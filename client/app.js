var Ch=Object.defineProperty;var Ke=(e,t)=>()=>(e&&(t=e(e=0)),t);var ur=(e,t)=>{for(var n in t)Ch(e,n,{get:t[n],enumerable:!0})};function Ha(e){Ki=e}function $a(e){fr=e}var a,Ki,fr,At=Ke(()=>{a={mode:"view",serverStatus:"unknown",serverStatusText:"",offlineReady:!1,offlineInitStatus:"idle",offlineInitError:"",offlineInitStartedAt:null,mediaStatusText:"",mediaPrefetchPaused:!1,isOutlineEditing:!1,outlineStatusText:"",isPublicView:!1,isRagView:!1,currentUser:null,articleId:null,article:null,currentBlockId:null,editingBlockId:null,selectionAnchorBlockId:null,selectedBlockIds:[],undoStack:[],redoStack:[],pendingTextPreview:null,editingUndo:null,editingInitialText:"",searchQuery:"",searchResults:[],searchError:"",searchLoading:!1,searchRequestId:0,searchMode:"classic",sidebarSearchView:"list",ragQuery:"",ragResults:[],ragBlockMap:{},ragSummaryHtml:"",ragSummaryLoading:!1,ragSummaryError:"",scrollTargetBlockId:null,pendingEditBlockId:null,isEditingTitle:!1,isSidebarCollapsed:!1,isSidebarMobileOpen:!1,articlesIndex:[],deletedArticlesIndex:[],articleFilterQuery:"",isMarkdownInserting:!1,isTrashView:!1,favoriteArticles:[],sidebarArticlesMode:"tree",recentArticleIds:[],sidebarSelectedArticleId:null,listSelectedArticleId:null,sidebarCollapsedArticleIds:[],listCollapsedArticleIds:[],isDragModeEnabled:!1,articleEncryptionKeys:{},isMergingBlocks:!1,isMovingBlock:!1,isDeletingBlock:!1,moveQueue:[],isMoveQueueProcessing:!1,editingScrollTop:null,editingCaretPosition:"start",outboxCount:null,offlineArticlesWithDoc:null,offlineArticlesTotal:null},Ki=!1,fr=!1});var p,Vt=Ke(()=>{p={authOverlay:document.getElementById("authOverlay"),authLoginTab:document.getElementById("authLoginTab"),authRegisterTab:document.getElementById("authRegisterTab"),authLoginForm:document.getElementById("authLoginForm"),authRegisterForm:document.getElementById("authRegisterForm"),authLoginUsername:document.getElementById("authLoginUsername"),authLoginPassword:document.getElementById("authLoginPassword"),authRegisterUsername:document.getElementById("authRegisterUsername"),authRegisterPassword:document.getElementById("authRegisterPassword"),authRegisterDisplayName:document.getElementById("authRegisterDisplayName"),authError:document.getElementById("authError"),authSubtitle:document.getElementById("authSubtitle"),authGoogleLoginBtn:document.getElementById("authGoogleLoginBtn"),authYandexLoginBtn:document.getElementById("authYandexLoginBtn"),authStorageInfo:document.getElementById("authStorageInfo"),currentUserLabel:document.getElementById("currentUserLabel"),logoutBtn:document.getElementById("logoutBtn"),userMenuBtn:document.getElementById("userMenuBtn"),userMenu:document.getElementById("userMenu"),sidebarSyncStatusPill:document.getElementById("sidebarSyncStatusPill"),syncMenu:document.getElementById("syncMenu"),syncMenuStatusLabel:document.getElementById("syncMenuStatusLabel"),syncMenuArticlesLabel:document.getElementById("syncMenuArticlesLabel"),syncMenuOutboxLabel:document.getElementById("syncMenuOutboxLabel"),offlineStatusItem:document.getElementById("offlineStatusItem"),offlineStatusLabel:document.getElementById("offlineStatusLabel"),offlineFetchBtn:document.getElementById("offlineFetchBtn"),offlineRepairBtn:document.getElementById("offlineRepairBtn"),telegramLinkBtn:document.getElementById("telegramLinkBtn"),telegramBotOpenBtn:document.getElementById("telegramBotOpenBtn"),telegramFeedbackBotOpenBtn:document.getElementById("telegramFeedbackBotOpenBtn"),openUsersViewBtn:document.getElementById("openUsersViewBtn"),usersView:document.getElementById("usersView"),usersList:document.getElementById("usersList"),usersBackBtn:document.getElementById("usersBackBtn"),graphView:document.getElementById("graphView"),graphCanvas:document.getElementById("graphCanvas"),graphBackBtn:document.getElementById("graphBackBtn"),articleListView:document.getElementById("articleListView"),articleView:document.getElementById("articleView"),articleHeader:document.getElementById("articleHeader"),articleTitle:document.getElementById("articleTitle"),updatedAt:document.getElementById("updatedAt"),articleStatusText:document.getElementById("articleStatusText"),mediaStatusText:document.getElementById("mediaStatusText"),mediaPrefetchToggleBtn:document.getElementById("mediaPrefetchToggleBtn"),blocksContainer:document.getElementById("blocksContainer"),articleList:document.getElementById("articleList"),createArticleBtn:document.getElementById("createArticleBtn"),backToList:document.getElementById("backToList"),toast:document.getElementById("toast"),searchInput:document.getElementById("searchInput"),searchClearBtn:document.getElementById("searchClearBtn"),searchResults:document.getElementById("searchResults"),searchPanel:document.querySelector(".search-panel"),searchModeToggle:document.getElementById("searchModeToggle"),sidebarSearchViewToggle:document.getElementById("sidebarSearchViewToggle"),ragOpenBtn:document.getElementById("ragOpenBtn"),articleTitleInput:document.getElementById("articleTitleInput"),editTitleBtn:document.getElementById("editTitleBtn"),hintToggleBtn:document.getElementById("hintToggleBtn"),hintPopover:document.getElementById("hintPopover"),sidebar:document.getElementById("sidebar"),sidebarToggle:document.getElementById("sidebarToggle"),sidebarArticleList:document.getElementById("sidebarArticleList"),sidebarNewArticleBtn:document.getElementById("sidebarNewArticleBtn"),sidebarRecentBtn:document.getElementById("sidebarRecentBtn"),openInboxBtn:document.getElementById("openInboxBtn"),quickNoteAddBtn:document.getElementById("quickNoteAddBtn"),articleFilterInput:document.getElementById("articleFilterInput"),trashTabBtn:document.getElementById("trashTabBtn"),articlesTabBtn:document.getElementById("articlesTabBtn"),semanticReindexBtn:document.getElementById("semanticReindexBtn"),graphToggleBtn:document.getElementById("graphToggleBtn"),listMenuBtn:document.getElementById("listMenuBtn"),listMenu:document.getElementById("listMenu"),articleMenuBtn:document.getElementById("articleMenuBtn"),articleMenu:document.getElementById("articleMenu"),articleFavoriteBtn:document.getElementById("articleFavoriteBtn"),articlePublicLinkBtn:document.getElementById("articlePublicLinkBtn"),articlePublicToggleBtn:document.getElementById("articlePublicToggleBtn"),articleEncryptionBtn:document.getElementById("articleEncryptionBtn"),articleEncryptionRemoveBtn:document.getElementById("articleEncryptionRemoveBtn"),deleteArticleBtn:document.getElementById("deleteArticleBtn"),exportArticleBtn:document.getElementById("exportArticleBtn"),outlineEditBtn:document.getElementById("outlineEditBtn"),saveVersionBtn:document.getElementById("saveVersionBtn"),versionsBtn:document.getElementById("versionsBtn"),blockHistoryBtn:document.getElementById("blockHistoryBtn"),articleHistoryBtn:document.getElementById("articleHistoryBtn"),exportAllHtmlZipBtn:document.getElementById("exportAllHtmlZipBtn"),importArticleBtn:document.getElementById("importArticleBtn"),importMarkdownBtn:document.getElementById("importMarkdownBtn"),importLogseqBtn:document.getElementById("importLogseqBtn"),importBackupFolderBtn:document.getElementById("importBackupFolderBtn"),articleUndoBtn:document.getElementById("articleUndoBtn"),articleRedoBtn:document.getElementById("articleRedoBtn"),mergeBlocksBtn:document.getElementById("mergeBlocksBtn"),splitBlockBtn:document.getElementById("splitBlockBtn"),insertTableBtn:document.getElementById("insertTableBtn"),deleteCurrentBlockBtn:document.getElementById("deleteCurrentBlockBtn"),exportCurrentBlockBtn:document.getElementById("exportCurrentBlockBtn"),articleBlockTrashBtn:document.getElementById("articleBlockTrashBtn"),articleNewBlockBtn:document.getElementById("articleNewBlockBtn"),articleToolbar:document.getElementById("articleToolbar"),outlineToolbar:document.getElementById("outlineToolbar"),outlineTagsBar:document.getElementById("outlineTagsBar"),outlineUndoBtn:document.getElementById("outlineUndoBtn"),outlineRedoBtn:document.getElementById("outlineRedoBtn"),outlineDeleteBtn:document.getElementById("outlineDeleteBtn"),outlineMoveUpBtn:document.getElementById("outlineMoveUpBtn"),outlineMoveDownBtn:document.getElementById("outlineMoveDownBtn"),outlineOutdentBtn:document.getElementById("outlineOutdentBtn"),outlineIndentBtn:document.getElementById("outlineIndentBtn"),outlineNewBelowBtn:document.getElementById("outlineNewBelowBtn"),outlineBoldBtn:document.getElementById("outlineBoldBtn"),outlineBulletListBtn:document.getElementById("outlineBulletListBtn"),outlineOrderedListBtn:document.getElementById("outlineOrderedListBtn"),outlineBlockquoteBtn:document.getElementById("outlineBlockquoteBtn"),outlineCodeBtn:document.getElementById("outlineCodeBtn"),outlineInsertTableBtn:document.getElementById("outlineInsertTableBtn"),outlineDeleteTableBtn:document.getElementById("outlineDeleteTableBtn"),outlineAddRowBtn:document.getElementById("outlineAddRowBtn"),outlineAddColBtn:document.getElementById("outlineAddColBtn"),pasteProgress:document.getElementById("pasteProgress"),mobileSidebarBtn:document.getElementById("mobileSidebarBtn"),sidebarBackdrop:document.getElementById("sidebarBackdrop"),dragModeToggleBtn:document.getElementById("dragModeToggleBtn"),listSidebarBtn:document.getElementById("listSidebarBtn"),outlineEditor:document.getElementById("outlineEditor")}});function sd(){if(!p.articlePublicToggleBtn)return;let e=a.article?.publicSlug||null;p.articlePublicToggleBtn.textContent=e?"\u041E\u0442\u043C\u0435\u043D\u0438\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435":"\u0414\u0430\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435"}function $n(){let e=a.article;if(!e)return;let t=e.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";if(p.articleTitle&&(p.articleTitle.textContent=t,p.articleTitle.classList.toggle("article-title--encrypted",!!e.encrypted),p.articleTitle.classList.toggle("hidden",a.isEditingTitle)),p.articleTitleInput&&(a.isEditingTitle||(p.articleTitleInput.value=t),p.articleTitleInput.classList.toggle("hidden",!a.isEditingTitle)),p.editTitleBtn&&p.editTitleBtn.classList.toggle("hidden",a.isEditingTitle),p.articleFavoriteBtn){let r=new Set(a.favoriteArticles||[]).has(e.id),o=p.articleFavoriteBtn.querySelector?.("i.bx")||p.articleFavoriteBtn.querySelector?.("span.bx")||p.articleFavoriteBtn.querySelector?.(".bx")||null;o&&o.classList?(o.classList.toggle("bxs-star",r),o.classList.toggle("bx-star",!r)):p.articleFavoriteBtn.innerHTML=`<i class="bx ${r?"bxs-star":"bx-star"}" aria-hidden="true"></i>`,p.articleFavoriteBtn.title=r?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}if(p.articlePublicLinkBtn){let n=!!e.publicSlug;p.articlePublicLinkBtn.classList.toggle("hidden",!n),n&&(p.articlePublicLinkBtn.title="\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0441\u044B\u043B\u043A\u0443")}if(p.deleteArticleBtn&&p.deleteArticleBtn.classList.toggle("hidden",e.id==="inbox"),p.articleEncryptionBtn&&(p.articleEncryptionBtn.textContent=e.encrypted?"\u0421\u043C\u0435\u043D\u0438\u0442\u044C \u043F\u0430\u0440\u043E\u043B\u044C":"\u0417\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C"),p.articleEncryptionRemoveBtn&&p.articleEncryptionRemoveBtn.classList.toggle("hidden",!e.encrypted),p.updatedAt&&(a.isOutlineEditing?p.updatedAt.textContent=a.outlineStatusText||"":e.updatedAt?p.updatedAt.textContent=`\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${new Date(e.updatedAt).toLocaleString()}`:p.updatedAt.textContent=""),p.articleStatusText&&(a.isOutlineEditing?p.articleStatusText.textContent=a.outlineStatusText||"":e.updatedAt?p.articleStatusText.textContent=`\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${new Date(e.updatedAt).toLocaleString()}`:p.articleStatusText.textContent=""),p.mediaStatusText&&(p.mediaStatusText.textContent=a.mediaStatusText||""),p.mediaPrefetchToggleBtn){let n=!!a.mediaPrefetchPaused;p.mediaPrefetchToggleBtn.textContent=n?"\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C":"\u041F\u0430\u0443\u0437\u0430",p.mediaPrefetchToggleBtn.classList.toggle("is-active",n)}}var Zo=Ke(()=>{At();Vt()});function ad(){ei!==null&&(clearTimeout(ei),ei=null)}function za(e){Fa=!!e,p.toast&&(Fa?p.toast.dataset.protected="true":p.toast.removeAttribute("data-protected"))}function P(e,t={}){if(!p.toast)return;let n=typeof t.duration=="number"?t.duration:2500;t.protect?za(!0):za(!1),ad(),p.toast.textContent=e,p.toast.classList.remove("hidden"),requestAnimationFrame(()=>{p.toast.classList.add("show")}),n>0&&(ei=setTimeout(()=>{p.toast.classList.remove("show"),setTimeout(()=>p.toast.classList.add("hidden"),200),ei=null},n))}function Ft(e,t={}){P(e,{...t,duration:0})}function bt(e={}){p.toast&&(Fa&&!e.force||(ad(),za(!1),p.toast.classList.remove("show"),p.toast.classList.add("hidden")))}var ei,Fa,zt=Ke(()=>{Vt();ei=null,Fa=!1;p.toast&&p.toast.addEventListener("click",()=>{bt()})});function ke(e){return new Promise((t,n)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error||new Error("IndexedDB request failed"))})}function wo(e,t,n={}){let r=t instanceof Error?t:new Error(String(t?.message||t||"IndexedDB error"));try{r.idbKind=String(e||"unknown"),r.cause=t,r.extra=n}catch{}return r}function Ve(e){return new Promise((t,n)=>{e.oncomplete=()=>t(),e.onabort=()=>n(e.error||new Error("IndexedDB transaction aborted")),e.onerror=()=>n(e.error||new Error("IndexedDB transaction failed"))})}function Bh(e){return String(e||"anon").replace(/[^a-zA-Z0-9_-]/g,"_")}function ld(e){return`memus_offline_v1_${Bh(e)}`}function Mh(e){try{let t=String(e||"").trim();if(!t)return;let n=window?.localStorage?.getItem?.(cd)||"[]",r=JSON.parse(n),o=Array.isArray(r)?r:[];o.includes(t)||o.push(t),window.localStorage.setItem(cd,JSON.stringify(o.slice(-200)))}catch{}}async function dd({userKey:e}={}){let t=e||"anon";Mh(t);let n=ld(t);if(typeof indexedDB>"u"){let c=new Error("IndexedDB is not available in this browser");throw c.name="IDBNotSupportedError",wo("no_idb",c,{name:n})}let r=indexedDB.open(n,Lh),o=3e3,i=!1;r.onblocked=()=>{i=!0},r.onupgradeneeded=()=>{let c=r.result;if(c.objectStoreNames.contains("meta")||c.createObjectStore("meta",{keyPath:"key"}),!c.objectStoreNames.contains("articles")){let l=c.createObjectStore("articles",{keyPath:"id"});l.createIndex("byUpdatedAt","updatedAt",{unique:!1}),l.createIndex("byDeletedAt","deletedAt",{unique:!1})}if(!c.objectStoreNames.contains("outline_sections")){let l=c.createObjectStore("outline_sections",{keyPath:"sectionId"});l.createIndex("byArticleId","articleId",{unique:!1}),l.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!c.objectStoreNames.contains("section_embeddings")){let l=c.createObjectStore("section_embeddings",{keyPath:"sectionId"});l.createIndex("byArticleId","articleId",{unique:!1}),l.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!c.objectStoreNames.contains("media_assets")){let l=c.createObjectStore("media_assets",{keyPath:"url"});l.createIndex("byStatus","status",{unique:!1}),l.createIndex("byFetchedAtMs","fetchedAtMs",{unique:!1}),l.createIndex("byStatusFetchedAtMs",["status","fetchedAtMs"],{unique:!1})}if(!c.objectStoreNames.contains("media_refs")){let l=c.createObjectStore("media_refs",{keyPath:"key"});l.createIndex("byArticleId","articleId",{unique:!1}),l.createIndex("byUrl","url",{unique:!1})}if(c.objectStoreNames.contains("outbox")){let l=r.transaction;try{let d=l.objectStore("outbox");d.indexNames.contains("byTypeCoalesceKey")||d.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}catch{}}else{let l=c.createObjectStore("outbox",{keyPath:"id"});l.createIndex("byCreatedAtMs","createdAtMs",{unique:!1}),l.createIndex("byTypeArticleId",["type","articleId"],{unique:!1}),l.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}if(!c.objectStoreNames.contains("pending_uploads")){let l=c.createObjectStore("pending_uploads",{keyPath:"token"});l.createIndex("byArticleId","articleId",{unique:!1}),l.createIndex("byCreatedAtMs","createdAtMs",{unique:!1})}if(!c.objectStoreNames.contains("tags_global")){let l=c.createObjectStore("tags_global",{keyPath:"key"});l.createIndex("byCount","count",{unique:!1}),l.createIndex("byLastSeenAtMs","lastSeenAtMs",{unique:!1})}c.objectStoreNames.contains("tags_by_article")||c.createObjectStore("tags_by_article",{keyPath:"articleId"}).createIndex("byUpdatedAt","updatedAt",{unique:!1})};let s=await Promise.race([ke(r),new Promise((c,l)=>{setTimeout(()=>{let d=new Error(i?"IndexedDB upgrade is blocked by another tab":"IndexedDB open timeout");d.name=i?"IDBBlockedError":"IDBTimeoutError",l(wo(i?"blocked":"timeout",d,{name:n}))},o)})]).catch(c=>{let l=String(c?.name||"");throw l==="IDBBlockedError"||l==="IDBTimeoutError"?c:l==="SecurityError"?wo("security",c,{name:n}):l==="InvalidStateError"?wo("invalid_state",c,{name:n}):l==="QuotaExceededError"?wo("quota",c,{name:n}):wo("unknown",c,{name:n})});try{s.onversionchange=()=>{try{s.close()}catch{}}}catch{}return s}async function ud({userKey:e}={}){let t=String(e||"anon").trim()||"anon",n=ld(t);typeof indexedDB>"u"||await new Promise((r,o)=>{let i=indexedDB.deleteDatabase(n);i.onsuccess=()=>r(),i.onerror=()=>o(i.error||new Error("IndexedDB delete failed")),i.onblocked=()=>o(new Error("IndexedDB delete blocked by another tab"))})}async function fd(e){let t=e.transaction(["meta"],"readonly"),n=t.objectStore("meta");await ke(n.get("ping")),await Ve(t)}var Lh,cd,Fn=Ke(()=>{Lh=4,cd="ttree_offline_known_user_keys_v1"});function pd(){return Ua}async function Ji({userKey:e}={}){let t=String(e||"").trim();if(!t||t==="anon")try{let n=window?.localStorage?.getItem?.("ttree_offline_user_key_v1")||"",r=String(n||"").trim();r&&(t=r)}catch{}if(!t||t==="anon")try{let n=window?.localStorage?.getItem?.("ttree_last_user_v1")||"",r=n?JSON.parse(n):null,o=String(r?.id||r?.username||"").trim();o&&(t=o)}catch{}return t||(t="anon"),ji&&Ua===t||(Ua=t,ji=(async()=>await dd({userKey:t}))()),ji}var ji,Ua,Va=Ke(()=>{Fn();ji=null,Ua=null});function Yi(){try{return window?.localStorage?.getItem?.(Nh)==="1"}catch{return!1}}function yd(){try{return window?.localStorage?.getItem?.(Ph)==="1"}catch{return!1}}function qa(e,t={}){try{if(!Yi())return;console.log("[perf][offline]",e,t)}catch{}}function Dh(){try{let e=window.__BUILD_ID__;return e?String(e):""}catch{return""}}function Ka(e,t){try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:e,data:t})}).catch(()=>{})}catch{}}async function ja(){let e={};try{e.ua=navigator?.userAgent||""}catch{e.ua=""}try{e.buildId=Dh()}catch{e.buildId=""}try{e.onLine=navigator?.onLine!==!1}catch{e.onLine=null}try{e.indexedDB=typeof indexedDB<"u"}catch{e.indexedDB=null}try{e.storagePersist=typeof navigator?.storage?.persist=="function"}catch{e.storagePersist=null}try{e.storageEstimate=typeof navigator?.storage?.estimate=="function"}catch{e.storageEstimate=null}try{if(navigator?.storage?.estimate){let t=await navigator.storage.estimate().catch(()=>null);t&&typeof t=="object"&&(e.quota=Number(t.quota||0)||null,e.usage=Number(t.usage||0)||null)}}catch{}return e}function bd(e){try{let t=window?.localStorage?.getItem?.("ttree_offline_user_key_v1")||"",n=String(t||"").trim();if(n)return n}catch{}return e&&(e.id||e.username)||"anon"}function _h(e){let t=String(e?.idbKind||"").trim(),n=String(e?.name||"").trim(),r=String(e?.message||"").trim();return t==="no_idb"||n==="IDBNotSupportedError"?{status:"unavailable",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0432 \u044D\u0442\u043E\u043C \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435 (\u043D\u0435\u0442 IndexedDB). \u041E\u0444\u0444\u043B\u0430\u0439\u043D \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u0435\u0442."}:t==="security"||n==="SecurityError"?{status:"unavailable",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u0430 \u043D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0430\u043C\u0438 \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0430/\u043F\u0440\u0438\u0432\u0430\u0442\u043D\u044B\u043C \u0440\u0435\u0436\u0438\u043C\u043E\u043C. \u041E\u0444\u0444\u043B\u0430\u0439\u043D \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u0435\u0442."}:t==="blocked"||n==="IDBBlockedError"?{status:"blocked",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u0437\u0430\u043D\u044F\u0442\u0430 \u0434\u0440\u0443\u0433\u043E\u0439 \u0432\u043A\u043B\u0430\u0434\u043A\u043E\u0439 Memus. \u0417\u0430\u043A\u0440\u043E\u0439\u0442\u0435 \u0434\u0440\u0443\u0433\u0438\u0435 \u0432\u043A\u043B\u0430\u0434\u043A\u0438 \u0438 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443."}:t==="timeout"||n==="IDBTimeoutError"?{status:"timeout",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435 \u043E\u0442\u0432\u0435\u0447\u0430\u0435\u0442 (\u0432\u043A\u043B\u0430\u0434\u043A\u0430 \u043C\u043E\u0433\u043B\u0430 \u201C\u0443\u0441\u043D\u0443\u0442\u044C\u201D). \u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443."}:t==="quota"||n==="QuotaExceededError"?{status:"quota",message:"\u041D\u0435\u0434\u043E\u0441\u0442\u0430\u0442\u043E\u0447\u043D\u043E \u043C\u0435\u0441\u0442\u0430 \u0434\u043B\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u043A\u044D\u0448\u0430. \u041E\u0447\u0438\u0441\u0442\u0438\u0442\u0435 \u043A\u044D\u0448 \u043A\u0430\u0440\u0442\u0438\u043D\u043E\u043A \u0438\u043B\u0438 \u043E\u0441\u0432\u043E\u0431\u043E\u0434\u0438\u0442\u0435 \u043C\u0435\u0441\u0442\u043E \u0432 \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435."}:t==="invalid_state"||n==="InvalidStateError"?{status:"error",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043F\u043E\u0432\u0440\u0435\u0436\u0434\u0435\u043D\u0430 \u0438\u043B\u0438 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430. \u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438\u043B\u0438 \u0441\u0431\u0440\u043E\u0441\u0438\u0442\u044C \u043E\u0444\u0444\u043B\u0430\u0439\u043D\u2011\u043A\u044D\u0448."}:r?{status:"error",message:`\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430: ${r}`}:{status:"error",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430."}}async function Gi(e){let t=bd(e);if(So&&md===t)return So;md=t,hd+=1;let n=hd;return So=(async()=>{let r=Yi()?performance.now():0;a.offlineReady=!1,a.offlineInitStatus="initializing",a.offlineInitError="",a.offlineInitStartedAt=Date.now();try{if(gd!==n){gd=n;let o=await ja().catch(()=>({}));Ka("offline.init.start",{t:new Date().toISOString(),attempt:n,userKey:t,env:o})}}catch{}try{yd()&&console.log("[offline] init start",{userKey:t})}catch{}try{let o=Yi()?performance.now():0,i=await Ji({userKey:t});o&&qa("getOfflineDb()",{ms:Math.round(performance.now()-o)});let s=Yi()?performance.now():0;await fd(i),s&&qa("idb.ping",{ms:Math.round(performance.now()-s)});try{navigator?.storage?.persist&&navigator.storage.persist().catch(()=>{})}catch{}a.offlineReady=!0,a.offlineInitStatus="ready",a.offlineInitError="",a.offlineInitStartedAt=null;try{if(Wi!==n){Wi=n;let c=await ja().catch(()=>({}));Ka("offline.init.ready",{t:new Date().toISOString(),attempt:n,userKey:t,env:c})}}catch{}try{yd()&&console.log("[offline] init ready")}catch{}return r&&qa("initOfflineForUser.total",{userKey:t,ms:Math.round(performance.now()-r)}),i}catch(o){a.offlineReady=!1;let i=_h(o);a.offlineInitStatus=i.status||"error",a.offlineInitStartedAt=null;try{console.error("[offline] init failed",o)}catch{}let s=i.message;a.offlineInitError=s,P(s);try{if(Wi!==n){Wi=n;let c=await ja().catch(()=>({}));Ka("offline.init.failed",{t:new Date().toISOString(),attempt:n,userKey:t,msg:s,err:{name:String(o?.name||""),message:String(o?.message||""),stack:String(o?.stack||"").slice(0,1500)},env:c})}}catch{}throw o}})(),So}async function lt(){return So||Gi(a.currentUser)}async function wd(){let e=pd()||bd(a.currentUser);await ud({userKey:e}).catch(()=>{})}var So,md,hd,gd,Wi,Nh,Ph,rr=Ke(()=>{At();zt();Va();Fn();So=null,md=null,hd=0,gd=null,Wi=null,Nh="ttree_profile_v1",Ph="ttree_debug_offline_v1"});function Ja(e){if(!e)return"";if(e.type==="text")return String(e.text||"");let t=Array.isArray(e.content)?e.content:[];if(!t.length)return"";let n=[];for(let r of t){let o=Ja(r);o&&n.push(o),r&&(r.type==="paragraph"||r.type==="hardBreak"||r.type==="heading")&&n.push(`
`)}return n.join("")}function Sd(e){return String(e||"").replace(/\r\n/g,`
`).replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}function xd(e,t=[]){for(let n of e||[]){if(!n||n.type!=="outlineSection")continue;let r=String(n.attrs?.id||""),o=n.content?.[0],i=n.content?.[1],s=n.content?.[2],c=Sd(Ja(o))||"",l=Sd(Ja(i))||"",d=`${c}
${l}`.trim();r&&t.push({sectionId:r,title:c,text:d});let u=s?.content||[];xd(u,t)}return t}function Oh(e){let t=Array.isArray(e?.content)?e.content:[];return xd(t,[])}function Rh(e){return String(e||"").trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9а-яё_-]/gi,"")}function kd(e,t){for(let n of e||[]){if(!n)continue;if(n.type==="tag"){let o=n.attrs?.key||n.attrs?.label||"",i=Rh(o);i&&t.add(i)}let r=Array.isArray(n.content)?n.content:[];r.length&&kd(r,t)}}function Hh(e){let t=new Set,n=Array.isArray(e?.content)?e.content:[];return kd(n,t),Array.from(t)}async function Qi(e,{articleId:t,docJson:n,updatedAt:r}){if(!e||!t||!n||typeof n!="object")return;let o=String(t),i=Hh(n),s=Date.now(),c=e.transaction(["tags_by_article","tags_global"],"readwrite"),l=c.objectStore("tags_by_article"),d=c.objectStore("tags_global"),u=await ke(l.get(o)).catch(()=>null),m=new Set(Array.isArray(u?.tags)?u.tags.map(f=>String(f||"").trim()).filter(Boolean):[]),y=new Set(i),w=[],g=[];for(let f of m)y.has(f)||w.push(f);for(let f of y)m.has(f)||g.push(f);for(let f of w){let h=await ke(d.get(f)).catch(()=>null),b=Math.max(0,(Number(h?.count||0)||0)-1);b<=0?await ke(d.delete(f)).catch(()=>{}):await ke(d.put({...h||{},key:f,label:String(h?.label||f),count:b,lastSeenAtMs:Number(h?.lastSeenAtMs||0)||0})).catch(()=>{})}for(let f of y){let h=await ke(d.get(f)).catch(()=>null),b=(Number(h?.count||0)||0)+(g.includes(f)?1:0);await ke(d.put({...h||{},key:f,label:String(h?.label||f),count:Math.max(1,b),lastSeenAtMs:s})).catch(()=>{})}await ke(l.put({articleId:o,tags:i,updatedAt:r||null,indexedAtMs:s})),await Ve(c)}async function Xi(e,{articleId:t,docJson:n,updatedAt:r}){if(!e||!t||!n||typeof n!="object")return;let o=Oh(n),i=e.transaction(["outline_sections"],"readwrite"),s=i.objectStore("outline_sections"),c=s.index("byArticleId"),l=IDBKeyRange.only(String(t)),d=await ke(c.openCursor(l));for(;d;)d.delete(),d=await ke(d.continue());for(let u of o)await ke(s.put({sectionId:u.sectionId,articleId:String(t),title:u.title||"",text:u.text||"",updatedAt:r||null}));await Ve(i)}var Ad=Ke(()=>{Fn()});function es(){try{return localStorage.getItem(Td)==="1"}catch{return!1}}function Wa(e){let t=!!e;try{localStorage.setItem(Td,t?"1":"0")}catch{}try{window.dispatchEvent(new CustomEvent("media-prefetch-paused",{detail:{paused:t}}))}catch{}return t}function Cd(){return Wa(!es())}async function Bd(e){let t=String(e||"").trim();if(!t)return{total:0,ok:0,error:0};let r=(await lt()).transaction(["media_refs","media_assets"],"readonly"),o=r.objectStore("media_refs"),i=r.objectStore("media_assets"),s=o.index("byArticleId"),c=IDBKeyRange.only(t),l=0,d=0,u=0,m=await ke(s.openCursor(c)).catch(()=>null);for(;m;){l+=1;let y=String(m.value?.url||"");if(y){let w=await ke(i.get(y)).catch(()=>null);w?.status==="ok"&&(d+=1),w?.status==="error"&&(u+=1)}m=await ke(m.continue()).catch(()=>null)}return await Ve(r),{total:l,ok:d,error:u}}function $h(e){let t=String(e||"").trim();if(!t)return null;try{let n=new URL(t,window.location.origin);return n.origin!==window.location.origin?/^https?:\/\/memus\.pro\b/i.test(t)&&n.pathname.startsWith("/uploads/")?n.pathname+(n.search||""):null:n.pathname.startsWith("/uploads/")?n.pathname+(n.search||""):null}catch{return t.startsWith("/uploads/")?t:null}}function Fh(e){let t=new Set,n=r=>{if(!r)return;if(Array.isArray(r)){r.forEach(n);return}if(r.type==="image"){let i=$h(r.attrs?.src);i&&t.add(i)}(Array.isArray(r.content)?r.content:[]).forEach(n)};return n(e?.content||[]),Array.from(t)}async function xo(e,t){let n=await lt(),r=Fh(t),o=n.transaction(["media_refs","media_assets"],"readwrite"),i=o.objectStore("media_refs"),s=o.objectStore("media_assets"),c=i.index("byArticleId"),l=IDBKeyRange.only(String(e)),d=await ke(c.openCursor(l)).catch(()=>null);for(;d;)d.delete(),d=await ke(d.continue()).catch(()=>null);for(let u of r){let m=`${String(e)}|${String(u)}`;await ke(i.put({key:m,articleId:String(e),url:String(u)})),await ke(s.get(u)).catch(()=>null)||await ke(s.put({url:String(u),status:"needed",fetchedAtMs:0,failCount:0,lastError:null}))}await Ve(o)}async function Ld(e={}){let{maxFailCountOnly:t=!1}=e||{},r=(await lt()).transaction(["media_assets"],"readwrite"),o=r.objectStore("media_assets"),i=await ke(o.getAll()).catch(()=>[])||[];for(let s of i){if(!s?.url||String(s.status||"")!=="error")continue;let c=Number(s.failCount||0);t&&c<5||await ke(o.put({...s,status:"needed",failCount:0,lastError:null,fetchedAtMs:0}))}await Ve(r)}async function Id(e,t){let n=e.transaction(["media_assets"],"readwrite"),r=n.objectStore("media_assets"),o=await ke(r.get(t)).catch(()=>null);await ke(r.put({...o||{},url:String(t),status:"ok",fetchedAtMs:Date.now(),failCount:0,lastError:null})),await Ve(n)}async function zh(e,t,n){let r=String(n?.message||n||"error"),o=e.transaction(["media_assets"],"readwrite"),i=o.objectStore("media_assets"),s=await ke(i.get(t)).catch(()=>null),c=Number(s?.failCount||0)+1;await ke(i.put({...s||{},url:String(t),status:"error",fetchedAtMs:Date.now(),failCount:c,lastError:r})),await Ve(o)}async function Uh(e,t){let n=e.transaction(["media_assets"],"readonly"),o=n.objectStore("media_assets").index("byFetchedAtMs"),i=[],s=await ke(o.openCursor()).catch(()=>null);for(;s;){let c=s.value,l=String(c?.status||""),d=Number(c?.failCount||0);if(l!=="ok"&&d<5){let u=String(c?.url||"");if(u&&i.push(u),i.length>=t)break}s=await ke(s.continue()).catch(()=>null)}return await Ve(n),i}async function Vh(e,t){try{return!!await e.match(t,{ignoreSearch:!1})}catch{return!1}}async function qh(e,t){let n=await fetch(t,{credentials:"include"});if(!n||!n.ok)throw new Error(`HTTP ${n?.status||0}`);await e.put(t,n.clone())}function Kh(){try{let e=navigator.connection||navigator.mozConnection||navigator.webkitConnection,t=String(e?.effectiveType||"");if(!!e?.saveData||t.includes("2g"))return 1;if(t.includes("3g"))return 2}catch{}return 3}function ts(){if(Ed)return;Ed=!0;let e=async()=>{if(!navigator.onLine||es())return;let t=Kh();if(Zi>=t)return;let n=await lt(),r=await caches.open(vd),o=await Uh(n,Math.max(5,t*3));if(o.length)for(let i of o){if(Zi>=t)break;Zi+=1,(async()=>{try{if(await Vh(r,i)){await Id(n,i);return}await qh(r,i),await Id(n,i)}catch(s){await zh(n,i,s)}finally{Zi-=1}})()}};setInterval(()=>{e().catch(()=>{})},1200),window.addEventListener("online",()=>{e().catch(()=>{})})}async function Md(){let e=await lt(),t=await caches.open(vd),n=e.transaction(["media_assets","media_refs"],"readwrite"),r=n.objectStore("media_assets"),i=n.objectStore("media_refs").index("byUrl"),s=[],c=await ke(r.openCursor()).catch(()=>null);for(;c&&s.length<500;){let l=String(c.value?.url||"");l&&(await ke(i.count(IDBKeyRange.only(l))).catch(()=>0)||(s.push(l),c.delete())),c=await ke(c.continue()).catch(()=>null)}if(await Ve(n),!s.length)return 0;for(let l of s)try{await t.delete(l)}catch{}return s.length}var vd,Td,Ed,Zi,ti=Ke(()=>{rr();Fn();vd="memus-uploads-v1",Td="ttree_media_prefetch_paused_v1";Ed=!1,Zi=0});function Ya(){try{window.dispatchEvent(new CustomEvent("offline-outbox-changed"))}catch{}}function jh(){return globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?globalThis.crypto.randomUUID():`id-${Date.now()}-${Math.random().toString(16).slice(2)}`}function Nd(){return new Date().toISOString()}async function Gt(e,{articleId:t,payload:n,coalesceKey:r}={}){let o=await lt(),i=jh(),s=Nd(),c=n?JSON.stringify(n):"{}",l=o.transaction(["outbox"],"readwrite"),d=l.objectStore("outbox"),u=d.index("byTypeArticleId"),m=d.index("byTypeCoalesceKey");if(r){let y=[String(e||""),String(r||"")],w=await ke(m.openCursor(IDBKeyRange.only(y))).catch(()=>null);for(;w;)w.delete(),w=await ke(w.continue()).catch(()=>null)}else if(t){let y=[String(e||""),t||null],w=await ke(u.openCursor(IDBKeyRange.only(y))).catch(()=>null);for(;w;)w.delete(),w=await ke(w.continue()).catch(()=>null)}return await ke(d.put({id:i,createdAt:s,createdAtMs:Date.now(),type:String(e||""),articleId:t||null,coalesceKey:r?String(r):null,payloadJson:c,attempts:0,lastError:null,lastAttemptAt:null})),await Ve(l),Ya(),i}async function Zr(e=50){let n=(await lt()).transaction(["outbox"],"readonly"),o=n.objectStore("outbox").index("byCreatedAtMs"),i=[],s=await ke(o.openCursor()).catch(()=>null);for(;s&&(i.push(s.value),!(i.length>=e));)s=await ke(s.continue()).catch(()=>null);return await Ve(n),i.map(c=>{let l={};try{l=JSON.parse(c?.payloadJson||"{}")}catch{l={}}return{id:c.id,createdAt:c.createdAt,type:c.type,articleId:c.articleId,payload:l,attempts:c.attempts||0}})}async function Jh(e=[],t=null){let n=String(t||"").trim(),r=Array.isArray(e)?e.map(l=>String(l||"").trim()).filter(Boolean):[];if(!n||!r.length)return!1;let i=(await lt()).transaction(["outbox"],"readonly"),c=i.objectStore("outbox").index("byTypeArticleId");for(let l of r)try{let d=[String(l),n];if(await ke(c.openCursor(IDBKeyRange.only(d))).catch(()=>null))return await Ve(i),!0}catch{}return await Ve(i),!1}async function Pd(e){return Jh(["delete_sections","section_upsert_content","structure_snapshot","save_doc_json"],e)}async function Dd(){let t=(await lt()).transaction(["outbox"],"readonly"),n=t.objectStore("outbox"),r=await ke(n.count()).catch(()=>0);return await Ve(t),Number(r||0)||0}async function _d(e,t){let r=(await lt()).transaction(["outbox"],"readwrite"),o=r.objectStore("outbox"),i=await ke(o.get(e)).catch(()=>null);i&&await ke(o.put({...i,attempts:Number(i.attempts||0)+1,lastError:String(t||"error"),lastAttemptAt:Nd()})),await Ve(r),Ya()}async function Or(e){let n=(await lt()).transaction(["outbox"],"readwrite"),r=n.objectStore("outbox");await ke(r.delete(e)),await Ve(n),Ya()}var eo=Ke(()=>{rr();Fn()});function Rd(e){ni.counts=new Map,ni.labelByKey=new Map;for(let t of e||[]){let n=String(t?.key||"").trim();if(!n)continue;let r=Number(t?.count||0)||0,o=String(t?.label||n);ni.counts.set(n,r),ni.labelByKey.set(n,o)}Od=!0}async function Hd(e){let t=e.transaction(["tags_global"],"readonly"),n=t.objectStore("tags_global"),r=await ke(n.getAll()).catch(()=>[]);return await Ve(t),Array.isArray(r)?r:[]}function $d(){return ni}function Fd(){Od||Ga||(Ga=(async()=>{try{let e=await lt(),t=await Hd(e);Rd(t)}catch{}finally{Ga=null}})())}function ns(){Qa||(Qa=setTimeout(()=>{Qa=null,Wh().catch(()=>{})},800))}async function Wh(){try{let e=await lt(),t=await Hd(e);Rd(t)}catch{}}var Od,Ga,Qa,ni,Xa=Ke(()=>{rr();Fn();Od=!1,Ga=null,Qa=null,ni={counts:new Map,labelByKey:new Map}});function Xh(e=null){try{if(window?.localStorage?.getItem?.(Yh)!=="1")return!1;let t=String(window?.localStorage?.getItem?.(Gh)||"").trim();if(!t)return!0;let n=String(e||"").trim();return n?n===t:!0}catch{return!1}}function Zh(){try{return window?.localStorage?.getItem?.(Qh)==="1"}catch{return!1}}function eg(e){try{return JSON.stringify(e)}catch{return'"[unserializable]"'}}function tg(e){try{let t=String(e||""),n=2166136261;for(let r=0;r<t.length;r+=1)n^=t.charCodeAt(r),n=Math.imul(n,16777619);return(n>>>0).toString(16)}catch{return"0"}}function Qt(e){try{return!e||typeof e!="object"?null:tg(eg(e))}catch{return null}}function ht(e,t={}){try{let n=t?.articleId?String(t.articleId):null;if(!Xh(n))return!1;let r={t:new Date().toISOString(),kind:String(e||"event"),data:t&&typeof t=="object"?t:{value:t}},o=[];try{let i=window?.localStorage?.getItem?.(rs)||"";o=i?JSON.parse(i):[],Array.isArray(o)||(o=[])}catch{o=[]}o.push(r),o.length>250&&(o=o.slice(o.length-250));try{window?.localStorage?.setItem?.(rs,JSON.stringify(o))}catch{}if(Zh()&&navigator.onLine!==!1)try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:`revert:${r.kind}`,data:r})}).catch(()=>{})}catch{}return!0}catch{return!1}}function ng(){try{let e=window?.localStorage?.getItem?.(rs)||"",t=e?JSON.parse(e):[];return Array.isArray(t)?t:[]}catch{return[]}}function rg(){try{window?.localStorage?.removeItem?.(rs)}catch{}}var Yh,Gh,Qh,rs,ri=Ke(()=>{Yh="ttree_debug_revert_v1",Gh="ttree_debug_revert_article_v1",Qh="ttree_client_log_v1",rs="ttree_revert_log_v1";try{window.memusRevertLogDump=()=>ng(),window.memusRevertLogClear=()=>rg()}catch{}});function og(e){return{id:e.id,title:e.title,updatedAt:e.updatedAt,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:!!e.encrypted}}async function pr(e){let t=await lt(),n=Array.isArray(e)?e:[],r=50;for(let o=0;o<n.length;o+=r){let i=n.slice(o,o+r),s=t.transaction(["articles"],"readwrite"),c=s.objectStore("articles");for(let l of i){let d=og(l),m={...await ke(c.get(d.id)).catch(()=>null)||{},id:d.id,title:d.title||"",updatedAt:d.updatedAt||null,parentId:d.parentId??null,position:typeof d.position=="number"?d.position:0,publicSlug:d.publicSlug??null,encrypted:d.encrypted?1:0,deletedAt:null};await ke(c.put(m))}await Ve(s),await new Promise(l=>setTimeout(l,0))}}async function or(){let t=(await lt()).transaction(["articles"],"readonly"),n=t.objectStore("articles"),r=1200,o=null,i=await Promise.race([ke(n.getAll()),new Promise((s,c)=>{o=setTimeout(()=>{try{t.abort()}catch{}let l=new Error("IndexedDB read timeout (articles index)");l.name="IDBTimeoutError";try{l.idbKind="timeout"}catch{}c(l)},r)})]).catch(s=>{try{String(s?.name||"")==="QuotaExceededError"&&(s.idbKind="quota")}catch{}throw s});return o&&clearTimeout(o),await Ve(t),i.filter(s=>s&&!s.deletedAt).sort((s,c)=>Number(s.position||0)-Number(c.position||0)).map(s=>({id:s.id,title:s.title||"",updatedAt:s.updatedAt||null,parentId:s.parentId??null,position:typeof s.position=="number"?s.position:0,publicSlug:s.publicSlug??null,encrypted:!!s.encrypted}))}async function zd(){let t=(await lt()).transaction(["articles"],"readonly"),n=t.objectStore("articles"),r=await ke(n.getAll()).catch(()=>[])||[];return await Ve(t),r.filter(o=>o&&!o.deletedAt).map(o=>({id:o.id,updatedAt:o.updatedAt||null,hasDocJson:!!o.docJsonStr}))}async function Rr(e){if(!e||!e.id)return;let t=await lt(),n=e.docJson&&typeof e.docJson=="object"?e.docJson:null,r=e.updatedAt||null,o=t.transaction(["articles"],"readwrite"),i=o.objectStore("articles"),s=await ke(i.get(e.id)).catch(()=>null),c=null;try{c=s?.articleJsonStr?JSON.parse(s.articleJsonStr):null}catch{c=null}let l=!!(c&&c.localDraft),d=e&&Object.prototype.hasOwnProperty.call(e,"outlineStructureRev")?Number(e.outlineStructureRev):null;try{let m=String(s?.updatedAt||"").trim(),y=String(r||"").trim();if(m&&y&&y<m){ht("cache.article.put.skip_older",{articleId:e.id,existingUpdatedAt:m,incomingUpdatedAt:y,incomingDocHash:Qt(n)}),await Ve(o);return}if(l&&m&&y&&m===y){let w=!1;try{w=await Pd(e.id)}catch{w=!1}if(w){let g=Qt(s?.docJsonStr?JSON.parse(s.docJsonStr):null),f=Qt(n);if(g&&f&&g!==f){let h=c&&typeof c=="object"?{...c}:{};h.id=e.id,h.title=e.title||h.title||"",h.updatedAt=m,h.parentId=e.parentId??h.parentId??null,h.position=typeof e.position=="number"?e.position:h.position??0,h.publicSlug=e.publicSlug??h.publicSlug??null,h.encrypted=!!e.encrypted,Object.prototype.hasOwnProperty.call(e,"outlineStructureRev")&&(h.outlineStructureRev=Number(e.outlineStructureRev)||0),h.localDraft=!0;let b={...s||{},id:e.id,title:e.title||"",updatedAt:m,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:e.encrypted?1:0,deletedAt:null,outlineStructureRev:Number.isFinite(d)?d:Number(s?.outlineStructureRev),docJsonStr:s?.docJsonStr??null,articleJsonStr:JSON.stringify(h)};await ke(i.put(b)),await Ve(o);try{ht("cache.article.put.skip_localDraft",{articleId:e.id,updatedAt:m,existingDocHash:g,incomingDocHash:f})}catch{}return}}else try{ht("cache.article.put.clear_stale_localDraft",{articleId:e.id,updatedAt:m})}catch{}}}catch{}let u={...s||{},id:e.id,title:e.title||"",updatedAt:r,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:e.encrypted?1:0,deletedAt:null,outlineStructureRev:Number.isFinite(d)?d:Number(s?.outlineStructureRev),docJsonStr:n?JSON.stringify(n):null,articleJsonStr:JSON.stringify(e)};await ke(i.put(u)),await Ve(o);try{ht("cache.article.put",{articleId:e.id,updatedAt:r,hasDocJson:!!n,docHash:Qt(n)})}catch{}n&&(Xi(t,{articleId:e.id,docJson:n,updatedAt:r}).catch(()=>{}),Qi(t,{articleId:e.id,docJson:n,updatedAt:r}).then(ns).catch(()=>{}),xo(e.id,n).catch(()=>{}))}async function Ud(e,t){if(!e||!t)return;let n=await lt(),r=String(t),o=e.docJson&&typeof e.docJson=="object"?e.docJson:null,i=e.updatedAt||null,s=n.transaction(["articles"],"readwrite"),c=s.objectStore("articles"),l=await ke(c.get(r)).catch(()=>null);try{let u=String(l?.updatedAt||"").trim(),m=String(i||"").trim();if(u&&m&&m<u){ht("cache.articleUnderId.put.skip_older",{articleId:r,existingUpdatedAt:u,incomingUpdatedAt:m,incomingDocHash:Qt(o)}),await Ve(s);return}}catch{}let d={...l||{},id:r,title:e.title||l?.title||"",updatedAt:i||l?.updatedAt||null,parentId:e.parentId??l?.parentId??null,position:typeof e.position=="number"?e.position:l?.position||0,publicSlug:e.publicSlug??l?.publicSlug??null,encrypted:e.encrypted||l?.encrypted?1:0,deletedAt:null,docJsonStr:o?JSON.stringify(o):l?.docJsonStr??null,articleJsonStr:JSON.stringify(e)};await ke(c.put(d)),await Ve(s),o&&(Xi(n,{articleId:r,docJson:o,updatedAt:i}).catch(()=>{}),Qi(n,{articleId:r,docJson:o,updatedAt:i}).then(ns).catch(()=>{}),xo(r,o).catch(()=>{}))}async function Sr(e){if(!e)return null;let n=(await lt()).transaction(["articles"],"readonly"),r=n.objectStore("articles"),o=await ke(r.get(e)).catch(()=>null);if(await Ve(n),!o)return null;try{let i=JSON.parse(o.articleJsonStr||"null");return i&&!i.docJson&&o.docJsonStr&&(i.docJson=JSON.parse(o.docJsonStr)),i}catch{try{let i=o.docJsonStr?JSON.parse(o.docJsonStr):null,s={id:e,title:o.title||"",createdAt:o.createdAt||o.updatedAt||null,updatedAt:o.updatedAt||null,deletedAt:o.deletedAt||null,parentId:o.parentId??null,position:typeof o.position=="number"?o.position:0,authorId:null,publicSlug:o.publicSlug??null,encrypted:!!o.encrypted,outlineStructureRev:Number.isFinite(Number(o.outlineStructureRev))?Number(o.outlineStructureRev):void 0,docJson:i&&typeof i=="object"?i:null,history:[],redoHistory:[],blockTrash:[]};try{ht("cache.article.get.fallback_docJsonStr",{articleId:e,updatedAt:s.updatedAt||null,docHash:Qt(s.docJson)})}catch{}return s}catch{return null}}}async function Pn(e,t,n){if(!e)return;let r=await lt(),o=r.transaction(["articles"],"readwrite"),i=o.objectStore("articles"),s=await ke(i.get(e)).catch(()=>null),c=n||s&&s.updatedAt||null,l=()=>{let m=String(e)==="inbox"?"\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438":"",y=(s&&typeof s.title=="string"?s.title:"")||m,w=c,g={id:e,title:y,createdAt:s&&s.createdAt||w||null,updatedAt:w,deletedAt:s&&s.deletedAt||null,parentId:(s&&s.parentId)??null,position:typeof(s&&s.position)=="number"?s.position:0,authorId:null,publicSlug:(s&&s.publicSlug)??null,encrypted:!!(s&&s.encrypted),docJson:null,history:[],blocks:[]};return JSON.stringify(g)},d=()=>{let m=s&&s.articleJsonStr||"",y=null;try{y=m?JSON.parse(m):null}catch{y=null}if(!y||typeof y!="object")try{y=JSON.parse(l())}catch{y={id:e}}return y.id=e,y.updatedAt=c||y.updatedAt||null,y.docJson=t&&typeof t=="object"?t:null,t&&typeof t=="object"&&(y.localDraft=!0),!y.title&&s?.title&&(y.title=s.title),y.deletedAt===void 0&&(y.deletedAt=null),y.parentId===void 0&&(y.parentId=s?.parentId??null),y.position===void 0&&(y.position=typeof s?.position=="number"?s.position:0),y.publicSlug===void 0&&(y.publicSlug=s?.publicSlug??null),y.encrypted===void 0&&(y.encrypted=!!s?.encrypted),y.history===void 0&&(y.history=[]),y.blocks===void 0&&(y.blocks=[]),JSON.stringify(y)},u={...s||{id:e},id:e,outlineStructureRev:s?.outlineStructureRev,docJsonStr:t?JSON.stringify(t):null,updatedAt:c,articleJsonStr:d()};await ke(i.put(u)),await Ve(o);try{ht("cache.docJson.put",{articleId:e,updatedAt:c,docHash:Qt(t)})}catch{}t&&typeof t=="object"&&(Xi(r,{articleId:e,docJson:t,updatedAt:n}).catch(()=>{}),Qi(r,{articleId:e,docJson:t,updatedAt:n}).then(ns).catch(()=>{}),xo(e,t).catch(()=>{}))}async function ko(e,t){let n=String(e||"").trim();if(!n)return;let r=String(t||new Date().toISOString()).trim(),i=(await lt()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),c=await ke(s.get(n)).catch(()=>null);if(!c){await Ve(i);return}let l=null;try{l=c.articleJsonStr?JSON.parse(c.articleJsonStr):null}catch{l=null}(!l||typeof l!="object")&&(l={id:n}),l.id=n,l.deletedAt=r;let d={...c,deletedAt:r,articleJsonStr:JSON.stringify(l)};await ke(s.put(d)),await Ve(i)}async function Vd(e){let t=String(e||"").trim();if(!t)return;let r=(await lt()).transaction(["articles"],"readwrite"),o=r.objectStore("articles"),i=await ke(o.get(t)).catch(()=>null);if(!i){await Ve(r);return}let s=null;try{s=i.articleJsonStr?JSON.parse(i.articleJsonStr):null}catch{s=null}(!s||typeof s!="object")&&(s={id:t}),s.id=t,delete s.localDraft;let c={...i,articleJsonStr:JSON.stringify(s)};await ke(o.put(c)),await Ve(r)}async function Ao(e){let t=await lt(),n=Array.isArray(e)?e:[];if(!n.length)return;let r=t.transaction(["articles"],"readwrite"),o=r.objectStore("articles");for(let i of n){if(!i||!i.id)continue;let s=await ke(o.get(i.id)).catch(()=>null);if(!s)continue;let c={...s,parentId:i.parentId??null,position:typeof i.position=="number"?i.position:0};await ke(o.put(c))}await Ve(r)}async function Za(e,t){let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return;let i=(await lt()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),c=await ke(s.get(n)).catch(()=>null);if(!c){await Ve(i);return}let l=null;try{l=c.articleJsonStr?JSON.parse(c.articleJsonStr):null}catch{l=null}(!l||typeof l!="object")&&(l={id:n}),l.id=n,l.updatedAt=r;let d={...c,updatedAt:r,articleJsonStr:JSON.stringify(l)};await ke(s.put(d)),await Ve(i)}async function ec(e,t){let n=String(e||"").trim();if(!n)return;let r=Number(t);if(!Number.isFinite(r)||r<0)return;let i=(await lt()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),c=await ke(s.get(n)).catch(()=>null);if(!c){await Ve(i);return}let l=null;try{l=c.articleJsonStr?JSON.parse(c.articleJsonStr):null}catch{l=null}(!l||typeof l!="object")&&(l={id:n}),l.id=n,l.outlineStructureRev=r;let d={...c,outlineStructureRev:r,articleJsonStr:JSON.stringify(l)};await ke(s.put(d)),await Ve(i)}var Hr=Ke(()=>{rr();Fn();Ad();ti();eo();Xa();ri()});function Kd(e){let t=Array.isArray(e)?e:[],n=new Float32Array(t.length),r=0;for(let o=0;o<t.length;o+=1){let i=Number(t[o]||0);n[o]=i,r+=i*i}if(r>0){let o=1/Math.sqrt(r);for(let i=0;i<n.length;i+=1)n[i]*=o}return n}function jd(){os=null,qd=0}async function tc(e,t){if(!e)return;let n=await lt(),r=Array.isArray(t)?t:[],o=n.transaction(["section_embeddings"],"readwrite"),i=o.objectStore("section_embeddings");for(let s of r){let c=String(s?.blockId||s?.sectionId||""),l=String(s?.updatedAt||"")||null,d=s?.embedding;if(!c||!Array.isArray(d)||!d.length)continue;let u=Kd(d);await ke(i.put({sectionId:c,articleId:String(e),updatedAt:l,vec:u}))}await Ve(o),jd()}async function is(e){let t=(e||[]).map(i=>String(i||"")).filter(Boolean);if(!t.length)return;let r=(await lt()).transaction(["section_embeddings"],"readwrite"),o=r.objectStore("section_embeddings");for(let i of t)await ke(o.delete(i));await Ve(r),jd()}async function Jd(){let t=(await lt()).transaction(["section_embeddings"],"readonly"),n=t.objectStore("section_embeddings"),r=await ke(n.count());return await Ve(t),Number(r||0)}async function Wd(){if(os)return os;let t=(await lt()).transaction(["section_embeddings"],"readonly"),n=t.objectStore("section_embeddings"),r=await ke(n.getAll()).catch(()=>[])||[];await Ve(t);let o=[];for(let i of r){let s=String(i?.sectionId||""),c=String(i?.articleId||""),l=i?.vec;if(!s||!c||!l)continue;let d=null;l instanceof Float32Array?d=l:l instanceof ArrayBuffer?d=new Float32Array(l):Array.isArray(l)&&(d=Kd(l)),!(!d||!d.length)&&o.push({sectionId:s,articleId:c,vec:d})}return os=o,qd=Date.now(),o}function Yd(e,t){let n=Math.min(e.length,t.length),r=0;for(let o=0;o<n;o+=1)r+=e[o]*t[o];return r}var os,qd,nc=Ke(()=>{rr();Fn();os=null,qd=0});function ig(e){let t=Array.isArray(e)?e:[],n=new Float32Array(t.length),r=0;for(let o=0;o<t.length;o+=1){let i=Number(t[o]||0);n[o]=i,r+=i*i}if(r>0){let o=1/Math.sqrt(r);for(let i=0;i<n.length;i+=1)n[i]*=o}return n}async function sg(e){let t=String(e||"").trim();if(!t)return null;let n=await fetch(`/api/search/semantic/query-embedding?q=${encodeURIComponent(t)}`,{method:"GET",credentials:"include",headers:{"Content-Type":"application/json"}});if(!n.ok){let i=await n.json().catch(()=>({}));throw new Error(i.detail||"Embedding failed")}let o=(await n.json().catch(()=>null))?.embedding;return!Array.isArray(o)||!o.length?null:ig(o)}async function ag(e){let t=(e||[]).map(l=>String(l||"")).filter(Boolean);if(!t.length)return[];let r=(await lt()).transaction(["outline_sections","articles"],"readonly"),o=r.objectStore("outline_sections"),i=r.objectStore("articles"),s=[];for(let l of t){let d=await ke(o.get(l)).catch(()=>null);d&&s.push({blockId:String(d.sectionId||l),articleId:String(d.articleId||""),blockText:String(d.text||"")})}let c=new Map;for(let l of s){if(!l.articleId||c.has(l.articleId))continue;let d=await ke(i.get(l.articleId)).catch(()=>null);c.set(l.articleId,String(d?.title||""))}return await Ve(r),s.map(l=>({blockId:l.blockId,articleId:l.articleId,articleTitle:c.get(l.articleId)||"",blockText:l.blockText}))}async function Gd(e,{limit:t=30}={}){let n=String(e||"").trim();if(!n||!navigator.onLine||!await Jd().catch(()=>0))return null;let o=await sg(n);if(!o)return null;let i=await Wd();if(!i.length)return null;let s=Math.max(1,Math.min(Number(t)||30,50)),c=[];for(let y of i){let w=Yd(o,y.vec);if(Number.isFinite(w)){if(c.length<s){c.push({sectionId:y.sectionId,score:w}),c.length===s&&c.sort((g,f)=>g.score-f.score);continue}w<=c[0].score||(c[0]={sectionId:y.sectionId,score:w},c.sort((g,f)=>g.score-f.score))}}c.sort((y,w)=>w.score-y.score);let l=c.map(y=>y.sectionId),d=await ag(l),u=new Map(d.map(y=>[y.blockId,y])),m=[];for(let y of c){let w=u.get(y.sectionId);if(!w)continue;let g=w.blockText||"";m.push({type:"block",articleId:w.articleId,articleTitle:w.articleTitle,blockId:w.blockId,snippet:g.slice(0,160),blockText:g,score:y.score})}return m}var Qd=Ke(()=>{rr();nc();Fn()});function ss(){try{return window?.localStorage?.getItem?.(cg)==="1"}catch{return!1}}function un(...e){try{if(!ss())return;console.log(...e)}catch{}}async function He(e,t={}){let n=ss()?performance.now():0,r=n?performance.now():0,o=await fetch(e,{headers:{"Content-Type":"application/json",...t.headers||{}},credentials:"include",...t}),i=r?performance.now():0;if(!o.ok){if(o.status===401||o.status===403){try{a.serverStatus="auth",a.serverStatusText="auth"}catch{}try{window.dispatchEvent(new CustomEvent("memus:auth-required",{detail:{path:e,status:o.status}}))}catch{}}let d=await o.json().catch(()=>({}));n&&console.log("[perf][api]",e,{status:o.status,ms:Math.round(performance.now()-n),fetchMs:i?Math.round(i-r):null});let u=new Error(d.detail||"Request failed");try{u.status=o.status,u.path=e}catch{}throw u}try{a.serverStatus==="down"&&(a.serverStatus="ok",a.serverStatusText="")}catch{}if(o.status===204)return n&&console.log("[perf][api]",e,{status:204,ms:Math.round(performance.now()-n),fetchMs:i?Math.round(i-r):null}),null;let s=n?performance.now():0,c=await o.json(),l=n?performance.now():0;try{if(window?.localStorage?.getItem?.("ttree_debug_article_load_v1")==="1"){let d=o.headers.get("X-Memus-Article-ms"),u=o.headers.get("X-Memus-DocJson-bytes");(d||u)&&console.log("[api]",e,{ms:d,docJsonBytes:u})}}catch{}if(n){let d=o.headers.get("X-Memus-Article-ms")||o.headers.get("X-Memus-Articles-ms")||o.headers.get("X-Memus-Server-ms"),u=o.headers.get("X-Memus-DocJson-bytes"),m=o.headers.get("X-Memus-Articles-count"),y=o.headers.get("Content-Length");console.log("[perf][api]",e,{status:o.status,ms:Math.round(l-n),fetchMs:i?Math.round(i-r):null,jsonMs:s?Math.round(l-s):null,serverMs:d?Number(d):null,docJsonBytes:u?Number(u):null,articlesCount:m?Number(m):null,contentLength:y?Number(y):null})}return c}async function eu(){await fetch("/api/auth/logout",{method:"POST",credentials:"include"})}function dg(){try{return window?.localStorage?.getItem?.(lg)==="1"}catch{return!1}}async function Xd({timeoutMs:e}){let t=typeof e=="number"?Math.max(0,Math.floor(e)):0,n=null,r=null;try{return t>0&&typeof AbortController<"u"&&(r=new AbortController,n=setTimeout(()=>{try{r.abort()}catch{}},t)),await He("/api/articles",r?{signal:r.signal}:{})}catch(o){if((o?.message||String(o||"")).toLowerCase().includes("abort"))try{a.serverStatus="down",a.serverStatusText="timeout"}catch{}throw o}finally{n&&clearTimeout(n)}}function zn(){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return or().catch(()=>[]);if(oi)return oi;let e=a?.offlineReady?600:250,t=2200;return oi=(async()=>{let n=ss()?performance.now():0,r=null,o=!1,i=new Promise(d=>{r=setTimeout(()=>{!o&&n&&un("[offline-first][articles] cache.lookup.timeout",{preferCacheMs:e}),d(null)},e)}),s=or().then(d=>(o=!0,r&&clearTimeout(r),r=null,n&&un("[offline-first][articles] cache.lookup.done",{ms:Math.round(performance.now()-n),hit:!!(d&&d.length)}),d)).catch(d=>{o=!0,r&&clearTimeout(r),r=null;try{if(a.offlineReady){let u=String(d?.idbKind||d?.name||"").toLowerCase();u.includes("timeout")?(a.offlineInitStatus="timeout",a.offlineInitError="\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435 \u043E\u0442\u0432\u0435\u0447\u0430\u0435\u0442 (\u0442\u0430\u0439\u043C\u0430\u0443\u0442 \u0447\u0442\u0435\u043D\u0438\u044F \u0441\u043F\u0438\u0441\u043A\u0430 \u0441\u0442\u0430\u0442\u0435\u0439). \u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443."):u.includes("quota")?(a.offlineInitStatus="quota",a.offlineInitError="\u041D\u0435\u0434\u043E\u0441\u0442\u0430\u0442\u043E\u0447\u043D\u043E \u043C\u0435\u0441\u0442\u0430 \u0434\u043B\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u043A\u044D\u0448\u0430. \u041E\u0447\u0438\u0441\u0442\u0438\u0442\u0435 \u043A\u044D\u0448 \u043A\u0430\u0440\u0442\u0438\u043D\u043E\u043A \u0438\u043B\u0438 \u043E\u0441\u0432\u043E\u0431\u043E\u0434\u0438\u0442\u0435 \u043C\u0435\u0441\u0442\u043E."):(a.offlineInitStatus="error",a.offlineInitError="\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0440\u043E\u0447\u0438\u0442\u0430\u0442\u044C \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A \u0441\u0442\u0430\u0442\u0435\u0439. \u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438\u043B\u0438 \u0441\u0431\u0440\u043E\u0441\u044C\u0442\u0435 \u043E\u0444\u0444\u043B\u0430\u0439\u043D\u2011\u043A\u044D\u0448.")}}catch{}return null}),c=await Promise.race([s,i]);if(c&&c.length)return rc||(rc=Xd({timeoutMs:t}).then(async d=>{try{typeof requestIdleCallback=="function"?requestIdleCallback(()=>pr(d).catch(()=>{}),{timeout:2500}):setTimeout(()=>pr(d).catch(()=>{}),250)}catch{pr(d).catch(()=>{})}}).catch(()=>{}).finally(()=>{rc=null})),c;let l=await Xd({timeoutMs:t});try{typeof requestIdleCallback=="function"?requestIdleCallback(()=>pr(l).catch(()=>{}),{timeout:2500}):setTimeout(()=>pr(l).catch(()=>{}),250)}catch{pr(l).catch(()=>{})}try{let d=await or().catch(()=>null),u=Array.isArray(l)?l.length:0,m=d&&Array.isArray(d)?d.length:0;if(m>=20&&u<=3||dg()&&m&&m>u)return d}catch{}return l})().catch(async n=>{let r=await or().catch(()=>null);if(r&&r.length)return r;throw n}).finally(()=>{oi=null}),oi}function tu(){return typeof navigator<"u"&&navigator&&navigator.onLine===!1?Promise.resolve([]):He("/api/articles/deleted").catch(async e=>[])}function nu(e,t={}){let n=String(e||"").trim();e=n.startsWith("inbox-")?"inbox":n;let{cacheTimeoutMs:o,metaTimeoutMs:i,...s}=t||{},c=a?.offlineReady?400:150,l=typeof o=="number"?Math.max(0,Math.floor(o)):c,d=typeof i=="number"?Math.max(0,Math.floor(i)):350,u=ss()?performance.now():0,m=null,y=!1,w=new Promise(O=>{m=setTimeout(()=>{!y&&u&&un("[offline-first][article] cache.lookup.timeout",{id:e,cacheTimeoutMs:l}),O(null)},l)}),g=Sr(e).then(O=>(y=!0,m&&clearTimeout(m),m=null,u&&un("[offline-first][article] cache.lookup.done",{id:e,ms:Math.round(performance.now()-u),hit:!!O}),O)).catch(O=>(y=!0,m&&clearTimeout(m),m=null,u&&un("[offline-first][article] cache.lookup.failed",{id:e,ms:Math.round(performance.now()-u),message:O?.message||String(O||"")}),null)),f=Promise.race([g,w]),h=()=>He(`/api/articles/${e}?include_history=0`,{...s,cache:"no-store"}).then(async O=>{try{ht("article.fetch.network.ok",{articleId:e,updatedAt:O?.updatedAt||null,docHash:Qt(O?.docJson||null)})}catch{}return Rr(O).catch(()=>{}),O&&O.id&&String(O.id)!==String(e)&&Ud(O,e).catch(()=>{}),O}).catch(async O=>{let W=await Sr(e).catch(()=>null);try{ht("article.fetch.network.err",{articleId:e,message:O?.message||String(O||""),cachedHit:!!W,cachedUpdatedAt:W?.updatedAt||null,cachedDocHash:Qt(W?.docJson||null)})}catch{}if(W)return W;throw O}),b=()=>{let O=new Date().toISOString(),J={type:"doc",content:[{type:"outlineSection",attrs:{id:(globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?()=>globalThis.crypto.randomUUID():()=>`id-${Date.now()}-${Math.random().toString(16).slice(2)}`)(),collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}]};return{id:"inbox",title:"\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438",createdAt:O,updatedAt:O,deletedAt:null,parentId:null,position:0,authorId:null,publicSlug:null,encrypted:!1,docJson:J,history:[]}},S="ttree_pending_quick_notes_v1",k=()=>{try{let O=window?.localStorage?.getItem?.(S)||"";if(!O)return[];let W=JSON.parse(O);return Array.isArray(W)?W.filter(Boolean):[]}catch{return[]}},A=(O,W)=>{let J=String(O||"").trim();if(!J)return null;let me=String(W||"").trim().split(/\r?\n/),we=[];for(let te=0;te<me.length;te+=1){let he=me[te];he&&we.push({type:"text",text:he}),te!==me.length-1&&we.push({type:"hardBreak"})}return{type:"outlineSection",attrs:{id:J,collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[we.length?{type:"paragraph",content:we}:{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}},v=O=>{try{if(!O||String(O.id||"")!=="inbox")return O;let W=k();if(!W.length)return O;let J=O?.docJson&&typeof O.docJson=="object"?O.docJson:{type:"doc",content:[]},ne=Array.isArray(J.content)?J.content:[],me=new Set(ne.filter(te=>te&&te.type==="outlineSection"&&te.attrs&&te.attrs.id).map(te=>String(te.attrs.id))),we=[];for(let te of W){let he=String(te?.sectionId||te?.id||"").trim();if(!he||me.has(he))continue;let Je=A(he,te?.text||"");Je&&we.push(Je)}return we.length?{...O,docJson:{...J,type:J.type||"doc",content:[...we,...ne]}}:O}catch{return O}},B=()=>He(`/api/articles/${encodeURIComponent(e)}/meta`,{method:"GET",headers:{...s.headers||{}},cache:"no-store"}),H=()=>d?Promise.race([B(),new Promise((O,W)=>setTimeout(()=>{let J=new Error("meta_timeout");J.name="TimeoutError",W(J)},d))]):B();return f.then(async O=>{if(!O){if(!navigator.onLine&&String(e)==="inbox"){try{let we=await Promise.race([g,new Promise(te=>setTimeout(()=>te(null),Math.max(500,d*5)))]);if(we){un("[offline-first][article] choose.cache.late.offline.inbox",{id:e});try{ht("article.choose",{articleId:e,choose:"cache.late.offline.inbox"})}catch{}return v(we)}}catch{}return un("[offline-first][article] choose.local.inbox.offline",{id:e}),v(b())}let J=g.then(we=>we?{src:"cache",article:v(we)}:new Promise(()=>{})).catch(()=>new Promise(()=>{})),ne=(async()=>({src:"network",article:await v(h())}))(),me=await Promise.race([J,ne]);if(me?.src==="cache"){un("[offline-first][article] choose.cache.late",{id:e});try{ht("article.choose",{articleId:e,choose:"cache.late"})}catch{}return ne.catch(()=>{}),me.article}un("[offline-first][article] choose.network.no-cache",{id:e});try{ht("article.choose",{articleId:e,choose:"network.no_cache"})}catch{}return me.article}if(!navigator.onLine){un("[offline-first][article] choose.cache.offline",{id:e,updatedAt:O?.updatedAt||null});try{ht("article.choose",{articleId:e,choose:"cache.offline",cachedUpdatedAt:O?.updatedAt||null,cachedDocHash:Qt(O?.docJson||null)})}catch{}return v(O)}let W=String(O.updatedAt||O.updated_at||"").trim();if(!W){un("[offline-first][article] choose.network.no-cached-updatedAt",{id:e});try{ht("article.choose",{articleId:e,choose:"network.no_cached_updatedAt",cachedDocHash:Qt(O?.docJson||null)})}catch{}return v(await h())}try{un("[offline-first][article] meta.check.start",{id:e,cachedUpdatedAt:W});let J=await H(),ne=String(J?.updatedAt||"").trim();if(ne&&ne===W){un("[offline-first][article] choose.cache.meta.same",{id:e,cachedUpdatedAt:W});try{ht("article.choose",{articleId:e,choose:"cache.meta.same",cachedUpdatedAt:W,serverUpdatedAt:ne,cachedDocHash:Qt(O?.docJson||null)})}catch{}return v(O)}un("[offline-first][article] choose.network.meta.diff",{id:e,cachedUpdatedAt:W,serverUpdatedAt:ne||null});try{ht("article.choose",{articleId:e,choose:"network.meta.diff",cachedUpdatedAt:W,serverUpdatedAt:ne||null,cachedDocHash:Qt(cached?.docJson||null)})}catch{}return v(await h())}catch(J){String(J?.name||"")==="TimeoutError"||String(J?.message||"")==="meta_timeout"?un("[offline-first][article] meta.check.timeout",{id:e,metaTimeoutMs:d}):un("[offline-first][article] meta.check.failed",{id:e,message:J?.message||String(J||"")}),h().catch(()=>{}),String(J?.name||"")==="TimeoutError"||String(J?.message||"")==="meta_timeout"?un("[offline-first][article] choose.cache.meta.timeout",{id:e,cachedUpdatedAt:W,metaTimeoutMs:d}):un("[offline-first][article] choose.cache.meta.failed",{id:e,cachedUpdatedAt:W});try{ht("article.choose",{articleId:e,choose:String(J?.name||"")==="TimeoutError"||String(J?.message||"")==="meta_timeout"?"cache.meta.timeout":"cache.meta.failed",cachedUpdatedAt:W,cachedDocHash:Qt(O?.docJson||null),error:J?.message||String(J||"")})}catch{}return v(O)}})}function ru(e){return e?He(`/api/articles/${encodeURIComponent(e)}/history`,{method:"GET"}):Promise.reject(new Error("articleId is required"))}function ou(e){return He(`/api/search?q=${encodeURIComponent(e.trim())}`)}function iu(e){let t=(e||"").trim();return t?Gd(t).then(n=>Array.isArray(n)&&n.length?n:He(`/api/search?q=${encodeURIComponent(t)}`)).catch(()=>He(`/api/search?q=${encodeURIComponent(t)}`)):Promise.resolve([])}function su(e,t){return He("/api/search/semantic/rag-summary",{method:"POST",body:JSON.stringify({query:(e||"").trim(),results:Array.isArray(t)?t:[]})})}function au(e,t={}){let n=t&&typeof t=="object"?t.parentId??null:null,r=()=>{let s={title:e};return n&&(s.parentId=n),He("/api/articles",{method:"POST",body:JSON.stringify(s)})};if(navigator.onLine)return r().then(async s=>(Rr(s).catch(()=>{}),s));let o=globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?globalThis.crypto.randomUUID():`id-${Date.now()}-${Math.random().toString(16).slice(2)}`,i=new Date().toISOString();return or().catch(()=>[]).then(s=>{let d=(Array.isArray(s)?s:[]).filter(m=>String(m?.parentId||"")===String(n||"")).reduce((m,y)=>Math.max(m,Number(y.position||0)),-1),u={id:o,title:e||"\u041D\u043E\u0432\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F",updatedAt:i,createdAt:i,docJson:null,blocks:[],encrypted:!1,parentId:n||null,position:d+1};return Rr(u).catch(()=>{}),Gt("create_article",{articleId:o,payload:{id:o,title:u.title,parentId:n||null}}).catch(()=>{}),u})}function cu(e,t){return e?!t||typeof t!="object"?Promise.reject(new Error("docJson must be object")):He(`/api/articles/${encodeURIComponent(e)}/doc-json`,{method:"PUT",body:JSON.stringify({docJson:t})}):Promise.reject(new Error("articleId is required"))}function lu(e){return typeof e!="string"?Promise.reject(new Error("text must be string")):He("/api/outline/generate-title",{method:"POST",body:JSON.stringify({text:e})})}function oc(e){return typeof e!="string"?Promise.reject(new Error("html must be string")):He("/api/outline/proofread-html",{method:"POST",body:JSON.stringify({html:e})})}function as(e,t={}){let n=t.force?"?force=true":"";return He(`/api/articles/${e}${n}`,{method:"DELETE"}).then(r=>{let o=n?new Date().toISOString():new Date().toISOString();return ko(e,o).catch(()=>{}),r})}function du(e){return He(`/api/articles/${e}/restore`,{method:"POST"})}function uu(e,t,n={}){let r=Array.isArray(t)?t.filter(Boolean).map(o=>String(o)):[];return e?r.length?He(`/api/articles/${encodeURIComponent(e)}/sections/delete`,{method:"PUT",cache:"no-store",body:JSON.stringify({opId:n?.opId||null,sectionIds:r})}):Promise.resolve({status:"ok",removedBlockIds:[]}):Promise.reject(new Error("articleId is required"))}function fu(e){let t={};return e&&(t["X-Users-Password"]=e),He("/api/users",{headers:t})}function pu(e){return He(`/api/users/${e}`,{method:"DELETE"})}function mu(){return He("/api/telegram/link-token",{method:"POST",body:JSON.stringify({})})}function si(e){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return Promise.reject(new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D"));let t=new FormData;t.append("file",e);let n=i=>{if(!(typeof navigator<"u"&&navigator&&navigator.onLine===!1))try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"uploadImageFile",data:i})}).catch(()=>{})}catch{}},r=()=>fetch("/api/uploads",{method:"POST",credentials:"include",body:t}).then(async i=>{let s=await i.json().catch(()=>null);if(n({transport:"fetch",status:i.status,ok:i.ok,details:s,name:e&&e.name,type:e&&e.type,size:e&&e.size}),!i.ok){let c=s?.detail||`Upload failed (status ${i.status})`,l=new Error(c);throw l.status=i.status,l.details=s,l}return s}),o=()=>new Promise((i,s)=>{let c=new XMLHttpRequest;c.open("POST","/api/uploads"),c.withCredentials=!0,c.onreadystatechange=()=>{if(c.readyState===XMLHttpRequest.DONE)try{let l=c.status,d=null;try{d=JSON.parse(c.responseText||"null")}catch{d=null}if(n({transport:"xhr",status:l,ok:l>=200&&l<300,details:d,name:e&&e.name,type:e&&e.type,size:e&&e.size}),l>=200&&l<300)i(d);else{let u=d&&d.detail||`Upload failed (status ${l})`,m=new Error(u);m.status=l,m.details=d,s(m)}}catch(l){s(l)}},c.onerror=()=>{n({transport:"xhr",status:0,ok:!1,details:{detail:"Network error during image upload"},name:e&&e.name,type:e&&e.type,size:e&&e.size});let l=new Error("Upload failed (network error)");l.status=0,l.details={detail:"Network error during image upload"},s(l)},c.send(t)});return r().catch(i=>{let s=String(i&&i.message?i.message:"").toLowerCase();if(s.includes("status ")||s.includes("upload failed"))throw i;return o()})}function hu(e,t=null){if(!e)return Promise.reject(new Error("articleId is required"));let n={};return t&&(n.label=String(t)),He(`/api/articles/${encodeURIComponent(e)}/versions`,{method:"POST",body:JSON.stringify(n)})}function gu(e){return e?He(`/api/articles/${encodeURIComponent(e)}/versions`,{method:"GET"}):Promise.reject(new Error("articleId is required"))}function yu(e,t){return e?t?He(`/api/articles/${encodeURIComponent(e)}/versions/${encodeURIComponent(t)}/restore`,{method:"POST",body:JSON.stringify({})}):Promise.reject(new Error("versionId is required")):Promise.reject(new Error("articleId is required"))}function ic(e,t){return e?t?He(`/api/articles/${encodeURIComponent(e)}/versions/${encodeURIComponent(t)}`,{method:"GET"}):Promise.reject(new Error("versionId is required")):Promise.reject(new Error("articleId is required"))}function ug(e,t,n=()=>{},{sectionId:r}={}){return typeof navigator<"u"&&navigator&&navigator.onLine===!1?Promise.reject(new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D")):new Promise((o,i)=>{let s=new XMLHttpRequest;s.open("POST",`/api/articles/${e}/attachments`),s.withCredentials=!0,s.upload.onprogress=l=>{if(l.lengthComputable){let d=Math.round(l.loaded/l.total*100);n(d)}},s.onreadystatechange=()=>{if(s.readyState===XMLHttpRequest.DONE)if(s.status>=200&&s.status<300)try{let l=JSON.parse(s.responseText||"{}");o(l)}catch(l){i(l)}else{let l=`Attachment upload failed (status ${s.status})`;try{let d=JSON.parse(s.responseText||"{}");d?.detail&&(l=d.detail)}catch{}i(new Error(l))}},s.onerror=()=>i(new Error("Network error during upload"));let c=new FormData;c.append("file",t),r&&c.append("sectionId",String(r)),s.send(c)})}function ii(e){let t=new Map;for(let n of e||[]){let r=n.parentId??null;t.has(r)||t.set(r,[]),t.get(r).push(n)}for(let n of t.values())n.sort((r,o)=>(r.position||0)-(o.position||0));return t}function $r(e){let t=[];for(let n=0;n<e.length;n+=1){let r=e[n];if(!r)continue;let o=n;(r.position||0)!==o&&(r.position=o,t.push({id:r.id,parentId:r.parentId??null,position:o}))}return t}function bu(e,t){return!e||!t?Promise.resolve(null):He(`/api/articles/${encodeURIComponent(e)}/move`,{method:"POST",body:JSON.stringify({direction:t})}).then(async r=>{try{let o=await or().catch(()=>[]),i=ii(o),s=(o||[]).find(c=>c.id===e);if(s){let c=i.get(s.parentId??null)||[],l=c.findIndex(m=>m.id===e),u=l+(t==="up"?-1:1);if(l!==-1&&u>=0&&u<c.length){let m=c[l];c[l]=c[u],c[u]=m;let y=$r(c);Ao(y).catch(()=>{})}}}catch{}return r}).catch(async()=>{let r=await or().catch(()=>[]),o=ii(r),i=(r||[]).find(y=>y.id===e);if(!i)return null;let s=o.get(i.parentId??null)||[],c=s.findIndex(y=>y.id===e);if(c===-1)return null;let d=c+(t==="up"?-1:1);if(d<0||d>=s.length)return null;let u=s[c];s[c]=s[d],s[d]=u;let m=$r(s);return Ao(m).catch(()=>{}),Gt("move_article_position",{articleId:e,payload:{direction:t},coalesceKey:`${e}:move`}).catch(()=>{}),{id:e}})}function wu(e){return e?He(`/api/articles/${encodeURIComponent(e)}/indent`,{method:"POST",body:JSON.stringify({})}).catch(async()=>{let n=await or().catch(()=>[]),r=ii(n),o=(n||[]).find(m=>m.id===e);if(!o)return null;let i=r.get(o.parentId??null)||[],s=i.findIndex(m=>m.id===e);if(s<=0)return null;let l=i[s-1]?.id||null;o.parentId=l;let d=r.get(l)||[];d.push(o);let u=[];return u.push(...$r(i.filter(m=>m.id!==e))),u.push(...$r(d)),Ao(u).catch(()=>{}),Gt("indent_article",{articleId:e,payload:{},coalesceKey:`${e}:indent`}).catch(()=>{}),{id:e}}):Promise.resolve(null)}function Su(e){return e?He(`/api/articles/${encodeURIComponent(e)}/outdent`,{method:"POST",body:JSON.stringify({})}).catch(async()=>{let n=await or().catch(()=>[]),r=ii(n),o=(n||[]).find(g=>g.id===e);if(!o)return null;let i=o.parentId??null;if(!i)return null;let c=(n||[]).find(g=>g.id===i)?.parentId??null,d=(r.get(i)||[]).filter(g=>g.id!==e),u=r.get(c)||[],m=u.findIndex(g=>g.id===i),y=m===-1?u.length:m+1;o.parentId=c,u.splice(y,0,o);let w=[];return w.push(...$r(d)),w.push(...$r(u)),Ao(w).catch(()=>{}),Gt("outdent_article",{articleId:e,payload:{},coalesceKey:`${e}:outdent`}).catch(()=>{}),{id:e}}):Promise.resolve(null)}function cs(e,t){return e?He(`/api/articles/${encodeURIComponent(e)}/move-tree`,{method:"POST",body:JSON.stringify(t||{})}).catch(async()=>{let r=await or().catch(()=>[]),o=ii(r),i=(r||[]).find(h=>h.id===e);if(!i)return null;let s=t&&t.placement||null,c=t&&t.anchorId||null,l=t?t.parentId??null:null;s==="inside"&&c&&(l=c);let d=i.parentId??null,m=(o.get(d)||[]).filter(h=>h.id!==e),w=(o.get(l)||[]).filter(h=>h.id!==e),g=w.length;if(c){let h=w.findIndex(b=>b.id===c);h!==-1&&(s==="before"?g=h:s==="after"?g=h+1:s==="inside"&&(g=w.length))}i.parentId=l,w.splice(g,0,i);let f=[];return f.push(...$r(m)),f.push(...$r(w)),Ao(f).catch(()=>{}),Gt("move_article_tree",{articleId:e,payload:t||{},coalesceKey:`${e}:move-tree`}).catch(()=>{}),{id:e}}):Promise.resolve(null)}async function fg({articleId:e,filename:t,overwrite:n=!1,sha256:r="",size:o=0}){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D");let s=await fetch("/api/yandex/disk/upload-url",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({filename:t||"",articleId:e||"",overwrite:!!n,sha256:r||"",size:typeof o=="number"?o:0})}),c=await s.json().catch(()=>null);if(!s.ok){let l=c&&c.detail||`Yandex upload URL failed (status ${s.status})`;throw new Error(l)}return c}async function Zd(e,{path:t,originalName:n,contentType:r,size:o,sectionId:i}){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D");let s={path:t||"",originalName:n||"",contentType:r||"",size:typeof o=="number"?o:0};i&&(s.sectionId=String(i));let c=await fetch(`/api/articles/${e}/attachments/yandex`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),l=await c.json().catch(()=>null);if(!c.ok){let d=l&&l.detail||`Register Yandex attachment failed (status ${c.status})`;throw new Error(d)}return l}async function ls(e,t,{onProgress:n,sectionId:r}={}){if(!t)throw new Error("\u0424\u0430\u0439\u043B \u043D\u0435 \u0443\u043A\u0430\u0437\u0430\u043D");let o="";try{if(window.crypto&&window.crypto.subtle&&typeof t.arrayBuffer=="function"){let y=await t.arrayBuffer(),w=await window.crypto.subtle.digest("SHA-256",y),g=new Uint8Array(w);o=Array.from(g).map(f=>f.toString(16).padStart(2,"0")).join("")}}catch{o=""}let{href:i,method:s,path:c,exists:l,same:d}=await fg({articleId:e,filename:t.name||"attachment",overwrite:!1,sha256:o,size:t.size||0});if(l&&d&&!i)return await Zd(e,{path:c,originalName:t.name||"attachment",contentType:t.type||"",size:t.size||0,sectionId:r});let u=!1;if(i)try{await new Promise((y,w)=>{let g=new XMLHttpRequest;g.open(s||"PUT",i),g.upload.onprogress=f=>{if(n&&f.lengthComputable){let h=Math.round(f.loaded/f.total*100);try{n(h)}catch{}}},g.onreadystatechange=()=>{g.readyState===XMLHttpRequest.DONE&&(g.status>=200&&g.status<300?y():w(new Error(`Yandex upload failed (status ${g.status})`)))},g.onerror=()=>w(new Error("Network error during Yandex upload")),g.send(t)}),u=!0}catch(y){console.warn("[attachments] Direct Yandex upload failed, falling back to server upload",y),u=!1}return u?await Zd(e,{path:c,originalName:t.name||"attachment",contentType:t.type||"",size:t.size||0,sectionId:r}):await ug(e,t,n,{sectionId:r})}function ds(e,t={}){let n=new FormData;return n.append("file",e),t.mode&&n.append("mode",t.mode),t.versionPrefix&&n.append("versionPrefix",t.versionPrefix),fetch("/api/import/html",{method:"POST",credentials:"include",body:n}).then(async r=>{let o=await r.json().catch(()=>null);if(!r.ok){let i=o?.detail||`Import failed (status ${r.status})`;throw new Error(i)}return o})}function xu(e,t=""){let n=new FormData;return n.append("file",e),t&&typeof t=="string"&&n.append("assetsBaseUrl",t),fetch("/api/import/markdown",{method:"POST",credentials:"include",body:n}).then(async r=>{let o=await r.json().catch(()=>null);if(!r.ok){let i=o?.detail||`Import failed (status ${r.status})`;throw new Error(i)}return o})}function ku(e,t=""){let n=new FormData;return n.append("file",e),t&&typeof t=="string"&&n.append("assetsBaseUrl",t),fetch("/api/import/logseq",{method:"POST",credentials:"include",body:n}).then(async r=>{let o=await r.json().catch(()=>null);if(!r.ok){let i=o?.detail||`Import failed (status ${r.status})`;throw new Error(i)}return o})}var cg,oi,rc,lg,Xt=Ke(()=>{Hr();eo();Qd();At();ri();cg="ttree_profile_v1";oi=null,rc=null,lg="ttree_offline_recovery_force_index_v1"});function qt(...e){console.log("[debug]",...e)}function gt(e=""){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function us(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function ai(e=""){let t=document.createElement("template");return t.innerHTML=e||"",(t.content.textContent||"").replace(/\s+/g," ").trim()}function Au(e=""){let t=(e||"").replace(/<br\s*\/?>/gi,`
`).replace(/<\/(?:div|p|li|h[1-6])>/gi,`
`),n=document.createElement("template");return n.innerHTML=t,(n.content.textContent||"").split(`
`).map(r=>r.replace(/\s+/g," ").trim()).filter(r=>r.length)}function Iu(e){if(!e)return!1;if(e.isContentEditable)return!0;let t=e.tagName?e.tagName.toLowerCase():"";return t==="input"||t==="textarea"||t==="select"}function fs(e){if(!e||!e.isConnected)return;let t=window.getSelection();if(!t)return;let n=document.createRange();n.selectNodeContents(e),n.collapse(!1),t.removeAllRanges(),t.addRange(n)}function sc(e){if(!e||!e.isConnected)return;let t=window.getSelection();if(!t)return;let n=document.createRange();n.selectNodeContents(e),n.collapse(!0),t.removeAllRanges(),t.addRange(n)}function Eu(e=""){let t=document.createElement("template");return t.innerHTML=e||"",t.content.textContent||""}function ac(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=t.content.querySelectorAll("img");return Array.from(n).map(r=>({src:r.getAttribute("src")||"",alt:r.getAttribute("alt")||""}))}function ir(e,t){if(!e||!document.contains(e))return;e.focus();let n=window.getSelection();if(!n)return;let r=n.rangeCount>0?n.getRangeAt(0):document.createRange();e.contains(r.commonAncestorContainer)||(r=document.createRange(),r.selectNodeContents(e),r.collapse(!1)),n.removeAllRanges(),n.addRange(r);let o=r.createContextualFragment(t);r.deleteContents(),r.insertNode(o),r.collapse(!1),n.removeAllRanges(),n.addRange(r)}var Un=Ke(()=>{});var gc={};ur(gc,{showArticleHistoryModal:()=>fc,showArticleLinkPrompt:()=>mg,showBlockHistoryModal:()=>uc,showBlockTrashPicker:()=>mc,showConfirm:()=>Vn,showImagePreview:()=>ci,showImportConflictDialog:()=>hc,showLinkPrompt:()=>pc,showPasswordWithHintPrompt:()=>ms,showPrompt:()=>xn,showPublicLinkModal:()=>ps,showVersionCompareTargetPicker:()=>lc,showVersionDiffModal:()=>dc,showVersionsPicker:()=>cc});function Dn(){let e=document.getElementById(vu);return e||(e=document.createElement("div"),e.id=vu,document.body.appendChild(e)),e}function Gn({title:e,message:t,confirmText:n,cancelText:r,renderBody:o}){let i=document.createElement("div");i.className="modal-overlay";let s=document.createElement("form");s.className="modal-form",s.addEventListener("submit",g=>{g.preventDefault()});let c=document.createElement("div");c.className="modal-card",c.setAttribute("role","dialog"),c.setAttribute("aria-modal","true"),c.tabIndex=-1;let l=document.createElement("div");l.className="modal-header";let d=document.createElement("h3");d.textContent=e||"\u041F\u043E\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043D\u0438\u0435",l.appendChild(d);let u=document.createElement("div");if(u.className="modal-body",typeof o=="function"){let g=o();Array.isArray(g)?g.forEach(f=>{f&&u.appendChild(f)}):g&&u.appendChild(g)}else u.textContent=t||"";let m=document.createElement("div");m.className="modal-footer modal-footer--stacked";let y=document.createElement("button");y.type="button",y.className="ghost",y.textContent=r||"\u041E\u0442\u043C\u0435\u043D\u0430";let w=document.createElement("button");return w.type="button",w.className="primary danger-btn",w.textContent=n||"\u0423\u0434\u0430\u043B\u0438\u0442\u044C",m.appendChild(w),m.appendChild(y),c.appendChild(l),c.appendChild(u),c.appendChild(m),s.appendChild(c),i.appendChild(s),{overlay:i,card:c,confirmBtn:w,cancelBtn:y,form:s}}function pg(e="",t=""){let n=String(e||"").length,r=String(t||"").length;if(n*r>2e6||n+r>2e4)return null;let s=Array.from(e),c=Array.from(t),l=s.length,d=c.length,u=Array.from({length:l+1},()=>new Array(d+1).fill(0));for(let f=l-1;f>=0;f-=1)for(let h=d-1;h>=0;h-=1)s[f]===c[h]?u[f][h]=u[f+1][h+1]+1:u[f][h]=Math.max(u[f+1][h],u[f][h+1]);let m=[],y=0,w=0;for(;y<l&&w<d;)s[y]===c[w]?(m.push({type:"same",value:s[y]}),y+=1,w+=1):u[y+1][w]>=u[y][w+1]?(m.push({type:"removed",value:s[y]}),y+=1):(m.push({type:"added",value:c[w]}),w+=1);for(;y<l;)m.push({type:"removed",value:s[y]}),y+=1;for(;w<d;)m.push({type:"added",value:c[w]}),w+=1;let g=[];return m.forEach(f=>{if(!f.value)return;let h=g[g.length-1];h&&h.type===f.type?h.value+=f.value:g.push({type:f.type,value:f.value})}),g}function Io({baseText:e="",nextText:t="",mode:n="before"}={}){let r=document.createDocumentFragment(),o=pg(e,t);if(!o){let s=String(n==="before"?e||"":t||""),c=s.length>2e5?`${s.slice(0,2e5)}

\u2026(\u043E\u0431\u0440\u0435\u0437\u0430\u043D\u043E)`:s,l=document.createElement("div");l.className="meta",l.style.marginBottom="6px",l.textContent="Diff \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 \u2014 \u043F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0435\u043C \u0442\u0435\u043A\u0441\u0442 \u0431\u0435\u0437 \u043F\u043E\u0434\u0441\u0432\u0435\u0442\u043A\u0438.";let d=document.createElement("pre");return d.className="diff-plain",d.style.whiteSpace="pre-wrap",d.style.wordBreak="break-word",d.textContent=c,r.appendChild(l),r.appendChild(d),r}return o.forEach(i=>{if(n==="before"&&i.type==="added"||n==="after"&&i.type==="removed")return;let s=document.createElement("span");s.className="diff-seg",i.type==="added"&&s.classList.add("diff-seg--added"),i.type==="removed"&&s.classList.add("diff-seg--removed"),s.textContent=i.value,r.appendChild(s)}),r}function Vn(e={}){let t=Dn(),{overlay:n,card:r,confirmBtn:o,cancelBtn:i,form:s}=Gn(e),c=!1,l=()=>{},d=()=>{n.classList.add("modal-overlay--hide"),setTimeout(()=>n.remove(),150),document.removeEventListener("keydown",m)},u=y=>{c||(c=!0,d(),l(y))},m=y=>{y.code==="Escape"&&(y.preventDefault(),u(!1)),y.code==="Enter"&&(y.preventDefault(),u(!0))};return new Promise(y=>{l=y,s.addEventListener("submit",w=>{w.preventDefault(),u(!0)}),o.addEventListener("click",()=>u(!0)),i.addEventListener("click",()=>u(!1)),n.addEventListener("click",w=>{w.target===n&&u(!1)}),document.addEventListener("keydown",m),t.appendChild(n),requestAnimationFrame(()=>{r.focus({preventScroll:!0})})})}function xn(e={}){let t=Dn(),n=null,r=null,o=Array.isArray(e.suggestions)?e.suggestions:[],i=null,{overlay:s,card:c,confirmBtn:l,cancelBtn:d,form:u}=Gn({...e,renderBody:()=>{let S=document.createDocumentFragment();if(e.message){let A=document.createElement("p");A.className="modal-body__text",A.textContent=e.message,S.appendChild(A)}let k=document.createElement("input");if(k.type=e.inputType==="password"?"password":"text",k.className="modal-input",k.placeholder=e.placeholder||"",k.value=e.defaultValue||"",k.autocomplete="off",S.appendChild(k),e.checkbox&&typeof e.checkbox=="object"){let A=document.createElement("label");A.className="modal-checkbox";let v=document.createElement("input");v.type="checkbox",v.checked=!!e.checkbox.checked,v.disabled=!!e.checkbox.disabled;let B=document.createElement("span");B.className="modal-checkbox__label",B.textContent=String(e.checkbox.label||"").trim(),A.appendChild(v),A.appendChild(B),S.appendChild(A),r=v}return o.length&&(i=document.createElement("div"),i.className="modal-suggestions",S.appendChild(i)),n=k,S}}),m=!1,y=()=>{},w=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",f)},g=S=>{if(!m)if(m=!0,w(),e.returnMeta){let k={value:S??null,selectedId:n?.dataset?.selectedId||null,checkboxChecked:r?!!r.checked:null};y(k)}else y(S)},f=S=>{if(S.code==="Escape"){S.preventDefault(),g(null);return}if(S.code==="Enter"&&n&&!e.hideConfirm){let k=n.value.trim();if(!k&&!e.allowEmpty)return;S.preventDefault(),g(k)}},h=()=>{if(!l||!n)return;let S=!!n.value.trim();l.disabled=!S&&!e.allowEmpty},b=()=>{if(!i||!n)return;let S=n.value.trim().toLowerCase();n.dataset.selectedId="";let k=o.filter(A=>(A.title||"").toLowerCase().includes(S)||(A.id||"").toLowerCase().includes(S)).slice(0,8);if(i.innerHTML="",!S||!k.length){i.classList.add("hidden");return}i.classList.remove("hidden"),k.forEach(A=>{let v=document.createElement("button");v.type="button",v.className="modal-suggestion",v.textContent=A.title||A.id||"",v.addEventListener("click",()=>{n.value=A.title||A.id||"",n.dataset.selectedId=A.id||"",h(),b(),g(n.value)}),i.appendChild(v)})};return new Promise(S=>{y=S,l.classList.remove("danger-btn"),e.hideConfirm?l.style.display="none":l.textContent=e.confirmText||"OK",d.textContent=e.cancelText||"Cancel";let k=()=>{if(!n){g(null);return}let A=n.value.trim();if(!A){n.focus();return}g(A)};u.addEventListener("submit",A=>{A.preventDefault(),k()}),l.addEventListener("click",k),d.addEventListener("click",()=>g(null)),s.addEventListener("click",A=>{A.target===s&&g(null)}),document.addEventListener("keydown",f),n?(n.dataset.selectedId="",n.addEventListener("input",()=>{n.dataset.selectedId="",h(),o.length&&b()}),e.hideConfirm&&n.addEventListener("keydown",A=>{A.code==="Enter"&&(A.preventDefault(),g(n.value.trim()))}),h(),o.length&&b()):h(),t.appendChild(s),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):c.focus({preventScroll:!0})})})}function mg(e={}){let t=Dn(),n=null,r=null,o=Array.isArray(e.suggestions)?e.suggestions:[],i=null,{overlay:s,card:c,confirmBtn:l,cancelBtn:d,form:u}=Gn({title:e.title||"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",renderBody:()=>{let S=document.createDocumentFragment();if(e.message){let H=document.createElement("p");H.className="modal-body__text",H.textContent=e.message,S.appendChild(H)}let k=document.createElement("label");k.className="modal-label",k.textContent=e.articleLabel||"\u0421\u0442\u0430\u0442\u044C\u044F";let A=document.createElement("input");A.type="text",A.className="modal-input",A.placeholder=e.articlePlaceholder||"ID \u0438\u043B\u0438 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435\u2026",A.value=e.defaultArticleValue||"",A.autocomplete="off",k.appendChild(A),S.appendChild(k),n=A,o.length&&(i=document.createElement("div"),i.className="modal-suggestions",S.appendChild(i));let v=document.createElement("label");v.className="modal-label",v.textContent=e.textLabel||"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)";let B=document.createElement("input");return B.type="text",B.className="modal-input",B.placeholder=e.textPlaceholder||"",B.value=e.defaultTextValue||"",B.autocomplete="off",v.appendChild(B),S.appendChild(v),r=B,S}}),m=!1,y=()=>{},w=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",b)},g=S=>{m||(m=!0,w(),y(S))},f=()=>{if(!l||!n)return;let S=!!n.value.trim()||!!n.dataset.selectedId;l.disabled=!S},h=()=>{if(!i||!n)return;let S=n.value.trim().toLowerCase();n.dataset.selectedId="";let k=o.filter(A=>(A.title||"").toLowerCase().includes(S)||(A.id||"").toLowerCase().includes(S)).slice(0,8);if(i.innerHTML="",!S||!k.length){i.classList.add("hidden");return}i.classList.remove("hidden"),k.forEach(A=>{let v=document.createElement("button");v.type="button",v.className="modal-suggestion",v.textContent=A.title||A.id||"",v.addEventListener("click",()=>{n.value=A.title||A.id||"",n.dataset.selectedId=A.id||"",f(),h(),r&&!r.value.trim()&&!e.lockTextValue&&(r.value=A.title||""),r?.focus?.({preventScroll:!0}),r?.select?.()}),i.appendChild(v)})},b=S=>{if(S.code==="Escape"){S.preventDefault(),g(null);return}S.code};return new Promise(S=>{y=S,l.classList.remove("danger-btn"),l.textContent=e.confirmText||"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",d.textContent=e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430";let k=()=>{if(!n||!r){g(null);return}let A=n.value.trim(),v=n.dataset.selectedId||"";if(!A&&!v){n.focus();return}g({articleValue:A,selectedId:v||null,textValue:r.value??""})};u.addEventListener("submit",A=>{A.preventDefault(),k()}),l.addEventListener("click",k),d.addEventListener("click",()=>g(null)),s.addEventListener("click",A=>{A.target===s&&g(null)}),document.addEventListener("keydown",b),n?(n.dataset.selectedId="",n.addEventListener("input",()=>{n.dataset.selectedId="",f(),o.length&&h()}),f(),o.length&&h()):f(),t.appendChild(s),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):c.focus({preventScroll:!0})})})}function ps(e={}){let t=Dn(),n=null,r=e.url||"",{overlay:o,card:i,confirmBtn:s,cancelBtn:c}=Gn({title:e.title||"\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u0430\u044F \u0441\u0441\u044B\u043B\u043A\u0430",renderBody:()=>{let f=document.createDocumentFragment(),h=document.createElement("label");h.className="modal-label",h.textContent=e.label||"\u041F\u0440\u043E\u0441\u043C\u043E\u0442\u0440 \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435";let b=document.createElement("input");return b.type="text",b.className="modal-input",b.value=r,b.readOnly=!0,b.autocomplete="off",h.appendChild(b),n=b,f.appendChild(h),f}}),l=!1,d=()=>{},u=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",y)},m=()=>{l||(l=!0,u(),d())},y=f=>{f.code==="Escape"&&(f.preventDefault(),m())},w=f=>{if(!f)return!1;let h=document.createElement("textarea");h.value=f,h.setAttribute("readonly",""),h.style.position="absolute",h.style.left="-9999px",document.body.appendChild(h),h.focus(),h.select();let b=!1;try{b=document.execCommand("copy")}catch{b=!1}return document.body.removeChild(h),b},g=()=>{let f=n&&n.value||r;if(f){P("\u0421\u0441\u044B\u043B\u043A\u0430 \u0441\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u0430");try{if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function"){let h=navigator.clipboard.writeText(f);h&&typeof h.catch=="function"&&h.catch(()=>{w(f)})}else w(f)}catch{w(f)}}};return new Promise(f=>{d=f,s.classList.remove("danger-btn"),s.innerHTML='<i class="bx bx-copy" aria-hidden="true"></i> \u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443',s.setAttribute("aria-label",e.copyLabel||"\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443"),c.classList.add("hidden"),s.addEventListener("click",()=>{g(),m()}),o.addEventListener("click",h=>{h.target===o&&m()}),document.addEventListener("keydown",y),t.appendChild(o),requestAnimationFrame(()=>{n?n.focus({preventScroll:!0}):i.focus({preventScroll:!0})})})}function cc(e={}){let t=Dn(),n=Array.isArray(e.versions)?e.versions:[],r=n[0]?.id||"",o=b=>{try{let S=new Date(b);return Number.isNaN(S.getTime())?String(b||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(S)}catch{return String(b||"")}},{overlay:i,card:s,confirmBtn:c,cancelBtn:l,form:d}=Gn({title:e.title||"\u0412\u0435\u0440\u0441\u0438\u0438",confirmText:e.confirmText||"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",cancelText:e.cancelText||"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",renderBody:()=>{let b=document.createDocumentFragment(),S=document.createElement("p");if(S.className="modal-body__text",S.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0435\u0440\u0441\u0438\u044E \u0441\u0442\u0430\u0442\u044C\u0438 \u0434\u043B\u044F \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F.",b.appendChild(S),!n.length){let A=document.createElement("div");return A.className="modal-empty",A.textContent="\u0412\u0435\u0440\u0441\u0438\u0439 \u043F\u043E\u043A\u0430 \u043D\u0435\u0442.",b.appendChild(A),b}let k=document.createElement("div");return k.className="modal-list",n.forEach((A,v)=>{let B=document.createElement("label");B.className="modal-list__item";let H=document.createElement("input");H.type="radio",H.name="version",H.value=A.id||"",H.checked=v===0,H.addEventListener("change",()=>{r=H.value,c.disabled=!r,u.disabled=!r});let O=document.createElement("div");O.className="modal-list__meta";let W=document.createElement("div");W.className="modal-list__title",W.textContent=A.label||o(A.created_at||A.createdAt);let J=document.createElement("div");J.className="modal-list__subtitle";let ne=A.reason||"",me=o(A.created_at||A.createdAt);J.textContent=[me,ne].filter(Boolean).join(" \xB7 "),O.appendChild(W),O.appendChild(J),B.appendChild(H),B.appendChild(O),k.appendChild(B)}),b.appendChild(k),b}});s.classList.add("modal-card--diff-light"),c.classList.remove("danger-btn"),c.disabled=!r;let u=document.createElement("button");u.type="button",u.className="ghost",u.textContent=e.compareText||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C",u.disabled=!r;let m=s.querySelector(".modal-footer");m&&m.insertBefore(u,c);let y=!1,w=()=>{},g=()=>{i.classList.add("modal-overlay--hide"),setTimeout(()=>i.remove(),150),document.removeEventListener("keydown",h)},f=b=>{y||(y=!0,g(),w(b))},h=b=>{b.code==="Escape"&&(b.preventDefault(),f(null))};return new Promise(b=>{w=b;let S=()=>{r&&f({action:"restore",versionId:r})};d.addEventListener("submit",k=>{k.preventDefault(),S()}),c.addEventListener("click",S),u.addEventListener("click",()=>{r&&f({action:"compare",versionId:r})}),l.addEventListener("click",()=>f(null)),i.addEventListener("click",k=>{k.target===i&&f(null)}),document.addEventListener("keydown",h),t.appendChild(i),requestAnimationFrame(()=>{s.focus({preventScroll:!0})})})}function lc(e={}){let t=Dn(),n=Array.isArray(e.versions)?e.versions:[],r=String(e.excludeId||""),o=[{kind:"current",id:"__current__",title:"\u0422\u0435\u043A\u0443\u0449\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F"},...n.filter(h=>String(h.id||"")&&String(h.id||"")!==r).map(h=>({kind:"version",id:String(h.id),title:h.label||h.created_at||h.createdAt||h.id}))],i=o[0]?.id||"",{overlay:s,card:c,confirmBtn:l,cancelBtn:d,form:u}=Gn({title:e.title||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C \u0441\u2026",confirmText:e.confirmText||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C",cancelText:e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430",renderBody:()=>{let h=document.createDocumentFragment(),b=document.createElement("p");b.className="modal-body__text",b.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0442\u043E\u0440\u0443\u044E \u0441\u0442\u043E\u0440\u043E\u043D\u0443 \u0441\u0440\u0430\u0432\u043D\u0435\u043D\u0438\u044F.",h.appendChild(b);let S=document.createElement("div");return S.className="modal-list",o.forEach((k,A)=>{let v=document.createElement("label");v.className="modal-list__item";let B=document.createElement("input");B.type="radio",B.name="compareTarget",B.value=k.id,B.checked=A===0,B.addEventListener("change",()=>{i=B.value,l.disabled=!i});let H=document.createElement("div");H.className="modal-list__meta";let O=document.createElement("div");O.className="modal-list__title",O.textContent=k.title,H.appendChild(O),v.appendChild(B),v.appendChild(H),S.appendChild(v)}),h.appendChild(S),h}});c.classList.add("modal-card--diff-light"),l.classList.remove("danger-btn"),l.disabled=!i;let m=!1,y=()=>{},w=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",f)},g=h=>{m||(m=!0,w(),y(h))},f=h=>{h.code==="Escape"&&(h.preventDefault(),g(null))};return new Promise(h=>{y=h;let b=()=>{if(!i)return;let S=o.find(k=>k.id===i)||null;if(!S){g(null);return}if(S.kind==="current"){g({target:"current"});return}g({target:"version",versionId:S.id})};u.addEventListener("submit",S=>{S.preventDefault(),b()}),l.addEventListener("click",b),d.addEventListener("click",()=>g(null)),s.addEventListener("click",S=>{S.target===s&&g(null)}),document.addEventListener("keydown",f),t.appendChild(s),requestAnimationFrame(()=>{c.focus({preventScroll:!0})})})}function dc(e={}){let t=Dn(),n=Array.isArray(e.changes)?e.changes:[],r=n.find(w=>w.type==="changed")||n[0]||null,{overlay:o,card:i,confirmBtn:s,cancelBtn:c}=Gn({title:e.title||"\u041E\u0442\u043B\u0438\u0447\u0438\u044F \u0432\u0435\u0440\u0441\u0438\u0439",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:"",renderBody:()=>{let w=document.createDocumentFragment(),g=document.createElement("div");g.className="diff-summary";let f=n.reduce((W,J)=>(W[J.type]=(W[J.type]||0)+1,W),{added:0,removed:0,changed:0});if(g.textContent=`\u0418\u0437\u043C\u0435\u043D\u0435\u043D\u043E: ${f.changed||0} \xB7 \u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E: ${f.added||0} \xB7 \u0423\u0434\u0430\u043B\u0435\u043D\u043E: ${f.removed||0}`,w.appendChild(g),!n.length){let W=document.createElement("div");return W.className="modal-empty",W.textContent="\u041D\u0435\u0442 \u043E\u0442\u043B\u0438\u0447\u0438\u0439.",w.appendChild(W),w}let h=document.createElement("div");h.className="modal-list",n.forEach(W=>{let J=document.createElement("button");J.type="button",J.className=`diff-item diff-item--${W.type}${r&&r.id===W.id?" diff-item--active":""}`;let ne=W.label||W.id;J.textContent=`${W.type==="changed"?"\u2260":W.type==="added"?"+":"\u2212"} ${ne}`,J.addEventListener("click",()=>{r=W,h.querySelectorAll(".diff-item").forEach(me=>me.classList.remove("diff-item--active")),J.classList.add("diff-item--active"),O()}),h.appendChild(J)}),w.appendChild(h);let b=document.createElement("div");b.className="diff-panes";let S=document.createElement("div");S.className="diff-pane-wrap";let k=document.createElement("div");k.className="diff-pane-wrap";let A=document.createElement("div");A.className="diff-pane-title",A.textContent=e.beforeTitle||"\u0412\u0435\u0440\u0441\u0438\u044F";let v=document.createElement("div");v.className="diff-pane-title",v.textContent=e.afterTitle||"\u0422\u0435\u043A\u0443\u0449\u0430\u044F";let B=document.createElement("div");B.className="diff-pane diff-pane--before";let H=document.createElement("div");H.className="diff-pane diff-pane--after",S.appendChild(A),S.appendChild(B),k.appendChild(v),k.appendChild(H),b.appendChild(S),b.appendChild(k),w.appendChild(b);let O=()=>{let W=r?.before||"",J=r?.after||"";B.innerHTML="",H.innerHTML="",B.appendChild(Io({baseText:W,nextText:J,mode:"before"})),H.appendChild(Io({baseText:W,nextText:J,mode:"after"}))};return O(),w}});i.classList.add("modal-card--fullscreen"),i.classList.add("modal-card--diff-light"),s.classList.remove("danger-btn"),c&&(c.style.display="none");let l=!1,d=()=>{},u=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",y)},m=()=>{l||(l=!0,u(),d())},y=w=>{w.code==="Escape"&&(w.preventDefault(),m())};return new Promise(w=>{d=w,s.addEventListener("click",m),o.addEventListener("click",g=>{g.target===o&&m()}),document.addEventListener("keydown",y),t.appendChild(o),requestAnimationFrame(()=>{i.focus({preventScroll:!0})})})}function uc(e={}){let t=Dn(),n=Array.isArray(e.entries)?e.entries:[],r=n[0]||null,o=r,i=[],s=null,c=b=>{try{let S=new Date(b);return Number.isNaN(S.getTime())?String(b||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(S)}catch{return String(b||"")}},{overlay:l,card:d,confirmBtn:u,cancelBtn:m}=Gn({title:e.title||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0431\u043B\u043E\u043A\u0430",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:e.canRestore?"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C (\u043F\u043E\u0441\u043B\u0435 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F)":"",renderBody:()=>{let b=document.createDocumentFragment(),S=document.createElement("p");if(S.className="modal-body__text",S.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0435. \u041C\u043E\u0436\u043D\u043E \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430 \u0434\u043E \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F.",b.appendChild(S),!n.length){let te=document.createElement("div");return te.className="modal-empty",te.textContent="\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430.",b.appendChild(te),b}let k=document.createElement("div");k.className="diff-layout";let A=document.createElement("div");A.className="modal-list diff-sidebar",i=[],n.forEach(te=>{let he=document.createElement("button");he.type="button";let Je=!!(r&&r.id===te.id);he.className=`diff-item${Je?" diff-item--active":""}`,he.setAttribute("aria-selected",Je?"true":"false");let vt=c(te.timestamp);he.textContent=vt?`\u2260 ${vt}`:`\u2260 ${te.id||""}`.trim(),he.addEventListener("click",()=>{r=te,A.querySelectorAll(".diff-item").forEach(Mt=>{Mt.classList.remove("diff-item--active"),Mt.setAttribute("aria-selected","false")}),he.classList.add("diff-item--active"),he.setAttribute("aria-selected","true"),we()}),A.appendChild(he),i.push(he)});let v=document.createElement("div");v.className="diff-main";let B=document.createElement("div");B.className="diff-panes diff-panes--side";let H=document.createElement("div");H.className="diff-pane-wrap";let O=document.createElement("div");O.className="diff-pane-wrap";let W=document.createElement("div");W.className="diff-pane-title",W.textContent=e.beforeTitle||"\u0414\u043E";let J=document.createElement("div");J.className="diff-pane-title",J.textContent=e.afterTitle||"\u041F\u043E\u0441\u043B\u0435";let ne=document.createElement("div");ne.className="diff-pane diff-pane--before";let me=document.createElement("div");me.className="diff-pane diff-pane--after",H.appendChild(W),H.appendChild(ne),O.appendChild(J),O.appendChild(me),B.appendChild(H),B.appendChild(O),v.appendChild(B),k.appendChild(A),k.appendChild(v),b.appendChild(k);let we=()=>{o=r;let te=r?.beforePlain||r?.before||"",he=r?.afterPlain||r?.after||"";ne.innerHTML="",me.innerHTML="",ne.appendChild(Io({baseText:te,nextText:he,mode:"before"})),me.appendChild(Io({baseText:te,nextText:he,mode:"after"}))};return s=we,we(),b}});d.classList.add("modal-card--fullscreen"),d.classList.add("modal-card--diff-light"),u.classList.remove("danger-btn"),!e.canRestore&&m&&(m.style.display="none"),m&&m.classList.add("danger-btn");let y=!1,w=()=>{},g=()=>{l.classList.add("modal-overlay--hide"),setTimeout(()=>l.remove(),150),document.removeEventListener("keydown",h)},f=b=>{y||(y=!0,g(),w(b))},h=b=>{if(b.code==="Escape"&&(b.preventDefault(),f(null)),b.code==="ArrowUp"||b.code==="ArrowDown"){if(!n.length)return;b.preventDefault();let S=String(r?.id||""),k=n.findIndex(B=>String(B?.id||"")===S);k<0&&(k=0),k=b.code==="ArrowUp"?Math.max(0,k-1):Math.min(n.length-1,k+1);let A=n[k]||null;if(!A)return;r=A;let v=i[k];if(i.forEach(B=>{B.classList.remove("diff-item--active"),B.setAttribute("aria-selected","false")}),v){v.classList.add("diff-item--active"),v.setAttribute("aria-selected","true"),v.focus({preventScroll:!0});try{v.scrollIntoView({block:"nearest"})}catch{}}typeof s=="function"&&s()}};return new Promise(b=>{w=b,u.addEventListener("click",()=>f(null)),m&&e.canRestore&&m.addEventListener("click",()=>f({action:"restore",entry:o||r||null})),l.addEventListener("click",S=>{S.target===l&&f(null)}),document.addEventListener("keydown",h),t.appendChild(l),requestAnimationFrame(()=>{d.focus({preventScroll:!0})})})}function Tu(e){let t=[],n=r=>{if(!r)return;if(typeof r=="string"){t.push(r);return}if(Array.isArray(r)){r.forEach(n);return}if(typeof r!="object")return;typeof r.text=="string"&&t.push(r.text);let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(e),t.join("").replace(/\u00a0/g," ").trim()}function hg(e){return!e||typeof e!="object"?!1:!!(e.beforeHeadingJson||e.beforeBodyJson||e.afterHeadingJson||e.afterBodyJson)}function fc(e={}){let t=Dn(),r=(Array.isArray(e.entries)?e.entries:[]).filter(hg),o=typeof e.onRestore=="function"?e.onRestore:null,i=O=>String(O??"").replace(/\u00a0/g," ").trim(),s=r.map(O=>({...O,beforePlain:i(O.beforePlain??O.before??""),afterPlain:i(O.afterPlain??O.after??"")})),c=new Map;for(let O of s){let W=String(O?.blockId||"").trim();if(!W)continue;let J=c.get(W)||{blockId:W,entries:[],latestAt:0,label:""};J.entries.push(O);let ne=Date.parse(O.timestamp||"")||0;if(ne>J.latestAt&&(J.latestAt=ne),!J.label){let me=Tu(O.afterHeadingJson)||Tu(O.beforeHeadingJson)||"",we=(O.afterPlain||O.beforePlain||"").split(`
`).map(te=>te.trim()).find(Boolean)||"";J.label=me||we||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"}c.set(W,J)}let l=Array.from(c.values()).sort((O,W)=>(W.latestAt||0)-(O.latestAt||0)),d=l[0]?.blockId||null,u=null,m=!1,y=O=>{try{let W=new Date(O);return Number.isNaN(W.getTime())?String(O||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(W)}catch{return String(O||"")}},{overlay:w,card:g,confirmBtn:f,cancelBtn:h}=Gn({title:e.title||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0441\u0442\u0430\u0442\u044C\u0438",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:e.canRestore?"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C":"",renderBody:()=>{let O=document.createDocumentFragment(),W=document.createElement("p");if(W.className="modal-body__text",W.textContent=e.message||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439 outline-\u0440\u0435\u0436\u0438\u043C\u0430. \u041C\u043E\u0436\u043D\u043E \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0435 \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0441\u0435\u043A\u0446\u0438\u0438 (\u0435\u0441\u043B\u0438 \u0441\u0435\u043A\u0446\u0438\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u2014 \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u043D\u0435\u0446 \u0441\u0442\u0430\u0442\u044C\u0438).",O.appendChild(W),!l.length){let cn=document.createElement("div");return cn.className="modal-empty",cn.textContent="\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430.",O.appendChild(cn),O}let J=document.createElement("div");J.className="diff-layout diff-layout--article-history";let ne=document.createElement("div");ne.className="modal-list diff-sidebar",ne.classList.add("diff-sections");let me=document.createElement("input");me.type="text",me.className="modal-input",me.placeholder="\u041F\u043E\u0438\u0441\u043A \u043F\u043E \u0438\u0441\u0442\u043E\u0440\u0438\u0438\u2026",ne.appendChild(me);let we=document.createElement("div");we.style.marginTop="8px",ne.appendChild(we);let te=document.createElement("div");te.className="diff-main";let he=document.createElement("div");he.className="diff-layout diff-layout--article-history-inner";let Je=document.createElement("div");Je.className="modal-list diff-sidebar",Je.classList.add("diff-revisions");let vt=document.createElement("div");vt.className="diff-panes diff-panes--side";let Mt=document.createElement("div");Mt.className="diff-pane-wrap";let $e=document.createElement("div");$e.className="diff-pane-wrap";let at=document.createElement("div");at.className="diff-pane-title",at.textContent=e.beforeTitle||"\u0414\u043E";let Dt=document.createElement("div");Dt.className="diff-pane-title",Dt.textContent=e.afterTitle||"\u041F\u043E\u0441\u043B\u0435";let tn=document.createElement("div");tn.className="diff-pane diff-pane--before";let Nt=document.createElement("div");Nt.className="diff-pane diff-pane--after",Mt.appendChild(at),Mt.appendChild(tn),$e.appendChild(Dt),$e.appendChild(Nt),vt.appendChild(Mt),vt.appendChild($e),he.appendChild(Je),he.appendChild(vt),te.appendChild(he),J.appendChild(ne),J.appendChild(te),O.appendChild(J);let er=()=>{let cn=me.value.trim().toLowerCase(),wn=cn?l.filter(Kt=>(Kt.label||"").toLowerCase().includes(cn)?!0:(Kt.entries||[]).some(Bt=>`${Bt.beforePlain||""}
${Bt.afterPlain||""}`.toLowerCase().includes(cn))):l;we.innerHTML="",wn.forEach(Kt=>{let Bt=document.createElement("button");Bt.type="button";let Yt=Kt.blockId===d;Bt.className=`diff-item${Yt?" diff-item--active":""}`,Bt.setAttribute("aria-selected",Yt?"true":"false");let tr=Kt.latestAt?y(new Date(Kt.latestAt).toISOString()):"",Y=Array.isArray(Kt.entries)?Kt.entries.length:0;Bt.textContent=`${Kt.label||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"}${tr?` \xB7 ${tr}`:""}${Y?` \xB7 ${Y}`:""}`,Bt.addEventListener("click",()=>{d=Kt.blockId,u=null,m=!1,er(),br(),wr()}),we.appendChild(Bt)}),d&&!wn.some(Kt=>Kt.blockId===d)&&(d=wn[0]?.blockId||null,u=null,m=!1,br(),wr())},br=()=>{let cn=d?c.get(d):null,wn=Array.isArray(cn?.entries)?cn.entries.slice():[];wn.sort((Bt,Yt)=>(Date.parse(Yt.timestamp||"")||0)-(Date.parse(Bt.timestamp||"")||0));let Kt=u&&wn.some(Bt=>String(Bt?.id||"")===String(u||""));(!m||!Kt)&&(u=wn[0]?.id||null),Je.innerHTML="",wn.forEach(Bt=>{let Yt=document.createElement("button");Yt.type="button";let tr=String(Bt.id||"")===String(u||"");Yt.className=`diff-item${tr?" diff-item--active":""}`,Yt.setAttribute("aria-selected",tr?"true":"false");let Y=y(Bt.timestamp),ce=(Bt.afterPlain||Bt.beforePlain||"").slice(0,64).trim();Yt.textContent=`${Y?`\u2260 ${Y}`:`\u2260 ${Bt.id||""}`}${ce?` \xB7 ${ce}`:""}`,Yt.addEventListener("click",()=>{u=Bt.id||null,m=!0,br(),wr()}),Je.appendChild(Yt)})},wr=()=>{let cn=d?c.get(d):null,wn=Array.isArray(cn?.entries)?cn.entries:[],Kt=wn.find(tr=>String(tr?.id||"")===String(u||""))||wn[0]||null,Bt=Kt?.beforePlain||"",Yt=Kt?.afterPlain||"";tn.innerHTML="",Nt.innerHTML="",tn.appendChild(Io({baseText:Bt,nextText:Yt,mode:"before"})),Nt.appendChild(Io({baseText:Bt,nextText:Yt,mode:"after"}))};return me.addEventListener("input",()=>{er()}),er(),br(),wr(),O}});g.classList.add("modal-card--fullscreen"),g.classList.add("modal-card--diff-light"),f.classList.remove("danger-btn"),!e.canRestore&&h&&(h.style.display="none"),h&&h.classList.add("danger-btn");let b=!1,S=()=>{},k=!1,A=()=>{w.classList.add("modal-overlay--hide"),setTimeout(()=>w.remove(),150),document.removeEventListener("keydown",B)},v=O=>{b||(b=!0,A(),S(O))},B=O=>{O.code==="Escape"&&(O.preventDefault(),v(null))},H=()=>{let O=d?c.get(d):null,W=Array.isArray(O?.entries)?O.entries:[];return W.find(J=>String(J?.id||"")===String(u||""))||W[0]||null};return new Promise(O=>{S=O,f.addEventListener("click",()=>v(null)),h&&e.canRestore&&h.addEventListener("click",async()=>{let W=H();if(!W){P("\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430");return}if(!o){v({action:"restore",entry:W});return}if(k)return;k=!0;let J=h.textContent;try{h.disabled=!0,f.disabled=!0,h.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C\u2026",await o(W)}catch(ne){P(ne?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C")}finally{k=!1,h.textContent=J,h.disabled=!1,f.disabled=!1}}),w.addEventListener("click",W=>{W.target===w&&v(null)}),document.addEventListener("keydown",B),t.appendChild(w),requestAnimationFrame(()=>{g.focus({preventScroll:!0})})})}function pc(e={}){let t=Dn(),n=null,r=null,{overlay:o,card:i,confirmBtn:s,cancelBtn:c,form:l}=Gn({...e,renderBody:()=>{let f=document.createDocumentFragment();if(e.message){let A=document.createElement("p");A.className="modal-body__text",A.textContent=e.message,f.appendChild(A)}let h=document.createElement("label");h.className="modal-label",h.textContent=e.textLabel||"\u0422\u0435\u043A\u0441\u0442";let b=document.createElement("input");b.type="text",b.className="modal-input",b.placeholder=e.textPlaceholder||"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438",b.value=e.defaultText||"",b.autocomplete="off",h.appendChild(b);let S=document.createElement("label");S.className="modal-label",S.textContent=e.urlLabel||"\u0421\u0441\u044B\u043B\u043A\u0430";let k=document.createElement("input");return k.type="text",k.className="modal-input",k.placeholder=e.urlPlaceholder||"https://example.com",k.value=e.defaultUrl||"",k.autocomplete="off",S.appendChild(k),n=b,r=k,f.appendChild(h),f.appendChild(S),f}}),d=!1,u=()=>{},m=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",w)},y=f=>{d||(d=!0,m(),u(f))},w=f=>{if(f.code==="Escape"){f.preventDefault(),y(null);return}f.code==="Enter"&&!s.disabled&&(f.preventDefault(),y({text:(n?.value||"").trim(),url:(r?.value||"").trim()}))},g=()=>{let f=!!(r?.value||"").trim();s.disabled=!f};return new Promise(f=>{u=f,s.classList.remove("danger-btn"),s.textContent=e.confirmText||"OK",c.textContent=e.cancelText||"Cancel";let h=()=>{y({text:(n?.value||"").trim(),url:(r?.value||"").trim()})};l.addEventListener("submit",S=>{S.preventDefault(),s.disabled||h()}),s.addEventListener("click",h),c.addEventListener("click",()=>y(null)),o.addEventListener("click",S=>{S.target===o&&y(null)}),document.addEventListener("keydown",w);let b=S=>{S&&S.addEventListener("input",g)};b(n),b(r),g(),t.appendChild(o),requestAnimationFrame(()=>{r?(r.focus({preventScroll:!0}),r.value&&r.setSelectionRange(r.value.length,r.value.length)):i.focus({preventScroll:!0})})})}function ms(e={}){let t=Dn(),n=null,r=null,{overlay:o,card:i,confirmBtn:s,cancelBtn:c,form:l}=Gn({...e,renderBody:()=>{let f=document.createDocumentFragment();if(e.message){let A=document.createElement("p");A.className="modal-body__text",A.textContent=e.message,f.appendChild(A)}let h=document.createElement("label");h.className="modal-label",h.textContent="\u041F\u0430\u0440\u043E\u043B\u044C";let b=document.createElement("input");b.type="password",b.className="modal-input",b.placeholder="\u041F\u0430\u0440\u043E\u043B\u044C \u0434\u043B\u044F \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B",b.autocomplete="off",h.appendChild(b);let S=document.createElement("label");S.className="modal-label",S.textContent="\u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0430 (\u043D\u0435\u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u044C\u043D\u043E)";let k=document.createElement("input");return k.type="text",k.className="modal-input",k.placeholder="\u041D\u0430\u043F\u043E\u043C\u0438\u043D\u0430\u043D\u0438\u0435 \u043E \u043F\u0430\u0440\u043E\u043B\u0435",k.autocomplete="off",S.appendChild(k),n=b,r=k,f.appendChild(h),f.appendChild(S),f}}),d=!1,u=()=>{},m=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",w)},y=f=>{d||(d=!0,m(),u(f))},w=f=>{if(f.code==="Escape"){f.preventDefault(),y(null);return}f.code==="Enter"&&!s.disabled&&(f.preventDefault(),y({password:(n?.value||"").trim(),hint:(r?.value||"").trim()}))},g=()=>{let f=!!(n?.value||"").trim();s.disabled=!f};return new Promise(f=>{u=f,s.classList.remove("danger-btn"),s.textContent=e.confirmText||"\u0417\u0430\u0449\u0438\u0442\u0438\u0442\u044C",c.textContent=e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430";let h=()=>{s.disabled||y({password:(n?.value||"").trim(),hint:(r?.value||"").trim()})};s.addEventListener("click",h),l.addEventListener("submit",b=>{b.preventDefault(),h()}),c.addEventListener("click",()=>y(null)),o.addEventListener("click",b=>{b.target===o&&y(null)}),document.addEventListener("keydown",w),n&&n.addEventListener("input",g),g(),t.appendChild(o),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):i.focus({preventScroll:!0})})})}function mc(e={}){let t=Dn(),n=Array.isArray(e.items)?e.items:[],{overlay:r,card:o,confirmBtn:i,cancelBtn:s}=Gn({title:e.title||"\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432",renderBody:()=>{let y=document.createElement("div");if(!n.length){let g=document.createElement("p");return g.className="modal-body__text",g.textContent="\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432 \u043F\u0443\u0441\u0442\u0430",y.appendChild(g),y}let w=document.createElement("div");return w.className="block-trash-list",n.forEach(g=>{let f=document.createElement("div");f.className="block-trash-item";let h=g.block&&g.block.text||"",b=Au(h),S=document.createElement("div");S.className="block-trash-item__title",S.textContent=b[0]||"(\u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A)";let k=document.createElement("div");k.className="block-trash-item__meta";let A=g.deletedAt?new Date(g.deletedAt).toLocaleString():"";k.textContent=A||"";let v=document.createElement("div");v.className="block-trash-item__info",v.appendChild(S),A&&v.appendChild(k);let B=document.createElement("button");B.type="button",B.className="primary",B.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",B.addEventListener("click",()=>{u(g)}),f.appendChild(v),f.appendChild(B),w.appendChild(f)}),y.appendChild(w),y}}),c=!1,l=()=>{},d=()=>{r.classList.add("modal-overlay--hide"),setTimeout(()=>r.remove(),150),document.removeEventListener("keydown",m)},u=y=>{c||(c=!0,d(),l(y||null))},m=y=>{y.code==="Escape"&&(y.preventDefault(),u(null))};return new Promise(y=>{l=y,i.classList.remove("hidden"),i.textContent="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u043A\u043E\u0440\u0437\u0438\u043D\u0443",i.classList.add("danger-btn"),s.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",i.addEventListener("click",()=>u({action:"clear"})),s.addEventListener("click",()=>u(null)),r.addEventListener("click",w=>{w.target===r&&u(null)}),document.addEventListener("keydown",m),t.appendChild(r),requestAnimationFrame(()=>{o.focus({preventScroll:!0})})})}function hc(e={}){let t=Dn(),{title:n,message:r,existingTitle:o,importedTitle:i,existingCreatedAt:s,existingUpdatedAt:c,importedCreatedAt:l,importedUpdatedAt:d,allowApplyToAll:u=!0}=e||{},m=document.createElement("div");m.className="modal-overlay";let y=document.createElement("div");y.className="modal-card",y.setAttribute("role","dialog"),y.setAttribute("aria-modal","true"),y.tabIndex=-1;let w=document.createElement("div");w.className="modal-header";let g=document.createElement("h3");g.textContent=n||"\u041A\u043E\u043D\u0444\u043B\u0438\u043A\u0442 \u043F\u0440\u0438 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0438",w.appendChild(g);let f=document.createElement("div");if(f.className="modal-body",r){let ne=document.createElement("p");ne.className="modal-body__text",ne.textContent=r,f.appendChild(ne)}if(o||i){let ne=document.createElement("p");ne.className="modal-body__text",ne.innerHTML=[o?`<strong>\u0412 \u0431\u0430\u0437\u0435:</strong> ${o}`:"",i?`<strong>\u0418\u0437 \u0444\u0430\u0439\u043B\u0430:</strong> ${i}`:""].filter(Boolean).join("<br />"),f.appendChild(ne)}if(s||c||l||d){let ne=te=>{if(!te)return"";let he=new Date(te);return Number.isNaN(he.getTime())?te:he.toLocaleString()},me=document.createElement("p");me.className="modal-body__text";let we=[];if(s||c){let te=s?ne(s):"\u2014",he=c?ne(c):"\u2014";we.push(`<strong>\u0412 \u0431\u0430\u0437\u0435:</strong> \u0441\u043E\u0437\u0434\u0430\u043D\u0430 ${te}, \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430 ${he}`)}if(l||d){let te=l?ne(l):"\u2014",he=d?ne(d):"\u2014";we.push(`<strong>\u0418\u0437 \u0444\u0430\u0439\u043B\u0430:</strong> \u0441\u043E\u0437\u0434\u0430\u043D\u0430 ${te}, \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430 ${he}`)}me.innerHTML=we.join("<br />"),f.appendChild(me)}let h=null;if(u){let ne=document.createElement("label");ne.className="modal-label";let me=document.createElement("input");me.type="checkbox",me.style.marginRight="0.5rem",ne.appendChild(me),ne.appendChild(document.createTextNode("\u041F\u0440\u0438\u043C\u0435\u043D\u044F\u0442\u044C \u044D\u0442\u043E \u0440\u0435\u0448\u0435\u043D\u0438\u0435 \u043A\u043E \u0432\u0441\u0435\u043C \u043A\u043E\u043D\u0444\u043B\u0438\u043A\u0442\u0430\u043C")),h=me,f.appendChild(ne)}let b=document.createElement("div");b.className="modal-footer modal-footer--stacked";let S=document.createElement("button");S.type="button",S.className="ghost",S.textContent="\u041E\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0443\u044E";let k=document.createElement("button");k.type="button",k.className="primary danger-btn",k.textContent="\u041F\u0435\u0440\u0435\u0437\u0430\u043F\u0438\u0441\u0430\u0442\u044C";let A=document.createElement("button");A.type="button",A.className="ghost",A.textContent="\u0421\u043E\u0437\u0434\u0430\u0442\u044C \u043A\u043E\u043F\u0438\u044E";let v=document.createElement("button");v.type="button",v.className="ghost",v.textContent="\u041E\u0442\u043C\u0435\u043D\u0430",b.appendChild(S),b.appendChild(k),b.appendChild(A),b.appendChild(v),y.appendChild(w),y.appendChild(f),y.appendChild(b),m.appendChild(y);let B=!1,H=()=>{},O=()=>{m.classList.add("modal-overlay--hide"),setTimeout(()=>m.remove(),150),document.removeEventListener("keydown",J)},W=ne=>{if(B)return;B=!0;let me=!!(h&&h.checked);O(),H({action:ne,applyToAll:me})},J=ne=>{ne.code==="Escape"&&(ne.preventDefault(),W(null))};return new Promise(ne=>{H=ne,S.addEventListener("click",()=>W("keep")),k.addEventListener("click",()=>W("overwrite")),A.addEventListener("click",()=>W("copy")),v.addEventListener("click",()=>W(null)),m.addEventListener("click",me=>{me.target===m&&W(null)}),document.addEventListener("keydown",J),t.appendChild(m),requestAnimationFrame(()=>{y.focus({preventScroll:!0})})})}function ci(e,t=""){let n=Dn(),r=document.createElement("div");r.className="modal-overlay image-modal";let o=document.createElement("div");o.className="image-modal__card",o.setAttribute("role","dialog"),o.setAttribute("aria-modal","true"),o.tabIndex=-1;let i=document.createElement("img");i.className="image-modal__img",i.src=e,t&&(i.alt=t),o.appendChild(i),r.appendChild(o);let s,c=()=>{s&&s()},l=d=>{d.code==="Escape"&&(d.preventDefault(),c())};s=()=>{document.removeEventListener("keydown",l),r.classList.add("modal-overlay--hide"),setTimeout(()=>r.remove(),150)},r.addEventListener("click",d=>{d.target===r&&c()}),document.addEventListener("keydown",l),n.appendChild(r),requestAnimationFrame(()=>{o.focus({preventScroll:!0})})}var vu,Qn=Ke(()=>{Un();zt();vu="modal-root"});function Bu(e){if(typeof btoa=="function"){let t="";for(let n=0;n<e.length;n+=1)t+=String.fromCharCode(e[n]);return btoa(t)}if(typeof Buffer<"u")return Buffer.from(e).toString("base64");throw new Error("No base64 encoder available")}function Lu(e){if(!e)return new Uint8Array(0);if(typeof atob=="function"){let t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r+=1)n[r]=t.charCodeAt(r);return n}if(typeof Buffer<"u"){let t=Buffer.from(e,"base64"),n=new Uint8Array(t.length);for(let r=0;r<t.length;r+=1)n[r]=t[r];return n}throw new Error("No base64 decoder available")}function li(e){return typeof e=="string"&&e.startsWith(yc)}async function gs(e,t){if(!e)throw new Error("Password is required");let n=t&&t.length?Lu(t):Mu(16),r=hs(e||""),o=new Uint8Array(r.length+n.length);return o.set(r,0),o.set(n,r.length),{key:{raw:hs(String.fromCharCode(...o))},salt:Bu(n)}}function hs(e=""){let t=2166136261,n=16777619;for(let o=0;o<e.length;o+=1){let i=e.charCodeAt(o);t^=i,t=t*16777619>>>0,n^=i<<o%8,n=n*16777619>>>0}let r=new Uint8Array(32);for(let o=0;o<32;o+=1){let i=o<16?t:n;r[o]=i>>>o%4*8&255}return r}function Mu(e){let t=new Uint8Array(e);for(let n=0;n<e;n+=1)t[n]=Math.floor(Math.random()*256);return t}async function bc(e,t=""){if(!e)throw new Error("Missing encryption key");let n=e&&e.raw?e.raw:hs("fallback-key"),r=Mu(12),i=new TextEncoder().encode(t||""),s=new Uint8Array(r.length+i.length);s.set(r,0);for(let c=0;c<i.length;c+=1){let l=n[c%n.length],d=r[c%r.length];s[r.length+c]=i[c]^l^d}return`${yc}${Bu(s)}`}async function di(e,t){if(!e)throw new Error("Missing encryption key");if(!li(t))throw new Error("Data is not in encrypted format");let n=t.slice(yc.length),r=Lu(n);if(r.length<13)throw new Error("Encrypted payload is too short");let o=r.slice(0,12),i=r.slice(12),s=e&&e.raw?e.raw:hs("fallback-key"),c=new Uint8Array(i.length);for(let d=0;d<i.length;d+=1){let u=s[d%s.length],m=o[d%o.length];c[d]=i[d]^u^m}return new TextDecoder().decode(c)}async function wc(e){return bc(e,Cu)}async function Nu(e,t){if(!t)return!1;try{return await di(e,t)===Cu}catch{return!1}}async function Pu(e,t){if(!e)return;if(typeof e.text=="string"&&li(e.text))try{e.text=await di(t,e.text)}catch{e.text=""}let n=Array.isArray(e.children)?e.children:[];for(let r of n)await Pu(r,t)}async function Sc(e,t){if(!(!e||!Array.isArray(e.blocks)))for(let n of e.blocks)await Pu(n,t)}async function ui(e,t){if(!e)return;typeof e.text=="string"&&(e.text=await bc(t,e.text));let n=Array.isArray(e.children)?e.children:[];for(let r of n)await ui(r,t)}async function ys(e,t){return bc(e,t||"")}var yc,Cu,fi=Ke(()=>{yc="enc-v1:",Cu="memus-article-encryption-ok"});function gg(e){return String(e||"").trim()}async function Du(e,{blockLimit:t=30,articleLimit:n=15}={}){let r=gg(e);if(!r)return[];let o=await lt(),i=r.toLowerCase(),s=o.transaction(["articles","outline_sections"],"readonly"),c=s.objectStore("articles"),l=s.objectStore("outline_sections"),d=await ke(c.getAll()).catch(()=>[])||[],u=d.filter(h=>h&&!h.deletedAt).filter(h=>String(h.title||"").toLowerCase().includes(i)).sort((h,b)=>String(b.updatedAt||"").localeCompare(String(h.updatedAt||""))).slice(0,Math.max(0,Number(n)||0)).map(h=>({type:"article",articleId:h.id,articleTitle:h.title||"",snippet:h.title||""}));try{if(!Number(await ke(l.count()).catch(()=>0)))return await Ve(s),navigator.onLine?null:u}catch{}let m=await ke(l.getAll()).catch(()=>[])||[],y=new Map(d.map(h=>[h.id,h.title||""])),w=Math.max(0,Number(t)||0),g=m.filter(h=>String(h?.text||"").toLowerCase().includes(i)).sort((h,b)=>String(b?.updatedAt||"").localeCompare(String(h?.updatedAt||""))).slice(0,w).map(h=>({blockId:h.sectionId,articleId:h.articleId,articleTitle:y.get(h.articleId)||"",blockText:h.text||""})),f=[];for(let h of g){let b=h.articleTitle||"",S=h.blockText||"";f.push({type:"block",articleId:h.articleId,articleTitle:b,blockId:h.blockId,snippet:S.slice(0,160),blockText:S})}return await Ve(s),[...u,...f]}var _u=Ke(()=>{rr();Fn()});function Ou(e=""){return String(e||"").replace(/\r\n/g,`
`).replace(/\u00a0/g," ").split(`
`).map(t=>t.replace(/[ \t]+$/g,""))}function Ru(e=""){let t=a.searchQuery.trim();if(!t)return gt(e);let n=new RegExp(us(t),"gi");return gt(e).replace(n,r=>`<mark>${r}</mark>`)}function Fr(){if(!p.ragOpenBtn)return;if(a.sidebarSearchView!=="search"){p.ragOpenBtn.classList.add("hidden");return}let e=a.searchMode==="semantic"&&!!a.searchQuery.trim()&&!a.searchLoading&&!a.searchError&&Array.isArray(a.searchResults)&&a.searchResults.length>0;p.ragOpenBtn.classList.toggle("hidden",!e)}function to(){if(!p.searchResults)return;if(a.sidebarSearchView!=="search"){p.searchResults.classList.add("hidden"),p.searchResults.innerHTML="",Fr();return}if(!a.searchQuery.trim()){p.searchResults.classList.add("hidden"),p.searchResults.innerHTML="",Fr();return}if(p.searchResults.classList.remove("hidden"),a.searchLoading){p.searchResults.innerHTML='<div class="search-result-empty">\u041F\u043E\u0438\u0441\u043A...</div>',Fr();return}if(a.searchError){p.searchResults.innerHTML=`<div class="search-result-empty">${gt(a.searchError)}</div>`,Fr();return}if(!a.searchResults.length){p.searchResults.innerHTML='<div class="search-result-empty">\u041D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E</div>',Fr();return}p.searchResults.innerHTML="",a.searchResults.forEach(t=>{let n=t.type==="article",r=document.createElement("div");r.className="search-result-item";let o=t.articleTitle||" ",i="",s=t.articleTitle||"";if(!n){let u=Ou(t.blockText||""),m=u.findIndex(y=>y.trim()!=="");i=m>=0?(u[m]||"").trim():"",o=i||s||" "}let c=Ru(o||" "),l=n?"\u0421\u0442\u0430\u0442\u044C\u044F":"\u0411\u043B\u043E\u043A",d="";if(!n){let u=Ou(t.blockText||""),m=u.findIndex(h=>h.trim()!==""),g=(m>=0?u.slice(m+1).filter(h=>h.trim()!==""):u.filter(h=>h.trim()!=="")).slice(0,2).map(h=>Ru(h)).join("<br />");d=`${s?`<div class="search-result-item__article">${gt(s)}</div>`:""}${g?`<div>${g}</div>`:""}`}r.innerHTML=`
      <div class="search-result-item__header">
        <span class="search-result-item__badge">${l}</span>
        <span class="search-result-item__title">${c}</span>
      </div>
      ${d?`<div class="search-result-item__snippet">${d}</div>`:""}
    `,r.addEventListener("mousedown",u=>{u.preventDefault(),yg(t)}),p.searchResults.appendChild(r)}),Fr()}function xr(){p.searchResults&&p.searchResults.classList.add("hidden")}async function Hu(e){if(a.sidebarSearchView!=="search"){xr(),Fr();return}let t=e.target.value;if(a.searchQuery=t,!t.trim()){a.searchResults=[],a.searchError="",a.searchLoading=!1,to();return}a.searchLoading=!0;let n=Date.now();a.searchRequestId=n,to();try{let r=null;if(a.searchMode!=="semantic")try{r=await Du(t)}catch{r=null}r||(r=await(a.searchMode==="semantic"?iu:ou)(t)),a.searchRequestId===n&&(a.searchResults=r,a.searchError="")}catch(r){a.searchRequestId===n&&(a.searchError=r.message)}finally{a.searchRequestId===n&&(a.searchLoading=!1,to())}}function yg(e){xr(),p.searchInput&&(p.searchInput.value=""),a.searchQuery="",a.searchResults=[],a.searchError="",Fr();let t=e.type==="article";a.scrollTargetBlockId=t?null:e.blockId,a.currentBlockId=t?null:e.blockId,a.isSidebarMobileOpen&&In(!1),It(wt.article(e.articleId))}function $u(){let e=a.searchQuery.trim();e&&a.searchMode==="semantic"&&(a.searchLoading||a.searchError||!Array.isArray(a.searchResults)||!a.searchResults.length||(a.ragQuery=e,a.ragResults=JSON.parse(JSON.stringify(a.searchResults)),a.ragSummaryHtml="",a.ragSummaryError="",a.ragSummaryLoading=!0,a.scrollTargetBlockId=null,a.currentBlockId=null,It(wt.article("RAG")),(async()=>{Ft("\u0413\u0435\u043D\u0435\u0440\u0438\u0440\u0443\u044E \u0441\u0432\u043E\u0434\u043A\u0443\u2026",{protect:!0});try{let t=await su(a.ragQuery,a.ragResults);a.ragSummaryHtml=t&&t.summaryHtml||"",a.ragSummaryError=""}catch(t){a.ragSummaryError=t.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0440\u0435\u0437\u044E\u043C\u0435",a.ragSummaryHtml=""}finally{a.ragSummaryLoading=!1,bt({force:!0}),a.articleId==="RAG"&&It(wt.article("RAG"))}})()))}var bs=Ke(()=>{At();Vt();Un();Xt();qn();En();zt();_u()});function Vu(){try{let e=localStorage.getItem(Uu);e==="1"?a.isSidebarCollapsed=!0:e==="0"&&(a.isSidebarCollapsed=!1)}catch{}}function qu(){try{localStorage.setItem(Uu,a.isSidebarCollapsed?"1":"0")}catch{}}function Ku(){try{let e=localStorage.getItem(Fu),t=e?JSON.parse(e):[];a.sidebarCollapsedArticleIds=Array.isArray(t)?t:[]}catch{a.sidebarCollapsedArticleIds=[]}}function pi(){try{localStorage.setItem(Fu,JSON.stringify(a.sidebarCollapsedArticleIds||[]))}catch{}}function ju(){try{let e=localStorage.getItem(zu),t=e?JSON.parse(e):[];a.listCollapsedArticleIds=Array.isArray(t)?t:[]}catch{a.listCollapsedArticleIds=[]}}function no(){try{localStorage.setItem(zu,JSON.stringify(a.listCollapsedArticleIds||[]))}catch{}}function kr(){let e=a.sidebarSelectedArticleId||a.articleId;if(!e)return;let t=a.isTrashView?a.deletedArticlesIndex:a.articlesIndex;if(!Array.isArray(t)||!t.length)return;let n=new Map(t.map(s=>[s.id,s])),r=new Set(a.sidebarCollapsedArticleIds||[]),o=new Set,i=n.get(e)||null;for(;i&&i.parentId&&!o.has(i.parentId);)o.add(i.parentId),r.delete(i.parentId),i=n.get(i.parentId)||null;a.sidebarCollapsedArticleIds=Array.from(r),pi()}var Fu,zu,Uu,Eo=Ke(()=>{At();Fu="ttree_collapsed_articles",zu="ttree_list_collapsed_articles",Uu="ttree_sidebar_collapsed"});function xc(){p.articlesTabBtn&&(p.articlesTabBtn.classList.toggle("active",!a.isTrashView),p.articlesTabBtn.setAttribute("aria-pressed",a.isTrashView?"false":"true")),p.trashTabBtn&&(p.trashTabBtn.classList.toggle("active",a.isTrashView),p.trashTabBtn.setAttribute("aria-pressed",a.isTrashView?"true":"false")),p.createArticleBtn&&(p.createArticleBtn.disabled=a.isTrashView),p.sidebarNewArticleBtn&&(p.sidebarNewArticleBtn.disabled=a.isTrashView)}function Ar(){fr&&($a(!1),p.hintPopover&&p.hintPopover.classList.add("hidden"),p.hintToggleBtn&&p.hintToggleBtn.setAttribute("aria-expanded","false"))}function kc(e){e&&e.stopPropagation(),$a(!fr),p.hintPopover&&p.hintPopover.classList.toggle("hidden",!fr),p.hintToggleBtn&&p.hintToggleBtn.setAttribute("aria-expanded",fr?"true":"false")}function ro(e){p.sidebar&&(a.isSidebarCollapsed=e,p.sidebar.classList.toggle("collapsed",e),p.sidebarToggle&&(p.sidebarToggle.setAttribute("aria-expanded",e?"false":"true"),p.sidebarToggle.title=e?"\u041F\u043E\u043A\u0430\u0437\u0430\u0442\u044C \u043F\u0430\u043D\u0435\u043B\u044C":"\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C \u043F\u0430\u043D\u0435\u043B\u044C",p.sidebarToggle.textContent=e?"\u2192":"x"),qu(),e&&(Ar(),xr()))}function Ac(){ro(!a.isSidebarCollapsed)}function In(e){a.isSidebarMobileOpen=e,p.sidebar&&p.sidebar.classList.toggle("mobile-open",e),p.sidebarBackdrop&&p.sidebarBackdrop.classList.toggle("hidden",!e),e&&(Ar(),xr())}function mi(){In(!1)}function hi(e){p.articleView.classList.toggle("hidden",!e),p.articleListView.classList.toggle("hidden",e),p.articleHeader&&p.articleHeader.classList.toggle("hidden",!e),e||Ar(),e&&a.isTrashView&&(a.isTrashView=!1,xc())}var ws=Ke(()=>{At();Vt();bs();Eo()});function Qu({renderSidebarArticleList:e,renderMainArticleList:t,setArticlesIndex:n}={}){Yu=typeof e=="function"?e:null,Ic=typeof t=="function"?t:null,Gu=typeof n=="function"?n:null}function xs(){sr&&(sr.classList.remove("drop-before","drop-after","drop-inside"),sr=null)}function Xu(e,t){e&&(sr&&sr!==e&&sr.classList.remove("drop-before","drop-after","drop-inside"),sr=e,sr.classList.remove("drop-before","drop-after","drop-inside"),t==="before"?sr.classList.add("drop-before"):t==="after"?sr.classList.add("drop-after"):t==="inside"&&sr.classList.add("drop-inside"))}function Sg(){_t&&(_t.sourceEl instanceof Element&&_t.sourceEl.classList.remove("article-dnd-source"),typeof document<"u"&&document.body&&document.body.classList.remove("article-dnd-active"),window.removeEventListener("pointermove",Tc),window.removeEventListener("pointerup",gi),window.removeEventListener("pointercancel",gi),window.removeEventListener("touchmove",Zu),window.removeEventListener("touchend",Ss),window.removeEventListener("touchcancel",Ss),_t=null,xs(),window.__ttreeDraggingArticleId=null)}function Ju(e){return e instanceof Element?!!(e.closest(".star-btn")||e.closest(".row-actions")):!1}function xg(e,t){if(!t||_t||!e.touches||e.touches.length!==1)return;let n=e.touches[0],r=e.currentTarget instanceof Element?e.currentTarget:null;_t={pointerId:"legacy-touch",articleId:t,startX:n.clientX,startY:n.clientY,dragging:!1,lastTargetId:null,lastDropMode:null,sourceEl:r},window.__ttreeDraggingArticleId=t,typeof document<"u"&&document.body&&document.body.classList.add("article-dnd-active");try{let o=window.getSelection?window.getSelection():null;o&&!o.isCollapsed&&o.removeAllRanges()}catch{}window.addEventListener("touchmove",Zu,{passive:!1}),window.addEventListener("touchend",Ss),window.addEventListener("touchcancel",Ss)}function Zu(e){if(!_t||!e.touches||e.touches.length===0)return;let t=e.touches[0];Tc({pointerId:"legacy-touch",clientX:t.clientX,clientY:t.clientY,preventDefault:()=>{e.preventDefault()}})}function Ss(){_t&&gi({pointerId:"legacy-touch"})}function kg(e,t){let n=document.elementFromPoint(e,t);if(!n)return null;let r=n.closest(".sidebar-article-item, #articleList li");return!r||!r.dataset||!r.dataset.articleId?null:r}function Ag(e,t){if(!t||_t)return;let n=e.currentTarget instanceof Element?e.currentTarget:null;_t={pointerId:e.pointerId,articleId:t,startX:e.clientX,startY:e.clientY,dragging:!1,lastTargetId:null,lastDropMode:null,sourceEl:n},window.__ttreeDraggingArticleId=t,typeof document<"u"&&document.body&&document.body.classList.add("article-dnd-active");try{let r=window.getSelection?window.getSelection():null;r&&!r.isCollapsed&&r.removeAllRanges()}catch{}try{e.currentTarget?.setPointerCapture?.(e.pointerId)}catch{}window.addEventListener("pointermove",Tc),window.addEventListener("pointerup",gi),window.addEventListener("pointercancel",gi)}function Tc(e){if(!_t||e.pointerId!==_t.pointerId)return;let t=e.clientX-_t.startX,n=e.clientY-_t.startY;if(!_t.dragging){if(Math.hypot(t,n)<bg)return;_t.dragging=!0,_t.sourceEl instanceof Element&&_t.sourceEl.classList.add("article-dnd-source")}e.preventDefault();let r=kg(e.clientX,e.clientY);if(!r||!r.dataset||!r.dataset.articleId||r.dataset.articleId===_t.articleId){xs(),_t.lastTargetId=null,_t.lastDropMode=null;return}let o=r.getBoundingClientRect(),i=e.clientY-o.top,s=o.height/3,c;i<s?c="before":i>o.height-s?c="after":c="inside",_t.lastTargetId=r.dataset.articleId,_t.lastDropMode=c,Xu(r,c)}function gi(e){if(!_t||e.pointerId!==_t.pointerId)return;let t=_t;Sg(),!(!t.dragging||!t.lastTargetId||!t.lastDropMode)&&t.lastTargetId!==t.articleId&&ef(t.articleId,t.lastTargetId,t.lastDropMode)}function Cc(e,t){e&&(wg?e.addEventListener("pointerdown",n=>{if(n.pointerType!=="touch"||typeof n.button=="number"&&n.button!==0||Ju(n.target))return;let r=n.pointerId,o=350,i=!1,s=window.setTimeout(()=>{i=!0,Ag(n,t)},o),c=l=>{l.pointerId===r&&(i||window.clearTimeout(s),window.removeEventListener("pointerup",c,!0),window.removeEventListener("pointercancel",c,!0))};window.addEventListener("pointerup",c,!0),window.addEventListener("pointercancel",c,!0)}):e.addEventListener("touchstart",n=>{if(!n.touches||n.touches.length!==1)return;let r=n.target;if(Ju(r))return;let o=350,i=!1,s=window.setTimeout(()=>{i=!0,xg(n,t)},o),c=()=>{i||window.clearTimeout(s),window.removeEventListener("touchend",c,!0),window.removeEventListener("touchcancel",c,!0)};window.addEventListener("touchend",c,!0),window.addEventListener("touchcancel",c,!0)},{passive:!1}))}function vc(e){return e&&(a.articlesIndex||[]).find(t=>t.id===e)||null}function Wu(e){let t=e||null;return(a.articlesIndex||[]).filter(n=>(n.parentId||null)===t).sort((n,r)=>n.position!==r.position?n.position-r.position:new Date(n.updatedAt||0)-new Date(r.updatedAt||0))}function Ig(e,t,n,r){if(!e)return;let o=vc(e);if(!o)return;let i=t||null,s=o.parentId||null,l=Wu(s).filter(w=>w.id!==e),d;i===s?d=l:d=Wu(i);let u=d.filter(w=>w.id!==e),m=u.length;if(n&&r&&r!=="inside"){let w=u.findIndex(g=>g.id===n);w!==-1&&(m=r==="before"?w:w+1)}r==="inside"&&(m=u.length),m<0&&(m=0),m>u.length&&(m=u.length);let y=u.slice();y.splice(m,0,o),o.parentId=i,l.forEach((w,g)=>{w.position=g}),y.forEach((w,g)=>{w.parentId=i,w.position=g})}function ef(e,t,n){if(!e||!t||!n)return;let r=vc(e),o=vc(t);if(!r||!o)return;let i=n==="inside"?o.id:o.parentId||null,s=n==="inside"?null:o.id;Ig(e,i,s,n),Yu?.(),Ic?.(),(async()=>{try{await cs(e,{parentId:i,anchorId:s,placement:n})}catch(c){try{let l=await zn();Gu?.(l),Ic?.()}catch{}P(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443")}})()}function Eg(e){window.__ttreeDraggingArticleId?_n=window.__ttreeDraggingArticleId:_n=e.currentTarget?.dataset?.articleId||null,e.dataTransfer&&(e.dataTransfer.effectAllowed="move",_n&&e.dataTransfer.setData("text/plain",_n))}function vg(e){if(!_n){let s=window.__ttreeDraggingArticleId,c=null;if(!s&&e?.dataTransfer)try{c=e.dataTransfer.getData("text/plain")||null}catch{c=null}_n=s||c||null}if(!_n||!e.currentTarget||!e.currentTarget.dataset.articleId)return;e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="move");let t=e.currentTarget,n=t.getBoundingClientRect(),r=e.clientY-n.top,o=n.height/3,i;r<o?i="before":r>n.height-o?i="after":i="inside",Xu(t,i)}function Tg(e){if(!_n){let c=window.__ttreeDraggingArticleId,l=null;if(!c&&e?.dataTransfer)try{l=e.dataTransfer.getData("text/plain")||null}catch{l=null}_n=c||l||null}if(!_n)return;let t=e.currentTarget,n=t?.dataset?.articleId||null;if(!n||n===_n)return;e.preventDefault(),xs();let r=t.getBoundingClientRect(),o=e.clientY-r.top,i=r.height/3,s;o<i?s="before":o>r.height-i?s="after":s="inside",ef(_n,n,s),_n=null}function Cg(){_n=null,window.__ttreeDraggingArticleId=null,xs()}function Bc(e){e&&(e.draggable=!0,e.addEventListener("dragstart",Eg),e.addEventListener("dragover",vg),e.addEventListener("drop",Tg),e.addEventListener("dragend",Cg))}var Yu,Ic,Gu,Ec,_n,sr,bg,_t,wg,Lc=Ke(()=>{At();Xt();zt();Yu=null,Ic=null,Gu=null;Ec=!1;typeof window<"u"&&(window.matchMedia&&window.matchMedia("(pointer: coarse)").matches||"ontouchstart"in window)&&(Ec=!0);_n=null,sr=null,bg=6,_t=null,wg=typeof window<"u"&&"PointerEvent"in window&&!Ec});function tf(){try{if(a.sidebarSearchView!=="list"||!p.searchInput||!!!((p.searchInput.value||"").trim()||(a.articleFilterQuery||"").trim()))return;p.searchInput.value="",a.articleFilterQuery="",p.searchInput.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}function Bg(){try{let e=localStorage.getItem(nf),t=e?JSON.parse(e):[];a.favoriteArticles=Array.isArray(t)?t:[]}catch{a.favoriteArticles=[]}}function Lg(){try{localStorage.setItem(nf,JSON.stringify(a.favoriteArticles||[]))}catch{}}function rf(e=[]){let t=new Set(a.favoriteArticles||[]);return[...e].sort((n,r)=>{let o=t.has(n.id),i=t.has(r.id);return o!==i?o?-1:1:new Date(r.updatedAt||r.deletedAt||0)-new Date(n.updatedAt||n.deletedAt||0)})}function vo(e){if(!e)return;a.favoriteArticles||(a.favoriteArticles=[]);let t=new Set(a.favoriteArticles);t.has(e)?t.delete(e):t.add(e),a.favoriteArticles=Array.from(t),Lg(),Pt(),an()}function ks(e=[]){(!a.favoriteArticles||!a.favoriteArticles.length)&&Bg();let t=Array.isArray(e)?e:[];a.articlesIndex=t.map(r=>({id:r.id,title:r.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",updatedAt:r.updatedAt||new Date().toISOString(),deletedAt:r.deletedAt||null,publicSlug:r.publicSlug||null,parentId:r.parentId||null,position:typeof r.position=="number"?r.position:0}));let n=new Set(a.articlesIndex.map(r=>r.id));Array.isArray(a.sidebarCollapsedArticleIds)&&a.sidebarCollapsedArticleIds.length&&(a.sidebarCollapsedArticleIds=a.sidebarCollapsedArticleIds.filter(r=>n.has(r)),pi()),Array.isArray(a.listCollapsedArticleIds)&&a.listCollapsedArticleIds.length&&(a.listCollapsedArticleIds=a.listCollapsedArticleIds.filter(r=>n.has(r)),no()),Pt()}function of(e=[]){let t=rf(Array.isArray(e)?e:[]);a.deletedArticlesIndex=t,Pt()}function As(e){let t=(a.articleFilterQuery||"").trim(),n=e?.target?.value||"",r=String(n||"").trim();a.articleFilterQuery=n;let o=!!(t&&!r&&a.sidebarArticlesMode!=="recent");o&&kr(),Pt(),o&&window.requestAnimationFrame(()=>{try{Is()}catch{}})}function sf(e){let t=String(e||"").trim();if(!t||!p?.sidebarArticleList)return;let n=p.sidebarArticleList.querySelector(`li.sidebar-article-item[data-article-id="${CSS.escape(t)}"]`)||p.sidebarArticleList.querySelector(`li[data-article-id="${CSS.escape(t)}"]`);if(n)try{n.scrollIntoView({block:"center",inline:"nearest"})}catch{}}function Is(){let e=a.sidebarSelectedArticleId||a.articleId;e&&sf(e)}function Xn(e){if(!e||!e.id||e.deletedAt)return;let t={id:e.id,title:e.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",updatedAt:e.updatedAt||new Date().toISOString(),publicSlug:e.publicSlug||null,parentId:e.parentId||null,position:typeof e.position=="number"?e.position:0},n=a.articlesIndex.findIndex(r=>r.id===t.id);n>=0?a.articlesIndex[n]={...a.articlesIndex[n],...t}:a.articlesIndex.unshift(t),Pt()}function oo(e){if(!e)return;let t=a.articlesIndex.length;a.articlesIndex=a.articlesIndex.filter(n=>n.id!==e),t!==a.articlesIndex.length&&(Pt(),an())}function To(e){if(!e)return;let t=a.deletedArticlesIndex.length;a.deletedArticlesIndex=a.deletedArticlesIndex.filter(n=>n.id!==e),t!==a.deletedArticlesIndex.length&&(Pt(),an())}function af(e=[]){let t=new Map;e.forEach(o=>{t.set(o.id,{...o,children:[]})});let n=[];t.forEach(o=>{let i=o.parentId||null;i&&t.has(i)?t.get(i).children.push(o):n.push(o)});let r=o=>{o.sort((i,s)=>{let c=(a.favoriteArticles||[]).includes(i.id),l=(a.favoriteArticles||[]).includes(s.id);return c!==l?c?-1:1:i.position!==s.position?i.position-s.position:new Date(s.updatedAt||0)-new Date(i.updatedAt||0)}),o.forEach(i=>r(i.children||[]))};return r(n),n}function Pt(){if(!p.sidebarArticleList)return;p.sidebarArticleList.innerHTML="",p.backToList&&p.backToList.classList.toggle("active",a.sidebarArticlesMode!=="recent"),p.sidebarRecentBtn&&p.sidebarRecentBtn.classList.toggle("active",a.sidebarArticlesMode==="recent");let e=(a.articleFilterQuery||"").trim().toLowerCase(),t=a.sidebarArticlesMode==="recent"?"recent":"tree",n=a.isTrashView?a.deletedArticlesIndex:a.articlesIndex,r=new Set(a.favoriteArticles||[]),o=new Set(a.sidebarCollapsedArticleIds||[]),i=a.sidebarSelectedArticleId||a.articleId,s=Array.isArray(a.recentArticleIds)?a.recentArticleIds:[],c=[];if(!a.isTrashView&&(r.has("RAG")||t==="recent"&&s.includes("RAG"))){let f=(a.ragQuery||"").trim();c.push({id:"RAG",title:f?`AI: ${f}`:"AI: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B \u043F\u043E\u0438\u0441\u043A\u0430",updatedAt:new Date().toISOString(),deletedAt:null,publicSlug:null,parentId:null,position:0})}let d=new Set(c.map(f=>f.id)),u=c.length&&!a.isTrashView?[...(n||[]).filter(f=>!d.has(f.id)),...c]:n,m=new Set;(u||[]).forEach(f=>{let h=f.parentId||null;h&&m.add(h)});let y=(u||[]).filter(f=>(e?(f.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(e):!0)&&(a.isTrashView?!0:f.id!=="inbox"));if(!y.length){let f=document.createElement("li");f.className="sidebar-article-empty",f.textContent=a.isTrashView?e?"No deleted pages match the filter":"Trash is empty":e?"\u041D\u0435\u0442 \u0441\u043E\u0432\u043F\u0430\u0434\u0435\u043D\u0438\u0439":"\u041D\u0435\u0442 \u0441\u0442\u0430\u0442\u0435\u0439",p.sidebarArticleList.appendChild(f);return}if(t==="recent"){let f=new Map(y.map(A=>[A.id,A])),h=new Set(s),b=s.map(A=>f.get(A)).filter(Boolean),S=rf(y.filter(A=>!h.has(A.id)));[...b,...S].forEach(A=>{let v=document.createElement("li");v.className="sidebar-article-item",v.dataset.articleId=A.id;let B=document.createElement("div");B.className="sidebar-article-row";let H=document.createElement("button");H.type="button",!a.isTrashView&&A.id===i&&H.classList.add("active");let O=r.has(A.id),W=gt(A.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),J=A.publicSlug?'<i class="bx bx-link-external article-public-icon" aria-hidden="true"></i>':"",ne=O?"bxs-star":"bx-star";H.innerHTML=`<span class="sidebar-article-title">${J}${W}</span><span class="star-btn ${O?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${O?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}"><i class="bx ${ne}" aria-hidden="true"></i></span>`,H.addEventListener("click",()=>{window.__ttreeDraggingArticleId||(a.sidebarSelectedArticleId=A.id,tf(),It(wt.article(A.id)),a.isSidebarMobileOpen&&In(!1))});let me=H.querySelector(".star-btn");me&&me.addEventListener("click",we=>{we.stopPropagation(),vo(A.id)}),B.appendChild(H),v.appendChild(B),p.sidebarArticleList.appendChild(v)});return}let w=af(y),g=(f,h)=>{let b=document.createElement("li");b.className="sidebar-article-item",m.has(f.id)&&(b.classList.add("has-children"),o.has(f.id)&&b.classList.add("is-collapsed")),b.dataset.articleId=f.id,b.style.paddingLeft=`${h*1.25}rem`;let S=document.createElement("div");S.className="sidebar-article-row";let k=document.createElement("button");k.type="button",!a.isTrashView&&f.id===i&&k.classList.add("active");let A=r.has(f.id),v=gt(f.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),B=f.publicSlug?'<i class="bx bx-link-external article-public-icon" aria-hidden="true"></i>':"",H=A?"bxs-star":"bx-star";k.innerHTML=`<span class="sidebar-article-title">${B}${v}</span><span class="star-btn ${A?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${A?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}"><i class="bx ${H}" aria-hidden="true"></i></span>`,k.addEventListener("click",()=>{if(window.__ttreeDraggingArticleId)return;a.sidebarSelectedArticleId=f.id,a.sidebarCollapsedArticleIds||(a.sidebarCollapsedArticleIds=[]);let W=new Set(a.sidebarCollapsedArticleIds);W.has(f.id)?W.delete(f.id):W.add(f.id),a.sidebarCollapsedArticleIds=Array.from(W),pi(),Pt()}),k.addEventListener("dblclick",W=>{W.preventDefault(),W.stopPropagation(),a.sidebarSelectedArticleId=f.id,tf(),It(wt.article(f.id)),a.isSidebarMobileOpen&&In(!1)});let O=k.querySelector(".star-btn");O&&O.addEventListener("click",W=>{W.stopPropagation(),vo(f.id)}),S.appendChild(k),b.appendChild(S),a.isTrashView||(Bc(b),Cc(b,f.id)),p.sidebarArticleList.appendChild(b),o.has(f.id)||(f.children||[]).forEach(W=>g(W,h+1))};w.forEach(f=>g(f,0))}function an(e=null){if(!p.articleList)return;p.articleList.innerHTML="";let t="",n=Array.isArray(e)&&e.length?e:a.isTrashView?a.deletedArticlesIndex:a.articlesIndex,r=new Set(a.favoriteArticles||[]),o=new Set(a.listCollapsedArticleIds||[]),i=a.listSelectedArticleId||a.articleId,s=new Set;if(n.forEach(u=>{let m=u.parentId||null;m&&s.add(m)}),!n.length){let u=document.createElement("li");u.textContent=a.isTrashView?t?"No deleted pages match the filter":"Trash is empty":t?"\u041D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E":"\u0421\u043F\u0438\u0441\u043E\u043A \u043F\u0443\u0441\u0442.",p.articleList.appendChild(u);return}if(a.isTrashView){n.slice().filter(u=>(t?(u.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(t):!0)&&(a.isTrashView?!0:u.id!=="inbox")).forEach(u=>{let m=document.createElement("li");m.dataset.articleId=u.id,m.innerHTML=`
      <span>
        <strong>${gt(u.title)}</strong>
      </span>
      <div class="row-actions">
        <button class="ghost restore-btn" data-id="${u.id}">\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C</button>
        <button class="ghost danger delete-btn" data-id="${u.id}">\u0423\u0434\u0430\u043B\u0438\u0442\u044C</button>
      </div>
    `;let y=m.querySelector(".restore-btn"),w=m.querySelector(".delete-btn");y&&y.addEventListener("click",async g=>{g.preventDefault(),g.stopPropagation(),await Mg(u.id)}),w&&w.addEventListener("click",async g=>{g.preventDefault(),g.stopPropagation(),await Ng(u.id)}),p.articleList.appendChild(m)});return}let c=n.slice().filter(u=>(t?(u.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(t):!0)&&u.id!=="inbox"),l=af(c),d=(u,m)=>{let y=document.createElement("li");s.has(u.id)&&(y.classList.add("has-children"),o.has(u.id)&&y.classList.add("is-collapsed")),y.dataset.articleId=u.id;let w=r.has(u.id),g=gt(u.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),f=u.publicSlug?'<i class="bx bx-link-external article-public-icon" aria-hidden="true"></i>':"",h=w?"bxs-star":"bx-star";y.style.paddingLeft=`${m*1.25}rem`,y.innerHTML=`
      <span>
        <strong>${f}${g}</strong>
      </span>
      <button class="ghost star-btn ${w?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${w?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}"><i class="bx ${h}" aria-hidden="true"></i></button>
    `;let b=y.querySelector(".star-btn");b&&b.addEventListener("click",S=>{S.preventDefault(),S.stopPropagation(),vo(u.id)}),u.id===i&&y.classList.add("active-article"),y.addEventListener("click",()=>{if(window.__ttreeDraggingArticleId)return;a.listSelectedArticleId=u.id,a.listCollapsedArticleIds||(a.listCollapsedArticleIds=[]);let S=new Set(a.listCollapsedArticleIds);S.has(u.id)?S.delete(u.id):S.add(u.id),a.listCollapsedArticleIds=Array.from(S),no(),an()}),y.addEventListener("dblclick",S=>{S.preventDefault(),S.stopPropagation(),a.listSelectedArticleId=u.id,It(wt.article(u.id))}),p.articleList.appendChild(y),a.isTrashView||(Bc(y),Cc(y,u.id)),o.has(u.id)||(u.children||[]).forEach(S=>d(S,m+1))};l.forEach(u=>d(u,0))}async function Mg(e){if(e)try{let t=await du(e);To(e),Xn(t),await yi(!1),It(wt.article(t.id)),P("Page restored")}catch(t){P(t.message)}}async function Ng(e){if(e)try{await as(e,{force:!0}),To(e),P("\u0421\u0442\u0430\u0442\u044C\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u0431\u0435\u0437\u0432\u043E\u0437\u0432\u0440\u0430\u0442\u043D\u043E"),an(),Pt()}catch(t){P(t.message)}}async function yi(e){a.isTrashView=e,xc(),e?await Es():await Ir(),Pt(),an()}async function Ir(){if(a.articlesIndex.length)return a.isTrashView||Pt(),a.articlesIndex;let e=await zn();return ks(e),e}async function Es(){if(a.deletedArticlesIndex.length)return a.isTrashView&&Pt(),a.deletedArticlesIndex;let e=await tu();return of(e),e}var nf,vs=Ke(()=>{At();Vt();Un();qn();Xt();zt();ws();Eo();Lc();nf="ttree_favorites"});function df(){try{let t=(window.localStorage.getItem(cf)||""||"").trim().toLowerCase();(t==="recent"||t==="tree")&&(a.sidebarArticlesMode=t)}catch{}try{let e=window.localStorage.getItem(lf)||"[]",t=JSON.parse(e);Array.isArray(t)&&(a.recentArticleIds=t.filter(n=>typeof n=="string"&&n&&n!=="inbox").slice(0,Mc))}catch{}}function Pg(){try{window.localStorage.setItem(cf,a.sidebarArticlesMode||"tree")}catch{}}function Dg(){try{let e=Array.isArray(a.recentArticleIds)?a.recentArticleIds:[];window.localStorage.setItem(lf,JSON.stringify(e.slice(0,Mc)))}catch{}}function Nc(){let e=a.sidebarArticlesMode,t=a.sidebarArticlesMode==="recent"?"tree":"recent";a.sidebarArticlesMode=t,Pg(),e==="recent"&&t==="tree"&&kr(),Pt(),e==="recent"&&t==="tree"&&window.requestAnimationFrame(()=>{try{Is()}catch{}})}function Ts(e){if(!e||e==="inbox"||a.isPublicView)return;let t=Array.isArray(a.recentArticleIds)?a.recentArticleIds:[],n=[e,...t.filter(r=>r!==e)];a.recentArticleIds=n.slice(0,Mc),Dg(),a.sidebarArticlesMode==="recent"&&Pt()}var cf,lf,Mc,Pc=Ke(()=>{At();vs();Eo();cf="ttree_sidebar_articles_mode",lf="ttree_recent_articles",Mc=300});function uf(){Vu(),Ku(),ju(),df(),p.sidebar&&ro(!!a.isSidebarCollapsed)}var En=Ke(()=>{Vt();At();Pc();Eo();ws();Lc();vs();Eo();Pc();ws();vs();Qu({renderSidebarArticleList:Pt,renderMainArticleList:an,setArticlesIndex:ks})});function Cs(e){a.articleId&&(a.articleEncryptionKeys||(a.articleEncryptionKeys={}),e?a.articleEncryptionKeys[a.articleId]=e:delete a.articleEncryptionKeys[a.articleId])}async function pf(e){if(!e||!e.encrypted)return e;let t=a.articleEncryptionKeys?.[e.id]||null;if(t)return await Sc(e,t),e;let n=0;for(;;){n+=1;let r=null;try{let o=e.encryptionHint||"",i="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C \u0434\u043B\u044F \u044D\u0442\u043E\u0439 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B.",s=o?`${i}
\u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0430: ${o}`:i;r=await xn({title:"\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430",message:s,confirmText:"\u041E\u0442\u043A\u0440\u044B\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"\u041F\u0430\u0440\u043E\u043B\u044C",inputType:"password"})}catch{r=window.prompt("\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430. \u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C:")||""}if(!r)throw new Error("\u041F\u0430\u0440\u043E\u043B\u044C \u043D\u0435 \u0432\u0432\u0435\u0434\u0451\u043D");try{let{key:o}=await gs(r,e.encryptionSalt||"");if(!await Nu(o,e.encryptionVerifier||"")){if(n>=3)throw new Error("\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C");window.alert("\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C, \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437.");continue}return await Sc(e,o),Cs(o),e}catch(o){if(n>=3)throw new Error(o.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");window.alert("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443, \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437.")}}}async function ff(e,t){if(!e||!Array.isArray(e.blocks))return;let n=[...e.blocks];for(let r of n){let o=Array.isArray(r.children)?r.children:[];n.push(...o);let i=r.text||"",s=await ys(t,i);await He(`/api/articles/${e.id}/blocks/${r.id}`,{method:"PATCH",body:JSON.stringify({text:s})})}}async function Bs(){if(!a.article||!a.articleId){P("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}if(a.articleId==="inbox"){P("\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438 \u043D\u0435\u043B\u044C\u0437\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C");return}if(!a.currentUser){P("\u041D\u0443\u0436\u043D\u043E \u0432\u043E\u0439\u0442\u0438 \u0432 \u0441\u0438\u0441\u0442\u0435\u043C\u0443");return}let e=a.article;if(e.encrypted){let o=null;try{o=await ms({title:"\u0421\u043C\u0435\u043D\u0438\u0442\u044C \u043F\u0430\u0440\u043E\u043B\u044C",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043D\u043E\u0432\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C \u0438 \u043F\u0440\u0438 \u0436\u0435\u043B\u0430\u043D\u0438\u0438 \u043F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0443.",confirmText:"\u041F\u0435\u0440\u0435\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"})}catch{o=null}if(!o||!o.password)return;let{password:i,hint:s}=o;try{let{key:c,salt:l}=await gs(i,""),d=await wc(c);P("\u041F\u0435\u0440\u0435\u0448\u0438\u0444\u0440\u043E\u0432\u044B\u0432\u0430\u0435\u043C \u0441\u043E\u0434\u0435\u0440\u0436\u0438\u043C\u043E\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B..."),await ff(e,c);let u=await He(`/api/articles/${a.articleId}`,{method:"PATCH",body:JSON.stringify({encrypted:!0,encryptionSalt:l,encryptionVerifier:d,encryptionHint:s||null})});e.encrypted=!0,e.encryptionSalt=l,e.encryptionVerifier=d,e.encryptionHint=s||null,e.updatedAt=u?.updatedAt||e.updatedAt,Cs(c),Xn(u),$n(),P("\u041F\u0430\u0440\u043E\u043B\u044C \u043E\u0431\u043D\u043E\u0432\u043B\u0451\u043D"),qt("toggleArticleEncryption: password changed",{id:e.id,encrypted:e.encrypted,hasSalt:!!e.encryptionSalt,hasVerifier:!!e.encryptionVerifier})}catch(c){P(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443")}return}let t=null;try{t=await ms({title:"\u0417\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C \u0438 \u043F\u0440\u0438 \u0436\u0435\u043B\u0430\u043D\u0438\u0438 \u043F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0443.",confirmText:"\u0417\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"})}catch{t=null}if(!t||!t.password)return;let{password:n,hint:r}=t;try{let{key:o,salt:i}=await gs(n,""),s=await wc(o);P("\u0428\u0438\u0444\u0440\u0443\u0435\u043C \u0441\u043E\u0434\u0435\u0440\u0436\u0438\u043C\u043E\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B..."),await ff(e,o);let c=await He(`/api/articles/${a.articleId}`,{method:"PATCH",body:JSON.stringify({encrypted:!0,encryptionSalt:i,encryptionVerifier:s,encryptionHint:r||null})});e.encrypted=!0,e.encryptionSalt=i,e.encryptionVerifier=s,e.encryptionHint=r||null,e.updatedAt=c?.updatedAt||e.updatedAt,Cs(o),Xn(c),$n(),P("\u0428\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0432\u043A\u043B\u044E\u0447\u0435\u043D\u043E"),qt("toggleArticleEncryption: enabled",{id:e.id,encrypted:e.encrypted,hasSalt:!!e.encryptionSalt,hasVerifier:!!e.encryptionVerifier})}catch(o){P(o.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0438\u0435")}}async function Ls(){if(!a.article||!a.articleId){P("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}if(a.articleId==="inbox"){P("\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438 \u043D\u0435\u043B\u044C\u0437\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C/\u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C");return}let e=a.article;if(!e.encrypted){P("\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0443\u0436\u0435 \u043D\u0435 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430");return}let t=!1;try{t=await Vn({title:"\u0421\u043D\u044F\u0442\u044C \u0437\u0430\u0449\u0438\u0442\u0443?",message:"\u0421\u043E\u0434\u0435\u0440\u0436\u0438\u043C\u043E\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B \u0431\u0443\u0434\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u0432 \u043E\u0442\u043A\u0440\u044B\u0442\u043E\u043C \u0432\u0438\u0434\u0435.",confirmText:"\u0421\u043D\u044F\u0442\u044C \u0437\u0430\u0449\u0438\u0442\u0443",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"})}catch{t=window.confirm("\u0421\u043D\u044F\u0442\u044C \u0437\u0430\u0449\u0438\u0442\u0443 \u0438 \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0432 \u043E\u0442\u043A\u0440\u044B\u0442\u043E\u043C \u0432\u0438\u0434\u0435?")}if(t)try{if(P("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0432 \u043E\u0442\u043A\u0440\u044B\u0442\u043E\u043C \u0432\u0438\u0434\u0435..."),Array.isArray(e.blocks)){let r=[...e.blocks];for(let o of r){let i=Array.isArray(o.children)?o.children:[];r.push(...i);let s=o.text||"";await He(`/api/articles/${e.id}/blocks/${o.id}`,{method:"PATCH",body:JSON.stringify({text:s})})}}let n=await He(`/api/articles/${a.articleId}`,{method:"PATCH",body:JSON.stringify({encrypted:!1,encryptionSalt:null,encryptionVerifier:null})});e.encrypted=!1,e.encryptionSalt=null,e.encryptionVerifier=null,e.encryptionHint=null,e.updatedAt=n?.updatedAt||e.updatedAt,Cs(null),Xn(n),$n(),P("\u0428\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B \u043E\u0442\u043A\u043B\u044E\u0447\u0435\u043D\u043E"),qt("removeArticleEncryption: disabled",{id:e.id,encrypted:e.encrypted})}catch(n){P(n.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0438\u0435")}}var Dc=Ke(()=>{At();Xt();zt();Qn();Un();fi();En();Zo()});function gf(e=""){return e.split(/\r?\n/).some(t=>/^(\s*)-\s+/.test(t))}function hf(e=""){if(!e)return"";let t=[],n=0,r=e.replace(/\[\[block\s+id=([a-zA-Z0-9_-]+)\]\]([\s\S]*?)\[\[\/block\]\]/gi,(i,s,c)=>{let l=`__INLINE_BLOCK_${n}__`;return t.push({token:l,html:`<span class="inline-fragment" data-inline-block-id="${gt(s.trim())}">${gt((c||"").trim())}</span>`}),n+=1,l}),o=gt(r);return t.forEach(({token:i,html:s})=>{let c=new RegExp(us(i),"g");o=o.replace(c,s)}),o}function Og(e=""){if(!e||!e.trim())return"";let t=e.replace(/\r/g,""),n=t.split(/\n{2,}/).map(r=>r.trim()).filter(Boolean);return n.length?n.map(r=>`<div>${hf(r).replace(/\n/g,"<br />")}</div>`).join(""):`<div>${hf(t.trim()).replace(/\n/g,"<br />")}</div>`}function Rg(e=[]){let t={title:"",content:"",comments:[],attributes:[]},n="content";e.forEach(o=>{let i=o.replace(/^\s+/,"");if(!i)return;let s=i.match(/^([A-Za-zА-Яа-яЁё]+)\s*:(.*)$/);if(s){let c=s[1].toLowerCase();if(mf[c]){n=mf[c];let l=s[2]?.trim()||"";l&&(n==="comments"?t.comments.push(l.replace(/^[-*+]\s*/,"")):n==="attributes"?t.attributes.push(l):n==="title"?t.title=l:t.content=t.content?`${t.content}
${l}`:l);return}}n==="comments"?t.comments.push(i.replace(/^[-*+]\s*/,"")):n==="attributes"?t.attributes.push(i):n==="title"?t.title=t.title?`${t.title}
${i}`:i:t.content=t.content?`${t.content}
${i}`:i});let r={};return t.attributes.forEach(o=>{let i=o.match(/^\s*(?:[-*+]\s*)?([^:=]+):=$/);if(i){let s=i[1].trim(),c=i[2].trim();s&&(r[s]=c)}}),{title:t.title.trim(),content:t.content.trim(),comments:t.comments.filter(Boolean),attributes:r}}function yf(e=""){let t=e.replace(/\t/g,"  ").split(/\r?\n/),n={level:-1,children:[]},r=[n];t.forEach(i=>{if(!i.trim())return;let s=i.match(/^(\s*)-\s+(.*)$/);if(s){let l=s[1].length,d=Math.floor(l/_g);for(;r.length&&r[r.length-1].level>=d;)r.pop();let u=r[r.length-1],m=u.block?u.block.children:u.children,y={title:s[2].trim(),detailLines:[],children:[]};m.push(y),r.push({level:d,block:y,children:y.children});return}let c=r[r.length-1];c?.block&&c.block.detailLines.push(i)});let o=i=>{let s=Rg(i.detailLines||[]);return{title:s.title||i.title,content:s.content,comments:s.comments,attributes:s.attributes,children:(i.children||[]).map(c=>o(c))}};return n.children.map(i=>o(i))}function Hg(e=[]){return e?.length?`<div class="block-section block-section--comments"><strong>\u041A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0438:</strong><ul>${e.map(n=>`<li>${gt(n)}</li>`).join("")}</ul></div>`:""}function $g(e={}){let t=Object.entries(e||{});return t.length?`<div class="block-section block-section--attributes"><strong>\u0410\u0442\u0440\u0438\u0431\u0443\u0442\u044B:</strong><ul>${t.map(([r,o])=>`<li><strong>${gt(r)}:</strong> ${gt(o)}</li>`).join("")}</ul></div>`:""}function _c(e){if(!e)return null;let t=e.title?.trim()||"\u041D\u043E\u0432\u044B\u0439 \u0431\u043B\u043E\u043A",n=Og(e.content),r=Hg(e.comments),o=$g(e.attributes),i=[n,r,o].filter(Boolean).join(""),s=i?`${t}<div><br /></div>${i}`:t;return{text:Oc(s),collapsed:!1,children:(e.children||[]).map(c=>_c(c)).filter(Boolean)}}var _g,mf,bf=Ke(()=>{Un();vn();_g=2,mf={\u043D\u0430\u0438\u043C\u0435\u043D\u043E\u0432\u0430\u043D\u0438\u0435:"title",\u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435:"title",\u0441\u043E\u0434\u0435\u0440\u0436\u0438\u043C\u043E\u0435:"content",\u0442\u0435\u043A\u0441\u0442:"content",\u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0438:"comments",\u0430\u0442\u0440\u0438\u0431\u0443\u0442\u044B:"attributes"}});function Fg(e){if(!e)return;e.focus({preventScroll:!0});let t=window.getSelection&&window.getSelection();if(!t)return;t.removeAllRanges();let n=document.createRange();n.selectNodeContents(e),n.collapse(!1),t.addRange(n)}function wf(e,t="\u0412\u0441\u0442\u0430\u0432\u043B\u044F\u0435\u043C Markdown..."){a.isMarkdownInserting=e;let n=p.pasteProgress;if(!n)return;let r=n.querySelector(".inline-progress__text");r&&t&&(r.textContent=t),n.classList.toggle("hidden",!e)}async function Rc(e){return!a.article||!a.article.encrypted||!a.articleEncryptionKey?e:ys(a.articleEncryptionKey,e)}async function zg(e){if(!a.article||!a.article.encrypted||!a.articleEncryptionKey||!e)return e;let t=JSON.parse(JSON.stringify(e));return await ui(t,a.articleEncryptionKey),t}async function Ms(){if(!a.currentBlockId||a.isRagView)return;let e=a.currentBlockId;a.editingScrollTop=p.blocksContainer?p.blocksContainer.scrollTop:null,a.mode="edit",a.scrollTargetBlockId=null,a.editingBlockId=a.currentBlockId,a.editingInitialText=Qe(a.currentBlockId)?.block.text||"",a.editingUndo=null,await Lt(e);let t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`);if(t||(st("actions.startEditing.fallback.fullRender"),await Lt(e),t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`)),!t){a.mode="view",a.editingBlockId=null,a.editingInitialText="",a.editingUndo=null,a.currentBlockId=e,P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430");return}Fg(t)}async function bi(){if(a.mode!=="edit"||!a.editingBlockId)return;let e=a.editingBlockId,t=Qe(e),n=t?.block.text||"",o=document.querySelector(`.block[data-block-id="${a.editingBlockId}"] .block-text`)?.innerHTML||"",{cleanupEditableHtml:i}=await Promise.resolve().then(()=>(vn(),Hc)),s=i(o);if(!(s||"").trim()){let l=wi(e),d=Qe(e),u=!!(d?.block&&d.block.__isNew);if(d&&a.article&&Array.isArray(a.article.blocks)){let m=d.siblings||a.article.blocks,y=d.index??m.findIndex(w=>w&&w.id===e);if(y>=0&&m.splice(y,1),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}if(!u){let w=Er(d.block);Si(w,d.parent?.id||null,d.index??null)}}a.mode="view",a.editingBlockId=null,a.editingInitialText="",a.currentBlockId=l,a.scrollTargetBlockId=l,Lo(e),st("actions.saveEditing.empty.delete.localRender"),(async()=>{try{let m=u?`/api/articles/${a.articleId}/blocks/${e}/permanent`:`/api/articles/${a.articleId}/blocks/${e}`,y=await He(m,{method:"DELETE"});if(!u&&y?.block){let w=Er(y.block);Tn({type:"structure",action:{kind:"delete",parentId:y.parentId||null,index:y.index??null,block:w,blockId:w?.id,fallbackId:l}})}P("\u041F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A \u0443\u0434\u0430\u043B\u0451\u043D")}catch(m){P(m.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await nn(a.articleId,{desiredBlockId:l||null}),st("actions.saveEditing.empty.delete.reloadAfterError")}catch{}}})();return}if(s===n){a.mode="view",a.editingBlockId=null,a.editingInitialText="",a.editingUndo=null,a.pendingEditBlockId=null,a.currentBlockId=e,a.scrollTargetBlockId=e,await Lt(e);return}if(t&&a.article&&Array.isArray(a.article.blocks)&&(t.block.text=s,a.article.updatedAt))try{a.article.updatedAt=new Date().toISOString()}catch{}a.mode="view",a.editingBlockId=null,a.editingInitialText="",a.editingUndo=null,a.pendingEditBlockId=null,a.currentBlockId=e,a.scrollTargetBlockId=e,await Lt(e),(async()=>{try{let l=await Rc(s),d=await He(`/api/articles/${a.articleId}/blocks/${e}`,{method:"PATCH",body:JSON.stringify({text:l})});n!==s&&(!!(t?.block&&t.block.__isNew)?delete t.block.__isNew:Tn({type:"text",blockId:e,historyEntryId:d?.historyEntryId||null})),P("\u0411\u043B\u043E\u043A \u043E\u0431\u043D\u043E\u0432\u043B\u0451\u043D")}catch(l){P(l.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await nn(a.articleId,{desiredBlockId:e}),st("actions.saveEditing.patchError.reload")}catch{}}})()}async function Ns(){if(a.mode!=="edit"||!a.editingBlockId)return;let e=a.editingBlockId,r=!(document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`)?.textContent||"").replace(/\u00a0/g," ").trim();if(a.mode="view",a.editingBlockId=null,a.editingInitialText="",a.editingUndo=null,r){let o=wi(e),i=Qe(e),s=!!(i?.block&&i.block.__isNew);if(i&&a.article&&Array.isArray(a.article.blocks)){let l=i.siblings||a.article.blocks,d=i.index??l.findIndex(u=>u&&u.id===e);if(d>=0&&l.splice(d,1),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}a.currentBlockId=o,a.scrollTargetBlockId=o,Lo(e);let c=i?.parent?.id||null;c?await Lt(c):st("actions.cancelEditing.empty.delete.localRender"),(async()=>{try{let l=s?`/api/articles/${a.articleId}/blocks/${e}/permanent`:`/api/articles/${a.articleId}/blocks/${e}`,d=await He(l,{method:"DELETE"});if(!s&&d?.block){let u=Er(d.block);Tn({type:"structure",action:{kind:"delete",parentId:d.parentId||null,index:d.index??null,block:u,blockId:u?.id,fallbackId:o}})}}catch(l){P(l.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await nn(a.articleId,{desiredBlockId:o||null}),st("actions.cancelEditing.empty.delete.reloadAfterError")}catch{}}})();return}a.currentBlockId=e,await Lt(e)}async function Co(){if(a.mode!=="edit"||!a.editingBlockId)return;let e=a.editingBlockId,t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`);if(!t)return;let n=window.getSelection();if(!n||n.rangeCount===0||!t.contains(n.anchorNode))return;let r=n.getRangeAt(0).cloneRange(),o=document.createElement("span"),i=`split-marker-${Date.now()}-${Math.random().toString(16).slice(2)}`;o.setAttribute("data-split-marker",i),o.textContent="",r.insertNode(o);let s=t.innerHTML;o.parentNode.removeChild(o);let c=`<span data-split-marker="${i}"></span>`,l=s.split(c);if(l.length!==2)return;let[d,u]=l,{cleanupEditableHtml:m}=await Promise.resolve().then(()=>(vn(),Hc)),y=m(d||""),w=m(u||"");if(!(!w||w===y))try{let g=Qe(e),f=g?.block,h=f?Er(f):null,b=await Rc(y);await He(`/api/articles/${a.articleId}/blocks/${e}`,{method:"PATCH",body:JSON.stringify({text:b})});let k=(await He(`/api/articles/${a.articleId}/blocks/${e}/siblings`,{method:"POST",body:JSON.stringify({direction:"after"})}))?.block?.id;if(!k){P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043D\u043E\u0432\u044B\u0439 \u0431\u043B\u043E\u043A");return}let A=await Rc(w);if(await He(`/api/articles/${a.articleId}/blocks/${k}`,{method:"PATCH",body:JSON.stringify({text:A})}),g&&a.article&&Array.isArray(a.article.blocks)){g.block.text=y;let B=g.parent,H=g.siblings||a.article.blocks||[],O=(g.index??0)+1,W={id:k,text:w,children:[],collapsed:!1};if(H.splice(O,0,W),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}a.mode="edit",a.editingBlockId=k,a.pendingEditBlockId=null,a.currentBlockId=k,a.scrollTargetBlockId=k,a.editingCaretPosition="start";let v=g?.parent?.id||null;v?await Lt(v):st(),h&&Tn({type:"text",blockId:e,block:h})}catch(g){P(g.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0437\u0431\u0438\u0442\u044C \u0431\u043B\u043E\u043A")}}async function zr(e){if(!a.currentBlockId)return;if(!a.article||!Array.isArray(a.article.blocks)){P("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}let t=a.currentBlockId;try{let n=Qe(t);if(!n){P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u0442\u0435\u043A\u0443\u0449\u0438\u0439 \u0431\u043B\u043E\u043A");return}let r=n.parent?.id||null,o=n.siblings||a.article.blocks;Array.isArray(o)||(o=a.article.blocks);let i=typeof n.index=="number"?n.index:o.findIndex(d=>d&&d.id===t);i<0&&(i=o.length);let s=e==="before"?i:i+1,c=window.crypto&&window.crypto.randomUUID?window.crypto.randomUUID():`block-${Date.now().toString(16)}-${Math.random().toString(16).slice(2)}`,l={id:c,text:"",children:[],collapsed:!1,__isNew:!0};if(o.splice(s,0,l),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}a.mode="edit",a.editingBlockId=c,a.editingInitialText="",a.pendingEditBlockId=null,a.currentBlockId=c,r?await Lt(r):st(),(async()=>{try{let d={id:c,text:"",children:[],collapsed:!1},u=await He(`/api/articles/${a.articleId}/blocks/${t}/siblings`,{method:"POST",body:JSON.stringify({direction:e,payload:d})}),m=u?.block;if(!m||!m.id)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043D\u043E\u0432\u044B\u0439 \u0431\u043B\u043E\u043A");let y=Er(m);Tn({type:"structure",action:{kind:"create",parentId:u.parentId||r||null,index:typeof u.index=="number"?u.index:null,blockId:m.id,block:y,fallbackId:t}})}catch(d){P(d.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043D\u043E\u0432\u044B\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await nn(a.articleId,{desiredBlockId:t}),st()}catch{}}})()}catch(n){P(n.message)}}async function Ps(){if(!a.currentBlockId)return;if(Ds(a.article?.blocks||[])<=1){P("\u041D\u0435\u043B\u044C\u0437\u044F \u0443\u0434\u0430\u043B\u044F\u0442\u044C \u043F\u043E\u0441\u043B\u0435\u0434\u043D\u0438\u0439 \u0431\u043B\u043E\u043A");return}if(a.isDeletingBlock)return;a.isDeletingBlock=!0;let e=wi(a.currentBlockId);try{let t=a.currentBlockId,n=Qe(t),r=n?.block?Er(n.block):null,o=await He(`/api/articles/${a.articleId}/blocks/${a.currentBlockId}`,{method:"DELETE"});if(n&&a.article&&Array.isArray(a.article.blocks)){let s=n.siblings||a.article.blocks,c=n.index??s.findIndex(l=>l.id===t);if(c>=0&&s.splice(c,1),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}r&&r.id&&Si(r,n.parent?.id||null,n.index??c)}Lo(t),a.currentBlockId=e,a.scrollTargetBlockId=e;let i=n?.parent?.id||null;i?await Lt(i):st(),r&&r.id&&Tn({type:"structure",action:{kind:"delete",parentId:n?.parent?.id||null,index:n?.index??null,block:r,blockId:r.id,fallbackId:e}})}catch(t){P(t.message)}finally{a.isDeletingBlock=!1}}async function Ug(e=[]){if(!e.length){P("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u043B\u044F\u0442\u044C \u043F\u0443\u0441\u0442\u044B\u0435 \u0431\u043B\u043E\u043A\u0438 \u0438\u0437 Markdown");return}if(!a.articleId){P("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u043B\u044F\u0442\u044C \u0431\u043B\u043E\u043A\u0438 \u0431\u0435\u0437 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0439 \u0441\u0442\u0430\u0442\u044C\u0438");return}if(!a.currentBlockId){P("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u043B\u044F\u0442\u044C \u0431\u043B\u043E\u043A\u0438 \u0431\u0435\u0437 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u0431\u043B\u043E\u043A\u0430");return}if(a.isMarkdownInserting){P("\u0418\u0434\u0451\u0442 \u0432\u0441\u0442\u0430\u0432\u043A\u0430 Markdown, \u043F\u043E\u0436\u0430\u043B\u0443\u0439\u0441\u0442\u0430, \u043F\u043E\u0434\u043E\u0436\u0434\u0438\u0442\u0435...");return}wf(!0);try{let t=a.currentBlockId,n=null,r=null;for(let o of e){let i=_c(o);if(!i)continue;let s=await zg(i),c=await He(`/api/articles/${a.articleId}/blocks/${t}/siblings`,{method:"POST",body:JSON.stringify({direction:"after",payload:s})}),l=c?.block;if(l&&l.id&&(t=l.id,n=l.id,r=c.parentId||null,a.article&&Array.isArray(a.article.blocks))){let d=null;if(r){let g=Qe(r)?.block||null;g&&(Array.isArray(g.children)||(g.children=[]),d=g.children)}else d=a.article.blocks;Array.isArray(d)||(d=a.article.blocks);let u=typeof c.index=="number"?c.index:null,m=u!==null&&u>=0&&u<=d.length?u:d.length,y=Er(l)||l;if(d.splice(m,0,y),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}}if(!n){P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u043D\u0438 \u043E\u0434\u043D\u043E\u0433\u043E \u0431\u043B\u043E\u043A\u0430");return}a.currentBlockId=n,a.scrollTargetBlockId=n,r?await Lt(r):st(),P("\u0411\u043B\u043E\u043A\u0438 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u044B \u0438\u0437 Markdown")}finally{wf(!1)}}function Sf(e){if(a.mode!=="view")return;let t=e.target;if(Iu(t))return;let n=e.clipboardData?.getData("text/plain");if(!n||!gf(n))return;e.preventDefault();let r=yf(n);Ug(r).catch(o=>{P(o.message)})}var Bo=Ke(()=>{At();Xt();Vt();zt();mr();mr();ar();vn();bf();Un();fi()});function Vg(e){try{let t=window.getComputedStyle(e).lineHeight,n=Number.parseFloat(t);if(Number.isFinite(n)&&n>0)return n}catch{}return 24}function qg(e,{behavior:t="smooth",topLines:n=2,bottomLines:r=5}={}){if(!e)return;let o=p.blocksContainer||document.scrollingElement||document.documentElement;if(!o)return;let i=o.getBoundingClientRect(),s=e.getBoundingClientRect(),c=Vg(o),l=Math.round(c*n),d=Math.round(c*r),u=0,m=i.top+l,y=i.bottom-d;if(s.bottom>y)u=s.bottom-y;else if(s.top<m)u=s.top-m;else return;if(o===document.body||o===document.documentElement||o===document.scrollingElement){window.scrollBy({top:u,behavior:t});return}o.scrollBy({top:u,behavior:t})}function On(e=[],t=[]){return(e||[]).forEach(n=>{t.push(n),n.children&&n.children.length>0&&!n.collapsed&&On(n.children,t)}),t}function Qe(e,t=a.article?.blocks||[],n=null,r=[]){for(let o=0;o<t.length;o+=1){let i=t[o];if(i.id===e)return{block:i,parent:n,index:o,siblings:t,ancestors:r};let s=Qe(e,i.children||[],i,[...r,i]);if(s)return s}return null}function xi({scrollIntoView:e=!1,scrollBehavior:t="smooth"}={}){let n=new Set(Array.isArray(a.selectedBlockIds)?a.selectedBlockIds:[]);if(a.currentBlockId&&n.add(a.currentBlockId),document.querySelectorAll(".block[data-block-id]").forEach(o=>{let i=o.getAttribute("data-block-id"),s=i&&n.has(i);o.classList.toggle("selected",!!s),o.classList.remove("block--selected-root-ancestor");let c=o.querySelector(":scope > .block-surface");c&&c.classList.remove("block--selected-root-ancestor")}),a.currentBlockId&&a.article&&Array.isArray(a.article.blocks)){let o=Qe(a.currentBlockId),i=o?.ancestors||[],s=i.length>0?i[0]?.id:o?.block?.id;if(s){let c=document.querySelector(`.block[data-block-id="${s}"]`);if(c){let l=c.querySelector(":scope > .block-surface");l&&l.classList.add("block--selected-root-ancestor")}}}if(e&&a.mode==="view"&&a.currentBlockId){let o=document.querySelector(`.block[data-block-id="${a.currentBlockId}"]`);o&&qg(o,{behavior:t||"smooth",topLines:2,bottomLines:5})}}function xf(e,t={}){if(!e||a.currentBlockId===e)return;let{preserveSelection:n=!1,scrollIntoView:r,scrollBehavior:o}=t;a.currentBlockId=e,n||(a.selectionAnchorBlockId=null,a.selectedBlockIds=[]);let i=typeof r=="boolean"?r:a.mode==="view";xi({scrollIntoView:i,scrollBehavior:o||"smooth"})}function Kn(e,t={}){xf(e,{preserveSelection:!1,...t})}function ki(e){if(!a.article)return;let t=On(a.article.blocks),n=t.findIndex(o=>o.id===a.currentBlockId);if(n===-1)return;let r=t[n+e];r&&(a.mode==="view"&&(a.scrollTargetBlockId=r.id),xf(r.id,{preserveSelection:!1}))}function Ai(e){if(!a.article)return;let t=On(a.article.blocks);if(!t.length)return;let n=a.selectionAnchorBlockId||a.currentBlockId||t[0].id;n||(n=t[0].id),a.selectionAnchorBlockId||(a.selectionAnchorBlockId=n);let r=t.findIndex(u=>u.id===n);if(r===-1)return;let o=a.currentBlockId||n,i=t.findIndex(u=>u.id===o);i===-1&&(i=r);let s=i+e;if(s<0||s>=t.length)return;let[c,l]=s>=r?[r,s]:[s,r],d=t.slice(c,l+1).map(u=>u.id);a.selectedBlockIds=d,a.currentBlockId=t[s].id,a.mode==="view"&&(a.scrollTargetBlockId=a.currentBlockId),xi({scrollIntoView:a.mode==="view"})}var kf=Ke(()=>{At();Vt()});function Ur(e){return e?e.nodeType===Node.TEXT_NODE?/\n\s*\n/.test(e.textContent||""):e.nodeType===Node.ELEMENT_NODE&&(e.tagName==="BR"||(e.tagName==="P"||e.tagName==="DIV")&&(!(e.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&(nbsp|#160);/gi,"").trim()||!(e.textContent||"").replace(/\u00a0/g,"").trim()&&!e.querySelector("img"))):!1}function _s(e=[]){let t=document.createElement("div");return e.forEach(n=>t.appendChild(n)),t.innerHTML.trim()}function $c(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=[],r=(i="")=>{let s=document.createElement("p");i?s.innerHTML=i:s.appendChild(document.createElement("br")),n.push(s)};Array.from(t.content.childNodes).forEach(i=>{if(i.nodeType===Node.TEXT_NODE){let s=(i.textContent||"").trim();s&&r(s);return}if(i.nodeType===Node.ELEMENT_NODE){if(i.tagName==="P"){n.push(i.cloneNode(!0));return}if(i.tagName==="BR"){r("");return}if(i.tagName==="DIV"){r(i.innerHTML);return}r(i.outerHTML)}}),n.length||r("");let o=document.createElement("div");return n.forEach(i=>o.appendChild(i)),o.innerHTML}function jn(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll(".block-header").forEach(m=>{let y=m.parentNode;if(y){for(;m.firstChild;)y.insertBefore(m.firstChild,m);y.removeChild(m)}});let n=Array.from(t.content.childNodes),r=m=>m?.nodeType===Node.TEXT_NODE&&!(m.textContent||"").trim(),o=0;for(;o<n.length&&r(n[o]);)o+=1;let i=n[o];if(!i||i.nodeType!==Node.ELEMENT_NODE||i.tagName!=="P"||Ur(i))return{titleHtml:"",bodyHtml:_s(n)};let s=o+1;for(;s<n.length&&r(n[s]);)s+=1;let c=n[s];if(!(!!c&&Ur(c)&&(c.nodeType===Node.ELEMENT_NODE?c.tagName==="P"||c.tagName==="DIV"||c.tagName==="BR":!1)))return{titleHtml:"",bodyHtml:_s(n)};let d=[i.cloneNode(!0)],u=[];for(let m=s+1;m<n.length;m+=1)u.push(n[m].cloneNode(!0));return{titleHtml:_s(d),bodyHtml:_s(u)}}function Af({event:e,element:t,range:n,selection:r,notifyEditingInput:o,logDebug:i}){if(!e||!t||!n||!r||!n.collapsed)return!1;let s=e.key==="Backspace"||e.code==="Backspace"||e.keyCode===8,c=e.key==="Delete"||e.key==="Del"||e.code==="Delete"||e.code==="Del"||e.keyCode===46;if(!s&&!c)return!1;let l=h=>{try{r.removeAllRanges(),r.addRange(h)}catch{}try{t.focus({preventScroll:!0})}catch{t.focus()}},d=h=>{let S=(n.commonAncestorContainer?.nodeType===Node.ELEMENT_NODE?n.commonAncestorContainer:n.commonAncestorContainer?.parentElement)?.closest?.("p");if(S)return S;let k=t,A=Array.from(k.childNodes),v=n.startContainer;for(;v&&v.parentNode!==k;)v=v.parentNode;let B=v?A.indexOf(v):-1,H=O=>{let W=O==="prev"?-1:1,J=B;for(J===-1?J=O==="prev"?A.length-1:0:J=O==="prev"?J-1:J;J>=0&&J<A.length;){let ne=A[J];if(ne?.nodeType===Node.ELEMENT_NODE&&ne.tagName==="P")return ne;J+=W}return null};return h==="Delete"?H("next")||H("prev"):h==="Backspace"?H("prev")||H("next"):null},u=()=>{if(n.startContainer!==t)return{prev:null,next:null};let h=Array.from(t.childNodes),b=n.startOffset,S=null,k=null;for(let A=b-1;A>=0;A-=1){let v=h[A];if(v?.nodeType===Node.ELEMENT_NODE&&v.tagName==="P"){S=v;break}}for(let A=b;A<h.length;A+=1){let v=h[A];if(v?.nodeType===Node.ELEMENT_NODE&&v.tagName==="P"){k=v;break}}return{prev:S,next:k}},m=h=>{let b=h?.previousElementSibling;for(;b&&b.tagName!=="P";)b=b.previousElementSibling;return b&&b.tagName==="P"?b:null},y=h=>{let b=h?.nextElementSibling;for(;b&&b.tagName!=="P";)b=b.nextElementSibling;return b&&b.tagName==="P"?b:null},w=h=>{if(!h)return!0;let b=new Set(["span","b","strong","i","em","u","s","mark","code"]),S=new Set(["img","video","audio","iframe"]),k=A=>{if(!A)return!1;if(A.nodeType===Node.TEXT_NODE)return(A.textContent||"").replace(/\u00a0/g,"").replace(/[\u200B-\u200D\uFEFF]/g,"").trim().length>0;if(A.nodeType!==Node.ELEMENT_NODE)return!1;let v=(A.tagName||"").toLowerCase();return v==="br"?!1:S.has(v)?!0:v==="span"&&(A.getAttribute("class")||"").includes("resizable-image__handle")?!1:b.has(v)?Array.from(A.childNodes||[]).some(k):!0};return!Array.from(h.childNodes||[]).some(k)},g=h=>{if(!h)return!1;let b=document.createRange();b.selectNodeContents(h);try{b.setEnd(n.startContainer,n.startOffset)}catch{return!1}if(w(b.cloneContents()))return!0;try{let S=document.createRange();return S.selectNodeContents(h),S.collapse(!0),n.compareBoundaryPoints(Range.START_TO_START,S)===0}catch{return!1}},f=h=>{if(!h)return!1;let b=document.createRange();b.selectNodeContents(h);try{b.setStart(n.startContainer,n.startOffset)}catch{return!1}if(w(b.cloneContents()))return!0;try{let S=document.createRange();return S.selectNodeContents(h),S.collapse(!1),n.compareBoundaryPoints(Range.END_TO_END,S)===0}catch{return!1}};if(window.__debugMergeP&&i("mergeP.keydown",{key:e.key,code:e.code,keyCode:e.keyCode,startContainer:n.startContainer?.nodeName,startOffset:n.startOffset,collapsed:n.collapsed}),s){if(n.startContainer===t){let k=u();if(k.prev&&k.next){e.preventDefault(),e.stopPropagation();let A=document.createRange();for(A.selectNodeContents(k.prev),A.collapse(!1);k.next.firstChild;)k.prev.appendChild(k.next.firstChild);return k.next.remove(),l(A),o(t),!0}return!1}let h=d("Backspace");if(!h||!t.contains(h)||!g(h))return!1;let b=m(h);if(!b||!t.contains(b))return!1;e.preventDefault(),e.stopPropagation();let S=document.createRange();for(S.selectNodeContents(b),S.collapse(!1);h.firstChild;)b.appendChild(h.firstChild);return h.remove(),l(S),o(t),!0}if(c){let h=d("Delete");if(!h||!t.contains(h)){let k=u();if(k.prev&&k.next){e.preventDefault(),e.stopPropagation();let A=document.createRange();for(A.selectNodeContents(k.prev),A.collapse(!1);k.next.firstChild;)k.prev.appendChild(k.next.firstChild);return k.next.remove(),l(A),o(t),!0}return!1}if(!f(h))return!1;let b=y(h);if(!b||!t.contains(b))return!1;e.preventDefault(),e.stopPropagation();let S=document.createRange();for(S.selectNodeContents(h),S.collapse(!1);b.firstChild;)h.appendChild(b.firstChild);return b.remove(),l(S),o(t),!0}return!1}var Fc=Ke(()=>{});function Ii(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=r=>{if(r&&!(r.nodeType===Node.ELEMENT_NODE&&r.tagName==="A")){if(r.nodeType===Node.TEXT_NODE){let o=r.textContent||"";if(Os.lastIndex=0,!Os.test(o))return;let s=document.createDocumentFragment(),c=0;Os.lastIndex=0;let l;for(;(l=Os.exec(o))!==null;){let[d]=l;l.index>c&&s.appendChild(document.createTextNode(o.slice(c,l.index)));let u=d.startsWith("http")?d:`https://${d}`,m=document.createElement("a");m.href=u,m.target="_blank",m.rel="noopener noreferrer",m.textContent=d,s.appendChild(m),c=l.index+d.length}c<o.length&&s.appendChild(document.createTextNode(o.slice(c))),r.parentNode&&r.parentNode.replaceChild(s,r);return}Array.from(r.childNodes||[]).forEach(n)}};return Array.from(t.content.childNodes).forEach(n),t.innerHTML}function If(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll("script, style").forEach(o=>o.remove());let n=(o="")=>/^javascript:/i.test(o.trim()),r=o=>{if(!o||o.nodeType!==Node.ELEMENT_NODE){Array.from(o?.childNodes||[]).forEach(r);return}Array.from(o.attributes||[]).forEach(i=>{let s=i.name.toLowerCase(),c=i.value||"";if(s.startsWith("on")||s==="style"){o.removeAttribute(i.name);return}(s==="href"||s==="src")&&n(c)&&o.removeAttribute(i.name)}),Array.from(o.childNodes||[]).forEach(r)};return Array.from(t.content.childNodes||[]).forEach(r),t.innerHTML}function Rs(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=r=>{if(!r)return!0;if(r.nodeType===Node.TEXT_NODE)return!(r.textContent||"").replace(/\u00a0/g,"").trim();if(r.nodeType!==Node.ELEMENT_NODE)return!1;if(r.tagName==="BR")return!0;let o=(r.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&nbsp;/gi,"").trim(),i=(r.textContent||"").replace(/\u00a0/g,"").trim(),s=!!r.querySelector("img,video,audio,iframe");return!o&&!i&&!s};for(;t.content.firstChild&&n(t.content.firstChild);)t.content.removeChild(t.content.firstChild);for(;t.content.lastChild&&n(t.content.lastChild);)t.content.removeChild(t.content.lastChild);return t.innerHTML}function Ef(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=(t.content.textContent||"").replace(/\u00a0/g," ").trim(),r=!!t.content.querySelector("a"),o=!1;{let g=Array.from(t.content.childNodes||[]);for(let f=0;f<g.length;f+=1){let h=g[f];if(h.nodeType===Node.TEXT_NODE){if(!(h.textContent||"").trim())continue;break}Ur(h)&&(o=!0);break}}let i=document.createElement("template");i.innerHTML=e||"",i.content.querySelectorAll("img").forEach(g=>{let f=String(g.getAttribute("src")||"").trim();if(!/^(blob:|filesystem:)/i.test(f))return;let h=String(g.getAttribute("alt")||"").trim()||"image",b=g.closest?.(".resizable-image")||g;try{b.replaceWith(document.createTextNode(`[${h} \u2014 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0431\u044B\u043B\u043E blob: \u0438 \u043D\u0435 \u0431\u044B\u043B\u043E \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E]`))}catch{}});let c=(()=>{if(!Array.from(i.content.childNodes||[]).length)return!1;let f=Array.from(i.content.querySelectorAll("p"));if(f.length<2)return!1;let h=te=>{let he=te.trim();return he.startsWith("|")&&he.indexOf("|",1)!==-1},S=f.map(te=>(te.textContent||"").replace(/\u00a0/g," ").trim()).filter(te=>te);if(S.length<2||!S.every(h))return!1;let k=S.map(te=>{let he=te.trim();return(he.endsWith("|")?he.slice(1,-1):he.slice(1)).split("|").map(vt=>vt.trim())}),A=k[0],v=k.slice(1),B=v.reduce((te,he)=>Math.max(te,he.length),A.length),H=document.createElement("table");H.className="memus-table";let O=document.createElement("colgroup"),W=100/Math.max(B,1);for(let te=0;te<B;te+=1){let he=document.createElement("col");he.setAttribute("width",`${W.toFixed(4)}%`),O.appendChild(he)}H.appendChild(O);let J=document.createElement("thead"),ne=document.createElement("tr");for(let te=0;te<B;te+=1){let he=document.createElement("th");he.textContent=A[te]||"",ne.appendChild(he)}J.appendChild(ne),H.appendChild(J);let me=document.createElement("tbody");return v.forEach(te=>{let he=document.createElement("tr"),Je=[...te];for(let vt=0;vt<B;vt+=1){let Mt=document.createElement("td");Mt.textContent=Je[vt]||"",he.appendChild(Mt)}me.appendChild(he)}),H.appendChild(me),i.content.innerHTML="",i.content.appendChild(H),Ii(i.innerHTML).replace(/<\/a>\s*<a/gi,"</a> <a")})();if(c)return c;i.content.querySelectorAll(".table-toolbar, .table-toolbar-btn").forEach(g=>{g.remove()}),i.content.querySelectorAll(".block-header").forEach(g=>{let f=g.parentNode;if(f){for(;g.firstChild;)f.insertBefore(g.firstChild,g);f.removeChild(g)}});let l=g=>{Array.from(g.childNodes).forEach(f=>{if(f.nodeType===Node.ELEMENT_NODE){if(f.tagName==="DIV"){let h=document.createElement("p");h.innerHTML=f.innerHTML,f.parentNode.replaceChild(h,f),l(h);return}l(f)}})};l(i.content),(g=>{Array.from(g.childNodes||[]).forEach(h=>{if(h.nodeType===Node.TEXT_NODE){let S=(h.textContent||"").replace(/\u00a0/g," ");if(!S.trim()){if(h.previousSibling&&h.nextSibling){h.textContent=" ";return}g.removeChild(h);return}let A=document.createElement("p");A.textContent=S,g.replaceChild(A,h)}})})(i.content),i.content.querySelectorAll("p").forEach(g=>{(g.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim()||(g.innerHTML="",g.appendChild(document.createElement("br")))});let u=i.content;if(!!u.querySelector("p")){if(o){let g=Array.from(u.childNodes||[]),f=null;for(let h=0;h<g.length;h+=1){let b=g[h];if(!(b.nodeType===Node.TEXT_NODE&&!(b.textContent||"").trim())){f=b;break}}if(f){if(!(f.tagName==="P"&&Ur(f))){let h=document.createElement("p");h.appendChild(document.createElement("br")),u.insertBefore(h,f)}}else{let h=document.createElement("p");h.appendChild(document.createElement("br")),u.appendChild(h)}}}else{let g=document.createElement("p");g.appendChild(document.createElement("br")),u.appendChild(g)}let w=Ii(i.innerHTML).replace(/<\/a>\s*<a/gi,"</a> <a");return!w.trim()&&(n||r)?e||"":w}var Os,vf=Ke(()=>{Fc();Os=/((?:https?:\/\/|www\.)[^\s<>"']+)/gi});function Vr(e){if(!e)return;if(!(e.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&nbsp;/gi,"").trim()){e.innerHTML="";let n=document.createRange();n.selectNodeContents(e),n.collapse(!0);let r=window.getSelection();r&&(r.removeAllRanges(),r.addRange(n))}}var zc=Ke(()=>{});function io(e){if(!e)return!1;if(e.type&&e.type.startsWith("image/"))return!0;let t=(e.name||"").toLowerCase();return t?/\.(png|jpe?g|gif|webp|bmp|svg|heic|heif)$/i.test(t):!1}function Uc(e=[],t=[]){let n=[];return Array.from(e||[]).forEach(r=>{if(r.kind==="file"){let o=typeof r.getAsFile=="function"?r.getAsFile():null;o&&io(o)&&n.push(o)}}),!n.length&&t?.length&&Array.from(t).forEach(r=>{io(r)&&n.push(r)}),n}function Vc(e=[],t=[]){let n=[];return Array.from(e||[]).forEach(r=>{if(r.kind==="file"){let o=typeof r.getAsFile=="function"?r.getAsFile():null;o&&!io(o)&&n.push(o)}}),!n.length&&t?.length&&Array.from(t).forEach(r=>{io(r)||n.push(r)}),n}async function Hs(e,t,n){let r=`img-${Date.now()}-${Math.random().toString(16).slice(2)}`,o=t&&t.name?t.name:"image",i=gt(o).replace(/"/g,"&quot;");try{Vr(e),ir(e,`<span data-pending-image="true" data-image-token="${r}">${i} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F...)</span>`)}catch{}try{let{url:s}=await si(t),l=`
      <span class="resizable-image" style="width:320px;max-width:100%;">
        <span class="resizable-image__inner">${`<img src="${s}" alt="${i}" draggable="false" />`}</span>
        <span class="resizable-image__handle" data-direction="e" aria-hidden="true"></span>
      </span>
    `,d=e,u=d&&d.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`);if(n&&(!u||!d.isConnected)){let m=document.querySelector(`.block[data-block-id="${n}"]`);if(m){let w=m.querySelector('.block-text[contenteditable="true"]')||m.querySelector(".block-text.block-body");w&&(d=w,u=d.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`))}}u?(u.removeAttribute("data-pending-image"),u.removeAttribute("data-image-token"),u.outerHTML=l):d&&(Vr(d),ir(d,l))}catch(s){try{let l=e;if(n&&!l.isConnected){let d=document.querySelector(`.block[data-block-id="${n}"]`);if(d){let m=d.querySelector('.block-text[contenteditable="true"]')||d.querySelector(".block-text.block-body");m&&(l=m)}}if(l){let d=l.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`);d&&(d.textContent=`${o} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F)`,d.removeAttribute("data-pending-image"))}}catch{}try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"insertImageFromFileError",data:{message:s&&s.message?String(s.message):String(s),name:t&&t.name,type:t&&t.type,size:t&&t.size}})}).catch(()=>{})}catch{}try{let l={where:"insertImageFromFile",message:s&&s.message?String(s.message):String(s),status:typeof s?.status=="number"?s.status:null,name:t&&t.name,type:t&&t.type,size:t&&t.size},d=l.status===null?"null":String(l.status);window.alert(`upload failed (status ${d}):\\n${JSON.stringify(l,null,2)}`)}catch{}let c=String(s?.message||"").toLowerCase();c.includes("status 0")||c.includes("network error")?P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 (\u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C). \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438, \u043F\u0440\u0438 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u043E\u0441\u0442\u0438, \u0432\u043E\u0439\u0434\u0438\u0442\u0435 \u0437\u0430\u043D\u043E\u0432\u043E."):P(s.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435")}}function Kg(e){if(e.button!==0)return;let t=e.target?.closest(".resizable-image__handle");if(!t)return;let n=t.closest(".resizable-image"),o=n?.closest(".block")?.dataset?.blockId;if(!n||!o||a.mode!=="edit"||a.editingBlockId!==o)return;e.preventDefault(),e.stopPropagation();let i=n.getBoundingClientRect();qr={wrapper:n,startWidth:i.width,startX:e.clientX},n.classList.add("resizable-image--resizing")}function jg(e){if(!qr)return;e.preventDefault();let t=e.clientX-qr.startX,r=parseFloat(getComputedStyle(document.documentElement).fontSize)||16,o=Math.max(r,document.documentElement.clientWidth-32),i=qr.startWidth+t;i=Math.max(r,Math.min(i,o)),qr.wrapper.style.width=`${i}px`}function Cf(){qr&&(qr.wrapper.classList.remove("resizable-image--resizing"),qr=null)}function Bf(){Tf||(Tf=!0,document.addEventListener("pointerdown",Kg),document.addEventListener("pointermove",jg),document.addEventListener("pointerup",Cf),document.addEventListener("pointercancel",Cf))}var qr,Tf,Lf=Ke(()=>{At();Xt();zt();Un();zc();qr=null,Tf=!1});function Mf({listTag:e,resolveTarget:t,restoreSelection:n,richContextRange:r,notifyEditingInput:o,setRichContextRange:i}){let s=t();if(!s||!document.contains(s))return;n();let c=window.getSelection(),l=null;if(r&&s.contains(r.commonAncestorContainer))l=r.cloneRange();else if(c&&c.rangeCount>0){let S=c.getRangeAt(0);s.contains(S.commonAncestorContainer)&&(l=S.cloneRange())}l||(l=document.createRange(),l.selectNodeContents(s),l.collapse(!1));let d=l.startContainer?.nodeType===Node.ELEMENT_NODE?l.startContainer:l.startContainer?.parentElement,u=d?.closest?.("li"),m=u?.closest?.("ol,ul"),y=S=>{if(!S)return;let k=document.createRange();k.selectNodeContents(S),k.collapse(!1),c&&(c.removeAllRanges(),c.addRange(k)),i(k);try{s.focus({preventScroll:!0})}catch{s.focus()}s.classList.remove("block-body--empty"),o(s)},w=S=>{let k=S.parentElement?.tagName==="P"&&S.parentElement.childNodes.length===1?S.parentElement:S,A=Array.from(S.children||[]).filter(H=>H.nodeType===Node.ELEMENT_NODE&&H.tagName==="LI"),v=document.createDocumentFragment(),B=[];A.forEach(H=>{let O=document.createElement("p");for(;H.firstChild;)O.appendChild(H.firstChild);B.push(O),v.appendChild(O)}),k.replaceWith(v),y(B[0]||null)};if(m){if(m.tagName.toLowerCase()===e){w(m);return}let k=document.createElement(e);for(;m.firstChild;)k.appendChild(m.firstChild);m.replaceWith(k),y(u||k.lastElementChild||k);return}let g=()=>{if(!l.collapsed)return null;let S=d?.closest?.("p")||null;if(S&&s.contains(S))return S;if(l.startContainer===s){let k=Array.from(s.childNodes),A=l.startOffset;for(let v=A-1;v>=0;v-=1){let B=k[v];if(B?.nodeType===Node.ELEMENT_NODE&&B.tagName==="P")return B}for(let v=A;v<k.length;v+=1){let B=k[v];if(B?.nodeType===Node.ELEMENT_NODE&&B.tagName==="P")return B}}return null},f=[];if(l.collapsed){let S=g();S&&(f=[S])}else if(f=Array.from(s.querySelectorAll(":scope > p")).filter(k=>{try{return l.intersectsNode(k)}catch{return!1}}),!f.length){let k=d?.closest?.("p");k&&s.contains(k)&&(f=[k])}if(!f.length)return;let h=document.createElement(e);f.forEach(S=>{let k=document.createElement("li");for(;S.firstChild;)k.appendChild(S.firstChild);h.appendChild(k)}),f[0].replaceWith(h),f.slice(1).forEach(S=>S.remove()),y(h.firstElementChild||h)}var Nf=Ke(()=>{});var Hc={};ur(Hc,{applyEditingUndoStep:()=>Po,attachRichContentHandlers:()=>Yc,buildEditableBlockHtml:()=>jc,buildStoredBlockHtml:()=>Oc,cleanupEditableHtml:()=>Ef,clearEditingUndoSession:()=>Gg,countBlocks:()=>Ds,ensureBlockVisible:()=>Gc,expandCollapsedAncestors:()=>Qg,extendSelection:()=>Ai,extractBlockSections:()=>jn,findBlock:()=>Qe,findCollapsibleTarget:()=>$s,findFallbackBlockId:()=>wi,flattenVisible:()=>On,initEditingUndoForElement:()=>Yg,insertFilesIntoEditable:()=>Wc,isSeparatorNode:()=>Ur,moveSelection:()=>ki,setCollapseState:()=>so,setCurrentBlock:()=>Kn,toggleCollapse:()=>Jc});function Of(e=""){return e?e.startsWith("app:/")?`/api/yandex/disk/file?path=${encodeURIComponent(e)}`:e.startsWith("disk:/")?`/api/yandex/disk/file?path=${encodeURIComponent(e)}`:e:""}function Wg(e,t){if(e===t)return!1;if(t.startsWith(e)){let n=t.slice(e.length);if(n.length>0&&n.length<=Jg&&/^[A-Za-zА-Яа-я0-9]+$/.test(n))return!1}return!0}function Yg(e,t){if(!e||!t)return;a.editingUndo={blockId:t,snapshots:[e.innerHTML],index:0,lastText:e.textContent||"",lastSnapshotAt:Date.now()};let n=()=>{let r=a.editingUndo;if(!r||r.blockId!==t)return;let o=e.innerHTML,i=e.textContent||"",{snapshots:s,index:c,lastText:l,lastSnapshotAt:d}=r,u=Date.now();if(!Wg(l||"",i)){r.lastText=i;return}if(s[c]===o){r.lastText=i,r.lastSnapshotAt=u;return}c<s.length-1&&s.splice(c+1),s.push(o),r.index=s.length-1,r.lastText=i,r.lastSnapshotAt=u};e.addEventListener("input",()=>{!a.editingUndo||a.editingUndo.blockId!==t||a.mode!=="edit"||a.editingBlockId!==t||n()})}function Gg(){a.editingUndo=null}function Ei(e){if(e)try{let t=typeof InputEvent=="function"?new InputEvent("input",{bubbles:!0}):new Event("input",{bubbles:!0});e.dispatchEvent(t)}catch{try{let n=document.createEvent("Event");n.initEvent("input",!0,!1),e.dispatchEvent(n)}catch{}}}function Po(e){let t=a.editingUndo;if(!t||!t.blockId||!e||a.mode!=="edit"||a.editingBlockId!==t.blockId)return!1;let n=document.querySelector(`.block[data-block-id="${t.blockId}"] .block-text[contenteditable="true"]`);if(!n)return!1;let r=t.index+e;if(r<0||r>=t.snapshots.length)return!1;t.index=r;let o=t.snapshots[r];n.innerHTML=o;try{n.focus({preventScroll:!0})}catch{n.focus()}try{let i=window.getSelection&&window.getSelection();if(i){let s=document.createRange();s.selectNodeContents(n),s.collapse(!1),i.removeAllRanges(),i.addRange(s)}}catch{}return!0}function jc(e=""){let t=jn(e);if(!t.titleHtml)return e||"";let n=$c(t.titleHtml),r=t.bodyHtml||"";if(r){let i=document.createElement("template");i.innerHTML=r;let s=i.content.firstChild;for(;s&&Ur(s);){let c=s;s=s.nextSibling,i.content.removeChild(c)}r=i.innerHTML}let o=$c(r||"");return`${n}<p><br /></p>${o}`}function Oc(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll(".block-header").forEach(i=>{let s=i.parentNode;if(s){for(;i.firstChild;)s.insertBefore(i.firstChild,i);s.removeChild(i)}});let n=t.innerHTML,r=jn(n);if(!r.titleHtml)return e||"";let o=`<div class="block-header">${r.titleHtml}</div>`;return r.bodyHtml?`${o}<div><br /></div>${r.bodyHtml}`:o}async function Jc(e){let t=Qe(e);t&&so(e,!t.block.collapsed)}async function so(e,t){let n=Qe(e);if(!n||n.block.collapsed===t)return;let r=()=>{let s=document.getElementById("blocksContainer");if(!s)return null;let c=a.currentBlockId;if(!c)return{container:s};let l=s.querySelector(`.block[data-block-id="${c}"]`);if(!l)return{container:s};let d=s.getBoundingClientRect(),u=l.getBoundingClientRect();return{container:s,currentId:c,topOffset:u.top-d.top}},o=s=>{if(!s?.container)return;let{container:c}=s;if(!s.currentId||typeof s.topOffset!="number")return;let l=c.querySelector(`.block[data-block-id="${s.currentId}"]`);if(!l)return;let d=c.getBoundingClientRect(),m=l.getBoundingClientRect().top-d.top;c.scrollTop+=m-s.topOffset},i=r();n.block.collapsed=t,await Lt(e),xi({scrollIntoView:!1}),o(i);try{let s=await He(`/api/articles/${a.articleId}/collapse`,{method:"PATCH",body:JSON.stringify({blockId:e,collapsed:t})});s?.updatedAt&&(a.article.updatedAt=s.updatedAt)}catch(s){n.block.collapsed=!t,await Lt(e),xi({scrollIntoView:!1}),o(i),P(s.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430")}}function $s(e,t){let n=Qe(e);for(;n;){let o=!!jn(n.block.text||"").titleHtml,i=!!n.block.children?.length;if((o||i)&&n.block.collapsed!==t)return n.block.id;if(!n.parent)break;n=Qe(n.parent.id)}return null}async function Qg(e){let t=Qe(e);if(!t)return;let n=(t.ancestors||[]).filter(r=>r.collapsed);for(let r of n)await so(r.id,!1)}function wi(e){let t=Qe(e);if(!t)return null;let n=t.siblings?.[t.index+1];if(n)return n.id;let r=t.siblings?.[t.index-1];return r?r.id:t.parent?t.parent.id:null}function Ds(e=[]){return(e||[]).reduce((t,n)=>t+1+Ds(n.children||[]),0)}async function Kc(e,t,n){if(!a.articleId){P("\u041D\u0435 \u0432\u044B\u0431\u0440\u0430\u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044F \u0434\u043B\u044F \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0444\u0430\u0439\u043B\u0430");return}let r=`att-${Date.now()}-${Math.random().toString(16).slice(2)}`,o=gt(t?.name||"\u0444\u0430\u0439\u043B"),i=t?.name||"\u0444\u0430\u0439\u043B",s="";qt("attachment: uploading to Yandex Disk",{name:t?.name,type:t?.type,size:t?.size,articleId:a.articleId,token:r});try{Vr(e),ir(e,`<a data-pending-attachment="true" data-attachment-token="${r}">${o} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430...)</a>`)}catch{}try{let c=await ls(a.articleId,t,{onProgress:y=>{let w=Math.max(0,Math.min(100,Math.round(y||0)));qt("attachment upload progress",{percent:w,name:t?.name});try{let g=e,f=g.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);if(n&&(!f||!g.isConnected)){let h=document.querySelector(`.block[data-block-id="${n}"]`);if(h){let S=h.querySelector('.block-text[contenteditable="true"]')||h.querySelector(".block-text.block-body");S&&(g=S,f=g.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`))}}if(f){let h=w>=100?`${i} (\u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0430...)`:`${i} (${w}%)`;h!==s&&(s=h,f.textContent=h)}}catch{}}}),l=gt(c.originalName||t.name||"\u0444\u0430\u0439\u043B"),d=c.storedPath||c.url||"",u=Of(d),m=gt(u);if(m){let y=e,w=y.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);if(n&&(!w||!y.isConnected)){let g=document.querySelector(`.block[data-block-id="${n}"]`);if(g){let h=g.querySelector('.block-text[contenteditable="true"]')||g.querySelector(".block-text.block-body");h&&(y=h,w=y.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`))}}w?(w.removeAttribute("data-pending-attachment"),w.removeAttribute("data-attachment-token"),w.setAttribute("href",m),w.setAttribute("target","_blank"),w.setAttribute("rel","noopener noreferrer"),w.textContent=l):(Vr(y),ir(y,`<a href="${m}" target="_blank" rel="noopener noreferrer">${l}</a>`))}}catch(c){try{let d=e;if(n&&!d.isConnected){let m=document.querySelector(`.block[data-block-id="${n}"]`);if(m){let w=m.querySelector('.block-text[contenteditable="true"]')||m.querySelector(".block-text.block-body");w&&(d=w)}}let u=d.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);u&&(u.textContent=`${o} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`)}catch{}let l=String(c?.message||"").toLowerCase();l.includes("status 0")||l.includes("network error")?P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B (\u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C). \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438, \u043F\u0440\u0438 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u043E\u0441\u0442\u0438, \u0432\u043E\u0439\u0434\u0438\u0442\u0435 \u0437\u0430\u043D\u043E\u0432\u043E."):P(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u043D\u0430 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A")}}function Wc(e,t=[],n){if(!e||!t||!t.length)return;let r=Array.from(t),o=r.filter(s=>io(s)),i=r.filter(s=>s&&!io(s));o.forEach(s=>Hs(e,s,n)),i.forEach(s=>Kc(e,s,n))}function Yc(e,t){_f(e,t);let n=e.closest(".block-content");n&&n!==e&&_f(n,t,e),e.addEventListener("paste",r=>{if(a.mode!=="edit"||a.editingBlockId!==t)return;let o=Uc(r.clipboardData?.items),i=Vc(r.clipboardData?.items);if(o.length>0)r.preventDefault(),o.forEach(s=>Hs(e,s,t));else if(i.length>0)r.preventDefault(),qt("paste: non-image files detected",i.map(s=>({name:s.name,type:s.type,size:s.size}))),i.forEach(s=>Kc(e,s,t));else{r.preventDefault();let s=y=>{let w=String(y||"").trim();if(!w)return"";let g=document.createElement("template");g.innerHTML=w;let f=g.content.querySelector("body");return((f?f.innerHTML:g.innerHTML)||"").replace(/<!--\s*StartFragment\s*-->/gi,"").replace(/<!--\s*EndFragment\s*-->/gi,"").trim()},c=y=>{let w=String(y||"").trim();if(!w)return"";if(/<\s*(table|ul|ol)\b/i.test(w)||!/<\s*(p|div|h[1-6])\b/i.test(w))return w;let g=document.createElement("template");g.innerHTML=w,(k=>{g.content.querySelectorAll(k).forEach(A=>{let v=A.parentNode;if(v){for(;A.firstChild;)v.insertBefore(A.firstChild,A);v.removeChild(A)}})})("ms-cmark-node");let h=[],b=k=>{let A=String(k||"").replace(/^\s*(<br\s*\/?>\s*)+/gi,"").replace(/(\s*<br\s*\/?>\s*)+$/gi,"").trim();A&&h.push(A)},S=Array.from(g.content.childNodes||[]);for(let k of S){if(!k)continue;if(k.nodeType===Node.TEXT_NODE){let v=(k.textContent||"").replace(/\u00a0/g," ").trim();v&&b(gt(v));continue}if(k.nodeType!==Node.ELEMENT_NODE)continue;let A=(k.tagName||"").toUpperCase();if(/^H[1-6]$/.test(A)){b(`<strong>${k.innerHTML||""}</strong>`);continue}if(A==="P"||A==="DIV"||A==="LI"||A==="BLOCKQUOTE"){b(k.innerHTML||"");continue}if(A==="BR"){b("<br />");continue}b(k.outerHTML||k.innerHTML||"")}return h.length?h.join("<br /><br />"):""},l=y=>{Vr(e);try{e.focus({preventScroll:!0})}catch{e.focus()}try{if(typeof document.execCommand=="function"&&document.execCommand("insertHTML",!1,y))return!0}catch{}return ir(e,y),!0},d=y=>{let w=s(y);if(!w)return!1;let f=(A=>{let v=document.createElement("template");v.innerHTML=String(A||"");let B=!1;return v.content.querySelectorAll("img").forEach(H=>{let O=String(H.getAttribute("src")||"").trim();if(!/^(blob:|filesystem:)/i.test(O))return;B=!0;let W=String(H.getAttribute("alt")||"").trim()||"image",J=H.closest?.(".resizable-image")||H;try{J.replaceWith(document.createTextNode(`[${W} \u2014 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0438\u0437 \u0431\u0443\u0444\u0435\u0440\u0430 \u043E\u0431\u043C\u0435\u043D\u0430 (blob:) \u043D\u0435 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E]`))}catch{}}),{html:v.innerHTML,hadUnstable:B}})(w);f.hadUnstable&&P("\u041A\u0430\u0440\u0442\u0438\u043D\u043A\u0430 \u0431\u044B\u043B\u0430 \u0432\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u0430 \u043A\u0430\u043A blob: URL \u0438 \u043D\u0435 \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u0441\u044F \u043F\u043E\u0441\u043B\u0435 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438. \u0412\u0441\u0442\u0430\u0432\u044C\u0442\u0435 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u043A\u0430\u043A \u0444\u0430\u0439\u043B (\u043F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435/\u0432\u0441\u0442\u0430\u0432\u044C\u0442\u0435 \u0444\u0430\u0439\u043B \u0438\u043B\u0438 \u0441\u043A\u0440\u0438\u043D\u0448\u043E\u0442).");let h=If(f.html),b=c(h);if(!b)return!1;let S=Rs(h),k=Rs(b)||S;return l(Ii(k)),Ei(e),!0},u=y=>{let w=String(y||""),g=w.trim();if(/^https?:\/\/\S+$/i.test(g)){let k=gt(g);return Vr(e),ir(e,`<a href="${k}" target="_blank" rel="noopener noreferrer">${k}</a>`),Ei(e),!0}let h=w.replace(/\r\n/g,`
`).replace(/\r/g,`
`),b=gt(h).replace(/\n{2,}/g,"<br /><br />").replace(/\n/g,"<br />"),S=Ii(Rs(b));return l(S),Ei(e),!0},m=(r.clipboardData?.getData("text/html")||"").trim();if(m&&d(m))return;try{let w=Array.from(r.clipboardData?.items||[]).find(g=>g&&g.kind==="string"&&g.type==="text/html");if(w&&typeof w.getAsString=="function"){w.getAsString(g=>{try{if(d(g))return}catch{}try{let f=r.clipboardData?.getData("text/plain")||"";u(f)}catch{}});return}}catch{}{let y=r.clipboardData?.getData("text/plain")||"";u(y)}}}),e.addEventListener("drop",r=>{if(a.mode!=="edit"||a.editingBlockId!==t){qt("drop ignored",{mode:a.mode,editingBlockId:a.editingBlockId,targetBlockId:t});return}let o=Array.from(r.dataTransfer?.files||[]);if(!o.length)return;let i=o.filter(c=>c.type?.startsWith("image/")),s=o.filter(c=>!c.type||!c.type.startsWith("image/"));!i.length&&!s.length||(r.preventDefault(),qt("drop: files detected",o.map(c=>({name:c.name,type:c.type,size:c.size}))),i.forEach(c=>Hs(e,c,t)),s.forEach(c=>Kc(e,c,t)))}),e.addEventListener("click",r=>{let o=r.target?.closest("img");if(o){if(r.target?.closest(".resizable-image__handle")){r.preventDefault();return}r.preventDefault(),ci(o.src,o.alt||"");return}let i=r.target?.closest("a[href]");if(!i)return;let s=i.getAttribute("href")||"";if(!s.startsWith("app:/")&&!s.startsWith("disk:/"))return;r.preventDefault();let c=Of(s);c&&window.open(c,"_blank","noopener,noreferrer")}),a.articleId==="inbox"&&e.addEventListener("click",async r=>{if(r.target?.closest(".move-block-btn")){r.preventDefault(),r.stopPropagation();try{let s=(a.articlesIndex.length?a.articlesIndex:await zn()).filter(u=>u.id!=="inbox").map(u=>({id:u.id,title:u.title||"\u0420\u2018\u0420\xB5\u0420\xB7 \u0420\u0405\u0420\xB0\u0420\xB7\u0420\u0406\u0420\xB0\u0420\u0405\u0420\u0451\u0421\u040F"})),c=await xn({title:"\u0420\u045F\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451 \u0420\u0406 \u0421\u0403\u0421\u201A\u0420\xB0\u0421\u201A\u0421\u040A\u0421\u040B",message:"\u0420\u2019\u0420\u0406\u0420\xB5\u0420\u0491\u0420\u0451\u0421\u201A\u0420\xB5 ID \u0420\u0451\u0420\xBB\u0420\u0451 \u0420\u0406\u0421\u2039\u0420\xB1\u0420\xB5\u0421\u0402\u0420\u0451\u0421\u201A\u0420\xB5 \u0421\u0403\u0421\u201A\u0420\xB0\u0421\u201A\u0421\u040A\u0421\u040B",confirmText:"\u0420\u045F\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451",cancelText:"\u0420\u045B\u0421\u201A\u0420\u0458\u0420\xB5\u0420\u0405\u0420\xB0",suggestions:s,returnMeta:!0,hideConfirm:!1}),d=(c?.selectedId||(typeof c=="object"?c?.value:c)||""||"").trim();if(!d)return;await He(`/api/articles/${a.articleId}/blocks/${t}/move-to/${d}`,{method:"POST"}),It(wt.article("inbox"))}catch(i){P(i.message||"\u0420\u045C\u0420\xB5 \u0421\u0453\u0420\u0491\u0420\xB0\u0420\xBB\u0420\u0455\u0421\u0403\u0421\u040A \u0420\u0457\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451 \u0420\xB1\u0420\xBB\u0420\u0455\u0420\u0454")}}}),e.addEventListener("dragover",r=>{if(a.mode!=="edit"||a.editingBlockId!==t)return;(Uc(r.dataTransfer?.items).length>0||Vc(r.dataTransfer?.items).length>0)&&r.preventDefault()}),e.addEventListener("keydown",r=>{if(a.mode!=="edit"||a.editingBlockId!==t)return;let o=window.getSelection();if(!o||o.rangeCount===0)return;let i=o.getRangeAt(0);if(!i||!i.collapsed||Af({event:r,element:e,range:i,selection:o,notifyEditingInput:Ei,logDebug:qt})||r.key!=="Tab"||!(i.commonAncestorContainer?.nodeType===Node.ELEMENT_NODE?i.commonAncestorContainer:i.commonAncestorContainer?.parentElement)?.closest?.("li"))return;r.preventDefault(),r.stopPropagation();let l=r.shiftKey?"outdent":"indent";document.execCommand(l,!1,null)})}function Rf(){let e=window.getSelection();if(!e||e.rangeCount===0)return;let t=e.getRangeAt(0),n=t.commonAncestorContainer,o=(n?.nodeType===Node.ELEMENT_NODE?n:n?.parentElement)?.closest('.block-text[contenteditable="true"]');if(!o){Ti=null;return}let s=o.closest(".block")?.dataset?.blockId;if(a.mode!=="edit"||a.editingBlockId!==s){Ti=null;return}Ti=t.cloneRange()}function Xg(){if(qc)return qc;Pf||(document.addEventListener("selectionchange",Rf),Pf=!0);let e=document.createElement("div");e.className="rich-context-menu hidden",e.innerHTML=`
	    <div class="rich-context-menu__col rich-context-menu__col--buffer">
	      <div class="rich-context-menu__grid">
	        <button class="rich-context-menu__icon-btn" data-action="copy" aria-label="\u041A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C" title="\u041A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C"><i class="bx bx-copy" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="cut" aria-label="\u0412\u044B\u0440\u0435\u0437\u0430\u0442\u044C" title="\u0412\u044B\u0440\u0435\u0437\u0430\u0442\u044C"><i class="bx bx-cut" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="paste" aria-label="\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C" title="\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C"><i class="bx bx-paste" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="select-all" aria-label="\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0432\u0441\u0451" title="\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0432\u0441\u0451"><i class="bx bx-select-multiple" aria-hidden="true"></i></button>
	      </div>
	    </div>
	    <div class="rich-context-menu__col">
	      <div class="rich-context-menu__grid">
	        <button class="rich-context-menu__icon-btn" data-action="bold" aria-label="\u041F\u043E\u043B\u0443\u0436\u0438\u0440\u043D\u044B\u0439" title="\u041F\u043E\u043B\u0443\u0436\u0438\u0440\u043D\u044B\u0439"><strong>\u0416</strong></button>
	        <button class="rich-context-menu__icon-btn" data-action="italic" aria-label="\u041A\u0443\u0440\u0441\u0438\u0432" title="\u041A\u0443\u0440\u0441\u0438\u0432"><em>/</em></button>
	        <button class="rich-context-menu__icon-btn" data-action="underline" aria-label="\u041F\u043E\u0434\u0447\u0435\u0440\u043A\u043D\u0443\u0442\u044C" title="\u041F\u043E\u0434\u0447\u0435\u0440\u043A\u043D\u0443\u0442\u044C"><u>\u0427</u></button>
	        <button class="rich-context-menu__icon-btn" data-action="remove-format" aria-label="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0444\u043E\u0440\u043C\u0430\u0442" title="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0444\u043E\u0440\u043C\u0430\u0442"><i class="bx bx-eraser" aria-hidden="true"></i></button>
	      </div>
	    </div>
	    <div class="rich-context-menu__col">
	      <div class="rich-context-menu__grid">
	        <button class="rich-context-menu__icon-btn" data-action="ul" aria-label="\u041C\u0430\u0440\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A" title="\u041C\u0430\u0440\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A"><i class="bx bx-list-ul" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="ol" aria-label="\u041D\u0443\u043C\u0435\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A" title="\u041D\u0443\u043C\u0435\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A"><i class="bx bx-list-ol" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="quote" aria-label="\u0426\u0438\u0442\u0430\u0442\u0430" title="\u0426\u0438\u0442\u0430\u0442\u0430"><i class="bx bx-quote-left" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="code" aria-label="\u041A\u043E\u0434" title="\u041A\u043E\u0434"><i class="bx bx-code-alt" aria-hidden="true"></i></button>
	      </div>
	    </div>
	    <div class="rich-context-menu__col">
	      <div class="rich-context-menu__grid">
	        <button class="rich-context-menu__icon-btn" data-action="link" aria-label="\u0421\u0441\u044B\u043B\u043A\u0430" title="\u0421\u0441\u044B\u043B\u043A\u0430"><i class="bx bx-link" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="unlink" aria-label="\u0423\u0431\u0440\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443" title="\u0423\u0431\u0440\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443"><i class="bx bx-unlink" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="insert-article-link" aria-label="\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E" title="\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E"><i class="bx bx-link-alt" aria-hidden="true"></i></button>
	      </div>
	    </div>
	    <div class="rich-context-menu__col">
	      <div class="rich-context-menu__grid">
	        <button class="rich-context-menu__icon-btn" data-action="split-at-caret" aria-label="\u0420\u0430\u0437\u0434\u0435\u043B\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043F\u043E \u043A\u0443\u0440\u0441\u043E\u0440\u0443" title="\u0420\u0430\u0437\u0434\u0435\u043B\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043F\u043E \u043A\u0443\u0440\u0441\u043E\u0440\u0443"><i class="bx bx-cut" aria-hidden="true"></i></button>
	      </div>
	    </div>
	  `,document.body.appendChild(e);let t=()=>{e.classList.add("hidden"),e.style.visibility="",Zt=null,No=null,vi=null},n=()=>{if(Zt){let o=window.getSelection();o.removeAllRanges(),o.addRange(Zt)}},r=async o=>{n();let i=()=>{if(No&&document.contains(No))return No;let y=window.getSelection()?.anchorNode?.parentElement?.closest(".block-text[contenteditable]");if(y)return y;if(Zt){let g=Zt.commonAncestorContainer;if(g?.parentElement){let f=g.parentElement.closest(".block-text[contenteditable]");if(f)return f}}if(vi&&document.contains(vi))return vi;if(a.editingBlockId){let g=document.querySelector(`.block[data-block-id="${a.editingBlockId}"] .block-text[contenteditable="true"]`);if(g)return g}let w=document.activeElement;if(w&&w.closest){let g=w.closest(".block-text[contenteditable]");if(g)return g}return null},s=u=>{Mf({listTag:u,resolveTarget:i,restoreSelection:n,richContextRange:Zt,notifyEditingInput:Ei,setRichContextRange:m=>{Zt=m?m.cloneRange():null}})},c=async()=>{let u=i();if(!u){P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0441\u0441\u044B\u043B\u043A\u0438");return}let m=a.articlesIndex.length?a.articlesIndex:await zn(),y=m.map(k=>({id:k.id,title:k.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),w="",g="";try{let k=await xn({title:"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438. \u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0438 \u043F\u043E\u043C\u043E\u0433\u0443\u0442 \u043D\u0430\u0439\u0442\u0438 \u043D\u0443\u0436\u043D\u0443\u044E.",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:y,returnMeta:!0,hideConfirm:!0});k&&typeof k=="object"?(w=k.value||"",g=k.selectedId||""):w=k||""}catch{w=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438")||""}let f=(w||"").trim().toLowerCase();if(!f&&!g)return;let h=m.find(k=>{let A=(k.title||"").toLowerCase();return g&&k.id===g||k.id&&k.id.toLowerCase()===f||A===f||A.includes(f)});if(!h){P("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}if(!u||!document.contains(u)){P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0441\u0441\u044B\u043B\u043A\u0438");return}n(),u.focus();let b=`<a href="${wt.article(h.id)}" class="article-link" data-article-id="${h.id}">${gt(h.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F")}</a>`;ir(u,b);let S=(u.innerHTML||"").trim();(!S||S==="<br>"||S==="<br/>"||S==="<br />")&&(u.innerHTML=b),u.classList.remove("block-body--empty")},l=()=>{n();let u=window.getSelection();if(!(!u||u.rangeCount===0)){document.execCommand("removeFormat");for(let m=0;m<4;m+=1)document.execCommand("outdent");document.execCommand("formatBlock",!1,"p")}},d=u=>{let m=i();if(!m||!document.contains(m))return P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u0442\u0435\u043A\u0441\u0442 \u0434\u043B\u044F \u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F"),null;let y=window.getSelection();if(!y||y.rangeCount===0)return null;let w=y.getRangeAt(0).cloneRange();if(!w||w.collapsed)return null;let g=w.cloneContents(),f=document.createElement("div");f.appendChild(g);let h=f.innerHTML||"",b=f.textContent||"",k=m.closest(".block")?.dataset.blockId||null;return Mo={html:h,text:b,sourceBlockId:k},qt("clipboard.capture",{kind:u,hasHtml:!!h,length:b.length,blockId:k}),{range:w,target:m}};switch(o){case"cut":{if(!d("cut"))break;document.execCommand("cut");break}case"copy":d("copy"),document.execCommand("copy");break;case"select-all":{let u=i();if(!u||!document.contains(u))break;let m=document.createRange();m.selectNodeContents(u);let y=window.getSelection();y&&(y.removeAllRanges(),y.addRange(m)),Zt=m.cloneRange();break}case"paste":{let u=i();if(!u||!document.contains(u)){P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438");break}if(!Mo||!Mo.html&&!Mo.text){P("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0441\u043A\u043E\u043F\u0438\u0440\u0443\u0439\u0442\u0435 \u0438\u043B\u0438 \u0432\u044B\u0440\u0435\u0436\u044C\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u0432 \u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440\u0435");break}n();let m=window.getSelection(),y=null;if(Zt&&u.contains(Zt.commonAncestorContainer))y=Zt.cloneRange();else if(m&&m.rangeCount>0){let h=m.getRangeAt(0);u.contains(h.commonAncestorContainer)&&(y=h.cloneRange())}y||(y=document.createRange(),y.selectNodeContents(u),y.collapse(!1));let w=Mo.html||gt(Mo.text).replace(/\n/g,"<br />"),g=document.createElement("div");g.innerHTML=w;let f=document.createDocumentFragment();for(;g.firstChild;)f.appendChild(g.firstChild);y.deleteContents(),y.insertNode(f),y.collapse(!1),m&&(m.removeAllRanges(),m.addRange(y)),u.focus({preventScroll:!0}),u.classList.remove("block-body--empty");break}case"bold":document.execCommand("bold");break;case"italic":document.execCommand("italic");break;case"underline":document.execCommand("underline");break;case"ul":s("ul");break;case"ol":s("ol");break;case"quote":document.execCommand("formatBlock",!1,"blockquote");break;case"code":document.execCommand("formatBlock",!1,"pre");break;case"link":{let u=window.getSelection(),m=u?u.toString():"",y=u?.anchorNode,w=y?y.parentElement?.closest("a"):null,g=w?.getAttribute("href")||"",f=await pc({title:"\u0421\u0441\u044B\u043B\u043A\u0430",textLabel:"\u0422\u0435\u043A\u0441\u0442",urlLabel:"\u0421\u0441\u044B\u043B\u043A\u0430",defaultText:m||w?.textContent||"",defaultUrl:g,confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"});if(qt("link action: prompt result",{hasResult:!!f,url:f?.url,text:f?.text}),!f||!f.url)break;let h=f.url.match(/^[a-z]+:/i)?f.url:`https://${f.url}`,b=f.text?.trim()||h;n();let S=i();if(qt("link action: target",{targetExists:!!S,inDom:!!(S&&document.contains(S)),className:S?.className}),!S||!document.contains(S))break;let k=window.getSelection(),A=null;Zt&&S.contains(Zt.commonAncestorContainer)?A=Zt.cloneRange():k&&k.rangeCount>0&&S.contains(k.getRangeAt(0).commonAncestorContainer)&&(A=k.getRangeAt(0).cloneRange()),A||(A=document.createRange(),A.selectNodeContents(S),A.collapse(!1)),qt("link action: range chosen",{usedSelectionRange:!!(k&&k.rangeCount>0&&S.contains(k.getRangeAt(0).commonAncestorContainer)),usedStoredRange:!!(Zt&&S.contains(Zt.commonAncestorContainer)),selectionRangeCollapsed:!!(k&&k.rangeCount>0&&k.getRangeAt(0).collapsed),rangeStartNode:A?.startContainer?.nodeName,rangeOffset:A?.startOffset,labelLength:(b||"").length,url:h});let v=document.createElement("a");v.href=h,v.target="_blank",v.rel="noopener noreferrer",v.textContent=b,A.deleteContents(),A.insertNode(v),A.setStartAfter(v),A.setEndAfter(v),qt("link action: inserted link",{outerHTML:v.outerHTML,parentClass:v.parentElement?.className,targetInner:S.innerHTML.slice(0,120)}),k&&(k.removeAllRanges(),k.addRange(A)),S.focus({preventScroll:!0}),S.classList.remove("block-body--empty");break}case"unlink":{let u=i();if(qt("unlink action: target",{targetExists:!!u,inDom:!!(u&&document.contains(u)),className:u?.className}),!u||!document.contains(u))break;let m=window.getSelection(),y=null;if(m&&m.rangeCount>0){let w=m.getRangeAt(0).commonAncestorContainer;y=w?.parentElement?.closest("a")||w?.closest?.("a")}if(!y&&Zt){let w=Zt.commonAncestorContainer;y=w?.parentElement?.closest("a")||w?.closest?.("a")}if(y||(y=u.querySelector("a")),y){let w=document.createTextNode(y.textContent||"");y.replaceWith(w)}else document.execCommand("unlink");break}case"remove-format":l();break;case"insert-article-link":c().finally(()=>{t()});return;case"split-at-caret":await Co();break;default:break}t()};return e.addEventListener("click",o=>{let i=o.target.closest("button[data-action]");if(!i)return;let s=i.dataset.action;r(s)}),document.addEventListener("click",o=>{e.classList.contains("hidden")||e.contains(o.target)||t()}),document.addEventListener("touchstart",o=>{e.classList.contains("hidden")||e.contains(o.target)||t()},{passive:!0}),document.addEventListener("keydown",o=>{o.code==="Escape"&&t()}),window.addEventListener("scroll",t,!0),qc=e,e}function Df(e){let t=Xg();t.classList.remove("hidden"),t.style.visibility="hidden",Rf();let n=window.getSelection();n&&n.rangeCount>0?Zt=n.getRangeAt(0).cloneRange():Ti?Zt=Ti.cloneRange():Zt=null;let r=t.getBoundingClientRect(),o=22,i=12,s=e.clientX+14,c=e.clientY+o;c+r.height+i>window.innerHeight&&(c=Math.max(i,e.clientY-r.height-o));let l=Math.min(Math.max(s,i),window.innerWidth-r.width-i),d=Math.min(Math.max(c,i),window.innerHeight-r.height-i);t.style.left=`${l}px`,t.style.top=`${d}px`,t.style.visibility="visible"}function _f(e,t,n){let r=n||e;e.addEventListener("focusin",()=>{vi=r}),e.addEventListener("contextmenu",s=>{a.mode!=="edit"||a.editingBlockId!==t||(s.preventDefault(),No=r,Df(s))});let o=null;e.addEventListener("touchstart",s=>{if(a.mode!=="edit"||a.editingBlockId!==t||s.touches.length!==1)return;let c=s.touches[0];o=window.setTimeout(()=>{No=r,Df({clientX:c.clientX,clientY:c.clientY})},500)},{passive:!0});let i=()=>{o!==null&&(clearTimeout(o),o=null)};e.addEventListener("touchend",i,{passive:!0}),e.addEventListener("touchcancel",i,{passive:!0})}async function Gc(e){if(!e)return;let t=Qe(e);if(!t)return;let n=(t.ancestors||[]).filter(r=>r.collapsed);for(let r of n)await so(r.id,!1)}var Jg,qc,Zt,No,vi,Mo,Ti,Pf,vn=Ke(()=>{At();Xt();zt();mr();Un();Qn();Xt();qn();qn();Bo();kf();Fc();vf();zc();Lf();Nf();Jg=16;qc=null,Zt=null,No=null,vi=null,Mo={html:"",text:"",sourceBlockId:null},Ti=null,Pf=!1;Bf()});function Zg(e="",t=""){let n=Array.from(e),r=Array.from(t),o=n.length,i=r.length,s=Array.from({length:o+1},()=>new Array(i+1).fill(0));for(let m=o-1;m>=0;m-=1)for(let y=i-1;y>=0;y-=1)n[m]===r[y]?s[m][y]=s[m+1][y+1]+1:s[m][y]=Math.max(s[m+1][y],s[m][y+1]);let c=[],l=0,d=0;for(;l<o&&d<i;)n[l]===r[d]?(c.push({type:"same",value:n[l]}),l+=1,d+=1):s[l+1][d]>=s[l][d+1]?(c.push({type:"removed",value:n[l]}),l+=1):(c.push({type:"added",value:r[d]}),d+=1);for(;l<o;)c.push({type:"removed",value:n[l]}),l+=1;for(;d<i;)c.push({type:"added",value:r[d]}),d+=1;let u=[];return c.forEach(m=>{if(!m.value)return;let y=u[u.length-1];y&&y.type===m.type?y.value+=m.value:u.push({type:m.type,value:m.value})}),u}function ey(e=[],t=[]){let n=c=>`${c.src}||${c.alt||""}`,r={};t.forEach(c=>{let l=n(c);r[l]=(r[l]||0)+1});let o=[];e.forEach(c=>{let l=n(c);r[l]?r[l]-=1:o.push({type:"removed",...c})});let i={};e.forEach(c=>{let l=n(c);i[l]=(i[l]||0)+1});let s=[];return t.forEach(c=>{let l=n(c);i[l]?i[l]-=1:s.push({type:"added",...c})}),[...o,...s]}function ty(e,t){if(!t.length)return;let n=document.createElement("div");n.className="diff-images",t.forEach(r=>{let o=document.createElement("div");o.className=`diff-image-card diff-image-card--${r.type}`;let i=document.createElement("div");i.className="diff-image-card__label",i.textContent=r.type==="added"?"\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E":"\u0423\u0434\u0430\u043B\u0435\u043D\u043E";let s=document.createElement("img");s.src=r.src,s.alt=r.alt||"",o.append(i,s),n.appendChild(o)}),e.appendChild(n)}function $f(e,t,n,r=[]){let o=document.createElement("div");o.className="diff-inline";let i=document.createElement("div");i.className="diff-inline__content",n.forEach(c=>{let l=document.createElement("span");c.type==="added"?l.className="diff-inline__segment diff-inline__segment--added":c.type==="removed"&&(l.className="diff-inline__segment diff-inline__segment--removed"),l.textContent=c.value,i.appendChild(l)}),ty(i,r);let s=document.createElement("div");s.className="diff-inline__hint",s.textContent=t==="undo"?"\u041F\u043E\u0432\u0442\u043E\u0440\u043D\u043E \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Ctrl+Z, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C \u043E\u0442\u043C\u0435\u043D\u0443":"\u041F\u043E\u0432\u0442\u043E\u0440\u043D\u043E \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Ctrl+Y, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C \u043F\u043E\u0432\u0442\u043E\u0440",o.append(i,s),e.innerHTML="",e.appendChild(o)}function ny(e,t="history"){return(t==="redo"?a.article?.redoHistory||[]:a.article?.history||[]).find(r=>r.id===e)||null}async function Ff(e,t){hr();let n=t==="undo"?"history":"redo",r=ny(e.historyEntryId,n);if(!r)return!1;await Fs(e.blockId);let o=document.querySelector(`.block[data-block-id="${e.blockId}"] .block-text`);if(!o)return!1;let i=o.innerHTML,s=t==="undo"?r.before:r.after,c=o.textContent||"",l=Eu(s),d=Zg(c,l),u=d.some(y=>y.type!=="same"),m=ey(ac(i),ac(s));return!u&&!m.length?!1:($f(o,t,d,m),a.pendingTextPreview={mode:t,blockId:e.blockId,originalHTML:i,chunks:d,imageDiff:m},!0)}async function zf(e){let t=a.pendingTextPreview;if(hr({restoreDom:!1}),!!t){if(e==="undo"){let n=a.undoStack.pop();if(!n)return;await qf(n)?a.redoStack.push(n):a.undoStack.push(n)}else if(e==="redo"){let n=a.redoStack.pop();if(!n)return;await Kf(n)?a.undoStack.push(n):a.redoStack.push(n)}}}function Uf(){let e=a.pendingTextPreview;if(!e)return;let t=document.querySelector(`.block[data-block-id="${e.blockId}"] .block-text`);t&&$f(t,e.mode,e.chunks,e.imageDiff||[])}function ry(e){return e?e.kind==="move"?{kind:"move",blockId:e.blockId,direction:e.direction==="up"?"down":"up"}:e.kind==="reorder"?{kind:"reorder",blockId:e.blockId,fromParentId:e.toParentId??null,fromIndex:e.toIndex??null,toParentId:e.fromParentId??null,toIndex:e.fromIndex??null}:e.kind==="indent"?{kind:"outdent",blockId:e.blockId}:e.kind==="outdent"?{kind:"indent",blockId:e.blockId}:e.kind==="create"?{kind:"delete",blockId:e.blockId,fallbackId:e.fallbackId||null}:e.kind==="delete"?{kind:"restore",block:e.block,parentId:e.parentId||null,index:e.index??null}:null:null}async function Vf(e,t={}){let{skipRecord:n=!1}=t;if(!e)return{success:!1};let r=!1,o=null;if(qt("executeStructureAction start",e),e.kind==="move")r=await Xc(e.blockId,e.direction,{skipRecord:n});else if(e.kind==="reorder")r=(await Vs(e.blockId,e.toParentId??null,e.toIndex??null,{skipRecord:!0})).success;else if(e.kind==="indent")r=await el(e.blockId,{skipRecord:n});else if(e.kind==="outdent")r=await tl(e.blockId,{skipRecord:n});else if(e.kind==="delete"){let i=e.blockId||e.block?.id;if(!i)return{success:!1};try{o=await He(`/api/articles/${a.articleId}/blocks/${i}`,{method:"DELETE"});let s=Qe(i);if(s&&a.article&&Array.isArray(a.article.blocks)){let l=s.siblings||a.article.blocks,d=s.index??l.findIndex(u=>u.id===i);if(d>=0&&l.splice(d,1),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}if(o?.block&&o.block.id){let{pushLocalBlockTrashEntry:u}=await Promise.resolve().then(()=>(mr(),Yf)),m=o.block;u(m,s.parent?.id||null,s.index??d)}}let c=e.fallbackId||o?.parentId||null;c&&await Fs(c),st("undo.executeStructureAction.delete.localRender"),r=!0}catch(s){P(s.message),r=!1}}else if(e.kind==="restore"||e.kind==="create"){let i=e.block||e.blockSnapshot;if(!i)return{success:!1};let s=e.parentId||null;try{let c=i;a.article&&a.article.encrypted&&a.articleEncryptionKey&&(c=JSON.parse(JSON.stringify(i)),await ui(c,a.articleEncryptionKey)),o=await He(`/api/articles/${a.articleId}/blocks/restore`,{method:"POST",body:JSON.stringify({parentId:e.parentId||null,index:e.index??null,block:c})});let l=o?.block,d=o?.parentId||e.parentId||null;if(s=d,l&&a.article&&Array.isArray(a.article.blocks)){let u=Er(l)||l;if(d){let y=Qe(d)?.block||null;if(y){Array.isArray(y.children)||(y.children=[]);let w=y.children,g=typeof o.index=="number"&&o.index>=0&&o.index<=w.length?o.index:w.length;w.splice(g,0,u)}}else{let m=a.article.blocks,y=typeof o.index=="number"&&o.index>=0&&o.index<=m.length?o.index:m.length;m.splice(y,0,u)}if(a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}r=!0}catch(c){P(c.message),r=!1}if(r&&a.article&&Array.isArray(a.article.blocks))if(s)try{await Lt(s)}catch{st("undo.executeStructureAction.restore.fallbackFullRender")}else st("undo.executeStructureAction.restore.fullRender")}if(r){let i=e.blockId||o?.block?.id||e.block?.id;i&&await Fs(i)}return qt("executeStructureAction result",{success:r,payload:o}),{success:r,payload:o}}async function qf(e){if(!a.articleId)return null;try{let t=await He(`/api/articles/${a.articleId}/blocks/undo-text`,{method:"POST",body:JSON.stringify({entryId:e?.historyEntryId||null})}),n=t?.blockId;if(!n)return null;let r=Qe(n);if(!r||!a.article||!Array.isArray(a.article.blocks))return await nn(a.articleId,{desiredBlockId:n}),st("undo.undoTextChange.hardResync.fullRender"),n;let o=t.block&&typeof t.block.text=="string"?t.block.text:"";if(a.article.encrypted&&a.articleEncryptionKeys?.[a.article.id]&&li(o)){let i=a.articleEncryptionKeys[a.article.id];try{o=await di(i,o)}catch{o=""}}if(r.block.text=o,a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}return a.currentBlockId=n,a.selectionAnchorBlockId=null,a.selectedBlockIds=[],await Lt(n),n}catch(t){return t.message!=="Nothing to undo"&&P(t.message),null}}async function Kf(e){if(!a.articleId)return null;try{let t=await He(`/api/articles/${a.articleId}/blocks/redo-text`,{method:"POST",body:JSON.stringify({entryId:e?.historyEntryId||null})}),n=t?.blockId;if(!n)return null;let r=Qe(n);if(!r||!a.article||!Array.isArray(a.article.blocks))return await nn(a.articleId,{desiredBlockId:n}),st("undo.redoTextChange.hardResync.fullRender"),n;let o=t.block&&typeof t.block.text=="string"?t.block.text:"";if(a.article.encrypted&&a.articleEncryptionKeys?.[a.article.id]&&li(o)){let i=a.articleEncryptionKeys[a.article.id];try{o=await di(i,o)}catch{o=""}}if(r.block.text=o,a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}return a.currentBlockId=n,a.selectionAnchorBlockId=null,a.selectedBlockIds=[],await Lt(n),n}catch(t){return t.message!=="Nothing to redo"&&P(t.message),null}}async function Do(){if(a.pendingTextPreview?.mode==="redo"&&hr(),a.pendingTextPreview?.mode==="undo"){await zf("undo");return}if(!a.undoStack.length){P("\u041D\u0435\u0447\u0435\u0433\u043E \u043E\u0442\u043C\u0435\u043D\u044F\u0442\u044C");return}let e=a.undoStack[a.undoStack.length-1];if(qt("handleUndoAction entry",e),e.type==="structure"){a.undoStack.pop();let n=ry(e.action),r=await Vf(n,{skipRecord:!0});r.success?(e.action.kind==="create"&&r.payload?.block&&(e.action.block=r.payload.block,e.action.parentId=r.payload.parentId||null,e.action.index=r.payload.index??null),a.redoStack.push(e)):(a.undoStack.push(e),P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043C\u0435\u043D\u0438\u0442\u044C \u0434\u0435\u0439\u0441\u0442\u0432\u0438\u0435"));return}await Ff(e,"undo")||(a.undoStack.pop(),await qf(e)?a.redoStack.push(e):a.undoStack.push(e))}async function _o(){if(a.pendingTextPreview?.mode==="undo"&&hr(),a.pendingTextPreview?.mode==="redo"){await zf("redo");return}if(!a.redoStack.length){P("\u041D\u0435\u0447\u0435\u0433\u043E \u043F\u043E\u0432\u0442\u043E\u0440\u044F\u0442\u044C");return}let e=a.redoStack[a.redoStack.length-1];if(qt("handleRedoAction entry",e),e.type==="structure"){a.redoStack.pop(),(await Vf(e.action,{skipRecord:!0})).success?a.undoStack.push(e):(a.redoStack.push(e),P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u0432\u0442\u043E\u0440\u0438\u0442\u044C \u0434\u0435\u0439\u0441\u0442\u0432\u0438\u0435"));return}await Ff(e,"redo")||(a.redoStack.pop(),await Kf(e)?a.undoStack.push(e):a.redoStack.push(e))}function jf(e){hr({restoreDom:!1});let t=n=>({type:"text",blockId:n.blockId,historyEntryId:n.id});a.undoStack=(e.history||[]).map(t),a.redoStack=(e.redoHistory||[]).map(t)}function Tn(e){e&&(qt("pushUndoEntry",e),a.undoStack.push(e),a.redoStack=[])}function Er(e){try{return JSON.parse(JSON.stringify(e||{}))}catch{return null}}function Qc(e){if(!e||!a.article||!Array.isArray(a.article.blocks))return;let t=!1,n=r=>{if(Array.isArray(r))for(let o=0;o<r.length;o+=1){let i=r[o];if(i){if(i===e)if(!t)t=!0;else{r.splice(o,1),o-=1;continue}Array.isArray(i.children)&&i.children.length&&n(i.children)}}};n(a.article.blocks)}async function oy(){if(a.articleId&&!a.isMoveQueueProcessing){a.isMoveQueueProcessing=!0;try{for(;a.moveQueue.length;){let e=a.moveQueue.shift();if(!e)break;let{blockId:t,direction:n}=e;try{await He(`/api/articles/${a.articleId}/blocks/${t}/move`,{method:"POST",body:JSON.stringify({direction:n})})}catch(r){P(r.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u043F\u043E\u0440\u044F\u0434\u043E\u043A \u0431\u043B\u043E\u043A\u043E\u0432, \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0441\u0442\u0430\u0442\u044C\u044E");try{await nn(a.articleId,{desiredBlockId:t}),st("undo.processMoveQueue.reloadAfterError")}catch{}a.moveQueue=[];break}}}finally{a.isMoveQueueProcessing=!1}}}function iy(e,t){!e||!["up","down"].includes(t)||(Array.isArray(a.moveQueue)||(a.moveQueue=[]),a.moveQueue.push({blockId:e,direction:t}),oy())}async function Fs(e){e&&(await Gc(e),Kn(e))}function hr({restoreDom:e=!0}={}){let t=a.pendingTextPreview;if(t){if(e){let n=document.querySelector(`.block[data-block-id="${t.blockId}"] .block-text`);n&&(n.innerHTML=t.originalHTML)}a.pendingTextPreview=null}}async function Xc(e,t,n={}){if(!e||!["up","down"].includes(t))return!1;let{skipRecord:r=!1,internal:o=!1,suppressRerender:i=!1}=n;try{let s=Qe(e);if(t==="up"&&s&&s.parent){let l=s.siblings||a.article?.blocks||[];if((s.index??l.findIndex(u=>u.id===e))===0){let u=s.parent.id,m=Qe(u),y=m?.siblings||a.article?.blocks||[],w=m?.index??y.findIndex(b=>b&&b.id===(m?.block?.id||u));if(w<=0)return!1;let g=y[w-1];if(!g||!g.id)return!1;let f=Array.isArray(g.children)?g.children.length:0,h=await Vs(e,g.id,f,{skipRecord:!0,anchorId:null,placement:null,suppressRerender:i});return h.success?(a.currentBlockId=e,r||Tn({type:"structure",action:{kind:"reorder",blockId:e,fromParentId:u,fromIndex:s.index??0,toParentId:g.id,toIndex:h.to?.index??f}}),!0):!1}}if(s&&a.article&&Array.isArray(a.article.blocks)){let l=s.siblings||a.article.blocks,d=s.index??l.findIndex(u=>u.id===e);if(d>=0){let u=d===0,m=d===l.length-1;if(t==="up"&&u||t==="down"&&m)return!1}}let c=null;if(s&&a.article&&Array.isArray(a.article.blocks)){let l=s.siblings||a.article.blocks,d=s.index??l.findIndex(u=>u.id===e);if(d>=0){let u=t==="up"?d-1:d+1;if(u>=0&&u<l.length){let[m]=l.splice(d,1);l.splice(u,0,m)}}if(a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}c=s.parent?.id||null}return a.currentBlockId=e,iy(e,t),i||qs(e,t)||(c?await Lt(c):st("undo.moveBlock.reorderDomBlockFallback.fullRender")),r||Tn({type:"structure",action:{kind:"move",blockId:e,direction:t}}),!0}catch(s){return P(s.message),!1}}function Hf(e){return Xc(a.currentBlockId,e)}async function Zc(e){if(!a.article||!Array.isArray(a.article.blocks)||!["up","down"].includes(e))return!1;let t=Array.isArray(a.selectedBlockIds)?a.selectedBlockIds:[];if(t.length<=1)return Hf(e);if(a.isMovingBlock)return!1;let r=On(a.article.blocks).filter(c=>t.includes(c.id));if(r.length<=1)return Hf(e);let o=Qe(r[0].id)?.parent?.id||null,i=[],s=!0;if(r.forEach((c,l)=>{let d=Qe(c.id);if(!d){s=!1;return}if((d.parent?.id||null)!==o){s=!1;return}i.push(d.index)}),!s||!i.length)return P("\u041C\u043D\u043E\u0436\u0435\u0441\u0442\u0432\u0435\u043D\u043D\u043E\u0435 \u043F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u043F\u043E\u0434\u0440\u044F\u0434 \u0438\u0434\u0443\u0449\u0438\u0445 \u0431\u043B\u043E\u043A\u043E\u0432 \u0441 \u043E\u0434\u043D\u0438\u043C \u0440\u043E\u0434\u0438\u0442\u0435\u043B\u0435\u043C"),!1;i.sort((c,l)=>c-l);for(let c=1;c<i.length;c+=1)if(i[c]!==i[0]+c)return P("\u041C\u043D\u043E\u0436\u0435\u0441\u0442\u0432\u0435\u043D\u043D\u043E\u0435 \u043F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u043F\u043E\u0434\u0440\u044F\u0434 \u0438\u0434\u0443\u0449\u0438\u0445 \u0431\u043B\u043E\u043A\u043E\u0432"),!1;a.isMovingBlock=!0;try{let c=e==="up"?[...r]:[...r].reverse();for(let f of c)if(!await Xc(f.id,e,{skipRecord:!0,internal:!0,suppressRerender:!0}))return P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438"),!1;let l=i[0],d=i[i.length-1],u=(o?Qe(o)?.block.children:a.article.blocks)||[],m=o,y=o,w=l,g=e==="up"?l-1:d+1;return Tn({type:"structure",action:{kind:"reorder",blockId:r[0].id,fromParentId:m,fromIndex:w,toParentId:y,toIndex:g}}),a.currentBlockId=r[0].id,o?await Lt(o):st(),!0}finally{a.isMovingBlock=!1}}async function Vs(e,t=null,n=null,r={}){if(!e)return{success:!1};let{skipRecord:o=!1,anchorId:i=null,placement:s=null,suppressRerender:c=!1}=r,l=Qe(e);if(!l)return P("\u0411\u043B\u043E\u043A \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D"),{success:!1};let d=l.parent?.id||null,u=l.index??0,m=t?Qe(t)?.block:null,y=m?m.children?.length||0:(a.article?.blocks||[]).length,w=typeof n=="number"&&n>=0?Math.min(n,y):y;if(d===t&&u===w)return{success:!0,noOp:!0,from:{parentId:d,index:u},to:{parentId:t,index:w}};let g=w;t===d&&u<g&&(g=Math.max(g-1,0));try{let f=await He(`/api/articles/${a.articleId}/blocks/${e}/relocate`,{method:"POST",body:JSON.stringify({parentId:t||null,index:g,anchorId:i||null,placement:s||null})});if(a.article&&Array.isArray(a.article.blocks)){let b=l.siblings||a.article.blocks,S=l.index??b.findIndex(B=>B.id===e),k=null;S>=0&&([k]=b.splice(S,1)),k||(k=l.block);let A;if(t){let B=Qe(t);B&&B.block?(Array.isArray(B.block.children)||(B.block.children=[]),A=B.block.children):A=a.article.blocks}else A=a.article.blocks;let v=typeof g=="number"&&g>=0?Math.min(g,A.length):A.length;if(A.splice(v,0,k),Qc(k),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}a.currentBlockId=e;let h=f?.parentId??t??null;return c||(d&&h?(await Lt(d),h!==d&&await Lt(h)):d&&!h?st("undo.moveBlockToParent.toRoot.fullRender"):!d&&h?st("undo.moveBlockToParent.fromRoot.fullRender"):st("undo.moveBlockToParent.rootReorder.fullRender")),o||Tn({type:"structure",action:{kind:"reorder",blockId:e,fromParentId:d,fromIndex:u,toParentId:f?.parentId??t??null,toIndex:f?.index??g}}),await Fs(e),{success:!0,from:{parentId:d,index:u},to:{parentId:f?.parentId??t??null,index:f?.index??g}}}catch(f){return P(f.message),{success:!1}}}async function el(e,t={}){if(!e)return!1;let{skipRecord:n=!1,keepEditing:r=!1,suppressRerender:o=!1}=t;try{if(!t.internal){if(a.isMovingBlock)return!1;a.isMovingBlock=!0}r&&(a.pendingEditBlockId=e,a.scrollTargetBlockId=e);let i=Qe(e),s=i?.parent?.id||null;if(await He(`/api/articles/${a.articleId}/blocks/${e}/indent`,{method:"POST",body:JSON.stringify({})}),i&&a.article&&Array.isArray(a.article.blocks)){let c=i.siblings||a.article.blocks,l=i.index??c.findIndex(d=>d.id===e);if(l>0){let d=c[l-1],[u]=c.splice(l,1);if(Array.isArray(d.children)||(d.children=[]),d.children.push(u),Qc(u),d.collapsed){d.collapsed=!1;try{await He(`/api/articles/${a.articleId}/collapse`,{method:"PATCH",body:JSON.stringify({blockId:d.id,collapsed:!1})})}catch{}}if(a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}}return a.currentBlockId=e,r&&(a.mode="edit",a.editingBlockId=e),o||(s?await Lt(s):st("undo.indentBlock.fullRender")),n||Tn({type:"structure",action:{kind:"indent",blockId:e}}),!0}catch(i){return P(i.message),!1}finally{t.internal||(a.isMovingBlock=!1)}}function zs(e={}){return el(a.currentBlockId,e)}async function Jf(e={}){if(!a.article||!Array.isArray(a.article.blocks))return!1;let t=Array.isArray(a.selectedBlockIds)?a.selectedBlockIds:[];if(t.length<=1)return zs(e);if(a.isMovingBlock)return!1;let r=On(a.article.blocks).filter(u=>t.includes(u.id));if(r.length<=1)return zs(e);let o=Qe(r[0].id);if(!o||!o.siblings)return!1;let i=o.siblings;if((o.index??i.findIndex(u=>u.id===o.block.id))<=0)return P("\u041D\u0435\u043B\u044C\u0437\u044F \u0443\u0432\u0435\u043B\u0438\u0447\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u043D\u043E\u0441\u0442\u044C \u043F\u0435\u0440\u0432\u043E\u0439 \u0433\u0440\u0443\u043F\u043F\u044B \u0431\u043B\u043E\u043A\u043E\u0432"),!1;let c=o.parent?.id||null,l=[],d=!0;if(r.forEach(u=>{let m=Qe(u.id);if(!m){d=!1;return}if((m.parent?.id||null)!==c){d=!1;return}l.push(m.index)}),!d||!l.length)return P("\u041C\u043D\u043E\u0436\u0435\u0441\u0442\u0432\u0435\u043D\u043D\u044B\u0439 \u043E\u0442\u0441\u0442\u0443\u043F \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u043F\u043E\u0434\u0440\u044F\u0434 \u0438\u0434\u0443\u0449\u0438\u0445 \u0431\u043B\u043E\u043A\u043E\u0432 \u0441 \u043E\u0434\u043D\u0438\u043C \u0440\u043E\u0434\u0438\u0442\u0435\u043B\u0435\u043C"),!1;l.sort((u,m)=>u-m);for(let u=1;u<l.length;u+=1)if(l[u]!==l[0]+u)return P("\u041C\u043D\u043E\u0436\u0435\u0441\u0442\u0432\u0435\u043D\u043D\u044B\u0439 \u043E\u0442\u0441\u0442\u0443\u043F \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u043F\u043E\u0434\u0440\u044F\u0434 \u0438\u0434\u0443\u0449\u0438\u0445 \u0431\u043B\u043E\u043A\u043E\u0432"),!1;a.isMovingBlock=!0;try{for(let u of r)if(!await el(u.id,{...e,skipRecord:!0,internal:!0,suppressRerender:!0}))return P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u043D\u043E\u0441\u0442\u044C \u0431\u043B\u043E\u043A\u043E\u0432"),!1;return Tn({type:"structure",action:{kind:"indent",blockId:r[0].id}}),a.currentBlockId=r[0].id,c?await Lt(c):st("undo.indentSelectedBlocks.fullRender"),!0}finally{a.isMovingBlock=!1}}async function tl(e,t={}){if(!e)return!1;let{skipRecord:n=!1,keepEditing:r=!1,suppressRerender:o=!1}=t;try{if(!t.internal){if(a.isMovingBlock)return!1;a.isMovingBlock=!0}r&&(a.pendingEditBlockId=e,a.scrollTargetBlockId=e);let i=Qe(e);await He(`/api/articles/${a.articleId}/blocks/${e}/outdent`,{method:"POST",body:JSON.stringify({})});let s=null;if(i&&a.article&&Array.isArray(a.article.blocks)){let c=i.parent||null,d=(c?Qe(c.id):null)?.parent||null;s=d?.id||null;let u=i.siblings||(c?c.children||[]:a.article.blocks),m=i.index??u.findIndex(h=>h.id===e),y=null;m>=0&&([y]=u.splice(m,1)),y||(y=i.block);let w;d?(Array.isArray(d.children)||(d.children=[]),w=d.children):w=a.article.blocks;let g=c?w.indexOf(c):-1,f=g>=0?g+1:w.length;if(w.splice(f,0,y),Qc(y),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}return a.currentBlockId=e,r&&(a.mode="edit",a.editingBlockId=e),o||(s?await Lt(s):st("undo.outdentBlock.fullRender")),n||Tn({type:"structure",action:{kind:"outdent",blockId:e}}),!0}catch(i){return P(i.message),!1}finally{t.internal||(a.isMovingBlock=!1)}}function Us(e={}){return tl(a.currentBlockId,e)}async function Wf(e={}){if(!a.article||!Array.isArray(a.article.blocks))return!1;let t=Array.isArray(a.selectedBlockIds)?a.selectedBlockIds:[];if(t.length<=1)return Us(e);if(a.isMovingBlock)return!1;let r=On(a.article.blocks).filter(l=>t.includes(l.id));if(r.length<=1)return Us(e);let o=Qe(r[0].id);if(!o||!o.parent)return P("\u041D\u0435\u043B\u044C\u0437\u044F \u0443\u043C\u0435\u043D\u044C\u0448\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u043D\u043E\u0441\u0442\u044C \u043A\u043E\u0440\u043D\u0435\u0432\u044B\u0445 \u0431\u043B\u043E\u043A\u043E\u0432"),!1;let i=o.parent.id,s=[],c=!0;if(r.forEach(l=>{let d=Qe(l.id);if(!d||!d.parent){c=!1;return}if(d.parent.id!==i){c=!1;return}s.push(d.index)}),!c||!s.length)return P("\u041C\u043D\u043E\u0436\u0435\u0441\u0442\u0432\u0435\u043D\u043D\u044B\u0439 \u043E\u0442\u0441\u0442\u0443\u043F \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u043F\u043E\u0434\u0440\u044F\u0434 \u0438\u0434\u0443\u0449\u0438\u0445 \u0431\u043B\u043E\u043A\u043E\u0432 \u0441 \u043E\u0434\u043D\u0438\u043C \u0440\u043E\u0434\u0438\u0442\u0435\u043B\u0435\u043C"),!1;s.sort((l,d)=>l-d);for(let l=1;l<s.length;l+=1)if(s[l]!==s[0]+l)return P("\u041C\u043D\u043E\u0436\u0435\u0441\u0442\u0432\u0435\u043D\u043D\u044B\u0439 \u043E\u0442\u0441\u0442\u0443\u043F \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u043F\u043E\u0434\u0440\u044F\u0434 \u0438\u0434\u0443\u0449\u0438\u0445 \u0431\u043B\u043E\u043A\u043E\u0432"),!1;a.isMovingBlock=!0;try{let l=[...r].reverse();for(let m of l)if(!await tl(m.id,{...e,skipRecord:!0,internal:!0,suppressRerender:!0}))return P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u043D\u043E\u0441\u0442\u044C \u0431\u043B\u043E\u043A\u043E\u0432"),!1;Tn({type:"structure",action:{kind:"outdent",blockId:r[0].id}}),a.currentBlockId=r[0].id;let u=Qe(r[0].id)?.parent?.id||null;return u?await Lt(u):st("undo.outdentSelectedBlocks.fullRender"),!0}finally{a.isMovingBlock=!1}}var ar=Ke(()=>{At();Xt();zt();mr();mr();vn();Un();fi()});function sy(){let e=a?.currentUser||null;return e&&(e.id||e.username)||"anon"}async function Ks(){return Ji({userKey:sy()})}async function Gf(e={}){let t=String(e?.token||"").trim(),n=String(e?.articleId||"").trim();if(!t||!n)return!1;let r=String(e?.kind||"image"),o=e?.blob||null,i=String(e?.mime||o&&o.type||"").trim(),s=String(e?.fileName||"").trim()||null,c=Date.now(),d=(await Ks()).transaction(["pending_uploads"],"readwrite"),u=d.objectStore("pending_uploads"),m=await ke(u.get(t)).catch(()=>null),y=Number(m?.createdAtMs||e?.createdAtMs||c)||c,w={token:t,articleId:n,kind:r,blob:o,mime:i,fileName:s,status:String(e?.status||m?.status||"pending"),errorMessage:String(e?.errorMessage||m?.errorMessage||""),createdAtMs:y,updatedAtMs:c};return await ke(u.put(w)),await Ve(d),!0}async function nl(e){let t=String(e||"").trim();if(!t)return!1;let r=(await Ks()).transaction(["pending_uploads"],"readwrite"),o=r.objectStore("pending_uploads");return await ke(o.delete(t)),await Ve(r),!0}async function rl(e,t){let n=String(e||"").trim();if(!n)return!1;let o=(await Ks()).transaction(["pending_uploads"],"readwrite"),i=o.objectStore("pending_uploads"),s=await ke(i.get(n)).catch(()=>null);return s?(s.status="error",s.errorMessage=String(t||"error"),s.updatedAtMs=Date.now(),await ke(i.put(s)),await Ve(o),!0):(await Ve(o),!1)}async function ol({articleId:e=null,limit:t=50}={}){let r=(await Ks()).transaction(["pending_uploads"],"readonly"),o=r.objectStore("pending_uploads"),i=[];try{let s=Number(t||0)||0;if(e){let c=o.index("byArticleId");i=await ke(c.getAll(String(e),s>0?s:void 0))}else i=await ke(o.getAll(s>0?s:void 0))}catch{i=[]}return await Ve(r),Array.isArray(i)?(i.sort((s,c)=>Number(s?.createdAtMs||0)-Number(c?.createdAtMs||0)),i):[]}var Qf=Ke(()=>{At();Va();Fn()});var js,Xf=Ke(()=>{js=["pending-attachment","app","disk"]});function il(e){let n=String(e||"").replace(/\r\n/g,`
`).split(`
`),r=l=>{let d=String(l||"").match(/^(#{1,6})\s+(.*)$/);if(!d)return null;let u=String(d[2]||"").trim();return u?{level:d[1].length,title:u}:null},o=!1;try{let l=n.find(d=>String(d||"").trim().length>0)||"";o=!!r(l)}catch{o=!1}let i=[],s=null,c=()=>{if(s){try{for(;s.bodyLines.length&&!String(s.bodyLines[0]||"").trim();)s.bodyLines.shift()}catch{}s.bodyText=s.bodyLines.join(`
`).trimEnd(),delete s.bodyLines,i.push(s),s=null}};for(let l of n){let d=r(l);if(d){c(),s={level:d.level,title:d.title,bodyLines:[]};continue}s&&s.bodyLines.push(l)}return c(),{sections:i,startsWithHeading:o,headingCount:i.length}}function Zf(e,t={}){let n=Array.isArray(e)?e.filter(Boolean):[],r=typeof t.makeId=="function"?t.makeId:()=>`${Date.now()}-${Math.random()}`;if(!n.length)return[];let o=Number.isFinite(t.baseLevel)?t.baseLevel:Number(n[0].level||1),i=[],s=[];for(let c of n){let l=Number(c.level||1),d=String(c.title||"").trim(),u=String(c.bodyText||"").trimEnd();if(!d)continue;let m=Math.max(0,l-o);for(;s.length>m;)s.pop();m>s.length&&(m=s.length);let y={id:r(),title:d,bodyText:u,children:[]},w=m>0?s[m-1]:null;w?w.children.push(y):i.push(y),s.push(y)}return i}var ep=Ke(()=>{});function np(){try{return window?.localStorage?.getItem?.(ay)==="1"}catch{return!1}}function ly(){try{let e=window?.localStorage?.getItem?.(cy);return e==="0"?!1:e==="1"?!0:np()}catch{return!1}}function dy(e){try{let t=String(e||""),n=2166136261;for(let r=0;r<t.length;r+=1)n^=t.charCodeAt(r),n=Math.imul(n,16777619);return(n>>>0).toString(16)}catch{return"0"}}function uy(e){try{let t=window?.localStorage?.getItem?.(tp)||"",n=t?JSON.parse(t):[],r=Array.isArray(n)?n:[];r.push(e);let o=r.length>250?r.slice(r.length-250):r;window?.localStorage?.setItem?.(tp,JSON.stringify(o))}catch{}}function Js(e,t={}){try{let n={t:new Date().toISOString(),kind:String(e||"event"),data:t&&typeof t=="object"?t:{value:t}};if(uy(n),ly()&&console.log(`[client] ${n.kind}`,n.data),np()&&navigator.onLine!==!1)try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:`client:${n.kind}`,data:n})}).catch(()=>{})}catch{}return!0}catch{return!1}}function Ws(e){try{let t=typeof e=="string"?e:String(e?.stack||""),r=t.split(`
`).map(s=>s.trim()).filter(Boolean).filter(s=>!s.includes("stackSummary")&&!s.includes("clientLog")),o=r.slice(0,6).join(`
`),i=dy(r.slice(0,20).join(`
`));return{top:o,hash:i,bytes:t.length,raw:t.slice(0,1600)}}catch{return{top:"",hash:"0",bytes:0,raw:""}}}var ay,cy,tp,sl=Ke(()=>{ay="ttree_client_log_v1",cy="ttree_client_log_console_v1",tp="ttree_client_event_log_v1"});var Gs={};ur(Gs,{addPendingQuickNote:()=>my,buildOutlineSectionFromPlainText:()=>cl,enqueuePendingQuickNotesForSync:()=>by,overlayPendingQuickNotesIntoInboxDocJson:()=>gy,readPendingQuickNotes:()=>Ys,refreshInboxCacheFromServer:()=>ll,removePendingQuickNoteBySectionId:()=>al});function fy(){return globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?globalThis.crypto.randomUUID():`id-${Date.now()}-${Math.random().toString(16).slice(2)}`}function py(){return new Date().toISOString()}function Ys(){try{let e=window?.localStorage?.getItem?.(op)||"";if(!e)return[];let t=JSON.parse(e);return Array.isArray(t)?t.filter(Boolean):[]}catch{return[]}}function ip(e){try{window?.localStorage?.setItem?.(op,JSON.stringify(Array.isArray(e)?e:[]))}catch{}}function my(e){let t=String(e||"").trim();if(!t)return null;let n=fy(),r={id:n,sectionId:n,createdAt:py(),text:t},o=Ys();return o.unshift(r),ip(o),r}function al(e){let t=String(e||"").trim();if(!t)return!1;let n=Ys(),r=n.filter(o=>String(o?.sectionId||o?.id||"")!==t);return r.length===n.length?!1:(ip(r),!0)}function hy(e){let n=String(e||"").trim().split(/\r?\n/),r=[];for(let o=0;o<n.length;o+=1){let i=n[o];i&&r.push({type:"text",text:i}),o!==n.length-1&&r.push({type:"hardBreak"})}return r.length?r:null}function cl({sectionId:e,text:t}={}){let n=String(e||"").trim();if(!n)return null;let r=hy(t);return{type:"outlineSection",attrs:{id:n,collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[r?{type:"paragraph",content:r}:{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}}function gy(e,t){let n=e&&typeof e=="object"?e:{type:"doc",content:[]},r=Array.isArray(n.content)?n.content:[],o=new Set(r.filter(c=>c&&c.type==="outlineSection"&&c.attrs&&c.attrs.id).map(c=>String(c.attrs.id))),i=Array.isArray(t)?t:[];if(!i.length)return{docJson:n,added:0};let s=[];for(let c of i){let l=String(c?.sectionId||c?.id||"").trim();if(!l||o.has(l))continue;let d=cl({sectionId:l,text:c?.text||""});d&&s.push(d)}return s.length?{docJson:{...n,type:n.type||"doc",content:[...s,...r]},added:s.length}:{docJson:n,added:0}}function yy(e,t){try{let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return 1;let o=window.localStorage.getItem(rp)||"",i=o?JSON.parse(o):{},s=i&&typeof i=="object"?i:{},c=(s[n]&&typeof s[n]=="object"?s[n]:{})||{},d=(Number(c[r]||0)||0)+1;return c[r]=d,s[n]=c,window.localStorage.setItem(rp,JSON.stringify(s)),d}catch{return Date.now()}}async function by(){let e=Ys();if(!e.length)return{status:"empty"};let t=e.slice().sort((r,o)=>Date.parse(String(r?.createdAt||""))-Date.parse(String(o?.createdAt||""))),n=0;for(let r of t){let o=String(r?.sectionId||r?.id||"").trim(),i=String(r?.text||"").trim();if(!o||!i)continue;let s=cl({sectionId:o,text:i});if(!s)continue;let c=s.content?.[0]||{type:"outlineHeading",content:[]},l=s.content?.[1]||{type:"outlineBody",content:[{type:"paragraph"}]},d=yy("inbox",o);await Gt("section_upsert_content",{articleId:"inbox",payload:{sectionId:o,headingJson:c,bodyJson:l,seq:d,opId:o},coalesceKey:`content:inbox:${o}`}),n+=1}return{status:"enqueued",count:n}}async function wy(){let e=await fetch("/api/articles/inbox?include_history=0",{method:"GET",credentials:"include"});if(e.status===401||e.status===403){let t=new Error("auth");throw t.status=e.status,t}if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()}async function ll(){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return{status:"offline"};let e=await wy(),t=new Date().toISOString();try{e?.docJson&&typeof e.docJson=="object"&&await Pn("inbox",e.docJson,t)}catch{}return{status:"refreshed",updatedAt:e?.updatedAt||null,docJson:e?.docJson||null}}var op,rp,Oo=Ke(()=>{eo();Hr();op="ttree_pending_quick_notes_v1",rp="ttree_outline_section_seq_v1"});var pp={};ur(pp,{flushOutboxOnce:()=>Ro,getBackgroundFullPullStatus:()=>ml,startBackgroundFullPull:()=>Bi,startSyncLoop:()=>gl,tryPullBootstrap:()=>hl});function Sy(e,t=null){try{if(!e)return;let n=window.localStorage.getItem(Qs)||"";if(!n)return;let r=JSON.parse(n);if(!r||typeof r!="object")return;let o=String(e),i=r[o]||null;if(!i)return;let s=Number(i?.queuedAt||0)||0,c=typeof t=="number"&&Number.isFinite(t)?t:null;if(c!=null&&s>c)return;delete r[o],window.localStorage.setItem(Qs,JSON.stringify(r))}catch{}}function Ay(e,t){try{let n=e&&typeof e=="object"?e:{type:"doc",content:[]},r=Array.isArray(n.content)?n.content:[],o=new Map,i=u=>{if(Array.isArray(u))for(let m of u){if(!m||typeof m!="object"||m.type!=="outlineSection")continue;let y=String(m?.attrs?.id||"").trim();y&&o.set(y,m);let g=(Array.isArray(m.content)?m.content:[]).find(f=>f&&typeof f=="object"&&f.type==="outlineChildren")||null;g&&Array.isArray(g.content)&&i(g.content)}};i(r);let s=(u,m)=>{let y=u&&typeof u=="object"?u:{type:"outlineSection",attrs:{id:m,collapsed:!1},content:[]};y.type="outlineSection";let w=y.attrs&&typeof y.attrs=="object"?y.attrs:{};w.id=m,y.attrs=w;let g=Array.isArray(y.content)?y.content:[],f=g.find(S=>S&&typeof S=="object"&&S.type==="outlineHeading")||{type:"outlineHeading",content:[]},h=g.find(S=>S&&typeof S=="object"&&S.type==="outlineBody")||{type:"outlineBody",content:[{type:"paragraph"}]},b=g.find(S=>S&&typeof S=="object"&&S.type==="outlineChildren")||{type:"outlineChildren",content:[]};return Array.isArray(b.content)||(b={...b,content:[]}),y.content=[f,h,b],y},c=new Set,l=new Map;for(let u of Array.isArray(t)?t:[]){let m=String(u?.sectionId||"").trim();if(!m)continue;let y=u?.parentId,w=y!=null&&String(y).trim()?String(y).trim():null,g=Number.isFinite(Number(u?.position))?Number(u.position):0,f=!!u?.collapsed,h=s(o.get(m),m);h.attrs={...h.attrs||{},id:m,collapsed:f},o.set(m,h),c.add(m),l.has(w)||l.set(w,[]),l.get(w).push({pos:g,sid:m,sec:h})}for(let[u,m]of l.entries())m.sort((y,w)=>y.pos-w.pos||String(y.sid).localeCompare(String(w.sid))),l.set(u,m);for(let[u,m]of o.entries()){let w=(l.get(u)||[]).map(g=>g.sec);try{Array.isArray(m.content)||(m.content=[]),(!m.content[2]||m.content[2].type!=="outlineChildren")&&(m.content[2]={type:"outlineChildren",content:[]}),m.content[2].content=w}catch{}}let d=(l.get(null)||[]).map(u=>u.sec);for(let[u,m]of o.entries())c.has(u)||d.push(m);return n.type="doc",n.content=d,n}catch{return e}}function Iy(e,t,n,r){try{let o=String(t||"").trim();if(!o)return e;let i=e&&typeof e=="object"?e:{type:"doc",content:[]},s=[i];for(;s.length;){let c=s.pop();if(!c||typeof c!="object")continue;if(c.type==="outlineSection"&&String(c?.attrs?.id||"").trim()===o){let u=(Array.isArray(c.content)?c.content:[]).find(m=>m&&typeof m=="object"&&m.type==="outlineChildren")||{type:"outlineChildren",content:[]};return c.content=[n,r,u],i}let l=c.content;if(Array.isArray(l))for(let d of l)s.push(d)}return i}catch{return e}}function pl(e){let t=e?.type||"";return t==="section_upsert_content"||t==="delete_sections"||t==="structure_snapshot"}function Ey(e,t,n){try{let r=String(e||"").trim(),o=String(t||"").trim(),i=Number(n);if(!r||!o||!Number.isFinite(i)||i<=0)return;let s="ttree_outline_section_seq_v1",c=window.localStorage.getItem(s)||"",l=c?JSON.parse(c):{},d=l&&typeof l=="object"?l:{},u=(d[r]&&typeof d[r]=="object"?d[r]:{})||{};if((Number(u[o]||0)||0)>=i)return;u[o]=i,d[r]=u,window.localStorage.setItem(s,JSON.stringify(d))}catch{}}function vy(e){let t=[],n=(i,s)=>{if(!Array.isArray(i))return;let c=0;for(let l of i){if(!l||typeof l!="object"||l.type!=="outlineSection")continue;let d=String(l?.attrs?.id||"").trim();if(!d)continue;t.push({sectionId:d,parentId:s||null,position:c,collapsed:!!l?.attrs?.collapsed}),c+=1;let m=(Array.isArray(l.content)?l.content:[]).find(w=>w&&typeof w=="object"&&w.type==="outlineChildren")||null,y=m&&Array.isArray(m.content)?m.content:[];n(y,d)}},r=e&&typeof e=="object"?e:null,o=r&&Array.isArray(r.content)?r.content:[];return n(o,null),t}function Ty(e,t){try{let n=e&&typeof e=="object"?{...e}:null;if(!n||n.type!=="outlineHeading")return e;let r=String(t||"");if(!r)return e;let o=Array.isArray(n.content)?[...n.content]:[];return o.unshift({type:"text",text:r}),n.content=o,n}catch{return e}}function Cy(e,t,n){let r=e&&typeof e=="object"?e:{type:"doc",content:[]};Array.isArray(r.content)||(r.content=[]);let o=String(t||"").trim(),i=c=>{for(let l=0;l<c.length;l+=1){let d=c[l];if(!d||typeof d!="object"||d.type!=="outlineSection")continue;let u=String(d?.attrs?.id||"").trim();if(o&&u===o)return c.splice(l+1,0,n),!0;let y=(Array.isArray(d.content)?d.content:[]).find(w=>w&&typeof w=="object"&&w.type==="outlineChildren")||null;if(y&&Array.isArray(y.content)&&i(y.content))return!0}return!1};return i(r.content)||r.content.push(n),r}function By(){try{return window?.localStorage?.getItem?.("ttree_debug_offline_v1")==="1"}catch{return!1}}function dp(...e){try{if(!By())return;console.log("[offline][queue]",...e)}catch{}}function fp(){try{let e=window.localStorage.getItem(Qs)||"";if(!e)return{changed:!1,removed:0};let t=JSON.parse(e);if(!t||typeof t!="object")return{changed:!1,removed:0};let n=Object.keys(t);if(!n.length)return{changed:!1,removed:0};let r=0;for(let o of n)o!=="inbox"&&(delete t[o],r+=1);return r?(window.localStorage.setItem(Qs,JSON.stringify(t)),dp("prune.queue",{removed:r}),{changed:!0,removed:r}):{changed:!1,removed:0}}catch(e){return dp("prune.queue.error",{message:e?.message||String(e||"error")}),{changed:!1,removed:0}}}function Kr(){try{window.dispatchEvent(new CustomEvent("offline-full-pull-status",{detail:{...Jt}}))}catch{}}function ml(){return{...Jt}}async function Cn(e,t={}){let n=await fetch(e,{headers:{"Content-Type":"application/json",...t.headers||{}},credentials:"include",...t});if(!n.ok){let r=await n.json().catch(()=>({})),o=new Error(r.detail||"Request failed");throw o.status=n.status,o.details=r,o.path=e,o}return n.status===204?null:n.json()}function up(e){let t=Number(e?.status||0);return!t||t>=500||t===408||t===429||t===401||t===403}function Ly(e,t){let n=Number(e?.status||0);return n===404||n===410?!0:n>=400&&n<500&&n!==401&&n!==403&&n!==408&&n!==429?t?.type==="save_doc_json"||String(t?.type||"").startsWith("section_")||t?.type==="structure_snapshot"||t?.type==="delete_sections":!1}async function hl(){try{let e=await zn();return pr(e).catch(()=>{}),Array.isArray(e)?e:[]}catch{return null}}function My(e,t){try{let n=new Set((Array.isArray(t)?t:[]).map(i=>String(i||"").trim()).filter(Boolean));if(!n.size)return e;let r=e&&typeof e=="object"?e:{type:"doc",content:[]},o=i=>{if(!Array.isArray(i))return[];let s=[];for(let c of i)if(!(!c||typeof c!="object")){if(c.type==="outlineSection"){let l=String(c?.attrs?.id||"").trim();if(l&&n.has(l))continue;let u=(Array.isArray(c.content)?c.content:[]).find(m=>m&&typeof m=="object"&&m.type==="outlineChildren")||null;u&&Array.isArray(u.content)&&(u.content=o(u.content))}s.push(c)}return s};return Array.isArray(r.content)?r.content=o(r.content):r.content=[],r.type=r.type||"doc",r}catch{return e}}async function Ny(e){if(e.type==="create_article"){let t=e.payload?.title||"\u041D\u043E\u0432\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F",n=e.payload?.id||e.articleId,r=e.payload?.parentId??null,o=await Cn("/api/articles",{method:"POST",body:JSON.stringify({title:t,id:n,parentId:r})});await Rr(o);return}if(e.type==="save_doc_json"){let t=e.payload?.docJson||null;if(!t||typeof t!="object")return;let n=await Cn(`/api/articles/${encodeURIComponent(e.articleId)}/doc-json/save`,{method:"PUT",body:JSON.stringify({docJson:t,createVersionIfStaleHours:12})}),r=n?.updatedAt||null;await Pn(e.articleId,t,r);try{ht("sync.flush.save_doc_json.ok",{articleId:e.articleId,opId:e.id,updatedAt:r,docHash:Qt(t)})}catch{}try{let o=Array.isArray(n?.changedBlockIds)?n.changedBlockIds:[],i=Array.isArray(n?.removedBlockIds)?n.removedBlockIds:[];if(i.length&&await is(i),o.length){let s=await Cn(`/api/articles/${encodeURIComponent(e.articleId)}/embeddings?ids=${encodeURIComponent(o.join(","))}`);await tc(e.articleId,s?.embeddings||[])}}catch{}return}if(e.type==="section_upsert_content"){let t=e.payload?.sectionId||null,n=e.payload?.headingJson||null,r=e.payload?.bodyJson||null,o=e.payload?.seq||null;if(!t||!n||!r||!o)return;let i=await Cn(`/api/articles/${encodeURIComponent(e.articleId)}/sections/upsert-content`,{method:"PUT",body:JSON.stringify({opId:e.payload?.opId||e.id,sectionId:t,headingJson:n,bodyJson:r,seq:o,createVersionIfStaleHours:12})});try{if(i?.updatedAt){let s=await Sr(e.articleId).catch(()=>null),c=s?.docJson&&typeof s.docJson=="object"?s.docJson:null;if(c){let l=Iy(c,t,n,r);await Pn(e.articleId,l,i.updatedAt)}}try{ht("sync.flush.section_upsert_content.ok",{articleId:e.articleId,opId:e.id,sectionId:t,updatedAt:i?.updatedAt||null})}catch{}}catch{}return}if(e.type==="structure_snapshot"){let t=e.payload?.nodes||null;if(!Array.isArray(t)||!t.length)return;let n=await Cn(`/api/articles/${encodeURIComponent(e.articleId)}/structure/snapshot`,{method:"PUT",body:JSON.stringify({opId:e.payload?.opId||e.id,nodes:t})});try{if(n?.updatedAt){let r=await Sr(e.articleId).catch(()=>null),o=r?.docJson&&typeof r.docJson=="object"?r.docJson:null;if(o){let i=Ay(o,t);await Pn(e.articleId,i,n.updatedAt)}}try{ht("sync.flush.structure_snapshot.ok",{articleId:e.articleId,opId:e.id,updatedAt:n?.updatedAt||null,nodesCount:Array.isArray(t)?t.length:null})}catch{}}catch{}return}if(e.type==="delete_sections"){let t=Array.isArray(e.payload?.sectionIds)?e.payload.sectionIds:[];if(!t.length)return;let n=await uu(e.articleId,t,{opId:e.payload?.opId||e.id});try{let r=n?.updatedAt||null,o=await Sr(e.articleId).catch(()=>null),i=o?.docJson&&typeof o.docJson=="object"?o.docJson:null;if(i&&r){let c=My(i,t);await Pn(e.articleId,c,r)}let s=Array.isArray(n?.removedBlockIds)?n.removedBlockIds:[];s.length&&await is(s),ht("sync.flush.delete_sections.ok",{articleId:e.articleId,opId:e.id,updatedAt:r||null,sectionIdsCount:t.length,removedCount:s.length})}catch{}return}if(e.type==="move_article_position"){let t=e.payload?.direction||null;if(!t)return;await Cn(`/api/articles/${encodeURIComponent(e.articleId)}/move`,{method:"POST",body:JSON.stringify({direction:t})});return}if(e.type==="indent_article"){await Cn(`/api/articles/${encodeURIComponent(e.articleId)}/indent`,{method:"POST",body:JSON.stringify({})});return}if(e.type==="outdent_article"){await Cn(`/api/articles/${encodeURIComponent(e.articleId)}/outdent`,{method:"POST",body:JSON.stringify({})});return}if(e.type==="move_article_tree"){await Cn(`/api/articles/${encodeURIComponent(e.articleId)}/move-tree`,{method:"POST",body:JSON.stringify(e.payload||{})});return}}async function Py(e){try{if(!e||!e.articleId||!(e.type==="save_doc_json"||e.type==="section_upsert_content"||e.type==="structure_snapshot"||e.type==="delete_sections"))return;let n=e.payload?.clientQueuedAt??null;if(typeof n!="number"||!Number.isFinite(n)||(await Zr(500)||[]).some(i=>i&&i.articleId===e.articleId&&(i.type==="save_doc_json"||i.type==="section_upsert_content"||i.type==="structure_snapshot")&&(i.payload?.clientQueuedAt??null)===n))return;Sy(e.articleId,n)}catch{}}async function Dy(e,t){let n=String(e||"").trim();if(n)for(let r of t||[])try{let o=String(r?.sectionId||"").trim(),i=r?.headingJson||null,s=r?.bodyJson||null;if(!o||!i||!s)continue;let c=globalThis.crypto?.randomUUID?.()||`conflict-${Date.now()}-${Math.random().toString(16).slice(2)}`,l=await Sr(n).catch(()=>null),d=l?.docJson&&typeof l.docJson=="object"?l.docJson:null,u=Ty(i,"\u041A\u043E\u043D\u0444\u043B\u0438\u043A\u0442\u043D\u0430\u044F \u043A\u043E\u043F\u0438\u044F: "),y=Cy(d||{type:"doc",content:[]},o,{type:"outlineSection",attrs:{id:c,collapsed:!1,isConflictCopy:!0},content:[u||{type:"outlineHeading",content:[]},s||{type:"outlineBody",content:[{type:"paragraph"}]},{type:"outlineChildren",content:[]}]});await Pn(n,y,l?.updatedAt||null).catch(()=>{}),Ey(n,c,1);let w=Date.now();await Gt("section_upsert_content",{articleId:n,payload:{sectionId:c,headingJson:u,bodyJson:s,seq:1,clientQueuedAt:w},coalesceKey:`content:${n}:${c}`}).catch(()=>{});let g=vy(y);g.length&&await Gt("structure_snapshot",{articleId:n,payload:{nodes:g,clientQueuedAt:w},coalesceKey:`structure:${n}`}).catch(()=>{});try{window.dispatchEvent(new CustomEvent("outline-sync-conflict",{detail:{articleId:n,sectionId:o,conflictCopySectionId:c}}))}catch{}}catch{}}async function _y(e,t){let n=String(e||"").trim();if(!n)return;let r=Date.now(),o=Number(cp.get(n)||0)||0;if(o&&r-o<xy)return;cp.set(n,r);let i=async()=>{let f=await Zr(200),h=[],b=[],S=[];for(let k of f||[])!k||String(k.articleId||"")!==n||(k.type==="delete_sections"?h.push(k):k.type==="section_upsert_content"?b.push(k):k.type==="structure_snapshot"&&S.push(k));return{deleteOps:h,upsertOps:b,structureOps:S}},s=0,c=[],l=[],d=[];try{({deleteOps:c,upsertOps:l,structureOps:d}=await i())}catch{c=[],l=[],d=[];for(let f of t||[])!f||String(f.articleId||"")!==n||(f.type==="delete_sections"?c.push(f):f.type==="section_upsert_content"?l.push(f):f.type==="structure_snapshot"&&d.push(f))}let u=new Set;for(let f of c){let h=Array.isArray(f.payload?.sectionIds)?f.payload.sectionIds:[];for(let b of h){let S=String(b||"").trim();S&&u.add(S)}}if(u.size&&l.length)for(let f of l)try{let h=String(f.payload?.sectionId||"").trim();h&&u.has(h)&&await Or(f.id)}catch{}let m=c.map(f=>{let h=Array.isArray(f.payload?.sectionIds)?f.payload.sectionIds:[];return{opId:f.payload?.opId||f.id,sectionIds:h.filter(Boolean).map(b=>String(b)),_outboxId:f.id}}).filter(f=>f.sectionIds.length),y=l.map(f=>{let h=String(f.payload?.sectionId||"").trim();return!h||u.has(h)?null:{opId:f.payload?.opId||f.id,sectionId:h,headingJson:f.payload?.headingJson||null,bodyJson:f.payload?.bodyJson||null,seq:f.payload?.seq||null,clientQueuedAt:f.payload?.clientQueuedAt??null,_outboxId:f.id}}).filter(Boolean),w=async()=>{let f=c.map(H=>{let O=Array.isArray(H.payload?.sectionIds)?H.payload.sectionIds:[];return{opId:H.payload?.opId||H.id,sectionIds:O.filter(Boolean).map(W=>String(W)),_outboxId:H.id}}).filter(H=>H.sectionIds.length),h=l.map(H=>{let O=String(H.payload?.sectionId||"").trim();return!O||u.has(O)?null:{opId:H.payload?.opId||H.id,sectionId:O,headingJson:H.payload?.headingJson||null,bodyJson:H.payload?.bodyJson||null,seq:H.payload?.seq||null,clientQueuedAt:H.payload?.clientQueuedAt??null,_outboxId:H.id}}).filter(Boolean),b=new Map;for(let H of f)b.set(String(H.opId),H._outboxId);for(let H of h)b.set(String(H.opId),H._outboxId);if(!f.length&&!h.length)return!1;try{ht("sync.flush.outline_compact.start",{articleId:n,deletesCount:f.length,upsertsCount:h.length})}catch{}let S=await Cn(`/api/articles/${encodeURIComponent(n)}/sync/compact`,{method:"PUT",body:JSON.stringify({deletes:f.map(({opId:H,sectionIds:O})=>({opId:H,sectionIds:O})),upserts:h.map(({opId:H,sectionId:O,headingJson:W,bodyJson:J,seq:ne})=>({opId:H,sectionId:O,headingJson:W,bodyJson:J,seq:ne}))})}),k=S?.updatedAt||null;k&&await Za(n,k).catch(()=>{});try{ht("sync.flush.outline_compact.ok",{articleId:n,updatedAt:k||null,deleteAcks:Array.isArray(S?.deleteAcks)?S.deleteAcks.length:null,upsertAcks:Array.isArray(S?.upsertAcks)?S.upsertAcks.length:null})}catch{}let A=Array.isArray(S?.deleteAcks)?S.deleteAcks:[];for(let H of A){let O=String(H?.opId||"").trim();if(!O)continue;let W=b.get(O)||O;await Or(W).catch(()=>{});try{let J=Array.isArray(H?.removedBlockIds)?H.removedBlockIds:[];J.length&&await is(J)}catch{}}let v=[],B=Array.isArray(S?.upsertAcks)?S.upsertAcks:[];for(let H of B){let O=String(H?.opId||"").trim(),W=String(H?.sectionId||"").trim();if(!O||!W)continue;let J=b.get(O)||O,ne=String(H?.result||"").trim();if(ne==="ok"||ne==="duplicate")await Or(J).catch(()=>{});else if(ne==="conflict"){await Or(J).catch(()=>{});let me=h.find(we=>String(we.opId)===O)||null;me&&v.push({sectionId:W,headingJson:me.headingJson,bodyJson:me.bodyJson})}}return v.length&&await Dy(n,v),!0};for(;s<2&&(s+=1,!!await w());)try{({deleteOps:c,upsertOps:l,structureOps:d}=await i())}catch{break}let g=null;try{({deleteOps:c,upsertOps:l,structureOps:d}=await i())}catch{}if(!c.length&&!l.length&&(g=d.length?d[d.length-1]:null),g){try{let h=Number(lp.get(n)||0)||0,b=Date.now();if(h&&b-h<ky)return}catch{}let f=g.payload?.nodes||null;if(Array.isArray(f)&&f.length){try{ht("sync.flush.structure_snapshot.start",{articleId:n,opId:g.id,nodesCount:f.length})}catch{}let h=await Cn(`/api/articles/${encodeURIComponent(n)}/structure/snapshot`,{method:"PUT",body:JSON.stringify({opId:g.payload?.opId||g.id,nodes:f})}),b=h?.updatedAt||null;b&&await Za(n,b).catch(()=>{}),Number.isFinite(Number(h?.newStructureRev))?await ec(n,Number(h.newStructureRev)):Number.isFinite(Number(h?.currentStructureRev))&&await ec(n,Number(h.currentStructureRev));try{ht("sync.flush.structure_snapshot.done",{articleId:n,opId:g.id,status:String(h?.status||""),updatedAt:b||null,newStructureRev:Number.isFinite(Number(h?.newStructureRev))?Number(h.newStructureRev):null,currentStructureRev:Number.isFinite(Number(h?.currentStructureRev))?Number(h.currentStructureRev):null})}catch{}let S=String(h?.status||"");if(S==="ok"||S==="duplicate"){await Or(g.id).catch(()=>{});try{lp.set(n,Date.now())}catch{}}}}try{(await Zr(200)||[]).some(b=>pl(b)&&String(b.articleId||"")===n)||(await Vd(n).catch(()=>{}),ht("sync.flush.localDraft.cleared",{articleId:n}))}catch{}}async function Ro(){if(dl)return null;if(!navigator.onLine)return!1;dl=!0;try{let e=await Zr(200),t=new Set,n=[];for(let o of e||[]){if(!pl(o))continue;let i=String(o.articleId||"").trim();!i||t.has(i)||(t.add(i),n.push(i))}for(let o of n)try{await _y(o,e)}catch(i){if(up(i))break}let r=await Zr(50);for(let o of r)if(!pl(o))try{await Ny(o),await Or(o.id);try{if(o.type==="section_upsert_content"&&String(o.articleId||"")==="inbox"){let i=String(o.payload?.sectionId||"").trim();i&&al(i)}}catch{}await Py(o)}catch(i){let s=Number(i?.status||0)||null,c=s?`${s}: ${i?.message||"error"}`:i?.message||String(i||"error");if(await _d(o.id,c),Ly(i,o)){try{console.warn("[offline][outbox] drop op",{opId:o.id,type:o.type,articleId:o.articleId,status:s,message:i?.message||null})}catch{}try{await Or(o.id)}catch{}continue}if(up(i))break;break}}finally{dl=!1}try{let e=await Zr(1);return Array.isArray(e)&&e.length>0}catch{return!0}}function Ci(){ao||(ao=window.setInterval(async()=>{try{await Ro()===!1&&(window.clearInterval(ao),ao=null,fp())}catch{}},15e3))}function fl(){ao&&(window.clearInterval(ao),ao=null)}function gl(){if(!sp){sp=!0,fp();try{ts()}catch{}window.addEventListener("online",()=>{Ro().then(e=>{e?Ci():fl()}).catch(()=>{})}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&Ro().then(e=>{e?Ci():fl()}).catch(()=>{})}),window.addEventListener("offline-outbox-changed",()=>{Ro().then(e=>{e?Ci():fl()}).catch(()=>{Ci()})}),Ro().then(e=>{e&&Ci()}).catch(()=>{})}}function Bi(e={}){let t=!!(e&&e.force);ul||ap&&!t||(ap=!0,ul=!0,Jt={running:!0,processed:0,total:0,errors:0,phase:"index",lastError:null,startedAt:new Date().toISOString(),finishedAt:null},Kr(),(async()=>{try{if(!navigator.onLine){Jt={...Jt,running:!1,phase:"error",lastError:"offline",finishedAt:new Date().toISOString()},Kr();return}let n=new Map;try{let o=await zd();n=new Map((o||[]).map(i=>[i.id,i]))}catch{}let r=[];try{Array.isArray(e?.initialIndex)?r=e.initialIndex:r=await Cn("/api/articles")||[],pr(r).catch(()=>{})}catch(o){Jt={...Jt,running:!1,phase:"error",lastError:o?.message||String(o||"error"),finishedAt:new Date().toISOString()},Kr();return}Jt={...Jt,phase:"articles",total:Array.isArray(r)?r.length:0},Kr();for(let o of r||[]){try{let i=o.updatedAt||null,s=n.get(o.id);if(i&&s?.updatedAt===i&&s?.hasDocJson){try{let l=await Sr(o.id),d=l?.docJson&&typeof l.docJson=="object"?l.docJson:null;d&&xo(o.id,d).catch(()=>{})}catch{}continue}let c=await Cn(`/api/articles/${encodeURIComponent(o.id)}`);await Rr(c);try{let l=await Cn(`/api/articles/${encodeURIComponent(o.id)}/embeddings`);await tc(o.id,l?.embeddings||[])}catch{}}catch{Jt={...Jt,errors:Number(Jt.errors||0)+1}}Jt={...Jt,processed:Number(Jt.processed||0)+1},Kr(),await new Promise(i=>setTimeout(i,120))}try{Jt={...Jt,phase:"inbox"},Kr();let o=await Cn("/api/articles/inbox?include_history=0");await Rr(o)}catch{Jt={...Jt,errors:Number(Jt.errors||0)+1},Kr()}Md().catch(()=>{}),Jt={...Jt,running:!1,phase:"done",finishedAt:new Date().toISOString()},Kr()}finally{ul=!1}})().catch(()=>{}))}var Qs,sp,dl,ap,ul,ao,xy,cp,ky,lp,Jt,Xs=Ke(()=>{Hr();eo();nc();ti();Xt();Oo();ri();Qs="ttree_outline_autosave_queue_docjson_v1";sp=!1,dl=!1,ap=!1,ul=!1,ao=null,xy=2e3,cp=new Map,ky=3e3,lp=new Map;Jt={running:!1,processed:0,total:0,errors:0,phase:"idle",lastError:null,startedAt:null,finishedAt:null}});var Lr={};ur(Lr,{closeOutlineEditor:()=>rm,enterOutlineSectionEditMode:()=>Ub,flushOutlineAutosave:()=>jb,getOutlineActiveSectionId:()=>_b,getOutlineActiveSectionSnapshot:()=>Ob,insertNewOutlineSectionAtEnd:()=>zb,insertNewOutlineSectionAtStart:()=>Vb,insertOutlineSectionFromPlainTextAtStart:()=>qb,insertOutlineSectionFromSectionFragmentsAtEnd:()=>Fb,openOutlineEditor:()=>Kb,openPublicOutlineViewer:()=>Jb,restoreOutlineSectionFromBlockHtml:()=>Hb,restoreOutlineSectionFromSectionFragments:()=>$b,revealOutlineSection:()=>nm});function jr(e,t={},{dedupeMs:n=250}={}){try{let r=Ws(new Error),o=Date.now();if(wl.hash===r.hash&&o-wl.atMs<n)return;wl={atMs:o,hash:r.hash},Js(e,{articleId:Et||a.articleId||null,isOutlineEditing:!!a.isOutlineEditing,mode:a.mode,stackHash:r.hash,stackTop:r.top,...t})}catch{}}function oa(e,t){let n=null,r=String(t||"").trim();return!e||!r?null:(e.descendants((o,i)=>{if(n!==null)return!1;o?.type?.name==="image"&&String(o.attrs?.uploadToken||"")===r&&(n=i)}),n)}function $y(e){let t=String(e||"").trim();if(!t)return;let n=ho.get(t)||null;if(n){ho.delete(t);try{URL.revokeObjectURL(n)}catch{}}}function Np(e,t=3e4){let n=String(e||"").trim();if(n){try{let r=Pi.get(n)||null;r&&clearTimeout(r)}catch{}try{let r=setTimeout(()=>{try{Pi.delete(n)}catch{}$y(n)},Math.max(0,Number(t)||0));Pi.set(n,r)}catch{}}}function Tl(e){if(!e)return!1;if(e.type&&String(e.type).startsWith("image/"))return!0;let t=String(e.name||"").toLowerCase();return!!(t&&/\.(png|jpe?g|gif|webp|bmp|svg|heic|heif)$/i.test(t))}function Pp(e,t){try{let n=e?.state?.schema,r=n?.nodes?.image||null;if(!n||!r)return P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435"),!1;let o=`upl-${Date.now()}-${Math.random().toString(16).slice(2)}`,i=URL.createObjectURL(t);try{ho.set(o,i)}catch{}try{let h=Et||a.articleId||null;Gf({token:o,articleId:h,kind:"image",blob:t,fileName:t?.name||"image",mime:t?.type||""})}catch{}let s=r.create({src:i,alt:t?.name||"image",width:320,uploadToken:o}),c=ze?.pmStateMod?.TextSelection,l=e.state.tr,d=l.selection.from,u=l.selection.to,m="\xA0\xA0";u>d&&(l=l.delete(d,u));let y=Math.max(0,Math.min(l.doc.content.size,d));l=l.insertText(m,y,y);let w=Math.max(0,Math.min(l.doc.content.size,y+m.length));l=l.replaceRangeWith(w,w,s);let g=Math.max(0,Math.min(l.doc.content.size,w+s.nodeSize));l=l.insertText(m,g,g);let f=Math.max(0,Math.min(l.doc.content.size,g+m.length));c&&(l=l.setSelection(c.create(l.doc,f))),l=l.setMeta(de,!0),e.dispatch(l.scrollIntoView());try{let h=new Image;h.decoding="async",h.onload=()=>{try{let b=Number(h.naturalWidth||0),S=Number(h.naturalHeight||0);if(!(b>0&&S>0))return;let k=b/S,A=oa(e.state.doc,o);if(typeof A!="number")return;let v=e.state.doc.nodeAt(A);if(!v||v.type?.name!=="image"||Number.isFinite(Number(v.attrs?.aspectRatio))&&Number(v.attrs.aspectRatio)>0)return;let B={...v.attrs,aspectRatio:k},H=e.state.tr.setNodeMarkup(A,void 0,B);H=H.setMeta(de,!0),e.dispatch(H)}catch{}},h.onerror=()=>{},h.src=i}catch{}try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return P("\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E \u0438 \u0431\u0443\u0434\u0435\u0442 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E \u043F\u0440\u0438 \u043F\u043E\u044F\u0432\u043B\u0435\u043D\u0438\u0438 \u0441\u0435\u0442\u0438"),!0}catch{}return si(t).then(h=>{let b=String(h?.url||"").trim();if(!b)throw new Error("Upload failed");let S=oa(e.state.doc,o);if(typeof S!="number")return;let k=e.state.doc.nodeAt(S);if(!k||k.type?.name!=="image")return;let A={...k.attrs,src:b,uploadToken:null},v=e.state.tr.setNodeMarkup(S,void 0,A);v=v.setMeta(de,!0),e.dispatch(v),Np(o),nl(o).catch(()=>{})}).catch(h=>{P(h?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435");try{let b=oa(e.state.doc,o);if(typeof b!="number")return;let S=e.state.doc.nodeAt(b);if(!S||S.type?.name!=="image")return;let k=String(S.attrs?.title||"").trim(),A=k?`${k} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",v=String(S.attrs?.alt||t?.name||"image"),B={...S.attrs,src:i,alt:v,title:A,uploadToken:o},H=e.state.tr.setNodeMarkup(b,void 0,B);H=H.setMeta(de,!0),e.dispatch(H)}catch{}try{rl(o,String(h?.message||h||"error"))}catch{}}),!0}catch{return!1}}function Dp(e,t){try{let n=e?.state?.schema,r=n?.marks?.link||null;if(!n||!r)return P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u0438\u0435: \u043D\u0435\u0442 \u0441\u0445\u0435\u043C\u044B \u0441\u0441\u044B\u043B\u043E\u043A"),!1;if(!a.articleId)return P("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E"),!1;let o=fn(),i=`pending-attachment:${String(o||"")}`,s=String(t?.name||"\u0444\u0430\u0439\u043B"),c=`${s} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430...)`,{from:l,to:d}=e.state.selection,u=e.state.tr.insertText(c,l,d);u=u.addMark(l,l+c.length,r.create({href:i})),u=u.setMeta(de,!0),e.dispatch(u.scrollIntoView());let m=null;try{m=(be?.getState?.(e.state)||null)?.editingSectionId||null}catch{m=null}let y=(w,g)=>{let f=`pending-attachment:${String(g||"")}`,h=w?.type?.schema?.marks?.link||null;if(!h)return null;let b=null;return w.descendants((S,k)=>{if(b)return!1;!S||!S.isText||!(Array.isArray(S.marks)?S.marks:[]).find(B=>B?.type===h&&String(B?.attrs?.href||"")===f)||(b={from:k,to:k+S.nodeSize})}),b};return ls(a.articleId,t,{sectionId:m}).then(w=>{let g=String(w?.storedPath||w?.url||w?.path||"").trim();if(!g)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443 \u043D\u0430 \u0444\u0430\u0439\u043B");let f=String(w?.originalName||t?.name||"\u0444\u0430\u0439\u043B"),h=y(e.state.doc,o);if(!h)return;let b=e.state.tr.insertText(f,h.from,h.to);b=b.addMark(h.from,h.from+f.length,r.create({href:g})),b=b.setMeta(de,!0),e.dispatch(b)}).catch(w=>{let g=y(e.state.doc,o);if(g){let f=`${s} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`,h=e.state.tr.insertText(f,g.from,g.to);h=h.setMeta(de,!0),e.dispatch(h)}P(w?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u043D\u0430 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A")}),!0}catch{return!1}}function Fy(e){try{if(!e||typeof e!="object")return e;let t=typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e)),n=r=>{if(!r||typeof r!="object")return;if(r.type==="image"&&r.attrs&&typeof r.attrs=="object"){let i=String(r.attrs.uploadToken||"").trim(),s=String(r.attrs.src||"");i&&s.startsWith("blob:")&&(r.attrs={...r.attrs,src:`${la}${i}`})}let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(t),t}catch{return e}}function hp(e){try{if(!e||typeof e!="object")return e;let t=typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e)),n=r=>{if(!r||typeof r!="object")return;if(r.type==="image"&&r.attrs&&typeof r.attrs=="object"){let i=String(r.attrs.uploadToken||"").trim(),s=String(r.attrs.src||"");i&&s.startsWith("blob:")&&(r.attrs={...r.attrs,src:`${la}${i}`})}let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(t),t}catch{return e}}async function zy(e){try{if(!re||re.isDestroyed)return;let t=String(e||"").trim();if(!t)return;let n=await ol({articleId:t,limit:200}).catch(()=>[]);if(!n.length)return;let r=new Map;for(let l of n){let d=String(l?.token||"").trim();d&&(l?.kind&&String(l.kind)!=="image"||l?.blob&&r.set(d,l.blob))}if(!r.size)return;let{state:o,view:i}=re,s=o.tr,c=!1;o.doc.descendants((l,d)=>{if(l?.type?.name!=="image")return;let u=String(l.attrs?.uploadToken||"").trim(),m=String(l.attrs?.src||""),y=m.startsWith(la)?m.slice(la.length).trim():"",w=u||y;if(!w)return;let g=r.get(w);if(!g)return;let f=ho.get(w)||null;if(!f)try{f=URL.createObjectURL(g),ho.set(w,f)}catch{f=null}if(!f)return;let h={...l.attrs,src:f,uploadToken:w};s=s.setNodeMarkup(d,void 0,h),c=!0}),c&&(s=s.setMeta(de,!0),i.dispatch(s))}catch{}}async function _p(e){try{if(!navigator.onLine||!re||re.isDestroyed)return!1;let t=String(e||"").trim();if(!t)return!1;let n=await ol({articleId:t,limit:50}).catch(()=>[]);if(!n.length)return!1;let r=!1;for(let o of n){let i=String(o?.token||"").trim();if(!i||o?.kind&&String(o.kind)!=="image")continue;let s=o?.blob||null;if(s)try{let c=s instanceof File?s:new File([s],o?.fileName||"image",{type:o?.mime||s.type||"application/octet-stream"}),l=await si(c),d=String(l?.url||"").trim();if(!d)throw new Error("Upload failed");try{let{state:u,view:m}=re,y=oa(u.doc,i);if(typeof y=="number"){let w=u.doc.nodeAt(y);if(w?.type?.name==="image"){let g={...w.attrs,src:d,uploadToken:null,title:String(w.attrs?.title||"").replace(/\s*\(ошибка загрузки\)\s*$/i,"").trim()},f=u.tr.setNodeMarkup(y,void 0,g);f=f.setMeta(de,!0),m.dispatch(f)}}}catch{}Np(i),await nl(i).catch(()=>{}),r=!0}catch(c){let l=c?.message||String(c||"error");await rl(i,l).catch(()=>{})}}if(r)try{yn({delayMs:350})}catch{}return r}catch{return!1}}function Cl(){try{let e=window?.localStorage?.getItem?.(vl)||"";if(!e)return null;let t=JSON.parse(e);return!t||typeof t!="object"||!Array.isArray(t.sections)?null:{mode:t.mode==="cut"?"cut":"copy",sourceArticleId:typeof t.sourceArticleId=="string"?t.sourceArticleId:null,createdAt:typeof t.createdAt=="string"?t.createdAt:null,sections:t.sections}}catch{return null}}function ia(e){try{if(!e){window?.localStorage?.removeItem?.(vl);return}window?.localStorage?.setItem?.(vl,JSON.stringify(e))}catch{}}function qo(e){Tr=!!e,Tr||(Gr=new Set);try{p?.outlineEditor&&p.outlineEditor.classList.toggle("outline-select-mode",Tr)}catch{}try{Op()}catch{}}function Uy(e){let t=String(e||"").trim();if(t){Gr.has(t)?Gr.delete(t):Gr.add(t);try{Op()}catch{}}}function Op(){if(!p?.outlineEditor)return;p.outlineEditor.querySelectorAll(".outline-heading[data-section-id] .outline-heading__select").forEach(t=>{let r=t.closest(".outline-heading")?.getAttribute?.("data-section-id")||"",o=r&&Gr.has(r);t.setAttribute("aria-checked",o?"true":"false"),t.style.display=Tr?"inline-flex":"none"})}function Vy(e,t){let n=t instanceof Set?t:new Set,r=[];if(!e||!n.size)return r;let o=(i,s)=>{let c=String(i?.attrs?.id||"").trim(),l=c&&n.has(c);if(l&&!s){r.push({id:c,node:i});return}let d=i?.childCount>=3?i.child(2):null;if(d)try{d.forEach(u=>{u?.type?.name==="outlineSection"&&o(u,s||l)})}catch{}};try{e.forEach(i=>{i?.type?.name==="outlineSection"&&o(i,!1)})}catch{}return r}function Dl(e){return JSON.parse(JSON.stringify(e))}function Rp(e,t){let n=Dl(e),r=o=>{if(!o||typeof o!="object")return;if(o.type==="outlineSection"){let s=t();o.attrs&&typeof o.attrs=="object"?o.attrs.id=s:o.attrs={id:s,collapsed:!!o.attrs?.collapsed}}let i=Array.isArray(o.content)?o.content:[];for(let s of i)r(s)};return r(n),n}async function qy(e){let t=String(e||"");if(t){try{if(navigator?.clipboard?.writeText){await navigator.clipboard.writeText(t);return}}catch{}try{let n=document.createElement("textarea");n.value=t,n.setAttribute("readonly","true"),n.style.position="fixed",n.style.left="-9999px",n.style.top="0",document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n)}catch{}}}function Hp(e,{baseLevel:t=2,depth:n=0}={}){let r=e;if(!r||r.type?.name!=="outlineSection")return"";let o="",i="";try{let l=r.child(0);o=String(l?.textContent||"").trim()}catch{o=""}try{let l=r.child(1);i=l?String(l.textBetween(0,l.content.size,`
`)).trimEnd():""}catch{i=""}let s=Math.min(6,Math.max(1,Number(t)+Number(n||0))),c=[];o&&c.push(`${"#".repeat(s)} ${o}`),i&&c.push(i);try{let l=r.child(2);if(l){let d=[];l.forEach(u=>{if(u?.type?.name!=="outlineSection")return;let m=Hp(u,{baseLevel:t,depth:n+1});m&&d.push(m)}),d.length&&c.push(d.join(`

`))}}catch{}return c.filter(Boolean).join(`

`).trim()}function $p(e,t){try{let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return 1;let o=window.localStorage.getItem(gp)||"",i=o?JSON.parse(o):{},s=i&&typeof i=="object"?i:{},c=(s[n]&&typeof s[n]=="object"?s[n]:{})||{},d=(Number(c[r]||0)||0)+1;return c[r]=d,s[n]=c,window.localStorage.setItem(gp,JSON.stringify(s)),d}catch{return Date.now()}}function Fp(e,t){try{let n=JSON.stringify({headingJson:e,bodyJson:t});return globalThis.TextEncoder?new TextEncoder().encode(n).length:n.length*2}catch{return 0}}function zo(e){try{let t=String(e||"").trim();if(!t)return;Jn.add(t);let n=Et||a.articleId||null;if(!n||a.article?.encrypted||Sl)return;Sl=setTimeout(()=>{Sl=null;try{if(!Jn.size)return;let r=Array.from(Jn);Jn.clear();let o=Date.now();Gt("delete_sections",{articleId:n,payload:{sectionIds:r,clientQueuedAt:o},coalesceKey:`delete:${n}`})}catch{}},0)}catch{}}function Ri(e){let t=[],n=o=>{try{if(!o||o.type?.name!=="outlineSection")return null;for(let i=0;i<o.childCount;i+=1){let s=o.child(i);if(s?.type?.name==="outlineChildren")return s}return null}catch{return null}},r=(o,i)=>{try{if(!o)return;let s=0;o.forEach(c=>{if(!c||c.type?.name!=="outlineSection")return;let l=String(c.attrs?.id||"").trim();if(!l)return;t.push({sectionId:l,parentId:i||null,position:s,collapsed:!!c.attrs?.collapsed}),s+=1;let d=n(c);d&&r(d,l)})}catch{}};try{if(!e)return[];r(e,null)}catch{return[]}return t}function yp(e){try{return Ri(e).map(n=>`${n.parentId||""}|${n.position}|${n.sectionId}|${n.collapsed?1:0}`).join(`
`)}catch{return""}}function Uo(e){let t=[];try{if(!e)return t;e.descendants((n,r)=>{n?.type?.name==="outlineSection"&&t.push(r)})}catch{}return t}function Bl(e,t){try{if(!e||e.isDestroyed)return!1;let n=!!t;return e.commands.command(({state:r,dispatch:o})=>{let i=Uo(r.doc);if(!i.length)return!1;let s=r.tr;for(let c of i){let l=s.doc.nodeAt(c);!l||l.type?.name!=="outlineSection"||!!l.attrs?.collapsed!==n&&(s=s.setNodeMarkup(c,void 0,{...l.attrs,collapsed:n}))}s=s.setMeta(de,!0);try{n&&be&&(be.getState(r)||{}).editingSectionId&&(s=s.setMeta(be,{type:"exit"}))}catch{}try{if(n&&TextSelection){let c=Ht(r.doc,r.selection.$from),l=typeof c=="number"?c:i[0],d=s.doc.nodeAt(l);if(d?.type?.name==="outlineSection"){let u=d.child(0),y=l+1+u.nodeSize-1;s=s.setSelection(TextSelection.near(s.doc.resolve(y),-1))}}}catch{}return o(s.scrollIntoView()),!0})}catch{return!1}}function Ky({articleId:e,editor:t}={}){try{let n=String(e||"").trim();if(!n||!t)return;cr=!0;try{if((be?.getState?.(t.state)||null)?.editingSectionId){rn&&(clearTimeout(rn),rn=null);return}}catch{}rn&&clearTimeout(rn),rn=setTimeout(()=>{rn=null;try{if(!cr)return;let r=t.state?.doc,o=Ri(r);if(!o.length)return;try{let i=null;try{i=o.filter(s=>s&&(s.parentId==null||s.parentId==="")&&Number(s.position)>=0).sort((s,c)=>Number(s.position)-Number(c.position)).slice(0,3).map(s=>String(s.sectionId||""))}catch{i=null}ht("outline.enqueue.structure_snapshot",{articleId:n,nodesCount:o.length,rootFirst:i})}catch{}Gt("structure_snapshot",{articleId:n,payload:{nodes:o},coalesceKey:`structure:${n}`}),cr=!1}catch{}},Ry)}catch{}}async function _l({articleId:e,doc:t,sectionId:n,reason:r}){let o=String(e||"").trim(),i=String(n||"").trim();if(!o||!i||!t)return!1;let s=kt(t,i),c=typeof s=="number"?t.nodeAt(s):null;if(!c||c.type?.name!=="outlineSection")return!1;try{if(!fo(t,i))return!1}catch{return!1}let l=c.child(0),d=c.child(1),u=l?.toJSON?l.toJSON():null,m=d?.toJSON?d.toJSON():null;if(!u||!m)return!1;try{u=hp(u),m=hp(m)}catch{}let y=Fp(u,m);if(y>da){let f=Date.now();return(!yl||f-yl>5e3)&&(yl=f,P(`\u0411\u043B\u043E\u043A \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 (${Math.ceil(y/1024)} KB). \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C: ${Math.ceil(da/1024)} KB. \u0420\u0430\u0437\u0431\u0435\u0439\u0442\u0435 \u0431\u043B\u043E\u043A \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E.`)),!1}let w=Date.now(),g=$p(o,i);try{ht("outline.enqueue.section_upsert_content",{articleId:o,sectionId:i,seq:g,bytes:y,reason:String(r||"")})}catch{}await Gt("section_upsert_content",{articleId:o,payload:{sectionId:i,headingJson:u,bodyJson:m,seq:g,clientQueuedAt:w},coalesceKey:`content:${o}:${i}`}).catch(()=>{});try{if(cr){let f=Ri(t);if(f.length){let h=null;try{h=f.filter(b=>b&&(b.parentId==null||b.parentId==="")&&Number(b.position)>=0).sort((b,S)=>Number(b.position)-Number(S.position)).slice(0,3).map(b=>String(b.sectionId||""))}catch{h=null}try{ht("outline.enqueue.structure_snapshot",{articleId:o,nodesCount:f.length,reason:"after_section_upsert",rootFirst:h})}catch{}Gt("structure_snapshot",{articleId:o,payload:{nodes:f},coalesceKey:`structure:${o}`})}cr=!1,rn&&(clearTimeout(rn),rn=null)}}catch{}try{go.set(i,ga(c)),yo.delete(i)}catch{}try{Promise.resolve().then(()=>(Xs(),pp)).then(f=>f.flushOutboxOnce?.()).catch(()=>{})}catch{}return!0}function jy(e){try{if(!e||e.isDestroyed)return;let t=be?.getState?.(e.state)||null,n=String(t?.editingSectionId||"").trim();if(!n)return;let r=Et||a.articleId||null;if(!r)return;Al=n,uo&&clearTimeout(uo),uo=setTimeout(()=>{uo=null;try{if(!re||re.isDestroyed)return;let o=be?.getState?.(re.state)||null,i=String(o?.editingSectionId||"").trim();if(!i||i!==Al)return;_l({articleId:r,doc:re.state.doc,sectionId:i,reason:"edit_heartbeat"})}catch{}},Hy)}catch{}}function Ll(){try{return window?.localStorage?.getItem?.(Jy)==="1"}catch{return!1}}function Rn(...e){Ll()}function lo(){try{return window?.localStorage?.getItem?.(Wy)==="1"}catch{return!1}}function Vo(e,t={}){lo()}function Gy(){try{return window?.localStorage?.getItem?.(Yy)==="1"}catch{return!1}}function en(e,t={}){Gy()}function aa(e){let t=String(e||"").replace(/\s+/g," ").trim().toLowerCase();return t?t.length>60?t.slice(0,60):t:null}function Mi(e){return String(e||"").replace(/\s+/g," ").trim().toLowerCase()}function Qy(e,t="tag"){let n=new Map,r=new Map,o=new Map,i=new Map;return e?(e.descendants((s,c)=>{if(s?.type?.name!=="outlineSection")return;let l=String(s.attrs?.id||"");l&&i.set(l,c);let d=new Set,u=m=>{m?.descendants?.(y=>{if(y?.type?.name!==t)return;let w=aa(y.attrs?.label||y.textContent||"");if(!w)return;let g=Mi(y.attrs?.key||w);g&&(n.set(g,(n.get(g)||0)+1),r.set(g,g),d.add(g))})};try{u(s.child(0)),u(s.child(1))}catch{}if(l)for(let m of d)o.has(m)||o.set(m,new Set),o.get(m).add(l);return!1}),{counts:n,labelByKey:r,sectionIdsByKey:o,sectionPosById:i}):{counts:n,labelByKey:r,sectionIdsByKey:o,sectionPosById:i}}function zp(){let e=p?.outlineTagsBar;if(!e)return;let t=Array.from(Br.counts.entries()).map(([n,r])=>({key:n,label:Br.labelByKey.get(n)||n,count:r})).filter(n=>n.key&&n.count>0).sort((n,r)=>r.count!==n.count?r.count-n.count:n.label.localeCompare(r.label));if(!t.length){e.innerHTML="",e.classList.add("hidden");return}e.classList.remove("hidden"),e.innerHTML=t.map(n=>{let r=Yr&&Yr===n.key?"true":"false",o=_i(n.label);return`<button type="button" class="outline-tag-pill" data-tag-key="${_i(n.key)}" aria-pressed="${r}">${o} <span class="outline-tag-pill__count">(${n.count})</span></button>`}).join("")}function Up(){if(re){if(Br=Qy(re.state.doc,"tag"),Yr&&!Br.counts.has(Yr)){Yr=null;try{fa?.(null)}catch{}}zp()}}function Xy(e){let t=String(e||"");if(!t||!re)return;let n=Br.sectionIdsByKey.get(t);if(!n||!n.size)return;let r=new Set;for(let s of n){let c=Br.sectionPosById.get(s);if(typeof c=="number"){r.add(c);try{let l=re.state.doc.resolve(Math.min(re.state.doc.content.size,c+1));for(let d=l.depth;d>0;d-=1)l.node(d)?.type?.name==="outlineSection"&&r.add(l.before(d))}catch{}}}let o=re.state.tr,i=!1;for(let s of r){let c=o.doc.nodeAt(s);!c||c.type?.name!=="outlineSection"||c.attrs?.collapsed&&(o=o.setNodeMarkup(s,void 0,{...c.attrs,collapsed:!1}),i=!0)}i&&(o=o.setMeta(de,!0),re.view.dispatch(o))}function Zy({setActiveTagKey:e}){let t=p?.outlineTagsBar;if(!t)return()=>{};let n=r=>{let o=r.target?.closest?.("[data-tag-key]");if(!o)return;let i=String(o.getAttribute("data-tag-key")||"");if(!i)return;let s=Yr===i?null:i;Yr=s;try{e(s)}catch{}s&&Xy(s),zp()};return t.addEventListener("click",n),()=>t.removeEventListener("click",n)}function Hn(e){let t=String(e||"").trim();if(!t.includes("|"))return null;let n=t;n.startsWith("|")&&(n=n.slice(1)),n.endsWith("|")&&(n=n.slice(0,-1));let r=n.split("|").map(o=>o.trim());return r.length<2||r.every(o=>!o)?null:r}function pa(e){let t=String(e||"").trim();return t?/^:?-{3,}:?$/.test(t):!1}function po(e){let t=(Array.isArray(e)?e:[]).map(i=>String(i||"").replace(/\r/g,"").trimEnd()).filter(i=>i.length>0);if(t.length<2)return null;let n=Hn(t[0]),r=Hn(t[1]);if(!n||!r||n.length!==r.length||!r.every(pa))return null;let o=[];for(let i=2;i<t.length;i+=1){let s=Hn(t[i]);if(!s||s.length!==n.length)return null;o.push(s)}return{header:n,rows:o}}function mo(e){let t=(Array.isArray(e)?e:[]).map(s=>String(s||"").replace(/\r/g,"").trimEnd()).filter(s=>s.length>0);if(t.length<1)return null;let n=Hn(t[0]);if(!n)return null;let r=n.length;if(r<2)return null;let o=[n];for(let s=1;s<t.length;s+=1){let c=Hn(t[s]);if(!c||c.length!==r)break;if(s===1&&c.every(pa))return null;o.push(c)}return o.flat().filter(s=>String(s||"").trim().length>0).length<2?null:{rows:o}}function Ol(e){let t=String(e||"").replace(/\r/g,"").split(`
`).map(n=>String(n||"").trimEnd());for(;t.length&&!t[0].trim();)t.shift();for(;t.length&&!t[t.length-1].trim();)t.pop();return t}function Jr(e,t){if(!e||!t)return null;let{header:n,rows:r,withHeader:o}=t,i=e.nodes.table,s=e.nodes.tableRow,c=e.nodes.tableCell,l=e.nodes.tableHeader,d=e.nodes.paragraph;if(!i||!s||!c||!l||!d||typeof e.text!="function")return null;let u=g=>d.create({},g?[e.text(String(g))]:[]),m=(g,f)=>g.map(h=>(f?l:c).create({},[u(h)])),y=(g,f)=>s.create({},m(g,f)),w=[];return o&&Array.isArray(n)&&n.length&&w.push(y(n,!0)),(Array.isArray(r)?r:[]).forEach(g=>w.push(y(g,!1))),w.length?i.create({},w):null}function eb(e,t){try{let n=e?.selection,r=n?.$from;if(!n?.empty||!r)return nt("table.merge.skip",{reason:"no-cursor"}),!1;if(r.parent?.type?.name!=="paragraph")return!1;if(r.parentOffset!==0)return nt("table.merge.skip",{reason:"not-at-paragraph-start"}),!1;let o=null,i=null,s=null;for(let te=r.depth;te>0;te-=1){let he=r.node(te)?.type?.name;if(!s&&(he==="tableCell"||he==="tableHeader")?s=te:!i&&he==="tableRow"?i=te:!o&&he==="table"&&(o=te),o&&i&&s)break}if(o==null||i==null||s==null)return nt("table.merge.skip",{reason:"not-in-table"}),!1;let c=r.depth===s+1,l=r.index(o),d=r.index(i),u=r.index(s);if(nt("table.merge.check",{parent:r.parent?.type?.name||null,parentOffset:r.parentOffset,tableDepth:o,rowDepth:i,cellDepth:s,isDirectParagraphInCell:c,rowIndex:l,colIndex:d,childIndexInCell:u}),!c)return nt("table.merge.skip",{reason:"paragraph-not-direct-child-of-cell"}),!1;if(l!==0||d!==0||u!==0)return nt("table.merge.skip",{reason:"not-in-first-cell",rowIndex:l,colIndex:d,childIndexInCell:u}),!1;let m=r.before(o),y=e.doc.nodeAt(m);if(!y||y.type?.name!=="table")return nt("table.merge.skip",{reason:"no-current-table",tablePos:m}),!1;let w=e.doc.resolve(m),g=w.index(),f=w.parent;if(!f||g<=0)return nt("table.merge.skip",{reason:"no-prev-sibling",idx:g,parent:f?.type?.name||null}),!1;let h=null,b=g-1;for(;b>=0;){let te=f.child(b);if(te?.type?.name==="paragraph"&&!String(te.textContent||"").trim()){b-=1;continue}h=te;break}if(!h||h.type?.name!=="table")return nt("table.merge.skip",{reason:"no-prev-table"}),!1;let S=h.childCount?h.child(0):null,k=y.childCount?y.child(0):null;if(!S||!k)return nt("table.merge.skip",{reason:"missing-rows"}),!1;if(S.childCount!==k.childCount)return nt("table.merge.skip",{reason:"different-columns",prevCols:S.childCount,curCols:k.childCount}),!1;let A=S.childCount,v=(te,he)=>{try{return te?.type?.name==="tableRow"&&te.childCount===he}catch{return!1}};for(let te=0;te<h.childCount;te+=1){let he=h.child(te);if(!v(he,A))return nt("table.merge.skip",{reason:"prev-row-mismatch",rowIndex:te,colsExpected:A,colsGot:he?.childCount??null}),!1}for(let te=0;te<y.childCount;te+=1){let he=y.child(te);if(!v(he,A))return nt("table.merge.skip",{reason:"cur-row-mismatch",rowIndex:te,colsExpected:A,colsGot:he?.childCount??null}),!1}let B=m;for(let te=g-1;te>=b;te-=1)B-=f.child(te).nodeSize;let H=h.childCount,O=e.doc.type.schema,W=B+h.nodeSize,J=e.tr;m>W&&(J=J.delete(W,m));let ne=W;J=J.delete(ne,ne+y.nodeSize);let me=J.doc.nodeAt(B);if(!me||me.type?.name!=="table")return nt("table.merge.skip",{reason:"prev-after-missing",prevStart:B,prevAfterType:me?.type?.name||null}),!1;nt("table.merge.plan",{idx:g,prevIdx:b,prevStart:B,prevEnd:W,tablePos:m,tablePos2:ne,cols:A,prevRowCount:H,curRowCount:y.childCount});try{let te=me.content.append(y.content),he=O.nodes.table.create(me.attrs,te,me.marks);J=J.replaceWith(B,B+me.nodeSize,he)}catch(te){return nt("table.merge.error",{message:String(te?.message||te||""),stack:String(te?.stack||"")}),!1}let we=J.doc.nodeAt(B);nt("table.merge.afterReplace",{mergedType:we?.type?.name||null,mergedRows:we?.type?.name==="table"?we.childCount:null});try{let te=ze?.pmStateMod?.TextSelection||ze?.pm?.state?.TextSelection||null;if(we&&we.type?.name==="table"){let he=Math.min(H,Math.max(0,we.childCount-1));if(we.child(he)?.childCount){let vt=(()=>{let $e=B+1;for(let at=0;at<he;at+=1)$e+=we.child(at).nodeSize;return $e+=1,$e})(),Mt=Math.min(J.doc.content.size,vt+2);te&&(J=J.setSelection(te.near(J.doc.resolve(Mt),1)))}}}catch(te){nt("table.merge.selection.error",{message:String(te?.message||te||""),stack:String(te?.stack||"")})}J=J.setMeta(de,!0);try{t(J.scrollIntoView())}catch(te){return nt("table.merge.dispatch.error",{message:String(te?.message||te||""),stack:String(te?.stack||"")}),!1}return!0}catch(n){try{nt("table.merge.exception",{message:String(n?.message||n||""),stack:String(n?.stack||"")})}catch{}return!1}}function tb(e,t,n,r){try{let o=(he,Je={})=>{},i=(he={})=>{};if(!n)return!1;if(!r)return o("no-TextSelection"),!1;let s=e?.selection;if(!s?.empty)return o("selection-not-empty"),!1;let c=s.$from||null;if(!c)return o("no-$from"),!1;i({from:s.from,parent:c.parent?.type?.name||null,parentOffset:c.parentOffset??null});let l=kt(e.doc,n);if(typeof l!="number")return o("section-not-found"),!1;let d=e.doc.nodeAt(l);if(!d||d.type?.name!=="outlineSection")return o("not-outlineSection",{found:d?.type?.name||null}),!1;let u=d.child(0),m=d.child(1);if(!u||u.type?.name!=="outlineHeading")return o("missing-heading",{found:u?.type?.name||null}),!1;if(!m||m.type?.name!=="outlineBody")return o("missing-body",{found:m?.type?.name||null}),!1;let y=String(u.textContent||"").replace(/\u00a0/g," "),w=!!y.trim(),g=/\s$/.test(y),f=null;for(let he=c.depth;he>=0;he-=1)if(c.node(he)?.type?.name==="outlineBody"){f=he;break}if(f==null)return o("not-in-outlineBody",{parent:c.parent?.type?.name||null}),!1;if(c.index(f)!==0)return o("not-first-body-child",{index:c.index(f)}),!1;if(c.parent?.type?.name!=="paragraph")return o("parent-not-paragraph",{parent:c.parent?.type?.name||null}),!1;if((c.parentOffset??null)!==0)return o("not-at-paragraph-start",{parentOffset:c.parentOffset??null}),!1;let h=l+1,b=s.from,S=c.parent,k=0,A=null;for(let he=0;he<S.childCount;he+=1){let Je=S.child(he);if(Je.type?.name==="hardBreak"){A=k;break}k+=Je.nodeSize}let v=b+(A??S.content.size);if(v<=b)return o("empty-first-line"),!1;let B=e.doc.slice(b,v);if(!B?.content||B.content.size<=0)return o("empty-slice"),!1;let H=A==null?v:v+1,O=h+1,W=h+u.nodeSize-1,J=e.tr;w&&!g&&(J=J.insertText(" ",W),J=J.setMeta(de,!0));let ne=J.mapping.map(W,1),me=ne;J=J.insert(ne,B.content);let we=J.mapping.map(b,1),te=J.mapping.map(H,-1);J=J.delete(we,te);try{J=J.setSelection(r.create(J.doc,me))}catch{}return J=J.setMeta(de,!0),t(J.scrollIntoView()),!0}catch(o){return!1}}function nb(e,t){try{if(!e?.doc||!t)return null;let n=kt(e.doc,t);if(typeof n!="number")return null;let r=e.doc.nodeAt(n);if(!r)return null;let o=r.child(0),i=r.child(1);if(!i||i.type?.name!=="outlineBody")return null;let c=n+1+o.nodeSize+1,l=[],d=0,u=0;for(;u<i.childCount;){let y=i.child(u),w=c+d;if(y.type?.name!=="paragraph"){d+=y.nodeSize,u+=1;continue}let g=Wr(y).trim();if(g.includes(`
`)&&g.includes("|")){let J=Ol(g),ne=po(J),me=ne?null:mo(J),we=ne?{header:ne.header,rows:ne.rows,withHeader:!0}:me?{header:null,rows:me.rows,withHeader:!1}:null,te=null;if(we)try{te=Jr(e.schema,we)}catch(he){Rn("convert: buildTableNode error (single)",{message:String(he?.message||he||""),stack:String(he?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),te=null}if(te){let he=w,Je=w+y.nodeSize;l.push({from:he,to:Je,tableNode:te}),Rn("convert: single-paragraph table",{sectionId:t,from:he,to:Je,lines:J}),d+=y.nodeSize,u+=1;continue}}let f=Hn(g);if(!f||u+1>=i.childCount){if(f){let J=[g],ne=d+y.nodeSize,me=u+1;for(;me<i.childCount;){let Je=i.child(me);if(Je.type?.name!=="paragraph")break;let vt=Wr(Je).trim();if(!vt)break;let Mt=Hn(vt);if(!Mt||Mt.length!==f.length)break;J.push(vt),ne+=Je.nodeSize,me+=1}let we=mo(J),te=we?{header:null,rows:we.rows,withHeader:!1}:null,he=null;if(te)try{he=Jr(e.schema,te)}catch(Je){Rn("convert: buildTableNode error (rows-only)",{message:String(Je?.message||Je||""),stack:String(Je?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),he=null}if(he){l.push({from:w,to:c+ne,tableNode:he}),Rn("convert: rows-only table",{sectionId:t,from:w,to:c+ne,lines:J}),d=ne,u=me;continue}}d+=y.nodeSize,u+=1;continue}let h=i.child(u+1);if(h.type?.name!=="paragraph"){d+=y.nodeSize,u+=1;continue}let b=Wr(h).trim(),S=Hn(b);if(!S||S.length!==f.length||!S.every(pa)){d+=y.nodeSize,u+=1;continue}let k=[g,b],A=d+y.nodeSize+h.nodeSize,v=u+2;for(;v<i.childCount;){let J=i.child(v);if(J.type?.name!=="paragraph")break;let ne=Wr(J).trim();if(!ne)break;let me=Hn(ne);if(!me||me.length!==f.length)break;k.push(ne),A+=J.nodeSize,v+=1}let B=po(k),H=B?null:mo(k),O=B?{header:B.header,rows:B.rows,withHeader:!0}:H?{header:null,rows:H.rows,withHeader:!1}:null,W=null;if(O)try{W=Jr(e.schema,O)}catch(J){Rn("convert: buildTableNode error (multi)",{message:String(J?.message||J||""),stack:String(J?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),W=null}if(!W){d+=y.nodeSize,u+=1;continue}l.push({from:w,to:c+A,tableNode:W}),Rn("convert: multi-paragraph table",{sectionId:t,from:w,to:c+A,lines:k}),d=A,u=v}if(!l.length)return null;l.sort((y,w)=>w.from-y.from);let m=e.tr;for(let y of l)m=m.replaceRangeWith(y.from,y.to,y.tableNode);return m=m.setMeta(de,!0),m}catch{return null}}function Wr(e){if(!e)return"";let t="";return e.descendants(n=>{n.isText?t+=n.text||"":n.type?.name==="hardBreak"&&(t+=`
`)}),t}function wp(e){try{if(!e||e.type!=="paragraph")return"";let t=[],n=r=>{if(!r)return;if(r.type==="text"){t.push(String(r.text||""));return}if(r.type==="hardBreak"){t.push(`
`);return}let o=Array.isArray(r.content)?r.content:[];for(let i of o)n(i)};return n(e),t.join("")}catch{return""}}function rb(e){if(!e)return null;let{header:t,rows:n}=e;if(!Array.isArray(t)||t.length===0)return null;let r=s=>({type:"paragraph",content:String(s||"").length?[{type:"text",text:String(s||"")}]:[]}),o={type:"tableRow",content:t.map(s=>({type:"tableHeader",content:[r(s)]}))},i=(Array.isArray(n)?n:[]).map(s=>({type:"tableRow",content:s.map(c=>({type:"tableCell",content:[r(c)]}))}));return{type:"table",content:[o,...i]}}function ob(e){if(!e)return!1;try{let{doc:t,schema:n}=e.state,r=[];if(t.descendants((i,s)=>{if(i.type?.name!=="outlineBody")return;let c=s+1,l=0,d=0;for(;d<i.childCount;){let u=i.child(d),m=c+l;if(u.type?.name!=="paragraph"){l+=u.nodeSize,d+=1;continue}let y=Wr(u).trim();if(y.includes(`
`)&&y.includes("|")){let H=Ol(y),O=po(H),W=O?null:mo(H),J=O?{header:O.header,rows:O.rows,withHeader:!0}:W?{header:null,rows:W.rows,withHeader:!1}:null,ne=J?Jr(n,J):null;if(ne){r.push({from:m,to:m+u.nodeSize,tableNode:ne}),l+=u.nodeSize,d+=1;continue}}let w=Hn(y);if(!w){l+=u.nodeSize,d+=1;continue}if(d+1>=i.childCount){let H=mo([y]),O=H?{header:null,rows:H.rows,withHeader:!1}:null,W=O?Jr(n,O):null;W&&r.push({from:m,to:m+u.nodeSize,tableNode:W}),l+=u.nodeSize,d+=1;continue}let g=i.child(d+1);if(g.type?.name!=="paragraph"){l+=u.nodeSize,d+=1;continue}let f=Wr(g).trim(),h=Hn(f);if(!h||h.length!==w.length||!h.every(pa)){let H=[y],O=l+u.nodeSize,W=d+1;for(;W<i.childCount;){let we=i.child(W);if(we.type?.name!=="paragraph")break;let te=Wr(we).trim();if(!te)break;let he=Hn(te);if(!he||he.length!==w.length)break;H.push(te),O+=we.nodeSize,W+=1}let J=mo(H),ne=J?{header:null,rows:J.rows,withHeader:!1}:null,me=ne?Jr(n,ne):null;if(me){r.push({from:m,to:c+O,tableNode:me}),l=O,d=W;continue}l+=u.nodeSize,d+=1;continue}let b=[y,f],S=l+u.nodeSize+g.nodeSize,k=d+2;for(;k<i.childCount;){let H=i.child(k);if(H.type?.name!=="paragraph")break;let O=Wr(H).trim();if(!O)break;let W=Hn(O);if(!W||W.length!==w.length)break;b.push(O),S+=H.nodeSize,k+=1}let A=po(b),v=A?{header:A.header,rows:A.rows,withHeader:!0}:null,B=v?Jr(n,v):null;if(!B){l+=u.nodeSize,d+=1;continue}r.push({from:m,to:c+S,tableNode:B}),l=S,d=k}}),!r.length)return!1;r.sort((i,s)=>s.from-i.from);let o=e.state.tr;for(let i of r)o=o.replaceRangeWith(i.from,i.to,i.tableNode);return o=o.setMeta(de,!0),e.view.dispatch(o),!0}catch{return!1}}function gr(){let e=Date.now();if(!(e-bp<900)){bp=e;try{P("\u0414\u043B\u044F \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Enter \u0438\u043B\u0438 \u0434\u0432\u043E\u0439\u043D\u043E\u0439 \u043A\u043B\u0438\u043A \u043C\u044B\u0448\u043A\u043E\u0439. Esc \u0434\u043B\u044F \u0432\u044B\u0445\u043E\u0434\u0430.")}catch{}}}function Ml(e=""){let t=document.createElement("div");return t.innerHTML=e||"",(t.textContent||"").replace(/\u00a0/g," ").trim()}function vr(e=""){return String(e||"").replace(/\u00a0/g," ").replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}function Nl(e=""){let t=String(e||""),n=0;for(let r=0;r<t.length;r+=1)n=n*31+t.charCodeAt(r)>>>0;return String(n)}function Fo(e=""){return Nl(String(e||"").slice(0,12e3))}function fn(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`sec-${Date.now()}-${Math.random().toString(16).slice(2)}`}function Vp({loading:e=!1}={}){p.outlineEditor&&(p.outlineEditor.innerHTML=`
    <div class="outline-editor__body">
      <div class="outline-editor__content" id="outlineEditorContent"></div>
      <div class="outline-editor__loading ${e?"":"hidden"}">\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440\u2026</div>
    </div>
  `,kl||(kl=!0))}function qp(e){let t=String(e||"").trim();if(!t)return null;let n=t.match(/(-?\d+(?:\.\d+)?)%/);if(!n)return null;let r=Number.parseFloat(n[1]);return Number.isFinite(r)?r:null}function lr(e){let t=Number(e);return Number.isFinite(t)?Math.max(0,Math.min(100,t)):0}function Kp(e){try{let t=e?.dataset?.ttPct||"",n=Number.parseFloat(String(t||""));if(Number.isFinite(n)&&n>0)return n;let r=qp(e?.style?.width||"");return r!=null&&r>0?r:null}catch{return null}}function ma(e,t){try{let n=lr(t);return e.dataset.ttPct=n.toFixed(4),e.style.width=`${n.toFixed(4)}%`,e.style.minWidth="",!0}catch{return!1}}function ua(e,{insertIndex:t,newColPct:n=10}={}){try{let r=e?.view;if(!r)return!1;let o=Number(t);if(!Number.isFinite(o)||o<0)return!1;let i=r.domAtPos(r.state.selection.from),c=((i?.node&&i.node.nodeType===1?i.node:i?.node?.parentElement)||null)?.closest?.("table")||null;if(!c)return!1;let l=c.querySelector("colgroup");if(!l)return!1;let d=Array.from(l.querySelectorAll("col"));if(!d.length||o>=d.length)return!1;let u=100/d.length,m=d.map(A=>Kp(A)??u),y=lr(n);m[o]=y;let w=o-1,g=w>=0?m.slice(0,w+1).reduce((A,v)=>A+v,0):0,f=o+1,h=Math.max(0,d.length-f),b=h>0?m.slice(f).reduce((A,v)=>A+v,0):0,S=100-g-y;if(S<0){let A=Math.max(0,o-1),v=Math.max(0,m[A]-1),B=Math.abs(S),H=Math.min(v,B);m[A]=Math.max(1,m[A]-H),S=100-m.slice(0,w+1).reduce((O,W)=>O+W,0)-y,S=Math.max(0,S)}if(h>0)if(b>0){let A=S/b;for(let v=f;v<d.length;v+=1)m[v]*=A}else{let A=S/h;for(let v=f;v<d.length;v+=1)m[v]=A}let k=m.reduce((A,v)=>A+v,0);if(k>0&&Math.abs(k-100)>.01){let A=100-k,v=d.length-1;m[v]=lr(m[v]+A),k=m.reduce((B,H)=>B+H,0)}for(let A=0;A<d.length;A+=1)ma(d[A],m[A]);try{c.style.width="100%",c.style.maxWidth="100%",c.style.tableLayout="fixed"}catch{}return!0}catch{return!1}}function ca(e){try{if(!e)return!1;let t=e.querySelector("colgroup");if(!t)return!1;let n=Array.from(t.querySelectorAll("col"));if(!n.length)return!1;let r=e.getBoundingClientRect();if(!Number.isFinite(r.width)||r.width<=0)return!1;let o=e.querySelector("tbody tr");if(!o)return!1;let i=Array.from(o.children||[]).filter(l=>l&&l.nodeType===1);if(!i.length)return!1;let s=[];for(let l=0;l<n.length;l+=1){let d=i[l]||null;if(!d){s.push(0);continue}let u=d.getBoundingClientRect();s.push(Number.isFinite(u.width)?u.width:0)}let c=s.reduce((l,d)=>l+(Number.isFinite(d)?d:0),0);if(!(c>0))return!1;for(let l=0;l<n.length;l+=1){let d=lr(s[l]/c*100);ma(n[l],d)}return!0}catch{return!1}}function kn(e){try{if(!e?.state?.selection)return null;let t=e.state.selection;try{let o=t?.$anchorCell?.pos,i=t?.$headCell?.pos,s=Number.isFinite(o)?o:Number.isFinite(i)?i:null;if(s!=null){let c=e.nodeDOM?.(s)||null;if(c&&c.nodeType===1)return c.closest?.("table")||null}}catch{}let n=e.domAtPos(t.from);return((n?.node&&n.node.nodeType===1?n.node:n?.node?.parentElement)||null)?.closest?.("table")||null}catch{return null}}function ib(e){try{let t=e?.state?.selection||null,n=t?.$from||null;if(!n)return null;try{let s=t?.$anchorCell?.pos,c=t?.$headCell?.pos,l=Number.isFinite(s)?s:Number.isFinite(c)?c:null;if(l!=null){let d=e.nodeDOM?.(l)||null;if(d&&d.nodeType===1)return d}}catch{}let r=null;for(let s=n.depth;s>=0;s-=1){let c=n.node(s)?.type?.name;if(c==="tableCell"||c==="tableHeader"){r=s;break}}if(r!=null){let s=n.before(r),c=e.nodeDOM?.(s)||null;if(c&&c.nodeType===1)return c}let o=e.domAtPos(t.from);return((o?.node&&o.node.nodeType===1?o.node:o?.node?.parentElement)||null)?.closest?.("td,th")||null}catch{return null}}function jo(e){try{if(!e)return null;let t=e.querySelector("colgroup");if(!t)return null;let n=Array.from(t.querySelectorAll("col"));if(!n.length)return null;let r=n.map(d=>Kp(d));if(r.some(d=>typeof d=="number"&&Number.isFinite(d)&&d>0)){let d=100/n.length;return r.map(u=>typeof u=="number"&&Number.isFinite(u)&&u>0?u:d)}let i=e.querySelector("tbody tr");if(!i)return null;let s=Array.from(i.children||[]).filter(d=>d&&d.nodeType===1);if(s.length<n.length)return null;let c=[];for(let d=0;d<n.length;d+=1){let u=s[d].getBoundingClientRect();c.push(Number.isFinite(u.width)?u.width:0)}let l=c.reduce((d,u)=>d+(Number.isFinite(u)?u:0),0);return l>0?c.map(d=>lr(d/l*100)):null}catch{return null}}function Jo(e,t){try{if(!e)return!1;let n=e.querySelector("colgroup");if(!n)return!1;let r=Array.from(n.querySelectorAll("col"));if(!r.length||!Array.isArray(t)||t.length!==r.length)return!1;for(let o=0;o<r.length;o+=1)ma(r[o],t[o]);try{e.style.width="100%",e.style.maxWidth="100%",e.style.tableLayout="fixed"}catch{}return!0}catch{return!1}}function jp(e,t){try{let n=Array.isArray(e)?e.map(m=>Number(m)||0):null,r=Number(t);if(!n||!Number.isFinite(r)||r<0||r>=n.length||n.length<=1)return null;let o=Math.max(0,n[r]||0),i=n.slice(0,r),s=n.slice(r+1),c=s.reduce((m,y)=>m+(Number.isFinite(y)?y:0),0),l=s;if(s.length)if(c>0){let m=(c+o)/c;l=s.map(y=>Number.isFinite(y)?y*m:0)}else{let m=(o||0)/s.length;l=s.map(()=>m)}else i.length&&(i[i.length-1]=Math.max(1,(i[i.length-1]||0)+o));let d=[...i,...l].map(m=>lr(m)),u=d.reduce((m,y)=>m+(Number.isFinite(y)?y:0),0);return u>0&&Math.abs(u-100)>.01&&(d[d.length-1]=lr(d[d.length-1]+(100-u))),d}catch{return null}}function on(e){try{let t=Ot?.TableMap||null,n=e?.selection||null,r=n?.$from||null,i=n?.$anchorCell||null||r||null;if(!i)return null;let s=null;for(let h=i.depth;h>=0;h-=1)if(i.node(h)?.type?.name==="table"){s=h;break}if(s==null)return null;let c=i.before(s),l=e.doc.nodeAt(c);if(!l||l.type?.name!=="table")return null;let d=null;for(let h=s+1;h<=i.depth;h+=1){let b=i.node(h)?.type?.name;if(b==="tableCell"||b==="tableHeader"){d=h;break}}if(d==null)return null;let u=i.before(d),m=t?.get?t.get(l):null;if(!m)return null;let y=u-c-1,w=m.findCell(y),g=Number(w?.left??0),f=Number(w?.top??0);return{tablePos:c,tableNode:l,map:m,colIndex:g,rowIndex:f}}catch{return null}}function xl(e){try{let t=[],n=e?.selection,r=e?.doc;if(!n||!r)return t;try{r.nodesBetween(n.from,n.to,(i,s)=>{let c=i?.type?.name;(c==="tableCell"||c==="tableHeader")&&t.push({node:i,pos:s})})}catch{}if(!t.length)try{let i=n.$from||null;if(i)for(let s=i.depth;s>=0;s-=1){let c=i.node(s)?.type?.name;if(c==="tableCell"||c==="tableHeader"){let l=i.before(s),d=r.nodeAt(l);d&&t.push({node:d,pos:l});break}}}catch{}let o=new Map;for(let i of t){let s=Number(i?.pos);Number.isFinite(s)&&(o.has(s)||o.set(s,i))}return Array.from(o.values()).sort((i,s)=>Number(i.pos)-Number(s.pos))}catch{return[]}}function sb(e,t){try{let n=Ot?.CellSelection||null,r=Ot?.TableMap||null;return!n||!r?!1:e.commands.command(({state:o,dispatch:i})=>{let s=on(o);if(!s)return!1;let{tablePos:c,tableNode:l,map:d}=s,u=Number(t);if(!Number.isFinite(u)||u<0||u>=d.height)return!1;let m=d.positionAt(u,0,l),y=d.positionAt(u,d.width-1,l),w=c+1+m,g=c+1+y,f=null;try{typeof n.create=="function"&&(f=n.create(o.doc,w,g))}catch{f=null}if(!f)return!1;let h=o.tr.setSelection(f);return h=h.setMeta(de,!0),i(h.scrollIntoView()),!0})}catch{return!1}}function ab(e,t,n){try{let r=Ot?.CellSelection||null,o=Ot?.TableMap||null;if(!r||!o)return!1;let i=Number(t),s=Number(n);return!Number.isFinite(i)||i<0||!Number.isFinite(s)||s<0?!1:e.commands.command(({state:c,dispatch:l})=>{let d=c?.doc?.nodeAt?.(i)||null;if(!d||d.type?.name!=="table")return!1;let u=o?.get?o.get(d):null;if(!u||s>=u.height)return!1;let m=u.positionAt(s,0,d),y=u.positionAt(s,u.width-1,d),w=i+1+m,g=i+1+y,f=null;try{typeof r.create=="function"&&(f=r.create(c.doc,w,g))}catch{f=null}if(!f)return!1;let h=c.tr.setSelection(f);return h=h.setMeta(de,!0),l(h.scrollIntoView()),!0})}catch{return!1}}function cb(e,t){try{let n=Ot?.CellSelection||null,r=Ot?.TableMap||null;return!n||!r?!1:e.commands.command(({state:o,dispatch:i})=>{let s=on(o);if(!s)return!1;let{tablePos:c,tableNode:l,map:d}=s,u=Number(t);if(!Number.isFinite(u)||u<0||u>=d.width)return!1;let m=d.positionAt(0,u,l),y=d.positionAt(d.height-1,u,l),w=c+1+m,g=c+1+y,f=null;try{typeof n.create=="function"&&(f=n.create(o.doc,w,g))}catch{f=null}if(!f)return!1;let h=o.tr.setSelection(f);return h=h.setMeta(de,!0),i(h.scrollIntoView()),!0})}catch{return!1}}function lb(e,t,n){try{let r=Ot?.CellSelection||null,o=Ot?.TableMap||null;if(!r||!o)return!1;let i=Number(t),s=Number(n);return!Number.isFinite(i)||i<0||!Number.isFinite(s)||s<0?!1:e.commands.command(({state:c,dispatch:l})=>{let d=c?.doc?.nodeAt?.(i)||null;if(!d||d.type?.name!=="table")return!1;let u=o?.get?o.get(d):null;if(!u||s>=u.width)return!1;let m=u.positionAt(0,s,d),y=u.positionAt(u.height-1,s,d),w=i+1+m,g=i+1+y,f=null;try{typeof r.create=="function"&&(f=r.create(c.doc,w,g))}catch{f=null}if(!f)return!1;let h=c.tr.setSelection(f);return h=h.setMeta(de,!0),l(h.scrollIntoView()),!0})}catch{return!1}}function db({pmState:e,dispatch:t},{tablePos:n,rowIndex:r,attr:o,value:i}){try{let s=Ot?.CellSelection||null,c=Ot?.TableMap||null;if(!c)return!1;let l=Number(n),d=Number(r);if(!Number.isFinite(l)||l<0||!Number.isFinite(d)||d<0)return!1;let u=e?.doc?.nodeAt?.(l)||null;if(!u||u.type?.name!=="table")return!1;let m=c?.get?c.get(u):null;if(!m||d>=m.height)return!1;let y=e.tr;try{if(s?.create){let f=m.positionAt(d,0,u),h=m.positionAt(d,m.width-1,u),b=l+1+f,S=l+1+h;y=y.setSelection(s.create(y.doc,b,S))}}catch{}let w=new Set;for(let f=0;f<m.width;f+=1){let h=m.map[d*m.width+f];Number.isFinite(h)&&w.add(l+1+h)}if(!w.size)return!1;let g=!1;for(let f of w){let h=y.doc.nodeAt(f),b=h?.type?.name;if(b!=="tableCell"&&b!=="tableHeader")continue;let S={...h.attrs||{}};i==null||i===""?delete S[o]:S[o]=i,y=y.setNodeMarkup(f,void 0,S),g=!0}return g?(y=y.setMeta(de,!0),t(y),!0):!1}catch{return!1}}function ub({pmState:e,dispatch:t},{tablePos:n,colIndex:r,attr:o,value:i}){try{let s=Ot?.CellSelection||null,c=Ot?.TableMap||null;if(!c)return!1;let l=Number(n),d=Number(r);if(!Number.isFinite(l)||l<0||!Number.isFinite(d)||d<0)return!1;let u=e?.doc?.nodeAt?.(l)||null;if(!u||u.type?.name!=="table")return!1;let m=c?.get?c.get(u):null;if(!m||d>=m.width)return!1;let y=e.tr;try{if(s?.create){let f=m.positionAt(0,d,u),h=m.positionAt(m.height-1,d,u),b=l+1+f,S=l+1+h;y=y.setSelection(s.create(y.doc,b,S))}}catch{}let w=new Set;for(let f=0;f<m.height;f+=1){let h=m.map[f*m.width+d];Number.isFinite(h)&&w.add(l+1+h)}if(!w.size)return!1;let g=!1;for(let f of w){let h=y.doc.nodeAt(f),b=h?.type?.name;if(b!=="tableCell"&&b!=="tableHeader")continue;let S={...h.attrs||{}};i==null||i===""?delete S[o]:S[o]=i,y=y.setNodeMarkup(f,void 0,S),g=!0}return g?(y=y.setMeta(de,!0),t(y),!0):!1}catch{return!1}}function ha(e,t="\u0442\u0430\u0431\u043B\u0438\u0446\u044B"){try{let n=!1;return e.descendants(r=>{if(n)return!1;let o=r?.type?.name;if(o==="tableCell"||o==="tableHeader"){let i=Number(r.attrs?.colspan||1),s=Number(r.attrs?.rowspan||1);if(i!==1||s!==1)return n=!0,!1}return!0}),n?(P(`\u041F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 ${t} \u043F\u043E\u043A\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u0445 \u044F\u0447\u0435\u0435\u043A`),!1):!0}catch{return!1}}function Jp(e,{kind:t,fromIndex:n,toIndex:r}){try{if(!e||!(Ot?.TableMap||null))return!0;let i=e.map||null,s=e.tableNode||null;if(!i||!s)return!0;let c=Number(n),l=Number(r);if(!Number.isFinite(c)||!Number.isFinite(l))return!0;let d=t==="row"?Math.max(0,Math.min(i.height-1,c)):Math.max(0,Math.min(i.width-1,c)),u=t==="row"?Math.max(0,Math.min(i.height-1,l)):Math.max(0,Math.min(i.width-1,l)),m=new Set;for(let y of i.map){let w=Number(y);if(!Number.isFinite(w)||w<0||m.has(w))continue;m.add(w);let g=null;try{g=i.findCell(w)}catch{g=null}if(!g)continue;let f=Number(g.right)-Number(g.left),h=Number(g.bottom)-Number(g.top);if(f>1||h>1)if(t==="col"){let b=Number(g.left),S=Number(g.right);if(b<=d&&d<S||b<=u&&u<S)return!0}else{let b=Number(g.top),S=Number(g.bottom);if(b<=d&&d<S||b<=u&&u<S)return!0}}return!1}catch{return!0}}function Sp(e,t){try{if(!e?.view)return!1;let n=on(e.state);if(!n)return!1;let{colIndex:r}=n,o=n.map?.width||0;if(!(o>0))return!1;let i=t<0?-1:1,s=r+i;return s>=0&&s<o?Wp(e,r,s):!1}catch{return!1}}function xp(e,t){try{if(!e?.view)return!1;let n=on(e.state);if(!n)return!1;let{rowIndex:r}=n,o=n.map?.height||0;if(!(o>0))return!1;let i=t<0?-1:1,s=r+i;return s>=0&&s<o?Yp(e,r,s):!1}catch{return!1}}function Wp(e,t,n){try{if(!e?.view)return!1;let r=e.state,o=on(r);if(!o)return!1;let{tableNode:i}=o,s=o.map?.width||0;if(!(s>0))return!1;let c=Number(t),l=Number(n);if(!Number.isFinite(c)||!Number.isFinite(l)||c<0||c>=s||l<0||l>=s)return!1;if(c===l)return!0;if(Jp(o,{kind:"col",fromIndex:c,toIndex:l}))return P("\u041D\u0435\u043B\u044C\u0437\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u043E\u043B\u0431\u0435\u0446: \u0438\u0441\u0445\u043E\u0434\u043D\u0430\u044F \u0438\u043B\u0438 \u0446\u0435\u043B\u0435\u0432\u0430\u044F \u043A\u043E\u043B\u043E\u043D\u043A\u0430 \u043F\u0435\u0440\u0435\u0441\u0435\u043A\u0430\u0435\u0442\u0441\u044F \u0441 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u043C\u0438 \u044F\u0447\u0435\u0439\u043A\u0430\u043C\u0438"),!1;let d=kn(e.view),u=jo(d),m=Array.isArray(u)&&u.length===s?(()=>{let f=u.slice(),h=f.splice(c,1)[0];return f.splice(l,0,h),f})():null,y=Ot?.moveTableColumn||null;if(typeof y!="function")return!1;let w=y({from:c,to:l,select:!0});return e.commands.command(({state:f,dispatch:h})=>w(f,typeof h=="function"?S=>{try{S=S.setMeta(de,!0)}catch{}h(S)}:void 0))?(m&&window.requestAnimationFrame(()=>{let f=kn(e.view);Jo(f,m);try{(f?.closest?.(".tableWrapper")||null)?.dispatchEvent?.(new Event("scroll"))}catch{}}),!0):!1}catch{return!1}}function Yp(e,t,n){try{if(!e?.view)return!1;let r=e.state,o=on(r);if(!o)return!1;let i=o.map?.height||0,s=o.map?.width||0;if(!(s>0&&i>0))return!1;let c=Number(t),l=Number(n);if(!Number.isFinite(c)||!Number.isFinite(l)||c<0||c>=i||l<0||l>=i)return!1;if(c===l)return!0;if(Jp(o,{kind:"row",fromIndex:c,toIndex:l}))return P("\u041D\u0435\u043B\u044C\u0437\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u043E\u043A\u0443: \u0438\u0441\u0445\u043E\u0434\u043D\u0430\u044F \u0438\u043B\u0438 \u0446\u0435\u043B\u0435\u0432\u0430\u044F \u0441\u0442\u0440\u043E\u043A\u0430 \u043F\u0435\u0440\u0435\u0441\u0435\u043A\u0430\u0435\u0442\u0441\u044F \u0441 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u043C\u0438 \u044F\u0447\u0435\u0439\u043A\u0430\u043C\u0438"),!1;let d=kn(e.view),u=jo(d),m=Ot?.moveTableRow||null;if(typeof m!="function")return!1;let y=m({from:c,to:l,select:!0});return e.commands.command(({state:g,dispatch:f})=>y(g,typeof f=="function"?b=>{try{b=b.setMeta(de,!0)}catch{}f(b)}:void 0))?(Array.isArray(u)&&u.length===s&&window.requestAnimationFrame(()=>{let g=kn(e.view);Jo(g,u)}),!0):!1}catch{return!1}}function Gp(e){try{if(!e)return"";let t=e.textContent||"";return String(t).replace(/\s+/g," ").trim()}catch{return""}}function fb(e){try{if(!e)return!1;for(let t=0;t<e.childCount;t+=1)if(e.child(t)?.type?.name==="tableHeader")return!0;return!1}catch{return!1}}function kp(e,{direction:t="asc"}={}){try{if(!e?.view)return!1;let n=e.state,r=on(n);if(!r)return!1;let{tablePos:o,tableNode:i,colIndex:s}=r,c=i.child(0)?.childCount||0,l=i.childCount||0;if(!(c>0&&l>1)||!(s>=0&&s<c)||!ha(i,"\u0442\u0430\u0431\u043B\u0438\u0446\u044B"))return!1;let d=fb(i.child(0))?i.child(0):null,u=d?1:0,m=[];for(let h=u;h<l;h+=1){let b=i.child(h),S=b.child(s);m.push({rowIndex:h,rowNode:b,key:Gp(S)})}let y=t==="desc"?-1:1;m.sort((h,b)=>y*h.key.localeCompare(b.key,void 0,{sensitivity:"base",numeric:!0}));let w=[];d&&w.push(d);for(let h of m)w.push(h.rowNode);let g=i.type.create(i.attrs,w),f=n.tr.replaceWith(o,o+i.nodeSize,g);return f=f.setMeta(de,!0),e.view.dispatch(f.scrollIntoView()),!0}catch{return!1}}function Ap(e,{direction:t="asc"}={}){try{if(!e?.view)return!1;let n=e.state,r=on(n);if(!r)return!1;let{tablePos:o,tableNode:i,rowIndex:s}=r,c=i.child(0)?.childCount||0,l=i.childCount||0;if(!(c>1&&l>0)||!(s>=0&&s<l)||!ha(i,"\u0442\u0430\u0431\u043B\u0438\u0446\u044B"))return!1;let d=i.child(s),u=[];for(let k=0;k<c;k+=1)u.push({colIndex:k,key:Gp(d.child(k))});let m=t==="desc"?-1:1;u.sort((k,A)=>m*k.key.localeCompare(A.key,void 0,{sensitivity:"base",numeric:!0}));let y=u.map(k=>k.colIndex),w=kn(e.view),g=jo(w),f=Array.isArray(g)&&g.length===c?y.map(k=>g[k]):null,h=[];for(let k=0;k<l;k+=1){let A=i.child(k),v=y.map(B=>A.child(B));h.push(A.type.create(A.attrs,v))}let b=i.type.create(i.attrs,h),S=n.tr.replaceWith(o,o+i.nodeSize,b);return S=S.setMeta(de,!0),e.view.dispatch(S.scrollIntoView()),f&&window.requestAnimationFrame(()=>{let k=kn(e.view);Jo(k,f)}),!0}catch{return!1}}function pb(e){try{if(!e?.view)return!1;let t=e.state,n=on(t);if(!n)return!1;let{tablePos:r,tableNode:o,rowIndex:i,colIndex:s}=n,c=o.child(0)?.childCount||0,l=o.childCount||0;if(!(c>0&&l>0)||!(i>=0&&i<l)||!ha(o,"\u0441\u0442\u0440\u043E\u043A"))return!1;let d=o.child(i),u=[];for(let w=0;w<l;w+=1)u.push(o.child(w)),w===i&&u.push(d.type.create(d.attrs,d.content,d.marks));let m=o.type.create(o.attrs,u),y=t.tr.replaceWith(r,r+o.nodeSize,m);y=y.setMeta(de,!0);try{let w=ze?.pmStateMod?.TextSelection;if(w){let g=Math.min(m.childCount-1,i+1),f=Math.min(c-1,Math.max(0,s)),h=m.child(g),b=h.child(f),S=r+1;for(let B=0;B<g;B+=1)S+=m.child(B).nodeSize;S+=1;for(let B=0;B<f;B+=1)S+=h.child(B).nodeSize;let k=S,A=k+1,v=k+b.nodeSize-1;y=y.setSelection(w.near(y.doc.resolve(Math.min(v,A+1)),1))}}catch{}return e.view.dispatch(y.scrollIntoView()),!0}catch{return!1}}function mb(e){try{if(!e?.view)return!1;let t=e.state,n=on(t);if(!n)return!1;let{tablePos:r,tableNode:o,rowIndex:i,colIndex:s}=n,c=o.child(0)?.childCount||0,l=o.childCount||0;if(!(c>0&&l>0)||!(s>=0&&s<c)||!ha(o,"\u0441\u0442\u043E\u043B\u0431\u0446\u043E\u0432"))return!1;let d=kn(e.view),u=jo(d),m=null;if(Array.isArray(u)&&u.length===c){let f=[...u],h=Math.max(0,Number(f[s]||0)),b=lr(h/2);f[s]=b,f.splice(s+1,0,b);let S=f.reduce((k,A)=>k+(Number.isFinite(A)?A:0),0);S>0&&Math.abs(S-100)>.01&&(f[f.length-1]=lr(f[f.length-1]+(100-S))),m=f}let y=[];for(let f=0;f<l;f+=1){let h=o.child(f),b=[];for(let S=0;S<c;S+=1){let k=h.child(S);b.push(k),S===s&&b.push(k.type.create(k.attrs,k.content,k.marks))}y.push(h.type.create(h.attrs,b))}let w=o.type.create(o.attrs,y),g=t.tr.replaceWith(r,r+o.nodeSize,w);g=g.setMeta(de,!0);try{let f=ze?.pmStateMod?.TextSelection;if(f){let h=Math.min(w.childCount-1,Math.max(0,i)),b=Math.min(c,Math.max(0,s+1)),S=w.child(h),k=S.child(b),A=r+1;for(let O=0;O<h;O+=1)A+=w.child(O).nodeSize;A+=1;for(let O=0;O<b;O+=1)A+=S.child(O).nodeSize;let v=A,B=v+1,H=v+k.nodeSize-1;g=g.setSelection(f.near(g.doc.resolve(Math.min(H,B+1)),1))}}catch{}return e.view.dispatch(g.scrollIntoView()),Array.isArray(m)&&m.length===c+1?window.requestAnimationFrame(()=>{let f=kn(e.view);Jo(f,m)}):window.requestAnimationFrame(()=>{let f=kn(e.view);ca(f)}),!0}catch{return!1}}function hb(e,t,n){try{if(!e?.view)return!1;let{state:r,view:o}=e,{selection:i}=r,s=i?.$from||null;if(!s)return!1;let c=n instanceof Set?n:new Set(Array.from(n||[])),l=null;for(let B=s.depth;B>0;B-=1)if(s.node(B)?.type?.name==="paragraph"){let H=s.node(B-1)?.type?.name||"";c.has(H)&&(l=B);break}if(l==null)return!1;let d=l-1,u=s.node(d),m=s.index(d);if(!u)return!1;let y=t<0?-1:1,w=m+y;if(!(w>=0&&w<u.childCount))return!1;let g=u.child(m),f=u.child(w);if(g?.type?.name!=="paragraph"||f?.type?.name!=="paragraph")return!1;let h=s.before(l),b=g.nodeSize,S=y<0?h-f.nodeSize:h+b,k=f.nodeSize,A=Math.max(0,i.from-s.start(l)),v=r.tr;if(y<0){v=v.delete(h,h+b),v=v.insert(S,g);let B=S,H=B+1,O=B+g.nodeSize-1,W=H+A,J=Math.min(Math.max(W,H),O);try{let ne=ze?.pmStateMod?.TextSelection;ne&&(v=v.setSelection(ne.near(v.doc.resolve(J),1)))}catch{}}else{v=v.delete(h,h+b);let B=h+k;v=v.insert(B,g);let H=B,O=H+1,W=H+g.nodeSize-1,J=O+A,ne=Math.min(Math.max(J,O),W);try{let me=ze?.pmStateMod?.TextSelection;me&&(v=v.setSelection(me.near(v.doc.resolve(ne),1)))}catch{}}return v=v.setMeta(de,!0),o.dispatch(v.scrollIntoView()),!0}catch{return!1}}function Ip(e,t){return hb(e,t,new Set(["outlineBody","tableCell","tableHeader"]))}function Ep(e,t){try{if(!e?.view)return!1;let{state:n,view:r}=e,{selection:o}=n,i=o?.$from||null;if(!i)return!1;let s=null;for(let A=i.depth;A>0;A-=1)if(i.node(A)?.type?.name==="listItem"){s=A;break}if(s==null)return!1;let c=s-1,l=i.node(c),d=l?.type?.name||"";if(d!=="bulletList"&&d!=="orderedList")return!1;let u=i.index(c),m=t<0?-1:1,y=u+m;if(!(y>=0&&y<l.childCount))return!1;let w=l.child(u),g=l.child(y);if(w?.type?.name!=="listItem"||g?.type?.name!=="listItem")return!1;let f=i.before(s),h=w.nodeSize,b=g.nodeSize,S=Math.max(0,o.from-i.start(s)),k=n.tr;if(m<0){let A=f-b;k=k.delete(f,f+h),k=k.insert(A,w);let v=A,B=v+1,H=v+w.nodeSize-1,O=B+S,W=Math.min(Math.max(O,B),H);try{let J=ze?.pmStateMod?.TextSelection;J&&(k=k.setSelection(J.near(k.doc.resolve(W),1)))}catch{}}else{k=k.delete(f,f+h);let A=f+b;k=k.insert(A,w);let v=A,B=v+1,H=v+w.nodeSize-1,O=B+S,W=Math.min(Math.max(O,B),H);try{let J=ze?.pmStateMod?.TextSelection;J&&(k=k.setSelection(J.near(k.doc.resolve(W),1)))}catch{}}return k=k.setMeta(de,!0),r.dispatch(k.scrollIntoView()),!0}catch{return!1}}function gb(e){if(!p.outlineToolbar||!e)return;let t=p.outlineToolbar,n=null,r={undo:p.outlineUndoBtn,redo:p.outlineRedoBtn,attachBtn:t.querySelector("#outlineAttachBtn"),attachInput:t.querySelector("#outlineAttachInput"),deleteBtn:p.outlineDeleteBtn,moveUpBtn:p.outlineMoveUpBtn,moveDownBtn:p.outlineMoveDownBtn,outdentBtn:p.outlineOutdentBtn,indentBtn:p.outlineIndentBtn,newBelowBtn:p.outlineNewBelowBtn,blocksMenuBtn:t.querySelector("#outlineBlocksMenuBtn"),textMenuBtn:t.querySelector("#outlineTextMenuBtn"),calloutMenuBtn:t.querySelector("#outlineCalloutMenuBtn"),listsMenuBtn:t.querySelector("#outlineListsMenuBtn"),tableMenuBtn:t.querySelector("#outlineTableMenuBtn")},o=new Set(Array.from(t.querySelectorAll(".outline-toolbar__dropdown-btn")));r.blocksMenuBtn&&o.add(r.blocksMenuBtn),r.textMenuBtn&&o.add(r.textMenuBtn),r.calloutMenuBtn&&o.add(r.calloutMenuBtn),r.listsMenuBtn&&o.add(r.listsMenuBtn),r.tableMenuBtn&&o.add(r.tableMenuBtn);let i=Array.from(o),s=Array.from(t.querySelectorAll(".outline-toolbar__menu")),c=Array.from(t.querySelectorAll("[data-outline-action]")),l=Array.from(t.querySelectorAll("[data-outline-clipboard-action]")),d=(Y,ce)=>{if(!Y)return()=>{};let fe=pe=>{pe.preventDefault(),pe.stopPropagation(),ce()};return Y.addEventListener("click",fe),()=>Y.removeEventListener("click",fe)},u=(Y,ce)=>{Y&&(Y.classList.toggle("is-active",!!ce),Y.setAttribute("aria-pressed",ce?"true":"false"))},m=()=>{for(let Y of s)Y.classList.add("hidden");for(let Y of i)Y.setAttribute("aria-expanded","false")},y=()=>{let Y=Cl(),ce=!!(Y&&Array.isArray(Y.sections)&&Y.sections.length);for(let fe of l)fe?.getAttribute?.("data-outline-clipboard-action")==="paste"&&fe.toggleAttribute("disabled",!ce)},w=Y=>{if(!Y)return;let ce=Y.getAttribute("aria-controls"),fe=ce?t.querySelector(`#${ce}`)||document.getElementById(ce):null;if(!fe)return!1;let pe=!fe.classList.contains("hidden");return m(),pe||(ce==="outlineBlocksMenu"&&y(),fe.classList.remove("hidden"),Y.setAttribute("aria-expanded","true")),!0},g="ttree_outline_debug_dropdown_v1",f=()=>{try{return window?.localStorage?.getItem?.(g)==="1"}catch{return!1}},h=(Y,ce={})=>{try{if(!f())return;console.log("[outline][dropdown]",Y,ce)}catch{}},b=Y=>{try{let ce=e.can().chain();return k()&&ce.command(({tr:fe})=>(fe.setMeta(de,!0),!0)),Y(ce),ce.run()}catch{return!1}},S=Y=>{if(!Y)return!1;try{let ce=e.chain().focus();if(k()&&ce.command(({tr:fe})=>(fe.setMeta(de,!0),!0)),Y==="collapseAllBlocks")return Bl(e,!0);if(Y==="expandAllBlocks")return Bl(e,!1);if(Y==="toggleBold")return ce.toggleBold().run();if(Y==="toggleItalic")return ce.toggleItalic().run();if(Y==="toggleStrike")return ce.toggleStrike().run();if(Y==="toggleCodeBlock")return e.commands.command(({state:fe,dispatch:pe})=>{let ue=fe.schema.nodes?.codeBlock||null;if(!ue)return!1;let Se=fe.selection,{from:ve,to:oe}=Se;if(ve===oe){let it=fe.tr.setMeta(de,!0);return pe(it),e.commands.toggleCodeBlock()}let Ce=Se.$from?.blockRange?.(Se.$to)||null;if(!Ce){let it=fe.tr.setMeta(de,!0);return pe(it),e.commands.toggleCodeBlock()}if(!Ce.parent?.canReplaceWith?.(Ce.startIndex,Ce.endIndex,ue)){let it=fe.tr.setMeta(de,!0);return pe(it),e.commands.toggleCodeBlock()}let qe=fe.doc.textBetween(Ce.start,Ce.end,`
`,`
`),Xe=String(qe||"").replace(/\n+$/g,"").trimEnd();if(!Xe)return!1;let dt=ue.create(null,fe.schema.text(Xe)),rt=fe.tr.replaceRangeWith(Ce.start,Ce.end,dt);return rt=rt.setMeta(de,!0),te&&(rt=rt.setSelection(te.near(rt.doc.resolve(Ce.start+2),1))),pe(rt.scrollIntoView()),!0});if(Y==="toggleBlockquote")return ce.toggleBlockquote().run();if(Y.startsWith("setTextBg:")){if(!A())return!1;let fe=Y.slice(10);return e.commands.setTextBg(fe)}if(Y==="clearTextBg")return A()?e.commands.clearTextBg():!1;if(Y.startsWith("setCallout:")){try{if(!(be?.getState?.(e.state)||null)?.editingSectionId)return gr(),!1}catch{return gr(),!1}let fe=Y.split(":")[1]||"";return e.commands.setCallout(fe)}if(Y==="unsetCallout"){try{if(!(be?.getState?.(e.state)||null)?.editingSectionId)return gr(),!1}catch{return gr(),!1}return e.commands.unsetCallout()}if(Y==="unsetLink")return ce.unsetLink().run();if(Y==="toggleBulletList")return e.isActive("orderedList")?ce.toggleOrderedList().toggleBulletList().run():ce.toggleBulletList().run();if(Y==="toggleOrderedList")return e.isActive("bulletList")?ce.toggleBulletList().toggleOrderedList().run():ce.toggleOrderedList().run();if(Y==="unsetList")return e.isActive("bulletList")?ce.toggleBulletList().run():e.isActive("orderedList")?ce.toggleOrderedList().run():ce.liftListItem("listItem").run();if(Y==="insertTable")return ce.insertTable({rows:2,cols:2,withHeaderRow:!1}).run();if(Y==="toggleHeaderRow")return ce.toggleHeaderRow().run();if(Y==="toggleHeaderColumn")return ce.toggleHeaderColumn().run();if(Y==="addRowBefore")return ce.addRowBefore().run();if(Y==="addRowAfter")return ce.addRowAfter().run();if(Y==="deleteRow")return ce.deleteRow().run();if(Y==="addColumnBefore"){let fe=on(e.state),pe=fe?Math.max(0,Number(fe.colIndex||0)):0,ue=ce.addColumnBefore().run();return ue&&ua(e,{insertIndex:pe,newColPct:10}),ue}if(Y==="addColumnAfter"){let fe=on(e.state),pe=fe?Math.max(0,Number(fe.colIndex||0)+1):1,ue=ce.addColumnAfter().run();return ue&&ua(e,{insertIndex:pe,newColPct:10}),ue}if(Y==="deleteColumn"){let fe=kn(e.view),pe=jo(fe),ue=on(e.state),Se=ue?Number(ue.colIndex||0):null,ve=pe&&Se!=null?jp(pe,Se):null,oe=ce.deleteColumn().run();return oe&&Array.isArray(ve)&&window.requestAnimationFrame(()=>{let Ce=kn(e.view);Jo(Ce,ve)}),oe}return Y==="mergeCells"?ce.mergeCells().run():Y==="splitCell"?ce.splitCell().run():Y==="copyColumn"||Y==="pasteColumnAfter"||Y==="moveColumnRight"?!1:Y==="cancelTable"?v():Y==="deleteTable"?ce.deleteTable().run():!1}catch{return!1}},k=()=>{try{return!!(be?.getState?.(e.state)||null)?.editingSectionId}catch{return!1}},A=()=>k()?!0:(gr(),!1),v=()=>{if(!A())return!1;try{let{state:Y,view:ce}=e,{schema:fe,selection:pe}=Y,ue=pe?.$from;if(!ue)return!1;let Se=null;for(let Ze=ue.depth;Ze>=0;Ze-=1)ue.node(Ze)?.type?.name==="table"&&(Se=Ze);if(Se==null)return!1;let ve=null,oe=null;for(let Ze=Se+1;Ze<=ue.depth;Ze+=1){let Ye=ue.node(Ze)?.type?.name;if(ve==null&&Ye==="tableRow"&&(ve=Ze),oe==null&&(Ye==="tableCell"||Ye==="tableHeader")&&(oe=Ze),ve!=null&&oe!=null)break}let Ce=ue.before(Se),qe=Y.doc.nodeAt(Ce);if(!qe||qe.type?.name!=="table")return!1;let Xe=ve!=null?ue.index(Se):null,dt=ve!=null&&oe!=null?ue.index(ve):null,rt=null;if(typeof Xe=="number"&&typeof dt=="number"){let Ze=qe.childCount&&qe.child(0)?.childCount||0;Ze>0&&(rt=Xe*Ze+dt)}let it=[],We=0,St=0;for(let Ze=0;Ze<qe.childCount;Ze+=1){let Tt=qe.child(Ze);for(let Ye=0;Ye<Tt.childCount;Ye+=1){let Mn=Tt.child(Ye),sn=[];try{for(let ln=0;ln<(Mn?.content?.childCount||0);ln+=1){let pn=Mn.content.child(ln);pn&&sn.push(pn)}}catch{}sn.length||sn.push(fe.nodes.paragraph.create(null,[])),rt!=null&&We===rt&&(St=it.length),it.push(...sn),We+=1}}if(!it.length)return!1;let pt=fe.nodes.outlineBody?fe.nodes.outlineBody.create({},it).content:fe.nodes.doc.create({},it).content,ot=Y.tr.replaceWith(Ce,Ce+qe.nodeSize,pt);ot=ot.setMeta(de,!0);try{let Ze=ze?.pmStateMod?.TextSelection;if(Ze){let Tt=Ce;for(let pn=0;pn<St;pn+=1)Tt+=it[pn].nodeSize;let Ye=null,Mn=Math.min(ot.doc.content.size,Tt),sn=Math.min(ot.doc.content.size,Tt+2e4);ot.doc.nodesBetween(Mn,sn,(pn,Wn)=>Ye!=null?!1:pn?.isTextblock?(Ye=Wn+1,!1):!0);let ln=Ye??Math.min(ot.doc.content.size,Tt+1);ot=ot.setSelection(Ze.near(ot.doc.resolve(ln),1))}}catch{}return ce.dispatch(ot.scrollIntoView()),ce.focus?.(),!0}catch{return!1}},B=()=>{if(!A())return!1;try{let{state:Y,view:ce}=e,{selection:fe}=Y,pe=fe?.$from;if(!pe)return!1;let ue=null,Se=null,ve=null;for(let ot=pe.depth;ot>=0;ot-=1){let Tt=pe.node(ot)?.type?.name;if(ve==null&&(Tt==="tableCell"||Tt==="tableHeader")&&(ve=ot),Se==null&&Tt==="tableRow"&&(Se=ot),Tt==="table"){ue=ot;break}}if(ue==null||Se==null||ve==null)return!1;let oe=pe.before(ue),Ce=Y.doc.nodeAt(oe);if(!Ce||Ce.type?.name!=="table")return!1;let qe=pe.index(ue),Xe=pe.index(Se),dt=Ce.child(0)?.childCount||0;if(!(dt>0)||!(Xe>=0&&Xe<dt-1))return!1;let rt=!1;if(Ce.descendants(ot=>{if(rt)return!1;let Ze=ot?.type?.name;if(Ze==="tableCell"||Ze==="tableHeader"){let Tt=Number(ot.attrs?.colspan||1),Ye=Number(ot.attrs?.rowspan||1);if(Tt!==1||Ye!==1)return rt=!0,!1}return!0}),rt)return P("\u041F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 \u0441\u0442\u043E\u043B\u0431\u0446\u043E\u0432 \u043F\u043E\u043A\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u0445 \u044F\u0447\u0435\u0435\u043A"),!1;let it=fe.from-pe.start(ve),We=[];for(let ot=0;ot<Ce.childCount;ot+=1){let Ze=Ce.child(ot);if(Ze.type?.name!=="tableRow"||Ze.childCount!==dt)return!1;let Tt=[];for(let Ye=0;Ye<dt;Ye+=1)Ye===Xe?Tt.push(Ze.child(Ye+1)):Ye===Xe+1?Tt.push(Ze.child(Ye-1)):Tt.push(Ze.child(Ye));We.push(Ze.type.create(Ze.attrs,Tt))}let St=Ce.type.create(Ce.attrs,We),pt=Y.tr.replaceWith(oe,oe+Ce.nodeSize,St);pt=pt.setMeta(de,!0);try{let ot=ze?.pmStateMod?.TextSelection;if(ot){let Ze=Math.min(St.childCount-1,Math.max(0,qe)),Tt=Xe+1,Ye=St.child(Ze),Mn=Ye.child(Tt),sn=oe+1;for(let L=0;L<Ze;L+=1)sn+=St.child(L).nodeSize;sn+=1;for(let L=0;L<Tt;L+=1)sn+=Ye.child(L).nodeSize;let ln=sn,pn=ln+1,Wn=ln+Mn.nodeSize-1,I=pn+Math.max(0,it),x=Math.min(Math.max(I,pn),Wn);pt=pt.setSelection(ot.near(pt.doc.resolve(x),1))}}catch{}return ce.dispatch(pt.scrollIntoView()),ce.focus?.(),!0}catch{return!1}},H=(Y,ce,fe={})=>{let pe=String(Y||"").trim();if(!pe)return!1;let ue=String(ce||"").trim()||pe,{from:Se,to:ve,empty:oe}=e.state.selection,Ce={href:pe,...fe},qe=e.chain().focus();return k()&&qe.command(({tr:Xe})=>(Xe.setMeta(de,!0),!0)),!oe&&Se!==ve?qe.setLink(Ce).run():qe.insertContent({type:"text",text:ue,marks:[{type:"link",attrs:Ce}]}).run()},O=async()=>{if(!A())return;let{from:Y,to:ce,empty:fe}=e.state.selection,pe=fe?"":e.state.doc.textBetween(Y,ce," ").trim(),ue="",Se=pe;try{let oe=await(await Promise.resolve().then(()=>(Qn(),gc))).showLinkPrompt({title:"\u0421\u0441\u044B\u043B\u043A\u0430 (URL)",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0441\u0441\u044B\u043B\u043A\u0443 (\u043B\u044E\u0431\u043E\u0439 \u0444\u043E\u0440\u043C\u0430\u0442) \u0438 \u0442\u0435\u043A\u0441\u0442 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E).",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",textLabel:"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)",urlLabel:"\u0421\u0441\u044B\u043B\u043A\u0430",defaultText:pe,defaultUrl:"",urlPlaceholder:""});if(!oe||typeof oe!="object")return;ue=String(oe.url||""),Se=String(oe.text??pe)}catch{ue=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0441\u0441\u044B\u043B\u043A\u0443")||"",Se=pe||window.prompt("\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)")||""}ue=(ue||"").trim(),ue&&H(ue,Se,{target:"_blank",rel:"noopener noreferrer"})},W=async()=>{if(!A())return;let Y=Array.isArray(a.articlesIndex)?a.articlesIndex:[];Y.length||(Y=await zn().catch(()=>[])||[],Array.isArray(Y)&&(a.articlesIndex=Y));let ce=(Array.isArray(Y)?Y:[]).map(it=>({id:it.id,title:it.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),{from:fe,to:pe,empty:ue}=e.state.selection,Se=ue?"":e.state.doc.textBetween(fe,pe," ").trim(),ve=!!Se,oe="",Ce="",qe=Se;try{let We=await(await Promise.resolve().then(()=>(Qn(),gc))).showArticleLinkPrompt({title:"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E \u0438 \u0437\u0430\u0434\u0430\u0439\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438.",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:ce,defaultTextValue:Se,lockTextValue:ve});if(We&&typeof We=="object")oe=We.articleValue||"",Ce=We.selectedId||"",qe=We.textValue||"";else return}catch{oe=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438")||"",qe=Se||window.prompt("\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)")||""}let Xe=(oe||"").trim().toLowerCase();if(!Xe&&!Ce)return;let dt=(Array.isArray(Y)?Y:[]).find(it=>{let We=(it.title||"").toLowerCase();return Ce&&it.id===Ce||it.id&&it.id.toLowerCase()===Xe||We===Xe||We.includes(Xe)});if(!dt){P("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}let rt=(qe||"").trim()||dt.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";H(wt.article(dt.id),rt,{class:"article-link"})},J=()=>{if(!a.isOutlineEditing||!e||e.isDestroyed)return;let Y=k();if(t.dataset.editing=Y?"true":"false",n===null?n=Y:n!==Y&&(m(),n=Y),r.deleteBtn&&(r.deleteBtn.hidden=Y),r.moveUpBtn&&(r.moveUpBtn.hidden=Y),r.moveDownBtn&&(r.moveDownBtn.hidden=Y),r.outdentBtn&&(r.outdentBtn.hidden=Y),r.indentBtn&&(r.indentBtn.hidden=Y),r.newBelowBtn&&(r.newBelowBtn.hidden=Y),r.blocksMenuBtn&&(r.blocksMenuBtn.hidden=Y),r.attachBtn&&(r.attachBtn.hidden=!Y),Y&&Tr&&qo(!1),r.undo&&(r.undo.disabled=!b(pe=>pe.undo())),r.redo&&(r.redo.disabled=!b(pe=>pe.redo())),r.textMenuBtn){let pe=e.isActive("bold")||e.isActive("italic")||e.isActive("strike")||e.isActive("codeBlock")||e.isActive("blockquote");u(r.textMenuBtn,pe),r.textMenuBtn.hidden=!Y}if(r.listsMenuBtn){let pe=e.isActive("bulletList")||e.isActive("orderedList");u(r.listsMenuBtn,pe),r.listsMenuBtn.hidden=!Y}if(r.tableMenuBtn){let pe=e.isActive("table");u(r.tableMenuBtn,pe),r.tableMenuBtn.hidden=!Y}if(r.calloutMenuBtn){let pe=e.isActive("callout");u(r.calloutMenuBtn,pe),r.calloutMenuBtn.hidden=!Y}let ce=null,fe=()=>{if(ce)return ce;let pe={total:0,collapsed:0};try{e.state.doc.descendants(ue=>{ue?.type?.name==="outlineSection"&&(pe.total+=1,ue.attrs?.collapsed&&(pe.collapsed+=1))})}catch{}return ce=pe,pe};for(let pe of c){let ue=pe.dataset.outlineAction||"";if(!ue)continue;let Se=!1,ve=!1;if(ue==="collapseAllBlocks"){let oe=fe();Se=!1,ve=oe.total===0||oe.collapsed>=oe.total}else if(ue==="expandAllBlocks"){let oe=fe();Se=!1,ve=oe.total===0||oe.collapsed<=0}else if(ue==="toggleBold")Se=e.isActive("bold"),ve=!b(oe=>oe.toggleBold());else if(ue==="toggleItalic")Se=e.isActive("italic"),ve=!b(oe=>oe.toggleItalic());else if(ue==="toggleStrike")Se=e.isActive("strike"),ve=!b(oe=>oe.toggleStrike());else if(ue==="toggleCodeBlock")Se=e.isActive("codeBlock"),ve=!k();else if(ue==="toggleBlockquote")Se=e.isActive("blockquote"),ve=!b(oe=>oe.toggleBlockquote());else if(ue.startsWith("setTextBg:"))Se=!1,ve=!k()||!b(oe=>oe.setTextBg(ue.slice(10)));else if(ue==="clearTextBg")Se=!1,ve=!k()||!b(oe=>oe.clearTextBg());else if(ue.startsWith("setCallout:")){let oe=ue.split(":")[1]||"";Se=e.isActive("callout",{kind:oe}),ve=!k()||!b(Ce=>Ce.setCallout(oe))}else ue==="unsetCallout"?(Se=!1,ve=!k()||!e.isActive("callout")||!b(oe=>oe.unsetCallout())):ue==="insertHttpLink"||ue==="insertArticleLink"?(Se=!1,ve=!k()):ue==="unsetLink"?(Se=e.isActive("link"),ve=!b(oe=>oe.unsetLink())):ue==="toggleBulletList"?(Se=e.isActive("bulletList"),e.isActive("orderedList")?ve=!(b(oe=>oe.toggleOrderedList())&&b(oe=>oe.toggleBulletList())):ve=!b(oe=>oe.toggleBulletList())):ue==="toggleOrderedList"?(Se=e.isActive("orderedList"),e.isActive("bulletList")?ve=!(b(oe=>oe.toggleBulletList())&&b(oe=>oe.toggleOrderedList())):ve=!b(oe=>oe.toggleOrderedList())):ue==="unsetList"?(Se=!1,e.isActive("bulletList")?ve=!b(oe=>oe.toggleBulletList()):e.isActive("orderedList")?ve=!b(oe=>oe.toggleOrderedList()):ve=!b(oe=>oe.liftListItem("listItem"))):ue==="insertTable"?(Se=!1,ve=!b(oe=>oe.insertTable({rows:2,cols:2,withHeaderRow:!1}))):ue==="toggleHeaderRow"?(Se=e.isActive("tableHeader"),ve=!b(oe=>oe.toggleHeaderRow())):ue==="toggleHeaderColumn"?(Se=e.isActive("tableHeader"),ve=!b(oe=>oe.toggleHeaderColumn())):ue==="addRowBefore"?(Se=!1,ve=!b(oe=>oe.addRowBefore())):ue==="addRowAfter"?(Se=!1,ve=!b(oe=>oe.addRowAfter())):ue==="deleteRow"?(Se=!1,ve=!b(oe=>oe.deleteRow())):ue==="addColumnBefore"?(Se=!1,ve=!b(oe=>oe.addColumnBefore())):ue==="addColumnAfter"?(Se=!1,ve=!b(oe=>oe.addColumnAfter())):ue==="deleteColumn"?(Se=!1,ve=!b(oe=>oe.deleteColumn())):ue==="copyColumn"||ue==="pasteColumnAfter"||ue==="moveColumnRight"?(Se=!1,ve=!0):ue==="mergeCells"?(Se=!1,ve=!b(oe=>oe.mergeCells())):ue==="splitCell"?(Se=!1,ve=!b(oe=>oe.splitCell())):ue==="cancelTable"?(Se=!1,ve=!k()||!e.isActive("table")):ue==="deleteTable"&&(Se=!1,ve=!b(oe=>oe.deleteTable()));pe.disabled=!!ve,pe.classList.toggle("is-active",!!Se)}},ne=null,me=()=>{ne||(ne=window.requestAnimationFrame(()=>{ne=null,J()}))},we=[d(r.undo,()=>e.chain().focus().undo().run()),d(r.redo,()=>e.chain().focus().redo().run()),d(r.attachBtn,()=>{if(!A())return;let Y=r.attachInput;if(!Y){P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0432\u044B\u0431\u043E\u0440 \u0444\u0430\u0439\u043B\u0430");return}try{Y.value=""}catch{}try{if(typeof Y.showPicker=="function"){Y.showPicker();return}}catch{}Y.click()})];try{let Y=r.attachInput;Y&&!Y.__ttreeOutlineAttachBound&&(Object.defineProperty(Y,"__ttreeOutlineAttachBound",{value:!0}),Y.addEventListener("change",()=>{if(!A())return;let ce=Array.from(Y.files||[]);if(ce.length){for(let fe of ce)if(fe)try{Tl(fe)?Pp(e.view,fe):Dp(e.view,fe)}catch{}}},{passive:!0}))}catch{}let te=ze?.pmStateMod?.TextSelection||null,he=(Y,ce)=>{try{let fe=Y.resolve(Math.min(Y.content.size,ce+1)),pe=null;for(let ue=fe.depth;ue>0;ue-=1){if(fe.node(ue)?.type?.name!=="outlineSection")continue;if(fe.before(ue)===ce){pe=ue;break}}if(pe===null)return null;for(let ue=pe-1;ue>0;ue-=1)if(fe.node(ue)?.type?.name==="outlineSection")return fe.before(ue);return null}catch{return null}},Je=Y=>{try{if(!te)return;e.commands.command(({state:ce,dispatch:fe})=>{let pe=Ht(ce.doc,ce.selection.$from);if(typeof pe!="number")return!1;let ue=ce.doc.resolve(pe),Se=ue.index(),ve=ue.parent;if(!ve)return!1;let oe=ce.doc.nodeAt(pe);if(!oe)return!1;if(Y==="up"){if(Se>0){let pn=ve.child(Se-1),Wn=pe-pn.nodeSize,I=ce.tr.delete(pe,pe+oe.nodeSize).insert(Wn,oe);return I=I.setMeta(de,!0),I=I.setSelection(te.near(I.doc.resolve(Wn+2),1)),fe(I.scrollIntoView()),!0}let Ce=he(ce.doc,pe);if(typeof Ce!="number")return!1;let qe=ce.doc.resolve(Ce),Xe=qe.index(),dt=qe.parent;if(!dt||Xe<=0)return!1;let rt=dt.child(Xe-1),it=Ce-rt.nodeSize,We=ce.doc.nodeAt(it);if(!We||We.type?.name!=="outlineSection")return!1;let St=We.child(0),pt=We.child(1),ot=We.child(2),Tt=it+1+St.nodeSize+pt.nodeSize+ot.nodeSize-1,Ye=ce.tr.delete(pe,pe+oe.nodeSize).setMeta(de,!0),Mn=Ye.mapping.map(it,-1),sn=Ye.mapping.map(Tt,-1);Ye=Ye.insert(sn,oe);let ln=Ye.doc.nodeAt(Mn);return ln?.type?.name==="outlineSection"&&ln.attrs?.collapsed&&(Ye=Ye.setNodeMarkup(Mn,void 0,{...ln.attrs,collapsed:!1})),Ye=Ye.setSelection(te.near(Ye.doc.resolve(sn+2),1)),fe(Ye.scrollIntoView()),!0}if(Y==="down"){if(Se<ve.childCount-1){let pn=pe+oe.nodeSize,Wn=ce.doc.nodeAt(pn);if(!Wn)return!1;let I=ce.tr.delete(pe,pe+oe.nodeSize),x=pe+Wn.nodeSize;return I=I.insert(x,oe),I=I.setMeta(de,!0),I=I.setSelection(te.near(I.doc.resolve(x+2),1)),fe(I.scrollIntoView()),!0}let Ce=he(ce.doc,pe);if(typeof Ce!="number")return!1;let qe=ce.doc.nodeAt(Ce);if(!qe||qe.type?.name!=="outlineSection")return!1;let Xe=ce.doc.resolve(Ce),dt=Xe.index(),rt=Xe.parent;if(!rt||dt>=rt.childCount-1)return!1;let it=Ce+qe.nodeSize,We=ce.doc.nodeAt(it);if(!We||We.type?.name!=="outlineSection")return!1;let St=We.child(0),pt=We.child(1),ot=We.child(2),Tt=it+1+St.nodeSize+pt.nodeSize+1,Ye=ce.tr.delete(pe,pe+oe.nodeSize).setMeta(de,!0),Mn=Ye.mapping.map(it,-1),sn=Ye.mapping.map(Tt,-1);Ye=Ye.insert(sn,oe);let ln=Ye.doc.nodeAt(Mn);return ln?.type?.name==="outlineSection"&&ln.attrs?.collapsed&&(Ye=Ye.setNodeMarkup(Mn,void 0,{...ln.attrs,collapsed:!1})),Ye=Ye.setSelection(te.near(Ye.doc.resolve(sn+2),1)),fe(Ye.scrollIntoView()),!0}return!1})}catch{}},vt=()=>{try{if(!te)return;e.commands.command(({state:Y,dispatch:ce})=>{let fe=Ht(Y.doc,Y.selection.$from);if(typeof fe!="number")return!1;let pe=Y.doc.resolve(fe),ue=0;for(let Ze=pe.depth;Ze>=0;Ze-=1)pe.node(Ze)?.type?.name==="outlineSection"&&(ue+=1);if(ue>=6)return!1;let Se=pe.index(),ve=pe.parent;if(!ve||Se<=0)return!1;let oe=Y.doc.nodeAt(fe);if(!oe)return!1;let Ce=ve.child(Se-1),qe=fe-Ce.nodeSize,Xe=Y.doc.nodeAt(qe);if(!Xe)return!1;let dt=Xe.child(0),rt=Xe.child(1),it=Xe.child(2),St=qe+1+dt.nodeSize+rt.nodeSize+it.nodeSize-1,pt=Y.tr.delete(fe,fe+oe.nodeSize).insert(St,oe),ot=pt.doc.nodeAt(qe);return ot?.type?.name==="outlineSection"&&ot.attrs?.collapsed&&(pt=pt.setNodeMarkup(qe,void 0,{...ot.attrs,collapsed:!1})),pt=pt.setMeta(de,!0),pt=pt.setSelection(te.near(pt.doc.resolve(St+2),1)),ce(pt.scrollIntoView()),!0})}catch{}},Mt=()=>{try{if(!te)return;e.commands.command(({state:Y,dispatch:ce})=>{let fe=Y.selection.$from,pe=null,ue=null;for(let dt=fe.depth;dt>0;dt-=1)if(fe.node(dt)?.type?.name==="outlineSection")if(pe===null)pe=dt;else{ue=dt;break}if(pe===null||ue===null)return!1;let Se=fe.before(pe),ve=fe.before(ue),oe=Y.doc.nodeAt(Se);if(!oe)return!1;let Ce=Y.tr.delete(Se,Se+oe.nodeSize),qe=Ce.doc.nodeAt(ve);if(!qe)return!1;let Xe=ve+qe.nodeSize;return Ce=Ce.insert(Xe,oe),Ce=Ce.setMeta(de,!0),Ce=Ce.setSelection(te.near(Ce.doc.resolve(Xe+2),1)),ce(Ce.scrollIntoView()),!0})}catch{}},$e=()=>{try{if(!te)return;e.commands.command(({state:Y,dispatch:ce})=>{let fe=Ht(Y.doc,Y.selection.$from);if(typeof fe!="number")return!1;let pe=Y.doc.nodeAt(fe);if(!pe)return!1;let ue=String(pe.attrs?.id||"").trim(),Se=Y.doc.resolve(fe),ve=Se.index(),oe=Se.parent;if(!oe)return!1;let Ce=Y.doc.type.schema;if(oe.childCount<=1){let St=Ce.nodes.outlineSection.create({...pe.attrs,collapsed:!1},[Ce.nodes.outlineHeading.create({},[]),Ce.nodes.outlineBody.create({},[Ce.nodes.paragraph.create({},[])]),Ce.nodes.outlineChildren.create({},[])]),pt=Y.tr.replaceWith(fe,fe+pe.nodeSize,St);pt=pt.setMeta(de,!0);let ot=St.child(0),Ze=fe+1+ot.nodeSize;return pt=pt.setSelection(te.near(pt.doc.resolve(Ze+2),1)),ce(pt.scrollIntoView()),!0}ue&&zo(ue);let qe=ve>0,Xe=qe?oe.child(ve-1):null,dt=qe?fe-Xe.nodeSize:null,rt=Y.tr.delete(fe,fe+pe.nodeSize);rt=rt.setMeta(de,!0);let it=qe&&typeof dt=="number"?dt:Math.min(rt.doc.content.size,fe),We=rt.doc.nodeAt(it);if(We?.type?.name==="outlineSection"){let St=We.child(0),pt=We.child(1),ot=it+1+St.nodeSize;pt.childCount||(rt=rt.insert(ot+1,Ce.nodes.paragraph.create({},[]))),rt=rt.setSelection(te.near(rt.doc.resolve(ot+2),1))}return ce(rt.scrollIntoView()),!0})}catch{}},at=()=>{try{if(!te)return;e.commands.command(({state:Y,dispatch:ce})=>{let fe=Ht(Y.doc,Y.selection.$from);if(typeof fe!="number")return!1;let pe=Y.doc.nodeAt(fe);if(!pe)return!1;let ue=Y.doc.type.schema,Se=fe+pe.nodeSize,ve=fn(),oe=ue.nodes.outlineSection.create({id:ve,collapsed:!1},[ue.nodes.outlineHeading.create({},[]),ue.nodes.outlineBody.create({},[ue.nodes.paragraph.create({},[])]),ue.nodes.outlineChildren.create({},[])]),Ce=Y.tr.insert(Se,oe);return Ce=Ce.setSelection(te.create(Ce.doc,Se+2)),Ce=Ce.setMeta(de,!0),be&&(Ce=Ce.setMeta(be,{type:"enter",sectionId:ve})),ce(Ce.scrollIntoView()),!0})}catch{}};we.push(d(r.deleteBtn,()=>$e())),we.push(d(r.moveUpBtn,()=>Je("up"))),we.push(d(r.moveDownBtn,()=>Je("down"))),we.push(d(r.outdentBtn,()=>Mt())),we.push(d(r.indentBtn,()=>vt())),we.push(d(r.newBelowBtn,()=>at()));let Dt=0,tn=Y=>{try{return Y?.target&&Y.target.nodeType===1?Y.target:Y?.target?.parentElement||null}catch{return null}},Nt=Y=>{let ce=tn(Y);if(!ce)return null;let fe=ce.closest?.(".outline-toolbar__dropdown-btn")||null;return!fe||!t.contains(fe)?null:fe},er=(Y,{source:ce})=>{try{let fe=Date.now();if(Dt&&fe-Dt<700){h("toggle.skip.dedupe",{source:ce,dtMs:fe-Dt});return}let pe=Nt(Y);if(!pe){h("toggle.skip.no-btn",{source:ce,targetClass:String(tn(Y)?.className||"")});return}if(pe.disabled){h("toggle.skip.disabled",{source:ce,btnId:pe.id||null});return}Y?.cancelable&&Y.preventDefault(),Y.stopPropagation();let ue=w(pe);h("toggle",{source:ce,ok:ue,btnId:pe.id||null,menuId:pe.getAttribute("aria-controls")||null,expanded:pe.getAttribute("aria-expanded")||null}),ue&&(Dt=fe)}catch(fe){h("toggle.error",{source:ce,message:String(fe?.message||fe||"")})}},br=Y=>{try{let ce=String(Y?.pointerType||"");if(ce!=="touch"&&ce!=="pen")return}catch{return}er(Y,{source:"pointerdown"})},wr=Y=>{er(Y,{source:"click"})};try{t.addEventListener("pointerdown",br,!0),we.push(()=>t.removeEventListener("pointerdown",br,!0))}catch{}t.addEventListener("click",wr,!0),we.push(()=>t.removeEventListener("click",wr,!0));let cn=Y=>{try{if(!a.isOutlineEditing)return;t.contains(Y.target)||m()}catch{}},wn=Y=>{try{if(!a.isOutlineEditing)return;t.contains(Y.target)||m()}catch{}};try{document.addEventListener("touchstart",cn,{passive:!0}),we.push(()=>document.removeEventListener("touchstart",cn))}catch{}document.addEventListener("click",wn),we.push(()=>document.removeEventListener("click",wn));for(let Y of c)we.push(d(Y,()=>{let ce=Y.dataset.outlineAction||"";if(ce==="insertHttpLink"){m(),O().finally(()=>me());return}if(ce==="insertArticleLink"){m(),W().finally(()=>me());return}let fe=S(ce);m(),fe&&me()}));for(let Y of l)we.push(d(Y,()=>{let ce=Y.getAttribute("data-outline-clipboard-action")||"";if(!ce)return;m();let fe=Bn||null,pe=Gr instanceof Set?Gr:new Set,ue=pe.size?new Set(pe):fe?new Set([fe]):new Set;if(ce==="toggleSelectMode"){qo(!Tr);return}if(ce==="clear"){ia(null),P("\u0411\u0443\u0444\u0435\u0440 \u043E\u0447\u0438\u0449\u0435\u043D");return}if(re){if(ce==="copy"||ce==="cut"){if(!ue.size){P("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A");return}let Se=Vy(re.state.doc,ue);if(!Se.length){P("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A");return}let ve=Se.map(qe=>qe.node.toJSON());try{let qe=Se.map(Xe=>Hp(Xe.node)).filter(Boolean).join(`

`);qy(qe)}catch{}if(ia({mode:ce==="cut"?"cut":"copy",sourceArticleId:Et||a.articleId||null,createdAt:new Date().toISOString(),sections:ve}),ce==="copy"){P(`\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${ve.length}`);return}let oe=[];for(let qe of Se){let Xe=kt(re.state.doc,qe.id),dt=typeof Xe=="number"?re.state.doc.nodeAt(Xe):null;typeof Xe=="number"&&dt&&oe.push({pos:Xe,size:dt.nodeSize})}oe.sort((qe,Xe)=>Xe.pos-qe.pos);let Ce=re.state.tr;for(let{pos:qe,size:Xe}of oe)Ce=Ce.delete(qe,qe+Xe);Ce=Ce.setMeta(de,!0),re.view.dispatch(Ce.scrollIntoView()),re.view.focus(),bn=!0,yn({delayMs:200}),qo(!1),P(`\u0412\u044B\u0440\u0435\u0437\u0430\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${ve.length}`);return}if(ce==="paste"){let Se=Cl();if(!Se||!Array.isArray(Se.sections)||!Se.sections.length){P("\u0411\u0443\u0444\u0435\u0440 \u043F\u0443\u0441\u0442");return}let ve=re.state,oe=ve.doc.content.size;if(fe){let We=kt(ve.doc,fe),St=typeof We=="number"?ve.doc.nodeAt(We):null;typeof We=="number"&&St&&(oe=We+St.nodeSize)}let Ce=new Set;try{ve.doc.descendants(We=>{if(We?.type?.name!=="outlineSection")return;let St=String(We.attrs?.id||"").trim();St&&Ce.add(St)})}catch{}let qe=[];if(Se.mode==="copy")for(let We of Se.sections)qe.push(Rp(We,()=>fn()));else for(let We of Se.sections){let St=String(We?.attrs?.id||"").trim();if(St&&Ce.has(St)){P("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C: \u0431\u043B\u043E\u043A \u0441 \u0442\u0430\u043A\u0438\u043C id \u0443\u0436\u0435 \u0435\u0441\u0442\u044C");return}qe.push(Dl(We))}let Xe=ve.doc.type.schema,dt=[];for(let We of qe)try{let St=Xe.nodeFromJSON(We);St?.type?.name==="outlineSection"&&dt.push(St)}catch{}if(!dt.length){P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438");return}let rt=ve.tr,it=oe;for(let We of dt)rt=rt.insert(it,We),it+=We.nodeSize;rt=rt.setMeta(de,!0),re.view.dispatch(rt.scrollIntoView()),re.view.focus(),bn=!0,yn({delayMs:200}),Se.mode==="cut"&&ia(null),qo(!1),P(`\u0412\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${dt.length}`)}}}));let Kt=Y=>{a.isOutlineEditing&&(t.contains(Y.target)||m())},Bt=Y=>{a.isOutlineEditing&&Y.key==="Escape"&&m()};document.addEventListener("pointerdown",Kt),document.addEventListener("keydown",Bt),we.push(()=>document.removeEventListener("pointerdown",Kt)),we.push(()=>document.removeEventListener("keydown",Bt));let Yt=e.on("transaction",me),tr=e.on("selectionUpdate",me);we.push(()=>Yt?.()),we.push(()=>tr?.());try{let Y=Zy({setActiveTagKey:ce=>{try{fa?.(ce)}catch{}}});we.push(()=>Y?.())}catch{}me(),ra=()=>{ne&&(window.cancelAnimationFrame(ne),ne=null);for(let Y of we)try{Y()}catch{}}}function yb(){if(ra)try{ra()}catch{}ra=null}function Cr(e=""){let t=String(e||"");a.outlineStatusText=t,p.updatedAt&&a.isOutlineEditing&&(p.updatedAt.textContent=t)}function bb(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=r.child(1),s=t+1+o.nodeSize,c=n.tr;if(!i.childCount){let d=n.doc.type.schema;c=c.insert(s+1,d.nodes.paragraph.create({},[]))}let{TextSelection:l}=ze?.pmStateMod||{};return l?(c=c.setSelection(l.near(c.doc.resolve(s+2),1)),e.view.dispatch(c.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0):!1}catch{return!1}}function wb(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=t+1,{TextSelection:s}=ze?.pmStateMod||{};if(!s)return!1;let c=i+1,l=i+o.nodeSize-1,d=Math.min(Math.max(c,c),Math.max(c,l)),u=n.tr.setSelection(s.near(n.doc.resolve(d),1));return u=u.setMeta(de,!0),e.view.dispatch(u.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0}catch{return!1}}function Sb(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=t+1,{TextSelection:s}=ze?.pmStateMod||{};if(!s)return!1;let c=i+1,l=i+o.nodeSize-1,d=Math.max(c,l),u=n.tr.setSelection(s.near(n.doc.resolve(d),-1));return u=u.setMeta(de,!0),e.view.dispatch(u.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0}catch{return!1}}function xb(e,t){try{if(!e)return!1;let n=String(t||"").trim();if(!n)return!1;let r=e.state,o=kt(r.doc,n);if(typeof o!="number")return!1;let i=r.doc.nodeAt(o);if(!i||i.type?.name!=="outlineSection")return!1;if(i.attrs?.collapsed)return wb(e,o);try{if(!i.child(1)?.childCount)return Sb(e,o)}catch{}return bb(e,o)}catch{return!1}}function kb(e,t,{block:n="center"}={}){try{let r=String(t||"").trim();if(!e||!r)return!1;let o=e.view;if(!o?.dom?.querySelector)return!1;let i=typeof CSS<"u"&&CSS.escape?CSS.escape(r):r.replace(/"/g,'\\"'),s=()=>{try{let c=o.dom?.querySelector?.(`[data-outline-section][data-section-id="${i}"]`)||o.dom?.querySelector?.(`[data-section-id="${i}"]`);c&&typeof c.scrollIntoView=="function"&&c.scrollIntoView({block:n||"center",inline:"nearest"})}catch{}};try{window.requestAnimationFrame(s)}catch{}try{setTimeout(s,80)}catch{}return!0}catch{return!1}}async function Ab(){if(ze)return ze;if(typeof window>"u")throw new Error("Outline editor is browser-only");let e=lo()?performance.now():0,t=await import("/outline/tiptap.bundle.js");return e&&Vo("import tiptap.bundle.js",{ms:Math.round(performance.now()-e)}),ze={core:t.core,starterKitMod:t.starterKitMod,htmlMod:t.htmlMod,pmStateMod:t.pmStateMod,pmViewMod:t.pmViewMod,pmTablesMod:t.pmTablesMod,linkMod:t.linkMod,imageMod:t.imageMod,mentionMod:t.mentionMod,tableMod:t.tableMod,tableRowMod:t.tableRowMod,tableCellMod:t.tableCellMod,tableHeaderMod:t.tableHeaderMod,uniqueIdMod:t.uniqueIdMod,markdownMod:t.markdownMod},ze}function Ib({blocks:e,parseHtmlToNodes:t}){let n=i=>Array.isArray(i)&&i.length>0?i:[{type:"paragraph",content:[]}],r=i=>{let s=String(i?.id||fn()),c=!!i?.collapsed,l=jn(String(i?.text||"")),d=Ml(l.titleHtml)||"",u=n(t(l.bodyHtml||"")),m=Array.isArray(i?.children)?i.children:[];return{type:"outlineSection",attrs:{id:s,collapsed:c},content:[{type:"outlineHeading",content:d?[{type:"text",text:d}]:[]},{type:"outlineBody",content:u},{type:"outlineChildren",content:m.map(r)}]}},o=(Array.isArray(e)?e:[]).map(r);return{type:"doc",content:o.length?o:[r({id:fn(),text:"",collapsed:!1,children:[]})]}}function Eb(e){try{let t=String(e||"").trim();if(!t)return null;let n=window?.localStorage?.getItem?.("ttree_outline_last_active_v1")||"{}",r=JSON.parse(n||"{}"),o=r&&typeof r=="object"?r[t]:null;if(!o||typeof o!="object")return null;let i=String(o.sectionId||"").trim();return i?{sectionId:i,collapsed:!!o.collapsed}:null}catch{return null}}function Qp(e,t,n){try{let r=String(e||"").trim(),o=String(t||"").trim();if(!r||!o)return!1;let i=window?.localStorage?.getItem?.("ttree_outline_last_active_v1")||"{}",s=JSON.parse(i||"{}"),c=s&&typeof s=="object"?s:{};return c[r]={sectionId:o,collapsed:!!n,savedAt:new Date().toISOString()},window?.localStorage?.setItem?.("ttree_outline_last_active_v1",JSON.stringify(c)),!0}catch{return!1}}function vp(e){try{let t=Et||a.articleId||null;if(!t||!e||e.isDestroyed)return!1;let n=e.state,r=Ht(n.doc,n.selection.$from);if(typeof r!="number")return!1;let o=n.doc.nodeAt(r);if(!o||o.type?.name!=="outlineSection")return!1;let i=String(o.attrs?.id||"").trim();if(!i)return!1;let s=!!o.attrs?.collapsed;return ea.articleId===t&&ea.sectionId===i&&ea.collapsed===s?!1:(ea={articleId:t,sectionId:i,collapsed:s},Qp(t,i,s))}catch{return!1}}function vb(e,{lines:t=4}={}){try{if(!e||e.isDestroyed)return!1;let n=e.view;if(!n||!n.state||!n.dom)return!1;let r=n.state.selection;return!r||typeof r.from!="number"?!1:(ta&&cancelAnimationFrame(ta),ta=requestAnimationFrame(()=>{ta=null;try{let o=n.coordsAtPos(r.from);if(!o||typeof o.bottom!="number")return;let s=(b=>{try{let S=b;for(;S&&S!==document.body&&S!==document.documentElement;){let k=window.getComputedStyle(S),A=String(k.overflowY||"");if((A==="auto"||A==="scroll"||A==="overlay")&&S.scrollHeight>S.clientHeight+2)return S;S=S.parentElement}}catch{}return document.scrollingElement||document.documentElement})(n.dom),c=window.getComputedStyle(n.dom),l=String(c.lineHeight||"").trim(),d=l==="normal"?20:Number.parseFloat(l)||20,u=Math.max(24,d*Math.max(1,Number(t)||4)+12),m=window.innerHeight||0,y=0;if(s&&s!==document.scrollingElement&&s!==document.documentElement&&s!==document.body){let b=s.getBoundingClientRect();y=b.top,m=b.height}if(!m)return;let w=o.bottom-y,g=m-u;if(w<=g)return;let f=w-g,h=Math.max(0,(s.scrollTop||0)+f);s.scrollTop=h}catch{}}),!0)}catch{return!1}}function Ht(e,t){try{if(t?.nodeAfter?.type?.name==="outlineSection")return t.pos}catch{}for(let n=t.depth;n>0;n-=1)if(t.node(n)?.type?.name==="outlineSection")return t.before(n);return null}function ga(e){if(!e)return"";let t=e.child(0),n=e.child(1),r=vr(t?.textContent||""),o="";try{o=vr(n?.textBetween?.(0,n.content.size,`
`,`
`)||"")}catch{o=vr(n?.textContent||"")}return vr(`${r}
${o}`)}function Tp(e){if(!e)return"";let t=e.child(1),n="";try{n=vr(t?.textBetween?.(0,t.content.size,`
`,`
`)||"")}catch{n=vr(t?.textContent||"")}return n}function Cp(e){if(!Il||!El)return"";let t=[];return e?.content?.forEach?.(o=>{t.push(o.toJSON())}),(Il({type:"doc",content:t},El)||""||"").trim()}function Bp(e){try{return vr(String(e?.textContent||"").replace(/\u00a0/g," ")).trim()}catch{return""}}function Tb(e){try{let t=document.createElement("template");return t.innerHTML=String(e||""),vr(String(t.content.textContent||"").replace(/\u00a0/g," ")).trim()}catch{return""}}function Xp(e){try{if(!e)return null;let t=e.state?.selection||null;if(!t)return null;let n=Number.isFinite(t.anchor)?t.anchor:t.from,r=Number.isFinite(t.head)?t.head:t.to,o=t.$from||null,i=null;try{let s=o?Ht(e.state.doc,o):null;if(typeof s=="number"){let c=e.state.doc.nodeAt(s);i=String(c?.attrs?.id||"")||null}}catch{i=null}return!Number.isFinite(n)||!Number.isFinite(r)?null:{anchor:n,head:r,sectionId:i}}catch{return null}}function Zp(e,t,n){try{if(!e?.view||!t)return!1;let{TextSelection:r}=ze?.pmStateMod||{};if(!r||!n)return e.view.dispatch(t),!0;let o=t.doc?.content?.size??null;if(!Number.isFinite(o))return e.view.dispatch(t),!0;let i=t.mapping.map(Math.max(0,Math.min(n.anchor,o)),1),s=t.mapping.map(Math.max(0,Math.min(n.head,o)),1);try{t=t.setSelection(r.create(t.doc,i,s))}catch{}return e.view.dispatch(t),!0}catch{try{return e?.view?.dispatch?.(t),!0}catch{return!1}}}function Cb(e,t,n,r={}){if(!e||!t)return!1;let o=kt(e.state.doc,t);if(typeof o!="number")return!1;let i=e.state.doc.nodeAt(o);if(!i)return!1;let s=e.state.schema,c=i.child(0),l=o+1,d=String(n||"").replace(/\u00a0/g," ").trim(),u=s.nodes.outlineHeading.create({},d?[s.text(d)]:[]),m=e.state.tr.replaceWith(l,l+c.nodeSize,u).setMeta(de,!0),y=r?.preserveSelection?Xp(e):null;return Zp(e,m,y),!0}function Bb(e,t,n,r={}){if(!e||!t||!Oi)return!1;let o=kt(e.state.doc,t);if(typeof o!="number")return!1;let i=e.state.doc.nodeAt(o);if(!i)return!1;let s=i.child(0),c=i.child(1),l=o+1+s.nodeSize,d=e.state.schema,u=[];try{u=Oi(n||"")}catch{u=[]}let m=[];try{m=(Array.isArray(u)?u:[]).map(f=>d.nodeFromJSON(f))}catch{m=[d.nodes.paragraph.create({},[])]}m.length||(m=[d.nodes.paragraph.create({},[])]);let y=d.nodes.outlineBody.create({},m),w=e.state.tr.replaceWith(l,l+c.nodeSize,y).setMeta(de,!0),g=r?.preserveSelection?Xp(e):null;return Zp(e,w,g),!0}function Pl(e){if(!e)return!0;let t=e.child(0);return!vr(t?.textContent||"")}function Lb(e,t,n){if(!e||!t)return!1;let r=kt(e.state.doc,t);if(typeof r!="number")return!1;let o=e.state.doc.nodeAt(r);if(!o||!Pl(o))return!1;let i=o.child(0),s=r+1,c=s+1,l=s+i.nodeSize-1,d=String(n||"").trim();if(!d)return!1;let u=d.length>200?d.slice(0,200):d,m=e.state.tr.insertText(u,c,l).setMeta(de,!0);return e.view.dispatch(m),!0}function Mb(e){go.clear(),e.descendants(t=>{if(t?.type?.name!=="outlineSection")return;let n=String(t.attrs?.id||"");n&&go.set(n,ga(t))})}function kt(e,t){let n=null;return e.descendants((r,o)=>{if(n!==null)return!1;r?.type?.name==="outlineSection"&&String(r.attrs?.id||"")===String(t||"")&&(n=o)}),n}function Nb(e,t){try{let n=e.doc,r=kt(n,t),o=typeof r=="number"?n.nodeAt(r):null;if(!o)return null;let i=e.schema,s=i.marks?.code||null,c=i.nodes?.codeBlock||null;if(!s||!c)return null;let l=o.child(0),d=o.child(1);if(!l||!d)return null;let m=r+1+l.nodeSize+1,y=[];if(d.descendants((g,f)=>{if(!g||g.type?.name!=="paragraph")return;let h=!1,b=!1,S=!0;for(let v=0;v<g.childCount;v+=1){let B=g.child(v);if(B){if(B.type?.name==="hardBreak"){b=!0;continue}if(B.isText){if(!String(B.text||""))continue;if(!(Array.isArray(B.marks)?B.marks:[]).some(J=>J?.type===s)){S=!1;break}h=!0;continue}S=!1;break}}if(!S||!h||!b)return;let k="";for(let v=0;v<g.childCount;v+=1){let B=g.child(v);if(B){if(B.type?.name==="hardBreak"){k+=`
`;continue}B.isText&&(k+=String(B.text||""))}}if(!k.trim())return;let A=m+f;y.push({from:A,to:A+g.nodeSize,text:k})}),!y.length)return null;let w=e.tr;for(let g=y.length-1;g>=0;g-=1){let{from:f,to:h,text:b}=y[g],S=w.doc.resolve(f),k=S.parent,A=S.index();if(!k?.canReplaceWith?.(A,A+1,c))continue;let v=i.text(b),B=c.create(null,v);w=w.replaceWith(f,h,B)}return w.docChanged?w.setMeta(de,!0):null}catch{return null}}function em(e,t,n){if(!e||!t||!n||a.article?.encrypted)return;let r=kt(t,n),o=typeof r=="number"?t.nodeAt(r):null;if(!o||!Pl(o))return;let i=Tp(o);if(!i)return;let s=Nl(i),c=bl.get(n)||null;c?.inFlight||c?.bodyHash!==s&&(bl.set(n,{bodyHash:s,inFlight:!0}),lu(i).then(l=>{let d=String(l?.title||"").trim();if(!d||d.length>200)return;let u=e.state.doc,m=kt(u,n),y=typeof m=="number"?u.nodeAt(m):null;if(!y||!Pl(y))return;let w=Tp(y);if(!(Nl(w)!==s||!Lb(e,n,d))){bn=!0;try{let f=Et||a.articleId||null;f&&(_l({articleId:f,doc:e.state.doc,sectionId:n,reason:"generate_title"}),Cr("\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438 \u043D\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044E"))}catch{}yn({delayMs:900})}}).catch(()=>{}).finally(()=>{bl.set(n,{bodyHash:s,inFlight:!1})}))}function Pb(e,t,n){if(!(!e||!t)&&!(!Array.isArray(n)||!n.length)&&!a.article?.encrypted&&!(typeof navigator<"u"&&navigator&&navigator.onLine===!1)){try{if((be?.getState?.(e.state)||null)?.editingSectionId)return}catch{}for(let r of n)try{em(e,t,r)}catch{}}}function Lp(e,t,n){let r=String(n||"").trim(),o=(B,H={})=>en("skip",{reason:B,sectionId:r,...H});if(!e||!t||!r){o("missing_args",{hasEditor:!!e,hasDoc:!!t,hasSectionId:!!r});return}if(a.article?.encrypted){o("encrypted_article");return}try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1){o("offline");return}}catch{}let i=kt(t,r),s=typeof i=="number"?t.nodeAt(i):null;if(!s){o("section_not_found",{pos:typeof i=="number"?i:null});return}let c=s.child(0),l=s.child(1),d=Bp(c),u=d?`<p>${_i(d)}</p>`:"",m=Cp(l);if(!u&&!m){o("empty_heading_and_body");return}let y=u?Fo(u):"",w=m?Fo(m):"",g=(B,H)=>{if(!H||B?.inFlight||B?.status==="ok"&&B?.htmlHash===H)return!0;if(B?.status==="error"&&B?.htmlHash===H){let O=Number(B?.lastAttemptAtMs||0)||0;if(Date.now()-O<Oy)return!0}return!1},f=$o.get(r)||null,h=Ho.get(r)||null,b=g(f,y),S=g(h,w);if(b&&S){o("already_ok_or_in_flight",{headingHash:y||null,bodyHash:w||null});try{Ko.delete(r)}catch{}return}let k=b,A=S,v=()=>{try{k&&A&&Ko.delete(r)}catch{}};b||(en("start_heading",{sectionId:r,htmlHash:y}),$o.set(r,{htmlHash:y,inFlight:!0,status:f?.status||"ok",lastAttemptAtMs:Date.now()}),oc(u).then(B=>{if(B&&B.ok===!1){en("unavailable_heading",{sectionId:r,reason:String(B.reason||"")}),$o.set(r,{htmlHash:y,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()});let Je=Date.now();Je-Zs>6e4&&(Zs=Je,P("\u041A\u043E\u0440\u0440\u0435\u043A\u0442\u0443\u0440\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 (\u043D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0430 \u043A OpenAI)."));return}let H=String(B?.html||"").trim();if(!H){en("skip_apply_heading",{sectionId:r,reason:"empty_corrected_html"});return}let O=Tb(H);if(!O){en("skip_apply_heading",{sectionId:r,reason:"empty_corrected_plain"});return}let W=e.state.doc,J=kt(W,r),ne=typeof J=="number"?W.nodeAt(J):null;if(!ne){en("skip_apply_heading",{sectionId:r,reason:"section_not_found_current_doc"});return}let me=Bp(ne.child(0)),we=me?`<p>${_i(me)}</p>`:"";if(Fo(we)!==y){en("skip_apply_heading",{sectionId:r,reason:"heading_changed_since_request"});return}if(Fo(`<p>${_i(O)}</p>`)===y){en("skip_apply_heading",{sectionId:r,reason:"no_changes_from_server"});return}if(!Cb(e,r,O,{preserveSelection:!0})){en("skip_apply_heading",{sectionId:r,reason:"apply_failed"});return}bn=!0,yn({delayMs:900})}).catch(()=>{en("error_heading",{sectionId:r,htmlHash:y}),$o.set(r,{htmlHash:y,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()})}).finally(()=>{($o.get(r)||null)?.status!=="error"&&$o.set(r,{htmlHash:y,inFlight:!1,status:"ok",lastAttemptAtMs:Date.now()}),en("done_heading",{sectionId:r,htmlHash:y}),k=!0,v()})),S||(en("start",{sectionId:r,htmlHash:w}),Ho.set(r,{htmlHash:w,inFlight:!0,status:h?.status||"ok",lastAttemptAtMs:Date.now()}),oc(m).then(B=>{if(B&&B.ok===!1){en("unavailable",{sectionId:r,reason:String(B.reason||"")}),Ho.set(r,{htmlHash:w,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()});let we=Date.now();we-Zs>6e4&&(Zs=we,P("\u041A\u043E\u0440\u0440\u0435\u043A\u0442\u0443\u0440\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 (\u043D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0430 \u043A OpenAI)."));return}let H=String(B?.html||"").trim();if(!H){en("skip_apply",{sectionId:r,reason:"empty_corrected_html"});return}let O=e.state.doc,W=kt(O,r),J=typeof W=="number"?O.nodeAt(W):null;if(!J){en("skip_apply",{sectionId:r,reason:"section_not_found_current_doc"});return}let ne=Cp(J.child(1));if(Fo(ne)!==w){en("skip_apply",{sectionId:r,reason:"body_changed_since_request"});return}if(Fo(H)===w){en("skip_apply",{sectionId:r,reason:"no_changes_from_server"});return}if(!Bb(e,r,H,{preserveSelection:!0})){en("skip_apply",{sectionId:r,reason:"apply_failed"});return}bn=!0,yn({delayMs:900})}).catch(()=>{en("error",{sectionId:r,htmlHash:w}),Ho.set(r,{htmlHash:w,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()})}).finally(()=>{(Ho.get(r)||null)?.status!=="error"&&Ho.set(r,{htmlHash:w,inFlight:!1,status:"ok",lastAttemptAtMs:Date.now()}),en("done",{sectionId:r,htmlHash:w}),A=!0,v()}))}function fo(e,t){if(!t)return!1;let n=kt(e,t);if(typeof n!="number")return!1;let r=e.nodeAt(n);if(!r)return!1;let o=ga(r),i=go.get(t)||"";if(o===i)return!1;yo.add(t);try{Ko.add(t)}catch{}return!0}function yn({delayMs:e=1200}={}){a.isOutlineEditing&&re&&(a.isPublicView||Et&&a.articleId&&Et!==a.articleId||(yr&&clearTimeout(yr),yr=setTimeout(()=>{yr=null,Di()},Math.max(200,e))))}async function Di({force:e=!1}={}){if(a.isOutlineEditing&&re&&!a.isPublicView&&!(Et&&a.articleId&&Et!==a.articleId)&&!na&&!(!e&&!bn&&!yo.size)){na=!0,Cr("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C\u2026");try{try{let t=re.state,n=Ht(t.doc,t.selection.$from);if(typeof n=="number"){let r=t.doc.nodeAt(n),o=String(r?.attrs?.id||"");o&&fo(t.doc,o)}}catch{}await Db({silent:!0,mode:"queue"})}finally{na=!1}}}async function tm(){if(!p.outlineEditor)return;let e=p.outlineEditor.querySelector("#outlineEditorContent");if(!e){P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043C\u043E\u043D\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440");return}if(Fd(),Li)return Li;jr("outline.mount.start",{outlineArticleId:Et,hadInstance:!!re,hadTiptap:!!ze,mounted:kl}),Li=(async()=>{let t=lo()?performance.now():0,n=lo()?performance.now():0,{core:r,starterKitMod:o,htmlMod:i,pmStateMod:s,pmViewMod:c}=await Ab();n&&Vo("loadTiptap()",{ms:Math.round(performance.now()-n)});let{Editor:l,Node:d,Extension:u,Mark:m,InputRule:y,mergeAttributes:w}=r,g=o.default||o.StarterKit||o,{generateJSON:f,generateHTML:h}=i,{TextSelection:b}=s,{Plugin:S,PluginKey:k}=s,{Decoration:A,DecorationSet:v}=c,B=ze.linkMod.default||ze.linkMod.Link||ze.linkMod,H=ze.imageMod.default||ze.imageMod.Image||ze.imageMod,O=ze.mentionMod?.default||ze.mentionMod?.Mention||ze.mentionMod,W=ze.tableMod.TableKit||ze.tableMod.tableKit;Ot={TableMap:ze.pmTablesMod?.TableMap||null,CellSelection:ze.pmTablesMod?.CellSelection||null,moveTableColumn:ze.pmTablesMod?.moveTableColumn||null,moveTableRow:ze.pmTablesMod?.moveTableRow||null,addRowBefore:ze.pmTablesMod?.addRowBefore||null,addRowAfter:ze.pmTablesMod?.addRowAfter||null,deleteRow:ze.pmTablesMod?.deleteRow||null,addColumnBefore:ze.pmTablesMod?.addColumnBefore||null,addColumnAfter:ze.pmTablesMod?.addColumnAfter||null,deleteColumn:ze.pmTablesMod?.deleteColumn||null,toggleHeaderRow:ze.pmTablesMod?.toggleHeaderRow||null,toggleHeaderColumn:ze.pmTablesMod?.toggleHeaderColumn||null};let J=ze.uniqueIdMod.default||ze.uniqueIdMod.UniqueID||ze.uniqueIdMod,ne=ze.markdownMod?.Markdown||ze.markdownMod?.default?.Markdown||ze.markdownMod?.default||null,me=I=>{let x=String(I||"").trim();if(!x)return null;let L=x.match(/(\d+(?:\.\d+)?)px/i);if(!L)return null;let M=Number.parseFloat(L[1]);return Number.isFinite(M)?M:null},we=new k("outlineTagHighlighter"),te=null,he=u.create({name:"outlineTagSuggestKeys",addProseMirrorPlugins(){return[new S({key:new k("outlineTagSuggestKeys"),props:{handleKeyDown(I,x){try{return te?.isOpen?.()?!!te.handleKeyDown?.(x):!1}catch{return!1}}}})]}}),Je=(()=>{if(!O||typeof O.extend!="function")return null;let I=()=>{let x=null,L=null,M=[],z=0,$=null,V=null,j=()=>{x||(x=document.createElement("div"),x.className="tt-tag-suggest",L=document.createElement("div"),L.className="tt-tag-suggest__list",x.appendChild(L),document.body.appendChild(x))},F=()=>{try{x?.remove()}catch{}x=null,L=null,M=[],z=0,$=null,te===V&&(te=null)},N=T=>{if(!x||!T)return;let _=T();_&&(x.style.left=`${Math.max(8,_.left)}px`,x.style.top=`${Math.max(8,_.bottom+6)}px`)},C=T=>{if(!(!x||!L)&&($=T||null,M=Array.isArray(T?.items)?T.items:[],L.innerHTML="",M.forEach((_,U)=>{let G=document.createElement("button");G.type="button",G.className=U===z?"tt-tag-suggest__item active":"tt-tag-suggest__item",G.textContent=String(_?.label||_?.key||""),G.addEventListener("pointerdown",q=>{q.preventDefault(),q.stopPropagation(),T.command(_)}),L.appendChild(G)}),!M.length)){let _=document.createElement("div");_.className="tt-tag-suggest__empty",_.textContent="\u041D\u0435\u0442 \u0441\u043E\u0432\u043F\u0430\u0434\u0435\u043D\u0438\u0439",L.appendChild(_)}},E=T=>{let _=M.length;_&&(z=(z+T+_)%_)},D=T=>{if(!T||!x)return!1;if(T.key==="Escape")return T.preventDefault(),T.stopPropagation(),F(),!0;if(T.key===" "||T.code==="Space"){if(!$)return!1;if(!M.length){let U=Mi($?.query||"");return U?(T.preventDefault(),T.stopPropagation(),$.command({key:U,label:U}),!0):!1}T.preventDefault(),T.stopPropagation();let _=M[z];return _&&$.command(_),!0}if(T.key==="ArrowDown")return T.preventDefault(),T.stopPropagation(),E(1),C($),!0;if(T.key==="ArrowUp")return T.preventDefault(),T.stopPropagation(),E(-1),C($),!0;if(T.key==="Enter"){if(!$)return!1;T.preventDefault(),T.stopPropagation();let _=M[z];return _&&$.command(_),!0}return!1};return V={isOpen:()=>!!x,handleKeyDown:D},te=V,{char:"\\",allowedPrefixes:null,allowSpaces:!1,startOfLine:!1,items:({query:T})=>{let _=String(T||""),U=Mi(_),G=$d(),q=new Map,K=new Map;try{for(let[ge,xe]of G?.counts?.entries?.()||[]){let Be=String(ge||"").trim();Be&&(q.set(Be,Number(xe||0)||0),K.set(Be,String(G?.labelByKey?.get?.(Be)||Be)))}}catch{}for(let[ge,xe]of Br.counts.entries()){let Be=String(ge||"").trim();Be&&(q.has(Be)||q.set(Be,Number(xe||0)||0),K.has(Be)||K.set(Be,String(Br.labelByKey.get(Be)||Be)))}let ee=Array.from(q.entries()).map(([ge,xe])=>({key:ge,label:K.get(ge)||ge,count:xe})).sort((ge,xe)=>(xe.count||0)-(ge.count||0));return(U?ee.filter(ge=>String(ge.key||"").includes(U)||String(ge.label||"").toLowerCase().includes(U.toLowerCase())):ee).slice(0,8)},command:({editor:T,range:_,props:U})=>{try{let G=String(U?.key||U?.label||""),q=aa(G),K=Mi(q);if(!K)return;T.chain().focus().insertContentAt(_,[{type:"tag",attrs:{label:K,key:K}}]).insertContent(" ").run()}catch{}},render:()=>({onStart:T=>{z=0,j(),C(T),N(T.clientRect)},onUpdate:T=>{z=0,j(),C(T),N(T.clientRect)},onKeyDown:T=>D(T?.event),onExit:()=>F()})}};return O.extend({name:"tag",group:"inline",inline:!0,atom:!0,selectable:!1,addAttributes(){return{label:{default:""},key:{default:""}}},parseHTML(){return[{tag:'span[data-tt-tag="1"]'}]},renderText({node:x}){try{return aa(x?.attrs?.label||x?.attrs?.key||"")||""}catch{return""}},renderHTML({node:x,HTMLAttributes:L}){let M=aa(x?.attrs?.label||x?.attrs?.key||"")||"",z=Mi(x?.attrs?.key||M)||"";return["span",w(L,{"data-tt-tag":"1","data-tag-key":z,class:"tt-tag"}),M||z||""]}}).configure({suggestion:I()})})(),vt=u.create({name:"outlineTagHighlighter",addProseMirrorPlugins(){return[new S({key:we,state:{init:()=>({activeKey:null}),apply:(I,x)=>{let L=I.getMeta(we);return L&&Object.prototype.hasOwnProperty.call(L,"activeKey")?{activeKey:L.activeKey?String(L.activeKey):null}:x}},props:{decorations(I){let x=we.getState(I)?.activeKey||null,L=[];return I.doc.descendants((M,z)=>{if(M?.type?.name!=="tag")return;let $=String(M.attrs?.key||"").trim();if(!$)return;let V=x&&$===x?"tt-tag tt-tag--active":"tt-tag";L.push(A.node(z,z+M.nodeSize,{class:V}))}),L.length?v.create(I.doc,L):null}}})]}}),Mt=H.extend({inline:!0,group:"inline",addAttributes(){return{...typeof this.parent=="function"?this.parent():{},width:{default:320,parseHTML:x=>{try{let L=x,M=L&&L.classList&&L.classList.contains("resizable-image")?L:L?.closest?.(".resizable-image"),z=me(M?.style?.width||"");if(z!==null)return Math.round(z);let $=me(M?.getAttribute?.("style")||"")||me(L?.getAttribute?.("style")||"");if($!==null)return Math.round($);let V=M?.getAttribute?.("data-width")||L?.getAttribute?.("data-width")||"",j=Number.parseFloat(String(V||""));return Number.isFinite(j)&&j>0?Math.round(j):320}catch{return 320}},renderHTML:()=>({})},aspectRatio:{default:null,parseHTML:x=>{try{let L=x,M=L&&L.classList&&L.classList.contains("resizable-image")?L:L?.closest?.(".resizable-image"),z=M?.style?.aspectRatio||M?.getAttribute?.("data-aspect-ratio")||L?.getAttribute?.("data-aspect-ratio")||"",$=Number.parseFloat(String(z||"").replace(",","."));return Number.isFinite($)&&$>0?$:null}catch{return null}},renderHTML:()=>({})},uploadToken:{default:null,parseHTML:()=>null,renderHTML:()=>({})}}},parseHTML(){return[{tag:"span.resizable-image",getAttrs:I=>{let x=I,L=x?.querySelector?.("img"),M=L?.getAttribute?.("src")||"";if(!M)return!1;let z=L?.getAttribute?.("alt")||"",$=L?.getAttribute?.("title")||"",V=me(x?.style?.width||"")??320;return{src:M,alt:z,title:$,width:Math.round(V)}}},{tag:"img[src]",getAttrs:I=>{let x=I,L=x?.getAttribute?.("src")||"";if(!L)return!1;let M=x?.getAttribute?.("alt")||"",z=x?.getAttribute?.("title")||"";return{src:L,alt:M,title:z,width:320}}}]},renderHTML({node:I,HTMLAttributes:x}){let L=I?.attrs?.width,M=Number.isFinite(Number(L))?Math.round(Number(L)):320,z=I?.attrs?.aspectRatio,$=Number.isFinite(Number(z))&&Number(z)>0?Number(z):null,V={...x};return delete V.width,delete V.aspectRatio,delete V.uploadToken,V.style=`${String(V.style||"").trim()};width:100%;height:auto;display:block;`.replace(/^;\s*/,""),["span",w({class:"resizable-image",style:`width:${M}px;max-width:100%;${$?`aspect-ratio:${$.toFixed(6)};`:""}`,...$?{"data-aspect-ratio":String($)}:{}},{}),["span",{class:"resizable-image__inner"},["img",w(V,{draggable:"false"})]],["span",{class:"resizable-image__handle","data-direction":"e","aria-hidden":"true"}]]}});Il=h,El=[g.configure({heading:!1,link:!1}),B.configure({openOnClick:!1,protocols:js}),Mt,W.configure({table:{resizable:!0}})];let $e=u.create({name:"outlineImageUpload",addProseMirrorPlugins(){let I=(L,M)=>{let z=[];return Array.from(L||[]).forEach($=>{if($.kind!=="file")return;let V=typeof $.getAsFile=="function"?$.getAsFile():null;V&&Tl(V)&&z.push(V)}),!z.length&&M?.length&&Array.from(M).forEach($=>{Tl($)&&z.push($)}),z},x=(L,M,z,$)=>{try{if(!(be?.getState?.(L.state)||null)?.editingSectionId)return!1}catch{return!1}let V=I(z,$);if(!V.length)return!1;M.preventDefault(),M.stopPropagation();for(let j of V)Pp(L,j);return!0};return[new S({props:{handleDOMEvents:{paste(L,M){let z=M?.clipboardData?.items||null,$=M?.clipboardData?.files||null;return x(L,M,z,$)},drop(L,M){let z=M?.dataTransfer?.items||null,$=M?.dataTransfer?.files||null;return x(L,M,z,$)}}},view(L){return{update(M,z){try{let $=be?.getState?.(z)||{},V=be?.getState?.(M.state)||{},j=$.editingSectionId||null,F=V.editingSectionId||null;if(j&&!F){let N=String(j||"").trim(),C=Et||a.articleId||null;if(!N||!C)return;let E=!1;try{let D=kt(M.state.doc,N),T=typeof D=="number"?M.state.doc.nodeAt(D):null;T?.type?.name==="outlineSection"&&(E=!!T.attrs?.collapsed)}catch{}Qp(C,N,E);try{let D=kt(M.state.doc,N),T=typeof D=="number"?M.state.doc.nodeAt(D):null;if(!T||T.type?.name!=="outlineSection")return;let _=!go.has(N),U=_||fo(M.state.doc,N),G=!1;if(U){let K=T.child(0),ee=T.child(1),se=K?.toJSON?K.toJSON():null,Ae=ee?.toJSON?ee.toJSON():null;if(se&&Ae){let ge=Fp(se,Ae);if(ge>da){P(`\u0411\u043B\u043E\u043A \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 (${Math.ceil(ge/1024)} KB). \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C: ${Math.ceil(da/1024)} KB. \u0420\u0430\u0437\u0431\u0435\u0439\u0442\u0435 \u0431\u043B\u043E\u043A \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E.`);try{let De=M.state.tr.setMeta(de,!0);De=De.setMeta(be,{type:"enter",sectionId:N}),M.dispatch(De)}catch{}return}let xe=Date.now(),Be=$p(C,N);try{ht("outline.enqueue.section_upsert_content",{articleId:C,sectionId:N,seq:Be,bytes:ge,reason:_?"exit_edit_mode_new_section":"exit_edit_mode"})}catch{}G=!0,Gt("section_upsert_content",{articleId:C,payload:{sectionId:N,headingJson:se,bodyJson:Ae,seq:Be,clientQueuedAt:xe},coalesceKey:`content:${C}:${N}`})}}let q=!1;if(_||cr||rn){let K=Ri(M.state.doc);if(K.length){let ee=null;try{ee=K.filter(se=>se&&(se.parentId==null||se.parentId==="")&&Number(se.position)>=0).sort((se,Ae)=>Number(se.position)-Number(Ae.position)).slice(0,3).map(se=>String(se.sectionId||""))}catch{ee=null}try{ht("outline.enqueue.structure_snapshot",{articleId:C,nodesCount:K.length,reason:_?"exit_edit_mode_new_section":"exit_edit_mode",rootFirst:ee})}catch{}Gt("structure_snapshot",{articleId:C,payload:{nodes:K},coalesceKey:`structure:${C}`}),q=!0}cr=!1,rn&&(clearTimeout(rn),rn=null)}try{(G||_)&&(go.set(N,ga(T)),yo.delete(N))}catch{}try{G&&re&&!re.isDestroyed&&re.view===M&&em(re,M.state.doc,N)}catch{}(G||q)&&Cr("\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438 \u043D\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044E")}catch{}}}catch{}}}}})]}}),at=u.create({name:"outlineImageResize",addProseMirrorPlugins(){return[new S({view(I){let x=null,L=(V,j)=>{try{if((I.state.selection?.node||null)?.type?.name==="image"&&typeof I.state.selection.from=="number")return I.state.selection.from;let N=G=>{if(typeof G!="number")return null;let q=[G,G-1,G+1,G-2,G+2];for(let K of q){if(K<0)continue;if(I.state.doc.nodeAt(K)?.type?.name==="image")return K}return null},C=V?.querySelector?.("img")||null,E=N(I.posAtDOM(V,0));if(typeof E=="number")return E;let D=C?N(I.posAtDOM(C,0)):null;if(typeof D=="number")return D;let T=j&&typeof j.clientX=="number"&&typeof j.clientY=="number"?{left:j.clientX,top:j.clientY}:null,_=T?I.posAtCoords(T):null,U=_&&typeof _.pos=="number"?N(_.pos):null;return typeof U=="number"?U:null}catch{return null}},M=V=>{if(V.button!==0)return;let j=V.target?.closest?.(".resizable-image__handle");if(!j)return;let F=j.closest(".resizable-image");if(!F||!I.dom.contains(F)||!(be?.getState?.(I.state)||null)?.editingSectionId)return;let C=L(F,V);if(typeof C!="number")return;let E=I.state.doc.nodeAt(C);if(!E||E.type?.name!=="image")return;V.preventDefault(),V.stopPropagation();let D=F.getBoundingClientRect();x={pos:C,startWidth:D.width,startX:V.clientX,wrapper:F,lastWidth:D.width},F.classList.add("resizable-image--resizing")},z=V=>{if(!x)return;V.preventDefault();let j=V.clientX-x.startX,N=parseFloat(getComputedStyle(document.documentElement).fontSize)||16,C=Math.max(N,document.documentElement.clientWidth-32),E=10,D=x.startWidth+j;D=Math.max(N,Math.min(D,C)),D=Math.round(D/E)*E,D=Math.max(N,Math.min(D,C)),x.lastWidth=D,x.wrapper.style.width=`${Math.round(D)}px`},$=()=>{if(!x)return;let{pos:V,wrapper:j}=x;j.classList.remove("resizable-image--resizing");let F=I.state.doc.nodeAt(V)?.type?.name==="image"?V:L(j,null),N=typeof F=="number"?I.state.doc.nodeAt(F):null;if(N&&N.type?.name==="image"){let E=Number(x.lastWidth||0)||j.getBoundingClientRect().width,D=Math.max(1,Math.round(E/10)*10),T={...N.attrs,width:D},_=I.state.tr.setNodeMarkup(F,void 0,T);_=_.setMeta(de,!0),I.dispatch(_)}x=null};return I.dom.addEventListener("pointerdown",M),document.addEventListener("pointermove",z),document.addEventListener("pointerup",$),document.addEventListener("pointercancel",$),{destroy(){I.dom.removeEventListener("pointerdown",M),document.removeEventListener("pointermove",z),document.removeEventListener("pointerup",$),document.removeEventListener("pointercancel",$)}}}})]}}),Dt=u.create({name:"outlineImagePreview",addProseMirrorPlugins(){return[new S({props:{handleDOMEvents:{click(I,x){try{if((be?.getState?.(I.state)||null)?.editingSectionId)return!1;let M=x?.target?.closest?.("img");return M?x.target?.closest?.(".resizable-image__handle")?(x.preventDefault(),!0):(x.preventDefault(),ci(M.src,M.alt||""),!0):!1}catch{return!1}}}}})]}}),tn=u.create({name:"outlineMarkdownTablePaste",addProseMirrorPlugins(){let I=(x,L)=>{try{if(!(be?.getState?.(x.state)||null)?.editingSectionId)return!1;let z=L?.clipboardData?.getData?.("text/plain")||"";if(Rn("paste: text/plain",{len:z.length,sample:z.slice(0,200)}),!z)return!1;let $=Ol(z),V=po($);Rn("paste: parsed",{ok:!!V,lines:$});let j=V?null:mo($);if(!V&&!j)return!1;let F=V?{header:V.header,rows:V.rows,withHeader:!0}:{header:null,rows:j.rows,withHeader:!1},N=null;try{N=Jr(x.state.schema,F)}catch(E){return Rn("paste: buildTableNode error",{message:String(E?.message||E||""),stack:String(E?.stack||""),schemaNodes:Object.keys(x.state.schema?.nodes||{})}),!1}if(Rn("paste: tableNode",{ok:!!N,schemaNodes:Ll()?Object.keys(x.state.schema?.nodes||{}):void 0}),!N)return!1;L.preventDefault(),L.stopPropagation();let C=x.state.tr;x.state.selection.empty||(C=C.deleteSelection());try{C=C.replaceSelectionWith(N,!1)}catch(E){return Rn("paste: replaceSelectionWith error",{message:String(E?.message||E||""),stack:String(E?.stack||""),selection:{from:x.state.selection?.from,to:x.state.selection?.to,empty:x.state.selection?.empty,$fromParent:x.state.selection?.$from?.parent?.type?.name}}),!1}return C=C.setMeta(de,!0),x.dispatch(C.scrollIntoView()),!0}catch(M){return Rn("paste: unexpected error",{message:String(M?.message||M||""),stack:String(M?.stack||"")}),!1}};return[new S({appendTransaction(x,L,M){try{let z=x?.some?.(C=>C?.docChanged),$=null;if(be)for(let C of x||[]){let E=C?.getMeta?.(be)||null;if(E?.type==="enter"&&E?.sectionId){$=String(E.sectionId);break}}let V=!!$;if(!z&&!V||x.some(C=>C.getMeta?.(de)))return null;let j=be?.getState?.(M)||null,F=$||j?.editingSectionId||null;if(!F)return null;Rn("appendTransaction: try convert",{didDocChange:z,didEnterEditMode:V,sectionId:F});let N=nb(M,F);if(N)return N;if(Ll()){let C=kt(M.doc,F),E=typeof C=="number"?M.doc.nodeAt(C):null,D=E?E.child(1):null,T=D?D.textContent:"";String(T||"").includes("|")&&Rn("appendTransaction: saw pipes but no conversion",{sectionId:F})}return Nb(M,F)}catch{return null}},props:{handlePaste(x,L){return I(x,L)},handleDOMEvents:{paste(x,L){return I(x,L)}}}})]}}),Nt=u.create({name:"outlineStructuredSectionPaste",addProseMirrorPlugins(){let I=$=>{let V=String($||"").trim();if(!V)return{sections:[],startsWithHeading:!1,headingCount:0};if(!/<h[1-6][\s>]/i.test(V))return{sections:[],startsWithHeading:!1,headingCount:0};let j=null;try{j=new DOMParser().parseFromString(V,"text/html")}catch{return{sections:[],startsWithHeading:!1,headingCount:0}}let F=j?.body;if(!F)return{sections:[],startsWithHeading:!1,headingCount:0};let N=!1;try{let T=Array.from(F.childNodes||[]).find(_=>_?.nodeType===1&&String(_?.textContent||"").trim());N=!!(T&&/^H[1-6]$/.test(String(T.nodeName||"")))}catch{N=!1}let C=[],E=null,D=()=>{if(!E)return;let T=document.createElement("div");for(let U of E.nodes)try{T.appendChild(U.cloneNode(!0))}catch{}let _=String(T.innerText||T.textContent||"").trimEnd();C.push({level:E.level,title:E.title,bodyText:_}),E=null};for(let T of Array.from(F.childNodes||[])){let G=(T?.nodeType===1?String(T.nodeName||"").toUpperCase():"").match(/^H([1-6])$/);if(G){D();let q=Number(G[1]),K=String(T.textContent||"").trim();if(!K)continue;E={level:q,title:K,nodes:[]};continue}E&&E.nodes.push(T)}return D(),{sections:C,startsWithHeading:N,headingCount:C.length}},x=$=>{let V=$?.selection?.$from;if(!V)return null;for(let j=V.depth;j>0;j-=1)if(V.node(j)?.type?.name==="outlineSection")return V.before(j);return null},L=($,V)=>{let j=String(V||"").replace(/\r\n/g,`
`).trimEnd(),F=$.nodes.paragraph;if(!F)return[];let N=$.nodes.hardBreak||$.nodes.hard_break||null,C=T=>{let _=String(T||"").split(`
`),U=[];for(let G=0;G<_.length;G+=1){let q=_[G];G>0&&N&&U.push(N.create()),q&&U.push($.text(q))}return F.create({},U)};if(!j.trim())return[F.create({},[])];let E=j.split(/\n{2,}/),D=[];for(let T of E){let _=String(T||"").trimEnd();D.push(C(_))}return D.length?D:[F.create({},[])]},M=($,V)=>{let j=$.nodes.outlineHeading.create({},V.title?[$.text(V.title)]:[]),F=L($,V.bodyText),N=$.nodes.outlineBody.create({},F),C=(V.children||[]).map(D=>M($,D)),E=$.nodes.outlineChildren.create({},C);return $.nodes.outlineSection.create({id:V.id,collapsed:!1},[j,N,E])},z=($,V)=>{try{if(!(be?.getState?.($.state)||null)?.editingSectionId)return!1;let F=V?.clipboardData?.getData?.("text/html")||"",N=V?.clipboardData?.getData?.("text/plain")||"",C=F?I(F):{sections:[],startsWithHeading:!1,headingCount:0},E=!C.sections.length&&N?il(N):{sections:[],startsWithHeading:!1,headingCount:0},D=C.sections.length?C:E;if(!D.sections.length||!(D.startsWithHeading||D.sections.length>=2))return!1;V.preventDefault(),V.stopPropagation();let _=x($.state);if(typeof _!="number")return!1;let U=$.state.doc.nodeAt(_);if(!U||U.type?.name!=="outlineSection")return!1;let G=Zf(D.sections,{makeId:()=>fn()});if(!G.length)return!1;let q=$.state.schema,K=G.map(Ae=>M(q,Ae)),ee=$.state.tr,se=_+U.nodeSize;for(let Ae of K)ee=ee.insert(se,Ae),se+=Ae.nodeSize;return ee=ee.setMeta(de,!0),$.dispatch(ee.scrollIntoView()),!0}catch{return!1}};return[new S({props:{handlePaste($,V){return z($,V)},handleDOMEvents:{paste($,V){return z($,V)}}}})]}}),er=(I="")=>{let x=String(I||"").trim();return x?x.startsWith("app:/")||x.startsWith("disk:/")?`/api/yandex/disk/file?path=${encodeURIComponent(x)}`:x:""},br=u.create({name:"outlineAttachmentUpload",addProseMirrorPlugins(){let I=M=>{let z=String(M?.type||"");return!(z&&z.startsWith("image/"))},x=(M,z)=>{let $=[];try{let V=[];if(z&&typeof z.length=="number")V.push(...Array.from(z||[]));else if(M&&typeof M.length=="number")for(let j of Array.from(M||[])){if(!j||j.kind!=="file")continue;let F=j.getAsFile?.();F&&V.push(F)}for(let j of V)j&&I(j)&&$.push(j)}catch{}return $},L=(M,z,$,V)=>{let j=x($,V);if(!j.length)return!1;z.preventDefault(),z.stopPropagation();try{if(!(be?.getState?.(M.state)||null)?.editingSectionId)return gr(),!0}catch{return gr(),!0}for(let F of j)Dp(M,F);return!0};return[new S({props:{handleDOMEvents:{drop(M,z){let $=z?.dataTransfer?.items||null,V=z?.dataTransfer?.files||null;return L(M,z,$,V)},paste(M,z){let $=z?.clipboardData?.items||null,V=z?.clipboardData?.files||null;return L(M,z,$,V)}}}})]}}),wr=d.create({name:"doc",topNode:!0,content:"outlineSection+"}),cn=d.create({name:"outlineChildren",content:"outlineSection*",defining:!0,renderHTML(){return["div",{class:"outline-children","data-outline-children":"true"},0]},parseHTML(){return[{tag:"div[data-outline-children]"}]},addNodeView(){return({node:I})=>{let x=document.createElement("div");x.className="outline-children",x.setAttribute("data-outline-children","true");let L=M=>{let z=!M||M.childCount===0;x.setAttribute("data-empty",z?"true":"false")};return L(I),{dom:x,contentDOM:x,update(M){return!M||M.type?.name!=="outlineChildren"?!1:(L(M),!0)}}}}}),wn=I=>{try{if(!I||I.childCount===0)return!0;let x=!1;return I.descendants(L=>{if(x)return!1;let M=L?.type?.name;return M==="image"||M==="table"||L.isText&&String(L.text||"").replace(/\u00a0/g," ").trim()?(x=!0,!1):!0}),!x}catch{return!1}},Kt=d.create({name:"outlineBody",content:"block*",defining:!0,renderHTML(){return["div",{class:"outline-body","data-outline-body":"true"},0]},parseHTML(){return[{tag:"div[data-outline-body]"}]},addNodeView(){return({node:I})=>{let x=document.createElement("div");x.className="outline-body",x.setAttribute("data-outline-body","true");let L=M=>{let z=wn(M);x.setAttribute("data-empty",z?"true":"false")};return L(I),{dom:x,contentDOM:x,update(M){return!M||M.type?.name!=="outlineBody"?!1:(L(M),!0)}}}}}),Bt=["note","info","success","warning","danger"],Yt=I=>{let x=String(I||"").trim().toLowerCase();return Bt.includes(x)?x:"note"},tr=d.create({name:"callout",group:"block",content:"block+",defining:!0,addAttributes(){return{kind:{default:"note",parseHTML:I=>Yt(I?.getAttribute?.("data-kind")),renderHTML:I=>({"data-kind":Yt(I?.kind)})}}},parseHTML(){return[{tag:"div[data-tt-callout]"}]},renderHTML({node:I,HTMLAttributes:x}){let L=Yt(I?.attrs?.kind),M=String(x?.class||"").trim(),z=`tt-callout tt-callout--${L}${M?` ${M}`:""}`;return["div",{...x,class:z,"data-tt-callout":"1","data-kind":L},0]},addCommands(){return{setCallout:I=>({editor:x,commands:L})=>{let M=Yt(I);return x.isActive("callout")?L.updateAttributes("callout",{kind:M}):L.toggleWrap("callout",{kind:M})},unsetCallout:()=>({editor:I,commands:x})=>I.isActive("callout")?x.toggleWrap("callout"):!1}}}),Y=m.create({name:"ttTextBg",inclusive:!1,addAttributes(){return{color:{default:null,parseHTML:I=>{try{return String(I?.style?.backgroundColor||"").trim()||null}catch{return null}},renderHTML:I=>{let x=I?.color?String(I.color).trim():"";return x?{style:`background-color: ${x}`}:{}}}}},parseHTML(){return[{tag:'span[data-tt-text-bg="1"]'}]},renderHTML({HTMLAttributes:I}){return["span",w(I,{class:"tt-text-bg","data-tt-text-bg":"1"}),0]}}),ce=u.create({name:"outlineTextBgNodes",addGlobalAttributes(){let I=(x,L)=>{try{let M=x?.style?.[L];return M?String(M).trim():""}catch{return""}};return[{types:["paragraph","outlineHeading"],attributes:{nodeBackground:{default:null,parseHTML:x=>{let L=I(x,"backgroundColor");return L?String(L).replace(/['"]+/g,""):null},renderHTML:x=>{let L=x?.nodeBackground?String(x.nodeBackground):"";return L?{style:`background-color: ${L}`,"data-tt-node-bg":"1"}:{}}}}},{types:["blockquote"],attributes:{nodeBorderColor:{default:null,parseHTML:x=>{let L=I(x,"borderLeftColor");return L?String(L).replace(/['"]+/g,""):null},renderHTML:x=>{let L=x?.nodeBorderColor?String(x.nodeBorderColor):"";return L?{style:`border-left-color: ${L}`,"data-tt-bq-border":"1"}:{}}}}}]},addCommands(){let I=(L,M)=>{try{let z=L.selection?.$from;if(!z)return null;for(let $=z.depth;$>=0;$-=1)if(z.node($)?.type?.name===M)return z.before($);return null}catch{return null}},x=(L,M,z,$,V)=>{try{let j=L.doc.nodeAt(z);if(!j)return!1;if(!M)return!0;let F={...j.attrs||{}};V==null||V===""?delete F[$]:F[$]=V;let N=L.tr.setNodeMarkup(z,void 0,F);return N=N.setMeta(de,!0),M(N),!0}catch{return!1}};return{setTextBg:L=>({editor:M,state:z,dispatch:$})=>{let V=String(L||"").trim(),j=z.selection;if(!j)return!1;if(j.from!==j.to){try{M.chain().focus().run()}catch{}let D=z.schema?.marks?.ttTextBg||null;if(!D)return!1;if(!$)return!0;let T=z.tr.addMark(j.from,j.to,D.create({color:V}));T=T.setMeta(de,!0);try{b&&(T=T.setSelection(b.create(T.doc,j.to,j.to)))}catch{}$(T);try{window?.getSelection?.()?.removeAllRanges?.()}catch{}return!0}let N=I(z,"blockquote");if(typeof N=="number")return x(z,$,N,"nodeBorderColor",V);let C=I(z,"paragraph");if(typeof C=="number")return x(z,$,C,"nodeBackground",V);let E=I(z,"outlineHeading");return typeof E=="number"?x(z,$,E,"nodeBackground",V):!1},clearTextBg:()=>({editor:L,state:M,dispatch:z})=>{let $=M.selection;if(!$)return!1;let V=$.from!==$.to,j=!1;if(V){try{L.chain().focus().run()}catch{}let E=M.schema?.marks?.ttTextBg||null;if(E){if(!z)return!0;let D=M.tr.removeMark($.from,$.to,E);D=D.setMeta(de,!0);try{b&&(D=D.setSelection(b.create(D.doc,$.to,$.to)))}catch{}z(D),j=!0}try{window?.getSelection?.()?.removeAllRanges?.()}catch{}}let F=I(M,"blockquote");typeof F=="number"&&(j=x(M,z,F,"nodeBorderColor",null)||j);let N=I(M,"paragraph");typeof N=="number"&&(j=x(M,z,N,"nodeBackground",null)||j);let C=I(M,"outlineHeading");return typeof C=="number"&&(j=x(M,z,C,"nodeBackground",null)||j),j}}}}),fe=d.create({name:"outlineHeading",content:"inline*",defining:!0,renderHTML(){return["div",{class:"outline-heading","data-outline-heading":"true"},0]},parseHTML(){return[{tag:"div[data-outline-heading]"}]},addNodeView(){return({editor:I,getPos:x,node:L})=>{let M=document.createElement("div");M.className="outline-heading",M.setAttribute("data-outline-heading","true");let z=document.createElement("button");z.type="button",z.className="outline-heading__toggle",z.title="\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C/\u0440\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C (Ctrl+\u2190/\u2192), \u0441 \u0434\u0435\u0442\u044C\u043C\u0438 (Ctrl+\u2191/\u2193)",z.setAttribute("aria-label","\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C/\u0440\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C");let $=document.createElement("div");$.className="outline-heading__content";let V=document.createElement("button");V.type="button",V.className="outline-heading__select",V.setAttribute("role","checkbox"),V.setAttribute("aria-checked","false"),V.setAttribute("aria-label","\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0431\u043B\u043E\u043A"),V.textContent="\u2713",V.addEventListener("pointerdown",F=>{F.preventDefault()}),V.addEventListener("click",F=>{if(F.preventDefault(),F.stopPropagation(),!Tr)return;let N=typeof x=="function"?x():null;if(typeof N!="number")return;let C=N-1,E=I.state.doc.nodeAt(C),D=String(E?.attrs?.id||"").trim();D&&Uy(D)});let j=()=>{let F=typeof x=="function"?x():null;if(typeof F!="number")return;let N=F-1,C=I.state.doc.nodeAt(N),E=String(C?.attrs?.id||"");E&&M.setAttribute("data-section-id",E),M.dataset.empty=L.content.size===0?"true":"false";let D=I.state.doc.resolve(Math.max(0,N+1)),T=0;for(let U=D.depth;U>=0;U-=1)D.node(U)?.type?.name==="outlineSection"&&(T+=1);M.dataset.depth=String(Math.min(6,Math.max(1,T||1)));let _=Tr&&E&&Gr.has(E);V.setAttribute("aria-checked",_?"true":"false"),V.style.display=Tr?"inline-flex":"none"};return z.addEventListener("click",F=>{F.preventDefault(),F.stopPropagation();let N=typeof x=="function"?x():null;if(typeof N!="number")return;let C=N-1,E=I.state.doc.nodeAt(C);if(!E)return;let D=!E.attrs?.collapsed,T=I.state.tr.setNodeMarkup(C,void 0,{...E.attrs,collapsed:D});try{D&&be&&(be.getState(I.state)||{}).editingSectionId&&(T=T.setMeta(be,{type:"exit"}))}catch{}T.setMeta(de,!0),I.view.dispatch(T),I.view.focus()}),M.appendChild(z),M.appendChild($),M.appendChild(V),j(),{dom:M,contentDOM:$,update:F=>F.type.name!=="outlineHeading"?!1:(L=F,j(),!0)}}}}),pe=d.create({name:"outlineSection",group:"block",content:"outlineHeading outlineBody outlineChildren",defining:!0,isolating:!0,draggable:!0,addAttributes(){return{collapsed:{default:!1}}},renderHTML({node:I,HTMLAttributes:x}){let L={...x,class:`outline-section${x?.class?` ${x.class}`:""}`,"data-outline-section":"true","data-section-id":I.attrs.id||"","data-collapsed":I.attrs.collapsed?"true":"false"};return["div",w(L),0]},parseHTML(){return[{tag:"div[data-outline-section]"}]}}),ue=I=>{if(!I)return!0;if((I.textContent||"").replace(/\u00a0/g," ").trim())return!1;if(I.childCount)for(let L=0;L<I.childCount;L+=1){let M=I.child(L);if(M.type?.name!=="paragraph"||(M.textContent||"").replace(/\u00a0/g," ").trim())return!1}return!0},Se=I=>{if(!I)return!0;try{let x=I.child(0),L=I.child(1),M=I.child(2);return ue(x)&&ue(L)&&(!M||M.childCount===0)}catch{return!0}},ve=(I,x,L)=>{let M=I.doc.nodeAt(L);if(!M)return!1;let z=String(M.attrs?.id||"").trim(),$=I.doc.resolve(L),V=$.index(),j=$.parent;if(!j)return!1;if(j.childCount<=1){if(j.type?.name==="doc"){let q=I.doc.type.schema,K=q.nodes.outlineSection.create({...M.attrs,collapsed:!1},[q.nodes.outlineHeading.create({},[]),q.nodes.outlineBody.create({},[q.nodes.paragraph.create({},[])]),q.nodes.outlineChildren.create({},[])]),ee=I.tr.replaceWith(L,L+M.nodeSize,K);ee=ee.setMeta(de,!0);let se=K.child(0),Ae=L+1+se.nodeSize;return x(ee.setSelection(b.near(ee.doc.resolve(Ae+2),1)).scrollIntoView()),!0}z&&zo(z);let U=null;try{for(let q=$.depth;q>0;q-=1)if($.node(q)?.type?.name==="outlineSection"){U=$.before(q);break}}catch{U=null}let G=I.tr.delete(L,L+M.nodeSize);G=G.setMeta(de,!0);try{if(typeof U=="number"){let q=G.mapping.map(U,-1),K=G.doc.nodeAt(q);if(K&&K.type?.name==="outlineSection"){let ee=K.child(0),se=K.child(1),Ae=q+1+ee.nodeSize;if(!se.childCount){let ge=G.doc.type.schema;G=G.insert(Ae+1,ge.nodes.paragraph.create({},[]))}G=G.setSelection(b.near(G.doc.resolve(Ae+2),1))}}}catch{}return x(G.scrollIntoView()),!0}let F=V>0,N=V<j.childCount-1,C=F?j.child(V-1):null,E=F?L-C.nodeSize:null,D=L+M.nodeSize;z&&zo(z);let T=I.tr.delete(L,L+M.nodeSize),_=(U,G)=>{try{let q=U.doc.nodeAt(G);if(!q||q.type?.name!=="outlineSection")return U;let K=q.child(0),se=G+1+K.nodeSize-1;return U.setSelection(b.near(U.doc.resolve(se),-1))}catch{return U}};if(N){let U=L<T.doc.content.size?L:D;T.doc.nodeAt(U)&&(T=_(T,U))}else F&&typeof E=="number"&&T.doc.nodeAt(E)&&(T=_(T,E));return T=T.setMeta(de,!0),x(T.scrollIntoView()),!0},oe=(I,x,L)=>{let M=I.doc.nodeAt(L);if(!M)return!1;let z=I.doc.resolve(L),$=z.index(),V=z.parent;if(!V||$<=0)return!1;let j=V.child($-1),F=L-j.nodeSize,N=M.child(0),C=M.child(1),E=M.child(2),D=I.tr.delete(L,L+M.nodeSize),T=D.doc.nodeAt(F);if(!T)return D=D.setMeta(de,!0),x(D.scrollIntoView()),!0;let _=D.doc.type.schema,U=T.child(0),G=T.child(1),q=T.child(2),K=[],ee=(N?.textContent||"").replace(/\u00a0/g," ").trim();ee&&K.push(_.nodes.paragraph.create({},[_.text(ee)])),C?.content?.forEach?.(De=>{K.push(De)});let se=K.length?_.nodes.outlineBody.create({},K).content:null,Ae=se?G.content.append(se):G.content,ge=q.content.append(E.content),xe=_.nodes.outlineSection.create(T.attrs,[U,_.nodes.outlineBody.create({},Ae),_.nodes.outlineChildren.create({},ge)]);D=D.replaceWith(F,F+T.nodeSize,xe);let Be=D.doc.nodeAt(F);if(Be){let De=Be.child(0),Ne=Be.child(1),Ue=F+1+De.nodeSize+Ne.nodeSize-1;D=D.setSelection(b.near(D.doc.resolve(Ue),-1))}return D=D.setMeta(de,!0),x(D.scrollIntoView()),!0},Ce=(I,x,L)=>{let M=I.doc.nodeAt(L);if(!M)return!1;let z=I.selection.$from,$=null,V=null;for(let De=z.depth;De>0;De-=1)if(z.node(De)?.type?.name==="outlineSection")if($===null)$=De;else{V=De;break}if($===null||V===null)return!1;let j=z.before(V);if(!I.doc.nodeAt(j))return!1;let N=I.doc.type.schema,C=M.child(0),E=M.child(1),D=M.child(2),T=I.tr.delete(L,L+M.nodeSize),_=T.doc.nodeAt(j);if(!_)return T=T.setMeta(de,!0),x(T.scrollIntoView()),!0;let U=_.child(0),G=_.child(1),q=_.child(2),K=[],ee=(C?.textContent||"").replace(/\u00a0/g," ").trim();ee&&K.push(N.nodes.paragraph.create({},[N.text(ee)])),E?.content?.forEach?.(De=>{K.push(De)});let se=K.length?N.nodes.outlineBody.create({},K).content:null,Ae=se?G.content.append(se):G.content,ge=D.content.append(q.content),xe=N.nodes.outlineSection.create({..._.attrs,collapsed:!1},[U,N.nodes.outlineBody.create({},Ae),N.nodes.outlineChildren.create({},ge)]);T=T.replaceWith(j,j+_.nodeSize,xe);let Be=T.doc.nodeAt(j);if(Be){let De=Be.child(0),Ne=Be.child(1),Ue=j+1+De.nodeSize+Ne.nodeSize-1;T=T.setSelection(b.near(T.doc.resolve(Ue),-1))}return T=T.setMeta(de,!0),x(T.scrollIntoView()),!0},qe=u.create({name:"outlineCommands",addKeyboardShortcuts(){let I=(R,Z)=>{for(let X=Z.depth;X>0;X-=1)if(Z.node(X)?.type?.name==="outlineSection")return Z.before(X);return null},x=(R,Z)=>{for(let X=R.depth;X>0;X-=1)if(R.node(X)?.type?.name===Z)return X;return null},L=R=>{if(!R)return!0;if((R.textContent||"").replace(/\u00a0/g," ").trim())return!1;if(R.childCount)for(let X=0;X<R.childCount;X+=1){let Q=R.child(X);if(Q.type?.name!=="paragraph"||(Q.textContent||"").replace(/\u00a0/g," ").trim())return!1}return!0},M=(R,Z)=>{let{selection:X}=R;if(!X||X.empty)return!1;let Q=I(R.doc,X.$from),ie=I(R.doc,X.$to);if(typeof Q!="number"||typeof ie!="number"||Q===ie||x(X.$from,"outlineBody")===null||X.$to.parent?.type?.name!=="outlineHeading"||X.$to.parentOffset!==0)return!1;let ae=R.doc.nodeAt(Q);if(!ae)return!1;let ye=ae.child(0),Ie=ae.child(1),_e=Q+1+ye.nodeSize,Ee=_e+1,Re=_e+Ie.nodeSize-1,Oe=Math.max(X.from,Ee),Pe=Math.min(X.to,Re);if(Pe<Oe)return!0;let Me=R.tr.delete(Oe,Pe),Le=Me.doc.nodeAt(_e);if(Le&&Le.content.size===0){let Fe=Me.doc.type.schema;Me=Me.insert(Ee,Fe.nodes.paragraph.create({},[]))}return Me=Me.setSelection(b.near(Me.doc.resolve(Ee+1),1)),Z(Me.scrollIntoView()),!0},z=(R,Z,X={})=>{let{selection:Q}=R;if(!Q||Q.empty)return!1;let ie=I(R.doc,Q.$from),le=I(R.doc,Q.$to);if(typeof ie!="number"||typeof le!="number"||ie!==le)return!1;let ae=x(Q.$from,"outlineHeading"),ye=x(Q.$to,"outlineHeading");if(ae===null||ye===null)return!1;let Ie=R.doc.nodeAt(ie);if(!Ie)return!1;let _e=Ie.child(0),Ee=ie+1,Re=Ee+1,Oe=Ee+_e.nodeSize-1;if(Q.from<Re||Q.to>Oe)return!1;let Pe=Math.max(Q.from,Re),Me=Math.min(Q.to,Oe);if(Me<Pe)return!0;if(typeof X.onClipboard=="function")try{let Fe=R.doc.textBetween(Pe,Me,`
`,`
`);X.onClipboard(Fe)}catch{}let Le=R.tr.delete(Pe,Me);return Le=Le.setSelection(b.near(Le.doc.resolve(Re),1)),Z(Le.scrollIntoView()),!0},$=R=>{if(!R)return!0;let Z=R.child(0),X=R.child(1),Q=R.child(2);return L(Z)&&L(X)&&(!Q||Q.childCount===0)},V=(R,Z,X)=>{let Q=R.doc.nodeAt(X);if(!Q)return!1;let ie=Q.child(0),le=Q.child(1),ye=X+1+ie.nodeSize+le.nodeSize-1,Ie=R.tr.setSelection(b.near(R.doc.resolve(ye),-1));return Z(Ie.scrollIntoView()),!0},j=(R,Z,X)=>{let Q=R.doc.nodeAt(X);if(!Q)return!1;let ie=Q.child(0),le=X+1,ae=R.tr.setSelection(b.near(R.doc.resolve(le+1),1));return Z(ae.scrollIntoView()),!0},F=(R,Z,X)=>{let Q=R.doc.nodeAt(X);if(!Q)return!1;let ie=Q.child(0),le=Q.child(1);if(!le||le.childCount<=0)return C(R,Z,X);let ye=X+1+ie.nodeSize+1,Ie=null;try{le.descendants((Re,Oe)=>{Re?.isTextblock&&(Ie=Oe)})}catch{Ie=null}if(typeof Ie!="number")return V(R,Z,X);let _e=ye+Ie+1,Ee=R.tr.setSelection(b.near(R.doc.resolve(_e),1));return Z(Ee.scrollIntoView()),!0},N=(R,Z,X)=>{let Q=R.doc.nodeAt(X);return Q?Q.attrs?.collapsed?j(R,Z,X):F(R,Z,X):!1},C=(R,Z,X)=>{let Q=R.doc.nodeAt(X);if(!Q)return!1;let ie=Q.child(0),le=Q.child(1),ae=X+1+ie.nodeSize,ye=R.tr;if(!le.childCount){let Ie=R.doc.type.schema;ye=ye.insert(ae+1,Ie.nodes.paragraph.create({},[]))}return ye=ye.setSelection(b.near(ye.doc.resolve(ae+2),1)),Z(ye.scrollIntoView()),!0},E=(R,Z,X)=>{let Q=R.doc.nodeAt(X);if(!Q)return!1;let ie=Q.child(0),le=Q.child(1);if(!!Q.attrs?.collapsed){let Re=X+1+ie.nodeSize-1,Oe=R.tr.setSelection(b.near(R.doc.resolve(Re),-1));return Z(Oe),!0}let Ie=X+1+ie.nodeSize+le.nodeSize-1,_e=R.tr.setSelection(b.near(R.doc.resolve(Ie),-1));return Z(_e),!0},D=(R,Z)=>{try{let X=R.resolve(Math.min(R.content.size,Math.max(0,Z+1)));for(let Q=X.depth;Q>0;Q-=1){let ie=X.node(Q);if(!(ie?.type?.name!=="outlineSection"||X.before(Q)===Z)&&ie.attrs?.collapsed)return!1}return!0}catch{return!0}},T=(R,Z)=>{let X=null;return R.nodesBetween(0,Z,(Q,ie)=>{if(ie>=Z)return!1;Q?.type?.name==="outlineSection"&&D(R,ie)&&(X=ie)}),X},_=(R,Z,X)=>{let Q=R.doc.nodeAt(X);if(!Q)return!1;let ie=String(Q.attrs?.id||"").trim(),le=R.doc.resolve(X),ae=le.index(),ye=le.parent;if(!ye)return!1;if(ye.childCount<=1){if(ye.type?.name==="doc"){let Le=R.doc.type.schema,Fe=Le.nodes.outlineSection.create({...Q.attrs,collapsed:!1},[Le.nodes.outlineHeading.create({},[]),Le.nodes.outlineBody.create({},[Le.nodes.paragraph.create({},[])]),Le.nodes.outlineChildren.create({},[])]),tt=R.tr.replaceWith(X,X+Q.nodeSize,Fe);tt=tt.setMeta(de,!0);let Ge=Fe.child(0),et=X+1+Ge.nodeSize;return Z(tt.setSelection(b.near(tt.doc.resolve(et+2),1)).scrollIntoView()),!0}let Pe=null;try{for(let Le=le.depth;Le>0;Le-=1)if(le.node(Le)?.type?.name==="outlineSection"){Pe=le.before(Le);break}}catch{Pe=null}let Me=R.tr.delete(X,X+Q.nodeSize);Me=Me.setMeta(de,!0);try{if(typeof Pe=="number"){let Le=Me.mapping.map(Pe,-1),Fe=Me.doc.nodeAt(Le);if(Fe&&Fe.type?.name==="outlineSection"){let tt=Fe.child(0),Ge=Fe.child(1),et=Le+1+tt.nodeSize;if(!Ge.childCount){let yt=Me.doc.type.schema;Me=Me.insert(et+1,yt.nodes.paragraph.create({},[]))}Me=Me.setSelection(b.near(Me.doc.resolve(et+2),1))}}}catch{}return Z(Me.scrollIntoView()),!0}ie&&zo(ie);let Ie=ae>0,_e=Ie?ye.child(ae-1):null,Ee=Ie?X-_e.nodeSize:null,Re=X+Q.nodeSize,Oe=R.tr.delete(X,X+Q.nodeSize);if(Ie&&typeof Ee=="number"){let Pe=Oe.doc.nodeAt(Ee);if(Pe){let Me=Pe.child(0),Le=Pe.child(1),Fe=Ee+1+Me.nodeSize;if(!Le.childCount){let tt=Oe.doc.type.schema;Oe=Oe.insert(Fe+1,tt.nodes.paragraph.create({},[]))}Oe=Oe.setSelection(b.near(Oe.doc.resolve(Fe+2),1))}}else{let Pe=X<Oe.doc.content.size?X:Re,Me=Oe.doc.nodeAt(Pe);if(Me){let Le=Me.child(0),Fe=Me.child(1),tt=Pe+1+Le.nodeSize;if(!Fe.childCount){let Ge=Oe.doc.type.schema;Oe=Oe.insert(tt+1,Ge.nodes.paragraph.create({},[]))}Oe=Oe.setSelection(b.near(Oe.doc.resolve(tt+2),1))}}return Oe=Oe.setMeta(de,!0),Z(Oe.scrollIntoView()),!0},U=(R,Z,X)=>{let Q=R.doc.nodeAt(X);if(!Q)return!1;let ie=String(Q.attrs?.id||"").trim(),le=R.doc.resolve(X),ae=le.index(),ye=le.parent;if(!ye||ae<=0)return!1;ie&&zo(ie);let Ie=ye.child(ae-1),_e=X-Ie.nodeSize,Ee=Q.child(0),Re=Q.child(1),Oe=Q.child(2),Pe=R.tr.delete(X,X+Q.nodeSize),Me=Pe.doc.nodeAt(_e);if(!Me)return Pe=Pe.setMeta(de,!0),Z(Pe.scrollIntoView()),!0;let Le=Pe.doc.type.schema,Fe=Me.child(0),tt=Me.child(1),Ge=Me.child(2),et=Number(tt?.content?.size||0)||0,yt=[],mt=(Ee?.textContent||"").replace(/\u00a0/g," ").trim();mt&&yt.push(Le.nodes.paragraph.create({},[Le.text(mt)])),Re?.content?.forEach?.($t=>{yt.push($t)});let Ut=yt.length?Le.nodes.outlineBody.create({},yt).content:null,Rt=Ut?tt.content.append(Ut):tt.content,hn=Ge.content.append(Oe.content),Ct=Le.nodes.outlineSection.create(Me.attrs,[Fe,Le.nodes.outlineBody.create({},Rt),Le.nodes.outlineChildren.create({},hn)]);Pe=Pe.replaceWith(_e,_e+Me.nodeSize,Ct);let dn=Pe.doc.nodeAt(_e);if(dn){let $t=dn.child(0),Nn=dn.child(1),gn=_e+1+$t.nodeSize+1+et,An=Math.min(Pe.doc.content.size,Math.max(0,gn+1));Pe=Pe.setSelection(b.near(Pe.doc.resolve(An),1))}return Pe=Pe.setMeta(de,!0),Z(Pe.scrollIntoView()),!0},G=(R,Z,X)=>{let Q=R.doc.nodeAt(X);if(!Q)return!1;let ie=String(Q.attrs?.id||"").trim(),le=R.selection.$from,ae=null,ye=null;for(let $t=le.depth;$t>0;$t-=1)if(le.node($t)?.type?.name==="outlineSection")if(ae===null)ae=$t;else{ye=$t;break}if(ae===null||ye===null)return!1;let Ie=le.before(ye);if(!R.doc.nodeAt(Ie))return!1;let Ee=R.doc.type.schema,Re=Q.child(0),Oe=Q.child(1),Pe=Q.child(2);ie&&zo(ie);let Me=R.tr.delete(X,X+Q.nodeSize),Le=Me.doc.nodeAt(Ie);if(!Le)return Me=Me.setMeta(de,!0),Z(Me.scrollIntoView()),!0;let Fe=Le.child(0),tt=Le.child(1),Ge=Le.child(2),et=Number(tt?.content?.size||0)||0,yt=[],mt=(Re?.textContent||"").replace(/\u00a0/g," ").trim();mt&&yt.push(Ee.nodes.paragraph.create({},[Ee.text(mt)])),Oe?.content?.forEach?.($t=>{yt.push($t)});let Ut=yt.length?Ee.nodes.outlineBody.create({},yt).content:null,Rt=Ut?tt.content.append(Ut):tt.content,hn=Pe.content.append(Ge.content),Ct=Ee.nodes.outlineSection.create({...Le.attrs,collapsed:!1},[Fe,Ee.nodes.outlineBody.create({},Rt),Ee.nodes.outlineChildren.create({},hn)]);Me=Me.replaceWith(Ie,Ie+Le.nodeSize,Ct);let dn=Me.doc.nodeAt(Ie);if(dn){let $t=dn.child(0),xt=Ie+1+$t.nodeSize+1+et,gn=Math.min(Me.doc.content.size,Math.max(0,xt+1));Me=Me.setSelection(b.near(Me.doc.resolve(gn),1))}return Me=Me.setMeta(de,!0),Z(Me.scrollIntoView()),!0},q=(R,Z,X)=>{let Q=R.doc.nodeAt(X);if(!Q)return!1;let ie=R.doc.resolve(X),le=ie.index(),ae=ie.parent;if(!ae||le>=ae.childCount-1)return!1;let ye=X+Q.nodeSize,Ie=R.doc.nodeAt(ye);if(!Ie||Ie.type?.name!=="outlineSection")return!1;let _e=R.doc.type.schema,Ee=Q.child(0),Re=Q.child(1),Oe=Q.child(2),Pe=Ie.child(1),Me=Ie.child(2),Le=Re.content.append(Pe.content),Fe=Oe.content.append(Me.content),tt=_e.nodes.outlineSection.create({...Q.attrs,collapsed:!1},[Ee,_e.nodes.outlineBody.create({},Le),_e.nodes.outlineChildren.create({},Fe)]),Ge=R.tr;Ge=Ge.delete(ye,ye+Ie.nodeSize),Ge=Ge.replaceWith(X,X+Q.nodeSize,tt);let et=Ge.doc.nodeAt(X);if(et){let yt=et.child(0),mt=et.child(1),Rt=X+1+yt.nodeSize+mt.nodeSize-1;Ge=Ge.setSelection(b.near(Ge.doc.resolve(Rt),-1))}return Ge=Ge.setMeta(de,!0),Z(Ge.scrollIntoView()),!0},K=R=>this.editor.commands.command(({state:Z,dispatch:X})=>{let Q=Pe=>{try{if(typeof CSS<"u"&&CSS&&typeof CSS.escape=="function")return CSS.escape(String(Pe||""))}catch{}return String(Pe||"").replace(/["\\]/g,"\\$&")},ie=Pe=>{try{let Me=Pe;for(;Me&&Me!==document.body;){let Le=Me.parentElement;if(!Le)break;let Fe=window.getComputedStyle(Le),tt=String(Fe?.overflowY||"");if((tt==="auto"||tt==="scroll")&&Le.scrollHeight>Le.clientHeight+1)return Le;Me=Le}}catch{}return document.scrollingElement||document.documentElement},le=Pe=>{try{let Me=String(Pe||"").trim();if(!Me)return null;let Le=document.querySelector(`.outline-heading[data-section-id="${Q(Me)}"]`);if(!Le)return null;let Fe=ie(Le);return{sid:Me,scrollEl:Fe,top:Le.getBoundingClientRect().top}}catch{return null}},ae=Pe=>{if(!Pe)return;let{sid:Me,scrollEl:Le,top:Fe}=Pe,tt=()=>{try{let Ge=document.querySelector(`.outline-heading[data-section-id="${Q(Me)}"]`);if(!Ge)return;let yt=Ge.getBoundingClientRect().top-Fe;if(!Number.isFinite(yt)||Math.abs(yt)<1)return;Le.scrollTop+=yt}catch{}};try{requestAnimationFrame(()=>requestAnimationFrame(tt))}catch{setTimeout(tt,0)}},ye=I(Z.doc,Z.selection.$from);if(typeof ye!="number")return!1;let Ie=Z.doc.resolve(ye),_e=Ie.index(),Ee=Ie.parent;if(!Ee)return!1;let Re=Z.doc.nodeAt(ye);if(!Re)return!1;let Oe=le(String(Re.attrs?.id||"").trim());if(R==="up"){if(_e>0){let gn=Ee.child(_e-1),An=ye-gn.nodeSize,ut=Z.tr.delete(ye,ye+Re.nodeSize).insert(An,Re).setMeta(de,!0),Sn=b.near(ut.doc.resolve(An+2),1);return ut.setSelection(Sn),X(ut.scrollIntoView()),ae(Oe),!0}let Pe=Ne(Z.doc,ye);if(typeof Pe!="number")return!1;let Me=Z.doc.resolve(Pe),Le=Me.index(),Fe=Me.parent;if(!Fe||Le<=0)return!1;let tt=Fe.child(Le-1),Ge=Pe-tt.nodeSize,et=Z.doc.nodeAt(Ge);if(!et||et.type?.name!=="outlineSection")return!1;let yt=et.child(0),mt=et.child(1),Ut=et.child(2),hn=Ge+1+yt.nodeSize+mt.nodeSize+Ut.nodeSize-1,Ct=Z.tr.delete(ye,ye+Re.nodeSize).setMeta(de,!0),dn=Ct.mapping.map(Ge,-1),$t=Ct.mapping.map(hn,-1);Ct=Ct.insert($t,Re);let Nn=Ct.doc.nodeAt(dn);Nn?.type?.name==="outlineSection"&&Nn.attrs?.collapsed&&(Ct=Ct.setNodeMarkup(dn,void 0,{...Nn.attrs,collapsed:!1}));let xt=b.near(Ct.doc.resolve($t+2),1);return Ct.setSelection(xt),X(Ct.scrollIntoView()),ae(Oe),!0}if(R==="down"){if(_e<Ee.childCount-1){let gn=ye+Re.nodeSize,An=Z.doc.nodeAt(gn);if(!An)return!1;let ut=Z.tr.delete(ye,ye+Re.nodeSize).setMeta(de,!0),Sn=ye+An.nodeSize;ut.insert(Sn,Re);let Xr=b.near(ut.doc.resolve(Sn+2),1);return ut.setSelection(Xr),X(ut.scrollIntoView()),ae(Oe),!0}let Pe=Ne(Z.doc,ye);if(typeof Pe!="number")return!1;let Me=Z.doc.nodeAt(Pe);if(!Me||Me.type?.name!=="outlineSection")return!1;let Le=Z.doc.resolve(Pe),Fe=Le.index(),tt=Le.parent;if(!tt||Fe>=tt.childCount-1)return!1;let Ge=Pe+Me.nodeSize,et=Z.doc.nodeAt(Ge);if(!et||et.type?.name!=="outlineSection")return!1;let yt=et.child(0),mt=et.child(1),Ut=et.child(2),hn=Ge+1+yt.nodeSize+mt.nodeSize+1,Ct=Z.tr.delete(ye,ye+Re.nodeSize).setMeta(de,!0),dn=Ct.mapping.map(Ge,-1),$t=Ct.mapping.map(hn,-1);Ct=Ct.insert($t,Re);let Nn=Ct.doc.nodeAt(dn);Nn?.type?.name==="outlineSection"&&Nn.attrs?.collapsed&&(Ct=Ct.setNodeMarkup(dn,void 0,{...Nn.attrs,collapsed:!1}));let xt=b.near(Ct.doc.resolve($t+2),1);return Ct.setSelection(xt),X(Ct.scrollIntoView()),ae(Oe),!0}return!1}),ee=()=>this.editor.commands.command(({state:R,dispatch:Z})=>{let{selection:X}=R;if(!X?.empty)return!1;let{$from:Q}=X,ie=I(R.doc,Q);if(typeof ie!="number")return!1;let le=R.doc.nodeAt(ie);if(!le)return!1;let ae=R.doc.type.schema;if(le.attrs?.collapsed){let xt=ie+le.nodeSize,gn=fn(),An=ae.nodes.outlineSection.create({id:gn,collapsed:!1},[ae.nodes.outlineHeading.create({},[]),ae.nodes.outlineBody.create({},[ae.nodes.paragraph.create({},[])]),ae.nodes.outlineChildren.create({},[])]),ut=R.tr.insert(xt,An);return ut=ut.setSelection(b.create(ut.doc,xt+2)),ut=ut.setMeta(de,!0),be&&(ut=ut.setMeta(be,{type:"enter",sectionId:gn})),Z(ut.scrollIntoView()),!0}let ye=ae.nodes.outlineChildren.create({},[]),Ie=xt=>xt&&xt.childCount?xt:ae.nodes.outlineBody.create({},[ae.nodes.paragraph.create({},[])]);if(Q.parent?.type?.name==="outlineHeading"){let xt=le.child(0),gn=le.child(1),An=le.child(2),ut=Q.parentOffset||0,Sn=xt.textBetween(0,Math.max(0,Math.min(ut,xt.content.size)),"",""),Xr=xt.textBetween(Math.max(0,Math.min(ut,xt.content.size)),xt.content.size,"",""),Eh=ae.nodes.outlineHeading.create({},Sn?[ae.text(Sn)]:[]),vh=ae.nodes.outlineHeading.create({},Xr?[ae.text(Xr)]:[]),nd=fn(),rd=ae.nodes.outlineSection.create({...le.attrs,collapsed:!1},[Eh,Ie(ae.nodes.outlineBody.create({},[])),ye]),Th=ae.nodes.outlineSection.create({id:nd,collapsed:!1},[vh,Ie(gn),An]),nr=R.tr.replaceWith(ie,ie+le.nodeSize,rd),od=nr.doc.nodeAt(ie),id=ie+(od?od.nodeSize:rd.nodeSize);return nr=nr.insert(id,Th),nr=nr.setSelection(b.create(nr.doc,id+2)),nr=nr.setMeta(de,!0),be&&(nr=nr.setMeta(be,{type:"enter",sectionId:nd})),Z(nr.scrollIntoView()),!0}if(x(Q,"outlineBody")===null||!Q.parent?.isTextblock)return!1;let Ee=R.tr,Re=X.from;try{Ee=Ee.split(Re)}catch{return!1}let Oe=Ee.mapping.map(Re);try{Ee=Ee.setSelection(b.near(Ee.doc.resolve(Math.min(Ee.doc.content.size,Oe+1)),1))}catch{}let Pe=Ee.selection.$from,Me=x(Pe,"outlineBody"),Le=x(Pe,"paragraph");if(Me===null||Le===null)return!1;let Fe=Pe.before(Le),tt=Pe.end(Me);if(typeof Fe!="number"||typeof tt!="number"||tt<Fe)return!1;let Ge=Ee.doc.slice(Fe,tt).content;Ee=Ee.delete(Fe,tt);let et=Ee.mapping.map(ie,-1),yt=Ee.doc.nodeAt(et);if(!yt)return Z(Ee.scrollIntoView()),!0;let mt=yt.child(0),Ut=Ie(yt.child(1)),Rt=yt.child(2),hn=ae.nodes.outlineSection.create({...yt.attrs,collapsed:!1},[mt,Ut,ye]),Ct=Ge&&Ge.childCount?ae.nodes.outlineBody.create({},Ge):ae.nodes.outlineBody.create({},[ae.nodes.paragraph.create({},[])]),dn=fn(),$t=ae.nodes.outlineSection.create({id:dn,collapsed:!1},[ae.nodes.outlineHeading.create({},[]),Ct,Rt]);Ee=Ee.replaceWith(et,et+yt.nodeSize,hn);let Nn=et+hn.nodeSize;return Ee=Ee.insert(Nn,$t),Ee=Ee.setSelection(b.create(Ee.doc,Nn+2)),Ee=Ee.setMeta(de,!0),be&&(Ee=Ee.setMeta(be,{type:"enter",sectionId:dn})),Z(Ee.scrollIntoView()),!0}),se=()=>this.editor.commands.command(({state:R,dispatch:Z})=>{let X=I(R.doc,R.selection.$from);if(typeof X!="number")return!1;let Q=R.doc.resolve(X),ie=0;for(let et=Q.depth;et>=0;et-=1)Q.node(et)?.type?.name==="outlineSection"&&(ie+=1);if(ie>=6)return!1;let le=Q.index(),ae=Q.parent;if(!ae||le<=0)return!1;let ye=R.doc.nodeAt(X);if(!ye)return!1;let Ie=ae.child(le-1),_e=X-Ie.nodeSize,Ee=R.doc.nodeAt(_e);if(!Ee)return!1;let Re=Ee.child(0),Oe=Ee.child(1),Pe=Ee.child(2),Le=_e+1+Re.nodeSize+Oe.nodeSize+Pe.nodeSize-1,Fe=R.tr.delete(X,X+ye.nodeSize).insert(Le,ye).setMeta(de,!0),tt=Fe.doc.nodeAt(_e);tt?.type?.name==="outlineSection"&&tt.attrs?.collapsed&&(Fe=Fe.setNodeMarkup(_e,void 0,{...tt.attrs,collapsed:!1}));let Ge=b.near(Fe.doc.resolve(Le+2),1);return Fe.setSelection(Ge),Z(Fe.scrollIntoView()),!0}),Ae=()=>this.editor.commands.command(({state:R,dispatch:Z})=>{let X=R.selection.$from,Q=null,ie=null;for(let Oe=X.depth;Oe>0;Oe-=1)if(X.node(Oe)?.type?.name==="outlineSection")if(Q===null)Q=Oe;else{ie=Oe;break}if(Q===null||ie===null)return!1;let le=X.before(Q),ae=X.before(ie),ye=R.doc.nodeAt(le);if(!ye)return!1;let Ie=R.tr.delete(le,le+ye.nodeSize).setMeta(de,!0),_e=Ie.doc.nodeAt(ae);if(!_e)return!1;let Ee=ae+_e.nodeSize;Ie.insert(Ee,ye);let Re=b.near(Ie.doc.resolve(Ee+2),1);return Ie.setSelection(Re),Z(Ie.scrollIntoView()),!0}),ge=R=>this.editor.commands.command(({state:Z,dispatch:X})=>{let Q=I(Z.doc,Z.selection.$from);if(typeof Q!="number")return!1;let ie=Z.doc.nodeAt(Q);if(!ie)return!1;let le=typeof R=="boolean"?R:!ie.attrs?.collapsed,ae=Z.tr.setNodeMarkup(Q,void 0,{...ie.attrs,collapsed:le}).setMeta(de,!0);try{le&&be&&(be.getState(Z)||{}).editingSectionId&&(ae=ae.setMeta(be,{type:"exit"}))}catch{}return X(ae),!0}),xe=()=>this.editor.commands.command(({state:R,dispatch:Z})=>{let X=I(R.doc,R.selection.$from);if(typeof X!="number")return!1;let Q=R.doc.nodeAt(X);if(!Q||Q.type?.name!=="outlineSection"||!Q.attrs?.collapsed)return!1;let ie=Ne(R.doc,X);if(typeof ie!="number"){let Ie=X+1,_e=R.tr.setSelection(b.near(R.doc.resolve(Ie+1),1));return Z(_e.scrollIntoView()),!0}let le=R.doc.nodeAt(ie);if(!le||le.type?.name!=="outlineSection")return!1;let ae=R.tr.setNodeMarkup(ie,void 0,{...le.attrs,collapsed:!0}).setMeta(de,!0);try{be&&(be.getState(R)||{}).editingSectionId&&(ae=ae.setMeta(be,{type:"exit"}))}catch{}let ye=ie+1;return ae=ae.setSelection(b.near(ae.doc.resolve(ye+1),1)),Z(ae.scrollIntoView()),!0}),Be=()=>this.editor.commands.command(({state:R,dispatch:Z})=>{let{selection:X}=R;if(!X?.empty)return!1;let{$from:Q}=X;if(Q.parent?.type?.name==="outlineHeading")return!1;let ie=I(R.doc,Q);if(typeof ie!="number")return!1;let le=R.doc.nodeAt(ie);if(!le||le.type?.name!=="outlineSection"||le.attrs?.collapsed)return!1;let ae=R.doc.type.schema,ye=x(Q,"outlineBody");if(ye===null)return!1;let Ie=null;for(let ut=Q.depth;ut>ye;ut-=1){let Sn=Q.node(ut),Xr=Q.node(ut-1);if(Sn?.type?.name==="paragraph"&&Xr?.type?.name==="outlineBody"){Ie=ut;break}}if(Ie===null)return!1;let _e=Q.node(Ie);if(!_e)return!1;let Ee=le.child(0),Re=le.child(1),Oe=le.child(2),Me=ie+1+Ee.nodeSize+1,Le=Q.before(Ie),Fe=null;try{let ut=0;for(let Sn=0;Sn<Re.childCount;Sn+=1){if(Me+ut===Le){Fe=Sn;break}ut+=Re.child(Sn).nodeSize}}catch{Fe=null}if(Fe===null)return!1;let tt=Q.pos-Q.start(Ie),Ge=Math.max(0,Math.min(tt,_e.content.size)),et=_e.textBetween(0,Ge,"",""),yt=_e.textBetween(Ge,_e.content.size,"",""),mt=String(et||"").trimEnd(),Ut=String(yt||"").trim(),Rt=[];for(let ut=0;ut<Fe;ut+=1)Rt.push(Re.child(ut));Rt.push(ae.nodes.paragraph.create({},mt?[ae.text(mt)]:[])),Rt.length||Rt.push(ae.nodes.paragraph.create({},[]));let hn=[];for(let ut=Fe+1;ut<Re.childCount;ut+=1)hn.push(Re.child(ut));hn.length||hn.push(ae.nodes.paragraph.create({},[]));let Ct=ae.nodes.outlineChildren.create({},[]),dn=ae.nodes.outlineSection.create({...le.attrs,collapsed:!1},[Ee,ae.nodes.outlineBody.create({},Rt),Ct]),$t=fn(),Nn=ae.nodes.outlineSection.create({id:$t,collapsed:!1},[ae.nodes.outlineHeading.create({},Ut?[ae.text(Ut)]:[]),ae.nodes.outlineBody.create({},hn),Oe]),xt=R.tr.replaceWith(ie,ie+le.nodeSize,dn),gn=ie+dn.nodeSize;xt=xt.insert(gn,Nn);let An=xt.doc.nodeAt(gn);if(An&&An.type?.name==="outlineSection"){let ut=An.child(0),Sn=gn+1+ut.nodeSize;xt=xt.setSelection(b.near(xt.doc.resolve(Sn+2),1))}else xt=xt.setSelection(b.near(xt.doc.resolve(gn+2),1));return xt=xt.setMeta(de,!0),be&&(xt=xt.setMeta(be,{type:"enter",sectionId:$t})),Z(xt.scrollIntoView()),!0}),De=(R,Z)=>{let X=R.nodeAt(Z);if(!X||X.type?.name!=="outlineSection")return[];let Q=[Z];return X.descendants((ie,le)=>{ie?.type?.name==="outlineSection"&&Q.push(Z+1+le)}),Q},Ne=(R,Z)=>{try{let X=R.resolve(Math.min(R.content.size,Z+1)),Q=null;for(let ie=X.depth;ie>0;ie-=1){if(X.node(ie)?.type?.name!=="outlineSection")continue;if(X.before(ie)===Z){Q=ie;break}}if(Q===null)return null;for(let ie=Q-1;ie>0;ie-=1)if(X.node(ie)?.type?.name==="outlineSection")return X.before(ie);return null}catch{return null}},Te=(R,Z,X,Q)=>{let ie=!!Q,le=R.tr;for(let ae of X){let ye=le.doc.nodeAt(ae);!ye||ye.type?.name!=="outlineSection"||!!ye.attrs?.collapsed!==ie&&(le=le.setNodeMarkup(ae,void 0,{...ye.attrs,collapsed:ie}))}le=le.setMeta(de,!0);try{ie&&be&&(be.getState(R)||{}).editingSectionId&&(le=le.setMeta(be,{type:"exit"}))}catch{}Z(le)},Ue=()=>this.editor.commands.command(({state:R,dispatch:Z})=>{let X=I(R.doc,R.selection.$from);if(typeof X!="number")return!1;let Q=Ne(R.doc,X),ie=typeof Q=="number"?Q:X,le=De(R.doc,ie);if(!le.length)return!1;let ae=R.tr;for(let Ie of le){let _e=ae.doc.nodeAt(Ie);!_e||_e.type?.name!=="outlineSection"||_e.attrs?.collapsed||(ae=ae.setNodeMarkup(Ie,void 0,{..._e.attrs,collapsed:!0}))}ae=ae.setMeta(de,!0);let ye=ae.doc.nodeAt(ie);if(ye){let Ie=ye.child(0),Ee=ie+1+Ie.nodeSize-1;ae=ae.setSelection(b.near(ae.doc.resolve(Ee),-1))}return Z(ae.scrollIntoView()),!0}),je=()=>this.editor.commands.command(({state:R,dispatch:Z})=>{let X=I(R.doc,R.selection.$from);if(typeof X!="number")return!1;let Q=De(R.doc,X);return Q.length?(Te(R,Z,Q,!1),!0):!1}),ft=(R,Z)=>{try{let X=R.nodeAt(Z);if(!X||X.type?.name!=="outlineSection")return[];if(X.childCount<3)return[];let Q=X.child(0),ie=X.child(1),le=X.child(2);if(!le||le.type?.name!=="outlineChildren")return[];let ae=Z+1+Q.nodeSize+ie.nodeSize,ye=[];return le.descendants((Ie,_e)=>{Ie?.type?.name==="outlineSection"&&ye.push(ae+1+_e)}),ye}catch{return[]}},ct=(R,Z)=>{try{let X=Ne(R,Z);if(typeof X!="number")return Uo(R);let Q=R.nodeAt(X);if(!Q||Q.type?.name!=="outlineSection"||Q.childCount<3)return Uo(R);let ie=Q.child(0),le=Q.child(1),ae=Q.child(2);if(!ae||ae.type?.name!=="outlineChildren")return Uo(R);let ye=X+1+ie.nodeSize+le.nodeSize,Ie=[];return ae.descendants((_e,Ee)=>{_e?.type?.name==="outlineSection"&&Ie.push(ye+1+Ee)}),Ie}catch{return Uo(R)}},jt=(R,Z)=>{try{for(let X of Z||[]){let Q=R.nodeAt(X);if(!(!Q||Q.type?.name!=="outlineSection")&&Q.attrs?.collapsed)return!0}}catch{}return!1},mn=()=>this.editor.commands.command(({state:R,dispatch:Z})=>{let X=I(R.doc,R.selection.$from);if(typeof X!="number")return!1;let Q=R.doc.nodeAt(X);if(!Q||Q.type?.name!=="outlineSection")return!1;if(Q.attrs?.collapsed)return Te(R,Z,[X],!1),!0;let ie=ft(R.doc,X);if(ie.length&&jt(R.doc,ie))return Te(R,Z,ie,!1),!0;let le=X;for(let ye=0;ye<64;ye+=1){let Ie=ct(R.doc,le);if(Ie.length&&jt(R.doc,Ie))return Te(R,Z,Ie,!1),!0;let _e=Ne(R.doc,le);if(typeof _e!="number")break;le=_e}let ae=Uo(R.doc);return ae.length&&jt(R.doc,ae)?(Te(R,Z,ae,!1),!0):!1}),Yn=R=>this.editor.commands.command(({state:Z,dispatch:X})=>{let{selection:Q}=Z,le=(Q?.node||null)?.type?.name==="outlineSection"?Q.from:I(Z.doc,Z.selection.$from);if(typeof le!="number"||!Z.doc.nodeAt(le))return!1;let ye=!!R,Ie=De(Z.doc,le);return Ie.length?(Te(Z,X,Ie,ye),!0):!1});return{"Alt-ArrowUp":()=>this.editor.isActive("table")?!1:K("up"),"Alt-ArrowDown":()=>this.editor.isActive("table")?!1:K("down"),"Alt-ArrowRight":()=>this.editor.isActive("table")?!1:se(),"Alt-ArrowLeft":()=>this.editor.isActive("table")?!1:Ae(),"Ctrl-Alt-ArrowUp":()=>this.editor.isActive("table")?!1:K("up"),"Alt-Ctrl-ArrowUp":()=>this.editor.isActive("table")?!1:K("up"),"Ctrl-Alt-ArrowDown":()=>this.editor.isActive("table")?!1:K("down"),"Alt-Ctrl-ArrowDown":()=>this.editor.isActive("table")?!1:K("down"),"Ctrl-Alt-ArrowRight":()=>this.editor.isActive("table")?!1:se(),"Alt-Ctrl-ArrowRight":()=>this.editor.isActive("table")?!1:se(),"Ctrl-Alt-ArrowLeft":()=>this.editor.isActive("table")?!1:Ae(),"Alt-Ctrl-ArrowLeft":()=>this.editor.isActive("table")?!1:Ae(),"Mod-ArrowRight":()=>ge(!1),"Mod-ArrowLeft":()=>xe()?!0:ge(!0),"Mod-ArrowUp":()=>{try{let R=this.editor.state,Z=I(R.doc,R.selection.$from);if(typeof Z=="number"){let X=R.doc.nodeAt(Z);if(X?.type?.name==="outlineSection"&&typeof Ne(R.doc,Z)!="number"&&X.attrs?.collapsed)return Bl(this.editor,!0)}}catch{}return Ue()},"Mod-ArrowDown":()=>mn(),"Mod-Enter":()=>{try{if(be&&!(be.getState(this.editor.state)||{}).editingSectionId)return!1}catch{}try{if(this.editor.state.selection?.$from?.parent?.type?.name==="outlineHeading")return ee()}catch{}return Be()?!0:ee()},Backspace:()=>this.editor.commands.command(({state:R,dispatch:Z})=>{let{selection:X}=R;if(z(R,Z)||M(R,Z))return!0;if(!X?.empty)return!1;let{$from:Q}=X;if(Q.parent?.type?.name!=="outlineHeading"||Q.parentOffset!==0)return!1;let ie=I(R.doc,Q);if(typeof ie!="number")return!1;let le=R.doc.nodeAt(ie);if(!le)return!1;if($(le))return _(R,Z,ie);try{if(R.doc.resolve(ie).index()<=0)return G(R,Z,ie)}catch{}return U(R,Z,ie)}),Delete:()=>this.editor.commands.command(({state:R,dispatch:Z})=>{let{selection:X}=R;if(z(R,Z)||M(R,Z))return!0;if(!X?.empty)return!1;let{$from:Q}=X;if(x(Q,"outlineBody")!==null){let Ie=I(R.doc,Q);if(typeof Ie!="number")return!1;let _e=R.doc.nodeAt(Ie);if(!_e)return!1;let Ee=_e.child(0),Re=_e.child(1),Pe=Ie+1+Ee.nodeSize+Re.nodeSize-1;return Q.pos===Pe?q(R,Z,Ie):!1}if(Q.parent?.type?.name!=="outlineHeading")return!1;let le=I(R.doc,Q);if(typeof le!="number")return!1;let ae=R.doc.nodeAt(le);if(!ae)return!1;let ye=ae.child(0);if(Q.parentOffset===ye.content.size){if($(ae))return _(R,Z,le);let Ie=ae.child(1),_e=le+1+ye.nodeSize,Ee=R.tr;if(!Ie.childCount){let Re=R.doc.type.schema;Ee=Ee.insert(_e+1,Re.nodes.paragraph.create({},[]))}return Ee=Ee.setSelection(b.near(Ee.doc.resolve(_e+2),1)),Z(Ee.scrollIntoView()),!0}return!1}),Enter:()=>this.editor.commands.command(({state:R,dispatch:Z})=>{let{selection:X}=R;if(!X?.empty)return!1;let{$from:Q}=X;if(Q.parent?.type?.name!=="outlineHeading")return!1;try{if(be&&!(be.getState(R)||{}).editingSectionId)return!1}catch{}let ie=I(R.doc,Q);if(typeof ie!="number")return!1;let le=R.doc.nodeAt(ie);if(!le)return!1;let ae=le.child(0),ye=le.child(1),Ie=ie+1+ae.nodeSize,_e=ae.content?.size??0;if(le.attrs?.collapsed&&Q.parentOffset===_e){let Re=ie+le.nodeSize,Oe=R.doc.type.schema,Pe=fn(),Me=Oe.nodes.outlineSection.create({id:Pe,collapsed:!1},[Oe.nodes.outlineHeading.create({},[]),Oe.nodes.outlineBody.create({},[Oe.nodes.paragraph.create({},[])]),Oe.nodes.outlineChildren.create({},[])]),Le=R.tr.insert(Re,Me);return Le=Le.setSelection(b.create(Le.doc,Re+2)),Le=Le.setMeta(de,!0),be&&(Le=Le.setMeta(be,{type:"enter",sectionId:Pe})),Z(Le.scrollIntoView()),!0}if(Q.parentOffset===0){let Re=R.doc.type.schema,Oe=ae.textBetween(0,_e,"",""),Pe=Re.nodes.outlineHeading.create({},[]),Me=le.child(2),Le=[];try{for(let mt=0;mt<ye.childCount;mt+=1)Le.push(ye.child(mt))}catch{}let Fe=[];if(Oe){let mt=Re.nodes.paragraph.create({},[Re.text(Oe)]),Ut=Le[0]||null;Ut&&Ut.type?.name==="paragraph"&&L(Ut)?Fe=[mt,...Le.slice(1)]:Fe=[mt,...Le]}else Fe=Le;Fe.length||(Fe=[Re.nodes.paragraph.create({},[])]);let tt=Re.nodes.outlineBody.create({},Fe),Ge=Re.nodes.outlineSection.create({...le.attrs,collapsed:!1},[Pe,tt,Me]),et=R.tr.replaceWith(ie,ie+le.nodeSize,Ge),yt=et.doc.nodeAt(ie);if(yt){let mt=yt.child(0),Ut=ie+1+mt.nodeSize;et=et.setSelection(b.near(et.doc.resolve(Ut+2),1))}else et=et.setSelection(b.near(et.doc.resolve(Ie+2),1));return et=et.setMeta(de,!0),Z(et.scrollIntoView()),!0}if(Q.parentOffset>0&&Q.parentOffset<_e){let Re=R.doc.type.schema,Oe=ae.textBetween(0,Math.max(0,Math.min(Q.parentOffset,_e)),"",""),Pe=ae.textBetween(Math.max(0,Math.min(Q.parentOffset,_e)),_e,"",""),Me=Re.nodes.outlineHeading.create({},Oe?[Re.text(Oe)]:[]),Le=le.child(2),Fe=[];try{for(let Rt=0;Rt<ye.childCount;Rt+=1)Fe.push(ye.child(Rt))}catch{}let tt=Re.nodes.paragraph.create({},Pe?[Re.text(Pe)]:[]),Ge=[];if(Pe){let Rt=Fe[0]||null;Rt&&Rt.type?.name==="paragraph"&&L(Rt)?Ge=[tt,...Fe.slice(1)]:Ge=[tt,...Fe]}else Ge=Fe;Ge.length||(Ge=[Re.nodes.paragraph.create({},[])]);let et=Re.nodes.outlineBody.create({},Ge),yt=Re.nodes.outlineSection.create({...le.attrs,collapsed:!1},[Me,et,Le]),mt=R.tr.replaceWith(ie,ie+le.nodeSize,yt),Ut=mt.doc.nodeAt(ie);if(Ut){let Rt=Ut.child(0),hn=ie+1+Rt.nodeSize;mt=mt.setSelection(b.near(mt.doc.resolve(hn+2),1))}else mt=mt.setSelection(b.near(mt.doc.resolve(Ie+2),1));return mt=mt.setMeta(de,!0),Z(mt.scrollIntoView()),!0}let Ee=R.tr;if(!ye.childCount){let Re=R.doc.type.schema;Ee=Ee.insert(Ie+1,Re.nodes.paragraph.create({},[]))}return Ee=Ee.setSelection(b.near(Ee.doc.resolve(Ie+2),1)),Z(Ee.scrollIntoView()),!0}),ArrowUp:()=>this.editor.commands.command(({state:R,dispatch:Z})=>{let{selection:X}=R;if(!X?.empty)return!1;let{$from:Q}=X;if(Q.parent?.type?.name!=="outlineHeading"||Q.parentOffset!==0)return!1;let ie=I(R.doc,Q);if(typeof ie!="number")return!1;let le=T(R.doc,ie);if(typeof le=="number")return N(R,Z,le);let ae=R.doc.resolve(ie),ye=ae.index(),Ie=ae.parent;if(!Ie)return!1;if(ye>0){let Oe=Ie.child(ye-1),Pe=ie-Oe.nodeSize;return j(R,Z,Pe)}let _e=null,Ee=null;for(let Oe=Q.depth;Oe>0;Oe-=1)if(Q.node(Oe)?.type?.name==="outlineSection")if(_e===null)_e=Oe;else{Ee=Oe;break}if(Ee===null)return!1;let Re=Q.before(Ee);return j(R,Z,Re)})}},addProseMirrorPlugins(){let I=(x,L)=>{for(let M=x.depth;M>0;M-=1)if(x.node(M)?.type?.name===L)return M;return null};return[new S({key:new k("outlineAltMoveRepeatGuard"),props:{handleKeyDown:(x,L)=>{let M=$=>{try{return!!$?.getModifierState?.("AltGraph")}catch{return!1}},z=$=>{try{return(!!$?.altKey||M($))&&!$?.metaKey&&(!$?.ctrlKey||M($))}catch{return!1}};try{if(!L||!z(L))return!1;let $=String(L.key||"");if($!=="ArrowUp"&&$!=="ArrowDown"||!L.repeat)return!1;let V=x?.state,j=V?.selection?.$from;if(!j)return!1;for(let D=j.depth;D>0;D-=1){let T=j.node(D)?.type?.name;if(T&&String(T).startsWith("table"))return!1}let F=null;for(let D=j.depth;D>0;D-=1)if(j.node(D)?.type?.name==="outlineSection"){F=j.before(D);break}if(typeof F!="number")return!1;let N=V.doc.resolve(F),C=N.parent;if(!C)return!1;let E=N.index();return $==="ArrowUp"&&E<=0||$==="ArrowDown"&&E>=C.childCount-1}catch{return!1}}}}),new S({props:{handleDOMEvents:{cut:(x,L)=>{try{let{state:M}=x,{selection:z}=M;if(!z||z.empty)return!1;let $=(Ae,ge)=>{for(let xe=ge.depth;xe>0;xe-=1)if(ge.node(xe)?.type?.name==="outlineSection")return ge.before(xe);return null},V=$(M.doc,z.$from),j=$(M.doc,z.$to);if(typeof V!="number"||typeof j!="number")return!1;let F=(Ae="")=>String(Ae||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");if(V===j){let Ae=I(z.$from,"outlineHeading"),ge=I(z.$to,"outlineHeading");if(Ae!==null&&ge!==null){let xe=M.doc.nodeAt(V);if(!xe)return!1;let Be=xe.child(0),De=V+1,Ne=De+1,Te=De+Be.nodeSize-1;if(z.from>=Ne&&z.to<=Te){let Ue=Math.max(z.from,Ne),je=Math.min(z.to,Te),ft=M.doc.textBetween(Ue,je,`
`,`
`);if(L?.clipboardData)try{L.clipboardData.setData("text/plain",ft),L.clipboardData.setData("text/html",`<pre>${F(ft)}</pre>`)}catch{}L.preventDefault(),L.stopPropagation();let ct=M.tr.delete(Ue,je);return ct=ct.setSelection(b.near(ct.doc.resolve(Ne),1)),x.dispatch(ct.scrollIntoView()),!0}}return!1}if(I(z.$from,"outlineBody")===null||z.$to.parent?.type?.name!=="outlineHeading"||z.$to.parentOffset!==0)return!1;let C=M.doc.nodeAt(V);if(!C)return!1;let E=C.child(0),D=C.child(1),T=V+1+E.nodeSize,_=T+1,U=T+D.nodeSize-1,G=Math.max(z.from,_),q=Math.min(z.to,U);if(q<G)return!0;let K=M.doc.textBetween(G,q,`
`,`
`);if(L?.clipboardData)try{L.clipboardData.setData("text/plain",K),L.clipboardData.setData("text/html",`<pre>${F(K)}</pre>`)}catch{}L.preventDefault(),L.stopPropagation();let ee=M.tr.delete(G,q),se=ee.doc.nodeAt(T);if(se&&se.content.size===0){let Ae=ee.doc.type.schema;ee=ee.insert(_,Ae.nodes.paragraph.create({},[]))}return ee=ee.setSelection(b.near(ee.doc.resolve(_+1),1)),x.dispatch(ee.scrollIntoView()),!0}catch{return!1}}}}}),new S({props:{handleKeyDown:(x,L)=>{if(L.key!=="Backspace")return!1;let{state:M}=x,{selection:z}=M;if(!z?.empty)return!1;let{$from:$}=z;if($.parent?.type?.name!=="paragraph"||$.parentOffset!==0)return!1;let V=null;for(let ee=$.depth;ee>0;ee-=1)if($.node(ee)?.type?.name==="listItem"){V=ee;break}if(V===null||$.index(V)!==0)return!1;let j=V-1,F=$.node(j);if(!F)return!1;let N=$.index(j);if(N<=0)return!1;let C=$.before(V),E=F.child(N-1),D=C-E.nodeSize,T=M.doc.nodeAt(C);if(!T||T.type?.name!=="listItem")return!1;L.preventDefault(),L.stopPropagation();let _=E.type.create(E.attrs,E.content.append(T.content),E.marks),U=M.tr.replaceWith(D,D+E.nodeSize,_),G=D+1+E.content.size,q=U.mapping.map(G,1),K=U.mapping.map(C);U=U.delete(K,K+T.nodeSize);try{U=U.setSelection(b.near(U.doc.resolve(q+1),1))}catch{}return x.dispatch(U.scrollIntoView()),!0}}}),new S({props:{handleKeyDown:(x,L)=>(L.key!=="Tab"||L.preventDefault(),!1)}}),new S({props:{handleKeyDown:(x,L)=>{if(!L.ctrlKey||L.shiftKey||L.altKey||L.metaKey||L.key!=="ArrowUp"&&L.key!=="ArrowDown")return!1;let{state:M}=x,{selection:z}=M;if(!z)return!1;let V=(()=>{if((z?.node||null)?.type?.name==="outlineSection")return z.from;let D=z.$from;for(let T=D.depth;T>0;T-=1)if(D.node(T)?.type?.name==="outlineSection")return D.before(T);return null})();if(typeof V!="number")return!1;let j=(E,D)=>{try{let T=E.resolve(Math.min(E.content.size,D+1)),_=null;for(let U=T.depth;U>0;U-=1)if(T.node(U)?.type?.name==="outlineSection"&&T.before(U)===D){_=U;break}if(_===null)return null;for(let U=_-1;U>0;U-=1)if(T.node(U)?.type?.name==="outlineSection")return T.before(U);return null}catch{return null}},F=(E,D)=>{let T=E.nodeAt(D);if(!T||T.type?.name!=="outlineSection")return[];let _=[D];return T.descendants((U,G)=>{U?.type?.name==="outlineSection"&&_.push(D+1+G)}),_};if(L.preventDefault(),L.stopPropagation(),L.key==="ArrowUp"){let E=j(M.doc,V),D=typeof E=="number"?E:V,T=F(M.doc,D);if(!T.length)return!0;let _=M.tr;for(let G of T){let q=_.doc.nodeAt(G);!q||q.type?.name!=="outlineSection"||q.attrs?.collapsed||(_=_.setNodeMarkup(G,void 0,{...q.attrs,collapsed:!0}))}let U=_.doc.nodeAt(D);if(U){let G=U.child(0),K=D+1+G.nodeSize-1;_=_.setSelection(b.near(_.doc.resolve(K),-1))}return x.dispatch(_.scrollIntoView()),!0}let N=F(M.doc,V);if(!N.length)return!0;let C=M.tr;for(let E of N){let D=C.doc.nodeAt(E);!D||D.type?.name!=="outlineSection"||D.attrs?.collapsed&&(C=C.setNodeMarkup(E,void 0,{...D.attrs,collapsed:!1}))}return x.dispatch(C),!0}}}),new S({props:{handleKeyDown:(x,L)=>{if(L.key!=="Enter")return!1;let{state:M}=x,{$from:z}=M.selection;if(!M.selection.empty)return!1;let $=I(z,"outlineBody");if($===null)return!1;let V=I(z,"paragraph");if(V===null||z.node(V-1)?.type?.name!=="outlineBody")return!1;let j=z.node(V);if(!j||j.content.size!==0||z.parentOffset!==0&&z.parentOffset!==j.content.size)return!1;let F=z.node($),N=z.index($);if(N!==F.childCount-1||N<1)return!1;let C=F.child(N-1);if(!C||C.type?.name!=="paragraph"||C.content.size!==0)return!1;let E=I(z,"outlineSection");if(E===null)return!1;let D=z.before(E);L.preventDefault(),L.stopPropagation();let T=M.tr,_=z.start($),U=_;for(let Be=0;Be<N;Be+=1)U+=F.child(Be).nodeSize;let G=N;for(let Be=N;Be>=0;Be-=1){let De=F.child(Be);if(!De||De.type?.name!=="paragraph"||De.content.size!==0)break;G=Be}let q=_;for(let Be=0;Be<G;Be+=1)q+=F.child(Be).nodeSize;let K=U+F.child(N).nodeSize;T=T.delete(q,K);let ee=T.doc.nodeAt(D);if(!ee)return!0;let se=D+ee.nodeSize,Ae=T.doc.type.schema,ge=fn(),xe=Ae.nodes.outlineSection.create({id:ge,collapsed:!1},[Ae.nodes.outlineHeading.create({},[]),Ae.nodes.outlineBody.create({},[Ae.nodes.paragraph.create({},[])]),Ae.nodes.outlineChildren.create({},[])]);return T=T.insert(se,xe),T=T.setSelection(b.create(T.doc,se+2)),T=T.setMeta(de,!0),be&&(T=T.setMeta(be,{type:"enter",sectionId:ge})),x.dispatch(T.scrollIntoView()),!0}}})]}}),Xe=u.create({name:"outlineActiveSection",addProseMirrorPlugins(){return[new S({props:{decorations(I){try{let x=Ht(I.doc,I.selection.$from);if(typeof x!="number")return null;let L=I.doc.nodeAt(x);return L?v.create(I.doc,[A.node(x,x+L.nodeSize,{"data-active":"true"})]):null}catch{return null}}}})]}}),dt=u.create({name:"outlineEditMode",addProseMirrorPlugins(){let I=new k("outlineEditMode");be=I;let x=null,L=F=>{let N=Ht(F.doc,F.selection.$from);if(typeof N!="number")return null;let C=F.doc.nodeAt(N);return String(C?.attrs?.id||"")||null},M=(F,N,C)=>{if(!N.docChanged)return!0;if(!C)return!1;let E=kt(F.doc,C);if(typeof E!="number")return!1;let D=F.doc.nodeAt(E);if(!D)return!1;let T=D.child(0),_=D.child(1),U=E+1,G=U+1,q=U+T.nodeSize-1,K=E+1+T.nodeSize,ee=K+1,se=K+_.nodeSize-1,Ae=(ge,xe)=>{let Be=ge>=G&&xe<=q,De=ge>=ee&&xe<=se;return Be||De};for(let ge of N.steps){let xe=ge.getMap(),Be=!0;if(xe.forEach((De,Ne)=>{Ae(De,Ne)||(Be=!1)}),!Be)return!1}return!0},z=()=>{try{P("\u0414\u043B\u044F \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Enter \u0438\u043B\u0438 \u0434\u0432\u043E\u0439\u043D\u043E\u0439 \u043A\u043B\u0438\u043A \u043C\u044B\u0448\u043A\u043E\u0439. Esc \u0434\u043B\u044F \u0432\u044B\u0445\u043E\u0434\u0430.")}catch{}},$=()=>{try{P("\u041D\u0430\u0436\u043C\u0438\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437, \u0447\u0442\u043E\u0431\u044B \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438")}catch{}},V=F=>{try{let{selection:N}=F;if(!N?.empty)return!1;let{$from:C}=N,E=null;for(let q=C.depth;q>0;q-=1)if(C.node(q)?.type?.name==="outlineHeading"){E=q;break}if(E===null||!(C.pos===C.start(E)))return!1;let T=Ht(F.doc,C);if(typeof T!="number")return!1;if(F.doc.resolve(T).index()>0)return!0;let G=!1;for(let q=C.depth;q>0;q-=1)if(C.node(q)?.type?.name==="outlineSection"){if(!G){G=!0;continue}return!0}return!1}catch{return!1}},j=(F,N)=>{try{if(!N)return!1;let{selection:C}=F;if(!C?.empty)return!1;let{$from:E}=C,D=Ht(F.doc,E);if(typeof D!="number")return!1;let T=F.doc.nodeAt(D);if(!T||String(T.attrs?.id||"")!==String(N))return!1;let _=T.child(0),U=T.child(1),q=D+1+_.nodeSize+U.nodeSize-1;if(E.pos!==q)return!1;let K=F.doc.resolve(D),ee=K.index(),se=K.parent;return se?ee<se.childCount-1:!1}catch{return!1}};return[new S({key:I,state:{init(){return{editingSectionId:null}},apply(F,N){let C=F.getMeta(I);return C?C.type==="enter"?{editingSectionId:C.sectionId||null}:C.type==="exit"?{editingSectionId:null}:N:N}},filterTransaction(F,N){let E=(I.getState(N)||{}).editingSectionId||null;return F.getMeta(de)||F.getMeta("history$")!=null||F.getMeta("closeHistory$")!=null||!F.docChanged?!0:M(N,F,E)},props:{decorations(F){try{let C=(I.getState(F)||{}).editingSectionId||null;if(!C)return null;let E=kt(F.doc,C);if(typeof E!="number")return null;let D=F.doc.nodeAt(E);return D?v.create(F.doc,[A.node(E,E+D.nodeSize,{"data-editing":"true"})]):null}catch{return null}},handleKeyDown(F,N){let C=F.state,D=(I.getState(C)||{}).editingSectionId||null;nt("keydown",{key:N?.key||null,repeat:!!N?.repeat,editingSectionId:D||null,selection:{empty:!!C?.selection?.empty,parent:C?.selection?.$from?.parent?.type?.name||null,parentOffset:C?.selection?.$from?.parentOffset??null}});let T=L(C);if(!D&&(N.key==="Delete"||N.key==="Del"||N.key==="Backspace")&&(N.ctrlKey||N.metaKey)&&!N.shiftKey&&!N.altKey){try{deleteActiveSection()}catch{}return N.preventDefault(),N.stopPropagation(),!0}if(D&&N.key==="Backspace"&&!N.ctrlKey&&!N.metaKey&&!N.altKey){let U=tb(C,F.dispatch,D,b);if(nt("editorProps.backspace.bodyToHeading",{promoted:U,editingSectionId:D}),U)return N.preventDefault(),N.stopPropagation(),!0;let G=eb(C,F.dispatch);if(nt("editorProps.backspace.tableMerge",{merged:G,editingSectionId:D||null}),G)return N.preventDefault(),N.stopPropagation(),!0}try{let U=(N.key==="Enter"||N.code==="Enter"||N.code==="NumpadEnter")&&(N.ctrlKey||N.metaKey)&&!N.shiftKey&&!N.altKey;if(!a.isPublicView&&!D&&U){let G=C.selection,q=G?.$from||null;if(q){let K=Ht(C.doc,q),ee=typeof K=="number"?C.doc.nodeAt(K):null;if(typeof K=="number"&&ee&&ee.type?.name==="outlineSection"){let se=!!(G&&G.empty),Ae=q.parent?.type?.name==="outlineHeading",xe=se&&Ae&&q.parentOffset===0?K:K+ee.nodeSize;N.preventDefault(),N.stopPropagation();let Be=C.schema,De=fn(),Ne=Be.nodes.outlineSection.create({id:De,collapsed:!1},[Be.nodes.outlineHeading.create({},[]),Be.nodes.outlineBody.create({},[Be.nodes.paragraph.create({},[])]),Be.nodes.outlineChildren.create({},[])]),Te=C.tr.insert(xe,Ne);try{let je=Te.doc.nodeAt(xe)?.child?.(0)||Ne.child(0),ft=xe+1+je.nodeSize;Te=Te.setSelection(b.near(Te.doc.resolve(ft+2),1))}catch{Te=Te.setSelection(b.create(Te.doc,xe+2))}Te=Te.setMeta(de,!0),Te=Te.setMeta(I,{type:"enter",sectionId:De}),F.dispatch(Te.scrollIntoView());try{F.focus()}catch{}return!0}}}}catch{}if((!x||x.sectionId!==T||x.key!==N.key)&&(x=null),a.isPublicView&&!D&&(N.key==="Enter"&&!N.shiftKey&&!N.ctrlKey&&!N.metaKey&&!N.altKey||N.key==="F2"&&!N.shiftKey&&!N.ctrlKey&&!N.metaKey&&!N.altKey))return N.preventDefault(),N.stopPropagation(),!0;if(!D&&(N.key==="Enter"&&!N.shiftKey&&!N.ctrlKey&&!N.metaKey&&!N.altKey||N.key==="F2"&&!N.shiftKey&&!N.ctrlKey&&!N.metaKey&&!N.altKey)){let U=L(C);return U?(N.preventDefault(),N.stopPropagation(),F.dispatch(C.tr.setMeta(I,{type:"enter",sectionId:U})),!0):!1}if(D&&N.key==="Escape")return N.preventDefault(),N.stopPropagation(),F.dispatch(C.tr.setMeta(I,{type:"exit"})),!0;if(!D){let U=N.key&&N.key.length===1&&!N.metaKey&&!N.ctrlKey&&!N.altKey;if(N.key==="Backspace"||N.key==="Delete"){if(N.key==="Backspace"&&V(C))try{let{selection:q}=C,{$from:K}=q,ee=findSectionPos(C.doc,K);if(typeof ee!="number")return!1;let se=C.doc.nodeAt(ee);if(!se)return!1;let Ae=String(se.attrs?.id||""),ge=null;try{let Be=C.doc.resolve(ee),De=Be.index(),Ne=Be.parent;if(Ne&&De>0){let Te=Ne.child(De-1),Ue=ee-Te.nodeSize,je=C.doc.nodeAt(Ue);ge=String(je?.attrs?.id||"")||null}else for(let Te=K.depth-1;Te>0;Te-=1){let Ue=K.node(Te);if(Ue?.type?.name==="outlineSection"){let je=String(Ue.attrs?.id||"");if(je&&je!==Ae){ge=je;break}}}}catch{ge=null}let xe=!1;if(Se(se))xe=ve(C,F.dispatch,ee);else try{C.doc.resolve(ee).index()<=0?xe=Ce(C,F.dispatch,ee):xe=oe(C,F.dispatch,ee)}catch{xe=oe(C,F.dispatch,ee)}return xe&&ge&&window.setTimeout(()=>{try{if((I.getState(F.state)||{}).editingSectionId)return;let De=kt(F.state.doc,ge),Ne=typeof De=="number"?F.state.doc.nodeAt(De):null;if(!Ne)return;let Te=F.state.tr;Ne?.attrs?.collapsed&&(Te=Te.setNodeMarkup(De,void 0,{...Ne.attrs,collapsed:!1}),Te=Te.setMeta(de,!0)),Te=Te.setMeta(I,{type:"enter",sectionId:ge});try{let Ue=Te.doc.nodeAt(De);if(Ue&&Ue.type?.name==="outlineSection"){let je=Ue.child(0),ft=Ue.child(1),jt=De+1+je.nodeSize+ft.nodeSize-1;Te=Te.setSelection(b.near(Te.doc.resolve(jt),-1))}}catch{}F.dispatch(Te.scrollIntoView());try{F.focus()}catch{}}catch{}},0),N.preventDefault(),N.stopPropagation(),!0}catch{}return N.preventDefault(),N.stopPropagation(),!0}if(U)return N.preventDefault(),N.stopPropagation(),z(),!0}let _=N.key==="Backspace"&&V(C)||N.key==="Delete"&&j(C,D);if(D&&(N.key==="Backspace"||N.key==="Delete")&&_){if(N.repeat)return N.preventDefault(),N.stopPropagation(),!0;let U=Date.now();return x&&x.sectionId===D&&x.key===N.key&&U-x.ts<1200?(x=null,!1):(x={sectionId:D,key:N.key,ts:U},N.preventDefault(),N.stopPropagation(),$(),!0)}return!1},handleTextInput(){let F=arguments[0],N=F?.state?I.getState(F.state):null;return N&&N.editingSectionId?!1:(z(),!0)},handleDOMEvents:{paste(F,N){let C=F.state;return(I.getState(C)||{}).editingSectionId?!1:(N.preventDefault(),N.stopPropagation(),z(),!0)},drop(F,N){let C=F.state;return(I.getState(C)||{}).editingSectionId?!1:(N.preventDefault(),N.stopPropagation(),z(),!0)}}}})]}}),rt=I=>{let x=(I||"").trim();if(!x)return[];let L=f(x,[g.configure({heading:!1,link:!1}),B.configure({openOnClick:!1,protocols:js}),Mt,W.configure({table:{resizable:!0}})]),M=Array.isArray(L?.content)?L.content:[],z=[];for(let $=0;$<M.length;$+=1){let V=M[$];if(V?.type!=="paragraph"){z.push(V);continue}let F=wp(V).trim();if(!Hn(F)){z.push(V);continue}let C=[],E=$,D=$;for(;D<M.length;D+=1){let U=M[D];if(U?.type!=="paragraph")break;let G=wp(U).trim();if(!G)break;C.push(G)}let T=po(C);if(!T){z.push(V);continue}let _=rb(T);if(!_){z.push(V);continue}z.push(_),$=D-1,$<E&&($=E)}return z};Oi=rt;let it=u.create({name:"outlineMarkdown",addCommands(){return{insertMarkdown:I=>({editor:x})=>{if(!be)return!1;if(!(be.getState(x.state)||{}).editingSectionId)return gr(),!1;if(!x?.storage?.markdown?.parser)return P("Markdown \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F"),!1;let M=x.storage.markdown.parser.parse(String(I||""),{inline:!0}),z=rt(M);return z.length?x.chain().focus().insertContent(z).run():!1}}}}),We=u.create({name:"outlineFormattedPaste",addProseMirrorPlugins(){let I=this.editor,x=j=>{let F=String(j||"").trim();if(!F)return"";let N=null;try{N=new DOMParser().parseFromString(F,"text/html")}catch{return F}let C=N?.body;if(!C)return F;try{for(let E of Array.from(C.querySelectorAll("ms-cmark-node"))){let D=E.parentNode;if(D){for(;E.firstChild;)D.insertBefore(E.firstChild,E);D.removeChild(E)}}}catch{}try{for(let E of Array.from(C.querySelectorAll("h1,h2,h3,h4,h5,h6"))){let D=N.createElement("p"),T=N.createElement("strong");try{for(;E.firstChild;)T.appendChild(E.firstChild)}catch{T.textContent=String(E.textContent||"")}D.appendChild(T),E.replaceWith(D)}}catch{}return String(C.innerHTML||"").replace(/<!--\s*StartFragment\s*-->/gi,"").replace(/<!--\s*EndFragment\s*-->/gi,"").trim()},L=j=>{let F=String(j||"").trim();if(!F||!F.includes("<")||!F.includes(">")||!/<\s*\/?\s*[a-z][^>]*>/i.test(F))return!1;try{let C=new DOMParser().parseFromString(F,"text/html")?.body;if(!C)return!1;let E=new Set(["p","br","strong","b","em","i","u","s","a","ul","ol","li","blockquote","pre","code","table","thead","tbody","tr","td","th","img","span","div","h1","h2","h3","h4","h5","h6"]);return!!Array.from(C.querySelectorAll("*")).find(T=>E.has(String(T.tagName||"").toLowerCase()))}catch{return!1}},M=j=>{let F=String(j||"").replace(/\r\n/g,`
`).trim();return F?[/```[\s\S]*```/m,/^\s{0,3}([-*+]|\d+\.)\s+\S/m,/^\s{0,3}>\s+\S/m,/\[[^\]]+\]\([^)]+\)/,/!\[[^\]]*\]\([^)]+\)/,/\*\*[^*\n]+\*\*/,/__[^_\n]+__/,/`[^`\n]+`/].some(C=>C.test(F)):!1},z=j=>{try{let F=String(j||"").replace(/\r\n/g,`
`).split(`
`).map(N=>String(N||"").trim()).filter(Boolean);return F.length<2?!1:!!po(F)}catch{return!1}},$=(j,F)=>{if(!F||!Array.isArray(F)||!F.length)return!1;let N=j?.state?.selection?.from,C=j?.state?.selection?.to;if(!Number.isFinite(N)||!Number.isFinite(C))return!1;try{return I.chain().focus().command(({tr:E})=>(E.setMeta(de,!0),!0)).insertContentAt({from:N,to:C},F).run()}catch{return!1}},V=(j,F)=>{try{if(!(be?.getState?.(j.state)||null)?.editingSectionId)return!1;let C=F?.clipboardData?.items||null,E=F?.clipboardData?.files||null;if(E&&E.length||C&&Array.from(C).some(_=>_?.kind==="file"))return!1;let D=String(F?.clipboardData?.getData?.("text/html")||"").trim(),T=String(F?.clipboardData?.getData?.("text/plain")||"").trim();if(D)try{let _=String(D).match(/<h[1-6][\s>]/gi);if((Array.isArray(_)?_.length:0)>=2)return!1}catch{}if(D){let _=x(D),U=rt(_);return U.length?(F.preventDefault(),F.stopPropagation(),$(j,U)):!1}if(T&&L(T)){let _=x(T),U=rt(_);return U.length?(F.preventDefault(),F.stopPropagation(),$(j,U)):!1}if(T&&M(T)){if(z(T))return!1;try{let ee=il(T);if(ee?.startsWithHeading||(ee?.sections?.length||0)>=2)return!1}catch{}let _=I?.storage?.markdown?.parser||null;if(!_?.parse)return!1;let U=!T.includes(`
`)&&!/^\s{0,3}([-*+]|\d+\.)\s+\S/m.test(T)&&!/```[\s\S]*```/m.test(T)&&!/^\s{0,3}>\s+\S/m.test(T),G=String(_.parse(T,{inline:U})).trim();if(!G)return!1;let q=x(G),K=rt(q);return K.length?(F.preventDefault(),F.stopPropagation(),$(j,K)):!1}return!1}catch{return!1}};return[new S({props:{handlePaste(j,F){return V(j,F)},handleDOMEvents:{paste(j,F){return V(j,F)}}}})]}}),St=!1,pt=null,ot=lo()?performance.now():0,Ze=a.article?.docJson||null;if(Ze&&typeof Ze=="object"&&Ze.type==="doc"&&Array.isArray(Ze.content)&&(pt=Ze),pt||(pt=Ib({blocks:a.article?.blocks||[],parseHtmlToNodes:rt}),St=!!(a.article&&!a.article?.docJson&&!a.article?.encrypted)),ot&&Vo("build initial content",{ms:Math.round(performance.now()-ot)}),re){try{re.destroy()}catch{}re=null}let Tt=ne?ne.configure({html:!0,tightLists:!0,transformPastedText:!1,transformCopiedText:!1}):null,Ye=u.create({name:"outlineTableCellStyling",addOptions(){return{types:["tableCell","tableHeader"],textAlignValues:["left","center","right","justify"],verticalAlignValues:["top","middle","bottom"]}},addGlobalAttributes(){let I=(L,M)=>{try{let z=L?.style?.[M];return z?String(z).trim():""}catch{return""}},x=L=>{let M=[],z=L?.nodeTextAlign?String(L.nodeTextAlign):"",$=L?.nodeVerticalAlign?String(L.nodeVerticalAlign):"",V=L?.nodeTextColor?String(L.nodeTextColor):"",j=L?.nodeBackground?String(L.nodeBackground):"";return z&&this.options.textAlignValues.includes(z)&&M.push(`text-align: ${z}`),$&&this.options.verticalAlignValues.includes($)&&M.push(`vertical-align: ${$}`),V&&M.push(`color: ${V}`),j&&M.push(`background-color: ${j}`),M.length?{style:M.join("; ")}:{}};return[{types:this.options.types,attributes:{nodeTextAlign:{default:null,parseHTML:L=>{let M=I(L,"textAlign");return M&&this.options.textAlignValues.includes(M)?M:null},renderHTML:L=>x(L)},nodeVerticalAlign:{default:null,parseHTML:L=>{let M=I(L,"verticalAlign");return M&&this.options.verticalAlignValues.includes(M)?M:null},renderHTML:L=>x(L)},nodeTextColor:{default:null,parseHTML:L=>{let M=I(L,"color");return M?String(M).replace(/['"]+/g,""):null},renderHTML:L=>x(L)},nodeBackground:{default:null,parseHTML:L=>{let M=I(L,"backgroundColor");return M?String(M).replace(/['"]+/g,""):null},renderHTML:L=>x(L)}}}]},addCommands(){let I=(L,M)=>({state:z,dispatch:$})=>{try{let V=xl(z);if(!V.length)return!1;let j=z.tr,F=!1;for(let{node:N,pos:C}of V){if(!N||typeof C!="number")continue;let E={...N.attrs||{}};M==null||M===""?delete E[L]:E[L]=M,j=j.setNodeMarkup(C,void 0,E),F=!0}return F?(j=j.setMeta(de,!0),$(j),!0):!1}catch{return!1}},x=()=>({state:L,dispatch:M})=>{try{let z=xl(L);if(!z.length)return!1;let $=L.schema.nodes?.paragraph||null;if(!$)return!1;let V=L.tr,j=[...z].sort((N,C)=>Number(C.pos)-Number(N.pos)),F=!1;for(let{node:N,pos:C}of j){if(!N||typeof C!="number")continue;let E=C+1,D=C+N.nodeSize-1;if(!(D>=E))continue;let T=$.createAndFill();T&&(V=V.replaceWith(E,D,T),F=!0)}return F?(V=V.setMeta(de,!0),M(V.scrollIntoView()),!0):!1}catch{return!1}};return{setNodeTextAlign:L=>I("nodeTextAlign",L),setNodeVAlign:L=>I("nodeVerticalAlign",L),setNodeTextColor:L=>I("nodeTextColor",L),setNodeBackground:L=>I("nodeBackground",L),unsetNodeAlignment:()=>({state:L,dispatch:M})=>{try{let z=xl(L);if(!z.length)return!1;let $=L.tr,V=!1;for(let{node:j,pos:F}of z){if(!j||typeof F!="number")continue;let N=j.attrs?.nodeTextAlign||null,C=j.attrs?.nodeVerticalAlign||null;if(!N&&!C)continue;let E={...j.attrs||{}};delete E.nodeTextAlign,delete E.nodeVerticalAlign,$=$.setNodeMarkup(F,void 0,E),V=!0}return V?($=$.setMeta(de,!0),M($),!0):!1}catch{return!1}},clearNodeContents:()=>x()}}}),Mn=u.create({name:"outlineTablePercentWidths",addProseMirrorPlugins(){return[new S({view(I){let x=null,L=$=>{let V=String($||"").trim();if(!V)return 0;let j=V.match(/(-?\\d+(?:\\.\\d+)?)px/i);return j&&Number(j[1])||0},M=()=>{x=null;try{let $=I?.dom;if(!$)return;let V=$.querySelectorAll(".tableWrapper > table");for(let j of V){let F=j.querySelector("colgroup");if(!F)continue;let N=Array.from(F.querySelectorAll("col"));if(!N.length||co)continue;try{j.style.width="100%",j.style.maxWidth="100%",j.style.tableLayout="fixed"}catch{}let C=!1;for(let E of N){let D=E?.dataset?.ttPct||"",T=Number.parseFloat(String(D||""));if(Number.isFinite(T)&&T>0)C=!0,E.style.width=`${T.toFixed(4)}%`,E.style.minWidth="";else{let _=qp(E.style.width);_!=null&&_>0&&(C=!0,E.dataset.ttPct=_.toFixed(4),E.style.width=`${_.toFixed(4)}%`,E.style.minWidth="")}}if(!C)try{let E=j.querySelector("tbody tr");if(!E)continue;let D=Array.from(E.children||[]).filter(q=>q&&q.nodeType===1);if(D.length<N.length)continue;let T=[];for(let q=0;q<N.length;q+=1){let K=D[q].getBoundingClientRect();T.push(Number.isFinite(K.width)?K.width:0)}let _=T.reduce((q,K)=>q+(Number.isFinite(K)?K:0),0);if(!(_>0))continue;let U=T.map(q=>lr(q/_*100)),G=U.reduce((q,K)=>q+K,0);Math.abs(G-100)>.01&&(U[U.length-1]=lr(U[U.length-1]+(100-G)));for(let q=0;q<N.length;q+=1)ma(N[q],U[q])}catch{}}}catch{}},z=()=>{x==null&&(x=window.requestAnimationFrame(M))};return z(),{update(){z()},destroy(){x!=null&&(window.cancelAnimationFrame(x),x=null)}}}})]}}),sn=u.create({name:"outlineTableSmartMouseSelection",addProseMirrorPlugins(){let I=Ot?.CellSelection||null;return I?[new S({view(x){let L=z=>{try{for(let $=z.depth;$>=0;$-=1){let V=z.node($)?.type?.name;if(V==="tableCell"||V==="tableHeader")return z.before($)}}catch{}return null},M=()=>{try{if(!(be?.getState?.(x.state)||null)?.editingSectionId)return;let $=x.state.selection;if(!$||$.empty)return;let V=L($.$anchor),j=L($.$head);if(V==null||j==null||V===j)return;let F=typeof I.create=="function"?I.create(x.state.doc,V,j):null;if(!F)return;let N=x.state.tr.setSelection(F);N=N.setMeta(de,!0),x.dispatch(N)}catch{}};return x.dom.addEventListener("mouseup",M,!0),{destroy(){x.dom.removeEventListener("mouseup",M,!0)}}}})]:[]}}),ln=u.create({name:"outlineTableResizeCapture",addProseMirrorPlugins(){return[new S({view(I){let x=M=>{try{if(!M?.target?.closest?.(".column-resize-handle")||!(be?.getState?.(I.state)||null)?.editingSectionId)return;co=!0}catch{}},L=()=>{if(co){co=!1;try{let M=I.domAtPos(I.state.selection.from),$=((M?.node&&M.node.nodeType===1?M.node:M?.node?.parentElement)||null)?.closest?.("table")||null;$&&ca($)}catch{}}};return I.dom.addEventListener("pointerdown",x,!0),document.addEventListener("pointerup",L,!0),document.addEventListener("pointercancel",L,!0),{destroy(){I.dom.removeEventListener("pointerdown",x,!0),document.removeEventListener("pointerup",L,!0),document.removeEventListener("pointercancel",L,!0)}}}})]}}),pn=u.create({name:"outlineTableNodeUi",addProseMirrorPlugins(){let I=this.editor,x=[{label:"Default text",value:null},{label:"Gray text",value:"var(--tt-color-text-gray)"},{label:"Brown text",value:"var(--tt-color-text-brown)"},{label:"Orange text",value:"var(--tt-color-text-orange)"},{label:"Yellow text",value:"var(--tt-color-text-yellow)"},{label:"Green text",value:"var(--tt-color-text-green)"},{label:"Blue text",value:"var(--tt-color-text-blue)"},{label:"Purple text",value:"var(--tt-color-text-purple)"},{label:"Pink text",value:"var(--tt-color-text-pink)"},{label:"Red text",value:"var(--tt-color-text-red)"}],L=[{label:"Default background",value:null},{label:"Gray background",value:"var(--tt-color-highlight-gray)"},{label:"Brown background",value:"var(--tt-color-highlight-brown)"},{label:"Orange background",value:"var(--tt-color-highlight-orange)"},{label:"Yellow background",value:"var(--tt-color-highlight-yellow)"},{label:"Green background",value:"var(--tt-color-highlight-green)"},{label:"Blue background",value:"var(--tt-color-highlight-blue)"},{label:"Purple background",value:"var(--tt-color-highlight-purple)"},{label:"Pink background",value:"var(--tt-color-highlight-pink)"},{label:"Red background",value:"var(--tt-color-highlight-red)"}],M=[{label:"Align left",value:"left"},{label:"Align center",value:"center"},{label:"Align right",value:"right"},{label:"Justify",value:"justify"}],z=[{label:"Align top",value:"top"},{label:"Align middle",value:"middle"},{label:"Align bottom",value:"bottom"}],$=N=>{try{if(!N)return null;let C={left:Number(N.left),top:Number(N.top),right:Number(N.right),bottom:Number(N.bottom),width:Number(N.width),height:Number(N.height)};return!Number.isFinite(C.left)||!Number.isFinite(C.top)?null:C}catch{return null}},V=(N,C,E,D,T=8)=>{try{let _=window.innerWidth||0,U=window.innerHeight||0,G=Math.max(T,Math.min(N,Math.max(T,_-E-T))),q=Math.max(T,Math.min(C,Math.max(T,U-D-T)));return{left:G,top:q}}catch{return{left:N,top:C}}};class j{constructor(){this.panels=[],this.onDocPointerDown=C=>{try{let E=C?.target||null,D=typeof C?.composedPath=="function"?C.composedPath():null,T=Array.isArray(D)&&D.length?D:E?[E]:[];if(!T.length)return;for(let _ of T)for(let U of this.panels)if(U&&(_===U||U.contains(_)))return;this.closeAll()}catch{this.closeAll()}},this.onKeyDown=C=>{C?.key==="Escape"&&this.closeAll()}}isOpen(){return this.panels.length>0}closeAll(){try{for(let C of this.panels)C?.remove?.()}catch{}this.panels=[];try{document.removeEventListener("pointerdown",this.onDocPointerDown,!1),window.removeEventListener("keydown",this.onKeyDown,!1)}catch{}}openPanel({anchorRect:C,items:E,level:D=0}){let T=$(C);if(!T)return;for(;this.panels.length>D;){let ee=this.panels.pop();try{ee?.remove?.()}catch{}}let _=document.createElement("div");_.className="tt-table-menu",_.setAttribute("role","menu"),_.setAttribute("data-level",String(D)),_.addEventListener("pointerdown",ee=>{ee.stopPropagation()}),_.addEventListener("mousedown",ee=>{ee.stopPropagation()});for(let ee of E){if(ee.type==="separator"){let Ae=document.createElement("div");Ae.className="tt-table-menu-sep",_.appendChild(Ae);continue}let se=document.createElement("button");if(se.type="button",se.className="tt-table-menu-item",se.textContent=ee.label,se.disabled=!!ee.disabled,ee.swatch){se.classList.add("has-swatch");try{let Ae=ee.swatchValue==null?"transparent":String(ee.swatchValue);se.style.setProperty("--tt-swatch",Ae)}catch{}}ee.submenu&&se.classList.add("has-submenu"),se.addEventListener("click",Ae=>{if(Ae.preventDefault(),Ae.stopPropagation(),!ee.disabled){if(ee.submenu){let ge=se.getBoundingClientRect();this.openPanel({anchorRect:ge,items:ee.submenu(),level:D+1});return}try{ee.onClick?.()}finally{this.closeAll()}}}),_.appendChild(se)}document.body.appendChild(_);let U=_.getBoundingClientRect(),G=T.right+8,q=T.top,K=V(G,q,U.width,U.height);_.style.left=`${K.left}px`,_.style.top=`${K.top}px`,this.panels.push(_);try{this.panels.length===1&&(document.addEventListener("pointerdown",this.onDocPointerDown,!1),window.addEventListener("keydown",this.onKeyDown,!1))}catch{}}}class F{constructor(C){this.view=C,this.menu=new j,this.wrapper=null,this.table=null,this.observedTable=null,this.resizeObserver=null,this.layoutRaf=null,this.resizeRaf=null,this.destroyed=!1,this.root=document.createElement("div"),this.root.className="tt-table-ui",this.root.style.display="none",this.cellOutline=document.createElement("div"),this.cellOutline.className="tt-table-active-cell-outline",this.cellOutline.style.display="none",this.root.appendChild(this.cellOutline),this.scheduleLayout=()=>{this.layoutRaf==null&&(this.layoutRaf=window.requestAnimationFrame(()=>{this.layoutRaf=null,!this.destroyed&&this.update(this.view)}))},this.scheduleResizeLoop=()=>{this.resizeRaf==null&&(this.resizeRaf=window.requestAnimationFrame(()=>{this.resizeRaf=null,!this.destroyed&&co&&this.update(this.view)}))},this.onWrapperScroll=()=>this.scheduleLayout(),this.onWindowResize=()=>this.scheduleLayout();try{window.addEventListener("resize",this.onWindowResize,{passive:!0})}catch{}this.rowHandles=[],this.colHandles=[],this.dragState=null,this.suppressClickUntil=0,this.colDropIndicator=document.createElement("div"),this.colDropIndicator.className="tt-table-drop-indicator tt-table-drop-indicator-col",this.colDropIndicator.style.display="none",this.root.appendChild(this.colDropIndicator),this.rowDropIndicator=document.createElement("div"),this.rowDropIndicator.className="tt-table-drop-indicator tt-table-drop-indicator-row",this.rowDropIndicator.style.display="none",this.root.appendChild(this.rowDropIndicator),this.cellHandle=document.createElement("button"),this.cellHandle.type="button",this.cellHandle.className="tt-table-handle tt-table-cell-handle",this.cellHandle.setAttribute("aria-label","Cell actions"),this.cellHandle.addEventListener("click",E=>{E.preventDefault(),E.stopPropagation();let D=this.cellHandle.getBoundingClientRect();this.openCellMenu(D)}),this.root.appendChild(this.cellHandle)}hideDropIndicators(){try{this.colDropIndicator&&(this.colDropIndicator.style.display="none")}catch{}try{this.rowDropIndicator&&(this.rowDropIndicator.style.display="none")}catch{}}cancelDrag(){let C=this.dragState;if(C){this.dragState=null,this.hideDropIndicators();try{window.removeEventListener("pointermove",C.onMove),window.removeEventListener("pointerup",C.onUp),window.removeEventListener("pointercancel",C.onUp)}catch{}try{document.body.classList.remove("tt-table-dragging")}catch{}}}destroy(){this.destroyed=!0,this.cancelDrag();try{this.cellOutline.style.display="none"}catch{}this.menu.closeAll();try{this.layoutRaf!=null&&window.cancelAnimationFrame(this.layoutRaf)}catch{}this.layoutRaf=null;try{this.resizeRaf!=null&&window.cancelAnimationFrame(this.resizeRaf)}catch{}this.resizeRaf=null;try{window.removeEventListener("resize",this.onWindowResize)}catch{}try{this.wrapper?.removeEventListener?.("scroll",this.onWrapperScroll)}catch{}try{this.resizeObserver?.disconnect?.()}catch{}this.resizeObserver=null,this.observedTable=null;try{this.root.remove()}catch{}this.wrapper=null,this.table=null}ensureAttached(C){if(C&&this.wrapper!==C){try{this.wrapper?.removeEventListener?.("scroll",this.onWrapperScroll)}catch{}try{this.root.remove()}catch{}this.wrapper=C;try{this.wrapper.addEventListener("scroll",this.onWrapperScroll,{passive:!0})}catch{}this.wrapper.appendChild(this.root)}}buildRowHandles(C){for(;this.rowHandles.length>C;){let E=this.rowHandles.pop();try{E?.remove?.()}catch{}}for(;this.rowHandles.length<C;){let E=document.createElement("button");E.type="button",E.className="tt-table-handle tt-table-row-handle",E.setAttribute("aria-label","Row actions"),E.dataset.idx=String(this.rowHandles.length),E.addEventListener("pointerdown",D=>this.onHandlePointerDown(D,E,"row")),E.addEventListener("click",D=>{if(Date.now()<this.suppressClickUntil){D.preventDefault(),D.stopPropagation();return}D.preventDefault(),D.stopPropagation();let T=on(this.view?.state)?.tablePos,_=E.getBoundingClientRect();I?.chain?.().focus?.().run?.();let U=Number(E.dataset.idx||0);sb(I,U),this.openRowMenu(_,U,T)}),this.rowHandles.push(E),this.root.appendChild(E)}}buildColHandles(C){for(;this.colHandles.length>C;){let E=this.colHandles.pop();try{E?.remove?.()}catch{}}for(;this.colHandles.length<C;){let E=document.createElement("button");E.type="button",E.className="tt-table-handle tt-table-col-handle",E.setAttribute("aria-label","Column actions"),E.dataset.idx=String(this.colHandles.length),E.addEventListener("pointerdown",D=>this.onHandlePointerDown(D,E,"col")),E.addEventListener("click",D=>{if(Date.now()<this.suppressClickUntil){D.preventDefault(),D.stopPropagation();return}D.preventDefault(),D.stopPropagation();let T=on(this.view?.state)?.tablePos,_=E.getBoundingClientRect();I?.chain?.().focus?.().run?.();let U=Number(E.dataset.idx||0);cb(I,U),this.openColumnMenu(_,U,T)}),this.colHandles.push(E),this.root.appendChild(E)}}onHandlePointerDown(C,E,D){try{if(!C||C.button!==0)return;C.preventDefault(),C.stopPropagation(),I?.chain?.().focus?.().run?.();let T=Number(E?.dataset?.idx||0);try{typeof E.setPointerCapture=="function"&&E.setPointerCapture(C.pointerId)}catch{}let _={kind:D,btn:E,pointerId:C.pointerId,fromIndex:T,startX:C.clientX,startY:C.clientY,moved:!1};this.dragState=_;let U=q=>this.onHandlePointerMove(q),G=q=>this.onHandlePointerUp(q);_.onMove=U,_.onUp=G,window.addEventListener("pointermove",U,{passive:!1}),window.addEventListener("pointerup",G,{passive:!1}),window.addEventListener("pointercancel",G,{passive:!1})}catch{}}onHandlePointerMove(C){let E=this.dragState;if(!E||!C||C.pointerId!==E.pointerId)return;try{C.preventDefault()}catch{}let D=C.clientX-E.startX,T=C.clientY-E.startY;if(!E.moved&&Math.hypot(D,T)>=4){E.moved=!0;try{document.body.classList.add("tt-table-dragging")}catch{}}if(E.moved){let _=this.getDropIndexFromPointer(E.kind,C.clientX,C.clientY);E.dropIndex=_,_==null?this.hideDropIndicators():this.updateDropIndicator(E.kind,_,C.clientX,C.clientY)}}getDropIndexFromPointer(C,E,D){try{let T=this.table;if(!T)return null;let _=Array.from(T.querySelectorAll("tbody tr"));if(!_.length)return null;if(C==="col"){let G=Array.from(_[0].children||[]).filter(K=>K&&K.nodeType===1);if(!G.length)return null;let q=G.map(K=>{let ee=K.getBoundingClientRect();return ee.left+ee.width/2});if(!q.length)return null;if(E<q[0])return 0;for(let K=0;K<q.length-1;K+=1)if(E>=q[K]&&E<q[K+1])return K+1;return q.length-1}let U=_.map(G=>{let q=G.children&&G.children[0];if(!q)return null;let K=q.getBoundingClientRect();return K.top+K.height/2}).filter(G=>typeof G=="number");if(!U.length)return null;if(D<U[0])return 0;for(let G=0;G<U.length-1;G+=1)if(D>=U[G]&&D<U[G+1])return G+1;return U.length-1}catch{return null}}updateDropIndicator(C,E,D,T){try{let _=this.table,U=this.wrapper;if(!_||!U)return;let G=U.getBoundingClientRect(),q=_.getBoundingClientRect(),K=q.top-G.top,ee=q.left-G.left,se=q.width,Ae=q.height,ge=Array.from(_.querySelectorAll("tbody tr"));if(!ge.length)return;if(C==="col"){let ft=Array.from(ge[0].children||[]).filter(Z=>Z&&Z.nodeType===1);if(!ft.length)return;let ct=Math.max(0,Math.min(ft.length-1,Number(E))),jt=ft[ct].getBoundingClientRect(),mn=ft[ft.length-1].getBoundingClientRect(),Yn=mn.left+mn.width/2,R=ct===ft.length-1&&D>Yn?mn.right-G.left:jt.left-G.left;this.colDropIndicator.style.display="",this.rowDropIndicator.style.display="none",this.colDropIndicator.style.left=`${Math.round(R)}px`,this.colDropIndicator.style.top=`${Math.round(K)}px`,this.colDropIndicator.style.height=`${Math.max(0,Math.round(Ae))}px`;return}let xe=Math.max(0,Math.min(ge.length-1,Number(E))),Be=ge[xe]?.children?.[0];if(!Be)return;let De=Be.getBoundingClientRect(),Te=(ge[ge.length-1]?.children?.[0]||null)?.getBoundingClientRect?.()||null,Ue=Te?Te.top+Te.height/2:null,je=xe===ge.length-1&&Te&&typeof Ue=="number"&&T>Ue?Te.bottom-G.top:De.top-G.top;this.rowDropIndicator.style.display="",this.colDropIndicator.style.display="none",this.rowDropIndicator.style.left=`${Math.round(ee)}px`,this.rowDropIndicator.style.top=`${Math.round(je)}px`,this.rowDropIndicator.style.width=`${Math.max(0,Math.round(se))}px`}catch{}}onHandlePointerUp(C){let E=this.dragState;if(!E||!C||C.pointerId!==E.pointerId)return;try{C.preventDefault(),C.stopPropagation()}catch{}this.dragState=null;try{window.removeEventListener("pointermove",E.onMove),window.removeEventListener("pointerup",E.onUp),window.removeEventListener("pointercancel",E.onUp)}catch{}try{document.body.classList.remove("tt-table-dragging")}catch{}if(this.hideDropIndicators(),!E.moved)return;this.suppressClickUntil=Date.now()+250;let D=E.dropIndex??this.getDropIndexFromPointer(E.kind,C.clientX,C.clientY);if(D!=null){try{I?.chain?.().focus?.().run?.()}catch{}E.kind==="col"?Wp(I,E.fromIndex,D):Yp(I,E.fromIndex,D),this.scheduleLayout()}}isEnabled(){try{return!!(be?.getState?.(this.view.state)||null)?.editingSectionId&&!a.isPublicView}catch{return!1}}update(C){if(this.view=C,!co&&this.resizeRaf!=null){try{window.cancelAnimationFrame(this.resizeRaf)}catch{}this.resizeRaf=null}if(!this.isEnabled()){this.root.style.display="none",this.menu.closeAll();try{this.cellOutline.style.display="none"}catch{}return}let E=on(C.state),D=ib(C),T=D?.closest?.("table")||kn(C),_=T?.closest?.(".tableWrapper")||null;if(!E||!T||!_||!D){this.root.style.display="none",this.menu.isOpen()||this.menu.closeAll();try{this.cellOutline.style.display="none"}catch{}return}this.ensureAttached(_),this.table=T;try{typeof ResizeObserver=="function"&&(this.resizeObserver||(this.resizeObserver=new ResizeObserver(()=>this.scheduleLayout())),this.observedTable!==T&&(this.resizeObserver.disconnect(),this.resizeObserver.observe(T),this.observedTable=T))}catch{}this.root.style.display="";let U=Array.from(T.querySelectorAll("tbody tr")),G=Number(E.map?.height||U.length||0),q=Number(E.map?.width||0);this.buildRowHandles(Math.max(0,G)),this.buildColHandles(Math.max(0,q));let K=_.getBoundingClientRect(),ee=T.getBoundingClientRect(),se=ee.top-K.top,Ae=ee.left-K.left,ge=14,xe=4,Be=ge/2,De=Math.max(0,Math.min(Math.max(0,G-1),Number(E.rowIndex||0))),Ne=Math.max(0,Math.min(Math.max(0,q-1),Number(E.colIndex||0))),Te=Math.max(Be,se-(ge/2+xe)),Ue=Math.max(Be,Ae-(ge/2+xe)),je=D.getBoundingClientRect(),ft=je.left-K.left+je.width/2,ct=je.top-K.top+je.height/2,jt=je.left-K.left,mn=je.top-K.top,Yn="cell";try{let R=C.state.selection,Z=R?.$anchorCell?.pos,X=R?.$headCell?.pos;if(typeof Z=="number"&&typeof X=="number"&&Z!==X){let Q=Z-(E.tablePos+1),ie=X-(E.tablePos+1),le=E.map?.rectBetween?.(Q,ie)||null;if(le){let ae=Number(le.right)-Number(le.left),ye=Number(le.bottom)-Number(le.top);ae===1&&ye>1?Yn="col":ye===1&&ae>1?Yn="row":Yn="range"}else Yn="range"}}catch{Yn="cell"}try{Yn==="cell"?(this.cellOutline.style.display="",this.cellOutline.style.left=`${Math.round(jt)}px`,this.cellOutline.style.top=`${Math.round(mn)}px`,this.cellOutline.style.width=`${Math.max(0,Math.round(je.width))}px`,this.cellOutline.style.height=`${Math.max(0,Math.round(je.height))}px`):this.cellOutline.style.display="none"}catch{try{this.cellOutline.style.display="none"}catch{}}for(let R=0;R<this.colHandles.length;R+=1){let Z=this.colHandles[R];if(Z){if(Z.dataset.idx=String(R),R!==Ne){Z.style.display="none";continue}Z.style.display="",Z.style.width=`${Math.max(18,Math.round(je.width))}px`,Z.style.height=`${ge}px`,Z.style.left=`${Math.round(ft)}px`,Z.style.top=`${Math.round(Te)}px`}}for(let R=0;R<this.rowHandles.length;R+=1){let Z=this.rowHandles[R];if(Z){if(Z.dataset.idx=String(R),R!==De){Z.style.display="none";continue}Z.style.display="",Z.style.width=`${ge}px`,Z.style.height=`${Math.max(18,Math.round(je.height))}px`,Z.style.left=`${Math.round(Ue)}px`,Z.style.top=`${Math.round(ct)}px`}}try{if(Yn!=="cell")this.cellHandle.style.display="none";else{let R=je.right-K.left;this.cellHandle.style.display="",this.cellHandle.style.left=`${Math.round(R)}px`,this.cellHandle.style.top=`${Math.round(ct)}px`}}catch{this.cellHandle.style.display="none"}co&&this.scheduleResizeLoop()}openCellMenu(C){let E=()=>{try{I?.chain?.().focus?.().run?.()}catch{}},D=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>x.map(T=>({label:T.label,swatch:!0,swatchValue:T.value,onClick:()=>{E(),I.commands.setNodeTextColor(T.value)}}))},{label:"Background color",submenu:()=>L.map(T=>({label:T.label,swatch:!0,swatchValue:T.value,onClick:()=>{E(),I.commands.setNodeBackground(T.value)}}))}]},{label:"Alignment",submenu:()=>[...M.map(T=>({label:T.label,onClick:()=>{E(),I.commands.setNodeTextAlign(T.value)}})),{type:"separator"},...z.map(T=>({label:T.label,onClick:()=>{E(),I.commands.setNodeVAlign(T.value)}}))]},{type:"separator"},{label:"Clear contents",onClick:()=>{E(),I.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:C,items:D,level:0})}openRowMenu(C,E,D){let T=()=>{try{I?.chain?.().focus?.().run?.()}catch{}Number.isFinite(Number(D))&&ab(I,D,E)},_=(K,ee)=>{try{I?.chain?.().focus?.().run?.()}catch{}return I.commands.command(({state:se,dispatch:Ae})=>{let ge=Number.isFinite(Number(D))?Number(D):on(se)?.tablePos,xe=Number.isFinite(Number(E))?Number(E):on(se)?.rowIndex;return!Number.isFinite(Number(ge))||!Number.isFinite(Number(xe))?!1:db({pmState:se,dispatch:Ae},{tablePos:ge,rowIndex:xe,attr:K,value:ee})})},U=K=>()=>(T(),K?.()),G=K=>{try{return typeof K!="function"?!1:(T(),I.commands.command(({state:ee,dispatch:se})=>K(ee,typeof se=="function"?ge=>{try{ge=ge.setMeta(de,!0)}catch{}se(ge)}:void 0)))}catch{return!1}},q=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>x.map(K=>({label:K.label,swatch:!0,swatchValue:K.value,onClick:()=>_("nodeTextColor",K.value)}))},{label:"Background color",submenu:()=>L.map(K=>({label:K.label,swatch:!0,swatchValue:K.value,onClick:()=>_("nodeBackground",K.value)}))}]},{label:"Alignment",submenu:()=>[...M.map(K=>({label:K.label,onClick:()=>_("nodeTextAlign",K.value)})),{type:"separator"},...z.map(K=>({label:K.label,onClick:()=>_("nodeVerticalAlign",K.value)}))]},{type:"separator"},{label:"Insert row above",onClick:()=>G(Ot?.addRowBefore)},{label:"Insert row below",onClick:()=>G(Ot?.addRowAfter)},{label:"Sort ",submenu:()=>[{label:"Sort column A-Z",onClick:U(()=>Ap(I,{direction:"asc"}))},{label:"Sort column Z-A",onClick:U(()=>Ap(I,{direction:"desc"}))}]},{label:"Header row",onClick:()=>G(Ot?.toggleHeaderRow)},{label:"Move ",submenu:()=>[{label:"Move row up",onClick:U(()=>xp(I,-1))},{label:"Move row down",onClick:U(()=>xp(I,1))},{label:"Move row left",disabled:!0,onClick:()=>{}},{label:"Move row right",disabled:!0,onClick:()=>{}}]},{label:"Duplicate row",onClick:U(()=>pb(I))},{label:"Delete row",onClick:()=>G(Ot?.deleteRow)},{type:"separator"},{label:"Clear row contents",onClick:()=>{T(),I.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:C,items:q,level:0})}openColumnMenu(C,E,D){let T=()=>{try{I?.chain?.().focus?.().run?.()}catch{}Number.isFinite(Number(D))&&lb(I,D,E)},_=(K,ee)=>{try{I?.chain?.().focus?.().run?.()}catch{}return I.commands.command(({state:se,dispatch:Ae})=>{let ge=Number.isFinite(Number(D))?Number(D):on(se)?.tablePos,xe=Number.isFinite(Number(E))?Number(E):on(se)?.colIndex;return!Number.isFinite(Number(ge))||!Number.isFinite(Number(xe))?!1:ub({pmState:se,dispatch:Ae},{tablePos:ge,colIndex:xe,attr:K,value:ee})})},U=K=>()=>(T(),K?.()),G=K=>{try{return typeof K!="function"?!1:(T(),I.commands.command(({state:ee,dispatch:se})=>K(ee,typeof se=="function"?ge=>{try{ge=ge.setMeta(de,!0)}catch{}se(ge)}:void 0)))}catch{return!1}},q=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>x.map(K=>({label:K.label,swatch:!0,swatchValue:K.value,onClick:()=>_("nodeTextColor",K.value)}))},{label:"Background color",submenu:()=>L.map(K=>({label:K.label,swatch:!0,swatchValue:K.value,onClick:()=>_("nodeBackground",K.value)}))}]},{label:"Alignment",submenu:()=>[...M.map(K=>({label:K.label,onClick:()=>_("nodeTextAlign",K.value)})),{type:"separator"},...z.map(K=>({label:K.label,onClick:()=>_("nodeVerticalAlign",K.value)}))]},{type:"separator"},{label:"Insert column left",onClick:()=>{T();let K=Math.max(0,Number(E||0));G(Ot?.addColumnBefore)&&window.requestAnimationFrame(()=>{try{ua(I,{insertIndex:K,newColPct:10})}catch{let se=kn(I.view);ca(se)}})}},{label:"Insert column right",onClick:()=>{T();let K=Math.max(0,Number(E||0)+1);G(Ot?.addColumnAfter)&&window.requestAnimationFrame(()=>{try{ua(I,{insertIndex:K,newColPct:10})}catch{let se=kn(I.view);ca(se)}})}},{label:"Sort ",submenu:()=>[{label:"Sort row A-Z",onClick:U(()=>kp(I,{direction:"asc"}))},{label:"Sort row Z-A",onClick:U(()=>kp(I,{direction:"desc"}))}]},{label:"Header column",onClick:()=>G(Ot?.toggleHeaderColumn)},{label:"Move ",submenu:()=>[{label:"Move column up",disabled:!0,onClick:()=>{}},{label:"Move column down",disabled:!0,onClick:()=>{}},{label:"Move column left",onClick:U(()=>Sp(I,-1))},{label:"Move column right",onClick:U(()=>Sp(I,1))}]},{label:"Duplicate column",onClick:U(()=>mb(I))},{label:"Delete column",onClick:()=>{T();let K=kn(I.view),ee=jo(K),se=Number.isFinite(Number(E))?Number(E):null,Ae=ee&&se!=null?jp(ee,se):null;G(Ot?.deleteColumn)&&Array.isArray(Ae)&&window.requestAnimationFrame(()=>{let xe=kn(I.view);Jo(xe,Ae)})}},{type:"separator"},{label:"Clear column contents",onClick:()=>{T(),I.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:C,items:q,level:0})}}return[new S({view(N){let C=new F(N);return C.update(N),{update(E){C.update(E)},destroy(){C.destroy()}}}})]}}),Wn=lo()?performance.now():0;if(re){jr("outline.mount.remountDetected",{outlineArticleId:Et,hadInstance:!0});try{re.destroy()}catch{}re=null}re=new l({element:e,extensions:[wr,pe,fe,Kt,tr,cn,Y,ce,Je,vt,he,Xe,dt,$e,br,at,Dt,Nt,tn,We,J.configure({types:["outlineSection"],attributeName:"id",generateID:()=>fn()}),g.configure({document:!1,heading:!1,link:!1}),B.configure({openOnClick:!1,protocols:js}),Tt,Mt,qe,Ye,W.configure({table:{resizable:!0}}),pn,sn,ln,Mn,it].filter(Boolean),content:pt,editorProps:{attributes:{class:"outline-prosemirror"},handleKeyDown(I,x){try{if(te?.isOpen?.()&&te.isOpen()&&!!te.handleKeyDown?.(x))return!0}catch{}try{if((x?.ctrlKey||x?.metaKey)&&!x?.shiftKey&&!x?.altKey&&(String(x?.key||"").toLowerCase()==="v"||String(x?.code||"")==="KeyV")&&!a.isPublicView&&!((be?.getState?.(I.state)||null)?.editingSectionId||null)){let _=Cl();if(_&&Array.isArray(_.sections)&&_.sections.length){x.preventDefault(),x.stopPropagation();let U=I.state,q=U.selection?.$from||null,K=q?Ht(U.doc,q):null,ee=typeof K=="number"?U.doc.nodeAt(K):null,se=U.doc.content.size;typeof K=="number"&&ee&&(se=K+ee.nodeSize);let Ae=new Set;try{U.doc.descendants(Te=>{if(Te?.type?.name!=="outlineSection")return;let Ue=String(Te.attrs?.id||"").trim();Ue&&Ae.add(Ue)})}catch{}let ge=[];if(_.mode==="copy")for(let Te of _.sections)ge.push(Rp(Te,()=>fn()));else for(let Te of _.sections){let Ue=String(Te?.attrs?.id||"").trim();if(Ue&&Ae.has(Ue))return P("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C: \u0431\u043B\u043E\u043A \u0441 \u0442\u0430\u043A\u0438\u043C id \u0443\u0436\u0435 \u0435\u0441\u0442\u044C"),!0;ge.push(Dl(Te))}let xe=U.doc.type.schema,Be=[];for(let Te of ge)try{let Ue=xe.nodeFromJSON(Te);Ue?.type?.name==="outlineSection"&&Be.push(Ue)}catch{}if(!Be.length)return P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438"),!0;let De=U.tr,Ne=se;for(let Te of Be)De=De.insert(Ne,Te),Ne+=Te.nodeSize;return De=De.setMeta(de,!0),I.dispatch(De.scrollIntoView()),bn=!0,yn({delayMs:200}),_.mode==="cut"&&ia(null),qo(!1),P(`\u0412\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${Be.length}`),!0}}}catch{}try{let E=x&&!x.defaultPrevented&&!x.isComposing&&!x.metaKey&&!x.ctrlKey&&!x.altKey,D=E&&String(x?.key||"")==="\\",T=E&&(String(x?.code||"")==="Backslash"||String(x?.code||"")==="IntlBackslash");if(D){x.preventDefault();let{from:_,to:U}=I.state.selection,G=I.state.tr.insertText("\\",_,U).setMeta(de,!0);return I.dispatch(G),!0}if(T)try{window?.localStorage?.getItem?.("ttree_outline_debug_tag_v1")==="1"&&console.log("[outline][tag-debug] backslash-code",{key:String(x?.key||""),code:String(x?.code||""),shiftKey:!!x?.shiftKey,altKey:!!x?.altKey,ctrlKey:!!x?.ctrlKey,metaKey:!!x?.metaKey})}catch{}}catch{}if(x&&x.__memusSyntheticAltProxy)return!1;let L="ttree_outline_debug_alt_v1",M=()=>{try{return window?.localStorage?.getItem?.(L)==="1"}catch{return!1}},z=E=>{try{return!!E?.getModifierState?.("AltGraph")}catch{return!1}};((E,D)=>{try{if(!M())return;let T=String(E?.key||""),_=String(E?.code||"");if(!T.startsWith("Arrow")&&_!=="Enter"&&_!=="NumpadEnter")return;let U={altKey:!!E?.altKey,ctrlKey:!!E?.ctrlKey,metaKey:!!E?.metaKey,shiftKey:!!E?.shiftKey,altGraph:z(E),repeat:!!E?.repeat,location:E?.location??null},G=[];U.metaKey&&G.push("Meta"),U.ctrlKey&&G.push("Ctrl"),U.altKey&&G.push(U.altGraph?"AltGraph":"Alt"),U.shiftKey&&G.push("Shift"),G.push(_||T||"?"),console.log("[outline][alt-debug]",D,{key:T,code:_,name:G.join("-"),...U})}catch{}})(x,"keydown");let V=E=>{try{return!!E?.getModifierState?.("AltGraph")}catch{return!1}},j=E=>{try{return(!!E?.altKey||V(E))&&!E?.metaKey&&(!E?.ctrlKey||V(E))}catch{return!1}},F="ttree_outline_debug_nav_v1",N=()=>{try{return window?.localStorage?.getItem?.(F)==="1"}catch{return!1}},C=(E,D)=>{if(N())try{console.log("[outline][nav-debug]",E,D)}catch{}};try{let D=(be?.getState?.(I.state)||null)?.editingSectionId||null;C("keydown",{key:String(x?.key||""),code:String(x?.code||""),altKey:!!x?.altKey,altGraph:!!z(x),ctrlKey:!!x?.ctrlKey,metaKey:!!x?.metaKey,shiftKey:!!x?.shiftKey,repeat:!!x?.repeat,editingSectionId:D?String(D):null,selection:{empty:!!I.state?.selection?.empty,parent:I.state?.selection?.$from?.parent?.type?.name||null,parentOffset:I.state?.selection?.$from?.parentOffset??null,pos:I.state?.selection?.$from?.pos??null}});try{let q=(se,Ae,ge)=>{try{let xe=ze?.pmStateMod?.TextSelection;if(!xe)return!1;let Be=se.doc.nodeAt(ge);if(!Be||Be.type?.name!=="outlineSection")return!1;let De=Be.child(0),Te=ge+1+1,Ue=se.tr;return Ue=Ue.setSelection(xe.near(Ue.doc.resolve(Te),1)),Ae(Ue.scrollIntoView()),!0}catch{return!1}},K=String(x?.key||""),ee=!x?.shiftKey&&!x?.metaKey&&!x?.ctrlKey&&!x?.altKey&&!z(x);if(!D&&ee&&(K==="ArrowUp"||K==="ArrowDown")){let se=I.state,Ae=Ht(se.doc,se.selection.$from);if(C("nav.check",{key:K,sectionPos:Ae}),typeof Ae=="number"){let ge=(Ne,Te)=>{try{let Ue=Ne.resolve(Math.min(Ne.content.size,Math.max(0,Te+1)));for(let je=Ue.depth;je>0;je-=1){let ft=Ue.node(je);if(!(ft?.type?.name!=="outlineSection"||Ue.before(je)===Te)&&ft.attrs?.collapsed)return!1}return!0}catch{return!0}},De=K==="ArrowUp"?((Ne,Te)=>{let Ue=null;return Ne.nodesBetween(0,Te,(je,ft)=>{if(ft>=Te)return!1;je?.type?.name==="outlineSection"&&ge(Ne,ft)&&(Ue=ft)}),Ue})(se.doc,Ae):((Ne,Te)=>{let Ue=null;return Ne.nodesBetween(Te+1,Ne.content.size,(je,ft)=>{if(Ue!==null)return!1;ft<=Te||je?.type?.name==="outlineSection"&&ge(Ne,ft)&&(Ue=ft)}),Ue})(se.doc,Ae);if(C("nav.target",{key:K,sectionPos:Ae,target:De}),typeof De=="number"){let Ne=q(se,I.dispatch,De);if(C("nav.apply",{ok:Ne}),Ne)return x.preventDefault(),x.stopPropagation(),!0}}}}catch{}let T=!!z(x)&&!x?.altKey&&!x?.ctrlKey&&!x?.metaKey&&!x?.shiftKey,_=String(x?.key||""),U=String(x?.code||"");if(!D&&T&&(_==="ArrowUp"||_==="ArrowDown"||_==="ArrowLeft"||_==="ArrowRight")){let q=null;try{q=new KeyboardEvent("keydown",{key:_,code:U||_,altKey:!0,ctrlKey:!1,metaKey:!1,shiftKey:!1,bubbles:!0,cancelable:!0});try{Object.defineProperty(q,"__memusSyntheticAltProxy",{value:!0})}catch{}}catch{q=null}if(q||(q={key:_,code:U||_,altKey:!0,ctrlKey:!1,metaKey:!1,shiftKey:!1,bubbles:!0,cancelable:!0,__memusSyntheticAltProxy:!0,preventDefault(){},stopPropagation(){},getModifierState(ee){return!1}}),!!I?.someProp?.("handleKeyDown",ee=>ee(I,q)))return x.preventDefault(),x.stopPropagation(),!0}}catch{}try{if(j(x)){let E=String(x.key||"");if((E==="ArrowUp"||E==="ArrowDown")&&x.repeat){let D=I?.state?.selection?.$from}}}catch{}nt("editorProps.keydown",{key:x?.key||null,repeat:!!x?.repeat,selection:{empty:!!I.state?.selection?.empty,parent:I.state?.selection?.$from?.parent?.type?.name||null,parentOffset:I.state?.selection?.$from?.parentOffset??null,pos:I.state?.selection?.$from?.pos??null}});try{let E=ze?.pmStateMod?.TextSelection;if(E){let T=(be?.getState?.(I.state)||null)?.editingSectionId||null,_=(x.key==="Enter"||x.code==="Enter"||x.code==="NumpadEnter")&&(x.ctrlKey||x.metaKey)&&!x.shiftKey&&!x.altKey;if(!a.isPublicView&&!T&&_){let U=I.state.selection,G=U?.$from||null;if(G){let q=Ht(I.state.doc,G),K=typeof q=="number"?I.state.doc.nodeAt(q):null;if(typeof q=="number"&&K?.type?.name==="outlineSection"){let ee=!!(U&&U.empty),se=G.parent?.type?.name==="outlineHeading",ge=ee&&se&&G.parentOffset===0?q:q+K.nodeSize,xe=I.state.schema,Be=fn(),De=xe.nodes.outlineSection.create({id:Be,collapsed:!1},[xe.nodes.outlineHeading.create({},[]),xe.nodes.outlineBody.create({},[xe.nodes.paragraph.create({},[])]),xe.nodes.outlineChildren.create({},[])]),Ne=I.state.tr.insert(ge,De);try{let Ue=Ne.doc.nodeAt(ge)?.child?.(0)||De.child(0),je=ge+1+Ue.nodeSize;Ne=Ne.setSelection(E.near(Ne.doc.resolve(je+2),1))}catch{Ne=Ne.setSelection(E.create(Ne.doc,ge+2))}Ne=Ne.setMeta(de,!0),be&&(Ne=Ne.setMeta(be,{type:"enter",sectionId:Be})),I.dispatch(Ne.scrollIntoView());try{I.focus()}catch{}return x.preventDefault(),x.stopPropagation(),!0}}}}}catch{}try{let E=j(x)&&!x.shiftKey,D=String(x.key||"");if(E&&(D==="ArrowLeft"||D==="ArrowRight"||D==="ArrowUp"||D==="ArrowDown")&&(be?.getState?.(I.state)||null)?.editingSectionId&&re){let _=()=>{try{let U=I?.state?.selection?.$from||null;if(!U)return!1;for(let G=U.depth;G>0;G-=1){let q=U.node(G)?.type?.name;if(q==="table"||q==="tableRow"||q==="tableCell"||q==="tableHeader")return!0}return!1}catch{return!1}};if(D==="ArrowLeft"||D==="ArrowRight"){let U=re.chain().focus();U.command(({tr:q})=>(q.setMeta(de,!0),!0));let G=!1;if(re.isActive("bulletList")||re.isActive("orderedList")?D==="ArrowRight"?G=U.sinkListItem("listItem").run():(G=U.liftListItem("listItem").run(),!G&&re.isActive("bulletList")&&(G=U.toggleBulletList().run()),!G&&re.isActive("orderedList")&&(G=U.toggleOrderedList().run())):D==="ArrowRight"&&(G=U.toggleBulletList().run()),G)return x.preventDefault(),x.stopPropagation(),!0}else if((D==="ArrowUp"||D==="ArrowDown")&&(D==="ArrowUp"?Ep(re,-1)||Ip(re,-1):Ep(re,1)||Ip(re,1)))return x.preventDefault(),x.stopPropagation(),!0}}catch{}try{if((x.ctrlKey||x.metaKey)&&!x.altKey&&!x.shiftKey&&(x.code==="KeyA"||String(x.key||"").toLowerCase()==="a")){let D=ze?.pmStateMod?.TextSelection;if(!D)return nt("editorProps.modA",{handled:!1,reason:"no-TextSelection"}),!1;let T=I.state,_=T.selection,U=_?.$from||null;if(!U)return nt("editorProps.modA",{handled:!1,reason:"no-$from"}),!1;let G=Ht(T.doc,U);if(typeof G!="number")return nt("editorProps.modA",{handled:!1,reason:"no-sectionPos"}),!1;let q=T.doc.nodeAt(G);if(!q||q.type?.name!=="outlineSection")return nt("editorProps.modA",{handled:!1,reason:"not-outlineSection"}),!1;let K=q.child(0),ee=q.child(1);if(!K||!ee)return nt("editorProps.modA",{handled:!1,reason:"missing-heading/body"}),!1;let se=G+1,Ae=se+1,ge=se+K.nodeSize-1,xe=G+1+K.nodeSize,Be=xe+1,De=xe+ee.nodeSize-1,Ne=De;try{let ct=null;T.doc.nodesBetween(Be,Math.min(T.doc.content.size,De),(jt,mn)=>{jt?.isTextblock&&(ct=mn+jt.nodeSize-1)}),typeof ct=="number"&&(Ne=ct)}catch{}Ne<Be&&(Ne=ge);let Te=Ae,Ue=(()=>{try{for(let ct=U.depth;ct>0;ct-=1)if(U.node(ct)?.type?.name==="outlineHeading")return!0}catch{}return!1})(),je=!!_&&typeof _.from=="number"&&typeof _.to=="number"&&Math.min(_.from,_.to)===Te&&Math.max(_.from,_.to)===Ne;if(Ue&&je)return nt("editorProps.modA",{handled:!1,reason:"pass-through-doc-select"}),!1;x.preventDefault(),x.stopPropagation();let ft=D.create(T.doc,Te,Ne);return I.dispatch(T.tr.setSelection(ft)),nt("editorProps.modA",{handled:!0,blockFrom:Te,blockTo:Ne,isInHeading:Ue,alreadySelectedBlock:je}),!0}}catch{}try{if(!be)return!1;let D=(be.getState(I.state)||{}).editingSectionId||null;if(!D){let T=(x.ctrlKey||x.metaKey)&&!x.altKey&&!x.shiftKey&&(x.key==="Delete"||x.key==="Del"||x.key==="Backspace"),_=x.key==="Backspace"||x.key==="Delete",U=x.key&&x.key.length===1&&!x.metaKey&&!x.ctrlKey&&!x.altKey,G=!x.metaKey&&!x.ctrlKey&&!x.altKey&&!x.shiftKey&&(x.key===" "||x.key==="Spacebar");if(T){let q=Ht(I.state.doc,I.state.selection.$from),K=!1;try{typeof q=="number"&&(K=ve(I.state,I.dispatch,q))}catch{K=!1}return nt("editorProps.modDelete",{ok:K,sectionPos:q}),x.preventDefault(),x.stopPropagation(),!0}if(G){let q=document.activeElement;if(!(!!(q&&q.closest&&q.closest(".outline-editor"))||!!(x?.target&&x.target.closest&&x.target.closest(".outline-editor"))))return!1;if(x.repeat)return x.preventDefault(),x.stopPropagation(),!0;let ee=x?.target||null,se=String(ee?.tagName||"").toLowerCase();if(se==="button"||se==="input"||se==="textarea"||se==="select"||ee?.closest?.("button, a[href], input, textarea, select")||!!!ee?.closest?.(".outline-prosemirror")&&ee?.closest?.('[contenteditable="true"]'))return!1;let ge=Ht(I.state.doc,I.state.selection.$from);if(typeof ge!="number")return x.preventDefault(),x.stopPropagation(),!0;let xe=I.state.doc.nodeAt(ge);if(!xe)return x.preventDefault(),x.stopPropagation(),!0;let Be=!xe.attrs?.collapsed,De=I.state.tr.setNodeMarkup(ge,void 0,{...xe.attrs,collapsed:Be});De=De.setMeta(de,!0);try{let Ne=xe.child(0),Ue=ge+1+Ne.nodeSize-1,{TextSelection:je}=ze?.pmStateMod||{};je&&(De=De.setSelection(je.near(De.doc.resolve(Ue),-1)))}catch{}return x.preventDefault(),x.stopPropagation(),I.dispatch(De.scrollIntoView()),!0}if(_){if(x.key==="Backspace")try{let q=I.state,K=q.selection,ee=K?.$from||null,se=null;try{for(let xe=ee?.depth||0;xe>0;xe-=1)if(ee.node(xe)?.type?.name==="outlineHeading"){se=xe;break}}catch{se=null}let Ae=se!==null&&ee?ee.start(se):null,ge=!!(K&&K.empty)&&!!ee&&se!==null&&typeof Ae=="number"&&ee.pos===Ae;if(nt("editorProps.backspace.check",{empty:!!K?.empty,headingDepth:se,headingStart:Ae,pos:ee?.pos??null,parent:ee?.parent?.type?.name||null,parentOffset:ee?.parentOffset??null,atHeadingStart:ge}),ge){let xe=Ht(q.doc,ee),Be=typeof xe=="number"?q.doc.nodeAt(xe):null;if(nt("editorProps.backspace.sectionPos",{sectionPos:xe,hasNode:!!Be}),typeof xe=="number"&&Be){let De=String(Be.attrs?.id||""),Ne=null;try{let Ue=q.doc.resolve(xe),je=Ue.index(),ft=Ue.parent;if(ft&&je>0){let ct=ft.child(je-1),jt=xe-ct.nodeSize,mn=q.doc.nodeAt(jt);Ne=String(mn?.attrs?.id||"")||null}else for(let ct=ee.depth-1;ct>0;ct-=1){let jt=ee.node(ct);if(jt?.type?.name==="outlineSection"){let mn=String(jt.attrs?.id||"");if(mn&&mn!==De){Ne=mn;break}}}}catch{Ne=null}nt("editorProps.backspace.mergeCandidate",{sectionPos:xe,currentSectionId:De,targetSectionId:Ne});let Te=!1;if(Se(Be))Te=ve(q,I.dispatch,xe);else try{q.doc.resolve(xe).index()<=0?Te=Ce(q,I.dispatch,xe):Te=oe(q,I.dispatch,xe)}catch{Te=oe(q,I.dispatch,xe)}return nt("editorProps.backspace.mergeDone",{ok:Te,targetSectionId:Ne}),Te&&Ne&&be&&window.setTimeout(()=>{try{if((be.getState(I.state)||{}).editingSectionId)return;let je=kt(I.state.doc,Ne),ft=typeof je=="number"?I.state.doc.nodeAt(je):null;if(!ft)return;let ct=I.state.tr;ft?.attrs?.collapsed&&(ct=ct.setNodeMarkup(je,void 0,{...ft.attrs,collapsed:!1}),ct=ct.setMeta(de,!0)),ct=ct.setMeta(be,{type:"enter",sectionId:Ne});try{let jt=ct.doc.nodeAt(je);if(jt&&jt.type?.name==="outlineSection"){let mn=jt.child(0),Yn=jt.child(1),Z=je+1+mn.nodeSize+Yn.nodeSize-1;ct=ct.setSelection(b.near(ct.doc.resolve(Z),-1))}}catch{}I.dispatch(ct.scrollIntoView());try{I.focus()}catch{}nt("editorProps.backspace.enterEdit.done",{targetSectionId:Ne})}catch{}},0),x.preventDefault(),x.stopPropagation(),!0}}}catch{}return x.preventDefault(),x.stopPropagation(),!0}if(U)return x.preventDefault(),x.stopPropagation(),gr(),!0}if(a.isPublicView&&!D&&(x.key==="Enter"&&!x.shiftKey&&!x.ctrlKey&&!x.metaKey&&!x.altKey||x.key==="F2"&&!x.shiftKey&&!x.ctrlKey&&!x.metaKey&&!x.altKey))return x.preventDefault(),x.stopPropagation(),!0;if(!D&&(x.key==="Enter"&&!x.shiftKey&&!x.ctrlKey&&!x.metaKey&&!x.altKey||x.key==="F2"&&!x.shiftKey&&!x.ctrlKey&&!x.metaKey&&!x.altKey)){let T=Ht(I.state.doc,I.state.selection.$from);if(typeof T!="number")return!1;let _=I.state.doc.nodeAt(T),U=String(_?.attrs?.id||"");if(!U)return!1;if(x.preventDefault(),x.stopPropagation(),_?.attrs?.collapsed){let G=I.state.tr.setNodeMarkup(T,void 0,{..._.attrs,collapsed:!1});return G.setMeta(de,!0),I.dispatch(G.scrollIntoView()),!0}return I.dispatch(I.state.tr.setMeta(be,{type:"enter",sectionId:U})),!0}if(D&&x.key==="Escape"){x.preventDefault(),x.stopPropagation();let T=D;I.dispatch(I.state.tr.setMeta(be,{type:"exit"}));try{let _=re;if(_&&!_.isDestroyed){let U=fo(I.state.doc,T);Lp(_,I.state.doc,T),U&&yn({delayMs:350})}}catch{}return!0}}catch{}return!1},handleDOMEvents:{click(I,x){try{let L=x.target?.closest?.("a[href]");if(!L||!be)return!1;let M=String(L.getAttribute("href")||"").trim();if(!M)return!1;if(a.isPublicView){let C=String(L.getAttribute("rel")||"").split(/\s+/).filter(Boolean);if(L.getAttribute("data-unpublished")==="1"||C.includes("unpublished")||M==="#")return alert("\u042D\u0442\u0430 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435 \u043E\u043F\u0443\u0431\u043B\u0438\u043A\u043E\u0432\u0430\u043D\u0430"),x.preventDefault(),x.stopPropagation(),!0}if(M.startsWith("app:/")||M.startsWith("disk:/")){x.preventDefault(),x.stopPropagation();let N=er(M);if(N)return window.open(N,"_blank","noopener,noreferrer"),!0}if((be.getState(I.state)||{}).editingSectionId||null)return!1;let V=N=>{let C=String(N||"").trim();if(!C||C.startsWith("/")||C.startsWith("#")||/\s/.test(C)||C.includes("://")||/^[a-z][a-z0-9+.-]*:/i.test(C))return!1;let E=C.split(/[/?#]/,1)[0];return!(!E||!E.includes(".")||E.startsWith(".")||E.endsWith(".")||E.includes(".."))},j=N=>{let C=String(N||"").trim();return C&&(C.startsWith("//")?`https:${C}`:V(C)?`https://${C}`:C)};if(x.preventDefault(),x.stopPropagation(),M.startsWith("/"))return a.isPublicView?(window.location.href=M,!0):(It(M),!0);let F=j(M);return/^https?:\/\//i.test(F)||/^mailto:/i.test(F)||/^tel:/i.test(F),window.open(F,"_blank","noopener,noreferrer"),!0}catch{return!1}},beforeinput(I,x){try{if(!be)return!1;let M=(be.getState(I.state)||{}).editingSectionId||null;if(M)return!1;let z=String(x?.inputType||"");if(z.startsWith("history"))return!1;if(nt("beforeinput",{inputType:z,key:x?.data??null,editingSectionId:M||null,selection:{empty:!!I.state?.selection?.empty,parent:I.state?.selection?.$from?.parent?.type?.name||null,parentOffset:I.state?.selection?.$from?.parentOffset??null}}),z==="deleteContentBackward"){try{let $=I.state,V=$.selection,j=V?.$from||null,F=null;try{for(let E=j?.depth||0;E>0;E-=1)if(j.node(E)?.type?.name==="outlineHeading"){F=E;break}}catch{F=null}let N=F!==null&&j?j.start(F):null,C=!!(V&&V.empty)&&!!j&&F!==null&&typeof N=="number"&&j.pos===N;if(nt("beforeinput.deleteContentBackward.check",{empty:!!V?.empty,headingDepth:F,headingStart:N,pos:j?.pos??null,parent:j?.parent?.type?.name||null,parentOffset:j?.parentOffset??null,atHeadingStart:C}),C){let E=Ht($.doc,j),D=typeof E=="number"?$.doc.nodeAt(E):null;if(typeof E=="number"&&D){let T=String(D.attrs?.id||"");nt("beforeinput.deleteContentBackward.candidate",{sectionPos:E,currentSectionId:T});let _=null;try{let G=$.doc.resolve(E),q=G.index(),K=G.parent;if(K&&q>0){let ee=K.child(q-1),se=E-ee.nodeSize,Ae=$.doc.nodeAt(se);_=String(Ae?.attrs?.id||"")||null}else for(let ee=j.depth-1;ee>0;ee-=1){let se=j.node(ee);if(se?.type?.name==="outlineSection"){let Ae=String(se.attrs?.id||"");if(Ae&&Ae!==T){_=Ae;break}}}}catch{_=null}let U=!1;if(Se(D))nt("beforeinput.merge",{kind:"deleteEmpty",sectionPos:E}),U=ve($,I.dispatch,E);else try{$.doc.resolve(E).index()<=0?(nt("beforeinput.merge",{kind:"intoParent",sectionPos:E,targetSectionId:_}),U=Ce($,I.dispatch,E)):(nt("beforeinput.merge",{kind:"intoPrev",sectionPos:E,targetSectionId:_}),U=oe($,I.dispatch,E))}catch{nt("beforeinput.merge",{kind:"intoPrev.catch",sectionPos:E,targetSectionId:_}),U=oe($,I.dispatch,E)}return nt("beforeinput.merge.done",{ok:U,targetSectionId:_}),U&&_&&window.setTimeout(()=>{try{if((be.getState(I.state)||{}).editingSectionId)return;let q=kt(I.state.doc,_),K=typeof q=="number"?I.state.doc.nodeAt(q):null;if(!K)return;let ee=I.state.tr;K?.attrs?.collapsed&&(ee=ee.setNodeMarkup(q,void 0,{...K.attrs,collapsed:!1}),ee=ee.setMeta(de,!0)),ee=ee.setMeta(be,{type:"enter",sectionId:_});try{let se=I.state.doc.nodeAt(q);if(se&&se.type?.name==="outlineSection"){let Ae=se.child(0),ge=q+1+Ae.nodeSize,xe=Math.min(ee.doc.content.size,ge+2);ee=ee.setSelection(b.create(ee.doc,xe))}}catch{}I.dispatch(ee.scrollIntoView());try{I.focus()}catch{}nt("beforeinput.enterEdit.done",{targetSectionId:_})}catch{}},0),x.preventDefault(),x.stopPropagation(),!0}}}catch{}return nt("beforeinput.deleteContentBackward.block",{inputType:z}),x.preventDefault(),x.stopPropagation(),!0}return z.startsWith("delete")?(nt("beforeinput.delete.block",{inputType:z}),x.preventDefault(),x.stopPropagation(),!0):(x.preventDefault(),x.stopPropagation(),gr(),!0)}catch{return!1}},dblclick(I,x){try{if(a.isPublicView||!be||(be.getState(I.state)||{}).editingSectionId||null)return!1;let z=x?.target&&x.target.closest&&x.target.closest('[data-outline-heading="true"]')||x?.target&&x.target.closest&&x.target.closest(".outline-heading"),$=x?.target&&x.target.closest&&x.target.closest('[data-outline-body="true"]')||x?.target&&x.target.closest&&x.target.closest(".outline-body");if(!z&&!$)return!1;let V={left:x.clientX,top:x.clientY},j=I.posAtCoords(V),F=j&&typeof j.pos=="number"?j.pos:null;if(typeof F!="number")return!1;let N=I.state.doc.resolve(Math.max(0,Math.min(I.state.doc.content.size,F))),C=Ht(I.state.doc,N);if(typeof C!="number")return!1;let E=I.state.doc.nodeAt(C),D=String(E?.attrs?.id||"");if(!D)return!1;window.setTimeout(()=>{try{if((be.getState(I.state)||{}).editingSectionId)return;let _=kt(I.state.doc,D),U=typeof _=="number"?I.state.doc.nodeAt(_):null,G=!!U?.attrs?.collapsed,q=I.state.tr;if(G&&typeof _=="number"&&U&&(q=q.setNodeMarkup(_,void 0,{...U.attrs,collapsed:!1}),q=q.setMeta(de,!0)),G){I.dispatch(q.scrollIntoView());try{I.focus()}catch{}return}q=q.setMeta(be,{type:"enter",sectionId:D});try{let{TextSelection:K}=ze?.pmStateMod||{},ee=typeof _=="number"?q.doc.nodeAt(_):null;if(ee&&ee.type?.name==="outlineSection"){let se=ee.child(0),Ae=_+1+se.nodeSize,ge=Math.min(q.doc.content.size,Ae+2);K&&(q=q.setSelection(K.near(q.doc.resolve(ge),1)))}}catch{}I.dispatch(q.scrollIntoView());try{I.focus()}catch{}}catch{}},0)}catch{}return!1}}},onCreate:({editor:I})=>{if(St&&a.articleId&&a.article&&!a.article.encrypted)try{let x=I.getJSON();a.article.docJson=x,cu(a.articleId,x).catch(()=>{})}catch{}try{Mb(I.state.doc)}catch{}yo.clear();try{Ko.clear()}catch{}bn=!1,Mp=null,Bn=null;try{sa=yp(I.state.doc),cr=!1;try{Jn.clear()}catch{Jn.clear()}rn&&(clearTimeout(rn),rn=null)}catch{}Cr("")},onUpdate:()=>{bn=!0;try{let I=be?.getState?.(re?.state)||null,x=String(I?.editingSectionId||"").trim();if(x){let L=re?.state?.doc||null;L&&fo(L,x)&&jy(re)}}catch{}try{let I=re?.state?.doc||null;if(I){let x=yp(I);x&&x!==sa&&(sa=x,Ky({articleId:Et||a.articleId,editor:re}))}}catch{}try{vp(re)}catch{}yn({delayMs:1500})},onSelectionUpdate:({editor:I})=>{let{state:x}=I,{selection:L}=x;if(!L)return;let M=Ht(x.doc,L.$from);if(typeof M!="number")return;let z=x.doc.nodeAt(M),$=String(z?.attrs?.id||"");if(!$)return;try{let F=(be?.getState?.(x)||null)?.editingSectionId||null;F&&F!==$&&I.view.dispatch(x.tr.setMeta(be,{type:"exit"}))}catch{}if(Bn&&Bn!==$){let j=fo(x.doc,Bn);try{en("leave_section",{from:Bn,to:$,changed:j})}catch{}try{Ko.has(Bn)&&Lp(I,x.doc,Bn)}catch{}j&&yn({delayMs:350})}let V=Bn;Bn=$;try{vp(I)}catch{}try{(be?.getState?.(x)||null)?.editingSectionId||vb(I,{lines:5})}catch{}}}),Wn&&Vo("new Editor()",{ms:Math.round(performance.now()-Wn)});try{let I=re?.state?.doc?.content?.size??null;jr("outline.mount.editorCreated",{outlineArticleId:Et,docSize:I})}catch{}try{(Et||a.articleId)&&(zy(Et||a.articleId),navigator.onLine&&_p(Et||a.articleId))}catch{}e.focus?.({preventScroll:!0}),fa=I=>{try{if(!re)return;let x=re.state.tr.setMeta(we,{activeKey:I||null});re.view.dispatch(x)}catch{}};try{Up()}catch{}try{let I=lo()?performance.now():0;ob(re),I&&Vo("convertMarkdownTablesInOutlineDoc()",{ms:Math.round(performance.now()-I)})}catch{}t&&Vo("mountOutlineEditor() total",{ms:Math.round(performance.now()-t)})})();try{await Li}finally{Li=null,jr("outline.mount.done",{outlineArticleId:Et,hasInstance:!!re})}}function _i(e=""){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}async function Db(e={}){if(a.isPublicView||!a.articleId||!a.article||!re)return;let t=Et||a.articleId;if(!t)return;let n=!!e.silent,r=e&&typeof e.mode=="string"?e.mode:"network",o=Array.from(new Set([...yo||[],Bn].filter(Boolean))),i=(s,c)=>{let l=s?String(s):"",d=c?String(c):"";return l?d?l>=d?l:d:l||null:d||null};try{if(n||Ft("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C outline\u2026"),a.article.encrypted){n||(bt(),P("Outline-\u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u0435 docJson \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0434\u043B\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0445 \u0441\u0442\u0430\u0442\u0435\u0439"));return}let s=re.getJSON(),c=Fy(s);if(a.articleId&&t!==a.articleId){await Pn(t,c,a.article?.updatedAt||null).catch(()=>{}),n||bt(),Cr("\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0447\u0435\u0440\u043D\u043E\u0432\u0438\u043A \u0441\u043E\u0445\u0440\u0430\u043D\u0451\u043D \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E");return}let l=Date.now();await Pn(t,c,a.article?.updatedAt||null).catch(()=>{});try{Bn&&fo(re.state.doc,Bn)}catch{}if(!0){let u=Jn.size?Array.from(Jn):[];try{u.length&&(Jn.clear(),await Gt("delete_sections",{articleId:t,payload:{sectionIds:u,clientQueuedAt:l},coalesceKey:`delete:${t}`}))}catch{}n||bt(),a.article&&(a.article.docJson=c),bn=!1,Mp=new Date,Cr("\u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E");try{Up()}catch{}try{Pb(re,re.state.doc,o)}catch{}return}}catch(s){n?Cr("\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F"):(bt(),P(s?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C outline"));try{let c=re.getJSON();c&&typeof c=="object"&&await Pn(t,c,a.article?.updatedAt||null).catch(()=>{})}catch{}yn({delayMs:5e3})}}function _b(){return Bn||null}function Ob(){try{if(!re||re.isDestroyed)return null;let e=re.state,t=Ht(e.doc,e.selection.$from);if(typeof t!="number")return null;let n=e.doc.nodeAt(t);if(!n||n.type?.name!=="outlineSection")return null;let r=String(n.attrs?.id||"").trim();return r?{sectionId:r,collapsed:!!n.attrs?.collapsed}:null}catch{return null}}function Rb(e,t){try{let n=String(t||"");if(!e||!n)return null;let r=(i,s,c)=>{if(!i||i.type?.name!=="outlineSection")return null;let l=String(i.attrs?.id||""),d=[...c,s];if(l===n)return d;let u=i.child(0),m=i.child(1),y=i.child(2);if(!y||y.type?.name!=="outlineChildren")return null;let g=s+1+u.nodeSize+m.nodeSize+1;for(let f=0;f<y.childCount;f+=1){let h=y.child(f),b=g;g+=h.nodeSize;let S=r(h,b,d);if(S)return S}return null},o=0;for(let i=0;i<e.childCount;i+=1){let s=e.child(i),c=o;o+=s.nodeSize;let l=r(s,c,[]);if(l)return l}return null}catch{return null}}function nm(e,t={}){try{if(!re||re.isDestroyed)return!1;let n=String(e||"");if(!n)return!1;let{state:r,view:o}=re,i=ze?.pmStateMod?.TextSelection,s=Rb(r.doc,n);if(!Array.isArray(s)||!s.length)return!1;let c=r.tr;for(let l of s){let d=c.doc.nodeAt(l);!d||d.type?.name!=="outlineSection"||d.attrs?.collapsed&&(c=c.setNodeMarkup(l,void 0,{...d.attrs,collapsed:!1}))}c=c.setMeta(de,!0);try{let l=kt(c.doc,n),d=typeof l=="number"?c.doc.nodeAt(l):null;if(typeof l=="number"&&d?.type?.name==="outlineSection"){let u=d.child(0),m=l+1+u.nodeSize,y=Math.min(c.doc.content.size,m+2);i&&(c=c.setSelection(i.create(c.doc,y)))}}catch{}o.dispatch(c.scrollIntoView());try{let l=typeof CSS<"u"&&CSS.escape?CSS.escape(n):n.replace(/"/g,'\\"');window.requestAnimationFrame(()=>{try{let d=o.dom?.querySelector?.(`[data-outline-section][data-section-id="${l}"]`)||o.dom?.querySelector?.(`[data-section-id="${l}"]`);d&&typeof d.scrollIntoView=="function"&&d.scrollIntoView({block:"center",inline:"nearest"})}catch{}})}catch{}if(t&&t.focus)try{o.focus()}catch{}return!0}catch{return!1}}function Hb(e,t){if(!re)return!1;let n=String(e||"");if(!n)return!1;let r=kt(re.state.doc,n);if(typeof r!="number")return!1;let o=re.state.doc.nodeAt(r);if(!o)return!1;let i=re.state.doc.type.schema,s=jn(String(t||"")),c=Ml(s.titleHtml||"")||Ml(s.bodyHtml||"").slice(0,80)||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",l=Oi?Oi(s.bodyHtml||""):[],d=[];for(let f of l||[])try{d.push(i.nodeFromJSON(f))}catch{}d.length||d.push(i.nodes.paragraph.create({},[]));let u=i.nodes.outlineHeading.create({},c?[i.text(c)]:[]),m=i.nodes.outlineBody.create({},d),y=o.child(2),w=i.nodes.outlineSection.create(o.attrs,[u,m,y]),g=re.state.tr.replaceWith(r,r+o.nodeSize,w);try{let f=ze?.pmStateMod?.TextSelection;f&&(g=g.setSelection(f.create(g.doc,r+2)))}catch{}return re.view.dispatch(g),re.view.focus(),bn=!0,yn({delayMs:200}),!0}function $b(e,t){if(!re)return!1;let n=String(e||"");if(!n)return!1;let r=kt(re.state.doc,n);if(typeof r!="number")return!1;let o=re.state.doc.nodeAt(r);if(!o)return!1;let i=t&&typeof t=="object"?t:{},s=re.state.doc.type.schema,c=null,l=null;try{i.heading&&typeof i.heading=="object"&&(c=s.nodeFromJSON(i.heading))}catch{c=null}try{i.body&&typeof i.body=="object"&&(l=s.nodeFromJSON(i.body))}catch{l=null}(!c||c.type?.name!=="outlineHeading")&&(c=s.nodes.outlineHeading.create({},[])),(!l||l.type?.name!=="outlineBody")&&(l=s.nodes.outlineBody.create({},[s.nodes.paragraph.create({},[])])),l.childCount||(l=s.nodes.outlineBody.create({},[s.nodes.paragraph.create({},[])]));let d=o.child(2),u=s.nodes.outlineSection.create(o.attrs,[c,l,d]),m=re.state.tr.replaceWith(r,r+o.nodeSize,u);try{let y=ze?.pmStateMod?.TextSelection;y&&(m=m.setSelection(y.create(m.doc,r+2)))}catch{}return re.view.dispatch(m),re.view.focus(),bn=!0,yn({delayMs:200}),!0}function Fb(e,t){if(!re)return!1;let n=String(e||"").trim();if(!n||typeof kt(re.state.doc,n)=="number")return!1;let o=t&&typeof t=="object"?t:{},i=re.state.doc.type.schema,s=null,c=null;try{o.heading&&typeof o.heading=="object"&&(s=i.nodeFromJSON(o.heading))}catch{s=null}try{o.body&&typeof o.body=="object"&&(c=i.nodeFromJSON(o.body))}catch{c=null}(!s||s.type?.name!=="outlineHeading")&&(s=i.nodes.outlineHeading.create({},[])),(!c||c.type?.name!=="outlineBody")&&(c=i.nodes.outlineBody.create({},[i.nodes.paragraph.create({},[])])),c.childCount||(c=i.nodes.outlineBody.create({},[i.nodes.paragraph.create({},[])]));let l=i.nodes.outlineChildren.create({},[]),d=i.nodes.outlineSection.create({id:n,collapsed:!1},[s,c,l]),u=re.state.doc.content.size,m=re.state.tr.insert(u,d);try{let y=ze?.pmStateMod?.TextSelection;if(y){let w=Math.min(m.doc.content.size,u+2);m=m.setSelection(y.near(m.doc.resolve(Math.max(0,w)),1))}}catch{}return m=m.setMeta(de,!0),re.view.dispatch(m.scrollIntoView()),re.view.focus(),bn=!0,yn({delayMs:200}),!0}function zb({enterEditMode:e=!0}={}){if(!re)return null;let t=re.state.doc.type.schema,n=re.state.doc.content.size,r=fn(),o=t.nodes.outlineSection.create({id:r,collapsed:!1},[t.nodes.outlineHeading.create({},[]),t.nodes.outlineBody.create({},[t.nodes.paragraph.create({},[])]),t.nodes.outlineChildren.create({},[])]),i=re.state.tr.insert(n,o);try{let s=ze?.pmStateMod?.TextSelection;if(s){let c=kt(i.doc,r),l=typeof c=="number"?ya(i.doc,c):null;typeof l=="number"?i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,l+2)),1)):i=i.setSelection(s.create(i.doc,n+2))}}catch{}return i=i.setMeta(de,!0),e&&be&&(i=i.setMeta(be,{type:"enter",sectionId:r})),re.view.dispatch(i.scrollIntoView()),re.view.focus(),bn=!0,yn({delayMs:200}),r}function ya(e,t){try{let n=e.nodeAt(t);if(!n||n.type?.name!=="outlineSection")return null;let r=n.child(0);return t+1+r.nodeSize}catch{return null}}function Ub(e,{focusBody:t=!0}={}){if(!re||!be)return!1;let n=String(e||"").trim();if(!n)return!1;let r=kt(re.state.doc,n);if(typeof r!="number"||re.state.doc.nodeAt(r)?.attrs?.collapsed)return!1;let i=re.state.tr;if(t)try{let s=ze?.pmStateMod?.TextSelection,c=ya(i.doc,r);s&&typeof c=="number"&&(i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,c+2)),1)))}catch{}return i=i.setMeta(de,!0),i=i.setMeta(be,{type:"enter",sectionId:n}),re.view.dispatch(i.scrollIntoView()),re.view.focus(),!0}function Vb({enterEditMode:e=!0}={}){if(!re)return null;let t=re.state.doc.type.schema,n=0,r=fn(),o=t.nodes.outlineSection.create({id:r,collapsed:!1},[t.nodes.outlineHeading.create({},[]),t.nodes.outlineBody.create({},[t.nodes.paragraph.create({},[])]),t.nodes.outlineChildren.create({},[])]),i=re.state.tr.insert(n,o);try{let s=ze?.pmStateMod?.TextSelection;if(s){let c=kt(i.doc,r),l=typeof c=="number"?ya(i.doc,c):null;typeof l=="number"?i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,l+2)),1)):i=i.setSelection(s.create(i.doc,n+2))}}catch{}return i=i.setMeta(de,!0),e&&be&&(i=i.setMeta(be,{type:"enter",sectionId:r})),re.view.dispatch(i.scrollIntoView()),re.view.focus(),bn=!0,yn({delayMs:200}),r}function qb(e,t,{enterEditMode:n=!1}={}){if(!re)return!1;let r=String(e||"").trim();if(!r||typeof kt(re.state.doc,r)=="number")return!1;let i=re.state.doc.type.schema,s=i.nodes.paragraph,c=i.nodes.hardBreak||i.nodes.hard_break||null,l=String(t||"").replace(/\r\n/g,`
`).trimEnd(),d=()=>{if(!s)return[];if(!l.trim())return[s.create({},[])];let h=l.split(/\n{2,}/),b=[];for(let S of h){let k=String(S||"").split(`
`),A=[];for(let v=0;v<k.length;v+=1){let B=k[v];v>0&&c&&A.push(c.create()),B&&A.push(i.text(B))}b.push(s.create({},A))}return b.length?b:[s.create({},[])]},u=i.nodes.outlineHeading.create({},[]),m=i.nodes.outlineBody.create({},d()),y=i.nodes.outlineChildren.create({},[]),w=i.nodes.outlineSection.create({id:r,collapsed:!1},[u,m,y]),g=0,f=re.state.tr.insert(g,w);try{let h=ze?.pmStateMod?.TextSelection;if(h){let b=kt(f.doc,r),S=typeof b=="number"?ya(f.doc,b):null;typeof S=="number"?f=f.setSelection(h.near(f.doc.resolve(Math.min(f.doc.content.size,S+2)),1)):f=f.setSelection(h.create(f.doc,g+2))}}catch{}return f=f.setMeta(de,!0),n&&be&&(f=f.setMeta(be,{type:"enter",sectionId:r})),re.view.dispatch(f.scrollIntoView()),re.view.focus(),bn=!0,yn({delayMs:200}),!0}async function Kb(){if(a.isPublicView||a.isRagView){P("Outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0432 \u044D\u0442\u043E\u043C \u0440\u0435\u0436\u0438\u043C\u0435");return}if(!a.articleId||!a.article){P("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}if(Et=a.articleId,jr("outline.open.start",{outlineArticleId:Et,updatedAt:a.article?.updatedAt||null,docHash:Qt(a.article?.docJson||null)}),!p.outlineEditor||!p.blocksContainer){P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440");return}a.isOutlineEditing=!0,p.articleToolbar&&p.articleToolbar.classList.add("hidden"),p.outlineToolbar&&p.outlineToolbar.classList.remove("hidden"),p.outlineTagsBar&&p.outlineTagsBar.classList.remove("hidden"),p.outlineEditor.classList.remove("hidden"),p.blocksContainer.classList.add("hidden"),Vp({loading:!0});try{ht("outline.open",{articleId:Et,updatedAt:a.article?.updatedAt||null,docHash:Qt(a.article?.docJson||null)})}catch{}try{if(!a.scrollTargetBlockId&&Et){let e=Eb(Et);e?.sectionId&&(a.currentBlockId=e.sectionId)}}catch{}try{await tm(),jr("outline.open.mounted",{outlineArticleId:Et,hasInstance:!!re});try{gb(re)}catch{}try{let t=a.scrollTargetBlockId||null;t&&(nm(t,{focus:!1}),a.scrollTargetBlockId=null,a.currentBlockId=t)}catch{}try{let t=a.currentBlockId||null;t&&(xb(re,t),kb(re,t,{block:"center"}))}catch{}let e=p.outlineEditor.querySelector(".outline-editor__loading");if(e&&e.classList.add("hidden"),Cr("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u0442\u0441\u044F \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438"),jr("outline.open.ready",{outlineArticleId:Et,currentBlockId:a.currentBlockId||null}),mp||(mp=!0,window.addEventListener("online",()=>{if(a.isOutlineEditing){try{_p(Et||a.articleId)}catch{}Di({force:!0})}}),window.addEventListener("blur",()=>{a.isOutlineEditing&&Di({force:!0})}),document.addEventListener("visibilitychange",()=>{a.isOutlineEditing&&document.visibilityState!=="visible"&&Di({force:!0})})),!Ni){let t=r=>{if(!a.isOutlineEditing)return;let o=r?.dataTransfer;if(!(o&&(o.files&&o.files.length||o.items&&o.items.length)))return;let s=r?.target;p.outlineEditor&&s&&p.outlineEditor.contains(s)||r.preventDefault()},n=r=>{if(!a.isOutlineEditing)return;let o=r?.dataTransfer;if(!(o&&o.files&&o.files.length))return;let s=r?.target;p.outlineEditor&&s&&p.outlineEditor.contains(s)||(r.preventDefault(),r.stopPropagation())};window.addEventListener("dragover",t,{passive:!1}),window.addEventListener("drop",n,{passive:!1}),Ni=()=>{window.removeEventListener("dragover",t),window.removeEventListener("drop",n),Ni=null}}}catch(e){P(e?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440"),rm()}}function rm(){jr("outline.close",{outlineArticleId:Et,hadInstance:!!re}),a.isOutlineEditing=!1,yb(),be=null,Et=null,Yr=null,fa=null,Br={counts:new Map,labelByKey:new Map,sectionIdsByKey:new Map,sectionPosById:new Map};try{p.outlineTagsBar&&(p.outlineTagsBar.innerHTML="",p.outlineTagsBar.classList.add("hidden"))}catch{}qo(!1),Ni&&Ni(),p.outlineToolbar&&p.outlineToolbar.classList.add("hidden"),p.articleToolbar&&p.articleToolbar.classList.remove("hidden"),yr&&(clearTimeout(yr),yr=null),rn&&(clearTimeout(rn),rn=null),uo&&(clearTimeout(uo),uo=null),Al=null,cr=!1,sa="";try{Jn.clear()}catch{}na=!1,yo.clear();try{Ko.clear()}catch{}go.clear(),Bn=null,bn=!1;try{for(let[,e]of Pi)try{clearTimeout(e)}catch{}Pi.clear()}catch{}try{for(let[,e]of ho)try{URL.revokeObjectURL(e)}catch{}ho.clear()}catch{}if(re){try{re.destroy()}catch{}re=null}ze=null,p.outlineEditor&&p.outlineEditor.classList.add("hidden"),p.blocksContainer&&p.blocksContainer.classList.remove("hidden")}async function jb(e={}){let t=e&&typeof e.mode=="string"?e.mode:"network",n=e&&typeof e.timeoutMs=="number"?Math.max(0,Math.floor(e.timeoutMs)):0;if(!re)return;yr&&(clearTimeout(yr),yr=null);try{let o=Et||a.articleId;if(o&&!a.article?.encrypted){let i=re.getJSON();if(i&&typeof i=="object")try{await Pn(o,i,a.article?.updatedAt||null)}catch{}try{try{let s=be?.getState?.(re?.state)||null,c=String(s?.editingSectionId||"").trim();c&&await _l({articleId:o,doc:re.state.doc,sectionId:c,reason:"pagehide"})}catch{}if(cr){let s=Ri(re.state.doc);s.length&&(Gt("structure_snapshot",{articleId:o,payload:{nodes:s},coalesceKey:`structure:${o}`}),cr=!1)}}catch{}try{if(Jn.size){let s=Array.from(Jn);Jn.clear();let c=Date.now();await Gt("delete_sections",{articleId:o,payload:{sectionIds:s,clientQueuedAt:c},coalesceKey:`delete:${o}:${c}`})}}catch{}}}catch{}if(t==="queue")return;let r=Di({force:!0,silent:!0});if(n>0){await Promise.race([r,new Promise(o=>setTimeout(o,n))]);return}await r}async function Jb({docJson:e}={}){if(p.outlineEditor){if(!e||typeof e!="object"){P("\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F: \u043D\u0435\u0442 \u0434\u043E\u043A\u0443\u043C\u0435\u043D\u0442\u0430");return}a.isPublicView=!0,a.isRagView=!1,a.isOutlineEditing=!1,a.articleId=null,a.article={docJson:e,encrypted:!1};try{p.outlineEditor.classList.add("outline-editor")}catch{}p.outlineEditor.classList.remove("hidden"),p.outlineEditor.querySelector("#outlineEditorContent")||Vp({loading:!0});try{await tm();let t=p.outlineEditor.querySelector(".outline-editor__loading");t&&t.classList.add("hidden"),Cr("\u0422\u043E\u043B\u044C\u043A\u043E \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440")}catch(t){P(t?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E")}}}var kl,ze,re,Li,yr,na,uo,Al,yl,Mp,Bn,ho,go,yo,Ko,bn,mp,Oi,Il,El,Ot,co,bl,Oy,Ho,$o,Zs,ra,be,Ni,Et,Yr,fa,Br,Tr,Gr,wl,Ry,ea,vl,la,Hy,Pi,gp,da,cr,sa,rn,Jn,Sl,de,bp,Jy,Wy,Yy,ta,Wb,Yb,nt,Mr=Ke(()=>{At();Vt();zt();vn();Qn();Xt();fi();ar();Hr();eo();Xa();Qf();qn();Xf();ep();ri();sl();kl=!1,ze=null,re=null,Li=null,yr=null,na=!1,uo=null,Al=null,yl=0,Mp=null,Bn=null,ho=new Map,go=new Map,yo=new Set,Ko=new Set,bn=!1,mp=!1,Oi=null,Il=null,El=null,Ot={TableMap:null,CellSelection:null,moveTableColumn:null,moveTableRow:null,addRowBefore:null,addRowAfter:null,deleteRow:null,addColumnBefore:null,addColumnAfter:null,deleteColumn:null,toggleHeaderRow:null,toggleHeaderColumn:null},co=!1,bl=new Map,Oy=30*1e3,Ho=new Map,$o=new Map,Zs=0,ra=null,be=null,Ni=null,Et=null,Yr=null,fa=null,Br={counts:new Map,labelByKey:new Map,sectionIdsByKey:new Map,sectionPosById:new Map},Tr=!1,Gr=new Set,wl={atMs:0,hash:null};Ry=650,ea={articleId:null,sectionId:null,collapsed:null},vl="ttree_outline_section_clipboard_v1",la="pending-attachment:",Hy=2e3,Pi=new Map;gp="ttree_outline_section_seq_v1",da=262144;cr=!1,sa="",rn=null,Jn=new Set,Sl=null;de="outlineAllowMutation",bp=0,Jy="ttree_outline_debug_md_table";Wy="ttree_profile_v1";Yy="ttree_outline_debug_proofread_v1";ta=null;Wb="ttree_debug_outline_keys_v1",Yb=()=>{try{return window?.localStorage?.getItem?.(Wb)==="1"}catch{return!1}},nt=(e,t={})=>{Yb()}});function Xb(){try{return window?.localStorage?.getItem?.(Gb)==="1"}catch{return!1}}function im(){try{return window?.localStorage?.getItem?.(Qb)==="1"}catch{return!1}}function Wo(...e){try{if(!Xb())return;console.log("[article-load]",...e)}catch{}}function Zb(e){try{let t=e?.content;if(!Array.isArray(t))return null;for(let n of t)if(n?.type==="outlineSection"){let r=String(n?.attrs?.id||"");if(r)return r}return null}catch{return null}}async function nn(e,t={}){let{desiredBlockId:n,resetUndoStacks:r,editBlockId:o}=t,i=a.articleId!==e;if(Wo("load.start",{id:e,switchingArticle:i,mode:a.mode,isOutlineEditing:a.isOutlineEditing}),i)try{let y=a.articleId,w=await Promise.resolve().then(()=>(Mr(),Lr));try{let g=w?.getOutlineActiveSectionSnapshot?.()||null;if(y&&g?.sectionId){let f=window?.localStorage?.getItem?.(om)||"{}",h=JSON.parse(f||"{}"),b=h&&typeof h=="object"?h:{};b[String(y)]={sectionId:g.sectionId,collapsed:!!g.collapsed,savedAt:new Date().toISOString()},window?.localStorage?.setItem?.(om,JSON.stringify(b))}}catch{}w?.flushOutlineAutosave&&await w.flushOutlineAutosave({mode:"queue"}),w?.closeOutlineEditor&&w.closeOutlineEditor()}catch{}a.articleId=e,a.isEditingTitle=!1,a.pendingTextPreview=null,a.article=null,a.currentBlockId=null;let s=performance.now(),c=await nu(e);im()&&console.log("[perf][article-load] fetchArticle",{id:e,ms:Math.round(performance.now()-s)}),Wo("load.fetched",{id:e,ms:Math.round(performance.now()-s),hasDocJson:!!c?.docJson,docContent:Array.isArray(c?.docJson?.content)?c.docJson.content.length:null,blocksCount:Array.isArray(c?.blocks)?c.blocks.length:null,updatedAt:c?.updatedAt});let l=c;try{l=await pf(c)}catch(y){throw P(y.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u0443\u044E \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443"),y}a.article=l,(typeof r=="boolean"?r:i)&&jf(l);let u=n||o||a.pendingEditBlockId||null;a.pendingEditBlockId=null;let m=Zb(l.docJson)||l.blocks?.[0]?.id||null;if(a.currentBlockId=u||m,a.mode="view",a.editingBlockId=null,Xn(l),sd(),!a.isPublicView&&!a.isRagView&&!l.encrypted)try{let y=await Promise.resolve().then(()=>(Mr(),Lr));if(y?.openOutlineEditor){Wo("outline.open.start",{id:e});let w=im()?performance.now():0;y.openOutlineEditor(),w&&console.log("[perf][article-load] outline.open scheduled",{id:e,ms:Math.round(performance.now()-w)}),Wo("outline.open.scheduled",{id:e,isOutlineEditing:a.isOutlineEditing})}}catch(y){a.isOutlineEditing=!1,Wo("outline.open.failed",{id:e,message:y?.message||String(y||"error")}),P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C outline-\u0440\u0435\u0436\u0438\u043C (\u0441\u043C. \u043A\u043E\u043D\u0441\u043E\u043B\u044C)")}return Wo("load.done",{id:e,currentBlockId:a.currentBlockId}),l}var Gb,Qb,om,Rl=Ke(()=>{At();Xt();ar();zt();En();Dc();Zo();Gb="ttree_debug_article_load_v1",Qb="ttree_profile_v1",om="ttree_outline_last_active_v1"});function dm(){if(!Wt||!$i()||Wt.pointerType==="mouse")return;let e=window.getSelection?window.getSelection():null;if(!(!e||e.isCollapsed))try{e.removeAllRanges()}catch{}}function ow(){ba||(document.addEventListener("selectionchange",dm),ba=!0)}function iw(){ba&&(document.removeEventListener("selectionchange",dm),ba=!1)}function $i(){return!!(a.isDragModeEnabled&&a.mode==="view"&&a.articleId!=="inbox")}function um(e){return e instanceof Element?!!e.closest(rw):!1}function Hl(){if(Wt){window.removeEventListener("pointermove",gm),window.removeEventListener("pointerup",wa),window.removeEventListener("pointercancel",wa);try{Wt.sourceEl?.releasePointerCapture?.(Wt.pointerId)}catch{}Wt=null,iw(),cw()}}function sw(e,t,n,{bypassInteractiveCheck:r=!1}={}){if(!a.article||!a.isDragModeEnabled||!$i()||e.pointerType==="mouse"&&e.button!==0||!r&&um(e.target))return;let o=Qe(t);if(o){Wt={pointerType:e.pointerType||"mouse",blockId:t,pointerId:e.pointerId,originParentId:o.parent?.id||null,originIndex:o.index??0,startX:e.clientX,startY:e.clientY,dragging:!1,forbidden:pm(o.block),lastDrop:null,sourceEl:n};try{n?.setPointerCapture?.(e.pointerId)}catch{}window.addEventListener("pointermove",gm),window.addEventListener("pointerup",wa),window.addEventListener("pointercancel",wa),ow()}}function fm(e,t,{allowInteractive:n=!1}={}){e&&e.addEventListener("pointerdown",r=>{if(!n&&um(r.target))return;(r.pointerType==="touch"||r.pointerType==="pen")&&$i()&&r.preventDefault(),sw(r,t,e,{bypassInteractiveCheck:n})})}function Qr(){let e=!!a.article,t=p.dragModeToggleBtn;if(t){t.disabled=!e,t.classList.toggle("active",!!a.isDragModeEnabled),t.setAttribute("aria-pressed",a.isDragModeEnabled?"true":"false");let o=a.isDragModeEnabled?"\u041F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435 \u0431\u043B\u043E\u043A \u0437\u0430 \u0435\u0433\u043E \u043F\u043E\u0432\u0435\u0440\u0445\u043D\u043E\u0441\u0442\u044C":"\u0412\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0440\u0435\u0436\u0438\u043C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u044F \u0431\u043B\u043E\u043A\u043E\u0432";e?a.articleId==="inbox"?o="\u041F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0432 \u0431\u044B\u0441\u0442\u0440\u044B\u0445 \u0437\u0430\u043C\u0435\u0442\u043A\u0430\u0445":a.mode!=="view"&&(o="\u041F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043C\u043E\u0436\u043D\u043E \u0442\u043E\u043B\u044C\u043A\u043E \u0432 \u0440\u0435\u0436\u0438\u043C\u0435 \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440\u0430"):o="\u041E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E, \u0447\u0442\u043E\u0431\u044B \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0442\u044C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435\u043C",t.title=o}let n=$i();[p.articleView,p.blocksContainer].forEach(o=>{o&&o.classList.toggle("drag-mode-enabled",n)}),document.body.classList.toggle("drag-mode-enabled",n)}function pm(e,t=new Set){return e&&(t.add(e.id),(e.children||[]).forEach(n=>pm(n,t))),t}function aw(){if(Hi)return Hi;let e=document.createElement("div");return e.className="block-drop-line hidden",document.body.appendChild(e),Hi=e,e}function cw(){Hi&&Hi.classList.add("hidden"),Ln&&(Ln.classList.remove("drop-inside-target"),Ln=null),bo&&(bo.remove(),bo=null),document.body.classList.remove("block-dnd-active")}function lw(e){bo&&(bo.style.left=`${e.clientX+12}px`,bo.style.top=`${e.clientY+12}px`)}function dw(e){let t=document.createElement("div");t.className="block-drag-preview";let n=p.blocksContainer?.querySelector(`.block[data-block-id="${e}"]`),r=n?.querySelector(".block-title")?.textContent?.trim(),o=n?.querySelector(".block-text")?.textContent?.trim();t.textContent=r||o||"\u0411\u043B\u043E\u043A",document.body.appendChild(t),bo=t}function mm(){return Zn&&Zn.isConnected?(p.blocksContainer&&Zn.parentNode!==p.blocksContainer&&p.blocksContainer.appendChild(Zn),Zn):(Zn=document.createElement("div"),Zn.className="drag-layer",p.blocksContainer&&(p.blocksContainer.appendChild(Zn),sm||(p.blocksContainer.addEventListener("scroll",am,{passive:!0}),window.addEventListener("resize",am,{passive:!0}),sm=!0)),Zn)}function hm(){lm.clear(),Zn&&(Zn.innerHTML="")}function am(){let e=p.blocksContainer;if(!e||!Zn)return;let t=e.getBoundingClientRect(),n=e.scrollTop;lm.forEach(({handle:r,blockEl:o})=>{let i=o.getBoundingClientRect(),s=o.querySelector(".block-header__left"),c=o.querySelector(".block-header"),l=o.querySelector(".collapse-btn"),d=s?.getBoundingClientRect(),u=c?.getBoundingClientRect(),m=l?.getBoundingClientRect(),y=(d&&d.height>0?d:null)||(u&&u.height>0?u:null)||(m&&m.height>0?m:null)||i,w=y.top-t.top+n+y.height/2;r.style.top=`${w}px`,r.style.right="8px"})}function uw(e){let t=aw();if(!e){t.classList.add("hidden"),Ln&&(Ln.classList.remove("drop-inside-target"),Ln=null);return}if(e.placement==="inside"){t.classList.add("hidden"),Ln&&Ln.dataset.blockId!==e.targetId&&Ln.classList.remove("drop-inside-target"),Ln=p.blocksContainer?.querySelector(`.block[data-block-id="${e.targetId}"]`)||null,Ln&&Ln.classList.add("drop-inside-target");return}Ln&&(Ln.classList.remove("drop-inside-target"),Ln=null),t.classList.remove("hidden");let n=e.placement==="before"?e.rect.top:e.rect.top+e.rect.height,r=Math.min(e.depth*cm,e.rect.width-32),o=e.rect.left+r,i=Math.max(e.rect.width-r,48);t.style.top=`${n}px`,t.style.left=`${o}px`,t.style.width=`${i}px`}function fw(e,t){if(!p.blocksContainer||!Wt)return null;let r=Array.from(p.blocksContainer.querySelectorAll(".block")).filter(k=>{let A=k.dataset.blockId;return A&&!Wt.forbidden.has(A)});if(!r.length)return null;let o=null,i=1/0;if(r.forEach(k=>{let A=k.getBoundingClientRect(),v=A.top+A.height/2,B=Math.abs(t-v);B<i&&(i=B,o=k)}),!o)return null;let s=o.getBoundingClientRect(),c=s.height>0?(t-s.top)/s.height:.5,l=c<tw?"before":c>nw?"after":"inside",d=o.dataset.blockId,u=Qe(d);if(!u)return null;let m=(u.ancestors||[]).length,y=l==="inside"?d:u.parent?.id||null;if(Wt.forbidden.has(y||""))return null;let w=d,g=y,f=l,h=s,b=l==="inside"?m+1:m,S=f==="after"?u.index+1:u.index;if(f!=="inside"&&u.parent){let k=u,A=s,v=s.left+cm;for(;k.parent;){let B=e<=v,H=t<=A.top||t>=A.bottom;if(!B&&!H)break;let O=Qe(k.parent.id);if(!O)break;let J=p.blocksContainer?.querySelector(`.block[data-block-id="${O.block.id}"]`)?.getBoundingClientRect();k=O,A=J||A,w=k.block.id,h=A,b=(k.ancestors||[]).length,g=k.parent?.id||null,S=f==="after"?k.index+1:k.index}}return{targetId:w,placement:f,parentId:g,index:S,depth:b,rect:h}}function pw(e){if(!p.blocksContainer)return;let t=p.blocksContainer.getBoundingClientRect(),n=60;e.clientY<t.top+n?p.blocksContainer.scrollTop-=12:e.clientY>t.bottom-n&&(p.blocksContainer.scrollTop+=12)}function gm(e){if(!Wt||e.pointerId!==Wt.pointerId)return;if(!$i()){Hl();return}let t=e.clientX-Wt.startX,n=e.clientY-Wt.startY;if(!Wt.dragging){if(Math.hypot(t,n)<ew)return;Wt.dragging=!0;let o=Wt.pointerType||e.pointerType||"mouse";(o==="touch"||o==="pen")&&document.body.classList.add("block-dnd-active"),dw(Wt.blockId)}e.preventDefault(),lw(e);let r=fw(e.clientX,e.clientY);Wt.lastDrop=r,uw(r),pw(e)}async function wa(e){if(!Wt||e.pointerId!==Wt.pointerId)return;let t=Wt;Hl();let n=t.dragging&&t.lastDrop,r=t.lastDrop,o=t.blockId;!n||!r||await Vs(o,r.parentId||null,r.index,{anchorId:r.targetId,placement:r.placement})}function Sa(){if(!a.article){P("\u041E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E, \u0447\u0442\u043E\u0431\u044B \u043F\u0435\u0440\u0435\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435");return}if(a.isDragModeEnabled=!a.isDragModeEnabled,!a.isDragModeEnabled){Hl(),Qr(),P("\u041F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435 \u0432\u044B\u043A\u043B\u044E\u0447\u0435\u043D\u043E");return}if(Qr(),a.articleId==="inbox"){P("\u0420\u0435\u0436\u0438\u043C \u0432\u043A\u043B\u044E\u0447\u0451\u043D, \u043D\u043E \u0432 \u0431\u044B\u0441\u0442\u0440\u044B\u0445 \u0437\u0430\u043C\u0435\u0442\u043A\u0430\u0445 \u043F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E");return}if(a.mode!=="view"){P("\u0420\u0435\u0436\u0438\u043C \u0432\u043A\u043B\u044E\u0447\u0451\u043D, \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u0442\u0435 \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435, \u0447\u0442\u043E\u0431\u044B \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u0442\u044C \u0431\u043B\u043E\u043A\u0438");return}P("\u041F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435 \u0432\u043A\u043B\u044E\u0447\u0435\u043D\u043E \u2014 \u043F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435 \u0431\u043B\u043E\u043A \u0437\u0430 \u0435\u0433\u043E \u043F\u043E\u0432\u0435\u0440\u0445\u043D\u043E\u0441\u0442\u044C")}var ew,cm,tw,nw,rw,Wt,Hi,Ln,bo,Zn,lm,sm,ba,Fi=Ke(()=>{At();Vt();vn();ar();zt();ew=6,cm=20,tw=.35,nw=.65,rw='button, a, input, textarea, select, [contenteditable="true"], .block-edit-actions, .move-block-btn, .collapse-btn',Wt=null,Hi=null,Ln=null,bo=null,Zn=null,lm=new Map,sm=!1,ba=!1});function ym(e){Fl=typeof e=="function"?e:null}function mw(e){let t=new Set,n=r=>{if(Array.isArray(r))for(let o=0;o<r.length;o+=1){let i=r[o];if(!i||!i.id){r.splice(o,1),o-=1;continue}if(t.has(i.id)){r.splice(o,1),o-=1;continue}t.add(i.id),Array.isArray(i.children)&&i.children.length&&n(i.children)}};n(e)}function bm(){if(!p.blocksContainer)return;let e=new Set;p.blocksContainer.querySelectorAll(".block[data-block-id]").forEach(n=>{let r=n.getAttribute("data-block-id");if(r)if(e.has(r)){let o=n.parentNode;o&&o.removeChild(n)}else e.add(r)})}function wm(){if(!p.blocksContainer||!a.article||!Array.isArray(a.article.blocks))return;let e=On(a.article.blocks),t=new Set(e.map(r=>r.id));p.blocksContainer.querySelectorAll(".block[data-block-id]").forEach(r=>{let o=r.getAttribute("data-block-id");if(o&&!t.has(o)){let i=r.parentNode;i&&i.removeChild(r)}})}function Si(e,t,n,r){if(!a.article||!e||!e.id)return;let o=Array.isArray(a.article.blockTrash)?a.article.blockTrash:[],i=r||new Date().toISOString();o.push({id:e.id,block:e,parentId:t||null,index:typeof n=="number"?n:null,deletedAt:i}),a.article.blockTrash=o}function Lo(e){if(!e||!p.blocksContainer)return;p.blocksContainer.querySelectorAll(`.block[data-block-id="${e}"]`).forEach(n=>{let r=n.parentElement;if(!r)return;let o=n.nextElementSibling;if(o&&o.classList.contains("block-children")){let i=o;o=o.nextElementSibling,i.parentNode===r&&r.removeChild(i)}n.parentNode===r&&r.removeChild(n)})}async function zl(e,t,n=1){for(let r of e){let o=document.createElement("div");o.className="block",o.dataset.blockId=r.id,typeof r.collapsed=="boolean"&&(o.dataset.collapsed=r.collapsed?"true":"false"),(r.id===a.currentBlockId||Array.isArray(a.selectedBlockIds)&&a.selectedBlockIds.includes(r.id))&&o.classList.add("selected"),r.id===a.editingBlockId&&o.classList.add("editing");let s=document.createElement("div");s.className="block-surface";let c=document.createElement("div");c.className="block-content";let l=jn(r.text||""),d=!!l.titleHtml,u=!!(l.bodyHtml&&l.bodyHtml.trim()),m=!!r.children?.length;if(!d&&m){let v=document.createElement("div");v.innerHTML=l.bodyHtml||r.text||"";let B=Array.from(v.childNodes||[]).filter(H=>H.nodeType===Node.TEXT_NODE?(H.textContent||"").trim().length>0:H.nodeType===Node.ELEMENT_NODE?H.tagName==="BR"?!1:H.tagName==="P"?(H.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim().length>0:!0:!1);if(B.length===1){let H=B[0];H.nodeType===Node.ELEMENT_NODE&&H.tagName==="P"&&(l={titleHtml:H.outerHTML,bodyHtml:""},d=!0,u=!1)}}let y=d||m,w=!d&&!m;o.classList.toggle("block--no-title",!d);let g=a.mode==="edit"&&a.editingBlockId===r.id,f=null;if(y||w){let v=document.createElement("button");v.className="collapse-btn",w?(v.classList.add("collapse-btn--placeholder"),v.setAttribute("aria-hidden","true"),v.removeAttribute("aria-expanded"),v.removeAttribute("title")):(v.setAttribute("aria-expanded",r.collapsed?"false":"true"),v.title=r.collapsed?"\u0420\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C":"\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C"),f=document.createElement("div"),f.className="block-header",d||f.classList.add("block-header--no-title");let B=document.createElement("div");if(B.className="block-header__left",B.appendChild(v),d){let H=Math.min(Math.max(n,1),6),O=document.createElement(`h${H}`);O.className="block-title",O.innerHTML=l.titleHtml||"",B.appendChild(O)}else{let H=document.createElement("div");H.className="block-title-spacer",H.style.flex="1",H.style.minWidth="0",B.appendChild(H)}f.appendChild(B)}let h=document.createElement("div");h.className="block-text block-body";let b=g?jc(r.text||""):l.bodyHtml||"";if(h.innerHTML=b,(!b||!b.trim())&&(h.classList.add("block-body--empty"),g&&(h.innerHTML="<p><br /></p>")),h.classList.toggle("block-body--no-title",!d),g?(h.setAttribute("contenteditable","true"),h.setAttribute("spellcheck","false"),h.dataset.placeholder="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0442\u0435\u043A\u0441\u0442"):h.removeAttribute("contenteditable"),f&&c.appendChild(f),(g||!d||b)&&c.appendChild(h),a.articleId==="inbox"&&!g){let v=document.createElement("div");v.className="block-footer";let B=document.createElement("button");B.type="button",B.className="ghost small move-block-btn",B.innerHTML='<i class="bx bx-transfer-alt" aria-hidden="true"></i>',B.title="\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0431\u043B\u043E\u043A \u0432 \u0434\u0440\u0443\u0433\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E",B.addEventListener("click",H=>{H.stopPropagation(),Fl?Fl(r.id):P("\u041F\u0435\u0440\u0435\u043D\u043E\u0441 \u0431\u043B\u043E\u043A\u0430 \u0432\u0440\u0435\u043C\u0435\u043D\u043D\u043E \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D")}),v.appendChild(B),c.appendChild(v)}if(s.appendChild(c),g&&("ontouchstart"in window||navigator.maxTouchPoints>0)&&c.addEventListener("click",B=>{let H=c.querySelector('.block-text[contenteditable="true"]');H&&(H.contains(B.target)||(B.stopPropagation(),H.focus(),a.editingCaretPosition==="start"?(H.scrollTop=0,sc(H)):fs(H)))}),fm(s,r.id),g){let v=document.createElement("div");v.className="block-edit-actions";let B=document.createElement("button");B.type="button",B.className="ghost small block-attach-btn",B.innerHTML='<i class="bx bx-paperclip block-attach-btn__icon" aria-hidden="true"></i><span class="block-attach-btn__label">\u0424\u0430\u0439\u043B</span>',B.title="\u041F\u0440\u0438\u043A\u0440\u0435\u043F\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u0438\u043B\u0438 \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0443",B.addEventListener("click",W=>{W.preventDefault(),W.stopPropagation();let J=o.querySelector('.block-text[contenteditable="true"]');if(!J)return;let ne=document.createElement("input");ne.type="file",ne.multiple=!0,ne.style.display="none",ne.addEventListener("change",()=>{let me=Array.from(ne.files||[]);me.length&&Wc(J,me,r.id),ne.remove()}),document.body.appendChild(ne),ne.click()});let H=document.createElement("button");H.type="button",H.className="ghost small",H.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C",H.addEventListener("click",async W=>{W.preventDefault(),W.stopPropagation(),await bi()});let O=document.createElement("button");O.type="button",O.className="ghost small",O.textContent="\u041E\u0442\u043C\u0435\u043D\u0430",O.addEventListener("click",W=>{W.preventDefault(),W.stopPropagation(),Ns()}),v.appendChild(B),v.appendChild(H),v.appendChild(O),c.appendChild(v)}Yc(h,r.id),o.appendChild(s),o.addEventListener("click",v=>{if(v.stopPropagation(),a.isRagView&&a.ragBlockMap&&a.ragBlockMap[r.id]){let Je=a.ragBlockMap[r.id];if(Je&&Je.articleId&&Je.blockId){a.scrollTargetBlockId=Je.blockId,a.currentBlockId=Je.blockId,It(wt.article(Je.articleId));return}}let B=v.target.closest('button, a, [contenteditable="true"], .block-edit-actions'),H=o.querySelector(".block-header"),O=o.querySelector(".block-text.block-body"),W=!!H,J=!!(H&&!H.classList.contains("block-header--no-title")),ne=W&&H.contains(v.target),me=O&&O.contains(v.target),we=J,te=a.currentBlockId===r.id,he=!1;(we&&ne||!we&&te&&me&&!B)&&(he=!0),he&&Jc(r.id),Kn(r.id)}),s.addEventListener("dblclick",v=>{if(a.mode!=="view"||a.isPublicView||a.isRagView)return;let B=v.target.closest('button, a, [contenteditable="true"]');B&&!B.matches('.block-text[contenteditable="true"]')||(v.stopPropagation(),Kn(r.id),Ms())});let k=r.collapsed&&r.id!==a.editingBlockId&&d;h.classList.contains("block-body--empty")||h.classList.toggle("collapsed",k);let A=null;r.children?.length>0&&!r.collapsed&&(A=document.createElement("div"),A.className="block-children",await zl(r.children,A,n+1)),t.appendChild(o),A&&(g?t.appendChild(A):o.appendChild(A))}}function qs(e,t){if(!e||!["up","down"].includes(t))return!1;let n=document.querySelector(`.block[data-block-id="${e}"]`);if(!n||n.classList.contains("editing"))return!1;let r=n.parentElement;if(!r)return!1;if(t==="up"){let s=n.previousElementSibling;for(;s&&!s.classList.contains("block");)s=s.previousElementSibling;return s?(r.insertBefore(n,s),!0):!1}let o=n.nextElementSibling;for(;o&&!o.classList.contains("block");)o=o.nextElementSibling;if(!o)return!1;let i=o.nextSibling;return i?r.insertBefore(n,i):r.appendChild(n),!0}async function Lt(e){if(!a.article||!Array.isArray(a.article.blocks))return;let t=Qe(e);if(!t)return;let n=(Array.isArray(t.ancestors)?t.ancestors.length:0)+1,r=document.querySelector(`.block[data-block-id="${e}"]`);if(!r)return;let o=r.parentElement;if(!o)return;let i=[],s=r.nextElementSibling;s&&s.classList.contains("block-children")&&i.push(s);let c=(i[i.length-1]||r).nextSibling;o.removeChild(r),i.forEach(u=>{u.parentNode===o&&o.removeChild(u)});let l=document.createElement("div");await zl([t.block],l,n),Array.from(l.childNodes).forEach(u=>{o.insertBefore(u,c)}),bm(),wm()}function st(e=null){let t=a.article;if(!t)return;try{let o=!(!a.isPublicView&&!a.isRagView&&a.isOutlineEditing),i=Ws(new Error),s=Date.now();if(!($l.hash===i.hash&&s-$l.atMs<400)){$l={atMs:s,hash:i.hash};let l=Array.isArray(t.blocks)?t.blocks.length:null,d=null;try{d=o?p.blocksContainer?.querySelectorAll?.(".block[data-block-id]")?.length??null:null}catch{d=null}Js("ui.renderArticle",{articleId:a.articleId||null,mode:a.mode,isOutlineEditing:!!a.isOutlineEditing,willFullRender:o,currentBlockId:a.currentBlockId||null,editingBlockId:a.editingBlockId||null,blocksCount:l,domBlocksCount:d,trace:e?String(e).slice(0,120):null,stackHash:i.hash,stackTop:i.top})}}catch{}if(!a.isPublicView&&!a.isRagView&&a.isOutlineEditing){Pt(),$n();return}Array.isArray(t.blocks)&&mw(t.blocks),Pt();let n=t.id==="inbox"?[...t.blocks||[]].reverse():t.blocks;$n(),p.blocksContainer.innerHTML="",Qr(),hm(),mm();let r=()=>{if(a.mode!=="edit"||!a.editingBlockId||a.editingCaretPosition==="start")return;let o=p.blocksContainer?.querySelector(`.block[data-block-id="${a.editingBlockId}"] .block-text[contenteditable="true"]`);if(!o)return;let i=document.activeElement;o===i||o.contains(i)||(o.focus({preventScroll:!0}),o.scrollHeight>o.clientHeight&&(o.scrollTop=o.scrollHeight),fs(o))};zl(n,p.blocksContainer).then(()=>{if(wm(),bm(),Uf(),a.scrollTargetBlockId&&a.mode==="view"){let o=a.scrollTargetBlockId;requestAnimationFrame(()=>{let i=document.querySelector(`.block[data-block-id="${o}"]`);if(i){(i.querySelector(".block-content")||i).scrollIntoView({behavior:"smooth",block:"nearest"});let c=i.querySelector('.block-text[contenteditable="true"]');c&&a.mode==="edit"&&a.editingBlockId===o?(c.focus({preventScroll:!0}),a.editingCaretPosition==="start"?(c.scrollTop=0,sc(c)):fs(c)):(i.setAttribute("tabindex","-1"),i.focus({preventScroll:!0}))}a.currentBlockId=o,a.scrollTargetBlockId=null})}r(),a.mode==="edit"&&typeof a.editingScrollTop=="number"&&p.blocksContainer&&(p.blocksContainer.scrollTop=a.editingScrollTop)})}var Fl,$l,Ul=Ke(()=>{At();Vt();Xt();zt();Qn();Bo();Un();vn();vn();En();ar();qn();Zo();Fi();sl();Fl=null;$l={atMs:0,hash:null}});async function hw(e){try{let n=(a.articlesIndex.length?a.articlesIndex:await zn()).filter(u=>u.id!=="inbox"),r=n.map(u=>({id:u.id,title:u.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),o=await xn({title:"\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0432 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0438\u043B\u0438 \u0432\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E",confirmText:"\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:r,returnMeta:!0,hideConfirm:!1}),s=(o?.selectedId||(typeof o=="object"?o?.value:o)||""||"").trim();if(!s)return;let c=s.toLowerCase(),l=n.find(u=>u.id&&u.id.toLowerCase()===c||(u.title||"").toLowerCase()===c),d=l?l.id:s;if(!d||d==="inbox"){P("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}await apiRequest(`/api/articles/${a.articleId}/blocks/${e}/move-to/${d}`,{method:"POST"}),await nn("inbox",{resetUndoStacks:!0}),st("views.moveBlockFromInbox.reloadInbox"),P("\u0411\u043B\u043E\u043A \u043F\u0435\u0440\u0435\u043D\u0435\u0441\u0451\u043D")}catch(t){P(t.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0431\u043B\u043E\u043A")}}async function xa(){if(a.isMergingBlocks)return;if(!a.article||!Array.isArray(a.article.blocks)||!a.article.blocks.length){P("\u041D\u0435\u0442 \u0431\u043B\u043E\u043A\u043E\u0432 \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u044F");return}let e=Array.isArray(a.selectedBlockIds)?a.selectedBlockIds:[];if(!e.length){P("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A\u0438 (Shift+\u2191/\u2193), \u043A\u043E\u0442\u043E\u0440\u044B\u0435 \u043D\u0443\u0436\u043D\u043E \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0438\u0442\u044C");return}let n=On(a.article.blocks).filter(d=>e.includes(d.id));if(n.length<2){P("\u0414\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u044F \u043D\u0443\u0436\u043D\u043E \u0432\u044B\u0431\u0440\u0430\u0442\u044C \u043A\u0430\u043A \u043C\u0438\u043D\u0438\u043C\u0443\u043C \u0434\u0432\u0430 \u0431\u043B\u043E\u043A\u0430");return}let r=n[0],o=n.slice(1),i=new Set(o.map(d=>d.id)),s=o.filter(d=>{let u=Qe(d.id,a.article?.blocks||[]);return u?!u.ancestors?.some(m=>i.has(m.id)):!1}),c=[];r.text&&c.push(r.text),o.forEach(d=>{d.text&&c.push(d.text)});let l=c.join("");a.isMergingBlocks=!0,p.mergeBlocksBtn&&(p.mergeBlocksBtn.disabled=!0),P("\u041E\u0431\u044A\u0435\u0434\u0438\u043D\u044F\u0435\u043C \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u044B\u0435 \u0431\u043B\u043E\u043A\u0438...");try{await apiRequest(`/api/articles/${a.articleId}/blocks/${r.id}`,{method:"PATCH",body:JSON.stringify({text:l})});for(let d of s)await apiRequest(`/api/articles/${a.articleId}/blocks/${d.id}`,{method:"DELETE"});await nn(a.articleId,{resetUndoStacks:!1}),st("views.mergeAllBlocksIntoFirst.reloadAfterMerge"),a.mode="view",a.editingBlockId=null,a.pendingEditBlockId=null,Kn(r.id),P("\u0411\u043B\u043E\u043A\u0438 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0435\u043D\u044B \u0432 \u043E\u0434\u0438\u043D")}catch(d){P(d.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438")}finally{a.isMergingBlocks=!1,p.mergeBlocksBtn&&(p.mergeBlocksBtn.disabled=!1)}}async function zi(e){try{String(e||"").startsWith("inbox-")&&(e="inbox")}catch{}a.isPublicView=!1,a.isRagView=!1,document.body.classList.remove("public-embedded"),a.isEditingTitle=!1,await Ir(),hi(!0),p.usersView&&p.usersView.classList.add("hidden"),p.blocksContainer.innerHTML="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...";try{if(e==="RAG"){a.isRagView=!0,a.mode="view",a.editingBlockId=null,a.pendingEditBlockId=null,a.scrollTargetBlockId=null,a.ragBlockMap={},Ts("RAG");let r=(a.ragQuery||"").trim(),o=Array.isArray(a.ragResults)?a.ragResults:[],i=o.length,s=Array.from(new Set(o.map(m=>m&&m.articleTitle?String(m.articleTitle):"").filter(Boolean))),c=s.slice(0,8),l=["<p><strong>\u0421\u0432\u043E\u0434\u043A\u0430</strong></p>"];a.ragSummaryLoading?l.push('<p class="meta">\u0413\u0435\u043D\u0435\u0440\u0438\u0440\u0443\u044E \u0441\u0432\u043E\u0434\u043A\u0443\u2026</p>'):a.ragSummaryError?l.push(`<p class="meta">\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0432\u043E\u0434\u043A\u0438: ${a.ragSummaryError}</p>`):a.ragSummaryHtml?l.push(a.ragSummaryHtml):l.push('<p class="meta">\u0421\u0432\u043E\u0434\u043A\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435 \u0433\u043E\u0442\u043E\u0432\u0430.</p>');let d=["<p><strong>AI-\u043F\u043E\u0438\u0441\u043A: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B</strong></p>",`<p><span class="meta">\u0417\u0430\u043F\u0440\u043E\u0441:</span> ${r||"\u2014"}</p>`,`<p><span class="meta">\u041D\u0430\u0439\u0434\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432:</span> ${i}</p>`];c.length&&d.push(`<p><span class="meta">\u0421\u0442\u0430\u0442\u044C\u0438:</span> ${c.join(" \xB7 ")}</p>`),s.length>c.length&&d.push(`<p><span class="meta">\u2026\u0438 \u0435\u0449\u0451:</span> ${s.length-c.length}</p>`);let u=[{id:"rag-ai-summary",text:l.join(""),children:[],collapsed:!1},{id:"rag-meta",text:d.join(""),children:[],collapsed:!1},...o.filter(m=>m&&m.type==="block").map((m,y)=>{let w=m.blockText||"",g=m.articleTitle?String(m.articleTitle):"",f=g?`<p><strong>${g}</strong></p>`:`<p><strong>\u0420\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442 ${y+1}</strong></p>`,h=`rag-${m.blockId||y}`;return m.articleId&&m.blockId&&(a.ragBlockMap[h]={articleId:m.articleId,blockId:m.blockId}),{id:h,text:`${f}${w}`,children:[],collapsed:!1}})];a.article={id:"RAG",title:r?`AI: ${r}`:"AI: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B \u043F\u043E\u0438\u0441\u043A\u0430",blocks:u,updated_at:new Date().toISOString()},a.articleId="RAG",a.currentBlockId=u[0]?.id||null,st("views.loadArticleView.rag.render");return}let t=a.pendingEditBlockId||void 0,n=a.scrollTargetBlockId||void 0;if(await nn(e,{resetUndoStacks:!0,desiredBlockId:n,editBlockId:t}),st("views.loadArticleView.afterLoadArticle"),Ts(e),e==="inbox"&&navigator.onLine&&a.serverStatus==="ok")try{await ll().catch(()=>{}),a.articleId==="inbox"&&!a.editingBlockId&&(await nn("inbox",{resetUndoStacks:!1}),st("views.loadArticleView.inbox.refreshCache"))}catch{}}catch(t){try{if((Number(t?.status||0)||null)===404&&e&&e!=="inbox"){ko(e,new Date().toISOString()).catch(()=>{}),oo(e),P("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430 (\u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E, \u0443\u0434\u0430\u043B\u0435\u043D\u0430)."),It(wt.list);return}}catch{}p.blocksContainer.innerHTML=`<p class="meta">\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u044C\u044E: ${t.message}</p>`}}async function ka(){a.isPublicView=!1,a.isRagView=!1,document.body.classList.remove("public-embedded"),p.usersView&&p.usersView.classList.add("hidden"),a.article=null,a.articleId=null,a.currentBlockId=null,a.isEditingTitle=!1,a.mode="view",a.editingBlockId=null,a.undoStack=[],a.redoStack=[],a.pendingEditBlockId=null,hr({restoreDom:!1}),hi(!1),Qr();try{if(a.isTrashView){let e=await Es();an(e)}else{let e=await Ir();an(e)}}catch(e){p.articleList.innerHTML=`<li>\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u043F\u0438\u0441\u043E\u043A: ${e.message}</li>`}}async function Aa(e){a.isPublicView=!0,a.isRagView=!1,document.body.classList.add("public-embedded"),p.usersView&&p.usersView.classList.add("hidden"),hi(!0),a.isEditingTitle=!1,a.mode="view",a.editingBlockId=null,a.pendingEditBlockId=null,a.selectionAnchorBlockId=null,a.selectedBlockIds=[],a.undoStack=[],a.redoStack=[],hr({restoreDom:!1}),p.blocksContainer&&(p.blocksContainer.innerHTML="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...");try{let t=await apiRequest(`/api/public/articles/${encodeURIComponent(e)}`,{method:"GET",credentials:"omit"});a.article=t,a.articleId=t?.id||null;let n=On(t?.blocks||[])[0];a.currentBlockId=n?n.id:null,st("views.loadPublicArticleView.render")}catch(t){p.blocksContainer&&(p.blocksContainer.innerHTML=`<p class="meta">\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E: ${t.message}</p>`)}}async function Ui(){p.createArticleBtn&&(p.createArticleBtn.disabled=!0),p.sidebarNewArticleBtn&&(p.sidebarNewArticleBtn.disabled=!0);try{let e="",t=null,n=String(a.sidebarSelectedArticleId||a.articleId||a.listSelectedArticleId||"").trim(),r=n&&n!=="inbox"&&n!=="RAG"?a.articlesIndex.find(s=>String(s?.id||"")===n):null,o=r?String(r.title||"").trim():"";try{let s=await xn({title:"\u041D\u043E\u0432\u0430\u044F \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0430",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0437\u0430\u0433\u043E\u043B\u043E\u0432\u043E\u043A \u0434\u043B\u044F \u043D\u043E\u0432\u043E\u0439 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B.",confirmText:"\u0421\u043E\u0437\u0434\u0430\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"\u0417\u0430\u0433\u043E\u043B\u043E\u0432\u043E\u043A \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B",defaultValue:"",returnMeta:!0,checkbox:o&&n?{label:`\u0421\u043E\u0437\u0434\u0430\u0442\u044C \u0432\u043D\u0443\u0442\u0440\u0438 "${o}"?`,checked:!1,disabled:!1}:null});e=typeof s=="object"?s?.value:s,t=typeof s=="object"&&s?.checkboxChecked&&n&&o?n:null}catch{e=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0437\u0430\u0433\u043E\u043B\u043E\u0432\u043E\u043A \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B")||""}if(e=(e||"").trim(),!e)return;let i=await au(e,{parentId:t});if(t&&i?.id&&navigator.onLine&&String(i.parentId||"")!==String(t))try{let s=await cs(i.id,{parentId:t,placement:"inside"});s&&s.id&&(i=s)}catch{}Xn(i),a.pendingEditBlockId=i?.blocks?.[0]?.id||null,a.scrollTargetBlockId=a.pendingEditBlockId,It(wt.article(i.id)),P("\u0421\u0442\u0430\u0442\u044C\u044F \u0441\u043E\u0437\u0434\u0430\u043D\u0430")}catch(e){P(e.message)}finally{p.createArticleBtn&&(p.createArticleBtn.disabled=!1),p.sidebarNewArticleBtn&&(p.sidebarNewArticleBtn.disabled=!1)}}async function Ia(){It(wt.article("inbox"))}async function Ea(){try{let e=wt.article("inbox");a.articleId==="inbox"&&window.location.pathname===e||It(e);let n=await Promise.resolve().then(()=>(Mr(),Lr)),r=null,o=performance.now()+15e3;for(;!r&&performance.now()<o;){if(!(a.articleId==="inbox"&&a.article&&(String(a.article.id||"")==="inbox"||String(a.article.id||"").startsWith("inbox-"))&&String(a.article.title||"")==="\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438")){await new Promise(s=>setTimeout(s,50));continue}if(a.article?.encrypted){P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u0437\u0430\u043C\u0435\u0442\u043A\u0443 (\u0438\u043D\u0431\u043E\u043A\u0441 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D)");return}r=n?.insertNewOutlineSectionAtStart?.({enterEditMode:!0})||null,r||await new Promise(s=>setTimeout(s,50))}if(!r){P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u0437\u0430\u043C\u0435\u0442\u043A\u0443");return}a.currentBlockId=r;try{n?.enterOutlineSectionEditMode?.(r,{focusBody:!0})}catch{}}catch(e){P(e.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u0437\u0430\u043C\u0435\u0442\u043A\u0443")}}var Sm=Ke(()=>{At();Vt();Xt();zt();Qn();qn();Hr();En();En();En();ar();vn();Rl();Ul();Fi();Oo();ym(hw)});var Yf={};ur(Yf,{createArticle:()=>Ui,createInboxNote:()=>Ea,loadArticle:()=>nn,loadArticleView:()=>zi,loadListView:()=>ka,loadPublicArticleView:()=>Aa,mergeAllBlocksIntoFirst:()=>xa,openInboxArticle:()=>Ia,pushLocalBlockTrashEntry:()=>Si,removeArticleEncryption:()=>Ls,removeDomBlockById:()=>Lo,renderArticle:()=>st,reorderDomBlock:()=>qs,rerenderSingleBlock:()=>Lt,toggleArticleEncryption:()=>Bs,toggleDragMode:()=>Sa,updateArticleHeaderUi:()=>$n});var mr=Ke(()=>{Zo();Dc();Rl();Ul();Sm();Fi();Fi();Qr()});function It(e){if(window.location.pathname===e){Yo(e);return}window.history.pushState({},"",e),Yo(e)}function Yo(e){let t=e.match(/^\/p\/([^/?#]+)/);if(t){Aa(decodeURIComponent(t[1]));return}let n=e.match(/^\/article\/([0-9a-zA-Z-]+)/);if(n){let r=String(n[1]||"");if(r.startsWith("inbox-")){try{window.history.replaceState({},"",wt.article("inbox"))}catch{}zi("inbox");return}zi(r);return}ka()}function Vl(){window.addEventListener("popstate",()=>Yo(window.location.pathname))}var wt,qn=Ke(()=>{mr();wt={list:"/",article:e=>`/article/${e}`,public:e=>`/p/${e}`}});var zm={};ur(zm,{exportCurrentArticleAsHtml:()=>xw,exportCurrentBlockAsHtml:()=>kw});async function xw(){if(!a.article||!a.articleId){P("\u041D\u0435\u0442 \u043E\u0442\u043A\u0440\u044B\u0442\u043E\u0439 \u0441\u0442\u0430\u0442\u044C\u0438 \u0434\u043B\u044F \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0430");return}try{P("\u0413\u043E\u0442\u043E\u0432\u0438\u043C \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u2026");let e=await fetch(`/api/articles/${encodeURIComponent(a.articleId)}/export/html`,{credentials:"include",cache:"no-store"});if(!e.ok)throw new Error(`\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u044B\u0433\u0440\u0443\u0437\u0438\u0442\u044C HTML (HTTP ${e.status})`);let t=await e.text();Fm(t,Rm(a.article.title||"article")),P("HTML \u0441\u043E\u0445\u0440\u0430\u043D\u0451\u043D")}catch(e){console.error("Export failed",e),P(e.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u044B\u0433\u0440\u0443\u0437\u0438\u0442\u044C HTML")}}async function kw(e){if(a.article?.docJson||a.isOutlineEditing){P("\u042D\u043A\u0441\u043F\u043E\u0440\u0442 \u0444\u0440\u0430\u0433\u043C\u0435\u043D\u0442\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0432 outline \u0440\u0435\u0436\u0438\u043C\u0435");return}if(!a.article){P("\u041D\u0435\u0442 \u043E\u0442\u043A\u0440\u044B\u0442\u043E\u0439 \u0441\u0442\u0430\u0442\u044C\u0438 \u0434\u043B\u044F \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0430");return}let t=e||a.currentBlockId;if(!t){P("\u041D\u0435 \u0432\u044B\u0431\u0440\u0430\u043D \u0431\u043B\u043E\u043A \u0434\u043B\u044F \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0430");return}let n=Qe(t);if(!n||!n.block){P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u044B\u0439 \u0431\u043B\u043E\u043A");return}let r=n.block,{titleHtml:o}=jn(r.text||""),i="";o?i=ai(o):r.text&&(i=ai(r.text).slice(0,80)),i||(i="\u0424\u0440\u0430\u0433\u043C\u0435\u043D\u0442");let s=a.article.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",c=`${i} \u2014 \u0444\u0440\u0430\u0433\u043C\u0435\u043D\u0442 \u0438\u0437 \xAB${s}\xBB`;try{P("\u0413\u043E\u0442\u043E\u0432\u0438\u043C \u044D\u043A\u0441\u043F\u043E\u0440\u0442 \u0444\u0440\u0430\u0433\u043C\u0435\u043D\u0442\u0430...");let l=await Aw(),{bodyHtml:d,plainText:u,wordCount:m}=Ew([r],{title:i,updatedAt:a.article.updatedAt||null,suppressRootTitleInBody:!0}),{html:y,failures:w}=await Tw(d),g=Iw(u),f={...a.article,blocks:[r],title:c},h=vw(f),b=Cw({cssText:l,contentHtml:y,title:c,description:g,article:f,wordCount:m,lang:document.documentElement.lang||"ru",exportPayload:h});Fm(b,Rm(i||"fragment")),w.length?(P(`\u042D\u043A\u0441\u043F\u043E\u0440\u0442 \u0444\u0440\u0430\u0433\u043C\u0435\u043D\u0442\u0430 \u0437\u0430\u0432\u0435\u0440\u0448\u0451\u043D \u0441 \u043F\u0440\u0435\u0434\u0443\u043F\u0440\u0435\u0436\u0434\u0435\u043D\u0438\u044F\u043C\u0438: ${w.length} \u0432\u043B\u043E\u0436\u0435\u043D\u0438\u0439 \u043D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u043D\u043B\u0430\u0439\u043D\u0438\u0442\u044C`),console.warn("Inline failures (fragment export)",w)):P("\u0424\u0440\u0430\u0433\u043C\u0435\u043D\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0451\u043D \u0432 HTML")}catch(l){console.error("Export fragment failed",l),P(l.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u044B\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0440\u0430\u0433\u043C\u0435\u043D\u0442 \u0432 HTML")}}async function Aw(){let e=await fetch("/style.css",{cache:"no-cache"});if(!e.ok)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0438\u043B\u0438 \u0434\u043B\u044F \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0430");return e.text()}function Iw(e=""){if(!e)return"";let t=e.trim().replace(/\s+/g," ");return t.length<=Om?t:`${t.slice(0,Om).trimEnd()}\u2026`}function Rm(e=""){return`${(e||"article").toLowerCase().replace(/[^a-z0-9\u0400-\u04ff]+/gi,"-").replace(/^-+|-+$/g,"").slice(0,60)||"article"}.html`}function Hm(e=[]){let t=[];return e.forEach(n=>{n?.text&&t.push(ai(n.text)),n?.children?.length&&t.push(Hm(n.children))}),t.flat().filter(Boolean)}function $m(e,t=1,n={}){let r=!!n.suppressTitle,o=jn(e.text||""),i=!!o.titleHtml,s=!!e.children?.length;if(!i&&s&&typeof document<"u"){let O=document.createElement("div");O.innerHTML=o.bodyHtml||e.text||"";let W=Array.from(O.childNodes||[]).filter(J=>J.nodeType===Node.TEXT_NODE?(J.textContent||"").trim().length>0:J.nodeType===Node.ELEMENT_NODE?J.tagName==="BR"?!1:J.tagName==="P"?(J.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim().length>0:!0:!1);if(W.length===1){let J=W[0];J.nodeType===Node.ELEMENT_NODE&&J.tagName==="P"&&(o={titleHtml:J.outerHTML,bodyHtml:""},i=!0)}}let c=i?o.bodyHtml:e.text||"",l=i&&!r,d=!!(c&&c.trim()),u=l||s,m=!l&&!s,y=!!e.collapsed,w="";(u||m)&&(m?w='<button class="collapse-btn collapse-btn--placeholder" type="button" aria-hidden="true"></button>':w=`<button class="collapse-btn" type="button" data-block-id="${e.id}" aria-expanded="${y?"false":"true"}"></button>`);let g="";if(l){let W=`h${Math.min(Math.max(t,1),6)}`;g=`<${W} class="block-title">${o.titleHtml}</${W}>`}let f=g?`<div class="block-header${l?"":" block-header--no-title"}">${g}</div>`:"",h=["block-text","block-body"];l||h.push("block-body--no-title"),d||h.push("block-body--empty"),y&&l&&h.push("collapsed");let b=`<div class="${h.join(" ")}" data-block-body>${c||""}</div>`,S=`<div class="block-content">${f}${b}</div>`,k=l?t+1:t,A=(e.children||[]).map(O=>$m(O,k)).join(""),v=`<div class="block-children${y?" collapsed":""}" data-children>${A}</div>`,B=["block"];l||B.push("block--no-title");let H=`<div class="block-surface">${w}${S}</div>`;return`<div class="${B.join(" ")}" data-block-id="${e.id}" data-collapsed="${y?"true":"false"}" tabindex="0">${H}${v}</div>`}function Ew(e=[],{title:t,updatedAt:n,suppressRootTitleInBody:r}={}){let o=e||[],i=o.map((y,w)=>$m(y,1,{suppressTitle:!!(r&&w===0)})).join(""),c=Hm(o).join(" ").replace(/\s+/g," ").trim(),l=c?c.split(/\s+/).length:0,d=n?new Date(n).toLocaleString():"";return{bodyHtml:`
    <section aria-label="\u042D\u043A\u0441\u043F\u043E\u0440\u0442 \u0441\u0442\u0430\u0442\u044C\u0438">
      ${`
    <div class="panel-header article-header">
      <div class="title-block">
        <div class="title-row">
          <h1>${gt(t||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F")}</h1>
        </div>
        ${d?`<p class="meta">\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${gt(d)}</p>`:""}
      </div>
    </div>
  `}
      <div id="exportBlocksRoot" class="blocks" role="tree">
        ${i}
      </div>
    </section>
  `,plainText:c,wordCount:l}}function vw(e){if(!e)return{version:1,source:"memus",article:null,blocks:[]};let t=(n=[])=>(n||[]).map(r=>({id:r.id,text:r.text||"",collapsed:!!r.collapsed,children:t(r.children||[])}));return{version:1,source:"memus",article:{id:e.id,title:e.title||"",createdAt:e.createdAt||null,updatedAt:e.updatedAt||null,deletedAt:e.deletedAt||null,isInbox:e.id==="inbox",encrypted:!!e.encrypted,encryptionHint:e.encryptionHint||null},blocks:t(e.blocks||[])}}async function Tw(e){let t=document.createElement("template");t.innerHTML=e;let n=new Map,r=[],o=async d=>{if(n.has(d))return n.get(d);let u=new URL(d,window.location.href).toString(),m=fetch(u).then(async y=>{if(!y.ok)throw new Error(`\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0440\u0435\u0441\u0443\u0440\u0441 ${d}`);return y.blob()});return n.set(d,m),m},i=d=>new Promise((u,m)=>{let y=new FileReader;y.onloadend=()=>u(y.result),y.onerror=m,y.readAsDataURL(d)}),s=async d=>{let u=URL.createObjectURL(d);try{let m=await new Promise((f,h)=>{let b=new Image;b.onload=()=>f(b),b.onerror=h,b.crossOrigin="anonymous",b.src=u}),y=document.createElement("canvas");y.width=m.naturalWidth||m.width||1,y.height=m.naturalHeight||m.height||1,y.getContext("2d").drawImage(m,0,0);let g=y.toDataURL("image/webp",Sw);if(!g||g==="data:,")throw new Error("Canvas returned empty webp");return g}finally{URL.revokeObjectURL(u)}},c=Array.from(t.content.querySelectorAll("img"));await Promise.all(c.map(async d=>{let u=d.getAttribute("src")||"";if(!(!u||u.startsWith("data:")))try{let m=await o(u);try{let y=await s(m);d.setAttribute("data-original-src",u),d.setAttribute("src",y)}catch(y){console.warn("WebP convert failed, fallback to base64",y);let w=await i(m);d.setAttribute("data-original-src",u),d.setAttribute("src",w)}}catch(m){console.warn("Inline image failed",u,m),r.push(u)}}));let l=Array.from(t.content.querySelectorAll("a")).filter(d=>{let u=d.getAttribute("href")||"";return!u||u.startsWith("#")||u.startsWith("mailto:")||u.startsWith("data:")?!1:d.classList.contains("attachment-link")?!0:u.startsWith("/uploads")||u.includes("/uploads/")});return await Promise.all(l.map(async d=>{let u=d.getAttribute("href")||"";if(!(!u||u.startsWith("data:")))try{let m=await o(u),y=await i(m);d.setAttribute("data-original-href",u),d.setAttribute("href",y)}catch(m){console.warn("Inline attachment failed",u,m),r.push(u)}})),{html:t.innerHTML,failures:r}}function Cw({cssText:e,contentHtml:t,title:n,description:r,article:o,wordCount:i,lang:s,exportPayload:c}){let l=o.updatedAt||"",d=o.createdAt||l||"",u={"@context":"https://schema.org","@type":"Article",headline:n,description:r,dateModified:l,datePublished:d,wordCount:i,inLanguage:s||"ru"};return`
<!doctype html>
<html lang="${gt(s||"ru")}">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>${gt(n)}</title>
  <link rel="icon" href="/icons/favicon.ico" type="image/x-icon" />
  <meta name="description" content="${gt(r||n)}" />
  <meta name="x-memus-export" content="memus;v=1" />
  <meta name="robots" content="index,follow" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="${gt(n)}" />
  <meta property="og:description" content="${gt(r||n)}" />
  <meta name="twitter:card" content="summary_large_image" />
  <style>
${e}

    body.export-page {
      margin: 0;
      background: #eef2f8;
    }
    .block-children.collapsed {
      display: none;
    }
    .block {
      cursor: default;
    }
    body.export-page .title-row h1 {
      margin: 0;
    }
  
  </style>
  <script type="application/ld+json">
${JSON.stringify(u,null,2)}
  <\/script>
</head>
<body class="export-page export-static">
<div class="page">
<script type="application/json" id="memus-export">
${JSON.stringify(c||null,null,2)}
<\/script>
${t}
</div>
<script>
(() => {
  const root = document.getElementById('exportBlocksRoot');
  if (!root) return;
  const collapseIcon = { open: '${ww}', closed: '${bw}' };
  let currentId = root.querySelector('.block')?.dataset.blockId || null;

  const getParentBlock = (block) => (block?.parentElement ? block.parentElement.closest('.block') : null);

  const updateBlockView = (block, collapsed) => {
    block.dataset.collapsed = collapsed ? 'true' : 'false';
    const body = block.querySelector('.block-body');
    const noTitle = block.classList.contains('block--no-title');
    if (body && !noTitle) {
      body.classList.toggle('collapsed', collapsed);
    }
    const children = block.querySelector('.block-children');
    if (children) children.classList.toggle('collapsed', collapsed);
    const btn = block.querySelector('.collapse-btn');
    if (btn) {
      btn.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
      btn.textContent = collapsed ? collapseIcon.closed : collapseIcon.open;
    }
  };

  const collectVisible = () => {
    const result = [];
    const walk = (container) => {
      const blocks = Array.from(container.children).filter((node) => node.classList?.contains('block'));
      blocks.forEach((block) => {
        result.push(block);
        const isCollapsed = block.dataset.collapsed === 'true';
        const children = block.querySelector('.block-children');
        if (!isCollapsed && children) walk(children);
      });
    };
    walk(root);
    return result;
  };

  const setCurrent = (block) => {
    if (!block) return;
    currentId = block.dataset.blockId || null;
    root.querySelectorAll('.block.selected').forEach((el) => el.classList.remove('selected'));
    block.classList.add('selected');
    block.focus({ preventScroll: false });
  };

  const toggleBlock = (block, desired) => {
    if (!block) return;
    const collapsed = block.dataset.collapsed === 'true';
    const next = typeof desired === 'boolean' ? desired : !collapsed;
    updateBlockView(block, next);
  };

  const moveSelection = (offset) => {
    if (!currentId) {
      const first = root.querySelector('.block');
      if (first) setCurrent(first);
      return;
    }
    const ordered = collectVisible();
    const index = ordered.findIndex((b) => b.dataset.blockId === currentId);
    if (index === -1) return;
    const next = ordered[index + offset];
    if (next) setCurrent(next);
  };

  const scrollCurrentBlockStep = (direction) => {
    if (!currentId) return false;
    const el =
      root.querySelector(\`.block[data-block-id="\${currentId}"] > .block-surface\`) ||
      root.querySelector(\`.block[data-block-id="\${currentId}"]\`);
    if (!el) return false;
    const rect = el.getBoundingClientRect();
    const margin = 24;
    const visibleHeight = window.innerHeight - margin * 2;
    if (visibleHeight <= 0) return false;
    if (rect.height <= visibleHeight) return false;
    if (direction === 'down') {
      const bottomLimit = window.innerHeight - margin;
      if (rect.bottom <= bottomLimit) return false;
      const delta = rect.bottom - bottomLimit;
      const baseStep = Math.min(Math.max(delta, 40), 160);
      const step = Math.max(24, Math.round(baseStep / 3));
      window.scrollBy({ top: step, behavior: 'smooth' });
      return true;
    }
    if (direction === 'up') {
      const topLimit = margin;
      if (rect.top >= topLimit) return false;
      const delta = topLimit - rect.top;
      const baseStep = Math.min(Math.max(delta, 40), 160);
      const step = Math.max(24, Math.round(baseStep / 3));
      window.scrollBy({ top: -step, behavior: 'smooth' });
      return true;
    }
    return false;
  };

  const handleArrowLeft = () => {
    if (!currentId) return;
    const block = root.querySelector(\`.block[data-block-id="\${currentId}"]\`);
    if (!block) return;
    const collapsed = block.dataset.collapsed === 'true';
    if (!collapsed) {
      toggleBlock(block, true);
      return;
    }
    const parent = getParentBlock(block);
    if (parent) setCurrent(parent);
  };

  const handleArrowRight = () => {
    if (!currentId) return;
    const block = root.querySelector(\`.block[data-block-id="\${currentId}"]\`);
    if (!block) return;
    const collapsed = block.dataset.collapsed === 'true';
    const firstChild = block.querySelector('.block-children .block');
    if (collapsed) {
      toggleBlock(block, false);
      if (firstChild) setCurrent(firstChild);
      return;
    }
    if (firstChild) {
      setCurrent(firstChild);
    }
  };

  root.addEventListener('click', (event) => {
    const btn = event.target.closest('.collapse-btn');
    if (btn) {
      const targetId = btn.dataset.blockId;
      const block = root.querySelector(\`.block[data-block-id="\${targetId}"]\`);
      toggleBlock(block);
      setCurrent(block);
      return;
    }
    const block = event.target.closest('.block');
    if (block) {
      const isInteractive = event.target.closest('a, button, input, textarea, select');
      if (!isInteractive) {
        const header = block.querySelector('.block-header');
        const body = block.querySelector('.block-text.block-body');
        const bodyHasNoTitle = body?.classList.contains('block-body--no-title');
        const clickedInHeader = header && header.contains(event.target);
        const clickedInBody = body && body.contains(event.target);
        const hasLogicalTitle = Boolean(header && !bodyHasNoTitle);
        let shouldToggle = false;
        if (hasLogicalTitle && clickedInHeader) {
          shouldToggle = true;
        } else if (!hasLogicalTitle && clickedInBody) {
          shouldToggle = true;
        }
        if (shouldToggle) {
          toggleBlock(block);
        }
      }
      setCurrent(block);
    }
  });

  function scrollCurrentBlockStep(direction) {
    if (!currentId) return false;
    const el =
      root.querySelector('.block[data-block-id="' + currentId + '"] > .block-surface') ||
      root.querySelector('.block[data-block-id="' + currentId + '"]');
    if (!el) return false;
    const rect = el.getBoundingClientRect();
    const margin = 24;
    const visibleHeight = window.innerHeight - margin * 2;
    if (visibleHeight <= 0) return false;
    if (rect.height <= visibleHeight) return false;
    if (direction === 'down') {
      const bottomLimit = window.innerHeight - margin;
      if (rect.bottom <= bottomLimit) return false;
      const delta = rect.bottom - bottomLimit;
      const baseStep = Math.min(Math.max(delta, 40), 160);
      const step = Math.max(24, Math.round(baseStep / 3));
      window.scrollBy({ top: step, behavior: 'smooth' });
      return true;
    }
    if (direction === 'up') {
      const topLimit = margin;
      if (rect.top >= topLimit) return false;
      const deltaUp = topLimit - rect.top;
      const baseStepUp = Math.min(Math.max(deltaUp, 40), 160);
      const stepUp = Math.max(24, Math.round(baseStepUp / 3));
      window.scrollBy({ top: -stepUp, behavior: 'smooth' });
      return true;
    }
    return false;
  }

  document.addEventListener('keydown', (event) => {
    if (['ArrowDown', 'ArrowUp', 'ArrowLeft', 'ArrowRight', 'Enter', 'Space', ' '].includes(event.code)) {
      event.preventDefault();
    } else {
      return;
    }
    if (event.code === 'ArrowDown') {
      const scrolled = scrollCurrentBlockStep('down');
      if (!scrolled) moveSelection(1);
      return;
    }
    if (event.code === 'ArrowUp') {
      const scrolled = scrollCurrentBlockStep('up');
      if (!scrolled) moveSelection(-1);
      return;
    }
    if (event.code === 'ArrowLeft') {
      handleArrowLeft();
      return;
    }
    if (event.code === 'ArrowRight') {
      handleArrowRight();
      return;
    }
    if (event.code === 'Enter' || event.code === 'Space' || event.code === ' ') {
      if (!currentId) return;
      const block = root.querySelector(\`.block[data-block-id="\${currentId}"]\`);
      toggleBlock(block);
    }
  });

  const initial = currentId ? root.querySelector(\`.block[data-block-id="\${currentId}"]\`) : root.querySelector('.block');
  if (initial) setCurrent(initial);
})();
<\/script>
</body>
</html>
`}function Fm(e,t){let n=new Blob([e],{type:"text/html"}),r=URL.createObjectURL(n),o=document.createElement("a");o.href=r,o.download=t,o.rel="noopener",o.click(),setTimeout(()=>URL.revokeObjectURL(r),0)}var Om,bw,ww,Sw,Um=Ke(()=>{At();vn();Un();zt();Om=160,bw="\u25B8",ww="\u25BE",Sw=.82});var ph={};ur(ph,{initGraphView:()=>Ww,openGraphView:()=>fh});function Pa(){if(typeof window>"u")return null;let e=window.vis;return!e||!e.Network?null:e}function Vw(){return qi||(qi=new Promise((e,t)=>{try{if(document.querySelector('link[data-vis-network-css="1"]')){e();return}let r=document.createElement("link");r.rel="stylesheet",r.href="/vendor/vis-network.min.css",r.dataset.visNetworkCss="1",r.onload=()=>e(),r.onerror=()=>t(new Error("vis-network css load failed")),document.head.appendChild(r)}catch(n){t(n)}}).finally(()=>{document.querySelector('link[data-vis-network-css="1"]')||(qi=null)}),qi)}function qw(){let e=Pa();return e?Promise.resolve(e):Vi||(Vi=(async()=>{await Vw(),await new Promise((n,r)=>{let o=document.createElement("script");o.src="/vendor/vis-network.min.js",o.async=!0,o.onload=()=>n(),o.onerror=()=>r(new Error("vis-network load failed")),document.head.appendChild(o)});let t=Pa();if(!t)throw new Error("vis-network not available");return t})().finally(()=>{Pa()||(Vi=null)}),Vi)}function Kw(e,t){let n=new Map;e.forEach(s=>{n.set(s,new Set)}),t.forEach(s=>{let{from:c,to:l}=s;!n.has(c)||!n.has(l)||(n.get(c).add(l),n.get(l).add(c))});let r=new Map,o=new Map,i=0;return e.forEach(s=>{if(r.has(s))return;let c=[s];r.set(s,i);let l=new Set([s]);for(;c.length;){let d=c.shift();(n.get(d)||new Set).forEach(m=>{r.has(m)||(r.set(m,i),l.add(m),c.push(m))})}o.set(i,l),i+=1}),{nodeToComp:r,compToNodes:o}}function jw(){if(!Na)return{nodes:[],edges:[]};let e=Na.nodes||[],t=Na.edges||[],n=["#fecaca","#fde68a","#bbf7d0","#bfdbfe","#ddd6fe","#f9a8d4"],r=e.map(l=>l.id),o=t.map((l,d)=>({id:`e-${d}`,from:l.source,to:l.target})),{nodeToComp:i,compToNodes:s}=Kw(r,o);Xl=i,dh=s,Da=new Map,_a=new Map;let c=e.map(l=>{let d=l.id,u=t.filter(A=>A.source===d||A.target===d).length,m=Xl.get(d)??0,y=n[m%n.length],w=a.articleId===d,g=w?"#f97316":l.public?"#0ea5e9":"#64748b",f=w?3:u>=4?2:1.5,h={size:18,color:"#111827",face:"system-ui, -apple-system, BlinkMacSystemFont, sans-serif"},b={background:y,border:g},S={background:"#e5e7eb",border:"#cbd5f5"},k={background:y,border:"#f97316"};return Da.set(d,{color:b,dimColor:S,highlightColor:k,borderWidth:f,font:h}),{id:d,label:l.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",title:l.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",value:Math.max(1,u),shape:"dot",size:uh/2,color:b,borderWidth:f,font:h}});return o.forEach(l=>{_a.set(l.id,{color:"#d1d5db",highlightColor:"#f97316",width:1,highlightWidth:1.5})}),{nodes:c,edges:o}}function Zl(){let t=p.graphCanvas.getBoundingClientRect(),n=t.width||600,r=t.height||400;return{autoResize:!0,width:`${n}px`,height:`${r}px`,interaction:{hover:!0,tooltipDelay:80},physics:{enabled:!0,solver:"forceAtlas2Based",stabilization:{enabled:!0,iterations:300,updateInterval:30,fit:!1},forceAtlas2Based:{gravitationalConstant:-100,centralGravity:.005,springLength:uh*5,springConstant:.1,damping:.4,avoidOverlap:1},minVelocity:.7},nodes:{shape:"dot",scaling:{min:10,max:20},font:{size:14,color:"#111827",face:"system-ui, -apple-system, BlinkMacSystemFont, sans-serif",strokeWidth:2,strokeColor:"#f8fafc"}},edges:{smooth:!1,color:{color:"#d1d5db",highlight:"#f97316"}}}}function lh(e){if(!Dr||!_r)return;if(e==null){let o=[];Dr.forEach(s=>{let c=Da.get(s.id);c&&o.push({id:s.id,color:c.color,borderWidth:c.borderWidth,font:c.font})}),Dr.update(o);let i=[];_r.forEach(s=>{let c=_a.get(s.id);c&&i.push({id:s.id,color:c.color,width:c.width})}),_r.update(i);return}let t=dh.get(e)||new Set,n=[];Dr.forEach(o=>{let i=Da.get(o.id);if(!i)return;let s=t.has(o.id);n.push({id:o.id,color:s?i.highlightColor:i.dimColor,borderWidth:i.borderWidth,font:i.font})}),Dr.update(n);let r=[];_r.forEach(o=>{let i=_a.get(o.id);if(!i)return;let s=t.has(o.from)&&t.has(o.to);r.push({id:o.id,color:s?i.highlightColor:i.color,width:s?i.highlightWidth:i.width})}),_r.update(r)}function Jw(){let e=Pa();if(!e||!p.graphCanvas){P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0431\u0438\u0431\u043B\u0438\u043E\u0442\u0435\u043A\u0443 \u0433\u0440\u0430\u0444\u0430 (vis-network)");return}let{nodes:t,edges:n}=jw();if(!t||t.length===0){p.graphCanvas.innerHTML='<div class="meta" style="padding:1rem">\u041D\u0435\u0442 \u0434\u0430\u043D\u043D\u044B\u0445 \u0434\u043B\u044F \u0433\u0440\u0430\u0444\u0430.</div>';return}if(dr||(p.graphCanvas.textContent=""),dr){Dr.clear(),_r.clear(),Dr.add(t),_r.add(n);let r=Zl();dr.setOptions(r)}else{Dr=new e.DataSet(t),_r=new e.DataSet(n);let r=Zl();dr=new e.Network(p.graphCanvas,{nodes:Dr,edges:_r},r);try{dr.once("stabilizationIterationsDone",()=>{try{dr.fit({animation:!1})}catch{}})}catch{}dr.on("click",o=>{if(!o.nodes||!o.nodes.length)return;let i=o.nodes[0];i&&It(wt.article(i))}),dr.on("hoverNode",o=>{let i=o.node,s=Xl.get(i);s!==void 0&&lh(s)}),dr.on("blurNode",()=>{lh(null)})}}async function fh(){if(!(!p.graphView||!p.graphCanvas)){p.articleListView&&p.articleListView.classList.add("hidden"),p.articleView&&p.articleView.classList.add("hidden"),p.articleHeader&&p.articleHeader.classList.add("hidden"),p.usersView&&p.usersView.classList.add("hidden"),p.graphView.classList.remove("hidden"),p.graphCanvas.innerHTML='<div class="meta" style="padding:1rem">\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0433\u0440\u0430\u0444\u0430\u2026</div>';try{await qw()}catch{P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0431\u0438\u0431\u043B\u0438\u043E\u0442\u0435\u043A\u0443 \u0433\u0440\u0430\u0444\u0430 (vis-network)"),p.graphCanvas.innerHTML='<div class="meta" style="padding:1rem">\u0413\u0440\u0430\u0444 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D: \u043D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0431\u0438\u0431\u043B\u0438\u043E\u0442\u0435\u043A\u0443.</div>';return}try{Na=await He("/api/graph")}catch(e){P(e.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0434\u0430\u043D\u043D\u044B\u0435 \u0433\u0440\u0430\u0444\u0430"),p.graphCanvas.innerHTML='<div class="meta" style="padding:1rem">\u0413\u0440\u0430\u0444 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D: \u043D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0434\u0430\u043D\u043D\u044B\u0435.</div>';return}requestAnimationFrame(()=>Jw())}}function Ww(){!p.graphView||!p.graphCanvas||!p.graphToggleBtn||(p.graphToggleBtn.addEventListener("click",()=>{fh()}),p.graphBackBtn&&p.graphBackBtn.addEventListener("click",()=>{p.graphView.classList.add("hidden"),p.articleView&&p.articleView.classList.add("hidden"),p.articleHeader&&p.articleHeader.classList.add("hidden"),p.articleListView&&p.articleListView.classList.remove("hidden")}),window.addEventListener("resize",()=>{if(!p.graphView.classList.contains("hidden")&&dr){let e=Zl();dr.setOptions(e)}}))}var Na,dr,Dr,_r,Xl,dh,Da,_a,uh,Vi,qi,mh=Ke(()=>{Vt();Xt();qn();At();zt();Na=null,dr=null,Dr=null,_r=null,Xl=new Map,dh=new Map,Da=new Map,_a=new Map,uh=22;Vi=null,qi=null});var yh={};ur(yh,{initUsersPanel:()=>Xw,openUsersPage:()=>gh});function Yw(){p.articleListView&&p.articleListView.classList.add("hidden"),p.articleView&&p.articleView.classList.add("hidden"),p.graphView&&p.graphView.classList.add("hidden"),p.articleHeader&&p.articleHeader.classList.add("hidden")}function Gw(){Yw(),p.usersView&&p.usersView.classList.remove("hidden")}function Qw(){p.usersView&&p.usersView.classList.add("hidden"),p.articleListView&&p.articleListView.classList.remove("hidden"),p.articleView&&p.articleView.classList.add("hidden"),p.articleHeader&&p.articleHeader.classList.add("hidden")}async function hh(e){if(p.usersList){p.usersList.textContent="";try{let t=await fu(e);if(!t.length){let n=document.createElement("li");n.textContent="\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439 \u043D\u0435\u0442",p.usersList.appendChild(n);return}t.forEach(n=>{let r=document.createElement("li");r.className="users-list-item";let o=document.createElement("span");if(o.className="users-list-item__info",o.textContent=`${n.username}${n.displayName&&n.displayName!==n.username?` (${n.displayName})`:""}`,n.isSuperuser){let i=document.createElement("span");i.className="users-list-item__badge",i.textContent="superuser",o.appendChild(i)}if(r.appendChild(o),!n.isSuperuser){let i=document.createElement("button");i.type="button",i.className="ghost small users-list-item__delete",i.textContent="\u0423\u0434\u0430\u043B\u0438\u0442\u044C",i.addEventListener("click",async()=>{if(window.confirm(`\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F "${n.username}" \u0441\u043E \u0432\u0441\u0435\u043C\u0438 \u0441\u0442\u0430\u0442\u044C\u044F\u043C\u0438 \u0438 \u0444\u0430\u0439\u043B\u0430\u043C\u0438?`))try{await pu(n.id),P("\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u0443\u0434\u0430\u043B\u0451\u043D"),await hh()}catch(c){P(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F")}}),r.appendChild(i)}p.usersList.appendChild(r)})}catch(t){let n=document.createElement("li");n.textContent=t.message||"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439",p.usersList.appendChild(n)}}}async function gh(e){Gw(),await hh(e)}function Xw(){p.openUsersViewBtn&&p.openUsersViewBtn.addEventListener("click",async()=>{let e="";try{e=await xn({title:"\u0414\u043E\u0441\u0442\u0443\u043F \u043A \u0443\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u044E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\u043C\u0438",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u0430.",confirmText:"\u041E\u0442\u043A\u0440\u044B\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"\u041F\u0430\u0440\u043E\u043B\u044C",inputType:"password"})}catch{e=""}e&&gh(e)}),p.usersBackBtn&&p.usersBackBtn.addEventListener("click",()=>{Qw()})}var bh=Ke(()=>{Vt();Xt();zt();Qn()});var wh={};ur(wh,{initTables:()=>cS});function Zw(e){if(!e)return null;let t=e.target;return!t||!(t instanceof Element)?null:t.closest("td,th")}function eS(e){if(!e)return;let t=e.parentElement,n=t&&t.closest("table.memus-table");if(!t||!n)return;let r=n.tBodies[0]||n.createTBody(),o=Array.from(r.rows),i=o.indexOf(t),s=t.cells.length,c=document.createElement("tr");for(let l=0;l<s;l+=1){let d=document.createElement("td");d.innerHTML="&nbsp;",c.appendChild(d)}i>=0&&i<o.length-1?r.insertBefore(c,o[i+1]):r.appendChild(c)}function tS(e){if(!e)return;let t=e.parentElement,n=t&&t.closest("table.memus-table");if(!t||!n)return;let r=n.tBodies[0];r&&(r.rows.length<=1||r.removeChild(t))}function nS(e){if(!e)return;let t=e.closest("table.memus-table");if(!t)return;let n=e.cellIndex,r=Array.from(t.rows);r.forEach(l=>{let d=document.createElement(l.sectionRowIndex===0&&l.parentElement===t.tHead?"th":"td");d.innerHTML="&nbsp;",n>=0&&n<l.cells.length-1?l.insertBefore(d,l.cells[n+1]):l.appendChild(d)});let o=t.querySelector("colgroup");o||(o=document.createElement("colgroup"),t.insertBefore(o,t.firstChild));let i=Array.from(o.querySelectorAll("col")),s=r[0]?.cells.length||i.length+1||1;for(;i.length<s;){let l=document.createElement("col");o.appendChild(l),i=Array.from(o.querySelectorAll("col"))}let c=100/s;i.forEach(l=>{l.setAttribute("width",`${c}%`)})}function rS(e){if(!e)return;let t=e.closest("table.memus-table");if(!t)return;let n=e.cellIndex;if(n<0)return;let r=Array.from(t.rows);if(r.length&&r[0].cells.length<=1)return;r.forEach(i=>{i.cells[n]&&i.deleteCell(n)});let o=t.querySelector("colgroup");if(o){let i=Array.from(o.querySelectorAll("col"));i[n]&&i[n].remove();let s=Array.from(o.querySelectorAll("col")),c=s.length||t.tHead?.rows[0]?.cells.length||0;if(c>0){let l=100/c;if(s.length)s.forEach(d=>{d.setAttribute("width",`${l}%`)});else for(let d=0;d<c;d+=1){let u=document.createElement("col");u.setAttribute("width",`${l}%`),o.appendChild(u)}}}}function td(){Qo&&Qo.parentElement&&Qo.parentElement.removeChild(Qo),Qo=null}function oS(e){if(td(),!e)return;let t=e.closest("table.memus-table");if(!t)return;let n=document.createElement("div");n.className="table-toolbar";let r=(d,u)=>{let m=document.createElement("button");return m.type="button",m.className="table-toolbar-btn",m.textContent=d,u&&(m.title=u),m},o=r("+\u0441\u0442\u0440","\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0441\u0442\u0440\u043E\u043A\u0443 \u043D\u0438\u0436\u0435"),i=r("\u2212\u0441\u0442\u0440","\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0441\u0442\u0440\u043E\u043A\u0443"),s=r("+\u043A\u043E\u043B","\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u043A\u043E\u043B\u043E\u043D\u043A\u0443 \u0441\u043F\u0440\u0430\u0432\u0430"),c=r("\u2212\u043A\u043E\u043B","\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043A\u043E\u043B\u043E\u043D\u043A\u0443");o.addEventListener("click",d=>{d.preventDefault(),d.stopPropagation(),eS(e)}),i.addEventListener("click",d=>{d.preventDefault(),d.stopPropagation(),tS(e)}),s.addEventListener("click",d=>{d.preventDefault(),d.stopPropagation(),nS(e)}),c.addEventListener("click",d=>{d.preventDefault(),d.stopPropagation(),rS(e)}),n.appendChild(o),n.appendChild(i),n.appendChild(s),n.appendChild(c),(t.parentElement||t).insertBefore(n,t),Qo=n}function iS(e,t,n){let r=t.closest("table.memus-table");if(!r)return;let o=r.querySelector("colgroup");if(!o)return;let i=Array.from(o.querySelectorAll("col"));if(!i[n])return;let s=r.getBoundingClientRect(),c=e.clientX,l=i.map(u=>{let m=u.getAttribute("width")||"";return m.endsWith("%")&&parseFloat(m.replace("%","").trim())||0}),d=l.reduce((u,m)=>u+m,0)||100;Oa={table:r,colgroup:o,cols:i,startX:c,startWidths:l,totalPercent:d,colIndex:n,tableWidthPx:s.width||1},e.preventDefault(),e.stopPropagation()}function sS(e){if(!Oa)return;let{cols:t,colIndex:n,startX:r,startWidths:o,totalPercent:i,tableWidthPx:s}=Oa,l=(e.clientX-r)/s*i,d=[...o],u=d[n]||i/t.length,m=n+1,y=d[m]||i/t.length,w=u+l,g=y-l,f=i*.05;if(w<f){let h=f-w;w=f,g-=h}if(g<f){let h=f-g;g=f,w-=h}d[n]=w,t[m]&&(d[m]=g),d.forEach((h,b)=>{if(t[b]){let S=h/i*100;t[b].setAttribute("width",`${S}%`)}})}function aS(){Oa=null}function ed(e){let t=e.tHead;if(!t)return;let n=t.rows[0];if(!n)return;let r=e.querySelector("colgroup");if(!r){let o=Math.max(n.cells.length||1,1),i=100/o;r=document.createElement("colgroup");for(let s=0;s<o;s+=1){let c=document.createElement("col");c.setAttribute("width",`${i.toFixed(4)}%`),r.appendChild(c)}e.insertBefore(r,t)}Array.from(n.cells).forEach((o,i)=>{let s=document.createElement("div");s.className="table-col-resize-handle",s.addEventListener("mousedown",c=>iS(c,o,i)),o.style.position="relative",o.appendChild(s)})}function cS(){p.articleView&&(p.articleView.addEventListener("click",t=>{let n=Zw(t);if(!n||a.mode!=="edit"||!a.editingBlockId){td();return}if(!n.closest('[contenteditable="true"]')){td();return}oS(n)},!0),p.articleView.addEventListener("wheel",t=>{let n=t.target;!n||!(n instanceof Element)||n.closest("table.memus-table")&&p.blocksContainer&&(p.blocksContainer.scrollTop+=t.deltaY,t.preventDefault())},{capture:!0,passive:!1})),document.addEventListener("mousemove",sS),document.addEventListener("mouseup",aS);let e=new MutationObserver(t=>{t.forEach(n=>{n.addedNodes.forEach(r=>{r instanceof HTMLElement&&(r.matches&&r.matches("table.memus-table")?ed(r):r.querySelectorAll?.("table.memus-table").forEach(o=>{ed(o)}))})})});p.articleView&&(e.observe(p.articleView,{childList:!0,subtree:!0}),p.articleView.querySelectorAll("table.memus-table").forEach(t=>{ed(t)}))}var Qo,Oa,Sh=Ke(()=>{Vt();At();Qo=null;Oa=null});qn();At();Vt();ar();Bo();vn();bs();At();Vt();Xt();Hr();zt();En();bs();qn();Qn();var ql=!1;function xm(){p.articleTitleInput&&requestAnimationFrame(()=>{p.articleTitleInput.focus(),p.articleTitleInput.select()})}function va(){if(!(!a.article||!p.articleTitleInput)){if(a.isEditingTitle){xm();return}a.isEditingTitle=!0,p.articleTitleInput.value=a.article.title||"",p.articleTitle&&p.articleTitle.classList.add("hidden"),p.articleTitleInput&&p.articleTitleInput.classList.remove("hidden"),p.editTitleBtn&&p.editTitleBtn.classList.add("hidden"),xm()}}function km(){a.article&&(a.isEditingTitle||va())}function gw(){if(!a.isEditingTitle)return;a.isEditingTitle=!1,p.articleTitleInput&&a.article&&(p.articleTitleInput.value=a.article.title||"");let e=a.article?.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";p.articleTitle&&(p.articleTitle.textContent=e,p.articleTitle.classList.remove("hidden")),p.articleTitleInput&&p.articleTitleInput.classList.add("hidden"),p.editTitleBtn&&p.editTitleBtn.classList.remove("hidden")}function yw(e){if(!e)return;let t=!1;a.searchResults=a.searchResults.map(n=>n.articleId===e.id&&n.articleTitle!==e.title?(t=!0,{...n,articleTitle:e.title}):n),t&&to()}async function Am(){if(!a.isEditingTitle||!p.articleTitleInput||!a.articleId||!a.article)return;let e=p.articleTitleInput.value.trim(),t=(a.article.title||"").trim();if(e===t){a.isEditingTitle=!1,p.articleTitle&&(p.articleTitle.textContent=t||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",p.articleTitle.classList.remove("hidden")),p.articleTitleInput&&p.articleTitleInput.classList.add("hidden"),p.editTitleBtn&&p.editTitleBtn.classList.remove("hidden");return}if(!Ki){Ha(!0),p.articleTitleInput.disabled=!0;try{let n=await He(`/api/articles/${a.articleId}`,{method:"PATCH",body:JSON.stringify({title:e})});a.article={...a.article,title:n.title,updatedAt:n.updatedAt},Xn(n),a.isEditingTitle=!1;let r=a.article.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";p.articleTitle&&(p.articleTitle.textContent=r,p.articleTitle.classList.remove("hidden")),p.articleTitleInput&&(p.articleTitleInput.classList.add("hidden"),p.articleTitleInput.value=r),p.editTitleBtn&&p.editTitleBtn.classList.remove("hidden"),yw(n),P("Title saved")}catch(n){P(n.message||"Failed to save title")}finally{Ha(!1),p.articleTitleInput&&(p.articleTitleInput.disabled=!1)}}}function Im(e){a.isEditingTitle&&(e.code==="Enter"?Am():e.code==="Escape"&&gw())}function Em(){!a.isEditingTitle||Ki||Am()}function vm(e){!p.articleMenu||!p.articleMenuBtn||(ql=e,p.articleMenu.classList.toggle("hidden",!e),p.articleMenuBtn.setAttribute("aria-expanded",e?"true":"false"))}function Tm(e){e&&e.stopPropagation(),a.article&&vm(!ql)}function Nr(){vm(!1)}function Cm(){return ql}async function Bm(e){if(e&&e.stopPropagation(),Nr(),!a.articleId)return;if(a.articleId==="inbox"){P("\u0421\u0442\u0430\u0442\u044C\u044E Inbox \u043D\u0435\u043B\u044C\u0437\u044F \u0443\u0434\u0430\u043B\u0438\u0442\u044C");return}let t=!!(a.article?.deletedAt||a.isTrashView),n=!1;try{n=await Vn({title:t?"\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0431\u0435\u0437\u0432\u043E\u0437\u0432\u0440\u0430\u0442\u043D\u043E?":"\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443?",message:t?"\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0431\u0443\u0434\u0435\u0442 \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u0431\u0435\u0437 \u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E\u0441\u0442\u0438 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F.":"\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0431\u0443\u0434\u0435\u0442 \u043F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0430 \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443.",confirmText:t?"\u0423\u0434\u0430\u043B\u0438\u0442\u044C":"\u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"})}catch{n=window.confirm(t?"\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0431\u0435\u0437\u0432\u043E\u0437\u0432\u0440\u0430\u0442\u043D\u043E?":"\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443?")}if(n)try{await as(a.articleId,{force:t}),t?To(a.articleId):oo(a.articleId),a.article=null,a.articleId=null,a.currentBlockId=null,It(wt.list),P(t?"\u0421\u0442\u0430\u0442\u044C\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u0431\u0435\u0437\u0432\u043E\u0437\u0432\u0440\u0430\u0442\u043D\u043E":"\u0421\u0442\u0430\u0442\u044C\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0430 \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443")}catch(r){if((Number(r?.status||0)||null)===404){try{ko(a.articleId,new Date().toISOString()).catch(()=>{})}catch{}t?(To(a.articleId),oo(a.articleId)):oo(a.articleId),a.article=null,a.articleId=null,a.currentBlockId=null,It(wt.list),P("\u0421\u0442\u0430\u0442\u044C\u044F \u0443\u0436\u0435 \u0443\u0434\u0430\u043B\u0435\u043D\u0430");return}P(r.message)}}En();En();mr();qn();Xt();Hr();rr();zt();Un();Qn();mr();ti();ti();rr();Fn();async function Lm(){let t=(await lt()).transaction(["articles","media_refs","media_assets"],"readonly"),n=t.objectStore("articles"),r=t.objectStore("media_refs"),o=t.objectStore("media_assets"),i=await ke(n.getAll()).catch(()=>[])||[],s=0,c=0;for(let g of i)!g||g.deletedAt||Number(g.encrypted||0)===0&&(s+=1,g.docJsonStr&&(c+=1));let l=await ke(r.getAll()).catch(()=>[])||[],d=new Set;for(let g of l){let f=String(g?.url||"");f&&d.add(f)}let u=0,m=0,y={notFound:0,noAccess:0,network:0,other:0};for(let g of d){let f=await ke(o.get(g)).catch(()=>null);if(f?.status==="ok"&&(u+=1),f?.status==="error"){m+=1;let h=String(f?.lastError||"");/\bHTTP\s+404\b/.test(h)?y.notFound+=1:/\bHTTP\s+(401|403)\b/.test(h)?y.noAccess+=1:/Failed to fetch/i.test(h)||/Network/i.test(h)||/timeout/i.test(h)||/ERR_/i.test(h)?y.network+=1:y.other+=1}}let w=d.size;return await Ve(t),{articles:{total:s,withDoc:c},media:{total:w,ok:u,error:m,errorKinds:y}}}Xs();eo();At();Vt();ar();ar();Bo();vn();En();function Kl(e){if(!e)return!1;let t=e instanceof Node?e:null;if(!t||t.nodeType!==Node.ELEMENT_NODE)return!!(e&&e.isContentEditable);let n=t.tagName;return n==="INPUT"||n==="TEXTAREA"||n==="SELECT"?!0:t.isContentEditable}function Mm(e){if(!a.currentBlockId)return!1;let t=document.querySelector(`.block[data-block-id="${a.currentBlockId}"] > .block-surface`)||document.querySelector(`.block[data-block-id="${a.currentBlockId}"]`);if(!t)return!1;let n=p.blocksContainer||document.scrollingElement||document.documentElement;if(!n)return!1;let r=n.getBoundingClientRect(),o=t.getBoundingClientRect(),i=24,s=r.height-i*2;if(s<=0||o.height<=s)return!1;if(e==="down"){let c=r.bottom-i;if(o.bottom<=c)return!1;let d=o.bottom-c,u=Math.min(Math.max(d,40),160),m=Math.max(24,Math.round(u/3));return n.scrollBy({top:m,behavior:"smooth"}),!0}if(e==="up"){let c=r.top+i;if(o.top>=c)return!1;let d=c-o.top,u=Math.min(Math.max(d,40),160),m=Math.max(24,Math.round(u/3));return n.scrollBy({top:-m,behavior:"smooth"}),!0}return!1}function Nm(e){if(!a.article||Kl(e.target)||a.isEditingTitle&&p.articleTitleInput&&p.articleTitleInput.contains(e.target))return;if(a.isPublicView||a.isRagView){let s=typeof e.code=="string"?e.code:"";if(s==="Enter"){e.preventDefault();return}if(e.ctrlKey&&(s==="KeyZ"||s==="KeyY"||s==="Delete"||s==="ArrowDown"||s==="ArrowUp"||s==="ArrowLeft"||s==="ArrowRight")){e.preventDefault();return}}if(fr&&e.code==="Escape"){e.preventDefault(),Ar();return}let t=typeof e.code=="string"?e.code:"",n=s=>{let c=p.blocksContainer;if(!c)return;let l=c.getBoundingClientRect(),d=24,u=Math.max(0,l.height-d*2);if(u<=0)return;let m=Math.max(40,Math.round(u*.92)),y=s==="down"?m:-m,w=Math.max(0,c.scrollHeight-c.clientHeight),g=c.scrollTop,f=Math.max(0,Math.min(g+y,w));c.scrollTop=f;let h=l.top+d,b=Array.from(c.querySelectorAll(".block[data-block-id]"));if(!b.length)return;let S=b.map(A=>{let v=A.getAttribute("data-block-id")||"",B=A.getBoundingClientRect();return{id:v,rect:B}}).filter(A=>A.id);if(!S.length)return;let k=S.find(A=>A.rect.top>=h)||null;!k&&s==="down"&&(k=S[S.length-1]),!k&&s==="up"&&(k=S[0]),f===g&&a.currentBlockId&&(s==="down"?k=S[S.length-1]:k=S[0]),k&&k.id&&(a.scrollTargetBlockId=k.id,Kn(k.id,{scrollIntoView:!1}))},r=s=>{let c=p.blocksContainer;if(!c)return;let l=Array.from(c.querySelectorAll(".block[data-block-id]"));if(!l.length)return;let u=(s==="end"?l[l.length-1]:l[0]).getAttribute("data-block-id");u&&(a.scrollTargetBlockId=u,Kn(u,{scrollIntoView:!0,scrollBehavior:"auto"}))};if(!e.ctrlKey&&!e.shiftKey&&!e.altKey&&!e.metaKey){if(t==="PageDown"){e.preventDefault(),n("down");return}if(t==="PageUp"){e.preventDefault(),n("up");return}if(t==="Home"){e.preventDefault(),r("home");return}if(t==="End"){e.preventDefault(),r("end");return}}let o=e.ctrlKey&&!e.shiftKey&&t==="KeyZ",i=e.ctrlKey&&!e.shiftKey&&t==="KeyY";if(a.pendingTextPreview){if(a.pendingTextPreview.mode==="undo"&&o){e.preventDefault(),Do();return}if(a.pendingTextPreview.mode==="redo"&&i){e.preventDefault(),_o();return}if(t==="Escape"){e.preventDefault(),hr();return}e.preventDefault();return}if(o){e.preventDefault(),Do();return}if(i){e.preventDefault(),_o();return}if(e.ctrlKey&&e.shiftKey&&e.code==="ArrowDown"){e.preventDefault(),Zc("down");return}if(e.ctrlKey&&e.shiftKey&&e.code==="ArrowUp"){e.preventDefault(),Zc("up");return}if(e.ctrlKey&&!e.shiftKey&&e.code==="ArrowDown"){e.preventDefault();let s=a.articleId==="inbox"?"before":"after";zr(s);return}if(e.ctrlKey&&!e.shiftKey&&e.code==="ArrowUp"){e.preventDefault();let s=a.articleId==="inbox"?"after":"before";zr(s);return}if(e.ctrlKey&&e.code==="Delete"){e.preventDefault(),Ps();return}if(e.ctrlKey&&e.code==="ArrowRight"){e.preventDefault(),Jf();return}if(e.ctrlKey&&e.code==="ArrowLeft"){e.preventDefault(),Wf();return}if(e.code==="ArrowDown"){if(!e.ctrlKey&&e.shiftKey){e.preventDefault(),Ai(1);return}if(!e.ctrlKey&&!e.shiftKey){if(e.preventDefault(),!Mm("down")){let c=a.articleId==="inbox"?-1:1;ki(c)}return}}if(e.code==="ArrowUp"){if(!e.ctrlKey&&e.shiftKey){e.preventDefault(),Ai(-1);return}if(!e.ctrlKey&&!e.shiftKey){if(e.preventDefault(),!Mm("up")){let c=a.articleId==="inbox"?1:-1;ki(c)}return}}if(e.code==="ArrowLeft"){e.preventDefault();let s=$s(a.currentBlockId,!0);s&&(a.currentBlockId!==s&&Kn(s),so(s,!0));return}if(e.code==="ArrowRight"){e.preventDefault();let s=$s(a.currentBlockId,!1);s&&so(s,!1);return}e.code==="Enter"&&(e.preventDefault(),Ms())}vn();ar();Bo();function Pm(e){let t=typeof e.code=="string"?e.code:"",n=e.ctrlKey&&!e.shiftKey&&t==="KeyZ",r=e.ctrlKey&&!e.shiftKey&&t==="KeyY",o=e.ctrlKey&&e.shiftKey&&t==="KeyZ";if(n&&Po(-1)){e.preventDefault();return}if((r||o)&&Po(1)){e.preventDefault();return}if(e.ctrlKey&&!e.shiftKey&&e.code==="ArrowDown"){e.preventDefault(),Co();return}if(e.ctrlKey&&!e.shiftKey&&e.code==="ArrowUp"){e.preventDefault(),(async()=>(await bi(),await zr("before")))();return}if(e.code==="Enter"&&e.ctrlKey){e.preventDefault(),bi();return}if(e.code==="Tab"&&!e.ctrlKey&&!e.altKey&&!e.metaKey){e.preventDefault();return}if(e.ctrlKey&&e.code==="ArrowRight"){e.preventDefault(),zs({keepEditing:!0});return}if(e.ctrlKey&&e.code==="ArrowLeft"){e.preventDefault(),Us({keepEditing:!0});return}e.code==="Escape"&&(e.preventDefault(),Ns())}At();Vt();qn();En();zt();Xt();function Dm(e){let{code:t,ctrlKey:n,shiftKey:r,altKey:o,metaKey:i}=e;if(o||i||!p.articleListView||p.articleListView.classList.contains("hidden")||!p.articleList)return;let s=p.articleList,c=Array.from(s.querySelectorAll("li[data-article-id]"));if(!c.length)return;let l=a.listSelectedArticleId||a.articleId,d=l&&c.findIndex(g=>g.dataset.articleId===l),u=d!=null&&d>=0?d:0,m=g=>{if(!c.length)return;u=Math.max(0,Math.min(c.length-1,u+g));let f=c[u];if(!f)return;let h=f.dataset.articleId;h&&(a.listSelectedArticleId=h,an(),f.scrollIntoView({block:"nearest"}))},w=(()=>{if(a.listSelectedArticleId)return a.listSelectedArticleId;if(a.articleId)return a.articleId;let g=c[0];return g?g.dataset.articleId:null})();if(w){if(!n&&!r&&(t==="ArrowDown"||t==="ArrowUp")){e.preventDefault(),m(t==="ArrowDown"?1:-1);return}if(!n&&!r&&(t==="ArrowLeft"||t==="ArrowRight")){if(!(a.articlesIndex||[]).some(h=>(h.parentId||null)===w))return;e.preventDefault(),a.listCollapsedArticleIds||(a.listCollapsedArticleIds=[]);let f=new Set(a.listCollapsedArticleIds);t==="ArrowLeft"?f.has(w)||(f.add(w),a.listCollapsedArticleIds=Array.from(f),no(),an()):t==="ArrowRight"&&f.has(w)&&(f.delete(w),a.listCollapsedArticleIds=Array.from(f),no(),an());return}if(!n&&!r&&t==="Enter"){e.preventDefault(),a.listSelectedArticleId=w,It(wt.article(w));return}if(n&&r&&(t==="ArrowUp"||t==="ArrowDown")){e.preventDefault(),bu(w,t==="ArrowUp"?"up":"down").then(()=>Ir()).then(g=>an(g)).catch(g=>P(g.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443"));return}if(n&&!r&&t==="ArrowRight"){e.preventDefault(),wu(w).then(()=>Ir()).then(g=>an(g)).catch(g=>P(g.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u043D\u043E\u0441\u0442\u044C"));return}if(n&&!r&&t==="ArrowLeft"){e.preventDefault(),Su(w).then(()=>Ir()).then(g=>an(g)).catch(g=>P(g.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u043D\u043E\u0441\u0442\u044C"));return}}}At();Vt();En();function _m(){p.mobileSidebarBtn&&p.mobileSidebarBtn.addEventListener("click",e=>{e.preventDefault(),ro(!1),In(!0)}),p.listSidebarBtn&&p.listSidebarBtn.addEventListener("click",e=>{e.preventDefault(),ro(!1),In(!0)}),p.sidebarBackdrop&&p.sidebarBackdrop.addEventListener("click",()=>{mi()}),p.sidebar&&p.sidebar.addEventListener("click",e=>{if(!a.isSidebarMobileOpen)return;let t=e.target,n=(()=>{try{if(t&&typeof t.closest=="function")return t.closest("button");if(t&&t.parentElement&&typeof t.parentElement.closest=="function")return t.parentElement.closest("button")}catch{}return null})();n&&(n.closest(".sidebar-article-item")||p.userMenuBtn&&n===p.userMenuBtn||p.userMenu&&p.userMenu.contains(t)||p.sidebarSyncStatusPill&&(n===p.sidebarSyncStatusPill||n.id==="sidebarSyncStatusPill")||p.syncMenu&&p.syncMenu.contains(t)||p.sidebarRecentBtn&&n===p.sidebarRecentBtn||p.sidebarSearchViewToggle&&n===p.sidebarSearchViewToggle||p.searchModeToggle&&n===p.searchModeToggle||p.searchClearBtn&&n===p.searchClearBtn||mi())},!0),document.addEventListener("click",e=>{if(window.matchMedia("(min-width: 768px)").matches||!a.isSidebarMobileOpen||!p.sidebar)return;let n=e.target;p.sidebar.contains(n)||p.mobileSidebarBtn&&p.mobileSidebarBtn.contains(n)||mi()},!0)}var Pr=0,Ta=null,jl=!1,Jm="\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043F\u043E\u0438\u0441\u043A",Bw="\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F",Wm="ttree_sidebar_search_view_v1",Vm=null,Jl=!1;function Lw(){return Promise.resolve().then(()=>(Mr(),Lr))}function qm(){return Promise.resolve().then(()=>(Um(),zm))}function Ba(e){return e==="search"?"search":"list"}function Mw(){try{return Ba(localStorage.getItem(Wm)||"")}catch{return"list"}}function Nw(){try{localStorage.setItem(Wm,a.sidebarSearchView||"list")}catch{}}function Wl(){let e=Ba(a.sidebarSearchView),t=e==="search",n=t?"\u0424\u0438\u043B\u044C\u0442\u0440":"\u041F\u043E\u0438\u0441\u043A";if(p.sidebarSearchViewToggle){p.sidebarSearchViewToggle.dataset.view=e;let r=p.sidebarSearchViewToggle.querySelector("span")||p.sidebarSearchViewToggle;r.textContent=n;let o=t?"\u041F\u0435\u0440\u0435\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0432 \u0440\u0435\u0436\u0438\u043C \u0444\u0438\u043B\u044C\u0442\u0440\u0430 \u0441\u0442\u0430\u0442\u0435\u0439":"\u041F\u0435\u0440\u0435\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0432 \u0440\u0435\u0436\u0438\u043C \u043F\u043E\u0438\u0441\u043A\u0430";p.sidebarSearchViewToggle.setAttribute("title",o),p.sidebarSearchViewToggle.setAttribute("aria-label",o),p.sidebarSearchViewToggle.classList.toggle("search-panel__toggle--active",t)}p.searchModeToggle&&p.searchModeToggle.classList.toggle("hidden",!t),t||(xr(),p.ragOpenBtn&&p.ragOpenBtn.classList.add("hidden")),p.searchInput&&(p.searchInput.placeholder=t?a.searchMode==="semantic"?"\u0421\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A...":"\u041F\u043E\u0438\u0441\u043A...":"\u0424\u0438\u043B\u044C\u0442\u0440 \u0441\u0442\u0430\u0442\u0435\u0439\u2026")}function Pw(e,{persist:t=!0}={}){let n=Ba(e);a.sidebarSearchView!==n&&(a.sidebarSearchView=n,t&&Nw(),a.sidebarSearchView==="list"?(a.searchQuery="",a.searchResults=[],a.searchError="",a.searchLoading=!1,a.searchRequestId=0):(a.articleFilterQuery="",Pt(),kr()),Pr=0,Wl(),p.searchInput&&p.searchInput.dispatchEvent(new Event("input",{bubbles:!0})))}function Km(e){let t=new Map,n=[],r=c=>String(c||"").replace(/\u00a0/g," ").replace(/\r\n/g,`
`),o=(c,l=`
`)=>c.map(d=>r(d)).filter(Boolean).join(l),i=c=>{if(!c)return"";if(Array.isArray(c))return c.map(i).join("");if(c.type==="text")return r(c.text||"");if(c.type==="hardBreak")return`
`;if(c.type==="table"){let u=[];return(c.content||[]).forEach(m=>{if(m?.type!=="tableRow")return;let y=[];(m.content||[]).forEach(w=>{!w||w.type!=="tableCell"&&w.type!=="tableHeader"||y.push(i(w).trim())}),u.push(y.join("	"))}),`${u.join(`
`)}
`}let l=Array.isArray(c.content)?c.content:[],d=l.map(i).join("");if(c.type==="paragraph"||c.type==="heading")return`${d}
`;if(c.type==="bulletList")return`${l.filter(m=>m?.type==="listItem").map(m=>{let y=i(m).trimEnd();if(!y)return"";let w=y.split(`
`);return w[0]=`- ${w[0]}`,w.join(`
`)}).filter(Boolean).join(`
`)}
`;if(c.type==="orderedList"){let u=1;return`${l.filter(y=>y?.type==="listItem").map(y=>{let w=i(y).trimEnd();if(!w)return"";let g=w.split(`
`);return g[0]=`${u}. ${g[0]}`,u+=1,g.join(`
`)}).filter(Boolean).join(`
`)}
`}return d},s=c=>{if(c){if(Array.isArray(c)){c.forEach(s);return}if(c.type==="outlineSection"){let l=String(c?.attrs?.id||c?.attrs?.sectionId||""),d=(c.content||[]).find(f=>f?.type==="outlineHeading")||null,u=(c.content||[]).find(f=>f?.type==="outlineBody")||null,m=(c.content||[]).find(f=>f?.type==="outlineChildren")||null,y=r(i(d)).trim(),w=r(i(u)).trim(),g=o([y,w],`
`).trim();l&&(t.set(l,{indexText:g,label:y||l}),n.push(l)),m?.content&&s(m.content);return}c.content&&s(c.content)}};return s(e?.content||[]),{map:t,order:n}}function Ca(e){if(!p.semanticReindexBtn)return;let t=p.semanticReindexBtn.querySelector(".sidebar-user-menu-label");if(!t)return;if(e&&e.status==="running"){let r=Number(e.processed||0),o=Number(e.total||0),i=o>0?`${r}/${o}`:`${r}`;t.textContent=`${Bw}: ${i}`;return}let n="";if(e&&e.status==="cooldown"){let r=Number(e.cooldownRemainingSeconds||0);n=r>0?` (\u0447\u0435\u0440\u0435\u0437 ${Math.ceil(r/60)} \u043C\u0438\u043D)`:" (\u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u043F\u043E\u0437\u0436\u0435)"}else e&&e.status==="completed"&&(n=` (${e.indexed||0})`);t.textContent=`${Jm}${n}`}async function Dw(){if(p.semanticReindexBtn)try{let e=await fetch("/api/search/semantic/reindex/status",{method:"GET",credentials:"include"});if(!e.ok)return;let t=await e.json();Ca(t)}catch{}}function _w(e){let{key:t,ctrlKey:n,altKey:r,metaKey:o}=e;if(n||r||o)return!1;let i=e.target;if(Kl(i)||a.sidebarSearchView!=="list"||!p.sidebar||!p.searchInput||p.sidebar.classList.contains("hidden"))return!1;let s=p.searchInput;if(t==="Escape")return!a.articleFilterQuery&&!s.value?!1:(e.preventDefault(),a.articleFilterQuery="",s.value="",Pr=0,kr(),Pt(),!0);if(t.length!==1)return!1;e.preventDefault();let c=Date.now(),u=(!Pr||c-Pr>2e3?"":s.value||a.articleFilterQuery||"")+t;s.value=u,a.articleFilterQuery=u,Pt(),s.focus();try{let m=s.value.length;s.setSelectionRange(m,m)}catch{}return Pr=c,!0}async function Ow(e){if(!e)return null;let t;try{t=await e.text()}catch(l){return console.error("Failed to read HTML file",l),null}let n=t.indexOf('id="memus-export"'),r=n===-1?t.indexOf("id='memus-export'"):n;if(r===-1)return null;let o=t.lastIndexOf("<script",r),i=t.indexOf("<\/script>",r);if(o===-1||i===-1)return null;let s=t.indexOf(">",o)+1;if(s===0||s>i)return null;let c=t.slice(s,i).trim();if(!c)return null;try{let l=JSON.parse(c);return!l||typeof l!="object"||l.source!=="memus"||Number(l.version||0)!==1?null:l}catch(l){return console.error("Failed to parse memus-export JSON",l),null}}async function Rw(e){if(!e)return{exists:!1,article:null};try{let t=await fetch(`/api/articles/${encodeURIComponent(e)}`,{method:"GET",credentials:"include"});if(t.status===404)return{exists:!1,article:null};if(!t.ok){let r=await t.json().catch(()=>null),o=r&&r.detail||`\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0438 \u0441\u0442\u0430\u0442\u044C\u0438 (status ${t.status})`;throw new Error(o)}return{exists:!0,article:await t.json()}}catch(t){throw console.error("Failed to check article existence",t),t}}function Hw(e){let t=typeof e.lastModified=="number"&&e.lastModified>0?e.lastModified:Date.now(),n=new Date(t),r=o=>String(o).padStart(2,"0");return`ver_${n.getFullYear()}${r(n.getMonth()+1)}${r(n.getDate())}_${r(n.getHours())}${r(n.getMinutes())}${r(n.getSeconds())}`}async function jm(e,t,{allowApplyToAll:n}={allowApplyToAll:!1}){if(!e)return null;let r=await Ow(e),o=r&&r.article,i=o&&o.id||"",s=o&&o.title||e.name||"\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F",c=o&&o.createdAt||null,l=o&&o.updatedAt||null,d={exists:!1,article:null};if(i&&(d=await Rw(i).catch(y=>{throw Ft(y.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0440\u043E\u0432\u0435\u0440\u0438\u0442\u044C \u043D\u0430\u043B\u0438\u0447\u0438\u0435 \u0441\u0442\u0430\u0442\u044C\u0438"),y})),!d.exists||!i)return ds(e);let u=t&&t.decision,m=t&&t.applyToAll;if(!u||!m){let y=await hc({title:"\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0443\u0436\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442",message:"\u0427\u0442\u043E \u0441\u0434\u0435\u043B\u0430\u0442\u044C \u0441 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0435\u0439 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0435\u0439 \u043F\u0440\u0438 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0438?",existingTitle:d.article&&d.article.title,importedTitle:s,existingCreatedAt:d.article&&d.article.createdAt,existingUpdatedAt:d.article&&d.article.updatedAt,importedCreatedAt:c,importedUpdatedAt:l,allowApplyToAll:n});if(!y||!y.action)return null;u=y.action,m=!!y.applyToAll,t&&(t.decision=u,t.applyToAll=m)}if(u==="keep")return null;if(u==="overwrite")return ds(e,{mode:"overwrite"});if(u==="copy"){let y=Hw(e);return ds(e,{mode:"copy",versionPrefix:y})}return null}function Ym(e){!p.listMenu||!p.listMenuBtn||(p.listMenu.classList.toggle("hidden",!e),p.listMenuBtn.setAttribute("aria-expanded",e?"true":"false"))}function Go(){!p.listMenu||!p.listMenuBtn||p.listMenu.classList.contains("hidden")||Ym(!1)}function Yl(){a.sidebarSearchView=Mw(),Wl();let e=async()=>{if(!Jl){Jl=!0;try{let g=es();a.mediaPrefetchPaused=g;let f="";try{let{total:h,ok:b,error:S}=await Bd(a.articleId);h>0&&(f=`\u041C\u0435\u0434\u0438\u0430: ${b}/${h}`,S>0&&(f+=`, \u043E\u0448\u0438\u0431\u043E\u043A: ${S}`))}catch{}!f&&g&&(f="\u041C\u0435\u0434\u0438\u0430: \u043F\u0430\u0443\u0437\u0430"),f&&g&&(f+=" (\u043F\u0430\u0443\u0437\u0430)"),a.mediaStatusText=f,$n()}finally{Jl=!1}}};Vm||!p.mediaStatusText&&!p.mediaPrefetchToggleBtn||(e().catch(()=>{}),Vm=window.setInterval(()=>{e().catch(()=>{})},2e3));let n=!1,r=0,o=0,i=!1,s=()=>{try{return window?.localStorage?.getItem?.("ttree_debug_offline_v1")==="1"}catch{return!1}},c=()=>{try{let f=String(navigator?.userAgent||"");if(!/HuaweiBrowser/i.test(f))return!1}catch{return!1}let g=Date.now();return g-o<15e3?!1:(o=g,!0)},l=(g,f)=>{try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:g,data:f})}).catch(()=>{})}catch{}},d=async()=>{if(!n&&!(!p.sidebarSyncStatusPill&&!p.offlineStatusLabel&&!p.offlineFetchBtn&&!p.offlineRepairBtn)){n=!0;try{c()&&l("offline.ui.tick",{t:new Date().toISOString(),serverStatus:String(a.serverStatus||""),serverStatusText:String(a.serverStatusText||""),offlineReady:!!a.offlineReady,offlineInitStatus:String(a.offlineInitStatus||""),offlineInitError:String(a.offlineInitError||""),offlineInitStartedAt:a.offlineInitStartedAt||null,buildId:(()=>{try{return String(window.__BUILD_ID__||"")}catch{return""}})(),hasOfflineStatusLabel:!!p.offlineStatusLabel});let g=($e,at)=>{p.sidebarSyncStatusPill&&(p.sidebarSyncStatusPill.dataset.offline=$e,at&&(p.sidebarSyncStatusPill.dataset.offlineTitle=at,p.sidebarSyncStatusPill.title=at))};if(a.serverStatus==="auth"){let $e="\u0422\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044F \u0432\u0445\u043E\u0434";p.offlineStatusLabel&&(p.offlineStatusLabel.textContent=$e),p.offlineFetchBtn&&p.offlineFetchBtn.classList.add("hidden"),p.offlineRepairBtn&&p.offlineRepairBtn.classList.add("hidden"),g("auth",`\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 ${$e}`);return}let f=(()=>{try{return navigator?.onLine!==!1}catch{return!0}})();if(a.serverStatus==="down"&&!a.offlineReady){let $e=f?"\u041D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0430 \u043A \u0441\u0435\u0440\u0432\u0435\u0440\u0443":"\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430";p.offlineStatusLabel&&(p.offlineStatusLabel.textContent=$e),p.offlineFetchBtn&&p.offlineFetchBtn.classList.add("hidden"),p.offlineRepairBtn&&p.offlineRepairBtn.classList.add("hidden"),g("off",`\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 ${$e}`),c()&&l("offline.ui.not_ready",{t:new Date().toISOString(),reason:"server_down_no_offline",serverStatus:a.serverStatus,offlineReady:!!a.offlineReady,offlineInitStatus:String(a.offlineInitStatus||""),offlineInitError:String(a.offlineInitError||""),onLine:(()=>{try{return navigator?.onLine!==!1}catch{return null}})(),buildId:(()=>{try{return String(window.__BUILD_ID__||"")}catch{return""}})()});return}if(!a.offlineReady){let $e=String(a.offlineInitStatus||"idle"),at=String(a.offlineInitError||"").trim();if($e==="initializing"){let tn=Number(a.offlineInitStartedAt||0)||0,Nt=Date.now(),er=tn?Nt-tn:0;if(er>8e3&&Nt-r>8e3){r=Nt;try{s()&&console.warn("[offline] still initializing",{ms:er})}catch{}}p.offlineStatusLabel&&(p.offlineStatusLabel.textContent="\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0438\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0430\u0446\u0438\u044F\u2026"),p.offlineFetchBtn&&p.offlineFetchBtn.classList.add("hidden"),p.offlineRepairBtn&&p.offlineRepairBtn.classList.add("hidden"),g("loading","\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 \u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0438\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0430\u0446\u0438\u044F\u2026"),c()&&l("offline.ui.not_ready",{t:new Date().toISOString(),reason:"initializing",initStatus:$e,offlineInitError:at,offlineInitStartedAt:a.offlineInitStartedAt||null,buildId:(()=>{try{return String(window.__BUILD_ID__||"")}catch{return""}})()});return}let Dt=at?`\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E (${at})`:"\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E";if(p.offlineStatusLabel&&(p.offlineStatusLabel.textContent=Dt),p.offlineFetchBtn&&p.offlineFetchBtn.classList.add("hidden"),p.offlineRepairBtn){let tn=p.offlineRepairBtn,Nt=tn.querySelector(".sidebar-user-menu-label");tn.classList.remove("hidden"),Nt&&($e==="quota"?Nt.textContent="\u041E\u0441\u0432\u043E\u0431\u043E\u0434\u0438\u0442\u044C \u043C\u0435\u0441\u0442\u043E":$e==="blocked"?Nt.textContent="\u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C (\u0437\u0430\u043A\u0440\u044B\u0442\u044C \u0434\u0440\u0443\u0433\u0438\u0435 \u0432\u043A\u043B\u0430\u0434\u043A\u0438)":$e==="timeout"?Nt.textContent="\u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C":$e==="unavailable"?Nt.textContent="\u041F\u043E\u0434\u0440\u043E\u0431\u043D\u0435\u0435":Nt.textContent="\u0421\u0431\u0440\u043E\u0441\u0438\u0442\u044C \u043E\u0444\u0444\u043B\u0430\u0439\u043D\u2011\u043A\u044D\u0448")}g("off",`\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 ${Dt}`),c()&&l("offline.ui.not_ready",{t:new Date().toISOString(),reason:"not_ready",initStatus:$e,offlineInitError:at,serverStatus:a.serverStatus,onLine:(()=>{try{return navigator?.onLine!==!1}catch{return null}})(),buildId:(()=>{try{return String(window.__BUILD_ID__||"")}catch{return""}})()});return}let h=null;try{h=await Promise.race([Lm(),new Promise($e=>setTimeout(()=>$e(null),700))])}catch{h=null}if(!h){p.offlineStatusLabel&&(p.offlineStatusLabel.textContent="\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u2026"),p.offlineFetchBtn&&p.offlineFetchBtn.classList.remove("hidden"),p.offlineRepairBtn&&p.offlineRepairBtn.classList.add("hidden"),g("loading","\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 \u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u2026"),c()&&l("offline.ui.summary_pending",{t:new Date().toISOString(),serverStatus:a.serverStatus,offlineReady:!!a.offlineReady,buildId:(()=>{try{return String(window.__BUILD_ID__||"")}catch{return""}})()});return}let b=Number(h.articles?.total||0),S=Number(h.articles?.withDoc||0),k=Number(h.media?.total||0),A=Number(h.media?.ok||0),v=Number(h.media?.error||0),B=h.media?.errorKinds||null,H=b===0?!0:S>=b,O=k===0?!0:A>=k,W=H&&O&&v===0,J=Math.max(0,b-S),ne=Math.max(0,k-A);try{a.offlineArticlesTotal=Number.isFinite(b)?Math.max(0,b):null,a.offlineArticlesWithDoc=Number.isFinite(S)?Math.max(0,S):null}catch{}let me=ne>0&&B&&Number(B.noAccess||0)>0&&navigator.onLine,we=ml?.()||null,te=!!we?.running,he=Number(we?.processed||0),Je=Number(we?.total||0),vt=Number(we?.errors||0),Mt=String(we?.lastError||"").trim();if(W)p.offlineStatusLabel&&(p.offlineStatusLabel.textContent="\u041E\u0444\u0444\u043B\u0430\u0439\u043D \u0440\u0435\u0436\u0438\u043C OK"),p.offlineFetchBtn&&p.offlineFetchBtn.classList.add("hidden"),p.offlineRepairBtn&&p.offlineRepairBtn.classList.add("hidden"),g("ok","\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 \u041E\u0444\u0444\u043B\u0430\u0439\u043D OK");else{let $e=[];if(te?($e.push(`\u0434\u043E\u043A\u0430\u0447\u043A\u0430: ${he}/${Je||"\u2026"}`),vt>0&&$e.push(`\u043E\u0448\u0438\u0431\u043E\u043A: ${vt}`)):Mt&&$e.push(`\u043E\u0448\u0438\u0431\u043A\u0430: ${Mt}`),me&&$e.push("\u043D\u0443\u0436\u043D\u043E \u0432\u043E\u0439\u0442\u0438, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u043A\u0430\u0447\u0430\u0442\u044C \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0438"),b>0&&$e.push(`\u0441\u0442\u0430\u0442\u044C\u0438: ${S}/${b}`),k>0&&$e.push(`\u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0438: ${A}/${k}`),ne>0&&B){let Dt=Number(B.notFound||0),tn=Number(B.noAccess||0),Nt=Number(B.network||0);Dt>0?$e.push(`\u0431\u0438\u0442\u044B\u0435: ${Dt}`):tn>0?$e.push(`\u043D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0430: ${tn}`):Nt>0&&$e.push(`\u043E\u0448\u0438\u0431\u043A\u043E\u043A \u0441\u0435\u0442\u0438: ${Nt}`)}let at=$e.length?`\u041E\u0444\u0444\u043B\u0430\u0439\u043D: ${$e.join(" \xB7 ")}`:"\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0434\u043E\u043A\u0430\u0447\u043A\u0430\u2026";if(p.offlineStatusLabel&&(p.offlineStatusLabel.textContent=at),p.offlineFetchBtn){let Dt=!!a.mediaPrefetchPaused,tn=!te&&!me&&(Dt||J>0||ne>0);p.offlineFetchBtn.classList.toggle("hidden",!tn);try{let Nt=p.offlineFetchBtn.querySelector(".sidebar-user-menu-label");Nt&&(Dt?Nt.textContent="\u0412\u043E\u0437\u043E\u0431\u043D\u043E\u0432\u0438\u0442\u044C \u0434\u043E\u043A\u0430\u0447\u043A\u0443":ne>0&&v>0?Nt.textContent="\u041F\u043E\u0432\u0442\u043E\u0440\u0438\u0442\u044C \u0434\u043E\u043A\u0430\u0447\u043A\u0443":Nt.textContent="\u0414\u043E\u043A\u0430\u0447\u0430\u0442\u044C \u0441\u0435\u0439\u0447\u0430\u0441")}catch{}}p.offlineRepairBtn&&p.offlineRepairBtn.classList.add("hidden"),g("loading",`\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 ${at}`)}}finally{n=!1}}},u=async()=>{if(!i&&p.sidebarSyncStatusPill){i=!0;try{let g=p.sidebarSyncStatusPill,f="offline";if(a.serverStatus==="auth")f="auth";else if(a.serverStatus==="ok")f="online";else try{f=navigator?.onLine===!1?"offline":"online"}catch{f="offline"}let h=null;if(a.offlineReady)try{h=await Promise.race([Dd(),new Promise(v=>setTimeout(()=>v(null),300))]),Number.isFinite(Number(h))||(h=null),h=h==null?null:Number(h)||0}catch{h=null}try{a.outboxCount=h==null?null:Number(h)||0}catch{}let b=h!=null&&h>0?"dirty":"clean",S="";f==="auth"?S=h!=null&&h>0?`\u0412\u0445\u043E\u0434 \xB7 ${h}`:"\u0412\u0445\u043E\u0434":f==="online"?S=h!=null&&h>0?`\u0421\u0438\u043D\u0445\u0440\u2026 ${h}`:"\u041E\u043D\u043B\u0430\u0439\u043D":S=h!=null&&h>0?`\u041E\u0444\u0444\u043B\u0430\u0439\u043D \xB7 ${h}`:"\u041E\u0444\u0444\u043B\u0430\u0439\u043D",g.dataset.net=f,g.dataset.sync=b,g.textContent=S;let k=String(g.dataset.offlineTitle||"").trim(),A=h!=null&&h>0?`\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439: ${h}`:f==="online"?"\u041E\u043D\u043B\u0430\u0439\u043D: \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u043D\u043E":f==="auth"?"\u0422\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044F \u0432\u0445\u043E\u0434":"\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439 \u043D\u0435\u0442";if(g.title=k?`${A} \xB7 ${k}`:A,p.syncMenuStatusLabel&&(p.syncMenuStatusLabel.textContent=f==="online"?"\u0421\u0442\u0430\u0442\u0443\u0441: \u043E\u043D\u043B\u0430\u0439\u043D":f==="auth"?"\u0421\u0442\u0430\u0442\u0443\u0441: \u0442\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044F \u0432\u0445\u043E\u0434":"\u0421\u0442\u0430\u0442\u0443\u0441: \u043E\u0444\u0444\u043B\u0430\u0439\u043D"),p.syncMenuArticlesLabel){let v=a.offlineArticlesWithDoc,B=a.offlineArticlesTotal;if(f==="auth")p.syncMenuArticlesLabel.textContent="\u0421\u0442\u0430\u0442\u044C\u0438: \u0442\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044F \u0432\u0445\u043E\u0434";else if(Number.isFinite(B)&&B>0&&Number.isFinite(v)){let H=Math.max(0,Math.min(100,Math.round(Number(v)/Number(B)*100)));p.syncMenuArticlesLabel.textContent=`\u0421\u0442\u0430\u0442\u044C\u0438: ${v}/${B} (${H}%)`}else p.syncMenuArticlesLabel.textContent="\u0421\u0442\u0430\u0442\u044C\u0438: \u2014"}p.syncMenuOutboxLabel&&(p.syncMenuOutboxLabel.textContent=h==null?"\u041E\u0447\u0435\u0440\u0435\u0434\u044C: \u2014":h>0?`\u041E\u0447\u0435\u0440\u0435\u0434\u044C: ${h}`:"\u041E\u0447\u0435\u0440\u0435\u0434\u044C: \u043F\u0443\u0441\u0442\u043E")}finally{i=!1}}};d().catch(()=>{}),u().catch(()=>{}),window.setInterval(()=>{d().catch(()=>{}),u().catch(()=>{})},4e3),window.addEventListener("offline-full-pull-status",()=>{d().catch(()=>{})}),window.addEventListener("media-prefetch-paused",()=>{e().catch(()=>{}),d().catch(()=>{}),u().catch(()=>{})}),window.addEventListener("online",()=>{e().catch(()=>{}),d().catch(()=>{}),u().catch(()=>{})}),window.addEventListener("offline",()=>{e().catch(()=>{}),d().catch(()=>{}),u().catch(()=>{})}),window.addEventListener("offline-outbox-changed",()=>{u().catch(()=>{})}),p.sidebarSyncStatusPill&&p.syncMenu&&p.sidebarSyncStatusPill.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation();let f=!p.syncMenu.classList.contains("hidden");try{p.userMenu?.classList.add("hidden"),p.userMenuBtn?.setAttribute("aria-expanded","false")}catch{}f?(p.syncMenu.classList.add("hidden"),p.sidebarSyncStatusPill.setAttribute("aria-expanded","false")):(p.syncMenu.classList.remove("hidden"),p.sidebarSyncStatusPill.setAttribute("aria-expanded","true"),u().catch(()=>{}),d().catch(()=>{}))}),p.mediaPrefetchToggleBtn&&p.mediaPrefetchToggleBtn.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),Cd(),e().catch(()=>{})}),p.offlineFetchBtn&&p.offlineFetchBtn.addEventListener("click",async g=>{g.preventDefault(),g.stopPropagation();try{if(!a.offlineReady){P("Offline \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0432 \u044D\u0442\u043E\u043C \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435");return}Wa(!1),Ld({maxFailCountOnly:!0}).catch(()=>{});try{ts()}catch{}Bi({force:!0}),P("\u0414\u043E\u043A\u0430\u0447\u0438\u0432\u0430\u0435\u043C \u043E\u0444\u043B\u0430\u0439\u043D\u2011\u0434\u0430\u043D\u043D\u044B\u0435 \u0432 \u0444\u043E\u043D\u0435\u2026"),p.syncMenu?.classList.add("hidden"),p.sidebarSyncStatusPill?.setAttribute("aria-expanded","false"),d().catch(()=>{})}catch(f){P(f?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u0434\u043E\u043A\u0430\u0447\u043A\u0443")}}),p.offlineRepairBtn&&p.offlineRepairBtn.addEventListener("click",async g=>{g.preventDefault(),g.stopPropagation();let f=String(a.offlineInitStatus||"").trim();if(f==="blocked"||f==="timeout"){try{window.location.reload()}catch{}return}if(f==="quota"){P("\u041C\u0430\u043B\u043E \u043C\u0435\u0441\u0442\u0430 \u0434\u043B\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u043A\u044D\u0448\u0430. \u041E\u0441\u0432\u043E\u0431\u043E\u0434\u0438\u0442\u0435 \u043C\u0435\u0441\u0442\u043E \u0432 \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435/\u041E\u0421 \u0438\u043B\u0438 \u043E\u0447\u0438\u0441\u0442\u0438\u0442\u0435 \u043A\u044D\u0448 \u043A\u0430\u0440\u0442\u0438\u043D\u043E\u043A.");return}if(f==="unavailable"){P(String(a.offlineInitError||"\u041E\u0444\u0444\u043B\u0430\u0439\u043D \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0432 \u044D\u0442\u043E\u043C \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435"));return}try{P("\u0421\u0431\u0440\u0430\u0441\u044B\u0432\u0430\u0435\u043C \u043E\u0444\u0444\u043B\u0430\u0439\u043D\u2011\u043A\u044D\u0448\u2026"),await wd()}catch{}try{window.location.reload()}catch{}}),document.addEventListener("keydown",g=>{a.isOutlineEditing||_w(g)||(a.mode==="view"?(Dm(g),Nm(g)):Pm(g))}),document.addEventListener("beforeinput",g=>{if(!a.isOutlineEditing&&(g.inputType==="historyUndo"||g.inputType==="historyRedo")){if(a.mode==="edit"&&a.editingBlockId&&g.target instanceof HTMLElement&&g.target.closest('.block-text[contenteditable="true"]')){g.preventDefault();let h=g.inputType==="historyUndo"?-1:1;Po(h);return}g.preventDefault(),g.inputType==="historyUndo"?Do():_o()}},!0),document.addEventListener("paste",Sf),p.createArticleBtn&&p.createArticleBtn.addEventListener("click",()=>{Ui(),a.isSidebarMobileOpen&&In(!1)}),p.sidebarNewArticleBtn&&p.sidebarNewArticleBtn.addEventListener("click",()=>{Ui(),a.isSidebarMobileOpen&&In(!1)}),p.openInboxBtn&&p.openInboxBtn.addEventListener("click",()=>{Ia(),a.isSidebarMobileOpen&&In(!1)}),p.quickNoteAddBtn&&p.quickNoteAddBtn.addEventListener("click",()=>{Ea(),a.isSidebarMobileOpen&&In(!1)}),p.backToList&&p.backToList.addEventListener("click",()=>It(wt.list)),p.sidebarRecentBtn&&p.sidebarRecentBtn.addEventListener("click",()=>{Nc()});let m=g=>{if(Ba(a.sidebarSearchView)==="search"){Hu(g);return}a.searchQuery="",a.searchResults=[],a.searchError="",a.searchLoading=!1,a.searchRequestId=0,xr(),p.ragOpenBtn&&p.ragOpenBtn.classList.add("hidden"),As(g)};p.searchInput&&(p.searchInput.addEventListener("input",m),p.searchInput.addEventListener("focus",()=>{a.sidebarSearchView==="search"&&a.searchQuery.trim()&&to()})),p.sidebarSearchViewToggle&&p.sidebarSearchViewToggle.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation();let f=a.sidebarSearchView==="search"?"list":"search";Pw(f),p.searchInput&&p.searchInput.focus({preventScroll:!0})});let y=()=>{!p.searchClearBtn||!p.searchInput||p.searchClearBtn.classList.toggle("hidden",!(p.searchInput.value||"").trim())};p.searchInput&&(p.searchInput.addEventListener("input",y),p.searchInput.addEventListener("focus",y),y()),p.searchClearBtn&&p.searchInput&&p.searchClearBtn.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),p.searchInput.value="",p.searchInput.focus({preventScroll:!0}),p.searchInput.dispatchEvent(new Event("input",{bubbles:!0})),y()}),p.ragOpenBtn&&p.ragOpenBtn.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),$u()});let w=()=>{if(!p.searchModeToggle)return;let g=a.searchMode==="semantic";p.searchModeToggle.classList.toggle("search-panel__toggle--active",g),p.searchModeToggle.dataset.mode=g?"semantic":"classic",p.searchModeToggle.setAttribute("title",g?"\u0421\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A \u0432\u043A\u043B\u044E\u0447\u0451\u043D":"\u041F\u0435\u0440\u0435\u043A\u043B\u044E\u0447\u0438\u0442\u044C\u0441\u044F \u043D\u0430 \u0441\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A"),p.searchModeToggle.setAttribute("aria-label",g?"\u0421\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A":"\u041A\u043B\u0430\u0441\u0441\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A"),Wl()};if(p.searchModeToggle&&(p.searchModeToggle.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),a.searchMode=a.searchMode==="semantic"?"classic":"semantic",w(),p.searchInput&&p.searchInput.dispatchEvent(new Event("input",{bubbles:!0}))}),w()),p.editTitleBtn&&p.editTitleBtn.addEventListener("click",va),p.articleTitle&&(p.articleTitle.addEventListener("dblclick",va),p.articleTitle.addEventListener("click",km),p.articleTitle.draggable=!0,p.articleTitle.addEventListener("dragstart",g=>{a.articleId&&(g.dataTransfer&&(g.dataTransfer.effectAllowed="move",g.dataTransfer.setData("text/plain",a.articleId)),window.__ttreeDraggingArticleId=a.articleId)}),p.articleTitle.addEventListener("dragend",()=>{window.__ttreeDraggingArticleId=null})),p.articleMenuBtn&&p.articleMenuBtn.addEventListener("click",Tm),p.articleFavoriteBtn&&p.articleFavoriteBtn.addEventListener("click",g=>{g.stopPropagation(),!(!a.article||!a.article.id||a.article.id==="inbox")&&(vo(a.article.id),$n())}),p.listMenuBtn&&p.listMenu&&(p.listMenuBtn.addEventListener("click",g=>{g.stopPropagation();let f=p.listMenu.classList.contains("hidden");Ym(f)}),document.addEventListener("click",g=>{let f=g.target;!p.listMenu||p.listMenu.classList.contains("hidden")||p.listMenu.contains(f)||p.listMenuBtn.contains(f)||Go()},!0)),p.articleEncryptionBtn&&p.articleEncryptionBtn.addEventListener("click",g=>{g.stopPropagation(),Bs()}),p.articleEncryptionRemoveBtn&&p.articleEncryptionRemoveBtn.addEventListener("click",g=>{g.stopPropagation(),Ls()}),p.articlePublicLinkBtn&&p.articlePublicLinkBtn.addEventListener("click",async g=>{if(g.stopPropagation(),!a.article||!a.article.publicSlug){P("\u0421\u0434\u0435\u043B\u0430\u0439\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u043E\u0439, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443");return}let f=a.article.publicSlug,h=`${window.location.origin}/p/${encodeURIComponent(f)}`;await ps({url:h})}),p.articlePublicToggleBtn&&p.articlePublicToggleBtn.addEventListener("click",async g=>{if(g.stopPropagation(),Nr(),!a.article||!a.articleId){P("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}if(!a.currentUser){P("\u041D\u0443\u0436\u043D\u043E \u0432\u043E\u0439\u0442\u0438 \u0432 \u0441\u0438\u0441\u0442\u0435\u043C\u0443");return}let f=!a.article.publicSlug;try{let b=(await He(`/api/articles/${a.articleId}/public`,{method:"POST",body:JSON.stringify({public:f})})).publicSlug||null;if(a.article={...a.article,publicSlug:b},p.articlePublicToggleBtn&&(p.articlePublicToggleBtn.textContent=b?"\u041E\u0442\u043C\u0435\u043D\u0438\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435":"\u0414\u0430\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435"),$n(),f&&b){let S=`${window.location.origin}/p/${encodeURIComponent(b)}`;await ps({url:S})}else f||P("\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u044B\u0439 \u0434\u043E\u0441\u0442\u0443\u043F \u043A \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0435 \u0432\u044B\u043A\u043B\u044E\u0447\u0435\u043D")}catch(h){P(h.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u044B\u0439 \u0434\u043E\u0441\u0442\u0443\u043F")}}),p.exportArticleBtn&&p.exportArticleBtn.addEventListener("click",async g=>{g.stopPropagation(),Nr();try{let{exportCurrentArticleAsHtml:f}=await qm();f?.()}catch{P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C")}}),p.saveVersionBtn&&p.saveVersionBtn.addEventListener("click",async g=>{if(g.stopPropagation(),Nr(),!!a.articleId)try{let f=await xn({title:"\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0432\u0435\u0440\u0441\u0438\u044E",message:"\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0432\u0435\u0440\u0441\u0438\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u044B\u043C)",placeholder:"\u041D\u0430\u043F\u0440\u0438\u043C\u0435\u0440: \u043F\u0435\u0440\u0435\u0434 \u0440\u0435\u0444\u0430\u043A\u0442\u043E\u0440\u0438\u043D\u0433\u043E\u043C",confirmText:"\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",allowEmpty:!0});if(f===null)return;Ft("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C \u0432\u0435\u0440\u0441\u0438\u044E\u2026"),await hu(a.articleId,(f||"").trim()||null),bt(),P("\u0412\u0435\u0440\u0441\u0438\u044F \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0430")}catch(f){bt(),P(f?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0432\u0435\u0440\u0441\u0438\u044E")}}),p.versionsBtn&&p.versionsBtn.addEventListener("click",async g=>{if(g.stopPropagation(),Nr(),!!a.articleId){if(a.article?.encrypted){P("\u0421\u0440\u0430\u0432\u043D\u0435\u043D\u0438\u0435 \u0432\u0435\u0440\u0441\u0438\u0439 \u043F\u043E\u043A\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0434\u043B\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0445 \u0441\u0442\u0430\u0442\u0435\u0439");return}try{Ft("\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0432\u0435\u0440\u0441\u0438\u0438\u2026");let f=await gu(a.articleId);bt();let h=Array.isArray(f?.versions)?f.versions:[],b=await cc({versions:h});if(!b)return;let S=typeof b=="string"?{action:"restore",versionId:b}:b;if(!S||!S.versionId)return;let{action:k,versionId:A}=S;if(k==="compare"){let H=$e=>{try{let at=new Date($e);return Number.isNaN(at.getTime())?String($e||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(at)}catch{return String($e||"")}},O=$e=>{let at=h.find(Dt=>String(Dt?.id||"")===String($e));return String(at&&(at?.label||H(at?.created_at||at?.createdAt))||$e)},W=await lc({versions:h,excludeId:A});if(!W)return;Ft("\u0421\u0440\u0430\u0432\u043D\u0438\u0432\u0430\u0435\u043C\u2026");let J=await ic(a.articleId,A),ne=J?.docJson||J?.doc_json||null,me=null,we=`\u0412\u0435\u0440\u0441\u0438\u044F: ${O(A)}`,te="\u0422\u0435\u043A\u0443\u0449\u0430\u044F";if(W.target==="current")me=a.article?.docJson||a.article?.doc_json||null;else{let $e=await ic(a.articleId,W.versionId);me=$e?.docJson||$e?.doc_json||null,te=`\u0412\u0435\u0440\u0441\u0438\u044F: ${O(W.versionId)}`}bt();let he=Km(ne||{}),Je=Km(me||{}),vt=[],Mt=new Set;he.order.forEach($e=>{Mt.add($e);let at=he.map.get($e),Dt=Je.map.get($e);if(!Dt){vt.push({type:"removed",id:$e,label:at?.label||$e,before:at?.indexText||"",after:""});return}(at?.indexText||"")!==(Dt?.indexText||"")&&vt.push({type:"changed",id:$e,label:Dt?.label||at?.label||$e,before:at?.indexText||"",after:Dt?.indexText||""})}),Je.order.forEach($e=>{if(Mt.has($e))return;let at=Je.map.get($e);vt.push({type:"added",id:$e,label:at?.label||$e,before:"",after:at?.indexText||""})}),await dc({title:"\u041E\u0442\u043B\u0438\u0447\u0438\u044F",beforeTitle:we,afterTitle:te,changes:vt});return}if(!await Vn({title:"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0432\u0435\u0440\u0441\u0438\u044E?",message:"\u0422\u0435\u043A\u0443\u0449\u0435\u0435 \u0441\u043E\u0434\u0435\u0440\u0436\u0438\u043C\u043E\u0435 \u0441\u0442\u0430\u0442\u044C\u0438 \u0431\u0443\u0434\u0435\u0442 \u0437\u0430\u043C\u0435\u043D\u0435\u043D\u043E \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0439 \u0432\u0435\u0440\u0441\u0438\u0435\u0439.",confirmText:"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"}))return;let B=!!a.isOutlineEditing;if(Ft("\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C\u2026"),await yu(a.articleId,A),await nn(a.articleId,{resetUndoStacks:!0}),B){let{closeOutlineEditor:H,openOutlineEditor:O}=await Lw();H?.(),await O?.()}else st("events.restoreVersion.fullRender");bt(),P("\u0412\u0435\u0440\u0441\u0438\u044F \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0430")}catch(f){bt(),P(f?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0432\u0435\u0440\u0441\u0438\u0438")}}}),p.blockHistoryBtn&&p.blockHistoryBtn.addEventListener("click",async g=>{if(g.stopPropagation(),Nr(),!(!a.articleId||!a.article)){if(a.article.encrypted){P("\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0431\u043B\u043E\u043A\u043E\u0432 \u043F\u043E\u043A\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0434\u043B\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0445 \u0441\u0442\u0430\u0442\u0435\u0439");return}try{let f=a.currentBlockId||null;if(a.isOutlineEditing)try{let B=await Promise.resolve().then(()=>(Mr(),Lr));B?.getOutlineActiveSectionId&&(f=B.getOutlineActiveSectionId()||f)}catch{}if(!f){P("\u041D\u0435 \u0432\u044B\u0431\u0440\u0430\u043D \u0431\u043B\u043E\u043A");return}Ft("\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0438\u0441\u0442\u043E\u0440\u0438\u044E\u2026");let h=await He(`/api/articles/${encodeURIComponent(a.articleId)}/blocks/${encodeURIComponent(f)}/history?limit=200`);bt();let S=(Array.isArray(h?.entries)?h.entries:[]).map(B=>({...B,beforePlain:String(B.beforePlain??B.before??""),afterPlain:String(B.afterPlain??B.after??"")})),k=await uc({title:"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0431\u043B\u043E\u043A\u0430",entries:S,canRestore:!0,beforeTitle:"\u0414\u043E",afterTitle:"\u041F\u043E\u0441\u043B\u0435"});if(!k||k.action!=="restore"||!k.entry||!await Vn({title:"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0431\u043B\u043E\u043A?",message:"\u0411\u043B\u043E\u043A \u0431\u0443\u0434\u0435\u0442 \u0437\u0430\u043C\u0435\u043D\u0451\u043D \u043D\u0430 \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u043F\u043E\u0441\u043B\u0435 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F.",confirmText:"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"}))return;if(a.isOutlineEditing){let B=await Promise.resolve().then(()=>(Mr(),Lr)),H={heading:k.entry.afterHeadingJson||null,body:k.entry.afterBodyJson||null};if(B?.restoreOutlineSectionFromSectionFragments){if(B.restoreOutlineSectionFromSectionFragments(f,H)){P("\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u043E (\u0431\u0443\u0434\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438)");return}if(B?.insertOutlineSectionFromSectionFragmentsAtEnd){if(!await Vn({title:"\u0411\u043B\u043E\u043A \u0443\u0434\u0430\u043B\u0451\u043D",message:"\u0421\u0435\u043A\u0446\u0438\u044F \u0441 \u044D\u0442\u0438\u043C ID \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430 \u0432 \u0442\u0435\u043A\u0443\u0449\u0435\u0439 \u0441\u0442\u0430\u0442\u044C\u0435. \u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u043D\u0443\u044E \u0441\u0435\u043A\u0446\u0438\u044E \u0432 \u043A\u043E\u043D\u0435\u0446 \u0441\u0442\u0430\u0442\u044C\u0438?",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u043D\u0435\u0446",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"}))return;if(B.insertOutlineSectionFromSectionFragmentsAtEnd(f,H)){P("\u0412\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u043E \u0432 \u043A\u043E\u043D\u0435\u0446 (\u0431\u0443\u0434\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438)");return}}P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C: \u0441\u0435\u043A\u0446\u0438\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}}let v=String(k.entry.after||"");Ft("\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C\u2026"),await He(`/api/articles/${encodeURIComponent(a.articleId)}/blocks/${encodeURIComponent(f)}`,{method:"PATCH",body:JSON.stringify({text:v})}),bt(),await nn(a.articleId,{desiredBlockId:f,resetUndoStacks:!0}),st("events.blockHistory.restore.fullRender"),P("\u0411\u043B\u043E\u043A \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D")}catch(f){bt(),P(f?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0441\u0442\u043E\u0440\u0438\u044E \u0431\u043B\u043E\u043A\u0430")}}}),p.articleHistoryBtn&&p.articleHistoryBtn.addEventListener("click",async g=>{if(g.stopPropagation(),Nr(),!(!a.articleId||!a.article)){if(a.article.encrypted){P("\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u043E\u043A\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0434\u043B\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0445 \u0441\u0442\u0430\u0442\u0435\u0439");return}try{let f=Array.isArray(a.article.history)?a.article.history:[];if(!f.length){Ft("\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0438\u0441\u0442\u043E\u0440\u0438\u044E\u2026");let b=await ru(a.articleId);bt(),a.article&&a.articleId&&(a.article.history=Array.isArray(b?.history)?b.history:[],a.article.redoHistory=Array.isArray(b?.redoHistory)?b.redoHistory:[],a.article.blockTrash=Array.isArray(b?.blockTrash)?b.blockTrash:[]),f=Array.isArray(a.article?.history)?a.article.history:[]}let h=f.filter(b=>b&&(b.beforeHeadingJson||b.beforeBodyJson||b.afterHeadingJson||b.afterBodyJson));await fc({title:"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0441\u0442\u0430\u0442\u044C\u0438",entries:h,canRestore:!0,beforeTitle:"\u0414\u043E",afterTitle:"\u041F\u043E\u0441\u043B\u0435",onRestore:async b=>{try{if(!a.articleId||!a.article)return;let S=String(b?.blockId||"").trim();if(!S){P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C: \u043D\u0435\u0442 ID \u0441\u0435\u043A\u0446\u0438\u0438");return}if(!await Vn({title:"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C?",message:"\u0415\u0441\u043B\u0438 \u0441\u0435\u043A\u0446\u0438\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430, \u043E\u043D\u0430 \u0431\u0443\u0434\u0435\u0442 \u0432\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u0430 \u0432 \u043A\u043E\u043D\u0435\u0446 \u0441\u0442\u0430\u0442\u044C\u0438.",confirmText:"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"}))return;if(!a.isOutlineEditing){P("\u041E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 outline-\u0440\u0435\u0436\u0438\u043C, \u0447\u0442\u043E\u0431\u044B \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u0435\u043A\u0446\u0438\u044E");return}let A=await Promise.resolve().then(()=>(Mr(),Lr)),v={heading:b.afterHeadingJson||null,body:b.afterBodyJson||null};if(A?.restoreOutlineSectionFromSectionFragments&&A.restoreOutlineSectionFromSectionFragments(S,v)){P("\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u043E (\u0431\u0443\u0434\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438)");return}if(A?.insertOutlineSectionFromSectionFragmentsAtEnd&&A.insertOutlineSectionFromSectionFragmentsAtEnd(S,v)){P("\u0412\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u043E \u0432 \u043A\u043E\u043D\u0435\u0446 (\u0431\u0443\u0434\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438)");return}P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u0435\u043A\u0446\u0438\u044E")}catch(S){P(S?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u0435\u043A\u0446\u0438\u044E")}}})}catch(f){P(f?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0438\u0441\u0442\u043E\u0440\u0438\u044E \u0441\u0442\u0430\u0442\u044C\u0438")}}}),p.exportCurrentBlockBtn&&p.exportCurrentBlockBtn.addEventListener("click",async g=>{g.preventDefault();try{let{exportCurrentBlockAsHtml:f}=await qm();await f?.()}catch{P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C")}}),p.exportAllHtmlZipBtn&&p.exportAllHtmlZipBtn.addEventListener("click",async g=>{g.stopPropagation(),Go();try{Ft("\u0413\u043E\u0442\u043E\u0432\u0438\u043C \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u0443\u044E \u043A\u043E\u043F\u0438\u044E (ZIP)...");let f=await fetch("/api/export/html-zip",{method:"GET"});if(!f.ok){bt(),P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u0443\u044E \u043A\u043E\u043F\u0438\u044E");return}if(f.status===204){bt(),P("\u041D\u0435\u0442 \u0441\u0442\u0440\u0430\u043D\u0438\u0446 \u0434\u043B\u044F \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438");return}let h=await f.blob();if(!h||h.size===0){bt(),P("\u041D\u0435\u0442 \u0434\u0430\u043D\u043D\u044B\u0445 \u0434\u043B\u044F \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438 (\u043F\u0443\u0441\u0442\u043E\u0439 \u0430\u0440\u0445\u0438\u0432)");return}let b=URL.createObjectURL(h),S=document.createElement("a"),k=f.headers.get("Content-Disposition")||"",A="memus-backup.zip",v=k.match(/filename=\"?([^\";]+)\"?/i);v&&v[1]&&(A=v[1]),S.href=b,S.download=A,S.rel="noopener",document.body.appendChild(S),bt(),S.click(),document.body.removeChild(S),setTimeout(()=>URL.revokeObjectURL(b),0),P("\u0420\u0435\u0437\u0435\u0440\u0432\u043D\u0430\u044F \u043A\u043E\u043F\u0438\u044F \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u0430")}catch(f){bt(),P(f.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u0443\u044E \u043A\u043E\u043F\u0438\u044E")}}),p.importArticleBtn&&p.importArticleBtn.addEventListener("click",async g=>{g.stopPropagation(),Go();try{let f=document.createElement("input");f.type="file",f.accept=".html,text/html",f.multiple=!1,f.addEventListener("change",async()=>{let h=f.files&&f.files[0];if(h)try{Ft("\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0438 \u043E\u0431\u0440\u0430\u0431\u0430\u0442\u044B\u0432\u0430\u0435\u043C HTML...");let S=await jm(h,{decision:null,applyToAll:!1},{allowApplyToAll:!1});bt(),S&&S.id?(It(wt.article(S.id)),P("\u0421\u0442\u0430\u0442\u044C\u044F \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0430")):P("\u0418\u043C\u043F\u043E\u0440\u0442 \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u043B\u0441\u044F \u0431\u0435\u0437 \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u0430")}catch(b){bt(),Ft(b.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C HTML")}}),f.click()}catch(f){P(f.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u0438\u043C\u043F\u043E\u0440\u0442")}}),p.importMarkdownBtn&&p.importMarkdownBtn.addEventListener("click",async g=>{g.stopPropagation(),Go();try{let f="";try{let b=window.localStorage.getItem("logseqAssetsBaseUrl")||"";f=await xn({title:"\u0410\u0434\u0440\u0435\u0441 assets \u0434\u043B\u044F Markdown",message:"\u0415\u0441\u043B\u0438 \u0432 \u0444\u0430\u0439\u043B\u0435 \u0435\u0441\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0438 \u0432\u0438\u0434\u0430 ../assets/..., \u0443\u043A\u0430\u0436\u0438 \u0431\u0430\u0437\u043E\u0432\u044B\u0439 URL, \u0433\u0434\u0435 \u043B\u0435\u0436\u0430\u0442 \u044D\u0442\u0438 \u0444\u0430\u0439\u043B\u044B (\u043D\u0430\u043F\u0440\u0438\u043C\u0435\u0440 https://prismatic-salamander-2afe94.netlify.app). \u0412\u043D\u0443\u0442\u0440\u0438 \u043D\u0435\u0433\u043E \u0431\u0443\u0434\u0443\u0442 \u0438\u0441\u043A\u0430\u0442\u044C\u0441\u044F \u0444\u0430\u0439\u043B\u044B \u0432 \u043A\u043E\u0440\u043D\u0435 \u0438\u043B\u0438 \u0432 \u043F\u043E\u0434\u043F\u0430\u043F\u043A\u0435 /assets.",confirmText:"\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"https://example.netlify.app",defaultValue:b})}catch{return}if(f=(f||"").trim(),f)try{window.localStorage.setItem("logseqAssetsBaseUrl",f)}catch{}let h=document.createElement("input");h.type="file",h.accept=".md,text/markdown,text/plain",h.multiple=!1,h.addEventListener("change",async()=>{let b=h.files&&h.files[0];if(b)try{Ft("\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0438 \u043E\u0431\u0440\u0430\u0431\u0430\u0442\u044B\u0432\u0430\u0435\u043C Markdown...");let S=await xu(b,f);bt(),S&&S.id?(It(wt.article(S.id)),P("\u0421\u0442\u0430\u0442\u044C\u044F \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0430 \u0438\u0437 Markdown")):P("\u0418\u043C\u043F\u043E\u0440\u0442 \u0438\u0437 Markdown \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u043B\u0441\u044F \u0431\u0435\u0437 \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u0430")}catch(S){bt(),Ft(S.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C Markdown")}}),h.click()}catch(f){P(f.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u0438\u043C\u043F\u043E\u0440\u0442 Markdown")}}),p.importBackupFolderBtn&&p.importBackupFolderBtn.addEventListener("click",async g=>{g.stopPropagation(),Go();try{let f=document.createElement("input");f.type="file",f.webkitdirectory=!0,f.multiple=!0,f.addEventListener("change",async()=>{let b=Array.from(f.files||[]).filter(A=>A.name&&A.name.toLowerCase().endsWith(".html"));if(!b.length){P("\u0412 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0439 \u043F\u0430\u043F\u043A\u0435 \u043D\u0435\u0442 HTML\u2011\u0444\u0430\u0439\u043B\u043E\u0432 Memus");return}let S={decision:null,applyToAll:!1},k=0;Ft(`\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u0443\u0435\u043C \u0438\u0437 \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438... (0 / ${b.length})`);for(let A of b){let v=await jm(A,S,{allowApplyToAll:!0});v&&v.id&&(k+=1),Ft(`\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u0443\u0435\u043C \u0438\u0437 \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438... (${k} / ${b.length})`)}bt(),k>0?(P(`\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0441\u0442\u0440\u0430\u043D\u0438\u0446 \u0438\u0437 \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438: ${k}`),It(wt.list)):P("\u0418\u043C\u043F\u043E\u0440\u0442 \u0438\u0437 \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438 \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u043B\u0441\u044F \u0431\u0435\u0437 \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u0430")}),f.click()}catch(f){P(f.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u0438\u043C\u043F\u043E\u0440\u0442 \u0438\u0437 \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438")}}),p.importLogseqBtn&&p.importLogseqBtn.addEventListener("click",async g=>{g.stopPropagation(),Go();try{if(!await Vn({title:"\u0418\u043C\u043F\u043E\u0440\u0442 \u0438\u0437 Logseq",message:"\u0412\u0441\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0438\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B \u0441 \u0442\u0430\u043A\u0438\u043C\u0438 \u0436\u0435 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F\u043C\u0438 \u0431\u0443\u0434\u0443\u0442 \u0443\u0434\u0430\u043B\u0435\u043D\u044B \u0438 \u0437\u0430\u043C\u0435\u043D\u0435\u043D\u044B \u0432\u0435\u0440\u0441\u0438\u044F\u043C\u0438 \u0438\u0437 \u0430\u0440\u0445\u0438\u0432\u0430 Logseq. \u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C?",confirmText:"\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"}))return;let h="";try{let S=window.localStorage.getItem("logseqAssetsBaseUrl")||"";h=await xn({title:"\u0410\u0434\u0440\u0435\u0441 assets \u0434\u043B\u044F Logseq",message:"\u0423\u043A\u0430\u0436\u0438 \u0431\u0430\u0437\u043E\u0432\u044B\u0439 URL, \u0433\u0434\u0435 \u043B\u0435\u0436\u0430\u0442 assets (\u043D\u0430\u043F\u0440\u0438\u043C\u0435\u0440 https://prismatic-salamander-2afe94.netlify.app). \u0412\u043D\u0443\u0442\u0440\u0438 \u043D\u0435\u0433\u043E \u0434\u043E\u043B\u0436\u043D\u044B \u0431\u044B\u0442\u044C \u0444\u0430\u0439\u043B\u044B \u0432 \u043F\u0430\u043F\u043A\u0435 /assets.",confirmText:"\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"https://example.netlify.app",defaultValue:S})}catch{return}if(h=(h||"").trim(),!h)return;try{window.localStorage.setItem("logseqAssetsBaseUrl",h)}catch{}P("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 ZIP-\u0430\u0440\u0445\u0438\u0432 Logseq \u0441 \u043F\u0430\u043F\u043A\u043E\u0439 pages/");let b=document.createElement("input");b.type="file",b.accept=".zip,application/zip",b.multiple=!1,b.addEventListener("change",async()=>{let S=b.files&&b.files[0];if(S)try{Ft("\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0438 \u043E\u0431\u0440\u0430\u0431\u0430\u0442\u044B\u0432\u0430\u0435\u043C \u0430\u0440\u0445\u0438\u0432 Logseq...");let k=await ku(S,h);bt();let A=Array.isArray(k)?k:[];A.length>0&&A[0].id?(It(wt.article(A[0].id)),A.length===1?P("\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0430 \u0438\u0437 Logseq"):P(`\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0441\u0442\u0440\u0430\u043D\u0438\u0446 \u0438\u0437 Logseq: ${A.length}`)):P("\u0418\u043C\u043F\u043E\u0440\u0442 \u0438\u0437 Logseq \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u043B\u0441\u044F \u0431\u0435\u0437 \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u0430")}catch(k){bt(),Ft(k.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0430\u0440\u0445\u0438\u0432 Logseq")}}),b.click()}catch(f){P(f.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u0438\u043C\u043F\u043E\u0440\u0442 Logseq")}}),p.deleteArticleBtn&&p.deleteArticleBtn.addEventListener("click",Bm),p.articleTitleInput&&(p.articleTitleInput.addEventListener("keydown",Im),p.articleTitleInput.addEventListener("blur",Em)),p.hintToggleBtn&&p.hintToggleBtn.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),window.open("/help.html","_blank","noopener,noreferrer")||kc(g)}),p.sidebarToggle&&p.sidebarToggle.addEventListener("click",Ac),_m(),p.dragModeToggleBtn&&p.dragModeToggleBtn.addEventListener("click",()=>{Sa()}),p.blocksContainer&&p.blocksContainer.addEventListener("click",g=>{if(a.mode!=="view"||!a.article||!Array.isArray(a.article.blocks)||!a.article.blocks.length||g.target.closest(".block"))return;let h=p.blocksContainer.querySelectorAll(".block[data-block-id]");if(!h.length)return;let b=h[h.length-1],S=b.getBoundingClientRect();if(g.clientY<=S.bottom+4)return;let k=b.getAttribute("data-block-id");k&&(a.currentBlockId=k,zr("after"))}),p.articleFilterInput&&p.articleFilterInput.addEventListener("input",As),p.searchInput&&p.searchInput.addEventListener("keydown",g=>{if(a.sidebarSearchView!=="list")return;if(g.key==="Escape"){g.stopPropagation(),g.preventDefault(),p.searchInput.value="",a.articleFilterQuery="",kr(),Pt(),Pr=0,y();return}let{key:f,ctrlKey:h,altKey:b,metaKey:S}=g;if(h||b||S||f.length!==1)return;let k=Date.now();(!Pr||k-Pr>2e3)&&(p.searchInput.value="",a.articleFilterQuery="",Pt(),y()),Pr=k}),p.articleUndoBtn&&p.articleUndoBtn.addEventListener("click",g=>{g.preventDefault(),Do()}),p.articleRedoBtn&&p.articleRedoBtn.addEventListener("click",g=>{g.preventDefault(),_o()}),p.deleteCurrentBlockBtn&&p.deleteCurrentBlockBtn.addEventListener("click",async g=>{g.preventDefault(),await Ps()}),p.articleBlockTrashBtn&&p.articleBlockTrashBtn.addEventListener("click",async g=>{if(g.preventDefault(),!a.article||!a.articleId){P("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}let f=Array.isArray(a.article.blockTrash)?a.article.blockTrash:[];if(!f.length){P("\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432 \u043F\u0443\u0441\u0442\u0430");return}try{let h=await mc({items:f});if(!h)return;let b=a.articleId;if(h.action==="clear"){await He(`/api/articles/${b}/blocks/trash/clear`,{method:"POST",body:JSON.stringify({})}),a.article&&(a.article.blockTrash=[]),P("\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432 \u043E\u0447\u0438\u0449\u0435\u043D\u0430");return}if(!h.id)return;let S=await He(`/api/articles/${b}/blocks/trash/restore`,{method:"POST",body:JSON.stringify({id:h.id})}),k=S&&S.block&&S.block.id||S.blockId||h.id,A=await nn(b,{desiredBlockId:k||null,resetUndoStacks:!0});a.article=A,st("events.blockTrash.restore.fullRender"),P("\u0411\u043B\u043E\u043A \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D \u0438\u0437 \u043A\u043E\u0440\u0437\u0438\u043D\u044B")}catch(h){P(h.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u0438\u0437 \u043A\u043E\u0440\u0437\u0438\u043D\u044B")}}),p.articleNewBlockBtn&&p.articleNewBlockBtn.addEventListener("click",g=>{if(g.preventDefault(),!a.article||!a.currentBlockId){P("\u041D\u0435\u0442 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u0431\u043B\u043E\u043A\u0430");return}zr("after")}),p.mergeBlocksBtn&&p.mergeBlocksBtn.addEventListener("click",async g=>{g.preventDefault(),await xa()}),p.splitBlockBtn&&p.splitBlockBtn.addEventListener("click",async g=>{if(g.preventDefault(),a.mode!=="edit"||!a.editingBlockId){P("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0432\u043A\u043B\u044E\u0447\u0438\u0442\u0435 \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430");return}await Co()}),p.insertTableBtn&&p.insertTableBtn.addEventListener("click",g=>{if(g.preventDefault(),a.mode!=="edit"||!a.editingBlockId){P("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0432\u043A\u043B\u044E\u0447\u0438\u0442\u0435 \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430");return}let f=document.querySelector(`.block[data-block-id="${a.editingBlockId}"] .block-text[contenteditable="true"]`);if(!f){P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u0431\u043B\u043E\u043A \u0434\u043B\u044F \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0442\u0430\u0431\u043B\u0438\u0446\u044B");return}let h=['<table class="memus-table">',"<thead>","<tr>","<th>\u0417\u0430\u0433\u043E\u043B\u043E\u0432\u043E\u043A 1</th>","<th>\u0417\u0430\u0433\u043E\u043B\u043E\u0432\u043E\u043A 2</th>","</tr>","</thead>","<tbody>","<tr>","<td>\u042F\u0447\u0435\u0439\u043A\u0430 1</td>","<td>\u042F\u0447\u0435\u0439\u043A\u0430 2</td>","</tr>","</tbody>","</table>","<p><br /></p>"].join("");ir(f,h),f.classList.remove("block-body--empty")}),p.articlesTabBtn&&p.articlesTabBtn.addEventListener("click",()=>yi(!1)),p.trashTabBtn&&p.trashTabBtn.addEventListener("click",()=>yi(!0)),p.telegramLinkBtn&&p.telegramLinkBtn.addEventListener("click",async g=>{g.preventDefault(),g.stopPropagation();try{let f=await mu(),h=f&&f.token||"";if(!h){P("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u043A\u043E\u0434 \u043F\u0440\u0438\u0432\u044F\u0437\u043A\u0438 Telegram");return}let b=`/link ${h}`;await xn({title:"\u041F\u0440\u0438\u0432\u044F\u0437\u0430\u0442\u044C Telegram",message:["\u0427\u0442\u043E\u0431\u044B \u0441\u043E\u0437\u0434\u0430\u0432\u0430\u0442\u044C \u0431\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438 \u0438\u0437 \u0422\u0435\u043B\u0435\u0433\u0440\u0430\u043C\u043C","1. \u041E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0447\u0430\u0442 \u0441 \u0431\u043E\u0442\u043E\u043C.","2. \u041E\u0442\u043F\u0440\u0430\u0432\u044C\u0442\u0435 \u0435\u043C\u0443 \u044D\u0442\u0443 \u043A\u043E\u043C\u0430\u043D\u0434\u0443:"].join(`
`),defaultValue:b,placeholder:"/link \u2026",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",hideConfirm:!0})}catch(f){P(f.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043A\u043E\u0434 \u043F\u0440\u0438\u0432\u044F\u0437\u043A\u0438 Telegram")}}),p.userMenuBtn&&p.userMenu&&p.userMenuBtn.addEventListener("click",g=>{if(g.preventDefault(),g.stopPropagation(),!p.userMenu.classList.contains("hidden"))p.userMenu.classList.add("hidden"),p.userMenuBtn.setAttribute("aria-expanded","false");else{try{p.syncMenu?.classList.add("hidden"),p.sidebarSyncStatusPill?.setAttribute("aria-expanded","false")}catch{}p.userMenu.classList.remove("hidden"),p.userMenuBtn.setAttribute("aria-expanded","true"),Dw()}}),p.semanticReindexBtn){let g=p.semanticReindexBtn.querySelector(".sidebar-user-menu-label");g&&g.textContent&&(Jm=g.textContent.trim()),p.semanticReindexBtn.addEventListener("click",async f=>{if(f.preventDefault(),f.stopPropagation(),jl){P("\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F \u0443\u0436\u0435 \u0432\u044B\u043F\u043E\u043B\u043D\u044F\u0435\u0442\u0441\u044F");return}let b=window.confirm(`\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A:

OK \u2014 \u0432\u0441\u0451 \u0437\u0430\u043D\u043E\u0432\u043E (\u043F\u0435\u0440\u0435\u0441\u0447\u0438\u0442\u0430\u0442\u044C \u0432\u0441\u0435 embeddings)
\u041E\u0442\u043C\u0435\u043D\u0430 \u2014 \u0442\u043E\u043B\u044C\u043A\u043E \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u044E\u0449\u0438\u0435 (\u0431\u044B\u0441\u0442\u0440\u0435\u0435)`)?"all":"missing";p.userMenu?.classList.add("hidden"),p.userMenuBtn?.setAttribute("aria-expanded","false");let S=p.semanticReindexBtn;S&&(S.disabled=!0);let k=()=>{jl=!1,Ta!==null&&(clearTimeout(Ta),Ta=null),S&&(S.disabled=!1)},A=B=>{if(!B||typeof B!="object"){Ft("\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F \u0441\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u043E\u0433\u043E \u043F\u043E\u0438\u0441\u043A\u0430...",{protect:!0});return}let H=B.status||"unknown";if(H==="running"){let O=Number(B.total||0),W=Number(B.processed||0),J=Number(B.failed||0),ne=Number(B.indexed||0),me=[];O>0?me.push(`${W}/${O}`):me.push(`${W}`),me.push(`\u0433\u043E\u0442\u043E\u0432\u043E: ${ne}`),J&&me.push(`\u043E\u0448\u0438\u0431\u043A\u0438: ${J}`),Ft(`\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F\u2026 ${me.join(" \u2022 ")}`,{protect:!0});return}if(H==="cooldown"){let O=Number(B.cooldownRemainingSeconds||0);if(O>0){let W=Math.ceil(O/60);P(`\u0421\u043B\u0438\u0448\u043A\u043E\u043C \u0447\u0430\u0441\u0442\u043E: \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0447\u0435\u0440\u0435\u0437 ~${W} \u043C\u0438\u043D`)}else P("\u0421\u043B\u0438\u0448\u043A\u043E\u043C \u0447\u0430\u0441\u0442\u043E: \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u043F\u043E\u0437\u0436\u0435");return}if(H==="completed"){P(`\u0418\u043D\u0434\u0435\u043A\u0441 \u043E\u0431\u043D\u043E\u0432\u043B\u0451\u043D: ${B.indexed||0} \u0431\u043B\u043E\u043A\u043E\u0432`);return}if(H==="cancelled"){P("\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F \u043E\u0442\u043C\u0435\u043D\u0435\u043D\u0430");return}if(H==="failed"){P(B.error||"\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u043B\u0430\u0441\u044C \u0441 \u043E\u0448\u0438\u0431\u043A\u043E\u0439");return}P(`\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F: ${H}`)},v=async()=>{try{let B=await fetch("/api/search/semantic/reindex/status",{method:"GET",credentials:"include"});if(!B.ok){let O=await B.text().catch(()=>"");throw new Error(O||B.statusText)}let H=await B.json();if(!H||H.status==="idle"){bt({force:!0}),P("\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F \u043D\u0435 \u0437\u0430\u043F\u0443\u0449\u0435\u043D\u0430"),k();return}if(H.status==="running"){A(H),Ca(H),Ta=setTimeout(v,1e3);return}bt({force:!0}),A(H),Ca(H),k()}catch(B){bt({force:!0}),P(B.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u0443\u0441 \u043F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u0438"),k()}};try{let B=await fetch("/api/search/semantic/reindex",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:b})});if(!B.ok){let O=await B.text().catch(()=>"");throw new Error(O||B.statusText)}let H=await B.json();if(H&&H.status==="cooldown"){A(H),k();return}jl=!0,A(H),Ca(H),await v()}catch(B){bt({force:!0}),P(B.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A"),k()}})}p.telegramBotOpenBtn&&p.telegramBotOpenBtn.addEventListener("click",()=>{try{window.open("https://t.me/Memus_pro_bot","_blank","noopener,noreferrer")}catch{window.location.href="https://t.me/Memus_pro_bot"}}),p.telegramFeedbackBotOpenBtn&&p.telegramFeedbackBotOpenBtn.addEventListener("click",()=>{try{window.open("https://t.me/Memus_feedback_bot","_blank","noopener,noreferrer")}catch{window.location.href="https://t.me/Memus_feedback_bot"}}),document.addEventListener("click",g=>{if(p.searchPanel&&!p.searchPanel.contains(g.target)&&xr(),fr&&p.hintPopover&&!p.hintPopover.contains(g.target)&&!(p.hintToggleBtn&&p.hintToggleBtn.contains(g.target))&&Ar(),Cm()&&p.articleMenu&&!p.articleMenu.contains(g.target)&&!(p.articleMenuBtn&&p.articleMenuBtn.contains(g.target))&&Nr(),p.userMenu&&p.userMenuBtn){let f=g.target;p.userMenu.classList.contains("hidden")||p.userMenu.contains(f)||p.userMenuBtn.contains(f)||(p.userMenu.classList.add("hidden"),p.userMenuBtn.setAttribute("aria-expanded","false"))}if(p.syncMenu&&p.sidebarSyncStatusPill){let f=g.target;p.syncMenu.classList.contains("hidden")||p.syncMenu.contains(f)||p.sidebarSyncStatusPill.contains(f)||(p.syncMenu.classList.add("hidden"),p.sidebarSyncStatusPill.setAttribute("aria-expanded","false"))}})}At();Vt();Xt();zt();rr();Xs();var $w="ttree_debug_quick_notes_v1";function Fw(){try{return window?.localStorage?.getItem?.($w)==="1"}catch{return!1}}function La(...e){try{if(!Fw())return;console.log("[quick-notes][auth]",...e)}catch{}}var Gm=!1;function Zm(){if(Gm)return;Gm=!0;let e=null,t=null,n=async i=>{try{let s=String(i?.id||"").trim(),c=String(i?.text||"").trim();if(!s||!c||String(a.articleId||"")!=="inbox"||!a.article)return!1;let l=await Promise.resolve().then(()=>(Mr(),Lr));if(!l?.insertOutlineSectionFromPlainTextAtStart)return!1;let d=l.insertOutlineSectionFromPlainTextAtStart(s,c);return d&&La("inbox.inserted",{noteId:s}),!!d}catch{return!1}},r=()=>{typeof navigator<"u"&&navigator&&navigator.onLine===!1||t||(e&&clearTimeout(e),e=setTimeout(()=>{e=null;try{La("sync.start"),t=Promise.resolve().then(()=>(Oo(),Gs)).then(i=>i.enqueuePendingQuickNotesForSync?.()).then(i=>{La("sync.done",i||null)}).catch(()=>{}).finally(()=>{t=null})}catch{t=null}},7e3))},o=i=>{let s=i?.detail?.note;s&&n(s).catch(()=>{}),r()};try{window.addEventListener("memus:queued-inbox-changed",o),La("listener.attached")}catch{}}var Qm=!1,Gl=null,eh="ttree_last_user_v1",th="ttree_offline_user_key_v1";function nh(e){try{let t=String(e?.id||"").trim();if(!t)return;window.localStorage.setItem(th,t)}catch{}}function zw(){try{window.localStorage.removeItem(th)}catch{}}async function Uw(e){let t=typeof e=="number"?Math.max(0,Math.floor(e)):8e3;try{let n=typeof AbortController<"u"?new AbortController:null,r=!1,o=new Promise(c=>{setTimeout(()=>{r=!0;try{n?.abort?.()}catch{}c({status:"down",message:"timeout"})},t)}),i=(async()=>{try{let c=await fetch("/api/auth/me",{method:"GET",credentials:"include",signal:n?.signal});return r?null:c.status===401||c.status===403?{status:"auth"}:c.ok?{status:"ok",user:await c.json()}:{status:"down",message:(await c.json().catch(()=>({})))?.detail||`HTTP ${c.status}`}}catch(c){return r?null:c?.name==="AbortError"?{status:"down",message:"timeout"}:{status:"down",message:c?.message||"network"}}})(),s=await Promise.race([i,o]);return s&&typeof s=="object"?s:{status:"down",message:"timeout"}}catch(n){return{status:"down",message:n?.message||"network"}}}async function Xm(e={}){let{reason:t}=e||{};try{let n=localStorage.getItem(eh),r=n?JSON.parse(n):null;if(!r||!r.id&&!r.username)return!1;ih(r),nh(r),rh(),sh(),Zm();try{await Gi(r);try{await Promise.resolve().then(()=>(Oo(),Gs)).then(o=>o.enqueuePendingQuickNotesForSync?.())}catch{}}catch(o){try{console.warn("[offline] init failed",o)}catch{}}return t&&P(`\u041E\u0444\u0444\u043B\u0430\u0439\u043D \u0440\u0435\u0436\u0438\u043C: \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 (${t})`),!0}catch{return!1}}function Ma(){p.authOverlay&&p.authOverlay.classList.remove("hidden")}function rh(){p.authOverlay&&p.authOverlay.classList.add("hidden")}function oh(e){p.authError&&(p.authError.textContent=e||"",p.authError.classList.toggle("hidden",!e))}function Ql(e){oh(""),e==="login"&&(p.authSubtitle&&(p.authSubtitle.textContent="\u0417\u0430\u0445\u043E\u0434\u0438\u0442\u0435, \u044F \u0441\u043E\u0441\u043A\u0443\u0447\u0438\u043B\u0441\u044F! :)"),p.authStorageInfo&&(p.authStorageInfo.textContent="\u0423\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0435 \u043E \u0431\u0435\u0437\u043E\u043F\u0430\u0441\u043D\u043E\u0441\u0442\u0438: \u0422\u0435\u043A\u0441\u0442\u044B \u0438 \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0438 \u0445\u0440\u0430\u043D\u044F\u0442\u0441\u044F \u043D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0430\u0445 Memus.pro, \u0438\u043D\u044B\u0435 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043D\u044B\u0435 \u0444\u0430\u0439\u043B\u044B \u0441\u043E\u0445\u0440\u0430\u043D\u044F\u044E\u0442\u0441\u044F \u043D\u0430\u043F\u0440\u044F\u043C\u0443\u044E \u043D\u0430 \u0432\u0430\u0448 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A. \u0412\u044B \u043C\u043E\u0436\u0435\u0442\u0435 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u043F\u0440\u0438\u0432\u0430\u0442\u043D\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435.",p.authStorageInfo.classList.remove("hidden")),p.authGoogleLoginBtn&&p.authGoogleLoginBtn.classList.remove("hidden"),p.authYandexLoginBtn&&p.authYandexLoginBtn.classList.remove("hidden"))}function ih(e){a.currentUser=e,nh(e);try{let n={id:e?.id||null,username:e?.username||null,displayName:e?.displayName||null,isSuperuser:!!e?.isSuperuser};(n.id||n.username)&&localStorage.setItem(eh,JSON.stringify(n))}catch{}p.currentUserLabel&&(p.currentUserLabel.textContent=e?.displayName||e?.username||"");let t=!!(e&&e.isSuperuser);p.openUsersViewBtn&&p.openUsersViewBtn.classList.toggle("hidden",!t),p.semanticReindexBtn&&p.semanticReindexBtn.classList.toggle("hidden",!t)}function sh(){Qm||!Gl||(Qm=!0,Gl())}function ah(e){Gl=e;try{window.addEventListener("memus:auth-required",()=>{try{if(navigator?.onLine===!1)return}catch{}try{a.serverStatus="auth",a.serverStatusText="auth"}catch{}Ql("login"),Ma()})}catch{}p.logoutBtn&&p.logoutBtn.addEventListener("click",async()=>{try{await eu()}catch{}zw(),a.currentUser=null,Ma(),P("\u0412\u044B \u0432\u044B\u0448\u043B\u0438 \u0438\u0437 \u0430\u043A\u043A\u0430\u0443\u043D\u0442\u0430"),window.location.reload()}),p.authGoogleLoginBtn&&p.authGoogleLoginBtn.addEventListener("click",()=>{window.location.href="/api/auth/google/login"}),p.authYandexLoginBtn&&p.authYandexLoginBtn.addEventListener("click",()=>{window.location.href="/api/auth/yandex/login"})}async function ch(){try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw a.serverStatus="down",a.serverStatusText="offline",new Error("offline");p.authSubtitle&&(p.authSubtitle.textContent="\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0431\u0430\u0437\u0443 \u0437\u043D\u0430\u043D\u0438\u0439\u2026"),p.authGoogleLoginBtn&&p.authGoogleLoginBtn.classList.add("hidden"),p.authYandexLoginBtn&&p.authYandexLoginBtn.classList.add("hidden");let e=await Uw(8e3);if(e?.status==="ok"&&e.user){a.serverStatus="ok",a.serverStatusText="",ih(e.user),rh(),sh(),Zm();try{let r=()=>import("/outline/tiptap.bundle.js").catch(()=>{});typeof requestIdleCallback=="function"?requestIdleCallback(()=>r(),{timeout:2500}):setTimeout(()=>r(),800)}catch{}(r=>{let o=!1,i=()=>{if(!o){o=!0;try{r()}catch{}}},s=setTimeout(i,1500);try{if(typeof requestIdleCallback=="function"){requestIdleCallback(()=>{try{clearTimeout(s)}catch{}i()},{timeout:3e3});return}}catch{}})(()=>{(async()=>{let r=!1,o=!1,i=setTimeout(()=>{r=!0,P("\u0418\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0438\u0440\u0443\u0435\u043C offline-\u0431\u0430\u0437\u0443\u2026 (\u043C\u043E\u0436\u0435\u0442 \u0437\u0430\u043D\u044F\u0442\u044C \u0432\u0440\u0435\u043C\u044F)")},5e3);try{await Gi(e.user);try{await Promise.resolve().then(()=>(Oo(),Gs)).then(c=>c.enqueuePendingQuickNotesForSync?.())}catch{}let s=await hl();gl(),Bi({initialIndex:s||void 0}),o=!0}catch(s){P("Offline \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0432 \u044D\u0442\u043E\u043C \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435");try{console.warn("[offline] init failed",s)}catch{}}finally{clearTimeout(i),r&&o&&P("Offline-\u0431\u0430\u0437\u0430 \u0433\u043E\u0442\u043E\u0432\u0430")}})()});return}if(e?.status==="auth"){a.serverStatus="auth",a.serverStatusText="auth",Ql("login"),Ma();return}if(a.serverStatus="down",a.serverStatusText=e?.message?String(e.message):"down",await Xm({reason:"\u043D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0430 \u043A \u0441\u0435\u0440\u0432\u0435\u0440\u0443"}))return}catch{}try{if(!navigator.onLine){if(await Xm({reason:"\u043D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430"}))return;oh("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430. \u041E\u0444\u0444\u043B\u0430\u0439\u043D-\u0440\u0435\u0436\u0438\u043C \u0431\u0443\u0434\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u043F\u043E\u0441\u043B\u0435 \u043F\u0435\u0440\u0432\u043E\u0433\u043E \u0432\u0445\u043E\u0434\u0430 \u043E\u043D\u043B\u0430\u0439\u043D.")}}catch{}Ql("login"),Ma()}En();Vt();At();zt();Qn();try{window.__memusAppStarted=!0}catch{}function xh(){try{let e=new URLSearchParams(window.location.search||""),t=e.get("profile")??e.get("perf");if(t==null)return;let n=String(t).trim().toLowerCase();if(n==="1"||n==="true"||n==="yes"||n==="on"){window.localStorage.setItem("ttree_profile_v1","1");return}(n==="0"||n==="false"||n==="no"||n==="off")&&window.localStorage.removeItem("ttree_profile_v1")}catch{}}function kh(){if("serviceWorker"in navigator)try{navigator.serviceWorker.register("/uploads-sw.js",{scope:"/",updateViaCache:"none"}).then(e=>{try{let t=e?.update?.();t&&typeof t.catch=="function"&&t.catch(()=>{})}catch{}}).catch(()=>{})}catch{}}function Xo(e,t){if(!(typeof navigator<"u"&&navigator&&navigator.onLine===!1)){try{if(window?.localStorage?.getItem?.("ttree_client_log_v1")!=="1")return}catch{return}try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:e,data:t})}).catch(()=>{})}catch{}}}async function lS({timeoutMs:e=2500}={}){let t=null,n=null;try{typeof AbortController<"u"&&(t=new AbortController,n=setTimeout(()=>{try{t.abort()}catch{}},Math.max(0,Math.floor(e))));let r=await fetch("/api/auth/me",{method:"GET",credentials:"include",cache:"no-store",signal:t?t.signal:void 0});return{ok:r.ok,status:r.status}}catch(r){return{ok:!1,status:0,error:String(r?.message||r||"")}}finally{n&&clearTimeout(n)}}function dS(){let e=Date.now(),t=0,n=0,r=()=>{e=Date.now()};["pointerdown","keydown","focus","touchstart","mousedown"].forEach(c=>{try{window.addEventListener(c,r,!0)}catch{}});let o=(c,l={})=>{Xo(c,{t:new Date().toISOString(),path:window.location.pathname,hidden:!!document.hidden,onLine:(()=>{try{return navigator?.onLine!==!1}catch{return null}})(),serverStatus:String(a.serverStatus||""),offlineReady:!!a.offlineReady,articlesIndexLen:Array.isArray(a.articlesIndex)?a.articlesIndex.length:null,...l})},i=async c=>{let l=Date.now();if(l-t<6e4)return;t=l,o("app.resume_check.start",{reason:c});let d=await lS({timeoutMs:2500});if(o("app.resume_check.done",{reason:c,ping:d}),d&&d.ok)return;try{if(navigator?.onLine===!1){P("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430. \u041E\u0444\u0444\u043B\u0430\u0439\u043D \u0440\u0435\u0436\u0438\u043C \u0434\u043E\u043B\u0436\u0435\u043D \u0440\u0430\u0431\u043E\u0442\u0430\u0442\u044C \u043F\u043E\u0441\u043B\u0435 \u0434\u043E\u043A\u0430\u0447\u043A\u0438.");return}}catch{}if(d&&(d.status===401||d.status===403))return;if(await Vn({title:"\u041F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435 \u043C\u043E\u0433\u043B\u043E \u201C\u0443\u0441\u043D\u0443\u0442\u044C\u201D",message:"\u041F\u043E\u0441\u043B\u0435 \u0434\u043E\u043B\u0433\u043E\u0433\u043E \u0431\u0435\u0437\u0434\u0435\u0439\u0441\u0442\u0432\u0438\u044F \u0431\u0440\u0430\u0443\u0437\u0435\u0440 \u043C\u043E\u0436\u0435\u0442 \u0437\u0430\u043C\u043E\u0440\u043E\u0437\u0438\u0442\u044C \u0432\u043A\u043B\u0430\u0434\u043A\u0443. \u0415\u0441\u043B\u0438 \u043A\u043B\u0438\u043A\u0438/\u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u044E\u0442 \u2014 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435.",confirmText:"\u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C",cancelText:"\u041F\u043E\u0437\u0436\u0435"}).catch(()=>!1))try{window.location.reload()}catch{}},s=c=>{let l=Date.now(),d=l-(e||l),u=n?l-n:0;o("app.lifecycle",{src:c,idleMs:d,frozenMs:u}),!(d<7200*1e3&&!n)&&(document.hidden||i(c).catch(()=>{}))};try{document.addEventListener("visibilitychange",()=>{document.hidden||s("visibility")})}catch{}try{window.addEventListener("pageshow",()=>s("pageshow")),window.addEventListener("pagehide",()=>o("app.lifecycle",{src:"pagehide"}))}catch{}try{document.addEventListener("freeze",()=>{n=Date.now(),o("app.lifecycle",{src:"freeze"})}),document.addEventListener("resume",()=>s("resume"))}catch{}}function uS(){if(!!!(navigator&&navigator.wakeLock&&typeof navigator.wakeLock.request=="function"))return;let t=null,n=!1,r=0,o=(d,u)=>{Xo(d,{t:new Date().toISOString(),...u})},i=()=>{try{if(document.hidden)return!1}catch{}let d=(()=>{try{return a.outboxCount==null?0:Number(a.outboxCount)||0}catch{return 0}})();return a.mode==="edit"||!!a.isOutlineEditing||d>0},s=async d=>{if(t)try{await t.release()}catch{}finally{t=null,o("wake_lock.release",{reason:d})}},c=async d=>{if(!i()){await s(`not_needed:${d}`);return}if(!n||t)return;let u=Date.now();if(!(u-r<1500)){r=u;try{t=await navigator.wakeLock.request("screen"),o("wake_lock.acquired",{reason:d});try{t.addEventListener("release",()=>{t=null,o("wake_lock.released",{reason:"event"})})}catch{}}catch(m){t=null,o("wake_lock.failed",{reason:d,err:String(m?.name||m?.message||m||"")})}}},l=()=>{n=!0,c("gesture").catch(()=>{})};["pointerdown","keydown","touchstart","mousedown"].forEach(d=>{try{window.addEventListener(d,l,{capture:!0,passive:!0})}catch{}});try{document.addEventListener("visibilitychange",()=>{document.hidden?s("hidden").catch(()=>{}):c("visible").catch(()=>{})})}catch{}setInterval(()=>{c("tick").catch(()=>{})},2e3)}function Ah(e,{timeout:t=3e3,fallbackDelay:n=1200}={}){try{if(typeof requestIdleCallback=="function"){requestIdleCallback(()=>e(),{timeout:t});return}}catch{}setTimeout(()=>e(),n)}function fS(e){try{let n=new URL(String(e||""),window.location.href).searchParams.get("v");return n?String(n):""}catch{return""}}function pS(e){try{let t=performance.getEntriesByType?.("resource")||[];for(let n=t.length-1;n>=0;n-=1){let r=t[n]?.name;if(r&&e.test(String(r)))return fS(r)}}catch{}return""}async function mS(){try{if(!("serviceWorker"in navigator))return null;let e=async t=>await new Promise(n=>{if(!t)return n(null);let r=new MessageChannel,o=setTimeout(()=>n(null),500);r.port1.onmessage=i=>{clearTimeout(o),n(i.data||null)};try{t.postMessage({type:"memus:get-sw-build"},[r.port2])}catch{clearTimeout(o),n(null)}});if(navigator.serviceWorker.controller)return await e(navigator.serviceWorker.controller);try{let t=await navigator.serviceWorker.getRegistration();if(t?.active)return await e(t.active)}catch{}return await new Promise(t=>{let n=new MessageChannel,r=setTimeout(()=>t(null),300);n.port1.onmessage=o=>{clearTimeout(r),t(o.data||null)},navigator.serviceWorker.controller?.postMessage?.({type:"memus:get-sw-build"},[n.port2])})}catch{return null}}async function Ra(){let e=document.getElementById("sidebarVersionLabel");if(e)try{let t=pS(/\/api\.js(\?|$)/),n=await mS(),r=n?.buildId?String(n.buildId):"";if(r){try{window.__BUILD_ID__=r}catch{}e.textContent=`v${r}`;return}t&&(e.textContent=`api v${t}`)}catch{}}try{"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("controllerchange",()=>{Ra().catch(()=>{})})}catch{}function Ih(){if(!p.graphToggleBtn)return;let e=null,t=async()=>{e||(e=Promise.resolve().then(()=>(mh(),ph)).then(n=>{p.graphToggleBtn?.removeEventListener("click",t,!0),n.initGraphView?.(),n.openGraphView?.()}).catch(()=>{}).finally(()=>{e=null}))};p.graphToggleBtn.addEventListener("click",t,!0)}function hS(){if(!p.openUsersViewBtn)return;let e=null,t=async()=>{e||(e=Promise.resolve().then(()=>(bh(),yh)).then(n=>{p.openUsersViewBtn?.removeEventListener("click",t,!0),n.initUsersPanel?.(),setTimeout(()=>p.openUsersViewBtn?.click(),0)}).catch(()=>{}).finally(()=>{e=null}))};p.openUsersViewBtn.addEventListener("click",t,!0)}Ah(()=>Ra(),{timeout:1500,fallbackDelay:50});setTimeout(()=>Ra(),3e3);try{navigator?.serviceWorker?.addEventListener?.("controllerchange",()=>Ra())}catch{}function gS(){xh(),Xo("app.start",{ua:navigator.userAgent}),kh(),dS(),uS(),Vl(),Yl(),uf(),Ih(),hS(),Ah(()=>{Promise.resolve().then(()=>(Sh(),wh)).then(e=>e.initTables?.()).catch(()=>{})}),Yo(window.location.pathname)}function yS(){xh(),Xo("app.public.start",{ua:navigator.userAgent,path:window.location.pathname}),p.authOverlay&&p.authOverlay.classList.add("hidden"),kh(),Vl(),Yl(),Ih(),Yo(window.location.pathname)}async function bS(){if(/^\/p\/[^/?#]+/.test(window.location.pathname)){yS();return}Xo("auth.bootstrap.start",{ua:navigator.userAgent}),ah(gS),await ch(),Xo("auth.bootstrap.done",{ua:navigator.userAgent})}bS().catch(()=>{});
