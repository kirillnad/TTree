var gm=Object.defineProperty;var Fe=(e,t)=>()=>(e&&(t=e(e=0)),t);var Vn=(e,t)=>{for(var n in t)gm(e,n,{get:t[n],enumerable:!0})};function Gs(e){hi=e}function Qs(e){qn=e}var a,hi,qn,ft=Fe(()=>{a={mode:"view",serverStatus:"unknown",serverStatusText:"",offlineReady:!1,offlineInitStatus:"idle",offlineInitError:"",offlineInitStartedAt:null,mediaStatusText:"",mediaPrefetchPaused:!1,isOutlineEditing:!1,outlineStatusText:"",isPublicView:!1,isRagView:!1,currentUser:null,articleId:null,article:null,currentBlockId:null,editingBlockId:null,selectionAnchorBlockId:null,selectedBlockIds:[],undoStack:[],redoStack:[],pendingTextPreview:null,editingUndo:null,editingInitialText:"",searchQuery:"",searchResults:[],searchError:"",searchLoading:!1,searchRequestId:0,searchMode:"classic",sidebarSearchView:"list",ragQuery:"",ragResults:[],ragBlockMap:{},ragSummaryHtml:"",ragSummaryLoading:!1,ragSummaryError:"",scrollTargetBlockId:null,pendingEditBlockId:null,isEditingTitle:!1,isSidebarCollapsed:!1,isSidebarMobileOpen:!1,articlesIndex:[],deletedArticlesIndex:[],articleFilterQuery:"",isMarkdownInserting:!1,isTrashView:!1,favoriteArticles:[],sidebarArticlesMode:"tree",recentArticleIds:[],sidebarSelectedArticleId:null,listSelectedArticleId:null,sidebarCollapsedArticleIds:[],listCollapsedArticleIds:[],isDragModeEnabled:!1,articleEncryptionKeys:{},isMergingBlocks:!1,isMovingBlock:!1,isDeletingBlock:!1,moveQueue:[],isMoveQueueProcessing:!1,editingScrollTop:null,editingCaretPosition:"start"},hi=!1,qn=!1});var m,vt=Fe(()=>{m={authOverlay:document.getElementById("authOverlay"),authLoginTab:document.getElementById("authLoginTab"),authRegisterTab:document.getElementById("authRegisterTab"),authLoginForm:document.getElementById("authLoginForm"),authRegisterForm:document.getElementById("authRegisterForm"),authLoginUsername:document.getElementById("authLoginUsername"),authLoginPassword:document.getElementById("authLoginPassword"),authRegisterUsername:document.getElementById("authRegisterUsername"),authRegisterPassword:document.getElementById("authRegisterPassword"),authRegisterDisplayName:document.getElementById("authRegisterDisplayName"),authError:document.getElementById("authError"),authSubtitle:document.getElementById("authSubtitle"),authGoogleLoginBtn:document.getElementById("authGoogleLoginBtn"),authYandexLoginBtn:document.getElementById("authYandexLoginBtn"),authStorageInfo:document.getElementById("authStorageInfo"),currentUserLabel:document.getElementById("currentUserLabel"),logoutBtn:document.getElementById("logoutBtn"),userMenuBtn:document.getElementById("userMenuBtn"),userMenu:document.getElementById("userMenu"),offlineStatusItem:document.getElementById("offlineStatusItem"),offlineStatusLabel:document.getElementById("offlineStatusLabel"),offlineFetchBtn:document.getElementById("offlineFetchBtn"),telegramLinkBtn:document.getElementById("telegramLinkBtn"),telegramBotOpenBtn:document.getElementById("telegramBotOpenBtn"),telegramFeedbackBotOpenBtn:document.getElementById("telegramFeedbackBotOpenBtn"),openUsersViewBtn:document.getElementById("openUsersViewBtn"),usersView:document.getElementById("usersView"),usersList:document.getElementById("usersList"),usersBackBtn:document.getElementById("usersBackBtn"),graphView:document.getElementById("graphView"),graphCanvas:document.getElementById("graphCanvas"),graphBackBtn:document.getElementById("graphBackBtn"),articleListView:document.getElementById("articleListView"),articleView:document.getElementById("articleView"),articleHeader:document.getElementById("articleHeader"),articleTitle:document.getElementById("articleTitle"),updatedAt:document.getElementById("updatedAt"),articleStatusText:document.getElementById("articleStatusText"),mediaStatusText:document.getElementById("mediaStatusText"),mediaPrefetchToggleBtn:document.getElementById("mediaPrefetchToggleBtn"),blocksContainer:document.getElementById("blocksContainer"),articleList:document.getElementById("articleList"),createArticleBtn:document.getElementById("createArticleBtn"),backToList:document.getElementById("backToList"),toast:document.getElementById("toast"),searchInput:document.getElementById("searchInput"),searchClearBtn:document.getElementById("searchClearBtn"),searchResults:document.getElementById("searchResults"),searchPanel:document.querySelector(".search-panel"),searchModeToggle:document.getElementById("searchModeToggle"),sidebarSearchViewToggle:document.getElementById("sidebarSearchViewToggle"),ragOpenBtn:document.getElementById("ragOpenBtn"),articleTitleInput:document.getElementById("articleTitleInput"),editTitleBtn:document.getElementById("editTitleBtn"),hintToggleBtn:document.getElementById("hintToggleBtn"),hintPopover:document.getElementById("hintPopover"),sidebar:document.getElementById("sidebar"),sidebarToggle:document.getElementById("sidebarToggle"),sidebarArticleList:document.getElementById("sidebarArticleList"),sidebarNewArticleBtn:document.getElementById("sidebarNewArticleBtn"),sidebarRecentBtn:document.getElementById("sidebarRecentBtn"),openInboxBtn:document.getElementById("openInboxBtn"),quickNoteAddBtn:document.getElementById("quickNoteAddBtn"),articleFilterInput:document.getElementById("articleFilterInput"),trashTabBtn:document.getElementById("trashTabBtn"),articlesTabBtn:document.getElementById("articlesTabBtn"),semanticReindexBtn:document.getElementById("semanticReindexBtn"),graphToggleBtn:document.getElementById("graphToggleBtn"),listMenuBtn:document.getElementById("listMenuBtn"),listMenu:document.getElementById("listMenu"),articleMenuBtn:document.getElementById("articleMenuBtn"),articleMenu:document.getElementById("articleMenu"),articleFavoriteBtn:document.getElementById("articleFavoriteBtn"),articlePublicLinkBtn:document.getElementById("articlePublicLinkBtn"),articlePublicToggleBtn:document.getElementById("articlePublicToggleBtn"),articleEncryptionBtn:document.getElementById("articleEncryptionBtn"),articleEncryptionRemoveBtn:document.getElementById("articleEncryptionRemoveBtn"),deleteArticleBtn:document.getElementById("deleteArticleBtn"),exportArticleBtn:document.getElementById("exportArticleBtn"),outlineEditBtn:document.getElementById("outlineEditBtn"),saveVersionBtn:document.getElementById("saveVersionBtn"),versionsBtn:document.getElementById("versionsBtn"),blockHistoryBtn:document.getElementById("blockHistoryBtn"),articleHistoryBtn:document.getElementById("articleHistoryBtn"),exportAllHtmlZipBtn:document.getElementById("exportAllHtmlZipBtn"),importArticleBtn:document.getElementById("importArticleBtn"),importMarkdownBtn:document.getElementById("importMarkdownBtn"),importLogseqBtn:document.getElementById("importLogseqBtn"),importBackupFolderBtn:document.getElementById("importBackupFolderBtn"),articleUndoBtn:document.getElementById("articleUndoBtn"),articleRedoBtn:document.getElementById("articleRedoBtn"),mergeBlocksBtn:document.getElementById("mergeBlocksBtn"),splitBlockBtn:document.getElementById("splitBlockBtn"),insertTableBtn:document.getElementById("insertTableBtn"),deleteCurrentBlockBtn:document.getElementById("deleteCurrentBlockBtn"),exportCurrentBlockBtn:document.getElementById("exportCurrentBlockBtn"),articleBlockTrashBtn:document.getElementById("articleBlockTrashBtn"),articleNewBlockBtn:document.getElementById("articleNewBlockBtn"),articleToolbar:document.getElementById("articleToolbar"),outlineToolbar:document.getElementById("outlineToolbar"),outlineTagsBar:document.getElementById("outlineTagsBar"),outlineUndoBtn:document.getElementById("outlineUndoBtn"),outlineRedoBtn:document.getElementById("outlineRedoBtn"),outlineDeleteBtn:document.getElementById("outlineDeleteBtn"),outlineMoveUpBtn:document.getElementById("outlineMoveUpBtn"),outlineMoveDownBtn:document.getElementById("outlineMoveDownBtn"),outlineOutdentBtn:document.getElementById("outlineOutdentBtn"),outlineIndentBtn:document.getElementById("outlineIndentBtn"),outlineNewBelowBtn:document.getElementById("outlineNewBelowBtn"),outlineBoldBtn:document.getElementById("outlineBoldBtn"),outlineBulletListBtn:document.getElementById("outlineBulletListBtn"),outlineOrderedListBtn:document.getElementById("outlineOrderedListBtn"),outlineBlockquoteBtn:document.getElementById("outlineBlockquoteBtn"),outlineCodeBtn:document.getElementById("outlineCodeBtn"),outlineInsertTableBtn:document.getElementById("outlineInsertTableBtn"),outlineDeleteTableBtn:document.getElementById("outlineDeleteTableBtn"),outlineAddRowBtn:document.getElementById("outlineAddRowBtn"),outlineAddColBtn:document.getElementById("outlineAddColBtn"),pasteProgress:document.getElementById("pasteProgress"),mobileSidebarBtn:document.getElementById("mobileSidebarBtn"),sidebarBackdrop:document.getElementById("sidebarBackdrop"),dragModeToggleBtn:document.getElementById("dragModeToggleBtn"),listSidebarBtn:document.getElementById("listSidebarBtn"),outlineEditor:document.getElementById("outlineEditor")}});function dl(){if(!m.articlePublicToggleBtn)return;let e=a.article?.publicSlug||null;m.articlePublicToggleBtn.textContent=e?"\u041E\u0442\u043C\u0435\u043D\u0438\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435":"\u0414\u0430\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435"}function gn(){let e=a.article;if(!e)return;let t=e.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";if(m.articleTitle&&(m.articleTitle.textContent=t,m.articleTitle.classList.toggle("article-title--encrypted",!!e.encrypted),m.articleTitle.classList.toggle("hidden",a.isEditingTitle)),m.articleTitleInput&&(a.isEditingTitle||(m.articleTitleInput.value=t),m.articleTitleInput.classList.toggle("hidden",!a.isEditingTitle)),m.editTitleBtn&&m.editTitleBtn.classList.toggle("hidden",a.isEditingTitle),m.articleFavoriteBtn){let r=new Set(a.favoriteArticles||[]).has(e.id);m.articleFavoriteBtn.textContent=r?"\uE735":"\uE734",m.articleFavoriteBtn.title=r?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}if(m.articlePublicLinkBtn){let n=!!e.publicSlug;m.articlePublicLinkBtn.classList.toggle("hidden",!n),n&&(m.articlePublicLinkBtn.title="\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0441\u044B\u043B\u043A\u0443")}if(m.deleteArticleBtn&&m.deleteArticleBtn.classList.toggle("hidden",e.id==="inbox"),m.articleEncryptionBtn&&(m.articleEncryptionBtn.textContent=e.encrypted?"\u0421\u043C\u0435\u043D\u0438\u0442\u044C \u043F\u0430\u0440\u043E\u043B\u044C":"\u0417\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C"),m.articleEncryptionRemoveBtn&&m.articleEncryptionRemoveBtn.classList.toggle("hidden",!e.encrypted),m.updatedAt&&(a.isOutlineEditing?m.updatedAt.textContent=a.outlineStatusText||"":e.updatedAt?m.updatedAt.textContent=`\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${new Date(e.updatedAt).toLocaleString()}`:m.updatedAt.textContent=""),m.articleStatusText&&(a.isOutlineEditing?m.articleStatusText.textContent=a.outlineStatusText||"":e.updatedAt?m.articleStatusText.textContent=`\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${new Date(e.updatedAt).toLocaleString()}`:m.articleStatusText.textContent=""),m.mediaStatusText&&(m.mediaStatusText.textContent=a.mediaStatusText||""),m.mediaPrefetchToggleBtn){let n=!!a.mediaPrefetchPaused;m.mediaPrefetchToggleBtn.textContent=n?"\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C":"\u041F\u0430\u0443\u0437\u0430",m.mediaPrefetchToggleBtn.classList.toggle("is-active",n)}}var So=Fe(()=>{ft();vt()});function ul(){xo!==null&&(clearTimeout(xo),xo=null)}function ea(e){Zs=!!e,m.toast&&(Zs?m.toast.dataset.protected="true":m.toast.removeAttribute("data-protected"))}function L(e,t={}){if(!m.toast)return;let n=typeof t.duration=="number"?t.duration:2500;t.protect?ea(!0):ea(!1),ul(),m.toast.textContent=e,m.toast.classList.remove("hidden"),requestAnimationFrame(()=>{m.toast.classList.add("show")}),n>0&&(xo=setTimeout(()=>{m.toast.classList.remove("show"),setTimeout(()=>m.toast.classList.add("hidden"),200),xo=null},n))}function It(e,t={}){L(e,{...t,duration:0})}function ot(e={}){m.toast&&(Zs&&!e.force||(ul(),ea(!1),m.toast.classList.remove("show"),m.toast.classList.add("hidden")))}var xo,Zs,Et=Fe(()=>{vt();xo=null,Zs=!1;m.toast&&m.toast.addEventListener("click",()=>{ot()})});function Ce(e){return new Promise((t,n)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error||new Error("IndexedDB request failed"))})}function Ue(e){return new Promise((t,n)=>{e.oncomplete=()=>t(),e.onabort=()=>n(e.error||new Error("IndexedDB transaction aborted")),e.onerror=()=>n(e.error||new Error("IndexedDB transaction failed"))})}function ym(e){return String(e||"anon").replace(/[^a-zA-Z0-9_-]/g,"_")}function bm(e){return`memus_offline_v1_${ym(e)}`}function Sm(e){try{let t=String(e||"").trim();if(!t)return;let n=window?.localStorage?.getItem?.(fl)||"[]",r=JSON.parse(n),o=Array.isArray(r)?r:[];o.includes(t)||o.push(t),window.localStorage.setItem(fl,JSON.stringify(o.slice(-200)))}catch{}}async function pl({userKey:e}={}){let t=e||"anon";Sm(t);let n=bm(t),r=indexedDB.open(n,wm);r.onupgradeneeded=()=>{let i=r.result;if(i.objectStoreNames.contains("meta")||i.createObjectStore("meta",{keyPath:"key"}),!i.objectStoreNames.contains("articles")){let s=i.createObjectStore("articles",{keyPath:"id"});s.createIndex("byUpdatedAt","updatedAt",{unique:!1}),s.createIndex("byDeletedAt","deletedAt",{unique:!1})}if(!i.objectStoreNames.contains("outline_sections")){let s=i.createObjectStore("outline_sections",{keyPath:"sectionId"});s.createIndex("byArticleId","articleId",{unique:!1}),s.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!i.objectStoreNames.contains("section_embeddings")){let s=i.createObjectStore("section_embeddings",{keyPath:"sectionId"});s.createIndex("byArticleId","articleId",{unique:!1}),s.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!i.objectStoreNames.contains("media_assets")){let s=i.createObjectStore("media_assets",{keyPath:"url"});s.createIndex("byStatus","status",{unique:!1}),s.createIndex("byFetchedAtMs","fetchedAtMs",{unique:!1}),s.createIndex("byStatusFetchedAtMs",["status","fetchedAtMs"],{unique:!1})}if(!i.objectStoreNames.contains("media_refs")){let s=i.createObjectStore("media_refs",{keyPath:"key"});s.createIndex("byArticleId","articleId",{unique:!1}),s.createIndex("byUrl","url",{unique:!1})}if(i.objectStoreNames.contains("outbox")){let s=r.transaction;try{let c=s.objectStore("outbox");c.indexNames.contains("byTypeCoalesceKey")||c.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}catch{}}else{let s=i.createObjectStore("outbox",{keyPath:"id"});s.createIndex("byCreatedAtMs","createdAtMs",{unique:!1}),s.createIndex("byTypeArticleId",["type","articleId"],{unique:!1}),s.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}if(!i.objectStoreNames.contains("pending_uploads")){let s=i.createObjectStore("pending_uploads",{keyPath:"token"});s.createIndex("byArticleId","articleId",{unique:!1}),s.createIndex("byCreatedAtMs","createdAtMs",{unique:!1})}};let o=await Ce(r);try{o.onversionchange=()=>{try{o.close()}catch{}}}catch{}return o}async function ml(e){let t=e.transaction(["meta"],"readonly"),n=t.objectStore("meta");await Ce(n.get("ping")),await Ue(t)}var wm,fl,En=Fe(()=>{wm=3,fl="ttree_offline_known_user_keys_v1"});async function yi({userKey:e}={}){let t=e||"anon";return gi&&hl===t||(hl=t,gi=(async()=>await pl({userKey:t}))()),gi}var gi,hl,ta=Fe(()=>{En();gi=null,hl=null});function bi(){try{return window?.localStorage?.getItem?.(xm)==="1"}catch{return!1}}function yl(){try{return window?.localStorage?.getItem?.(km)==="1"}catch{return!1}}function na(e,t={}){try{if(!bi())return;console.log("[perf][offline]",e,t)}catch{}}function Am(e){return e&&(e.id||e.username)||"anon"}async function wi(e){let t=Am(e);return jr&&gl===t||(gl=t,jr=(async()=>{let n=bi()?performance.now():0;a.offlineReady=!1,a.offlineInitStatus="initializing",a.offlineInitError="",a.offlineInitStartedAt=Date.now();try{yl()&&console.log("[offline] init start",{userKey:t})}catch{}try{let r=bi()?performance.now():0,o=await yi({userKey:t});r&&na("getOfflineDb()",{ms:Math.round(performance.now()-r)});let i=bi()?performance.now():0;await ml(o),i&&na("idb.ping",{ms:Math.round(performance.now()-i)});try{navigator?.storage?.persist&&navigator.storage.persist().catch(()=>{})}catch{}a.offlineReady=!0,a.offlineInitStatus="ready",a.offlineInitError="",a.offlineInitStartedAt=null;try{yl()&&console.log("[offline] init ready")}catch{}return n&&na("initOfflineForUser.total",{userKey:t,ms:Math.round(performance.now()-n)}),o}catch(r){a.offlineReady=!1,a.offlineInitStatus="error",a.offlineInitStartedAt=null;try{console.error("[offline] init failed",r)}catch{}let o=r?.message?`Offline \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430: ${r.message}`:"Offline \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0432 \u044D\u0442\u043E\u043C \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435";throw a.offlineInitError=o,L(o),r}})()),jr}async function st(){return jr||wi(a.currentUser)}var jr,gl,xm,km,Qn=Fe(()=>{ft();Et();ta();En();jr=null,gl=null,xm="ttree_profile_v1",km="ttree_debug_offline_v1"});function ra(e){if(!e)return"";if(e.type==="text")return String(e.text||"");let t=Array.isArray(e.content)?e.content:[];if(!t.length)return"";let n=[];for(let r of t){let o=ra(r);o&&n.push(o),r&&(r.type==="paragraph"||r.type==="hardBreak"||r.type==="heading")&&n.push(`
`)}return n.join("")}function bl(e){return String(e||"").replace(/\r\n/g,`
`).replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}function wl(e,t=[]){for(let n of e||[]){if(!n||n.type!=="outlineSection")continue;let r=String(n.attrs?.id||""),o=n.content?.[0],i=n.content?.[1],s=n.content?.[2],c=bl(ra(o))||"",d=bl(ra(i))||"",l=`${c}
${d}`.trim();r&&t.push({sectionId:r,title:c,text:l});let u=s?.content||[];wl(u,t)}return t}function Im(e){let t=Array.isArray(e?.content)?e.content:[];return wl(t,[])}async function Si(e,{articleId:t,docJson:n,updatedAt:r}){if(!e||!t||!n||typeof n!="object")return;let o=Im(n),i=e.transaction(["outline_sections"],"readwrite"),s=i.objectStore("outline_sections"),c=s.index("byArticleId"),d=IDBKeyRange.only(String(t)),l=await Ce(c.openCursor(d));for(;l;)l.delete(),l=await Ce(l.continue());for(let u of o)await Ce(s.put({sectionId:u.sectionId,articleId:String(t),title:u.title||"",text:u.text||"",updatedAt:r||null}));await Ue(i)}var Sl=Fe(()=>{En()});function ki(){try{return localStorage.getItem(Il)==="1"}catch{return!1}}function oa(e){let t=!!e;try{localStorage.setItem(Il,t?"1":"0")}catch{}try{window.dispatchEvent(new CustomEvent("media-prefetch-paused",{detail:{paused:t}}))}catch{}return t}function vl(){return oa(!ki())}async function El(e){let t=String(e||"").trim();if(!t)return{total:0,ok:0,error:0};let r=(await st()).transaction(["media_refs","media_assets"],"readonly"),o=r.objectStore("media_refs"),i=r.objectStore("media_assets"),s=o.index("byArticleId"),c=IDBKeyRange.only(t),d=0,l=0,u=0,f=await Ce(s.openCursor(c)).catch(()=>null);for(;f;){d+=1;let p=String(f.value?.url||"");if(p){let y=await Ce(i.get(p)).catch(()=>null);y?.status==="ok"&&(l+=1),y?.status==="error"&&(u+=1)}f=await Ce(f.continue()).catch(()=>null)}return await Ue(r),{total:d,ok:l,error:u}}function vm(e){let t=String(e||"").trim();if(!t)return null;try{let n=new URL(t,window.location.origin);return n.origin!==window.location.origin?/^https?:\/\/memus\.pro\b/i.test(t)&&n.pathname.startsWith("/uploads/")?n.pathname+(n.search||""):null:n.pathname.startsWith("/uploads/")?n.pathname+(n.search||""):null}catch{return t.startsWith("/uploads/")?t:null}}function Em(e){let t=new Set,n=r=>{if(!r)return;if(Array.isArray(r)){r.forEach(n);return}if(r.type==="image"){let i=vm(r.attrs?.src);i&&t.add(i)}(Array.isArray(r.content)?r.content:[]).forEach(n)};return n(e?.content||[]),Array.from(t)}async function Wr(e,t){let n=await st(),r=Em(t),o=n.transaction(["media_refs","media_assets"],"readwrite"),i=o.objectStore("media_refs"),s=o.objectStore("media_assets"),c=i.index("byArticleId"),d=IDBKeyRange.only(String(e)),l=await Ce(c.openCursor(d)).catch(()=>null);for(;l;)l.delete(),l=await Ce(l.continue()).catch(()=>null);for(let u of r){let f=`${String(e)}|${String(u)}`;await Ce(i.put({key:f,articleId:String(e),url:String(u)})),await Ce(s.get(u)).catch(()=>null)||await Ce(s.put({url:String(u),status:"needed",fetchedAtMs:0,failCount:0,lastError:null}))}await Ue(o)}async function Tl(e={}){let{maxFailCountOnly:t=!1}=e||{},r=(await st()).transaction(["media_assets"],"readwrite"),o=r.objectStore("media_assets"),i=await Ce(o.getAll()).catch(()=>[])||[];for(let s of i){if(!s?.url||String(s.status||"")!=="error")continue;let c=Number(s.failCount||0);t&&c<5||await Ce(o.put({...s,status:"needed",failCount:0,lastError:null,fetchedAtMs:0}))}await Ue(r)}async function xl(e,t){let n=e.transaction(["media_assets"],"readwrite"),r=n.objectStore("media_assets"),o=await Ce(r.get(t)).catch(()=>null);await Ce(r.put({...o||{},url:String(t),status:"ok",fetchedAtMs:Date.now(),failCount:0,lastError:null})),await Ue(n)}async function Tm(e,t,n){let r=String(n?.message||n||"error"),o=e.transaction(["media_assets"],"readwrite"),i=o.objectStore("media_assets"),s=await Ce(i.get(t)).catch(()=>null),c=Number(s?.failCount||0)+1;await Ce(i.put({...s||{},url:String(t),status:"error",fetchedAtMs:Date.now(),failCount:c,lastError:r})),await Ue(o)}async function Cm(e,t){let n=e.transaction(["media_assets"],"readonly"),o=n.objectStore("media_assets").index("byFetchedAtMs"),i=[],s=await Ce(o.openCursor()).catch(()=>null);for(;s;){let c=s.value,d=String(c?.status||""),l=Number(c?.failCount||0);if(d!=="ok"&&l<5){let u=String(c?.url||"");if(u&&i.push(u),i.length>=t)break}s=await Ce(s.continue()).catch(()=>null)}return await Ue(n),i}async function Bm(e,t){try{return!!await e.match(t,{ignoreSearch:!1})}catch{return!1}}async function Lm(e,t){let n=await fetch(t,{credentials:"include"});if(!n||!n.ok)throw new Error(`HTTP ${n?.status||0}`);await e.put(t,n.clone())}function Mm(){try{let e=navigator.connection||navigator.mozConnection||navigator.webkitConnection,t=String(e?.effectiveType||"");if(!!e?.saveData||t.includes("2g"))return 1;if(t.includes("3g"))return 2}catch{}return 3}function Ai(){if(kl)return;kl=!0;let e=async()=>{if(!navigator.onLine||ki())return;let t=Mm();if(xi>=t)return;let n=await st(),r=await caches.open(Al),o=await Cm(n,Math.max(5,t*3));if(o.length)for(let i of o){if(xi>=t)break;xi+=1,(async()=>{try{if(await Bm(r,i)){await xl(n,i);return}await Lm(r,i),await xl(n,i)}catch(s){await Tm(n,i,s)}finally{xi-=1}})()}};setInterval(()=>{e().catch(()=>{})},1200),window.addEventListener("online",()=>{e().catch(()=>{})})}async function Cl(){let e=await st(),t=await caches.open(Al),n=e.transaction(["media_assets","media_refs"],"readwrite"),r=n.objectStore("media_assets"),i=n.objectStore("media_refs").index("byUrl"),s=[],c=await Ce(r.openCursor()).catch(()=>null);for(;c&&s.length<500;){let d=String(c.value?.url||"");d&&(await Ce(i.count(IDBKeyRange.only(d))).catch(()=>0)||(s.push(d),c.delete())),c=await Ce(c.continue()).catch(()=>null)}if(await Ue(n),!s.length)return 0;for(let d of s)try{await t.delete(d)}catch{}return s.length}var Al,Il,kl,xi,ko=Fe(()=>{Qn();En();Al="memus-uploads-v1",Il="ttree_media_prefetch_paused_v1";kl=!1,xi=0});function _m(e=null){try{if(window?.localStorage?.getItem?.(Nm)!=="1")return!1;let t=String(window?.localStorage?.getItem?.(Pm)||"").trim();if(!t)return!0;let n=String(e||"").trim();return n?n===t:!0}catch{return!1}}function Om(){try{return window?.localStorage?.getItem?.(Dm)==="1"}catch{return!1}}function Rm(e){try{return JSON.stringify(e)}catch{return'"[unserializable]"'}}function Hm(e){try{let t=String(e||""),n=2166136261;for(let r=0;r<t.length;r+=1)n^=t.charCodeAt(r),n=Math.imul(n,16777619);return(n>>>0).toString(16)}catch{return"0"}}function Rt(e){try{return!e||typeof e!="object"?null:Hm(Rm(e))}catch{return null}}function at(e,t={}){try{let n=t?.articleId?String(t.articleId):null;if(!_m(n))return!1;let r={t:new Date().toISOString(),kind:String(e||"event"),data:t&&typeof t=="object"?t:{value:t}},o=[];try{let i=window?.localStorage?.getItem?.(Ii)||"";o=i?JSON.parse(i):[],Array.isArray(o)||(o=[])}catch{o=[]}o.push(r),o.length>250&&(o=o.slice(o.length-250));try{window?.localStorage?.setItem?.(Ii,JSON.stringify(o))}catch{}if(Om()&&navigator.onLine!==!1)try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:`revert:${r.kind}`,data:r})}).catch(()=>{})}catch{}return!0}catch{return!1}}function $m(){try{let e=window?.localStorage?.getItem?.(Ii)||"",t=e?JSON.parse(e):[];return Array.isArray(t)?t:[]}catch{return[]}}function Fm(){try{window?.localStorage?.removeItem?.(Ii)}catch{}}var Nm,Pm,Dm,Ii,Ao=Fe(()=>{Nm="ttree_debug_revert_v1",Pm="ttree_debug_revert_article_v1",Dm="ttree_client_log_v1",Ii="ttree_revert_log_v1";try{window.memusRevertLogDump=()=>$m(),window.memusRevertLogClear=()=>Fm()}catch{}});function zm(e){return{id:e.id,title:e.title,updatedAt:e.updatedAt,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:!!e.encrypted}}async function Kn(e){let t=await st(),n=Array.isArray(e)?e:[],r=50;for(let o=0;o<n.length;o+=r){let i=n.slice(o,o+r),s=t.transaction(["articles"],"readwrite"),c=s.objectStore("articles");for(let d of i){let l=zm(d),f={...await Ce(c.get(l.id)).catch(()=>null)||{},id:l.id,title:l.title||"",updatedAt:l.updatedAt||null,parentId:l.parentId??null,position:typeof l.position=="number"?l.position:0,publicSlug:l.publicSlug??null,encrypted:l.encrypted?1:0,deletedAt:null};await Ce(c.put(f))}await Ue(s),await new Promise(d=>setTimeout(d,0))}}async function _n(){let t=(await st()).transaction(["articles"],"readonly"),n=t.objectStore("articles"),r=await Ce(n.getAll()).catch(()=>[])||[];return await Ue(t),r.filter(o=>o&&!o.deletedAt).sort((o,i)=>Number(o.position||0)-Number(i.position||0)).map(o=>({id:o.id,title:o.title||"",updatedAt:o.updatedAt||null,parentId:o.parentId??null,position:typeof o.position=="number"?o.position:0,publicSlug:o.publicSlug??null,encrypted:!!o.encrypted}))}async function Bl(){let t=(await st()).transaction(["articles"],"readonly"),n=t.objectStore("articles"),r=await Ce(n.getAll()).catch(()=>[])||[];return await Ue(t),r.filter(o=>o&&!o.deletedAt).map(o=>({id:o.id,updatedAt:o.updatedAt||null,hasDocJson:!!o.docJsonStr}))}async function Cr(e){if(!e||!e.id)return;let t=await st(),n=e.docJson&&typeof e.docJson=="object"?e.docJson:null,r=e.updatedAt||null,o=t.transaction(["articles"],"readwrite"),i=o.objectStore("articles"),s=await Ce(i.get(e.id)).catch(()=>null),c=null;try{c=s?.articleJsonStr?JSON.parse(s.articleJsonStr):null}catch{c=null}let d=!!(c&&c.localDraft),l=e&&Object.prototype.hasOwnProperty.call(e,"outlineStructureRev")?Number(e.outlineStructureRev):null;try{let f=String(s?.updatedAt||"").trim(),p=String(r||"").trim();if(f&&p&&p<f){at("cache.article.put.skip_older",{articleId:e.id,existingUpdatedAt:f,incomingUpdatedAt:p,incomingDocHash:Rt(n)}),await Ue(o);return}if(d&&f&&p&&f===p){let y=Rt(s?.docJsonStr?JSON.parse(s.docJsonStr):null),b=Rt(n);if(y&&b&&y!==b){let h=c&&typeof c=="object"?{...c}:{};h.id=e.id,h.title=e.title||h.title||"",h.updatedAt=f,h.parentId=e.parentId??h.parentId??null,h.position=typeof e.position=="number"?e.position:h.position??0,h.publicSlug=e.publicSlug??h.publicSlug??null,h.encrypted=!!e.encrypted,Object.prototype.hasOwnProperty.call(e,"outlineStructureRev")&&(h.outlineStructureRev=Number(e.outlineStructureRev)||0),h.localDraft=!0;let g={...s||{},id:e.id,title:e.title||"",updatedAt:f,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:e.encrypted?1:0,deletedAt:null,outlineStructureRev:Number.isFinite(l)?l:Number(s?.outlineStructureRev),docJsonStr:s?.docJsonStr??null,articleJsonStr:JSON.stringify(h)};await Ce(i.put(g)),await Ue(o);try{at("cache.article.put.skip_localDraft",{articleId:e.id,updatedAt:f,existingDocHash:y,incomingDocHash:b})}catch{}return}}}catch{}let u={...s||{},id:e.id,title:e.title||"",updatedAt:r,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:e.encrypted?1:0,deletedAt:null,outlineStructureRev:Number.isFinite(l)?l:Number(s?.outlineStructureRev),docJsonStr:n?JSON.stringify(n):null,articleJsonStr:JSON.stringify(e)};await Ce(i.put(u)),await Ue(o);try{at("cache.article.put",{articleId:e.id,updatedAt:r,hasDocJson:!!n,docHash:Rt(n)})}catch{}n&&(Si(t,{articleId:e.id,docJson:n,updatedAt:r}).catch(()=>{}),Wr(e.id,n).catch(()=>{}))}async function Ll(e,t){if(!e||!t)return;let n=await st(),r=String(t),o=e.docJson&&typeof e.docJson=="object"?e.docJson:null,i=e.updatedAt||null,s=n.transaction(["articles"],"readwrite"),c=s.objectStore("articles"),d=await Ce(c.get(r)).catch(()=>null);try{let u=String(d?.updatedAt||"").trim(),f=String(i||"").trim();if(u&&f&&f<u){at("cache.articleUnderId.put.skip_older",{articleId:r,existingUpdatedAt:u,incomingUpdatedAt:f,incomingDocHash:Rt(o)}),await Ue(s);return}}catch{}let l={...d||{},id:r,title:e.title||d?.title||"",updatedAt:i||d?.updatedAt||null,parentId:e.parentId??d?.parentId??null,position:typeof e.position=="number"?e.position:d?.position||0,publicSlug:e.publicSlug??d?.publicSlug??null,encrypted:e.encrypted||d?.encrypted?1:0,deletedAt:null,docJsonStr:o?JSON.stringify(o):d?.docJsonStr??null,articleJsonStr:JSON.stringify(e)};await Ce(c.put(l)),await Ue(s),o&&(Si(n,{articleId:r,docJson:o,updatedAt:i}).catch(()=>{}),Wr(r,o).catch(()=>{}))}async function Jn(e){if(!e)return null;let n=(await st()).transaction(["articles"],"readonly"),r=n.objectStore("articles"),o=await Ce(r.get(e)).catch(()=>null);if(await Ue(n),!o)return null;try{let i=JSON.parse(o.articleJsonStr||"null");return i&&!i.docJson&&o.docJsonStr&&(i.docJson=JSON.parse(o.docJsonStr)),i}catch{try{let i=o.docJsonStr?JSON.parse(o.docJsonStr):null,s={id:e,title:o.title||"",createdAt:o.createdAt||o.updatedAt||null,updatedAt:o.updatedAt||null,deletedAt:o.deletedAt||null,parentId:o.parentId??null,position:typeof o.position=="number"?o.position:0,authorId:null,publicSlug:o.publicSlug??null,encrypted:!!o.encrypted,outlineStructureRev:Number.isFinite(Number(o.outlineStructureRev))?Number(o.outlineStructureRev):void 0,docJson:i&&typeof i=="object"?i:null,history:[],redoHistory:[],blockTrash:[]};try{at("cache.article.get.fallback_docJsonStr",{articleId:e,updatedAt:s.updatedAt||null,docHash:Rt(s.docJson)})}catch{}return s}catch{return null}}}async function ln(e,t,n){if(!e)return;let r=await st(),o=r.transaction(["articles"],"readwrite"),i=o.objectStore("articles"),s=await Ce(i.get(e)).catch(()=>null),c=n||s&&s.updatedAt||null,d=()=>{let f=String(e)==="inbox"?"\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438":"",p=(s&&typeof s.title=="string"?s.title:"")||f,y=c,b={id:e,title:p,createdAt:s&&s.createdAt||y||null,updatedAt:y,deletedAt:s&&s.deletedAt||null,parentId:(s&&s.parentId)??null,position:typeof(s&&s.position)=="number"?s.position:0,authorId:null,publicSlug:(s&&s.publicSlug)??null,encrypted:!!(s&&s.encrypted),docJson:null,history:[],blocks:[]};return JSON.stringify(b)},l=()=>{let f=s&&s.articleJsonStr||"",p=null;try{p=f?JSON.parse(f):null}catch{p=null}if(!p||typeof p!="object")try{p=JSON.parse(d())}catch{p={id:e}}return p.id=e,p.updatedAt=c||p.updatedAt||null,p.docJson=t&&typeof t=="object"?t:null,t&&typeof t=="object"&&(p.localDraft=!0),!p.title&&s?.title&&(p.title=s.title),p.deletedAt===void 0&&(p.deletedAt=null),p.parentId===void 0&&(p.parentId=s?.parentId??null),p.position===void 0&&(p.position=typeof s?.position=="number"?s.position:0),p.publicSlug===void 0&&(p.publicSlug=s?.publicSlug??null),p.encrypted===void 0&&(p.encrypted=!!s?.encrypted),p.history===void 0&&(p.history=[]),p.blocks===void 0&&(p.blocks=[]),JSON.stringify(p)},u={...s||{id:e},id:e,outlineStructureRev:s?.outlineStructureRev,docJsonStr:t?JSON.stringify(t):null,updatedAt:c,articleJsonStr:l()};await Ce(i.put(u)),await Ue(o);try{at("cache.docJson.put",{articleId:e,updatedAt:c,docHash:Rt(t)})}catch{}t&&typeof t=="object"&&(Si(r,{articleId:e,docJson:t,updatedAt:n}).catch(()=>{}),Wr(e,t).catch(()=>{}))}async function Ml(e){let t=String(e||"").trim();if(!t)return;let r=(await st()).transaction(["articles"],"readwrite"),o=r.objectStore("articles"),i=await Ce(o.get(t)).catch(()=>null);if(!i){await Ue(r);return}let s=null;try{s=i.articleJsonStr?JSON.parse(i.articleJsonStr):null}catch{s=null}(!s||typeof s!="object")&&(s={id:t}),s.id=t,delete s.localDraft;let c={...i,articleJsonStr:JSON.stringify(s)};await Ce(o.put(c)),await Ue(r)}async function Yr(e){let t=await st(),n=Array.isArray(e)?e:[];if(!n.length)return;let r=t.transaction(["articles"],"readwrite"),o=r.objectStore("articles");for(let i of n){if(!i||!i.id)continue;let s=await Ce(o.get(i.id)).catch(()=>null);if(!s)continue;let c={...s,parentId:i.parentId??null,position:typeof i.position=="number"?i.position:0};await Ce(o.put(c))}await Ue(r)}async function ia(e,t){let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return;let i=(await st()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),c=await Ce(s.get(n)).catch(()=>null);if(!c){await Ue(i);return}let d=null;try{d=c.articleJsonStr?JSON.parse(c.articleJsonStr):null}catch{d=null}(!d||typeof d!="object")&&(d={id:n}),d.id=n,d.updatedAt=r;let l={...c,updatedAt:r,articleJsonStr:JSON.stringify(d)};await Ce(s.put(l)),await Ue(i)}async function sa(e,t){let n=String(e||"").trim();if(!n)return;let r=Number(t);if(!Number.isFinite(r)||r<0)return;let i=(await st()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),c=await Ce(s.get(n)).catch(()=>null);if(!c){await Ue(i);return}let d=null;try{d=c.articleJsonStr?JSON.parse(c.articleJsonStr):null}catch{d=null}(!d||typeof d!="object")&&(d={id:n}),d.id=n,d.outlineStructureRev=r;let l={...c,outlineStructureRev:r,articleJsonStr:JSON.stringify(d)};await Ce(s.put(l)),await Ue(i)}var Io=Fe(()=>{Qn();En();Sl();ko();Ao()});function aa(){try{window.dispatchEvent(new CustomEvent("offline-outbox-changed"))}catch{}}function Um(){return globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?globalThis.crypto.randomUUID():`id-${Date.now()}-${Math.random().toString(16).slice(2)}`}function Nl(){return new Date().toISOString()}async function Nt(e,{articleId:t,payload:n,coalesceKey:r}={}){let o=await st(),i=Um(),s=Nl(),c=n?JSON.stringify(n):"{}",d=o.transaction(["outbox"],"readwrite"),l=d.objectStore("outbox"),u=l.index("byTypeArticleId"),f=l.index("byTypeCoalesceKey");if(r){let p=[String(e||""),String(r||"")],y=await Ce(f.openCursor(IDBKeyRange.only(p))).catch(()=>null);for(;y;)y.delete(),y=await Ce(y.continue()).catch(()=>null)}else if(t){let p=[String(e||""),t||null],y=await Ce(u.openCursor(IDBKeyRange.only(p))).catch(()=>null);for(;y;)y.delete(),y=await Ce(y.continue()).catch(()=>null)}return await Ce(l.put({id:i,createdAt:s,createdAtMs:Date.now(),type:String(e||""),articleId:t||null,coalesceKey:r?String(r):null,payloadJson:c,attempts:0,lastError:null,lastAttemptAt:null})),await Ue(d),aa(),i}async function Br(e=50){let n=(await st()).transaction(["outbox"],"readonly"),o=n.objectStore("outbox").index("byCreatedAtMs"),i=[],s=await Ce(o.openCursor()).catch(()=>null);for(;s&&(i.push(s.value),!(i.length>=e));)s=await Ce(s.continue()).catch(()=>null);return await Ue(n),i.map(c=>{let d={};try{d=JSON.parse(c?.payloadJson||"{}")}catch{d={}}return{id:c.id,createdAt:c.createdAt,type:c.type,articleId:c.articleId,payload:d,attempts:c.attempts||0}})}async function Pl(e,t){let r=(await st()).transaction(["outbox"],"readwrite"),o=r.objectStore("outbox"),i=await Ce(o.get(e)).catch(()=>null);i&&await Ce(o.put({...i,attempts:Number(i.attempts||0)+1,lastError:String(t||"error"),lastAttemptAt:Nl()})),await Ue(r),aa()}async function pr(e){let n=(await st()).transaction(["outbox"],"readwrite"),r=n.objectStore("outbox");await Ce(r.delete(e)),await Ue(n),aa()}var vo=Fe(()=>{Qn();En()});function _l(e){let t=Array.isArray(e)?e:[],n=new Float32Array(t.length),r=0;for(let o=0;o<t.length;o+=1){let i=Number(t[o]||0);n[o]=i,r+=i*i}if(r>0){let o=1/Math.sqrt(r);for(let i=0;i<n.length;i+=1)n[i]*=o}return n}function Ol(){vi=null,Dl=0}async function ca(e,t){if(!e)return;let n=await st(),r=Array.isArray(t)?t:[],o=n.transaction(["section_embeddings"],"readwrite"),i=o.objectStore("section_embeddings");for(let s of r){let c=String(s?.blockId||s?.sectionId||""),d=String(s?.updatedAt||"")||null,l=s?.embedding;if(!c||!Array.isArray(l)||!l.length)continue;let u=_l(l);await Ce(i.put({sectionId:c,articleId:String(e),updatedAt:d,vec:u}))}await Ue(o),Ol()}async function Ei(e){let t=(e||[]).map(i=>String(i||"")).filter(Boolean);if(!t.length)return;let r=(await st()).transaction(["section_embeddings"],"readwrite"),o=r.objectStore("section_embeddings");for(let i of t)await Ce(o.delete(i));await Ue(r),Ol()}async function Rl(){let t=(await st()).transaction(["section_embeddings"],"readonly"),n=t.objectStore("section_embeddings"),r=await Ce(n.count());return await Ue(t),Number(r||0)}async function Hl(){if(vi)return vi;let t=(await st()).transaction(["section_embeddings"],"readonly"),n=t.objectStore("section_embeddings"),r=await Ce(n.getAll()).catch(()=>[])||[];await Ue(t);let o=[];for(let i of r){let s=String(i?.sectionId||""),c=String(i?.articleId||""),d=i?.vec;if(!s||!c||!d)continue;let l=null;d instanceof Float32Array?l=d:d instanceof ArrayBuffer?l=new Float32Array(d):Array.isArray(d)&&(l=_l(d)),!(!l||!l.length)&&o.push({sectionId:s,articleId:c,vec:l})}return vi=o,Dl=Date.now(),o}function $l(e,t){let n=Math.min(e.length,t.length),r=0;for(let o=0;o<n;o+=1)r+=e[o]*t[o];return r}var vi,Dl,la=Fe(()=>{Qn();En();vi=null,Dl=0});function Vm(e){let t=Array.isArray(e)?e:[],n=new Float32Array(t.length),r=0;for(let o=0;o<t.length;o+=1){let i=Number(t[o]||0);n[o]=i,r+=i*i}if(r>0){let o=1/Math.sqrt(r);for(let i=0;i<n.length;i+=1)n[i]*=o}return n}async function qm(e){let t=String(e||"").trim();if(!t)return null;let n=await fetch(`/api/search/semantic/query-embedding?q=${encodeURIComponent(t)}`,{method:"GET",credentials:"include",headers:{"Content-Type":"application/json"}});if(!n.ok){let i=await n.json().catch(()=>({}));throw new Error(i.detail||"Embedding failed")}let o=(await n.json().catch(()=>null))?.embedding;return!Array.isArray(o)||!o.length?null:Vm(o)}async function Km(e){let t=(e||[]).map(d=>String(d||"")).filter(Boolean);if(!t.length)return[];let r=(await st()).transaction(["outline_sections","articles"],"readonly"),o=r.objectStore("outline_sections"),i=r.objectStore("articles"),s=[];for(let d of t){let l=await Ce(o.get(d)).catch(()=>null);l&&s.push({blockId:String(l.sectionId||d),articleId:String(l.articleId||""),blockText:String(l.text||"")})}let c=new Map;for(let d of s){if(!d.articleId||c.has(d.articleId))continue;let l=await Ce(i.get(d.articleId)).catch(()=>null);c.set(d.articleId,String(l?.title||""))}return await Ue(r),s.map(d=>({blockId:d.blockId,articleId:d.articleId,articleTitle:c.get(d.articleId)||"",blockText:d.blockText}))}async function Fl(e,{limit:t=30}={}){let n=String(e||"").trim();if(!n||!navigator.onLine||!await Rl().catch(()=>0))return null;let o=await qm(n);if(!o)return null;let i=await Hl();if(!i.length)return null;let s=Math.max(1,Math.min(Number(t)||30,50)),c=[];for(let p of i){let y=$l(o,p.vec);if(Number.isFinite(y)){if(c.length<s){c.push({sectionId:p.sectionId,score:y}),c.length===s&&c.sort((b,h)=>b.score-h.score);continue}y<=c[0].score||(c[0]={sectionId:p.sectionId,score:y},c.sort((b,h)=>b.score-h.score))}}c.sort((p,y)=>y.score-p.score);let d=c.map(p=>p.sectionId),l=await Km(d),u=new Map(l.map(p=>[p.blockId,p])),f=[];for(let p of c){let y=u.get(p.sectionId);if(!y)continue;let b=y.blockText||"";f.push({type:"block",articleId:y.articleId,articleTitle:y.articleTitle,blockId:y.blockId,snippet:b.slice(0,160),blockText:b,score:p.score})}return f}var zl=Fe(()=>{Qn();la();En()});function Ti(){try{return window?.localStorage?.getItem?.(Jm)==="1"}catch{return!1}}function Wt(...e){try{if(!Ti())return;console.log(...e)}catch{}}async function De(e,t={}){let n=Ti()?performance.now():0,r=n?performance.now():0,o=await fetch(e,{headers:{"Content-Type":"application/json",...t.headers||{}},credentials:"include",...t}),i=r?performance.now():0;if(!o.ok){if(o.status===401||o.status===403){try{a.serverStatus="auth",a.serverStatusText="auth"}catch{}try{window.dispatchEvent(new CustomEvent("memus:auth-required",{detail:{path:e,status:o.status}}))}catch{}}let l=await o.json().catch(()=>({}));throw n&&console.log("[perf][api]",e,{status:o.status,ms:Math.round(performance.now()-n),fetchMs:i?Math.round(i-r):null}),new Error(l.detail||"Request failed")}try{a.serverStatus==="down"&&(a.serverStatus="ok",a.serverStatusText="")}catch{}if(o.status===204)return n&&console.log("[perf][api]",e,{status:204,ms:Math.round(performance.now()-n),fetchMs:i?Math.round(i-r):null}),null;let s=n?performance.now():0,c=await o.json(),d=n?performance.now():0;try{if(window?.localStorage?.getItem?.("ttree_debug_article_load_v1")==="1"){let l=o.headers.get("X-Memus-Article-ms"),u=o.headers.get("X-Memus-DocJson-bytes");(l||u)&&console.log("[api]",e,{ms:l,docJsonBytes:u})}}catch{}if(n){let l=o.headers.get("X-Memus-Article-ms")||o.headers.get("X-Memus-Articles-ms")||o.headers.get("X-Memus-Server-ms"),u=o.headers.get("X-Memus-DocJson-bytes"),f=o.headers.get("X-Memus-Articles-count"),p=o.headers.get("Content-Length");console.log("[perf][api]",e,{status:o.status,ms:Math.round(d-n),fetchMs:i?Math.round(i-r):null,jsonMs:s?Math.round(d-s):null,serverMs:l?Number(l):null,docJsonBytes:u?Number(u):null,articlesCount:f?Number(f):null,contentLength:p?Number(p):null})}return c}async function ql(){await fetch("/api/auth/logout",{method:"POST",credentials:"include"})}function Wm(){try{return window?.localStorage?.getItem?.(jm)==="1"}catch{return!1}}async function Ul({timeoutMs:e}){let t=typeof e=="number"?Math.max(0,Math.floor(e)):0,n=null,r=null;try{return t>0&&typeof AbortController<"u"&&(r=new AbortController,n=setTimeout(()=>{try{r.abort()}catch{}},t)),await De("/api/articles",r?{signal:r.signal}:{})}catch(o){if((o?.message||String(o||"")).toLowerCase().includes("abort"))try{a.serverStatus="down",a.serverStatusText="timeout"}catch{}throw o}finally{n&&clearTimeout(n)}}function yn(){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return _n().catch(()=>[]);if(Eo)return Eo;let e=a?.offlineReady?600:250,t=2200;return Eo=(async()=>{let n=Ti()?performance.now():0,r=null,o=!1,i=new Promise(l=>{r=setTimeout(()=>{!o&&n&&Wt("[offline-first][articles] cache.lookup.timeout",{preferCacheMs:e}),l(null)},e)}),s=_n().then(l=>(o=!0,r&&clearTimeout(r),r=null,n&&Wt("[offline-first][articles] cache.lookup.done",{ms:Math.round(performance.now()-n),hit:!!(l&&l.length)}),l)).catch(()=>(o=!0,r&&clearTimeout(r),r=null,null)),c=await Promise.race([s,i]);if(c&&c.length)return da||(da=Ul({timeoutMs:t}).then(async l=>{try{typeof requestIdleCallback=="function"?requestIdleCallback(()=>Kn(l).catch(()=>{}),{timeout:2500}):setTimeout(()=>Kn(l).catch(()=>{}),250)}catch{Kn(l).catch(()=>{})}}).catch(()=>{}).finally(()=>{da=null})),c;let d=await Ul({timeoutMs:t});try{typeof requestIdleCallback=="function"?requestIdleCallback(()=>Kn(d).catch(()=>{}),{timeout:2500}):setTimeout(()=>Kn(d).catch(()=>{}),250)}catch{Kn(d).catch(()=>{})}try{let l=await _n().catch(()=>null),u=Array.isArray(d)?d.length:0,f=l&&Array.isArray(l)?l.length:0;if(f>=20&&u<=3||Wm()&&f&&f>u)return l}catch{}return d})().catch(async n=>{let r=await _n().catch(()=>null);if(r&&r.length)return r;throw n}).finally(()=>{Eo=null}),Eo}function Kl(){return typeof navigator<"u"&&navigator&&navigator.onLine===!1?Promise.resolve([]):De("/api/articles/deleted").catch(async e=>[])}function Jl(e,t={}){let{cacheTimeoutMs:n,metaTimeoutMs:r,...o}=t||{},i=a?.offlineReady?400:150,s=typeof n=="number"?Math.max(0,Math.floor(n)):i,c=typeof r=="number"?Math.max(0,Math.floor(r)):350,d=Ti()?performance.now():0,l=null,u=!1,f=new Promise(B=>{l=setTimeout(()=>{!u&&d&&Wt("[offline-first][article] cache.lookup.timeout",{id:e,cacheTimeoutMs:s}),B(null)},s)}),p=Jn(e).then(B=>(u=!0,l&&clearTimeout(l),l=null,d&&Wt("[offline-first][article] cache.lookup.done",{id:e,ms:Math.round(performance.now()-d),hit:!!B}),B)).catch(B=>(u=!0,l&&clearTimeout(l),l=null,d&&Wt("[offline-first][article] cache.lookup.failed",{id:e,ms:Math.round(performance.now()-d),message:B?.message||String(B||"")}),null)),y=Promise.race([p,f]),b=()=>De(`/api/articles/${e}?include_history=0`,{...o,cache:"no-store"}).then(async B=>{try{at("article.fetch.network.ok",{articleId:e,updatedAt:B?.updatedAt||null,docHash:Rt(B?.docJson||null)})}catch{}return Cr(B).catch(()=>{}),B&&B.id&&String(B.id)!==String(e)&&Ll(B,e).catch(()=>{}),B}).catch(async B=>{let $=await Jn(e).catch(()=>null);try{at("article.fetch.network.err",{articleId:e,message:B?.message||String(B||""),cachedHit:!!$,cachedUpdatedAt:$?.updatedAt||null,cachedDocHash:Rt($?.docJson||null)})}catch{}if($)return $;throw B}),h=()=>{let B=new Date().toISOString(),U={type:"doc",content:[{type:"outlineSection",attrs:{id:(globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?()=>globalThis.crypto.randomUUID():()=>`id-${Date.now()}-${Math.random().toString(16).slice(2)}`)(),collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}]};return{id:"inbox",title:"\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438",createdAt:B,updatedAt:B,deletedAt:null,parentId:null,position:0,authorId:null,publicSlug:null,encrypted:!1,docJson:U,history:[]}},g="ttree_pending_quick_notes_v1",w=()=>{try{let B=window?.localStorage?.getItem?.(g)||"";if(!B)return[];let $=JSON.parse(B);return Array.isArray($)?$.filter(Boolean):[]}catch{return[]}},S=(B,$)=>{let U=String(B||"").trim();if(!U)return null;let J=String($||"").trim().split(/\r?\n/),re=[];for(let he=0;he<J.length;he+=1){let Re=J[he];Re&&re.push({type:"text",text:Re}),he!==J.length-1&&re.push({type:"hardBreak"})}return{type:"outlineSection",attrs:{id:U,collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[re.length?{type:"paragraph",content:re}:{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}},x=B=>{try{if(!B||String(B.id||"")!=="inbox")return B;let $=w();if(!$.length)return B;let U=B?.docJson&&typeof B.docJson=="object"?B.docJson:{type:"doc",content:[]},Y=Array.isArray(U.content)?U.content:[],J=new Set(Y.filter(he=>he&&he.type==="outlineSection"&&he.attrs&&he.attrs.id).map(he=>String(he.attrs.id))),re=[];for(let he of $){let Re=String(he?.sectionId||he?.id||"").trim();if(!Re||J.has(Re))continue;let G=S(Re,he?.text||"");G&&re.push(G)}return re.length?{...B,docJson:{...U,type:U.type||"doc",content:[...re,...Y]}}:B}catch{return B}},T=()=>De(`/api/articles/${encodeURIComponent(e)}/meta`,{method:"GET",headers:{...o.headers||{}},cache:"no-store"}),N=()=>c?Promise.race([T(),new Promise((B,$)=>setTimeout(()=>{let U=new Error("meta_timeout");U.name="TimeoutError",$(U)},c))]):T();return y.then(async B=>{if(!B){if(!navigator.onLine&&String(e)==="inbox")return Wt("[offline-first][article] choose.local.inbox.offline",{id:e}),x(h());let U=p.then(re=>re?{src:"cache",article:x(re)}:new Promise(()=>{})).catch(()=>new Promise(()=>{})),Y=(async()=>({src:"network",article:await x(b())}))(),J=await Promise.race([U,Y]);if(J?.src==="cache"){Wt("[offline-first][article] choose.cache.late",{id:e});try{at("article.choose",{articleId:e,choose:"cache.late"})}catch{}return Y.catch(()=>{}),J.article}Wt("[offline-first][article] choose.network.no-cache",{id:e});try{at("article.choose",{articleId:e,choose:"network.no_cache"})}catch{}return J.article}if(!navigator.onLine){Wt("[offline-first][article] choose.cache.offline",{id:e,updatedAt:B?.updatedAt||null});try{at("article.choose",{articleId:e,choose:"cache.offline",cachedUpdatedAt:B?.updatedAt||null,cachedDocHash:Rt(B?.docJson||null)})}catch{}return x(B)}let $=String(B.updatedAt||B.updated_at||"").trim();if(!$){Wt("[offline-first][article] choose.network.no-cached-updatedAt",{id:e});try{at("article.choose",{articleId:e,choose:"network.no_cached_updatedAt",cachedDocHash:Rt(B?.docJson||null)})}catch{}return x(await b())}try{Wt("[offline-first][article] meta.check.start",{id:e,cachedUpdatedAt:$});let U=await N(),Y=String(U?.updatedAt||"").trim();if(Y&&Y===$){Wt("[offline-first][article] choose.cache.meta.same",{id:e,cachedUpdatedAt:$});try{at("article.choose",{articleId:e,choose:"cache.meta.same",cachedUpdatedAt:$,serverUpdatedAt:Y,cachedDocHash:Rt(B?.docJson||null)})}catch{}return x(B)}Wt("[offline-first][article] choose.network.meta.diff",{id:e,cachedUpdatedAt:$,serverUpdatedAt:Y||null});try{at("article.choose",{articleId:e,choose:"network.meta.diff",cachedUpdatedAt:$,serverUpdatedAt:Y||null,cachedDocHash:Rt(cached?.docJson||null)})}catch{}return x(await b())}catch(U){String(U?.name||"")==="TimeoutError"||String(U?.message||"")==="meta_timeout"?Wt("[offline-first][article] meta.check.timeout",{id:e,metaTimeoutMs:c}):Wt("[offline-first][article] meta.check.failed",{id:e,message:U?.message||String(U||"")}),b().catch(()=>{}),String(U?.name||"")==="TimeoutError"||String(U?.message||"")==="meta_timeout"?Wt("[offline-first][article] choose.cache.meta.timeout",{id:e,cachedUpdatedAt:$,metaTimeoutMs:c}):Wt("[offline-first][article] choose.cache.meta.failed",{id:e,cachedUpdatedAt:$});try{at("article.choose",{articleId:e,choose:String(U?.name||"")==="TimeoutError"||String(U?.message||"")==="meta_timeout"?"cache.meta.timeout":"cache.meta.failed",cachedUpdatedAt:$,cachedDocHash:Rt(B?.docJson||null),error:U?.message||String(U||"")})}catch{}return x(B)}})}function jl(e){return e?De(`/api/articles/${encodeURIComponent(e)}/history`,{method:"GET"}):Promise.reject(new Error("articleId is required"))}function Wl(e){return De(`/api/search?q=${encodeURIComponent(e.trim())}`)}function Yl(e){let t=(e||"").trim();return t?Fl(t).then(n=>Array.isArray(n)&&n.length?n:De(`/api/search?q=${encodeURIComponent(t)}`)).catch(()=>De(`/api/search?q=${encodeURIComponent(t)}`)):Promise.resolve([])}function Xl(e,t){return De("/api/search/semantic/rag-summary",{method:"POST",body:JSON.stringify({query:(e||"").trim(),results:Array.isArray(t)?t:[]})})}function Gl(e){let t=()=>De("/api/articles",{method:"POST",body:JSON.stringify({title:e})});if(navigator.onLine)return t().then(async o=>(Cr(o).catch(()=>{}),o));let n=globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?globalThis.crypto.randomUUID():`id-${Date.now()}-${Math.random().toString(16).slice(2)}`,r=new Date().toISOString();return _n().catch(()=>[]).then(o=>{let s=(o||[]).filter(d=>!d.parentId).reduce((d,l)=>Math.max(d,Number(l.position||0)),-1),c={id:n,title:e||"\u041D\u043E\u0432\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F",updatedAt:r,createdAt:r,docJson:null,blocks:[],encrypted:!1,parentId:null,position:s+1};return Cr(c).catch(()=>{}),Nt("create_article",{articleId:n,payload:{id:n,title:c.title}}).catch(()=>{}),c})}function Ql(e,t){return e?!t||typeof t!="object"?Promise.reject(new Error("docJson must be object")):De(`/api/articles/${encodeURIComponent(e)}/doc-json`,{method:"PUT",body:JSON.stringify({docJson:t})}):Promise.reject(new Error("articleId is required"))}function Zl(e){return typeof e!="string"?Promise.reject(new Error("text must be string")):De("/api/outline/generate-title",{method:"POST",body:JSON.stringify({text:e})})}function ed(e){return typeof e!="string"?Promise.reject(new Error("html must be string")):De("/api/outline/proofread-html",{method:"POST",body:JSON.stringify({html:e})})}function Ci(e,t={}){let n=t.force?"?force=true":"";return De(`/api/articles/${e}${n}`,{method:"DELETE"})}function td(e){return De(`/api/articles/${e}/restore`,{method:"POST"})}function nd(e,t,n={}){let r=Array.isArray(t)?t.filter(Boolean).map(o=>String(o)):[];return e?r.length?De(`/api/articles/${encodeURIComponent(e)}/sections/delete`,{method:"PUT",cache:"no-store",body:JSON.stringify({opId:n?.opId||null,sectionIds:r})}):Promise.resolve({status:"ok",removedBlockIds:[]}):Promise.reject(new Error("articleId is required"))}function rd(e){let t={};return e&&(t["X-Users-Password"]=e),De("/api/users",{headers:t})}function od(e){return De(`/api/users/${e}`,{method:"DELETE"})}function id(){return De("/api/telegram/link-token",{method:"POST",body:JSON.stringify({})})}function Co(e){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return Promise.reject(new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D"));let t=new FormData;t.append("file",e);let n=i=>{if(!(typeof navigator<"u"&&navigator&&navigator.onLine===!1))try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"uploadImageFile",data:i})}).catch(()=>{})}catch{}},r=()=>fetch("/api/uploads",{method:"POST",credentials:"include",body:t}).then(async i=>{let s=await i.json().catch(()=>null);if(n({transport:"fetch",status:i.status,ok:i.ok,details:s,name:e&&e.name,type:e&&e.type,size:e&&e.size}),!i.ok){let c=s?.detail||`Upload failed (status ${i.status})`,d=new Error(c);throw d.status=i.status,d.details=s,d}return s}),o=()=>new Promise((i,s)=>{let c=new XMLHttpRequest;c.open("POST","/api/uploads"),c.withCredentials=!0,c.onreadystatechange=()=>{if(c.readyState===XMLHttpRequest.DONE)try{let d=c.status,l=null;try{l=JSON.parse(c.responseText||"null")}catch{l=null}if(n({transport:"xhr",status:d,ok:d>=200&&d<300,details:l,name:e&&e.name,type:e&&e.type,size:e&&e.size}),d>=200&&d<300)i(l);else{let u=l&&l.detail||`Upload failed (status ${d})`,f=new Error(u);f.status=d,f.details=l,s(f)}}catch(d){s(d)}},c.onerror=()=>{n({transport:"xhr",status:0,ok:!1,details:{detail:"Network error during image upload"},name:e&&e.name,type:e&&e.type,size:e&&e.size});let d=new Error("Upload failed (network error)");d.status=0,d.details={detail:"Network error during image upload"},s(d)},c.send(t)});return r().catch(i=>{let s=String(i&&i.message?i.message:"").toLowerCase();if(s.includes("status ")||s.includes("upload failed"))throw i;return o()})}function sd(e,t=null){if(!e)return Promise.reject(new Error("articleId is required"));let n={};return t&&(n.label=String(t)),De(`/api/articles/${encodeURIComponent(e)}/versions`,{method:"POST",body:JSON.stringify(n)})}function ad(e){return e?De(`/api/articles/${encodeURIComponent(e)}/versions`,{method:"GET"}):Promise.reject(new Error("articleId is required"))}function cd(e,t){return e?t?De(`/api/articles/${encodeURIComponent(e)}/versions/${encodeURIComponent(t)}/restore`,{method:"POST",body:JSON.stringify({})}):Promise.reject(new Error("versionId is required")):Promise.reject(new Error("articleId is required"))}function ua(e,t){return e?t?De(`/api/articles/${encodeURIComponent(e)}/versions/${encodeURIComponent(t)}`,{method:"GET"}):Promise.reject(new Error("versionId is required")):Promise.reject(new Error("articleId is required"))}function Ym(e,t,n=()=>{}){return typeof navigator<"u"&&navigator&&navigator.onLine===!1?Promise.reject(new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D")):new Promise((r,o)=>{let i=new XMLHttpRequest;i.open("POST",`/api/articles/${e}/attachments`),i.withCredentials=!0,i.upload.onprogress=c=>{if(c.lengthComputable){let d=Math.round(c.loaded/c.total*100);n(d)}},i.onreadystatechange=()=>{if(i.readyState===XMLHttpRequest.DONE)if(i.status>=200&&i.status<300)try{let c=JSON.parse(i.responseText||"{}");r(c)}catch(c){o(c)}else{let c=`Attachment upload failed (status ${i.status})`;try{let d=JSON.parse(i.responseText||"{}");d?.detail&&(c=d.detail)}catch{}o(new Error(c))}},i.onerror=()=>o(new Error("Network error during upload"));let s=new FormData;s.append("file",t),i.send(s)})}function To(e){let t=new Map;for(let n of e||[]){let r=n.parentId??null;t.has(r)||t.set(r,[]),t.get(r).push(n)}for(let n of t.values())n.sort((r,o)=>(r.position||0)-(o.position||0));return t}function mr(e){let t=[];for(let n=0;n<e.length;n+=1){let r=e[n];if(!r)continue;let o=n;(r.position||0)!==o&&(r.position=o,t.push({id:r.id,parentId:r.parentId??null,position:o}))}return t}function ld(e,t){return!e||!t?Promise.resolve(null):De(`/api/articles/${encodeURIComponent(e)}/move`,{method:"POST",body:JSON.stringify({direction:t})}).then(async r=>{try{let o=await _n().catch(()=>[]),i=To(o),s=(o||[]).find(c=>c.id===e);if(s){let c=i.get(s.parentId??null)||[],d=c.findIndex(f=>f.id===e),u=d+(t==="up"?-1:1);if(d!==-1&&u>=0&&u<c.length){let f=c[d];c[d]=c[u],c[u]=f;let p=mr(c);Yr(p).catch(()=>{})}}}catch{}return r}).catch(async()=>{let r=await _n().catch(()=>[]),o=To(r),i=(r||[]).find(p=>p.id===e);if(!i)return null;let s=o.get(i.parentId??null)||[],c=s.findIndex(p=>p.id===e);if(c===-1)return null;let l=c+(t==="up"?-1:1);if(l<0||l>=s.length)return null;let u=s[c];s[c]=s[l],s[l]=u;let f=mr(s);return Yr(f).catch(()=>{}),Nt("move_article_position",{articleId:e,payload:{direction:t},coalesceKey:`${e}:move`}).catch(()=>{}),{id:e}})}function dd(e){return e?De(`/api/articles/${encodeURIComponent(e)}/indent`,{method:"POST",body:JSON.stringify({})}).catch(async()=>{let n=await _n().catch(()=>[]),r=To(n),o=(n||[]).find(f=>f.id===e);if(!o)return null;let i=r.get(o.parentId??null)||[],s=i.findIndex(f=>f.id===e);if(s<=0)return null;let d=i[s-1]?.id||null;o.parentId=d;let l=r.get(d)||[];l.push(o);let u=[];return u.push(...mr(i.filter(f=>f.id!==e))),u.push(...mr(l)),Yr(u).catch(()=>{}),Nt("indent_article",{articleId:e,payload:{},coalesceKey:`${e}:indent`}).catch(()=>{}),{id:e}}):Promise.resolve(null)}function ud(e){return e?De(`/api/articles/${encodeURIComponent(e)}/outdent`,{method:"POST",body:JSON.stringify({})}).catch(async()=>{let n=await _n().catch(()=>[]),r=To(n),o=(n||[]).find(b=>b.id===e);if(!o)return null;let i=o.parentId??null;if(!i)return null;let c=(n||[]).find(b=>b.id===i)?.parentId??null,l=(r.get(i)||[]).filter(b=>b.id!==e),u=r.get(c)||[],f=u.findIndex(b=>b.id===i),p=f===-1?u.length:f+1;o.parentId=c,u.splice(p,0,o);let y=[];return y.push(...mr(l)),y.push(...mr(u)),Yr(y).catch(()=>{}),Nt("outdent_article",{articleId:e,payload:{},coalesceKey:`${e}:outdent`}).catch(()=>{}),{id:e}}):Promise.resolve(null)}function fd(e,t){return e?De(`/api/articles/${encodeURIComponent(e)}/move-tree`,{method:"POST",body:JSON.stringify(t||{})}).catch(async()=>{let r=await _n().catch(()=>[]),o=To(r),i=(r||[]).find(g=>g.id===e);if(!i)return null;let s=t&&t.placement||null,c=t&&t.anchorId||null,d=t?t.parentId??null:null;s==="inside"&&c&&(d=c);let l=i.parentId??null,f=(o.get(l)||[]).filter(g=>g.id!==e),y=(o.get(d)||[]).filter(g=>g.id!==e),b=y.length;if(c){let g=y.findIndex(w=>w.id===c);g!==-1&&(s==="before"?b=g:s==="after"?b=g+1:s==="inside"&&(b=y.length))}i.parentId=d,y.splice(b,0,i);let h=[];return h.push(...mr(f)),h.push(...mr(y)),Yr(h).catch(()=>{}),Nt("move_article_tree",{articleId:e,payload:t||{},coalesceKey:`${e}:move-tree`}).catch(()=>{}),{id:e}}):Promise.resolve(null)}async function Xm({articleId:e,filename:t,overwrite:n=!1,sha256:r="",size:o=0}){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D");let s=await fetch("/api/yandex/disk/upload-url",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({filename:t||"",articleId:e||"",overwrite:!!n,sha256:r||"",size:typeof o=="number"?o:0})}),c=await s.json().catch(()=>null);if(!s.ok){let d=c&&c.detail||`Yandex upload URL failed (status ${s.status})`;throw new Error(d)}return c}async function Vl(e,{path:t,originalName:n,contentType:r,size:o}){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D");let i={path:t||"",originalName:n||"",contentType:r||"",size:typeof o=="number"?o:0},s=await fetch(`/api/articles/${e}/attachments/yandex`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),c=await s.json().catch(()=>null);if(!s.ok){let d=c&&c.detail||`Register Yandex attachment failed (status ${s.status})`;throw new Error(d)}return c}async function Bi(e,t,{onProgress:n}={}){if(!t)throw new Error("\u0424\u0430\u0439\u043B \u043D\u0435 \u0443\u043A\u0430\u0437\u0430\u043D");let r="";try{if(window.crypto&&window.crypto.subtle&&typeof t.arrayBuffer=="function"){let f=await t.arrayBuffer(),p=await window.crypto.subtle.digest("SHA-256",f),y=new Uint8Array(p);r=Array.from(y).map(b=>b.toString(16).padStart(2,"0")).join("")}}catch{r=""}let{href:o,method:i,path:s,exists:c,same:d}=await Xm({articleId:e,filename:t.name||"attachment",overwrite:!1,sha256:r,size:t.size||0});if(c&&d&&!o)return await Vl(e,{path:s,originalName:t.name||"attachment",contentType:t.type||"",size:t.size||0});let l=!1;if(o)try{await new Promise((f,p)=>{let y=new XMLHttpRequest;y.open(i||"PUT",o),y.upload.onprogress=b=>{if(n&&b.lengthComputable){let h=Math.round(b.loaded/b.total*100);try{n(h)}catch{}}},y.onreadystatechange=()=>{y.readyState===XMLHttpRequest.DONE&&(y.status>=200&&y.status<300?f():p(new Error(`Yandex upload failed (status ${y.status})`)))},y.onerror=()=>p(new Error("Network error during Yandex upload")),y.send(t)}),l=!0}catch(f){console.warn("[attachments] Direct Yandex upload failed, falling back to server upload",f),l=!1}return l?await Vl(e,{path:s,originalName:t.name||"attachment",contentType:t.type||"",size:t.size||0}):await Ym(e,t,n)}function Li(e,t={}){let n=new FormData;return n.append("file",e),t.mode&&n.append("mode",t.mode),t.versionPrefix&&n.append("versionPrefix",t.versionPrefix),fetch("/api/import/html",{method:"POST",credentials:"include",body:n}).then(async r=>{let o=await r.json().catch(()=>null);if(!r.ok){let i=o?.detail||`Import failed (status ${r.status})`;throw new Error(i)}return o})}function pd(e,t=""){let n=new FormData;return n.append("file",e),t&&typeof t=="string"&&n.append("assetsBaseUrl",t),fetch("/api/import/markdown",{method:"POST",credentials:"include",body:n}).then(async r=>{let o=await r.json().catch(()=>null);if(!r.ok){let i=o?.detail||`Import failed (status ${r.status})`;throw new Error(i)}return o})}function md(e,t=""){let n=new FormData;return n.append("file",e),t&&typeof t=="string"&&n.append("assetsBaseUrl",t),fetch("/api/import/logseq",{method:"POST",credentials:"include",body:n}).then(async r=>{let o=await r.json().catch(()=>null);if(!r.ok){let i=o?.detail||`Import failed (status ${r.status})`;throw new Error(i)}return o})}var Jm,Eo,da,jm,Pt=Fe(()=>{Io();vo();zl();ft();Ao();Jm="ttree_profile_v1";Eo=null,da=null,jm="ttree_offline_recovery_force_index_v1"});function Tt(...e){console.log("[debug]",...e)}function it(e=""){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Mi(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Bo(e=""){let t=document.createElement("template");return t.innerHTML=e||"",(t.content.textContent||"").replace(/\s+/g," ").trim()}function hd(e=""){let t=(e||"").replace(/<br\s*\/?>/gi,`
`).replace(/<\/(?:div|p|li|h[1-6])>/gi,`
`),n=document.createElement("template");return n.innerHTML=t,(n.content.textContent||"").split(`
`).map(r=>r.replace(/\s+/g," ").trim()).filter(r=>r.length)}function gd(e){if(!e)return!1;if(e.isContentEditable)return!0;let t=e.tagName?e.tagName.toLowerCase():"";return t==="input"||t==="textarea"||t==="select"}function Ni(e){if(!e||!e.isConnected)return;let t=window.getSelection();if(!t)return;let n=document.createRange();n.selectNodeContents(e),n.collapse(!1),t.removeAllRanges(),t.addRange(n)}function fa(e){if(!e||!e.isConnected)return;let t=window.getSelection();if(!t)return;let n=document.createRange();n.selectNodeContents(e),n.collapse(!0),t.removeAllRanges(),t.addRange(n)}function yd(e=""){let t=document.createElement("template");return t.innerHTML=e||"",t.content.textContent||""}function pa(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=t.content.querySelectorAll("img");return Array.from(n).map(r=>({src:r.getAttribute("src")||"",alt:r.getAttribute("alt")||""}))}function Tn(e,t){if(!e||!document.contains(e))return;e.focus();let n=window.getSelection();if(!n)return;let r=n.rangeCount>0?n.getRangeAt(0):document.createRange();e.contains(r.commonAncestorContainer)||(r=document.createRange(),r.selectNodeContents(e),r.collapse(!1)),n.removeAllRanges(),n.addRange(r);let o=r.createContextualFragment(t);r.deleteContents(),r.insertNode(o),r.collapse(!1),n.removeAllRanges(),n.addRange(r)}var bn=Fe(()=>{});var ka={};Vn(ka,{showArticleHistoryModal:()=>ba,showArticleLinkPrompt:()=>Qm,showBlockHistoryModal:()=>ya,showBlockTrashPicker:()=>Sa,showConfirm:()=>On,showImagePreview:()=>Lo,showImportConflictDialog:()=>xa,showLinkPrompt:()=>wa,showPasswordWithHintPrompt:()=>Di,showPrompt:()=>Gt,showPublicLinkModal:()=>Pi,showVersionCompareTargetPicker:()=>ha,showVersionDiffModal:()=>ga,showVersionsPicker:()=>ma});function dn(){let e=document.getElementById(bd);return e||(e=document.createElement("div"),e.id=bd,document.body.appendChild(e)),e}function Cn({title:e,message:t,confirmText:n,cancelText:r,renderBody:o}){let i=document.createElement("div");i.className="modal-overlay";let s=document.createElement("form");s.className="modal-form",s.addEventListener("submit",b=>{b.preventDefault()});let c=document.createElement("div");c.className="modal-card",c.setAttribute("role","dialog"),c.setAttribute("aria-modal","true"),c.tabIndex=-1;let d=document.createElement("div");d.className="modal-header";let l=document.createElement("h3");l.textContent=e||"\u041F\u043E\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043D\u0438\u0435",d.appendChild(l);let u=document.createElement("div");if(u.className="modal-body",typeof o=="function"){let b=o();Array.isArray(b)?b.forEach(h=>{h&&u.appendChild(h)}):b&&u.appendChild(b)}else u.textContent=t||"";let f=document.createElement("div");f.className="modal-footer modal-footer--stacked";let p=document.createElement("button");p.type="button",p.className="ghost",p.textContent=r||"\u041E\u0442\u043C\u0435\u043D\u0430";let y=document.createElement("button");return y.type="button",y.className="primary danger-btn",y.textContent=n||"\u0423\u0434\u0430\u043B\u0438\u0442\u044C",f.appendChild(y),f.appendChild(p),c.appendChild(d),c.appendChild(u),c.appendChild(f),s.appendChild(c),i.appendChild(s),{overlay:i,card:c,confirmBtn:y,cancelBtn:p,form:s}}function Gm(e="",t=""){let n=String(e||"").length,r=String(t||"").length;if(n*r>2e6||n+r>2e4)return null;let s=Array.from(e),c=Array.from(t),d=s.length,l=c.length,u=Array.from({length:d+1},()=>new Array(l+1).fill(0));for(let h=d-1;h>=0;h-=1)for(let g=l-1;g>=0;g-=1)s[h]===c[g]?u[h][g]=u[h+1][g+1]+1:u[h][g]=Math.max(u[h+1][g],u[h][g+1]);let f=[],p=0,y=0;for(;p<d&&y<l;)s[p]===c[y]?(f.push({type:"same",value:s[p]}),p+=1,y+=1):u[p+1][y]>=u[p][y+1]?(f.push({type:"removed",value:s[p]}),p+=1):(f.push({type:"added",value:c[y]}),y+=1);for(;p<d;)f.push({type:"removed",value:s[p]}),p+=1;for(;y<l;)f.push({type:"added",value:c[y]}),y+=1;let b=[];return f.forEach(h=>{if(!h.value)return;let g=b[b.length-1];g&&g.type===h.type?g.value+=h.value:b.push({type:h.type,value:h.value})}),b}function Xr({baseText:e="",nextText:t="",mode:n="before"}={}){let r=document.createDocumentFragment(),o=Gm(e,t);if(!o){let s=String(n==="before"?e||"":t||""),c=s.length>2e5?`${s.slice(0,2e5)}

\u2026(\u043E\u0431\u0440\u0435\u0437\u0430\u043D\u043E)`:s,d=document.createElement("div");d.className="meta",d.style.marginBottom="6px",d.textContent="Diff \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 \u2014 \u043F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0435\u043C \u0442\u0435\u043A\u0441\u0442 \u0431\u0435\u0437 \u043F\u043E\u0434\u0441\u0432\u0435\u0442\u043A\u0438.";let l=document.createElement("pre");return l.className="diff-plain",l.style.whiteSpace="pre-wrap",l.style.wordBreak="break-word",l.textContent=c,r.appendChild(d),r.appendChild(l),r}return o.forEach(i=>{if(n==="before"&&i.type==="added"||n==="after"&&i.type==="removed")return;let s=document.createElement("span");s.className="diff-seg",i.type==="added"&&s.classList.add("diff-seg--added"),i.type==="removed"&&s.classList.add("diff-seg--removed"),s.textContent=i.value,r.appendChild(s)}),r}function On(e={}){let t=dn(),{overlay:n,card:r,confirmBtn:o,cancelBtn:i,form:s}=Cn(e),c=!1,d=()=>{},l=()=>{n.classList.add("modal-overlay--hide"),setTimeout(()=>n.remove(),150),document.removeEventListener("keydown",f)},u=p=>{c||(c=!0,l(),d(p))},f=p=>{p.code==="Escape"&&(p.preventDefault(),u(!1)),p.code==="Enter"&&(p.preventDefault(),u(!0))};return new Promise(p=>{d=p,s.addEventListener("submit",y=>{y.preventDefault(),u(!0)}),o.addEventListener("click",()=>u(!0)),i.addEventListener("click",()=>u(!1)),n.addEventListener("click",y=>{y.target===n&&u(!1)}),document.addEventListener("keydown",f),t.appendChild(n),requestAnimationFrame(()=>{r.focus({preventScroll:!0})})})}function Gt(e={}){let t=dn(),n=null,r=Array.isArray(e.suggestions)?e.suggestions:[],o=null,{overlay:i,card:s,confirmBtn:c,cancelBtn:d,form:l}=Cn({...e,renderBody:()=>{let w=document.createDocumentFragment();if(e.message){let x=document.createElement("p");x.className="modal-body__text",x.textContent=e.message,w.appendChild(x)}let S=document.createElement("input");return S.type=e.inputType==="password"?"password":"text",S.className="modal-input",S.placeholder=e.placeholder||"",S.value=e.defaultValue||"",S.autocomplete="off",w.appendChild(S),r.length&&(o=document.createElement("div"),o.className="modal-suggestions",w.appendChild(o)),n=S,w}}),u=!1,f=()=>{},p=()=>{i.classList.add("modal-overlay--hide"),setTimeout(()=>i.remove(),150),document.removeEventListener("keydown",b)},y=w=>{if(!u)if(u=!0,p(),e.returnMeta){let S={value:w??null,selectedId:n?.dataset?.selectedId||null};f(S)}else f(w)},b=w=>{if(w.code==="Escape"){w.preventDefault(),y(null);return}if(w.code==="Enter"&&n&&!e.hideConfirm){let S=n.value.trim();if(!S&&!e.allowEmpty)return;w.preventDefault(),y(S)}},h=()=>{if(!c||!n)return;let w=!!n.value.trim();c.disabled=!w&&!e.allowEmpty},g=()=>{if(!o||!n)return;let w=n.value.trim().toLowerCase();n.dataset.selectedId="";let S=r.filter(x=>(x.title||"").toLowerCase().includes(w)||(x.id||"").toLowerCase().includes(w)).slice(0,8);if(o.innerHTML="",!w||!S.length){o.classList.add("hidden");return}o.classList.remove("hidden"),S.forEach(x=>{let T=document.createElement("button");T.type="button",T.className="modal-suggestion",T.textContent=x.title||x.id||"",T.addEventListener("click",()=>{n.value=x.title||x.id||"",n.dataset.selectedId=x.id||"",h(),g(),y(n.value)}),o.appendChild(T)})};return new Promise(w=>{f=w,c.classList.remove("danger-btn"),e.hideConfirm?c.style.display="none":c.textContent=e.confirmText||"OK",d.textContent=e.cancelText||"Cancel";let S=()=>{if(!n){y(null);return}let x=n.value.trim();if(!x){n.focus();return}y(x)};l.addEventListener("submit",x=>{x.preventDefault(),S()}),c.addEventListener("click",S),d.addEventListener("click",()=>y(null)),i.addEventListener("click",x=>{x.target===i&&y(null)}),document.addEventListener("keydown",b),n?(n.dataset.selectedId="",n.addEventListener("input",()=>{n.dataset.selectedId="",h(),r.length&&g()}),e.hideConfirm&&n.addEventListener("keydown",x=>{x.code==="Enter"&&(x.preventDefault(),y(n.value.trim()))}),h(),r.length&&g()):h(),t.appendChild(i),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):s.focus({preventScroll:!0})})})}function Qm(e={}){let t=dn(),n=null,r=null,o=Array.isArray(e.suggestions)?e.suggestions:[],i=null,{overlay:s,card:c,confirmBtn:d,cancelBtn:l,form:u}=Cn({title:e.title||"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",renderBody:()=>{let S=document.createDocumentFragment();if(e.message){let $=document.createElement("p");$.className="modal-body__text",$.textContent=e.message,S.appendChild($)}let x=document.createElement("label");x.className="modal-label",x.textContent=e.articleLabel||"\u0421\u0442\u0430\u0442\u044C\u044F";let T=document.createElement("input");T.type="text",T.className="modal-input",T.placeholder=e.articlePlaceholder||"ID \u0438\u043B\u0438 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435\u2026",T.value=e.defaultArticleValue||"",T.autocomplete="off",x.appendChild(T),S.appendChild(x),n=T,o.length&&(i=document.createElement("div"),i.className="modal-suggestions",S.appendChild(i));let N=document.createElement("label");N.className="modal-label",N.textContent=e.textLabel||"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)";let B=document.createElement("input");return B.type="text",B.className="modal-input",B.placeholder=e.textPlaceholder||"",B.value=e.defaultTextValue||"",B.autocomplete="off",N.appendChild(B),S.appendChild(N),r=B,S}}),f=!1,p=()=>{},y=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",w)},b=S=>{f||(f=!0,y(),p(S))},h=()=>{if(!d||!n)return;let S=!!n.value.trim()||!!n.dataset.selectedId;d.disabled=!S},g=()=>{if(!i||!n)return;let S=n.value.trim().toLowerCase();n.dataset.selectedId="";let x=o.filter(T=>(T.title||"").toLowerCase().includes(S)||(T.id||"").toLowerCase().includes(S)).slice(0,8);if(i.innerHTML="",!S||!x.length){i.classList.add("hidden");return}i.classList.remove("hidden"),x.forEach(T=>{let N=document.createElement("button");N.type="button",N.className="modal-suggestion",N.textContent=T.title||T.id||"",N.addEventListener("click",()=>{n.value=T.title||T.id||"",n.dataset.selectedId=T.id||"",h(),g(),r&&!r.value.trim()&&!e.lockTextValue&&(r.value=T.title||""),r?.focus?.({preventScroll:!0}),r?.select?.()}),i.appendChild(N)})},w=S=>{if(S.code==="Escape"){S.preventDefault(),b(null);return}S.code};return new Promise(S=>{p=S,d.classList.remove("danger-btn"),d.textContent=e.confirmText||"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",l.textContent=e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430";let x=()=>{if(!n||!r){b(null);return}let T=n.value.trim(),N=n.dataset.selectedId||"";if(!T&&!N){n.focus();return}b({articleValue:T,selectedId:N||null,textValue:r.value??""})};u.addEventListener("submit",T=>{T.preventDefault(),x()}),d.addEventListener("click",x),l.addEventListener("click",()=>b(null)),s.addEventListener("click",T=>{T.target===s&&b(null)}),document.addEventListener("keydown",w),n?(n.dataset.selectedId="",n.addEventListener("input",()=>{n.dataset.selectedId="",h(),o.length&&g()}),h(),o.length&&g()):h(),t.appendChild(s),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):c.focus({preventScroll:!0})})})}function Pi(e={}){let t=dn(),n=null,r=e.url||"",{overlay:o,card:i,confirmBtn:s,cancelBtn:c}=Cn({title:e.title||"\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u0430\u044F \u0441\u0441\u044B\u043B\u043A\u0430",renderBody:()=>{let h=document.createDocumentFragment(),g=document.createElement("label");g.className="modal-label",g.textContent=e.label||"\u041F\u0440\u043E\u0441\u043C\u043E\u0442\u0440 \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435";let w=document.createElement("input");return w.type="text",w.className="modal-input",w.value=r,w.readOnly=!0,w.autocomplete="off",g.appendChild(w),n=w,h.appendChild(g),h}}),d=!1,l=()=>{},u=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",p)},f=()=>{d||(d=!0,u(),l())},p=h=>{h.code==="Escape"&&(h.preventDefault(),f())},y=h=>{if(!h)return!1;let g=document.createElement("textarea");g.value=h,g.setAttribute("readonly",""),g.style.position="absolute",g.style.left="-9999px",document.body.appendChild(g),g.focus(),g.select();let w=!1;try{w=document.execCommand("copy")}catch{w=!1}return document.body.removeChild(g),w},b=()=>{let h=n&&n.value||r;if(h){L("\u0421\u0441\u044B\u043B\u043A\u0430 \u0441\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u0430");try{if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function"){let g=navigator.clipboard.writeText(h);g&&typeof g.catch=="function"&&g.catch(()=>{y(h)})}else y(h)}catch{y(h)}}};return new Promise(h=>{l=h,s.classList.remove("danger-btn"),s.textContent="\u29C9 \u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443",s.setAttribute("aria-label",e.copyLabel||"\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443"),c.classList.add("hidden"),s.addEventListener("click",()=>{b(),f()}),o.addEventListener("click",g=>{g.target===o&&f()}),document.addEventListener("keydown",p),t.appendChild(o),requestAnimationFrame(()=>{n?n.focus({preventScroll:!0}):i.focus({preventScroll:!0})})})}function ma(e={}){let t=dn(),n=Array.isArray(e.versions)?e.versions:[],r=n[0]?.id||"",o=w=>{try{let S=new Date(w);return Number.isNaN(S.getTime())?String(w||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(S)}catch{return String(w||"")}},{overlay:i,card:s,confirmBtn:c,cancelBtn:d,form:l}=Cn({title:e.title||"\u0412\u0435\u0440\u0441\u0438\u0438",confirmText:e.confirmText||"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",cancelText:e.cancelText||"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",renderBody:()=>{let w=document.createDocumentFragment(),S=document.createElement("p");if(S.className="modal-body__text",S.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0435\u0440\u0441\u0438\u044E \u0441\u0442\u0430\u0442\u044C\u0438 \u0434\u043B\u044F \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F.",w.appendChild(S),!n.length){let T=document.createElement("div");return T.className="modal-empty",T.textContent="\u0412\u0435\u0440\u0441\u0438\u0439 \u043F\u043E\u043A\u0430 \u043D\u0435\u0442.",w.appendChild(T),w}let x=document.createElement("div");return x.className="modal-list",n.forEach((T,N)=>{let B=document.createElement("label");B.className="modal-list__item";let $=document.createElement("input");$.type="radio",$.name="version",$.value=T.id||"",$.checked=N===0,$.addEventListener("change",()=>{r=$.value,c.disabled=!r,u.disabled=!r});let U=document.createElement("div");U.className="modal-list__meta";let Y=document.createElement("div");Y.className="modal-list__title",Y.textContent=T.label||o(T.created_at||T.createdAt);let J=document.createElement("div");J.className="modal-list__subtitle";let re=T.reason||"",he=o(T.created_at||T.createdAt);J.textContent=[he,re].filter(Boolean).join(" \xB7 "),U.appendChild(Y),U.appendChild(J),B.appendChild($),B.appendChild(U),x.appendChild(B)}),w.appendChild(x),w}});s.classList.add("modal-card--diff-light"),c.classList.remove("danger-btn"),c.disabled=!r;let u=document.createElement("button");u.type="button",u.className="ghost",u.textContent=e.compareText||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C",u.disabled=!r;let f=s.querySelector(".modal-footer");f&&f.insertBefore(u,c);let p=!1,y=()=>{},b=()=>{i.classList.add("modal-overlay--hide"),setTimeout(()=>i.remove(),150),document.removeEventListener("keydown",g)},h=w=>{p||(p=!0,b(),y(w))},g=w=>{w.code==="Escape"&&(w.preventDefault(),h(null))};return new Promise(w=>{y=w;let S=()=>{r&&h({action:"restore",versionId:r})};l.addEventListener("submit",x=>{x.preventDefault(),S()}),c.addEventListener("click",S),u.addEventListener("click",()=>{r&&h({action:"compare",versionId:r})}),d.addEventListener("click",()=>h(null)),i.addEventListener("click",x=>{x.target===i&&h(null)}),document.addEventListener("keydown",g),t.appendChild(i),requestAnimationFrame(()=>{s.focus({preventScroll:!0})})})}function ha(e={}){let t=dn(),n=Array.isArray(e.versions)?e.versions:[],r=String(e.excludeId||""),o=[{kind:"current",id:"__current__",title:"\u0422\u0435\u043A\u0443\u0449\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F"},...n.filter(g=>String(g.id||"")&&String(g.id||"")!==r).map(g=>({kind:"version",id:String(g.id),title:g.label||g.created_at||g.createdAt||g.id}))],i=o[0]?.id||"",{overlay:s,card:c,confirmBtn:d,cancelBtn:l,form:u}=Cn({title:e.title||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C \u0441\u2026",confirmText:e.confirmText||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C",cancelText:e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430",renderBody:()=>{let g=document.createDocumentFragment(),w=document.createElement("p");w.className="modal-body__text",w.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0442\u043E\u0440\u0443\u044E \u0441\u0442\u043E\u0440\u043E\u043D\u0443 \u0441\u0440\u0430\u0432\u043D\u0435\u043D\u0438\u044F.",g.appendChild(w);let S=document.createElement("div");return S.className="modal-list",o.forEach((x,T)=>{let N=document.createElement("label");N.className="modal-list__item";let B=document.createElement("input");B.type="radio",B.name="compareTarget",B.value=x.id,B.checked=T===0,B.addEventListener("change",()=>{i=B.value,d.disabled=!i});let $=document.createElement("div");$.className="modal-list__meta";let U=document.createElement("div");U.className="modal-list__title",U.textContent=x.title,$.appendChild(U),N.appendChild(B),N.appendChild($),S.appendChild(N)}),g.appendChild(S),g}});c.classList.add("modal-card--diff-light"),d.classList.remove("danger-btn"),d.disabled=!i;let f=!1,p=()=>{},y=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",h)},b=g=>{f||(f=!0,y(),p(g))},h=g=>{g.code==="Escape"&&(g.preventDefault(),b(null))};return new Promise(g=>{p=g;let w=()=>{if(!i)return;let S=o.find(x=>x.id===i)||null;if(!S){b(null);return}if(S.kind==="current"){b({target:"current"});return}b({target:"version",versionId:S.id})};u.addEventListener("submit",S=>{S.preventDefault(),w()}),d.addEventListener("click",w),l.addEventListener("click",()=>b(null)),s.addEventListener("click",S=>{S.target===s&&b(null)}),document.addEventListener("keydown",h),t.appendChild(s),requestAnimationFrame(()=>{c.focus({preventScroll:!0})})})}function ga(e={}){let t=dn(),n=Array.isArray(e.changes)?e.changes:[],r=n.find(y=>y.type==="changed")||n[0]||null,{overlay:o,card:i,confirmBtn:s,cancelBtn:c}=Cn({title:e.title||"\u041E\u0442\u043B\u0438\u0447\u0438\u044F \u0432\u0435\u0440\u0441\u0438\u0439",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:"",renderBody:()=>{let y=document.createDocumentFragment(),b=document.createElement("div");b.className="diff-summary";let h=n.reduce((Y,J)=>(Y[J.type]=(Y[J.type]||0)+1,Y),{added:0,removed:0,changed:0});if(b.textContent=`\u0418\u0437\u043C\u0435\u043D\u0435\u043D\u043E: ${h.changed||0} \xB7 \u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E: ${h.added||0} \xB7 \u0423\u0434\u0430\u043B\u0435\u043D\u043E: ${h.removed||0}`,y.appendChild(b),!n.length){let Y=document.createElement("div");return Y.className="modal-empty",Y.textContent="\u041D\u0435\u0442 \u043E\u0442\u043B\u0438\u0447\u0438\u0439.",y.appendChild(Y),y}let g=document.createElement("div");g.className="modal-list",n.forEach(Y=>{let J=document.createElement("button");J.type="button",J.className=`diff-item diff-item--${Y.type}${r&&r.id===Y.id?" diff-item--active":""}`;let re=Y.label||Y.id;J.textContent=`${Y.type==="changed"?"\u2260":Y.type==="added"?"+":"\u2212"} ${re}`,J.addEventListener("click",()=>{r=Y,g.querySelectorAll(".diff-item").forEach(he=>he.classList.remove("diff-item--active")),J.classList.add("diff-item--active"),U()}),g.appendChild(J)}),y.appendChild(g);let w=document.createElement("div");w.className="diff-panes";let S=document.createElement("div");S.className="diff-pane-wrap";let x=document.createElement("div");x.className="diff-pane-wrap";let T=document.createElement("div");T.className="diff-pane-title",T.textContent=e.beforeTitle||"\u0412\u0435\u0440\u0441\u0438\u044F";let N=document.createElement("div");N.className="diff-pane-title",N.textContent=e.afterTitle||"\u0422\u0435\u043A\u0443\u0449\u0430\u044F";let B=document.createElement("div");B.className="diff-pane diff-pane--before";let $=document.createElement("div");$.className="diff-pane diff-pane--after",S.appendChild(T),S.appendChild(B),x.appendChild(N),x.appendChild($),w.appendChild(S),w.appendChild(x),y.appendChild(w);let U=()=>{let Y=r?.before||"",J=r?.after||"";B.innerHTML="",$.innerHTML="",B.appendChild(Xr({baseText:Y,nextText:J,mode:"before"})),$.appendChild(Xr({baseText:Y,nextText:J,mode:"after"}))};return U(),y}});i.classList.add("modal-card--fullscreen"),i.classList.add("modal-card--diff-light"),s.classList.remove("danger-btn"),c&&(c.style.display="none");let d=!1,l=()=>{},u=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",p)},f=()=>{d||(d=!0,u(),l())},p=y=>{y.code==="Escape"&&(y.preventDefault(),f())};return new Promise(y=>{l=y,s.addEventListener("click",f),o.addEventListener("click",b=>{b.target===o&&f()}),document.addEventListener("keydown",p),t.appendChild(o),requestAnimationFrame(()=>{i.focus({preventScroll:!0})})})}function ya(e={}){let t=dn(),n=Array.isArray(e.entries)?e.entries:[],r=n[0]||null,o=r,i=[],s=null,c=w=>{try{let S=new Date(w);return Number.isNaN(S.getTime())?String(w||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(S)}catch{return String(w||"")}},{overlay:d,card:l,confirmBtn:u,cancelBtn:f}=Cn({title:e.title||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0431\u043B\u043E\u043A\u0430",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:e.canRestore?"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C (\u043F\u043E\u0441\u043B\u0435 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F)":"",renderBody:()=>{let w=document.createDocumentFragment(),S=document.createElement("p");if(S.className="modal-body__text",S.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0435. \u041C\u043E\u0436\u043D\u043E \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430 \u0434\u043E \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F.",w.appendChild(S),!n.length){let G=document.createElement("div");return G.className="modal-empty",G.textContent="\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430.",w.appendChild(G),w}let x=document.createElement("div");x.className="diff-layout";let T=document.createElement("div");T.className="modal-list diff-sidebar",i=[],n.forEach(G=>{let ie=document.createElement("button");ie.type="button";let $e=!!(r&&r.id===G.id);ie.className=`diff-item${$e?" diff-item--active":""}`,ie.setAttribute("aria-selected",$e?"true":"false");let dt=c(G.timestamp);ie.textContent=dt?`\u2260 ${dt}`:`\u2260 ${G.id||""}`.trim(),ie.addEventListener("click",()=>{r=G,T.querySelectorAll(".diff-item").forEach(ut=>{ut.classList.remove("diff-item--active"),ut.setAttribute("aria-selected","false")}),ie.classList.add("diff-item--active"),ie.setAttribute("aria-selected","true"),Re()}),T.appendChild(ie),i.push(ie)});let N=document.createElement("div");N.className="diff-main";let B=document.createElement("div");B.className="diff-panes diff-panes--side";let $=document.createElement("div");$.className="diff-pane-wrap";let U=document.createElement("div");U.className="diff-pane-wrap";let Y=document.createElement("div");Y.className="diff-pane-title",Y.textContent=e.beforeTitle||"\u0414\u043E";let J=document.createElement("div");J.className="diff-pane-title",J.textContent=e.afterTitle||"\u041F\u043E\u0441\u043B\u0435";let re=document.createElement("div");re.className="diff-pane diff-pane--before";let he=document.createElement("div");he.className="diff-pane diff-pane--after",$.appendChild(Y),$.appendChild(re),U.appendChild(J),U.appendChild(he),B.appendChild($),B.appendChild(U),N.appendChild(B),x.appendChild(T),x.appendChild(N),w.appendChild(x);let Re=()=>{o=r;let G=r?.beforePlain||r?.before||"",ie=r?.afterPlain||r?.after||"";re.innerHTML="",he.innerHTML="",re.appendChild(Xr({baseText:G,nextText:ie,mode:"before"})),he.appendChild(Xr({baseText:G,nextText:ie,mode:"after"}))};return s=Re,Re(),w}});l.classList.add("modal-card--fullscreen"),l.classList.add("modal-card--diff-light"),u.classList.remove("danger-btn"),!e.canRestore&&f&&(f.style.display="none"),f&&f.classList.add("danger-btn");let p=!1,y=()=>{},b=()=>{d.classList.add("modal-overlay--hide"),setTimeout(()=>d.remove(),150),document.removeEventListener("keydown",g)},h=w=>{p||(p=!0,b(),y(w))},g=w=>{if(w.code==="Escape"&&(w.preventDefault(),h(null)),w.code==="ArrowUp"||w.code==="ArrowDown"){if(!n.length)return;w.preventDefault();let S=String(r?.id||""),x=n.findIndex(B=>String(B?.id||"")===S);x<0&&(x=0),x=w.code==="ArrowUp"?Math.max(0,x-1):Math.min(n.length-1,x+1);let T=n[x]||null;if(!T)return;r=T;let N=i[x];if(i.forEach(B=>{B.classList.remove("diff-item--active"),B.setAttribute("aria-selected","false")}),N){N.classList.add("diff-item--active"),N.setAttribute("aria-selected","true"),N.focus({preventScroll:!0});try{N.scrollIntoView({block:"nearest"})}catch{}}typeof s=="function"&&s()}};return new Promise(w=>{y=w,u.addEventListener("click",()=>h(null)),f&&e.canRestore&&f.addEventListener("click",()=>h({action:"restore",entry:o||r||null})),d.addEventListener("click",S=>{S.target===d&&h(null)}),document.addEventListener("keydown",g),t.appendChild(d),requestAnimationFrame(()=>{l.focus({preventScroll:!0})})})}function wd(e){let t=[],n=r=>{if(!r)return;if(typeof r=="string"){t.push(r);return}if(Array.isArray(r)){r.forEach(n);return}if(typeof r!="object")return;typeof r.text=="string"&&t.push(r.text);let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(e),t.join("").replace(/\u00a0/g," ").trim()}function Zm(e){return!e||typeof e!="object"?!1:!!(e.beforeHeadingJson||e.beforeBodyJson||e.afterHeadingJson||e.afterBodyJson)}function ba(e={}){let t=dn(),r=(Array.isArray(e.entries)?e.entries:[]).filter(Zm),o=typeof e.onRestore=="function"?e.onRestore:null,i=U=>String(U??"").replace(/\u00a0/g," ").trim(),s=r.map(U=>({...U,beforePlain:i(U.beforePlain??U.before??""),afterPlain:i(U.afterPlain??U.after??"")})),c=new Map;for(let U of s){let Y=String(U?.blockId||"").trim();if(!Y)continue;let J=c.get(Y)||{blockId:Y,entries:[],latestAt:0,label:""};J.entries.push(U);let re=Date.parse(U.timestamp||"")||0;if(re>J.latestAt&&(J.latestAt=re),!J.label){let he=wd(U.afterHeadingJson)||wd(U.beforeHeadingJson)||"",Re=(U.afterPlain||U.beforePlain||"").split(`
`).map(G=>G.trim()).find(Boolean)||"";J.label=he||Re||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"}c.set(Y,J)}let d=Array.from(c.values()).sort((U,Y)=>(Y.latestAt||0)-(U.latestAt||0)),l=d[0]?.blockId||null,u=null,f=!1,p=U=>{try{let Y=new Date(U);return Number.isNaN(Y.getTime())?String(U||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(Y)}catch{return String(U||"")}},{overlay:y,card:b,confirmBtn:h,cancelBtn:g}=Cn({title:e.title||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0441\u0442\u0430\u0442\u044C\u0438",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:e.canRestore?"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C":"",renderBody:()=>{let U=document.createDocumentFragment(),Y=document.createElement("p");if(Y.className="modal-body__text",Y.textContent=e.message||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439 outline-\u0440\u0435\u0436\u0438\u043C\u0430. \u041C\u043E\u0436\u043D\u043E \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0435 \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0441\u0435\u043A\u0446\u0438\u0438 (\u0435\u0441\u043B\u0438 \u0441\u0435\u043A\u0446\u0438\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u2014 \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u043D\u0435\u0446 \u0441\u0442\u0430\u0442\u044C\u0438).",U.appendChild(Y),!d.length){let ge=document.createElement("div");return ge.className="modal-empty",ge.textContent="\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430.",U.appendChild(ge),U}let J=document.createElement("div");J.className="diff-layout diff-layout--article-history";let re=document.createElement("div");re.className="modal-list diff-sidebar",re.classList.add("diff-sections");let he=document.createElement("input");he.type="text",he.className="modal-input",he.placeholder="\u041F\u043E\u0438\u0441\u043A \u043F\u043E \u0438\u0441\u0442\u043E\u0440\u0438\u0438\u2026",re.appendChild(he);let Re=document.createElement("div");Re.style.marginTop="8px",re.appendChild(Re);let G=document.createElement("div");G.className="diff-main";let ie=document.createElement("div");ie.className="diff-layout diff-layout--article-history-inner";let $e=document.createElement("div");$e.className="modal-list diff-sidebar",$e.classList.add("diff-revisions");let dt=document.createElement("div");dt.className="diff-panes diff-panes--side";let ut=document.createElement("div");ut.className="diff-pane-wrap";let Zt=document.createElement("div");Zt.className="diff-pane-wrap";let Mn=document.createElement("div");Mn.className="diff-pane-title",Mn.textContent=e.beforeTitle||"\u0414\u043E";let Z=document.createElement("div");Z.className="diff-pane-title",Z.textContent=e.afterTitle||"\u041F\u043E\u0441\u043B\u0435";let de=document.createElement("div");de.className="diff-pane diff-pane--before";let pe=document.createElement("div");pe.className="diff-pane diff-pane--after",ut.appendChild(Mn),ut.appendChild(de),Zt.appendChild(Z),Zt.appendChild(pe),dt.appendChild(ut),dt.appendChild(Zt),ie.appendChild($e),ie.appendChild(dt),G.appendChild(ie),J.appendChild(re),J.appendChild(G),U.appendChild(J);let ue=()=>{let ge=he.value.trim().toLowerCase(),te=ge?d.filter(me=>(me.label||"").toLowerCase().includes(ge)?!0:(me.entries||[]).some(Ee=>`${Ee.beforePlain||""}
${Ee.afterPlain||""}`.toLowerCase().includes(ge))):d;Re.innerHTML="",te.forEach(me=>{let Ee=document.createElement("button");Ee.type="button";let Ne=me.blockId===l;Ee.className=`diff-item${Ne?" diff-item--active":""}`,Ee.setAttribute("aria-selected",Ne?"true":"false");let Je=me.latestAt?p(new Date(me.latestAt).toISOString()):"",je=Array.isArray(me.entries)?me.entries.length:0;Ee.textContent=`${me.label||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"}${Je?` \xB7 ${Je}`:""}${je?` \xB7 ${je}`:""}`,Ee.addEventListener("click",()=>{l=me.blockId,u=null,f=!1,ue(),le(),ye()}),Re.appendChild(Ee)}),l&&!te.some(me=>me.blockId===l)&&(l=te[0]?.blockId||null,u=null,f=!1,le(),ye())},le=()=>{let ge=l?c.get(l):null,te=Array.isArray(ge?.entries)?ge.entries.slice():[];te.sort((Ee,Ne)=>(Date.parse(Ne.timestamp||"")||0)-(Date.parse(Ee.timestamp||"")||0));let me=u&&te.some(Ee=>String(Ee?.id||"")===String(u||""));(!f||!me)&&(u=te[0]?.id||null),$e.innerHTML="",te.forEach(Ee=>{let Ne=document.createElement("button");Ne.type="button";let Je=String(Ee.id||"")===String(u||"");Ne.className=`diff-item${Je?" diff-item--active":""}`,Ne.setAttribute("aria-selected",Je?"true":"false");let je=p(Ee.timestamp),Qe=(Ee.afterPlain||Ee.beforePlain||"").slice(0,64).trim();Ne.textContent=`${je?`\u2260 ${je}`:`\u2260 ${Ee.id||""}`}${Qe?` \xB7 ${Qe}`:""}`,Ne.addEventListener("click",()=>{u=Ee.id||null,f=!0,le(),ye()}),$e.appendChild(Ne)})},ye=()=>{let ge=l?c.get(l):null,te=Array.isArray(ge?.entries)?ge.entries:[],me=te.find(Je=>String(Je?.id||"")===String(u||""))||te[0]||null,Ee=me?.beforePlain||"",Ne=me?.afterPlain||"";de.innerHTML="",pe.innerHTML="",de.appendChild(Xr({baseText:Ee,nextText:Ne,mode:"before"})),pe.appendChild(Xr({baseText:Ee,nextText:Ne,mode:"after"}))};return he.addEventListener("input",()=>{ue()}),ue(),le(),ye(),U}});b.classList.add("modal-card--fullscreen"),b.classList.add("modal-card--diff-light"),h.classList.remove("danger-btn"),!e.canRestore&&g&&(g.style.display="none"),g&&g.classList.add("danger-btn");let w=!1,S=()=>{},x=!1,T=()=>{y.classList.add("modal-overlay--hide"),setTimeout(()=>y.remove(),150),document.removeEventListener("keydown",B)},N=U=>{w||(w=!0,T(),S(U))},B=U=>{U.code==="Escape"&&(U.preventDefault(),N(null))},$=()=>{let U=l?c.get(l):null,Y=Array.isArray(U?.entries)?U.entries:[];return Y.find(J=>String(J?.id||"")===String(u||""))||Y[0]||null};return new Promise(U=>{S=U,h.addEventListener("click",()=>N(null)),g&&e.canRestore&&g.addEventListener("click",async()=>{let Y=$();if(!Y){L("\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430");return}if(!o){N({action:"restore",entry:Y});return}if(x)return;x=!0;let J=g.textContent;try{g.disabled=!0,h.disabled=!0,g.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C\u2026",await o(Y)}catch(re){L(re?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C")}finally{x=!1,g.textContent=J,g.disabled=!1,h.disabled=!1}}),y.addEventListener("click",Y=>{Y.target===y&&N(null)}),document.addEventListener("keydown",B),t.appendChild(y),requestAnimationFrame(()=>{b.focus({preventScroll:!0})})})}function wa(e={}){let t=dn(),n=null,r=null,{overlay:o,card:i,confirmBtn:s,cancelBtn:c,form:d}=Cn({...e,renderBody:()=>{let h=document.createDocumentFragment();if(e.message){let T=document.createElement("p");T.className="modal-body__text",T.textContent=e.message,h.appendChild(T)}let g=document.createElement("label");g.className="modal-label",g.textContent=e.textLabel||"\u0422\u0435\u043A\u0441\u0442";let w=document.createElement("input");w.type="text",w.className="modal-input",w.placeholder=e.textPlaceholder||"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438",w.value=e.defaultText||"",w.autocomplete="off",g.appendChild(w);let S=document.createElement("label");S.className="modal-label",S.textContent=e.urlLabel||"\u0421\u0441\u044B\u043B\u043A\u0430";let x=document.createElement("input");return x.type="text",x.className="modal-input",x.placeholder=e.urlPlaceholder||"https://example.com",x.value=e.defaultUrl||"",x.autocomplete="off",S.appendChild(x),n=w,r=x,h.appendChild(g),h.appendChild(S),h}}),l=!1,u=()=>{},f=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",y)},p=h=>{l||(l=!0,f(),u(h))},y=h=>{if(h.code==="Escape"){h.preventDefault(),p(null);return}h.code==="Enter"&&!s.disabled&&(h.preventDefault(),p({text:(n?.value||"").trim(),url:(r?.value||"").trim()}))},b=()=>{let h=!!(r?.value||"").trim();s.disabled=!h};return new Promise(h=>{u=h,s.classList.remove("danger-btn"),s.textContent=e.confirmText||"OK",c.textContent=e.cancelText||"Cancel";let g=()=>{p({text:(n?.value||"").trim(),url:(r?.value||"").trim()})};d.addEventListener("submit",S=>{S.preventDefault(),s.disabled||g()}),s.addEventListener("click",g),c.addEventListener("click",()=>p(null)),o.addEventListener("click",S=>{S.target===o&&p(null)}),document.addEventListener("keydown",y);let w=S=>{S&&S.addEventListener("input",b)};w(n),w(r),b(),t.appendChild(o),requestAnimationFrame(()=>{r?(r.focus({preventScroll:!0}),r.value&&r.setSelectionRange(r.value.length,r.value.length)):i.focus({preventScroll:!0})})})}function Di(e={}){let t=dn(),n=null,r=null,{overlay:o,card:i,confirmBtn:s,cancelBtn:c,form:d}=Cn({...e,renderBody:()=>{let h=document.createDocumentFragment();if(e.message){let T=document.createElement("p");T.className="modal-body__text",T.textContent=e.message,h.appendChild(T)}let g=document.createElement("label");g.className="modal-label",g.textContent="\u041F\u0430\u0440\u043E\u043B\u044C";let w=document.createElement("input");w.type="password",w.className="modal-input",w.placeholder="\u041F\u0430\u0440\u043E\u043B\u044C \u0434\u043B\u044F \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B",w.autocomplete="off",g.appendChild(w);let S=document.createElement("label");S.className="modal-label",S.textContent="\u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0430 (\u043D\u0435\u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u044C\u043D\u043E)";let x=document.createElement("input");return x.type="text",x.className="modal-input",x.placeholder="\u041D\u0430\u043F\u043E\u043C\u0438\u043D\u0430\u043D\u0438\u0435 \u043E \u043F\u0430\u0440\u043E\u043B\u0435",x.autocomplete="off",S.appendChild(x),n=w,r=x,h.appendChild(g),h.appendChild(S),h}}),l=!1,u=()=>{},f=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",y)},p=h=>{l||(l=!0,f(),u(h))},y=h=>{if(h.code==="Escape"){h.preventDefault(),p(null);return}h.code==="Enter"&&!s.disabled&&(h.preventDefault(),p({password:(n?.value||"").trim(),hint:(r?.value||"").trim()}))},b=()=>{let h=!!(n?.value||"").trim();s.disabled=!h};return new Promise(h=>{u=h,s.classList.remove("danger-btn"),s.textContent=e.confirmText||"\u0417\u0430\u0449\u0438\u0442\u0438\u0442\u044C",c.textContent=e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430";let g=()=>{s.disabled||p({password:(n?.value||"").trim(),hint:(r?.value||"").trim()})};s.addEventListener("click",g),d.addEventListener("submit",w=>{w.preventDefault(),g()}),c.addEventListener("click",()=>p(null)),o.addEventListener("click",w=>{w.target===o&&p(null)}),document.addEventListener("keydown",y),n&&n.addEventListener("input",b),b(),t.appendChild(o),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):i.focus({preventScroll:!0})})})}function Sa(e={}){let t=dn(),n=Array.isArray(e.items)?e.items:[],{overlay:r,card:o,confirmBtn:i,cancelBtn:s}=Cn({title:e.title||"\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432",renderBody:()=>{let p=document.createElement("div");if(!n.length){let b=document.createElement("p");return b.className="modal-body__text",b.textContent="\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432 \u043F\u0443\u0441\u0442\u0430",p.appendChild(b),p}let y=document.createElement("div");return y.className="block-trash-list",n.forEach(b=>{let h=document.createElement("div");h.className="block-trash-item";let g=b.block&&b.block.text||"",w=hd(g),S=document.createElement("div");S.className="block-trash-item__title",S.textContent=w[0]||"(\u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A)";let x=document.createElement("div");x.className="block-trash-item__meta";let T=b.deletedAt?new Date(b.deletedAt).toLocaleString():"";x.textContent=T||"";let N=document.createElement("div");N.className="block-trash-item__info",N.appendChild(S),T&&N.appendChild(x);let B=document.createElement("button");B.type="button",B.className="primary",B.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",B.addEventListener("click",()=>{u(b)}),h.appendChild(N),h.appendChild(B),y.appendChild(h)}),p.appendChild(y),p}}),c=!1,d=()=>{},l=()=>{r.classList.add("modal-overlay--hide"),setTimeout(()=>r.remove(),150),document.removeEventListener("keydown",f)},u=p=>{c||(c=!0,l(),d(p||null))},f=p=>{p.code==="Escape"&&(p.preventDefault(),u(null))};return new Promise(p=>{d=p,i.classList.remove("hidden"),i.textContent="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u043A\u043E\u0440\u0437\u0438\u043D\u0443",i.classList.add("danger-btn"),s.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",i.addEventListener("click",()=>u({action:"clear"})),s.addEventListener("click",()=>u(null)),r.addEventListener("click",y=>{y.target===r&&u(null)}),document.addEventListener("keydown",f),t.appendChild(r),requestAnimationFrame(()=>{o.focus({preventScroll:!0})})})}function xa(e={}){let t=dn(),{title:n,message:r,existingTitle:o,importedTitle:i,existingCreatedAt:s,existingUpdatedAt:c,importedCreatedAt:d,importedUpdatedAt:l,allowApplyToAll:u=!0}=e||{},f=document.createElement("div");f.className="modal-overlay";let p=document.createElement("div");p.className="modal-card",p.setAttribute("role","dialog"),p.setAttribute("aria-modal","true"),p.tabIndex=-1;let y=document.createElement("div");y.className="modal-header";let b=document.createElement("h3");b.textContent=n||"\u041A\u043E\u043D\u0444\u043B\u0438\u043A\u0442 \u043F\u0440\u0438 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0438",y.appendChild(b);let h=document.createElement("div");if(h.className="modal-body",r){let re=document.createElement("p");re.className="modal-body__text",re.textContent=r,h.appendChild(re)}if(o||i){let re=document.createElement("p");re.className="modal-body__text",re.innerHTML=[o?`<strong>\u0412 \u0431\u0430\u0437\u0435:</strong> ${o}`:"",i?`<strong>\u0418\u0437 \u0444\u0430\u0439\u043B\u0430:</strong> ${i}`:""].filter(Boolean).join("<br />"),h.appendChild(re)}if(s||c||d||l){let re=G=>{if(!G)return"";let ie=new Date(G);return Number.isNaN(ie.getTime())?G:ie.toLocaleString()},he=document.createElement("p");he.className="modal-body__text";let Re=[];if(s||c){let G=s?re(s):"\u2014",ie=c?re(c):"\u2014";Re.push(`<strong>\u0412 \u0431\u0430\u0437\u0435:</strong> \u0441\u043E\u0437\u0434\u0430\u043D\u0430 ${G}, \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430 ${ie}`)}if(d||l){let G=d?re(d):"\u2014",ie=l?re(l):"\u2014";Re.push(`<strong>\u0418\u0437 \u0444\u0430\u0439\u043B\u0430:</strong> \u0441\u043E\u0437\u0434\u0430\u043D\u0430 ${G}, \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430 ${ie}`)}he.innerHTML=Re.join("<br />"),h.appendChild(he)}let g=null;if(u){let re=document.createElement("label");re.className="modal-label";let he=document.createElement("input");he.type="checkbox",he.style.marginRight="0.5rem",re.appendChild(he),re.appendChild(document.createTextNode("\u041F\u0440\u0438\u043C\u0435\u043D\u044F\u0442\u044C \u044D\u0442\u043E \u0440\u0435\u0448\u0435\u043D\u0438\u0435 \u043A\u043E \u0432\u0441\u0435\u043C \u043A\u043E\u043D\u0444\u043B\u0438\u043A\u0442\u0430\u043C")),g=he,h.appendChild(re)}let w=document.createElement("div");w.className="modal-footer modal-footer--stacked";let S=document.createElement("button");S.type="button",S.className="ghost",S.textContent="\u041E\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0443\u044E";let x=document.createElement("button");x.type="button",x.className="primary danger-btn",x.textContent="\u041F\u0435\u0440\u0435\u0437\u0430\u043F\u0438\u0441\u0430\u0442\u044C";let T=document.createElement("button");T.type="button",T.className="ghost",T.textContent="\u0421\u043E\u0437\u0434\u0430\u0442\u044C \u043A\u043E\u043F\u0438\u044E";let N=document.createElement("button");N.type="button",N.className="ghost",N.textContent="\u041E\u0442\u043C\u0435\u043D\u0430",w.appendChild(S),w.appendChild(x),w.appendChild(T),w.appendChild(N),p.appendChild(y),p.appendChild(h),p.appendChild(w),f.appendChild(p);let B=!1,$=()=>{},U=()=>{f.classList.add("modal-overlay--hide"),setTimeout(()=>f.remove(),150),document.removeEventListener("keydown",J)},Y=re=>{if(B)return;B=!0;let he=!!(g&&g.checked);U(),$({action:re,applyToAll:he})},J=re=>{re.code==="Escape"&&(re.preventDefault(),Y(null))};return new Promise(re=>{$=re,S.addEventListener("click",()=>Y("keep")),x.addEventListener("click",()=>Y("overwrite")),T.addEventListener("click",()=>Y("copy")),N.addEventListener("click",()=>Y(null)),f.addEventListener("click",he=>{he.target===f&&Y(null)}),document.addEventListener("keydown",J),t.appendChild(f),requestAnimationFrame(()=>{p.focus({preventScroll:!0})})})}function Lo(e,t=""){let n=dn(),r=document.createElement("div");r.className="modal-overlay image-modal";let o=document.createElement("div");o.className="image-modal__card",o.setAttribute("role","dialog"),o.setAttribute("aria-modal","true"),o.tabIndex=-1;let i=document.createElement("img");i.className="image-modal__img",i.src=e,t&&(i.alt=t),o.appendChild(i),r.appendChild(o);let s,c=()=>{s&&s()},d=l=>{l.code==="Escape"&&(l.preventDefault(),c())};s=()=>{document.removeEventListener("keydown",d),r.classList.add("modal-overlay--hide"),setTimeout(()=>r.remove(),150)},r.addEventListener("click",l=>{l.target===r&&c()}),document.addEventListener("keydown",d),n.appendChild(r),requestAnimationFrame(()=>{o.focus({preventScroll:!0})})}var bd,Rn=Fe(()=>{bn();Et();bd="modal-root"});function xd(e){if(typeof btoa=="function"){let t="";for(let n=0;n<e.length;n+=1)t+=String.fromCharCode(e[n]);return btoa(t)}if(typeof Buffer<"u")return Buffer.from(e).toString("base64");throw new Error("No base64 encoder available")}function kd(e){if(!e)return new Uint8Array(0);if(typeof atob=="function"){let t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r+=1)n[r]=t.charCodeAt(r);return n}if(typeof Buffer<"u"){let t=Buffer.from(e,"base64"),n=new Uint8Array(t.length);for(let r=0;r<t.length;r+=1)n[r]=t[r];return n}throw new Error("No base64 decoder available")}function Mo(e){return typeof e=="string"&&e.startsWith(Aa)}async function Oi(e,t){if(!e)throw new Error("Password is required");let n=t&&t.length?kd(t):Ad(16),r=_i(e||""),o=new Uint8Array(r.length+n.length);return o.set(r,0),o.set(n,r.length),{key:{raw:_i(String.fromCharCode(...o))},salt:xd(n)}}function _i(e=""){let t=2166136261,n=16777619;for(let o=0;o<e.length;o+=1){let i=e.charCodeAt(o);t^=i,t=t*16777619>>>0,n^=i<<o%8,n=n*16777619>>>0}let r=new Uint8Array(32);for(let o=0;o<32;o+=1){let i=o<16?t:n;r[o]=i>>>o%4*8&255}return r}function Ad(e){let t=new Uint8Array(e);for(let n=0;n<e;n+=1)t[n]=Math.floor(Math.random()*256);return t}async function Ia(e,t=""){if(!e)throw new Error("Missing encryption key");let n=e&&e.raw?e.raw:_i("fallback-key"),r=Ad(12),i=new TextEncoder().encode(t||""),s=new Uint8Array(r.length+i.length);s.set(r,0);for(let c=0;c<i.length;c+=1){let d=n[c%n.length],l=r[c%r.length];s[r.length+c]=i[c]^d^l}return`${Aa}${xd(s)}`}async function No(e,t){if(!e)throw new Error("Missing encryption key");if(!Mo(t))throw new Error("Data is not in encrypted format");let n=t.slice(Aa.length),r=kd(n);if(r.length<13)throw new Error("Encrypted payload is too short");let o=r.slice(0,12),i=r.slice(12),s=e&&e.raw?e.raw:_i("fallback-key"),c=new Uint8Array(i.length);for(let l=0;l<i.length;l+=1){let u=s[l%s.length],f=o[l%o.length];c[l]=i[l]^u^f}return new TextDecoder().decode(c)}async function va(e){return Ia(e,Sd)}async function Id(e,t){if(!t)return!1;try{return await No(e,t)===Sd}catch{return!1}}async function vd(e,t){if(!e)return;if(typeof e.text=="string"&&Mo(e.text))try{e.text=await No(t,e.text)}catch{e.text=""}let n=Array.isArray(e.children)?e.children:[];for(let r of n)await vd(r,t)}async function Ea(e,t){if(!(!e||!Array.isArray(e.blocks)))for(let n of e.blocks)await vd(n,t)}async function Po(e,t){if(!e)return;typeof e.text=="string"&&(e.text=await Ia(t,e.text));let n=Array.isArray(e.children)?e.children:[];for(let r of n)await Po(r,t)}async function Ri(e,t){return Ia(e,t||"")}var Aa,Sd,Do=Fe(()=>{Aa="enc-v1:",Sd="memus-article-encryption-ok"});function eh(e){return String(e||"").trim()}async function Ed(e,{blockLimit:t=30,articleLimit:n=15}={}){let r=eh(e);if(!r)return[];let o=await st(),i=r.toLowerCase(),s=o.transaction(["articles","outline_sections"],"readonly"),c=s.objectStore("articles"),d=s.objectStore("outline_sections"),l=await Ce(c.getAll()).catch(()=>[])||[],u=l.filter(g=>g&&!g.deletedAt).filter(g=>String(g.title||"").toLowerCase().includes(i)).sort((g,w)=>String(w.updatedAt||"").localeCompare(String(g.updatedAt||""))).slice(0,Math.max(0,Number(n)||0)).map(g=>({type:"article",articleId:g.id,articleTitle:g.title||"",snippet:g.title||""}));try{if(!Number(await Ce(d.count()).catch(()=>0)))return await Ue(s),navigator.onLine?null:u}catch{}let f=await Ce(d.getAll()).catch(()=>[])||[],p=new Map(l.map(g=>[g.id,g.title||""])),y=Math.max(0,Number(t)||0),b=f.filter(g=>String(g?.text||"").toLowerCase().includes(i)).sort((g,w)=>String(w?.updatedAt||"").localeCompare(String(g?.updatedAt||""))).slice(0,y).map(g=>({blockId:g.sectionId,articleId:g.articleId,articleTitle:p.get(g.articleId)||"",blockText:g.text||""})),h=[];for(let g of b){let w=g.articleTitle||"",S=g.blockText||"";h.push({type:"block",articleId:g.articleId,articleTitle:w,blockId:g.blockId,snippet:S.slice(0,160),blockText:S})}return await Ue(s),[...u,...h]}var Td=Fe(()=>{Qn();En()});function Cd(e=""){return String(e||"").replace(/\r\n/g,`
`).replace(/\u00a0/g," ").split(`
`).map(t=>t.replace(/[ \t]+$/g,""))}function Bd(e=""){let t=a.searchQuery.trim();if(!t)return it(e);let n=new RegExp(Mi(t),"gi");return it(e).replace(n,r=>`<mark>${r}</mark>`)}function hr(){if(!m.ragOpenBtn)return;if(a.sidebarSearchView!=="search"){m.ragOpenBtn.classList.add("hidden");return}let e=a.searchMode==="semantic"&&!!a.searchQuery.trim()&&!a.searchLoading&&!a.searchError&&Array.isArray(a.searchResults)&&a.searchResults.length>0;m.ragOpenBtn.classList.toggle("hidden",!e)}function Lr(){if(!m.searchResults)return;if(a.sidebarSearchView!=="search"){m.searchResults.classList.add("hidden"),m.searchResults.innerHTML="",hr();return}if(!a.searchQuery.trim()){m.searchResults.classList.add("hidden"),m.searchResults.innerHTML="",hr();return}if(m.searchResults.classList.remove("hidden"),a.searchLoading){m.searchResults.innerHTML='<div class="search-result-empty">\u041F\u043E\u0438\u0441\u043A...</div>',hr();return}if(a.searchError){m.searchResults.innerHTML=`<div class="search-result-empty">${it(a.searchError)}</div>`,hr();return}if(!a.searchResults.length){m.searchResults.innerHTML='<div class="search-result-empty">\u041D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E</div>',hr();return}m.searchResults.innerHTML="",a.searchResults.forEach(t=>{let n=t.type==="article",r=document.createElement("div");r.className="search-result-item";let o=t.articleTitle||" ",i="",s=t.articleTitle||"";if(!n){let u=Cd(t.blockText||""),f=u.findIndex(p=>p.trim()!=="");i=f>=0?(u[f]||"").trim():"",o=i||s||" "}let c=Bd(o||" "),d=n?"\u0421\u0442\u0430\u0442\u044C\u044F":"\u0411\u043B\u043E\u043A",l="";if(!n){let u=Cd(t.blockText||""),f=u.findIndex(g=>g.trim()!==""),b=(f>=0?u.slice(f+1).filter(g=>g.trim()!==""):u.filter(g=>g.trim()!=="")).slice(0,2).map(g=>Bd(g)).join("<br />");l=`${s?`<div class="search-result-item__article">${it(s)}</div>`:""}${b?`<div>${b}</div>`:""}`}r.innerHTML=`
      <div class="search-result-item__header">
        <span class="search-result-item__badge">${d}</span>
        <span class="search-result-item__title">${c}</span>
      </div>
      ${l?`<div class="search-result-item__snippet">${l}</div>`:""}
    `,r.addEventListener("mousedown",u=>{u.preventDefault(),th(t)}),m.searchResults.appendChild(r)}),hr()}function Zn(){m.searchResults&&m.searchResults.classList.add("hidden")}async function Ld(e){if(a.sidebarSearchView!=="search"){Zn(),hr();return}let t=e.target.value;if(a.searchQuery=t,!t.trim()){a.searchResults=[],a.searchError="",a.searchLoading=!1,Lr();return}a.searchLoading=!0;let n=Date.now();a.searchRequestId=n,Lr();try{let r=null;if(a.searchMode!=="semantic")try{r=await Ed(t)}catch{r=null}r||(r=await(a.searchMode==="semantic"?Yl:Wl)(t)),a.searchRequestId===n&&(a.searchResults=r,a.searchError="")}catch(r){a.searchRequestId===n&&(a.searchError=r.message)}finally{a.searchRequestId===n&&(a.searchLoading=!1,Lr())}}function th(e){Zn(),m.searchInput&&(m.searchInput.value=""),a.searchQuery="",a.searchResults=[],a.searchError="",hr();let t=e.type==="article";a.scrollTargetBlockId=t?null:e.blockId,a.currentBlockId=t?null:e.blockId,a.isSidebarMobileOpen&&en(!1),gt(pt.article(e.articleId))}function Md(){let e=a.searchQuery.trim();e&&a.searchMode==="semantic"&&(a.searchLoading||a.searchError||!Array.isArray(a.searchResults)||!a.searchResults.length||(a.ragQuery=e,a.ragResults=JSON.parse(JSON.stringify(a.searchResults)),a.ragSummaryHtml="",a.ragSummaryError="",a.ragSummaryLoading=!0,a.scrollTargetBlockId=null,a.currentBlockId=null,gt(pt.article("RAG")),(async()=>{It("\u0413\u0435\u043D\u0435\u0440\u0438\u0440\u0443\u044E \u0441\u0432\u043E\u0434\u043A\u0443\u2026",{protect:!0});try{let t=await Xl(a.ragQuery,a.ragResults);a.ragSummaryHtml=t&&t.summaryHtml||"",a.ragSummaryError=""}catch(t){a.ragSummaryError=t.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0440\u0435\u0437\u044E\u043C\u0435",a.ragSummaryHtml=""}finally{a.ragSummaryLoading=!1,ot({force:!0}),a.articleId==="RAG"&&gt(pt.article("RAG"))}})()))}var Hi=Fe(()=>{ft();vt();bn();Pt();wn();tn();Et();Td()});function _d(){try{let e=localStorage.getItem(Dd);e==="1"?a.isSidebarCollapsed=!0:e==="0"&&(a.isSidebarCollapsed=!1)}catch{}}function Od(){try{localStorage.setItem(Dd,a.isSidebarCollapsed?"1":"0")}catch{}}function Rd(){try{let e=localStorage.getItem(Nd),t=e?JSON.parse(e):[];a.sidebarCollapsedArticleIds=Array.isArray(t)?t:[]}catch{a.sidebarCollapsedArticleIds=[]}}function _o(){try{localStorage.setItem(Nd,JSON.stringify(a.sidebarCollapsedArticleIds||[]))}catch{}}function Hd(){try{let e=localStorage.getItem(Pd),t=e?JSON.parse(e):[];a.listCollapsedArticleIds=Array.isArray(t)?t:[]}catch{a.listCollapsedArticleIds=[]}}function Mr(){try{localStorage.setItem(Pd,JSON.stringify(a.listCollapsedArticleIds||[]))}catch{}}function er(){let e=a.sidebarSelectedArticleId||a.articleId;if(!e)return;let t=a.isTrashView?a.deletedArticlesIndex:a.articlesIndex;if(!Array.isArray(t)||!t.length)return;let n=new Map(t.map(s=>[s.id,s])),r=new Set(a.sidebarCollapsedArticleIds||[]),o=new Set,i=n.get(e)||null;for(;i&&i.parentId&&!o.has(i.parentId);)o.add(i.parentId),r.delete(i.parentId),i=n.get(i.parentId)||null;a.sidebarCollapsedArticleIds=Array.from(r),_o()}var Nd,Pd,Dd,Gr=Fe(()=>{ft();Nd="ttree_collapsed_articles",Pd="ttree_list_collapsed_articles",Dd="ttree_sidebar_collapsed"});function Ta(){m.articlesTabBtn&&(m.articlesTabBtn.classList.toggle("active",!a.isTrashView),m.articlesTabBtn.setAttribute("aria-pressed",a.isTrashView?"false":"true")),m.trashTabBtn&&(m.trashTabBtn.classList.toggle("active",a.isTrashView),m.trashTabBtn.setAttribute("aria-pressed",a.isTrashView?"true":"false")),m.createArticleBtn&&(m.createArticleBtn.disabled=a.isTrashView),m.sidebarNewArticleBtn&&(m.sidebarNewArticleBtn.disabled=a.isTrashView)}function tr(){qn&&(Qs(!1),m.hintPopover&&m.hintPopover.classList.add("hidden"),m.hintToggleBtn&&m.hintToggleBtn.setAttribute("aria-expanded","false"))}function Ca(e){e&&e.stopPropagation(),Qs(!qn),m.hintPopover&&m.hintPopover.classList.toggle("hidden",!qn),m.hintToggleBtn&&m.hintToggleBtn.setAttribute("aria-expanded",qn?"true":"false")}function Nr(e){m.sidebar&&(a.isSidebarCollapsed=e,m.sidebar.classList.toggle("collapsed",e),m.sidebarToggle&&(m.sidebarToggle.setAttribute("aria-expanded",e?"false":"true"),m.sidebarToggle.title=e?"\u041F\u043E\u043A\u0430\u0437\u0430\u0442\u044C \u043F\u0430\u043D\u0435\u043B\u044C":"\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C \u043F\u0430\u043D\u0435\u043B\u044C",m.sidebarToggle.textContent=e?"\u2192":"x"),Od(),e&&(tr(),Zn()))}function Ba(){Nr(!a.isSidebarCollapsed)}function en(e){a.isSidebarMobileOpen=e,m.sidebar&&m.sidebar.classList.toggle("mobile-open",e),m.sidebarBackdrop&&m.sidebarBackdrop.classList.toggle("hidden",!e),e&&(tr(),Zn())}function Oo(){en(!1)}function Ro(e){m.articleView.classList.toggle("hidden",!e),m.articleListView.classList.toggle("hidden",e),m.articleHeader&&m.articleHeader.classList.toggle("hidden",!e),e||tr(),e&&a.isTrashView&&(a.isTrashView=!1,Ta())}var $i=Fe(()=>{ft();vt();Hi();Gr()});function Vd({renderSidebarArticleList:e,renderMainArticleList:t,setArticlesIndex:n}={}){zd=typeof e=="function"?e:null,La=typeof t=="function"?t:null,Ud=typeof n=="function"?n:null}function zi(){Hn&&(Hn.classList.remove("drop-before","drop-after","drop-inside"),Hn=null)}function qd(e,t){e&&(Hn&&Hn!==e&&Hn.classList.remove("drop-before","drop-after","drop-inside"),Hn=e,Hn.classList.remove("drop-before","drop-after","drop-inside"),t==="before"?Hn.classList.add("drop-before"):t==="after"?Hn.classList.add("drop-after"):t==="inside"&&Hn.classList.add("drop-inside"))}function oh(){xt&&(xt.sourceEl instanceof Element&&xt.sourceEl.classList.remove("article-dnd-source"),typeof document<"u"&&document.body&&document.body.classList.remove("article-dnd-active"),window.removeEventListener("pointermove",Pa),window.removeEventListener("pointerup",Ho),window.removeEventListener("pointercancel",Ho),window.removeEventListener("touchmove",Kd),window.removeEventListener("touchend",Fi),window.removeEventListener("touchcancel",Fi),xt=null,zi(),window.__ttreeDraggingArticleId=null)}function $d(e){return e instanceof Element?!!(e.closest(".star-btn")||e.closest(".row-actions")):!1}function ih(e,t){if(!t||xt||!e.touches||e.touches.length!==1)return;let n=e.touches[0],r=e.currentTarget instanceof Element?e.currentTarget:null;xt={pointerId:"legacy-touch",articleId:t,startX:n.clientX,startY:n.clientY,dragging:!1,lastTargetId:null,lastDropMode:null,sourceEl:r},window.__ttreeDraggingArticleId=t,typeof document<"u"&&document.body&&document.body.classList.add("article-dnd-active");try{let o=window.getSelection?window.getSelection():null;o&&!o.isCollapsed&&o.removeAllRanges()}catch{}window.addEventListener("touchmove",Kd,{passive:!1}),window.addEventListener("touchend",Fi),window.addEventListener("touchcancel",Fi)}function Kd(e){if(!xt||!e.touches||e.touches.length===0)return;let t=e.touches[0];Pa({pointerId:"legacy-touch",clientX:t.clientX,clientY:t.clientY,preventDefault:()=>{e.preventDefault()}})}function Fi(){xt&&Ho({pointerId:"legacy-touch"})}function sh(e,t){let n=document.elementFromPoint(e,t);if(!n)return null;let r=n.closest(".sidebar-article-item, #articleList li");return!r||!r.dataset||!r.dataset.articleId?null:r}function ah(e,t){if(!t||xt)return;let n=e.currentTarget instanceof Element?e.currentTarget:null;xt={pointerId:e.pointerId,articleId:t,startX:e.clientX,startY:e.clientY,dragging:!1,lastTargetId:null,lastDropMode:null,sourceEl:n},window.__ttreeDraggingArticleId=t,typeof document<"u"&&document.body&&document.body.classList.add("article-dnd-active");try{let r=window.getSelection?window.getSelection():null;r&&!r.isCollapsed&&r.removeAllRanges()}catch{}try{e.currentTarget?.setPointerCapture?.(e.pointerId)}catch{}window.addEventListener("pointermove",Pa),window.addEventListener("pointerup",Ho),window.addEventListener("pointercancel",Ho)}function Pa(e){if(!xt||e.pointerId!==xt.pointerId)return;let t=e.clientX-xt.startX,n=e.clientY-xt.startY;if(!xt.dragging){if(Math.hypot(t,n)<nh)return;xt.dragging=!0,xt.sourceEl instanceof Element&&xt.sourceEl.classList.add("article-dnd-source")}e.preventDefault();let r=sh(e.clientX,e.clientY);if(!r||!r.dataset||!r.dataset.articleId||r.dataset.articleId===xt.articleId){zi(),xt.lastTargetId=null,xt.lastDropMode=null;return}let o=r.getBoundingClientRect(),i=e.clientY-o.top,s=o.height/3,c;i<s?c="before":i>o.height-s?c="after":c="inside",xt.lastTargetId=r.dataset.articleId,xt.lastDropMode=c,qd(r,c)}function Ho(e){if(!xt||e.pointerId!==xt.pointerId)return;let t=xt;oh(),!(!t.dragging||!t.lastTargetId||!t.lastDropMode)&&t.lastTargetId!==t.articleId&&Jd(t.articleId,t.lastTargetId,t.lastDropMode)}function Da(e,t){e&&(rh?e.addEventListener("pointerdown",n=>{if(n.pointerType!=="touch"||typeof n.button=="number"&&n.button!==0||$d(n.target))return;let r=n.pointerId,o=350,i=!1,s=window.setTimeout(()=>{i=!0,ah(n,t)},o),c=d=>{d.pointerId===r&&(i||window.clearTimeout(s),window.removeEventListener("pointerup",c,!0),window.removeEventListener("pointercancel",c,!0))};window.addEventListener("pointerup",c,!0),window.addEventListener("pointercancel",c,!0)}):e.addEventListener("touchstart",n=>{if(!n.touches||n.touches.length!==1)return;let r=n.target;if($d(r))return;let o=350,i=!1,s=window.setTimeout(()=>{i=!0,ih(n,t)},o),c=()=>{i||window.clearTimeout(s),window.removeEventListener("touchend",c,!0),window.removeEventListener("touchcancel",c,!0)};window.addEventListener("touchend",c,!0),window.addEventListener("touchcancel",c,!0)},{passive:!1}))}function Na(e){return e&&(a.articlesIndex||[]).find(t=>t.id===e)||null}function Fd(e){let t=e||null;return(a.articlesIndex||[]).filter(n=>(n.parentId||null)===t).sort((n,r)=>n.position!==r.position?n.position-r.position:new Date(n.updatedAt||0)-new Date(r.updatedAt||0))}function ch(e,t,n,r){if(!e)return;let o=Na(e);if(!o)return;let i=t||null,s=o.parentId||null,d=Fd(s).filter(y=>y.id!==e),l;i===s?l=d:l=Fd(i);let u=l.filter(y=>y.id!==e),f=u.length;if(n&&r&&r!=="inside"){let y=u.findIndex(b=>b.id===n);y!==-1&&(f=r==="before"?y:y+1)}r==="inside"&&(f=u.length),f<0&&(f=0),f>u.length&&(f=u.length);let p=u.slice();p.splice(f,0,o),o.parentId=i,d.forEach((y,b)=>{y.position=b}),p.forEach((y,b)=>{y.parentId=i,y.position=b})}function Jd(e,t,n){if(!e||!t||!n)return;let r=Na(e),o=Na(t);if(!r||!o)return;let i=n==="inside"?o.id:o.parentId||null,s=n==="inside"?null:o.id;ch(e,i,s,n),zd?.(),La?.(),(async()=>{try{await fd(e,{parentId:i,anchorId:s,placement:n})}catch(c){try{let d=await yn();Ud?.(d),La?.()}catch{}L(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443")}})()}function lh(e){window.__ttreeDraggingArticleId?un=window.__ttreeDraggingArticleId:un=e.currentTarget?.dataset?.articleId||null,e.dataTransfer&&(e.dataTransfer.effectAllowed="move",un&&e.dataTransfer.setData("text/plain",un))}function dh(e){if(!un){let s=window.__ttreeDraggingArticleId,c=null;if(!s&&e?.dataTransfer)try{c=e.dataTransfer.getData("text/plain")||null}catch{c=null}un=s||c||null}if(!un||!e.currentTarget||!e.currentTarget.dataset.articleId)return;e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="move");let t=e.currentTarget,n=t.getBoundingClientRect(),r=e.clientY-n.top,o=n.height/3,i;r<o?i="before":r>n.height-o?i="after":i="inside",qd(t,i)}function uh(e){if(!un){let c=window.__ttreeDraggingArticleId,d=null;if(!c&&e?.dataTransfer)try{d=e.dataTransfer.getData("text/plain")||null}catch{d=null}un=c||d||null}if(!un)return;let t=e.currentTarget,n=t?.dataset?.articleId||null;if(!n||n===un)return;e.preventDefault(),zi();let r=t.getBoundingClientRect(),o=e.clientY-r.top,i=r.height/3,s;o<i?s="before":o>r.height-i?s="after":s="inside",Jd(un,n,s),un=null}function fh(){un=null,window.__ttreeDraggingArticleId=null,zi()}function _a(e){e&&(e.draggable=!0,e.addEventListener("dragstart",lh),e.addEventListener("dragover",dh),e.addEventListener("drop",uh),e.addEventListener("dragend",fh))}var zd,La,Ud,Ma,un,Hn,nh,xt,rh,Oa=Fe(()=>{ft();Pt();Et();zd=null,La=null,Ud=null;Ma=!1;typeof window<"u"&&(window.matchMedia&&window.matchMedia("(pointer: coarse)").matches||"ontouchstart"in window)&&(Ma=!0);un=null,Hn=null,nh=6,xt=null,rh=typeof window<"u"&&"PointerEvent"in window&&!Ma});function ph(){try{let e=localStorage.getItem(jd),t=e?JSON.parse(e):[];a.favoriteArticles=Array.isArray(t)?t:[]}catch{a.favoriteArticles=[]}}function mh(){try{localStorage.setItem(jd,JSON.stringify(a.favoriteArticles||[]))}catch{}}function Wd(e=[]){let t=new Set(a.favoriteArticles||[]);return[...e].sort((n,r)=>{let o=t.has(n.id),i=t.has(r.id);return o!==i?o?-1:1:new Date(r.updatedAt||r.deletedAt||0)-new Date(n.updatedAt||n.deletedAt||0)})}function Qr(e){if(!e)return;a.favoriteArticles||(a.favoriteArticles=[]);let t=new Set(a.favoriteArticles);t.has(e)?t.delete(e):t.add(e),a.favoriteArticles=Array.from(t),mh(),wt(),qt()}function Ui(e=[]){(!a.favoriteArticles||!a.favoriteArticles.length)&&ph();let t=Array.isArray(e)?e:[];a.articlesIndex=t.map(r=>({id:r.id,title:r.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",updatedAt:r.updatedAt||new Date().toISOString(),deletedAt:r.deletedAt||null,publicSlug:r.publicSlug||null,parentId:r.parentId||null,position:typeof r.position=="number"?r.position:0}));let n=new Set(a.articlesIndex.map(r=>r.id));Array.isArray(a.sidebarCollapsedArticleIds)&&a.sidebarCollapsedArticleIds.length&&(a.sidebarCollapsedArticleIds=a.sidebarCollapsedArticleIds.filter(r=>n.has(r)),_o()),Array.isArray(a.listCollapsedArticleIds)&&a.listCollapsedArticleIds.length&&(a.listCollapsedArticleIds=a.listCollapsedArticleIds.filter(r=>n.has(r)),Mr()),wt()}function Yd(e=[]){let t=Wd(Array.isArray(e)?e:[]);a.deletedArticlesIndex=t,wt()}function Vi(e){let t=(a.articleFilterQuery||"").trim(),n=e?.target?.value||"",r=String(n||"").trim();a.articleFilterQuery=n;let o=!!(t&&!r&&a.sidebarArticlesMode!=="recent");o&&er(),wt(),o&&window.requestAnimationFrame(()=>{try{qi()}catch{}})}function Xd(e){let t=String(e||"").trim();if(!t||!m?.sidebarArticleList)return;let n=m.sidebarArticleList.querySelector(`li.sidebar-article-item[data-article-id="${CSS.escape(t)}"]`)||m.sidebarArticleList.querySelector(`li[data-article-id="${CSS.escape(t)}"]`);if(n)try{n.scrollIntoView({block:"center",inline:"nearest"})}catch{}}function qi(){let e=a.sidebarSelectedArticleId||a.articleId;e&&Xd(e)}function Bn(e){if(!e||!e.id||e.deletedAt)return;let t={id:e.id,title:e.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",updatedAt:e.updatedAt||new Date().toISOString(),publicSlug:e.publicSlug||null,parentId:e.parentId||null,position:typeof e.position=="number"?e.position:0},n=a.articlesIndex.findIndex(r=>r.id===t.id);n>=0?a.articlesIndex[n]={...a.articlesIndex[n],...t}:a.articlesIndex.unshift(t),wt()}function Ra(e){if(!e)return;let t=a.articlesIndex.length;a.articlesIndex=a.articlesIndex.filter(n=>n.id!==e),t!==a.articlesIndex.length&&(wt(),qt())}function $o(e){if(!e)return;let t=a.deletedArticlesIndex.length;a.deletedArticlesIndex=a.deletedArticlesIndex.filter(n=>n.id!==e),t!==a.deletedArticlesIndex.length&&(wt(),qt())}function Gd(e=[]){let t=new Map;e.forEach(o=>{t.set(o.id,{...o,children:[]})});let n=[];t.forEach(o=>{let i=o.parentId||null;i&&t.has(i)?t.get(i).children.push(o):n.push(o)});let r=o=>{o.sort((i,s)=>{let c=(a.favoriteArticles||[]).includes(i.id),d=(a.favoriteArticles||[]).includes(s.id);return c!==d?c?-1:1:i.position!==s.position?i.position-s.position:new Date(s.updatedAt||0)-new Date(i.updatedAt||0)}),o.forEach(i=>r(i.children||[]))};return r(n),n}function wt(){if(!m.sidebarArticleList)return;m.sidebarArticleList.innerHTML="",m.backToList&&m.backToList.classList.toggle("active",a.sidebarArticlesMode!=="recent"),m.sidebarRecentBtn&&m.sidebarRecentBtn.classList.toggle("active",a.sidebarArticlesMode==="recent");let e=(a.articleFilterQuery||"").trim().toLowerCase(),t=a.sidebarArticlesMode==="recent"?"recent":"tree",n=a.isTrashView?a.deletedArticlesIndex:a.articlesIndex,r=new Set(a.favoriteArticles||[]),o=new Set(a.sidebarCollapsedArticleIds||[]),i=a.sidebarSelectedArticleId||a.articleId,s=Array.isArray(a.recentArticleIds)?a.recentArticleIds:[],c=[];if(!a.isTrashView&&(r.has("RAG")||t==="recent"&&s.includes("RAG"))){let h=(a.ragQuery||"").trim();c.push({id:"RAG",title:h?`AI: ${h}`:"AI: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B \u043F\u043E\u0438\u0441\u043A\u0430",updatedAt:new Date().toISOString(),deletedAt:null,publicSlug:null,parentId:null,position:0})}let l=new Set(c.map(h=>h.id)),u=c.length&&!a.isTrashView?[...(n||[]).filter(h=>!l.has(h.id)),...c]:n,f=new Set;(u||[]).forEach(h=>{let g=h.parentId||null;g&&f.add(g)});let p=(u||[]).filter(h=>(e?(h.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(e):!0)&&(a.isTrashView?!0:h.id!=="inbox"));if(!p.length){let h=document.createElement("li");h.className="sidebar-article-empty",h.textContent=a.isTrashView?e?"No deleted pages match the filter":"Trash is empty":e?"\u041D\u0435\u0442 \u0441\u043E\u0432\u043F\u0430\u0434\u0435\u043D\u0438\u0439":"\u041D\u0435\u0442 \u0441\u0442\u0430\u0442\u0435\u0439",m.sidebarArticleList.appendChild(h);return}if(t==="recent"){let h=new Map(p.map(T=>[T.id,T])),g=new Set(s),w=s.map(T=>h.get(T)).filter(Boolean),S=Wd(p.filter(T=>!g.has(T.id)));[...w,...S].forEach(T=>{let N=document.createElement("li");N.className="sidebar-article-item",N.dataset.articleId=T.id;let B=document.createElement("div");B.className="sidebar-article-row";let $=document.createElement("button");$.type="button",!a.isTrashView&&T.id===i&&$.classList.add("active");let U=r.has(T.id),Y=it(T.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),J=T.publicSlug?"\uE774 ":"";$.innerHTML=`<span class="sidebar-article-title">${J}${Y}</span><span class="star-btn ${U?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${U?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}">${U?"\uE735":"\uE734"}</span>`,$.addEventListener("click",()=>{window.__ttreeDraggingArticleId||(a.sidebarSelectedArticleId=T.id,gt(pt.article(T.id)),a.isSidebarMobileOpen&&en(!1))});let re=$.querySelector(".star-btn");re&&re.addEventListener("click",he=>{he.stopPropagation(),Qr(T.id)}),B.appendChild($),N.appendChild(B),m.sidebarArticleList.appendChild(N)});return}let y=Gd(p),b=(h,g)=>{let w=document.createElement("li");w.className="sidebar-article-item",f.has(h.id)&&(w.classList.add("has-children"),o.has(h.id)&&w.classList.add("is-collapsed")),w.dataset.articleId=h.id,w.style.paddingLeft=`${g*1.25}rem`;let S=document.createElement("div");S.className="sidebar-article-row";let x=document.createElement("button");x.type="button",!a.isTrashView&&h.id===i&&x.classList.add("active");let T=r.has(h.id),N=it(h.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),B=h.publicSlug?"\uE774 ":"";x.innerHTML=`<span class="sidebar-article-title">${B}${N}</span><span class="star-btn ${T?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${T?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}">${T?"\uE735":"\uE734"}</span>`,x.addEventListener("click",()=>{if(window.__ttreeDraggingArticleId)return;a.sidebarSelectedArticleId=h.id,a.sidebarCollapsedArticleIds||(a.sidebarCollapsedArticleIds=[]);let U=new Set(a.sidebarCollapsedArticleIds);U.has(h.id)?U.delete(h.id):U.add(h.id),a.sidebarCollapsedArticleIds=Array.from(U),_o(),wt()}),x.addEventListener("dblclick",U=>{U.preventDefault(),U.stopPropagation(),a.sidebarSelectedArticleId=h.id,gt(pt.article(h.id)),a.isSidebarMobileOpen&&en(!1)});let $=x.querySelector(".star-btn");$&&$.addEventListener("click",U=>{U.stopPropagation(),Qr(h.id)}),S.appendChild(x),w.appendChild(S),a.isTrashView||(_a(w),Da(w,h.id)),m.sidebarArticleList.appendChild(w),o.has(h.id)||(h.children||[]).forEach(U=>b(U,g+1))};y.forEach(h=>b(h,0))}function qt(e=null){if(!m.articleList)return;m.articleList.innerHTML="";let t="",n=Array.isArray(e)&&e.length?e:a.isTrashView?a.deletedArticlesIndex:a.articlesIndex,r=new Set(a.favoriteArticles||[]),o=new Set(a.listCollapsedArticleIds||[]),i=a.listSelectedArticleId||a.articleId,s=new Set;if(n.forEach(u=>{let f=u.parentId||null;f&&s.add(f)}),!n.length){let u=document.createElement("li");u.textContent=a.isTrashView?t?"No deleted pages match the filter":"Trash is empty":t?"\u041D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E":"\u0421\u043F\u0438\u0441\u043E\u043A \u043F\u0443\u0441\u0442.",m.articleList.appendChild(u);return}if(a.isTrashView){n.slice().filter(u=>(t?(u.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(t):!0)&&(a.isTrashView?!0:u.id!=="inbox")).forEach(u=>{let f=document.createElement("li");f.dataset.articleId=u.id,f.innerHTML=`
      <span>
        <strong>${it(u.title)}</strong>
      </span>
      <div class="row-actions">
        <button class="ghost restore-btn" data-id="${u.id}">\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C</button>
        <button class="ghost danger delete-btn" data-id="${u.id}">\u0423\u0434\u0430\u043B\u0438\u0442\u044C</button>
      </div>
    `;let p=f.querySelector(".restore-btn"),y=f.querySelector(".delete-btn");p&&p.addEventListener("click",async b=>{b.preventDefault(),b.stopPropagation(),await hh(u.id)}),y&&y.addEventListener("click",async b=>{b.preventDefault(),b.stopPropagation(),await gh(u.id)}),m.articleList.appendChild(f)});return}let c=n.slice().filter(u=>(t?(u.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(t):!0)&&u.id!=="inbox"),d=Gd(c),l=(u,f)=>{let p=document.createElement("li");s.has(u.id)&&(p.classList.add("has-children"),o.has(u.id)&&p.classList.add("is-collapsed")),p.dataset.articleId=u.id;let y=r.has(u.id),b=it(u.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),h=u.publicSlug?'<span class="article-public-icon">&#xE774;</span>':"";p.style.paddingLeft=`${f*1.25}rem`,p.innerHTML=`
      <span>
        <strong>${h}${b}</strong>
      </span>
      <button class="ghost star-btn ${y?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${y?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}">${y?"\uE735":"\uE734"}</button>
    `;let g=p.querySelector(".star-btn");g&&g.addEventListener("click",w=>{w.preventDefault(),w.stopPropagation(),Qr(u.id)}),u.id===i&&p.classList.add("active-article"),p.addEventListener("click",()=>{if(window.__ttreeDraggingArticleId)return;a.listSelectedArticleId=u.id,a.listCollapsedArticleIds||(a.listCollapsedArticleIds=[]);let w=new Set(a.listCollapsedArticleIds);w.has(u.id)?w.delete(u.id):w.add(u.id),a.listCollapsedArticleIds=Array.from(w),Mr(),qt()}),p.addEventListener("dblclick",w=>{w.preventDefault(),w.stopPropagation(),a.listSelectedArticleId=u.id,gt(pt.article(u.id))}),m.articleList.appendChild(p),a.isTrashView||(_a(p),Da(p,u.id)),o.has(u.id)||(u.children||[]).forEach(w=>l(w,f+1))};d.forEach(u=>l(u,0))}async function hh(e){if(e)try{let t=await td(e);$o(e),Bn(t),await Fo(!1),gt(pt.article(t.id)),L("Page restored")}catch(t){L(t.message)}}async function gh(e){if(e)try{await Ci(e,{force:!0}),$o(e),L("\u0421\u0442\u0430\u0442\u044C\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u0431\u0435\u0437\u0432\u043E\u0437\u0432\u0440\u0430\u0442\u043D\u043E"),qt(),wt()}catch(t){L(t.message)}}async function Fo(e){a.isTrashView=e,Ta(),e?await Ki():await nr(),wt(),qt()}async function nr(){if(a.articlesIndex.length)return a.isTrashView||wt(),a.articlesIndex;let e=await yn();return Ui(e),e}async function Ki(){if(a.deletedArticlesIndex.length)return a.isTrashView&&wt(),a.deletedArticlesIndex;let e=await Kl();return Yd(e),e}var jd,Ji=Fe(()=>{ft();vt();bn();wn();Pt();Et();$i();Gr();Oa();jd="ttree_favorites"});function eu(){try{let t=(window.localStorage.getItem(Qd)||""||"").trim().toLowerCase();(t==="recent"||t==="tree")&&(a.sidebarArticlesMode=t)}catch{}try{let e=window.localStorage.getItem(Zd)||"[]",t=JSON.parse(e);Array.isArray(t)&&(a.recentArticleIds=t.filter(n=>typeof n=="string"&&n&&n!=="inbox").slice(0,Ha))}catch{}}function yh(){try{window.localStorage.setItem(Qd,a.sidebarArticlesMode||"tree")}catch{}}function bh(){try{let e=Array.isArray(a.recentArticleIds)?a.recentArticleIds:[];window.localStorage.setItem(Zd,JSON.stringify(e.slice(0,Ha)))}catch{}}function $a(){let e=a.sidebarArticlesMode,t=a.sidebarArticlesMode==="recent"?"tree":"recent";a.sidebarArticlesMode=t,yh(),e==="recent"&&t==="tree"&&er(),wt(),e==="recent"&&t==="tree"&&window.requestAnimationFrame(()=>{try{qi()}catch{}})}function ji(e){if(!e||e==="inbox"||a.isPublicView)return;let t=Array.isArray(a.recentArticleIds)?a.recentArticleIds:[],n=[e,...t.filter(r=>r!==e)];a.recentArticleIds=n.slice(0,Ha),bh(),a.sidebarArticlesMode==="recent"&&wt()}var Qd,Zd,Ha,Fa=Fe(()=>{ft();Ji();Gr();Qd="ttree_sidebar_articles_mode",Zd="ttree_recent_articles",Ha=300});function tu(){_d(),Rd(),Hd(),eu(),m.sidebar&&Nr(!!a.isSidebarCollapsed)}var tn=Fe(()=>{vt();ft();Fa();Gr();$i();Oa();Ji();Gr();Fa();$i();Ji();Vd({renderSidebarArticleList:wt,renderMainArticleList:qt,setArticlesIndex:Ui})});function Wi(e){a.articleId&&(a.articleEncryptionKeys||(a.articleEncryptionKeys={}),e?a.articleEncryptionKeys[a.articleId]=e:delete a.articleEncryptionKeys[a.articleId])}async function ru(e){if(!e||!e.encrypted)return e;let t=a.articleEncryptionKeys?.[e.id]||null;if(t)return await Ea(e,t),e;let n=0;for(;;){n+=1;let r=null;try{let o=e.encryptionHint||"",i="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C \u0434\u043B\u044F \u044D\u0442\u043E\u0439 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B.",s=o?`${i}
\u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0430: ${o}`:i;r=await Gt({title:"\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430",message:s,confirmText:"\u041E\u0442\u043A\u0440\u044B\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"\u041F\u0430\u0440\u043E\u043B\u044C",inputType:"password"})}catch{r=window.prompt("\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430. \u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C:")||""}if(!r)throw new Error("\u041F\u0430\u0440\u043E\u043B\u044C \u043D\u0435 \u0432\u0432\u0435\u0434\u0451\u043D");try{let{key:o}=await Oi(r,e.encryptionSalt||"");if(!await Id(o,e.encryptionVerifier||"")){if(n>=3)throw new Error("\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C");window.alert("\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C, \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437.");continue}return await Ea(e,o),Wi(o),e}catch(o){if(n>=3)throw new Error(o.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");window.alert("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443, \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437.")}}}async function nu(e,t){if(!e||!Array.isArray(e.blocks))return;let n=[...e.blocks];for(let r of n){let o=Array.isArray(r.children)?r.children:[];n.push(...o);let i=r.text||"",s=await Ri(t,i);await De(`/api/articles/${e.id}/blocks/${r.id}`,{method:"PATCH",body:JSON.stringify({text:s})})}}async function Yi(){if(!a.article||!a.articleId){L("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}if(a.articleId==="inbox"){L("\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438 \u043D\u0435\u043B\u044C\u0437\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C");return}if(!a.currentUser){L("\u041D\u0443\u0436\u043D\u043E \u0432\u043E\u0439\u0442\u0438 \u0432 \u0441\u0438\u0441\u0442\u0435\u043C\u0443");return}let e=a.article;if(e.encrypted){let o=null;try{o=await Di({title:"\u0421\u043C\u0435\u043D\u0438\u0442\u044C \u043F\u0430\u0440\u043E\u043B\u044C",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043D\u043E\u0432\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C \u0438 \u043F\u0440\u0438 \u0436\u0435\u043B\u0430\u043D\u0438\u0438 \u043F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0443.",confirmText:"\u041F\u0435\u0440\u0435\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"})}catch{o=null}if(!o||!o.password)return;let{password:i,hint:s}=o;try{let{key:c,salt:d}=await Oi(i,""),l=await va(c);L("\u041F\u0435\u0440\u0435\u0448\u0438\u0444\u0440\u043E\u0432\u044B\u0432\u0430\u0435\u043C \u0441\u043E\u0434\u0435\u0440\u0436\u0438\u043C\u043E\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B..."),await nu(e,c);let u=await De(`/api/articles/${a.articleId}`,{method:"PATCH",body:JSON.stringify({encrypted:!0,encryptionSalt:d,encryptionVerifier:l,encryptionHint:s||null})});e.encrypted=!0,e.encryptionSalt=d,e.encryptionVerifier=l,e.encryptionHint=s||null,e.updatedAt=u?.updatedAt||e.updatedAt,Wi(c),Bn(u),gn(),L("\u041F\u0430\u0440\u043E\u043B\u044C \u043E\u0431\u043D\u043E\u0432\u043B\u0451\u043D"),Tt("toggleArticleEncryption: password changed",{id:e.id,encrypted:e.encrypted,hasSalt:!!e.encryptionSalt,hasVerifier:!!e.encryptionVerifier})}catch(c){L(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443")}return}let t=null;try{t=await Di({title:"\u0417\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C \u0438 \u043F\u0440\u0438 \u0436\u0435\u043B\u0430\u043D\u0438\u0438 \u043F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0443.",confirmText:"\u0417\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"})}catch{t=null}if(!t||!t.password)return;let{password:n,hint:r}=t;try{let{key:o,salt:i}=await Oi(n,""),s=await va(o);L("\u0428\u0438\u0444\u0440\u0443\u0435\u043C \u0441\u043E\u0434\u0435\u0440\u0436\u0438\u043C\u043E\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B..."),await nu(e,o);let c=await De(`/api/articles/${a.articleId}`,{method:"PATCH",body:JSON.stringify({encrypted:!0,encryptionSalt:i,encryptionVerifier:s,encryptionHint:r||null})});e.encrypted=!0,e.encryptionSalt=i,e.encryptionVerifier=s,e.encryptionHint=r||null,e.updatedAt=c?.updatedAt||e.updatedAt,Wi(o),Bn(c),gn(),L("\u0428\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0432\u043A\u043B\u044E\u0447\u0435\u043D\u043E"),Tt("toggleArticleEncryption: enabled",{id:e.id,encrypted:e.encrypted,hasSalt:!!e.encryptionSalt,hasVerifier:!!e.encryptionVerifier})}catch(o){L(o.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0438\u0435")}}async function Xi(){if(!a.article||!a.articleId){L("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}if(a.articleId==="inbox"){L("\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438 \u043D\u0435\u043B\u044C\u0437\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C/\u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C");return}let e=a.article;if(!e.encrypted){L("\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0443\u0436\u0435 \u043D\u0435 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430");return}let t=!1;try{t=await On({title:"\u0421\u043D\u044F\u0442\u044C \u0437\u0430\u0449\u0438\u0442\u0443?",message:"\u0421\u043E\u0434\u0435\u0440\u0436\u0438\u043C\u043E\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B \u0431\u0443\u0434\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u0432 \u043E\u0442\u043A\u0440\u044B\u0442\u043E\u043C \u0432\u0438\u0434\u0435.",confirmText:"\u0421\u043D\u044F\u0442\u044C \u0437\u0430\u0449\u0438\u0442\u0443",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"})}catch{t=window.confirm("\u0421\u043D\u044F\u0442\u044C \u0437\u0430\u0449\u0438\u0442\u0443 \u0438 \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0432 \u043E\u0442\u043A\u0440\u044B\u0442\u043E\u043C \u0432\u0438\u0434\u0435?")}if(t)try{if(L("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0432 \u043E\u0442\u043A\u0440\u044B\u0442\u043E\u043C \u0432\u0438\u0434\u0435..."),Array.isArray(e.blocks)){let r=[...e.blocks];for(let o of r){let i=Array.isArray(o.children)?o.children:[];r.push(...i);let s=o.text||"";await De(`/api/articles/${e.id}/blocks/${o.id}`,{method:"PATCH",body:JSON.stringify({text:s})})}}let n=await De(`/api/articles/${a.articleId}`,{method:"PATCH",body:JSON.stringify({encrypted:!1,encryptionSalt:null,encryptionVerifier:null})});e.encrypted=!1,e.encryptionSalt=null,e.encryptionVerifier=null,e.encryptionHint=null,e.updatedAt=n?.updatedAt||e.updatedAt,Wi(null),Bn(n),gn(),L("\u0428\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B \u043E\u0442\u043A\u043B\u044E\u0447\u0435\u043D\u043E"),Tt("removeArticleEncryption: disabled",{id:e.id,encrypted:e.encrypted})}catch(n){L(n.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0438\u0435")}}var za=Fe(()=>{ft();Pt();Et();Rn();bn();Do();tn();So()});function su(e=""){return e.split(/\r?\n/).some(t=>/^(\s*)-\s+/.test(t))}function iu(e=""){if(!e)return"";let t=[],n=0,r=e.replace(/\[\[block\s+id=([a-zA-Z0-9_-]+)\]\]([\s\S]*?)\[\[\/block\]\]/gi,(i,s,c)=>{let d=`__INLINE_BLOCK_${n}__`;return t.push({token:d,html:`<span class="inline-fragment" data-inline-block-id="${it(s.trim())}">${it((c||"").trim())}</span>`}),n+=1,d}),o=it(r);return t.forEach(({token:i,html:s})=>{let c=new RegExp(Mi(i),"g");o=o.replace(c,s)}),o}function Sh(e=""){if(!e||!e.trim())return"";let t=e.replace(/\r/g,""),n=t.split(/\n{2,}/).map(r=>r.trim()).filter(Boolean);return n.length?n.map(r=>`<div>${iu(r).replace(/\n/g,"<br />")}</div>`).join(""):`<div>${iu(t.trim()).replace(/\n/g,"<br />")}</div>`}function xh(e=[]){let t={title:"",content:"",comments:[],attributes:[]},n="content";e.forEach(o=>{let i=o.replace(/^\s+/,"");if(!i)return;let s=i.match(/^([A-Za-z--]+)\s*:(.*)$/);if(s){let c=s[1].toLowerCase();if(ou[c]){n=ou[c];let d=s[2]?.trim()||"";d&&(n==="comments"?t.comments.push(d.replace(/^[-*+]\s*/,"")):n==="attributes"?t.attributes.push(d):n==="title"?t.title=d:t.content=t.content?`${t.content}
${d}`:d);return}}n==="comments"?t.comments.push(i.replace(/^[-*+]\s*/,"")):n==="attributes"?t.attributes.push(i):n==="title"?t.title=t.title?`${t.title}
${i}`:i:t.content=t.content?`${t.content}
${i}`:i});let r={};return t.attributes.forEach(o=>{let i=o.match(/^\s*(?:[-*+]\s*)?([^:=]+):=$/);if(i){let s=i[1].trim(),c=i[2].trim();s&&(r[s]=c)}}),{title:t.title.trim(),content:t.content.trim(),comments:t.comments.filter(Boolean),attributes:r}}function au(e=""){let t=e.replace(/\t/g,"  ").split(/\r?\n/),n={level:-1,children:[]},r=[n];t.forEach(i=>{if(!i.trim())return;let s=i.match(/^(\s*)-\s+(.*)$/);if(s){let d=s[1].length,l=Math.floor(d/wh);for(;r.length&&r[r.length-1].level>=l;)r.pop();let u=r[r.length-1],f=u.block?u.block.children:u.children,p={title:s[2].trim(),detailLines:[],children:[]};f.push(p),r.push({level:l,block:p,children:p.children});return}let c=r[r.length-1];c?.block&&c.block.detailLines.push(i)});let o=i=>{let s=xh(i.detailLines||[]);return{title:s.title||i.title,content:s.content,comments:s.comments,attributes:s.attributes,children:(i.children||[]).map(c=>o(c))}};return n.children.map(i=>o(i))}function kh(e=[]){return e?.length?`<div class="block-section block-section--comments"><strong>\u041A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0438:</strong><ul>${e.map(n=>`<li>${it(n)}</li>`).join("")}</ul></div>`:""}function Ah(e={}){let t=Object.entries(e||{});return t.length?`<div class="block-section block-section--attributes"><strong>\u0410\u0442\u0440\u0438\u0431\u0443\u0442\u044B:</strong><ul>${t.map(([r,o])=>`<li><strong>${it(r)}:</strong> ${it(o)}</li>`).join("")}</ul></div>`:""}function Ua(e){if(!e)return null;let t=e.title?.trim()||"\u041D\u043E\u0432\u044B\u0439 \u0431\u043B\u043E\u043A",n=Sh(e.content),r=kh(e.comments),o=Ah(e.attributes),i=[n,r,o].filter(Boolean).join(""),s=i?`${t}<div><br /></div>${i}`:t;return{text:Va(s),collapsed:!1,children:(e.children||[]).map(c=>Ua(c)).filter(Boolean)}}var wh,ou,cu=Fe(()=>{bn();nn();wh=2,ou={\u043D\u0430\u0438\u043C\u0435\u043D\u043E\u0432\u0430\u043D\u0438\u0435:"title",\u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435:"title",\u0441\u043E\u0434\u0435\u0440\u0436\u0438\u043C\u043E\u0435:"content",\u0442\u0435\u043A\u0441\u0442:"content",\u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0438:"comments",\u0430\u0442\u0440\u0438\u0431\u0443\u0442\u044B:"attributes"}});function Ih(e){if(!e)return;e.focus({preventScroll:!0});let t=window.getSelection&&window.getSelection();if(!t)return;t.removeAllRanges();let n=document.createRange();n.selectNodeContents(e),n.collapse(!1),t.addRange(n)}function lu(e,t="\u0412\u0441\u0442\u0430\u0432\u043B\u044F\u0435\u043C Markdown..."){a.isMarkdownInserting=e;let n=m.pasteProgress;if(!n)return;let r=n.querySelector(".inline-progress__text");r&&t&&(r.textContent=t),n.classList.toggle("hidden",!e)}async function qa(e){return!a.article||!a.article.encrypted||!a.articleEncryptionKey?e:Ri(a.articleEncryptionKey,e)}async function vh(e){if(!a.article||!a.article.encrypted||!a.articleEncryptionKey||!e)return e;let t=JSON.parse(JSON.stringify(e));return await Po(t,a.articleEncryptionKey),t}async function Gi(){if(!a.currentBlockId||a.isRagView)return;let e=a.currentBlockId;a.editingScrollTop=m.blocksContainer?m.blocksContainer.scrollTop:null,a.mode="edit",a.scrollTargetBlockId=null,a.editingBlockId=a.currentBlockId,a.editingInitialText=Ke(a.currentBlockId)?.block.text||"",a.editingUndo=null,await yt(e);let t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`);if(t||(nt(),await yt(e),t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`)),!t){a.mode="view",a.editingBlockId=null,a.editingInitialText="",a.editingUndo=null,a.currentBlockId=e,L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430");return}Ih(t)}async function zo(){if(a.mode!=="edit"||!a.editingBlockId)return;let e=a.editingBlockId,t=Ke(e),n=t?.block.text||"",o=document.querySelector(`.block[data-block-id="${a.editingBlockId}"] .block-text`)?.innerHTML||"",{cleanupEditableHtml:i}=await Promise.resolve().then(()=>(nn(),Ka)),s=i(o);if(!(s||"").trim()){let d=Uo(e),l=Ke(e),u=!!(l?.block&&l.block.__isNew);if(l&&a.article&&Array.isArray(a.article.blocks)){let f=l.siblings||a.article.blocks,p=l.index??f.findIndex(y=>y&&y.id===e);if(p>=0&&f.splice(p,1),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}if(!u){let y=rr(l.block);Vo(y,l.parent?.id||null,l.index??null)}}a.mode="view",a.editingBlockId=null,a.editingInitialText="",a.currentBlockId=d,a.scrollTargetBlockId=d,to(e),nt(),(async()=>{try{let f=u?`/api/articles/${a.articleId}/blocks/${e}/permanent`:`/api/articles/${a.articleId}/blocks/${e}`,p=await De(f,{method:"DELETE"});if(!u&&p?.block){let y=rr(p.block);rn({type:"structure",action:{kind:"delete",parentId:p.parentId||null,index:p.index??null,block:y,blockId:y?.id,fallbackId:d}})}L("\u041F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A \u0443\u0434\u0430\u043B\u0451\u043D")}catch(f){L(f.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Ht(a.articleId,{desiredBlockId:d||null}),nt()}catch{}}})();return}if(s===n){a.mode="view",a.editingBlockId=null,a.editingInitialText="",a.editingUndo=null,a.pendingEditBlockId=null,a.currentBlockId=e,a.scrollTargetBlockId=e,await yt(e);return}if(t&&a.article&&Array.isArray(a.article.blocks)&&(t.block.text=s,a.article.updatedAt))try{a.article.updatedAt=new Date().toISOString()}catch{}a.mode="view",a.editingBlockId=null,a.editingInitialText="",a.editingUndo=null,a.pendingEditBlockId=null,a.currentBlockId=e,a.scrollTargetBlockId=e,await yt(e),(async()=>{try{let d=await qa(s),l=await De(`/api/articles/${a.articleId}/blocks/${e}`,{method:"PATCH",body:JSON.stringify({text:d})});n!==s&&(!!(t?.block&&t.block.__isNew)?delete t.block.__isNew:rn({type:"text",blockId:e,historyEntryId:l?.historyEntryId||null})),L("\u0411\u043B\u043E\u043A \u043E\u0431\u043D\u043E\u0432\u043B\u0451\u043D")}catch(d){L(d.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Ht(a.articleId,{desiredBlockId:e}),nt()}catch{}}})()}async function Qi(){if(a.mode!=="edit"||!a.editingBlockId)return;let e=a.editingBlockId,r=!(document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`)?.textContent||"").replace(/\u00a0/g," ").trim();if(a.mode="view",a.editingBlockId=null,a.editingInitialText="",a.editingUndo=null,r){let o=Uo(e),i=Ke(e),s=!!(i?.block&&i.block.__isNew);if(i&&a.article&&Array.isArray(a.article.blocks)){let d=i.siblings||a.article.blocks,l=i.index??d.findIndex(u=>u&&u.id===e);if(l>=0&&d.splice(l,1),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}a.currentBlockId=o,a.scrollTargetBlockId=o,to(e);let c=i?.parent?.id||null;c?await yt(c):nt(),(async()=>{try{let d=s?`/api/articles/${a.articleId}/blocks/${e}/permanent`:`/api/articles/${a.articleId}/blocks/${e}`,l=await De(d,{method:"DELETE"});if(!s&&l?.block){let u=rr(l.block);rn({type:"structure",action:{kind:"delete",parentId:l.parentId||null,index:l.index??null,block:u,blockId:u?.id,fallbackId:o}})}}catch(d){L(d.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Ht(a.articleId,{desiredBlockId:o||null}),nt()}catch{}}})();return}a.currentBlockId=e,await yt(e)}async function Zr(){if(a.mode!=="edit"||!a.editingBlockId)return;let e=a.editingBlockId,t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`);if(!t)return;let n=window.getSelection();if(!n||n.rangeCount===0||!t.contains(n.anchorNode))return;let r=n.getRangeAt(0).cloneRange(),o=document.createElement("span"),i=`split-marker-${Date.now()}-${Math.random().toString(16).slice(2)}`;o.setAttribute("data-split-marker",i),o.textContent="",r.insertNode(o);let s=t.innerHTML;o.parentNode.removeChild(o);let c=`<span data-split-marker="${i}"></span>`,d=s.split(c);if(d.length!==2)return;let[l,u]=d,{cleanupEditableHtml:f}=await Promise.resolve().then(()=>(nn(),Ka)),p=f(l||""),y=f(u||"");if(!(!y||y===p))try{let b=Ke(e),h=b?.block,g=h?rr(h):null,w=await qa(p);await De(`/api/articles/${a.articleId}/blocks/${e}`,{method:"PATCH",body:JSON.stringify({text:w})});let x=(await De(`/api/articles/${a.articleId}/blocks/${e}/siblings`,{method:"POST",body:JSON.stringify({direction:"after"})}))?.block?.id;if(!x){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043D\u043E\u0432\u044B\u0439 \u0431\u043B\u043E\u043A");return}let T=await qa(y);if(await De(`/api/articles/${a.articleId}/blocks/${x}`,{method:"PATCH",body:JSON.stringify({text:T})}),b&&a.article&&Array.isArray(a.article.blocks)){b.block.text=p;let B=b.parent,$=b.siblings||a.article.blocks||[],U=(b.index??0)+1,Y={id:x,text:y,children:[],collapsed:!1};if($.splice(U,0,Y),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}a.mode="edit",a.editingBlockId=x,a.pendingEditBlockId=null,a.currentBlockId=x,a.scrollTargetBlockId=x,a.editingCaretPosition="start";let N=b?.parent?.id||null;N?await yt(N):nt(),g&&rn({type:"text",blockId:e,block:g})}catch(b){L(b.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0437\u0431\u0438\u0442\u044C \u0431\u043B\u043E\u043A")}}async function gr(e){if(!a.currentBlockId)return;if(!a.article||!Array.isArray(a.article.blocks)){L("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}let t=a.currentBlockId;try{let n=Ke(t);if(!n){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u0442\u0435\u043A\u0443\u0449\u0438\u0439 \u0431\u043B\u043E\u043A");return}let r=n.parent?.id||null,o=n.siblings||a.article.blocks;Array.isArray(o)||(o=a.article.blocks);let i=typeof n.index=="number"?n.index:o.findIndex(l=>l&&l.id===t);i<0&&(i=o.length);let s=e==="before"?i:i+1,c=window.crypto&&window.crypto.randomUUID?window.crypto.randomUUID():`block-${Date.now().toString(16)}-${Math.random().toString(16).slice(2)}`,d={id:c,text:"",children:[],collapsed:!1,__isNew:!0};if(o.splice(s,0,d),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}a.mode="edit",a.editingBlockId=c,a.editingInitialText="",a.pendingEditBlockId=null,a.currentBlockId=c,r?await yt(r):nt(),(async()=>{try{let l={id:c,text:"",children:[],collapsed:!1},u=await De(`/api/articles/${a.articleId}/blocks/${t}/siblings`,{method:"POST",body:JSON.stringify({direction:e,payload:l})}),f=u?.block;if(!f||!f.id)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043D\u043E\u0432\u044B\u0439 \u0431\u043B\u043E\u043A");let p=rr(f);rn({type:"structure",action:{kind:"create",parentId:u.parentId||r||null,index:typeof u.index=="number"?u.index:null,blockId:f.id,block:p,fallbackId:t}})}catch(l){L(l.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043D\u043E\u0432\u044B\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Ht(a.articleId,{desiredBlockId:t}),nt()}catch{}}})()}catch(n){L(n.message)}}async function Zi(){if(!a.currentBlockId)return;if(es(a.article?.blocks||[])<=1){L("\u041D\u0435\u043B\u044C\u0437\u044F \u0443\u0434\u0430\u043B\u044F\u0442\u044C \u043F\u043E\u0441\u043B\u0435\u0434\u043D\u0438\u0439 \u0431\u043B\u043E\u043A");return}if(a.isDeletingBlock)return;a.isDeletingBlock=!0;let e=Uo(a.currentBlockId);try{let t=a.currentBlockId,n=Ke(t),r=n?.block?rr(n.block):null,o=await De(`/api/articles/${a.articleId}/blocks/${a.currentBlockId}`,{method:"DELETE"});if(n&&a.article&&Array.isArray(a.article.blocks)){let s=n.siblings||a.article.blocks,c=n.index??s.findIndex(d=>d.id===t);if(c>=0&&s.splice(c,1),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}r&&r.id&&Vo(r,n.parent?.id||null,n.index??c)}to(t),a.currentBlockId=e,a.scrollTargetBlockId=e;let i=n?.parent?.id||null;i?await yt(i):nt(),r&&r.id&&rn({type:"structure",action:{kind:"delete",parentId:n?.parent?.id||null,index:n?.index??null,block:r,blockId:r.id,fallbackId:e}})}catch(t){L(t.message)}finally{a.isDeletingBlock=!1}}async function Eh(e=[]){if(!e.length){L("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u043B\u044F\u0442\u044C \u043F\u0443\u0441\u0442\u044B\u0435 \u0431\u043B\u043E\u043A\u0438 \u0438\u0437 Markdown");return}if(!a.articleId){L("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u043B\u044F\u0442\u044C \u0431\u043B\u043E\u043A\u0438 \u0431\u0435\u0437 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0439 \u0441\u0442\u0430\u0442\u044C\u0438");return}if(!a.currentBlockId){L("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u043B\u044F\u0442\u044C \u0431\u043B\u043E\u043A\u0438 \u0431\u0435\u0437 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u0431\u043B\u043E\u043A\u0430");return}if(a.isMarkdownInserting){L("\u0418\u0434\u0451\u0442 \u0432\u0441\u0442\u0430\u0432\u043A\u0430 Markdown, \u043F\u043E\u0436\u0430\u043B\u0443\u0439\u0441\u0442\u0430, \u043F\u043E\u0434\u043E\u0436\u0434\u0438\u0442\u0435...");return}lu(!0);try{let t=a.currentBlockId,n=null,r=null;for(let o of e){let i=Ua(o);if(!i)continue;let s=await vh(i),c=await De(`/api/articles/${a.articleId}/blocks/${t}/siblings`,{method:"POST",body:JSON.stringify({direction:"after",payload:s})}),d=c?.block;if(d&&d.id&&(t=d.id,n=d.id,r=c.parentId||null,a.article&&Array.isArray(a.article.blocks))){let l=null;if(r){let b=Ke(r)?.block||null;b&&(Array.isArray(b.children)||(b.children=[]),l=b.children)}else l=a.article.blocks;Array.isArray(l)||(l=a.article.blocks);let u=typeof c.index=="number"?c.index:null,f=u!==null&&u>=0&&u<=l.length?u:l.length,p=rr(d)||d;if(l.splice(f,0,p),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}}if(!n){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u043D\u0438 \u043E\u0434\u043D\u043E\u0433\u043E \u0431\u043B\u043E\u043A\u0430");return}a.currentBlockId=n,a.scrollTargetBlockId=n,r?await yt(r):nt(),L("\u0411\u043B\u043E\u043A\u0438 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u044B \u0438\u0437 Markdown")}finally{lu(!1)}}function du(e){if(a.mode!=="view")return;let t=e.target;if(gd(t))return;let n=e.clipboardData?.getData("text/plain");if(!n||!su(n))return;e.preventDefault();let r=au(n);Eh(r).catch(o=>{L(o.message)})}var eo=Fe(()=>{ft();Pt();vt();Et();jn();jn();$n();nn();cu();bn();Do()});function fn(e=[],t=[]){return(e||[]).forEach(n=>{t.push(n),n.children&&n.children.length>0&&!n.collapsed&&fn(n.children,t)}),t}function Ke(e,t=a.article?.blocks||[],n=null,r=[]){for(let o=0;o<t.length;o+=1){let i=t[o];if(i.id===e)return{block:i,parent:n,index:o,siblings:t,ancestors:r};let s=Ke(e,i.children||[],i,[...r,i]);if(s)return s}return null}function qo({scrollIntoView:e=!1,scrollBehavior:t="smooth"}={}){let n=new Set(Array.isArray(a.selectedBlockIds)?a.selectedBlockIds:[]);if(a.currentBlockId&&n.add(a.currentBlockId),document.querySelectorAll(".block[data-block-id]").forEach(o=>{let i=o.getAttribute("data-block-id"),s=i&&n.has(i);o.classList.toggle("selected",!!s),o.classList.remove("block--selected-root-ancestor");let c=o.querySelector(":scope > .block-surface");c&&c.classList.remove("block--selected-root-ancestor")}),a.currentBlockId&&a.article&&Array.isArray(a.article.blocks)){let o=Ke(a.currentBlockId),i=o?.ancestors||[],s=i.length>0?i[0]?.id:o?.block?.id;if(s){let c=document.querySelector(`.block[data-block-id="${s}"]`);if(c){let d=c.querySelector(":scope > .block-surface");d&&d.classList.add("block--selected-root-ancestor")}}}if(e&&a.mode==="view"&&a.currentBlockId){let o=document.querySelector(`.block[data-block-id="${a.currentBlockId}"]`);o&&o.scrollIntoView({behavior:t||"smooth",block:"nearest"})}}function uu(e,t={}){if(!e||a.currentBlockId===e)return;let{preserveSelection:n=!1,scrollIntoView:r,scrollBehavior:o}=t;a.currentBlockId=e,n||(a.selectionAnchorBlockId=null,a.selectedBlockIds=[]);let i=typeof r=="boolean"?r:a.mode==="view";qo({scrollIntoView:i,scrollBehavior:o||"smooth"})}function Sn(e,t={}){uu(e,{preserveSelection:!1,...t})}function Ko(e){if(!a.article)return;let t=fn(a.article.blocks),n=t.findIndex(o=>o.id===a.currentBlockId);if(n===-1)return;let r=t[n+e];r&&(a.mode==="view"&&(a.scrollTargetBlockId=r.id),uu(r.id,{preserveSelection:!1}))}function Jo(e){if(!a.article)return;let t=fn(a.article.blocks);if(!t.length)return;let n=a.selectionAnchorBlockId||a.currentBlockId||t[0].id;n||(n=t[0].id),a.selectionAnchorBlockId||(a.selectionAnchorBlockId=n);let r=t.findIndex(u=>u.id===n);if(r===-1)return;let o=a.currentBlockId||n,i=t.findIndex(u=>u.id===o);i===-1&&(i=r);let s=i+e;if(s<0||s>=t.length)return;let[c,d]=s>=r?[r,s]:[s,r],l=t.slice(c,d+1).map(u=>u.id);a.selectedBlockIds=l,a.currentBlockId=t[s].id,a.mode==="view"&&(a.scrollTargetBlockId=a.currentBlockId),qo({scrollIntoView:a.mode==="view"})}var fu=Fe(()=>{ft();vt()});function yr(e){return e?e.nodeType===Node.TEXT_NODE?/\n\s*\n/.test(e.textContent||""):e.nodeType===Node.ELEMENT_NODE&&(e.tagName==="BR"||(e.tagName==="P"||e.tagName==="DIV")&&(!(e.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&(nbsp|#160);/gi,"").trim()||!(e.textContent||"").replace(/\u00a0/g,"").trim()&&!e.querySelector("img"))):!1}function ts(e=[]){let t=document.createElement("div");return e.forEach(n=>t.appendChild(n)),t.innerHTML.trim()}function Ja(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=[],r=(i="")=>{let s=document.createElement("p");i?s.innerHTML=i:s.appendChild(document.createElement("br")),n.push(s)};Array.from(t.content.childNodes).forEach(i=>{if(i.nodeType===Node.TEXT_NODE){let s=(i.textContent||"").trim();s&&r(s);return}if(i.nodeType===Node.ELEMENT_NODE){if(i.tagName==="P"){n.push(i.cloneNode(!0));return}if(i.tagName==="BR"){r("");return}if(i.tagName==="DIV"){r(i.innerHTML);return}r(i.outerHTML)}}),n.length||r("");let o=document.createElement("div");return n.forEach(i=>o.appendChild(i)),o.innerHTML}function xn(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll(".block-header").forEach(f=>{let p=f.parentNode;if(p){for(;f.firstChild;)p.insertBefore(f.firstChild,f);p.removeChild(f)}});let n=Array.from(t.content.childNodes),r=f=>f?.nodeType===Node.TEXT_NODE&&!(f.textContent||"").trim(),o=0;for(;o<n.length&&r(n[o]);)o+=1;let i=n[o];if(!i||i.nodeType!==Node.ELEMENT_NODE||i.tagName!=="P"||yr(i))return{titleHtml:"",bodyHtml:ts(n)};let s=o+1;for(;s<n.length&&r(n[s]);)s+=1;let c=n[s];if(!(!!c&&yr(c)&&(c.nodeType===Node.ELEMENT_NODE?c.tagName==="P"||c.tagName==="DIV"||c.tagName==="BR":!1)))return{titleHtml:"",bodyHtml:ts(n)};let l=[i.cloneNode(!0)],u=[];for(let f=s+1;f<n.length;f+=1)u.push(n[f].cloneNode(!0));return{titleHtml:ts(l),bodyHtml:ts(u)}}function pu({event:e,element:t,range:n,selection:r,notifyEditingInput:o,logDebug:i}){if(!e||!t||!n||!r||!n.collapsed)return!1;let s=e.key==="Backspace"||e.code==="Backspace"||e.keyCode===8,c=e.key==="Delete"||e.key==="Del"||e.code==="Delete"||e.code==="Del"||e.keyCode===46;if(!s&&!c)return!1;let d=g=>{try{r.removeAllRanges(),r.addRange(g)}catch{}try{t.focus({preventScroll:!0})}catch{t.focus()}},l=g=>{let S=(n.commonAncestorContainer?.nodeType===Node.ELEMENT_NODE?n.commonAncestorContainer:n.commonAncestorContainer?.parentElement)?.closest?.("p");if(S)return S;let x=t,T=Array.from(x.childNodes),N=n.startContainer;for(;N&&N.parentNode!==x;)N=N.parentNode;let B=N?T.indexOf(N):-1,$=U=>{let Y=U==="prev"?-1:1,J=B;for(J===-1?J=U==="prev"?T.length-1:0:J=U==="prev"?J-1:J;J>=0&&J<T.length;){let re=T[J];if(re?.nodeType===Node.ELEMENT_NODE&&re.tagName==="P")return re;J+=Y}return null};return g==="Delete"?$("next")||$("prev"):g==="Backspace"?$("prev")||$("next"):null},u=()=>{if(n.startContainer!==t)return{prev:null,next:null};let g=Array.from(t.childNodes),w=n.startOffset,S=null,x=null;for(let T=w-1;T>=0;T-=1){let N=g[T];if(N?.nodeType===Node.ELEMENT_NODE&&N.tagName==="P"){S=N;break}}for(let T=w;T<g.length;T+=1){let N=g[T];if(N?.nodeType===Node.ELEMENT_NODE&&N.tagName==="P"){x=N;break}}return{prev:S,next:x}},f=g=>{let w=g?.previousElementSibling;for(;w&&w.tagName!=="P";)w=w.previousElementSibling;return w&&w.tagName==="P"?w:null},p=g=>{let w=g?.nextElementSibling;for(;w&&w.tagName!=="P";)w=w.nextElementSibling;return w&&w.tagName==="P"?w:null},y=g=>{if(!g)return!0;let w=new Set(["span","b","strong","i","em","u","s","mark","code"]),S=new Set(["img","video","audio","iframe"]),x=T=>{if(!T)return!1;if(T.nodeType===Node.TEXT_NODE)return(T.textContent||"").replace(/\u00a0/g,"").replace(/[\u200B-\u200D\uFEFF]/g,"").trim().length>0;if(T.nodeType!==Node.ELEMENT_NODE)return!1;let N=(T.tagName||"").toLowerCase();return N==="br"?!1:S.has(N)?!0:N==="span"&&(T.getAttribute("class")||"").includes("resizable-image__handle")?!1:w.has(N)?Array.from(T.childNodes||[]).some(x):!0};return!Array.from(g.childNodes||[]).some(x)},b=g=>{if(!g)return!1;let w=document.createRange();w.selectNodeContents(g);try{w.setEnd(n.startContainer,n.startOffset)}catch{return!1}if(y(w.cloneContents()))return!0;try{let S=document.createRange();return S.selectNodeContents(g),S.collapse(!0),n.compareBoundaryPoints(Range.START_TO_START,S)===0}catch{return!1}},h=g=>{if(!g)return!1;let w=document.createRange();w.selectNodeContents(g);try{w.setStart(n.startContainer,n.startOffset)}catch{return!1}if(y(w.cloneContents()))return!0;try{let S=document.createRange();return S.selectNodeContents(g),S.collapse(!1),n.compareBoundaryPoints(Range.END_TO_END,S)===0}catch{return!1}};if(window.__debugMergeP&&i("mergeP.keydown",{key:e.key,code:e.code,keyCode:e.keyCode,startContainer:n.startContainer?.nodeName,startOffset:n.startOffset,collapsed:n.collapsed}),s){if(n.startContainer===t){let x=u();if(x.prev&&x.next){e.preventDefault(),e.stopPropagation();let T=document.createRange();for(T.selectNodeContents(x.prev),T.collapse(!1);x.next.firstChild;)x.prev.appendChild(x.next.firstChild);return x.next.remove(),d(T),o(t),!0}return!1}let g=l("Backspace");if(!g||!t.contains(g)||!b(g))return!1;let w=f(g);if(!w||!t.contains(w))return!1;e.preventDefault(),e.stopPropagation();let S=document.createRange();for(S.selectNodeContents(w),S.collapse(!1);g.firstChild;)w.appendChild(g.firstChild);return g.remove(),d(S),o(t),!0}if(c){let g=l("Delete");if(!g||!t.contains(g)){let x=u();if(x.prev&&x.next){e.preventDefault(),e.stopPropagation();let T=document.createRange();for(T.selectNodeContents(x.prev),T.collapse(!1);x.next.firstChild;)x.prev.appendChild(x.next.firstChild);return x.next.remove(),d(T),o(t),!0}return!1}if(!h(g))return!1;let w=p(g);if(!w||!t.contains(w))return!1;e.preventDefault(),e.stopPropagation();let S=document.createRange();for(S.selectNodeContents(g),S.collapse(!1);w.firstChild;)g.appendChild(w.firstChild);return w.remove(),d(S),o(t),!0}return!1}var ja=Fe(()=>{});function jo(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=r=>{if(r&&!(r.nodeType===Node.ELEMENT_NODE&&r.tagName==="A")){if(r.nodeType===Node.TEXT_NODE){let o=r.textContent||"";if(ns.lastIndex=0,!ns.test(o))return;let s=document.createDocumentFragment(),c=0;ns.lastIndex=0;let d;for(;(d=ns.exec(o))!==null;){let[l]=d;d.index>c&&s.appendChild(document.createTextNode(o.slice(c,d.index)));let u=l.startsWith("http")?l:`https://${l}`,f=document.createElement("a");f.href=u,f.target="_blank",f.rel="noopener noreferrer",f.textContent=l,s.appendChild(f),c=d.index+l.length}c<o.length&&s.appendChild(document.createTextNode(o.slice(c))),r.parentNode&&r.parentNode.replaceChild(s,r);return}Array.from(r.childNodes||[]).forEach(n)}};return Array.from(t.content.childNodes).forEach(n),t.innerHTML}function mu(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll("script, style").forEach(o=>o.remove());let n=(o="")=>/^javascript:/i.test(o.trim()),r=o=>{if(!o||o.nodeType!==Node.ELEMENT_NODE){Array.from(o?.childNodes||[]).forEach(r);return}Array.from(o.attributes||[]).forEach(i=>{let s=i.name.toLowerCase(),c=i.value||"";if(s.startsWith("on")||s==="style"){o.removeAttribute(i.name);return}(s==="href"||s==="src")&&n(c)&&o.removeAttribute(i.name)}),Array.from(o.childNodes||[]).forEach(r)};return Array.from(t.content.childNodes||[]).forEach(r),t.innerHTML}function Wa(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=r=>{if(!r)return!0;if(r.nodeType===Node.TEXT_NODE)return!(r.textContent||"").replace(/\u00a0/g,"").trim();if(r.nodeType!==Node.ELEMENT_NODE)return!1;if(r.tagName==="BR")return!0;let o=(r.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&nbsp;/gi,"").trim(),i=(r.textContent||"").replace(/\u00a0/g,"").trim(),s=!!r.querySelector("img,video,audio,iframe");return!o&&!i&&!s};for(;t.content.firstChild&&n(t.content.firstChild);)t.content.removeChild(t.content.firstChild);for(;t.content.lastChild&&n(t.content.lastChild);)t.content.removeChild(t.content.lastChild);return t.innerHTML}function hu(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=(t.content.textContent||"").replace(/\u00a0/g," ").trim(),r=!!t.content.querySelector("a"),o=!1;{let b=Array.from(t.content.childNodes||[]);for(let h=0;h<b.length;h+=1){let g=b[h];if(g.nodeType===Node.TEXT_NODE){if(!(g.textContent||"").trim())continue;break}yr(g)&&(o=!0);break}}let i=document.createElement("template");i.innerHTML=e||"";let c=(()=>{if(!Array.from(i.content.childNodes||[]).length)return!1;let h=Array.from(i.content.querySelectorAll("p"));if(h.length<2)return!1;let g=G=>{let ie=G.trim();return ie.startsWith("|")&&ie.indexOf("|",1)!==-1},S=h.map(G=>(G.textContent||"").replace(/\u00a0/g," ").trim()).filter(G=>G);if(S.length<2||!S.every(g))return!1;let x=S.map(G=>{let ie=G.trim();return(ie.endsWith("|")?ie.slice(1,-1):ie.slice(1)).split("|").map(dt=>dt.trim())}),T=x[0],N=x.slice(1),B=N.reduce((G,ie)=>Math.max(G,ie.length),T.length),$=document.createElement("table");$.className="memus-table";let U=document.createElement("colgroup"),Y=100/Math.max(B,1);for(let G=0;G<B;G+=1){let ie=document.createElement("col");ie.setAttribute("width",`${Y.toFixed(4)}%`),U.appendChild(ie)}$.appendChild(U);let J=document.createElement("thead"),re=document.createElement("tr");for(let G=0;G<B;G+=1){let ie=document.createElement("th");ie.textContent=T[G]||"",re.appendChild(ie)}J.appendChild(re),$.appendChild(J);let he=document.createElement("tbody");return N.forEach(G=>{let ie=document.createElement("tr"),$e=[...G];for(let dt=0;dt<B;dt+=1){let ut=document.createElement("td");ut.textContent=$e[dt]||"",ie.appendChild(ut)}he.appendChild(ie)}),$.appendChild(he),i.content.innerHTML="",i.content.appendChild($),jo(i.innerHTML).replace(/<\/a>\s*<a/gi,"</a> <a")})();if(c)return c;i.content.querySelectorAll(".table-toolbar, .table-toolbar-btn").forEach(b=>{b.remove()}),i.content.querySelectorAll(".block-header").forEach(b=>{let h=b.parentNode;if(h){for(;b.firstChild;)h.insertBefore(b.firstChild,b);h.removeChild(b)}});let d=b=>{Array.from(b.childNodes).forEach(h=>{if(h.nodeType===Node.ELEMENT_NODE){if(h.tagName==="DIV"){let g=document.createElement("p");g.innerHTML=h.innerHTML,h.parentNode.replaceChild(g,h),d(g);return}d(h)}})};d(i.content),(b=>{Array.from(b.childNodes||[]).forEach(g=>{if(g.nodeType===Node.TEXT_NODE){let S=(g.textContent||"").replace(/\u00a0/g," ");if(!S.trim()){if(g.previousSibling&&g.nextSibling){g.textContent=" ";return}b.removeChild(g);return}let T=document.createElement("p");T.textContent=S,b.replaceChild(T,g)}})})(i.content),i.content.querySelectorAll("p").forEach(b=>{(b.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim()||(b.innerHTML="",b.appendChild(document.createElement("br")))});let u=i.content;if(!!u.querySelector("p")){if(o){let b=Array.from(u.childNodes||[]),h=null;for(let g=0;g<b.length;g+=1){let w=b[g];if(!(w.nodeType===Node.TEXT_NODE&&!(w.textContent||"").trim())){h=w;break}}if(h){if(!(h.tagName==="P"&&yr(h))){let g=document.createElement("p");g.appendChild(document.createElement("br")),u.insertBefore(g,h)}}else{let g=document.createElement("p");g.appendChild(document.createElement("br")),u.appendChild(g)}}}else{let b=document.createElement("p");b.appendChild(document.createElement("br")),u.appendChild(b)}let y=jo(i.innerHTML).replace(/<\/a>\s*<a/gi,"</a> <a");return!y.trim()&&(n||r)?e||"":y}var ns,gu=Fe(()=>{ja();ns=/((?:https?:\/\/|www\.)[^\s<>"']+)/gi});function or(e){if(!e)return;if(!(e.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&nbsp;/gi,"").trim()){e.innerHTML="";let n=document.createRange();n.selectNodeContents(e),n.collapse(!0);let r=window.getSelection();r&&(r.removeAllRanges(),r.addRange(n))}}var Ya=Fe(()=>{});function Pr(e){if(!e)return!1;if(e.type&&e.type.startsWith("image/"))return!0;let t=(e.name||"").toLowerCase();return t?/\.(png|jpe?g|gif|webp|bmp|svg|heic|heif)$/i.test(t):!1}function Xa(e=[],t=[]){let n=[];return Array.from(e||[]).forEach(r=>{if(r.kind==="file"){let o=typeof r.getAsFile=="function"?r.getAsFile():null;o&&Pr(o)&&n.push(o)}}),!n.length&&t?.length&&Array.from(t).forEach(r=>{Pr(r)&&n.push(r)}),n}function Ga(e=[],t=[]){let n=[];return Array.from(e||[]).forEach(r=>{if(r.kind==="file"){let o=typeof r.getAsFile=="function"?r.getAsFile():null;o&&!Pr(o)&&n.push(o)}}),!n.length&&t?.length&&Array.from(t).forEach(r=>{Pr(r)||n.push(r)}),n}async function rs(e,t,n){let r=`img-${Date.now()}-${Math.random().toString(16).slice(2)}`,o=t&&t.name?t.name:"image",i=it(o).replace(/"/g,"&quot;");try{or(e),Tn(e,`<span data-pending-image="true" data-image-token="${r}">${i} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F...)</span>`)}catch{}try{let{url:s}=await Co(t),d=`
      <span class="resizable-image" style="width:320px;max-width:100%;">
        <span class="resizable-image__inner">${`<img src="${s}" alt="${i}" draggable="false" />`}</span>
        <span class="resizable-image__handle" data-direction="e" aria-hidden="true"></span>
      </span>
    `,l=e,u=l&&l.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`);if(n&&(!u||!l.isConnected)){let f=document.querySelector(`.block[data-block-id="${n}"]`);if(f){let y=f.querySelector('.block-text[contenteditable="true"]')||f.querySelector(".block-text.block-body");y&&(l=y,u=l.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`))}}u?(u.removeAttribute("data-pending-image"),u.removeAttribute("data-image-token"),u.outerHTML=d):l&&(or(l),Tn(l,d))}catch(s){try{let d=e;if(n&&!d.isConnected){let l=document.querySelector(`.block[data-block-id="${n}"]`);if(l){let f=l.querySelector('.block-text[contenteditable="true"]')||l.querySelector(".block-text.block-body");f&&(d=f)}}if(d){let l=d.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`);l&&(l.textContent=`${o} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F)`,l.removeAttribute("data-pending-image"))}}catch{}try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"insertImageFromFileError",data:{message:s&&s.message?String(s.message):String(s),name:t&&t.name,type:t&&t.type,size:t&&t.size}})}).catch(()=>{})}catch{}try{let d={where:"insertImageFromFile",message:s&&s.message?String(s.message):String(s),status:typeof s?.status=="number"?s.status:null,name:t&&t.name,type:t&&t.type,size:t&&t.size},l=d.status===null?"null":String(d.status);window.alert(`upload failed (status ${l}):\\n${JSON.stringify(d,null,2)}`)}catch{}let c=String(s?.message||"").toLowerCase();c.includes("status 0")||c.includes("network error")?L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 (\u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C). \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438, \u043F\u0440\u0438 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u043E\u0441\u0442\u0438, \u0432\u043E\u0439\u0434\u0438\u0442\u0435 \u0437\u0430\u043D\u043E\u0432\u043E."):L(s.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435")}}function Th(e){if(e.button!==0)return;let t=e.target?.closest(".resizable-image__handle");if(!t)return;let n=t.closest(".resizable-image"),o=n?.closest(".block")?.dataset?.blockId;if(!n||!o||a.mode!=="edit"||a.editingBlockId!==o)return;e.preventDefault(),e.stopPropagation();let i=n.getBoundingClientRect();br={wrapper:n,startWidth:i.width,startX:e.clientX},n.classList.add("resizable-image--resizing")}function Ch(e){if(!br)return;e.preventDefault();let t=e.clientX-br.startX,r=parseFloat(getComputedStyle(document.documentElement).fontSize)||16,o=Math.max(r,document.documentElement.clientWidth-32),i=br.startWidth+t;i=Math.max(r,Math.min(i,o)),br.wrapper.style.width=`${i}px`}function bu(){br&&(br.wrapper.classList.remove("resizable-image--resizing"),br=null)}function wu(){yu||(yu=!0,document.addEventListener("pointerdown",Th),document.addEventListener("pointermove",Ch),document.addEventListener("pointerup",bu),document.addEventListener("pointercancel",bu))}var br,yu,Su=Fe(()=>{ft();Pt();Et();bn();Ya();br=null,yu=!1});function xu({listTag:e,resolveTarget:t,restoreSelection:n,richContextRange:r,notifyEditingInput:o,setRichContextRange:i}){let s=t();if(!s||!document.contains(s))return;n();let c=window.getSelection(),d=null;if(r&&s.contains(r.commonAncestorContainer))d=r.cloneRange();else if(c&&c.rangeCount>0){let S=c.getRangeAt(0);s.contains(S.commonAncestorContainer)&&(d=S.cloneRange())}d||(d=document.createRange(),d.selectNodeContents(s),d.collapse(!1));let l=d.startContainer?.nodeType===Node.ELEMENT_NODE?d.startContainer:d.startContainer?.parentElement,u=l?.closest?.("li"),f=u?.closest?.("ol,ul"),p=S=>{if(!S)return;let x=document.createRange();x.selectNodeContents(S),x.collapse(!1),c&&(c.removeAllRanges(),c.addRange(x)),i(x);try{s.focus({preventScroll:!0})}catch{s.focus()}s.classList.remove("block-body--empty"),o(s)},y=S=>{let x=S.parentElement?.tagName==="P"&&S.parentElement.childNodes.length===1?S.parentElement:S,T=Array.from(S.children||[]).filter($=>$.nodeType===Node.ELEMENT_NODE&&$.tagName==="LI"),N=document.createDocumentFragment(),B=[];T.forEach($=>{let U=document.createElement("p");for(;$.firstChild;)U.appendChild($.firstChild);B.push(U),N.appendChild(U)}),x.replaceWith(N),p(B[0]||null)};if(f){if(f.tagName.toLowerCase()===e){y(f);return}let x=document.createElement(e);for(;f.firstChild;)x.appendChild(f.firstChild);f.replaceWith(x),p(u||x.lastElementChild||x);return}let b=()=>{if(!d.collapsed)return null;let S=l?.closest?.("p")||null;if(S&&s.contains(S))return S;if(d.startContainer===s){let x=Array.from(s.childNodes),T=d.startOffset;for(let N=T-1;N>=0;N-=1){let B=x[N];if(B?.nodeType===Node.ELEMENT_NODE&&B.tagName==="P")return B}for(let N=T;N<x.length;N+=1){let B=x[N];if(B?.nodeType===Node.ELEMENT_NODE&&B.tagName==="P")return B}}return null},h=[];if(d.collapsed){let S=b();S&&(h=[S])}else if(h=Array.from(s.querySelectorAll(":scope > p")).filter(x=>{try{return d.intersectsNode(x)}catch{return!1}}),!h.length){let x=l?.closest?.("p");x&&s.contains(x)&&(h=[x])}if(!h.length)return;let g=document.createElement(e);h.forEach(S=>{let x=document.createElement("li");for(;S.firstChild;)x.appendChild(S.firstChild);g.appendChild(x)}),h[0].replaceWith(g),h.slice(1).forEach(S=>S.remove()),p(g.firstElementChild||g)}var ku=Fe(()=>{});var Ka={};Vn(Ka,{applyEditingUndoStep:()=>oo,attachRichContentHandlers:()=>rc,buildEditableBlockHtml:()=>ec,buildStoredBlockHtml:()=>Va,cleanupEditableHtml:()=>hu,clearEditingUndoSession:()=>Nh,countBlocks:()=>es,ensureBlockVisible:()=>oc,expandCollapsedAncestors:()=>Ph,extendSelection:()=>Jo,extractBlockSections:()=>xn,findBlock:()=>Ke,findCollapsibleTarget:()=>os,findFallbackBlockId:()=>Uo,flattenVisible:()=>fn,initEditingUndoForElement:()=>Mh,insertFilesIntoEditable:()=>nc,isSeparatorNode:()=>yr,moveSelection:()=>Ko,setCollapseState:()=>Dr,setCurrentBlock:()=>Sn,toggleCollapse:()=>tc});function Eu(e=""){return e?e.startsWith("app:/")?`/api/yandex/disk/file?path=${encodeURIComponent(e)}`:e.startsWith("disk:/")?`/api/yandex/disk/file?path=${encodeURIComponent(e)}`:e:""}function Lh(e,t){if(e===t)return!1;if(t.startsWith(e)){let n=t.slice(e.length);if(n.length>0&&n.length<=Bh&&/^[A-Za-z--0-9]+$/.test(n))return!1}return!0}function Mh(e,t){if(!e||!t)return;a.editingUndo={blockId:t,snapshots:[e.innerHTML],index:0,lastText:e.textContent||"",lastSnapshotAt:Date.now()};let n=()=>{let r=a.editingUndo;if(!r||r.blockId!==t)return;let o=e.innerHTML,i=e.textContent||"",{snapshots:s,index:c,lastText:d,lastSnapshotAt:l}=r,u=Date.now();if(!Lh(d||"",i)){r.lastText=i;return}if(s[c]===o){r.lastText=i,r.lastSnapshotAt=u;return}c<s.length-1&&s.splice(c+1),s.push(o),r.index=s.length-1,r.lastText=i,r.lastSnapshotAt=u};e.addEventListener("input",()=>{!a.editingUndo||a.editingUndo.blockId!==t||a.mode!=="edit"||a.editingBlockId!==t||n()})}function Nh(){a.editingUndo=null}function Wo(e){if(e)try{let t=typeof InputEvent=="function"?new InputEvent("input",{bubbles:!0}):new Event("input",{bubbles:!0});e.dispatchEvent(t)}catch{try{let n=document.createEvent("Event");n.initEvent("input",!0,!1),e.dispatchEvent(n)}catch{}}}function oo(e){let t=a.editingUndo;if(!t||!t.blockId||!e||a.mode!=="edit"||a.editingBlockId!==t.blockId)return!1;let n=document.querySelector(`.block[data-block-id="${t.blockId}"] .block-text[contenteditable="true"]`);if(!n)return!1;let r=t.index+e;if(r<0||r>=t.snapshots.length)return!1;t.index=r;let o=t.snapshots[r];n.innerHTML=o;try{n.focus({preventScroll:!0})}catch{n.focus()}try{let i=window.getSelection&&window.getSelection();if(i){let s=document.createRange();s.selectNodeContents(n),s.collapse(!1),i.removeAllRanges(),i.addRange(s)}}catch{}return!0}function ec(e=""){let t=xn(e);if(!t.titleHtml)return e||"";let n=Ja(t.titleHtml),r=t.bodyHtml||"";if(r){let i=document.createElement("template");i.innerHTML=r;let s=i.content.firstChild;for(;s&&yr(s);){let c=s;s=s.nextSibling,i.content.removeChild(c)}r=i.innerHTML}let o=Ja(r||"");return`${n}<p><br /></p>${o}`}function Va(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll(".block-header").forEach(i=>{let s=i.parentNode;if(s){for(;i.firstChild;)s.insertBefore(i.firstChild,i);s.removeChild(i)}});let n=t.innerHTML,r=xn(n);if(!r.titleHtml)return e||"";let o=`<div class="block-header">${r.titleHtml}</div>`;return r.bodyHtml?`${o}<div><br /></div>${r.bodyHtml}`:o}async function tc(e){let t=Ke(e);t&&Dr(e,!t.block.collapsed)}async function Dr(e,t){let n=Ke(e);if(!n||n.block.collapsed===t)return;let r=()=>{let s=document.getElementById("blocksContainer");if(!s)return null;let c=a.currentBlockId;if(!c)return{container:s};let d=s.querySelector(`.block[data-block-id="${c}"]`);if(!d)return{container:s};let l=s.getBoundingClientRect(),u=d.getBoundingClientRect();return{container:s,currentId:c,topOffset:u.top-l.top}},o=s=>{if(!s?.container)return;let{container:c}=s;if(!s.currentId||typeof s.topOffset!="number")return;let d=c.querySelector(`.block[data-block-id="${s.currentId}"]`);if(!d)return;let l=c.getBoundingClientRect(),f=d.getBoundingClientRect().top-l.top;c.scrollTop+=f-s.topOffset},i=r();n.block.collapsed=t,await yt(e),qo({scrollIntoView:!1}),o(i);try{let s=await De(`/api/articles/${a.articleId}/collapse`,{method:"PATCH",body:JSON.stringify({blockId:e,collapsed:t})});s?.updatedAt&&(a.article.updatedAt=s.updatedAt)}catch(s){n.block.collapsed=!t,await yt(e),qo({scrollIntoView:!1}),o(i),L(s.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430")}}function os(e,t){let n=Ke(e);for(;n;){let o=!!xn(n.block.text||"").titleHtml,i=!!n.block.children?.length;if((o||i)&&n.block.collapsed!==t)return n.block.id;if(!n.parent)break;n=Ke(n.parent.id)}return null}async function Ph(e){let t=Ke(e);if(!t)return;let n=(t.ancestors||[]).filter(r=>r.collapsed);for(let r of n)await Dr(r.id,!1)}function Uo(e){let t=Ke(e);if(!t)return null;let n=t.siblings?.[t.index+1];if(n)return n.id;let r=t.siblings?.[t.index-1];return r?r.id:t.parent?t.parent.id:null}function es(e=[]){return(e||[]).reduce((t,n)=>t+1+es(n.children||[]),0)}async function Za(e,t,n){if(!a.articleId){L("\u041D\u0435 \u0432\u044B\u0431\u0440\u0430\u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044F \u0434\u043B\u044F \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0444\u0430\u0439\u043B\u0430");return}let r=`att-${Date.now()}-${Math.random().toString(16).slice(2)}`,o=it(t?.name||"\u0444\u0430\u0439\u043B"),i=t?.name||"\u0444\u0430\u0439\u043B",s="";Tt("attachment: uploading to Yandex Disk",{name:t?.name,type:t?.type,size:t?.size,articleId:a.articleId,token:r});try{or(e),Tn(e,`<a data-pending-attachment="true" data-attachment-token="${r}">${o} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430...)</a>`)}catch{}try{let c=await Bi(a.articleId,t,{onProgress:p=>{let y=Math.max(0,Math.min(100,Math.round(p||0)));Tt("attachment upload progress",{percent:y,name:t?.name});try{let b=e,h=b.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);if(n&&(!h||!b.isConnected)){let g=document.querySelector(`.block[data-block-id="${n}"]`);if(g){let S=g.querySelector('.block-text[contenteditable="true"]')||g.querySelector(".block-text.block-body");S&&(b=S,h=b.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`))}}if(h){let g=y>=100?`${i} (\u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0430...)`:`${i} (${y}%)`;g!==s&&(s=g,h.textContent=g)}}catch{}}}),d=it(c.originalName||t.name||"\u0444\u0430\u0439\u043B"),l=c.storedPath||c.url||"",u=Eu(l),f=it(u);if(f){let p=e,y=p.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);if(n&&(!y||!p.isConnected)){let b=document.querySelector(`.block[data-block-id="${n}"]`);if(b){let g=b.querySelector('.block-text[contenteditable="true"]')||b.querySelector(".block-text.block-body");g&&(p=g,y=p.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`))}}y?(y.removeAttribute("data-pending-attachment"),y.removeAttribute("data-attachment-token"),y.setAttribute("href",f),y.setAttribute("target","_blank"),y.setAttribute("rel","noopener noreferrer"),y.textContent=d):(or(p),Tn(p,`<a href="${f}" target="_blank" rel="noopener noreferrer">${d}</a>`))}}catch(c){try{let l=e;if(n&&!l.isConnected){let f=document.querySelector(`.block[data-block-id="${n}"]`);if(f){let y=f.querySelector('.block-text[contenteditable="true"]')||f.querySelector(".block-text.block-body");y&&(l=y)}}let u=l.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);u&&(u.textContent=`${o} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`)}catch{}let d=String(c?.message||"").toLowerCase();d.includes("status 0")||d.includes("network error")?L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B (\u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C). \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438, \u043F\u0440\u0438 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u043E\u0441\u0442\u0438, \u0432\u043E\u0439\u0434\u0438\u0442\u0435 \u0437\u0430\u043D\u043E\u0432\u043E."):L(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u043D\u0430 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A")}}function nc(e,t=[],n){if(!e||!t||!t.length)return;let r=Array.from(t),o=r.filter(s=>Pr(s)),i=r.filter(s=>s&&!Pr(s));o.forEach(s=>rs(e,s,n)),i.forEach(s=>Za(e,s,n))}function rc(e,t){vu(e,t);let n=e.closest(".block-content");n&&n!==e&&vu(n,t,e),e.addEventListener("paste",r=>{if(a.mode!=="edit"||a.editingBlockId!==t)return;let o=Xa(r.clipboardData?.items),i=Ga(r.clipboardData?.items);if(o.length>0)r.preventDefault(),o.forEach(s=>rs(e,s,t));else if(i.length>0)r.preventDefault(),Tt("paste: non-image files detected",i.map(s=>({name:s.name,type:s.type,size:s.size}))),i.forEach(s=>Za(e,s,t));else{let s=(r.clipboardData?.getData("text/html")||"").trim();if(r.preventDefault(),s){let c=mu(s),d=Wa(c);or(e),Tn(e,jo(d)),Wo(e)}else{let c=r.clipboardData?.getData("text/plain")||"",d=c.trim();if(/^https?:\/\/\S+$/i.test(d)){let u=it(d);or(e),Tn(e,`<a href="${u}" target="_blank" rel="noopener noreferrer">${u}</a>`),Wo(e)}else{let u=c.replace(/\r\n/g,`
`).replace(/\r/g,`
`),f=it(u).replace(/\n{2,}/g,"<br /><br />").replace(/\n/g," "),p=jo(Wa(f));or(e),Tn(e,p),Wo(e)}}}}),e.addEventListener("drop",r=>{if(a.mode!=="edit"||a.editingBlockId!==t){Tt("drop ignored",{mode:a.mode,editingBlockId:a.editingBlockId,targetBlockId:t});return}let o=Array.from(r.dataTransfer?.files||[]);if(!o.length)return;let i=o.filter(c=>c.type?.startsWith("image/")),s=o.filter(c=>!c.type||!c.type.startsWith("image/"));!i.length&&!s.length||(r.preventDefault(),Tt("drop: files detected",o.map(c=>({name:c.name,type:c.type,size:c.size}))),i.forEach(c=>rs(e,c,t)),s.forEach(c=>Za(e,c,t)))}),e.addEventListener("click",r=>{let o=r.target?.closest("img");if(o){if(r.target?.closest(".resizable-image__handle")){r.preventDefault();return}r.preventDefault(),Lo(o.src,o.alt||"");return}let i=r.target?.closest("a[href]");if(!i)return;let s=i.getAttribute("href")||"";if(!s.startsWith("app:/")&&!s.startsWith("disk:/"))return;r.preventDefault();let c=Eu(s);c&&window.open(c,"_blank","noopener,noreferrer")}),a.articleId==="inbox"&&e.addEventListener("click",async r=>{if(r.target?.closest(".move-block-btn")){r.preventDefault(),r.stopPropagation();try{let s=(a.articlesIndex.length?a.articlesIndex:await yn()).filter(u=>u.id!=="inbox").map(u=>({id:u.id,title:u.title||"\u0420\u2018\u0420\xB5\u0420\xB7 \u0420\u0405\u0420\xB0\u0420\xB7\u0420\u0406\u0420\xB0\u0420\u0405\u0420\u0451\u0421\u040F"})),c=await Gt({title:"\u0420\u045F\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451 \u0420\u0406 \u0421\u0403\u0421\u201A\u0420\xB0\u0421\u201A\u0421\u040A\u0421\u040B",message:"\u0420\u2019\u0420\u0406\u0420\xB5\u0420\u0491\u0420\u0451\u0421\u201A\u0420\xB5 ID \u0420\u0451\u0420\xBB\u0420\u0451 \u0420\u0406\u0421\u2039\u0420\xB1\u0420\xB5\u0421\u0402\u0420\u0451\u0421\u201A\u0420\xB5 \u0421\u0403\u0421\u201A\u0420\xB0\u0421\u201A\u0421\u040A\u0421\u040B",confirmText:"\u0420\u045F\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451",cancelText:"\u0420\u045B\u0421\u201A\u0420\u0458\u0420\xB5\u0420\u0405\u0420\xB0",suggestions:s,returnMeta:!0,hideConfirm:!1}),l=(c?.selectedId||(typeof c=="object"?c?.value:c)||""||"").trim();if(!l)return;await De(`/api/articles/${a.articleId}/blocks/${t}/move-to/${l}`,{method:"POST"}),gt(pt.article("inbox"))}catch(i){L(i.message||"\u0420\u045C\u0420\xB5 \u0421\u0453\u0420\u0491\u0420\xB0\u0420\xBB\u0420\u0455\u0421\u0403\u0421\u040A \u0420\u0457\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451 \u0420\xB1\u0420\xBB\u0420\u0455\u0420\u0454")}}}),e.addEventListener("dragover",r=>{if(a.mode!=="edit"||a.editingBlockId!==t)return;(Xa(r.dataTransfer?.items).length>0||Ga(r.dataTransfer?.items).length>0)&&r.preventDefault()}),e.addEventListener("keydown",r=>{if(a.mode!=="edit"||a.editingBlockId!==t)return;let o=window.getSelection();if(!o||o.rangeCount===0)return;let i=o.getRangeAt(0);if(!i||!i.collapsed||pu({event:r,element:e,range:i,selection:o,notifyEditingInput:Wo,logDebug:Tt})||r.key!=="Tab"||!(i.commonAncestorContainer?.nodeType===Node.ELEMENT_NODE?i.commonAncestorContainer:i.commonAncestorContainer?.parentElement)?.closest?.("li"))return;r.preventDefault(),r.stopPropagation();let d=r.shiftKey?"outdent":"indent";document.execCommand(d,!1,null)})}function Tu(){let e=window.getSelection();if(!e||e.rangeCount===0)return;let t=e.getRangeAt(0),n=t.commonAncestorContainer,o=(n?.nodeType===Node.ELEMENT_NODE?n:n?.parentElement)?.closest('.block-text[contenteditable="true"]');if(!o){Xo=null;return}let s=o.closest(".block")?.dataset?.blockId;if(a.mode!=="edit"||a.editingBlockId!==s){Xo=null;return}Xo=t.cloneRange()}function Dh(){if(Qa)return Qa;Au||(document.addEventListener("selectionchange",Tu),Au=!0);let e=document.createElement("div");e.className="rich-context-menu hidden",e.innerHTML=`
    <div class="rich-context-menu__col rich-context-menu__col--buffer">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="copy" aria-label="\u041A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C" title="\u041A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C">\u29C9</button>
        <button class="rich-context-menu__icon-btn" data-action="cut" aria-label="\u0412\u044B\u0440\u0435\u0437\u0430\u0442\u044C" title="\u0412\u044B\u0440\u0435\u0437\u0430\u0442\u044C">\u2702</button>
        <button class="rich-context-menu__icon-btn" data-action="paste" aria-label="\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C" title="\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C">\u25A3</button>
        <button class="rich-context-menu__icon-btn" data-action="select-all" aria-label="\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0432\u0441\u0451" title="\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0432\u0441\u0451">\u26F6</button>
      </div>
    </div>
    <div class="rich-context-menu__col">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="bold" aria-label="\u041F\u043E\u043B\u0443\u0436\u0438\u0440\u043D\u044B\u0439" title="\u041F\u043E\u043B\u0443\u0436\u0438\u0440\u043D\u044B\u0439"><strong>\u0416</strong></button>
        <button class="rich-context-menu__icon-btn" data-action="italic" aria-label="\u041A\u0443\u0440\u0441\u0438\u0432" title="\u041A\u0443\u0440\u0441\u0438\u0432"><em>/</em></button>
        <button class="rich-context-menu__icon-btn" data-action="underline" aria-label="\u041F\u043E\u0434\u0447\u0435\u0440\u043A\u043D\u0443\u0442\u044C" title="\u041F\u043E\u0434\u0447\u0435\u0440\u043A\u043D\u0443\u0442\u044C"><u>\u0427</u></button>
        <button class="rich-context-menu__icon-btn" data-action="remove-format" aria-label="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0444\u043E\u0440\u043C\u0430\u0442" title="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0444\u043E\u0440\u043C\u0430\u0442">\u2715</button>
      </div>
    </div>
    <div class="rich-context-menu__col">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="ul" aria-label="\u041C\u0430\u0440\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A" title="\u041C\u0430\u0440\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A">\u2022</button>
        <button class="rich-context-menu__icon-btn" data-action="ol" aria-label="\u041D\u0443\u043C\u0435\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A" title="\u041D\u0443\u043C\u0435\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A">1.</button>
        <button class="rich-context-menu__icon-btn" data-action="quote" aria-label="\u0426\u0438\u0442\u0430\u0442\u0430" title="\u0426\u0438\u0442\u0430\u0442\u0430">\u275D</button>
        <button class="rich-context-menu__icon-btn" data-action="code" aria-label="\u041A\u043E\u0434" title="\u041A\u043E\u0434">&lt;/&gt;</button>
      </div>
    </div>
    <div class="rich-context-menu__col">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="link" aria-label="\u0421\u0441\u044B\u043B\u043A\u0430" title="\u0421\u0441\u044B\u043B\u043A\u0430">\u{1F517}</button>
        <button class="rich-context-menu__icon-btn" data-action="unlink" aria-label="\u0423\u0431\u0440\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443" title="\u0423\u0431\u0440\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443">\u2298</button>
        <button class="rich-context-menu__icon-btn" data-action="insert-article-link" aria-label="\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E" title="\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E">\xA7</button>
      </div>
    </div>
    <div class="rich-context-menu__col">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="split-at-caret" aria-label="\u0420\u0430\u0437\u0434\u0435\u043B\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043F\u043E \u043A\u0443\u0440\u0441\u043E\u0440\u0443" title="\u0420\u0430\u0437\u0434\u0435\u043B\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043F\u043E \u043A\u0443\u0440\u0441\u043E\u0440\u0443">|\u21B5</button>
      </div>
    </div>
  `,document.body.appendChild(e);let t=()=>{e.classList.add("hidden"),e.style.visibility="",Dt=null,ro=null,Yo=null},n=()=>{if(Dt){let o=window.getSelection();o.removeAllRanges(),o.addRange(Dt)}},r=async o=>{n();let i=()=>{if(ro&&document.contains(ro))return ro;let p=window.getSelection()?.anchorNode?.parentElement?.closest(".block-text[contenteditable]");if(p)return p;if(Dt){let b=Dt.commonAncestorContainer;if(b?.parentElement){let h=b.parentElement.closest(".block-text[contenteditable]");if(h)return h}}if(Yo&&document.contains(Yo))return Yo;if(a.editingBlockId){let b=document.querySelector(`.block[data-block-id="${a.editingBlockId}"] .block-text[contenteditable="true"]`);if(b)return b}let y=document.activeElement;if(y&&y.closest){let b=y.closest(".block-text[contenteditable]");if(b)return b}return null},s=u=>{xu({listTag:u,resolveTarget:i,restoreSelection:n,richContextRange:Dt,notifyEditingInput:Wo,setRichContextRange:f=>{Dt=f?f.cloneRange():null}})},c=async()=>{let u=i();if(!u){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0441\u0441\u044B\u043B\u043A\u0438");return}let f=a.articlesIndex.length?a.articlesIndex:await yn(),p=f.map(x=>({id:x.id,title:x.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),y="",b="";try{let x=await Gt({title:"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438. \u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0438 \u043F\u043E\u043C\u043E\u0433\u0443\u0442 \u043D\u0430\u0439\u0442\u0438 \u043D\u0443\u0436\u043D\u0443\u044E.",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:p,returnMeta:!0,hideConfirm:!0});x&&typeof x=="object"?(y=x.value||"",b=x.selectedId||""):y=x||""}catch{y=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438")||""}let h=(y||"").trim().toLowerCase();if(!h&&!b)return;let g=f.find(x=>{let T=(x.title||"").toLowerCase();return b&&x.id===b||x.id&&x.id.toLowerCase()===h||T===h||T.includes(h)});if(!g){L("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}if(!u||!document.contains(u)){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0441\u0441\u044B\u043B\u043A\u0438");return}n(),u.focus();let w=`<a href="${pt.article(g.id)}" class="article-link" data-article-id="${g.id}">${it(g.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F")}</a>`;Tn(u,w);let S=(u.innerHTML||"").trim();(!S||S==="<br>"||S==="<br/>"||S==="<br />")&&(u.innerHTML=w),u.classList.remove("block-body--empty")},d=()=>{n();let u=window.getSelection();if(!(!u||u.rangeCount===0)){document.execCommand("removeFormat");for(let f=0;f<4;f+=1)document.execCommand("outdent");document.execCommand("formatBlock",!1,"p")}},l=u=>{let f=i();if(!f||!document.contains(f))return L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u0442\u0435\u043A\u0441\u0442 \u0434\u043B\u044F \u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F"),null;let p=window.getSelection();if(!p||p.rangeCount===0)return null;let y=p.getRangeAt(0).cloneRange();if(!y||y.collapsed)return null;let b=y.cloneContents(),h=document.createElement("div");h.appendChild(b);let g=h.innerHTML||"",w=h.textContent||"",x=f.closest(".block")?.dataset.blockId||null;return no={html:g,text:w,sourceBlockId:x},Tt("clipboard.capture",{kind:u,hasHtml:!!g,length:w.length,blockId:x}),{range:y,target:f}};switch(o){case"cut":{if(!l("cut"))break;document.execCommand("cut");break}case"copy":l("copy"),document.execCommand("copy");break;case"select-all":{let u=i();if(!u||!document.contains(u))break;let f=document.createRange();f.selectNodeContents(u);let p=window.getSelection();p&&(p.removeAllRanges(),p.addRange(f)),Dt=f.cloneRange();break}case"paste":{let u=i();if(!u||!document.contains(u)){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438");break}if(!no||!no.html&&!no.text){L("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0441\u043A\u043E\u043F\u0438\u0440\u0443\u0439\u0442\u0435 \u0438\u043B\u0438 \u0432\u044B\u0440\u0435\u0436\u044C\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u0432 \u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440\u0435");break}n();let f=window.getSelection(),p=null;if(Dt&&u.contains(Dt.commonAncestorContainer))p=Dt.cloneRange();else if(f&&f.rangeCount>0){let g=f.getRangeAt(0);u.contains(g.commonAncestorContainer)&&(p=g.cloneRange())}p||(p=document.createRange(),p.selectNodeContents(u),p.collapse(!1));let y=no.html||it(no.text).replace(/\n/g,"<br />"),b=document.createElement("div");b.innerHTML=y;let h=document.createDocumentFragment();for(;b.firstChild;)h.appendChild(b.firstChild);p.deleteContents(),p.insertNode(h),p.collapse(!1),f&&(f.removeAllRanges(),f.addRange(p)),u.focus({preventScroll:!0}),u.classList.remove("block-body--empty");break}case"bold":document.execCommand("bold");break;case"italic":document.execCommand("italic");break;case"underline":document.execCommand("underline");break;case"ul":s("ul");break;case"ol":s("ol");break;case"quote":document.execCommand("formatBlock",!1,"blockquote");break;case"code":document.execCommand("formatBlock",!1,"pre");break;case"link":{let u=window.getSelection(),f=u?u.toString():"",p=u?.anchorNode,y=p?p.parentElement?.closest("a"):null,b=y?.getAttribute("href")||"",h=await wa({title:"\u0421\u0441\u044B\u043B\u043A\u0430",textLabel:"\u0422\u0435\u043A\u0441\u0442",urlLabel:"\u0421\u0441\u044B\u043B\u043A\u0430",defaultText:f||y?.textContent||"",defaultUrl:b,confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"});if(Tt("link action: prompt result",{hasResult:!!h,url:h?.url,text:h?.text}),!h||!h.url)break;let g=h.url.match(/^[a-z]+:/i)?h.url:`https://${h.url}`,w=h.text?.trim()||g;n();let S=i();if(Tt("link action: target",{targetExists:!!S,inDom:!!(S&&document.contains(S)),className:S?.className}),!S||!document.contains(S))break;let x=window.getSelection(),T=null;Dt&&S.contains(Dt.commonAncestorContainer)?T=Dt.cloneRange():x&&x.rangeCount>0&&S.contains(x.getRangeAt(0).commonAncestorContainer)&&(T=x.getRangeAt(0).cloneRange()),T||(T=document.createRange(),T.selectNodeContents(S),T.collapse(!1)),Tt("link action: range chosen",{usedSelectionRange:!!(x&&x.rangeCount>0&&S.contains(x.getRangeAt(0).commonAncestorContainer)),usedStoredRange:!!(Dt&&S.contains(Dt.commonAncestorContainer)),selectionRangeCollapsed:!!(x&&x.rangeCount>0&&x.getRangeAt(0).collapsed),rangeStartNode:T?.startContainer?.nodeName,rangeOffset:T?.startOffset,labelLength:(w||"").length,url:g});let N=document.createElement("a");N.href=g,N.target="_blank",N.rel="noopener noreferrer",N.textContent=w,T.deleteContents(),T.insertNode(N),T.setStartAfter(N),T.setEndAfter(N),Tt("link action: inserted link",{outerHTML:N.outerHTML,parentClass:N.parentElement?.className,targetInner:S.innerHTML.slice(0,120)}),x&&(x.removeAllRanges(),x.addRange(T)),S.focus({preventScroll:!0}),S.classList.remove("block-body--empty");break}case"unlink":{let u=i();if(Tt("unlink action: target",{targetExists:!!u,inDom:!!(u&&document.contains(u)),className:u?.className}),!u||!document.contains(u))break;let f=window.getSelection(),p=null;if(f&&f.rangeCount>0){let y=f.getRangeAt(0).commonAncestorContainer;p=y?.parentElement?.closest("a")||y?.closest?.("a")}if(!p&&Dt){let y=Dt.commonAncestorContainer;p=y?.parentElement?.closest("a")||y?.closest?.("a")}if(p||(p=u.querySelector("a")),p){let y=document.createTextNode(p.textContent||"");p.replaceWith(y)}else document.execCommand("unlink");break}case"remove-format":d();break;case"insert-article-link":c().finally(()=>{t()});return;case"split-at-caret":await Zr();break;default:break}t()};return e.addEventListener("click",o=>{let i=o.target.closest("button[data-action]");if(!i)return;let s=i.dataset.action;r(s)}),document.addEventListener("click",o=>{e.classList.contains("hidden")||e.contains(o.target)||t()}),document.addEventListener("touchstart",o=>{e.classList.contains("hidden")||e.contains(o.target)||t()},{passive:!0}),document.addEventListener("keydown",o=>{o.code==="Escape"&&t()}),window.addEventListener("scroll",t,!0),Qa=e,e}function Iu(e){let t=Dh();t.classList.remove("hidden"),t.style.visibility="hidden",Tu();let n=window.getSelection();n&&n.rangeCount>0?Dt=n.getRangeAt(0).cloneRange():Xo?Dt=Xo.cloneRange():Dt=null;let r=t.getBoundingClientRect(),o=22,i=12,s=e.clientX+14,c=e.clientY+o;c+r.height+i>window.innerHeight&&(c=Math.max(i,e.clientY-r.height-o));let d=Math.min(Math.max(s,i),window.innerWidth-r.width-i),l=Math.min(Math.max(c,i),window.innerHeight-r.height-i);t.style.left=`${d}px`,t.style.top=`${l}px`,t.style.visibility="visible"}function vu(e,t,n){let r=n||e;e.addEventListener("focusin",()=>{Yo=r}),e.addEventListener("contextmenu",s=>{a.mode!=="edit"||a.editingBlockId!==t||(s.preventDefault(),ro=r,Iu(s))});let o=null;e.addEventListener("touchstart",s=>{if(a.mode!=="edit"||a.editingBlockId!==t||s.touches.length!==1)return;let c=s.touches[0];o=window.setTimeout(()=>{ro=r,Iu({clientX:c.clientX,clientY:c.clientY})},500)},{passive:!0});let i=()=>{o!==null&&(clearTimeout(o),o=null)};e.addEventListener("touchend",i,{passive:!0}),e.addEventListener("touchcancel",i,{passive:!0})}async function oc(e){if(!e)return;let t=Ke(e);if(!t)return;let n=(t.ancestors||[]).filter(r=>r.collapsed);for(let r of n)await Dr(r.id,!1)}var Bh,Qa,Dt,ro,Yo,no,Xo,Au,nn=Fe(()=>{ft();Pt();Et();jn();bn();Rn();Pt();wn();wn();eo();fu();ja();gu();Ya();Su();ku();Bh=16;Qa=null,Dt=null,ro=null,Yo=null,no={html:"",text:"",sourceBlockId:null},Xo=null,Au=!1;wu()});function _h(e="",t=""){let n=Array.from(e),r=Array.from(t),o=n.length,i=r.length,s=Array.from({length:o+1},()=>new Array(i+1).fill(0));for(let f=o-1;f>=0;f-=1)for(let p=i-1;p>=0;p-=1)n[f]===r[p]?s[f][p]=s[f+1][p+1]+1:s[f][p]=Math.max(s[f+1][p],s[f][p+1]);let c=[],d=0,l=0;for(;d<o&&l<i;)n[d]===r[l]?(c.push({type:"same",value:n[d]}),d+=1,l+=1):s[d+1][l]>=s[d][l+1]?(c.push({type:"removed",value:n[d]}),d+=1):(c.push({type:"added",value:r[l]}),l+=1);for(;d<o;)c.push({type:"removed",value:n[d]}),d+=1;for(;l<i;)c.push({type:"added",value:r[l]}),l+=1;let u=[];return c.forEach(f=>{if(!f.value)return;let p=u[u.length-1];p&&p.type===f.type?p.value+=f.value:u.push({type:f.type,value:f.value})}),u}function Oh(e=[],t=[]){let n=c=>`${c.src}||${c.alt||""}`,r={};t.forEach(c=>{let d=n(c);r[d]=(r[d]||0)+1});let o=[];e.forEach(c=>{let d=n(c);r[d]?r[d]-=1:o.push({type:"removed",...c})});let i={};e.forEach(c=>{let d=n(c);i[d]=(i[d]||0)+1});let s=[];return t.forEach(c=>{let d=n(c);i[d]?i[d]-=1:s.push({type:"added",...c})}),[...o,...s]}function Rh(e,t){if(!t.length)return;let n=document.createElement("div");n.className="diff-images",t.forEach(r=>{let o=document.createElement("div");o.className=`diff-image-card diff-image-card--${r.type}`;let i=document.createElement("div");i.className="diff-image-card__label",i.textContent=r.type==="added"?"\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E":"\u0423\u0434\u0430\u043B\u0435\u043D\u043E";let s=document.createElement("img");s.src=r.src,s.alt=r.alt||"",o.append(i,s),n.appendChild(o)}),e.appendChild(n)}function Bu(e,t,n,r=[]){let o=document.createElement("div");o.className="diff-inline";let i=document.createElement("div");i.className="diff-inline__content",n.forEach(c=>{let d=document.createElement("span");c.type==="added"?d.className="diff-inline__segment diff-inline__segment--added":c.type==="removed"&&(d.className="diff-inline__segment diff-inline__segment--removed"),d.textContent=c.value,i.appendChild(d)}),Rh(i,r);let s=document.createElement("div");s.className="diff-inline__hint",s.textContent=t==="undo"?"\u041F\u043E\u0432\u0442\u043E\u0440\u043D\u043E \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Ctrl+Z, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C \u043E\u0442\u043C\u0435\u043D\u0443":"\u041F\u043E\u0432\u0442\u043E\u0440\u043D\u043E \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Ctrl+Y, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C \u043F\u043E\u0432\u0442\u043E\u0440",o.append(i,s),e.innerHTML="",e.appendChild(o)}function Hh(e,t="history"){return(t==="redo"?a.article?.redoHistory||[]:a.article?.history||[]).find(r=>r.id===e)||null}async function Lu(e,t){Wn();let n=t==="undo"?"history":"redo",r=Hh(e.historyEntryId,n);if(!r)return!1;await is(e.blockId);let o=document.querySelector(`.block[data-block-id="${e.blockId}"] .block-text`);if(!o)return!1;let i=o.innerHTML,s=t==="undo"?r.before:r.after,c=o.textContent||"",d=yd(s),l=_h(c,d),u=l.some(p=>p.type!=="same"),f=Oh(pa(i),pa(s));return!u&&!f.length?!1:(Bu(o,t,l,f),a.pendingTextPreview={mode:t,blockId:e.blockId,originalHTML:i,chunks:l,imageDiff:f},!0)}async function Mu(e){let t=a.pendingTextPreview;if(Wn({restoreDom:!1}),!!t){if(e==="undo"){let n=a.undoStack.pop();if(!n)return;await Du(n)?a.redoStack.push(n):a.undoStack.push(n)}else if(e==="redo"){let n=a.redoStack.pop();if(!n)return;await _u(n)?a.undoStack.push(n):a.redoStack.push(n)}}}function Nu(){let e=a.pendingTextPreview;if(!e)return;let t=document.querySelector(`.block[data-block-id="${e.blockId}"] .block-text`);t&&Bu(t,e.mode,e.chunks,e.imageDiff||[])}function $h(e){return e?e.kind==="move"?{kind:"move",blockId:e.blockId,direction:e.direction==="up"?"down":"up"}:e.kind==="reorder"?{kind:"reorder",blockId:e.blockId,fromParentId:e.toParentId??null,fromIndex:e.toIndex??null,toParentId:e.fromParentId??null,toIndex:e.fromIndex??null}:e.kind==="indent"?{kind:"outdent",blockId:e.blockId}:e.kind==="outdent"?{kind:"indent",blockId:e.blockId}:e.kind==="create"?{kind:"delete",blockId:e.blockId,fallbackId:e.fallbackId||null}:e.kind==="delete"?{kind:"restore",block:e.block,parentId:e.parentId||null,index:e.index??null}:null:null}async function Pu(e,t={}){let{skipRecord:n=!1}=t;if(!e)return{success:!1};let r=!1,o=null;if(Tt("executeStructureAction start",e),e.kind==="move")r=await sc(e.blockId,e.direction,{skipRecord:n});else if(e.kind==="reorder")r=(await cs(e.blockId,e.toParentId??null,e.toIndex??null,{skipRecord:!0})).success;else if(e.kind==="indent")r=await cc(e.blockId,{skipRecord:n});else if(e.kind==="outdent")r=await lc(e.blockId,{skipRecord:n});else if(e.kind==="delete"){let i=e.blockId||e.block?.id;if(!i)return{success:!1};try{o=await De(`/api/articles/${a.articleId}/blocks/${i}`,{method:"DELETE"});let s=Ke(i);if(s&&a.article&&Array.isArray(a.article.blocks)){let d=s.siblings||a.article.blocks,l=s.index??d.findIndex(u=>u.id===i);if(l>=0&&d.splice(l,1),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}if(o?.block&&o.block.id){let{pushLocalBlockTrashEntry:u}=await Promise.resolve().then(()=>(jn(),$u)),f=o.block;u(f,s.parent?.id||null,s.index??l)}}let c=e.fallbackId||o?.parentId||null;c&&await is(c),nt(),r=!0}catch(s){L(s.message),r=!1}}else if(e.kind==="restore"||e.kind==="create"){let i=e.block||e.blockSnapshot;if(!i)return{success:!1};let s=e.parentId||null;try{let c=i;a.article&&a.article.encrypted&&a.articleEncryptionKey&&(c=JSON.parse(JSON.stringify(i)),await Po(c,a.articleEncryptionKey)),o=await De(`/api/articles/${a.articleId}/blocks/restore`,{method:"POST",body:JSON.stringify({parentId:e.parentId||null,index:e.index??null,block:c})});let d=o?.block,l=o?.parentId||e.parentId||null;if(s=l,d&&a.article&&Array.isArray(a.article.blocks)){let u=rr(d)||d;if(l){let p=Ke(l)?.block||null;if(p){Array.isArray(p.children)||(p.children=[]);let y=p.children,b=typeof o.index=="number"&&o.index>=0&&o.index<=y.length?o.index:y.length;y.splice(b,0,u)}}else{let f=a.article.blocks,p=typeof o.index=="number"&&o.index>=0&&o.index<=f.length?o.index:f.length;f.splice(p,0,u)}if(a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}r=!0}catch(c){L(c.message),r=!1}if(r&&a.article&&Array.isArray(a.article.blocks))if(s)try{await yt(s)}catch{nt()}else nt()}if(r){let i=e.blockId||o?.block?.id||e.block?.id;i&&await is(i)}return Tt("executeStructureAction result",{success:r,payload:o}),{success:r,payload:o}}async function Du(e){if(!a.articleId)return null;try{let t=await De(`/api/articles/${a.articleId}/blocks/undo-text`,{method:"POST",body:JSON.stringify({entryId:e?.historyEntryId||null})}),n=t?.blockId;if(!n)return null;let r=Ke(n);if(!r||!a.article||!Array.isArray(a.article.blocks))return await Ht(a.articleId,{desiredBlockId:n}),nt(),n;let o=t.block&&typeof t.block.text=="string"?t.block.text:"";if(a.article.encrypted&&a.articleEncryptionKeys?.[a.article.id]&&Mo(o)){let i=a.articleEncryptionKeys[a.article.id];try{o=await No(i,o)}catch{o=""}}if(r.block.text=o,a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}return a.currentBlockId=n,a.selectionAnchorBlockId=null,a.selectedBlockIds=[],await yt(n),n}catch(t){return t.message!=="Nothing to undo"&&L(t.message),null}}async function _u(e){if(!a.articleId)return null;try{let t=await De(`/api/articles/${a.articleId}/blocks/redo-text`,{method:"POST",body:JSON.stringify({entryId:e?.historyEntryId||null})}),n=t?.blockId;if(!n)return null;let r=Ke(n);if(!r||!a.article||!Array.isArray(a.article.blocks))return await Ht(a.articleId,{desiredBlockId:n}),nt(),n;let o=t.block&&typeof t.block.text=="string"?t.block.text:"";if(a.article.encrypted&&a.articleEncryptionKeys?.[a.article.id]&&Mo(o)){let i=a.articleEncryptionKeys[a.article.id];try{o=await No(i,o)}catch{o=""}}if(r.block.text=o,a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}return a.currentBlockId=n,a.selectionAnchorBlockId=null,a.selectedBlockIds=[],await yt(n),n}catch(t){return t.message!=="Nothing to redo"&&L(t.message),null}}async function io(){if(a.pendingTextPreview?.mode==="redo"&&Wn(),a.pendingTextPreview?.mode==="undo"){await Mu("undo");return}if(!a.undoStack.length){L("\u041D\u0435\u0447\u0435\u0433\u043E \u043E\u0442\u043C\u0435\u043D\u044F\u0442\u044C");return}let e=a.undoStack[a.undoStack.length-1];if(Tt("handleUndoAction entry",e),e.type==="structure"){a.undoStack.pop();let n=$h(e.action),r=await Pu(n,{skipRecord:!0});r.success?(e.action.kind==="create"&&r.payload?.block&&(e.action.block=r.payload.block,e.action.parentId=r.payload.parentId||null,e.action.index=r.payload.index??null),a.redoStack.push(e)):(a.undoStack.push(e),L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043C\u0435\u043D\u0438\u0442\u044C \u0434\u0435\u0439\u0441\u0442\u0432\u0438\u0435"));return}await Lu(e,"undo")||(a.undoStack.pop(),await Du(e)?a.redoStack.push(e):a.undoStack.push(e))}async function so(){if(a.pendingTextPreview?.mode==="undo"&&Wn(),a.pendingTextPreview?.mode==="redo"){await Mu("redo");return}if(!a.redoStack.length){L("\u041D\u0435\u0447\u0435\u0433\u043E \u043F\u043E\u0432\u0442\u043E\u0440\u044F\u0442\u044C");return}let e=a.redoStack[a.redoStack.length-1];if(Tt("handleRedoAction entry",e),e.type==="structure"){a.redoStack.pop(),(await Pu(e.action,{skipRecord:!0})).success?a.undoStack.push(e):(a.redoStack.push(e),L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u0432\u0442\u043E\u0440\u0438\u0442\u044C \u0434\u0435\u0439\u0441\u0442\u0432\u0438\u0435"));return}await Lu(e,"redo")||(a.redoStack.pop(),await _u(e)?a.undoStack.push(e):a.redoStack.push(e))}function Ou(e){Wn({restoreDom:!1});let t=n=>({type:"text",blockId:n.blockId,historyEntryId:n.id});a.undoStack=(e.history||[]).map(t),a.redoStack=(e.redoHistory||[]).map(t)}function rn(e){e&&(Tt("pushUndoEntry",e),a.undoStack.push(e),a.redoStack=[])}function rr(e){try{return JSON.parse(JSON.stringify(e||{}))}catch{return null}}function ic(e){if(!e||!a.article||!Array.isArray(a.article.blocks))return;let t=!1,n=r=>{if(Array.isArray(r))for(let o=0;o<r.length;o+=1){let i=r[o];if(i){if(i===e)if(!t)t=!0;else{r.splice(o,1),o-=1;continue}Array.isArray(i.children)&&i.children.length&&n(i.children)}}};n(a.article.blocks)}async function Fh(){if(a.articleId&&!a.isMoveQueueProcessing){a.isMoveQueueProcessing=!0;try{for(;a.moveQueue.length;){let e=a.moveQueue.shift();if(!e)break;let{blockId:t,direction:n}=e;try{await De(`/api/articles/${a.articleId}/blocks/${t}/move`,{method:"POST",body:JSON.stringify({direction:n})})}catch(r){L(r.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u043F\u043E\u0440\u044F\u0434\u043E\u043A \u0431\u043B\u043E\u043A\u043E\u0432, \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0441\u0442\u0430\u0442\u044C\u044E");try{await Ht(a.articleId,{desiredBlockId:t}),nt()}catch{}a.moveQueue=[];break}}}finally{a.isMoveQueueProcessing=!1}}}function zh(e,t){!e||!["up","down"].includes(t)||(Array.isArray(a.moveQueue)||(a.moveQueue=[]),a.moveQueue.push({blockId:e,direction:t}),Fh())}async function is(e){e&&(await oc(e),Sn(e))}function Wn({restoreDom:e=!0}={}){let t=a.pendingTextPreview;if(t){if(e){let n=document.querySelector(`.block[data-block-id="${t.blockId}"] .block-text`);n&&(n.innerHTML=t.originalHTML)}a.pendingTextPreview=null}}async function sc(e,t,n={}){if(!e||!["up","down"].includes(t))return!1;let{skipRecord:r=!1,internal:o=!1,suppressRerender:i=!1}=n;try{let s=Ke(e);if(t==="up"&&s&&s.parent){let d=s.siblings||a.article?.blocks||[];if((s.index??d.findIndex(u=>u.id===e))===0){let u=s.parent.id,f=Ke(u),p=f?.siblings||a.article?.blocks||[],y=f?.index??p.findIndex(w=>w&&w.id===(f?.block?.id||u));if(y<=0)return!1;let b=p[y-1];if(!b||!b.id)return!1;let h=Array.isArray(b.children)?b.children.length:0,g=await cs(e,b.id,h,{skipRecord:!0,anchorId:null,placement:null,suppressRerender:i});return g.success?(a.currentBlockId=e,r||rn({type:"structure",action:{kind:"reorder",blockId:e,fromParentId:u,fromIndex:s.index??0,toParentId:b.id,toIndex:g.to?.index??h}}),!0):!1}}if(s&&a.article&&Array.isArray(a.article.blocks)){let d=s.siblings||a.article.blocks,l=s.index??d.findIndex(u=>u.id===e);if(l>=0){let u=l===0,f=l===d.length-1;if(t==="up"&&u||t==="down"&&f)return!1}}let c=null;if(s&&a.article&&Array.isArray(a.article.blocks)){let d=s.siblings||a.article.blocks,l=s.index??d.findIndex(u=>u.id===e);if(l>=0){let u=t==="up"?l-1:l+1;if(u>=0&&u<d.length){let[f]=d.splice(l,1);d.splice(u,0,f)}}if(a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}c=s.parent?.id||null}return a.currentBlockId=e,zh(e,t),i||ls(e,t)||(c?await yt(c):nt()),r||rn({type:"structure",action:{kind:"move",blockId:e,direction:t}}),!0}catch(s){return L(s.message),!1}}function Cu(e){return sc(a.currentBlockId,e)}async function ac(e){if(!a.article||!Array.isArray(a.article.blocks)||!["up","down"].includes(e))return!1;let t=Array.isArray(a.selectedBlockIds)?a.selectedBlockIds:[];if(t.length<=1)return Cu(e);if(a.isMovingBlock)return!1;let r=fn(a.article.blocks).filter(c=>t.includes(c.id));if(r.length<=1)return Cu(e);let o=Ke(r[0].id)?.parent?.id||null,i=[],s=!0;if(r.forEach((c,d)=>{let l=Ke(c.id);if(!l){s=!1;return}if((l.parent?.id||null)!==o){s=!1;return}i.push(l.index)}),!s||!i.length)return L("\u041C\u043D\u043E\u0436\u0435\u0441\u0442\u0432\u0435\u043D\u043D\u043E\u0435 \u043F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u043F\u043E\u0434\u0440\u044F\u0434 \u0438\u0434\u0443\u0449\u0438\u0445 \u0431\u043B\u043E\u043A\u043E\u0432 \u0441 \u043E\u0434\u043D\u0438\u043C \u0440\u043E\u0434\u0438\u0442\u0435\u043B\u0435\u043C"),!1;i.sort((c,d)=>c-d);for(let c=1;c<i.length;c+=1)if(i[c]!==i[0]+c)return L("\u041C\u043D\u043E\u0436\u0435\u0441\u0442\u0432\u0435\u043D\u043D\u043E\u0435 \u043F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u043F\u043E\u0434\u0440\u044F\u0434 \u0438\u0434\u0443\u0449\u0438\u0445 \u0431\u043B\u043E\u043A\u043E\u0432"),!1;a.isMovingBlock=!0;try{let c=e==="up"?[...r]:[...r].reverse();for(let h of c)if(!await sc(h.id,e,{skipRecord:!0,internal:!0,suppressRerender:!0}))return L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438"),!1;let d=i[0],l=i[i.length-1],u=(o?Ke(o)?.block.children:a.article.blocks)||[],f=o,p=o,y=d,b=e==="up"?d-1:l+1;return rn({type:"structure",action:{kind:"reorder",blockId:r[0].id,fromParentId:f,fromIndex:y,toParentId:p,toIndex:b}}),a.currentBlockId=r[0].id,o?await yt(o):nt(),!0}finally{a.isMovingBlock=!1}}async function cs(e,t=null,n=null,r={}){if(!e)return{success:!1};let{skipRecord:o=!1,anchorId:i=null,placement:s=null,suppressRerender:c=!1}=r,d=Ke(e);if(!d)return L("\u0411\u043B\u043E\u043A \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D"),{success:!1};let l=d.parent?.id||null,u=d.index??0,f=t?Ke(t)?.block:null,p=f?f.children?.length||0:(a.article?.blocks||[]).length,y=typeof n=="number"&&n>=0?Math.min(n,p):p;if(l===t&&u===y)return{success:!0,noOp:!0,from:{parentId:l,index:u},to:{parentId:t,index:y}};let b=y;t===l&&u<b&&(b=Math.max(b-1,0));try{let h=await De(`/api/articles/${a.articleId}/blocks/${e}/relocate`,{method:"POST",body:JSON.stringify({parentId:t||null,index:b,anchorId:i||null,placement:s||null})});if(a.article&&Array.isArray(a.article.blocks)){let w=d.siblings||a.article.blocks,S=d.index??w.findIndex(B=>B.id===e),x=null;S>=0&&([x]=w.splice(S,1)),x||(x=d.block);let T;if(t){let B=Ke(t);B&&B.block?(Array.isArray(B.block.children)||(B.block.children=[]),T=B.block.children):T=a.article.blocks}else T=a.article.blocks;let N=typeof b=="number"&&b>=0?Math.min(b,T.length):T.length;if(T.splice(N,0,x),ic(x),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}a.currentBlockId=e;let g=h?.parentId??t??null;return c||(l&&g?(await yt(l),g!==l&&await yt(g)):l&&!g?nt():!l&&g?nt():nt()),o||rn({type:"structure",action:{kind:"reorder",blockId:e,fromParentId:l,fromIndex:u,toParentId:h?.parentId??t??null,toIndex:h?.index??b}}),await is(e),{success:!0,from:{parentId:l,index:u},to:{parentId:h?.parentId??t??null,index:h?.index??b}}}catch(h){return L(h.message),{success:!1}}}async function cc(e,t={}){if(!e)return!1;let{skipRecord:n=!1,keepEditing:r=!1,suppressRerender:o=!1}=t;try{if(!t.internal){if(a.isMovingBlock)return!1;a.isMovingBlock=!0}r&&(a.pendingEditBlockId=e,a.scrollTargetBlockId=e);let i=Ke(e),s=i?.parent?.id||null;if(await De(`/api/articles/${a.articleId}/blocks/${e}/indent`,{method:"POST",body:JSON.stringify({})}),i&&a.article&&Array.isArray(a.article.blocks)){let c=i.siblings||a.article.blocks,d=i.index??c.findIndex(l=>l.id===e);if(d>0){let l=c[d-1],[u]=c.splice(d,1);if(Array.isArray(l.children)||(l.children=[]),l.children.push(u),ic(u),l.collapsed){l.collapsed=!1;try{await De(`/api/articles/${a.articleId}/collapse`,{method:"PATCH",body:JSON.stringify({blockId:l.id,collapsed:!1})})}catch{}}if(a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}}return a.currentBlockId=e,r&&(a.mode="edit",a.editingBlockId=e),o||(s?await yt(s):nt()),n||rn({type:"structure",action:{kind:"indent",blockId:e}}),!0}catch(i){return L(i.message),!1}finally{t.internal||(a.isMovingBlock=!1)}}function ss(e={}){return cc(a.currentBlockId,e)}async function Ru(e={}){if(!a.article||!Array.isArray(a.article.blocks))return!1;let t=Array.isArray(a.selectedBlockIds)?a.selectedBlockIds:[];if(t.length<=1)return ss(e);if(a.isMovingBlock)return!1;let r=fn(a.article.blocks).filter(u=>t.includes(u.id));if(r.length<=1)return ss(e);let o=Ke(r[0].id);if(!o||!o.siblings)return!1;let i=o.siblings;if((o.index??i.findIndex(u=>u.id===o.block.id))<=0)return L("\u041D\u0435\u043B\u044C\u0437\u044F \u0443\u0432\u0435\u043B\u0438\u0447\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u043D\u043E\u0441\u0442\u044C \u043F\u0435\u0440\u0432\u043E\u0439 \u0433\u0440\u0443\u043F\u043F\u044B \u0431\u043B\u043E\u043A\u043E\u0432"),!1;let c=o.parent?.id||null,d=[],l=!0;if(r.forEach(u=>{let f=Ke(u.id);if(!f){l=!1;return}if((f.parent?.id||null)!==c){l=!1;return}d.push(f.index)}),!l||!d.length)return L("\u041C\u043D\u043E\u0436\u0435\u0441\u0442\u0432\u0435\u043D\u043D\u044B\u0439 \u043E\u0442\u0441\u0442\u0443\u043F \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u043F\u043E\u0434\u0440\u044F\u0434 \u0438\u0434\u0443\u0449\u0438\u0445 \u0431\u043B\u043E\u043A\u043E\u0432 \u0441 \u043E\u0434\u043D\u0438\u043C \u0440\u043E\u0434\u0438\u0442\u0435\u043B\u0435\u043C"),!1;d.sort((u,f)=>u-f);for(let u=1;u<d.length;u+=1)if(d[u]!==d[0]+u)return L("\u041C\u043D\u043E\u0436\u0435\u0441\u0442\u0432\u0435\u043D\u043D\u044B\u0439 \u043E\u0442\u0441\u0442\u0443\u043F \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u043F\u043E\u0434\u0440\u044F\u0434 \u0438\u0434\u0443\u0449\u0438\u0445 \u0431\u043B\u043E\u043A\u043E\u0432"),!1;a.isMovingBlock=!0;try{for(let u of r)if(!await cc(u.id,{...e,skipRecord:!0,internal:!0,suppressRerender:!0}))return L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u043D\u043E\u0441\u0442\u044C \u0431\u043B\u043E\u043A\u043E\u0432"),!1;return rn({type:"structure",action:{kind:"indent",blockId:r[0].id}}),a.currentBlockId=r[0].id,c?await yt(c):nt(),!0}finally{a.isMovingBlock=!1}}async function lc(e,t={}){if(!e)return!1;let{skipRecord:n=!1,keepEditing:r=!1,suppressRerender:o=!1}=t;try{if(!t.internal){if(a.isMovingBlock)return!1;a.isMovingBlock=!0}r&&(a.pendingEditBlockId=e,a.scrollTargetBlockId=e);let i=Ke(e);await De(`/api/articles/${a.articleId}/blocks/${e}/outdent`,{method:"POST",body:JSON.stringify({})});let s=null;if(i&&a.article&&Array.isArray(a.article.blocks)){let c=i.parent||null,l=(c?Ke(c.id):null)?.parent||null;s=l?.id||null;let u=i.siblings||(c?c.children||[]:a.article.blocks),f=i.index??u.findIndex(g=>g.id===e),p=null;f>=0&&([p]=u.splice(f,1)),p||(p=i.block);let y;l?(Array.isArray(l.children)||(l.children=[]),y=l.children):y=a.article.blocks;let b=c?y.indexOf(c):-1,h=b>=0?b+1:y.length;if(y.splice(h,0,p),ic(p),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}return a.currentBlockId=e,r&&(a.mode="edit",a.editingBlockId=e),o||(s?await yt(s):nt()),n||rn({type:"structure",action:{kind:"outdent",blockId:e}}),!0}catch(i){return L(i.message),!1}finally{t.internal||(a.isMovingBlock=!1)}}function as(e={}){return lc(a.currentBlockId,e)}async function Hu(e={}){if(!a.article||!Array.isArray(a.article.blocks))return!1;let t=Array.isArray(a.selectedBlockIds)?a.selectedBlockIds:[];if(t.length<=1)return as(e);if(a.isMovingBlock)return!1;let r=fn(a.article.blocks).filter(d=>t.includes(d.id));if(r.length<=1)return as(e);let o=Ke(r[0].id);if(!o||!o.parent)return L("\u041D\u0435\u043B\u044C\u0437\u044F \u0443\u043C\u0435\u043D\u044C\u0448\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u043D\u043E\u0441\u0442\u044C \u043A\u043E\u0440\u043D\u0435\u0432\u044B\u0445 \u0431\u043B\u043E\u043A\u043E\u0432"),!1;let i=o.parent.id,s=[],c=!0;if(r.forEach(d=>{let l=Ke(d.id);if(!l||!l.parent){c=!1;return}if(l.parent.id!==i){c=!1;return}s.push(l.index)}),!c||!s.length)return L("\u041C\u043D\u043E\u0436\u0435\u0441\u0442\u0432\u0435\u043D\u043D\u044B\u0439 \u043E\u0442\u0441\u0442\u0443\u043F \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u043F\u043E\u0434\u0440\u044F\u0434 \u0438\u0434\u0443\u0449\u0438\u0445 \u0431\u043B\u043E\u043A\u043E\u0432 \u0441 \u043E\u0434\u043D\u0438\u043C \u0440\u043E\u0434\u0438\u0442\u0435\u043B\u0435\u043C"),!1;s.sort((d,l)=>d-l);for(let d=1;d<s.length;d+=1)if(s[d]!==s[0]+d)return L("\u041C\u043D\u043E\u0436\u0435\u0441\u0442\u0432\u0435\u043D\u043D\u044B\u0439 \u043E\u0442\u0441\u0442\u0443\u043F \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u043F\u043E\u0434\u0440\u044F\u0434 \u0438\u0434\u0443\u0449\u0438\u0445 \u0431\u043B\u043E\u043A\u043E\u0432"),!1;a.isMovingBlock=!0;try{let d=[...r].reverse();for(let f of d)if(!await lc(f.id,{...e,skipRecord:!0,internal:!0,suppressRerender:!0}))return L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u043D\u043E\u0441\u0442\u044C \u0431\u043B\u043E\u043A\u043E\u0432"),!1;rn({type:"structure",action:{kind:"outdent",blockId:r[0].id}}),a.currentBlockId=r[0].id;let u=Ke(r[0].id)?.parent?.id||null;return u?await yt(u):nt(),!0}finally{a.isMovingBlock=!1}}var $n=Fe(()=>{ft();Pt();Et();jn();jn();nn();bn();Do()});function Uh(){let e=a?.currentUser||null;return e&&(e.id||e.username)||"anon"}async function ds(){return yi({userKey:Uh()})}async function Fu(e={}){let t=String(e?.token||"").trim(),n=String(e?.articleId||"").trim();if(!t||!n)return!1;let r=String(e?.kind||"image"),o=e?.blob||null,i=String(e?.mime||o&&o.type||"").trim(),s=String(e?.fileName||"").trim()||null,c=Date.now(),l=(await ds()).transaction(["pending_uploads"],"readwrite"),u=l.objectStore("pending_uploads"),f=await Ce(u.get(t)).catch(()=>null),p=Number(f?.createdAtMs||e?.createdAtMs||c)||c,y={token:t,articleId:n,kind:r,blob:o,mime:i,fileName:s,status:String(e?.status||f?.status||"pending"),errorMessage:String(e?.errorMessage||f?.errorMessage||""),createdAtMs:p,updatedAtMs:c};return await Ce(u.put(y)),await Ue(l),!0}async function dc(e){let t=String(e||"").trim();if(!t)return!1;let r=(await ds()).transaction(["pending_uploads"],"readwrite"),o=r.objectStore("pending_uploads");return await Ce(o.delete(t)),await Ue(r),!0}async function uc(e,t){let n=String(e||"").trim();if(!n)return!1;let o=(await ds()).transaction(["pending_uploads"],"readwrite"),i=o.objectStore("pending_uploads"),s=await Ce(i.get(n)).catch(()=>null);return s?(s.status="error",s.errorMessage=String(t||"error"),s.updatedAtMs=Date.now(),await Ce(i.put(s)),await Ue(o),!0):(await Ue(o),!1)}async function fc({articleId:e=null,limit:t=50}={}){let r=(await ds()).transaction(["pending_uploads"],"readonly"),o=r.objectStore("pending_uploads"),i=[];try{let s=Number(t||0)||0;if(e){let c=o.index("byArticleId");i=await Ce(c.getAll(String(e),s>0?s:void 0))}else i=await Ce(o.getAll(s>0?s:void 0))}catch{i=[]}return await Ue(r),Array.isArray(i)?(i.sort((s,c)=>Number(s?.createdAtMs||0)-Number(c?.createdAtMs||0)),i):[]}var zu=Fe(()=>{ft();ta();En()});var us,Uu=Fe(()=>{us=["pending-attachment","app","disk"]});function pc(e){let n=String(e||"").replace(/\r\n/g,`
`).split(`
`),r=d=>{let l=String(d||"").match(/^(#{1,6})\s+(.*)$/);if(!l)return null;let u=String(l[2]||"").trim();return u?{level:l[1].length,title:u}:null},o=!1;try{let d=n.find(l=>String(l||"").trim().length>0)||"";o=!!r(d)}catch{o=!1}let i=[],s=null,c=()=>{if(s){try{for(;s.bodyLines.length&&!String(s.bodyLines[0]||"").trim();)s.bodyLines.shift()}catch{}s.bodyText=s.bodyLines.join(`
`).trimEnd(),delete s.bodyLines,i.push(s),s=null}};for(let d of n){let l=r(d);if(l){c(),s={level:l.level,title:l.title,bodyLines:[]};continue}s&&s.bodyLines.push(d)}return c(),{sections:i,startsWithHeading:o,headingCount:i.length}}function Vu(e,t={}){let n=Array.isArray(e)?e.filter(Boolean):[],r=typeof t.makeId=="function"?t.makeId:()=>`${Date.now()}-${Math.random()}`;if(!n.length)return[];let o=Number.isFinite(t.baseLevel)?t.baseLevel:Number(n[0].level||1),i=[],s=[];for(let c of n){let d=Number(c.level||1),l=String(c.title||"").trim(),u=String(c.bodyText||"").trimEnd();if(!l)continue;let f=Math.max(0,d-o);for(;s.length>f;)s.pop();f>s.length&&(f=s.length);let p={id:r(),title:l,bodyText:u,children:[]},y=f>0?s[f-1]:null;y?y.children.push(p):i.push(p),s.push(p)}return i}var qu=Fe(()=>{});var ps={};Vn(ps,{addPendingQuickNote:()=>Kh,buildOutlineSectionFromPlainText:()=>hc,enqueuePendingQuickNotesForSync:()=>Yh,overlayPendingQuickNotesIntoInboxDocJson:()=>jh,readPendingQuickNotes:()=>fs,refreshInboxCacheFromServer:()=>gc,removePendingQuickNoteBySectionId:()=>mc});function Vh(){return globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?globalThis.crypto.randomUUID():`id-${Date.now()}-${Math.random().toString(16).slice(2)}`}function qh(){return new Date().toISOString()}function fs(){try{let e=window?.localStorage?.getItem?.(Ju)||"";if(!e)return[];let t=JSON.parse(e);return Array.isArray(t)?t.filter(Boolean):[]}catch{return[]}}function ju(e){try{window?.localStorage?.setItem?.(Ju,JSON.stringify(Array.isArray(e)?e:[]))}catch{}}function Kh(e){let t=String(e||"").trim();if(!t)return null;let n=Vh(),r={id:n,sectionId:n,createdAt:qh(),text:t},o=fs();return o.unshift(r),ju(o),r}function mc(e){let t=String(e||"").trim();if(!t)return!1;let n=fs(),r=n.filter(o=>String(o?.sectionId||o?.id||"")!==t);return r.length===n.length?!1:(ju(r),!0)}function Jh(e){let n=String(e||"").trim().split(/\r?\n/),r=[];for(let o=0;o<n.length;o+=1){let i=n[o];i&&r.push({type:"text",text:i}),o!==n.length-1&&r.push({type:"hardBreak"})}return r.length?r:null}function hc({sectionId:e,text:t}={}){let n=String(e||"").trim();if(!n)return null;let r=Jh(t);return{type:"outlineSection",attrs:{id:n,collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[r?{type:"paragraph",content:r}:{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}}function jh(e,t){let n=e&&typeof e=="object"?e:{type:"doc",content:[]},r=Array.isArray(n.content)?n.content:[],o=new Set(r.filter(c=>c&&c.type==="outlineSection"&&c.attrs&&c.attrs.id).map(c=>String(c.attrs.id))),i=Array.isArray(t)?t:[];if(!i.length)return{docJson:n,added:0};let s=[];for(let c of i){let d=String(c?.sectionId||c?.id||"").trim();if(!d||o.has(d))continue;let l=hc({sectionId:d,text:c?.text||""});l&&s.push(l)}return s.length?{docJson:{...n,type:n.type||"doc",content:[...s,...r]},added:s.length}:{docJson:n,added:0}}function Wh(e,t){try{let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return 1;let o=window.localStorage.getItem(Ku)||"",i=o?JSON.parse(o):{},s=i&&typeof i=="object"?i:{},c=(s[n]&&typeof s[n]=="object"?s[n]:{})||{},l=(Number(c[r]||0)||0)+1;return c[r]=l,s[n]=c,window.localStorage.setItem(Ku,JSON.stringify(s)),l}catch{return Date.now()}}async function Yh(){let e=fs();if(!e.length)return{status:"empty"};let t=e.slice().sort((r,o)=>Date.parse(String(r?.createdAt||""))-Date.parse(String(o?.createdAt||""))),n=0;for(let r of t){let o=String(r?.sectionId||r?.id||"").trim(),i=String(r?.text||"").trim();if(!o||!i)continue;let s=hc({sectionId:o,text:i});if(!s)continue;let c=s.content?.[0]||{type:"outlineHeading",content:[]},d=s.content?.[1]||{type:"outlineBody",content:[{type:"paragraph"}]},l=Wh("inbox",o);await Nt("section_upsert_content",{articleId:"inbox",payload:{sectionId:o,headingJson:c,bodyJson:d,seq:l,opId:o},coalesceKey:`content:inbox:${o}`}),n+=1}return{status:"enqueued",count:n}}async function Xh(){let e=await fetch("/api/articles/inbox?include_history=0",{method:"GET",credentials:"include"});if(e.status===401||e.status===403){let t=new Error("auth");throw t.status=e.status,t}if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()}async function gc(){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return{status:"offline"};let e=await Xh(),t=new Date().toISOString();try{e?.docJson&&typeof e.docJson=="object"&&await ln("inbox",e.docJson,t)}catch{}return{status:"refreshed",updatedAt:e?.updatedAt||null,docJson:e?.docJson||null}}var Ju,Ku,ao=Fe(()=>{vo();Io();Ju="ttree_pending_quick_notes_v1",Ku="ttree_outline_section_seq_v1"});var tf={};Vn(tf,{flushOutboxOnce:()=>lo,getBackgroundFullPullStatus:()=>xc,startBackgroundFullPull:()=>Qo,startSyncLoop:()=>Ac,tryPullBootstrap:()=>kc});function Gh(e,t=null){try{if(!e)return;let n=window.localStorage.getItem(ms)||"";if(!n)return;let r=JSON.parse(n);if(!r||typeof r!="object")return;let o=String(e),i=r[o]||null;if(!i)return;let s=Number(i?.queuedAt||0)||0,c=typeof t=="number"&&Number.isFinite(t)?t:null;if(c!=null&&s>c)return;delete r[o],window.localStorage.setItem(ms,JSON.stringify(r))}catch{}}function eg(e,t){try{let n=e&&typeof e=="object"?e:{type:"doc",content:[]},r=Array.isArray(n.content)?n.content:[],o=new Map,i=u=>{if(Array.isArray(u))for(let f of u){if(!f||typeof f!="object"||f.type!=="outlineSection")continue;let p=String(f?.attrs?.id||"").trim();p&&o.set(p,f);let b=(Array.isArray(f.content)?f.content:[]).find(h=>h&&typeof h=="object"&&h.type==="outlineChildren")||null;b&&Array.isArray(b.content)&&i(b.content)}};i(r);let s=(u,f)=>{let p=u&&typeof u=="object"?u:{type:"outlineSection",attrs:{id:f,collapsed:!1},content:[]};p.type="outlineSection";let y=p.attrs&&typeof p.attrs=="object"?p.attrs:{};y.id=f,p.attrs=y;let b=Array.isArray(p.content)?p.content:[],h=b.find(S=>S&&typeof S=="object"&&S.type==="outlineHeading")||{type:"outlineHeading",content:[]},g=b.find(S=>S&&typeof S=="object"&&S.type==="outlineBody")||{type:"outlineBody",content:[{type:"paragraph"}]},w=b.find(S=>S&&typeof S=="object"&&S.type==="outlineChildren")||{type:"outlineChildren",content:[]};return Array.isArray(w.content)||(w={...w,content:[]}),p.content=[h,g,w],p},c=new Set,d=new Map;for(let u of Array.isArray(t)?t:[]){let f=String(u?.sectionId||"").trim();if(!f)continue;let p=u?.parentId,y=p!=null&&String(p).trim()?String(p).trim():null,b=Number.isFinite(Number(u?.position))?Number(u.position):0,h=!!u?.collapsed,g=s(o.get(f),f);g.attrs={...g.attrs||{},id:f,collapsed:h},o.set(f,g),c.add(f),d.has(y)||d.set(y,[]),d.get(y).push({pos:b,sid:f,sec:g})}for(let[u,f]of d.entries())f.sort((p,y)=>p.pos-y.pos||String(p.sid).localeCompare(String(y.sid))),d.set(u,f);for(let[u,f]of o.entries()){let y=(d.get(u)||[]).map(b=>b.sec);try{Array.isArray(f.content)||(f.content=[]),(!f.content[2]||f.content[2].type!=="outlineChildren")&&(f.content[2]={type:"outlineChildren",content:[]}),f.content[2].content=y}catch{}}let l=(d.get(null)||[]).map(u=>u.sec);for(let[u,f]of o.entries())c.has(u)||l.push(f);return n.type="doc",n.content=l,n}catch{return e}}function tg(e,t,n,r){try{let o=String(t||"").trim();if(!o)return e;let i=e&&typeof e=="object"?e:{type:"doc",content:[]},s=[i];for(;s.length;){let c=s.pop();if(!c||typeof c!="object")continue;if(c.type==="outlineSection"&&String(c?.attrs?.id||"").trim()===o){let u=(Array.isArray(c.content)?c.content:[]).find(f=>f&&typeof f=="object"&&f.type==="outlineChildren")||{type:"outlineChildren",content:[]};return c.content=[n,r,u],i}let d=c.content;if(Array.isArray(d))for(let l of d)s.push(l)}return i}catch{return e}}function Sc(e){let t=e?.type||"";return t==="section_upsert_content"||t==="delete_sections"||t==="structure_snapshot"}function ng(e,t,n){try{let r=String(e||"").trim(),o=String(t||"").trim(),i=Number(n);if(!r||!o||!Number.isFinite(i)||i<=0)return;let s="ttree_outline_section_seq_v1",c=window.localStorage.getItem(s)||"",d=c?JSON.parse(c):{},l=d&&typeof d=="object"?d:{},u=(l[r]&&typeof l[r]=="object"?l[r]:{})||{};if((Number(u[o]||0)||0)>=i)return;u[o]=i,l[r]=u,window.localStorage.setItem(s,JSON.stringify(l))}catch{}}function rg(e){let t=[],n=(i,s)=>{if(!Array.isArray(i))return;let c=0;for(let d of i){if(!d||typeof d!="object"||d.type!=="outlineSection")continue;let l=String(d?.attrs?.id||"").trim();if(!l)continue;t.push({sectionId:l,parentId:s||null,position:c,collapsed:!!d?.attrs?.collapsed}),c+=1;let f=(Array.isArray(d.content)?d.content:[]).find(y=>y&&typeof y=="object"&&y.type==="outlineChildren")||null,p=f&&Array.isArray(f.content)?f.content:[];n(p,l)}},r=e&&typeof e=="object"?e:null,o=r&&Array.isArray(r.content)?r.content:[];return n(o,null),t}function og(e,t){try{let n=e&&typeof e=="object"?{...e}:null;if(!n||n.type!=="outlineHeading")return e;let r=String(t||"");if(!r)return e;let o=Array.isArray(n.content)?[...n.content]:[];return o.unshift({type:"text",text:r}),n.content=o,n}catch{return e}}function ig(e,t,n){let r=e&&typeof e=="object"?e:{type:"doc",content:[]};Array.isArray(r.content)||(r.content=[]);let o=String(t||"").trim(),i=c=>{for(let d=0;d<c.length;d+=1){let l=c[d];if(!l||typeof l!="object"||l.type!=="outlineSection")continue;let u=String(l?.attrs?.id||"").trim();if(o&&u===o)return c.splice(d+1,0,n),!0;let p=(Array.isArray(l.content)?l.content:[]).find(y=>y&&typeof y=="object"&&y.type==="outlineChildren")||null;if(p&&Array.isArray(p.content)&&i(p.content))return!0}return!1};return i(r.content)||r.content.push(n),r}function sg(){try{return window?.localStorage?.getItem?.("ttree_debug_offline_v1")==="1"}catch{return!1}}function Qu(...e){try{if(!sg())return;console.log("[offline][queue]",...e)}catch{}}function ef(){try{let e=window.localStorage.getItem(ms)||"";if(!e)return{changed:!1,removed:0};let t=JSON.parse(e);if(!t||typeof t!="object")return{changed:!1,removed:0};let n=Object.keys(t);if(!n.length)return{changed:!1,removed:0};let r=0;for(let o of n)o!=="inbox"&&(delete t[o],r+=1);return r?(window.localStorage.setItem(ms,JSON.stringify(t)),Qu("prune.queue",{removed:r}),{changed:!0,removed:r}):{changed:!1,removed:0}}catch(e){return Qu("prune.queue.error",{message:e?.message||String(e||"error")}),{changed:!1,removed:0}}}function co(){try{window.dispatchEvent(new CustomEvent("offline-full-pull-status",{detail:{...Yt}}))}catch{}}function xc(){return{...Yt}}async function pn(e,t={}){let n=await fetch(e,{headers:{"Content-Type":"application/json",...t.headers||{}},credentials:"include",...t});if(!n.ok){let r=await n.json().catch(()=>({})),o=new Error(r.detail||"Request failed");throw o.status=n.status,o.details=r,o.path=e,o}return n.status===204?null:n.json()}function Zu(e){let t=Number(e?.status||0);return!t||t>=500||t===408||t===429||t===401||t===403}function ag(e,t){let n=Number(e?.status||0);return n===404||n===410?!0:n>=400&&n<500&&n!==401&&n!==403&&n!==408&&n!==429?t?.type==="save_doc_json"||String(t?.type||"").startsWith("section_")||t?.type==="structure_snapshot"||t?.type==="delete_sections":!1}async function kc(){try{let e=await yn();return Kn(e).catch(()=>{}),Array.isArray(e)?e:[]}catch{return null}}function cg(e,t){try{let n=new Set((Array.isArray(t)?t:[]).map(i=>String(i||"").trim()).filter(Boolean));if(!n.size)return e;let r=e&&typeof e=="object"?e:{type:"doc",content:[]},o=i=>{if(!Array.isArray(i))return[];let s=[];for(let c of i)if(!(!c||typeof c!="object")){if(c.type==="outlineSection"){let d=String(c?.attrs?.id||"").trim();if(d&&n.has(d))continue;let u=(Array.isArray(c.content)?c.content:[]).find(f=>f&&typeof f=="object"&&f.type==="outlineChildren")||null;u&&Array.isArray(u.content)&&(u.content=o(u.content))}s.push(c)}return s};return Array.isArray(r.content)?r.content=o(r.content):r.content=[],r.type=r.type||"doc",r}catch{return e}}async function lg(e){if(e.type==="create_article"){let t=e.payload?.title||"\u041D\u043E\u0432\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F",n=e.payload?.id||e.articleId,r=await pn("/api/articles",{method:"POST",body:JSON.stringify({title:t,id:n})});await Cr(r);return}if(e.type==="save_doc_json"){let t=e.payload?.docJson||null;if(!t||typeof t!="object")return;let n=await pn(`/api/articles/${encodeURIComponent(e.articleId)}/doc-json/save`,{method:"PUT",body:JSON.stringify({docJson:t,createVersionIfStaleHours:12})}),r=n?.updatedAt||null;await ln(e.articleId,t,r);try{at("sync.flush.save_doc_json.ok",{articleId:e.articleId,opId:e.id,updatedAt:r,docHash:Rt(t)})}catch{}try{let o=Array.isArray(n?.changedBlockIds)?n.changedBlockIds:[],i=Array.isArray(n?.removedBlockIds)?n.removedBlockIds:[];if(i.length&&await Ei(i),o.length){let s=await pn(`/api/articles/${encodeURIComponent(e.articleId)}/embeddings?ids=${encodeURIComponent(o.join(","))}`);await ca(e.articleId,s?.embeddings||[])}}catch{}return}if(e.type==="section_upsert_content"){let t=e.payload?.sectionId||null,n=e.payload?.headingJson||null,r=e.payload?.bodyJson||null,o=e.payload?.seq||null;if(!t||!n||!r||!o)return;let i=await pn(`/api/articles/${encodeURIComponent(e.articleId)}/sections/upsert-content`,{method:"PUT",body:JSON.stringify({opId:e.payload?.opId||e.id,sectionId:t,headingJson:n,bodyJson:r,seq:o,createVersionIfStaleHours:12})});try{if(i?.updatedAt){let s=await Jn(e.articleId).catch(()=>null),c=s?.docJson&&typeof s.docJson=="object"?s.docJson:null;if(c){let d=tg(c,t,n,r);await ln(e.articleId,d,i.updatedAt)}}try{at("sync.flush.section_upsert_content.ok",{articleId:e.articleId,opId:e.id,sectionId:t,updatedAt:i?.updatedAt||null})}catch{}}catch{}return}if(e.type==="structure_snapshot"){let t=e.payload?.nodes||null;if(!Array.isArray(t)||!t.length)return;let n=await pn(`/api/articles/${encodeURIComponent(e.articleId)}/structure/snapshot`,{method:"PUT",body:JSON.stringify({opId:e.payload?.opId||e.id,nodes:t})});try{if(n?.updatedAt){let r=await Jn(e.articleId).catch(()=>null),o=r?.docJson&&typeof r.docJson=="object"?r.docJson:null;if(o){let i=eg(o,t);await ln(e.articleId,i,n.updatedAt)}}try{at("sync.flush.structure_snapshot.ok",{articleId:e.articleId,opId:e.id,updatedAt:n?.updatedAt||null,nodesCount:Array.isArray(t)?t.length:null})}catch{}}catch{}return}if(e.type==="delete_sections"){let t=Array.isArray(e.payload?.sectionIds)?e.payload.sectionIds:[];if(!t.length)return;let n=await nd(e.articleId,t,{opId:e.payload?.opId||e.id});try{let r=n?.updatedAt||null,o=await Jn(e.articleId).catch(()=>null),i=o?.docJson&&typeof o.docJson=="object"?o.docJson:null;if(i&&r){let c=cg(i,t);await ln(e.articleId,c,r)}let s=Array.isArray(n?.removedBlockIds)?n.removedBlockIds:[];s.length&&await Ei(s),at("sync.flush.delete_sections.ok",{articleId:e.articleId,opId:e.id,updatedAt:r||null,sectionIdsCount:t.length,removedCount:s.length})}catch{}return}if(e.type==="move_article_position"){let t=e.payload?.direction||null;if(!t)return;await pn(`/api/articles/${encodeURIComponent(e.articleId)}/move`,{method:"POST",body:JSON.stringify({direction:t})});return}if(e.type==="indent_article"){await pn(`/api/articles/${encodeURIComponent(e.articleId)}/indent`,{method:"POST",body:JSON.stringify({})});return}if(e.type==="outdent_article"){await pn(`/api/articles/${encodeURIComponent(e.articleId)}/outdent`,{method:"POST",body:JSON.stringify({})});return}if(e.type==="move_article_tree"){await pn(`/api/articles/${encodeURIComponent(e.articleId)}/move-tree`,{method:"POST",body:JSON.stringify(e.payload||{})});return}}async function dg(e){try{if(!e||!e.articleId||!(e.type==="save_doc_json"||e.type==="section_upsert_content"||e.type==="structure_snapshot"||e.type==="delete_sections"))return;let n=e.payload?.clientQueuedAt??null;if(typeof n!="number"||!Number.isFinite(n)||(await Br(500)||[]).some(i=>i&&i.articleId===e.articleId&&(i.type==="save_doc_json"||i.type==="section_upsert_content"||i.type==="structure_snapshot")&&(i.payload?.clientQueuedAt??null)===n))return;Gh(e.articleId,n)}catch{}}async function ug(e,t){let n=String(e||"").trim();if(n)for(let r of t||[])try{let o=String(r?.sectionId||"").trim(),i=r?.headingJson||null,s=r?.bodyJson||null;if(!o||!i||!s)continue;let c=globalThis.crypto?.randomUUID?.()||`conflict-${Date.now()}-${Math.random().toString(16).slice(2)}`,d=await Jn(n).catch(()=>null),l=d?.docJson&&typeof d.docJson=="object"?d.docJson:null,u=og(i,"\u041A\u043E\u043D\u0444\u043B\u0438\u043A\u0442\u043D\u0430\u044F \u043A\u043E\u043F\u0438\u044F: "),p=ig(l||{type:"doc",content:[]},o,{type:"outlineSection",attrs:{id:c,collapsed:!1,isConflictCopy:!0},content:[u||{type:"outlineHeading",content:[]},s||{type:"outlineBody",content:[{type:"paragraph"}]},{type:"outlineChildren",content:[]}]});await ln(n,p,d?.updatedAt||null).catch(()=>{}),ng(n,c,1);let y=Date.now();await Nt("section_upsert_content",{articleId:n,payload:{sectionId:c,headingJson:u,bodyJson:s,seq:1,clientQueuedAt:y},coalesceKey:`content:${n}:${c}`}).catch(()=>{});let b=rg(p);b.length&&await Nt("structure_snapshot",{articleId:n,payload:{nodes:b,clientQueuedAt:y},coalesceKey:`structure:${n}`}).catch(()=>{});try{window.dispatchEvent(new CustomEvent("outline-sync-conflict",{detail:{articleId:n,sectionId:o,conflictCopySectionId:c}}))}catch{}}catch{}}async function fg(e,t){let n=String(e||"").trim();if(!n)return;let r=Date.now(),o=Number(Xu.get(n)||0)||0;if(o&&r-o<Qh)return;Xu.set(n,r);let i=async()=>{let h=await Br(200),g=[],w=[],S=[];for(let x of h||[])!x||String(x.articleId||"")!==n||(x.type==="delete_sections"?g.push(x):x.type==="section_upsert_content"?w.push(x):x.type==="structure_snapshot"&&S.push(x));return{deleteOps:g,upsertOps:w,structureOps:S}},s=0,c=[],d=[],l=[];try{({deleteOps:c,upsertOps:d,structureOps:l}=await i())}catch{c=[],d=[],l=[];for(let h of t||[])!h||String(h.articleId||"")!==n||(h.type==="delete_sections"?c.push(h):h.type==="section_upsert_content"?d.push(h):h.type==="structure_snapshot"&&l.push(h))}let u=new Set;for(let h of c){let g=Array.isArray(h.payload?.sectionIds)?h.payload.sectionIds:[];for(let w of g){let S=String(w||"").trim();S&&u.add(S)}}if(u.size&&d.length)for(let h of d)try{let g=String(h.payload?.sectionId||"").trim();g&&u.has(g)&&await pr(h.id)}catch{}let f=c.map(h=>{let g=Array.isArray(h.payload?.sectionIds)?h.payload.sectionIds:[];return{opId:h.payload?.opId||h.id,sectionIds:g.filter(Boolean).map(w=>String(w)),_outboxId:h.id}}).filter(h=>h.sectionIds.length),p=d.map(h=>{let g=String(h.payload?.sectionId||"").trim();return!g||u.has(g)?null:{opId:h.payload?.opId||h.id,sectionId:g,headingJson:h.payload?.headingJson||null,bodyJson:h.payload?.bodyJson||null,seq:h.payload?.seq||null,clientQueuedAt:h.payload?.clientQueuedAt??null,_outboxId:h.id}}).filter(Boolean),y=async()=>{let h=c.map($=>{let U=Array.isArray($.payload?.sectionIds)?$.payload.sectionIds:[];return{opId:$.payload?.opId||$.id,sectionIds:U.filter(Boolean).map(Y=>String(Y)),_outboxId:$.id}}).filter($=>$.sectionIds.length),g=d.map($=>{let U=String($.payload?.sectionId||"").trim();return!U||u.has(U)?null:{opId:$.payload?.opId||$.id,sectionId:U,headingJson:$.payload?.headingJson||null,bodyJson:$.payload?.bodyJson||null,seq:$.payload?.seq||null,clientQueuedAt:$.payload?.clientQueuedAt??null,_outboxId:$.id}}).filter(Boolean),w=new Map;for(let $ of h)w.set(String($.opId),$._outboxId);for(let $ of g)w.set(String($.opId),$._outboxId);if(!h.length&&!g.length)return!1;try{at("sync.flush.outline_compact.start",{articleId:n,deletesCount:h.length,upsertsCount:g.length})}catch{}let S=await pn(`/api/articles/${encodeURIComponent(n)}/sync/compact`,{method:"PUT",body:JSON.stringify({deletes:h.map(({opId:$,sectionIds:U})=>({opId:$,sectionIds:U})),upserts:g.map(({opId:$,sectionId:U,headingJson:Y,bodyJson:J,seq:re})=>({opId:$,sectionId:U,headingJson:Y,bodyJson:J,seq:re}))})}),x=S?.updatedAt||null;x&&await ia(n,x).catch(()=>{});try{at("sync.flush.outline_compact.ok",{articleId:n,updatedAt:x||null,deleteAcks:Array.isArray(S?.deleteAcks)?S.deleteAcks.length:null,upsertAcks:Array.isArray(S?.upsertAcks)?S.upsertAcks.length:null})}catch{}let T=Array.isArray(S?.deleteAcks)?S.deleteAcks:[];for(let $ of T){let U=String($?.opId||"").trim();if(!U)continue;let Y=w.get(U)||U;await pr(Y).catch(()=>{});try{let J=Array.isArray($?.removedBlockIds)?$.removedBlockIds:[];J.length&&await Ei(J)}catch{}}let N=[],B=Array.isArray(S?.upsertAcks)?S.upsertAcks:[];for(let $ of B){let U=String($?.opId||"").trim(),Y=String($?.sectionId||"").trim();if(!U||!Y)continue;let J=w.get(U)||U,re=String($?.result||"").trim();if(re==="ok"||re==="duplicate")await pr(J).catch(()=>{});else if(re==="conflict"){await pr(J).catch(()=>{});let he=g.find(Re=>String(Re.opId)===U)||null;he&&N.push({sectionId:Y,headingJson:he.headingJson,bodyJson:he.bodyJson})}}return N.length&&await ug(n,N),!0};for(;s<2&&(s+=1,!!await y());)try{({deleteOps:c,upsertOps:d,structureOps:l}=await i())}catch{break}let b=null;try{({deleteOps:c,upsertOps:d,structureOps:l}=await i())}catch{}if(!c.length&&!d.length&&(b=l.length?l[l.length-1]:null),b){try{let g=Number(Gu.get(n)||0)||0,w=Date.now();if(g&&w-g<Zh)return}catch{}let h=b.payload?.nodes||null;if(Array.isArray(h)&&h.length){let g=await Jn(n).catch(()=>null),w=null;try{if(g&&Object.prototype.hasOwnProperty.call(g,"outlineStructureRev")){let N=Number(g.outlineStructureRev);Number.isFinite(N)&&N>=0&&(w=N)}}catch{w=null}try{at("sync.flush.structure_snapshot.start",{articleId:n,opId:b.id,baseStructureRev:w,nodesCount:h.length})}catch{}let S=await pn(`/api/articles/${encodeURIComponent(n)}/structure/snapshot`,{method:"PUT",body:JSON.stringify({opId:b.payload?.opId||b.id,nodes:h,...w!=null?{baseStructureRev:w}:{}})}),x=S?.updatedAt||null;x&&await ia(n,x).catch(()=>{}),Number.isFinite(Number(S?.newStructureRev))?await sa(n,Number(S.newStructureRev)):Number.isFinite(Number(S?.currentStructureRev))&&await sa(n,Number(S.currentStructureRev));try{at("sync.flush.structure_snapshot.done",{articleId:n,opId:b.id,status:String(S?.status||""),updatedAt:x||null,newStructureRev:Number.isFinite(Number(S?.newStructureRev))?Number(S.newStructureRev):null,currentStructureRev:Number.isFinite(Number(S?.currentStructureRev))?Number(S.currentStructureRev):null})}catch{}let T=String(S?.status||"");if(T==="ok"||T==="duplicate"){await pr(b.id).catch(()=>{});try{Gu.set(n,Date.now())}catch{}}}}try{(await Br(200)||[]).some(w=>Sc(w)&&String(w.articleId||"")===n)||(await Ml(n).catch(()=>{}),at("sync.flush.localDraft.cleared",{articleId:n}))}catch{}}async function lo(){if(yc)return null;if(!navigator.onLine)return!1;yc=!0;try{let e=await Br(200),t=new Set,n=[];for(let o of e||[]){if(!Sc(o))continue;let i=String(o.articleId||"").trim();!i||t.has(i)||(t.add(i),n.push(i))}for(let o of n)try{await fg(o,e)}catch(i){if(Zu(i))break}let r=await Br(50);for(let o of r)if(!Sc(o))try{await lg(o),await pr(o.id);try{if(o.type==="section_upsert_content"&&String(o.articleId||"")==="inbox"){let i=String(o.payload?.sectionId||"").trim();i&&mc(i)}}catch{}await dg(o)}catch(i){let s=Number(i?.status||0)||null,c=s?`${s}: ${i?.message||"error"}`:i?.message||String(i||"error");if(await Pl(o.id,c),ag(i,o)){try{console.warn("[offline][outbox] drop op",{opId:o.id,type:o.type,articleId:o.articleId,status:s,message:i?.message||null})}catch{}try{await pr(o.id)}catch{}continue}if(Zu(i))break;break}}finally{yc=!1}try{let e=await Br(1);return Array.isArray(e)&&e.length>0}catch{return!0}}function Go(){_r||(_r=window.setInterval(async()=>{try{await lo()===!1&&(window.clearInterval(_r),_r=null,ef())}catch{}},15e3))}function wc(){_r&&(window.clearInterval(_r),_r=null)}function Ac(){if(!Wu){Wu=!0,ef();try{Ai()}catch{}window.addEventListener("online",()=>{lo().then(e=>{e?Go():wc()}).catch(()=>{})}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&lo().then(e=>{e?Go():wc()}).catch(()=>{})}),window.addEventListener("offline-outbox-changed",()=>{lo().then(e=>{e?Go():wc()}).catch(()=>{Go()})}),lo().then(e=>{e&&Go()}).catch(()=>{})}}function Qo(e={}){let t=!!(e&&e.force);bc||Yu&&!t||(Yu=!0,bc=!0,Yt={running:!0,processed:0,total:0,errors:0,phase:"index",lastError:null,startedAt:new Date().toISOString(),finishedAt:null},co(),(async()=>{try{if(!navigator.onLine){Yt={...Yt,running:!1,phase:"error",lastError:"offline",finishedAt:new Date().toISOString()},co();return}let n=new Map;try{let o=await Bl();n=new Map((o||[]).map(i=>[i.id,i]))}catch{}let r=[];try{Array.isArray(e?.initialIndex)?r=e.initialIndex:r=await pn("/api/articles")||[],Kn(r).catch(()=>{})}catch(o){Yt={...Yt,running:!1,phase:"error",lastError:o?.message||String(o||"error"),finishedAt:new Date().toISOString()},co();return}Yt={...Yt,phase:"articles",total:Array.isArray(r)?r.length:0},co();for(let o of r||[]){try{let i=o.updatedAt||null,s=n.get(o.id);if(i&&s?.updatedAt===i&&s?.hasDocJson){try{let d=await Jn(o.id),l=d?.docJson&&typeof d.docJson=="object"?d.docJson:null;l&&Wr(o.id,l).catch(()=>{})}catch{}continue}let c=await pn(`/api/articles/${encodeURIComponent(o.id)}`);await Cr(c);try{let d=await pn(`/api/articles/${encodeURIComponent(o.id)}/embeddings`);await ca(o.id,d?.embeddings||[])}catch{}}catch{Yt={...Yt,errors:Number(Yt.errors||0)+1}}Yt={...Yt,processed:Number(Yt.processed||0)+1},co(),await new Promise(i=>setTimeout(i,120))}Cl().catch(()=>{}),Yt={...Yt,running:!1,phase:"done",finishedAt:new Date().toISOString()},co()}finally{bc=!1}})().catch(()=>{}))}var ms,Wu,yc,Yu,bc,_r,Qh,Xu,Zh,Gu,Yt,hs=Fe(()=>{Io();vo();la();ko();Pt();ao();Ao();ms="ttree_outline_autosave_queue_docjson_v1";Wu=!1,yc=!1,Yu=!1,bc=!1,_r=null,Qh=2e3,Xu=new Map,Zh=3e3,Gu=new Map;Yt={running:!1,processed:0,total:0,errors:0,phase:"idle",lastError:null,startedAt:null,finishedAt:null}});var sr={};Vn(sr,{closeOutlineEditor:()=>jf,enterOutlineSectionEditMode:()=>gy,flushOutlineAutosave:()=>Sy,getOutlineActiveSectionId:()=>ly,getOutlineActiveSectionSnapshot:()=>dy,insertNewOutlineSectionAtEnd:()=>hy,insertNewOutlineSectionAtStart:()=>yy,insertOutlineSectionFromPlainTextAtStart:()=>by,insertOutlineSectionFromSectionFragmentsAtEnd:()=>my,openOutlineEditor:()=>wy,openPublicOutlineViewer:()=>xy,restoreOutlineSectionFromBlockHtml:()=>fy,restoreOutlineSectionFromSectionFragments:()=>py,revealOutlineSection:()=>Jf});function _c(e,t){let n=null,r=String(t||"").trim();return!e||!r?null:(e.descendants((o,i)=>{if(n!==null)return!1;o?.type?.name==="image"&&String(o.attrs?.uploadToken||"")===r&&(n=i)}),n)}function Af(e){let t=String(e||"").trim();if(!t)return;let n=oi.get(t)||null;if(n){oi.delete(t);try{URL.revokeObjectURL(n)}catch{}}}function hg(e){try{if(!e||typeof e!="object")return e;let t=typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e)),n=r=>{if(!r||typeof r!="object")return;if(r.type==="image"&&r.attrs&&typeof r.attrs=="object"){let i=String(r.attrs.uploadToken||"").trim(),s=String(r.attrs.src||"");i&&s.startsWith("blob:")&&(r.attrs={...r.attrs,src:`${Dc}${i}`})}let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(t),t}catch{return e}}async function gg(e){try{if(!oe||oe.isDestroyed)return;let t=String(e||"").trim();if(!t)return;let n=await fc({articleId:t,limit:200}).catch(()=>[]);if(!n.length)return;let r=new Map;for(let d of n){let l=String(d?.token||"").trim();l&&(d?.kind&&String(d.kind)!=="image"||d?.blob&&r.set(l,d.blob))}if(!r.size)return;let{state:o,view:i}=oe,s=o.tr,c=!1;o.doc.descendants((d,l)=>{if(d?.type?.name!=="image")return;let u=String(d.attrs?.uploadToken||"").trim(),f=String(d.attrs?.src||""),p=f.startsWith(Dc)?f.slice(Dc.length).trim():"",y=u||p;if(!y)return;let b=r.get(y);if(!b)return;let h=oi.get(y)||null;if(!h)try{h=URL.createObjectURL(b),oi.set(y,h)}catch{h=null}if(!h)return;let g={...d.attrs,src:h,uploadToken:y};s=s.setNodeMarkup(l,void 0,g),c=!0}),c&&(s=s.setMeta(ce,!0),i.dispatch(s))}catch{}}async function If(e){try{if(!navigator.onLine||!oe||oe.isDestroyed)return!1;let t=String(e||"").trim();if(!t)return!1;let n=await fc({articleId:t,limit:50}).catch(()=>[]);if(!n.length)return!1;let r=!1;for(let o of n){let i=String(o?.token||"").trim();if(!i||o?.kind&&String(o.kind)!=="image")continue;let s=o?.blob||null;if(s)try{let c=s instanceof File?s:new File([s],o?.fileName||"image",{type:o?.mime||s.type||"application/octet-stream"}),d=await Co(c),l=String(d?.url||"").trim();if(!l)throw new Error("Upload failed");try{let{state:u,view:f}=oe,p=_c(u.doc,i);if(typeof p=="number"){let y=u.doc.nodeAt(p);if(y?.type?.name==="image"){let b={...y.attrs,src:l,uploadToken:null,title:String(y.attrs?.title||"").replace(/\s*\( \)\s*$/i,"").trim()},h=u.tr.setNodeMarkup(p,void 0,b);h=h.setMeta(ce,!0),f.dispatch(h)}}}catch{}Af(i),await dc(i).catch(()=>{}),r=!0}catch(c){let d=c?.message||String(c||"error");await uc(i,d).catch(()=>{})}}if(r)try{sn({delayMs:350})}catch{}return r}catch{return!1}}function sf(){try{let e=window?.localStorage?.getItem?.(Pc)||"";if(!e)return null;let t=JSON.parse(e);return!t||typeof t!="object"||!Array.isArray(t.sections)?null:{mode:t.mode==="cut"?"cut":"copy",sourceArticleId:typeof t.sourceArticleId=="string"?t.sourceArticleId:null,createdAt:typeof t.createdAt=="string"?t.createdAt:null,sections:t.sections}}catch{return null}}function Ec(e){try{if(!e){window?.localStorage?.removeItem?.(Pc);return}window?.localStorage?.setItem?.(Pc,JSON.stringify(e))}catch{}}function ti(e){ir=!!e,ir||(Ar=new Set);try{m?.outlineEditor&&m.outlineEditor.classList.toggle("outline-select-mode",ir)}catch{}try{vf()}catch{}}function yg(e){let t=String(e||"").trim();if(t){Ar.has(t)?Ar.delete(t):Ar.add(t);try{vf()}catch{}}}function vf(){if(!m?.outlineEditor)return;m.outlineEditor.querySelectorAll(".outline-heading[data-section-id] .outline-heading__select").forEach(t=>{let r=t.closest(".outline-heading")?.getAttribute?.("data-section-id")||"",o=r&&Ar.has(r);t.setAttribute("aria-checked",o?"true":"false"),t.style.display=ir?"inline-flex":"none"})}function bg(e,t){let n=t instanceof Set?t:new Set,r=[];if(!e||!n.size)return r;let o=(i,s)=>{let c=String(i?.attrs?.id||"").trim(),d=c&&n.has(c);if(d&&!s){r.push({id:c,node:i});return}let l=i?.childCount>=3?i.child(2):null;if(l)try{l.forEach(u=>{u?.type?.name==="outlineSection"&&o(u,s||d)})}catch{}};try{e.forEach(i=>{i?.type?.name==="outlineSection"&&o(i,!1)})}catch{}return r}function Ef(e){return JSON.parse(JSON.stringify(e))}function wg(e,t){let n=Ef(e),r=o=>{if(!o||typeof o!="object")return;if(o.type==="outlineSection"){let s=t();o.attrs&&typeof o.attrs=="object"?o.attrs.id=s:o.attrs={id:s,collapsed:!!o.attrs?.collapsed}}let i=Array.isArray(o.content)?o.content:[];for(let s of i)r(s)};return r(n),n}async function Sg(e){let t=String(e||"");if(t){try{if(navigator?.clipboard?.writeText){await navigator.clipboard.writeText(t);return}}catch{}try{let n=document.createElement("textarea");n.value=t,n.setAttribute("readonly","true"),n.style.position="fixed",n.style.left="-9999px",n.style.top="0",document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n)}catch{}}}function Tf(e,{baseLevel:t=2,depth:n=0}={}){let r=e;if(!r||r.type?.name!=="outlineSection")return"";let o="",i="";try{let d=r.child(0);o=String(d?.textContent||"").trim()}catch{o=""}try{let d=r.child(1);i=d?String(d.textBetween(0,d.content.size,`
`)).trimEnd():""}catch{i=""}let s=Math.min(6,Math.max(1,Number(t)+Number(n||0))),c=[];o&&c.push(`${"#".repeat(s)} ${o}`),i&&c.push(i);try{let d=r.child(2);if(d){let l=[];d.forEach(u=>{if(u?.type?.name!=="outlineSection")return;let f=Tf(u,{baseLevel:t,depth:n+1});f&&l.push(f)}),l.length&&c.push(l.join(`

`))}}catch{}return c.filter(Boolean).join(`

`).trim()}function Cf(e,t){try{let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return 1;let o=window.localStorage.getItem(af)||"",i=o?JSON.parse(o):{},s=i&&typeof i=="object"?i:{},c=(s[n]&&typeof s[n]=="object"?s[n]:{})||{},l=(Number(c[r]||0)||0)+1;return c[r]=l,s[n]=c,window.localStorage.setItem(af,JSON.stringify(s)),l}catch{return Date.now()}}function Bf(e,t){try{let n=JSON.stringify({headingJson:e,bodyJson:t});return globalThis.TextEncoder?new TextEncoder().encode(n).length:n.length*2}catch{return 0}}function uo(e){try{let t=String(e||"").trim();if(!t)return;kn.add(t);let n=Lt||a.articleId||null;if(!n||a.article?.encrypted||Tc)return;Tc=setTimeout(()=>{Tc=null;try{if(!kn.size)return;let r=Array.from(kn);kn.clear();let o=Date.now();Nt("delete_sections",{articleId:n,payload:{sectionIds:r,clientQueuedAt:o},coalesceKey:`delete:${n}`})}catch{}},0)}catch{}}function si(e){let t=[],n=o=>{try{if(!o||o.type?.name!=="outlineSection")return null;for(let i=0;i<o.childCount;i+=1){let s=o.child(i);if(s?.type?.name==="outlineChildren")return s}return null}catch{return null}},r=(o,i)=>{try{if(!o)return;let s=0;o.forEach(c=>{if(!c||c.type?.name!=="outlineSection")return;let d=String(c.attrs?.id||"").trim();if(!d)return;t.push({sectionId:d,parentId:i||null,position:s,collapsed:!!c.attrs?.collapsed}),s+=1;let l=n(c);l&&r(l,d)})}catch{}};try{if(!e)return[];r(e,null)}catch{return[]}return t}function cf(e){try{return si(e).map(n=>`${n.parentId||""}|${n.position}|${n.sectionId}|${n.collapsed?1:0}`).join(`
`)}catch{return""}}function xg(e){let t=[];try{if(!e)return t;e.descendants((n,r)=>{n?.type?.name==="outlineSection"&&t.push(r)})}catch{}return t}function Oc(e,t){try{if(!e||e.isDestroyed)return!1;let n=!!t;return e.commands.command(({state:r,dispatch:o})=>{let i=xg(r.doc);if(!i.length)return!1;let s=r.tr;for(let c of i){let d=s.doc.nodeAt(c);!d||d.type?.name!=="outlineSection"||!!d.attrs?.collapsed!==n&&(s=s.setNodeMarkup(c,void 0,{...d.attrs,collapsed:n}))}s=s.setMeta(ce,!0);try{n&&Ae&&(Ae.getState(r)||{}).editingSectionId&&(s=s.setMeta(Ae,{type:"exit"}))}catch{}try{if(n&&TextSelection){let c=Bt(r.doc,r.selection.$from),d=typeof c=="number"?c:i[0],l=s.doc.nodeAt(d);if(l?.type?.name==="outlineSection"){let u=l.child(0),p=d+1+u.nodeSize-1;s=s.setSelection(TextSelection.near(s.doc.resolve(p),-1))}}}catch{}return o(s.scrollIntoView()),!0})}catch{return!1}}function kg({articleId:e,editor:t}={}){try{let n=String(e||"").trim();if(!n||!t)return;Fn=!0;try{if((Ae?.getState?.(t.state)||null)?.editingSectionId){$t&&(clearTimeout($t),$t=null);return}}catch{}$t&&clearTimeout($t),$t=setTimeout(()=>{$t=null;try{if(!Fn)return;let r=t.state?.doc,o=si(r);if(!o.length)return;try{let i=null;try{i=o.filter(s=>s&&(s.parentId==null||s.parentId==="")&&Number(s.position)>=0).sort((s,c)=>Number(s.position)-Number(c.position)).slice(0,3).map(s=>String(s.sectionId||""))}catch{i=null}at("outline.enqueue.structure_snapshot",{articleId:n,nodesCount:o.length,rootFirst:i})}catch{}Nt("structure_snapshot",{articleId:n,payload:{nodes:o},coalesceKey:`structure:${n}`}),Fn=!1}catch{}},pg)}catch{}}async function Lf({articleId:e,doc:t,sectionId:n,reason:r}){let o=String(e||"").trim(),i=String(n||"").trim();if(!o||!i||!t)return!1;let s=mt(t,i),c=typeof s=="number"?t.nodeAt(s):null;if(!c||c.type?.name!=="outlineSection")return!1;try{if(!Fr(t,i))return!1}catch{return!1}let d=c.child(0),l=c.child(1),u=d?.toJSON?d.toJSON():null,f=l?.toJSON?l.toJSON():null;if(!u||!f)return!1;let p=Bf(u,f);if(p>ks){let h=Date.now();return(!Ic||h-Ic>5e3)&&(Ic=h,L(`\u0411\u043B\u043E\u043A \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 (${Math.ceil(p/1024)} KB). \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C: ${Math.ceil(ks/1024)} KB. \u0420\u0430\u0437\u0431\u0435\u0439\u0442\u0435 \u0431\u043B\u043E\u043A \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E.`)),!1}let y=Date.now(),b=Cf(o,i);try{at("outline.enqueue.section_upsert_content",{articleId:o,sectionId:i,seq:b,bytes:p,reason:String(r||"")})}catch{}await Nt("section_upsert_content",{articleId:o,payload:{sectionId:i,headingJson:u,bodyJson:f,seq:b,clientQueuedAt:y},coalesceKey:`content:${o}:${i}`}).catch(()=>{});try{if(Fn){let h=si(t);if(h.length){let g=null;try{g=h.filter(w=>w&&(w.parentId==null||w.parentId==="")&&Number(w.position)>=0).sort((w,S)=>Number(w.position)-Number(S.position)).slice(0,3).map(w=>String(w.sectionId||""))}catch{g=null}try{at("outline.enqueue.structure_snapshot",{articleId:o,nodesCount:h.length,reason:"after_section_upsert",rootFirst:g})}catch{}Nt("structure_snapshot",{articleId:o,payload:{nodes:h},coalesceKey:`structure:${o}`})}Fn=!1,$t&&(clearTimeout($t),$t=null)}}catch{}try{Vr.set(i,Cs(c)),xr.delete(i)}catch{}try{Promise.resolve().then(()=>(hs(),tf)).then(h=>h.flushOutboxOnce?.()).catch(()=>{})}catch{}return!0}function Ag(e){try{if(!e||e.isDestroyed)return;let t=Ae?.getState?.(e.state)||null,n=String(t?.editingSectionId||"").trim();if(!n)return;let r=Lt||a.articleId||null;if(!r)return;Lc=n,Hr&&clearTimeout(Hr),Hr=setTimeout(()=>{Hr=null;try{if(!oe||oe.isDestroyed)return;let o=Ae?.getState?.(oe.state)||null,i=String(o?.editingSectionId||"").trim();if(!i||i!==Lc)return;Lf({articleId:r,doc:oe.state.doc,sectionId:i,reason:"edit_heartbeat"})}catch{}},mg)}catch{}}function Rc(){try{return window?.localStorage?.getItem?.(Ig)==="1"}catch{return!1}}function mn(...e){try{if(!Rc())return;console.log("[outline][md-table]",...e)}catch{}}function Rr(){try{return window?.localStorage?.getItem?.(vg)==="1"}catch{return!1}}function fo(e,t={}){try{if(!Rr())return;console.log("[perf][outline]",e,t)}catch{}}function Tg(){try{return window?.localStorage?.getItem?.(Eg)==="1"}catch{return!1}}function Yn(e,t={}){try{if(!Tg())return;console.log("[outline][proofread]",e,t)}catch{}}function Mf(e){let t=String(e||"").replace(/\s+/g," ").trim();return t?t.length>60?t.slice(0,60):t:null}function Nf(e){return String(e||"").replace(/\s+/g," ").trim().toUpperCase()}function Cg(e,t="tag"){let n=new Map,r=new Map,o=new Map,i=new Map;return e?(e.descendants((s,c)=>{if(s?.type?.name!=="outlineSection")return;let d=String(s.attrs?.id||"");d&&i.set(d,c);let l=new Set,u=f=>{f?.descendants?.(p=>{if(p?.type?.name!==t)return;let y=Mf(p.attrs?.label||p.textContent||"");if(!y)return;let b=Nf(p.attrs?.key||y);b&&(n.set(b,(n.get(b)||0)+1),r.set(b,b),l.add(b))})};try{u(s.child(0)),u(s.child(1))}catch{}if(d)for(let f of l)o.has(f)||o.set(f,new Set),o.get(f).add(d);return!1}),{counts:n,labelByKey:r,sectionIdsByKey:o,sectionPosById:i}):{counts:n,labelByKey:r,sectionIdsByKey:o,sectionPosById:i}}function Pf(){let e=m?.outlineTagsBar;if(!e)return;let t=Array.from(qr.counts.entries()).map(([n,r])=>({key:n,label:qr.labelByKey.get(n)||n,count:r})).filter(n=>n.key&&n.count>0).sort((n,r)=>r.count!==n.count?r.count-n.count:n.label.localeCompare(r.label));if(!t.length){e.innerHTML="",e.classList.add("hidden");return}e.classList.remove("hidden"),e.innerHTML=t.map(n=>{let r=kr&&kr===n.key?"true":"false",o=xf(n.label);return`<button type="button" class="outline-tag-pill" data-tag-key="${xf(n.key)}" aria-pressed="${r}">${o} <span class="outline-tag-pill__count">(${n.count})</span></button>`}).join("")}function Df(){if(oe){if(qr=Cg(oe.state.doc,"tag"),kr&&!qr.counts.has(kr)){kr=null;try{Is?.(null)}catch{}}Pf()}}function Bg(e){let t=String(e||"");if(!t||!oe)return;let n=qr.sectionIdsByKey.get(t);if(!n||!n.size)return;let r=new Set;for(let s of n){let c=qr.sectionPosById.get(s);if(typeof c=="number"){r.add(c);try{let d=oe.state.doc.resolve(Math.min(oe.state.doc.content.size,c+1));for(let l=d.depth;l>0;l-=1)d.node(l)?.type?.name==="outlineSection"&&r.add(d.before(l))}catch{}}}let o=oe.state.tr,i=!1;for(let s of r){let c=o.doc.nodeAt(s);!c||c.type?.name!=="outlineSection"||c.attrs?.collapsed&&(o=o.setNodeMarkup(s,void 0,{...c.attrs,collapsed:!1}),i=!0)}i&&(o=o.setMeta(ce,!0),oe.view.dispatch(o))}function Lg({setActiveTagKey:e}){let t=m?.outlineTagsBar;if(!t)return()=>{};let n=r=>{let o=r.target?.closest?.("[data-tag-key]");if(!o)return;let i=String(o.getAttribute("data-tag-key")||"");if(!i)return;let s=kr===i?null:i;kr=s;try{e(s)}catch{}s&&Bg(s),Pf()};return t.addEventListener("click",n),()=>t.removeEventListener("click",n)}function hn(e){let t=String(e||"").trim();if(!t.includes("|"))return null;let n=t;n.startsWith("|")&&(n=n.slice(1)),n.endsWith("|")&&(n=n.slice(0,-1));let r=n.split("|").map(o=>o.trim());return r.length<2||r.every(o=>!o)?null:r}function vs(e){let t=String(e||"").trim();return t?/^:?-{3,}:?$/.test(t):!1}function zr(e){let t=(Array.isArray(e)?e:[]).map(i=>String(i||"").replace(/\r/g,"").trimEnd()).filter(i=>i.length>0);if(t.length<2)return null;let n=hn(t[0]),r=hn(t[1]);if(!n||!r||n.length!==r.length||!r.every(vs))return null;let o=[];for(let i=2;i<t.length;i+=1){let s=hn(t[i]);if(!s||s.length!==n.length)return null;o.push(s)}return{header:n,rows:o}}function Ur(e){let t=(Array.isArray(e)?e:[]).map(s=>String(s||"").replace(/\r/g,"").trimEnd()).filter(s=>s.length>0);if(t.length<1)return null;let n=hn(t[0]);if(!n)return null;let r=n.length;if(r<2)return null;let o=[n];for(let s=1;s<t.length;s+=1){let c=hn(t[s]);if(!c||c.length!==r)break;if(s===1&&c.every(vs))return null;o.push(c)}return o.flat().filter(s=>String(s||"").trim().length>0).length<2?null:{rows:o}}function zc(e){let t=String(e||"").replace(/\r/g,"").split(`
`).map(n=>String(n||"").trimEnd());for(;t.length&&!t[0].trim();)t.shift();for(;t.length&&!t[t.length-1].trim();)t.pop();return t}function wr(e,t){if(!e||!t)return null;let{header:n,rows:r,withHeader:o}=t,i=e.nodes.table,s=e.nodes.tableRow,c=e.nodes.tableCell,d=e.nodes.tableHeader,l=e.nodes.paragraph;if(!i||!s||!c||!d||!l||typeof e.text!="function")return null;let u=b=>l.create({},b?[e.text(String(b))]:[]),f=(b,h)=>b.map(g=>(h?d:c).create({},[u(g)])),p=(b,h)=>s.create({},f(b,h)),y=[];return o&&Array.isArray(n)&&n.length&&y.push(p(n,!0)),(Array.isArray(r)?r:[]).forEach(b=>y.push(p(b,!1))),y.length?i.create({},y):null}function Mg(e,t){try{let n=e?.selection,r=n?.$from;if(!n?.empty||!r)return We("table.merge.skip",{reason:"no-cursor"}),!1;if(r.parent?.type?.name!=="paragraph")return!1;if(r.parentOffset!==0)return We("table.merge.skip",{reason:"not-at-paragraph-start"}),!1;let o=null,i=null,s=null;for(let G=r.depth;G>0;G-=1){let ie=r.node(G)?.type?.name;if(!s&&(ie==="tableCell"||ie==="tableHeader")?s=G:!i&&ie==="tableRow"?i=G:!o&&ie==="table"&&(o=G),o&&i&&s)break}if(o==null||i==null||s==null)return We("table.merge.skip",{reason:"not-in-table"}),!1;let c=r.depth===s+1,d=r.index(o),l=r.index(i),u=r.index(s);if(We("table.merge.check",{parent:r.parent?.type?.name||null,parentOffset:r.parentOffset,tableDepth:o,rowDepth:i,cellDepth:s,isDirectParagraphInCell:c,rowIndex:d,colIndex:l,childIndexInCell:u}),!c)return We("table.merge.skip",{reason:"paragraph-not-direct-child-of-cell"}),!1;if(d!==0||l!==0||u!==0)return We("table.merge.skip",{reason:"not-in-first-cell",rowIndex:d,colIndex:l,childIndexInCell:u}),!1;let f=r.before(o),p=e.doc.nodeAt(f);if(!p||p.type?.name!=="table")return We("table.merge.skip",{reason:"no-current-table",tablePos:f}),!1;let y=e.doc.resolve(f),b=y.index(),h=y.parent;if(!h||b<=0)return We("table.merge.skip",{reason:"no-prev-sibling",idx:b,parent:h?.type?.name||null}),!1;let g=null,w=b-1;for(;w>=0;){let G=h.child(w);if(G?.type?.name==="paragraph"&&!String(G.textContent||"").trim()){w-=1;continue}g=G;break}if(!g||g.type?.name!=="table")return We("table.merge.skip",{reason:"no-prev-table"}),!1;let S=g.childCount?g.child(0):null,x=p.childCount?p.child(0):null;if(!S||!x)return We("table.merge.skip",{reason:"missing-rows"}),!1;if(S.childCount!==x.childCount)return We("table.merge.skip",{reason:"different-columns",prevCols:S.childCount,curCols:x.childCount}),!1;let T=S.childCount,N=(G,ie)=>{try{return G?.type?.name==="tableRow"&&G.childCount===ie}catch{return!1}};for(let G=0;G<g.childCount;G+=1){let ie=g.child(G);if(!N(ie,T))return We("table.merge.skip",{reason:"prev-row-mismatch",rowIndex:G,colsExpected:T,colsGot:ie?.childCount??null}),!1}for(let G=0;G<p.childCount;G+=1){let ie=p.child(G);if(!N(ie,T))return We("table.merge.skip",{reason:"cur-row-mismatch",rowIndex:G,colsExpected:T,colsGot:ie?.childCount??null}),!1}let B=f;for(let G=b-1;G>=w;G-=1)B-=h.child(G).nodeSize;let $=g.childCount,U=e.doc.type.schema,Y=B+g.nodeSize,J=e.tr;f>Y&&(J=J.delete(Y,f));let re=Y;J=J.delete(re,re+p.nodeSize);let he=J.doc.nodeAt(B);if(!he||he.type?.name!=="table")return We("table.merge.skip",{reason:"prev-after-missing",prevStart:B,prevAfterType:he?.type?.name||null}),!1;We("table.merge.plan",{idx:b,prevIdx:w,prevStart:B,prevEnd:Y,tablePos:f,tablePos2:re,cols:T,prevRowCount:$,curRowCount:p.childCount});try{let G=he.content.append(p.content),ie=U.nodes.table.create(he.attrs,G,he.marks);J=J.replaceWith(B,B+he.nodeSize,ie)}catch(G){return We("table.merge.error",{message:String(G?.message||G||""),stack:String(G?.stack||"")}),!1}let Re=J.doc.nodeAt(B);We("table.merge.afterReplace",{mergedType:Re?.type?.name||null,mergedRows:Re?.type?.name==="table"?Re.childCount:null});try{let G=He?.pmStateMod?.TextSelection||He?.pm?.state?.TextSelection||null;if(Re&&Re.type?.name==="table"){let ie=Math.min($,Math.max(0,Re.childCount-1));if(Re.child(ie)?.childCount){let dt=(()=>{let Zt=B+1;for(let Mn=0;Mn<ie;Mn+=1)Zt+=Re.child(Mn).nodeSize;return Zt+=1,Zt})(),ut=Math.min(J.doc.content.size,dt+2);G&&(J=J.setSelection(G.near(J.doc.resolve(ut),1)))}}}catch(G){We("table.merge.selection.error",{message:String(G?.message||G||""),stack:String(G?.stack||"")})}J=J.setMeta(ce,!0);try{t(J.scrollIntoView())}catch(G){return We("table.merge.dispatch.error",{message:String(G?.message||G||""),stack:String(G?.stack||"")}),!1}return!0}catch(n){try{We("table.merge.exception",{message:String(n?.message||n||""),stack:String(n?.stack||"")})}catch{}return!1}}function Ng(e,t,n,r){try{let o=(ie,$e={})=>{try{if(window?.localStorage?.getItem?.("ttree_debug_outline_keys_v1")!=="1")return;console.log("[outline][keys]","bodyToHeading.skip",{reason:ie,sectionId:n||null,...$e})}catch{}},i=(ie={})=>{try{if(window?.localStorage?.getItem?.("ttree_debug_outline_keys_v1")!=="1")return;console.log("[outline][keys]","bodyToHeading.check",{sectionId:n||null,...ie})}catch{}};if(!n)return!1;if(!r)return o("no-TextSelection"),!1;let s=e?.selection;if(!s?.empty)return o("selection-not-empty"),!1;let c=s.$from||null;if(!c)return o("no-$from"),!1;i({from:s.from,parent:c.parent?.type?.name||null,parentOffset:c.parentOffset??null});let d=mt(e.doc,n);if(typeof d!="number")return o("section-not-found"),!1;let l=e.doc.nodeAt(d);if(!l||l.type?.name!=="outlineSection")return o("not-outlineSection",{found:l?.type?.name||null}),!1;let u=l.child(0),f=l.child(1);if(!u||u.type?.name!=="outlineHeading")return o("missing-heading",{found:u?.type?.name||null}),!1;if(!f||f.type?.name!=="outlineBody")return o("missing-body",{found:f?.type?.name||null}),!1;let p=String(u.textContent||"").replace(/\u00a0/g," "),y=!!p.trim(),b=/\s$/.test(p),h=null;for(let ie=c.depth;ie>=0;ie-=1)if(c.node(ie)?.type?.name==="outlineBody"){h=ie;break}if(h==null)return o("not-in-outlineBody",{parent:c.parent?.type?.name||null}),!1;if(c.index(h)!==0)return o("not-first-body-child",{index:c.index(h)}),!1;if(c.parent?.type?.name!=="paragraph")return o("parent-not-paragraph",{parent:c.parent?.type?.name||null}),!1;if((c.parentOffset??null)!==0)return o("not-at-paragraph-start",{parentOffset:c.parentOffset??null}),!1;let g=d+1,w=s.from,S=c.parent,x=0,T=null;for(let ie=0;ie<S.childCount;ie+=1){let $e=S.child(ie);if($e.type?.name==="hardBreak"){T=x;break}x+=$e.nodeSize}let N=w+(T??S.content.size);if(N<=w)return o("empty-first-line"),!1;let B=e.doc.slice(w,N);if(!B?.content||B.content.size<=0)return o("empty-slice"),!1;let $=T==null?N:N+1,U=g+1,Y=g+u.nodeSize-1,J=e.tr;y&&!b&&(J=J.insertText(" ",Y),J=J.setMeta(ce,!0));let re=J.mapping.map(Y,1),he=re;J=J.insert(re,B.content);let Re=J.mapping.map(w,1),G=J.mapping.map($,-1);J=J.delete(Re,G);try{J=J.setSelection(r.create(J.doc,he))}catch{}return J=J.setMeta(ce,!0),t(J.scrollIntoView()),!0}catch(o){try{window?.localStorage?.getItem?.("ttree_debug_outline_keys_v1")==="1"&&console.log("[outline][keys]","bodyToHeading.error",{sectionId:n||null,message:String(o?.message||o||""),stack:String(o?.stack||"")})}catch{}return!1}}function Pg(e,t){try{if(!e?.doc||!t)return null;let n=mt(e.doc,t);if(typeof n!="number")return null;let r=e.doc.nodeAt(n);if(!r)return null;let o=r.child(0),i=r.child(1);if(!i||i.type?.name!=="outlineBody")return null;let c=n+1+o.nodeSize+1,d=[],l=0,u=0;for(;u<i.childCount;){let p=i.child(u),y=c+l;if(p.type?.name!=="paragraph"){l+=p.nodeSize,u+=1;continue}let b=Sr(p).trim();if(b.includes(`
`)&&b.includes("|")){let J=zc(b),re=zr(J),he=re?null:Ur(J),Re=re?{header:re.header,rows:re.rows,withHeader:!0}:he?{header:null,rows:he.rows,withHeader:!1}:null,G=null;if(Re)try{G=wr(e.schema,Re)}catch(ie){mn("convert: buildTableNode error (single)",{message:String(ie?.message||ie||""),stack:String(ie?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),G=null}if(G){let ie=y,$e=y+p.nodeSize;d.push({from:ie,to:$e,tableNode:G}),mn("convert: single-paragraph table",{sectionId:t,from:ie,to:$e,lines:J}),l+=p.nodeSize,u+=1;continue}}let h=hn(b);if(!h||u+1>=i.childCount){if(h){let J=[b],re=l+p.nodeSize,he=u+1;for(;he<i.childCount;){let $e=i.child(he);if($e.type?.name!=="paragraph")break;let dt=Sr($e).trim();if(!dt)break;let ut=hn(dt);if(!ut||ut.length!==h.length)break;J.push(dt),re+=$e.nodeSize,he+=1}let Re=Ur(J),G=Re?{header:null,rows:Re.rows,withHeader:!1}:null,ie=null;if(G)try{ie=wr(e.schema,G)}catch($e){mn("convert: buildTableNode error (rows-only)",{message:String($e?.message||$e||""),stack:String($e?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),ie=null}if(ie){d.push({from:y,to:c+re,tableNode:ie}),mn("convert: rows-only table",{sectionId:t,from:y,to:c+re,lines:J}),l=re,u=he;continue}}l+=p.nodeSize,u+=1;continue}let g=i.child(u+1);if(g.type?.name!=="paragraph"){l+=p.nodeSize,u+=1;continue}let w=Sr(g).trim(),S=hn(w);if(!S||S.length!==h.length||!S.every(vs)){l+=p.nodeSize,u+=1;continue}let x=[b,w],T=l+p.nodeSize+g.nodeSize,N=u+2;for(;N<i.childCount;){let J=i.child(N);if(J.type?.name!=="paragraph")break;let re=Sr(J).trim();if(!re)break;let he=hn(re);if(!he||he.length!==h.length)break;x.push(re),T+=J.nodeSize,N+=1}let B=zr(x),$=B?null:Ur(x),U=B?{header:B.header,rows:B.rows,withHeader:!0}:$?{header:null,rows:$.rows,withHeader:!1}:null,Y=null;if(U)try{Y=wr(e.schema,U)}catch(J){mn("convert: buildTableNode error (multi)",{message:String(J?.message||J||""),stack:String(J?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),Y=null}if(!Y){l+=p.nodeSize,u+=1;continue}d.push({from:y,to:c+T,tableNode:Y}),mn("convert: multi-paragraph table",{sectionId:t,from:y,to:c+T,lines:x}),l=T,u=N}if(!d.length)return null;d.sort((p,y)=>y.from-p.from);let f=e.tr;for(let p of d)f=f.replaceRangeWith(p.from,p.to,p.tableNode);return f=f.setMeta(ce,!0),f}catch{return null}}function Sr(e){if(!e)return"";let t="";return e.descendants(n=>{n.isText?t+=n.text||"":n.type?.name==="hardBreak"&&(t+=`
`)}),t}function df(e){try{if(!e||e.type!=="paragraph")return"";let t=[],n=r=>{if(!r)return;if(r.type==="text"){t.push(String(r.text||""));return}if(r.type==="hardBreak"){t.push(`
`);return}let o=Array.isArray(r.content)?r.content:[];for(let i of o)n(i)};return n(e),t.join("")}catch{return""}}function Dg(e){if(!e)return null;let{header:t,rows:n}=e;if(!Array.isArray(t)||t.length===0)return null;let r=s=>({type:"paragraph",content:String(s||"").length?[{type:"text",text:String(s||"")}]:[]}),o={type:"tableRow",content:t.map(s=>({type:"tableHeader",content:[r(s)]}))},i=(Array.isArray(n)?n:[]).map(s=>({type:"tableRow",content:s.map(c=>({type:"tableCell",content:[r(c)]}))}));return{type:"table",content:[o,...i]}}function _g(e){if(!e)return!1;try{let{doc:t,schema:n}=e.state,r=[];if(t.descendants((i,s)=>{if(i.type?.name!=="outlineBody")return;let c=s+1,d=0,l=0;for(;l<i.childCount;){let u=i.child(l),f=c+d;if(u.type?.name!=="paragraph"){d+=u.nodeSize,l+=1;continue}let p=Sr(u).trim();if(p.includes(`
`)&&p.includes("|")){let $=zc(p),U=zr($),Y=U?null:Ur($),J=U?{header:U.header,rows:U.rows,withHeader:!0}:Y?{header:null,rows:Y.rows,withHeader:!1}:null,re=J?wr(n,J):null;if(re){r.push({from:f,to:f+u.nodeSize,tableNode:re}),d+=u.nodeSize,l+=1;continue}}let y=hn(p);if(!y){d+=u.nodeSize,l+=1;continue}if(l+1>=i.childCount){let $=Ur([p]),U=$?{header:null,rows:$.rows,withHeader:!1}:null,Y=U?wr(n,U):null;Y&&r.push({from:f,to:f+u.nodeSize,tableNode:Y}),d+=u.nodeSize,l+=1;continue}let b=i.child(l+1);if(b.type?.name!=="paragraph"){d+=u.nodeSize,l+=1;continue}let h=Sr(b).trim(),g=hn(h);if(!g||g.length!==y.length||!g.every(vs)){let $=[p],U=d+u.nodeSize,Y=l+1;for(;Y<i.childCount;){let Re=i.child(Y);if(Re.type?.name!=="paragraph")break;let G=Sr(Re).trim();if(!G)break;let ie=hn(G);if(!ie||ie.length!==y.length)break;$.push(G),U+=Re.nodeSize,Y+=1}let J=Ur($),re=J?{header:null,rows:J.rows,withHeader:!1}:null,he=re?wr(n,re):null;if(he){r.push({from:f,to:c+U,tableNode:he}),d=U,l=Y;continue}d+=u.nodeSize,l+=1;continue}let w=[p,h],S=d+u.nodeSize+b.nodeSize,x=l+2;for(;x<i.childCount;){let $=i.child(x);if($.type?.name!=="paragraph")break;let U=Sr($).trim();if(!U)break;let Y=hn(U);if(!Y||Y.length!==y.length)break;w.push(U),S+=$.nodeSize,x+=1}let T=zr(w),N=T?{header:T.header,rows:T.rows,withHeader:!0}:null,B=N?wr(n,N):null;if(!B){d+=u.nodeSize,l+=1;continue}r.push({from:f,to:c+S,tableNode:B}),d=S,l=x}}),!r.length)return!1;r.sort((i,s)=>s.from-i.from);let o=e.state.tr;for(let i of r)o=o.replaceRangeWith(i.from,i.to,i.tableNode);return o=o.setMeta(ce,!0),e.view.dispatch(o),!0}catch{return!1}}function po(){let e=Date.now();if(!(e-lf<900)){lf=e;try{L("\u0414\u043B\u044F \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Enter \u0438\u043B\u0438 \u0434\u0432\u043E\u0439\u043D\u043E\u0439 \u043A\u043B\u0438\u043A \u043C\u044B\u0448\u043A\u043E\u0439. Esc \u0434\u043B\u044F \u0432\u044B\u0445\u043E\u0434\u0430.")}catch{}}}function Hc(e=""){let t=document.createElement("div");return t.innerHTML=e||"",(t.textContent||"").replace(/\u00a0/g," ").trim()}function $r(e=""){return String(e||"").replace(/\u00a0/g," ").replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}function $c(e=""){let t=String(e||""),n=0;for(let r=0;r<t.length;r+=1)n=n*31+t.charCodeAt(r)>>>0;return String(n)}function Cc(e=""){return $c(String(e||"").slice(0,12e3))}function Xt(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`sec-${Date.now()}-${Math.random().toString(16).slice(2)}`}function _f({loading:e=!1}={}){m.outlineEditor&&(m.outlineEditor.innerHTML=`
    <div class="outline-editor__body">
      <div class="outline-editor__content" id="outlineEditorContent"></div>
      <div class="outline-editor__loading ${e?"":"hidden"}">\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440\u2026</div>
    </div>
  `,nf||(nf=!0))}function Of(e){let t=String(e||"").trim();if(!t)return null;let n=t.match(/(-?\d+(?:\.\d+)?)%/);if(!n)return null;let r=Number.parseFloat(n[1]);return Number.isFinite(r)?r:null}function zn(e){let t=Number(e);return Number.isFinite(t)?Math.max(0,Math.min(100,t)):0}function Rf(e){try{let t=e?.dataset?.ttPct||"",n=Number.parseFloat(String(t||""));if(Number.isFinite(n)&&n>0)return n;let r=Of(e?.style?.width||"");return r!=null&&r>0?r:null}catch{return null}}function Es(e,t){try{let n=zn(t);return e.dataset.ttPct=n.toFixed(4),e.style.width=`${n.toFixed(4)}%`,e.style.minWidth="",!0}catch{return!1}}function As(e,{insertIndex:t,newColPct:n=10}={}){try{let r=e?.view;if(!r)return!1;let o=Number(t);if(!Number.isFinite(o)||o<0)return!1;let i=r.domAtPos(r.state.selection.from),c=((i?.node&&i.node.nodeType===1?i.node:i?.node?.parentElement)||null)?.closest?.("table")||null;if(!c)return!1;let d=c.querySelector("colgroup");if(!d)return!1;let l=Array.from(d.querySelectorAll("col"));if(!l.length||o>=l.length)return!1;let u=100/l.length,f=l.map(T=>Rf(T)??u),p=zn(n);f[o]=p;let y=o-1,b=y>=0?f.slice(0,y+1).reduce((T,N)=>T+N,0):0,h=o+1,g=Math.max(0,l.length-h),w=g>0?f.slice(h).reduce((T,N)=>T+N,0):0,S=100-b-p;if(S<0){let T=Math.max(0,o-1),N=Math.max(0,f[T]-1),B=Math.abs(S),$=Math.min(N,B);f[T]=Math.max(1,f[T]-$),S=100-f.slice(0,y+1).reduce((U,Y)=>U+Y,0)-p,S=Math.max(0,S)}if(g>0)if(w>0){let T=S/w;for(let N=h;N<l.length;N+=1)f[N]*=T}else{let T=S/g;for(let N=h;N<l.length;N+=1)f[N]=T}let x=f.reduce((T,N)=>T+N,0);if(x>0&&Math.abs(x-100)>.01){let T=100-x,N=l.length-1;f[N]=zn(f[N]+T),x=f.reduce((B,$)=>B+$,0)}for(let T=0;T<l.length;T+=1)Es(l[T],f[T]);try{c.style.width="100%",c.style.maxWidth="100%",c.style.tableLayout="fixed"}catch{}return!0}catch{return!1}}function xs(e){try{if(!e)return!1;let t=e.querySelector("colgroup");if(!t)return!1;let n=Array.from(t.querySelectorAll("col"));if(!n.length)return!1;let r=e.getBoundingClientRect();if(!Number.isFinite(r.width)||r.width<=0)return!1;let o=e.querySelector("tbody tr");if(!o)return!1;let i=Array.from(o.children||[]).filter(d=>d&&d.nodeType===1);if(!i.length)return!1;let s=[];for(let d=0;d<n.length;d+=1){let l=i[d]||null;if(!l){s.push(0);continue}let u=l.getBoundingClientRect();s.push(Number.isFinite(u.width)?u.width:0)}let c=s.reduce((d,l)=>d+(Number.isFinite(l)?l:0),0);if(!(c>0))return!1;for(let d=0;d<n.length;d+=1){let l=zn(s[d]/c*100);Es(n[d],l)}return!0}catch{return!1}}function Qt(e){try{if(!e?.state?.selection)return null;let t=e.state.selection;try{let o=t?.$anchorCell?.pos,i=t?.$headCell?.pos,s=Number.isFinite(o)?o:Number.isFinite(i)?i:null;if(s!=null){let c=e.nodeDOM?.(s)||null;if(c&&c.nodeType===1)return c.closest?.("table")||null}}catch{}let n=e.domAtPos(t.from);return((n?.node&&n.node.nodeType===1?n.node:n?.node?.parentElement)||null)?.closest?.("table")||null}catch{return null}}function Og(e){try{let t=e?.state?.selection||null,n=t?.$from||null;if(!n)return null;try{let s=t?.$anchorCell?.pos,c=t?.$headCell?.pos,d=Number.isFinite(s)?s:Number.isFinite(c)?c:null;if(d!=null){let l=e.nodeDOM?.(d)||null;if(l&&l.nodeType===1)return l}}catch{}let r=null;for(let s=n.depth;s>=0;s-=1){let c=n.node(s)?.type?.name;if(c==="tableCell"||c==="tableHeader"){r=s;break}}if(r!=null){let s=n.before(r),c=e.nodeDOM?.(s)||null;if(c&&c.nodeType===1)return c}let o=e.domAtPos(t.from);return((o?.node&&o.node.nodeType===1?o.node:o?.node?.parentElement)||null)?.closest?.("td,th")||null}catch{return null}}function mo(e){try{if(!e)return null;let t=e.querySelector("colgroup");if(!t)return null;let n=Array.from(t.querySelectorAll("col"));if(!n.length)return null;let r=n.map(l=>Rf(l));if(r.some(l=>typeof l=="number"&&Number.isFinite(l)&&l>0)){let l=100/n.length;return r.map(u=>typeof u=="number"&&Number.isFinite(u)&&u>0?u:l)}let i=e.querySelector("tbody tr");if(!i)return null;let s=Array.from(i.children||[]).filter(l=>l&&l.nodeType===1);if(s.length<n.length)return null;let c=[];for(let l=0;l<n.length;l+=1){let u=s[l].getBoundingClientRect();c.push(Number.isFinite(u.width)?u.width:0)}let d=c.reduce((l,u)=>l+(Number.isFinite(u)?u:0),0);return d>0?c.map(l=>zn(l/d*100)):null}catch{return null}}function ho(e,t){try{if(!e)return!1;let n=e.querySelector("colgroup");if(!n)return!1;let r=Array.from(n.querySelectorAll("col"));if(!r.length||!Array.isArray(t)||t.length!==r.length)return!1;for(let o=0;o<r.length;o+=1)Es(r[o],t[o]);try{e.style.width="100%",e.style.maxWidth="100%",e.style.tableLayout="fixed"}catch{}return!0}catch{return!1}}function Hf(e,t){try{let n=Array.isArray(e)?e.map(f=>Number(f)||0):null,r=Number(t);if(!n||!Number.isFinite(r)||r<0||r>=n.length||n.length<=1)return null;let o=Math.max(0,n[r]||0),i=n.slice(0,r),s=n.slice(r+1),c=s.reduce((f,p)=>f+(Number.isFinite(p)?p:0),0),d=s;if(s.length)if(c>0){let f=(c+o)/c;d=s.map(p=>Number.isFinite(p)?p*f:0)}else{let f=(o||0)/s.length;d=s.map(()=>f)}else i.length&&(i[i.length-1]=Math.max(1,(i[i.length-1]||0)+o));let l=[...i,...d].map(f=>zn(f)),u=l.reduce((f,p)=>f+(Number.isFinite(p)?p:0),0);return u>0&&Math.abs(u-100)>.01&&(l[l.length-1]=zn(l[l.length-1]+(100-u))),l}catch{return null}}function Ft(e){try{let t=kt?.TableMap||null,n=e?.selection||null,r=n?.$from||null,i=n?.$anchorCell||null||r||null;if(!i)return null;let s=null;for(let g=i.depth;g>=0;g-=1)if(i.node(g)?.type?.name==="table"){s=g;break}if(s==null)return null;let c=i.before(s),d=e.doc.nodeAt(c);if(!d||d.type?.name!=="table")return null;let l=null;for(let g=s+1;g<=i.depth;g+=1){let w=i.node(g)?.type?.name;if(w==="tableCell"||w==="tableHeader"){l=g;break}}if(l==null)return null;let u=i.before(l),f=t?.get?t.get(d):null;if(!f)return null;let p=u-c-1,y=f.findCell(p),b=Number(y?.left??0),h=Number(y?.top??0);return{tablePos:c,tableNode:d,map:f,colIndex:b,rowIndex:h}}catch{return null}}function Bc(e){try{let t=[],n=e?.selection,r=e?.doc;if(!n||!r)return t;try{r.nodesBetween(n.from,n.to,(i,s)=>{let c=i?.type?.name;(c==="tableCell"||c==="tableHeader")&&t.push({node:i,pos:s})})}catch{}if(!t.length)try{let i=n.$from||null;if(i)for(let s=i.depth;s>=0;s-=1){let c=i.node(s)?.type?.name;if(c==="tableCell"||c==="tableHeader"){let d=i.before(s),l=r.nodeAt(d);l&&t.push({node:l,pos:d});break}}}catch{}let o=new Map;for(let i of t){let s=Number(i?.pos);Number.isFinite(s)&&(o.has(s)||o.set(s,i))}return Array.from(o.values()).sort((i,s)=>Number(i.pos)-Number(s.pos))}catch{return[]}}function Rg(e,t){try{let n=kt?.CellSelection||null,r=kt?.TableMap||null;return!n||!r?!1:e.commands.command(({state:o,dispatch:i})=>{let s=Ft(o);if(!s)return!1;let{tablePos:c,tableNode:d,map:l}=s,u=Number(t);if(!Number.isFinite(u)||u<0||u>=l.height)return!1;let f=l.positionAt(u,0,d),p=l.positionAt(u,l.width-1,d),y=c+1+f,b=c+1+p,h=null;try{typeof n.create=="function"&&(h=n.create(o.doc,y,b))}catch{h=null}if(!h)return!1;let g=o.tr.setSelection(h);return g=g.setMeta(ce,!0),i(g.scrollIntoView()),!0})}catch{return!1}}function Hg(e,t,n){try{let r=kt?.CellSelection||null,o=kt?.TableMap||null;if(!r||!o)return!1;let i=Number(t),s=Number(n);return!Number.isFinite(i)||i<0||!Number.isFinite(s)||s<0?!1:e.commands.command(({state:c,dispatch:d})=>{let l=c?.doc?.nodeAt?.(i)||null;if(!l||l.type?.name!=="table")return!1;let u=o?.get?o.get(l):null;if(!u||s>=u.height)return!1;let f=u.positionAt(s,0,l),p=u.positionAt(s,u.width-1,l),y=i+1+f,b=i+1+p,h=null;try{typeof r.create=="function"&&(h=r.create(c.doc,y,b))}catch{h=null}if(!h)return!1;let g=c.tr.setSelection(h);return g=g.setMeta(ce,!0),d(g.scrollIntoView()),!0})}catch{return!1}}function $g(e,t){try{let n=kt?.CellSelection||null,r=kt?.TableMap||null;return!n||!r?!1:e.commands.command(({state:o,dispatch:i})=>{let s=Ft(o);if(!s)return!1;let{tablePos:c,tableNode:d,map:l}=s,u=Number(t);if(!Number.isFinite(u)||u<0||u>=l.width)return!1;let f=l.positionAt(0,u,d),p=l.positionAt(l.height-1,u,d),y=c+1+f,b=c+1+p,h=null;try{typeof n.create=="function"&&(h=n.create(o.doc,y,b))}catch{h=null}if(!h)return!1;let g=o.tr.setSelection(h);return g=g.setMeta(ce,!0),i(g.scrollIntoView()),!0})}catch{return!1}}function Fg(e,t,n){try{let r=kt?.CellSelection||null,o=kt?.TableMap||null;if(!r||!o)return!1;let i=Number(t),s=Number(n);return!Number.isFinite(i)||i<0||!Number.isFinite(s)||s<0?!1:e.commands.command(({state:c,dispatch:d})=>{let l=c?.doc?.nodeAt?.(i)||null;if(!l||l.type?.name!=="table")return!1;let u=o?.get?o.get(l):null;if(!u||s>=u.width)return!1;let f=u.positionAt(0,s,l),p=u.positionAt(u.height-1,s,l),y=i+1+f,b=i+1+p,h=null;try{typeof r.create=="function"&&(h=r.create(c.doc,y,b))}catch{h=null}if(!h)return!1;let g=c.tr.setSelection(h);return g=g.setMeta(ce,!0),d(g.scrollIntoView()),!0})}catch{return!1}}function zg({pmState:e,dispatch:t},{tablePos:n,rowIndex:r,attr:o,value:i}){try{let s=kt?.CellSelection||null,c=kt?.TableMap||null;if(!c)return!1;let d=Number(n),l=Number(r);if(!Number.isFinite(d)||d<0||!Number.isFinite(l)||l<0)return!1;let u=e?.doc?.nodeAt?.(d)||null;if(!u||u.type?.name!=="table")return!1;let f=c?.get?c.get(u):null;if(!f||l>=f.height)return!1;let p=e.tr;try{if(s?.create){let h=f.positionAt(l,0,u),g=f.positionAt(l,f.width-1,u),w=d+1+h,S=d+1+g;p=p.setSelection(s.create(p.doc,w,S))}}catch{}let y=new Set;for(let h=0;h<f.width;h+=1){let g=f.map[l*f.width+h];Number.isFinite(g)&&y.add(d+1+g)}if(!y.size)return!1;let b=!1;for(let h of y){let g=p.doc.nodeAt(h),w=g?.type?.name;if(w!=="tableCell"&&w!=="tableHeader")continue;let S={...g.attrs||{}};i==null||i===""?delete S[o]:S[o]=i,p=p.setNodeMarkup(h,void 0,S),b=!0}return b?(p=p.setMeta(ce,!0),t(p),!0):!1}catch{return!1}}function Ug({pmState:e,dispatch:t},{tablePos:n,colIndex:r,attr:o,value:i}){try{let s=kt?.CellSelection||null,c=kt?.TableMap||null;if(!c)return!1;let d=Number(n),l=Number(r);if(!Number.isFinite(d)||d<0||!Number.isFinite(l)||l<0)return!1;let u=e?.doc?.nodeAt?.(d)||null;if(!u||u.type?.name!=="table")return!1;let f=c?.get?c.get(u):null;if(!f||l>=f.width)return!1;let p=e.tr;try{if(s?.create){let h=f.positionAt(0,l,u),g=f.positionAt(f.height-1,l,u),w=d+1+h,S=d+1+g;p=p.setSelection(s.create(p.doc,w,S))}}catch{}let y=new Set;for(let h=0;h<f.height;h+=1){let g=f.map[h*f.width+l];Number.isFinite(g)&&y.add(d+1+g)}if(!y.size)return!1;let b=!1;for(let h of y){let g=p.doc.nodeAt(h),w=g?.type?.name;if(w!=="tableCell"&&w!=="tableHeader")continue;let S={...g.attrs||{}};i==null||i===""?delete S[o]:S[o]=i,p=p.setNodeMarkup(h,void 0,S),b=!0}return b?(p=p.setMeta(ce,!0),t(p),!0):!1}catch{return!1}}function Ts(e,t="\u0442\u0430\u0431\u043B\u0438\u0446\u044B"){try{let n=!1;return e.descendants(r=>{if(n)return!1;let o=r?.type?.name;if(o==="tableCell"||o==="tableHeader"){let i=Number(r.attrs?.colspan||1),s=Number(r.attrs?.rowspan||1);if(i!==1||s!==1)return n=!0,!1}return!0}),n?(L(`\u041F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 ${t} \u043F\u043E\u043A\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u0445 \u044F\u0447\u0435\u0435\u043A`),!1):!0}catch{return!1}}function $f(e,{kind:t,fromIndex:n,toIndex:r}){try{if(!e||!(kt?.TableMap||null))return!0;let i=e.map||null,s=e.tableNode||null;if(!i||!s)return!0;let c=Number(n),d=Number(r);if(!Number.isFinite(c)||!Number.isFinite(d))return!0;let l=t==="row"?Math.max(0,Math.min(i.height-1,c)):Math.max(0,Math.min(i.width-1,c)),u=t==="row"?Math.max(0,Math.min(i.height-1,d)):Math.max(0,Math.min(i.width-1,d)),f=new Set;for(let p of i.map){let y=Number(p);if(!Number.isFinite(y)||y<0||f.has(y))continue;f.add(y);let b=null;try{b=i.findCell(y)}catch{b=null}if(!b)continue;let h=Number(b.right)-Number(b.left),g=Number(b.bottom)-Number(b.top);if(h>1||g>1)if(t==="col"){let w=Number(b.left),S=Number(b.right);if(w<=l&&l<S||w<=u&&u<S)return!0}else{let w=Number(b.top),S=Number(b.bottom);if(w<=l&&l<S||w<=u&&u<S)return!0}}return!1}catch{return!0}}function uf(e,t){try{if(!e?.view)return!1;let n=Ft(e.state);if(!n)return!1;let{colIndex:r}=n,o=n.map?.width||0;if(!(o>0))return!1;let i=t<0?-1:1,s=r+i;return s>=0&&s<o?Ff(e,r,s):!1}catch{return!1}}function ff(e,t){try{if(!e?.view)return!1;let n=Ft(e.state);if(!n)return!1;let{rowIndex:r}=n,o=n.map?.height||0;if(!(o>0))return!1;let i=t<0?-1:1,s=r+i;return s>=0&&s<o?zf(e,r,s):!1}catch{return!1}}function Ff(e,t,n){try{if(!e?.view)return!1;let r=e.state,o=Ft(r);if(!o)return!1;let{tableNode:i}=o,s=o.map?.width||0;if(!(s>0))return!1;let c=Number(t),d=Number(n);if(!Number.isFinite(c)||!Number.isFinite(d)||c<0||c>=s||d<0||d>=s)return!1;if(c===d)return!0;if($f(o,{kind:"col",fromIndex:c,toIndex:d}))return L("\u041D\u0435\u043B\u044C\u0437\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u043E\u043B\u0431\u0435\u0446: \u0438\u0441\u0445\u043E\u0434\u043D\u0430\u044F \u0438\u043B\u0438 \u0446\u0435\u043B\u0435\u0432\u0430\u044F \u043A\u043E\u043B\u043E\u043D\u043A\u0430 \u043F\u0435\u0440\u0435\u0441\u0435\u043A\u0430\u0435\u0442\u0441\u044F \u0441 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u043C\u0438 \u044F\u0447\u0435\u0439\u043A\u0430\u043C\u0438"),!1;let l=Qt(e.view),u=mo(l),f=Array.isArray(u)&&u.length===s?(()=>{let h=u.slice(),g=h.splice(c,1)[0];return h.splice(d,0,g),h})():null,p=kt?.moveTableColumn||null;if(typeof p!="function")return!1;let y=p({from:c,to:d,select:!0});return e.commands.command(({state:h,dispatch:g})=>y(h,typeof g=="function"?S=>{try{S=S.setMeta(ce,!0)}catch{}g(S)}:void 0))?(f&&window.requestAnimationFrame(()=>{let h=Qt(e.view);ho(h,f);try{(h?.closest?.(".tableWrapper")||null)?.dispatchEvent?.(new Event("scroll"))}catch{}}),!0):!1}catch{return!1}}function zf(e,t,n){try{if(!e?.view)return!1;let r=e.state,o=Ft(r);if(!o)return!1;let i=o.map?.height||0,s=o.map?.width||0;if(!(s>0&&i>0))return!1;let c=Number(t),d=Number(n);if(!Number.isFinite(c)||!Number.isFinite(d)||c<0||c>=i||d<0||d>=i)return!1;if(c===d)return!0;if($f(o,{kind:"row",fromIndex:c,toIndex:d}))return L("\u041D\u0435\u043B\u044C\u0437\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u043E\u043A\u0443: \u0438\u0441\u0445\u043E\u0434\u043D\u0430\u044F \u0438\u043B\u0438 \u0446\u0435\u043B\u0435\u0432\u0430\u044F \u0441\u0442\u0440\u043E\u043A\u0430 \u043F\u0435\u0440\u0435\u0441\u0435\u043A\u0430\u0435\u0442\u0441\u044F \u0441 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u043C\u0438 \u044F\u0447\u0435\u0439\u043A\u0430\u043C\u0438"),!1;let l=Qt(e.view),u=mo(l),f=kt?.moveTableRow||null;if(typeof f!="function")return!1;let p=f({from:c,to:d,select:!0});return e.commands.command(({state:b,dispatch:h})=>p(b,typeof h=="function"?w=>{try{w=w.setMeta(ce,!0)}catch{}h(w)}:void 0))?(Array.isArray(u)&&u.length===s&&window.requestAnimationFrame(()=>{let b=Qt(e.view);ho(b,u)}),!0):!1}catch{return!1}}function Uf(e){try{if(!e)return"";let t=e.textContent||"";return String(t).replace(/\s+/g," ").trim()}catch{return""}}function Vg(e){try{if(!e)return!1;for(let t=0;t<e.childCount;t+=1)if(e.child(t)?.type?.name==="tableHeader")return!0;return!1}catch{return!1}}function pf(e,{direction:t="asc"}={}){try{if(!e?.view)return!1;let n=e.state,r=Ft(n);if(!r)return!1;let{tablePos:o,tableNode:i,colIndex:s}=r,c=i.child(0)?.childCount||0,d=i.childCount||0;if(!(c>0&&d>1)||!(s>=0&&s<c)||!Ts(i,"\u0442\u0430\u0431\u043B\u0438\u0446\u044B"))return!1;let l=Vg(i.child(0))?i.child(0):null,u=l?1:0,f=[];for(let g=u;g<d;g+=1){let w=i.child(g),S=w.child(s);f.push({rowIndex:g,rowNode:w,key:Uf(S)})}let p=t==="desc"?-1:1;f.sort((g,w)=>p*g.key.localeCompare(w.key,void 0,{sensitivity:"base",numeric:!0}));let y=[];l&&y.push(l);for(let g of f)y.push(g.rowNode);let b=i.type.create(i.attrs,y),h=n.tr.replaceWith(o,o+i.nodeSize,b);return h=h.setMeta(ce,!0),e.view.dispatch(h.scrollIntoView()),!0}catch{return!1}}function mf(e,{direction:t="asc"}={}){try{if(!e?.view)return!1;let n=e.state,r=Ft(n);if(!r)return!1;let{tablePos:o,tableNode:i,rowIndex:s}=r,c=i.child(0)?.childCount||0,d=i.childCount||0;if(!(c>1&&d>0)||!(s>=0&&s<d)||!Ts(i,"\u0442\u0430\u0431\u043B\u0438\u0446\u044B"))return!1;let l=i.child(s),u=[];for(let x=0;x<c;x+=1)u.push({colIndex:x,key:Uf(l.child(x))});let f=t==="desc"?-1:1;u.sort((x,T)=>f*x.key.localeCompare(T.key,void 0,{sensitivity:"base",numeric:!0}));let p=u.map(x=>x.colIndex),y=Qt(e.view),b=mo(y),h=Array.isArray(b)&&b.length===c?p.map(x=>b[x]):null,g=[];for(let x=0;x<d;x+=1){let T=i.child(x),N=p.map(B=>T.child(B));g.push(T.type.create(T.attrs,N))}let w=i.type.create(i.attrs,g),S=n.tr.replaceWith(o,o+i.nodeSize,w);return S=S.setMeta(ce,!0),e.view.dispatch(S.scrollIntoView()),h&&window.requestAnimationFrame(()=>{let x=Qt(e.view);ho(x,h)}),!0}catch{return!1}}function qg(e){try{if(!e?.view)return!1;let t=e.state,n=Ft(t);if(!n)return!1;let{tablePos:r,tableNode:o,rowIndex:i,colIndex:s}=n,c=o.child(0)?.childCount||0,d=o.childCount||0;if(!(c>0&&d>0)||!(i>=0&&i<d)||!Ts(o,"\u0441\u0442\u0440\u043E\u043A"))return!1;let l=o.child(i),u=[];for(let y=0;y<d;y+=1)u.push(o.child(y)),y===i&&u.push(l.type.create(l.attrs,l.content,l.marks));let f=o.type.create(o.attrs,u),p=t.tr.replaceWith(r,r+o.nodeSize,f);p=p.setMeta(ce,!0);try{let y=He?.pmStateMod?.TextSelection;if(y){let b=Math.min(f.childCount-1,i+1),h=Math.min(c-1,Math.max(0,s)),g=f.child(b),w=g.child(h),S=r+1;for(let B=0;B<b;B+=1)S+=f.child(B).nodeSize;S+=1;for(let B=0;B<h;B+=1)S+=g.child(B).nodeSize;let x=S,T=x+1,N=x+w.nodeSize-1;p=p.setSelection(y.near(p.doc.resolve(Math.min(N,T+1)),1))}}catch{}return e.view.dispatch(p.scrollIntoView()),!0}catch{return!1}}function Kg(e){try{if(!e?.view)return!1;let t=e.state,n=Ft(t);if(!n)return!1;let{tablePos:r,tableNode:o,rowIndex:i,colIndex:s}=n,c=o.child(0)?.childCount||0,d=o.childCount||0;if(!(c>0&&d>0)||!(s>=0&&s<c)||!Ts(o,"\u0441\u0442\u043E\u043B\u0431\u0446\u043E\u0432"))return!1;let l=Qt(e.view),u=mo(l),f=null;if(Array.isArray(u)&&u.length===c){let h=[...u],g=Math.max(0,Number(h[s]||0)),w=zn(g/2);h[s]=w,h.splice(s+1,0,w);let S=h.reduce((x,T)=>x+(Number.isFinite(T)?T:0),0);S>0&&Math.abs(S-100)>.01&&(h[h.length-1]=zn(h[h.length-1]+(100-S))),f=h}let p=[];for(let h=0;h<d;h+=1){let g=o.child(h),w=[];for(let S=0;S<c;S+=1){let x=g.child(S);w.push(x),S===s&&w.push(x.type.create(x.attrs,x.content,x.marks))}p.push(g.type.create(g.attrs,w))}let y=o.type.create(o.attrs,p),b=t.tr.replaceWith(r,r+o.nodeSize,y);b=b.setMeta(ce,!0);try{let h=He?.pmStateMod?.TextSelection;if(h){let g=Math.min(y.childCount-1,Math.max(0,i)),w=Math.min(c,Math.max(0,s+1)),S=y.child(g),x=S.child(w),T=r+1;for(let U=0;U<g;U+=1)T+=y.child(U).nodeSize;T+=1;for(let U=0;U<w;U+=1)T+=S.child(U).nodeSize;let N=T,B=N+1,$=N+x.nodeSize-1;b=b.setSelection(h.near(b.doc.resolve(Math.min($,B+1)),1))}}catch{}return e.view.dispatch(b.scrollIntoView()),Array.isArray(f)&&f.length===c+1?window.requestAnimationFrame(()=>{let h=Qt(e.view);ho(h,f)}):window.requestAnimationFrame(()=>{let h=Qt(e.view);xs(h)}),!0}catch{return!1}}function Jg(e,t,n){try{if(!e?.view)return!1;let{state:r,view:o}=e,{selection:i}=r,s=i?.$from||null;if(!s)return!1;let c=n instanceof Set?n:new Set(Array.from(n||[])),d=null;for(let B=s.depth;B>0;B-=1)if(s.node(B)?.type?.name==="paragraph"){let $=s.node(B-1)?.type?.name||"";c.has($)&&(d=B);break}if(d==null)return!1;let l=d-1,u=s.node(l),f=s.index(l);if(!u)return!1;let p=t<0?-1:1,y=f+p;if(!(y>=0&&y<u.childCount))return!1;let b=u.child(f),h=u.child(y);if(b?.type?.name!=="paragraph"||h?.type?.name!=="paragraph")return!1;let g=s.before(d),w=b.nodeSize,S=p<0?g-h.nodeSize:g+w,x=h.nodeSize,T=Math.max(0,i.from-s.start(d)),N=r.tr;if(p<0){N=N.delete(g,g+w),N=N.insert(S,b);let B=S,$=B+1,U=B+b.nodeSize-1,Y=$+T,J=Math.min(Math.max(Y,$),U);try{let re=He?.pmStateMod?.TextSelection;re&&(N=N.setSelection(re.near(N.doc.resolve(J),1)))}catch{}}else{N=N.delete(g,g+w);let B=g+x;N=N.insert(B,b);let $=B,U=$+1,Y=$+b.nodeSize-1,J=U+T,re=Math.min(Math.max(J,U),Y);try{let he=He?.pmStateMod?.TextSelection;he&&(N=N.setSelection(he.near(N.doc.resolve(re),1)))}catch{}}return N=N.setMeta(ce,!0),o.dispatch(N.scrollIntoView()),!0}catch{return!1}}function hf(e,t){return Jg(e,t,new Set(["outlineBody","tableCell","tableHeader"]))}function gf(e,t){try{if(!e?.view)return!1;let{state:n,view:r}=e,{selection:o}=n,i=o?.$from||null;if(!i)return!1;let s=null;for(let T=i.depth;T>0;T-=1)if(i.node(T)?.type?.name==="listItem"){s=T;break}if(s==null)return!1;let c=s-1,d=i.node(c),l=d?.type?.name||"";if(l!=="bulletList"&&l!=="orderedList")return!1;let u=i.index(c),f=t<0?-1:1,p=u+f;if(!(p>=0&&p<d.childCount))return!1;let y=d.child(u),b=d.child(p);if(y?.type?.name!=="listItem"||b?.type?.name!=="listItem")return!1;let h=i.before(s),g=y.nodeSize,w=b.nodeSize,S=Math.max(0,o.from-i.start(s)),x=n.tr;if(f<0){let T=h-w;x=x.delete(h,h+g),x=x.insert(T,y);let N=T,B=N+1,$=N+y.nodeSize-1,U=B+S,Y=Math.min(Math.max(U,B),$);try{let J=He?.pmStateMod?.TextSelection;J&&(x=x.setSelection(J.near(x.doc.resolve(Y),1)))}catch{}}else{x=x.delete(h,h+g);let T=h+w;x=x.insert(T,y);let N=T,B=N+1,$=N+y.nodeSize-1,U=B+S,Y=Math.min(Math.max(U,B),$);try{let J=He?.pmStateMod?.TextSelection;J&&(x=x.setSelection(J.near(x.doc.resolve(Y),1)))}catch{}}return x=x.setMeta(ce,!0),r.dispatch(x.scrollIntoView()),!0}catch{return!1}}function jg(e){if(!m.outlineToolbar||!e)return;let t=m.outlineToolbar,n={undo:m.outlineUndoBtn,redo:m.outlineRedoBtn,deleteBtn:m.outlineDeleteBtn,moveUpBtn:m.outlineMoveUpBtn,moveDownBtn:m.outlineMoveDownBtn,outdentBtn:m.outlineOutdentBtn,indentBtn:m.outlineIndentBtn,newBelowBtn:m.outlineNewBelowBtn,blocksMenuBtn:t.querySelector("#outlineBlocksMenuBtn"),textMenuBtn:t.querySelector("#outlineTextMenuBtn"),listsMenuBtn:t.querySelector("#outlineListsMenuBtn"),tableMenuBtn:t.querySelector("#outlineTableMenuBtn")},r=Array.from(t.querySelectorAll(".outline-toolbar__dropdown-btn")),o=Array.from(t.querySelectorAll(".outline-toolbar__menu")),i=Array.from(t.querySelectorAll("[data-outline-action]")),s=Array.from(t.querySelectorAll("[data-outline-clipboard-action]")),c=(Z,de)=>{if(!Z)return()=>{};let pe=ue=>{ue.preventDefault(),ue.stopPropagation(),de()};return Z.addEventListener("click",pe),()=>Z.removeEventListener("click",pe)},d=(Z,de)=>{if(!Z)return()=>{};let pe=0,ue=te=>{pe=Date.now(),te.preventDefault(),te.stopPropagation(),de()},le=te=>ue(te),ye=te=>ue(te),ge=te=>{if(Date.now()-pe<450){te.preventDefault(),te.stopPropagation();return}ue(te)};try{Z.addEventListener("pointerdown",le)}catch{}try{Z.addEventListener("touchstart",ye,{passive:!1})}catch{try{Z.addEventListener("touchstart",ye)}catch{}}return Z.addEventListener("click",ge),()=>{try{Z.removeEventListener("pointerdown",le)}catch{}Z.removeEventListener("touchstart",ye),Z.removeEventListener("click",ge)}},l=(Z,de)=>{Z&&(Z.classList.toggle("is-active",!!de),Z.setAttribute("aria-pressed",de?"true":"false"))},u=()=>{for(let Z of o)Z.classList.add("hidden");for(let Z of r)Z.setAttribute("aria-expanded","false")},f=()=>{let Z=sf(),de=!!(Z&&Array.isArray(Z.sections)&&Z.sections.length);for(let pe of s)pe?.getAttribute?.("data-outline-clipboard-action")==="paste"&&pe.toggleAttribute("disabled",!de)},p=Z=>{if(!Z)return;let de=Z.getAttribute("aria-controls"),pe=de?t.querySelector(`#${de}`):null;if(!pe)return;let ue=!pe.classList.contains("hidden");u(),ue||(de==="outlineBlocksMenu"&&f(),pe.classList.remove("hidden"),Z.setAttribute("aria-expanded","true"))},y=Z=>{try{let de=e.can().chain();return h()&&de.command(({tr:pe})=>(pe.setMeta(ce,!0),!0)),Z(de),de.run()}catch{return!1}},b=Z=>{if(!Z)return!1;try{let de=e.chain().focus();if(h()&&de.command(({tr:pe})=>(pe.setMeta(ce,!0),!0)),Z==="collapseAllBlocks")return Oc(e,!0);if(Z==="expandAllBlocks")return Oc(e,!1);if(Z==="toggleBold")return de.toggleBold().run();if(Z==="toggleItalic")return de.toggleItalic().run();if(Z==="toggleStrike")return de.toggleStrike().run();if(Z==="toggleCodeBlock")return e.commands.command(({state:pe,dispatch:ue})=>{let le=pe.schema.nodes?.codeBlock||null;if(!le)return!1;let ye=pe.selection,{from:ge,to:te}=ye;if(ge===te){let Qe=pe.tr.setMeta(ce,!0);return ue(Qe),e.commands.toggleCodeBlock()}let me=ye.$from?.blockRange?.(ye.$to)||null;if(!me){let Qe=pe.tr.setMeta(ce,!0);return ue(Qe),e.commands.toggleCodeBlock()}if(!me.parent?.canReplaceWith?.(me.startIndex,me.endIndex,le)){let Qe=pe.tr.setMeta(ce,!0);return ue(Qe),e.commands.toggleCodeBlock()}let Ee=pe.doc.textBetween(me.start,me.end,`
`,`
`),Ne=String(Ee||"").replace(/\n+$/g,"").trimEnd();if(!Ne)return!1;let Je=le.create(null,pe.schema.text(Ne)),je=pe.tr.replaceRangeWith(me.start,me.end,Je);return je=je.setMeta(ce,!0),J&&(je=je.setSelection(J.near(je.doc.resolve(me.start+2),1))),ue(je.scrollIntoView()),!0});if(Z==="toggleBlockquote")return de.toggleBlockquote().run();if(Z==="unsetLink")return de.unsetLink().run();if(Z==="toggleBulletList")return e.isActive("orderedList")?de.toggleOrderedList().toggleBulletList().run():de.toggleBulletList().run();if(Z==="toggleOrderedList")return e.isActive("bulletList")?de.toggleBulletList().toggleOrderedList().run():de.toggleOrderedList().run();if(Z==="unsetList")return e.isActive("bulletList")?de.toggleBulletList().run():e.isActive("orderedList")?de.toggleOrderedList().run():de.liftListItem("listItem").run();if(Z==="insertTable")return de.insertTable({rows:2,cols:2,withHeaderRow:!1}).run();if(Z==="toggleHeaderRow")return de.toggleHeaderRow().run();if(Z==="toggleHeaderColumn")return de.toggleHeaderColumn().run();if(Z==="addRowBefore")return de.addRowBefore().run();if(Z==="addRowAfter")return de.addRowAfter().run();if(Z==="deleteRow")return de.deleteRow().run();if(Z==="addColumnBefore"){let pe=Ft(e.state),ue=pe?Math.max(0,Number(pe.colIndex||0)):0,le=de.addColumnBefore().run();return le&&As(e,{insertIndex:ue,newColPct:10}),le}if(Z==="addColumnAfter"){let pe=Ft(e.state),ue=pe?Math.max(0,Number(pe.colIndex||0)+1):1,le=de.addColumnAfter().run();return le&&As(e,{insertIndex:ue,newColPct:10}),le}if(Z==="deleteColumn"){let pe=Qt(e.view),ue=mo(pe),le=Ft(e.state),ye=le?Number(le.colIndex||0):null,ge=ue&&ye!=null?Hf(ue,ye):null,te=de.deleteColumn().run();return te&&Array.isArray(ge)&&window.requestAnimationFrame(()=>{let me=Qt(e.view);ho(me,ge)}),te}return Z==="mergeCells"?de.mergeCells().run():Z==="splitCell"?de.splitCell().run():Z==="copyColumn"||Z==="pasteColumnAfter"||Z==="moveColumnRight"?!1:Z==="cancelTable"?w():Z==="deleteTable"?de.deleteTable().run():!1}catch{return!1}},h=()=>{try{return!!(Ae?.getState?.(e.state)||null)?.editingSectionId}catch{return!1}},g=()=>h()?!0:(po(),!1),w=()=>{if(!g())return!1;try{let{state:Z,view:de}=e,{schema:pe,selection:ue}=Z,le=ue?.$from;if(!le)return!1;let ye=null;for(let Xe=le.depth;Xe>=0;Xe-=1)le.node(Xe)?.type?.name==="table"&&(ye=Xe);if(ye==null)return!1;let ge=null,te=null;for(let Xe=ye+1;Xe<=le.depth;Xe+=1){let ze=le.node(Xe)?.type?.name;if(ge==null&&ze==="tableRow"&&(ge=Xe),te==null&&(ze==="tableCell"||ze==="tableHeader")&&(te=Xe),ge!=null&&te!=null)break}let me=le.before(ye),Ee=Z.doc.nodeAt(me);if(!Ee||Ee.type?.name!=="table")return!1;let Ne=ge!=null?le.index(ye):null,Je=ge!=null&&te!=null?le.index(ge):null,je=null;if(typeof Ne=="number"&&typeof Je=="number"){let Xe=Ee.childCount&&Ee.child(0)?.childCount||0;Xe>0&&(je=Ne*Xe+Je)}let Qe=[],Ve=0,rt=0;for(let Xe=0;Xe<Ee.childCount;Xe+=1){let lt=Ee.child(Xe);for(let ze=0;ze<lt.childCount;ze+=1){let Kt=lt.child(ze),zt=[];try{for(let Jt=0;Jt<(Kt?.content?.childCount||0);Jt+=1){let jt=Kt.content.child(Jt);jt&&zt.push(jt)}}catch{}zt.length||zt.push(pe.nodes.paragraph.create(null,[])),je!=null&&Ve===je&&(rt=Qe.length),Qe.push(...zt),Ve+=1}}if(!Qe.length)return!1;let ct=pe.nodes.outlineBody?pe.nodes.outlineBody.create({},Qe).content:pe.nodes.doc.create({},Qe).content,Ze=Z.tr.replaceWith(me,me+Ee.nodeSize,ct);Ze=Ze.setMeta(ce,!0);try{let Xe=He?.pmStateMod?.TextSelection;if(Xe){let lt=me;for(let jt=0;jt<rt;jt+=1)lt+=Qe[jt].nodeSize;let ze=null,Kt=Math.min(Ze.doc.content.size,lt),zt=Math.min(Ze.doc.content.size,lt+2e4);Ze.doc.nodesBetween(Kt,zt,(jt,Nn)=>ze!=null?!1:jt?.isTextblock?(ze=Nn+1,!1):!0);let Jt=ze??Math.min(Ze.doc.content.size,lt+1);Ze=Ze.setSelection(Xe.near(Ze.doc.resolve(Jt),1))}}catch{}return de.dispatch(Ze.scrollIntoView()),de.focus?.(),!0}catch{return!1}},S=()=>{if(!g())return!1;try{let{state:Z,view:de}=e,{selection:pe}=Z,ue=pe?.$from;if(!ue)return!1;let le=null,ye=null,ge=null;for(let Ze=ue.depth;Ze>=0;Ze-=1){let lt=ue.node(Ze)?.type?.name;if(ge==null&&(lt==="tableCell"||lt==="tableHeader")&&(ge=Ze),ye==null&&lt==="tableRow"&&(ye=Ze),lt==="table"){le=Ze;break}}if(le==null||ye==null||ge==null)return!1;let te=ue.before(le),me=Z.doc.nodeAt(te);if(!me||me.type?.name!=="table")return!1;let Ee=ue.index(le),Ne=ue.index(ye),Je=me.child(0)?.childCount||0;if(!(Je>0)||!(Ne>=0&&Ne<Je-1))return!1;let je=!1;if(me.descendants(Ze=>{if(je)return!1;let Xe=Ze?.type?.name;if(Xe==="tableCell"||Xe==="tableHeader"){let lt=Number(Ze.attrs?.colspan||1),ze=Number(Ze.attrs?.rowspan||1);if(lt!==1||ze!==1)return je=!0,!1}return!0}),je)return L("\u041F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 \u0441\u0442\u043E\u043B\u0431\u0446\u043E\u0432 \u043F\u043E\u043A\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u0445 \u044F\u0447\u0435\u0435\u043A"),!1;let Qe=pe.from-ue.start(ge),Ve=[];for(let Ze=0;Ze<me.childCount;Ze+=1){let Xe=me.child(Ze);if(Xe.type?.name!=="tableRow"||Xe.childCount!==Je)return!1;let lt=[];for(let ze=0;ze<Je;ze+=1)ze===Ne?lt.push(Xe.child(ze+1)):ze===Ne+1?lt.push(Xe.child(ze-1)):lt.push(Xe.child(ze));Ve.push(Xe.type.create(Xe.attrs,lt))}let rt=me.type.create(me.attrs,Ve),ct=Z.tr.replaceWith(te,te+me.nodeSize,rt);ct=ct.setMeta(ce,!0);try{let Ze=He?.pmStateMod?.TextSelection;if(Ze){let Xe=Math.min(rt.childCount-1,Math.max(0,Ee)),lt=Ne+1,ze=rt.child(Xe),Kt=ze.child(lt),zt=te+1;for(let Un=0;Un<Xe;Un+=1)zt+=rt.child(Un).nodeSize;zt+=1;for(let Un=0;Un<lt;Un+=1)zt+=ze.child(Un).nodeSize;let Jt=zt,jt=Jt+1,Nn=Jt+Kt.nodeSize-1,Ut=jt+Math.max(0,Qe),Jr=Math.min(Math.max(Ut,jt),Nn);ct=ct.setSelection(Ze.near(ct.doc.resolve(Jr),1))}}catch{}return de.dispatch(ct.scrollIntoView()),de.focus?.(),!0}catch{return!1}},x=(Z,de,pe={})=>{let ue=String(Z||"").trim();if(!ue)return!1;let le=String(de||"").trim()||ue,{from:ye,to:ge,empty:te}=e.state.selection,me={href:ue,...pe},Ee=e.chain().focus();return h()&&Ee.command(({tr:Ne})=>(Ne.setMeta(ce,!0),!0)),!te&&ye!==ge?Ee.setLink(me).run():Ee.insertContent({type:"text",text:le,marks:[{type:"link",attrs:me}]}).run()},T=async()=>{if(!g())return;let{from:Z,to:de,empty:pe}=e.state.selection,ue=pe?"":e.state.doc.textBetween(Z,de," ").trim(),le="",ye=ue;try{let te=await(await Promise.resolve().then(()=>(Rn(),ka))).showLinkPrompt({title:"\u0421\u0441\u044B\u043B\u043A\u0430 (URL)",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0441\u0441\u044B\u043B\u043A\u0443 (\u043B\u044E\u0431\u043E\u0439 \u0444\u043E\u0440\u043C\u0430\u0442) \u0438 \u0442\u0435\u043A\u0441\u0442 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E).",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",textLabel:"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)",urlLabel:"\u0421\u0441\u044B\u043B\u043A\u0430",defaultText:ue,defaultUrl:"",urlPlaceholder:""});if(!te||typeof te!="object")return;le=String(te.url||""),ye=String(te.text??ue)}catch{le=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0441\u0441\u044B\u043B\u043A\u0443")||"",ye=ue||window.prompt("\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)")||""}le=(le||"").trim(),le&&x(le,ye,{target:"_blank",rel:"noopener noreferrer"})},N=async()=>{if(!g())return;let Z=Array.isArray(a.articlesIndex)?a.articlesIndex:[];Z.length||(Z=await yn().catch(()=>[])||[],Array.isArray(Z)&&(a.articlesIndex=Z));let de=(Array.isArray(Z)?Z:[]).map(Qe=>({id:Qe.id,title:Qe.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),{from:pe,to:ue,empty:le}=e.state.selection,ye=le?"":e.state.doc.textBetween(pe,ue," ").trim(),ge=!!ye,te="",me="",Ee=ye;try{let Ve=await(await Promise.resolve().then(()=>(Rn(),ka))).showArticleLinkPrompt({title:"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E \u0438 \u0437\u0430\u0434\u0430\u0439\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438.",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:de,defaultTextValue:ye,lockTextValue:ge});if(Ve&&typeof Ve=="object")te=Ve.articleValue||"",me=Ve.selectedId||"",Ee=Ve.textValue||"";else return}catch{te=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438")||"",Ee=ye||window.prompt("\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)")||""}let Ne=(te||"").trim().toLowerCase();if(!Ne&&!me)return;let Je=(Array.isArray(Z)?Z:[]).find(Qe=>{let Ve=(Qe.title||"").toLowerCase();return me&&Qe.id===me||Qe.id&&Qe.id.toLowerCase()===Ne||Ve===Ne||Ve.includes(Ne)});if(!Je){L("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}let je=(Ee||"").trim()||Je.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";x(pt.article(Je.id),je,{class:"article-link"})},B=()=>{if(!a.isOutlineEditing||!e||e.isDestroyed)return;let Z=h();if(t.dataset.editing=Z?"true":"false",Z||u(),n.deleteBtn&&(n.deleteBtn.hidden=Z),n.moveUpBtn&&(n.moveUpBtn.hidden=Z),n.moveDownBtn&&(n.moveDownBtn.hidden=Z),n.outdentBtn&&(n.outdentBtn.hidden=Z),n.indentBtn&&(n.indentBtn.hidden=Z),n.newBelowBtn&&(n.newBelowBtn.hidden=Z),n.blocksMenuBtn&&(n.blocksMenuBtn.hidden=Z),Z&&ir&&ti(!1),n.undo&&(n.undo.disabled=!y(ue=>ue.undo())),n.redo&&(n.redo.disabled=!y(ue=>ue.redo())),n.textMenuBtn){let ue=e.isActive("bold")||e.isActive("italic")||e.isActive("strike")||e.isActive("codeBlock")||e.isActive("blockquote");l(n.textMenuBtn,ue),n.textMenuBtn.hidden=!Z}if(n.listsMenuBtn){let ue=e.isActive("bulletList")||e.isActive("orderedList");l(n.listsMenuBtn,ue),n.listsMenuBtn.hidden=!Z}if(n.tableMenuBtn){let ue=e.isActive("table");l(n.tableMenuBtn,ue),n.tableMenuBtn.hidden=!Z}let de=null,pe=()=>{if(de)return de;let ue={total:0,collapsed:0};try{e.state.doc.descendants(le=>{le?.type?.name==="outlineSection"&&(ue.total+=1,le.attrs?.collapsed&&(ue.collapsed+=1))})}catch{}return de=ue,ue};for(let ue of i){let le=ue.dataset.outlineAction||"";if(!le)continue;let ye=!1,ge=!1;if(le==="collapseAllBlocks"){let te=pe();ye=!1,ge=te.total===0||te.collapsed>=te.total}else if(le==="expandAllBlocks"){let te=pe();ye=!1,ge=te.total===0||te.collapsed<=0}else le==="toggleBold"?(ye=e.isActive("bold"),ge=!y(te=>te.toggleBold())):le==="toggleItalic"?(ye=e.isActive("italic"),ge=!y(te=>te.toggleItalic())):le==="toggleStrike"?(ye=e.isActive("strike"),ge=!y(te=>te.toggleStrike())):le==="toggleCodeBlock"?(ye=e.isActive("codeBlock"),ge=!h()):le==="toggleBlockquote"?(ye=e.isActive("blockquote"),ge=!y(te=>te.toggleBlockquote())):le==="insertHttpLink"||le==="insertArticleLink"?(ye=!1,ge=!h()):le==="unsetLink"?(ye=e.isActive("link"),ge=!y(te=>te.unsetLink())):le==="toggleBulletList"?(ye=e.isActive("bulletList"),e.isActive("orderedList")?ge=!(y(te=>te.toggleOrderedList())&&y(te=>te.toggleBulletList())):ge=!y(te=>te.toggleBulletList())):le==="toggleOrderedList"?(ye=e.isActive("orderedList"),e.isActive("bulletList")?ge=!(y(te=>te.toggleBulletList())&&y(te=>te.toggleOrderedList())):ge=!y(te=>te.toggleOrderedList())):le==="unsetList"?(ye=!1,e.isActive("bulletList")?ge=!y(te=>te.toggleBulletList()):e.isActive("orderedList")?ge=!y(te=>te.toggleOrderedList()):ge=!y(te=>te.liftListItem("listItem"))):le==="insertTable"?(ye=!1,ge=!y(te=>te.insertTable({rows:2,cols:2,withHeaderRow:!1}))):le==="toggleHeaderRow"?(ye=e.isActive("tableHeader"),ge=!y(te=>te.toggleHeaderRow())):le==="toggleHeaderColumn"?(ye=e.isActive("tableHeader"),ge=!y(te=>te.toggleHeaderColumn())):le==="addRowBefore"?(ye=!1,ge=!y(te=>te.addRowBefore())):le==="addRowAfter"?(ye=!1,ge=!y(te=>te.addRowAfter())):le==="deleteRow"?(ye=!1,ge=!y(te=>te.deleteRow())):le==="addColumnBefore"?(ye=!1,ge=!y(te=>te.addColumnBefore())):le==="addColumnAfter"?(ye=!1,ge=!y(te=>te.addColumnAfter())):le==="deleteColumn"?(ye=!1,ge=!y(te=>te.deleteColumn())):le==="copyColumn"||le==="pasteColumnAfter"||le==="moveColumnRight"?(ye=!1,ge=!0):le==="mergeCells"?(ye=!1,ge=!y(te=>te.mergeCells())):le==="splitCell"?(ye=!1,ge=!y(te=>te.splitCell())):le==="cancelTable"?(ye=!1,ge=!h()||!e.isActive("table")):le==="deleteTable"&&(ye=!1,ge=!y(te=>te.deleteTable()));ue.disabled=!!ge,ue.classList.toggle("is-active",!!ye)}},$=null,U=()=>{$||($=window.requestAnimationFrame(()=>{$=null,B()}))},Y=[c(n.undo,()=>e.chain().focus().undo().run()),c(n.redo,()=>e.chain().focus().redo().run())],J=He?.pmStateMod?.TextSelection||null,re=(Z,de)=>{try{let pe=Z.resolve(Math.min(Z.content.size,de+1)),ue=null;for(let le=pe.depth;le>0;le-=1){if(pe.node(le)?.type?.name!=="outlineSection")continue;if(pe.before(le)===de){ue=le;break}}if(ue===null)return null;for(let le=ue-1;le>0;le-=1)if(pe.node(le)?.type?.name==="outlineSection")return pe.before(le);return null}catch{return null}},he=Z=>{try{if(!J)return;e.commands.command(({state:de,dispatch:pe})=>{let ue=Bt(de.doc,de.selection.$from);if(typeof ue!="number")return!1;let le=de.doc.resolve(ue),ye=le.index(),ge=le.parent;if(!ge)return!1;let te=de.doc.nodeAt(ue);if(!te)return!1;if(Z==="up"){if(ye>0){let jt=ge.child(ye-1),Nn=ue-jt.nodeSize,Ut=de.tr.delete(ue,ue+te.nodeSize).insert(Nn,te);return Ut=Ut.setMeta(ce,!0),Ut=Ut.setSelection(J.near(Ut.doc.resolve(Nn+2),1)),pe(Ut.scrollIntoView()),!0}let me=re(de.doc,ue);if(typeof me!="number")return!1;let Ee=de.doc.resolve(me),Ne=Ee.index(),Je=Ee.parent;if(!Je||Ne<=0)return!1;let je=Je.child(Ne-1),Qe=me-je.nodeSize,Ve=de.doc.nodeAt(Qe);if(!Ve||Ve.type?.name!=="outlineSection")return!1;let rt=Ve.child(0),ct=Ve.child(1),Ze=Ve.child(2),lt=Qe+1+rt.nodeSize+ct.nodeSize+Ze.nodeSize-1,ze=de.tr.delete(ue,ue+te.nodeSize).setMeta(ce,!0),Kt=ze.mapping.map(Qe,-1),zt=ze.mapping.map(lt,-1);ze=ze.insert(zt,te);let Jt=ze.doc.nodeAt(Kt);return Jt?.type?.name==="outlineSection"&&Jt.attrs?.collapsed&&(ze=ze.setNodeMarkup(Kt,void 0,{...Jt.attrs,collapsed:!1})),ze=ze.setSelection(J.near(ze.doc.resolve(zt+2),1)),pe(ze.scrollIntoView()),!0}if(Z==="down"){if(ye<ge.childCount-1){let jt=ue+te.nodeSize,Nn=de.doc.nodeAt(jt);if(!Nn)return!1;let Ut=de.tr.delete(ue,ue+te.nodeSize),Jr=ue+Nn.nodeSize;return Ut=Ut.insert(Jr,te),Ut=Ut.setMeta(ce,!0),Ut=Ut.setSelection(J.near(Ut.doc.resolve(Jr+2),1)),pe(Ut.scrollIntoView()),!0}let me=re(de.doc,ue);if(typeof me!="number")return!1;let Ee=de.doc.nodeAt(me);if(!Ee||Ee.type?.name!=="outlineSection")return!1;let Ne=de.doc.resolve(me),Je=Ne.index(),je=Ne.parent;if(!je||Je>=je.childCount-1)return!1;let Qe=me+Ee.nodeSize,Ve=de.doc.nodeAt(Qe);if(!Ve||Ve.type?.name!=="outlineSection")return!1;let rt=Ve.child(0),ct=Ve.child(1),Ze=Ve.child(2),lt=Qe+1+rt.nodeSize+ct.nodeSize+1,ze=de.tr.delete(ue,ue+te.nodeSize).setMeta(ce,!0),Kt=ze.mapping.map(Qe,-1),zt=ze.mapping.map(lt,-1);ze=ze.insert(zt,te);let Jt=ze.doc.nodeAt(Kt);return Jt?.type?.name==="outlineSection"&&Jt.attrs?.collapsed&&(ze=ze.setNodeMarkup(Kt,void 0,{...Jt.attrs,collapsed:!1})),ze=ze.setSelection(J.near(ze.doc.resolve(zt+2),1)),pe(ze.scrollIntoView()),!0}return!1})}catch{}},Re=()=>{try{if(!J)return;e.commands.command(({state:Z,dispatch:de})=>{let pe=Bt(Z.doc,Z.selection.$from);if(typeof pe!="number")return!1;let ue=Z.doc.resolve(pe),le=0;for(let Xe=ue.depth;Xe>=0;Xe-=1)ue.node(Xe)?.type?.name==="outlineSection"&&(le+=1);if(le>=6)return!1;let ye=ue.index(),ge=ue.parent;if(!ge||ye<=0)return!1;let te=Z.doc.nodeAt(pe);if(!te)return!1;let me=ge.child(ye-1),Ee=pe-me.nodeSize,Ne=Z.doc.nodeAt(Ee);if(!Ne)return!1;let Je=Ne.child(0),je=Ne.child(1),Qe=Ne.child(2),rt=Ee+1+Je.nodeSize+je.nodeSize+Qe.nodeSize-1,ct=Z.tr.delete(pe,pe+te.nodeSize).insert(rt,te),Ze=ct.doc.nodeAt(Ee);return Ze?.type?.name==="outlineSection"&&Ze.attrs?.collapsed&&(ct=ct.setNodeMarkup(Ee,void 0,{...Ze.attrs,collapsed:!1})),ct=ct.setMeta(ce,!0),ct=ct.setSelection(J.near(ct.doc.resolve(rt+2),1)),de(ct.scrollIntoView()),!0})}catch{}},G=()=>{try{if(!J)return;e.commands.command(({state:Z,dispatch:de})=>{let pe=Z.selection.$from,ue=null,le=null;for(let Je=pe.depth;Je>0;Je-=1)if(pe.node(Je)?.type?.name==="outlineSection")if(ue===null)ue=Je;else{le=Je;break}if(ue===null||le===null)return!1;let ye=pe.before(ue),ge=pe.before(le),te=Z.doc.nodeAt(ye);if(!te)return!1;let me=Z.tr.delete(ye,ye+te.nodeSize),Ee=me.doc.nodeAt(ge);if(!Ee)return!1;let Ne=ge+Ee.nodeSize;return me=me.insert(Ne,te),me=me.setMeta(ce,!0),me=me.setSelection(J.near(me.doc.resolve(Ne+2),1)),de(me.scrollIntoView()),!0})}catch{}},ie=()=>{try{if(!J)return;e.commands.command(({state:Z,dispatch:de})=>{let pe=Bt(Z.doc,Z.selection.$from);if(typeof pe!="number")return!1;let ue=Z.doc.nodeAt(pe);if(!ue)return!1;let le=String(ue.attrs?.id||"").trim(),ye=Z.doc.resolve(pe),ge=ye.index(),te=ye.parent;if(!te)return!1;let me=Z.doc.type.schema;if(te.childCount<=1){let rt=me.nodes.outlineSection.create({...ue.attrs,collapsed:!1},[me.nodes.outlineHeading.create({},[]),me.nodes.outlineBody.create({},[me.nodes.paragraph.create({},[])]),me.nodes.outlineChildren.create({},[])]),ct=Z.tr.replaceWith(pe,pe+ue.nodeSize,rt);ct=ct.setMeta(ce,!0);let Ze=rt.child(0),Xe=pe+1+Ze.nodeSize;return ct=ct.setSelection(J.near(ct.doc.resolve(Xe+2),1)),de(ct.scrollIntoView()),!0}le&&uo(le);let Ee=ge>0,Ne=Ee?te.child(ge-1):null,Je=Ee?pe-Ne.nodeSize:null,je=Z.tr.delete(pe,pe+ue.nodeSize);je=je.setMeta(ce,!0);let Qe=Ee&&typeof Je=="number"?Je:Math.min(je.doc.content.size,pe),Ve=je.doc.nodeAt(Qe);if(Ve?.type?.name==="outlineSection"){let rt=Ve.child(0),ct=Ve.child(1),Ze=Qe+1+rt.nodeSize;ct.childCount||(je=je.insert(Ze+1,me.nodes.paragraph.create({},[]))),je=je.setSelection(J.near(je.doc.resolve(Ze+2),1))}return de(je.scrollIntoView()),!0})}catch{}},$e=()=>{try{if(!J)return;e.commands.command(({state:Z,dispatch:de})=>{let pe=Bt(Z.doc,Z.selection.$from);if(typeof pe!="number")return!1;let ue=Z.doc.nodeAt(pe);if(!ue)return!1;let le=Z.doc.type.schema,ye=pe+ue.nodeSize,ge=Xt(),te=le.nodes.outlineSection.create({id:ge,collapsed:!1},[le.nodes.outlineHeading.create({},[]),le.nodes.outlineBody.create({},[le.nodes.paragraph.create({},[])]),le.nodes.outlineChildren.create({},[])]),me=Z.tr.insert(ye,te);return me=me.setSelection(J.create(me.doc,ye+2)),me=me.setMeta(ce,!0),Ae&&(me=me.setMeta(Ae,{type:"enter",sectionId:ge})),de(me.scrollIntoView()),!0})}catch{}};Y.push(c(n.deleteBtn,()=>ie())),Y.push(c(n.moveUpBtn,()=>he("up"))),Y.push(c(n.moveDownBtn,()=>he("down"))),Y.push(c(n.outdentBtn,()=>G())),Y.push(c(n.indentBtn,()=>Re())),Y.push(c(n.newBelowBtn,()=>$e()));for(let Z of r)Y.push(d(Z,()=>p(Z)));for(let Z of i)Y.push(c(Z,()=>{let de=Z.dataset.outlineAction||"";if(de==="insertHttpLink"){u(),T().finally(()=>U());return}if(de==="insertArticleLink"){u(),N().finally(()=>U());return}let pe=b(de);u(),pe&&U()}));for(let Z of s)Y.push(c(Z,()=>{let de=Z.getAttribute("data-outline-clipboard-action")||"";if(!de)return;u();let pe=on||null,ue=Ar instanceof Set?Ar:new Set,le=ue.size?new Set(ue):pe?new Set([pe]):new Set;if(de==="toggleSelectMode"){ti(!ir);return}if(de==="clear"){Ec(null),L("\u0411\u0443\u0444\u0435\u0440 \u043E\u0447\u0438\u0449\u0435\u043D");return}if(oe){if(de==="copy"||de==="cut"){if(!le.size){L("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A");return}let ye=bg(oe.state.doc,le);if(!ye.length){L("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A");return}let ge=ye.map(Ee=>Ee.node.toJSON());try{let Ee=ye.map(Ne=>Tf(Ne.node)).filter(Boolean).join(`

`);Sg(Ee)}catch{}if(Ec({mode:de==="cut"?"cut":"copy",sourceArticleId:Lt||a.articleId||null,createdAt:new Date().toISOString(),sections:ge}),de==="copy"){L(`\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${ge.length}`);return}let te=[];for(let Ee of ye){let Ne=mt(oe.state.doc,Ee.id),Je=typeof Ne=="number"?oe.state.doc.nodeAt(Ne):null;typeof Ne=="number"&&Je&&te.push({pos:Ne,size:Je.nodeSize})}te.sort((Ee,Ne)=>Ne.pos-Ee.pos);let me=oe.state.tr;for(let{pos:Ee,size:Ne}of te)me=me.delete(Ee,Ee+Ne);me=me.setMeta(ce,!0),oe.view.dispatch(me.scrollIntoView()),oe.view.focus(),an=!0,sn({delayMs:200}),ti(!1),L(`\u0412\u044B\u0440\u0435\u0437\u0430\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${ge.length}`);return}if(de==="paste"){let ye=sf();if(!ye||!Array.isArray(ye.sections)||!ye.sections.length){L("\u0411\u0443\u0444\u0435\u0440 \u043F\u0443\u0441\u0442");return}let ge=oe.state,te=ge.doc.content.size;if(pe){let Ve=mt(ge.doc,pe),rt=typeof Ve=="number"?ge.doc.nodeAt(Ve):null;typeof Ve=="number"&&rt&&(te=Ve+rt.nodeSize)}let me=new Set;try{ge.doc.descendants(Ve=>{if(Ve?.type?.name!=="outlineSection")return;let rt=String(Ve.attrs?.id||"").trim();rt&&me.add(rt)})}catch{}let Ee=[];if(ye.mode==="copy")for(let Ve of ye.sections)Ee.push(wg(Ve,()=>Xt()));else for(let Ve of ye.sections){let rt=String(Ve?.attrs?.id||"").trim();if(rt&&me.has(rt)){L("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C: \u0431\u043B\u043E\u043A \u0441 \u0442\u0430\u043A\u0438\u043C id \u0443\u0436\u0435 \u0435\u0441\u0442\u044C");return}Ee.push(Ef(Ve))}let Ne=ge.doc.type.schema,Je=[];for(let Ve of Ee)try{let rt=Ne.nodeFromJSON(Ve);rt?.type?.name==="outlineSection"&&Je.push(rt)}catch{}if(!Je.length){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438");return}let je=ge.tr,Qe=te;for(let Ve of Je)je=je.insert(Qe,Ve),Qe+=Ve.nodeSize;je=je.setMeta(ce,!0),oe.view.dispatch(je.scrollIntoView()),oe.view.focus(),an=!0,sn({delayMs:200}),ye.mode==="cut"&&Ec(null),ti(!1),L(`\u0412\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${Je.length}`)}}}));let dt=Z=>{a.isOutlineEditing&&(t.contains(Z.target)||u())},ut=Z=>{a.isOutlineEditing&&Z.key==="Escape"&&u()};document.addEventListener("pointerdown",dt),document.addEventListener("keydown",ut),Y.push(()=>document.removeEventListener("pointerdown",dt)),Y.push(()=>document.removeEventListener("keydown",ut));let Zt=e.on("transaction",U),Mn=e.on("selectionUpdate",U);Y.push(()=>Zt?.()),Y.push(()=>Mn?.());try{let Z=Lg({setActiveTagKey:de=>{try{Is?.(de)}catch{}}});Y.push(()=>Z?.())}catch{}U(),ws=()=>{$&&(window.cancelAnimationFrame($),$=null);for(let Z of Y)try{Z()}catch{}}}function Wg(){if(ws)try{ws()}catch{}ws=null}function Ir(e=""){let t=String(e||"");a.outlineStatusText=t,m.updatedAt&&a.isOutlineEditing&&(m.updatedAt.textContent=t)}function Yg(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=r.child(1),s=t+1+o.nodeSize,c=n.tr;if(!i.childCount){let l=n.doc.type.schema;c=c.insert(s+1,l.nodes.paragraph.create({},[]))}let{TextSelection:d}=He?.pmStateMod||{};return d?(c=c.setSelection(d.near(c.doc.resolve(s+2),1)),e.view.dispatch(c.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0):!1}catch{return!1}}function Xg(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=t+1,{TextSelection:s}=He?.pmStateMod||{};if(!s)return!1;let c=i+1,d=i+o.nodeSize-1,l=Math.min(Math.max(c,c),Math.max(c,d)),u=n.tr.setSelection(s.near(n.doc.resolve(l),1));return u=u.setMeta(ce,!0),e.view.dispatch(u.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0}catch{return!1}}function Gg(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=t+1,{TextSelection:s}=He?.pmStateMod||{};if(!s)return!1;let c=i+1,d=i+o.nodeSize-1,l=Math.max(c,d),u=n.tr.setSelection(s.near(n.doc.resolve(l),-1));return u=u.setMeta(ce,!0),e.view.dispatch(u.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0}catch{return!1}}function Qg(e,t){try{if(!e)return!1;let n=String(t||"").trim();if(!n)return!1;let r=e.state,o=mt(r.doc,n);if(typeof o!="number")return!1;let i=r.doc.nodeAt(o);if(!i||i.type?.name!=="outlineSection")return!1;if(i.attrs?.collapsed)return Xg(e,o);try{if(!i.child(1)?.childCount)return Gg(e,o)}catch{}return Yg(e,o)}catch{return!1}}async function Zg(){if(He)return He;if(typeof window>"u")throw new Error("Outline editor is browser-only");let e=Rr()?performance.now():0,t=await import("/outline/tiptap.bundle.js");return e&&fo("import tiptap.bundle.js",{ms:Math.round(performance.now()-e)}),He={core:t.core,starterKitMod:t.starterKitMod,htmlMod:t.htmlMod,pmStateMod:t.pmStateMod,pmViewMod:t.pmViewMod,pmTablesMod:t.pmTablesMod,linkMod:t.linkMod,imageMod:t.imageMod,tableMod:t.tableMod,tableRowMod:t.tableRowMod,tableCellMod:t.tableCellMod,tableHeaderMod:t.tableHeaderMod,uniqueIdMod:t.uniqueIdMod,markdownMod:t.markdownMod},He}function ey({blocks:e,parseHtmlToNodes:t}){let n=i=>Array.isArray(i)&&i.length>0?i:[{type:"paragraph",content:[]}],r=i=>{let s=String(i?.id||Xt()),c=!!i?.collapsed,d=xn(String(i?.text||"")),l=Hc(d.titleHtml)||"",u=n(t(d.bodyHtml||"")),f=Array.isArray(i?.children)?i.children:[];return{type:"outlineSection",attrs:{id:s,collapsed:c},content:[{type:"outlineHeading",content:l?[{type:"text",text:l}]:[]},{type:"outlineBody",content:u},{type:"outlineChildren",content:f.map(r)}]}},o=(Array.isArray(e)?e:[]).map(r);return{type:"doc",content:o.length?o:[r({id:Xt(),text:"",collapsed:!1,children:[]})]}}function ty(e){try{let t=String(e||"").trim();if(!t)return null;let n=window?.localStorage?.getItem?.("ttree_outline_last_active_v1")||"{}",r=JSON.parse(n||"{}"),o=r&&typeof r=="object"?r[t]:null;if(!o||typeof o!="object")return null;let i=String(o.sectionId||"").trim();return i?{sectionId:i,collapsed:!!o.collapsed}:null}catch{return null}}function Vf(e,t,n){try{let r=String(e||"").trim(),o=String(t||"").trim();if(!r||!o)return!1;let i=window?.localStorage?.getItem?.("ttree_outline_last_active_v1")||"{}",s=JSON.parse(i||"{}"),c=s&&typeof s=="object"?s:{};return c[r]={sectionId:o,collapsed:!!n,savedAt:new Date().toISOString()},window?.localStorage?.setItem?.("ttree_outline_last_active_v1",JSON.stringify(c)),!0}catch{return!1}}function yf(e){try{let t=Lt||a.articleId||null;if(!t||!e||e.isDestroyed)return!1;let n=e.state,r=Bt(n.doc,n.selection.$from);if(typeof r!="number")return!1;let o=n.doc.nodeAt(r);if(!o||o.type?.name!=="outlineSection")return!1;let i=String(o.attrs?.id||"").trim();if(!i)return!1;let s=!!o.attrs?.collapsed;return gs.articleId===t&&gs.sectionId===i&&gs.collapsed===s?!1:(gs={articleId:t,sectionId:i,collapsed:s},Vf(t,i,s))}catch{return!1}}function ny(e,{lines:t=4}={}){try{if(!e||e.isDestroyed)return!1;let n=e.view;if(!n||!n.state||!n.dom)return!1;let r=n.state.selection;return!r||typeof r.from!="number"?!1:(ys&&cancelAnimationFrame(ys),ys=requestAnimationFrame(()=>{ys=null;try{let o=n.coordsAtPos(r.from);if(!o||typeof o.bottom!="number")return;let s=(w=>{try{let S=w;for(;S&&S!==document.body&&S!==document.documentElement;){let x=window.getComputedStyle(S),T=String(x.overflowY||"");if((T==="auto"||T==="scroll"||T==="overlay")&&S.scrollHeight>S.clientHeight+2)return S;S=S.parentElement}}catch{}return document.scrollingElement||document.documentElement})(n.dom),c=window.getComputedStyle(n.dom),d=String(c.lineHeight||"").trim(),l=d==="normal"?20:Number.parseFloat(d)||20,u=Math.max(24,l*Math.max(1,Number(t)||4)+12),f=window.innerHeight||0,p=0;if(s&&s!==document.scrollingElement&&s!==document.documentElement&&s!==document.body){let w=s.getBoundingClientRect();p=w.top,f=w.height}if(!f)return;let y=o.bottom-p,b=f-u;if(y<=b)return;let h=y-b,g=Math.max(0,(s.scrollTop||0)+h);s.scrollTop=g}catch{}}),!0)}catch{return!1}}function Bt(e,t){try{if(t?.nodeAfter?.type?.name==="outlineSection")return t.pos}catch{}for(let n=t.depth;n>0;n-=1)if(t.node(n)?.type?.name==="outlineSection")return t.before(n);return null}function Cs(e){if(!e)return"";let t=e.child(0),n=e.child(1),r=$r(t?.textContent||""),o="";try{o=$r(n?.textBetween?.(0,n.content.size,`
`,`
`)||"")}catch{o=$r(n?.textContent||"")}return $r(`${r}
${o}`)}function bf(e){if(!e)return"";let t=e.child(1),n="";try{n=$r(t?.textBetween?.(0,t.content.size,`
`,`
`)||"")}catch{n=$r(t?.textContent||"")}return n}function wf(e){if(!Mc||!Nc)return"";let t=[];return e?.content?.forEach?.(o=>{t.push(o.toJSON())}),(Mc({type:"doc",content:t},Nc)||""||"").trim()}function ry(e,t,n){if(!e||!t||!ii)return!1;let r=mt(e.state.doc,t);if(typeof r!="number")return!1;let o=e.state.doc.nodeAt(r);if(!o)return!1;let i=o.child(0),s=o.child(1),c=r+1+i.nodeSize,d=e.state.schema,l=[];try{l=ii(n||"")}catch{l=[]}let u=[];try{u=(Array.isArray(l)?l:[]).map(y=>d.nodeFromJSON(y))}catch{u=[d.nodes.paragraph.create({},[])]}u.length||(u=[d.nodes.paragraph.create({},[])]);let f=d.nodes.outlineBody.create({},u),p=e.state.tr.replaceWith(c,c+s.nodeSize,f).setMeta(ce,!0);return e.view.dispatch(p),!0}function Fc(e){if(!e)return!0;let t=e.child(0);return!$r(t?.textContent||"")}function oy(e,t,n){if(!e||!t)return!1;let r=mt(e.state.doc,t);if(typeof r!="number")return!1;let o=e.state.doc.nodeAt(r);if(!o||!Fc(o))return!1;let i=o.child(0),s=r+1,c=s+1,d=s+i.nodeSize-1,l=String(n||"").trim();if(!l)return!1;let u=l.length>200?l.slice(0,200):l,f=e.state.tr.insertText(u,c,d).setMeta(ce,!0);return e.view.dispatch(f),!0}function iy(e){Vr.clear(),e.descendants(t=>{if(t?.type?.name!=="outlineSection")return;let n=String(t.attrs?.id||"");n&&Vr.set(n,Cs(t))})}function mt(e,t){let n=null;return e.descendants((r,o)=>{if(n!==null)return!1;r?.type?.name==="outlineSection"&&String(r.attrs?.id||"")===String(t||"")&&(n=o)}),n}function sy(e,t){try{let n=e.doc,r=mt(n,t),o=typeof r=="number"?n.nodeAt(r):null;if(!o)return null;let i=e.schema,s=i.marks?.code||null,c=i.nodes?.codeBlock||null;if(!s||!c)return null;let d=o.child(0),l=o.child(1);if(!d||!l)return null;let f=r+1+d.nodeSize+1,p=[];if(l.descendants((b,h)=>{if(!b||b.type?.name!=="paragraph")return;let g=!1,w=!1,S=!0;for(let N=0;N<b.childCount;N+=1){let B=b.child(N);if(B){if(B.type?.name==="hardBreak"){w=!0;continue}if(B.isText){if(!String(B.text||""))continue;if(!(Array.isArray(B.marks)?B.marks:[]).some(J=>J?.type===s)){S=!1;break}g=!0;continue}S=!1;break}}if(!S||!g||!w)return;let x="";for(let N=0;N<b.childCount;N+=1){let B=b.child(N);if(B){if(B.type?.name==="hardBreak"){x+=`
`;continue}B.isText&&(x+=String(B.text||""))}}if(!x.trim())return;let T=f+h;p.push({from:T,to:T+b.nodeSize,text:x})}),!p.length)return null;let y=e.tr;for(let b=p.length-1;b>=0;b-=1){let{from:h,to:g,text:w}=p[b],S=y.doc.resolve(h),x=S.parent,T=S.index();if(!x?.canReplaceWith?.(T,T+1,c))continue;let N=i.text(w),B=c.create(null,N);y=y.replaceWith(h,g,B)}return y.docChanged?y.setMeta(ce,!0):null}catch{return null}}function qf(e,t,n){if(!e||!t||!n||a.article?.encrypted)return;let r=mt(t,n),o=typeof r=="number"?t.nodeAt(r):null;if(!o||!Fc(o))return;let i=bf(o);if(!i)return;let s=$c(i),c=vc.get(n)||null;c?.inFlight||c?.bodyHash!==s&&(vc.set(n,{bodyHash:s,inFlight:!0}),Zl(i).then(d=>{let l=String(d?.title||"").trim();if(!l||l.length>200)return;let u=e.state.doc,f=mt(u,n),p=typeof f=="number"?u.nodeAt(f):null;if(!p||!Fc(p))return;let y=bf(p);$c(y)!==s||!oy(e,n,l)||(an=!0,sn({delayMs:900}))}).catch(()=>{}).finally(()=>{vc.set(n,{bodyHash:s,inFlight:!1})}))}function ay(e,t,n){if(!(!e||!t)&&!(!Array.isArray(n)||!n.length)&&!a.article?.encrypted&&!(typeof navigator<"u"&&navigator&&navigator.onLine===!1)){try{if((Ae?.getState?.(e.state)||null)?.editingSectionId)return}catch{}for(let r of n)try{qf(e,t,r)}catch{}}}function Sf(e,t,n){let r=String(n||"").trim(),o=(f,p={})=>Yn("skip",{reason:f,sectionId:r,...p});if(!e||!t||!r){o("missing_args",{hasEditor:!!e,hasDoc:!!t,hasSectionId:!!r});return}if(a.article?.encrypted){o("encrypted_article");return}try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1){o("offline");return}}catch{}let i=mt(t,r),s=typeof i=="number"?t.nodeAt(i):null;if(!s){o("section_not_found",{pos:typeof i=="number"?i:null});return}let c=s.child(1),d=wf(c);if(!d){o("empty_body_html");return}let l=Cc(d),u=ei.get(r)||null;if(u?.inFlight){o("already_in_flight",{htmlHash:l});return}if(u?.status==="ok"&&u?.htmlHash===l){o("already_ok_same_hash",{htmlHash:l});return}if(u?.status==="error"&&u?.htmlHash===l){let f=Number(u?.lastAttemptAtMs||0)||0;if(Date.now()-f<of){o("error_cooldown",{htmlHash:l,lastAttemptAtMs:f,cooldownMs:of});return}}Yn("start",{sectionId:r,htmlHash:l}),ei.set(r,{htmlHash:l,inFlight:!0,status:u?.status||"ok",lastAttemptAtMs:Date.now()}),ed(d).then(f=>{let p=String(f?.html||"").trim();if(!p){Yn("skip_apply",{sectionId:r,reason:"empty_corrected_html"});return}let y=e.state.doc,b=mt(y,r),h=typeof b=="number"?y.nodeAt(b):null;if(!h){Yn("skip_apply",{sectionId:r,reason:"section_not_found_current_doc"});return}let g=wf(h.child(1));if(Cc(g)!==l){Yn("skip_apply",{sectionId:r,reason:"body_changed_since_request"});return}if(Cc(p)===l){Yn("skip_apply",{sectionId:r,reason:"no_changes_from_server"});return}if(!ry(e,r,p)){Yn("skip_apply",{sectionId:r,reason:"apply_failed"});return}an=!0,sn({delayMs:900})}).catch(()=>{Yn("error",{sectionId:r,htmlHash:l}),ei.set(r,{htmlHash:l,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()})}).finally(()=>{(ei.get(r)||null)?.status!=="error"&&(ei.set(r,{htmlHash:l,inFlight:!1,status:"ok",lastAttemptAtMs:Date.now()}),Yn("done",{sectionId:r,htmlHash:l}))})}function Fr(e,t){if(!t)return!1;let n=mt(e,t);if(typeof n!="number")return!1;let r=e.nodeAt(n);if(!r)return!1;let o=Cs(r),i=Vr.get(t)||"";return o===i?!1:(xr.add(t),!0)}function sn({delayMs:e=1200}={}){a.isOutlineEditing&&oe&&(a.isPublicView||Lt&&a.articleId&&Lt!==a.articleId||(Xn&&clearTimeout(Xn),Xn=setTimeout(()=>{Xn=null,ri()},Math.max(200,e))))}async function ri({force:e=!1}={}){if(a.isOutlineEditing&&oe&&!a.isPublicView&&!(Lt&&a.articleId&&Lt!==a.articleId)&&!bs&&!(!e&&!an&&!xr.size)){bs=!0,Ir("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C\u2026");try{try{let t=oe.state,n=Bt(t.doc,t.selection.$from);if(typeof n=="number"){let r=t.doc.nodeAt(n),o=String(r?.attrs?.id||"");o&&Fr(t.doc,o)}}catch{}await cy({silent:!0,mode:"queue"})}finally{bs=!1}}}async function Kf(){if(!m.outlineEditor)return;let e=m.outlineEditor.querySelector("#outlineEditorContent");if(!e){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043C\u043E\u043D\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440");return}if(Zo)return Zo;Zo=(async()=>{let t=Rr()?performance.now():0,n=Rr()?performance.now():0,{core:r,starterKitMod:o,htmlMod:i,pmStateMod:s,pmViewMod:c}=await Zg();n&&fo("loadTiptap()",{ms:Math.round(performance.now()-n)});let{Editor:d,Node:l,Extension:u,InputRule:f,mergeAttributes:p}=r,y=o.default||o.StarterKit||o,{generateJSON:b,generateHTML:h}=i,{TextSelection:g}=s,{Plugin:w,PluginKey:S}=s,{Decoration:x,DecorationSet:T}=c,N=He.linkMod.default||He.linkMod.Link||He.linkMod,B=He.imageMod.default||He.imageMod.Image||He.imageMod,$=He.tableMod.TableKit||He.tableMod.tableKit;kt={TableMap:He.pmTablesMod?.TableMap||null,CellSelection:He.pmTablesMod?.CellSelection||null,moveTableColumn:He.pmTablesMod?.moveTableColumn||null,moveTableRow:He.pmTablesMod?.moveTableRow||null,addRowBefore:He.pmTablesMod?.addRowBefore||null,addRowAfter:He.pmTablesMod?.addRowAfter||null,deleteRow:He.pmTablesMod?.deleteRow||null,addColumnBefore:He.pmTablesMod?.addColumnBefore||null,addColumnAfter:He.pmTablesMod?.addColumnAfter||null,deleteColumn:He.pmTablesMod?.deleteColumn||null,toggleHeaderRow:He.pmTablesMod?.toggleHeaderRow||null,toggleHeaderColumn:He.pmTablesMod?.toggleHeaderColumn||null};let U=He.uniqueIdMod.default||He.uniqueIdMod.UniqueID||He.uniqueIdMod,Y=He.markdownMod?.Markdown||He.markdownMod?.default?.Markdown||He.markdownMod?.default||null,J=v=>{let k=String(v||"").trim();if(!k)return null;let _=k.match(/(\d+(?:\.\d+)?)px/i);if(!_)return null;let O=Number.parseFloat(_[1]);return Number.isFinite(O)?O:null},re=new S("outlineTagHighlighter"),he=l.create({name:"tag",group:"inline",inline:!0,atom:!0,selectable:!1,renderText({node:v}){try{return String(v?.attrs?.label||"").trim()}catch{return""}},addAttributes(){return{label:{default:""},key:{default:""}}},parseHTML(){return[{tag:'span[data-tt-tag="1"]'}]},renderHTML({node:v,HTMLAttributes:k}){let _=String(v?.attrs?.label||"").trim(),O=String(v?.attrs?.key||"").trim();return["span",p(k,{"data-tt-tag":"1","data-tag-key":O,class:"tt-tag"}),_||O||""]},addInputRules(){let v=/(^|[\s([{"'-])\\([^\\\n]{1,60}?)\\$/;return[new f({find:v,handler:({state:k,range:_,match:O})=>{let V=String(O?.[1]||""),P=String(O?.[2]||""),M=Mf(P);if(!M)return null;let H=Nf(M);if(!H)return null;let C=k.schema.nodes?.tag;if(!C)return null;let E=C.create({label:H,key:H}),A=k.tr.delete(_.from,_.to),I=_.from;V&&(A=A.insertText(V,I),I+=V.length),A=A.insert(I,E);let R=g.near(A.doc.resolve(Math.min(A.doc.content.size,I+E.nodeSize)),1);return A=A.setSelection(R),A=A.setMeta(ce,!0),A}})]}}),Re=u.create({name:"outlineTagHighlighter",addProseMirrorPlugins(){return[new w({key:re,state:{init:()=>({activeKey:null}),apply:(v,k)=>{let _=v.getMeta(re);return _&&Object.prototype.hasOwnProperty.call(_,"activeKey")?{activeKey:_.activeKey?String(_.activeKey):null}:k}},props:{decorations(v){let k=re.getState(v)?.activeKey||null,_=[];return v.doc.descendants((O,V)=>{if(O?.type?.name!=="tag")return;let P=String(O.attrs?.key||"").trim();if(!P)return;let M=k&&P===k?"tt-tag tt-tag--active":"tt-tag";_.push(x.node(V,V+O.nodeSize,{class:M}))}),_.length?T.create(v.doc,_):null}}})]}}),G=B.extend({inline:!0,group:"inline",addAttributes(){return{...typeof this.parent=="function"?this.parent():{},width:{default:320,parseHTML:k=>{try{let _=k,O=_&&_.classList&&_.classList.contains("resizable-image")?_:_?.closest?.(".resizable-image"),V=J(O?.style?.width||"");if(V!==null)return Math.round(V);let P=J(O?.getAttribute?.("style")||"")||J(_?.getAttribute?.("style")||"");if(P!==null)return Math.round(P);let M=O?.getAttribute?.("data-width")||_?.getAttribute?.("data-width")||"",H=Number.parseFloat(String(M||""));return Number.isFinite(H)&&H>0?Math.round(H):320}catch{return 320}},renderHTML:()=>({})},uploadToken:{default:null,parseHTML:()=>null,renderHTML:()=>({})}}},parseHTML(){return[{tag:"span.resizable-image",getAttrs:v=>{let k=v,_=k?.querySelector?.("img"),O=_?.getAttribute?.("src")||"";if(!O)return!1;let V=_?.getAttribute?.("alt")||"",P=_?.getAttribute?.("title")||"",M=J(k?.style?.width||"")??320;return{src:O,alt:V,title:P,width:Math.round(M)}}},{tag:"img[src]",getAttrs:v=>{let k=v,_=k?.getAttribute?.("src")||"";if(!_)return!1;let O=k?.getAttribute?.("alt")||"",V=k?.getAttribute?.("title")||"";return{src:_,alt:O,title:V,width:320}}}]},renderHTML({node:v,HTMLAttributes:k}){let _=v?.attrs?.width,O=Number.isFinite(Number(_))?Math.round(Number(_)):320,V={...k};return delete V.width,delete V.uploadToken,["span",p({class:"resizable-image",style:`width:${O}px;max-width:100%;`},{}),["span",{class:"resizable-image__inner"},["img",p(V,{draggable:"false"})]],["span",{class:"resizable-image__handle","data-direction":"e","aria-hidden":"true"}]]}});Mc=h,Nc=[y.configure({heading:!1,link:!1}),N.configure({openOnClick:!1,protocols:us}),G,$.configure({table:{resizable:!0}})];let ie=u.create({name:"outlineImageUpload",addProseMirrorPlugins(){let v=V=>{if(!V)return!1;if(V.type&&String(V.type).startsWith("image/"))return!0;let P=String(V.name||"").toLowerCase();return!!(P&&/\.(png|jpe?g|gif|webp|bmp|svg|heic|heif)$/i.test(P))},k=(V,P)=>{let M=[];return Array.from(V||[]).forEach(H=>{if(H.kind!=="file")return;let C=typeof H.getAsFile=="function"?H.getAsFile():null;C&&v(C)&&M.push(C)}),!M.length&&P?.length&&Array.from(P).forEach(H=>{v(H)&&M.push(H)}),M},_=(V,P)=>{let M=`upl-${Date.now()}-${Math.random().toString(16).slice(2)}`,H=URL.createObjectURL(P);try{oi.set(M,H)}catch{}try{let z=Lt||a.articleId||null;Fu({token:M,articleId:z,kind:"image",blob:P,fileName:P?.name||"image",mime:P?.type||""})}catch{}let C=V.state.schema.nodes.image.create({src:H,alt:P?.name||"image",width:320,uploadToken:M}),E=V.state.tr,A=E.selection.from,I=E.selection.to;I>A&&(E=E.delete(A,I)),E=E.insertText("  ",A,A);let R=E.mapping.map(A,1);E=E.replaceRangeWith(R,R,C);let D=E.mapping.map(R+C.nodeSize,1);E=E.insertText("  ",D,D),E=E.setSelection(g.near(E.doc.resolve(Math.min(E.doc.content.size,D+1)),1)),E=E.setMeta(ce,!0),V.dispatch(E.scrollIntoView());try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1){L("\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E \u0438 \u0431\u0443\u0434\u0435\u0442 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E \u043F\u0440\u0438 \u043F\u043E\u044F\u0432\u043B\u0435\u043D\u0438\u0438 \u0441\u0435\u0442\u0438");return}}catch{}Co(P).then(z=>{let q=String(z?.url||"").trim();if(!q)throw new Error("Upload failed");let W=_c(V.state.doc,M);if(typeof W!="number")return;let K=V.state.doc.nodeAt(W);if(!K||K.type?.name!=="image")return;let j={...K.attrs,src:q,uploadToken:null},ee=V.state.tr.setNodeMarkup(W,void 0,j);ee=ee.setMeta(ce,!0),V.dispatch(ee),Af(M),dc(M).catch(()=>{})}).catch(z=>{L(z?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435");try{window?.localStorage?.getItem?.("ttree_debug_outline_keys_v1")==="1"&&console.log("[outline][image]","upload.failed",{token:M,message:String(z?.message||z||"")})}catch{}try{let q=_c(V.state.doc,M);if(typeof q!="number")return;let W=V.state.doc.nodeAt(q);if(!W||W.type?.name!=="image")return;let K=String(W.attrs?.title||"").trim(),j=K?`${K} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",ee=String(W.attrs?.alt||P?.name||"image"),se={...W.attrs,src:H,alt:ee,title:j,uploadToken:M},we=V.state.tr.setNodeMarkup(q,void 0,se);we=we.setMeta(ce,!0),V.dispatch(we)}catch{}try{uc(M,String(z?.message||z||"error"))}catch{}})},O=(V,P,M,H)=>{try{if(!(Ae?.getState?.(V.state)||null)?.editingSectionId)return!1}catch{return!1}let C=k(M,H);if(!C.length)return!1;P.preventDefault(),P.stopPropagation();for(let E of C)_(V,E);return!0};return[new w({props:{handleDOMEvents:{paste(V,P){let M=P?.clipboardData?.items||null,H=P?.clipboardData?.files||null;return O(V,P,M,H)},drop(V,P){let M=P?.dataTransfer?.items||null,H=P?.dataTransfer?.files||null;return O(V,P,M,H)}}},view(V){return{update(P,M){try{let H=Ae?.getState?.(M)||{},C=Ae?.getState?.(P.state)||{},E=H.editingSectionId||null,A=C.editingSectionId||null;if(E&&!A){let I=String(E||"").trim(),R=Lt||a.articleId||null;if(!I||!R)return;let D=!1;try{let z=mt(P.state.doc,I),q=typeof z=="number"?P.state.doc.nodeAt(z):null;q?.type?.name==="outlineSection"&&(D=!!q.attrs?.collapsed)}catch{}Vf(R,I,D);try{let z=mt(P.state.doc,I),q=typeof z=="number"?P.state.doc.nodeAt(z):null;if(!q||q.type?.name!=="outlineSection")return;let W=!Vr.has(I),K=W||Fr(P.state.doc,I),j=!1;if(K){let se=q.child(0),we=q.child(1),fe=se?.toJSON?se.toJSON():null,Pe=we?.toJSON?we.toJSON():null;if(fe&&Pe){let Oe=Bf(fe,Pe);if(Oe>ks){L(`\u0411\u043B\u043E\u043A \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 (${Math.ceil(Oe/1024)} KB). \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C: ${Math.ceil(ks/1024)} KB. \u0420\u0430\u0437\u0431\u0435\u0439\u0442\u0435 \u0431\u043B\u043E\u043A \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E.`);try{let F=P.state.tr.setMeta(ce,!0);F=F.setMeta(Ae,{type:"enter",sectionId:I}),P.dispatch(F)}catch{}return}let Ye=Date.now(),bt=Cf(R,I);try{at("outline.enqueue.section_upsert_content",{articleId:R,sectionId:I,seq:bt,bytes:Oe,reason:W?"exit_edit_mode_new_section":"exit_edit_mode"})}catch{}j=!0,Nt("section_upsert_content",{articleId:R,payload:{sectionId:I,headingJson:fe,bodyJson:Pe,seq:bt,clientQueuedAt:Ye},coalesceKey:`content:${R}:${I}`})}}let ee=!1;if(W||Fn||$t){let se=si(P.state.doc);if(se.length){let we=null;try{we=se.filter(fe=>fe&&(fe.parentId==null||fe.parentId==="")&&Number(fe.position)>=0).sort((fe,Pe)=>Number(fe.position)-Number(Pe.position)).slice(0,3).map(fe=>String(fe.sectionId||""))}catch{we=null}try{at("outline.enqueue.structure_snapshot",{articleId:R,nodesCount:se.length,reason:W?"exit_edit_mode_new_section":"exit_edit_mode",rootFirst:we})}catch{}Nt("structure_snapshot",{articleId:R,payload:{nodes:se},coalesceKey:`structure:${R}`}),ee=!0}Fn=!1,$t&&(clearTimeout($t),$t=null)}try{(j||W)&&(Vr.set(I,Cs(q)),xr.delete(I))}catch{}try{j&&oe&&!oe.isDestroyed&&oe.view===P&&qf(oe,P.state.doc,I)}catch{}(j||ee)&&Ir("\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438 \u043D\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044E")}catch{}}}catch{}}}}})]}}),$e=u.create({name:"outlineImageResize",addProseMirrorPlugins(){return[new w({view(v){let k=null,_=(M,H)=>{try{if((v.state.selection?.node||null)?.type?.name==="image"&&typeof v.state.selection.from=="number")return v.state.selection.from;let E=W=>{if(typeof W!="number")return null;let K=[W,W-1,W+1,W-2,W+2];for(let j of K){if(j<0)continue;if(v.state.doc.nodeAt(j)?.type?.name==="image")return j}return null},A=M?.querySelector?.("img")||null,I=E(v.posAtDOM(M,0));if(typeof I=="number")return I;let R=A?E(v.posAtDOM(A,0)):null;if(typeof R=="number")return R;let D=H&&typeof H.clientX=="number"&&typeof H.clientY=="number"?{left:H.clientX,top:H.clientY}:null,z=D?v.posAtCoords(D):null,q=z&&typeof z.pos=="number"?E(z.pos):null;return typeof q=="number"?q:null}catch{return null}},O=M=>{if(M.button!==0)return;let H=M.target?.closest?.(".resizable-image__handle");if(!H)return;let C=H.closest(".resizable-image");if(!C||!v.dom.contains(C)||!(Ae?.getState?.(v.state)||null)?.editingSectionId)return;let A=_(C,M);if(typeof A!="number")return;let I=v.state.doc.nodeAt(A);if(!I||I.type?.name!=="image")return;M.preventDefault(),M.stopPropagation();let R=C.getBoundingClientRect();k={pos:A,startWidth:R.width,startX:M.clientX,wrapper:C,lastWidth:R.width},C.classList.add("resizable-image--resizing")},V=M=>{if(!k)return;M.preventDefault();let H=M.clientX-k.startX,E=parseFloat(getComputedStyle(document.documentElement).fontSize)||16,A=Math.max(E,document.documentElement.clientWidth-32),I=k.startWidth+H;I=Math.max(E,Math.min(I,A)),k.lastWidth=I,k.wrapper.style.width=`${Math.round(I)}px`},P=()=>{if(!k)return;let{pos:M,wrapper:H}=k;H.classList.remove("resizable-image--resizing");let C=v.state.doc.nodeAt(M)?.type?.name==="image"?M:_(H,null),E=typeof C=="number"?v.state.doc.nodeAt(C):null;if(E&&E.type?.name==="image"){let A=Math.max(1,Math.round(Number(k.lastWidth||0)||H.getBoundingClientRect().width)),I={...E.attrs,width:A},R=v.state.tr.setNodeMarkup(C,void 0,I);R=R.setMeta(ce,!0),v.dispatch(R)}k=null};return v.dom.addEventListener("pointerdown",O),document.addEventListener("pointermove",V),document.addEventListener("pointerup",P),document.addEventListener("pointercancel",P),{destroy(){v.dom.removeEventListener("pointerdown",O),document.removeEventListener("pointermove",V),document.removeEventListener("pointerup",P),document.removeEventListener("pointercancel",P)}}}})]}}),dt=u.create({name:"outlineImagePreview",addProseMirrorPlugins(){return[new w({props:{handleDOMEvents:{click(v,k){try{if((Ae?.getState?.(v.state)||null)?.editingSectionId)return!1;let O=k?.target?.closest?.("img");return O?k.target?.closest?.(".resizable-image__handle")?(k.preventDefault(),!0):(k.preventDefault(),Lo(O.src,O.alt||""),!0):!1}catch{return!1}}}}})]}}),ut=u.create({name:"outlineMarkdownTablePaste",addProseMirrorPlugins(){let v=(k,_)=>{try{if(!(Ae?.getState?.(k.state)||null)?.editingSectionId)return!1;let V=_?.clipboardData?.getData?.("text/plain")||"";if(mn("paste: text/plain",{len:V.length,sample:V.slice(0,200)}),!V)return!1;let P=zc(V),M=zr(P);mn("paste: parsed",{ok:!!M,lines:P});let H=M?null:Ur(P);if(!M&&!H)return!1;let C=M?{header:M.header,rows:M.rows,withHeader:!0}:{header:null,rows:H.rows,withHeader:!1},E=null;try{E=wr(k.state.schema,C)}catch(I){return mn("paste: buildTableNode error",{message:String(I?.message||I||""),stack:String(I?.stack||""),schemaNodes:Object.keys(k.state.schema?.nodes||{})}),!1}if(mn("paste: tableNode",{ok:!!E,schemaNodes:Rc()?Object.keys(k.state.schema?.nodes||{}):void 0}),!E)return!1;_.preventDefault(),_.stopPropagation();let A=k.state.tr;k.state.selection.empty||(A=A.deleteSelection());try{A=A.replaceSelectionWith(E,!1)}catch(I){return mn("paste: replaceSelectionWith error",{message:String(I?.message||I||""),stack:String(I?.stack||""),selection:{from:k.state.selection?.from,to:k.state.selection?.to,empty:k.state.selection?.empty,$fromParent:k.state.selection?.$from?.parent?.type?.name}}),!1}return A=A.setMeta(ce,!0),k.dispatch(A.scrollIntoView()),!0}catch(O){return mn("paste: unexpected error",{message:String(O?.message||O||""),stack:String(O?.stack||"")}),!1}};return[new w({appendTransaction(k,_,O){try{let V=k?.some?.(A=>A?.docChanged),P=null;if(Ae)for(let A of k||[]){let I=A?.getMeta?.(Ae)||null;if(I?.type==="enter"&&I?.sectionId){P=String(I.sectionId);break}}let M=!!P;if(!V&&!M||k.some(A=>A.getMeta?.(ce)))return null;let H=Ae?.getState?.(O)||null,C=P||H?.editingSectionId||null;if(!C)return null;mn("appendTransaction: try convert",{didDocChange:V,didEnterEditMode:M,sectionId:C});let E=Pg(O,C);if(E)return E;if(Rc()){let A=mt(O.doc,C),I=typeof A=="number"?O.doc.nodeAt(A):null,R=I?I.child(1):null,D=R?R.textContent:"";String(D||"").includes("|")&&mn("appendTransaction: saw pipes but no conversion",{sectionId:C})}return sy(O,C)}catch{return null}},props:{handlePaste(k,_){return v(k,_)},handleDOMEvents:{paste(k,_){return v(k,_)}}}})]}}),Zt=u.create({name:"outlineStructuredSectionPaste",addProseMirrorPlugins(){let v=P=>{let M=String(P||"").trim();if(!M)return{sections:[],startsWithHeading:!1,headingCount:0};if(!/<h[1-6][\s>]/i.test(M))return{sections:[],startsWithHeading:!1,headingCount:0};let H=null;try{H=new DOMParser().parseFromString(M,"text/html")}catch{return{sections:[],startsWithHeading:!1,headingCount:0}}let C=H?.body;if(!C)return{sections:[],startsWithHeading:!1,headingCount:0};let E=!1;try{let D=Array.from(C.childNodes||[]).find(z=>z?.nodeType===1&&String(z?.textContent||"").trim());E=!!(D&&/^H[1-6]$/.test(String(D.nodeName||"")))}catch{E=!1}let A=[],I=null,R=()=>{if(!I)return;let D=document.createElement("div");for(let q of I.nodes)try{D.appendChild(q.cloneNode(!0))}catch{}let z=String(D.innerText||D.textContent||"").trimEnd();A.push({level:I.level,title:I.title,bodyText:z}),I=null};for(let D of Array.from(C.childNodes||[])){let W=(D?.nodeType===1?String(D.nodeName||"").toUpperCase():"").match(/^H([1-6])$/);if(W){R();let K=Number(W[1]),j=String(D.textContent||"").trim();if(!j)continue;I={level:K,title:j,nodes:[]};continue}I&&I.nodes.push(D)}return R(),{sections:A,startsWithHeading:E,headingCount:A.length}},k=P=>{let M=P?.selection?.$from;if(!M)return null;for(let H=M.depth;H>0;H-=1)if(M.node(H)?.type?.name==="outlineSection")return M.before(H);return null},_=(P,M)=>{let H=String(M||"").replace(/\r\n/g,`
`).trimEnd(),C=P.nodes.paragraph;if(!C)return[];let E=P.nodes.hardBreak||P.nodes.hard_break||null,A=D=>{let z=String(D||"").split(`
`),q=[];for(let W=0;W<z.length;W+=1){let K=z[W];W>0&&E&&q.push(E.create()),K&&q.push(P.text(K))}return C.create({},q)};if(!H.trim())return[C.create({},[])];let I=H.split(/\n{2,}/),R=[];for(let D of I){let z=String(D||"").trimEnd();R.push(A(z))}return R.length?R:[C.create({},[])]},O=(P,M)=>{let H=P.nodes.outlineHeading.create({},M.title?[P.text(M.title)]:[]),C=_(P,M.bodyText),E=P.nodes.outlineBody.create({},C),A=(M.children||[]).map(R=>O(P,R)),I=P.nodes.outlineChildren.create({},A);return P.nodes.outlineSection.create({id:M.id,collapsed:!1},[H,E,I])},V=(P,M)=>{try{if(!(Ae?.getState?.(P.state)||null)?.editingSectionId)return!1;let C=M?.clipboardData?.getData?.("text/html")||"",E=M?.clipboardData?.getData?.("text/plain")||"",A=C?v(C):{sections:[],startsWithHeading:!1,headingCount:0},I=!A.sections.length&&E?pc(E):{sections:[],startsWithHeading:!1,headingCount:0},R=A.sections.length?A:I;if(!R.sections.length||!(R.startsWithHeading||R.sections.length>=2))return!1;M.preventDefault(),M.stopPropagation();let z=k(P.state);if(typeof z!="number")return!1;let q=P.state.doc.nodeAt(z);if(!q||q.type?.name!=="outlineSection")return!1;let W=Vu(R.sections,{makeId:()=>Xt()});if(!W.length)return!1;let K=P.state.schema,j=W.map(we=>O(K,we)),ee=P.state.tr,se=z+q.nodeSize;for(let we of j)ee=ee.insert(se,we),se+=we.nodeSize;return ee=ee.setMeta(ce,!0),P.dispatch(ee.scrollIntoView()),!0}catch{return!1}};return[new w({props:{handlePaste(P,M){return V(P,M)},handleDOMEvents:{paste(P,M){return V(P,M)}}}})]}}),Mn=(v="")=>{let k=String(v||"").trim();return k?k.startsWith("app:/")||k.startsWith("disk:/")?`/api/yandex/disk/file?path=${encodeURIComponent(k)}`:k:""},Z=u.create({name:"outlineAttachmentUpload",addProseMirrorPlugins(){let v=M=>{let H=String(M?.type||"");return!(H&&H.startsWith("image/"))},k=(M,H)=>{let C=[];try{let E=[];if(H&&typeof H.length=="number")E.push(...Array.from(H||[]));else if(M&&typeof M.length=="number")for(let A of Array.from(M||[])){if(!A||A.kind!=="file")continue;let I=A.getAsFile?.();I&&E.push(I)}for(let A of E)A&&v(A)&&C.push(A)}catch{}return C},_=M=>`pending-attachment:${String(M||"")}`,O=(M,H)=>{let C=_(H),E=M?.type?.schema?.marks?.link||null;if(!E)return null;let A=null;return M.descendants((I,R)=>{if(A)return!1;!I||!I.isText||!(Array.isArray(I.marks)?I.marks:[]).find(q=>q?.type===E&&String(q?.attrs?.href||"")===C)||(A={from:R,to:R+I.nodeSize})}),A},V=(M,H)=>{let C=M?.state?.schema,E=C?.marks?.link||null;if(!C||!E){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u0438\u0435: \u043D\u0435\u0442 \u0441\u0445\u0435\u043C\u044B \u0441\u0441\u044B\u043B\u043E\u043A");return}if(!a.articleId){L("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}let A=Xt(),I=_(A),R=String(H?.name||"\u0444\u0430\u0439\u043B"),D=`${R} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430...)`,{from:z,to:q}=M.state.selection,W=M.state.tr.insertText(D,z,q);W=W.addMark(z,z+D.length,E.create({href:I})),W=W.setMeta(ce,!0),M.dispatch(W.scrollIntoView()),Bi(a.articleId,H).then(K=>{let j=String(K?.storedPath||K?.url||K?.path||"").trim();if(!j)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443 \u043D\u0430 \u0444\u0430\u0439\u043B");let ee=String(K?.originalName||H?.name||"\u0444\u0430\u0439\u043B"),se=O(M.state.doc,A);if(!se)return;let we=M.state.tr.insertText(ee,se.from,se.to);we=we.addMark(se.from,se.from+ee.length,E.create({href:j})),we=we.setMeta(ce,!0),M.dispatch(we)}).catch(K=>{let j=O(M.state.doc,A);if(j){let ee=`${R} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`,se=M.state.tr.insertText(ee,j.from,j.to);se=se.setMeta(ce,!0),M.dispatch(se)}L(K?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u043D\u0430 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A")})},P=(M,H,C,E)=>{let A=k(C,E);if(!A.length)return!1;H.preventDefault(),H.stopPropagation();try{if(!(Ae?.getState?.(M.state)||null)?.editingSectionId)return po(),!0}catch{return po(),!0}for(let I of A)V(M,I);return!0};return[new w({props:{handleDOMEvents:{drop(M,H){let C=H?.dataTransfer?.items||null,E=H?.dataTransfer?.files||null;return P(M,H,C,E)},paste(M,H){let C=H?.clipboardData?.items||null,E=H?.clipboardData?.files||null;return P(M,H,C,E)}}}})]}}),de=l.create({name:"doc",topNode:!0,content:"outlineSection+"}),pe=l.create({name:"outlineChildren",content:"outlineSection*",defining:!0,renderHTML(){return["div",{class:"outline-children","data-outline-children":"true"},0]},parseHTML(){return[{tag:"div[data-outline-children]"}]},addNodeView(){return({node:v})=>{let k=document.createElement("div");k.className="outline-children",k.setAttribute("data-outline-children","true");let _=O=>{let V=!O||O.childCount===0;k.setAttribute("data-empty",V?"true":"false")};return _(v),{dom:k,contentDOM:k,update(O){return!O||O.type?.name!=="outlineChildren"?!1:(_(O),!0)}}}}}),ue=v=>{try{if(!v||v.childCount===0)return!0;let k=!1;return v.descendants(_=>{if(k)return!1;let O=_?.type?.name;return O==="image"||O==="table"||_.isText&&String(_.text||"").replace(/\u00a0/g," ").trim()?(k=!0,!1):!0}),!k}catch{return!1}},le=l.create({name:"outlineBody",content:"block*",defining:!0,renderHTML(){return["div",{class:"outline-body","data-outline-body":"true"},0]},parseHTML(){return[{tag:"div[data-outline-body]"}]},addNodeView(){return({node:v})=>{let k=document.createElement("div");k.className="outline-body",k.setAttribute("data-outline-body","true");let _=O=>{let V=ue(O);k.setAttribute("data-empty",V?"true":"false")};return _(v),{dom:k,contentDOM:k,update(O){return!O||O.type?.name!=="outlineBody"?!1:(_(O),!0)}}}}}),ye=l.create({name:"outlineHeading",content:"inline*",defining:!0,renderHTML(){return["div",{class:"outline-heading","data-outline-heading":"true"},0]},parseHTML(){return[{tag:"div[data-outline-heading]"}]},addNodeView(){return({editor:v,getPos:k,node:_})=>{let O=document.createElement("div");O.className="outline-heading",O.setAttribute("data-outline-heading","true");let V=document.createElement("button");V.type="button",V.className="outline-heading__toggle",V.title="\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C/\u0440\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C (Ctrl+\u2190/\u2192), \u0441 \u0434\u0435\u0442\u044C\u043C\u0438 (Ctrl+\u2191/\u2193)",V.setAttribute("aria-label","\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C/\u0440\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C");let P=document.createElement("div");P.className="outline-heading__content";let M=document.createElement("button");M.type="button",M.className="outline-heading__select",M.setAttribute("role","checkbox"),M.setAttribute("aria-checked","false"),M.setAttribute("aria-label","\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0431\u043B\u043E\u043A"),M.textContent="\u2713",M.addEventListener("pointerdown",C=>{C.preventDefault()}),M.addEventListener("click",C=>{if(C.preventDefault(),C.stopPropagation(),!ir)return;let E=typeof k=="function"?k():null;if(typeof E!="number")return;let A=E-1,I=v.state.doc.nodeAt(A),R=String(I?.attrs?.id||"").trim();R&&yg(R)});let H=()=>{let C=typeof k=="function"?k():null;if(typeof C!="number")return;let E=C-1,A=v.state.doc.nodeAt(E),I=String(A?.attrs?.id||"");I&&O.setAttribute("data-section-id",I),O.dataset.empty=_.content.size===0?"true":"false";let R=v.state.doc.resolve(Math.max(0,E+1)),D=0;for(let q=R.depth;q>=0;q-=1)R.node(q)?.type?.name==="outlineSection"&&(D+=1);O.dataset.depth=String(Math.min(6,Math.max(1,D||1)));let z=ir&&I&&Ar.has(I);M.setAttribute("aria-checked",z?"true":"false"),M.style.display=ir?"inline-flex":"none"};return V.addEventListener("click",C=>{C.preventDefault(),C.stopPropagation();let E=typeof k=="function"?k():null;if(typeof E!="number")return;let A=E-1,I=v.state.doc.nodeAt(A);if(!I)return;let R=!I.attrs?.collapsed,D=v.state.tr.setNodeMarkup(A,void 0,{...I.attrs,collapsed:R});try{R&&Ae&&(Ae.getState(v.state)||{}).editingSectionId&&(D=D.setMeta(Ae,{type:"exit"}))}catch{}D.setMeta(ce,!0),v.view.dispatch(D),v.view.focus()}),O.appendChild(V),O.appendChild(P),O.appendChild(M),H(),{dom:O,contentDOM:P,update:C=>C.type.name!=="outlineHeading"?!1:(_=C,H(),!0)}}}}),ge=l.create({name:"outlineSection",group:"block",content:"outlineHeading outlineBody outlineChildren",defining:!0,isolating:!0,draggable:!0,addAttributes(){return{collapsed:{default:!1}}},renderHTML({node:v,HTMLAttributes:k}){let _={...k,class:`outline-section${k?.class?` ${k.class}`:""}`,"data-outline-section":"true","data-section-id":v.attrs.id||"","data-collapsed":v.attrs.collapsed?"true":"false"};return["div",p(_),0]},parseHTML(){return[{tag:"div[data-outline-section]"}]}}),te=v=>{if(!v)return!0;if((v.textContent||"").replace(/\u00a0/g," ").trim())return!1;if(v.childCount)for(let _=0;_<v.childCount;_+=1){let O=v.child(_);if(O.type?.name!=="paragraph"||(O.textContent||"").replace(/\u00a0/g," ").trim())return!1}return!0},me=v=>{if(!v)return!0;try{let k=v.child(0),_=v.child(1),O=v.child(2);return te(k)&&te(_)&&(!O||O.childCount===0)}catch{return!0}},Ee=(v,k,_)=>{let O=v.doc.nodeAt(_);if(!O)return!1;let V=String(O.attrs?.id||"").trim(),P=v.doc.resolve(_),M=P.index(),H=P.parent;if(!H)return!1;if(H.childCount<=1){if(H.type?.name==="doc"){let K=v.doc.type.schema,j=K.nodes.outlineSection.create({...O.attrs,collapsed:!1},[K.nodes.outlineHeading.create({},[]),K.nodes.outlineBody.create({},[K.nodes.paragraph.create({},[])]),K.nodes.outlineChildren.create({},[])]),ee=v.tr.replaceWith(_,_+O.nodeSize,j);ee=ee.setMeta(ce,!0);let se=j.child(0),we=_+1+se.nodeSize;return k(ee.setSelection(g.near(ee.doc.resolve(we+2),1)).scrollIntoView()),!0}V&&uo(V);let q=null;try{for(let K=P.depth;K>0;K-=1)if(P.node(K)?.type?.name==="outlineSection"){q=P.before(K);break}}catch{q=null}let W=v.tr.delete(_,_+O.nodeSize);W=W.setMeta(ce,!0);try{if(typeof q=="number"){let K=W.mapping.map(q,-1),j=W.doc.nodeAt(K);if(j&&j.type?.name==="outlineSection"){let ee=j.child(0),se=j.child(1),we=K+1+ee.nodeSize;if(!se.childCount){let fe=W.doc.type.schema;W=W.insert(we+1,fe.nodes.paragraph.create({},[]))}W=W.setSelection(g.near(W.doc.resolve(we+2),1))}}}catch{}return k(W.scrollIntoView()),!0}let C=M>0,E=M<H.childCount-1,A=C?H.child(M-1):null,I=C?_-A.nodeSize:null,R=_+O.nodeSize;V&&uo(V);let D=v.tr.delete(_,_+O.nodeSize),z=(q,W)=>{try{let K=q.doc.nodeAt(W);if(!K||K.type?.name!=="outlineSection")return q;let j=K.child(0),se=W+1+j.nodeSize-1;return q.setSelection(g.near(q.doc.resolve(se),-1))}catch{return q}};if(E){let q=_<D.doc.content.size?_:R;D.doc.nodeAt(q)&&(D=z(D,q))}else C&&typeof I=="number"&&D.doc.nodeAt(I)&&(D=z(D,I));return D=D.setMeta(ce,!0),k(D.scrollIntoView()),!0},Ne=(v,k,_)=>{let O=v.doc.nodeAt(_);if(!O)return!1;let V=v.doc.resolve(_),P=V.index(),M=V.parent;if(!M||P<=0)return!1;let H=M.child(P-1),C=_-H.nodeSize,E=O.child(0),A=O.child(1),I=O.child(2),R=v.tr.delete(_,_+O.nodeSize),D=R.doc.nodeAt(C);if(!D)return R=R.setMeta(ce,!0),k(R.scrollIntoView()),!0;let z=R.doc.type.schema,q=D.child(0),W=D.child(1),K=D.child(2),j=[],ee=(E?.textContent||"").replace(/\u00a0/g," ").trim();ee&&j.push(z.nodes.paragraph.create({},[z.text(ee)])),A?.content?.forEach?.(Ye=>{j.push(Ye)});let se=j.length?z.nodes.outlineBody.create({},j).content:null,we=se?W.content.append(se):W.content,fe=K.content.append(I.content),Pe=z.nodes.outlineSection.create(D.attrs,[q,z.nodes.outlineBody.create({},we),z.nodes.outlineChildren.create({},fe)]);R=R.replaceWith(C,C+D.nodeSize,Pe);let Oe=R.doc.nodeAt(C);if(Oe){let Ye=Oe.child(0),bt=Oe.child(1),ne=C+1+Ye.nodeSize+bt.nodeSize-1;R=R.setSelection(g.near(R.doc.resolve(ne),-1))}return R=R.setMeta(ce,!0),k(R.scrollIntoView()),!0},Je=(v,k,_)=>{let O=v.doc.nodeAt(_);if(!O)return!1;let V=v.selection.$from,P=null,M=null;for(let Ye=V.depth;Ye>0;Ye-=1)if(V.node(Ye)?.type?.name==="outlineSection")if(P===null)P=Ye;else{M=Ye;break}if(P===null||M===null)return!1;let H=V.before(M);if(!v.doc.nodeAt(H))return!1;let E=v.doc.type.schema,A=O.child(0),I=O.child(1),R=O.child(2),D=v.tr.delete(_,_+O.nodeSize),z=D.doc.nodeAt(H);if(!z)return D=D.setMeta(ce,!0),k(D.scrollIntoView()),!0;let q=z.child(0),W=z.child(1),K=z.child(2),j=[],ee=(A?.textContent||"").replace(/\u00a0/g," ").trim();ee&&j.push(E.nodes.paragraph.create({},[E.text(ee)])),I?.content?.forEach?.(Ye=>{j.push(Ye)});let se=j.length?E.nodes.outlineBody.create({},j).content:null,we=se?W.content.append(se):W.content,fe=R.content.append(K.content),Pe=E.nodes.outlineSection.create({...z.attrs,collapsed:!1},[q,E.nodes.outlineBody.create({},we),E.nodes.outlineChildren.create({},fe)]);D=D.replaceWith(H,H+z.nodeSize,Pe);let Oe=D.doc.nodeAt(H);if(Oe){let Ye=Oe.child(0),bt=Oe.child(1),ne=H+1+Ye.nodeSize+bt.nodeSize-1;D=D.setSelection(g.near(D.doc.resolve(ne),-1))}return D=D.setMeta(ce,!0),k(D.scrollIntoView()),!0},je=u.create({name:"outlineCommands",addKeyboardShortcuts(){let v=(F,ne)=>{for(let X=ne.depth;X>0;X-=1)if(ne.node(X)?.type?.name==="outlineSection")return ne.before(X);return null},k=(F,ne)=>{for(let X=F.depth;X>0;X-=1)if(F.node(X)?.type?.name===ne)return X;return null},_=F=>{if(!F)return!0;if((F.textContent||"").replace(/\u00a0/g," ").trim())return!1;if(F.childCount)for(let X=0;X<F.childCount;X+=1){let Q=F.child(X);if(Q.type?.name!=="paragraph"||(Q.textContent||"").replace(/\u00a0/g," ").trim())return!1}return!0},O=(F,ne)=>{let{selection:X}=F;if(!X||X.empty)return!1;let Q=v(F.doc,X.$from),ae=v(F.doc,X.$to);if(typeof Q!="number"||typeof ae!="number"||Q===ae||k(X.$from,"outlineBody")===null||X.$to.parent?.type?.name!=="outlineHeading"||X.$to.parentOffset!==0)return!1;let be=F.doc.nodeAt(Q);if(!be)return!1;let ke=be.child(0),ve=be.child(1),Be=Q+1+ke.nodeSize,Ie=Be+1,_e=Be+ve.nodeSize-1,Me=Math.max(X.from,Ie),Te=Math.min(X.to,_e);if(Te<Me)return!0;let xe=F.tr.delete(Me,Te),Le=xe.doc.nodeAt(Be);if(Le&&Le.content.size===0){let qe=xe.doc.type.schema;xe=xe.insert(Ie,qe.nodes.paragraph.create({},[]))}return xe=xe.setSelection(g.near(xe.doc.resolve(Ie+1),1)),ne(xe.scrollIntoView()),!0},V=(F,ne,X={})=>{let{selection:Q}=F;if(!Q||Q.empty)return!1;let ae=v(F.doc,Q.$from),Se=v(F.doc,Q.$to);if(typeof ae!="number"||typeof Se!="number"||ae!==Se)return!1;let be=k(Q.$from,"outlineHeading"),ke=k(Q.$to,"outlineHeading");if(be===null||ke===null)return!1;let ve=F.doc.nodeAt(ae);if(!ve)return!1;let Be=ve.child(0),Ie=ae+1,_e=Ie+1,Me=Ie+Be.nodeSize-1;if(Q.from<_e||Q.to>Me)return!1;let Te=Math.max(Q.from,_e),xe=Math.min(Q.to,Me);if(xe<Te)return!0;if(typeof X.onClipboard=="function")try{let qe=F.doc.textBetween(Te,xe,`
`,`
`);X.onClipboard(qe)}catch{}let Le=F.tr.delete(Te,xe);return Le=Le.setSelection(g.near(Le.doc.resolve(_e),1)),ne(Le.scrollIntoView()),!0},P=F=>{if(!F)return!0;let ne=F.child(0),X=F.child(1),Q=F.child(2);return _(ne)&&_(X)&&(!Q||Q.childCount===0)},M=(F,ne,X)=>{let Q=F.doc.nodeAt(X);if(!Q)return!1;let ae=Q.child(0),Se=Q.child(1),ke=X+1+ae.nodeSize+Se.nodeSize-1,ve=F.tr.setSelection(g.near(F.doc.resolve(ke),-1));return ne(ve.scrollIntoView()),!0},H=(F,ne,X)=>{let Q=F.doc.nodeAt(X);if(!Q)return!1;let ae=Q.child(0),Se=X+1,be=F.tr.setSelection(g.near(F.doc.resolve(Se+1),1));return ne(be.scrollIntoView()),!0},C=(F,ne,X)=>{let Q=F.doc.nodeAt(X);if(!Q)return!1;let ae=Q.child(0),Se=Q.child(1),be=X+1+ae.nodeSize,ke=F.tr;if(!Se.childCount){let ve=F.doc.type.schema;ke=ke.insert(be+1,ve.nodes.paragraph.create({},[]))}return ke=ke.setSelection(g.near(ke.doc.resolve(be+2),1)),ne(ke.scrollIntoView()),!0},E=(F,ne,X)=>{let Q=F.doc.nodeAt(X);if(!Q)return!1;let ae=Q.child(0),Se=Q.child(1);if(!!Q.attrs?.collapsed){let _e=X+1+ae.nodeSize-1,Me=F.tr.setSelection(g.near(F.doc.resolve(_e),-1));return ne(Me),!0}let ve=X+1+ae.nodeSize+Se.nodeSize-1,Be=F.tr.setSelection(g.near(F.doc.resolve(ve),-1));return ne(Be),!0},A=(F,ne)=>{try{let X=F.resolve(Math.min(F.content.size,Math.max(0,ne+1)));for(let Q=X.depth;Q>0;Q-=1){let ae=X.node(Q);if(!(ae?.type?.name!=="outlineSection"||X.before(Q)===ne)&&ae.attrs?.collapsed)return!1}return!0}catch{return!0}},I=(F,ne)=>{let X=null;return F.nodesBetween(0,ne,(Q,ae)=>{if(ae>=ne)return!1;Q?.type?.name==="outlineSection"&&A(F,ae)&&(X=ae)}),X},R=(F,ne,X)=>{let Q=F.doc.nodeAt(X);if(!Q)return!1;let ae=String(Q.attrs?.id||"").trim(),Se=F.doc.resolve(X),be=Se.index(),ke=Se.parent;if(!ke)return!1;if(ke.childCount<=1){if(ke.type?.name==="doc"){let Le=F.doc.type.schema,qe=Le.nodes.outlineSection.create({...Q.attrs,collapsed:!1},[Le.nodes.outlineHeading.create({},[]),Le.nodes.outlineBody.create({},[Le.nodes.paragraph.create({},[])]),Le.nodes.outlineChildren.create({},[])]),et=F.tr.replaceWith(X,X+Q.nodeSize,qe);et=et.setMeta(ce,!0);let Ge=qe.child(0),tt=X+1+Ge.nodeSize;return ne(et.setSelection(g.near(et.doc.resolve(tt+2),1)).scrollIntoView()),!0}let Te=null;try{for(let Le=Se.depth;Le>0;Le-=1)if(Se.node(Le)?.type?.name==="outlineSection"){Te=Se.before(Le);break}}catch{Te=null}let xe=F.tr.delete(X,X+Q.nodeSize);xe=xe.setMeta(ce,!0);try{if(typeof Te=="number"){let Le=xe.mapping.map(Te,-1),qe=xe.doc.nodeAt(Le);if(qe&&qe.type?.name==="outlineSection"){let et=qe.child(0),Ge=qe.child(1),tt=Le+1+et.nodeSize;if(!Ge.childCount){let St=xe.doc.type.schema;xe=xe.insert(tt+1,St.nodes.paragraph.create({},[]))}xe=xe.setSelection(g.near(xe.doc.resolve(tt+2),1))}}}catch{}return ne(xe.scrollIntoView()),!0}ae&&uo(ae);let ve=be>0,Be=ve?ke.child(be-1):null,Ie=ve?X-Be.nodeSize:null,_e=X+Q.nodeSize,Me=F.tr.delete(X,X+Q.nodeSize);if(ve&&typeof Ie=="number"){let Te=Me.doc.nodeAt(Ie);if(Te){let xe=Te.child(0),Le=Te.child(1),qe=Ie+1+xe.nodeSize;if(!Le.childCount){let et=Me.doc.type.schema;Me=Me.insert(qe+1,et.nodes.paragraph.create({},[]))}Me=Me.setSelection(g.near(Me.doc.resolve(qe+2),1))}}else{let Te=X<Me.doc.content.size?X:_e,xe=Me.doc.nodeAt(Te);if(xe){let Le=xe.child(0),qe=xe.child(1),et=Te+1+Le.nodeSize;if(!qe.childCount){let Ge=Me.doc.type.schema;Me=Me.insert(et+1,Ge.nodes.paragraph.create({},[]))}Me=Me.setSelection(g.near(Me.doc.resolve(et+2),1))}}return Me=Me.setMeta(ce,!0),ne(Me.scrollIntoView()),!0},D=(F,ne,X)=>{let Q=F.doc.nodeAt(X);if(!Q)return!1;let ae=String(Q.attrs?.id||"").trim(),Se=F.doc.resolve(X),be=Se.index(),ke=Se.parent;if(!ke||be<=0)return!1;ae&&uo(ae);let ve=ke.child(be-1),Be=X-ve.nodeSize,Ie=Q.child(0),_e=Q.child(1),Me=Q.child(2),Te=F.tr.delete(X,X+Q.nodeSize),xe=Te.doc.nodeAt(Be);if(!xe)return Te=Te.setMeta(ce,!0),ne(Te.scrollIntoView()),!0;let Le=Te.doc.type.schema,qe=xe.child(0),et=xe.child(1),Ge=xe.child(2),tt=[],St=(Ie?.textContent||"").replace(/\u00a0/g," ").trim();St&&tt.push(Le.nodes.paragraph.create({},[Le.text(St)])),_e?.content?.forEach?.(Ct=>{tt.push(Ct)});let At=tt.length?Le.nodes.outlineBody.create({},tt).content:null,An=At?et.content.append(At):et.content,Vt=Ge.content.append(Me.content),In=Le.nodes.outlineSection.create(xe.attrs,[qe,Le.nodes.outlineBody.create({},An),Le.nodes.outlineChildren.create({},Vt)]);Te=Te.replaceWith(Be,Be+xe.nodeSize,In);let ht=Te.doc.nodeAt(Be);if(ht){let Ct=ht.child(0),Pn=ht.child(1),_t=Be+1+Ct.nodeSize+Pn.nodeSize-1;Te=Te.setSelection(g.near(Te.doc.resolve(_t),-1))}return Te=Te.setMeta(ce,!0),ne(Te.scrollIntoView()),!0},z=(F,ne,X)=>{let Q=F.doc.nodeAt(X);if(!Q)return!1;let ae=String(Q.attrs?.id||"").trim(),Se=F.selection.$from,be=null,ke=null;for(let Ct=Se.depth;Ct>0;Ct-=1)if(Se.node(Ct)?.type?.name==="outlineSection")if(be===null)be=Ct;else{ke=Ct;break}if(be===null||ke===null)return!1;let ve=Se.before(ke);if(!F.doc.nodeAt(ve))return!1;let Ie=F.doc.type.schema,_e=Q.child(0),Me=Q.child(1),Te=Q.child(2);ae&&uo(ae);let xe=F.tr.delete(X,X+Q.nodeSize),Le=xe.doc.nodeAt(ve);if(!Le)return xe=xe.setMeta(ce,!0),ne(xe.scrollIntoView()),!0;let qe=Le.child(0),et=Le.child(1),Ge=Le.child(2),tt=[],St=(_e?.textContent||"").replace(/\u00a0/g," ").trim();St&&tt.push(Ie.nodes.paragraph.create({},[Ie.text(St)])),Me?.content?.forEach?.(Ct=>{tt.push(Ct)});let At=tt.length?Ie.nodes.outlineBody.create({},tt).content:null,An=At?et.content.append(At):et.content,Vt=Te.content.append(Ge.content),In=Ie.nodes.outlineSection.create({...Le.attrs,collapsed:!1},[qe,Ie.nodes.outlineBody.create({},An),Ie.nodes.outlineChildren.create({},Vt)]);xe=xe.replaceWith(ve,ve+Le.nodeSize,In);let ht=xe.doc.nodeAt(ve);if(ht){let Ct=ht.child(0),Pn=ht.child(1),_t=ve+1+Ct.nodeSize+Pn.nodeSize-1;xe=xe.setSelection(g.near(xe.doc.resolve(_t),-1))}return xe=xe.setMeta(ce,!0),ne(xe.scrollIntoView()),!0},q=(F,ne,X)=>{let Q=F.doc.nodeAt(X);if(!Q)return!1;let ae=F.doc.resolve(X),Se=ae.index(),be=ae.parent;if(!be||Se>=be.childCount-1)return!1;let ke=X+Q.nodeSize,ve=F.doc.nodeAt(ke);if(!ve||ve.type?.name!=="outlineSection")return!1;let Be=F.doc.type.schema,Ie=Q.child(0),_e=Q.child(1),Me=Q.child(2),Te=ve.child(1),xe=ve.child(2),Le=_e.content.append(Te.content),qe=Me.content.append(xe.content),et=Be.nodes.outlineSection.create({...Q.attrs,collapsed:!1},[Ie,Be.nodes.outlineBody.create({},Le),Be.nodes.outlineChildren.create({},qe)]),Ge=F.tr;Ge=Ge.delete(ke,ke+ve.nodeSize),Ge=Ge.replaceWith(X,X+Q.nodeSize,et);let tt=Ge.doc.nodeAt(X);if(tt){let St=tt.child(0),At=tt.child(1),Vt=X+1+St.nodeSize+At.nodeSize-1;Ge=Ge.setSelection(g.near(Ge.doc.resolve(Vt),-1))}return Ge=Ge.setMeta(ce,!0),ne(Ge.scrollIntoView()),!0},W=F=>this.editor.commands.command(({state:ne,dispatch:X})=>{let Q=Te=>{try{if(typeof CSS<"u"&&CSS&&typeof CSS.escape=="function")return CSS.escape(String(Te||""))}catch{}return String(Te||"").replace(/["\\]/g,"\\$&")},ae=Te=>{try{let xe=Te;for(;xe&&xe!==document.body;){let Le=xe.parentElement;if(!Le)break;let qe=window.getComputedStyle(Le),et=String(qe?.overflowY||"");if((et==="auto"||et==="scroll")&&Le.scrollHeight>Le.clientHeight+1)return Le;xe=Le}}catch{}return document.scrollingElement||document.documentElement},Se=Te=>{try{let xe=String(Te||"").trim();if(!xe)return null;let Le=document.querySelector(`.outline-heading[data-section-id="${Q(xe)}"]`);if(!Le)return null;let qe=ae(Le);return{sid:xe,scrollEl:qe,top:Le.getBoundingClientRect().top}}catch{return null}},be=Te=>{if(!Te)return;let{sid:xe,scrollEl:Le,top:qe}=Te,et=()=>{try{let Ge=document.querySelector(`.outline-heading[data-section-id="${Q(xe)}"]`);if(!Ge)return;let St=Ge.getBoundingClientRect().top-qe;if(!Number.isFinite(St)||Math.abs(St)<1)return;Le.scrollTop+=St}catch{}};try{requestAnimationFrame(()=>requestAnimationFrame(et))}catch{setTimeout(et,0)}},ke=v(ne.doc,ne.selection.$from);if(typeof ke!="number")return!1;let ve=ne.doc.resolve(ke),Be=ve.index(),Ie=ve.parent;if(!Ie)return!1;let _e=ne.doc.nodeAt(ke);if(!_e)return!1;let Me=Se(String(_e.attrs?.id||"").trim());if(F==="up"){if(Be>0){let fr=Ie.child(Be-1),Gn=ke-fr.nodeSize,Ot=ne.tr.delete(ke,ke+_e.nodeSize).insert(Gn,_e).setMeta(ce,!0),Tr=g.near(Ot.doc.resolve(Gn+2),1);return Ot.setSelection(Tr),X(Ot.scrollIntoView()),be(Me),!0}let Te=fe(ne.doc,ke);if(typeof Te!="number")return!1;let xe=ne.doc.resolve(Te),Le=xe.index(),qe=xe.parent;if(!qe||Le<=0)return!1;let et=qe.child(Le-1),Ge=Te-et.nodeSize,tt=ne.doc.nodeAt(Ge);if(!tt||tt.type?.name!=="outlineSection")return!1;let St=tt.child(0),At=tt.child(1),An=tt.child(2),In=Ge+1+St.nodeSize+At.nodeSize+An.nodeSize-1,ht=ne.tr.delete(ke,ke+_e.nodeSize).setMeta(ce,!0),Ct=ht.mapping.map(Ge,-1),Pn=ht.mapping.map(In,-1);ht=ht.insert(Pn,_e);let vn=ht.doc.nodeAt(Ct);vn?.type?.name==="outlineSection"&&vn.attrs?.collapsed&&(ht=ht.setNodeMarkup(Ct,void 0,{...vn.attrs,collapsed:!1}));let _t=g.near(ht.doc.resolve(Pn+2),1);return ht.setSelection(_t),X(ht.scrollIntoView()),be(Me),!0}if(F==="down"){if(Be<Ie.childCount-1){let fr=ke+_e.nodeSize,Gn=ne.doc.nodeAt(fr);if(!Gn)return!1;let Ot=ne.tr.delete(ke,ke+_e.nodeSize).setMeta(ce,!0),Tr=ke+Gn.nodeSize;Ot.insert(Tr,_e);let mi=g.near(Ot.doc.resolve(Tr+2),1);return Ot.setSelection(mi),X(Ot.scrollIntoView()),be(Me),!0}let Te=fe(ne.doc,ke);if(typeof Te!="number")return!1;let xe=ne.doc.nodeAt(Te);if(!xe||xe.type?.name!=="outlineSection")return!1;let Le=ne.doc.resolve(Te),qe=Le.index(),et=Le.parent;if(!et||qe>=et.childCount-1)return!1;let Ge=Te+xe.nodeSize,tt=ne.doc.nodeAt(Ge);if(!tt||tt.type?.name!=="outlineSection")return!1;let St=tt.child(0),At=tt.child(1),An=tt.child(2),In=Ge+1+St.nodeSize+At.nodeSize+1,ht=ne.tr.delete(ke,ke+_e.nodeSize).setMeta(ce,!0),Ct=ht.mapping.map(Ge,-1),Pn=ht.mapping.map(In,-1);ht=ht.insert(Pn,_e);let vn=ht.doc.nodeAt(Ct);vn?.type?.name==="outlineSection"&&vn.attrs?.collapsed&&(ht=ht.setNodeMarkup(Ct,void 0,{...vn.attrs,collapsed:!1}));let _t=g.near(ht.doc.resolve(Pn+2),1);return ht.setSelection(_t),X(ht.scrollIntoView()),be(Me),!0}return!1}),K=()=>this.editor.commands.command(({state:F,dispatch:ne})=>{let{selection:X}=F;if(!X?.empty)return!1;let{$from:Q}=X,ae=v(F.doc,Q);if(typeof ae!="number")return!1;let Se=F.doc.nodeAt(ae);if(!Se)return!1;let be=F.doc.type.schema;if(Se.attrs?.collapsed){let _t=ae+Se.nodeSize,fr=Xt(),Gn=be.nodes.outlineSection.create({id:fr,collapsed:!1},[be.nodes.outlineHeading.create({},[]),be.nodes.outlineBody.create({},[be.nodes.paragraph.create({},[])]),be.nodes.outlineChildren.create({},[])]),Ot=F.tr.insert(_t,Gn);return Ot=Ot.setSelection(g.create(Ot.doc,_t+2)),Ot=Ot.setMeta(ce,!0),Ae&&(Ot=Ot.setMeta(Ae,{type:"enter",sectionId:fr})),ne(Ot.scrollIntoView()),!0}let ke=be.nodes.outlineChildren.create({},[]),ve=_t=>_t&&_t.childCount?_t:be.nodes.outlineBody.create({},[be.nodes.paragraph.create({},[])]);if(Q.parent?.type?.name==="outlineHeading"){let _t=Se.child(0),fr=Se.child(1),Gn=Se.child(2),Ot=Q.parentOffset||0,Tr=_t.textBetween(0,Math.max(0,Math.min(Ot,_t.content.size)),"",""),mi=_t.textBetween(Math.max(0,Math.min(Ot,_t.content.size)),_t.content.size,"",""),pm=be.nodes.outlineHeading.create({},Tr?[be.text(Tr)]:[]),mm=be.nodes.outlineHeading.create({},mi?[be.text(mi)]:[]),sl=Xt(),al=be.nodes.outlineSection.create({...Se.attrs,collapsed:!1},[pm,ve(be.nodes.outlineBody.create({},[])),ke]),hm=be.nodes.outlineSection.create({id:sl,collapsed:!1},[mm,ve(fr),Gn]),Dn=F.tr.replaceWith(ae,ae+Se.nodeSize,al),cl=Dn.doc.nodeAt(ae),ll=ae+(cl?cl.nodeSize:al.nodeSize);return Dn=Dn.insert(ll,hm),Dn=Dn.setSelection(g.create(Dn.doc,ll+2)),Dn=Dn.setMeta(ce,!0),Ae&&(Dn=Dn.setMeta(Ae,{type:"enter",sectionId:sl})),ne(Dn.scrollIntoView()),!0}if(k(Q,"outlineBody")===null||!Q.parent?.isTextblock)return!1;let Ie=F.tr,_e=X.from;try{Ie=Ie.split(_e)}catch{return!1}let Me=Ie.mapping.map(_e);try{Ie=Ie.setSelection(g.near(Ie.doc.resolve(Math.min(Ie.doc.content.size,Me+1)),1))}catch{}let Te=Ie.selection.$from,xe=k(Te,"outlineBody"),Le=k(Te,"paragraph");if(xe===null||Le===null)return!1;let qe=Te.before(Le),et=Te.end(xe);if(typeof qe!="number"||typeof et!="number"||et<qe)return!1;let Ge=Ie.doc.slice(qe,et).content;Ie=Ie.delete(qe,et);let tt=Ie.mapping.map(ae,-1),St=Ie.doc.nodeAt(tt);if(!St)return ne(Ie.scrollIntoView()),!0;let At=St.child(0),An=ve(St.child(1)),Vt=St.child(2),In=be.nodes.outlineSection.create({...St.attrs,collapsed:!1},[At,An,ke]),ht=Ge&&Ge.childCount?be.nodes.outlineBody.create({},Ge):be.nodes.outlineBody.create({},[be.nodes.paragraph.create({},[])]),Ct=Xt(),Pn=be.nodes.outlineSection.create({id:Ct,collapsed:!1},[be.nodes.outlineHeading.create({},[]),ht,Vt]);Ie=Ie.replaceWith(tt,tt+St.nodeSize,In);let vn=tt+In.nodeSize;return Ie=Ie.insert(vn,Pn),Ie=Ie.setSelection(g.create(Ie.doc,vn+2)),Ie=Ie.setMeta(ce,!0),Ae&&(Ie=Ie.setMeta(Ae,{type:"enter",sectionId:Ct})),ne(Ie.scrollIntoView()),!0}),j=()=>this.editor.commands.command(({state:F,dispatch:ne})=>{let X=v(F.doc,F.selection.$from);if(typeof X!="number")return!1;let Q=F.doc.resolve(X),ae=0;for(let tt=Q.depth;tt>=0;tt-=1)Q.node(tt)?.type?.name==="outlineSection"&&(ae+=1);if(ae>=6)return!1;let Se=Q.index(),be=Q.parent;if(!be||Se<=0)return!1;let ke=F.doc.nodeAt(X);if(!ke)return!1;let ve=be.child(Se-1),Be=X-ve.nodeSize,Ie=F.doc.nodeAt(Be);if(!Ie)return!1;let _e=Ie.child(0),Me=Ie.child(1),Te=Ie.child(2),Le=Be+1+_e.nodeSize+Me.nodeSize+Te.nodeSize-1,qe=F.tr.delete(X,X+ke.nodeSize).insert(Le,ke).setMeta(ce,!0),et=qe.doc.nodeAt(Be);et?.type?.name==="outlineSection"&&et.attrs?.collapsed&&(qe=qe.setNodeMarkup(Be,void 0,{...et.attrs,collapsed:!1}));let Ge=g.near(qe.doc.resolve(Le+2),1);return qe.setSelection(Ge),ne(qe.scrollIntoView()),!0}),ee=()=>this.editor.commands.command(({state:F,dispatch:ne})=>{let X=F.selection.$from,Q=null,ae=null;for(let Me=X.depth;Me>0;Me-=1)if(X.node(Me)?.type?.name==="outlineSection")if(Q===null)Q=Me;else{ae=Me;break}if(Q===null||ae===null)return!1;let Se=X.before(Q),be=X.before(ae),ke=F.doc.nodeAt(Se);if(!ke)return!1;let ve=F.tr.delete(Se,Se+ke.nodeSize).setMeta(ce,!0),Be=ve.doc.nodeAt(be);if(!Be)return!1;let Ie=be+Be.nodeSize;ve.insert(Ie,ke);let _e=g.near(ve.doc.resolve(Ie+2),1);return ve.setSelection(_e),ne(ve.scrollIntoView()),!0}),se=F=>this.editor.commands.command(({state:ne,dispatch:X})=>{let Q=v(ne.doc,ne.selection.$from);if(typeof Q!="number")return!1;let ae=ne.doc.nodeAt(Q);if(!ae)return!1;let Se=typeof F=="boolean"?F:!ae.attrs?.collapsed,be=ne.tr.setNodeMarkup(Q,void 0,{...ae.attrs,collapsed:Se}).setMeta(ce,!0);try{Se&&Ae&&(Ae.getState(ne)||{}).editingSectionId&&(be=be.setMeta(Ae,{type:"exit"}))}catch{}return X(be),!0}),we=(F,ne)=>{let X=F.nodeAt(ne);if(!X||X.type?.name!=="outlineSection")return[];let Q=[ne];return X.descendants((ae,Se)=>{ae?.type?.name==="outlineSection"&&Q.push(ne+1+Se)}),Q},fe=(F,ne)=>{try{let X=F.resolve(Math.min(F.content.size,ne+1)),Q=null;for(let ae=X.depth;ae>0;ae-=1){if(X.node(ae)?.type?.name!=="outlineSection")continue;if(X.before(ae)===ne){Q=ae;break}}if(Q===null)return null;for(let ae=Q-1;ae>0;ae-=1)if(X.node(ae)?.type?.name==="outlineSection")return X.before(ae);return null}catch{return null}},Pe=(F,ne,X,Q)=>{let ae=!!Q,Se=F.tr;for(let be of X){let ke=Se.doc.nodeAt(be);!ke||ke.type?.name!=="outlineSection"||!!ke.attrs?.collapsed!==ae&&(Se=Se.setNodeMarkup(be,void 0,{...ke.attrs,collapsed:ae}))}Se=Se.setMeta(ce,!0);try{ae&&Ae&&(Ae.getState(F)||{}).editingSectionId&&(Se=Se.setMeta(Ae,{type:"exit"}))}catch{}ne(Se)},Oe=()=>this.editor.commands.command(({state:F,dispatch:ne})=>{let X=v(F.doc,F.selection.$from);if(typeof X!="number")return!1;let Q=fe(F.doc,X),ae=typeof Q=="number"?Q:X,Se=we(F.doc,ae);if(!Se.length)return!1;let be=F.tr;for(let ve of Se){let Be=be.doc.nodeAt(ve);!Be||Be.type?.name!=="outlineSection"||Be.attrs?.collapsed||(be=be.setNodeMarkup(ve,void 0,{...Be.attrs,collapsed:!0}))}be=be.setMeta(ce,!0);let ke=be.doc.nodeAt(ae);if(ke){let ve=ke.child(0),Ie=ae+1+ve.nodeSize-1;be=be.setSelection(g.near(be.doc.resolve(Ie),-1))}return ne(be.scrollIntoView()),!0}),Ye=()=>this.editor.commands.command(({state:F,dispatch:ne})=>{let X=v(F.doc,F.selection.$from);if(typeof X!="number")return!1;let Q=we(F.doc,X);return Q.length?(Pe(F,ne,Q,!1),!0):!1}),bt=F=>this.editor.commands.command(({state:ne,dispatch:X})=>{let{selection:Q}=ne,Se=(Q?.node||null)?.type?.name==="outlineSection"?Q.from:v(ne.doc,ne.selection.$from);if(typeof Se!="number"||!ne.doc.nodeAt(Se))return!1;let ke=!!F,ve=we(ne.doc,Se);return ve.length?(Pe(ne,X,ve,ke),!0):!1});return{"Alt-ArrowUp":()=>this.editor.isActive("table")?!1:W("up"),"Alt-ArrowDown":()=>this.editor.isActive("table")?!1:W("down"),"Alt-ArrowRight":()=>this.editor.isActive("table")?!1:j(),"Alt-ArrowLeft":()=>this.editor.isActive("table")?!1:ee(),"Mod-ArrowRight":()=>se(!1),"Mod-ArrowLeft":()=>se(!0),"Mod-ArrowUp":()=>{try{let F=this.editor.state,ne=v(F.doc,F.selection.$from);if(typeof ne=="number"){let X=F.doc.nodeAt(ne);if(X?.type?.name==="outlineSection"&&typeof fe(F.doc,ne)!="number"&&X.attrs?.collapsed)return Oc(this.editor,!0)}}catch{}return Oe()},"Mod-ArrowDown":()=>Ye(),"Mod-Enter":()=>{try{if(Ae&&!(Ae.getState(this.editor.state)||{}).editingSectionId)return!1}catch{}return K()},Backspace:()=>this.editor.commands.command(({state:F,dispatch:ne})=>{let{selection:X}=F;if(V(F,ne)||O(F,ne))return!0;if(!X?.empty)return!1;let{$from:Q}=X;if(Q.parent?.type?.name!=="outlineHeading"||Q.parentOffset!==0)return!1;let ae=v(F.doc,Q);if(typeof ae!="number")return!1;let Se=F.doc.nodeAt(ae);if(!Se)return!1;if(P(Se))return R(F,ne,ae);try{if(F.doc.resolve(ae).index()<=0)return z(F,ne,ae)}catch{}return D(F,ne,ae)}),Delete:()=>this.editor.commands.command(({state:F,dispatch:ne})=>{let{selection:X}=F;if(V(F,ne)||O(F,ne))return!0;if(!X?.empty)return!1;let{$from:Q}=X;if(k(Q,"outlineBody")!==null){let ve=v(F.doc,Q);if(typeof ve!="number")return!1;let Be=F.doc.nodeAt(ve);if(!Be)return!1;let Ie=Be.child(0),_e=Be.child(1),Te=ve+1+Ie.nodeSize+_e.nodeSize-1;return Q.pos===Te?q(F,ne,ve):!1}if(Q.parent?.type?.name!=="outlineHeading")return!1;let Se=v(F.doc,Q);if(typeof Se!="number")return!1;let be=F.doc.nodeAt(Se);if(!be)return!1;let ke=be.child(0);if(Q.parentOffset===ke.content.size){if(P(be))return R(F,ne,Se);let ve=be.child(1),Be=Se+1+ke.nodeSize,Ie=F.tr;if(!ve.childCount){let _e=F.doc.type.schema;Ie=Ie.insert(Be+1,_e.nodes.paragraph.create({},[]))}return Ie=Ie.setSelection(g.near(Ie.doc.resolve(Be+2),1)),ne(Ie.scrollIntoView()),!0}return!1}),Enter:()=>this.editor.commands.command(({state:F,dispatch:ne})=>{let{selection:X}=F;if(!X?.empty)return!1;let{$from:Q}=X;if(Q.parent?.type?.name!=="outlineHeading")return!1;try{if(Ae&&!(Ae.getState(F)||{}).editingSectionId)return!1}catch{}let ae=v(F.doc,Q);if(typeof ae!="number")return!1;let Se=F.doc.nodeAt(ae);if(!Se)return!1;let be=Se.child(0),ke=Se.child(1),ve=ae+1+be.nodeSize,Be=be.content?.size??0;if(Se.attrs?.collapsed&&Q.parentOffset===Be){let _e=ae+Se.nodeSize,Me=F.doc.type.schema,Te=Xt(),xe=Me.nodes.outlineSection.create({id:Te,collapsed:!1},[Me.nodes.outlineHeading.create({},[]),Me.nodes.outlineBody.create({},[Me.nodes.paragraph.create({},[])]),Me.nodes.outlineChildren.create({},[])]),Le=F.tr.insert(_e,xe);return Le=Le.setSelection(g.create(Le.doc,_e+2)),Le=Le.setMeta(ce,!0),Ae&&(Le=Le.setMeta(Ae,{type:"enter",sectionId:Te})),ne(Le.scrollIntoView()),!0}if(Q.parentOffset===0){let _e=F.doc.type.schema,Me=Xt(),Te=_e.nodes.outlineSection.create({id:Me,collapsed:!1},[_e.nodes.outlineHeading.create({},[]),_e.nodes.outlineBody.create({},[_e.nodes.paragraph.create({},[])]),_e.nodes.outlineChildren.create({},[])]),xe=F.tr.insert(ae,Te);return xe=xe.setSelection(g.create(xe.doc,ae+2)),xe=xe.setMeta(ce,!0),Ae&&(xe=xe.setMeta(Ae,{type:"enter",sectionId:Me})),ne(xe.scrollIntoView()),!0}if(Q.parentOffset>0&&Q.parentOffset<Be){let _e=F.doc.type.schema,Me=be.textBetween(0,Math.max(0,Math.min(Q.parentOffset,Be)),"",""),Te=be.textBetween(Math.max(0,Math.min(Q.parentOffset,Be)),Be,"",""),xe=_e.nodes.outlineHeading.create({},Me?[_e.text(Me)]:[]),Le=Se.child(2),qe=[];try{for(let Vt=0;Vt<ke.childCount;Vt+=1)qe.push(ke.child(Vt))}catch{}let et=_e.nodes.paragraph.create({},Te?[_e.text(Te)]:[]),Ge=[];if(Te){let Vt=qe[0]||null;Vt&&Vt.type?.name==="paragraph"&&_(Vt)?Ge=[et,...qe.slice(1)]:Ge=[et,...qe]}else Ge=qe;Ge.length||(Ge=[_e.nodes.paragraph.create({},[])]);let tt=_e.nodes.outlineBody.create({},Ge),St=_e.nodes.outlineSection.create({...Se.attrs,collapsed:!1},[xe,tt,Le]),At=F.tr.replaceWith(ae,ae+Se.nodeSize,St),An=At.doc.nodeAt(ae);if(An){let Vt=An.child(0),In=ae+1+Vt.nodeSize;At=At.setSelection(g.near(At.doc.resolve(In+2),1))}else At=At.setSelection(g.near(At.doc.resolve(ve+2),1));return At=At.setMeta(ce,!0),ne(At.scrollIntoView()),!0}let Ie=F.tr;if(!ke.childCount){let _e=F.doc.type.schema;Ie=Ie.insert(ve+1,_e.nodes.paragraph.create({},[]))}return Ie=Ie.setSelection(g.near(Ie.doc.resolve(ve+2),1)),ne(Ie.scrollIntoView()),!0}),ArrowUp:()=>this.editor.commands.command(({state:F,dispatch:ne})=>{let{selection:X}=F;if(!X?.empty)return!1;let{$from:Q}=X;if(Q.parent?.type?.name!=="outlineHeading"||Q.parentOffset!==0)return!1;let ae=v(F.doc,Q);if(typeof ae!="number")return!1;let Se=I(F.doc,ae);if(typeof Se=="number")return H(F,ne,Se);let be=F.doc.resolve(ae),ke=be.index(),ve=be.parent;if(!ve)return!1;if(ke>0){let Me=ve.child(ke-1),Te=ae-Me.nodeSize;return H(F,ne,Te)}let Be=null,Ie=null;for(let Me=Q.depth;Me>0;Me-=1)if(Q.node(Me)?.type?.name==="outlineSection")if(Be===null)Be=Me;else{Ie=Me;break}if(Ie===null)return!1;let _e=Q.before(Ie);return H(F,ne,_e)})}},addProseMirrorPlugins(){let v=(k,_)=>{for(let O=k.depth;O>0;O-=1)if(k.node(O)?.type?.name===_)return O;return null};return[new w({key:new S("outlineAltMoveRepeatGuard"),props:{handleKeyDown:(k,_)=>{try{if(!_||!_.altKey||_.metaKey||_.ctrlKey)return!1;let O=String(_.key||"");if(O!=="ArrowUp"&&O!=="ArrowDown"||!_.repeat)return!1;let V=k?.state,P=V?.selection?.$from;if(!P)return!1;for(let A=P.depth;A>0;A-=1){let I=P.node(A)?.type?.name;if(I&&String(I).startsWith("table"))return!1}let M=null;for(let A=P.depth;A>0;A-=1)if(P.node(A)?.type?.name==="outlineSection"){M=P.before(A);break}if(typeof M!="number")return!1;let H=V.doc.resolve(M),C=H.parent;if(!C)return!1;let E=H.index();return O==="ArrowUp"&&E<=0||O==="ArrowDown"&&E>=C.childCount-1}catch{return!1}}}}),new w({props:{handleDOMEvents:{cut:(k,_)=>{try{let{state:O}=k,{selection:V}=O;if(!V||V.empty)return!1;let P=(we,fe)=>{for(let Pe=fe.depth;Pe>0;Pe-=1)if(fe.node(Pe)?.type?.name==="outlineSection")return fe.before(Pe);return null},M=P(O.doc,V.$from),H=P(O.doc,V.$to);if(typeof M!="number"||typeof H!="number")return!1;let C=(we="")=>String(we||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");if(M===H){let we=v(V.$from,"outlineHeading"),fe=v(V.$to,"outlineHeading");if(we!==null&&fe!==null){let Pe=O.doc.nodeAt(M);if(!Pe)return!1;let Oe=Pe.child(0),Ye=M+1,bt=Ye+1,F=Ye+Oe.nodeSize-1;if(V.from>=bt&&V.to<=F){let ne=Math.max(V.from,bt),X=Math.min(V.to,F),Q=O.doc.textBetween(ne,X,`
`,`
`);if(_?.clipboardData)try{_.clipboardData.setData("text/plain",Q),_.clipboardData.setData("text/html",`<pre>${C(Q)}</pre>`)}catch{}_.preventDefault(),_.stopPropagation();let ae=O.tr.delete(ne,X);return ae=ae.setSelection(g.near(ae.doc.resolve(bt),1)),k.dispatch(ae.scrollIntoView()),!0}}return!1}if(v(V.$from,"outlineBody")===null||V.$to.parent?.type?.name!=="outlineHeading"||V.$to.parentOffset!==0)return!1;let A=O.doc.nodeAt(M);if(!A)return!1;let I=A.child(0),R=A.child(1),D=M+1+I.nodeSize,z=D+1,q=D+R.nodeSize-1,W=Math.max(V.from,z),K=Math.min(V.to,q);if(K<W)return!0;let j=O.doc.textBetween(W,K,`
`,`
`);if(_?.clipboardData)try{_.clipboardData.setData("text/plain",j),_.clipboardData.setData("text/html",`<pre>${C(j)}</pre>`)}catch{}_.preventDefault(),_.stopPropagation();let ee=O.tr.delete(W,K),se=ee.doc.nodeAt(D);if(se&&se.content.size===0){let we=ee.doc.type.schema;ee=ee.insert(z,we.nodes.paragraph.create({},[]))}return ee=ee.setSelection(g.near(ee.doc.resolve(z+1),1)),k.dispatch(ee.scrollIntoView()),!0}catch{return!1}}}}}),new w({props:{handleKeyDown:(k,_)=>{if(_.key!=="Backspace")return!1;let{state:O}=k,{selection:V}=O;if(!V?.empty)return!1;let{$from:P}=V;if(P.parent?.type?.name!=="paragraph"||P.parentOffset!==0)return!1;let M=null;for(let ee=P.depth;ee>0;ee-=1)if(P.node(ee)?.type?.name==="listItem"){M=ee;break}if(M===null||P.index(M)!==0)return!1;let H=M-1,C=P.node(H);if(!C)return!1;let E=P.index(H);if(E<=0)return!1;let A=P.before(M),I=C.child(E-1),R=A-I.nodeSize,D=O.doc.nodeAt(A);if(!D||D.type?.name!=="listItem")return!1;_.preventDefault(),_.stopPropagation();let z=I.type.create(I.attrs,I.content.append(D.content),I.marks),q=O.tr.replaceWith(R,R+I.nodeSize,z),W=R+1+I.content.size,K=q.mapping.map(W,1),j=q.mapping.map(A);q=q.delete(j,j+D.nodeSize);try{q=q.setSelection(g.near(q.doc.resolve(K+1),1))}catch{}return k.dispatch(q.scrollIntoView()),!0}}}),new w({props:{handleKeyDown:(k,_)=>(_.key!=="Tab"||_.preventDefault(),!1)}}),new w({props:{handleKeyDown:(k,_)=>{if(!_.ctrlKey||_.shiftKey||_.altKey||_.metaKey||_.key!=="ArrowUp"&&_.key!=="ArrowDown")return!1;let{state:O}=k,{selection:V}=O;if(!V)return!1;let M=(()=>{if((V?.node||null)?.type?.name==="outlineSection")return V.from;let R=V.$from;for(let D=R.depth;D>0;D-=1)if(R.node(D)?.type?.name==="outlineSection")return R.before(D);return null})();if(typeof M!="number")return!1;let H=(I,R)=>{try{let D=I.resolve(Math.min(I.content.size,R+1)),z=null;for(let q=D.depth;q>0;q-=1)if(D.node(q)?.type?.name==="outlineSection"&&D.before(q)===R){z=q;break}if(z===null)return null;for(let q=z-1;q>0;q-=1)if(D.node(q)?.type?.name==="outlineSection")return D.before(q);return null}catch{return null}},C=(I,R)=>{let D=I.nodeAt(R);if(!D||D.type?.name!=="outlineSection")return[];let z=[R];return D.descendants((q,W)=>{q?.type?.name==="outlineSection"&&z.push(R+1+W)}),z};if(_.preventDefault(),_.stopPropagation(),_.key==="ArrowUp"){let I=H(O.doc,M),R=typeof I=="number"?I:M,D=C(O.doc,R);if(!D.length)return!0;let z=O.tr;for(let W of D){let K=z.doc.nodeAt(W);!K||K.type?.name!=="outlineSection"||K.attrs?.collapsed||(z=z.setNodeMarkup(W,void 0,{...K.attrs,collapsed:!0}))}let q=z.doc.nodeAt(R);if(q){let W=q.child(0),j=R+1+W.nodeSize-1;z=z.setSelection(g.near(z.doc.resolve(j),-1))}return k.dispatch(z.scrollIntoView()),!0}let E=C(O.doc,M);if(!E.length)return!0;let A=O.tr;for(let I of E){let R=A.doc.nodeAt(I);!R||R.type?.name!=="outlineSection"||R.attrs?.collapsed&&(A=A.setNodeMarkup(I,void 0,{...R.attrs,collapsed:!1}))}return k.dispatch(A),!0}}}),new w({props:{handleKeyDown:(k,_)=>{if(_.key!=="Enter")return!1;let{state:O}=k,{$from:V}=O.selection;if(!O.selection.empty)return!1;let P=v(V,"outlineBody");if(P===null)return!1;let M=v(V,"paragraph");if(M===null||V.node(M-1)?.type?.name!=="outlineBody")return!1;let H=V.node(M);if(!H||H.content.size!==0||V.parentOffset!==0&&V.parentOffset!==H.content.size)return!1;let C=V.node(P),E=V.index(P);if(E!==C.childCount-1||E<1)return!1;let A=C.child(E-1);if(!A||A.type?.name!=="paragraph"||A.content.size!==0)return!1;let I=v(V,"outlineSection");if(I===null)return!1;let R=V.before(I);_.preventDefault(),_.stopPropagation();let D=O.tr,z=V.start(P),q=z;for(let Oe=0;Oe<E;Oe+=1)q+=C.child(Oe).nodeSize;let W=E;for(let Oe=E;Oe>=0;Oe-=1){let Ye=C.child(Oe);if(!Ye||Ye.type?.name!=="paragraph"||Ye.content.size!==0)break;W=Oe}let K=z;for(let Oe=0;Oe<W;Oe+=1)K+=C.child(Oe).nodeSize;let j=q+C.child(E).nodeSize;D=D.delete(K,j);let ee=D.doc.nodeAt(R);if(!ee)return!0;let se=R+ee.nodeSize,we=D.doc.type.schema,fe=Xt(),Pe=we.nodes.outlineSection.create({id:fe,collapsed:!1},[we.nodes.outlineHeading.create({},[]),we.nodes.outlineBody.create({},[we.nodes.paragraph.create({},[])]),we.nodes.outlineChildren.create({},[])]);return D=D.insert(se,Pe),D=D.setSelection(g.create(D.doc,se+2)),D=D.setMeta(ce,!0),Ae&&(D=D.setMeta(Ae,{type:"enter",sectionId:fe})),k.dispatch(D.scrollIntoView()),!0}}})]}}),Qe=u.create({name:"outlineActiveSection",addProseMirrorPlugins(){return[new w({props:{decorations(v){try{let k=Bt(v.doc,v.selection.$from);if(typeof k!="number")return null;let _=v.doc.nodeAt(k);return _?T.create(v.doc,[x.node(k,k+_.nodeSize,{"data-active":"true"})]):null}catch{return null}}}})]}}),Ve=u.create({name:"outlineEditMode",addProseMirrorPlugins(){let v=new S("outlineEditMode");Ae=v;let k=null,_=C=>{let E=Bt(C.doc,C.selection.$from);if(typeof E!="number")return null;let A=C.doc.nodeAt(E);return String(A?.attrs?.id||"")||null},O=(C,E,A)=>{if(!E.docChanged)return!0;if(!A)return!1;let I=mt(C.doc,A);if(typeof I!="number")return!1;let R=C.doc.nodeAt(I);if(!R)return!1;let D=R.child(0),z=R.child(1),q=I+1,W=q+1,K=q+D.nodeSize-1,j=I+1+D.nodeSize,ee=j+1,se=j+z.nodeSize-1,we=(fe,Pe)=>{let Oe=fe>=W&&Pe<=K,Ye=fe>=ee&&Pe<=se;return Oe||Ye};for(let fe of E.steps){let Pe=fe.getMap(),Oe=!0;if(Pe.forEach((Ye,bt)=>{we(Ye,bt)||(Oe=!1)}),!Oe)return!1}return!0},V=()=>{try{L("\u0414\u043B\u044F \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Enter \u0438\u043B\u0438 \u0434\u0432\u043E\u0439\u043D\u043E\u0439 \u043A\u043B\u0438\u043A \u043C\u044B\u0448\u043A\u043E\u0439. Esc \u0434\u043B\u044F \u0432\u044B\u0445\u043E\u0434\u0430.")}catch{}},P=()=>{try{L("\u041D\u0430\u0436\u043C\u0438\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437, \u0447\u0442\u043E\u0431\u044B \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438")}catch{}},M=C=>{try{let{selection:E}=C;if(!E?.empty)return!1;let{$from:A}=E,I=null;for(let K=A.depth;K>0;K-=1)if(A.node(K)?.type?.name==="outlineHeading"){I=K;break}if(I===null||!(A.pos===A.start(I)))return!1;let D=Bt(C.doc,A);if(typeof D!="number")return!1;if(C.doc.resolve(D).index()>0)return!0;let W=!1;for(let K=A.depth;K>0;K-=1)if(A.node(K)?.type?.name==="outlineSection"){if(!W){W=!0;continue}return!0}return!1}catch{return!1}},H=(C,E)=>{try{if(!E)return!1;let{selection:A}=C;if(!A?.empty)return!1;let{$from:I}=A,R=Bt(C.doc,I);if(typeof R!="number")return!1;let D=C.doc.nodeAt(R);if(!D||String(D.attrs?.id||"")!==String(E))return!1;let z=D.child(0),q=D.child(1),K=R+1+z.nodeSize+q.nodeSize-1;if(I.pos!==K)return!1;let j=C.doc.resolve(R),ee=j.index(),se=j.parent;return se?ee<se.childCount-1:!1}catch{return!1}};return[new w({key:v,state:{init(){return{editingSectionId:null}},apply(C,E){let A=C.getMeta(v);return A?A.type==="enter"?{editingSectionId:A.sectionId||null}:A.type==="exit"?{editingSectionId:null}:E:E}},filterTransaction(C,E){let I=(v.getState(E)||{}).editingSectionId||null;return C.getMeta(ce)||C.getMeta("history$")!=null||C.getMeta("closeHistory$")!=null||!C.docChanged?!0:O(E,C,I)},props:{decorations(C){try{let A=(v.getState(C)||{}).editingSectionId||null;if(!A)return null;let I=mt(C.doc,A);if(typeof I!="number")return null;let R=C.doc.nodeAt(I);return R?T.create(C.doc,[x.node(I,I+R.nodeSize,{"data-editing":"true"})]):null}catch{return null}},handleKeyDown(C,E){let A=C.state,R=(v.getState(A)||{}).editingSectionId||null;We("keydown",{key:E?.key||null,repeat:!!E?.repeat,editingSectionId:R||null,selection:{empty:!!A?.selection?.empty,parent:A?.selection?.$from?.parent?.type?.name||null,parentOffset:A?.selection?.$from?.parentOffset??null}});let D=_(A);if(!R&&(E.key==="Delete"||E.key==="Del"||E.key==="Backspace")&&(E.ctrlKey||E.metaKey)&&!E.shiftKey&&!E.altKey){try{deleteActiveSection()}catch{}return E.preventDefault(),E.stopPropagation(),!0}if(R&&E.key==="Backspace"&&!E.ctrlKey&&!E.metaKey&&!E.altKey){let q=Ng(A,C.dispatch,R,g);if(We("editorProps.backspace.bodyToHeading",{promoted:q,editingSectionId:R}),q)return E.preventDefault(),E.stopPropagation(),!0;let W=Mg(A,C.dispatch);if(We("editorProps.backspace.tableMerge",{merged:W,editingSectionId:R||null}),W)return E.preventDefault(),E.stopPropagation(),!0}try{let q=(E.key==="Enter"||E.code==="Enter"||E.code==="NumpadEnter")&&(E.ctrlKey||E.metaKey)&&!E.shiftKey&&!E.altKey;if(!a.isPublicView&&!R&&q){let W=A.selection,K=W?.$from||null;if(K){let j=Bt(A.doc,K),ee=typeof j=="number"?A.doc.nodeAt(j):null;if(typeof j=="number"&&ee&&ee.type?.name==="outlineSection"){let se=!!(W&&W.empty),we=K.parent?.type?.name==="outlineHeading",Pe=se&&we&&K.parentOffset===0?j:j+ee.nodeSize;E.preventDefault(),E.stopPropagation();let Oe=A.schema,Ye=Xt(),bt=Oe.nodes.outlineSection.create({id:Ye,collapsed:!1},[Oe.nodes.outlineHeading.create({},[]),Oe.nodes.outlineBody.create({},[Oe.nodes.paragraph.create({},[])]),Oe.nodes.outlineChildren.create({},[])]),F=A.tr.insert(Pe,bt);try{let X=F.doc.nodeAt(Pe)?.child?.(0)||bt.child(0),Q=Pe+1+X.nodeSize;F=F.setSelection(g.near(F.doc.resolve(Q+2),1))}catch{F=F.setSelection(g.create(F.doc,Pe+2))}F=F.setMeta(ce,!0),F=F.setMeta(v,{type:"enter",sectionId:Ye}),C.dispatch(F.scrollIntoView());try{C.focus()}catch{}return!0}}}}catch{}if((!k||k.sectionId!==D||k.key!==E.key)&&(k=null),a.isPublicView&&!R&&(E.key==="Enter"&&!E.shiftKey&&!E.ctrlKey&&!E.metaKey&&!E.altKey||E.key==="F2"&&!E.shiftKey&&!E.ctrlKey&&!E.metaKey&&!E.altKey))return E.preventDefault(),E.stopPropagation(),!0;if(!R&&(E.key==="Enter"&&!E.shiftKey&&!E.ctrlKey&&!E.metaKey&&!E.altKey||E.key==="F2"&&!E.shiftKey&&!E.ctrlKey&&!E.metaKey&&!E.altKey)){let q=_(A);return q?(E.preventDefault(),E.stopPropagation(),C.dispatch(A.tr.setMeta(v,{type:"enter",sectionId:q})),!0):!1}if(R&&E.key==="Escape")return E.preventDefault(),E.stopPropagation(),C.dispatch(A.tr.setMeta(v,{type:"exit"})),!0;if(!R){let q=E.key&&E.key.length===1&&!E.metaKey&&!E.ctrlKey&&!E.altKey;if(E.key==="Backspace"||E.key==="Delete"){if(E.key==="Backspace"&&M(A))try{let{selection:K}=A,{$from:j}=K,ee=findSectionPos(A.doc,j);if(typeof ee!="number")return!1;let se=A.doc.nodeAt(ee);if(!se)return!1;let we=String(se.attrs?.id||""),fe=null;try{let Oe=A.doc.resolve(ee),Ye=Oe.index(),bt=Oe.parent;if(bt&&Ye>0){let F=bt.child(Ye-1),ne=ee-F.nodeSize,X=A.doc.nodeAt(ne);fe=String(X?.attrs?.id||"")||null}else for(let F=j.depth-1;F>0;F-=1){let ne=j.node(F);if(ne?.type?.name==="outlineSection"){let X=String(ne.attrs?.id||"");if(X&&X!==we){fe=X;break}}}}catch{fe=null}let Pe=!1;if(me(se))Pe=Ee(A,C.dispatch,ee);else try{A.doc.resolve(ee).index()<=0?Pe=Je(A,C.dispatch,ee):Pe=Ne(A,C.dispatch,ee)}catch{Pe=Ne(A,C.dispatch,ee)}return Pe&&fe&&window.setTimeout(()=>{try{if((v.getState(C.state)||{}).editingSectionId)return;let Ye=mt(C.state.doc,fe),bt=typeof Ye=="number"?C.state.doc.nodeAt(Ye):null;if(!bt)return;let F=C.state.tr;bt?.attrs?.collapsed&&(F=F.setNodeMarkup(Ye,void 0,{...bt.attrs,collapsed:!1}),F=F.setMeta(ce,!0)),F=F.setMeta(v,{type:"enter",sectionId:fe});try{let ne=F.doc.nodeAt(Ye);if(ne&&ne.type?.name==="outlineSection"){let X=ne.child(0),Q=ne.child(1),Se=Ye+1+X.nodeSize+Q.nodeSize-1;F=F.setSelection(g.near(F.doc.resolve(Se),-1))}}catch{}C.dispatch(F.scrollIntoView());try{C.focus()}catch{}}catch{}},0),E.preventDefault(),E.stopPropagation(),!0}catch{}return E.preventDefault(),E.stopPropagation(),!0}if(q)return E.preventDefault(),E.stopPropagation(),V(),!0}let z=E.key==="Backspace"&&M(A)||E.key==="Delete"&&H(A,R);if(R&&(E.key==="Backspace"||E.key==="Delete")&&z){if(E.repeat)return E.preventDefault(),E.stopPropagation(),!0;let q=Date.now();return k&&k.sectionId===R&&k.key===E.key&&q-k.ts<1200?(k=null,!1):(k={sectionId:R,key:E.key,ts:q},E.preventDefault(),E.stopPropagation(),P(),!0)}return!1},handleTextInput(){let C=arguments[0],E=C?.state?v.getState(C.state):null;return E&&E.editingSectionId?!1:(V(),!0)},handleDOMEvents:{paste(C,E){let A=C.state;return(v.getState(A)||{}).editingSectionId?!1:(E.preventDefault(),E.stopPropagation(),V(),!0)},drop(C,E){let A=C.state;return(v.getState(A)||{}).editingSectionId?!1:(E.preventDefault(),E.stopPropagation(),V(),!0)}}}})]}}),rt=v=>{let k=(v||"").trim();if(!k)return[];let _=b(k,[y.configure({heading:!1,link:!1}),N.configure({openOnClick:!1,protocols:us}),G,$.configure({table:{resizable:!0}})]),O=Array.isArray(_?.content)?_.content:[],V=[];for(let P=0;P<O.length;P+=1){let M=O[P];if(M?.type!=="paragraph"){V.push(M);continue}let C=df(M).trim();if(!hn(C)){V.push(M);continue}let A=[],I=P,R=P;for(;R<O.length;R+=1){let q=O[R];if(q?.type!=="paragraph")break;let W=df(q).trim();if(!W)break;A.push(W)}let D=zr(A);if(!D){V.push(M);continue}let z=Dg(D);if(!z){V.push(M);continue}V.push(z),P=R-1,P<I&&(P=I)}return V};ii=rt;let ct=u.create({name:"outlineMarkdown",addCommands(){return{insertMarkdown:v=>({editor:k})=>{if(!Ae)return!1;if(!(Ae.getState(k.state)||{}).editingSectionId)return po(),!1;if(!k?.storage?.markdown?.parser)return L("Markdown \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F"),!1;let O=k.storage.markdown.parser.parse(String(v||""),{inline:!0}),V=rt(O);return V.length?k.chain().focus().insertContent(V).run():!1}}}}),Ze=u.create({name:"outlineFormattedPaste",addProseMirrorPlugins(){let v=this.editor,k=H=>{let C=String(H||"").trim();if(!C)return"";let E=null;try{E=new DOMParser().parseFromString(C,"text/html")}catch{return C}let A=E?.body;if(!A)return C;try{for(let I of Array.from(A.querySelectorAll("h1,h2,h3,h4,h5,h6"))){let R=E.createElement("p"),D=E.createElement("strong");try{for(;I.firstChild;)D.appendChild(I.firstChild)}catch{D.textContent=String(I.textContent||"")}R.appendChild(D),I.replaceWith(R)}}catch{}return String(A.innerHTML||"").trim()},_=H=>{let C=String(H||"").trim();if(!C||!C.includes("<")||!C.includes(">")||!/<\s*\/?\s*[a-z][^>]*>/i.test(C))return!1;try{let A=new DOMParser().parseFromString(C,"text/html")?.body;if(!A)return!1;let I=new Set(["p","br","strong","b","em","i","u","s","a","ul","ol","li","blockquote","pre","code","table","thead","tbody","tr","td","th","img","span","div","h1","h2","h3","h4","h5","h6"]);return!!Array.from(A.querySelectorAll("*")).find(D=>I.has(String(D.tagName||"").toLowerCase()))}catch{return!1}},O=H=>{let C=String(H||"").replace(/\r\n/g,`
`).trim();return C?[/```[\s\S]*```/m,/^\s{0,3}([-*+]|\d+\.)\s+\S/m,/^\s{0,3}>\s+\S/m,/\[[^\]]+\]\([^)]+\)/,/!\[[^\]]*\]\([^)]+\)/,/\*\*[^*\n]+\*\*/,/__[^_\n]+__/,/`[^`\n]+`/].some(A=>A.test(C)):!1},V=H=>{try{let C=String(H||"").replace(/\r\n/g,`
`).split(`
`).map(E=>String(E||"").trim()).filter(Boolean);return C.length<2?!1:!!zr(C)}catch{return!1}},P=(H,C)=>{if(!C||!Array.isArray(C)||!C.length)return!1;let E=H?.state?.selection?.from,A=H?.state?.selection?.to;if(!Number.isFinite(E)||!Number.isFinite(A))return!1;try{return v.chain().focus().command(({tr:I})=>(I.setMeta(ce,!0),!0)).insertContentAt({from:E,to:A},C).run()}catch{return!1}},M=(H,C)=>{try{if(!(Ae?.getState?.(H.state)||null)?.editingSectionId)return!1;let A=C?.clipboardData?.items||null,I=C?.clipboardData?.files||null;if(I&&I.length||A&&Array.from(A).some(z=>z?.kind==="file"))return!1;let R=String(C?.clipboardData?.getData?.("text/html")||"").trim(),D=String(C?.clipboardData?.getData?.("text/plain")||"").trim();if(R)try{if(!!/<h[1-6][\s>]/i.test(R))return!1}catch{}if(R){let z=k(R),q=rt(z);return q.length?(C.preventDefault(),C.stopPropagation(),P(H,q)):!1}if(D&&_(D)){let z=k(D),q=rt(z);return q.length?(C.preventDefault(),C.stopPropagation(),P(H,q)):!1}if(D&&O(D)){if(V(D))return!1;try{let ee=pc(D);if(ee?.startsWithHeading||(ee?.sections?.length||0)>=2)return!1}catch{}let z=v?.storage?.markdown?.parser||null;if(!z?.parse)return!1;let q=!D.includes(`
`)&&!/^\s{0,3}([-*+]|\d+\.)\s+\S/m.test(D)&&!/```[\s\S]*```/m.test(D)&&!/^\s{0,3}>\s+\S/m.test(D),W=String(z.parse(D,{inline:q})).trim();if(!W)return!1;let K=k(W),j=rt(K);return j.length?(C.preventDefault(),C.stopPropagation(),P(H,j)):!1}return!1}catch{return!1}};return[new w({props:{handlePaste(H,C){return M(H,C)},handleDOMEvents:{paste(H,C){return M(H,C)}}}})]}}),Xe=!1,lt=null,ze=Rr()?performance.now():0,Kt=a.article?.docJson||null;if(Kt&&typeof Kt=="object"&&Kt.type==="doc"&&Array.isArray(Kt.content)&&(lt=Kt),lt||(lt=ey({blocks:a.article?.blocks||[],parseHtmlToNodes:rt}),Xe=!!(a.article&&!a.article?.docJson&&!a.article?.encrypted)),ze&&fo("build initial content",{ms:Math.round(performance.now()-ze)}),oe){try{oe.destroy()}catch{}oe=null}let zt=Y?Y.configure({html:!0,tightLists:!0,transformPastedText:!1,transformCopiedText:!1}):null,Jt=u.create({name:"outlineTableCellStyling",addOptions(){return{types:["tableCell","tableHeader"],textAlignValues:["left","center","right","justify"],verticalAlignValues:["top","middle","bottom"]}},addGlobalAttributes(){let v=(_,O)=>{try{let V=_?.style?.[O];return V?String(V).trim():""}catch{return""}},k=_=>{let O=[],V=_?.nodeTextAlign?String(_.nodeTextAlign):"",P=_?.nodeVerticalAlign?String(_.nodeVerticalAlign):"",M=_?.nodeTextColor?String(_.nodeTextColor):"",H=_?.nodeBackground?String(_.nodeBackground):"";return V&&this.options.textAlignValues.includes(V)&&O.push(`text-align: ${V}`),P&&this.options.verticalAlignValues.includes(P)&&O.push(`vertical-align: ${P}`),M&&O.push(`color: ${M}`),H&&O.push(`background-color: ${H}`),O.length?{style:O.join("; ")}:{}};return[{types:this.options.types,attributes:{nodeTextAlign:{default:null,parseHTML:_=>{let O=v(_,"textAlign");return O&&this.options.textAlignValues.includes(O)?O:null},renderHTML:_=>k(_)},nodeVerticalAlign:{default:null,parseHTML:_=>{let O=v(_,"verticalAlign");return O&&this.options.verticalAlignValues.includes(O)?O:null},renderHTML:_=>k(_)},nodeTextColor:{default:null,parseHTML:_=>{let O=v(_,"color");return O?String(O).replace(/['"]+/g,""):null},renderHTML:_=>k(_)},nodeBackground:{default:null,parseHTML:_=>{let O=v(_,"backgroundColor");return O?String(O).replace(/['"]+/g,""):null},renderHTML:_=>k(_)}}}]},addCommands(){let v=(_,O)=>({state:V,dispatch:P})=>{try{let M=Bc(V);if(!M.length)return!1;let H=V.tr,C=!1;for(let{node:E,pos:A}of M){if(!E||typeof A!="number")continue;let I={...E.attrs||{}};O==null||O===""?delete I[_]:I[_]=O,H=H.setNodeMarkup(A,void 0,I),C=!0}return C?(H=H.setMeta(ce,!0),P(H),!0):!1}catch{return!1}},k=()=>({state:_,dispatch:O})=>{try{let V=Bc(_);if(!V.length)return!1;let P=_.schema.nodes?.paragraph||null;if(!P)return!1;let M=_.tr,H=[...V].sort((E,A)=>Number(A.pos)-Number(E.pos)),C=!1;for(let{node:E,pos:A}of H){if(!E||typeof A!="number")continue;let I=A+1,R=A+E.nodeSize-1;if(!(R>=I))continue;let D=P.createAndFill();D&&(M=M.replaceWith(I,R,D),C=!0)}return C?(M=M.setMeta(ce,!0),O(M.scrollIntoView()),!0):!1}catch{return!1}};return{setNodeTextAlign:_=>v("nodeTextAlign",_),setNodeVAlign:_=>v("nodeVerticalAlign",_),setNodeTextColor:_=>v("nodeTextColor",_),setNodeBackground:_=>v("nodeBackground",_),unsetNodeAlignment:()=>({state:_,dispatch:O})=>{try{let V=Bc(_);if(!V.length)return!1;let P=_.tr,M=!1;for(let{node:H,pos:C}of V){if(!H||typeof C!="number")continue;let E=H.attrs?.nodeTextAlign||null,A=H.attrs?.nodeVerticalAlign||null;if(!E&&!A)continue;let I={...H.attrs||{}};delete I.nodeTextAlign,delete I.nodeVerticalAlign,P=P.setNodeMarkup(C,void 0,I),M=!0}return M?(P=P.setMeta(ce,!0),O(P),!0):!1}catch{return!1}},clearNodeContents:()=>k()}}}),jt=u.create({name:"outlineTablePercentWidths",addProseMirrorPlugins(){return[new w({view(v){let k=null,_=P=>{let M=String(P||"").trim();if(!M)return 0;let H=M.match(/(-?\\d+(?:\\.\\d+)?)px/i);return H&&Number(H[1])||0},O=()=>{k=null;try{let P=v?.dom;if(!P)return;let M=P.querySelectorAll(".tableWrapper > table");for(let H of M){let C=H.querySelector("colgroup");if(!C)continue;let E=Array.from(C.querySelectorAll("col"));if(!E.length||Or)continue;try{H.style.width="100%",H.style.maxWidth="100%",H.style.tableLayout="fixed"}catch{}let A=!1;for(let I of E){let R=I?.dataset?.ttPct||"",D=Number.parseFloat(String(R||""));if(Number.isFinite(D)&&D>0)A=!0,I.style.width=`${D.toFixed(4)}%`,I.style.minWidth="";else{let z=Of(I.style.width);z!=null&&z>0&&(A=!0,I.dataset.ttPct=z.toFixed(4),I.style.width=`${z.toFixed(4)}%`,I.style.minWidth="")}}if(!A)try{let I=H.querySelector("tbody tr");if(!I)continue;let R=Array.from(I.children||[]).filter(K=>K&&K.nodeType===1);if(R.length<E.length)continue;let D=[];for(let K=0;K<E.length;K+=1){let j=R[K].getBoundingClientRect();D.push(Number.isFinite(j.width)?j.width:0)}let z=D.reduce((K,j)=>K+(Number.isFinite(j)?j:0),0);if(!(z>0))continue;let q=D.map(K=>zn(K/z*100)),W=q.reduce((K,j)=>K+j,0);Math.abs(W-100)>.01&&(q[q.length-1]=zn(q[q.length-1]+(100-W)));for(let K=0;K<E.length;K+=1)Es(E[K],q[K])}catch{}}}catch{}},V=()=>{k==null&&(k=window.requestAnimationFrame(O))};return V(),{update(){V()},destroy(){k!=null&&(window.cancelAnimationFrame(k),k=null)}}}})]}}),Nn=u.create({name:"outlineTableSmartMouseSelection",addProseMirrorPlugins(){let v=kt?.CellSelection||null;return v?[new w({view(k){let _=V=>{try{for(let P=V.depth;P>=0;P-=1){let M=V.node(P)?.type?.name;if(M==="tableCell"||M==="tableHeader")return V.before(P)}}catch{}return null},O=()=>{try{if(!(Ae?.getState?.(k.state)||null)?.editingSectionId)return;let P=k.state.selection;if(!P||P.empty)return;let M=_(P.$anchor),H=_(P.$head);if(M==null||H==null||M===H)return;let C=typeof v.create=="function"?v.create(k.state.doc,M,H):null;if(!C)return;let E=k.state.tr.setSelection(C);E=E.setMeta(ce,!0),k.dispatch(E)}catch{}};return k.dom.addEventListener("mouseup",O,!0),{destroy(){k.dom.removeEventListener("mouseup",O,!0)}}}})]:[]}}),Ut=u.create({name:"outlineTableResizeCapture",addProseMirrorPlugins(){return[new w({view(v){let k=O=>{try{if(!O?.target?.closest?.(".column-resize-handle")||!(Ae?.getState?.(v.state)||null)?.editingSectionId)return;Or=!0}catch{}},_=()=>{if(Or){Or=!1;try{let O=v.domAtPos(v.state.selection.from),P=((O?.node&&O.node.nodeType===1?O.node:O?.node?.parentElement)||null)?.closest?.("table")||null;P&&xs(P)}catch{}}};return v.dom.addEventListener("pointerdown",k,!0),document.addEventListener("pointerup",_,!0),document.addEventListener("pointercancel",_,!0),{destroy(){v.dom.removeEventListener("pointerdown",k,!0),document.removeEventListener("pointerup",_,!0),document.removeEventListener("pointercancel",_,!0)}}}})]}}),Jr=u.create({name:"outlineTableNodeUi",addProseMirrorPlugins(){let v=this.editor,k=[{label:"Default text",value:null},{label:"Gray text",value:"var(--tt-color-text-gray)"},{label:"Brown text",value:"var(--tt-color-text-brown)"},{label:"Orange text",value:"var(--tt-color-text-orange)"},{label:"Yellow text",value:"var(--tt-color-text-yellow)"},{label:"Green text",value:"var(--tt-color-text-green)"},{label:"Blue text",value:"var(--tt-color-text-blue)"},{label:"Purple text",value:"var(--tt-color-text-purple)"},{label:"Pink text",value:"var(--tt-color-text-pink)"},{label:"Red text",value:"var(--tt-color-text-red)"}],_=[{label:"Default background",value:null},{label:"Gray background",value:"var(--tt-color-highlight-gray)"},{label:"Brown background",value:"var(--tt-color-highlight-brown)"},{label:"Orange background",value:"var(--tt-color-highlight-orange)"},{label:"Yellow background",value:"var(--tt-color-highlight-yellow)"},{label:"Green background",value:"var(--tt-color-highlight-green)"},{label:"Blue background",value:"var(--tt-color-highlight-blue)"},{label:"Purple background",value:"var(--tt-color-highlight-purple)"},{label:"Pink background",value:"var(--tt-color-highlight-pink)"},{label:"Red background",value:"var(--tt-color-highlight-red)"}],O=[{label:"Align left",value:"left"},{label:"Align center",value:"center"},{label:"Align right",value:"right"},{label:"Justify",value:"justify"}],V=[{label:"Align top",value:"top"},{label:"Align middle",value:"middle"},{label:"Align bottom",value:"bottom"}],P=E=>{try{if(!E)return null;let A={left:Number(E.left),top:Number(E.top),right:Number(E.right),bottom:Number(E.bottom),width:Number(E.width),height:Number(E.height)};return!Number.isFinite(A.left)||!Number.isFinite(A.top)?null:A}catch{return null}},M=(E,A,I,R,D=8)=>{try{let z=window.innerWidth||0,q=window.innerHeight||0,W=Math.max(D,Math.min(E,Math.max(D,z-I-D))),K=Math.max(D,Math.min(A,Math.max(D,q-R-D)));return{left:W,top:K}}catch{return{left:E,top:A}}};class H{constructor(){this.panels=[],this.onDocPointerDown=A=>{try{let I=A?.target||null,R=typeof A?.composedPath=="function"?A.composedPath():null,D=Array.isArray(R)&&R.length?R:I?[I]:[];if(!D.length)return;for(let z of D)for(let q of this.panels)if(q&&(z===q||q.contains(z)))return;this.closeAll()}catch{this.closeAll()}},this.onKeyDown=A=>{A?.key==="Escape"&&this.closeAll()}}isOpen(){return this.panels.length>0}closeAll(){try{for(let A of this.panels)A?.remove?.()}catch{}this.panels=[];try{document.removeEventListener("pointerdown",this.onDocPointerDown,!1),window.removeEventListener("keydown",this.onKeyDown,!1)}catch{}}openPanel({anchorRect:A,items:I,level:R=0}){let D=P(A);if(!D)return;for(;this.panels.length>R;){let ee=this.panels.pop();try{ee?.remove?.()}catch{}}let z=document.createElement("div");z.className="tt-table-menu",z.setAttribute("role","menu"),z.setAttribute("data-level",String(R)),z.addEventListener("pointerdown",ee=>{ee.stopPropagation()}),z.addEventListener("mousedown",ee=>{ee.stopPropagation()});for(let ee of I){if(ee.type==="separator"){let we=document.createElement("div");we.className="tt-table-menu-sep",z.appendChild(we);continue}let se=document.createElement("button");if(se.type="button",se.className="tt-table-menu-item",se.textContent=ee.label,se.disabled=!!ee.disabled,ee.swatch){se.classList.add("has-swatch");try{let we=ee.swatchValue==null?"transparent":String(ee.swatchValue);se.style.setProperty("--tt-swatch",we)}catch{}}ee.submenu&&se.classList.add("has-submenu"),se.addEventListener("click",we=>{if(we.preventDefault(),we.stopPropagation(),!ee.disabled){if(ee.submenu){let fe=se.getBoundingClientRect();this.openPanel({anchorRect:fe,items:ee.submenu(),level:R+1});return}try{ee.onClick?.()}finally{this.closeAll()}}}),z.appendChild(se)}document.body.appendChild(z);let q=z.getBoundingClientRect(),W=D.right+8,K=D.top,j=M(W,K,q.width,q.height);z.style.left=`${j.left}px`,z.style.top=`${j.top}px`,this.panels.push(z);try{this.panels.length===1&&(document.addEventListener("pointerdown",this.onDocPointerDown,!1),window.addEventListener("keydown",this.onKeyDown,!1))}catch{}}}class C{constructor(A){this.view=A,this.menu=new H,this.wrapper=null,this.table=null,this.observedTable=null,this.resizeObserver=null,this.layoutRaf=null,this.resizeRaf=null,this.destroyed=!1,this.root=document.createElement("div"),this.root.className="tt-table-ui",this.root.style.display="none",this.cellOutline=document.createElement("div"),this.cellOutline.className="tt-table-active-cell-outline",this.cellOutline.style.display="none",this.root.appendChild(this.cellOutline),this.scheduleLayout=()=>{this.layoutRaf==null&&(this.layoutRaf=window.requestAnimationFrame(()=>{this.layoutRaf=null,!this.destroyed&&this.update(this.view)}))},this.scheduleResizeLoop=()=>{this.resizeRaf==null&&(this.resizeRaf=window.requestAnimationFrame(()=>{this.resizeRaf=null,!this.destroyed&&Or&&this.update(this.view)}))},this.onWrapperScroll=()=>this.scheduleLayout(),this.onWindowResize=()=>this.scheduleLayout();try{window.addEventListener("resize",this.onWindowResize,{passive:!0})}catch{}this.rowHandles=[],this.colHandles=[],this.dragState=null,this.suppressClickUntil=0,this.colDropIndicator=document.createElement("div"),this.colDropIndicator.className="tt-table-drop-indicator tt-table-drop-indicator-col",this.colDropIndicator.style.display="none",this.root.appendChild(this.colDropIndicator),this.rowDropIndicator=document.createElement("div"),this.rowDropIndicator.className="tt-table-drop-indicator tt-table-drop-indicator-row",this.rowDropIndicator.style.display="none",this.root.appendChild(this.rowDropIndicator),this.cellHandle=document.createElement("button"),this.cellHandle.type="button",this.cellHandle.className="tt-table-handle tt-table-cell-handle",this.cellHandle.setAttribute("aria-label","Cell actions"),this.cellHandle.addEventListener("click",I=>{I.preventDefault(),I.stopPropagation();let R=this.cellHandle.getBoundingClientRect();this.openCellMenu(R)}),this.root.appendChild(this.cellHandle)}hideDropIndicators(){try{this.colDropIndicator&&(this.colDropIndicator.style.display="none")}catch{}try{this.rowDropIndicator&&(this.rowDropIndicator.style.display="none")}catch{}}cancelDrag(){let A=this.dragState;if(A){this.dragState=null,this.hideDropIndicators();try{window.removeEventListener("pointermove",A.onMove),window.removeEventListener("pointerup",A.onUp),window.removeEventListener("pointercancel",A.onUp)}catch{}try{document.body.classList.remove("tt-table-dragging")}catch{}}}destroy(){this.destroyed=!0,this.cancelDrag();try{this.cellOutline.style.display="none"}catch{}this.menu.closeAll();try{this.layoutRaf!=null&&window.cancelAnimationFrame(this.layoutRaf)}catch{}this.layoutRaf=null;try{this.resizeRaf!=null&&window.cancelAnimationFrame(this.resizeRaf)}catch{}this.resizeRaf=null;try{window.removeEventListener("resize",this.onWindowResize)}catch{}try{this.wrapper?.removeEventListener?.("scroll",this.onWrapperScroll)}catch{}try{this.resizeObserver?.disconnect?.()}catch{}this.resizeObserver=null,this.observedTable=null;try{this.root.remove()}catch{}this.wrapper=null,this.table=null}ensureAttached(A){if(A&&this.wrapper!==A){try{this.wrapper?.removeEventListener?.("scroll",this.onWrapperScroll)}catch{}try{this.root.remove()}catch{}this.wrapper=A;try{this.wrapper.addEventListener("scroll",this.onWrapperScroll,{passive:!0})}catch{}this.wrapper.appendChild(this.root)}}buildRowHandles(A){for(;this.rowHandles.length>A;){let I=this.rowHandles.pop();try{I?.remove?.()}catch{}}for(;this.rowHandles.length<A;){let I=document.createElement("button");I.type="button",I.className="tt-table-handle tt-table-row-handle",I.setAttribute("aria-label","Row actions"),I.dataset.idx=String(this.rowHandles.length),I.addEventListener("pointerdown",R=>this.onHandlePointerDown(R,I,"row")),I.addEventListener("click",R=>{if(Date.now()<this.suppressClickUntil){R.preventDefault(),R.stopPropagation();return}R.preventDefault(),R.stopPropagation();let D=Ft(this.view?.state)?.tablePos,z=I.getBoundingClientRect();v?.chain?.().focus?.().run?.();let q=Number(I.dataset.idx||0);Rg(v,q),this.openRowMenu(z,q,D)}),this.rowHandles.push(I),this.root.appendChild(I)}}buildColHandles(A){for(;this.colHandles.length>A;){let I=this.colHandles.pop();try{I?.remove?.()}catch{}}for(;this.colHandles.length<A;){let I=document.createElement("button");I.type="button",I.className="tt-table-handle tt-table-col-handle",I.setAttribute("aria-label","Column actions"),I.dataset.idx=String(this.colHandles.length),I.addEventListener("pointerdown",R=>this.onHandlePointerDown(R,I,"col")),I.addEventListener("click",R=>{if(Date.now()<this.suppressClickUntil){R.preventDefault(),R.stopPropagation();return}R.preventDefault(),R.stopPropagation();let D=Ft(this.view?.state)?.tablePos,z=I.getBoundingClientRect();v?.chain?.().focus?.().run?.();let q=Number(I.dataset.idx||0);$g(v,q),this.openColumnMenu(z,q,D)}),this.colHandles.push(I),this.root.appendChild(I)}}onHandlePointerDown(A,I,R){try{if(!A||A.button!==0)return;A.preventDefault(),A.stopPropagation(),v?.chain?.().focus?.().run?.();let D=Number(I?.dataset?.idx||0);try{typeof I.setPointerCapture=="function"&&I.setPointerCapture(A.pointerId)}catch{}let z={kind:R,btn:I,pointerId:A.pointerId,fromIndex:D,startX:A.clientX,startY:A.clientY,moved:!1};this.dragState=z;let q=K=>this.onHandlePointerMove(K),W=K=>this.onHandlePointerUp(K);z.onMove=q,z.onUp=W,window.addEventListener("pointermove",q,{passive:!1}),window.addEventListener("pointerup",W,{passive:!1}),window.addEventListener("pointercancel",W,{passive:!1})}catch{}}onHandlePointerMove(A){let I=this.dragState;if(!I||!A||A.pointerId!==I.pointerId)return;try{A.preventDefault()}catch{}let R=A.clientX-I.startX,D=A.clientY-I.startY;if(!I.moved&&Math.hypot(R,D)>=4){I.moved=!0;try{document.body.classList.add("tt-table-dragging")}catch{}}if(I.moved){let z=this.getDropIndexFromPointer(I.kind,A.clientX,A.clientY);I.dropIndex=z,z==null?this.hideDropIndicators():this.updateDropIndicator(I.kind,z,A.clientX,A.clientY)}}getDropIndexFromPointer(A,I,R){try{let D=this.table;if(!D)return null;let z=Array.from(D.querySelectorAll("tbody tr"));if(!z.length)return null;if(A==="col"){let W=Array.from(z[0].children||[]).filter(j=>j&&j.nodeType===1);if(!W.length)return null;let K=W.map(j=>{let ee=j.getBoundingClientRect();return ee.left+ee.width/2});if(!K.length)return null;if(I<K[0])return 0;for(let j=0;j<K.length-1;j+=1)if(I>=K[j]&&I<K[j+1])return j+1;return K.length-1}let q=z.map(W=>{let K=W.children&&W.children[0];if(!K)return null;let j=K.getBoundingClientRect();return j.top+j.height/2}).filter(W=>typeof W=="number");if(!q.length)return null;if(R<q[0])return 0;for(let W=0;W<q.length-1;W+=1)if(R>=q[W]&&R<q[W+1])return W+1;return q.length-1}catch{return null}}updateDropIndicator(A,I,R,D){try{let z=this.table,q=this.wrapper;if(!z||!q)return;let W=q.getBoundingClientRect(),K=z.getBoundingClientRect(),j=K.top-W.top,ee=K.left-W.left,se=K.width,we=K.height,fe=Array.from(z.querySelectorAll("tbody tr"));if(!fe.length)return;if(A==="col"){let Q=Array.from(fe[0].children||[]).filter(Be=>Be&&Be.nodeType===1);if(!Q.length)return;let ae=Math.max(0,Math.min(Q.length-1,Number(I))),Se=Q[ae].getBoundingClientRect(),be=Q[Q.length-1].getBoundingClientRect(),ke=be.left+be.width/2,ve=ae===Q.length-1&&R>ke?be.right-W.left:Se.left-W.left;this.colDropIndicator.style.display="",this.rowDropIndicator.style.display="none",this.colDropIndicator.style.left=`${Math.round(ve)}px`,this.colDropIndicator.style.top=`${Math.round(j)}px`,this.colDropIndicator.style.height=`${Math.max(0,Math.round(we))}px`;return}let Pe=Math.max(0,Math.min(fe.length-1,Number(I))),Oe=fe[Pe]?.children?.[0];if(!Oe)return;let Ye=Oe.getBoundingClientRect(),F=(fe[fe.length-1]?.children?.[0]||null)?.getBoundingClientRect?.()||null,ne=F?F.top+F.height/2:null,X=Pe===fe.length-1&&F&&typeof ne=="number"&&D>ne?F.bottom-W.top:Ye.top-W.top;this.rowDropIndicator.style.display="",this.colDropIndicator.style.display="none",this.rowDropIndicator.style.left=`${Math.round(ee)}px`,this.rowDropIndicator.style.top=`${Math.round(X)}px`,this.rowDropIndicator.style.width=`${Math.max(0,Math.round(se))}px`}catch{}}onHandlePointerUp(A){let I=this.dragState;if(!I||!A||A.pointerId!==I.pointerId)return;try{A.preventDefault(),A.stopPropagation()}catch{}this.dragState=null;try{window.removeEventListener("pointermove",I.onMove),window.removeEventListener("pointerup",I.onUp),window.removeEventListener("pointercancel",I.onUp)}catch{}try{document.body.classList.remove("tt-table-dragging")}catch{}if(this.hideDropIndicators(),!I.moved)return;this.suppressClickUntil=Date.now()+250;let R=I.dropIndex??this.getDropIndexFromPointer(I.kind,A.clientX,A.clientY);if(R!=null){try{v?.chain?.().focus?.().run?.()}catch{}I.kind==="col"?Ff(v,I.fromIndex,R):zf(v,I.fromIndex,R),this.scheduleLayout()}}isEnabled(){try{return!!(Ae?.getState?.(this.view.state)||null)?.editingSectionId&&!a.isPublicView}catch{return!1}}update(A){if(this.view=A,!Or&&this.resizeRaf!=null){try{window.cancelAnimationFrame(this.resizeRaf)}catch{}this.resizeRaf=null}if(!this.isEnabled()){this.root.style.display="none",this.menu.closeAll();try{this.cellOutline.style.display="none"}catch{}return}let I=Ft(A.state),R=Og(A),D=R?.closest?.("table")||Qt(A),z=D?.closest?.(".tableWrapper")||null;if(!I||!D||!z||!R){this.root.style.display="none",this.menu.isOpen()||this.menu.closeAll();try{this.cellOutline.style.display="none"}catch{}return}this.ensureAttached(z),this.table=D;try{typeof ResizeObserver=="function"&&(this.resizeObserver||(this.resizeObserver=new ResizeObserver(()=>this.scheduleLayout())),this.observedTable!==D&&(this.resizeObserver.disconnect(),this.resizeObserver.observe(D),this.observedTable=D))}catch{}this.root.style.display="";let q=Array.from(D.querySelectorAll("tbody tr")),W=Number(I.map?.height||q.length||0),K=Number(I.map?.width||0);this.buildRowHandles(Math.max(0,W)),this.buildColHandles(Math.max(0,K));let j=z.getBoundingClientRect(),ee=D.getBoundingClientRect(),se=ee.top-j.top,we=ee.left-j.left,fe=14,Pe=4,Oe=fe/2,Ye=Math.max(0,Math.min(Math.max(0,W-1),Number(I.rowIndex||0))),bt=Math.max(0,Math.min(Math.max(0,K-1),Number(I.colIndex||0))),F=Math.max(Oe,se-(fe/2+Pe)),ne=Math.max(Oe,we-(fe/2+Pe)),X=R.getBoundingClientRect(),Q=X.left-j.left+X.width/2,ae=X.top-j.top+X.height/2,Se=X.left-j.left,be=X.top-j.top,ke="cell";try{let ve=A.state.selection,Be=ve?.$anchorCell?.pos,Ie=ve?.$headCell?.pos;if(typeof Be=="number"&&typeof Ie=="number"&&Be!==Ie){let _e=Be-(I.tablePos+1),Me=Ie-(I.tablePos+1),Te=I.map?.rectBetween?.(_e,Me)||null;if(Te){let xe=Number(Te.right)-Number(Te.left),Le=Number(Te.bottom)-Number(Te.top);xe===1&&Le>1?ke="col":Le===1&&xe>1?ke="row":ke="range"}else ke="range"}}catch{ke="cell"}try{ke==="cell"?(this.cellOutline.style.display="",this.cellOutline.style.left=`${Math.round(Se)}px`,this.cellOutline.style.top=`${Math.round(be)}px`,this.cellOutline.style.width=`${Math.max(0,Math.round(X.width))}px`,this.cellOutline.style.height=`${Math.max(0,Math.round(X.height))}px`):this.cellOutline.style.display="none"}catch{try{this.cellOutline.style.display="none"}catch{}}for(let ve=0;ve<this.colHandles.length;ve+=1){let Be=this.colHandles[ve];if(Be){if(Be.dataset.idx=String(ve),ve!==bt){Be.style.display="none";continue}Be.style.display="",Be.style.width=`${Math.max(18,Math.round(X.width))}px`,Be.style.height=`${fe}px`,Be.style.left=`${Math.round(Q)}px`,Be.style.top=`${Math.round(F)}px`}}for(let ve=0;ve<this.rowHandles.length;ve+=1){let Be=this.rowHandles[ve];if(Be){if(Be.dataset.idx=String(ve),ve!==Ye){Be.style.display="none";continue}Be.style.display="",Be.style.width=`${fe}px`,Be.style.height=`${Math.max(18,Math.round(X.height))}px`,Be.style.left=`${Math.round(ne)}px`,Be.style.top=`${Math.round(ae)}px`}}try{if(ke!=="cell")this.cellHandle.style.display="none";else{let ve=X.right-j.left;this.cellHandle.style.display="",this.cellHandle.style.left=`${Math.round(ve)}px`,this.cellHandle.style.top=`${Math.round(ae)}px`}}catch{this.cellHandle.style.display="none"}Or&&this.scheduleResizeLoop()}openCellMenu(A){let I=()=>{try{v?.chain?.().focus?.().run?.()}catch{}},R=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>k.map(D=>({label:D.label,swatch:!0,swatchValue:D.value,onClick:()=>{I(),v.commands.setNodeTextColor(D.value)}}))},{label:"Background color",submenu:()=>_.map(D=>({label:D.label,swatch:!0,swatchValue:D.value,onClick:()=>{I(),v.commands.setNodeBackground(D.value)}}))}]},{label:"Alignment",submenu:()=>[...O.map(D=>({label:D.label,onClick:()=>{I(),v.commands.setNodeTextAlign(D.value)}})),{type:"separator"},...V.map(D=>({label:D.label,onClick:()=>{I(),v.commands.setNodeVAlign(D.value)}}))]},{type:"separator"},{label:"Clear contents",onClick:()=>{I(),v.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:A,items:R,level:0})}openRowMenu(A,I,R){let D=()=>{try{v?.chain?.().focus?.().run?.()}catch{}Number.isFinite(Number(R))&&Hg(v,R,I)},z=(j,ee)=>{try{v?.chain?.().focus?.().run?.()}catch{}return v.commands.command(({state:se,dispatch:we})=>{let fe=Number.isFinite(Number(R))?Number(R):Ft(se)?.tablePos,Pe=Number.isFinite(Number(I))?Number(I):Ft(se)?.rowIndex;return!Number.isFinite(Number(fe))||!Number.isFinite(Number(Pe))?!1:zg({pmState:se,dispatch:we},{tablePos:fe,rowIndex:Pe,attr:j,value:ee})})},q=j=>()=>(D(),j?.()),W=j=>{try{return typeof j!="function"?!1:(D(),v.commands.command(({state:ee,dispatch:se})=>j(ee,typeof se=="function"?fe=>{try{fe=fe.setMeta(ce,!0)}catch{}se(fe)}:void 0)))}catch{return!1}},K=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>k.map(j=>({label:j.label,swatch:!0,swatchValue:j.value,onClick:()=>z("nodeTextColor",j.value)}))},{label:"Background color",submenu:()=>_.map(j=>({label:j.label,swatch:!0,swatchValue:j.value,onClick:()=>z("nodeBackground",j.value)}))}]},{label:"Alignment",submenu:()=>[...O.map(j=>({label:j.label,onClick:()=>z("nodeTextAlign",j.value)})),{type:"separator"},...V.map(j=>({label:j.label,onClick:()=>z("nodeVerticalAlign",j.value)}))]},{type:"separator"},{label:"Insert row above",onClick:()=>W(kt?.addRowBefore)},{label:"Insert row below",onClick:()=>W(kt?.addRowAfter)},{label:"Sort ",submenu:()=>[{label:"Sort column A-Z",onClick:q(()=>mf(v,{direction:"asc"}))},{label:"Sort column Z-A",onClick:q(()=>mf(v,{direction:"desc"}))}]},{label:"Header row",onClick:()=>W(kt?.toggleHeaderRow)},{label:"Move ",submenu:()=>[{label:"Move row up",onClick:q(()=>ff(v,-1))},{label:"Move row down",onClick:q(()=>ff(v,1))},{label:"Move row left",disabled:!0,onClick:()=>{}},{label:"Move row right",disabled:!0,onClick:()=>{}}]},{label:"Duplicate row",onClick:q(()=>qg(v))},{label:"Delete row",onClick:()=>W(kt?.deleteRow)},{type:"separator"},{label:"Clear row contents",onClick:()=>{D(),v.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:A,items:K,level:0})}openColumnMenu(A,I,R){let D=()=>{try{v?.chain?.().focus?.().run?.()}catch{}Number.isFinite(Number(R))&&Fg(v,R,I)},z=(j,ee)=>{try{v?.chain?.().focus?.().run?.()}catch{}return v.commands.command(({state:se,dispatch:we})=>{let fe=Number.isFinite(Number(R))?Number(R):Ft(se)?.tablePos,Pe=Number.isFinite(Number(I))?Number(I):Ft(se)?.colIndex;return!Number.isFinite(Number(fe))||!Number.isFinite(Number(Pe))?!1:Ug({pmState:se,dispatch:we},{tablePos:fe,colIndex:Pe,attr:j,value:ee})})},q=j=>()=>(D(),j?.()),W=j=>{try{return typeof j!="function"?!1:(D(),v.commands.command(({state:ee,dispatch:se})=>j(ee,typeof se=="function"?fe=>{try{fe=fe.setMeta(ce,!0)}catch{}se(fe)}:void 0)))}catch{return!1}},K=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>k.map(j=>({label:j.label,swatch:!0,swatchValue:j.value,onClick:()=>z("nodeTextColor",j.value)}))},{label:"Background color",submenu:()=>_.map(j=>({label:j.label,swatch:!0,swatchValue:j.value,onClick:()=>z("nodeBackground",j.value)}))}]},{label:"Alignment",submenu:()=>[...O.map(j=>({label:j.label,onClick:()=>z("nodeTextAlign",j.value)})),{type:"separator"},...V.map(j=>({label:j.label,onClick:()=>z("nodeVerticalAlign",j.value)}))]},{type:"separator"},{label:"Insert column left",onClick:()=>{D();let j=Math.max(0,Number(I||0));W(kt?.addColumnBefore)&&window.requestAnimationFrame(()=>{try{As(v,{insertIndex:j,newColPct:10})}catch{let se=Qt(v.view);xs(se)}})}},{label:"Insert column right",onClick:()=>{D();let j=Math.max(0,Number(I||0)+1);W(kt?.addColumnAfter)&&window.requestAnimationFrame(()=>{try{As(v,{insertIndex:j,newColPct:10})}catch{let se=Qt(v.view);xs(se)}})}},{label:"Sort ",submenu:()=>[{label:"Sort row A-Z",onClick:q(()=>pf(v,{direction:"asc"}))},{label:"Sort row Z-A",onClick:q(()=>pf(v,{direction:"desc"}))}]},{label:"Header column",onClick:()=>W(kt?.toggleHeaderColumn)},{label:"Move ",submenu:()=>[{label:"Move column up",disabled:!0,onClick:()=>{}},{label:"Move column down",disabled:!0,onClick:()=>{}},{label:"Move column left",onClick:q(()=>uf(v,-1))},{label:"Move column right",onClick:q(()=>uf(v,1))}]},{label:"Duplicate column",onClick:q(()=>Kg(v))},{label:"Delete column",onClick:()=>{D();let j=Qt(v.view),ee=mo(j),se=Number.isFinite(Number(I))?Number(I):null,we=ee&&se!=null?Hf(ee,se):null;W(kt?.deleteColumn)&&Array.isArray(we)&&window.requestAnimationFrame(()=>{let Pe=Qt(v.view);ho(Pe,we)})}},{type:"separator"},{label:"Clear column contents",onClick:()=>{D(),v.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:A,items:K,level:0})}}return[new w({view(E){let A=new C(E);return A.update(E),{update(I){A.update(I)},destroy(){A.destroy()}}}})]}}),Un=Rr()?performance.now():0;oe=new d({element:e,extensions:[de,ge,ye,le,pe,he,Re,Qe,Ve,ie,Z,$e,dt,Zt,ut,Ze,U.configure({types:["outlineSection"],attributeName:"id",generateID:()=>Xt()}),y.configure({document:!1,heading:!1,link:!1}),N.configure({openOnClick:!1,protocols:us}),zt,G,je,Jt,$.configure({table:{resizable:!0}}),Jr,Nn,Ut,jt,ct].filter(Boolean),content:lt,editorProps:{attributes:{class:"outline-prosemirror"},handleKeyDown(v,k){try{if(k?.altKey&&!k.ctrlKey&&!k.metaKey){let _=String(k.key||"");if((_==="ArrowUp"||_==="ArrowDown")&&k.repeat){let O=v?.state?.selection?.$from;if(O){let V=!1;for(let P=O.depth;P>0;P-=1){let M=O.node(P)?.type?.name;if(M&&String(M).startsWith("table")){V=!0;break}}if(!V){let P=null;for(let M=O.depth;M>0;M-=1)if(O.node(M)?.type?.name==="outlineSection"){P=O.before(M);break}if(typeof P=="number"){let M=v.state.doc.resolve(P),H=M.parent;if(H){let C=M.index();if(_==="ArrowUp"&&C<=0||_==="ArrowDown"&&C>=H.childCount-1)return!0}}}}}}}catch{}We("editorProps.keydown",{key:k?.key||null,repeat:!!k?.repeat,selection:{empty:!!v.state?.selection?.empty,parent:v.state?.selection?.$from?.parent?.type?.name||null,parentOffset:v.state?.selection?.$from?.parentOffset??null,pos:v.state?.selection?.$from?.pos??null}});try{let _=He?.pmStateMod?.TextSelection;if(_){let V=(Ae?.getState?.(v.state)||null)?.editingSectionId||null,P=(k.key==="Enter"||k.code==="Enter"||k.code==="NumpadEnter")&&(k.ctrlKey||k.metaKey)&&!k.shiftKey&&!k.altKey;if(!a.isPublicView&&!V&&P){let M=v.state.selection,H=M?.$from||null;if(H){let C=Bt(v.state.doc,H),E=typeof C=="number"?v.state.doc.nodeAt(C):null;if(typeof C=="number"&&E?.type?.name==="outlineSection"){let A=!!(M&&M.empty),I=H.parent?.type?.name==="outlineHeading",D=A&&I&&H.parentOffset===0?C:C+E.nodeSize,z=v.state.schema,q=Xt(),W=z.nodes.outlineSection.create({id:q,collapsed:!1},[z.nodes.outlineHeading.create({},[]),z.nodes.outlineBody.create({},[z.nodes.paragraph.create({},[])]),z.nodes.outlineChildren.create({},[])]),K=v.state.tr.insert(D,W);try{let ee=K.doc.nodeAt(D)?.child?.(0)||W.child(0),se=D+1+ee.nodeSize;K=K.setSelection(_.near(K.doc.resolve(se+2),1))}catch{K=K.setSelection(_.create(K.doc,D+2))}K=K.setMeta(ce,!0),Ae&&(K=K.setMeta(Ae,{type:"enter",sectionId:q})),v.dispatch(K.scrollIntoView());try{v.focus()}catch{}return k.preventDefault(),k.stopPropagation(),!0}}}}}catch{}try{let _=k.altKey&&!k.ctrlKey&&!k.metaKey&&!k.shiftKey,O=String(k.key||"");if(_&&(O==="ArrowLeft"||O==="ArrowRight"||O==="ArrowUp"||O==="ArrowDown")&&(Ae?.getState?.(v.state)||null)?.editingSectionId&&oe){let P=()=>{try{let M=v?.state?.selection?.$from||null;if(!M)return!1;for(let H=M.depth;H>0;H-=1){let C=M.node(H)?.type?.name;if(C==="table"||C==="tableRow"||C==="tableCell"||C==="tableHeader")return!0}return!1}catch{return!1}};if(O==="ArrowLeft"||O==="ArrowRight"){let M=oe.chain().focus();M.command(({tr:C})=>(C.setMeta(ce,!0),!0));let H=!1;if(oe.isActive("bulletList")||oe.isActive("orderedList")?O==="ArrowRight"?H=M.sinkListItem("listItem").run():(H=M.liftListItem("listItem").run(),!H&&oe.isActive("bulletList")&&(H=M.toggleBulletList().run()),!H&&oe.isActive("orderedList")&&(H=M.toggleOrderedList().run())):O==="ArrowRight"&&(H=M.toggleBulletList().run()),H)return k.preventDefault(),k.stopPropagation(),!0}else if((O==="ArrowUp"||O==="ArrowDown")&&(O==="ArrowUp"?gf(oe,-1)||hf(oe,-1):gf(oe,1)||hf(oe,1)))return k.preventDefault(),k.stopPropagation(),!0}}catch{}try{if((k.ctrlKey||k.metaKey)&&!k.altKey&&!k.shiftKey&&(k.code==="KeyA"||String(k.key||"").toLowerCase()==="a")){let O=He?.pmStateMod?.TextSelection;if(!O)return We("editorProps.modA",{handled:!1,reason:"no-TextSelection"}),!1;let V=v.state,P=V.selection,M=P?.$from||null;if(!M)return We("editorProps.modA",{handled:!1,reason:"no-$from"}),!1;let H=Bt(V.doc,M);if(typeof H!="number")return We("editorProps.modA",{handled:!1,reason:"no-sectionPos"}),!1;let C=V.doc.nodeAt(H);if(!C||C.type?.name!=="outlineSection")return We("editorProps.modA",{handled:!1,reason:"not-outlineSection"}),!1;let E=C.child(0),A=C.child(1);if(!E||!A)return We("editorProps.modA",{handled:!1,reason:"missing-heading/body"}),!1;let I=H+1,R=I+1,D=I+E.nodeSize-1,z=H+1+E.nodeSize,q=z+1,W=z+A.nodeSize-1,K=W;try{let fe=null;V.doc.nodesBetween(q,Math.min(V.doc.content.size,W),(Pe,Oe)=>{Pe?.isTextblock&&(fe=Oe+Pe.nodeSize-1)}),typeof fe=="number"&&(K=fe)}catch{}K<q&&(K=D);let j=R,ee=(()=>{try{for(let fe=M.depth;fe>0;fe-=1)if(M.node(fe)?.type?.name==="outlineHeading")return!0}catch{}return!1})(),se=!!P&&typeof P.from=="number"&&typeof P.to=="number"&&Math.min(P.from,P.to)===j&&Math.max(P.from,P.to)===K;if(ee&&se)return We("editorProps.modA",{handled:!1,reason:"pass-through-doc-select"}),!1;k.preventDefault(),k.stopPropagation();let we=O.create(V.doc,j,K);return v.dispatch(V.tr.setSelection(we)),We("editorProps.modA",{handled:!0,blockFrom:j,blockTo:K,isInHeading:ee,alreadySelectedBlock:se}),!0}}catch{}try{if(!Ae)return!1;let O=(Ae.getState(v.state)||{}).editingSectionId||null;if(!O){let V=(k.ctrlKey||k.metaKey)&&!k.altKey&&!k.shiftKey&&(k.key==="Delete"||k.key==="Del"||k.key==="Backspace"),P=k.key==="Backspace"||k.key==="Delete",M=k.key&&k.key.length===1&&!k.metaKey&&!k.ctrlKey&&!k.altKey,H=!k.metaKey&&!k.ctrlKey&&!k.altKey&&!k.shiftKey&&(k.key===" "||k.key==="Spacebar");if(V){let C=Bt(v.state.doc,v.state.selection.$from),E=!1;try{typeof C=="number"&&(E=Ee(v.state,v.dispatch,C))}catch{E=!1}return We("editorProps.modDelete",{ok:E,sectionPos:C}),k.preventDefault(),k.stopPropagation(),!0}if(H){let C=document.activeElement;if(!(!!(C&&C.closest&&C.closest(".outline-editor"))||!!(k?.target&&k.target.closest&&k.target.closest(".outline-editor"))))return!1;if(k.repeat)return k.preventDefault(),k.stopPropagation(),!0;let A=k?.target||null,I=String(A?.tagName||"").toLowerCase();if(I==="button"||I==="input"||I==="textarea"||I==="select"||A?.closest?.("button, a[href], input, textarea, select")||!!!A?.closest?.(".outline-prosemirror")&&A?.closest?.('[contenteditable="true"]'))return!1;let D=Bt(v.state.doc,v.state.selection.$from);if(typeof D!="number")return k.preventDefault(),k.stopPropagation(),!0;let z=v.state.doc.nodeAt(D);if(!z)return k.preventDefault(),k.stopPropagation(),!0;let q=!z.attrs?.collapsed,W=v.state.tr.setNodeMarkup(D,void 0,{...z.attrs,collapsed:q});W=W.setMeta(ce,!0);try{let K=z.child(0),ee=D+1+K.nodeSize-1,{TextSelection:se}=He?.pmStateMod||{};se&&(W=W.setSelection(se.near(W.doc.resolve(ee),-1)))}catch{}return k.preventDefault(),k.stopPropagation(),v.dispatch(W.scrollIntoView()),!0}if(P){if(k.key==="Backspace")try{let C=v.state,E=C.selection,A=E?.$from||null,I=null;try{for(let z=A?.depth||0;z>0;z-=1)if(A.node(z)?.type?.name==="outlineHeading"){I=z;break}}catch{I=null}let R=I!==null&&A?A.start(I):null,D=!!(E&&E.empty)&&!!A&&I!==null&&typeof R=="number"&&A.pos===R;if(We("editorProps.backspace.check",{empty:!!E?.empty,headingDepth:I,headingStart:R,pos:A?.pos??null,parent:A?.parent?.type?.name||null,parentOffset:A?.parentOffset??null,atHeadingStart:D}),D){let z=Bt(C.doc,A),q=typeof z=="number"?C.doc.nodeAt(z):null;if(We("editorProps.backspace.sectionPos",{sectionPos:z,hasNode:!!q}),typeof z=="number"&&q){let W=String(q.attrs?.id||""),K=null;try{let ee=C.doc.resolve(z),se=ee.index(),we=ee.parent;if(we&&se>0){let fe=we.child(se-1),Pe=z-fe.nodeSize,Oe=C.doc.nodeAt(Pe);K=String(Oe?.attrs?.id||"")||null}else for(let fe=A.depth-1;fe>0;fe-=1){let Pe=A.node(fe);if(Pe?.type?.name==="outlineSection"){let Oe=String(Pe.attrs?.id||"");if(Oe&&Oe!==W){K=Oe;break}}}}catch{K=null}We("editorProps.backspace.mergeCandidate",{sectionPos:z,currentSectionId:W,targetSectionId:K});let j=!1;if(me(q))j=Ee(C,v.dispatch,z);else try{C.doc.resolve(z).index()<=0?j=Je(C,v.dispatch,z):j=Ne(C,v.dispatch,z)}catch{j=Ne(C,v.dispatch,z)}return We("editorProps.backspace.mergeDone",{ok:j,targetSectionId:K}),j&&K&&Ae&&window.setTimeout(()=>{try{if((Ae.getState(v.state)||{}).editingSectionId)return;let se=mt(v.state.doc,K),we=typeof se=="number"?v.state.doc.nodeAt(se):null;if(!we)return;let fe=v.state.tr;we?.attrs?.collapsed&&(fe=fe.setNodeMarkup(se,void 0,{...we.attrs,collapsed:!1}),fe=fe.setMeta(ce,!0)),fe=fe.setMeta(Ae,{type:"enter",sectionId:K});try{let Pe=fe.doc.nodeAt(se);if(Pe&&Pe.type?.name==="outlineSection"){let Oe=Pe.child(0),Ye=Pe.child(1),F=se+1+Oe.nodeSize+Ye.nodeSize-1;fe=fe.setSelection(g.near(fe.doc.resolve(F),-1))}}catch{}v.dispatch(fe.scrollIntoView());try{v.focus()}catch{}We("editorProps.backspace.enterEdit.done",{targetSectionId:K})}catch{}},0),k.preventDefault(),k.stopPropagation(),!0}}}catch{}return k.preventDefault(),k.stopPropagation(),!0}if(M)return k.preventDefault(),k.stopPropagation(),po(),!0}if(a.isPublicView&&!O&&(k.key==="Enter"&&!k.shiftKey&&!k.ctrlKey&&!k.metaKey&&!k.altKey||k.key==="F2"&&!k.shiftKey&&!k.ctrlKey&&!k.metaKey&&!k.altKey))return k.preventDefault(),k.stopPropagation(),!0;if(!O&&(k.key==="Enter"&&!k.shiftKey&&!k.ctrlKey&&!k.metaKey&&!k.altKey||k.key==="F2"&&!k.shiftKey&&!k.ctrlKey&&!k.metaKey&&!k.altKey)){let V=Bt(v.state.doc,v.state.selection.$from);if(typeof V!="number")return!1;let P=v.state.doc.nodeAt(V),M=String(P?.attrs?.id||"");if(!M)return!1;if(k.preventDefault(),k.stopPropagation(),P?.attrs?.collapsed){let H=v.state.tr.setNodeMarkup(V,void 0,{...P.attrs,collapsed:!1});return H.setMeta(ce,!0),v.dispatch(H.scrollIntoView()),!0}return v.dispatch(v.state.tr.setMeta(Ae,{type:"enter",sectionId:M})),!0}if(O&&k.key==="Escape"){k.preventDefault(),k.stopPropagation();let V=O;v.dispatch(v.state.tr.setMeta(Ae,{type:"exit"}));try{let P=oe;if(P&&!P.isDestroyed){let M=Fr(v.state.doc,V);Sf(P,v.state.doc,V),M&&sn({delayMs:350})}}catch{}return!0}}catch{}return!1},handleDOMEvents:{click(v,k){try{let _=k.target?.closest?.("a[href]");if(!_||!Ae||(Ae.getState(v.state)||{}).editingSectionId||null)return!1;let P=String(_.getAttribute("href")||"").trim();if(!P)return!1;if(a.isPublicView){let A=String(_.getAttribute("rel")||"").split(/\s+/).filter(Boolean);if(_.getAttribute("data-unpublished")==="1"||A.includes("unpublished")||P==="#")return alert("\u042D\u0442\u0430 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435 \u043E\u043F\u0443\u0431\u043B\u0438\u043A\u043E\u0432\u0430\u043D\u0430"),k.preventDefault(),k.stopPropagation(),!0}if(P.startsWith("app:/")||P.startsWith("disk:/")){k.preventDefault(),k.stopPropagation();let E=Mn(P);if(E)return window.open(E,"_blank","noopener,noreferrer"),!0}let M=E=>{let A=String(E||"").trim();if(!A||A.startsWith("/")||A.startsWith("#")||/\s/.test(A)||A.includes("://")||/^[a-z][a-z0-9+.-]*:/i.test(A))return!1;let I=A.split(/[/?#]/,1)[0];return!(!I||!I.includes(".")||I.startsWith(".")||I.endsWith(".")||I.includes(".."))},H=E=>{let A=String(E||"").trim();return A&&(A.startsWith("//")?`https:${A}`:M(A)?`https://${A}`:A)};if(k.preventDefault(),k.stopPropagation(),P.startsWith("/"))return a.isPublicView?(window.location.href=P,!0):(gt(P),!0);let C=H(P);return/^https?:\/\//i.test(C)||/^mailto:/i.test(C)||/^tel:/i.test(C),window.open(C,"_blank","noopener,noreferrer"),!0}catch{return!1}},beforeinput(v,k){try{if(!Ae)return!1;let O=(Ae.getState(v.state)||{}).editingSectionId||null;if(O)return!1;let V=String(k?.inputType||"");if(V.startsWith("history"))return!1;if(We("beforeinput",{inputType:V,key:k?.data??null,editingSectionId:O||null,selection:{empty:!!v.state?.selection?.empty,parent:v.state?.selection?.$from?.parent?.type?.name||null,parentOffset:v.state?.selection?.$from?.parentOffset??null}}),V==="deleteContentBackward"){try{let P=v.state,M=P.selection,H=M?.$from||null,C=null;try{for(let I=H?.depth||0;I>0;I-=1)if(H.node(I)?.type?.name==="outlineHeading"){C=I;break}}catch{C=null}let E=C!==null&&H?H.start(C):null,A=!!(M&&M.empty)&&!!H&&C!==null&&typeof E=="number"&&H.pos===E;if(We("beforeinput.deleteContentBackward.check",{empty:!!M?.empty,headingDepth:C,headingStart:E,pos:H?.pos??null,parent:H?.parent?.type?.name||null,parentOffset:H?.parentOffset??null,atHeadingStart:A}),A){let I=Bt(P.doc,H),R=typeof I=="number"?P.doc.nodeAt(I):null;if(typeof I=="number"&&R){let D=String(R.attrs?.id||"");We("beforeinput.deleteContentBackward.candidate",{sectionPos:I,currentSectionId:D});let z=null;try{let W=P.doc.resolve(I),K=W.index(),j=W.parent;if(j&&K>0){let ee=j.child(K-1),se=I-ee.nodeSize,we=P.doc.nodeAt(se);z=String(we?.attrs?.id||"")||null}else for(let ee=H.depth-1;ee>0;ee-=1){let se=H.node(ee);if(se?.type?.name==="outlineSection"){let we=String(se.attrs?.id||"");if(we&&we!==D){z=we;break}}}}catch{z=null}let q=!1;if(me(R))We("beforeinput.merge",{kind:"deleteEmpty",sectionPos:I}),q=Ee(P,v.dispatch,I);else try{P.doc.resolve(I).index()<=0?(We("beforeinput.merge",{kind:"intoParent",sectionPos:I,targetSectionId:z}),q=Je(P,v.dispatch,I)):(We("beforeinput.merge",{kind:"intoPrev",sectionPos:I,targetSectionId:z}),q=Ne(P,v.dispatch,I))}catch{We("beforeinput.merge",{kind:"intoPrev.catch",sectionPos:I,targetSectionId:z}),q=Ne(P,v.dispatch,I)}return We("beforeinput.merge.done",{ok:q,targetSectionId:z}),q&&z&&window.setTimeout(()=>{try{if((Ae.getState(v.state)||{}).editingSectionId)return;let K=mt(v.state.doc,z),j=typeof K=="number"?v.state.doc.nodeAt(K):null;if(!j)return;let ee=v.state.tr;j?.attrs?.collapsed&&(ee=ee.setNodeMarkup(K,void 0,{...j.attrs,collapsed:!1}),ee=ee.setMeta(ce,!0)),ee=ee.setMeta(Ae,{type:"enter",sectionId:z});try{let se=v.state.doc.nodeAt(K);if(se&&se.type?.name==="outlineSection"){let we=se.child(0),fe=K+1+we.nodeSize,Pe=Math.min(ee.doc.content.size,fe+2);ee=ee.setSelection(g.create(ee.doc,Pe))}}catch{}v.dispatch(ee.scrollIntoView());try{v.focus()}catch{}We("beforeinput.enterEdit.done",{targetSectionId:z})}catch{}},0),k.preventDefault(),k.stopPropagation(),!0}}}catch{}return We("beforeinput.deleteContentBackward.block",{inputType:V}),k.preventDefault(),k.stopPropagation(),!0}return V.startsWith("delete")?(We("beforeinput.delete.block",{inputType:V}),k.preventDefault(),k.stopPropagation(),!0):(k.preventDefault(),k.stopPropagation(),po(),!0)}catch{return!1}},dblclick(v,k){try{if(a.isPublicView||!Ae||(Ae.getState(v.state)||{}).editingSectionId||null)return!1;let V=k?.target&&k.target.closest&&k.target.closest('[data-outline-heading="true"]')||k?.target&&k.target.closest&&k.target.closest(".outline-heading"),P=k?.target&&k.target.closest&&k.target.closest('[data-outline-body="true"]')||k?.target&&k.target.closest&&k.target.closest(".outline-body");if(!V&&!P)return!1;let M={left:k.clientX,top:k.clientY},H=v.posAtCoords(M),C=H&&typeof H.pos=="number"?H.pos:null;if(typeof C!="number")return!1;let E=v.state.doc.resolve(Math.max(0,Math.min(v.state.doc.content.size,C))),A=Bt(v.state.doc,E);if(typeof A!="number")return!1;let I=v.state.doc.nodeAt(A),R=String(I?.attrs?.id||"");if(!R)return!1;window.setTimeout(()=>{try{if((Ae.getState(v.state)||{}).editingSectionId)return;let z=mt(v.state.doc,R),q=typeof z=="number"?v.state.doc.nodeAt(z):null,W=!!q?.attrs?.collapsed,K=v.state.tr;if(W&&typeof z=="number"&&q&&(K=K.setNodeMarkup(z,void 0,{...q.attrs,collapsed:!1}),K=K.setMeta(ce,!0)),W){v.dispatch(K.scrollIntoView());try{v.focus()}catch{}return}K=K.setMeta(Ae,{type:"enter",sectionId:R});try{let{TextSelection:j}=He?.pmStateMod||{},ee=typeof z=="number"?K.doc.nodeAt(z):null;if(ee&&ee.type?.name==="outlineSection"){let se=ee.child(0),we=z+1+se.nodeSize,fe=Math.min(K.doc.content.size,we+2);j&&(K=K.setSelection(j.near(K.doc.resolve(fe),1)))}}catch{}v.dispatch(K.scrollIntoView());try{v.focus()}catch{}}catch{}},0)}catch{}return!1}}},onCreate:({editor:v})=>{if(Xe&&a.articleId&&a.article&&!a.article.encrypted)try{let k=v.getJSON();a.article.docJson=k,Ql(a.articleId,k).catch(()=>{})}catch{}try{iy(v.state.doc)}catch{}xr.clear(),an=!1,kf=null,on=null;try{Ss=cf(v.state.doc),Fn=!1;try{kn.clear()}catch{kn.clear()}$t&&(clearTimeout($t),$t=null)}catch{}Ir("")},onUpdate:()=>{an=!0;try{let v=Ae?.getState?.(oe?.state)||null,k=String(v?.editingSectionId||"").trim();if(k){let _=oe?.state?.doc||null;_&&Fr(_,k)&&Ag(oe)}}catch{}try{let v=oe?.state?.doc||null;if(v){let k=cf(v);k&&k!==Ss&&(Ss=k,kg({articleId:Lt||a.articleId,editor:oe}))}}catch{}try{yf(oe)}catch{}sn({delayMs:1500})},onSelectionUpdate:({editor:v})=>{let{state:k}=v,{selection:_}=k;if(!_)return;let O=Bt(k.doc,_.$from);if(typeof O!="number")return;let V=k.doc.nodeAt(O),P=String(V?.attrs?.id||"");if(!P)return;try{let C=(Ae?.getState?.(k)||null)?.editingSectionId||null;C&&C!==P&&v.view.dispatch(k.tr.setMeta(Ae,{type:"exit"}))}catch{}if(on&&on!==P){let H=Fr(k.doc,on);try{Yn("leave_section",{from:on,to:P,changed:H})}catch{}try{xr.has(on)&&Sf(v,k.doc,on)}catch{}H&&sn({delayMs:350})}let M=on;on=P;try{yf(v)}catch{}try{!(Ae?.getState?.(k)||null)?.editingSectionId&&M&&M!==P&&ny(v,{lines:4})}catch{}}}),Un&&fo("new Editor()",{ms:Math.round(performance.now()-Un)});try{(Lt||a.articleId)&&(gg(Lt||a.articleId),navigator.onLine&&If(Lt||a.articleId))}catch{}e.focus?.({preventScroll:!0}),Is=v=>{try{if(!oe)return;let k=oe.state.tr.setMeta(re,{activeKey:v||null});oe.view.dispatch(k)}catch{}};try{Df()}catch{}try{let v=Rr()?performance.now():0;_g(oe),v&&fo("convertMarkdownTablesInOutlineDoc()",{ms:Math.round(performance.now()-v)})}catch{}t&&fo("mountOutlineEditor() total",{ms:Math.round(performance.now()-t)})})();try{await Zo}finally{Zo=null}}function xf(e=""){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}async function cy(e={}){if(a.isPublicView||!a.articleId||!a.article||!oe)return;let t=Lt||a.articleId;if(!t)return;let n=!!e.silent,r=e&&typeof e.mode=="string"?e.mode:"network",o=Array.from(new Set([...xr||[],on].filter(Boolean))),i=(s,c)=>{let d=s?String(s):"",l=c?String(c):"";return d?l?d>=l?d:l:d||null:l||null};try{if(n||It("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C outline\u2026"),a.article.encrypted){n||(ot(),L("Outline-\u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u0435 docJson \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0434\u043B\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0445 \u0441\u0442\u0430\u0442\u0435\u0439"));return}let s=oe.getJSON(),c=hg(s);if(a.articleId&&t!==a.articleId){await ln(t,c,a.article?.updatedAt||null).catch(()=>{}),n||ot(),Ir("\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0447\u0435\u0440\u043D\u043E\u0432\u0438\u043A \u0441\u043E\u0445\u0440\u0430\u043D\u0451\u043D \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E");return}let d=Date.now();await ln(t,c,a.article?.updatedAt||null).catch(()=>{});try{on&&Fr(oe.state.doc,on)}catch{}if(!0){let u=kn.size?Array.from(kn):[];try{u.length&&(kn.clear(),await Nt("delete_sections",{articleId:t,payload:{sectionIds:u,clientQueuedAt:d},coalesceKey:`delete:${t}`}))}catch{}n||ot(),a.article&&(a.article.docJson=c),an=!1,kf=new Date,Ir("\u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E");try{Df()}catch{}try{ay(oe,oe.state.doc,o)}catch{}return}}catch(s){n?Ir("\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F"):(ot(),L(s?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C outline"));try{let c=oe.getJSON();c&&typeof c=="object"&&await ln(t,c,a.article?.updatedAt||null).catch(()=>{})}catch{}sn({delayMs:5e3})}}function ly(){return on||null}function dy(){try{if(!oe||oe.isDestroyed)return null;let e=oe.state,t=Bt(e.doc,e.selection.$from);if(typeof t!="number")return null;let n=e.doc.nodeAt(t);if(!n||n.type?.name!=="outlineSection")return null;let r=String(n.attrs?.id||"").trim();return r?{sectionId:r,collapsed:!!n.attrs?.collapsed}:null}catch{return null}}function uy(e,t){try{let n=String(t||"");if(!e||!n)return null;let r=(i,s,c)=>{if(!i||i.type?.name!=="outlineSection")return null;let d=String(i.attrs?.id||""),l=[...c,s];if(d===n)return l;let u=i.child(0),f=i.child(1),p=i.child(2);if(!p||p.type?.name!=="outlineChildren")return null;let b=s+1+u.nodeSize+f.nodeSize+1;for(let h=0;h<p.childCount;h+=1){let g=p.child(h),w=b;b+=g.nodeSize;let S=r(g,w,l);if(S)return S}return null},o=0;for(let i=0;i<e.childCount;i+=1){let s=e.child(i),c=o;o+=s.nodeSize;let d=r(s,c,[]);if(d)return d}return null}catch{return null}}function Jf(e,t={}){try{if(!oe||oe.isDestroyed)return!1;let n=String(e||"");if(!n)return!1;let{state:r,view:o}=oe,i=He?.pmStateMod?.TextSelection,s=uy(r.doc,n);if(!Array.isArray(s)||!s.length)return!1;let c=r.tr;for(let d of s){let l=c.doc.nodeAt(d);!l||l.type?.name!=="outlineSection"||l.attrs?.collapsed&&(c=c.setNodeMarkup(d,void 0,{...l.attrs,collapsed:!1}))}c=c.setMeta(ce,!0);try{let d=mt(c.doc,n),l=typeof d=="number"?c.doc.nodeAt(d):null;if(typeof d=="number"&&l?.type?.name==="outlineSection"){let u=l.child(0),f=d+1+u.nodeSize,p=Math.min(c.doc.content.size,f+2);i&&(c=c.setSelection(i.create(c.doc,p)))}}catch{}o.dispatch(c.scrollIntoView());try{let d=typeof CSS<"u"&&CSS.escape?CSS.escape(n):n.replace(/"/g,'\\"');window.requestAnimationFrame(()=>{try{let l=o.dom?.querySelector?.(`[data-outline-section][data-section-id="${d}"]`)||o.dom?.querySelector?.(`[data-section-id="${d}"]`);l&&typeof l.scrollIntoView=="function"&&l.scrollIntoView({block:"center",inline:"nearest"})}catch{}})}catch{}if(t&&t.focus)try{o.focus()}catch{}return!0}catch{return!1}}function fy(e,t){if(!oe)return!1;let n=String(e||"");if(!n)return!1;let r=mt(oe.state.doc,n);if(typeof r!="number")return!1;let o=oe.state.doc.nodeAt(r);if(!o)return!1;let i=oe.state.doc.type.schema,s=xn(String(t||"")),c=Hc(s.titleHtml||"")||Hc(s.bodyHtml||"").slice(0,80)||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",d=ii?ii(s.bodyHtml||""):[],l=[];for(let h of d||[])try{l.push(i.nodeFromJSON(h))}catch{}l.length||l.push(i.nodes.paragraph.create({},[]));let u=i.nodes.outlineHeading.create({},c?[i.text(c)]:[]),f=i.nodes.outlineBody.create({},l),p=o.child(2),y=i.nodes.outlineSection.create(o.attrs,[u,f,p]),b=oe.state.tr.replaceWith(r,r+o.nodeSize,y);try{let h=He?.pmStateMod?.TextSelection;h&&(b=b.setSelection(h.create(b.doc,r+2)))}catch{}return oe.view.dispatch(b),oe.view.focus(),an=!0,sn({delayMs:200}),!0}function py(e,t){if(!oe)return!1;let n=String(e||"");if(!n)return!1;let r=mt(oe.state.doc,n);if(typeof r!="number")return!1;let o=oe.state.doc.nodeAt(r);if(!o)return!1;let i=t&&typeof t=="object"?t:{},s=oe.state.doc.type.schema,c=null,d=null;try{i.heading&&typeof i.heading=="object"&&(c=s.nodeFromJSON(i.heading))}catch{c=null}try{i.body&&typeof i.body=="object"&&(d=s.nodeFromJSON(i.body))}catch{d=null}(!c||c.type?.name!=="outlineHeading")&&(c=s.nodes.outlineHeading.create({},[])),(!d||d.type?.name!=="outlineBody")&&(d=s.nodes.outlineBody.create({},[s.nodes.paragraph.create({},[])])),d.childCount||(d=s.nodes.outlineBody.create({},[s.nodes.paragraph.create({},[])]));let l=o.child(2),u=s.nodes.outlineSection.create(o.attrs,[c,d,l]),f=oe.state.tr.replaceWith(r,r+o.nodeSize,u);try{let p=He?.pmStateMod?.TextSelection;p&&(f=f.setSelection(p.create(f.doc,r+2)))}catch{}return oe.view.dispatch(f),oe.view.focus(),an=!0,sn({delayMs:200}),!0}function my(e,t){if(!oe)return!1;let n=String(e||"").trim();if(!n||typeof mt(oe.state.doc,n)=="number")return!1;let o=t&&typeof t=="object"?t:{},i=oe.state.doc.type.schema,s=null,c=null;try{o.heading&&typeof o.heading=="object"&&(s=i.nodeFromJSON(o.heading))}catch{s=null}try{o.body&&typeof o.body=="object"&&(c=i.nodeFromJSON(o.body))}catch{c=null}(!s||s.type?.name!=="outlineHeading")&&(s=i.nodes.outlineHeading.create({},[])),(!c||c.type?.name!=="outlineBody")&&(c=i.nodes.outlineBody.create({},[i.nodes.paragraph.create({},[])])),c.childCount||(c=i.nodes.outlineBody.create({},[i.nodes.paragraph.create({},[])]));let d=i.nodes.outlineChildren.create({},[]),l=i.nodes.outlineSection.create({id:n,collapsed:!1},[s,c,d]),u=oe.state.doc.content.size,f=oe.state.tr.insert(u,l);try{let p=He?.pmStateMod?.TextSelection;if(p){let y=Math.min(f.doc.content.size,u+2);f=f.setSelection(p.near(f.doc.resolve(Math.max(0,y)),1))}}catch{}return f=f.setMeta(ce,!0),oe.view.dispatch(f.scrollIntoView()),oe.view.focus(),an=!0,sn({delayMs:200}),!0}function hy({enterEditMode:e=!0}={}){if(!oe)return null;let t=oe.state.doc.type.schema,n=oe.state.doc.content.size,r=Xt(),o=t.nodes.outlineSection.create({id:r,collapsed:!1},[t.nodes.outlineHeading.create({},[]),t.nodes.outlineBody.create({},[t.nodes.paragraph.create({},[])]),t.nodes.outlineChildren.create({},[])]),i=oe.state.tr.insert(n,o);try{let s=He?.pmStateMod?.TextSelection;if(s){let c=mt(i.doc,r),d=typeof c=="number"?Bs(i.doc,c):null;typeof d=="number"?i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,d+2)),1)):i=i.setSelection(s.create(i.doc,n+2))}}catch{}return i=i.setMeta(ce,!0),e&&Ae&&(i=i.setMeta(Ae,{type:"enter",sectionId:r})),oe.view.dispatch(i.scrollIntoView()),oe.view.focus(),an=!0,sn({delayMs:200}),r}function Bs(e,t){try{let n=e.nodeAt(t);if(!n||n.type?.name!=="outlineSection")return null;let r=n.child(0);return t+1+r.nodeSize}catch{return null}}function gy(e,{focusBody:t=!0}={}){if(!oe||!Ae)return!1;let n=String(e||"").trim();if(!n)return!1;let r=mt(oe.state.doc,n);if(typeof r!="number"||oe.state.doc.nodeAt(r)?.attrs?.collapsed)return!1;let i=oe.state.tr;if(t)try{let s=He?.pmStateMod?.TextSelection,c=Bs(i.doc,r);s&&typeof c=="number"&&(i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,c+2)),1)))}catch{}return i=i.setMeta(ce,!0),i=i.setMeta(Ae,{type:"enter",sectionId:n}),oe.view.dispatch(i.scrollIntoView()),oe.view.focus(),!0}function yy({enterEditMode:e=!0}={}){if(!oe)return null;let t=oe.state.doc.type.schema,n=0,r=Xt(),o=t.nodes.outlineSection.create({id:r,collapsed:!1},[t.nodes.outlineHeading.create({},[]),t.nodes.outlineBody.create({},[t.nodes.paragraph.create({},[])]),t.nodes.outlineChildren.create({},[])]),i=oe.state.tr.insert(n,o);try{let s=He?.pmStateMod?.TextSelection;if(s){let c=mt(i.doc,r),d=typeof c=="number"?Bs(i.doc,c):null;typeof d=="number"?i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,d+2)),1)):i=i.setSelection(s.create(i.doc,n+2))}}catch{}return i=i.setMeta(ce,!0),e&&Ae&&(i=i.setMeta(Ae,{type:"enter",sectionId:r})),oe.view.dispatch(i.scrollIntoView()),oe.view.focus(),an=!0,sn({delayMs:200}),r}function by(e,t,{enterEditMode:n=!1}={}){if(!oe)return!1;let r=String(e||"").trim();if(!r||typeof mt(oe.state.doc,r)=="number")return!1;let i=oe.state.doc.type.schema,s=i.nodes.paragraph,c=i.nodes.hardBreak||i.nodes.hard_break||null,d=String(t||"").replace(/\r\n/g,`
`).trimEnd(),l=()=>{if(!s)return[];if(!d.trim())return[s.create({},[])];let g=d.split(/\n{2,}/),w=[];for(let S of g){let x=String(S||"").split(`
`),T=[];for(let N=0;N<x.length;N+=1){let B=x[N];N>0&&c&&T.push(c.create()),B&&T.push(i.text(B))}w.push(s.create({},T))}return w.length?w:[s.create({},[])]},u=i.nodes.outlineHeading.create({},[]),f=i.nodes.outlineBody.create({},l()),p=i.nodes.outlineChildren.create({},[]),y=i.nodes.outlineSection.create({id:r,collapsed:!1},[u,f,p]),b=0,h=oe.state.tr.insert(b,y);try{let g=He?.pmStateMod?.TextSelection;if(g){let w=mt(h.doc,r),S=typeof w=="number"?Bs(h.doc,w):null;typeof S=="number"?h=h.setSelection(g.near(h.doc.resolve(Math.min(h.doc.content.size,S+2)),1)):h=h.setSelection(g.create(h.doc,b+2))}}catch{}return h=h.setMeta(ce,!0),n&&Ae&&(h=h.setMeta(Ae,{type:"enter",sectionId:r})),oe.view.dispatch(h.scrollIntoView()),oe.view.focus(),an=!0,sn({delayMs:200}),!0}async function wy(){if(a.isPublicView||a.isRagView){L("Outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0432 \u044D\u0442\u043E\u043C \u0440\u0435\u0436\u0438\u043C\u0435");return}if(!a.articleId||!a.article){L("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}if(Lt=a.articleId,!m.outlineEditor||!m.blocksContainer){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440");return}a.isOutlineEditing=!0,m.articleToolbar&&m.articleToolbar.classList.add("hidden"),m.outlineToolbar&&m.outlineToolbar.classList.remove("hidden"),m.outlineTagsBar&&m.outlineTagsBar.classList.remove("hidden"),m.outlineEditor.classList.remove("hidden"),m.blocksContainer.classList.add("hidden"),_f({loading:!0});try{at("outline.open",{articleId:Lt,updatedAt:a.article?.updatedAt||null,docHash:Rt(a.article?.docJson||null)})}catch{}try{if(!a.scrollTargetBlockId&&Lt){let e=ty(Lt);e?.sectionId&&(a.currentBlockId=e.sectionId)}}catch{}try{await Kf();try{jg(oe)}catch{}try{let t=a.scrollTargetBlockId||null;t&&(Jf(t,{focus:!1}),a.scrollTargetBlockId=null,a.currentBlockId=t)}catch{}try{let t=a.currentBlockId||null;t&&Qg(oe,t)}catch{}let e=m.outlineEditor.querySelector(".outline-editor__loading");if(e&&e.classList.add("hidden"),Ir("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u0442\u0441\u044F \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438"),rf||(rf=!0,window.addEventListener("online",()=>{if(a.isOutlineEditing){try{If(Lt||a.articleId)}catch{}ri({force:!0})}}),window.addEventListener("blur",()=>{a.isOutlineEditing&&ri({force:!0})}),document.addEventListener("visibilitychange",()=>{a.isOutlineEditing&&document.visibilityState!=="visible"&&ri({force:!0})})),!ni){let t=r=>{if(!a.isOutlineEditing)return;let o=r?.dataTransfer;if(!(o&&(o.files&&o.files.length||o.items&&o.items.length)))return;let s=r?.target;m.outlineEditor&&s&&m.outlineEditor.contains(s)||r.preventDefault()},n=r=>{if(!a.isOutlineEditing)return;let o=r?.dataTransfer;if(!(o&&o.files&&o.files.length))return;let s=r?.target;m.outlineEditor&&s&&m.outlineEditor.contains(s)||(r.preventDefault(),r.stopPropagation())};window.addEventListener("dragover",t,{passive:!1}),window.addEventListener("drop",n,{passive:!1}),ni=()=>{window.removeEventListener("dragover",t),window.removeEventListener("drop",n),ni=null}}}catch(e){L(e?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440"),jf()}}function jf(){a.isOutlineEditing=!1,Wg(),Ae=null,Lt=null,kr=null,Is=null,qr={counts:new Map,labelByKey:new Map,sectionIdsByKey:new Map,sectionPosById:new Map};try{m.outlineTagsBar&&(m.outlineTagsBar.innerHTML="",m.outlineTagsBar.classList.add("hidden"))}catch{}ti(!1),ni&&ni(),m.outlineToolbar&&m.outlineToolbar.classList.add("hidden"),m.articleToolbar&&m.articleToolbar.classList.remove("hidden"),Xn&&(clearTimeout(Xn),Xn=null),$t&&(clearTimeout($t),$t=null),Hr&&(clearTimeout(Hr),Hr=null),Lc=null,Fn=!1,Ss="";try{kn.clear()}catch{}if(bs=!1,xr.clear(),Vr.clear(),on=null,an=!1,oe){try{oe.destroy()}catch{}oe=null}He=null,m.outlineEditor&&m.outlineEditor.classList.add("hidden"),m.blocksContainer&&m.blocksContainer.classList.remove("hidden")}async function Sy(e={}){let t=e&&typeof e.mode=="string"?e.mode:"network",n=e&&typeof e.timeoutMs=="number"?Math.max(0,Math.floor(e.timeoutMs)):0;if(!oe)return;Xn&&(clearTimeout(Xn),Xn=null);try{let o=Lt||a.articleId;if(o&&!a.article?.encrypted){let i=oe.getJSON();if(i&&typeof i=="object")try{await ln(o,i,a.article?.updatedAt||null)}catch{}try{try{let s=Ae?.getState?.(oe?.state)||null,c=String(s?.editingSectionId||"").trim();c&&await Lf({articleId:o,doc:oe.state.doc,sectionId:c,reason:"pagehide"})}catch{}if(Fn){let s=si(oe.state.doc);s.length&&(Nt("structure_snapshot",{articleId:o,payload:{nodes:s},coalesceKey:`structure:${o}`}),Fn=!1)}}catch{}try{if(kn.size){let s=Array.from(kn);kn.clear();let c=Date.now();await Nt("delete_sections",{articleId:o,payload:{sectionIds:s,clientQueuedAt:c},coalesceKey:`delete:${o}:${c}`})}}catch{}}}catch{}if(t==="queue")return;let r=ri({force:!0,silent:!0});if(n>0){await Promise.race([r,new Promise(o=>setTimeout(o,n))]);return}await r}async function xy({docJson:e}={}){if(m.outlineEditor){if(!e||typeof e!="object"){L("\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F: \u043D\u0435\u0442 \u0434\u043E\u043A\u0443\u043C\u0435\u043D\u0442\u0430");return}a.isPublicView=!0,a.isRagView=!1,a.isOutlineEditing=!1,a.articleId=null,a.article={docJson:e,encrypted:!1};try{m.outlineEditor.classList.add("outline-editor")}catch{}m.outlineEditor.classList.remove("hidden"),m.outlineEditor.querySelector("#outlineEditorContent")||_f({loading:!0});try{await Kf();let t=m.outlineEditor.querySelector(".outline-editor__loading");t&&t.classList.add("hidden"),Ir("\u0422\u043E\u043B\u044C\u043A\u043E \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440")}catch(t){L(t?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E")}}}var nf,He,oe,Zo,Xn,bs,Hr,Lc,Ic,kf,on,oi,Vr,xr,an,rf,ii,Mc,Nc,kt,Or,vc,of,ei,ws,Ae,ni,Lt,kr,Is,qr,ir,Ar,pg,gs,Pc,Dc,mg,af,ks,Fn,Ss,$t,kn,Tc,ce,lf,Ig,vg,Eg,ys,ky,Ay,We,ar=Fe(()=>{ft();vt();Et();nn();Rn();Pt();Do();$n();Io();vo();zu();wn();Uu();qu();Ao();nf=!1,He=null,oe=null,Zo=null,Xn=null,bs=!1,Hr=null,Lc=null,Ic=0,kf=null,on=null,oi=new Map,Vr=new Map,xr=new Set,an=!1,rf=!1,ii=null,Mc=null,Nc=null,kt={TableMap:null,CellSelection:null,moveTableColumn:null,moveTableRow:null,addRowBefore:null,addRowAfter:null,deleteRow:null,addColumnBefore:null,addColumnAfter:null,deleteColumn:null,toggleHeaderRow:null,toggleHeaderColumn:null},Or=!1,vc=new Map,of=30*1e3,ei=new Map,ws=null,Ae=null,ni=null,Lt=null,kr=null,Is=null,qr={counts:new Map,labelByKey:new Map,sectionIdsByKey:new Map,sectionPosById:new Map},ir=!1,Ar=new Set,pg=650,gs={articleId:null,sectionId:null,collapsed:null},Pc="ttree_outline_section_clipboard_v1",Dc="pending-attachment:",mg=2e3;af="ttree_outline_section_seq_v1",ks=262144;Fn=!1,Ss="",$t=null,kn=new Set,Tc=null;ce="outlineAllowMutation",lf=0,Ig="ttree_outline_debug_md_table";vg="ttree_profile_v1";Eg="ttree_outline_debug_proofread_v1";ys=null;ky="ttree_debug_outline_keys_v1",Ay=()=>{try{return window?.localStorage?.getItem?.(ky)==="1"}catch{return!1}},We=(e,t={})=>{try{if(!Ay())return;console.log("[outline][keys]",e,t)}catch{}}});function Ey(){try{return window?.localStorage?.getItem?.(Iy)==="1"}catch{return!1}}function Yf(){try{return window?.localStorage?.getItem?.(vy)==="1"}catch{return!1}}function go(...e){try{if(!Ey())return;console.log("[article-load]",...e)}catch{}}function Ty(e){try{let t=e?.content;if(!Array.isArray(t))return null;for(let n of t)if(n?.type==="outlineSection"){let r=String(n?.attrs?.id||"");if(r)return r}return null}catch{return null}}async function Ht(e,t={}){let{desiredBlockId:n,resetUndoStacks:r,editBlockId:o}=t,i=a.articleId!==e;if(go("load.start",{id:e,switchingArticle:i,mode:a.mode,isOutlineEditing:a.isOutlineEditing}),i)try{let p=a.articleId,y=await Promise.resolve().then(()=>(ar(),sr));try{let b=y?.getOutlineActiveSectionSnapshot?.()||null;if(p&&b?.sectionId){let h=window?.localStorage?.getItem?.(Wf)||"{}",g=JSON.parse(h||"{}"),w=g&&typeof g=="object"?g:{};w[String(p)]={sectionId:b.sectionId,collapsed:!!b.collapsed,savedAt:new Date().toISOString()},window?.localStorage?.setItem?.(Wf,JSON.stringify(w))}}catch{}y?.flushOutlineAutosave&&await y.flushOutlineAutosave({mode:"queue"}),y?.closeOutlineEditor&&y.closeOutlineEditor()}catch{}a.articleId=e,a.isEditingTitle=!1,a.pendingTextPreview=null,a.article=null,a.currentBlockId=null;let s=performance.now(),c=await Jl(e);Yf()&&console.log("[perf][article-load] fetchArticle",{id:e,ms:Math.round(performance.now()-s)}),go("load.fetched",{id:e,ms:Math.round(performance.now()-s),hasDocJson:!!c?.docJson,docContent:Array.isArray(c?.docJson?.content)?c.docJson.content.length:null,blocksCount:Array.isArray(c?.blocks)?c.blocks.length:null,updatedAt:c?.updatedAt});let d=c;try{d=await ru(c)}catch(p){throw L(p.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u0443\u044E \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443"),p}a.article=d,(typeof r=="boolean"?r:i)&&Ou(d);let u=n||o||a.pendingEditBlockId||null;a.pendingEditBlockId=null;let f=Ty(d.docJson)||d.blocks?.[0]?.id||null;if(a.currentBlockId=u||f,a.mode="view",a.editingBlockId=null,Bn(d),dl(),!a.isPublicView&&!a.isRagView&&!d.encrypted)try{let p=await Promise.resolve().then(()=>(ar(),sr));if(p?.openOutlineEditor){go("outline.open.start",{id:e});let y=Yf()?performance.now():0;p.openOutlineEditor(),y&&console.log("[perf][article-load] outline.open scheduled",{id:e,ms:Math.round(performance.now()-y)}),go("outline.open.scheduled",{id:e,isOutlineEditing:a.isOutlineEditing})}}catch(p){a.isOutlineEditing=!1,go("outline.open.failed",{id:e,message:p?.message||String(p||"error")}),L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C outline-\u0440\u0435\u0436\u0438\u043C (\u0441\u043C. \u043A\u043E\u043D\u0441\u043E\u043B\u044C)")}return go("load.done",{id:e,currentBlockId:a.currentBlockId}),d}var Iy,vy,Wf,Uc=Fe(()=>{ft();Pt();$n();Et();tn();za();So();Iy="ttree_debug_article_load_v1",vy="ttree_profile_v1",Wf="ttree_outline_last_active_v1"});function ep(){if(!Mt||!ci()||Mt.pointerType==="mouse")return;let e=window.getSelection?window.getSelection():null;if(!(!e||e.isCollapsed))try{e.removeAllRanges()}catch{}}function Ny(){Ls||(document.addEventListener("selectionchange",ep),Ls=!0)}function Py(){Ls&&(document.removeEventListener("selectionchange",ep),Ls=!1)}function ci(){return!!(a.isDragModeEnabled&&a.mode==="view"&&a.articleId!=="inbox")}function tp(e){return e instanceof Element?!!e.closest(My):!1}function Vc(){if(Mt){window.removeEventListener("pointermove",sp),window.removeEventListener("pointerup",Ms),window.removeEventListener("pointercancel",Ms);try{Mt.sourceEl?.releasePointerCapture?.(Mt.pointerId)}catch{}Mt=null,Py(),Oy()}}function Dy(e,t,n,{bypassInteractiveCheck:r=!1}={}){if(!a.article||!a.isDragModeEnabled||!ci()||e.pointerType==="mouse"&&e.button!==0||!r&&tp(e.target))return;let o=Ke(t);if(o){Mt={pointerType:e.pointerType||"mouse",blockId:t,pointerId:e.pointerId,originParentId:o.parent?.id||null,originIndex:o.index??0,startX:e.clientX,startY:e.clientY,dragging:!1,forbidden:rp(o.block),lastDrop:null,sourceEl:n};try{n?.setPointerCapture?.(e.pointerId)}catch{}window.addEventListener("pointermove",sp),window.addEventListener("pointerup",Ms),window.addEventListener("pointercancel",Ms),Ny()}}function np(e,t,{allowInteractive:n=!1}={}){e&&e.addEventListener("pointerdown",r=>{if(!n&&tp(r.target))return;(r.pointerType==="touch"||r.pointerType==="pen")&&ci()&&r.preventDefault(),Dy(r,t,e,{bypassInteractiveCheck:n})})}function vr(){let e=!!a.article,t=m.dragModeToggleBtn;if(t){t.disabled=!e,t.classList.toggle("active",!!a.isDragModeEnabled),t.setAttribute("aria-pressed",a.isDragModeEnabled?"true":"false");let o=a.isDragModeEnabled?"\u041F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435 \u0431\u043B\u043E\u043A \u0437\u0430 \u0435\u0433\u043E \u043F\u043E\u0432\u0435\u0440\u0445\u043D\u043E\u0441\u0442\u044C":"\u0412\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0440\u0435\u0436\u0438\u043C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u044F \u0431\u043B\u043E\u043A\u043E\u0432";e?a.articleId==="inbox"?o="\u041F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0432 \u0431\u044B\u0441\u0442\u0440\u044B\u0445 \u0437\u0430\u043C\u0435\u0442\u043A\u0430\u0445":a.mode!=="view"&&(o="\u041F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043C\u043E\u0436\u043D\u043E \u0442\u043E\u043B\u044C\u043A\u043E \u0432 \u0440\u0435\u0436\u0438\u043C\u0435 \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440\u0430"):o="\u041E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E, \u0447\u0442\u043E\u0431\u044B \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0442\u044C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435\u043C",t.title=o}let n=ci();[m.articleView,m.blocksContainer].forEach(o=>{o&&o.classList.toggle("drag-mode-enabled",n)}),document.body.classList.toggle("drag-mode-enabled",n)}function rp(e,t=new Set){return e&&(t.add(e.id),(e.children||[]).forEach(n=>rp(n,t))),t}function _y(){if(ai)return ai;let e=document.createElement("div");return e.className="block-drop-line hidden",document.body.appendChild(e),ai=e,e}function Oy(){ai&&ai.classList.add("hidden"),cn&&(cn.classList.remove("drop-inside-target"),cn=null),Kr&&(Kr.remove(),Kr=null),document.body.classList.remove("block-dnd-active")}function Ry(e){Kr&&(Kr.style.left=`${e.clientX+12}px`,Kr.style.top=`${e.clientY+12}px`)}function Hy(e){let t=document.createElement("div");t.className="block-drag-preview";let n=m.blocksContainer?.querySelector(`.block[data-block-id="${e}"]`),r=n?.querySelector(".block-title")?.textContent?.trim(),o=n?.querySelector(".block-text")?.textContent?.trim();t.textContent=r||o||"\u0411\u043B\u043E\u043A",document.body.appendChild(t),Kr=t}function op(){return Ln&&Ln.isConnected?(m.blocksContainer&&Ln.parentNode!==m.blocksContainer&&m.blocksContainer.appendChild(Ln),Ln):(Ln=document.createElement("div"),Ln.className="drag-layer",m.blocksContainer&&(m.blocksContainer.appendChild(Ln),Xf||(m.blocksContainer.addEventListener("scroll",Gf,{passive:!0}),window.addEventListener("resize",Gf,{passive:!0}),Xf=!0)),Ln)}function ip(){Zf.clear(),Ln&&(Ln.innerHTML="")}function Gf(){let e=m.blocksContainer;if(!e||!Ln)return;let t=e.getBoundingClientRect(),n=e.scrollTop;Zf.forEach(({handle:r,blockEl:o})=>{let i=o.getBoundingClientRect(),s=o.querySelector(".block-header__left"),c=o.querySelector(".block-header"),d=o.querySelector(".collapse-btn"),l=s?.getBoundingClientRect(),u=c?.getBoundingClientRect(),f=d?.getBoundingClientRect(),p=(l&&l.height>0?l:null)||(u&&u.height>0?u:null)||(f&&f.height>0?f:null)||i,y=p.top-t.top+n+p.height/2;r.style.top=`${y}px`,r.style.right="8px"})}function $y(e){let t=_y();if(!e){t.classList.add("hidden"),cn&&(cn.classList.remove("drop-inside-target"),cn=null);return}if(e.placement==="inside"){t.classList.add("hidden"),cn&&cn.dataset.blockId!==e.targetId&&cn.classList.remove("drop-inside-target"),cn=m.blocksContainer?.querySelector(`.block[data-block-id="${e.targetId}"]`)||null,cn&&cn.classList.add("drop-inside-target");return}cn&&(cn.classList.remove("drop-inside-target"),cn=null),t.classList.remove("hidden");let n=e.placement==="before"?e.rect.top:e.rect.top+e.rect.height,r=Math.min(e.depth*Qf,e.rect.width-32),o=e.rect.left+r,i=Math.max(e.rect.width-r,48);t.style.top=`${n}px`,t.style.left=`${o}px`,t.style.width=`${i}px`}function Fy(e,t){if(!m.blocksContainer||!Mt)return null;let r=Array.from(m.blocksContainer.querySelectorAll(".block")).filter(x=>{let T=x.dataset.blockId;return T&&!Mt.forbidden.has(T)});if(!r.length)return null;let o=null,i=1/0;if(r.forEach(x=>{let T=x.getBoundingClientRect(),N=T.top+T.height/2,B=Math.abs(t-N);B<i&&(i=B,o=x)}),!o)return null;let s=o.getBoundingClientRect(),c=s.height>0?(t-s.top)/s.height:.5,d=c<By?"before":c>Ly?"after":"inside",l=o.dataset.blockId,u=Ke(l);if(!u)return null;let f=(u.ancestors||[]).length,p=d==="inside"?l:u.parent?.id||null;if(Mt.forbidden.has(p||""))return null;let y=l,b=p,h=d,g=s,w=d==="inside"?f+1:f,S=h==="after"?u.index+1:u.index;if(h!=="inside"&&u.parent){let x=u,T=s,N=s.left+Qf;for(;x.parent;){let B=e<=N,$=t<=T.top||t>=T.bottom;if(!B&&!$)break;let U=Ke(x.parent.id);if(!U)break;let J=m.blocksContainer?.querySelector(`.block[data-block-id="${U.block.id}"]`)?.getBoundingClientRect();x=U,T=J||T,y=x.block.id,g=T,w=(x.ancestors||[]).length,b=x.parent?.id||null,S=h==="after"?x.index+1:x.index}}return{targetId:y,placement:h,parentId:b,index:S,depth:w,rect:g}}function zy(e){if(!m.blocksContainer)return;let t=m.blocksContainer.getBoundingClientRect(),n=60;e.clientY<t.top+n?m.blocksContainer.scrollTop-=12:e.clientY>t.bottom-n&&(m.blocksContainer.scrollTop+=12)}function sp(e){if(!Mt||e.pointerId!==Mt.pointerId)return;if(!ci()){Vc();return}let t=e.clientX-Mt.startX,n=e.clientY-Mt.startY;if(!Mt.dragging){if(Math.hypot(t,n)<Cy)return;Mt.dragging=!0;let o=Mt.pointerType||e.pointerType||"mouse";(o==="touch"||o==="pen")&&document.body.classList.add("block-dnd-active"),Hy(Mt.blockId)}e.preventDefault(),Ry(e);let r=Fy(e.clientX,e.clientY);Mt.lastDrop=r,$y(r),zy(e)}async function Ms(e){if(!Mt||e.pointerId!==Mt.pointerId)return;let t=Mt;Vc();let n=t.dragging&&t.lastDrop,r=t.lastDrop,o=t.blockId;!n||!r||await cs(o,r.parentId||null,r.index,{anchorId:r.targetId,placement:r.placement})}function Ns(){if(!a.article){L("\u041E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E, \u0447\u0442\u043E\u0431\u044B \u043F\u0435\u0440\u0435\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435");return}if(a.isDragModeEnabled=!a.isDragModeEnabled,!a.isDragModeEnabled){Vc(),vr(),L("\u041F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435 \u0432\u044B\u043A\u043B\u044E\u0447\u0435\u043D\u043E");return}if(vr(),a.articleId==="inbox"){L("\u0420\u0435\u0436\u0438\u043C \u0432\u043A\u043B\u044E\u0447\u0451\u043D, \u043D\u043E \u0432 \u0431\u044B\u0441\u0442\u0440\u044B\u0445 \u0437\u0430\u043C\u0435\u0442\u043A\u0430\u0445 \u043F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E");return}if(a.mode!=="view"){L("\u0420\u0435\u0436\u0438\u043C \u0432\u043A\u043B\u044E\u0447\u0451\u043D, \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u0442\u0435 \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435, \u0447\u0442\u043E\u0431\u044B \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u0442\u044C \u0431\u043B\u043E\u043A\u0438");return}L("\u041F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435 \u0432\u043A\u043B\u044E\u0447\u0435\u043D\u043E \u2014 \u043F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435 \u0431\u043B\u043E\u043A \u0437\u0430 \u0435\u0433\u043E \u043F\u043E\u0432\u0435\u0440\u0445\u043D\u043E\u0441\u0442\u044C")}var Cy,Qf,By,Ly,My,Mt,ai,cn,Kr,Ln,Zf,Xf,Ls,li=Fe(()=>{ft();vt();nn();$n();Et();Cy=6,Qf=20,By=.35,Ly=.65,My='button, a, input, textarea, select, [contenteditable="true"], .block-edit-actions, .move-block-btn, .collapse-btn',Mt=null,ai=null,cn=null,Kr=null,Ln=null,Zf=new Map,Xf=!1,Ls=!1});function ap(e){qc=typeof e=="function"?e:null}function Uy(e){let t=new Set,n=r=>{if(Array.isArray(r))for(let o=0;o<r.length;o+=1){let i=r[o];if(!i||!i.id){r.splice(o,1),o-=1;continue}if(t.has(i.id)){r.splice(o,1),o-=1;continue}t.add(i.id),Array.isArray(i.children)&&i.children.length&&n(i.children)}};n(e)}function cp(){if(!m.blocksContainer)return;let e=new Set;m.blocksContainer.querySelectorAll(".block[data-block-id]").forEach(n=>{let r=n.getAttribute("data-block-id");if(r)if(e.has(r)){let o=n.parentNode;o&&o.removeChild(n)}else e.add(r)})}function lp(){if(!m.blocksContainer||!a.article||!Array.isArray(a.article.blocks))return;let e=fn(a.article.blocks),t=new Set(e.map(r=>r.id));m.blocksContainer.querySelectorAll(".block[data-block-id]").forEach(r=>{let o=r.getAttribute("data-block-id");if(o&&!t.has(o)){let i=r.parentNode;i&&i.removeChild(r)}})}function Vo(e,t,n,r){if(!a.article||!e||!e.id)return;let o=Array.isArray(a.article.blockTrash)?a.article.blockTrash:[],i=r||new Date().toISOString();o.push({id:e.id,block:e,parentId:t||null,index:typeof n=="number"?n:null,deletedAt:i}),a.article.blockTrash=o}function to(e){if(!e||!m.blocksContainer)return;m.blocksContainer.querySelectorAll(`.block[data-block-id="${e}"]`).forEach(n=>{let r=n.parentElement;if(!r)return;let o=n.nextElementSibling;if(o&&o.classList.contains("block-children")){let i=o;o=o.nextElementSibling,i.parentNode===r&&r.removeChild(i)}n.parentNode===r&&r.removeChild(n)})}async function Kc(e,t,n=1){for(let r of e){let o=document.createElement("div");o.className="block",o.dataset.blockId=r.id,typeof r.collapsed=="boolean"&&(o.dataset.collapsed=r.collapsed?"true":"false"),(r.id===a.currentBlockId||Array.isArray(a.selectedBlockIds)&&a.selectedBlockIds.includes(r.id))&&o.classList.add("selected"),r.id===a.editingBlockId&&o.classList.add("editing");let s=document.createElement("div");s.className="block-surface";let c=document.createElement("div");c.className="block-content";let d=xn(r.text||""),l=!!d.titleHtml,u=!!(d.bodyHtml&&d.bodyHtml.trim()),f=!!r.children?.length;if(!l&&f){let N=document.createElement("div");N.innerHTML=d.bodyHtml||r.text||"";let B=Array.from(N.childNodes||[]).filter($=>$.nodeType===Node.TEXT_NODE?($.textContent||"").trim().length>0:$.nodeType===Node.ELEMENT_NODE?$.tagName==="BR"?!1:$.tagName==="P"?($.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim().length>0:!0:!1);if(B.length===1){let $=B[0];$.nodeType===Node.ELEMENT_NODE&&$.tagName==="P"&&(d={titleHtml:$.outerHTML,bodyHtml:""},l=!0,u=!1)}}let p=l||f,y=!l&&!f;o.classList.toggle("block--no-title",!l);let b=a.mode==="edit"&&a.editingBlockId===r.id,h=null;if(p||y){let N=document.createElement("button");N.className="collapse-btn",y?(N.classList.add("collapse-btn--placeholder"),N.setAttribute("aria-hidden","true"),N.removeAttribute("aria-expanded"),N.removeAttribute("title")):(N.setAttribute("aria-expanded",r.collapsed?"false":"true"),N.title=r.collapsed?"\u0420\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C":"\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C"),h=document.createElement("div"),h.className="block-header",l||h.classList.add("block-header--no-title");let B=document.createElement("div");if(B.className="block-header__left",B.appendChild(N),l){let $=Math.min(Math.max(n,1),6),U=document.createElement(`h${$}`);U.className="block-title",U.innerHTML=d.titleHtml||"",B.appendChild(U)}else{let $=document.createElement("div");$.className="block-title-spacer",$.style.flex="1",$.style.minWidth="0",B.appendChild($)}h.appendChild(B)}let g=document.createElement("div");g.className="block-text block-body";let w=b?ec(r.text||""):d.bodyHtml||"";if(g.innerHTML=w,(!w||!w.trim())&&(g.classList.add("block-body--empty"),b&&(g.innerHTML="<p><br /></p>")),g.classList.toggle("block-body--no-title",!l),b?(g.setAttribute("contenteditable","true"),g.setAttribute("spellcheck","false"),g.dataset.placeholder="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0442\u0435\u043A\u0441\u0442"):g.removeAttribute("contenteditable"),h&&c.appendChild(h),(b||!l||w)&&c.appendChild(g),a.articleId==="inbox"&&!b){let N=document.createElement("div");N.className="block-footer";let B=document.createElement("button");B.type="button",B.className="ghost small move-block-btn",B.innerHTML="&#10140;",B.title="\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0431\u043B\u043E\u043A \u0432 \u0434\u0440\u0443\u0433\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E",B.addEventListener("click",$=>{$.stopPropagation(),qc?qc(r.id):L("\u041F\u0435\u0440\u0435\u043D\u043E\u0441 \u0431\u043B\u043E\u043A\u0430 \u0432\u0440\u0435\u043C\u0435\u043D\u043D\u043E \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D")}),N.appendChild(B),c.appendChild(N)}if(s.appendChild(c),b&&("ontouchstart"in window||navigator.maxTouchPoints>0)&&c.addEventListener("click",B=>{let $=c.querySelector('.block-text[contenteditable="true"]');$&&($.contains(B.target)||(B.stopPropagation(),$.focus(),a.editingCaretPosition==="start"?($.scrollTop=0,fa($)):Ni($)))}),np(s,r.id),b){let N=document.createElement("div");N.className="block-edit-actions";let B=document.createElement("button");B.type="button",B.className="ghost small block-attach-btn",B.innerHTML='<span class="block-attach-btn__icon">&#xE723;</span><span class="block-attach-btn__label">\u0424\u0430\u0439\u043B</span>',B.title="\u041F\u0440\u0438\u043A\u0440\u0435\u043F\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u0438\u043B\u0438 \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0443",B.addEventListener("click",Y=>{Y.preventDefault(),Y.stopPropagation();let J=o.querySelector('.block-text[contenteditable="true"]');if(!J)return;let re=document.createElement("input");re.type="file",re.multiple=!0,re.style.display="none",re.addEventListener("change",()=>{let he=Array.from(re.files||[]);he.length&&nc(J,he,r.id),re.remove()}),document.body.appendChild(re),re.click()});let $=document.createElement("button");$.type="button",$.className="ghost small",$.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C",$.addEventListener("click",async Y=>{Y.preventDefault(),Y.stopPropagation(),await zo()});let U=document.createElement("button");U.type="button",U.className="ghost small",U.textContent="\u041E\u0442\u043C\u0435\u043D\u0430",U.addEventListener("click",Y=>{Y.preventDefault(),Y.stopPropagation(),Qi()}),N.appendChild(B),N.appendChild($),N.appendChild(U),c.appendChild(N)}rc(g,r.id),o.appendChild(s),o.addEventListener("click",N=>{if(N.stopPropagation(),a.isRagView&&a.ragBlockMap&&a.ragBlockMap[r.id]){let $e=a.ragBlockMap[r.id];if($e&&$e.articleId&&$e.blockId){a.scrollTargetBlockId=$e.blockId,a.currentBlockId=$e.blockId,gt(pt.article($e.articleId));return}}let B=N.target.closest('button, a, [contenteditable="true"], .block-edit-actions'),$=o.querySelector(".block-header"),U=o.querySelector(".block-text.block-body"),Y=!!$,J=!!($&&!$.classList.contains("block-header--no-title")),re=Y&&$.contains(N.target),he=U&&U.contains(N.target),Re=J,G=a.currentBlockId===r.id,ie=!1;(Re&&re||!Re&&G&&he&&!B)&&(ie=!0),ie&&tc(r.id),Sn(r.id)}),s.addEventListener("dblclick",N=>{if(a.mode!=="view"||a.isPublicView||a.isRagView)return;let B=N.target.closest('button, a, [contenteditable="true"]');B&&!B.matches('.block-text[contenteditable="true"]')||(N.stopPropagation(),Sn(r.id),Gi())});let x=r.collapsed&&r.id!==a.editingBlockId&&l;g.classList.contains("block-body--empty")||g.classList.toggle("collapsed",x);let T=null;r.children?.length>0&&!r.collapsed&&(T=document.createElement("div"),T.className="block-children",await Kc(r.children,T,n+1)),t.appendChild(o),T&&(b?t.appendChild(T):o.appendChild(T))}}function ls(e,t){if(!e||!["up","down"].includes(t))return!1;let n=document.querySelector(`.block[data-block-id="${e}"]`);if(!n||n.classList.contains("editing"))return!1;let r=n.parentElement;if(!r)return!1;if(t==="up"){let s=n.previousElementSibling;for(;s&&!s.classList.contains("block");)s=s.previousElementSibling;return s?(r.insertBefore(n,s),!0):!1}let o=n.nextElementSibling;for(;o&&!o.classList.contains("block");)o=o.nextElementSibling;if(!o)return!1;let i=o.nextSibling;return i?r.insertBefore(n,i):r.appendChild(n),!0}async function yt(e){if(!a.article||!Array.isArray(a.article.blocks))return;let t=Ke(e);if(!t)return;let n=(Array.isArray(t.ancestors)?t.ancestors.length:0)+1,r=document.querySelector(`.block[data-block-id="${e}"]`);if(!r)return;let o=r.parentElement;if(!o)return;let i=[],s=r.nextElementSibling;s&&s.classList.contains("block-children")&&i.push(s);let c=(i[i.length-1]||r).nextSibling;o.removeChild(r),i.forEach(u=>{u.parentNode===o&&o.removeChild(u)});let d=document.createElement("div");await Kc([t.block],d,n),Array.from(d.childNodes).forEach(u=>{o.insertBefore(u,c)}),cp(),lp()}function nt(){let e=a.article;if(!e)return;if(!a.isPublicView&&!a.isRagView&&a.isOutlineEditing){wt(),gn();return}Array.isArray(e.blocks)&&Uy(e.blocks),wt();let t=e.id==="inbox"?[...e.blocks||[]].reverse():e.blocks;gn(),m.blocksContainer.innerHTML="",vr(),ip(),op();let n=()=>{if(a.mode!=="edit"||!a.editingBlockId||a.editingCaretPosition==="start")return;let r=m.blocksContainer?.querySelector(`.block[data-block-id="${a.editingBlockId}"] .block-text[contenteditable="true"]`);if(!r)return;let o=document.activeElement;r===o||r.contains(o)||(r.focus({preventScroll:!0}),r.scrollHeight>r.clientHeight&&(r.scrollTop=r.scrollHeight),Ni(r))};Kc(t,m.blocksContainer).then(()=>{if(lp(),cp(),Nu(),a.scrollTargetBlockId&&a.mode==="view"){let r=a.scrollTargetBlockId;requestAnimationFrame(()=>{let o=document.querySelector(`.block[data-block-id="${r}"]`);if(o){(o.querySelector(".block-content")||o).scrollIntoView({behavior:"smooth",block:"nearest"});let s=o.querySelector('.block-text[contenteditable="true"]');s&&a.mode==="edit"&&a.editingBlockId===r?(s.focus({preventScroll:!0}),a.editingCaretPosition==="start"?(s.scrollTop=0,fa(s)):Ni(s)):(o.setAttribute("tabindex","-1"),o.focus({preventScroll:!0}))}a.currentBlockId=r,a.scrollTargetBlockId=null})}n(),a.mode==="edit"&&typeof a.editingScrollTop=="number"&&m.blocksContainer&&(m.blocksContainer.scrollTop=a.editingScrollTop)})}var qc,Jc=Fe(()=>{ft();vt();Pt();Et();Rn();eo();bn();nn();nn();tn();$n();wn();So();li();qc=null});async function Vy(e){try{let n=(a.articlesIndex.length?a.articlesIndex:await yn()).filter(u=>u.id!=="inbox"),r=n.map(u=>({id:u.id,title:u.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),o=await Gt({title:"\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0432 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0438\u043B\u0438 \u0432\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E",confirmText:"\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:r,returnMeta:!0,hideConfirm:!1}),s=(o?.selectedId||(typeof o=="object"?o?.value:o)||""||"").trim();if(!s)return;let c=s.toLowerCase(),d=n.find(u=>u.id&&u.id.toLowerCase()===c||(u.title||"").toLowerCase()===c),l=d?d.id:s;if(!l||l==="inbox"){L("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}await apiRequest(`/api/articles/${a.articleId}/blocks/${e}/move-to/${l}`,{method:"POST"}),await Ht("inbox",{resetUndoStacks:!0}),nt(),L("\u0411\u043B\u043E\u043A \u043F\u0435\u0440\u0435\u043D\u0435\u0441\u0451\u043D")}catch(t){L(t.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0431\u043B\u043E\u043A")}}async function Ps(){if(a.isMergingBlocks)return;if(!a.article||!Array.isArray(a.article.blocks)||!a.article.blocks.length){L("\u041D\u0435\u0442 \u0431\u043B\u043E\u043A\u043E\u0432 \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u044F");return}let e=Array.isArray(a.selectedBlockIds)?a.selectedBlockIds:[];if(!e.length){L("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A\u0438 (Shift+\u2191/\u2193), \u043A\u043E\u0442\u043E\u0440\u044B\u0435 \u043D\u0443\u0436\u043D\u043E \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0438\u0442\u044C");return}let n=fn(a.article.blocks).filter(l=>e.includes(l.id));if(n.length<2){L("\u0414\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u044F \u043D\u0443\u0436\u043D\u043E \u0432\u044B\u0431\u0440\u0430\u0442\u044C \u043A\u0430\u043A \u043C\u0438\u043D\u0438\u043C\u0443\u043C \u0434\u0432\u0430 \u0431\u043B\u043E\u043A\u0430");return}let r=n[0],o=n.slice(1),i=new Set(o.map(l=>l.id)),s=o.filter(l=>{let u=Ke(l.id,a.article?.blocks||[]);return u?!u.ancestors?.some(f=>i.has(f.id)):!1}),c=[];r.text&&c.push(r.text),o.forEach(l=>{l.text&&c.push(l.text)});let d=c.join("");a.isMergingBlocks=!0,m.mergeBlocksBtn&&(m.mergeBlocksBtn.disabled=!0),L("\u041E\u0431\u044A\u0435\u0434\u0438\u043D\u044F\u0435\u043C \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u044B\u0435 \u0431\u043B\u043E\u043A\u0438...");try{await apiRequest(`/api/articles/${a.articleId}/blocks/${r.id}`,{method:"PATCH",body:JSON.stringify({text:d})});for(let l of s)await apiRequest(`/api/articles/${a.articleId}/blocks/${l.id}`,{method:"DELETE"});await Ht(a.articleId,{resetUndoStacks:!1}),nt(),a.mode="view",a.editingBlockId=null,a.pendingEditBlockId=null,Sn(r.id),L("\u0411\u043B\u043E\u043A\u0438 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0435\u043D\u044B \u0432 \u043E\u0434\u0438\u043D")}catch(l){L(l.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438")}finally{a.isMergingBlocks=!1,m.mergeBlocksBtn&&(m.mergeBlocksBtn.disabled=!1)}}async function Ds(e){a.isPublicView=!1,a.isRagView=!1,document.body.classList.remove("public-embedded"),a.isEditingTitle=!1,await nr(),Ro(!0),m.usersView&&m.usersView.classList.add("hidden"),m.blocksContainer.innerHTML="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...";try{if(e==="RAG"){a.isRagView=!0,a.mode="view",a.editingBlockId=null,a.pendingEditBlockId=null,a.scrollTargetBlockId=null,a.ragBlockMap={},ji("RAG");let r=(a.ragQuery||"").trim(),o=Array.isArray(a.ragResults)?a.ragResults:[],i=o.length,s=Array.from(new Set(o.map(f=>f&&f.articleTitle?String(f.articleTitle):"").filter(Boolean))),c=s.slice(0,8),d=["<p><strong>\u0421\u0432\u043E\u0434\u043A\u0430</strong></p>"];a.ragSummaryLoading?d.push('<p class="meta">\u0413\u0435\u043D\u0435\u0440\u0438\u0440\u0443\u044E \u0441\u0432\u043E\u0434\u043A\u0443\u2026</p>'):a.ragSummaryError?d.push(`<p class="meta">\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0432\u043E\u0434\u043A\u0438: ${a.ragSummaryError}</p>`):a.ragSummaryHtml?d.push(a.ragSummaryHtml):d.push('<p class="meta">\u0421\u0432\u043E\u0434\u043A\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435 \u0433\u043E\u0442\u043E\u0432\u0430.</p>');let l=["<p><strong>AI-\u043F\u043E\u0438\u0441\u043A: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B</strong></p>",`<p><span class="meta">\u0417\u0430\u043F\u0440\u043E\u0441:</span> ${r||"\u2014"}</p>`,`<p><span class="meta">\u041D\u0430\u0439\u0434\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432:</span> ${i}</p>`];c.length&&l.push(`<p><span class="meta">\u0421\u0442\u0430\u0442\u044C\u0438:</span> ${c.join(" \xB7 ")}</p>`),s.length>c.length&&l.push(`<p><span class="meta">\u2026\u0438 \u0435\u0449\u0451:</span> ${s.length-c.length}</p>`);let u=[{id:"rag-ai-summary",text:d.join(""),children:[],collapsed:!1},{id:"rag-meta",text:l.join(""),children:[],collapsed:!1},...o.filter(f=>f&&f.type==="block").map((f,p)=>{let y=f.blockText||"",b=f.articleTitle?String(f.articleTitle):"",h=b?`<p><strong>${b}</strong></p>`:`<p><strong>\u0420\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442 ${p+1}</strong></p>`,g=`rag-${f.blockId||p}`;return f.articleId&&f.blockId&&(a.ragBlockMap[g]={articleId:f.articleId,blockId:f.blockId}),{id:g,text:`${h}${y}`,children:[],collapsed:!1}})];a.article={id:"RAG",title:r?`AI: ${r}`:"AI: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B \u043F\u043E\u0438\u0441\u043A\u0430",blocks:u,updated_at:new Date().toISOString()},a.articleId="RAG",a.currentBlockId=u[0]?.id||null,nt();return}let t=a.pendingEditBlockId||void 0,n=a.scrollTargetBlockId||void 0;if(await Ht(e,{resetUndoStacks:!0,desiredBlockId:n,editBlockId:t}),nt(),ji(e),e==="inbox"&&navigator.onLine&&a.serverStatus==="ok")try{await gc().catch(()=>{}),a.articleId==="inbox"&&!a.editingBlockId&&(await Ht("inbox",{resetUndoStacks:!1}),nt())}catch{}}catch(t){m.blocksContainer.innerHTML=`<p class="meta">\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u044C\u044E: ${t.message}</p>`}}async function _s(){a.isPublicView=!1,a.isRagView=!1,document.body.classList.remove("public-embedded"),m.usersView&&m.usersView.classList.add("hidden"),a.article=null,a.articleId=null,a.currentBlockId=null,a.isEditingTitle=!1,a.mode="view",a.editingBlockId=null,a.undoStack=[],a.redoStack=[],a.pendingEditBlockId=null,Wn({restoreDom:!1}),Ro(!1),vr();try{if(a.isTrashView){let e=await Ki();qt(e)}else{let e=await nr();qt(e)}}catch(e){m.articleList.innerHTML=`<li>\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u043F\u0438\u0441\u043E\u043A: ${e.message}</li>`}}async function Os(e){a.isPublicView=!0,a.isRagView=!1,document.body.classList.add("public-embedded"),m.usersView&&m.usersView.classList.add("hidden"),Ro(!0),a.isEditingTitle=!1,a.mode="view",a.editingBlockId=null,a.pendingEditBlockId=null,a.selectionAnchorBlockId=null,a.selectedBlockIds=[],a.undoStack=[],a.redoStack=[],Wn({restoreDom:!1}),m.blocksContainer&&(m.blocksContainer.innerHTML="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...");try{let t=await apiRequest(`/api/public/articles/${encodeURIComponent(e)}`,{method:"GET",credentials:"omit"});a.article=t,a.articleId=t?.id||null;let n=fn(t?.blocks||[])[0];a.currentBlockId=n?n.id:null,nt()}catch(t){m.blocksContainer&&(m.blocksContainer.innerHTML=`<p class="meta">\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E: ${t.message}</p>`)}}async function di(){m.createArticleBtn&&(m.createArticleBtn.disabled=!0),m.sidebarNewArticleBtn&&(m.sidebarNewArticleBtn.disabled=!0);try{let e="";try{e=await Gt({title:"\u041D\u043E\u0432\u0430\u044F \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0430",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0437\u0430\u0433\u043E\u043B\u043E\u0432\u043E\u043A \u0434\u043B\u044F \u043D\u043E\u0432\u043E\u0439 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B.",confirmText:"\u0421\u043E\u0437\u0434\u0430\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"\u0417\u0430\u0433\u043E\u043B\u043E\u0432\u043E\u043A \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B",defaultValue:""})}catch{e=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0437\u0430\u0433\u043E\u043B\u043E\u0432\u043E\u043A \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B")||""}if(e=(e||"").trim(),!e)return;let t=await Gl(e);Bn(t),a.pendingEditBlockId=t?.blocks?.[0]?.id||null,a.scrollTargetBlockId=a.pendingEditBlockId,gt(pt.article(t.id)),L("\u0421\u0442\u0430\u0442\u044C\u044F \u0441\u043E\u0437\u0434\u0430\u043D\u0430")}catch(e){L(e.message)}finally{m.createArticleBtn&&(m.createArticleBtn.disabled=!1),m.sidebarNewArticleBtn&&(m.sidebarNewArticleBtn.disabled=!1)}}async function Rs(){gt(pt.article("inbox"))}async function Hs(){try{let e=pt.article("inbox");a.articleId==="inbox"&&window.location.pathname===e||gt(e);let n=await Promise.resolve().then(()=>(ar(),sr)),r=null,o=performance.now()+15e3;for(;!r&&performance.now()<o;){if(!(a.articleId==="inbox"&&a.article&&(String(a.article.id||"")==="inbox"||String(a.article.id||"").startsWith("inbox-"))&&String(a.article.title||"")==="\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438")){await new Promise(s=>setTimeout(s,50));continue}if(a.article?.encrypted){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u0437\u0430\u043C\u0435\u0442\u043A\u0443 (\u0438\u043D\u0431\u043E\u043A\u0441 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D)");return}r=n?.insertNewOutlineSectionAtStart?.({enterEditMode:!0})||null,r||await new Promise(s=>setTimeout(s,50))}if(!r){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u0437\u0430\u043C\u0435\u0442\u043A\u0443");return}a.currentBlockId=r;try{n?.enterOutlineSectionEditMode?.(r,{focusBody:!0})}catch{}}catch(e){L(e.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u0437\u0430\u043C\u0435\u0442\u043A\u0443")}}var dp=Fe(()=>{ft();vt();Pt();Et();Rn();wn();tn();tn();tn();$n();nn();Uc();Jc();li();ao();ap(Vy)});var $u={};Vn($u,{createArticle:()=>di,createInboxNote:()=>Hs,loadArticle:()=>Ht,loadArticleView:()=>Ds,loadListView:()=>_s,loadPublicArticleView:()=>Os,mergeAllBlocksIntoFirst:()=>Ps,openInboxArticle:()=>Rs,pushLocalBlockTrashEntry:()=>Vo,removeArticleEncryption:()=>Xi,removeDomBlockById:()=>to,renderArticle:()=>nt,reorderDomBlock:()=>ls,rerenderSingleBlock:()=>yt,toggleArticleEncryption:()=>Yi,toggleDragMode:()=>Ns,updateArticleHeaderUi:()=>gn});var jn=Fe(()=>{So();za();Uc();Jc();dp();li();li();vr()});function gt(e){if(window.location.pathname===e){yo(e);return}window.history.pushState({},"",e),yo(e)}function yo(e){let t=e.match(/^\/p\/([^/?#]+)/);if(t){Os(decodeURIComponent(t[1]));return}let n=e.match(/^\/article\/([0-9a-zA-Z-]+)/);if(n){Ds(n[1]);return}_s()}function jc(){window.addEventListener("popstate",()=>yo(window.location.pathname))}var pt,wn=Fe(()=>{jn();pt={list:"/",article:e=>`/article/${e}`,public:e=>`/p/${e}`}});var Mp={};Vn(Mp,{exportCurrentArticleAsHtml:()=>Yy,exportCurrentBlockAsHtml:()=>Xy});async function Yy(){if(!a.article||!a.articleId){L("\u041D\u0435\u0442 \u043E\u0442\u043A\u0440\u044B\u0442\u043E\u0439 \u0441\u0442\u0430\u0442\u044C\u0438 \u0434\u043B\u044F \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0430");return}try{L("\u0413\u043E\u0442\u043E\u0432\u0438\u043C \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u2026");let e=await fetch(`/api/articles/${encodeURIComponent(a.articleId)}/export/html`,{credentials:"include",cache:"no-store"});if(!e.ok)throw new Error(`\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u044B\u0433\u0440\u0443\u0437\u0438\u0442\u044C HTML (HTTP ${e.status})`);let t=await e.text();Lp(t,Tp(a.article.title||"article")),L("HTML \u0441\u043E\u0445\u0440\u0430\u043D\u0451\u043D")}catch(e){console.error("Export failed",e),L(e.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u044B\u0433\u0440\u0443\u0437\u0438\u0442\u044C HTML")}}async function Xy(e){if(a.article?.docJson||a.isOutlineEditing){L("\u042D\u043A\u0441\u043F\u043E\u0440\u0442 \u0444\u0440\u0430\u0433\u043C\u0435\u043D\u0442\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0432 outline \u0440\u0435\u0436\u0438\u043C\u0435");return}if(!a.article){L("\u041D\u0435\u0442 \u043E\u0442\u043A\u0440\u044B\u0442\u043E\u0439 \u0441\u0442\u0430\u0442\u044C\u0438 \u0434\u043B\u044F \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0430");return}let t=e||a.currentBlockId;if(!t){L("\u041D\u0435 \u0432\u044B\u0431\u0440\u0430\u043D \u0431\u043B\u043E\u043A \u0434\u043B\u044F \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0430");return}let n=Ke(t);if(!n||!n.block){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u044B\u0439 \u0431\u043B\u043E\u043A");return}let r=n.block,{titleHtml:o}=xn(r.text||""),i="";o?i=Bo(o):r.text&&(i=Bo(r.text).slice(0,80)),i||(i="\u0424\u0440\u0430\u0433\u043C\u0435\u043D\u0442");let s=a.article.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",c=`${i} \u2014 \u0444\u0440\u0430\u0433\u043C\u0435\u043D\u0442 \u0438\u0437 \xAB${s}\xBB`;try{L("\u0413\u043E\u0442\u043E\u0432\u0438\u043C \u044D\u043A\u0441\u043F\u043E\u0440\u0442 \u0444\u0440\u0430\u0433\u043C\u0435\u043D\u0442\u0430...");let d=await Gy(),{bodyHtml:l,plainText:u,wordCount:f}=Zy([r],{title:i,updatedAt:a.article.updatedAt||null,suppressRootTitleInBody:!0}),{html:p,failures:y}=await tb(l),b=Qy(u),h={...a.article,blocks:[r],title:c},g=eb(h),w=nb({cssText:d,contentHtml:p,title:c,description:b,article:h,wordCount:f,lang:document.documentElement.lang||"ru",exportPayload:g});Lp(w,Tp(i||"fragment")),y.length?(L(`\u042D\u043A\u0441\u043F\u043E\u0440\u0442 \u0444\u0440\u0430\u0433\u043C\u0435\u043D\u0442\u0430 \u0437\u0430\u0432\u0435\u0440\u0448\u0451\u043D \u0441 \u043F\u0440\u0435\u0434\u0443\u043F\u0440\u0435\u0436\u0434\u0435\u043D\u0438\u044F\u043C\u0438: ${y.length} \u0432\u043B\u043E\u0436\u0435\u043D\u0438\u0439 \u043D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u043D\u043B\u0430\u0439\u043D\u0438\u0442\u044C`),console.warn("Inline failures (fragment export)",y)):L("\u0424\u0440\u0430\u0433\u043C\u0435\u043D\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0451\u043D \u0432 HTML")}catch(d){console.error("Export fragment failed",d),L(d.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u044B\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0440\u0430\u0433\u043C\u0435\u043D\u0442 \u0432 HTML")}}async function Gy(){let e=await fetch("/style.css",{cache:"no-cache"});if(!e.ok)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0438\u043B\u0438 \u0434\u043B\u044F \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0430");return e.text()}function Qy(e=""){if(!e)return"";let t=e.trim().replace(/\s+/g," ");return t.length<=Ep?t:`${t.slice(0,Ep).trimEnd()}\u2026`}function Tp(e=""){return`${(e||"article").toLowerCase().replace(/[^a-z0-9\u0400-\u04ff]+/gi,"-").replace(/^-+|-+$/g,"").slice(0,60)||"article"}.html`}function Cp(e=[]){let t=[];return e.forEach(n=>{n?.text&&t.push(Bo(n.text)),n?.children?.length&&t.push(Cp(n.children))}),t.flat().filter(Boolean)}function Bp(e,t=1,n={}){let r=!!n.suppressTitle,o=xn(e.text||""),i=!!o.titleHtml,s=!!e.children?.length;if(!i&&s&&typeof document<"u"){let U=document.createElement("div");U.innerHTML=o.bodyHtml||e.text||"";let Y=Array.from(U.childNodes||[]).filter(J=>J.nodeType===Node.TEXT_NODE?(J.textContent||"").trim().length>0:J.nodeType===Node.ELEMENT_NODE?J.tagName==="BR"?!1:J.tagName==="P"?(J.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim().length>0:!0:!1);if(Y.length===1){let J=Y[0];J.nodeType===Node.ELEMENT_NODE&&J.tagName==="P"&&(o={titleHtml:J.outerHTML,bodyHtml:""},i=!0)}}let c=i?o.bodyHtml:e.text||"",d=i&&!r,l=!!(c&&c.trim()),u=d||s,f=!d&&!s,p=!!e.collapsed,y="";(u||f)&&(f?y='<button class="collapse-btn collapse-btn--placeholder" type="button" aria-hidden="true"></button>':y=`<button class="collapse-btn" type="button" data-block-id="${e.id}" aria-expanded="${p?"false":"true"}"></button>`);let b="";if(d){let Y=`h${Math.min(Math.max(t,1),6)}`;b=`<${Y} class="block-title">${o.titleHtml}</${Y}>`}let h=b?`<div class="block-header${d?"":" block-header--no-title"}">${b}</div>`:"",g=["block-text","block-body"];d||g.push("block-body--no-title"),l||g.push("block-body--empty"),p&&d&&g.push("collapsed");let w=`<div class="${g.join(" ")}" data-block-body>${c||""}</div>`,S=`<div class="block-content">${h}${w}</div>`,x=d?t+1:t,T=(e.children||[]).map(U=>Bp(U,x)).join(""),N=`<div class="block-children${p?" collapsed":""}" data-children>${T}</div>`,B=["block"];d||B.push("block--no-title");let $=`<div class="block-surface">${y}${S}</div>`;return`<div class="${B.join(" ")}" data-block-id="${e.id}" data-collapsed="${p?"true":"false"}" tabindex="0">${$}${N}</div>`}function Zy(e=[],{title:t,updatedAt:n,suppressRootTitleInBody:r}={}){let o=e||[],i=o.map((p,y)=>Bp(p,1,{suppressTitle:!!(r&&y===0)})).join(""),c=Cp(o).join(" ").replace(/\s+/g," ").trim(),d=c?c.split(/\s+/).length:0,l=n?new Date(n).toLocaleString():"";return{bodyHtml:`
    <section aria-label="\u042D\u043A\u0441\u043F\u043E\u0440\u0442 \u0441\u0442\u0430\u0442\u044C\u0438">
      ${`
    <div class="panel-header article-header">
      <div class="title-block">
        <div class="title-row">
          <h1>${it(t||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F")}</h1>
        </div>
        ${l?`<p class="meta">\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${it(l)}</p>`:""}
      </div>
    </div>
  `}
      <div id="exportBlocksRoot" class="blocks" role="tree">
        ${i}
      </div>
    </section>
  `,plainText:c,wordCount:d}}function eb(e){if(!e)return{version:1,source:"memus",article:null,blocks:[]};let t=(n=[])=>(n||[]).map(r=>({id:r.id,text:r.text||"",collapsed:!!r.collapsed,children:t(r.children||[])}));return{version:1,source:"memus",article:{id:e.id,title:e.title||"",createdAt:e.createdAt||null,updatedAt:e.updatedAt||null,deletedAt:e.deletedAt||null,isInbox:e.id==="inbox",encrypted:!!e.encrypted,encryptionHint:e.encryptionHint||null},blocks:t(e.blocks||[])}}async function tb(e){let t=document.createElement("template");t.innerHTML=e;let n=new Map,r=[],o=async l=>{if(n.has(l))return n.get(l);let u=new URL(l,window.location.href).toString(),f=fetch(u).then(async p=>{if(!p.ok)throw new Error(`\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0440\u0435\u0441\u0443\u0440\u0441 ${l}`);return p.blob()});return n.set(l,f),f},i=l=>new Promise((u,f)=>{let p=new FileReader;p.onloadend=()=>u(p.result),p.onerror=f,p.readAsDataURL(l)}),s=async l=>{let u=URL.createObjectURL(l);try{let f=await new Promise((h,g)=>{let w=new Image;w.onload=()=>h(w),w.onerror=g,w.crossOrigin="anonymous",w.src=u}),p=document.createElement("canvas");p.width=f.naturalWidth||f.width||1,p.height=f.naturalHeight||f.height||1,p.getContext("2d").drawImage(f,0,0);let b=p.toDataURL("image/webp",Wy);if(!b||b==="data:,")throw new Error("Canvas returned empty webp");return b}finally{URL.revokeObjectURL(u)}},c=Array.from(t.content.querySelectorAll("img"));await Promise.all(c.map(async l=>{let u=l.getAttribute("src")||"";if(!(!u||u.startsWith("data:")))try{let f=await o(u);try{let p=await s(f);l.setAttribute("data-original-src",u),l.setAttribute("src",p)}catch(p){console.warn("WebP convert failed, fallback to base64",p);let y=await i(f);l.setAttribute("data-original-src",u),l.setAttribute("src",y)}}catch(f){console.warn("Inline image failed",u,f),r.push(u)}}));let d=Array.from(t.content.querySelectorAll("a")).filter(l=>{let u=l.getAttribute("href")||"";return!u||u.startsWith("#")||u.startsWith("mailto:")||u.startsWith("data:")?!1:l.classList.contains("attachment-link")?!0:u.startsWith("/uploads")||u.includes("/uploads/")});return await Promise.all(d.map(async l=>{let u=l.getAttribute("href")||"";if(!(!u||u.startsWith("data:")))try{let f=await o(u),p=await i(f);l.setAttribute("data-original-href",u),l.setAttribute("href",p)}catch(f){console.warn("Inline attachment failed",u,f),r.push(u)}})),{html:t.innerHTML,failures:r}}function nb({cssText:e,contentHtml:t,title:n,description:r,article:o,wordCount:i,lang:s,exportPayload:c}){let d=o.updatedAt||"",l=o.createdAt||d||"",u={"@context":"https://schema.org","@type":"Article",headline:n,description:r,dateModified:d,datePublished:l,wordCount:i,inLanguage:s||"ru"};return`
<!doctype html>
<html lang="${it(s||"ru")}">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>${it(n)}</title>
  <link rel="icon" href="/icons/favicon.ico" type="image/x-icon" />
  <meta name="description" content="${it(r||n)}" />
  <meta name="x-memus-export" content="memus;v=1" />
  <meta name="robots" content="index,follow" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="${it(n)}" />
  <meta property="og:description" content="${it(r||n)}" />
  <meta name="twitter:card" content="summary_large_image" />
  <style>
${e}

    body.export-page {
      margin: 0;
      background: #eef2f8;
    }
    .block-children.collapsed {
      display: none;
    }
    .block {
      cursor: default;
    }
    body.export-page .title-row h1 {
      margin: 0;
    }
  
  </style>
  <script type="application/ld+json">
${JSON.stringify(u,null,2)}
  <\/script>
</head>
<body class="export-page export-static">
<div class="page">
<script type="application/json" id="memus-export">
${JSON.stringify(c||null,null,2)}
<\/script>
${t}
</div>
<script>
(() => {
  const root = document.getElementById('exportBlocksRoot');
  if (!root) return;
  const collapseIcon = { open: '${jy}', closed: '${Jy}' };
  let currentId = root.querySelector('.block')?.dataset.blockId || null;

  const getParentBlock = (block) => (block?.parentElement ? block.parentElement.closest('.block') : null);

  const updateBlockView = (block, collapsed) => {
    block.dataset.collapsed = collapsed ? 'true' : 'false';
    const body = block.querySelector('.block-body');
    const noTitle = block.classList.contains('block--no-title');
    if (body && !noTitle) {
      body.classList.toggle('collapsed', collapsed);
    }
    const children = block.querySelector('.block-children');
    if (children) children.classList.toggle('collapsed', collapsed);
    const btn = block.querySelector('.collapse-btn');
    if (btn) {
      btn.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
      btn.textContent = collapsed ? collapseIcon.closed : collapseIcon.open;
    }
  };

  const collectVisible = () => {
    const result = [];
    const walk = (container) => {
      const blocks = Array.from(container.children).filter((node) => node.classList?.contains('block'));
      blocks.forEach((block) => {
        result.push(block);
        const isCollapsed = block.dataset.collapsed === 'true';
        const children = block.querySelector('.block-children');
        if (!isCollapsed && children) walk(children);
      });
    };
    walk(root);
    return result;
  };

  const setCurrent = (block) => {
    if (!block) return;
    currentId = block.dataset.blockId || null;
    root.querySelectorAll('.block.selected').forEach((el) => el.classList.remove('selected'));
    block.classList.add('selected');
    block.focus({ preventScroll: false });
  };

  const toggleBlock = (block, desired) => {
    if (!block) return;
    const collapsed = block.dataset.collapsed === 'true';
    const next = typeof desired === 'boolean' ? desired : !collapsed;
    updateBlockView(block, next);
  };

  const moveSelection = (offset) => {
    if (!currentId) {
      const first = root.querySelector('.block');
      if (first) setCurrent(first);
      return;
    }
    const ordered = collectVisible();
    const index = ordered.findIndex((b) => b.dataset.blockId === currentId);
    if (index === -1) return;
    const next = ordered[index + offset];
    if (next) setCurrent(next);
  };

  const scrollCurrentBlockStep = (direction) => {
    if (!currentId) return false;
    const el =
      root.querySelector(\`.block[data-block-id="\${currentId}"] > .block-surface\`) ||
      root.querySelector(\`.block[data-block-id="\${currentId}"]\`);
    if (!el) return false;
    const rect = el.getBoundingClientRect();
    const margin = 24;
    const visibleHeight = window.innerHeight - margin * 2;
    if (visibleHeight <= 0) return false;
    if (rect.height <= visibleHeight) return false;
    if (direction === 'down') {
      const bottomLimit = window.innerHeight - margin;
      if (rect.bottom <= bottomLimit) return false;
      const delta = rect.bottom - bottomLimit;
      const baseStep = Math.min(Math.max(delta, 40), 160);
      const step = Math.max(24, Math.round(baseStep / 3));
      window.scrollBy({ top: step, behavior: 'smooth' });
      return true;
    }
    if (direction === 'up') {
      const topLimit = margin;
      if (rect.top >= topLimit) return false;
      const delta = topLimit - rect.top;
      const baseStep = Math.min(Math.max(delta, 40), 160);
      const step = Math.max(24, Math.round(baseStep / 3));
      window.scrollBy({ top: -step, behavior: 'smooth' });
      return true;
    }
    return false;
  };

  const handleArrowLeft = () => {
    if (!currentId) return;
    const block = root.querySelector(\`.block[data-block-id="\${currentId}"]\`);
    if (!block) return;
    const collapsed = block.dataset.collapsed === 'true';
    if (!collapsed) {
      toggleBlock(block, true);
      return;
    }
    const parent = getParentBlock(block);
    if (parent) setCurrent(parent);
  };

  const handleArrowRight = () => {
    if (!currentId) return;
    const block = root.querySelector(\`.block[data-block-id="\${currentId}"]\`);
    if (!block) return;
    const collapsed = block.dataset.collapsed === 'true';
    const firstChild = block.querySelector('.block-children .block');
    if (collapsed) {
      toggleBlock(block, false);
      if (firstChild) setCurrent(firstChild);
      return;
    }
    if (firstChild) {
      setCurrent(firstChild);
    }
  };

  root.addEventListener('click', (event) => {
    const btn = event.target.closest('.collapse-btn');
    if (btn) {
      const targetId = btn.dataset.blockId;
      const block = root.querySelector(\`.block[data-block-id="\${targetId}"]\`);
      toggleBlock(block);
      setCurrent(block);
      return;
    }
    const block = event.target.closest('.block');
    if (block) {
      const isInteractive = event.target.closest('a, button, input, textarea, select');
      if (!isInteractive) {
        const header = block.querySelector('.block-header');
        const body = block.querySelector('.block-text.block-body');
        const bodyHasNoTitle = body?.classList.contains('block-body--no-title');
        const clickedInHeader = header && header.contains(event.target);
        const clickedInBody = body && body.contains(event.target);
        const hasLogicalTitle = Boolean(header && !bodyHasNoTitle);
        let shouldToggle = false;
        if (hasLogicalTitle && clickedInHeader) {
          shouldToggle = true;
        } else if (!hasLogicalTitle && clickedInBody) {
          shouldToggle = true;
        }
        if (shouldToggle) {
          toggleBlock(block);
        }
      }
      setCurrent(block);
    }
  });

  function scrollCurrentBlockStep(direction) {
    if (!currentId) return false;
    const el =
      root.querySelector('.block[data-block-id="' + currentId + '"] > .block-surface') ||
      root.querySelector('.block[data-block-id="' + currentId + '"]');
    if (!el) return false;
    const rect = el.getBoundingClientRect();
    const margin = 24;
    const visibleHeight = window.innerHeight - margin * 2;
    if (visibleHeight <= 0) return false;
    if (rect.height <= visibleHeight) return false;
    if (direction === 'down') {
      const bottomLimit = window.innerHeight - margin;
      if (rect.bottom <= bottomLimit) return false;
      const delta = rect.bottom - bottomLimit;
      const baseStep = Math.min(Math.max(delta, 40), 160);
      const step = Math.max(24, Math.round(baseStep / 3));
      window.scrollBy({ top: step, behavior: 'smooth' });
      return true;
    }
    if (direction === 'up') {
      const topLimit = margin;
      if (rect.top >= topLimit) return false;
      const deltaUp = topLimit - rect.top;
      const baseStepUp = Math.min(Math.max(deltaUp, 40), 160);
      const stepUp = Math.max(24, Math.round(baseStepUp / 3));
      window.scrollBy({ top: -stepUp, behavior: 'smooth' });
      return true;
    }
    return false;
  }

  document.addEventListener('keydown', (event) => {
    if (['ArrowDown', 'ArrowUp', 'ArrowLeft', 'ArrowRight', 'Enter', 'Space', ' '].includes(event.code)) {
      event.preventDefault();
    } else {
      return;
    }
    if (event.code === 'ArrowDown') {
      const scrolled = scrollCurrentBlockStep('down');
      if (!scrolled) moveSelection(1);
      return;
    }
    if (event.code === 'ArrowUp') {
      const scrolled = scrollCurrentBlockStep('up');
      if (!scrolled) moveSelection(-1);
      return;
    }
    if (event.code === 'ArrowLeft') {
      handleArrowLeft();
      return;
    }
    if (event.code === 'ArrowRight') {
      handleArrowRight();
      return;
    }
    if (event.code === 'Enter' || event.code === 'Space' || event.code === ' ') {
      if (!currentId) return;
      const block = root.querySelector(\`.block[data-block-id="\${currentId}"]\`);
      toggleBlock(block);
    }
  });

  const initial = currentId ? root.querySelector(\`.block[data-block-id="\${currentId}"]\`) : root.querySelector('.block');
  if (initial) setCurrent(initial);
})();
<\/script>
</body>
</html>
`}function Lp(e,t){let n=new Blob([e],{type:"text/html"}),r=URL.createObjectURL(n),o=document.createElement("a");o.href=r,o.download=t,o.rel="noopener",o.click(),setTimeout(()=>URL.revokeObjectURL(r),0)}var Ep,Jy,jy,Wy,Np=Fe(()=>{ft();nn();bn();Et();Ep=160,Jy="\u25B8",jy="\u25BE",Wy=.82});var tm={};Vn(tm,{initGraphView:()=>xb,openGraphView:()=>em});function Ks(){if(typeof window>"u")return null;let e=window.vis;return!e||!e.Network?null:e}function gb(){return fi||(fi=new Promise((e,t)=>{try{if(document.querySelector('link[data-vis-network-css="1"]')){e();return}let r=document.createElement("link");r.rel="stylesheet",r.href="https://unpkg.com/vis-network@9.1.6/styles/vis-network.min.css",r.dataset.visNetworkCss="1",r.onload=()=>e(),r.onerror=()=>t(new Error("vis-network css load failed")),document.head.appendChild(r)}catch(n){t(n)}}).finally(()=>{document.querySelector('link[data-vis-network-css="1"]')||(fi=null)}),fi)}function yb(){let e=Ks();return e?Promise.resolve(e):ui||(ui=(async()=>{if(!navigator.onLine)throw new Error("offline");await gb(),await new Promise((n,r)=>{let o=document.createElement("script");o.src="https://unpkg.com/vis-network@9.1.6/dist/vis-network.min.js",o.async=!0,o.onload=()=>n(),o.onerror=()=>r(new Error("vis-network load failed")),document.head.appendChild(o)});let t=Ks();if(!t)throw new Error("vis-network not available");return t})().finally(()=>{Ks()||(ui=null)}),ui)}function bb(e,t){let n=new Map;e.forEach(s=>{n.set(s,new Set)}),t.forEach(s=>{let{from:c,to:d}=s;!n.has(c)||!n.has(d)||(n.get(c).add(d),n.get(d).add(c))});let r=new Map,o=new Map,i=0;return e.forEach(s=>{if(r.has(s))return;let c=[s];r.set(s,i);let d=new Set([s]);for(;c.length;){let l=c.shift();(n.get(l)||new Set).forEach(f=>{r.has(f)||(r.set(f,i),d.add(f),c.push(f))})}o.set(i,d),i+=1}),{nodeToComp:r,compToNodes:o}}function wb(){if(!pi)return{nodes:[],edges:[]};let e=pi.nodes||[],t=pi.edges||[],n=["#fecaca","#fde68a","#bbf7d0","#bfdbfe","#ddd6fe","#f9a8d4"],r=e.map(d=>d.id),o=t.map((d,l)=>({id:`e-${l}`,from:d.source,to:d.target})),{nodeToComp:i,compToNodes:s}=bb(r,o);nl=i,Qp=s,Js=new Map,js=new Map;let c=e.map(d=>{let l=d.id,u=t.filter(T=>T.source===l||T.target===l).length,f=nl.get(l)??0,p=n[f%n.length],y=a.articleId===l,b=y?"#f97316":d.public?"#0ea5e9":"#64748b",h=y?3:u>=4?2:1.5,g={size:18,color:"#111827",face:"system-ui, -apple-system, BlinkMacSystemFont, sans-serif"},w={background:p,border:b},S={background:"#e5e7eb",border:"#cbd5f5"},x={background:p,border:"#f97316"};return Js.set(l,{color:w,dimColor:S,highlightColor:x,borderWidth:h,font:g}),{id:l,label:d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",title:d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",value:Math.max(1,u),shape:"dot",size:Zp/2,color:w,borderWidth:h,font:g}});return o.forEach(d=>{js.set(d.id,{color:"#d1d5db",highlightColor:"#f97316",width:1,highlightWidth:1.5})}),{nodes:c,edges:o}}function rl(){let t=m.graphCanvas.getBoundingClientRect(),n=t.width||600,r=t.height||400;return{autoResize:!0,width:`${n}px`,height:`${r}px`,interaction:{hover:!0,tooltipDelay:80},physics:{enabled:!0,solver:"forceAtlas2Based",stabilization:{enabled:!0,iterations:300,updateInterval:30,fit:!1},forceAtlas2Based:{gravitationalConstant:-100,centralGravity:.005,springLength:Zp*5,springConstant:.1,damping:.4,avoidOverlap:1},minVelocity:.7},nodes:{shape:"dot",scaling:{min:10,max:20},font:{size:14,color:"#111827",face:"system-ui, -apple-system, BlinkMacSystemFont, sans-serif",strokeWidth:2,strokeColor:"#f8fafc"}},edges:{smooth:!1,color:{color:"#d1d5db",highlight:"#f97316"}}}}function Gp(e){if(!dr||!ur)return;if(e==null){let o=[];dr.forEach(s=>{let c=Js.get(s.id);c&&o.push({id:s.id,color:c.color,borderWidth:c.borderWidth,font:c.font})}),dr.update(o);let i=[];ur.forEach(s=>{let c=js.get(s.id);c&&i.push({id:s.id,color:c.color,width:c.width})}),ur.update(i);return}let t=Qp.get(e)||new Set,n=[];dr.forEach(o=>{let i=Js.get(o.id);if(!i)return;let s=t.has(o.id);n.push({id:o.id,color:s?i.highlightColor:i.dimColor,borderWidth:i.borderWidth,font:i.font})}),dr.update(n);let r=[];ur.forEach(o=>{let i=js.get(o.id);if(!i)return;let s=t.has(o.from)&&t.has(o.to);r.push({id:o.id,color:s?i.highlightColor:i.color,width:s?i.highlightWidth:i.width})}),ur.update(r)}function Sb(){let e=Ks();if(!e||!m.graphCanvas){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0431\u0438\u0431\u043B\u0438\u043E\u0442\u0435\u043A\u0443 \u0433\u0440\u0430\u0444\u0430 (vis-network)");return}let{nodes:t,edges:n}=wb();if(Er){dr.clear(),ur.clear(),dr.add(t),ur.add(n);let r=rl();Er.setOptions(r)}else{dr=new e.DataSet(t),ur=new e.DataSet(n);let r=rl();Er=new e.Network(m.graphCanvas,{nodes:dr,edges:ur},r),Er.on("click",o=>{if(!o.nodes||!o.nodes.length)return;let i=o.nodes[0];i&&gt(pt.article(i))}),Er.on("hoverNode",o=>{let i=o.node,s=nl.get(i);s!==void 0&&Gp(s)}),Er.on("blurNode",()=>{Gp(null)})}}async function em(){if(!(!m.graphView||!m.graphCanvas)){m.articleListView&&m.articleListView.classList.add("hidden"),m.articleView&&m.articleView.classList.add("hidden"),m.articleHeader&&m.articleHeader.classList.add("hidden"),m.usersView&&m.usersView.classList.add("hidden"),m.graphView.classList.remove("hidden");try{await yb()}catch(e){!navigator.onLine||e?.message==="offline"?L("\u0413\u0440\u0430\u0444 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0431\u0435\u0437 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430"):L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0431\u0438\u0431\u043B\u0438\u043E\u0442\u0435\u043A\u0443 \u0433\u0440\u0430\u0444\u0430 (vis-network)");return}if(!pi)try{pi=await De("/api/graph")}catch(e){L(e.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0434\u0430\u043D\u043D\u044B\u0435 \u0433\u0440\u0430\u0444\u0430");return}Sb()}}function xb(){!m.graphView||!m.graphCanvas||!m.graphToggleBtn||(m.graphToggleBtn.addEventListener("click",()=>{em()}),m.graphBackBtn&&m.graphBackBtn.addEventListener("click",()=>{m.graphView.classList.add("hidden"),m.articleView&&m.articleView.classList.add("hidden"),m.articleHeader&&m.articleHeader.classList.add("hidden"),m.articleListView&&m.articleListView.classList.remove("hidden")}),window.addEventListener("resize",()=>{if(!m.graphView.classList.contains("hidden")&&Er){let e=rl();Er.setOptions(e)}}))}var pi,Er,dr,ur,nl,Qp,Js,js,Zp,ui,fi,nm=Fe(()=>{vt();Pt();wn();ft();Et();pi=null,Er=null,dr=null,ur=null,nl=new Map,Qp=new Map,Js=new Map,js=new Map,Zp=22;ui=null,fi=null});var im={};Vn(im,{initUsersPanel:()=>vb,openUsersPage:()=>om});function kb(){m.articleListView&&m.articleListView.classList.add("hidden"),m.articleView&&m.articleView.classList.add("hidden"),m.graphView&&m.graphView.classList.add("hidden"),m.articleHeader&&m.articleHeader.classList.add("hidden")}function Ab(){kb(),m.usersView&&m.usersView.classList.remove("hidden")}function Ib(){m.usersView&&m.usersView.classList.add("hidden"),m.articleListView&&m.articleListView.classList.remove("hidden"),m.articleView&&m.articleView.classList.add("hidden"),m.articleHeader&&m.articleHeader.classList.add("hidden")}async function rm(e){if(m.usersList){m.usersList.textContent="";try{let t=await rd(e);if(!t.length){let n=document.createElement("li");n.textContent="\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439 \u043D\u0435\u0442",m.usersList.appendChild(n);return}t.forEach(n=>{let r=document.createElement("li");r.className="users-list-item";let o=document.createElement("span");if(o.className="users-list-item__info",o.textContent=`${n.username}${n.displayName&&n.displayName!==n.username?` (${n.displayName})`:""}`,n.isSuperuser){let i=document.createElement("span");i.className="users-list-item__badge",i.textContent="superuser",o.appendChild(i)}if(r.appendChild(o),!n.isSuperuser){let i=document.createElement("button");i.type="button",i.className="ghost small users-list-item__delete",i.textContent="\u0423\u0434\u0430\u043B\u0438\u0442\u044C",i.addEventListener("click",async()=>{if(window.confirm(`\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F "${n.username}" \u0441\u043E \u0432\u0441\u0435\u043C\u0438 \u0441\u0442\u0430\u0442\u044C\u044F\u043C\u0438 \u0438 \u0444\u0430\u0439\u043B\u0430\u043C\u0438?`))try{await od(n.id),L("\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u0443\u0434\u0430\u043B\u0451\u043D"),await rm()}catch(c){L(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F")}}),r.appendChild(i)}m.usersList.appendChild(r)})}catch(t){let n=document.createElement("li");n.textContent=t.message||"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439",m.usersList.appendChild(n)}}}async function om(e){Ab(),await rm(e)}function vb(){m.openUsersViewBtn&&m.openUsersViewBtn.addEventListener("click",async()=>{let e="";try{e=await Gt({title:"\u0414\u043E\u0441\u0442\u0443\u043F \u043A \u0443\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u044E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\u043C\u0438",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u0430.",confirmText:"\u041E\u0442\u043A\u0440\u044B\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"\u041F\u0430\u0440\u043E\u043B\u044C",inputType:"password"})}catch{e=""}e&&om(e)}),m.usersBackBtn&&m.usersBackBtn.addEventListener("click",()=>{Ib()})}var sm=Fe(()=>{vt();Pt();Et();Rn()});var am={};Vn(am,{initTables:()=>_b});function Eb(e){if(!e)return null;let t=e.target;return!t||!(t instanceof Element)?null:t.closest("td,th")}function Tb(e){if(!e)return;let t=e.parentElement,n=t&&t.closest("table.memus-table");if(!t||!n)return;let r=n.tBodies[0]||n.createTBody(),o=Array.from(r.rows),i=o.indexOf(t),s=t.cells.length,c=document.createElement("tr");for(let d=0;d<s;d+=1){let l=document.createElement("td");l.innerHTML="&nbsp;",c.appendChild(l)}i>=0&&i<o.length-1?r.insertBefore(c,o[i+1]):r.appendChild(c)}function Cb(e){if(!e)return;let t=e.parentElement,n=t&&t.closest("table.memus-table");if(!t||!n)return;let r=n.tBodies[0];r&&(r.rows.length<=1||r.removeChild(t))}function Bb(e){if(!e)return;let t=e.closest("table.memus-table");if(!t)return;let n=e.cellIndex,r=Array.from(t.rows);r.forEach(d=>{let l=document.createElement(d.sectionRowIndex===0&&d.parentElement===t.tHead?"th":"td");l.innerHTML="&nbsp;",n>=0&&n<d.cells.length-1?d.insertBefore(l,d.cells[n+1]):d.appendChild(l)});let o=t.querySelector("colgroup");o||(o=document.createElement("colgroup"),t.insertBefore(o,t.firstChild));let i=Array.from(o.querySelectorAll("col")),s=r[0]?.cells.length||i.length+1||1;for(;i.length<s;){let d=document.createElement("col");o.appendChild(d),i=Array.from(o.querySelectorAll("col"))}let c=100/s;i.forEach(d=>{d.setAttribute("width",`${c}%`)})}function Lb(e){if(!e)return;let t=e.closest("table.memus-table");if(!t)return;let n=e.cellIndex;if(n<0)return;let r=Array.from(t.rows);if(r.length&&r[0].cells.length<=1)return;r.forEach(i=>{i.cells[n]&&i.deleteCell(n)});let o=t.querySelector("colgroup");if(o){let i=Array.from(o.querySelectorAll("col"));i[n]&&i[n].remove();let s=Array.from(o.querySelectorAll("col")),c=s.length||t.tHead?.rows[0]?.cells.length||0;if(c>0){let d=100/c;if(s.length)s.forEach(l=>{l.setAttribute("width",`${d}%`)});else for(let l=0;l<c;l+=1){let u=document.createElement("col");u.setAttribute("width",`${d}%`),o.appendChild(u)}}}}function il(){wo&&wo.parentElement&&wo.parentElement.removeChild(wo),wo=null}function Mb(e){if(il(),!e)return;let t=e.closest("table.memus-table");if(!t)return;let n=document.createElement("div");n.className="table-toolbar";let r=(l,u)=>{let f=document.createElement("button");return f.type="button",f.className="table-toolbar-btn",f.textContent=l,u&&(f.title=u),f},o=r("+\u0441\u0442\u0440","\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0441\u0442\u0440\u043E\u043A\u0443 \u043D\u0438\u0436\u0435"),i=r("\u2212\u0441\u0442\u0440","\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0441\u0442\u0440\u043E\u043A\u0443"),s=r("+\u043A\u043E\u043B","\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u043A\u043E\u043B\u043E\u043D\u043A\u0443 \u0441\u043F\u0440\u0430\u0432\u0430"),c=r("\u2212\u043A\u043E\u043B","\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043A\u043E\u043B\u043E\u043D\u043A\u0443");o.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),Tb(e)}),i.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),Cb(e)}),s.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),Bb(e)}),c.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),Lb(e)}),n.appendChild(o),n.appendChild(i),n.appendChild(s),n.appendChild(c),(t.parentElement||t).insertBefore(n,t),wo=n}function Nb(e,t,n){let r=t.closest("table.memus-table");if(!r)return;let o=r.querySelector("colgroup");if(!o)return;let i=Array.from(o.querySelectorAll("col"));if(!i[n])return;let s=r.getBoundingClientRect(),c=e.clientX,d=i.map(u=>{let f=u.getAttribute("width")||"";return f.endsWith("%")&&parseFloat(f.replace("%","").trim())||0}),l=d.reduce((u,f)=>u+f,0)||100;Ws={table:r,colgroup:o,cols:i,startX:c,startWidths:d,totalPercent:l,colIndex:n,tableWidthPx:s.width||1},e.preventDefault(),e.stopPropagation()}function Pb(e){if(!Ws)return;let{cols:t,colIndex:n,startX:r,startWidths:o,totalPercent:i,tableWidthPx:s}=Ws,d=(e.clientX-r)/s*i,l=[...o],u=l[n]||i/t.length,f=n+1,p=l[f]||i/t.length,y=u+d,b=p-d,h=i*.05;if(y<h){let g=h-y;y=h,b-=g}if(b<h){let g=h-b;b=h,y-=g}l[n]=y,t[f]&&(l[f]=b),l.forEach((g,w)=>{if(t[w]){let S=g/i*100;t[w].setAttribute("width",`${S}%`)}})}function Db(){Ws=null}function ol(e){let t=e.tHead;if(!t)return;let n=t.rows[0];if(!n)return;let r=e.querySelector("colgroup");if(!r){let o=Math.max(n.cells.length||1,1),i=100/o;r=document.createElement("colgroup");for(let s=0;s<o;s+=1){let c=document.createElement("col");c.setAttribute("width",`${i.toFixed(4)}%`),r.appendChild(c)}e.insertBefore(r,t)}Array.from(n.cells).forEach((o,i)=>{let s=document.createElement("div");s.className="table-col-resize-handle",s.addEventListener("mousedown",c=>Nb(c,o,i)),o.style.position="relative",o.appendChild(s)})}function _b(){m.articleView&&(m.articleView.addEventListener("click",t=>{let n=Eb(t);if(!n||a.mode!=="edit"||!a.editingBlockId){il();return}if(!n.closest('[contenteditable="true"]')){il();return}Mb(n)},!0),m.articleView.addEventListener("wheel",t=>{let n=t.target;!n||!(n instanceof Element)||n.closest("table.memus-table")&&m.blocksContainer&&(m.blocksContainer.scrollTop+=t.deltaY,t.preventDefault())},{capture:!0,passive:!1})),document.addEventListener("mousemove",Pb),document.addEventListener("mouseup",Db);let e=new MutationObserver(t=>{t.forEach(n=>{n.addedNodes.forEach(r=>{r instanceof HTMLElement&&(r.matches&&r.matches("table.memus-table")?ol(r):r.querySelectorAll?.("table.memus-table").forEach(o=>{ol(o)}))})})});m.articleView&&(e.observe(m.articleView,{childList:!0,subtree:!0}),m.articleView.querySelectorAll("table.memus-table").forEach(t=>{ol(t)}))}var wo,Ws,cm=Fe(()=>{vt();ft();wo=null;Ws=null});wn();ft();vt();$n();eo();nn();Hi();ft();vt();Pt();Et();tn();Hi();wn();Rn();var Wc=!1;function up(){m.articleTitleInput&&requestAnimationFrame(()=>{m.articleTitleInput.focus(),m.articleTitleInput.select()})}function $s(){if(!(!a.article||!m.articleTitleInput)){if(a.isEditingTitle){up();return}a.isEditingTitle=!0,m.articleTitleInput.value=a.article.title||"",m.articleTitle&&m.articleTitle.classList.add("hidden"),m.articleTitleInput&&m.articleTitleInput.classList.remove("hidden"),m.editTitleBtn&&m.editTitleBtn.classList.add("hidden"),up()}}function fp(){a.article&&(a.isEditingTitle||$s())}function qy(){if(!a.isEditingTitle)return;a.isEditingTitle=!1,m.articleTitleInput&&a.article&&(m.articleTitleInput.value=a.article.title||"");let e=a.article?.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";m.articleTitle&&(m.articleTitle.textContent=e,m.articleTitle.classList.remove("hidden")),m.articleTitleInput&&m.articleTitleInput.classList.add("hidden"),m.editTitleBtn&&m.editTitleBtn.classList.remove("hidden")}function Ky(e){if(!e)return;let t=!1;a.searchResults=a.searchResults.map(n=>n.articleId===e.id&&n.articleTitle!==e.title?(t=!0,{...n,articleTitle:e.title}):n),t&&Lr()}async function pp(){if(!a.isEditingTitle||!m.articleTitleInput||!a.articleId||!a.article)return;let e=m.articleTitleInput.value.trim(),t=(a.article.title||"").trim();if(e===t){a.isEditingTitle=!1,m.articleTitle&&(m.articleTitle.textContent=t||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",m.articleTitle.classList.remove("hidden")),m.articleTitleInput&&m.articleTitleInput.classList.add("hidden"),m.editTitleBtn&&m.editTitleBtn.classList.remove("hidden");return}if(!hi){Gs(!0),m.articleTitleInput.disabled=!0;try{let n=await De(`/api/articles/${a.articleId}`,{method:"PATCH",body:JSON.stringify({title:e})});a.article={...a.article,title:n.title,updatedAt:n.updatedAt},Bn(n),a.isEditingTitle=!1;let r=a.article.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";m.articleTitle&&(m.articleTitle.textContent=r,m.articleTitle.classList.remove("hidden")),m.articleTitleInput&&(m.articleTitleInput.classList.add("hidden"),m.articleTitleInput.value=r),m.editTitleBtn&&m.editTitleBtn.classList.remove("hidden"),Ky(n),L("Title saved")}catch(n){L(n.message||"Failed to save title")}finally{Gs(!1),m.articleTitleInput&&(m.articleTitleInput.disabled=!1)}}}function mp(e){a.isEditingTitle&&(e.code==="Enter"?pp():e.code==="Escape"&&qy())}function hp(){!a.isEditingTitle||hi||pp()}function gp(e){!m.articleMenu||!m.articleMenuBtn||(Wc=e,m.articleMenu.classList.toggle("hidden",!e),m.articleMenuBtn.setAttribute("aria-expanded",e?"true":"false"))}function yp(e){e&&e.stopPropagation(),a.article&&gp(!Wc)}function cr(){gp(!1)}function bp(){return Wc}async function wp(e){if(e&&e.stopPropagation(),cr(),!a.articleId)return;if(a.articleId==="inbox"){L("\u0421\u0442\u0430\u0442\u044C\u044E Inbox \u043D\u0435\u043B\u044C\u0437\u044F \u0443\u0434\u0430\u043B\u0438\u0442\u044C");return}let t=!!(a.article?.deletedAt||a.isTrashView),n=!1;try{n=await On({title:t?"\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0431\u0435\u0437\u0432\u043E\u0437\u0432\u0440\u0430\u0442\u043D\u043E?":"\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443?",message:t?"\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0431\u0443\u0434\u0435\u0442 \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u0431\u0435\u0437 \u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E\u0441\u0442\u0438 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F.":"\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0431\u0443\u0434\u0435\u0442 \u043F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0430 \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443.",confirmText:t?"\u0423\u0434\u0430\u043B\u0438\u0442\u044C":"\u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"})}catch{n=window.confirm(t?"\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0431\u0435\u0437\u0432\u043E\u0437\u0432\u0440\u0430\u0442\u043D\u043E?":"\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443?")}if(n)try{await Ci(a.articleId,{force:t}),t?$o(a.articleId):Ra(a.articleId),a.article=null,a.articleId=null,a.currentBlockId=null,gt(pt.list),L(t?"\u0421\u0442\u0430\u0442\u044C\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u0431\u0435\u0437\u0432\u043E\u0437\u0432\u0440\u0430\u0442\u043D\u043E":"\u0421\u0442\u0430\u0442\u044C\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0430 \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443")}catch(r){L(r.message)}}tn();tn();jn();wn();Pt();Et();bn();Rn();jn();ko();ko();Qn();En();async function Sp(){let t=(await st()).transaction(["articles","media_refs","media_assets"],"readonly"),n=t.objectStore("articles"),r=t.objectStore("media_refs"),o=t.objectStore("media_assets"),i=await Ce(n.getAll()).catch(()=>[])||[],s=0,c=0;for(let b of i)!b||b.deletedAt||Number(b.encrypted||0)===0&&(s+=1,b.docJsonStr&&(c+=1));let d=await Ce(r.getAll()).catch(()=>[])||[],l=new Set;for(let b of d){let h=String(b?.url||"");h&&l.add(h)}let u=0,f=0,p={notFound:0,noAccess:0,network:0,other:0};for(let b of l){let h=await Ce(o.get(b)).catch(()=>null);if(h?.status==="ok"&&(u+=1),h?.status==="error"){f+=1;let g=String(h?.lastError||"");/\bHTTP\s+404\b/.test(g)?p.notFound+=1:/\bHTTP\s+(401|403)\b/.test(g)?p.noAccess+=1:/Failed to fetch/i.test(g)||/Network/i.test(g)||/timeout/i.test(g)||/ERR_/i.test(g)?p.network+=1:p.other+=1}}let y=l.size;return await Ue(t),{articles:{total:s,withDoc:c},media:{total:y,ok:u,error:f,errorKinds:p}}}hs();ft();vt();$n();$n();eo();nn();tn();function Yc(e){if(!e)return!1;let t=e instanceof Node?e:null;if(!t||t.nodeType!==Node.ELEMENT_NODE)return!!(e&&e.isContentEditable);let n=t.tagName;return n==="INPUT"||n==="TEXTAREA"||n==="SELECT"?!0:t.isContentEditable}function xp(e){if(!a.currentBlockId)return!1;let t=document.querySelector(`.block[data-block-id="${a.currentBlockId}"] > .block-surface`)||document.querySelector(`.block[data-block-id="${a.currentBlockId}"]`);if(!t)return!1;let n=m.blocksContainer||document.scrollingElement||document.documentElement;if(!n)return!1;let r=n.getBoundingClientRect(),o=t.getBoundingClientRect(),i=24,s=r.height-i*2;if(s<=0||o.height<=s)return!1;if(e==="down"){let c=r.bottom-i;if(o.bottom<=c)return!1;let l=o.bottom-c,u=Math.min(Math.max(l,40),160),f=Math.max(24,Math.round(u/3));return n.scrollBy({top:f,behavior:"smooth"}),!0}if(e==="up"){let c=r.top+i;if(o.top>=c)return!1;let l=c-o.top,u=Math.min(Math.max(l,40),160),f=Math.max(24,Math.round(u/3));return n.scrollBy({top:-f,behavior:"smooth"}),!0}return!1}function kp(e){if(!a.article||Yc(e.target)||a.isEditingTitle&&m.articleTitleInput&&m.articleTitleInput.contains(e.target))return;if(a.isPublicView||a.isRagView){let s=typeof e.code=="string"?e.code:"";if(s==="Enter"){e.preventDefault();return}if(e.ctrlKey&&(s==="KeyZ"||s==="KeyY"||s==="Delete"||s==="ArrowDown"||s==="ArrowUp"||s==="ArrowLeft"||s==="ArrowRight")){e.preventDefault();return}}if(qn&&e.code==="Escape"){e.preventDefault(),tr();return}let t=typeof e.code=="string"?e.code:"",n=s=>{let c=m.blocksContainer;if(!c)return;let d=c.getBoundingClientRect(),l=24,u=Math.max(0,d.height-l*2);if(u<=0)return;let f=Math.max(40,Math.round(u*.92)),p=s==="down"?f:-f,y=Math.max(0,c.scrollHeight-c.clientHeight),b=c.scrollTop,h=Math.max(0,Math.min(b+p,y));c.scrollTop=h;let g=d.top+l,w=Array.from(c.querySelectorAll(".block[data-block-id]"));if(!w.length)return;let S=w.map(T=>{let N=T.getAttribute("data-block-id")||"",B=T.getBoundingClientRect();return{id:N,rect:B}}).filter(T=>T.id);if(!S.length)return;let x=S.find(T=>T.rect.top>=g)||null;!x&&s==="down"&&(x=S[S.length-1]),!x&&s==="up"&&(x=S[0]),h===b&&a.currentBlockId&&(s==="down"?x=S[S.length-1]:x=S[0]),x&&x.id&&(a.scrollTargetBlockId=x.id,Sn(x.id,{scrollIntoView:!1}))},r=s=>{let c=m.blocksContainer;if(!c)return;let d=Array.from(c.querySelectorAll(".block[data-block-id]"));if(!d.length)return;let u=(s==="end"?d[d.length-1]:d[0]).getAttribute("data-block-id");u&&(a.scrollTargetBlockId=u,Sn(u,{scrollIntoView:!0,scrollBehavior:"auto"}))};if(!e.ctrlKey&&!e.shiftKey&&!e.altKey&&!e.metaKey){if(t==="PageDown"){e.preventDefault(),n("down");return}if(t==="PageUp"){e.preventDefault(),n("up");return}if(t==="Home"){e.preventDefault(),r("home");return}if(t==="End"){e.preventDefault(),r("end");return}}let o=e.ctrlKey&&!e.shiftKey&&t==="KeyZ",i=e.ctrlKey&&!e.shiftKey&&t==="KeyY";if(a.pendingTextPreview){if(a.pendingTextPreview.mode==="undo"&&o){e.preventDefault(),io();return}if(a.pendingTextPreview.mode==="redo"&&i){e.preventDefault(),so();return}if(t==="Escape"){e.preventDefault(),Wn();return}e.preventDefault();return}if(o){e.preventDefault(),io();return}if(i){e.preventDefault(),so();return}if(e.ctrlKey&&e.shiftKey&&e.code==="ArrowDown"){e.preventDefault(),ac("down");return}if(e.ctrlKey&&e.shiftKey&&e.code==="ArrowUp"){e.preventDefault(),ac("up");return}if(e.ctrlKey&&!e.shiftKey&&e.code==="ArrowDown"){e.preventDefault();let s=a.articleId==="inbox"?"before":"after";gr(s);return}if(e.ctrlKey&&!e.shiftKey&&e.code==="ArrowUp"){e.preventDefault();let s=a.articleId==="inbox"?"after":"before";gr(s);return}if(e.ctrlKey&&e.code==="Delete"){e.preventDefault(),Zi();return}if(e.ctrlKey&&e.code==="ArrowRight"){e.preventDefault(),Ru();return}if(e.ctrlKey&&e.code==="ArrowLeft"){e.preventDefault(),Hu();return}if(e.code==="ArrowDown"){if(!e.ctrlKey&&e.shiftKey){e.preventDefault(),Jo(1);return}if(!e.ctrlKey&&!e.shiftKey){if(e.preventDefault(),!xp("down")){let c=a.articleId==="inbox"?-1:1;Ko(c)}return}}if(e.code==="ArrowUp"){if(!e.ctrlKey&&e.shiftKey){e.preventDefault(),Jo(-1);return}if(!e.ctrlKey&&!e.shiftKey){if(e.preventDefault(),!xp("up")){let c=a.articleId==="inbox"?1:-1;Ko(c)}return}}if(e.code==="ArrowLeft"){e.preventDefault();let s=os(a.currentBlockId,!0);s&&(a.currentBlockId!==s&&Sn(s),Dr(s,!0));return}if(e.code==="ArrowRight"){e.preventDefault();let s=os(a.currentBlockId,!1);s&&Dr(s,!1);return}e.code==="Enter"&&(e.preventDefault(),Gi())}nn();$n();eo();function Ap(e){let t=typeof e.code=="string"?e.code:"",n=e.ctrlKey&&!e.shiftKey&&t==="KeyZ",r=e.ctrlKey&&!e.shiftKey&&t==="KeyY",o=e.ctrlKey&&e.shiftKey&&t==="KeyZ";if(n&&oo(-1)){e.preventDefault();return}if((r||o)&&oo(1)){e.preventDefault();return}if(e.ctrlKey&&!e.shiftKey&&e.code==="ArrowDown"){e.preventDefault(),Zr();return}if(e.ctrlKey&&!e.shiftKey&&e.code==="ArrowUp"){e.preventDefault(),(async()=>(await zo(),await gr("before")))();return}if(e.code==="Enter"&&e.ctrlKey){e.preventDefault(),zo();return}if(e.code==="Tab"&&!e.ctrlKey&&!e.altKey&&!e.metaKey){e.preventDefault();return}if(e.ctrlKey&&e.code==="ArrowRight"){e.preventDefault(),ss({keepEditing:!0});return}if(e.ctrlKey&&e.code==="ArrowLeft"){e.preventDefault(),as({keepEditing:!0});return}e.code==="Escape"&&(e.preventDefault(),Qi())}ft();vt();wn();tn();Et();Pt();function Ip(e){let{code:t,ctrlKey:n,shiftKey:r,altKey:o,metaKey:i}=e;if(o||i||!m.articleListView||m.articleListView.classList.contains("hidden")||!m.articleList)return;let s=m.articleList,c=Array.from(s.querySelectorAll("li[data-article-id]"));if(!c.length)return;let d=a.listSelectedArticleId||a.articleId,l=d&&c.findIndex(b=>b.dataset.articleId===d),u=l!=null&&l>=0?l:0,f=b=>{if(!c.length)return;u=Math.max(0,Math.min(c.length-1,u+b));let h=c[u];if(!h)return;let g=h.dataset.articleId;g&&(a.listSelectedArticleId=g,qt(),h.scrollIntoView({block:"nearest"}))},y=(()=>{if(a.listSelectedArticleId)return a.listSelectedArticleId;if(a.articleId)return a.articleId;let b=c[0];return b?b.dataset.articleId:null})();if(y){if(!n&&!r&&(t==="ArrowDown"||t==="ArrowUp")){e.preventDefault(),f(t==="ArrowDown"?1:-1);return}if(!n&&!r&&(t==="ArrowLeft"||t==="ArrowRight")){if(!(a.articlesIndex||[]).some(g=>(g.parentId||null)===y))return;e.preventDefault(),a.listCollapsedArticleIds||(a.listCollapsedArticleIds=[]);let h=new Set(a.listCollapsedArticleIds);t==="ArrowLeft"?h.has(y)||(h.add(y),a.listCollapsedArticleIds=Array.from(h),Mr(),qt()):t==="ArrowRight"&&h.has(y)&&(h.delete(y),a.listCollapsedArticleIds=Array.from(h),Mr(),qt());return}if(!n&&!r&&t==="Enter"){e.preventDefault(),a.listSelectedArticleId=y,gt(pt.article(y));return}if(n&&r&&(t==="ArrowUp"||t==="ArrowDown")){e.preventDefault(),ld(y,t==="ArrowUp"?"up":"down").then(()=>nr()).then(b=>qt(b)).catch(b=>L(b.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443"));return}if(n&&!r&&t==="ArrowRight"){e.preventDefault(),dd(y).then(()=>nr()).then(b=>qt(b)).catch(b=>L(b.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u043D\u043E\u0441\u0442\u044C"));return}if(n&&!r&&t==="ArrowLeft"){e.preventDefault(),ud(y).then(()=>nr()).then(b=>qt(b)).catch(b=>L(b.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u043D\u043E\u0441\u0442\u044C"));return}}}ft();vt();tn();function vp(){m.mobileSidebarBtn&&m.mobileSidebarBtn.addEventListener("click",e=>{e.preventDefault(),Nr(!1),en(!0)}),m.listSidebarBtn&&m.listSidebarBtn.addEventListener("click",e=>{e.preventDefault(),Nr(!1),en(!0)}),m.sidebarBackdrop&&m.sidebarBackdrop.addEventListener("click",()=>{Oo()}),m.sidebar&&m.sidebar.addEventListener("click",e=>{if(!a.isSidebarMobileOpen)return;let t=e.target,n=t.closest("button");n&&(n.closest(".sidebar-article-item")||m.userMenuBtn&&n===m.userMenuBtn||m.userMenu&&m.userMenu.contains(t)||m.sidebarRecentBtn&&n===m.sidebarRecentBtn||m.sidebarSearchViewToggle&&n===m.sidebarSearchViewToggle||m.searchModeToggle&&n===m.searchModeToggle||m.searchClearBtn&&n===m.searchClearBtn||Oo())},!0),document.addEventListener("click",e=>{if(window.matchMedia("(min-width: 768px)").matches||!a.isSidebarMobileOpen||!m.sidebar)return;let n=e.target;m.sidebar.contains(n)||m.mobileSidebarBtn&&m.mobileSidebarBtn.contains(n)||Oo()},!0)}var lr=0,Fs=null,Xc=!1,Rp="\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043F\u043E\u0438\u0441\u043A",rb="\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F",Hp="ttree_sidebar_search_view_v1",Pp=null,Gc=!1;function ob(){return Promise.resolve().then(()=>(ar(),sr))}function Dp(){return Promise.resolve().then(()=>(Np(),Mp))}function Us(e){return e==="search"?"search":"list"}function ib(){try{return Us(localStorage.getItem(Hp)||"")}catch{return"list"}}function sb(){try{localStorage.setItem(Hp,a.sidebarSearchView||"list")}catch{}}function Qc(){let e=Us(a.sidebarSearchView),t=e==="search",n=t?"\u041F\u043E\u0438\u0441\u043A":"\u0424\u0438\u043B\u044C\u0442\u0440";if(m.sidebarSearchViewToggle){m.sidebarSearchViewToggle.dataset.view=e;let r=m.sidebarSearchViewToggle.querySelector("span")||m.sidebarSearchViewToggle;r.textContent=n;let o=t?"\u041F\u0435\u0440\u0435\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0432 \u0440\u0435\u0436\u0438\u043C \u0444\u0438\u043B\u044C\u0442\u0440\u0430 \u0441\u0442\u0430\u0442\u0435\u0439":"\u041F\u0435\u0440\u0435\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0432 \u0440\u0435\u0436\u0438\u043C \u043F\u043E\u0438\u0441\u043A\u0430";m.sidebarSearchViewToggle.setAttribute("title",o),m.sidebarSearchViewToggle.setAttribute("aria-label",o),m.sidebarSearchViewToggle.classList.toggle("search-panel__toggle--active",t)}m.searchModeToggle&&m.searchModeToggle.classList.toggle("hidden",!t),t||(Zn(),m.ragOpenBtn&&m.ragOpenBtn.classList.add("hidden")),m.searchInput&&(m.searchInput.placeholder=t?a.searchMode==="semantic"?"\u0421\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A...":"\u041F\u043E\u0438\u0441\u043A...":"\u0424\u0438\u043B\u044C\u0442\u0440 \u0441\u0442\u0430\u0442\u0435\u0439\u2026")}function ab(e,{persist:t=!0}={}){let n=Us(e);a.sidebarSearchView!==n&&(a.sidebarSearchView=n,t&&sb(),a.sidebarSearchView==="list"?(a.searchQuery="",a.searchResults=[],a.searchError="",a.searchLoading=!1,a.searchRequestId=0):(a.articleFilterQuery="",wt(),er()),lr=0,Qc(),m.searchInput&&m.searchInput.dispatchEvent(new Event("input",{bubbles:!0})))}function _p(e){let t=new Map,n=[],r=c=>String(c||"").replace(/\u00a0/g," ").replace(/\r\n/g,`
`),o=(c,d=`
`)=>c.map(l=>r(l)).filter(Boolean).join(d),i=c=>{if(!c)return"";if(Array.isArray(c))return c.map(i).join("");if(c.type==="text")return r(c.text||"");if(c.type==="hardBreak")return`
`;if(c.type==="table"){let u=[];return(c.content||[]).forEach(f=>{if(f?.type!=="tableRow")return;let p=[];(f.content||[]).forEach(y=>{!y||y.type!=="tableCell"&&y.type!=="tableHeader"||p.push(i(y).trim())}),u.push(p.join("	"))}),`${u.join(`
`)}
`}let d=Array.isArray(c.content)?c.content:[],l=d.map(i).join("");if(c.type==="paragraph"||c.type==="heading")return`${l}
`;if(c.type==="bulletList")return`${d.filter(f=>f?.type==="listItem").map(f=>{let p=i(f).trimEnd();if(!p)return"";let y=p.split(`
`);return y[0]=`- ${y[0]}`,y.join(`
`)}).filter(Boolean).join(`
`)}
`;if(c.type==="orderedList"){let u=1;return`${d.filter(p=>p?.type==="listItem").map(p=>{let y=i(p).trimEnd();if(!y)return"";let b=y.split(`
`);return b[0]=`${u}. ${b[0]}`,u+=1,b.join(`
`)}).filter(Boolean).join(`
`)}
`}return l},s=c=>{if(c){if(Array.isArray(c)){c.forEach(s);return}if(c.type==="outlineSection"){let d=String(c?.attrs?.id||c?.attrs?.sectionId||""),l=(c.content||[]).find(h=>h?.type==="outlineHeading")||null,u=(c.content||[]).find(h=>h?.type==="outlineBody")||null,f=(c.content||[]).find(h=>h?.type==="outlineChildren")||null,p=r(i(l)).trim(),y=r(i(u)).trim(),b=o([p,y],`
`).trim();d&&(t.set(d,{indexText:b,label:p||d}),n.push(d)),f?.content&&s(f.content);return}c.content&&s(c.content)}};return s(e?.content||[]),{map:t,order:n}}function zs(e){if(!m.semanticReindexBtn)return;let t=m.semanticReindexBtn.querySelector(".sidebar-user-menu-label");if(!t)return;if(e&&e.status==="running"){let r=Number(e.processed||0),o=Number(e.total||0),i=o>0?`${r}/${o}`:`${r}`;t.textContent=`${rb}: ${i}`;return}let n="";if(e&&e.status==="cooldown"){let r=Number(e.cooldownRemainingSeconds||0);n=r>0?` (\u0447\u0435\u0440\u0435\u0437 ${Math.ceil(r/60)} \u043C\u0438\u043D)`:" (\u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u043F\u043E\u0437\u0436\u0435)"}else e&&e.status==="completed"&&(n=` (${e.indexed||0})`);t.textContent=`${Rp}${n}`}async function cb(){if(m.semanticReindexBtn)try{let e=await fetch("/api/search/semantic/reindex/status",{method:"GET",credentials:"include"});if(!e.ok)return;let t=await e.json();zs(t)}catch{}}function lb(e){let{key:t,ctrlKey:n,altKey:r,metaKey:o}=e;if(n||r||o)return!1;let i=e.target;if(Yc(i)||a.sidebarSearchView!=="list"||!m.sidebar||!m.searchInput||m.sidebar.classList.contains("hidden"))return!1;let s=m.searchInput;if(t==="Escape")return!a.articleFilterQuery&&!s.value?!1:(e.preventDefault(),a.articleFilterQuery="",s.value="",lr=0,er(),wt(),!0);if(t.length!==1)return!1;e.preventDefault();let c=Date.now(),u=(!lr||c-lr>2e3?"":s.value||a.articleFilterQuery||"")+t;s.value=u,a.articleFilterQuery=u,wt(),s.focus();try{let f=s.value.length;s.setSelectionRange(f,f)}catch{}return lr=c,!0}async function db(e){if(!e)return null;let t;try{t=await e.text()}catch(d){return console.error("Failed to read HTML file",d),null}let n=t.indexOf('id="memus-export"'),r=n===-1?t.indexOf("id='memus-export'"):n;if(r===-1)return null;let o=t.lastIndexOf("<script",r),i=t.indexOf("<\/script>",r);if(o===-1||i===-1)return null;let s=t.indexOf(">",o)+1;if(s===0||s>i)return null;let c=t.slice(s,i).trim();if(!c)return null;try{let d=JSON.parse(c);return!d||typeof d!="object"||d.source!=="memus"||Number(d.version||0)!==1?null:d}catch(d){return console.error("Failed to parse memus-export JSON",d),null}}async function ub(e){if(!e)return{exists:!1,article:null};try{let t=await fetch(`/api/articles/${encodeURIComponent(e)}`,{method:"GET",credentials:"include"});if(t.status===404)return{exists:!1,article:null};if(!t.ok){let r=await t.json().catch(()=>null),o=r&&r.detail||`\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0438 \u0441\u0442\u0430\u0442\u044C\u0438 (status ${t.status})`;throw new Error(o)}return{exists:!0,article:await t.json()}}catch(t){throw console.error("Failed to check article existence",t),t}}function fb(e){let t=typeof e.lastModified=="number"&&e.lastModified>0?e.lastModified:Date.now(),n=new Date(t),r=o=>String(o).padStart(2,"0");return`ver_${n.getFullYear()}${r(n.getMonth()+1)}${r(n.getDate())}_${r(n.getHours())}${r(n.getMinutes())}${r(n.getSeconds())}`}async function Op(e,t,{allowApplyToAll:n}={allowApplyToAll:!1}){if(!e)return null;let r=await db(e),o=r&&r.article,i=o&&o.id||"",s=o&&o.title||e.name||"\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F",c=o&&o.createdAt||null,d=o&&o.updatedAt||null,l={exists:!1,article:null};if(i&&(l=await ub(i).catch(p=>{throw It(p.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0440\u043E\u0432\u0435\u0440\u0438\u0442\u044C \u043D\u0430\u043B\u0438\u0447\u0438\u0435 \u0441\u0442\u0430\u0442\u044C\u0438"),p})),!l.exists||!i)return Li(e);let u=t&&t.decision,f=t&&t.applyToAll;if(!u||!f){let p=await xa({title:"\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0443\u0436\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442",message:"\u0427\u0442\u043E \u0441\u0434\u0435\u043B\u0430\u0442\u044C \u0441 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0435\u0439 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0435\u0439 \u043F\u0440\u0438 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0438?",existingTitle:l.article&&l.article.title,importedTitle:s,existingCreatedAt:l.article&&l.article.createdAt,existingUpdatedAt:l.article&&l.article.updatedAt,importedCreatedAt:c,importedUpdatedAt:d,allowApplyToAll:n});if(!p||!p.action)return null;u=p.action,f=!!p.applyToAll,t&&(t.decision=u,t.applyToAll=f)}if(u==="keep")return null;if(u==="overwrite")return Li(e,{mode:"overwrite"});if(u==="copy"){let p=fb(e);return Li(e,{mode:"copy",versionPrefix:p})}return null}function $p(e){!m.listMenu||!m.listMenuBtn||(m.listMenu.classList.toggle("hidden",!e),m.listMenuBtn.setAttribute("aria-expanded",e?"true":"false"))}function bo(){!m.listMenu||!m.listMenuBtn||m.listMenu.classList.contains("hidden")||$p(!1)}function Zc(){a.sidebarSearchView=ib(),Qc();let e=async()=>{if(!Gc){Gc=!0;try{let l=ki();a.mediaPrefetchPaused=l;let u="";try{let{total:f,ok:p,error:y}=await El(a.articleId);f>0&&(u=`\u041C\u0435\u0434\u0438\u0430: ${p}/${f}`,y>0&&(u+=`, \u043E\u0448\u0438\u0431\u043E\u043A: ${y}`))}catch{}!u&&l&&(u="\u041C\u0435\u0434\u0438\u0430: \u043F\u0430\u0443\u0437\u0430"),u&&l&&(u+=" (\u043F\u0430\u0443\u0437\u0430)"),a.mediaStatusText=u,gn()}finally{Gc=!1}}};Pp||!m.mediaStatusText&&!m.mediaPrefetchToggleBtn||(e().catch(()=>{}),Pp=window.setInterval(()=>{e().catch(()=>{})},2e3));let n=!1,r=0,o=()=>{try{return window?.localStorage?.getItem?.("ttree_debug_offline_v1")==="1"}catch{return!1}},i=async()=>{if(!n&&!(!m.userMenuBtn&&!m.offlineStatusLabel&&!m.offlineFetchBtn)){n=!0;try{let l=(G,ie)=>{m.userMenuBtn&&(m.userMenuBtn.dataset.offline=G,ie&&(m.userMenuBtn.title=ie))};if(a.serverStatus==="auth"){let G="\u0422\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044F \u0432\u0445\u043E\u0434";m.offlineStatusLabel&&(m.offlineStatusLabel.textContent=G),m.offlineFetchBtn&&m.offlineFetchBtn.classList.add("hidden"),l("auth",`\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 ${G}`);return}let u=(()=>{try{return navigator?.onLine!==!1}catch{return!0}})();if(a.serverStatus==="down"&&!a.offlineReady){let G=u?"\u041D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0430 \u043A \u0441\u0435\u0440\u0432\u0435\u0440\u0443":"\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430";m.offlineStatusLabel&&(m.offlineStatusLabel.textContent=G),m.offlineFetchBtn&&m.offlineFetchBtn.classList.add("hidden"),l("off",`\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 ${G}`);return}if(!a.offlineReady){let G=String(a.offlineInitStatus||"idle"),ie=String(a.offlineInitError||"").trim();if(G==="initializing"){let dt=Number(a.offlineInitStartedAt||0)||0,ut=Date.now(),Zt=dt?ut-dt:0;if(Zt>8e3&&ut-r>8e3){r=ut;try{o()&&console.warn("[offline] still initializing",{ms:Zt})}catch{}}m.offlineStatusLabel&&(m.offlineStatusLabel.textContent="\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0438\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0430\u0446\u0438\u044F\u2026"),m.offlineFetchBtn&&m.offlineFetchBtn.classList.add("hidden"),l("loading","\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 \u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0438\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0430\u0446\u0438\u044F\u2026");return}let $e=ie?`\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E (${ie})`:"\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E";m.offlineStatusLabel&&(m.offlineStatusLabel.textContent=$e),m.offlineFetchBtn&&m.offlineFetchBtn.classList.add("hidden"),l("off",`\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 ${$e}`);return}let f=null;try{f=await Sp()}catch{f=null}if(!f){m.offlineStatusLabel&&(m.offlineStatusLabel.textContent="\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u2026"),m.offlineFetchBtn&&m.offlineFetchBtn.classList.remove("hidden"),l("loading","\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 \u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u2026");return}let p=Number(f.articles?.total||0),y=Number(f.articles?.withDoc||0),b=Number(f.media?.total||0),h=Number(f.media?.ok||0),g=Number(f.media?.error||0),w=f.media?.errorKinds||null,S=p===0?!0:y>=p,x=b===0?!0:h>=b,T=S&&x&&g===0,N=Math.max(0,p-y),B=Math.max(0,b-h),$=B>0&&w&&Number(w.noAccess||0)>0&&navigator.onLine,U=xc?.()||null,Y=!!U?.running,J=Number(U?.processed||0),re=Number(U?.total||0),he=Number(U?.errors||0),Re=String(U?.lastError||"").trim();if(T)m.offlineStatusLabel&&(m.offlineStatusLabel.textContent="\u041E\u0444\u0444\u043B\u0430\u0439\u043D OK"),m.offlineFetchBtn&&m.offlineFetchBtn.classList.add("hidden"),l("ok","\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 \u041E\u0444\u0444\u043B\u0430\u0439\u043D OK");else{let G=[];if(Y?(G.push(`\u0434\u043E\u043A\u0430\u0447\u043A\u0430: ${J}/${re||"\u2026"}`),he>0&&G.push(`\u043E\u0448\u0438\u0431\u043E\u043A: ${he}`)):Re&&G.push(`\u043E\u0448\u0438\u0431\u043A\u0430: ${Re}`),$&&G.push("\u043D\u0443\u0436\u043D\u043E \u0432\u043E\u0439\u0442\u0438, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u043A\u0430\u0447\u0430\u0442\u044C \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0438"),p>0&&G.push(`\u0441\u0442\u0430\u0442\u044C\u0438: ${y}/${p}`),b>0&&G.push(`\u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0438: ${h}/${b}`),B>0&&w){let $e=Number(w.notFound||0),dt=Number(w.noAccess||0),ut=Number(w.network||0);$e>0?G.push(`\u0431\u0438\u0442\u044B\u0435: ${$e}`):dt>0?G.push(`\u043D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0430: ${dt}`):ut>0&&G.push(`\u043E\u0448\u0438\u0431\u043A\u043E\u043A \u0441\u0435\u0442\u0438: ${ut}`)}let ie=G.length?`\u041E\u0444\u0444\u043B\u0430\u0439\u043D: ${G.join(" \xB7 ")}`:"\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0434\u043E\u043A\u0430\u0447\u043A\u0430\u2026";if(m.offlineStatusLabel&&(m.offlineStatusLabel.textContent=ie),m.offlineFetchBtn){let $e=!!a.mediaPrefetchPaused,dt=!Y&&!$&&($e||N>0||B>0);m.offlineFetchBtn.classList.toggle("hidden",!dt);try{let ut=m.offlineFetchBtn.querySelector(".sidebar-user-menu-label");ut&&($e?ut.textContent="\u0412\u043E\u0437\u043E\u0431\u043D\u043E\u0432\u0438\u0442\u044C \u0434\u043E\u043A\u0430\u0447\u043A\u0443":B>0&&g>0?ut.textContent="\u041F\u043E\u0432\u0442\u043E\u0440\u0438\u0442\u044C \u0434\u043E\u043A\u0430\u0447\u043A\u0443":ut.textContent="\u0414\u043E\u043A\u0430\u0447\u0430\u0442\u044C \u0441\u0435\u0439\u0447\u0430\u0441")}catch{}}l("loading",`\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 ${ie}`)}}finally{n=!1}}};i().catch(()=>{}),window.setInterval(()=>{i().catch(()=>{})},4e3),window.addEventListener("offline-full-pull-status",()=>{i().catch(()=>{})}),window.addEventListener("media-prefetch-paused",()=>{e().catch(()=>{}),i().catch(()=>{})}),window.addEventListener("online",()=>{e().catch(()=>{}),i().catch(()=>{})}),window.addEventListener("offline",()=>{e().catch(()=>{}),i().catch(()=>{})}),m.mediaPrefetchToggleBtn&&m.mediaPrefetchToggleBtn.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),vl(),e().catch(()=>{})}),m.offlineFetchBtn&&m.offlineFetchBtn.addEventListener("click",async l=>{l.preventDefault(),l.stopPropagation();try{if(!a.offlineReady){L("Offline \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0432 \u044D\u0442\u043E\u043C \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435");return}oa(!1),Tl({maxFailCountOnly:!0}).catch(()=>{});try{Ai()}catch{}Qo({force:!0}),L("\u0414\u043E\u043A\u0430\u0447\u0438\u0432\u0430\u0435\u043C \u043E\u0444\u043B\u0430\u0439\u043D\u2011\u0434\u0430\u043D\u043D\u044B\u0435 \u0432 \u0444\u043E\u043D\u0435\u2026"),m.userMenu?.classList.add("hidden"),m.userMenuBtn?.setAttribute("aria-expanded","false"),i().catch(()=>{})}catch(u){L(u?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u0434\u043E\u043A\u0430\u0447\u043A\u0443")}}),document.addEventListener("keydown",l=>{a.isOutlineEditing||lb(l)||(a.mode==="view"?(Ip(l),kp(l)):Ap(l))}),document.addEventListener("beforeinput",l=>{if(!a.isOutlineEditing&&(l.inputType==="historyUndo"||l.inputType==="historyRedo")){if(a.mode==="edit"&&a.editingBlockId&&l.target instanceof HTMLElement&&l.target.closest('.block-text[contenteditable="true"]')){l.preventDefault();let f=l.inputType==="historyUndo"?-1:1;oo(f);return}l.preventDefault(),l.inputType==="historyUndo"?io():so()}},!0),document.addEventListener("paste",du),m.createArticleBtn&&m.createArticleBtn.addEventListener("click",()=>{di(),a.isSidebarMobileOpen&&en(!1)}),m.sidebarNewArticleBtn&&m.sidebarNewArticleBtn.addEventListener("click",()=>{di(),a.isSidebarMobileOpen&&en(!1)}),m.openInboxBtn&&m.openInboxBtn.addEventListener("click",()=>{Rs(),a.isSidebarMobileOpen&&en(!1)}),m.quickNoteAddBtn&&m.quickNoteAddBtn.addEventListener("click",()=>{Hs(),a.isSidebarMobileOpen&&en(!1)}),m.backToList&&m.backToList.addEventListener("click",()=>gt(pt.list)),m.sidebarRecentBtn&&m.sidebarRecentBtn.addEventListener("click",()=>{$a()});let s=l=>{if(Us(a.sidebarSearchView)==="search"){Ld(l);return}a.searchQuery="",a.searchResults=[],a.searchError="",a.searchLoading=!1,a.searchRequestId=0,Zn(),m.ragOpenBtn&&m.ragOpenBtn.classList.add("hidden"),Vi(l)};m.searchInput&&(m.searchInput.addEventListener("input",s),m.searchInput.addEventListener("focus",()=>{a.sidebarSearchView==="search"&&a.searchQuery.trim()&&Lr()})),m.sidebarSearchViewToggle&&m.sidebarSearchViewToggle.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation();let u=a.sidebarSearchView==="search"?"list":"search";ab(u),m.searchInput&&m.searchInput.focus({preventScroll:!0})});let c=()=>{!m.searchClearBtn||!m.searchInput||m.searchClearBtn.classList.toggle("hidden",!(m.searchInput.value||"").trim())};m.searchInput&&(m.searchInput.addEventListener("input",c),m.searchInput.addEventListener("focus",c),c()),m.searchClearBtn&&m.searchInput&&m.searchClearBtn.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),m.searchInput.value="",m.searchInput.focus({preventScroll:!0}),m.searchInput.dispatchEvent(new Event("input",{bubbles:!0})),c()}),m.ragOpenBtn&&m.ragOpenBtn.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),Md()});let d=()=>{if(!m.searchModeToggle)return;let l=a.searchMode==="semantic";m.searchModeToggle.classList.toggle("search-panel__toggle--active",l),m.searchModeToggle.dataset.mode=l?"semantic":"classic",m.searchModeToggle.setAttribute("title",l?"\u0421\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A \u0432\u043A\u043B\u044E\u0447\u0451\u043D":"\u041F\u0435\u0440\u0435\u043A\u043B\u044E\u0447\u0438\u0442\u044C\u0441\u044F \u043D\u0430 \u0441\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A"),m.searchModeToggle.setAttribute("aria-label",l?"\u0421\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A":"\u041A\u043B\u0430\u0441\u0441\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A"),Qc()};if(m.searchModeToggle&&(m.searchModeToggle.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),a.searchMode=a.searchMode==="semantic"?"classic":"semantic",d(),m.searchInput&&m.searchInput.dispatchEvent(new Event("input",{bubbles:!0}))}),d()),m.editTitleBtn&&m.editTitleBtn.addEventListener("click",$s),m.articleTitle&&(m.articleTitle.addEventListener("dblclick",$s),m.articleTitle.addEventListener("click",fp),m.articleTitle.draggable=!0,m.articleTitle.addEventListener("dragstart",l=>{a.articleId&&(l.dataTransfer&&(l.dataTransfer.effectAllowed="move",l.dataTransfer.setData("text/plain",a.articleId)),window.__ttreeDraggingArticleId=a.articleId)}),m.articleTitle.addEventListener("dragend",()=>{window.__ttreeDraggingArticleId=null})),m.articleMenuBtn&&m.articleMenuBtn.addEventListener("click",yp),m.articleFavoriteBtn&&m.articleFavoriteBtn.addEventListener("click",l=>{l.stopPropagation(),!(!a.article||!a.article.id||a.article.id==="inbox")&&(Qr(a.article.id),gn())}),m.listMenuBtn&&m.listMenu&&(m.listMenuBtn.addEventListener("click",l=>{l.stopPropagation();let u=m.listMenu.classList.contains("hidden");$p(u)}),document.addEventListener("click",l=>{let u=l.target;!m.listMenu||m.listMenu.classList.contains("hidden")||m.listMenu.contains(u)||m.listMenuBtn.contains(u)||bo()},!0)),m.articleEncryptionBtn&&m.articleEncryptionBtn.addEventListener("click",l=>{l.stopPropagation(),Yi()}),m.articleEncryptionRemoveBtn&&m.articleEncryptionRemoveBtn.addEventListener("click",l=>{l.stopPropagation(),Xi()}),m.articlePublicLinkBtn&&m.articlePublicLinkBtn.addEventListener("click",async l=>{if(l.stopPropagation(),!a.article||!a.article.publicSlug){L("\u0421\u0434\u0435\u043B\u0430\u0439\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u043E\u0439, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443");return}let u=a.article.publicSlug,f=`${window.location.origin}/p/${encodeURIComponent(u)}`;await Pi({url:f})}),m.articlePublicToggleBtn&&m.articlePublicToggleBtn.addEventListener("click",async l=>{if(l.stopPropagation(),cr(),!a.article||!a.articleId){L("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}if(!a.currentUser){L("\u041D\u0443\u0436\u043D\u043E \u0432\u043E\u0439\u0442\u0438 \u0432 \u0441\u0438\u0441\u0442\u0435\u043C\u0443");return}let u=!a.article.publicSlug;try{let p=(await De(`/api/articles/${a.articleId}/public`,{method:"POST",body:JSON.stringify({public:u})})).publicSlug||null;if(a.article={...a.article,publicSlug:p},m.articlePublicToggleBtn&&(m.articlePublicToggleBtn.textContent=p?"\u041E\u0442\u043C\u0435\u043D\u0438\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435":"\u0414\u0430\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435"),gn(),u&&p){let y=`${window.location.origin}/p/${encodeURIComponent(p)}`;await Pi({url:y})}else u||L("\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u044B\u0439 \u0434\u043E\u0441\u0442\u0443\u043F \u043A \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0435 \u0432\u044B\u043A\u043B\u044E\u0447\u0435\u043D")}catch(f){L(f.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u044B\u0439 \u0434\u043E\u0441\u0442\u0443\u043F")}}),m.exportArticleBtn&&m.exportArticleBtn.addEventListener("click",async l=>{l.stopPropagation(),cr();try{let{exportCurrentArticleAsHtml:u}=await Dp();u?.()}catch{L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C")}}),m.saveVersionBtn&&m.saveVersionBtn.addEventListener("click",async l=>{if(l.stopPropagation(),cr(),!!a.articleId)try{let u=await Gt({title:"\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0432\u0435\u0440\u0441\u0438\u044E",message:"\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0432\u0435\u0440\u0441\u0438\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u044B\u043C)",placeholder:"\u041D\u0430\u043F\u0440\u0438\u043C\u0435\u0440: \u043F\u0435\u0440\u0435\u0434 \u0440\u0435\u0444\u0430\u043A\u0442\u043E\u0440\u0438\u043D\u0433\u043E\u043C",confirmText:"\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",allowEmpty:!0});if(u===null)return;It("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C \u0432\u0435\u0440\u0441\u0438\u044E\u2026"),await sd(a.articleId,(u||"").trim()||null),ot(),L("\u0412\u0435\u0440\u0441\u0438\u044F \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0430")}catch(u){ot(),L(u?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0432\u0435\u0440\u0441\u0438\u044E")}}),m.versionsBtn&&m.versionsBtn.addEventListener("click",async l=>{if(l.stopPropagation(),cr(),!!a.articleId){if(a.article?.encrypted){L("\u0421\u0440\u0430\u0432\u043D\u0435\u043D\u0438\u0435 \u0432\u0435\u0440\u0441\u0438\u0439 \u043F\u043E\u043A\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0434\u043B\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0445 \u0441\u0442\u0430\u0442\u0435\u0439");return}try{It("\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0432\u0435\u0440\u0441\u0438\u0438\u2026");let u=await ad(a.articleId);ot();let f=Array.isArray(u?.versions)?u.versions:[],p=await ma({versions:f});if(!p)return;let y=typeof p=="string"?{action:"restore",versionId:p}:p;if(!y||!y.versionId)return;let{action:b,versionId:h}=y;if(b==="compare"){let S=G=>{try{let ie=new Date(G);return Number.isNaN(ie.getTime())?String(G||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(ie)}catch{return String(G||"")}},x=G=>{let ie=f.find($e=>String($e?.id||"")===String(G));return String(ie&&(ie?.label||S(ie?.created_at||ie?.createdAt))||G)},T=await ha({versions:f,excludeId:h});if(!T)return;It("\u0421\u0440\u0430\u0432\u043D\u0438\u0432\u0430\u0435\u043C\u2026");let N=await ua(a.articleId,h),B=N?.docJson||N?.doc_json||null,$=null,U=`\u0412\u0435\u0440\u0441\u0438\u044F: ${x(h)}`,Y="\u0422\u0435\u043A\u0443\u0449\u0430\u044F";if(T.target==="current")$=a.article?.docJson||a.article?.doc_json||null;else{let G=await ua(a.articleId,T.versionId);$=G?.docJson||G?.doc_json||null,Y=`\u0412\u0435\u0440\u0441\u0438\u044F: ${x(T.versionId)}`}ot();let J=_p(B||{}),re=_p($||{}),he=[],Re=new Set;J.order.forEach(G=>{Re.add(G);let ie=J.map.get(G),$e=re.map.get(G);if(!$e){he.push({type:"removed",id:G,label:ie?.label||G,before:ie?.indexText||"",after:""});return}(ie?.indexText||"")!==($e?.indexText||"")&&he.push({type:"changed",id:G,label:$e?.label||ie?.label||G,before:ie?.indexText||"",after:$e?.indexText||""})}),re.order.forEach(G=>{if(Re.has(G))return;let ie=re.map.get(G);he.push({type:"added",id:G,label:ie?.label||G,before:"",after:ie?.indexText||""})}),await ga({title:"\u041E\u0442\u043B\u0438\u0447\u0438\u044F",beforeTitle:U,afterTitle:Y,changes:he});return}if(!await On({title:"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0432\u0435\u0440\u0441\u0438\u044E?",message:"\u0422\u0435\u043A\u0443\u0449\u0435\u0435 \u0441\u043E\u0434\u0435\u0440\u0436\u0438\u043C\u043E\u0435 \u0441\u0442\u0430\u0442\u044C\u0438 \u0431\u0443\u0434\u0435\u0442 \u0437\u0430\u043C\u0435\u043D\u0435\u043D\u043E \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0439 \u0432\u0435\u0440\u0441\u0438\u0435\u0439.",confirmText:"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"}))return;let w=!!a.isOutlineEditing;if(It("\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C\u2026"),await cd(a.articleId,h),await Ht(a.articleId,{resetUndoStacks:!0}),w){let{closeOutlineEditor:S,openOutlineEditor:x}=await ob();S?.(),await x?.()}else nt();ot(),L("\u0412\u0435\u0440\u0441\u0438\u044F \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0430")}catch(u){ot(),L(u?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0432\u0435\u0440\u0441\u0438\u0438")}}}),m.blockHistoryBtn&&m.blockHistoryBtn.addEventListener("click",async l=>{if(l.stopPropagation(),cr(),!(!a.articleId||!a.article)){if(a.article.encrypted){L("\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0431\u043B\u043E\u043A\u043E\u0432 \u043F\u043E\u043A\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0434\u043B\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0445 \u0441\u0442\u0430\u0442\u0435\u0439");return}try{let u=a.currentBlockId||null;if(a.isOutlineEditing)try{let w=await Promise.resolve().then(()=>(ar(),sr));w?.getOutlineActiveSectionId&&(u=w.getOutlineActiveSectionId()||u)}catch{}if(!u){L("\u041D\u0435 \u0432\u044B\u0431\u0440\u0430\u043D \u0431\u043B\u043E\u043A");return}It("\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0438\u0441\u0442\u043E\u0440\u0438\u044E\u2026");let f=await De(`/api/articles/${encodeURIComponent(a.articleId)}/blocks/${encodeURIComponent(u)}/history?limit=200`);ot();let y=(Array.isArray(f?.entries)?f.entries:[]).map(w=>({...w,beforePlain:String(w.beforePlain??w.before??""),afterPlain:String(w.afterPlain??w.after??"")})),b=await ya({title:"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0431\u043B\u043E\u043A\u0430",entries:y,canRestore:!0,beforeTitle:"\u0414\u043E",afterTitle:"\u041F\u043E\u0441\u043B\u0435"});if(!b||b.action!=="restore"||!b.entry||!await On({title:"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0431\u043B\u043E\u043A?",message:"\u0411\u043B\u043E\u043A \u0431\u0443\u0434\u0435\u0442 \u0437\u0430\u043C\u0435\u043D\u0451\u043D \u043D\u0430 \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u043F\u043E\u0441\u043B\u0435 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F.",confirmText:"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"}))return;if(a.isOutlineEditing){let w=await Promise.resolve().then(()=>(ar(),sr)),S={heading:b.entry.afterHeadingJson||null,body:b.entry.afterBodyJson||null};if(w?.restoreOutlineSectionFromSectionFragments){if(w.restoreOutlineSectionFromSectionFragments(u,S)){L("\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u043E (\u0431\u0443\u0434\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438)");return}if(w?.insertOutlineSectionFromSectionFragmentsAtEnd){if(!await On({title:"\u0411\u043B\u043E\u043A \u0443\u0434\u0430\u043B\u0451\u043D",message:"\u0421\u0435\u043A\u0446\u0438\u044F \u0441 \u044D\u0442\u0438\u043C ID \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430 \u0432 \u0442\u0435\u043A\u0443\u0449\u0435\u0439 \u0441\u0442\u0430\u0442\u044C\u0435. \u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u043D\u0443\u044E \u0441\u0435\u043A\u0446\u0438\u044E \u0432 \u043A\u043E\u043D\u0435\u0446 \u0441\u0442\u0430\u0442\u044C\u0438?",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u043D\u0435\u0446",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"}))return;if(w.insertOutlineSectionFromSectionFragmentsAtEnd(u,S)){L("\u0412\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u043E \u0432 \u043A\u043E\u043D\u0435\u0446 (\u0431\u0443\u0434\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438)");return}}L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C: \u0441\u0435\u043A\u0446\u0438\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}}let g=String(b.entry.after||"");It("\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C\u2026"),await De(`/api/articles/${encodeURIComponent(a.articleId)}/blocks/${encodeURIComponent(u)}`,{method:"PATCH",body:JSON.stringify({text:g})}),ot(),await Ht(a.articleId,{desiredBlockId:u,resetUndoStacks:!0}),nt(),L("\u0411\u043B\u043E\u043A \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D")}catch(u){ot(),L(u?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0441\u0442\u043E\u0440\u0438\u044E \u0431\u043B\u043E\u043A\u0430")}}}),m.articleHistoryBtn&&m.articleHistoryBtn.addEventListener("click",async l=>{if(l.stopPropagation(),cr(),!(!a.articleId||!a.article)){if(a.article.encrypted){L("\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u043E\u043A\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0434\u043B\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0445 \u0441\u0442\u0430\u0442\u0435\u0439");return}try{let u=Array.isArray(a.article.history)?a.article.history:[];if(!u.length){It("\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0438\u0441\u0442\u043E\u0440\u0438\u044E\u2026");let p=await jl(a.articleId);ot(),a.article&&a.articleId&&(a.article.history=Array.isArray(p?.history)?p.history:[],a.article.redoHistory=Array.isArray(p?.redoHistory)?p.redoHistory:[],a.article.blockTrash=Array.isArray(p?.blockTrash)?p.blockTrash:[]),u=Array.isArray(a.article?.history)?a.article.history:[]}let f=u.filter(p=>p&&(p.beforeHeadingJson||p.beforeBodyJson||p.afterHeadingJson||p.afterBodyJson));await ba({title:"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0441\u0442\u0430\u0442\u044C\u0438",entries:f,canRestore:!0,beforeTitle:"\u0414\u043E",afterTitle:"\u041F\u043E\u0441\u043B\u0435",onRestore:async p=>{try{if(!a.articleId||!a.article)return;let y=String(p?.blockId||"").trim();if(!y){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C: \u043D\u0435\u0442 ID \u0441\u0435\u043A\u0446\u0438\u0438");return}if(!await On({title:"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C?",message:"\u0415\u0441\u043B\u0438 \u0441\u0435\u043A\u0446\u0438\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430, \u043E\u043D\u0430 \u0431\u0443\u0434\u0435\u0442 \u0432\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u0430 \u0432 \u043A\u043E\u043D\u0435\u0446 \u0441\u0442\u0430\u0442\u044C\u0438.",confirmText:"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"}))return;if(!a.isOutlineEditing){L("\u041E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 outline-\u0440\u0435\u0436\u0438\u043C, \u0447\u0442\u043E\u0431\u044B \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u0435\u043A\u0446\u0438\u044E");return}let h=await Promise.resolve().then(()=>(ar(),sr)),g={heading:p.afterHeadingJson||null,body:p.afterBodyJson||null};if(h?.restoreOutlineSectionFromSectionFragments&&h.restoreOutlineSectionFromSectionFragments(y,g)){L("\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u043E (\u0431\u0443\u0434\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438)");return}if(h?.insertOutlineSectionFromSectionFragmentsAtEnd&&h.insertOutlineSectionFromSectionFragmentsAtEnd(y,g)){L("\u0412\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u043E \u0432 \u043A\u043E\u043D\u0435\u0446 (\u0431\u0443\u0434\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438)");return}L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u0435\u043A\u0446\u0438\u044E")}catch(y){L(y?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u0435\u043A\u0446\u0438\u044E")}}})}catch(u){L(u?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0438\u0441\u0442\u043E\u0440\u0438\u044E \u0441\u0442\u0430\u0442\u044C\u0438")}}}),m.exportCurrentBlockBtn&&m.exportCurrentBlockBtn.addEventListener("click",async l=>{l.preventDefault();try{let{exportCurrentBlockAsHtml:u}=await Dp();await u?.()}catch{L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C")}}),m.exportAllHtmlZipBtn&&m.exportAllHtmlZipBtn.addEventListener("click",async l=>{l.stopPropagation(),bo();try{It("\u0413\u043E\u0442\u043E\u0432\u0438\u043C \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u0443\u044E \u043A\u043E\u043F\u0438\u044E (ZIP)...");let u=await fetch("/api/export/html-zip",{method:"GET"});if(!u.ok){ot(),L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u0443\u044E \u043A\u043E\u043F\u0438\u044E");return}if(u.status===204){ot(),L("\u041D\u0435\u0442 \u0441\u0442\u0440\u0430\u043D\u0438\u0446 \u0434\u043B\u044F \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438");return}let f=await u.blob();if(!f||f.size===0){ot(),L("\u041D\u0435\u0442 \u0434\u0430\u043D\u043D\u044B\u0445 \u0434\u043B\u044F \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438 (\u043F\u0443\u0441\u0442\u043E\u0439 \u0430\u0440\u0445\u0438\u0432)");return}let p=URL.createObjectURL(f),y=document.createElement("a"),b=u.headers.get("Content-Disposition")||"",h="memus-backup.zip",g=b.match(/filename=\"?([^\";]+)\"?/i);g&&g[1]&&(h=g[1]),y.href=p,y.download=h,y.rel="noopener",document.body.appendChild(y),ot(),y.click(),document.body.removeChild(y),setTimeout(()=>URL.revokeObjectURL(p),0),L("\u0420\u0435\u0437\u0435\u0440\u0432\u043D\u0430\u044F \u043A\u043E\u043F\u0438\u044F \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u0430")}catch(u){ot(),L(u.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u0443\u044E \u043A\u043E\u043F\u0438\u044E")}}),m.importArticleBtn&&m.importArticleBtn.addEventListener("click",async l=>{l.stopPropagation(),bo();try{let u=document.createElement("input");u.type="file",u.accept=".html,text/html",u.multiple=!1,u.addEventListener("change",async()=>{let f=u.files&&u.files[0];if(f)try{It("\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0438 \u043E\u0431\u0440\u0430\u0431\u0430\u0442\u044B\u0432\u0430\u0435\u043C HTML...");let y=await Op(f,{decision:null,applyToAll:!1},{allowApplyToAll:!1});ot(),y&&y.id?(gt(pt.article(y.id)),L("\u0421\u0442\u0430\u0442\u044C\u044F \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0430")):L("\u0418\u043C\u043F\u043E\u0440\u0442 \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u043B\u0441\u044F \u0431\u0435\u0437 \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u0430")}catch(p){ot(),It(p.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C HTML")}}),u.click()}catch(u){L(u.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u0438\u043C\u043F\u043E\u0440\u0442")}}),m.importMarkdownBtn&&m.importMarkdownBtn.addEventListener("click",async l=>{l.stopPropagation(),bo();try{let u="";try{let p=window.localStorage.getItem("logseqAssetsBaseUrl")||"";u=await Gt({title:"\u0410\u0434\u0440\u0435\u0441 assets \u0434\u043B\u044F Markdown",message:"\u0415\u0441\u043B\u0438 \u0432 \u0444\u0430\u0439\u043B\u0435 \u0435\u0441\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0438 \u0432\u0438\u0434\u0430 ../assets/..., \u0443\u043A\u0430\u0436\u0438 \u0431\u0430\u0437\u043E\u0432\u044B\u0439 URL, \u0433\u0434\u0435 \u043B\u0435\u0436\u0430\u0442 \u044D\u0442\u0438 \u0444\u0430\u0439\u043B\u044B (\u043D\u0430\u043F\u0440\u0438\u043C\u0435\u0440 https://prismatic-salamander-2afe94.netlify.app). \u0412\u043D\u0443\u0442\u0440\u0438 \u043D\u0435\u0433\u043E \u0431\u0443\u0434\u0443\u0442 \u0438\u0441\u043A\u0430\u0442\u044C\u0441\u044F \u0444\u0430\u0439\u043B\u044B \u0432 \u043A\u043E\u0440\u043D\u0435 \u0438\u043B\u0438 \u0432 \u043F\u043E\u0434\u043F\u0430\u043F\u043A\u0435 /assets.",confirmText:"\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"https://example.netlify.app",defaultValue:p})}catch{return}if(u=(u||"").trim(),u)try{window.localStorage.setItem("logseqAssetsBaseUrl",u)}catch{}let f=document.createElement("input");f.type="file",f.accept=".md,text/markdown,text/plain",f.multiple=!1,f.addEventListener("change",async()=>{let p=f.files&&f.files[0];if(p)try{It("\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0438 \u043E\u0431\u0440\u0430\u0431\u0430\u0442\u044B\u0432\u0430\u0435\u043C Markdown...");let y=await pd(p,u);ot(),y&&y.id?(gt(pt.article(y.id)),L("\u0421\u0442\u0430\u0442\u044C\u044F \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0430 \u0438\u0437 Markdown")):L("\u0418\u043C\u043F\u043E\u0440\u0442 \u0438\u0437 Markdown \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u043B\u0441\u044F \u0431\u0435\u0437 \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u0430")}catch(y){ot(),It(y.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C Markdown")}}),f.click()}catch(u){L(u.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u0438\u043C\u043F\u043E\u0440\u0442 Markdown")}}),m.importBackupFolderBtn&&m.importBackupFolderBtn.addEventListener("click",async l=>{l.stopPropagation(),bo();try{let u=document.createElement("input");u.type="file",u.webkitdirectory=!0,u.multiple=!0,u.addEventListener("change",async()=>{let p=Array.from(u.files||[]).filter(h=>h.name&&h.name.toLowerCase().endsWith(".html"));if(!p.length){L("\u0412 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0439 \u043F\u0430\u043F\u043A\u0435 \u043D\u0435\u0442 HTML\u2011\u0444\u0430\u0439\u043B\u043E\u0432 Memus");return}let y={decision:null,applyToAll:!1},b=0;It(`\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u0443\u0435\u043C \u0438\u0437 \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438... (0 / ${p.length})`);for(let h of p){let g=await Op(h,y,{allowApplyToAll:!0});g&&g.id&&(b+=1),It(`\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u0443\u0435\u043C \u0438\u0437 \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438... (${b} / ${p.length})`)}ot(),b>0?(L(`\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0441\u0442\u0440\u0430\u043D\u0438\u0446 \u0438\u0437 \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438: ${b}`),gt(pt.list)):L("\u0418\u043C\u043F\u043E\u0440\u0442 \u0438\u0437 \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438 \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u043B\u0441\u044F \u0431\u0435\u0437 \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u0430")}),u.click()}catch(u){L(u.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u0438\u043C\u043F\u043E\u0440\u0442 \u0438\u0437 \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438")}}),m.importLogseqBtn&&m.importLogseqBtn.addEventListener("click",async l=>{l.stopPropagation(),bo();try{if(!await On({title:"\u0418\u043C\u043F\u043E\u0440\u0442 \u0438\u0437 Logseq",message:"\u0412\u0441\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0438\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B \u0441 \u0442\u0430\u043A\u0438\u043C\u0438 \u0436\u0435 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F\u043C\u0438 \u0431\u0443\u0434\u0443\u0442 \u0443\u0434\u0430\u043B\u0435\u043D\u044B \u0438 \u0437\u0430\u043C\u0435\u043D\u0435\u043D\u044B \u0432\u0435\u0440\u0441\u0438\u044F\u043C\u0438 \u0438\u0437 \u0430\u0440\u0445\u0438\u0432\u0430 Logseq. \u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C?",confirmText:"\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"}))return;let f="";try{let y=window.localStorage.getItem("logseqAssetsBaseUrl")||"";f=await Gt({title:"\u0410\u0434\u0440\u0435\u0441 assets \u0434\u043B\u044F Logseq",message:"\u0423\u043A\u0430\u0436\u0438 \u0431\u0430\u0437\u043E\u0432\u044B\u0439 URL, \u0433\u0434\u0435 \u043B\u0435\u0436\u0430\u0442 assets (\u043D\u0430\u043F\u0440\u0438\u043C\u0435\u0440 https://prismatic-salamander-2afe94.netlify.app). \u0412\u043D\u0443\u0442\u0440\u0438 \u043D\u0435\u0433\u043E \u0434\u043E\u043B\u0436\u043D\u044B \u0431\u044B\u0442\u044C \u0444\u0430\u0439\u043B\u044B \u0432 \u043F\u0430\u043F\u043A\u0435 /assets.",confirmText:"\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"https://example.netlify.app",defaultValue:y})}catch{return}if(f=(f||"").trim(),!f)return;try{window.localStorage.setItem("logseqAssetsBaseUrl",f)}catch{}L("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 ZIP-\u0430\u0440\u0445\u0438\u0432 Logseq \u0441 \u043F\u0430\u043F\u043A\u043E\u0439 pages/");let p=document.createElement("input");p.type="file",p.accept=".zip,application/zip",p.multiple=!1,p.addEventListener("change",async()=>{let y=p.files&&p.files[0];if(y)try{It("\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0438 \u043E\u0431\u0440\u0430\u0431\u0430\u0442\u044B\u0432\u0430\u0435\u043C \u0430\u0440\u0445\u0438\u0432 Logseq...");let b=await md(y,f);ot();let h=Array.isArray(b)?b:[];h.length>0&&h[0].id?(gt(pt.article(h[0].id)),h.length===1?L("\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0430 \u0438\u0437 Logseq"):L(`\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0441\u0442\u0440\u0430\u043D\u0438\u0446 \u0438\u0437 Logseq: ${h.length}`)):L("\u0418\u043C\u043F\u043E\u0440\u0442 \u0438\u0437 Logseq \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u043B\u0441\u044F \u0431\u0435\u0437 \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u0430")}catch(b){ot(),It(b.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0430\u0440\u0445\u0438\u0432 Logseq")}}),p.click()}catch(u){L(u.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u0438\u043C\u043F\u043E\u0440\u0442 Logseq")}}),m.deleteArticleBtn&&m.deleteArticleBtn.addEventListener("click",wp),m.articleTitleInput&&(m.articleTitleInput.addEventListener("keydown",mp),m.articleTitleInput.addEventListener("blur",hp)),m.hintToggleBtn&&m.hintToggleBtn.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),window.open("/help.html","_blank","noopener,noreferrer")||Ca(l)}),m.sidebarToggle&&m.sidebarToggle.addEventListener("click",Ba),vp(),m.dragModeToggleBtn&&m.dragModeToggleBtn.addEventListener("click",()=>{Ns()}),m.blocksContainer&&m.blocksContainer.addEventListener("click",l=>{if(a.mode!=="view"||!a.article||!Array.isArray(a.article.blocks)||!a.article.blocks.length||l.target.closest(".block"))return;let f=m.blocksContainer.querySelectorAll(".block[data-block-id]");if(!f.length)return;let p=f[f.length-1],y=p.getBoundingClientRect();if(l.clientY<=y.bottom+4)return;let b=p.getAttribute("data-block-id");b&&(a.currentBlockId=b,gr("after"))}),m.articleFilterInput&&m.articleFilterInput.addEventListener("input",Vi),m.searchInput&&m.searchInput.addEventListener("keydown",l=>{if(a.sidebarSearchView!=="list")return;if(l.key==="Escape"){l.stopPropagation(),l.preventDefault(),m.searchInput.value="",a.articleFilterQuery="",er(),wt(),lr=0,c();return}let{key:u,ctrlKey:f,altKey:p,metaKey:y}=l;if(f||p||y||u.length!==1)return;let b=Date.now();(!lr||b-lr>2e3)&&(m.searchInput.value="",a.articleFilterQuery="",wt(),c()),lr=b}),m.articleUndoBtn&&m.articleUndoBtn.addEventListener("click",l=>{l.preventDefault(),io()}),m.articleRedoBtn&&m.articleRedoBtn.addEventListener("click",l=>{l.preventDefault(),so()}),m.deleteCurrentBlockBtn&&m.deleteCurrentBlockBtn.addEventListener("click",async l=>{l.preventDefault(),await Zi()}),m.articleBlockTrashBtn&&m.articleBlockTrashBtn.addEventListener("click",async l=>{if(l.preventDefault(),!a.article||!a.articleId){L("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}let u=Array.isArray(a.article.blockTrash)?a.article.blockTrash:[];if(!u.length){L("\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432 \u043F\u0443\u0441\u0442\u0430");return}try{let f=await Sa({items:u});if(!f)return;let p=a.articleId;if(f.action==="clear"){await De(`/api/articles/${p}/blocks/trash/clear`,{method:"POST",body:JSON.stringify({})}),a.article&&(a.article.blockTrash=[]),L("\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432 \u043E\u0447\u0438\u0449\u0435\u043D\u0430");return}if(!f.id)return;let y=await De(`/api/articles/${p}/blocks/trash/restore`,{method:"POST",body:JSON.stringify({id:f.id})}),b=y&&y.block&&y.block.id||y.blockId||f.id,h=await Ht(p,{desiredBlockId:b||null,resetUndoStacks:!0});a.article=h,nt(),L("\u0411\u043B\u043E\u043A \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D \u0438\u0437 \u043A\u043E\u0440\u0437\u0438\u043D\u044B")}catch(f){L(f.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u0438\u0437 \u043A\u043E\u0440\u0437\u0438\u043D\u044B")}}),m.articleNewBlockBtn&&m.articleNewBlockBtn.addEventListener("click",l=>{if(l.preventDefault(),!a.article||!a.currentBlockId){L("\u041D\u0435\u0442 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u0431\u043B\u043E\u043A\u0430");return}gr("after")}),m.mergeBlocksBtn&&m.mergeBlocksBtn.addEventListener("click",async l=>{l.preventDefault(),await Ps()}),m.splitBlockBtn&&m.splitBlockBtn.addEventListener("click",async l=>{if(l.preventDefault(),a.mode!=="edit"||!a.editingBlockId){L("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0432\u043A\u043B\u044E\u0447\u0438\u0442\u0435 \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430");return}await Zr()}),m.insertTableBtn&&m.insertTableBtn.addEventListener("click",l=>{if(l.preventDefault(),a.mode!=="edit"||!a.editingBlockId){L("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0432\u043A\u043B\u044E\u0447\u0438\u0442\u0435 \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430");return}let u=document.querySelector(`.block[data-block-id="${a.editingBlockId}"] .block-text[contenteditable="true"]`);if(!u){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u0431\u043B\u043E\u043A \u0434\u043B\u044F \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0442\u0430\u0431\u043B\u0438\u0446\u044B");return}let f=['<table class="memus-table">',"<thead>","<tr>","<th>\u0417\u0430\u0433\u043E\u043B\u043E\u0432\u043E\u043A 1</th>","<th>\u0417\u0430\u0433\u043E\u043B\u043E\u0432\u043E\u043A 2</th>","</tr>","</thead>","<tbody>","<tr>","<td>\u042F\u0447\u0435\u0439\u043A\u0430 1</td>","<td>\u042F\u0447\u0435\u0439\u043A\u0430 2</td>","</tr>","</tbody>","</table>","<p><br /></p>"].join("");Tn(u,f),u.classList.remove("block-body--empty")}),m.articlesTabBtn&&m.articlesTabBtn.addEventListener("click",()=>Fo(!1)),m.trashTabBtn&&m.trashTabBtn.addEventListener("click",()=>Fo(!0)),m.telegramLinkBtn&&m.telegramLinkBtn.addEventListener("click",async l=>{l.preventDefault(),l.stopPropagation();try{let u=await id(),f=u&&u.token||"";if(!f){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u043A\u043E\u0434 \u043F\u0440\u0438\u0432\u044F\u0437\u043A\u0438 Telegram");return}let p=`/link ${f}`;await Gt({title:"\u041F\u0440\u0438\u0432\u044F\u0437\u0430\u0442\u044C Telegram",message:["\u0427\u0442\u043E\u0431\u044B \u043F\u0440\u0438\u0432\u044F\u0437\u0430\u0442\u044C \u044D\u0442\u043E\u0442 \u0430\u043A\u043A\u0430\u0443\u043D\u0442 Memus \u043A \u0447\u0430\u0442\u0443 \u0432 Telegram:","","1. \u041E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0447\u0430\u0442 \u0441 \u0431\u043E\u0442\u043E\u043C.","2. \u041E\u0442\u043F\u0440\u0430\u0432\u044C\u0442\u0435 \u0435\u043C\u0443 \u044D\u0442\u0443 \u043A\u043E\u043C\u0430\u043D\u0434\u0443:","",p].join(`
`),defaultValue:p,placeholder:"/link \u2026",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",hideConfirm:!0})}catch(u){L(u.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043A\u043E\u0434 \u043F\u0440\u0438\u0432\u044F\u0437\u043A\u0438 Telegram")}}),m.userMenuBtn&&m.userMenu&&m.userMenuBtn.addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),!m.userMenu.classList.contains("hidden")?(m.userMenu.classList.add("hidden"),m.userMenuBtn.setAttribute("aria-expanded","false")):(m.userMenu.classList.remove("hidden"),m.userMenuBtn.setAttribute("aria-expanded","true"),cb())}),m.semanticReindexBtn){let l=m.semanticReindexBtn.querySelector(".sidebar-user-menu-label");l&&l.textContent&&(Rp=l.textContent.trim()),m.semanticReindexBtn.addEventListener("click",async u=>{if(u.preventDefault(),u.stopPropagation(),Xc){L("\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F \u0443\u0436\u0435 \u0432\u044B\u043F\u043E\u043B\u043D\u044F\u0435\u0442\u0441\u044F");return}let p=window.confirm(`\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A:

OK \u2014 \u0432\u0441\u0451 \u0437\u0430\u043D\u043E\u0432\u043E (\u043F\u0435\u0440\u0435\u0441\u0447\u0438\u0442\u0430\u0442\u044C \u0432\u0441\u0435 embeddings)
\u041E\u0442\u043C\u0435\u043D\u0430 \u2014 \u0442\u043E\u043B\u044C\u043A\u043E \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u044E\u0449\u0438\u0435 (\u0431\u044B\u0441\u0442\u0440\u0435\u0435)`)?"all":"missing";m.userMenu?.classList.add("hidden"),m.userMenuBtn?.setAttribute("aria-expanded","false");let y=m.semanticReindexBtn;y&&(y.disabled=!0);let b=()=>{Xc=!1,Fs!==null&&(clearTimeout(Fs),Fs=null),y&&(y.disabled=!1)},h=w=>{if(!w||typeof w!="object"){It("\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F \u0441\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u043E\u0433\u043E \u043F\u043E\u0438\u0441\u043A\u0430...",{protect:!0});return}let S=w.status||"unknown";if(S==="running"){let x=Number(w.total||0),T=Number(w.processed||0),N=Number(w.failed||0),B=Number(w.indexed||0),$=[];x>0?$.push(`${T}/${x}`):$.push(`${T}`),$.push(`\u0433\u043E\u0442\u043E\u0432\u043E: ${B}`),N&&$.push(`\u043E\u0448\u0438\u0431\u043A\u0438: ${N}`),It(`\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F\u2026 ${$.join(" \u2022 ")}`,{protect:!0});return}if(S==="cooldown"){let x=Number(w.cooldownRemainingSeconds||0);if(x>0){let T=Math.ceil(x/60);L(`\u0421\u043B\u0438\u0448\u043A\u043E\u043C \u0447\u0430\u0441\u0442\u043E: \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0447\u0435\u0440\u0435\u0437 ~${T} \u043C\u0438\u043D`)}else L("\u0421\u043B\u0438\u0448\u043A\u043E\u043C \u0447\u0430\u0441\u0442\u043E: \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u043F\u043E\u0437\u0436\u0435");return}if(S==="completed"){L(`\u0418\u043D\u0434\u0435\u043A\u0441 \u043E\u0431\u043D\u043E\u0432\u043B\u0451\u043D: ${w.indexed||0} \u0431\u043B\u043E\u043A\u043E\u0432`);return}if(S==="cancelled"){L("\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F \u043E\u0442\u043C\u0435\u043D\u0435\u043D\u0430");return}if(S==="failed"){L(w.error||"\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u043B\u0430\u0441\u044C \u0441 \u043E\u0448\u0438\u0431\u043A\u043E\u0439");return}L(`\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F: ${S}`)},g=async()=>{try{let w=await fetch("/api/search/semantic/reindex/status",{method:"GET",credentials:"include"});if(!w.ok){let x=await w.text().catch(()=>"");throw new Error(x||w.statusText)}let S=await w.json();if(!S||S.status==="idle"){ot({force:!0}),L("\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F \u043D\u0435 \u0437\u0430\u043F\u0443\u0449\u0435\u043D\u0430"),b();return}if(S.status==="running"){h(S),zs(S),Fs=setTimeout(g,1e3);return}ot({force:!0}),h(S),zs(S),b()}catch(w){ot({force:!0}),L(w.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u0443\u0441 \u043F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u0438"),b()}};try{let w=await fetch("/api/search/semantic/reindex",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:p})});if(!w.ok){let x=await w.text().catch(()=>"");throw new Error(x||w.statusText)}let S=await w.json();if(S&&S.status==="cooldown"){h(S),b();return}Xc=!0,h(S),zs(S),await g()}catch(w){ot({force:!0}),L(w.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A"),b()}})}m.telegramBotOpenBtn&&m.telegramBotOpenBtn.addEventListener("click",()=>{try{window.open("https://t.me/Memus_pro_bot","_blank","noopener,noreferrer")}catch{window.location.href="https://t.me/Memus_pro_bot"}}),m.telegramFeedbackBotOpenBtn&&m.telegramFeedbackBotOpenBtn.addEventListener("click",()=>{try{window.open("https://t.me/Memus_feedback_bot","_blank","noopener,noreferrer")}catch{window.location.href="https://t.me/Memus_feedback_bot"}}),document.addEventListener("click",l=>{if(m.searchPanel&&!m.searchPanel.contains(l.target)&&Zn(),qn&&m.hintPopover&&!m.hintPopover.contains(l.target)&&!(m.hintToggleBtn&&m.hintToggleBtn.contains(l.target))&&tr(),bp()&&m.articleMenu&&!m.articleMenu.contains(l.target)&&!(m.articleMenuBtn&&m.articleMenuBtn.contains(l.target))&&cr(),m.userMenu&&m.userMenuBtn){let u=l.target;if(m.userMenu.classList.contains("hidden")||m.userMenu.contains(u)||m.userMenuBtn.contains(u))return;m.userMenu.classList.add("hidden"),m.userMenuBtn.setAttribute("aria-expanded","false")}})}ft();vt();Pt();Et();Qn();hs();var pb="ttree_debug_quick_notes_v1";function mb(){try{return window?.localStorage?.getItem?.(pb)==="1"}catch{return!1}}function Vs(...e){try{if(!mb())return;console.log("[quick-notes][auth]",...e)}catch{}}var Fp=!1;function Vp(){if(Fp)return;Fp=!0;let e=null,t=null,n=async i=>{try{let s=String(i?.id||"").trim(),c=String(i?.text||"").trim();if(!s||!c||String(a.articleId||"")!=="inbox"||!a.article)return!1;let d=await Promise.resolve().then(()=>(ar(),sr));if(!d?.insertOutlineSectionFromPlainTextAtStart)return!1;let l=d.insertOutlineSectionFromPlainTextAtStart(s,c);return l&&Vs("inbox.inserted",{noteId:s}),!!l}catch{return!1}},r=()=>{typeof navigator<"u"&&navigator&&navigator.onLine===!1||t||(e&&clearTimeout(e),e=setTimeout(()=>{e=null;try{Vs("sync.start"),t=Promise.resolve().then(()=>(ao(),ps)).then(i=>i.enqueuePendingQuickNotesForSync?.()).then(i=>{Vs("sync.done",i||null)}).catch(()=>{}).finally(()=>{t=null})}catch{t=null}},7e3))},o=i=>{let s=i?.detail?.note;s&&n(s).catch(()=>{}),r()};try{window.addEventListener("memus:queued-inbox-changed",o),Vs("listener.attached")}catch{}}var zp=!1,el=null,qp="ttree_last_user_v1";async function hb(e){let t=typeof e=="number"?Math.max(0,Math.floor(e)):8e3;try{let n=typeof AbortController<"u"?new AbortController:null,r=!1,o=new Promise(c=>{setTimeout(()=>{r=!0;try{n?.abort?.()}catch{}c({status:"down",message:"timeout"})},t)}),i=(async()=>{try{let c=await fetch("/api/auth/me",{method:"GET",credentials:"include",signal:n?.signal});return r?null:c.status===401||c.status===403?{status:"auth"}:c.ok?{status:"ok",user:await c.json()}:{status:"down",message:(await c.json().catch(()=>({})))?.detail||`HTTP ${c.status}`}}catch(c){return r?null:c?.name==="AbortError"?{status:"down",message:"timeout"}:{status:"down",message:c?.message||"network"}}})(),s=await Promise.race([i,o]);return s&&typeof s=="object"?s:{status:"down",message:"timeout"}}catch(n){return{status:"down",message:n?.message||"network"}}}async function Up(e={}){let{reason:t}=e||{};try{let n=localStorage.getItem(qp),r=n?JSON.parse(n):null;if(!r||!r.id&&!r.username)return!1;jp(r),Kp(),Wp(),Vp();try{await wi(r);try{await Promise.resolve().then(()=>(ao(),ps)).then(o=>o.enqueuePendingQuickNotesForSync?.())}catch{}}catch(o){try{console.warn("[offline] init failed",o)}catch{}}return t&&L(`\u041E\u0444\u0444\u043B\u0430\u0439\u043D \u0440\u0435\u0436\u0438\u043C: \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 (${t})`),!0}catch{return!1}}function qs(){m.authOverlay&&m.authOverlay.classList.remove("hidden")}function Kp(){m.authOverlay&&m.authOverlay.classList.add("hidden")}function Jp(e){m.authError&&(m.authError.textContent=e||"",m.authError.classList.toggle("hidden",!e))}function tl(e){Jp(""),e==="login"&&(m.authSubtitle&&(m.authSubtitle.textContent="\u0417\u0430\u0445\u043E\u0434\u0438\u0442\u0435, \u044F \u0441\u043E\u0441\u043A\u0443\u0447\u0438\u043B\u0441\u044F! :)"),m.authStorageInfo&&(m.authStorageInfo.textContent="\u0423\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0435 \u043E \u0431\u0435\u0437\u043E\u043F\u0430\u0441\u043D\u043E\u0441\u0442\u0438: \u0422\u0435\u043A\u0441\u0442\u044B \u0438 \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0438 \u0445\u0440\u0430\u043D\u044F\u0442\u0441\u044F \u043D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0430\u0445 Memus.pro, \u0438\u043D\u044B\u0435 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043D\u044B\u0435 \u0444\u0430\u0439\u043B\u044B \u0441\u043E\u0445\u0440\u0430\u043D\u044F\u044E\u0442\u0441\u044F \u043D\u0430\u043F\u0440\u044F\u043C\u0443\u044E \u043D\u0430 \u0432\u0430\u0448 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A. \u0412\u044B \u043C\u043E\u0436\u0435\u0442\u0435 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u043F\u0440\u0438\u0432\u0430\u0442\u043D\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435.",m.authStorageInfo.classList.remove("hidden")),m.authGoogleLoginBtn&&m.authGoogleLoginBtn.classList.remove("hidden"),m.authYandexLoginBtn&&m.authYandexLoginBtn.classList.remove("hidden"))}function jp(e){a.currentUser=e;try{let n={id:e?.id||null,username:e?.username||null,displayName:e?.displayName||null,isSuperuser:!!e?.isSuperuser};(n.id||n.username)&&localStorage.setItem(qp,JSON.stringify(n))}catch{}m.currentUserLabel&&(m.currentUserLabel.textContent=e?.displayName||e?.username||"");let t=!!(e&&e.isSuperuser);m.openUsersViewBtn&&m.openUsersViewBtn.classList.toggle("hidden",!t),m.semanticReindexBtn&&m.semanticReindexBtn.classList.toggle("hidden",!t)}function Wp(){zp||!el||(zp=!0,el())}function Yp(e){el=e;try{window.addEventListener("memus:auth-required",()=>{try{if(navigator?.onLine===!1)return}catch{}try{a.serverStatus="auth",a.serverStatusText="auth"}catch{}tl("login"),qs()})}catch{}m.logoutBtn&&m.logoutBtn.addEventListener("click",async()=>{try{await ql()}catch{}a.currentUser=null,qs(),L("\u0412\u044B \u0432\u044B\u0448\u043B\u0438 \u0438\u0437 \u0430\u043A\u043A\u0430\u0443\u043D\u0442\u0430"),window.location.reload()}),m.authGoogleLoginBtn&&m.authGoogleLoginBtn.addEventListener("click",()=>{window.location.href="/api/auth/google/login"}),m.authYandexLoginBtn&&m.authYandexLoginBtn.addEventListener("click",()=>{window.location.href="/api/auth/yandex/login"})}async function Xp(){try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw a.serverStatus="down",a.serverStatusText="offline",new Error("offline");m.authSubtitle&&(m.authSubtitle.textContent="\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0431\u0430\u0437\u0443 \u0437\u043D\u0430\u043D\u0438\u0439\u2026"),m.authGoogleLoginBtn&&m.authGoogleLoginBtn.classList.add("hidden"),m.authYandexLoginBtn&&m.authYandexLoginBtn.classList.add("hidden");let e=await hb(8e3);if(e?.status==="ok"&&e.user){a.serverStatus="ok",a.serverStatusText="",jp(e.user),Kp(),Wp(),Vp();try{let r=()=>import("/outline/tiptap.bundle.js").catch(()=>{});typeof requestIdleCallback=="function"?requestIdleCallback(()=>r(),{timeout:2500}):setTimeout(()=>r(),800)}catch{}(r=>{try{if(typeof requestIdleCallback=="function"){requestIdleCallback(()=>r(),{timeout:3e3});return}}catch{}setTimeout(()=>r(),1500)})(()=>{(async()=>{let r=!1,o=!1,i=setTimeout(()=>{r=!0,L("\u0418\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0438\u0440\u0443\u0435\u043C offline-\u0431\u0430\u0437\u0443\u2026 (\u043C\u043E\u0436\u0435\u0442 \u0437\u0430\u043D\u044F\u0442\u044C \u0432\u0440\u0435\u043C\u044F)")},5e3);try{await wi(e.user);try{await Promise.resolve().then(()=>(ao(),ps)).then(c=>c.enqueuePendingQuickNotesForSync?.())}catch{}let s=await kc();Ac(),Qo({initialIndex:s||void 0}),o=!0}catch(s){L("Offline \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0432 \u044D\u0442\u043E\u043C \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435");try{console.warn("[offline] init failed",s)}catch{}}finally{clearTimeout(i),r&&o&&L("Offline-\u0431\u0430\u0437\u0430 \u0433\u043E\u0442\u043E\u0432\u0430")}})()});return}if(e?.status==="auth"){a.serverStatus="auth",a.serverStatusText="auth",tl("login"),qs();return}if(a.serverStatus="down",a.serverStatusText=e?.message?String(e.message):"down",await Up({reason:"\u043D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0430 \u043A \u0441\u0435\u0440\u0432\u0435\u0440\u0443"}))return}catch{}try{if(!navigator.onLine){if(await Up({reason:"\u043D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430"}))return;Jp("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430. \u041E\u0444\u0444\u043B\u0430\u0439\u043D-\u0440\u0435\u0436\u0438\u043C \u0431\u0443\u0434\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u043F\u043E\u0441\u043B\u0435 \u043F\u0435\u0440\u0432\u043E\u0433\u043E \u0432\u0445\u043E\u0434\u0430 \u043E\u043D\u043B\u0430\u0439\u043D.")}}catch{}tl("login"),qs()}tn();vt();try{window.__memusAppStarted=!0}catch{}function lm(){try{let e=new URLSearchParams(window.location.search||""),t=e.get("profile")??e.get("perf");if(t==null)return;let n=String(t).trim().toLowerCase();if(n==="1"||n==="true"||n==="yes"||n==="on"){window.localStorage.setItem("ttree_profile_v1","1");return}(n==="0"||n==="false"||n==="no"||n==="off")&&window.localStorage.removeItem("ttree_profile_v1")}catch{}}function dm(){if("serviceWorker"in navigator)try{navigator.serviceWorker.register("/uploads-sw.js",{scope:"/",updateViaCache:"none"}).then(e=>{try{let t=e?.update?.();t&&typeof t.catch=="function"&&t.catch(()=>{})}catch{}}).catch(()=>{})}catch{}}function Ys(e,t){if(!(typeof navigator<"u"&&navigator&&navigator.onLine===!1)){try{if(window?.localStorage?.getItem?.("ttree_client_log_v1")!=="1")return}catch{return}try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:e,data:t})}).catch(()=>{})}catch{}}}function um(e,{timeout:t=3e3,fallbackDelay:n=1200}={}){try{if(typeof requestIdleCallback=="function"){requestIdleCallback(()=>e(),{timeout:t});return}}catch{}setTimeout(()=>e(),n)}function Ob(e){try{let n=new URL(String(e||""),window.location.href).searchParams.get("v");return n?String(n):""}catch{return""}}function Rb(e){try{let t=performance.getEntriesByType?.("resource")||[];for(let n=t.length-1;n>=0;n-=1){let r=t[n]?.name;if(r&&e.test(String(r)))return Ob(r)}}catch{}return""}async function Hb(){try{if(!("serviceWorker"in navigator))return null;let e=async t=>await new Promise(n=>{if(!t)return n(null);let r=new MessageChannel,o=setTimeout(()=>n(null),500);r.port1.onmessage=i=>{clearTimeout(o),n(i.data||null)};try{t.postMessage({type:"memus:get-sw-build"},[r.port2])}catch{clearTimeout(o),n(null)}});if(navigator.serviceWorker.controller)return await e(navigator.serviceWorker.controller);try{let t=await navigator.serviceWorker.getRegistration();if(t?.active)return await e(t.active)}catch{}return await new Promise(t=>{let n=new MessageChannel,r=setTimeout(()=>t(null),300);n.port1.onmessage=o=>{clearTimeout(r),t(o.data||null)},navigator.serviceWorker.controller?.postMessage?.({type:"memus:get-sw-build"},[n.port2])})}catch{return null}}async function Xs(){let e=document.getElementById("sidebarVersionLabel");if(e)try{let t=Rb(/\/api\.js(\?|$)/),n=await Hb(),r=n?.buildId?String(n.buildId):"";if(r){try{window.__BUILD_ID__=r}catch{}e.textContent=`v${r}`;return}t&&(e.textContent=`api v${t}`)}catch{}}try{"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("controllerchange",()=>{Xs().catch(()=>{})})}catch{}function fm(){if(!m.graphToggleBtn)return;let e=null,t=async()=>{e||(e=Promise.resolve().then(()=>(nm(),tm)).then(n=>{m.graphToggleBtn?.removeEventListener("click",t,!0),n.initGraphView?.(),n.openGraphView?.()}).catch(()=>{}).finally(()=>{e=null}))};m.graphToggleBtn.addEventListener("click",t,!0)}function $b(){if(!m.openUsersViewBtn)return;let e=null,t=async()=>{e||(e=Promise.resolve().then(()=>(sm(),im)).then(n=>{m.openUsersViewBtn?.removeEventListener("click",t,!0),n.initUsersPanel?.(),setTimeout(()=>m.openUsersViewBtn?.click(),0)}).catch(()=>{}).finally(()=>{e=null}))};m.openUsersViewBtn.addEventListener("click",t,!0)}um(()=>Xs(),{timeout:1500,fallbackDelay:50});setTimeout(()=>Xs(),3e3);try{navigator?.serviceWorker?.addEventListener?.("controllerchange",()=>Xs())}catch{}function Fb(){lm(),Ys("app.start",{ua:navigator.userAgent}),dm(),jc(),Zc(),tu(),fm(),$b(),um(()=>{Promise.resolve().then(()=>(cm(),am)).then(e=>e.initTables?.()).catch(()=>{})}),yo(window.location.pathname)}function zb(){lm(),Ys("app.public.start",{ua:navigator.userAgent,path:window.location.pathname}),m.authOverlay&&m.authOverlay.classList.add("hidden"),dm(),jc(),Zc(),fm(),yo(window.location.pathname)}async function Ub(){if(/^\/p\/[^/?#]+/.test(window.location.pathname)){zb();return}Ys("auth.bootstrap.start",{ua:navigator.userAgent}),Yp(Fb),await Xp(),Ys("auth.bootstrap.done",{ua:navigator.userAgent})}Ub().catch(()=>{});
