var Bm=Object.defineProperty;var Fe=(e,t)=>()=>(e&&(t=e(e=0)),t);var Wn=(e,t)=>{for(var n in t)Bm(e,n,{get:t[n],enumerable:!0})};function ra(e){xi=e}function oa(e){Yn=e}var a,xi,Yn,mt=Fe(()=>{a={mode:"view",serverStatus:"unknown",serverStatusText:"",offlineReady:!1,offlineInitStatus:"idle",offlineInitError:"",offlineInitStartedAt:null,mediaStatusText:"",mediaPrefetchPaused:!1,isOutlineEditing:!1,outlineStatusText:"",isPublicView:!1,isRagView:!1,currentUser:null,articleId:null,article:null,currentBlockId:null,editingBlockId:null,selectionAnchorBlockId:null,selectedBlockIds:[],undoStack:[],redoStack:[],pendingTextPreview:null,editingUndo:null,editingInitialText:"",searchQuery:"",searchResults:[],searchError:"",searchLoading:!1,searchRequestId:0,searchMode:"classic",sidebarSearchView:"list",ragQuery:"",ragResults:[],ragBlockMap:{},ragSummaryHtml:"",ragSummaryLoading:!1,ragSummaryError:"",scrollTargetBlockId:null,pendingEditBlockId:null,isEditingTitle:!1,isSidebarCollapsed:!1,isSidebarMobileOpen:!1,articlesIndex:[],deletedArticlesIndex:[],articleFilterQuery:"",isMarkdownInserting:!1,isTrashView:!1,favoriteArticles:[],sidebarArticlesMode:"tree",recentArticleIds:[],sidebarSelectedArticleId:null,listSelectedArticleId:null,sidebarCollapsedArticleIds:[],listCollapsedArticleIds:[],isDragModeEnabled:!1,articleEncryptionKeys:{},isMergingBlocks:!1,isMovingBlock:!1,isDeletingBlock:!1,moveQueue:[],isMoveQueueProcessing:!1,editingScrollTop:null,editingCaretPosition:"start"},xi=!1,Yn=!1});var p,Mt=Fe(()=>{p={authOverlay:document.getElementById("authOverlay"),authLoginTab:document.getElementById("authLoginTab"),authRegisterTab:document.getElementById("authRegisterTab"),authLoginForm:document.getElementById("authLoginForm"),authRegisterForm:document.getElementById("authRegisterForm"),authLoginUsername:document.getElementById("authLoginUsername"),authLoginPassword:document.getElementById("authLoginPassword"),authRegisterUsername:document.getElementById("authRegisterUsername"),authRegisterPassword:document.getElementById("authRegisterPassword"),authRegisterDisplayName:document.getElementById("authRegisterDisplayName"),authError:document.getElementById("authError"),authSubtitle:document.getElementById("authSubtitle"),authGoogleLoginBtn:document.getElementById("authGoogleLoginBtn"),authYandexLoginBtn:document.getElementById("authYandexLoginBtn"),authStorageInfo:document.getElementById("authStorageInfo"),currentUserLabel:document.getElementById("currentUserLabel"),logoutBtn:document.getElementById("logoutBtn"),userMenuBtn:document.getElementById("userMenuBtn"),userMenu:document.getElementById("userMenu"),sidebarSyncStatusPill:document.getElementById("sidebarSyncStatusPill"),syncMenu:document.getElementById("syncMenu"),syncMenuStatusLabel:document.getElementById("syncMenuStatusLabel"),syncMenuOutboxLabel:document.getElementById("syncMenuOutboxLabel"),offlineStatusItem:document.getElementById("offlineStatusItem"),offlineStatusLabel:document.getElementById("offlineStatusLabel"),offlineFetchBtn:document.getElementById("offlineFetchBtn"),telegramLinkBtn:document.getElementById("telegramLinkBtn"),telegramBotOpenBtn:document.getElementById("telegramBotOpenBtn"),telegramFeedbackBotOpenBtn:document.getElementById("telegramFeedbackBotOpenBtn"),openUsersViewBtn:document.getElementById("openUsersViewBtn"),usersView:document.getElementById("usersView"),usersList:document.getElementById("usersList"),usersBackBtn:document.getElementById("usersBackBtn"),graphView:document.getElementById("graphView"),graphCanvas:document.getElementById("graphCanvas"),graphBackBtn:document.getElementById("graphBackBtn"),articleListView:document.getElementById("articleListView"),articleView:document.getElementById("articleView"),articleHeader:document.getElementById("articleHeader"),articleTitle:document.getElementById("articleTitle"),updatedAt:document.getElementById("updatedAt"),articleStatusText:document.getElementById("articleStatusText"),mediaStatusText:document.getElementById("mediaStatusText"),mediaPrefetchToggleBtn:document.getElementById("mediaPrefetchToggleBtn"),blocksContainer:document.getElementById("blocksContainer"),articleList:document.getElementById("articleList"),createArticleBtn:document.getElementById("createArticleBtn"),backToList:document.getElementById("backToList"),toast:document.getElementById("toast"),searchInput:document.getElementById("searchInput"),searchClearBtn:document.getElementById("searchClearBtn"),searchResults:document.getElementById("searchResults"),searchPanel:document.querySelector(".search-panel"),searchModeToggle:document.getElementById("searchModeToggle"),sidebarSearchViewToggle:document.getElementById("sidebarSearchViewToggle"),ragOpenBtn:document.getElementById("ragOpenBtn"),articleTitleInput:document.getElementById("articleTitleInput"),editTitleBtn:document.getElementById("editTitleBtn"),hintToggleBtn:document.getElementById("hintToggleBtn"),hintPopover:document.getElementById("hintPopover"),sidebar:document.getElementById("sidebar"),sidebarToggle:document.getElementById("sidebarToggle"),sidebarArticleList:document.getElementById("sidebarArticleList"),sidebarNewArticleBtn:document.getElementById("sidebarNewArticleBtn"),sidebarRecentBtn:document.getElementById("sidebarRecentBtn"),openInboxBtn:document.getElementById("openInboxBtn"),quickNoteAddBtn:document.getElementById("quickNoteAddBtn"),articleFilterInput:document.getElementById("articleFilterInput"),trashTabBtn:document.getElementById("trashTabBtn"),articlesTabBtn:document.getElementById("articlesTabBtn"),semanticReindexBtn:document.getElementById("semanticReindexBtn"),graphToggleBtn:document.getElementById("graphToggleBtn"),listMenuBtn:document.getElementById("listMenuBtn"),listMenu:document.getElementById("listMenu"),articleMenuBtn:document.getElementById("articleMenuBtn"),articleMenu:document.getElementById("articleMenu"),articleFavoriteBtn:document.getElementById("articleFavoriteBtn"),articlePublicLinkBtn:document.getElementById("articlePublicLinkBtn"),articlePublicToggleBtn:document.getElementById("articlePublicToggleBtn"),articleEncryptionBtn:document.getElementById("articleEncryptionBtn"),articleEncryptionRemoveBtn:document.getElementById("articleEncryptionRemoveBtn"),deleteArticleBtn:document.getElementById("deleteArticleBtn"),exportArticleBtn:document.getElementById("exportArticleBtn"),outlineEditBtn:document.getElementById("outlineEditBtn"),saveVersionBtn:document.getElementById("saveVersionBtn"),versionsBtn:document.getElementById("versionsBtn"),blockHistoryBtn:document.getElementById("blockHistoryBtn"),articleHistoryBtn:document.getElementById("articleHistoryBtn"),exportAllHtmlZipBtn:document.getElementById("exportAllHtmlZipBtn"),importArticleBtn:document.getElementById("importArticleBtn"),importMarkdownBtn:document.getElementById("importMarkdownBtn"),importLogseqBtn:document.getElementById("importLogseqBtn"),importBackupFolderBtn:document.getElementById("importBackupFolderBtn"),articleUndoBtn:document.getElementById("articleUndoBtn"),articleRedoBtn:document.getElementById("articleRedoBtn"),mergeBlocksBtn:document.getElementById("mergeBlocksBtn"),splitBlockBtn:document.getElementById("splitBlockBtn"),insertTableBtn:document.getElementById("insertTableBtn"),deleteCurrentBlockBtn:document.getElementById("deleteCurrentBlockBtn"),exportCurrentBlockBtn:document.getElementById("exportCurrentBlockBtn"),articleBlockTrashBtn:document.getElementById("articleBlockTrashBtn"),articleNewBlockBtn:document.getElementById("articleNewBlockBtn"),articleToolbar:document.getElementById("articleToolbar"),outlineToolbar:document.getElementById("outlineToolbar"),outlineTagsBar:document.getElementById("outlineTagsBar"),outlineUndoBtn:document.getElementById("outlineUndoBtn"),outlineRedoBtn:document.getElementById("outlineRedoBtn"),outlineDeleteBtn:document.getElementById("outlineDeleteBtn"),outlineMoveUpBtn:document.getElementById("outlineMoveUpBtn"),outlineMoveDownBtn:document.getElementById("outlineMoveDownBtn"),outlineOutdentBtn:document.getElementById("outlineOutdentBtn"),outlineIndentBtn:document.getElementById("outlineIndentBtn"),outlineNewBelowBtn:document.getElementById("outlineNewBelowBtn"),outlineBoldBtn:document.getElementById("outlineBoldBtn"),outlineBulletListBtn:document.getElementById("outlineBulletListBtn"),outlineOrderedListBtn:document.getElementById("outlineOrderedListBtn"),outlineBlockquoteBtn:document.getElementById("outlineBlockquoteBtn"),outlineCodeBtn:document.getElementById("outlineCodeBtn"),outlineInsertTableBtn:document.getElementById("outlineInsertTableBtn"),outlineDeleteTableBtn:document.getElementById("outlineDeleteTableBtn"),outlineAddRowBtn:document.getElementById("outlineAddRowBtn"),outlineAddColBtn:document.getElementById("outlineAddColBtn"),pasteProgress:document.getElementById("pasteProgress"),mobileSidebarBtn:document.getElementById("mobileSidebarBtn"),sidebarBackdrop:document.getElementById("sidebarBackdrop"),dragModeToggleBtn:document.getElementById("dragModeToggleBtn"),listSidebarBtn:document.getElementById("listSidebarBtn"),outlineEditor:document.getElementById("outlineEditor")}});function wl(){if(!p.articlePublicToggleBtn)return;let e=a.article?.publicSlug||null;p.articlePublicToggleBtn.textContent=e?"\u041E\u0442\u043C\u0435\u043D\u0438\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435":"\u0414\u0430\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435"}function An(){let e=a.article;if(!e)return;let t=e.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";if(p.articleTitle&&(p.articleTitle.textContent=t,p.articleTitle.classList.toggle("article-title--encrypted",!!e.encrypted),p.articleTitle.classList.toggle("hidden",a.isEditingTitle)),p.articleTitleInput&&(a.isEditingTitle||(p.articleTitleInput.value=t),p.articleTitleInput.classList.toggle("hidden",!a.isEditingTitle)),p.editTitleBtn&&p.editTitleBtn.classList.toggle("hidden",a.isEditingTitle),p.articleFavoriteBtn){let r=new Set(a.favoriteArticles||[]).has(e.id);p.articleFavoriteBtn.textContent=r?"\uE735":"\uE734",p.articleFavoriteBtn.title=r?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}if(p.articlePublicLinkBtn){let n=!!e.publicSlug;p.articlePublicLinkBtn.classList.toggle("hidden",!n),n&&(p.articlePublicLinkBtn.title="\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0441\u044B\u043B\u043A\u0443")}if(p.deleteArticleBtn&&p.deleteArticleBtn.classList.toggle("hidden",e.id==="inbox"),p.articleEncryptionBtn&&(p.articleEncryptionBtn.textContent=e.encrypted?"\u0421\u043C\u0435\u043D\u0438\u0442\u044C \u043F\u0430\u0440\u043E\u043B\u044C":"\u0417\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C"),p.articleEncryptionRemoveBtn&&p.articleEncryptionRemoveBtn.classList.toggle("hidden",!e.encrypted),p.updatedAt&&(a.isOutlineEditing?p.updatedAt.textContent=a.outlineStatusText||"":e.updatedAt?p.updatedAt.textContent=`\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${new Date(e.updatedAt).toLocaleString()}`:p.updatedAt.textContent=""),p.articleStatusText&&(a.isOutlineEditing?p.articleStatusText.textContent=a.outlineStatusText||"":e.updatedAt?p.articleStatusText.textContent=`\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${new Date(e.updatedAt).toLocaleString()}`:p.articleStatusText.textContent=""),p.mediaStatusText&&(p.mediaStatusText.textContent=a.mediaStatusText||""),p.mediaPrefetchToggleBtn){let n=!!a.mediaPrefetchPaused;p.mediaPrefetchToggleBtn.textContent=n?"\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C":"\u041F\u0430\u0443\u0437\u0430",p.mediaPrefetchToggleBtn.classList.toggle("is-active",n)}}var Eo=Fe(()=>{mt();Mt()});function Sl(){To!==null&&(clearTimeout(To),To=null)}function sa(e){ia=!!e,p.toast&&(ia?p.toast.dataset.protected="true":p.toast.removeAttribute("data-protected"))}function L(e,t={}){if(!p.toast)return;let n=typeof t.duration=="number"?t.duration:2500;t.protect?sa(!0):sa(!1),Sl(),p.toast.textContent=e,p.toast.classList.remove("hidden"),requestAnimationFrame(()=>{p.toast.classList.add("show")}),n>0&&(To=setTimeout(()=>{p.toast.classList.remove("show"),setTimeout(()=>p.toast.classList.add("hidden"),200),To=null},n))}function Bt(e,t={}){L(e,{...t,duration:0})}function st(e={}){p.toast&&(ia&&!e.force||(Sl(),sa(!1),p.toast.classList.remove("show"),p.toast.classList.add("hidden")))}var To,ia,Nt=Fe(()=>{Mt();To=null,ia=!1;p.toast&&p.toast.addEventListener("click",()=>{st()})});function ve(e){return new Promise((t,n)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error||new Error("IndexedDB request failed"))})}function ze(e){return new Promise((t,n)=>{e.oncomplete=()=>t(),e.onabort=()=>n(e.error||new Error("IndexedDB transaction aborted")),e.onerror=()=>n(e.error||new Error("IndexedDB transaction failed"))})}function Lm(e){return String(e||"anon").replace(/[^a-zA-Z0-9_-]/g,"_")}function Mm(e){return`memus_offline_v1_${Lm(e)}`}function Pm(e){try{let t=String(e||"").trim();if(!t)return;let n=window?.localStorage?.getItem?.(xl)||"[]",r=JSON.parse(n),o=Array.isArray(r)?r:[];o.includes(t)||o.push(t),window.localStorage.setItem(xl,JSON.stringify(o.slice(-200)))}catch{}}async function kl({userKey:e}={}){let t=e||"anon";Pm(t);let n=Mm(t),r=indexedDB.open(n,Nm);r.onupgradeneeded=()=>{let i=r.result;if(i.objectStoreNames.contains("meta")||i.createObjectStore("meta",{keyPath:"key"}),!i.objectStoreNames.contains("articles")){let s=i.createObjectStore("articles",{keyPath:"id"});s.createIndex("byUpdatedAt","updatedAt",{unique:!1}),s.createIndex("byDeletedAt","deletedAt",{unique:!1})}if(!i.objectStoreNames.contains("outline_sections")){let s=i.createObjectStore("outline_sections",{keyPath:"sectionId"});s.createIndex("byArticleId","articleId",{unique:!1}),s.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!i.objectStoreNames.contains("section_embeddings")){let s=i.createObjectStore("section_embeddings",{keyPath:"sectionId"});s.createIndex("byArticleId","articleId",{unique:!1}),s.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!i.objectStoreNames.contains("media_assets")){let s=i.createObjectStore("media_assets",{keyPath:"url"});s.createIndex("byStatus","status",{unique:!1}),s.createIndex("byFetchedAtMs","fetchedAtMs",{unique:!1}),s.createIndex("byStatusFetchedAtMs",["status","fetchedAtMs"],{unique:!1})}if(!i.objectStoreNames.contains("media_refs")){let s=i.createObjectStore("media_refs",{keyPath:"key"});s.createIndex("byArticleId","articleId",{unique:!1}),s.createIndex("byUrl","url",{unique:!1})}if(i.objectStoreNames.contains("outbox")){let s=r.transaction;try{let c=s.objectStore("outbox");c.indexNames.contains("byTypeCoalesceKey")||c.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}catch{}}else{let s=i.createObjectStore("outbox",{keyPath:"id"});s.createIndex("byCreatedAtMs","createdAtMs",{unique:!1}),s.createIndex("byTypeArticleId",["type","articleId"],{unique:!1}),s.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}if(!i.objectStoreNames.contains("pending_uploads")){let s=i.createObjectStore("pending_uploads",{keyPath:"token"});s.createIndex("byArticleId","articleId",{unique:!1}),s.createIndex("byCreatedAtMs","createdAtMs",{unique:!1})}};let o=await ve(r);try{o.onversionchange=()=>{try{o.close()}catch{}}}catch{}return o}async function Al(e){let t=e.transaction(["meta"],"readonly"),n=t.objectStore("meta");await ve(n.get("ping")),await ze(t)}var Nm,xl,Pn=Fe(()=>{Nm=3,xl="ttree_offline_known_user_keys_v1"});async function Ai({userKey:e}={}){let t=String(e||"").trim();if(!t||t==="anon")try{let n=window?.localStorage?.getItem?.("ttree_offline_user_key_v1")||"",r=String(n||"").trim();r&&(t=r)}catch{}if(!t||t==="anon")try{let n=window?.localStorage?.getItem?.("ttree_last_user_v1")||"",r=n?JSON.parse(n):null,o=String(r?.id||r?.username||"").trim();o&&(t=o)}catch{}return t||(t="anon"),ki&&Il===t||(Il=t,ki=(async()=>await kl({userKey:t}))()),ki}var ki,Il,aa=Fe(()=>{Pn();ki=null,Il=null});function vi(){try{return window?.localStorage?.getItem?.(Dm)==="1"}catch{return!1}}function Cl(){try{return window?.localStorage?.getItem?.(_m)==="1"}catch{return!1}}function ca(e,t={}){try{if(!vi())return;console.log("[perf][offline]",e,t)}catch{}}function Om(){try{let e=window.__BUILD_ID__;return e?String(e):""}catch{return""}}function la(e,t){try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:e,data:t})}).catch(()=>{})}catch{}}async function da(){let e={};try{e.ua=navigator?.userAgent||""}catch{e.ua=""}try{e.buildId=Om()}catch{e.buildId=""}try{e.onLine=navigator?.onLine!==!1}catch{e.onLine=null}try{e.indexedDB=typeof indexedDB<"u"}catch{e.indexedDB=null}try{e.storagePersist=typeof navigator?.storage?.persist=="function"}catch{e.storagePersist=null}try{e.storageEstimate=typeof navigator?.storage?.estimate=="function"}catch{e.storageEstimate=null}try{if(navigator?.storage?.estimate){let t=await navigator.storage.estimate().catch(()=>null);t&&typeof t=="object"&&(e.quota=Number(t.quota||0)||null,e.usage=Number(t.usage||0)||null)}}catch{}return e}function Rm(e){try{let t=window?.localStorage?.getItem?.("ttree_offline_user_key_v1")||"",n=String(t||"").trim();if(n)return n}catch{}return e&&(e.id||e.username)||"anon"}async function Ei(e){let t=Rm(e);if(Qr&&vl===t)return Qr;vl=t,El+=1;let n=El;return Qr=(async()=>{let r=vi()?performance.now():0;a.offlineReady=!1,a.offlineInitStatus="initializing",a.offlineInitError="",a.offlineInitStartedAt=Date.now();try{if(Tl!==n){Tl=n;let o=await da().catch(()=>({}));la("offline.init.start",{t:new Date().toISOString(),attempt:n,userKey:t,env:o})}}catch{}try{Cl()&&console.log("[offline] init start",{userKey:t})}catch{}try{let o=vi()?performance.now():0,i=await Ai({userKey:t});o&&ca("getOfflineDb()",{ms:Math.round(performance.now()-o)});let s=vi()?performance.now():0;await Al(i),s&&ca("idb.ping",{ms:Math.round(performance.now()-s)});try{navigator?.storage?.persist&&navigator.storage.persist().catch(()=>{})}catch{}a.offlineReady=!0,a.offlineInitStatus="ready",a.offlineInitError="",a.offlineInitStartedAt=null;try{if(Ii!==n){Ii=n;let c=await da().catch(()=>({}));la("offline.init.ready",{t:new Date().toISOString(),attempt:n,userKey:t,env:c})}}catch{}try{Cl()&&console.log("[offline] init ready")}catch{}return r&&ca("initOfflineForUser.total",{userKey:t,ms:Math.round(performance.now()-r)}),i}catch(o){a.offlineReady=!1,a.offlineInitStatus="error",a.offlineInitStartedAt=null;try{console.error("[offline] init failed",o)}catch{}let i=o?.message?`Offline \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430: ${o.message}`:"Offline \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0432 \u044D\u0442\u043E\u043C \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435";a.offlineInitError=i,L(i);try{if(Ii!==n){Ii=n;let s=await da().catch(()=>({}));la("offline.init.failed",{t:new Date().toISOString(),attempt:n,userKey:t,msg:i,err:{name:String(o?.name||""),message:String(o?.message||""),stack:String(o?.stack||"").slice(0,1500)},env:s})}}catch{}throw o}})(),Qr}async function at(){return Qr||Ei(a.currentUser)}var Qr,vl,El,Tl,Ii,Dm,_m,rr=Fe(()=>{mt();Nt();aa();Pn();Qr=null,vl=null,El=0,Tl=null,Ii=null,Dm="ttree_profile_v1",_m="ttree_debug_offline_v1"});function ua(e){if(!e)return"";if(e.type==="text")return String(e.text||"");let t=Array.isArray(e.content)?e.content:[];if(!t.length)return"";let n=[];for(let r of t){let o=ua(r);o&&n.push(o),r&&(r.type==="paragraph"||r.type==="hardBreak"||r.type==="heading")&&n.push(`
`)}return n.join("")}function Bl(e){return String(e||"").replace(/\r\n/g,`
`).replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}function Ll(e,t=[]){for(let n of e||[]){if(!n||n.type!=="outlineSection")continue;let r=String(n.attrs?.id||""),o=n.content?.[0],i=n.content?.[1],s=n.content?.[2],c=Bl(ua(o))||"",l=Bl(ua(i))||"",d=`${c}
${l}`.trim();r&&t.push({sectionId:r,title:c,text:d});let u=s?.content||[];Ll(u,t)}return t}function Hm(e){let t=Array.isArray(e?.content)?e.content:[];return Ll(t,[])}async function Ti(e,{articleId:t,docJson:n,updatedAt:r}){if(!e||!t||!n||typeof n!="object")return;let o=Hm(n),i=e.transaction(["outline_sections"],"readwrite"),s=i.objectStore("outline_sections"),c=s.index("byArticleId"),l=IDBKeyRange.only(String(t)),d=await ve(c.openCursor(l));for(;d;)d.delete(),d=await ve(d.continue());for(let u of o)await ve(s.put({sectionId:u.sectionId,articleId:String(t),title:u.title||"",text:u.text||"",updatedAt:r||null}));await ze(i)}var Ml=Fe(()=>{Pn()});function Bi(){try{return localStorage.getItem(_l)==="1"}catch{return!1}}function fa(e){let t=!!e;try{localStorage.setItem(_l,t?"1":"0")}catch{}try{window.dispatchEvent(new CustomEvent("media-prefetch-paused",{detail:{paused:t}}))}catch{}return t}function Ol(){return fa(!Bi())}async function Rl(e){let t=String(e||"").trim();if(!t)return{total:0,ok:0,error:0};let r=(await at()).transaction(["media_refs","media_assets"],"readonly"),o=r.objectStore("media_refs"),i=r.objectStore("media_assets"),s=o.index("byArticleId"),c=IDBKeyRange.only(t),l=0,d=0,u=0,m=await ve(s.openCursor(c)).catch(()=>null);for(;m;){l+=1;let g=String(m.value?.url||"");if(g){let w=await ve(i.get(g)).catch(()=>null);w?.status==="ok"&&(d+=1),w?.status==="error"&&(u+=1)}m=await ve(m.continue()).catch(()=>null)}return await ze(r),{total:l,ok:d,error:u}}function $m(e){let t=String(e||"").trim();if(!t)return null;try{let n=new URL(t,window.location.origin);return n.origin!==window.location.origin?/^https?:\/\/memus\.pro\b/i.test(t)&&n.pathname.startsWith("/uploads/")?n.pathname+(n.search||""):null:n.pathname.startsWith("/uploads/")?n.pathname+(n.search||""):null}catch{return t.startsWith("/uploads/")?t:null}}function Fm(e){let t=new Set,n=r=>{if(!r)return;if(Array.isArray(r)){r.forEach(n);return}if(r.type==="image"){let i=$m(r.attrs?.src);i&&t.add(i)}(Array.isArray(r.content)?r.content:[]).forEach(n)};return n(e?.content||[]),Array.from(t)}async function Zr(e,t){let n=await at(),r=Fm(t),o=n.transaction(["media_refs","media_assets"],"readwrite"),i=o.objectStore("media_refs"),s=o.objectStore("media_assets"),c=i.index("byArticleId"),l=IDBKeyRange.only(String(e)),d=await ve(c.openCursor(l)).catch(()=>null);for(;d;)d.delete(),d=await ve(d.continue()).catch(()=>null);for(let u of r){let m=`${String(e)}|${String(u)}`;await ve(i.put({key:m,articleId:String(e),url:String(u)})),await ve(s.get(u)).catch(()=>null)||await ve(s.put({url:String(u),status:"needed",fetchedAtMs:0,failCount:0,lastError:null}))}await ze(o)}async function Hl(e={}){let{maxFailCountOnly:t=!1}=e||{},r=(await at()).transaction(["media_assets"],"readwrite"),o=r.objectStore("media_assets"),i=await ve(o.getAll()).catch(()=>[])||[];for(let s of i){if(!s?.url||String(s.status||"")!=="error")continue;let c=Number(s.failCount||0);t&&c<5||await ve(o.put({...s,status:"needed",failCount:0,lastError:null,fetchedAtMs:0}))}await ze(r)}async function Nl(e,t){let n=e.transaction(["media_assets"],"readwrite"),r=n.objectStore("media_assets"),o=await ve(r.get(t)).catch(()=>null);await ve(r.put({...o||{},url:String(t),status:"ok",fetchedAtMs:Date.now(),failCount:0,lastError:null})),await ze(n)}async function zm(e,t,n){let r=String(n?.message||n||"error"),o=e.transaction(["media_assets"],"readwrite"),i=o.objectStore("media_assets"),s=await ve(i.get(t)).catch(()=>null),c=Number(s?.failCount||0)+1;await ve(i.put({...s||{},url:String(t),status:"error",fetchedAtMs:Date.now(),failCount:c,lastError:r})),await ze(o)}async function Um(e,t){let n=e.transaction(["media_assets"],"readonly"),o=n.objectStore("media_assets").index("byFetchedAtMs"),i=[],s=await ve(o.openCursor()).catch(()=>null);for(;s;){let c=s.value,l=String(c?.status||""),d=Number(c?.failCount||0);if(l!=="ok"&&d<5){let u=String(c?.url||"");if(u&&i.push(u),i.length>=t)break}s=await ve(s.continue()).catch(()=>null)}return await ze(n),i}async function Vm(e,t){try{return!!await e.match(t,{ignoreSearch:!1})}catch{return!1}}async function qm(e,t){let n=await fetch(t,{credentials:"include"});if(!n||!n.ok)throw new Error(`HTTP ${n?.status||0}`);await e.put(t,n.clone())}function Km(){try{let e=navigator.connection||navigator.mozConnection||navigator.webkitConnection,t=String(e?.effectiveType||"");if(!!e?.saveData||t.includes("2g"))return 1;if(t.includes("3g"))return 2}catch{}return 3}function Li(){if(Pl)return;Pl=!0;let e=async()=>{if(!navigator.onLine||Bi())return;let t=Km();if(Ci>=t)return;let n=await at(),r=await caches.open(Dl),o=await Um(n,Math.max(5,t*3));if(o.length)for(let i of o){if(Ci>=t)break;Ci+=1,(async()=>{try{if(await Vm(r,i)){await Nl(n,i);return}await qm(r,i),await Nl(n,i)}catch(s){await zm(n,i,s)}finally{Ci-=1}})()}};setInterval(()=>{e().catch(()=>{})},1200),window.addEventListener("online",()=>{e().catch(()=>{})})}async function $l(){let e=await at(),t=await caches.open(Dl),n=e.transaction(["media_assets","media_refs"],"readwrite"),r=n.objectStore("media_assets"),i=n.objectStore("media_refs").index("byUrl"),s=[],c=await ve(r.openCursor()).catch(()=>null);for(;c&&s.length<500;){let l=String(c.value?.url||"");l&&(await ve(i.count(IDBKeyRange.only(l))).catch(()=>0)||(s.push(l),c.delete())),c=await ve(c.continue()).catch(()=>null)}if(await ze(n),!s.length)return 0;for(let l of s)try{await t.delete(l)}catch{}return s.length}var Dl,_l,Pl,Ci,Co=Fe(()=>{rr();Pn();Dl="memus-uploads-v1",_l="ttree_media_prefetch_paused_v1";Pl=!1,Ci=0});function Ym(e=null){try{if(window?.localStorage?.getItem?.(Jm)!=="1")return!1;let t=String(window?.localStorage?.getItem?.(jm)||"").trim();if(!t)return!0;let n=String(e||"").trim();return n?n===t:!0}catch{return!1}}function Xm(){try{return window?.localStorage?.getItem?.(Wm)==="1"}catch{return!1}}function Gm(e){try{return JSON.stringify(e)}catch{return'"[unserializable]"'}}function Qm(e){try{let t=String(e||""),n=2166136261;for(let r=0;r<t.length;r+=1)n^=t.charCodeAt(r),n=Math.imul(n,16777619);return(n>>>0).toString(16)}catch{return"0"}}function Kt(e){try{return!e||typeof e!="object"?null:Qm(Gm(e))}catch{return null}}function ct(e,t={}){try{let n=t?.articleId?String(t.articleId):null;if(!Ym(n))return!1;let r={t:new Date().toISOString(),kind:String(e||"event"),data:t&&typeof t=="object"?t:{value:t}},o=[];try{let i=window?.localStorage?.getItem?.(Mi)||"";o=i?JSON.parse(i):[],Array.isArray(o)||(o=[])}catch{o=[]}o.push(r),o.length>250&&(o=o.slice(o.length-250));try{window?.localStorage?.setItem?.(Mi,JSON.stringify(o))}catch{}if(Xm()&&navigator.onLine!==!1)try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:`revert:${r.kind}`,data:r})}).catch(()=>{})}catch{}return!0}catch{return!1}}function Zm(){try{let e=window?.localStorage?.getItem?.(Mi)||"",t=e?JSON.parse(e):[];return Array.isArray(t)?t:[]}catch{return[]}}function eh(){try{window?.localStorage?.removeItem?.(Mi)}catch{}}var Jm,jm,Wm,Mi,Bo=Fe(()=>{Jm="ttree_debug_revert_v1",jm="ttree_debug_revert_article_v1",Wm="ttree_client_log_v1",Mi="ttree_revert_log_v1";try{window.memusRevertLogDump=()=>Zm(),window.memusRevertLogClear=()=>eh()}catch{}});function th(e){return{id:e.id,title:e.title,updatedAt:e.updatedAt,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:!!e.encrypted}}async function Xn(e){let t=await at(),n=Array.isArray(e)?e:[],r=50;for(let o=0;o<n.length;o+=r){let i=n.slice(o,o+r),s=t.transaction(["articles"],"readwrite"),c=s.objectStore("articles");for(let l of i){let d=th(l),m={...await ve(c.get(d.id)).catch(()=>null)||{},id:d.id,title:d.title||"",updatedAt:d.updatedAt||null,parentId:d.parentId??null,position:typeof d.position=="number"?d.position:0,publicSlug:d.publicSlug??null,encrypted:d.encrypted?1:0,deletedAt:null};await ve(c.put(m))}await ze(s),await new Promise(l=>setTimeout(l,0))}}async function zn(){let t=(await at()).transaction(["articles"],"readonly"),n=t.objectStore("articles"),r=await ve(n.getAll()).catch(()=>[])||[];return await ze(t),r.filter(o=>o&&!o.deletedAt).sort((o,i)=>Number(o.position||0)-Number(i.position||0)).map(o=>({id:o.id,title:o.title||"",updatedAt:o.updatedAt||null,parentId:o.parentId??null,position:typeof o.position=="number"?o.position:0,publicSlug:o.publicSlug??null,encrypted:!!o.encrypted}))}async function Fl(){let t=(await at()).transaction(["articles"],"readonly"),n=t.objectStore("articles"),r=await ve(n.getAll()).catch(()=>[])||[];return await ze(t),r.filter(o=>o&&!o.deletedAt).map(o=>({id:o.id,updatedAt:o.updatedAt||null,hasDocJson:!!o.docJsonStr}))}async function wr(e){if(!e||!e.id)return;let t=await at(),n=e.docJson&&typeof e.docJson=="object"?e.docJson:null,r=e.updatedAt||null,o=t.transaction(["articles"],"readwrite"),i=o.objectStore("articles"),s=await ve(i.get(e.id)).catch(()=>null),c=null;try{c=s?.articleJsonStr?JSON.parse(s.articleJsonStr):null}catch{c=null}let l=!!(c&&c.localDraft),d=e&&Object.prototype.hasOwnProperty.call(e,"outlineStructureRev")?Number(e.outlineStructureRev):null;try{let m=String(s?.updatedAt||"").trim(),g=String(r||"").trim();if(m&&g&&g<m){ct("cache.article.put.skip_older",{articleId:e.id,existingUpdatedAt:m,incomingUpdatedAt:g,incomingDocHash:Kt(n)}),await ze(o);return}if(l&&m&&g&&m===g){let w=Kt(s?.docJsonStr?JSON.parse(s.docJsonStr):null),y=Kt(n);if(w&&y&&w!==y){let f=c&&typeof c=="object"?{...c}:{};f.id=e.id,f.title=e.title||f.title||"",f.updatedAt=m,f.parentId=e.parentId??f.parentId??null,f.position=typeof e.position=="number"?e.position:f.position??0,f.publicSlug=e.publicSlug??f.publicSlug??null,f.encrypted=!!e.encrypted,Object.prototype.hasOwnProperty.call(e,"outlineStructureRev")&&(f.outlineStructureRev=Number(e.outlineStructureRev)||0),f.localDraft=!0;let h={...s||{},id:e.id,title:e.title||"",updatedAt:m,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:e.encrypted?1:0,deletedAt:null,outlineStructureRev:Number.isFinite(d)?d:Number(s?.outlineStructureRev),docJsonStr:s?.docJsonStr??null,articleJsonStr:JSON.stringify(f)};await ve(i.put(h)),await ze(o);try{ct("cache.article.put.skip_localDraft",{articleId:e.id,updatedAt:m,existingDocHash:w,incomingDocHash:y})}catch{}return}}}catch{}let u={...s||{},id:e.id,title:e.title||"",updatedAt:r,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:e.encrypted?1:0,deletedAt:null,outlineStructureRev:Number.isFinite(d)?d:Number(s?.outlineStructureRev),docJsonStr:n?JSON.stringify(n):null,articleJsonStr:JSON.stringify(e)};await ve(i.put(u)),await ze(o);try{ct("cache.article.put",{articleId:e.id,updatedAt:r,hasDocJson:!!n,docHash:Kt(n)})}catch{}n&&(Ti(t,{articleId:e.id,docJson:n,updatedAt:r}).catch(()=>{}),Zr(e.id,n).catch(()=>{}))}async function zl(e,t){if(!e||!t)return;let n=await at(),r=String(t),o=e.docJson&&typeof e.docJson=="object"?e.docJson:null,i=e.updatedAt||null,s=n.transaction(["articles"],"readwrite"),c=s.objectStore("articles"),l=await ve(c.get(r)).catch(()=>null);try{let u=String(l?.updatedAt||"").trim(),m=String(i||"").trim();if(u&&m&&m<u){ct("cache.articleUnderId.put.skip_older",{articleId:r,existingUpdatedAt:u,incomingUpdatedAt:m,incomingDocHash:Kt(o)}),await ze(s);return}}catch{}let d={...l||{},id:r,title:e.title||l?.title||"",updatedAt:i||l?.updatedAt||null,parentId:e.parentId??l?.parentId??null,position:typeof e.position=="number"?e.position:l?.position||0,publicSlug:e.publicSlug??l?.publicSlug??null,encrypted:e.encrypted||l?.encrypted?1:0,deletedAt:null,docJsonStr:o?JSON.stringify(o):l?.docJsonStr??null,articleJsonStr:JSON.stringify(e)};await ve(c.put(d)),await ze(s),o&&(Ti(n,{articleId:r,docJson:o,updatedAt:i}).catch(()=>{}),Zr(r,o).catch(()=>{}))}async function Gn(e){if(!e)return null;let n=(await at()).transaction(["articles"],"readonly"),r=n.objectStore("articles"),o=await ve(r.get(e)).catch(()=>null);if(await ze(n),!o)return null;try{let i=JSON.parse(o.articleJsonStr||"null");return i&&!i.docJson&&o.docJsonStr&&(i.docJson=JSON.parse(o.docJsonStr)),i}catch{try{let i=o.docJsonStr?JSON.parse(o.docJsonStr):null,s={id:e,title:o.title||"",createdAt:o.createdAt||o.updatedAt||null,updatedAt:o.updatedAt||null,deletedAt:o.deletedAt||null,parentId:o.parentId??null,position:typeof o.position=="number"?o.position:0,authorId:null,publicSlug:o.publicSlug??null,encrypted:!!o.encrypted,outlineStructureRev:Number.isFinite(Number(o.outlineStructureRev))?Number(o.outlineStructureRev):void 0,docJson:i&&typeof i=="object"?i:null,history:[],redoHistory:[],blockTrash:[]};try{ct("cache.article.get.fallback_docJsonStr",{articleId:e,updatedAt:s.updatedAt||null,docHash:Kt(s.docJson)})}catch{}return s}catch{return null}}}async function yn(e,t,n){if(!e)return;let r=await at(),o=r.transaction(["articles"],"readwrite"),i=o.objectStore("articles"),s=await ve(i.get(e)).catch(()=>null),c=n||s&&s.updatedAt||null,l=()=>{let m=String(e)==="inbox"?"\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438":"",g=(s&&typeof s.title=="string"?s.title:"")||m,w=c,y={id:e,title:g,createdAt:s&&s.createdAt||w||null,updatedAt:w,deletedAt:s&&s.deletedAt||null,parentId:(s&&s.parentId)??null,position:typeof(s&&s.position)=="number"?s.position:0,authorId:null,publicSlug:(s&&s.publicSlug)??null,encrypted:!!(s&&s.encrypted),docJson:null,history:[],blocks:[]};return JSON.stringify(y)},d=()=>{let m=s&&s.articleJsonStr||"",g=null;try{g=m?JSON.parse(m):null}catch{g=null}if(!g||typeof g!="object")try{g=JSON.parse(l())}catch{g={id:e}}return g.id=e,g.updatedAt=c||g.updatedAt||null,g.docJson=t&&typeof t=="object"?t:null,t&&typeof t=="object"&&(g.localDraft=!0),!g.title&&s?.title&&(g.title=s.title),g.deletedAt===void 0&&(g.deletedAt=null),g.parentId===void 0&&(g.parentId=s?.parentId??null),g.position===void 0&&(g.position=typeof s?.position=="number"?s.position:0),g.publicSlug===void 0&&(g.publicSlug=s?.publicSlug??null),g.encrypted===void 0&&(g.encrypted=!!s?.encrypted),g.history===void 0&&(g.history=[]),g.blocks===void 0&&(g.blocks=[]),JSON.stringify(g)},u={...s||{id:e},id:e,outlineStructureRev:s?.outlineStructureRev,docJsonStr:t?JSON.stringify(t):null,updatedAt:c,articleJsonStr:d()};await ve(i.put(u)),await ze(o);try{ct("cache.docJson.put",{articleId:e,updatedAt:c,docHash:Kt(t)})}catch{}t&&typeof t=="object"&&(Ti(r,{articleId:e,docJson:t,updatedAt:n}).catch(()=>{}),Zr(e,t).catch(()=>{}))}async function Ul(e){let t=String(e||"").trim();if(!t)return;let r=(await at()).transaction(["articles"],"readwrite"),o=r.objectStore("articles"),i=await ve(o.get(t)).catch(()=>null);if(!i){await ze(r);return}let s=null;try{s=i.articleJsonStr?JSON.parse(i.articleJsonStr):null}catch{s=null}(!s||typeof s!="object")&&(s={id:t}),s.id=t,delete s.localDraft;let c={...i,articleJsonStr:JSON.stringify(s)};await ve(o.put(c)),await ze(r)}async function eo(e){let t=await at(),n=Array.isArray(e)?e:[];if(!n.length)return;let r=t.transaction(["articles"],"readwrite"),o=r.objectStore("articles");for(let i of n){if(!i||!i.id)continue;let s=await ve(o.get(i.id)).catch(()=>null);if(!s)continue;let c={...s,parentId:i.parentId??null,position:typeof i.position=="number"?i.position:0};await ve(o.put(c))}await ze(r)}async function pa(e,t){let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return;let i=(await at()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),c=await ve(s.get(n)).catch(()=>null);if(!c){await ze(i);return}let l=null;try{l=c.articleJsonStr?JSON.parse(c.articleJsonStr):null}catch{l=null}(!l||typeof l!="object")&&(l={id:n}),l.id=n,l.updatedAt=r;let d={...c,updatedAt:r,articleJsonStr:JSON.stringify(l)};await ve(s.put(d)),await ze(i)}async function ma(e,t){let n=String(e||"").trim();if(!n)return;let r=Number(t);if(!Number.isFinite(r)||r<0)return;let i=(await at()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),c=await ve(s.get(n)).catch(()=>null);if(!c){await ze(i);return}let l=null;try{l=c.articleJsonStr?JSON.parse(c.articleJsonStr):null}catch{l=null}(!l||typeof l!="object")&&(l={id:n}),l.id=n,l.outlineStructureRev=r;let d={...c,outlineStructureRev:r,articleJsonStr:JSON.stringify(l)};await ve(s.put(d)),await ze(i)}var Lo=Fe(()=>{rr();Pn();Ml();Co();Bo()});function ha(){try{window.dispatchEvent(new CustomEvent("offline-outbox-changed"))}catch{}}function nh(){return globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?globalThis.crypto.randomUUID():`id-${Date.now()}-${Math.random().toString(16).slice(2)}`}function Vl(){return new Date().toISOString()}async function $t(e,{articleId:t,payload:n,coalesceKey:r}={}){let o=await at(),i=nh(),s=Vl(),c=n?JSON.stringify(n):"{}",l=o.transaction(["outbox"],"readwrite"),d=l.objectStore("outbox"),u=d.index("byTypeArticleId"),m=d.index("byTypeCoalesceKey");if(r){let g=[String(e||""),String(r||"")],w=await ve(m.openCursor(IDBKeyRange.only(g))).catch(()=>null);for(;w;)w.delete(),w=await ve(w.continue()).catch(()=>null)}else if(t){let g=[String(e||""),t||null],w=await ve(u.openCursor(IDBKeyRange.only(g))).catch(()=>null);for(;w;)w.delete(),w=await ve(w.continue()).catch(()=>null)}return await ve(d.put({id:i,createdAt:s,createdAtMs:Date.now(),type:String(e||""),articleId:t||null,coalesceKey:r?String(r):null,payloadJson:c,attempts:0,lastError:null,lastAttemptAt:null})),await ze(l),ha(),i}async function _r(e=50){let n=(await at()).transaction(["outbox"],"readonly"),o=n.objectStore("outbox").index("byCreatedAtMs"),i=[],s=await ve(o.openCursor()).catch(()=>null);for(;s&&(i.push(s.value),!(i.length>=e));)s=await ve(s.continue()).catch(()=>null);return await ze(n),i.map(c=>{let l={};try{l=JSON.parse(c?.payloadJson||"{}")}catch{l={}}return{id:c.id,createdAt:c.createdAt,type:c.type,articleId:c.articleId,payload:l,attempts:c.attempts||0}})}async function ql(){let t=(await at()).transaction(["outbox"],"readonly"),n=t.objectStore("outbox"),r=await ve(n.count()).catch(()=>0);return await ze(t),Number(r||0)||0}async function Kl(e,t){let r=(await at()).transaction(["outbox"],"readwrite"),o=r.objectStore("outbox"),i=await ve(o.get(e)).catch(()=>null);i&&await ve(o.put({...i,attempts:Number(i.attempts||0)+1,lastError:String(t||"error"),lastAttemptAt:Vl()})),await ze(r),ha()}async function Sr(e){let n=(await at()).transaction(["outbox"],"readwrite"),r=n.objectStore("outbox");await ve(r.delete(e)),await ze(n),ha()}var to=Fe(()=>{rr();Pn()});function jl(e){let t=Array.isArray(e)?e:[],n=new Float32Array(t.length),r=0;for(let o=0;o<t.length;o+=1){let i=Number(t[o]||0);n[o]=i,r+=i*i}if(r>0){let o=1/Math.sqrt(r);for(let i=0;i<n.length;i+=1)n[i]*=o}return n}function Wl(){Ni=null,Jl=0}async function ga(e,t){if(!e)return;let n=await at(),r=Array.isArray(t)?t:[],o=n.transaction(["section_embeddings"],"readwrite"),i=o.objectStore("section_embeddings");for(let s of r){let c=String(s?.blockId||s?.sectionId||""),l=String(s?.updatedAt||"")||null,d=s?.embedding;if(!c||!Array.isArray(d)||!d.length)continue;let u=jl(d);await ve(i.put({sectionId:c,articleId:String(e),updatedAt:l,vec:u}))}await ze(o),Wl()}async function Pi(e){let t=(e||[]).map(i=>String(i||"")).filter(Boolean);if(!t.length)return;let r=(await at()).transaction(["section_embeddings"],"readwrite"),o=r.objectStore("section_embeddings");for(let i of t)await ve(o.delete(i));await ze(r),Wl()}async function Yl(){let t=(await at()).transaction(["section_embeddings"],"readonly"),n=t.objectStore("section_embeddings"),r=await ve(n.count());return await ze(t),Number(r||0)}async function Xl(){if(Ni)return Ni;let t=(await at()).transaction(["section_embeddings"],"readonly"),n=t.objectStore("section_embeddings"),r=await ve(n.getAll()).catch(()=>[])||[];await ze(t);let o=[];for(let i of r){let s=String(i?.sectionId||""),c=String(i?.articleId||""),l=i?.vec;if(!s||!c||!l)continue;let d=null;l instanceof Float32Array?d=l:l instanceof ArrayBuffer?d=new Float32Array(l):Array.isArray(l)&&(d=jl(l)),!(!d||!d.length)&&o.push({sectionId:s,articleId:c,vec:d})}return Ni=o,Jl=Date.now(),o}function Gl(e,t){let n=Math.min(e.length,t.length),r=0;for(let o=0;o<n;o+=1)r+=e[o]*t[o];return r}var Ni,Jl,ya=Fe(()=>{rr();Pn();Ni=null,Jl=0});function rh(e){let t=Array.isArray(e)?e:[],n=new Float32Array(t.length),r=0;for(let o=0;o<t.length;o+=1){let i=Number(t[o]||0);n[o]=i,r+=i*i}if(r>0){let o=1/Math.sqrt(r);for(let i=0;i<n.length;i+=1)n[i]*=o}return n}async function oh(e){let t=String(e||"").trim();if(!t)return null;let n=await fetch(`/api/search/semantic/query-embedding?q=${encodeURIComponent(t)}`,{method:"GET",credentials:"include",headers:{"Content-Type":"application/json"}});if(!n.ok){let i=await n.json().catch(()=>({}));throw new Error(i.detail||"Embedding failed")}let o=(await n.json().catch(()=>null))?.embedding;return!Array.isArray(o)||!o.length?null:rh(o)}async function ih(e){let t=(e||[]).map(l=>String(l||"")).filter(Boolean);if(!t.length)return[];let r=(await at()).transaction(["outline_sections","articles"],"readonly"),o=r.objectStore("outline_sections"),i=r.objectStore("articles"),s=[];for(let l of t){let d=await ve(o.get(l)).catch(()=>null);d&&s.push({blockId:String(d.sectionId||l),articleId:String(d.articleId||""),blockText:String(d.text||"")})}let c=new Map;for(let l of s){if(!l.articleId||c.has(l.articleId))continue;let d=await ve(i.get(l.articleId)).catch(()=>null);c.set(l.articleId,String(d?.title||""))}return await ze(r),s.map(l=>({blockId:l.blockId,articleId:l.articleId,articleTitle:c.get(l.articleId)||"",blockText:l.blockText}))}async function Ql(e,{limit:t=30}={}){let n=String(e||"").trim();if(!n||!navigator.onLine||!await Yl().catch(()=>0))return null;let o=await oh(n);if(!o)return null;let i=await Xl();if(!i.length)return null;let s=Math.max(1,Math.min(Number(t)||30,50)),c=[];for(let g of i){let w=Gl(o,g.vec);if(Number.isFinite(w)){if(c.length<s){c.push({sectionId:g.sectionId,score:w}),c.length===s&&c.sort((y,f)=>y.score-f.score);continue}w<=c[0].score||(c[0]={sectionId:g.sectionId,score:w},c.sort((y,f)=>y.score-f.score))}}c.sort((g,w)=>w.score-g.score);let l=c.map(g=>g.sectionId),d=await ih(l),u=new Map(d.map(g=>[g.blockId,g])),m=[];for(let g of c){let w=u.get(g.sectionId);if(!w)continue;let y=w.blockText||"";m.push({type:"block",articleId:w.articleId,articleTitle:w.articleTitle,blockId:w.blockId,snippet:y.slice(0,160),blockText:y,score:g.score})}return m}var Zl=Fe(()=>{rr();ya();Pn()});function Di(){try{return window?.localStorage?.getItem?.(sh)==="1"}catch{return!1}}function Zt(...e){try{if(!Di())return;console.log(...e)}catch{}}async function Pe(e,t={}){let n=Di()?performance.now():0,r=n?performance.now():0,o=await fetch(e,{headers:{"Content-Type":"application/json",...t.headers||{}},credentials:"include",...t}),i=r?performance.now():0;if(!o.ok){if(o.status===401||o.status===403){try{a.serverStatus="auth",a.serverStatusText="auth"}catch{}try{window.dispatchEvent(new CustomEvent("memus:auth-required",{detail:{path:e,status:o.status}}))}catch{}}let d=await o.json().catch(()=>({}));throw n&&console.log("[perf][api]",e,{status:o.status,ms:Math.round(performance.now()-n),fetchMs:i?Math.round(i-r):null}),new Error(d.detail||"Request failed")}try{a.serverStatus==="down"&&(a.serverStatus="ok",a.serverStatusText="")}catch{}if(o.status===204)return n&&console.log("[perf][api]",e,{status:204,ms:Math.round(performance.now()-n),fetchMs:i?Math.round(i-r):null}),null;let s=n?performance.now():0,c=await o.json(),l=n?performance.now():0;try{if(window?.localStorage?.getItem?.("ttree_debug_article_load_v1")==="1"){let d=o.headers.get("X-Memus-Article-ms"),u=o.headers.get("X-Memus-DocJson-bytes");(d||u)&&console.log("[api]",e,{ms:d,docJsonBytes:u})}}catch{}if(n){let d=o.headers.get("X-Memus-Article-ms")||o.headers.get("X-Memus-Articles-ms")||o.headers.get("X-Memus-Server-ms"),u=o.headers.get("X-Memus-DocJson-bytes"),m=o.headers.get("X-Memus-Articles-count"),g=o.headers.get("Content-Length");console.log("[perf][api]",e,{status:o.status,ms:Math.round(l-n),fetchMs:i?Math.round(i-r):null,jsonMs:s?Math.round(l-s):null,serverMs:d?Number(d):null,docJsonBytes:u?Number(u):null,articlesCount:m?Number(m):null,contentLength:g?Number(g):null})}return c}async function nd(){await fetch("/api/auth/logout",{method:"POST",credentials:"include"})}function ch(){try{return window?.localStorage?.getItem?.(ah)==="1"}catch{return!1}}async function ed({timeoutMs:e}){let t=typeof e=="number"?Math.max(0,Math.floor(e)):0,n=null,r=null;try{return t>0&&typeof AbortController<"u"&&(r=new AbortController,n=setTimeout(()=>{try{r.abort()}catch{}},t)),await Pe("/api/articles",r?{signal:r.signal}:{})}catch(o){if((o?.message||String(o||"")).toLowerCase().includes("abort"))try{a.serverStatus="down",a.serverStatusText="timeout"}catch{}throw o}finally{n&&clearTimeout(n)}}function In(){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return zn().catch(()=>[]);if(Mo)return Mo;let e=a?.offlineReady?600:250,t=2200;return Mo=(async()=>{let n=Di()?performance.now():0,r=null,o=!1,i=new Promise(d=>{r=setTimeout(()=>{!o&&n&&Zt("[offline-first][articles] cache.lookup.timeout",{preferCacheMs:e}),d(null)},e)}),s=zn().then(d=>(o=!0,r&&clearTimeout(r),r=null,n&&Zt("[offline-first][articles] cache.lookup.done",{ms:Math.round(performance.now()-n),hit:!!(d&&d.length)}),d)).catch(()=>(o=!0,r&&clearTimeout(r),r=null,null)),c=await Promise.race([s,i]);if(c&&c.length)return ba||(ba=ed({timeoutMs:t}).then(async d=>{try{typeof requestIdleCallback=="function"?requestIdleCallback(()=>Xn(d).catch(()=>{}),{timeout:2500}):setTimeout(()=>Xn(d).catch(()=>{}),250)}catch{Xn(d).catch(()=>{})}}).catch(()=>{}).finally(()=>{ba=null})),c;let l=await ed({timeoutMs:t});try{typeof requestIdleCallback=="function"?requestIdleCallback(()=>Xn(l).catch(()=>{}),{timeout:2500}):setTimeout(()=>Xn(l).catch(()=>{}),250)}catch{Xn(l).catch(()=>{})}try{let d=await zn().catch(()=>null),u=Array.isArray(l)?l.length:0,m=d&&Array.isArray(d)?d.length:0;if(m>=20&&u<=3||ch()&&m&&m>u)return d}catch{}return l})().catch(async n=>{let r=await zn().catch(()=>null);if(r&&r.length)return r;throw n}).finally(()=>{Mo=null}),Mo}function rd(){return typeof navigator<"u"&&navigator&&navigator.onLine===!1?Promise.resolve([]):Pe("/api/articles/deleted").catch(async e=>[])}function od(e,t={}){let n=String(e||"").trim();e=n.startsWith("inbox-")?"inbox":n;let{cacheTimeoutMs:o,metaTimeoutMs:i,...s}=t||{},c=a?.offlineReady?400:150,l=typeof o=="number"?Math.max(0,Math.floor(o)):c,d=typeof i=="number"?Math.max(0,Math.floor(i)):350,u=Di()?performance.now():0,m=null,g=!1,w=new Promise(P=>{m=setTimeout(()=>{!g&&u&&Zt("[offline-first][article] cache.lookup.timeout",{id:e,cacheTimeoutMs:l}),P(null)},l)}),y=Gn(e).then(P=>(g=!0,m&&clearTimeout(m),m=null,u&&Zt("[offline-first][article] cache.lookup.done",{id:e,ms:Math.round(performance.now()-u),hit:!!P}),P)).catch(P=>(g=!0,m&&clearTimeout(m),m=null,u&&Zt("[offline-first][article] cache.lookup.failed",{id:e,ms:Math.round(performance.now()-u),message:P?.message||String(P||"")}),null)),f=Promise.race([y,w]),h=()=>Pe(`/api/articles/${e}?include_history=0`,{...s,cache:"no-store"}).then(async P=>{try{ct("article.fetch.network.ok",{articleId:e,updatedAt:P?.updatedAt||null,docHash:Kt(P?.docJson||null)})}catch{}return wr(P).catch(()=>{}),P&&P.id&&String(P.id)!==String(e)&&zl(P,e).catch(()=>{}),P}).catch(async P=>{let W=await Gn(e).catch(()=>null);try{ct("article.fetch.network.err",{articleId:e,message:P?.message||String(P||""),cachedHit:!!W,cachedUpdatedAt:W?.updatedAt||null,cachedDocHash:Kt(W?.docJson||null)})}catch{}if(W)return W;throw P}),b=()=>{let P=new Date().toISOString(),q={type:"doc",content:[{type:"outlineSection",attrs:{id:(globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?()=>globalThis.crypto.randomUUID():()=>`id-${Date.now()}-${Math.random().toString(16).slice(2)}`)(),collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}]};return{id:"inbox",title:"\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438",createdAt:P,updatedAt:P,deletedAt:null,parentId:null,position:0,authorId:null,publicSlug:null,encrypted:!1,docJson:q,history:[]}},S="ttree_pending_quick_notes_v1",x=()=>{try{let P=window?.localStorage?.getItem?.(S)||"";if(!P)return[];let W=JSON.parse(P);return Array.isArray(W)?W.filter(Boolean):[]}catch{return[]}},v=(P,W)=>{let q=String(P||"").trim();if(!q)return null;let de=String(W||"").trim().split(/\r?\n/),Le=[];for(let ne=0;ne<de.length;ne+=1){let pe=de[ne];pe&&Le.push({type:"text",text:pe}),ne!==de.length-1&&Le.push({type:"hardBreak"})}return{type:"outlineSection",attrs:{id:q,collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[Le.length?{type:"paragraph",content:Le}:{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}},B=P=>{try{if(!P||String(P.id||"")!=="inbox")return P;let W=x();if(!W.length)return P;let q=P?.docJson&&typeof P.docJson=="object"?P.docJson:{type:"doc",content:[]},ee=Array.isArray(q.content)?q.content:[],de=new Set(ee.filter(ne=>ne&&ne.type==="outlineSection"&&ne.attrs&&ne.attrs.id).map(ne=>String(ne.attrs.id))),Le=[];for(let ne of W){let pe=String(ne?.sectionId||ne?.id||"").trim();if(!pe||de.has(pe))continue;let je=v(pe,ne?.text||"");je&&Le.push(je)}return Le.length?{...P,docJson:{...q,type:q.type||"doc",content:[...Le,...ee]}}:P}catch{return P}},N=()=>Pe(`/api/articles/${encodeURIComponent(e)}/meta`,{method:"GET",headers:{...s.headers||{}},cache:"no-store"}),z=()=>d?Promise.race([N(),new Promise((P,W)=>setTimeout(()=>{let q=new Error("meta_timeout");q.name="TimeoutError",W(q)},d))]):N();return f.then(async P=>{if(!P){if(!navigator.onLine&&String(e)==="inbox"){try{let Le=await Promise.race([y,new Promise(ne=>setTimeout(()=>ne(null),Math.max(500,d*5)))]);if(Le){Zt("[offline-first][article] choose.cache.late.offline.inbox",{id:e});try{ct("article.choose",{articleId:e,choose:"cache.late.offline.inbox"})}catch{}return B(Le)}}catch{}return Zt("[offline-first][article] choose.local.inbox.offline",{id:e}),B(b())}let q=y.then(Le=>Le?{src:"cache",article:B(Le)}:new Promise(()=>{})).catch(()=>new Promise(()=>{})),ee=(async()=>({src:"network",article:await B(h())}))(),de=await Promise.race([q,ee]);if(de?.src==="cache"){Zt("[offline-first][article] choose.cache.late",{id:e});try{ct("article.choose",{articleId:e,choose:"cache.late"})}catch{}return ee.catch(()=>{}),de.article}Zt("[offline-first][article] choose.network.no-cache",{id:e});try{ct("article.choose",{articleId:e,choose:"network.no_cache"})}catch{}return de.article}if(!navigator.onLine){Zt("[offline-first][article] choose.cache.offline",{id:e,updatedAt:P?.updatedAt||null});try{ct("article.choose",{articleId:e,choose:"cache.offline",cachedUpdatedAt:P?.updatedAt||null,cachedDocHash:Kt(P?.docJson||null)})}catch{}return B(P)}let W=String(P.updatedAt||P.updated_at||"").trim();if(!W){Zt("[offline-first][article] choose.network.no-cached-updatedAt",{id:e});try{ct("article.choose",{articleId:e,choose:"network.no_cached_updatedAt",cachedDocHash:Kt(P?.docJson||null)})}catch{}return B(await h())}try{Zt("[offline-first][article] meta.check.start",{id:e,cachedUpdatedAt:W});let q=await z(),ee=String(q?.updatedAt||"").trim();if(ee&&ee===W){Zt("[offline-first][article] choose.cache.meta.same",{id:e,cachedUpdatedAt:W});try{ct("article.choose",{articleId:e,choose:"cache.meta.same",cachedUpdatedAt:W,serverUpdatedAt:ee,cachedDocHash:Kt(P?.docJson||null)})}catch{}return B(P)}Zt("[offline-first][article] choose.network.meta.diff",{id:e,cachedUpdatedAt:W,serverUpdatedAt:ee||null});try{ct("article.choose",{articleId:e,choose:"network.meta.diff",cachedUpdatedAt:W,serverUpdatedAt:ee||null,cachedDocHash:Kt(cached?.docJson||null)})}catch{}return B(await h())}catch(q){String(q?.name||"")==="TimeoutError"||String(q?.message||"")==="meta_timeout"?Zt("[offline-first][article] meta.check.timeout",{id:e,metaTimeoutMs:d}):Zt("[offline-first][article] meta.check.failed",{id:e,message:q?.message||String(q||"")}),h().catch(()=>{}),String(q?.name||"")==="TimeoutError"||String(q?.message||"")==="meta_timeout"?Zt("[offline-first][article] choose.cache.meta.timeout",{id:e,cachedUpdatedAt:W,metaTimeoutMs:d}):Zt("[offline-first][article] choose.cache.meta.failed",{id:e,cachedUpdatedAt:W});try{ct("article.choose",{articleId:e,choose:String(q?.name||"")==="TimeoutError"||String(q?.message||"")==="meta_timeout"?"cache.meta.timeout":"cache.meta.failed",cachedUpdatedAt:W,cachedDocHash:Kt(P?.docJson||null),error:q?.message||String(q||"")})}catch{}return B(P)}})}function id(e){return e?Pe(`/api/articles/${encodeURIComponent(e)}/history`,{method:"GET"}):Promise.reject(new Error("articleId is required"))}function sd(e){return Pe(`/api/search?q=${encodeURIComponent(e.trim())}`)}function ad(e){let t=(e||"").trim();return t?Ql(t).then(n=>Array.isArray(n)&&n.length?n:Pe(`/api/search?q=${encodeURIComponent(t)}`)).catch(()=>Pe(`/api/search?q=${encodeURIComponent(t)}`)):Promise.resolve([])}function cd(e,t){return Pe("/api/search/semantic/rag-summary",{method:"POST",body:JSON.stringify({query:(e||"").trim(),results:Array.isArray(t)?t:[]})})}function ld(e){let t=()=>Pe("/api/articles",{method:"POST",body:JSON.stringify({title:e})});if(navigator.onLine)return t().then(async o=>(wr(o).catch(()=>{}),o));let n=globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?globalThis.crypto.randomUUID():`id-${Date.now()}-${Math.random().toString(16).slice(2)}`,r=new Date().toISOString();return zn().catch(()=>[]).then(o=>{let s=(o||[]).filter(l=>!l.parentId).reduce((l,d)=>Math.max(l,Number(d.position||0)),-1),c={id:n,title:e||"\u041D\u043E\u0432\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F",updatedAt:r,createdAt:r,docJson:null,blocks:[],encrypted:!1,parentId:null,position:s+1};return wr(c).catch(()=>{}),$t("create_article",{articleId:n,payload:{id:n,title:c.title}}).catch(()=>{}),c})}function dd(e,t){return e?!t||typeof t!="object"?Promise.reject(new Error("docJson must be object")):Pe(`/api/articles/${encodeURIComponent(e)}/doc-json`,{method:"PUT",body:JSON.stringify({docJson:t})}):Promise.reject(new Error("articleId is required"))}function ud(e){return typeof e!="string"?Promise.reject(new Error("text must be string")):Pe("/api/outline/generate-title",{method:"POST",body:JSON.stringify({text:e})})}function fd(e){return typeof e!="string"?Promise.reject(new Error("html must be string")):Pe("/api/outline/proofread-html",{method:"POST",body:JSON.stringify({html:e})})}function _i(e,t={}){let n=t.force?"?force=true":"";return Pe(`/api/articles/${e}${n}`,{method:"DELETE"})}function pd(e){return Pe(`/api/articles/${e}/restore`,{method:"POST"})}function md(e,t,n={}){let r=Array.isArray(t)?t.filter(Boolean).map(o=>String(o)):[];return e?r.length?Pe(`/api/articles/${encodeURIComponent(e)}/sections/delete`,{method:"PUT",cache:"no-store",body:JSON.stringify({opId:n?.opId||null,sectionIds:r})}):Promise.resolve({status:"ok",removedBlockIds:[]}):Promise.reject(new Error("articleId is required"))}function hd(e){let t={};return e&&(t["X-Users-Password"]=e),Pe("/api/users",{headers:t})}function gd(e){return Pe(`/api/users/${e}`,{method:"DELETE"})}function yd(){return Pe("/api/telegram/link-token",{method:"POST",body:JSON.stringify({})})}function Po(e){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return Promise.reject(new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D"));let t=new FormData;t.append("file",e);let n=i=>{if(!(typeof navigator<"u"&&navigator&&navigator.onLine===!1))try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"uploadImageFile",data:i})}).catch(()=>{})}catch{}},r=()=>fetch("/api/uploads",{method:"POST",credentials:"include",body:t}).then(async i=>{let s=await i.json().catch(()=>null);if(n({transport:"fetch",status:i.status,ok:i.ok,details:s,name:e&&e.name,type:e&&e.type,size:e&&e.size}),!i.ok){let c=s?.detail||`Upload failed (status ${i.status})`,l=new Error(c);throw l.status=i.status,l.details=s,l}return s}),o=()=>new Promise((i,s)=>{let c=new XMLHttpRequest;c.open("POST","/api/uploads"),c.withCredentials=!0,c.onreadystatechange=()=>{if(c.readyState===XMLHttpRequest.DONE)try{let l=c.status,d=null;try{d=JSON.parse(c.responseText||"null")}catch{d=null}if(n({transport:"xhr",status:l,ok:l>=200&&l<300,details:d,name:e&&e.name,type:e&&e.type,size:e&&e.size}),l>=200&&l<300)i(d);else{let u=d&&d.detail||`Upload failed (status ${l})`,m=new Error(u);m.status=l,m.details=d,s(m)}}catch(l){s(l)}},c.onerror=()=>{n({transport:"xhr",status:0,ok:!1,details:{detail:"Network error during image upload"},name:e&&e.name,type:e&&e.type,size:e&&e.size});let l=new Error("Upload failed (network error)");l.status=0,l.details={detail:"Network error during image upload"},s(l)},c.send(t)});return r().catch(i=>{let s=String(i&&i.message?i.message:"").toLowerCase();if(s.includes("status ")||s.includes("upload failed"))throw i;return o()})}function bd(e,t=null){if(!e)return Promise.reject(new Error("articleId is required"));let n={};return t&&(n.label=String(t)),Pe(`/api/articles/${encodeURIComponent(e)}/versions`,{method:"POST",body:JSON.stringify(n)})}function wd(e){return e?Pe(`/api/articles/${encodeURIComponent(e)}/versions`,{method:"GET"}):Promise.reject(new Error("articleId is required"))}function Sd(e,t){return e?t?Pe(`/api/articles/${encodeURIComponent(e)}/versions/${encodeURIComponent(t)}/restore`,{method:"POST",body:JSON.stringify({})}):Promise.reject(new Error("versionId is required")):Promise.reject(new Error("articleId is required"))}function wa(e,t){return e?t?Pe(`/api/articles/${encodeURIComponent(e)}/versions/${encodeURIComponent(t)}`,{method:"GET"}):Promise.reject(new Error("versionId is required")):Promise.reject(new Error("articleId is required"))}function lh(e,t,n=()=>{}){return typeof navigator<"u"&&navigator&&navigator.onLine===!1?Promise.reject(new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D")):new Promise((r,o)=>{let i=new XMLHttpRequest;i.open("POST",`/api/articles/${e}/attachments`),i.withCredentials=!0,i.upload.onprogress=c=>{if(c.lengthComputable){let l=Math.round(c.loaded/c.total*100);n(l)}},i.onreadystatechange=()=>{if(i.readyState===XMLHttpRequest.DONE)if(i.status>=200&&i.status<300)try{let c=JSON.parse(i.responseText||"{}");r(c)}catch(c){o(c)}else{let c=`Attachment upload failed (status ${i.status})`;try{let l=JSON.parse(i.responseText||"{}");l?.detail&&(c=l.detail)}catch{}o(new Error(c))}},i.onerror=()=>o(new Error("Network error during upload"));let s=new FormData;s.append("file",t),i.send(s)})}function No(e){let t=new Map;for(let n of e||[]){let r=n.parentId??null;t.has(r)||t.set(r,[]),t.get(r).push(n)}for(let n of t.values())n.sort((r,o)=>(r.position||0)-(o.position||0));return t}function xr(e){let t=[];for(let n=0;n<e.length;n+=1){let r=e[n];if(!r)continue;let o=n;(r.position||0)!==o&&(r.position=o,t.push({id:r.id,parentId:r.parentId??null,position:o}))}return t}function xd(e,t){return!e||!t?Promise.resolve(null):Pe(`/api/articles/${encodeURIComponent(e)}/move`,{method:"POST",body:JSON.stringify({direction:t})}).then(async r=>{try{let o=await zn().catch(()=>[]),i=No(o),s=(o||[]).find(c=>c.id===e);if(s){let c=i.get(s.parentId??null)||[],l=c.findIndex(m=>m.id===e),u=l+(t==="up"?-1:1);if(l!==-1&&u>=0&&u<c.length){let m=c[l];c[l]=c[u],c[u]=m;let g=xr(c);eo(g).catch(()=>{})}}}catch{}return r}).catch(async()=>{let r=await zn().catch(()=>[]),o=No(r),i=(r||[]).find(g=>g.id===e);if(!i)return null;let s=o.get(i.parentId??null)||[],c=s.findIndex(g=>g.id===e);if(c===-1)return null;let d=c+(t==="up"?-1:1);if(d<0||d>=s.length)return null;let u=s[c];s[c]=s[d],s[d]=u;let m=xr(s);return eo(m).catch(()=>{}),$t("move_article_position",{articleId:e,payload:{direction:t},coalesceKey:`${e}:move`}).catch(()=>{}),{id:e}})}function kd(e){return e?Pe(`/api/articles/${encodeURIComponent(e)}/indent`,{method:"POST",body:JSON.stringify({})}).catch(async()=>{let n=await zn().catch(()=>[]),r=No(n),o=(n||[]).find(m=>m.id===e);if(!o)return null;let i=r.get(o.parentId??null)||[],s=i.findIndex(m=>m.id===e);if(s<=0)return null;let l=i[s-1]?.id||null;o.parentId=l;let d=r.get(l)||[];d.push(o);let u=[];return u.push(...xr(i.filter(m=>m.id!==e))),u.push(...xr(d)),eo(u).catch(()=>{}),$t("indent_article",{articleId:e,payload:{},coalesceKey:`${e}:indent`}).catch(()=>{}),{id:e}}):Promise.resolve(null)}function Ad(e){return e?Pe(`/api/articles/${encodeURIComponent(e)}/outdent`,{method:"POST",body:JSON.stringify({})}).catch(async()=>{let n=await zn().catch(()=>[]),r=No(n),o=(n||[]).find(y=>y.id===e);if(!o)return null;let i=o.parentId??null;if(!i)return null;let c=(n||[]).find(y=>y.id===i)?.parentId??null,d=(r.get(i)||[]).filter(y=>y.id!==e),u=r.get(c)||[],m=u.findIndex(y=>y.id===i),g=m===-1?u.length:m+1;o.parentId=c,u.splice(g,0,o);let w=[];return w.push(...xr(d)),w.push(...xr(u)),eo(w).catch(()=>{}),$t("outdent_article",{articleId:e,payload:{},coalesceKey:`${e}:outdent`}).catch(()=>{}),{id:e}}):Promise.resolve(null)}function Id(e,t){return e?Pe(`/api/articles/${encodeURIComponent(e)}/move-tree`,{method:"POST",body:JSON.stringify(t||{})}).catch(async()=>{let r=await zn().catch(()=>[]),o=No(r),i=(r||[]).find(h=>h.id===e);if(!i)return null;let s=t&&t.placement||null,c=t&&t.anchorId||null,l=t?t.parentId??null:null;s==="inside"&&c&&(l=c);let d=i.parentId??null,m=(o.get(d)||[]).filter(h=>h.id!==e),w=(o.get(l)||[]).filter(h=>h.id!==e),y=w.length;if(c){let h=w.findIndex(b=>b.id===c);h!==-1&&(s==="before"?y=h:s==="after"?y=h+1:s==="inside"&&(y=w.length))}i.parentId=l,w.splice(y,0,i);let f=[];return f.push(...xr(m)),f.push(...xr(w)),eo(f).catch(()=>{}),$t("move_article_tree",{articleId:e,payload:t||{},coalesceKey:`${e}:move-tree`}).catch(()=>{}),{id:e}}):Promise.resolve(null)}async function dh({articleId:e,filename:t,overwrite:n=!1,sha256:r="",size:o=0}){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D");let s=await fetch("/api/yandex/disk/upload-url",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({filename:t||"",articleId:e||"",overwrite:!!n,sha256:r||"",size:typeof o=="number"?o:0})}),c=await s.json().catch(()=>null);if(!s.ok){let l=c&&c.detail||`Yandex upload URL failed (status ${s.status})`;throw new Error(l)}return c}async function td(e,{path:t,originalName:n,contentType:r,size:o}){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D");let i={path:t||"",originalName:n||"",contentType:r||"",size:typeof o=="number"?o:0},s=await fetch(`/api/articles/${e}/attachments/yandex`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),c=await s.json().catch(()=>null);if(!s.ok){let l=c&&c.detail||`Register Yandex attachment failed (status ${s.status})`;throw new Error(l)}return c}async function Oi(e,t,{onProgress:n}={}){if(!t)throw new Error("\u0424\u0430\u0439\u043B \u043D\u0435 \u0443\u043A\u0430\u0437\u0430\u043D");let r="";try{if(window.crypto&&window.crypto.subtle&&typeof t.arrayBuffer=="function"){let m=await t.arrayBuffer(),g=await window.crypto.subtle.digest("SHA-256",m),w=new Uint8Array(g);r=Array.from(w).map(y=>y.toString(16).padStart(2,"0")).join("")}}catch{r=""}let{href:o,method:i,path:s,exists:c,same:l}=await dh({articleId:e,filename:t.name||"attachment",overwrite:!1,sha256:r,size:t.size||0});if(c&&l&&!o)return await td(e,{path:s,originalName:t.name||"attachment",contentType:t.type||"",size:t.size||0});let d=!1;if(o)try{await new Promise((m,g)=>{let w=new XMLHttpRequest;w.open(i||"PUT",o),w.upload.onprogress=y=>{if(n&&y.lengthComputable){let f=Math.round(y.loaded/y.total*100);try{n(f)}catch{}}},w.onreadystatechange=()=>{w.readyState===XMLHttpRequest.DONE&&(w.status>=200&&w.status<300?m():g(new Error(`Yandex upload failed (status ${w.status})`)))},w.onerror=()=>g(new Error("Network error during Yandex upload")),w.send(t)}),d=!0}catch(m){console.warn("[attachments] Direct Yandex upload failed, falling back to server upload",m),d=!1}return d?await td(e,{path:s,originalName:t.name||"attachment",contentType:t.type||"",size:t.size||0}):await lh(e,t,n)}function Ri(e,t={}){let n=new FormData;return n.append("file",e),t.mode&&n.append("mode",t.mode),t.versionPrefix&&n.append("versionPrefix",t.versionPrefix),fetch("/api/import/html",{method:"POST",credentials:"include",body:n}).then(async r=>{let o=await r.json().catch(()=>null);if(!r.ok){let i=o?.detail||`Import failed (status ${r.status})`;throw new Error(i)}return o})}function vd(e,t=""){let n=new FormData;return n.append("file",e),t&&typeof t=="string"&&n.append("assetsBaseUrl",t),fetch("/api/import/markdown",{method:"POST",credentials:"include",body:n}).then(async r=>{let o=await r.json().catch(()=>null);if(!r.ok){let i=o?.detail||`Import failed (status ${r.status})`;throw new Error(i)}return o})}function Ed(e,t=""){let n=new FormData;return n.append("file",e),t&&typeof t=="string"&&n.append("assetsBaseUrl",t),fetch("/api/import/logseq",{method:"POST",credentials:"include",body:n}).then(async r=>{let o=await r.json().catch(()=>null);if(!r.ok){let i=o?.detail||`Import failed (status ${r.status})`;throw new Error(i)}return o})}var sh,Mo,ba,ah,Ft=Fe(()=>{Lo();to();Zl();mt();Bo();sh="ttree_profile_v1";Mo=null,ba=null,ah="ttree_offline_recovery_force_index_v1"});function Pt(...e){console.log("[debug]",...e)}function lt(e=""){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Hi(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Do(e=""){let t=document.createElement("template");return t.innerHTML=e||"",(t.content.textContent||"").replace(/\s+/g," ").trim()}function Td(e=""){let t=(e||"").replace(/<br\s*\/?>/gi,`
`).replace(/<\/(?:div|p|li|h[1-6])>/gi,`
`),n=document.createElement("template");return n.innerHTML=t,(n.content.textContent||"").split(`
`).map(r=>r.replace(/\s+/g," ").trim()).filter(r=>r.length)}function Cd(e){if(!e)return!1;if(e.isContentEditable)return!0;let t=e.tagName?e.tagName.toLowerCase():"";return t==="input"||t==="textarea"||t==="select"}function $i(e){if(!e||!e.isConnected)return;let t=window.getSelection();if(!t)return;let n=document.createRange();n.selectNodeContents(e),n.collapse(!1),t.removeAllRanges(),t.addRange(n)}function Sa(e){if(!e||!e.isConnected)return;let t=window.getSelection();if(!t)return;let n=document.createRange();n.selectNodeContents(e),n.collapse(!0),t.removeAllRanges(),t.addRange(n)}function Bd(e=""){let t=document.createElement("template");return t.innerHTML=e||"",t.content.textContent||""}function xa(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=t.content.querySelectorAll("img");return Array.from(n).map(r=>({src:r.getAttribute("src")||"",alt:r.getAttribute("alt")||""}))}function Dn(e,t){if(!e||!document.contains(e))return;e.focus();let n=window.getSelection();if(!n)return;let r=n.rangeCount>0?n.getRangeAt(0):document.createRange();e.contains(r.commonAncestorContainer)||(r=document.createRange(),r.selectNodeContents(e),r.collapse(!1)),n.removeAllRanges(),n.addRange(r);let o=r.createContextualFragment(t);r.deleteContents(),r.insertNode(o),r.collapse(!1),n.removeAllRanges(),n.addRange(r)}var vn=Fe(()=>{});var La={};Wn(La,{showArticleHistoryModal:()=>Ea,showArticleLinkPrompt:()=>fh,showBlockHistoryModal:()=>va,showBlockTrashPicker:()=>Ca,showConfirm:()=>Un,showImagePreview:()=>_o,showImportConflictDialog:()=>Ba,showLinkPrompt:()=>Ta,showPasswordWithHintPrompt:()=>zi,showPrompt:()=>on,showPublicLinkModal:()=>Fi,showVersionCompareTargetPicker:()=>Aa,showVersionDiffModal:()=>Ia,showVersionsPicker:()=>ka});function bn(){let e=document.getElementById(Ld);return e||(e=document.createElement("div"),e.id=Ld,document.body.appendChild(e)),e}function _n({title:e,message:t,confirmText:n,cancelText:r,renderBody:o}){let i=document.createElement("div");i.className="modal-overlay";let s=document.createElement("form");s.className="modal-form",s.addEventListener("submit",y=>{y.preventDefault()});let c=document.createElement("div");c.className="modal-card",c.setAttribute("role","dialog"),c.setAttribute("aria-modal","true"),c.tabIndex=-1;let l=document.createElement("div");l.className="modal-header";let d=document.createElement("h3");d.textContent=e||"\u041F\u043E\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043D\u0438\u0435",l.appendChild(d);let u=document.createElement("div");if(u.className="modal-body",typeof o=="function"){let y=o();Array.isArray(y)?y.forEach(f=>{f&&u.appendChild(f)}):y&&u.appendChild(y)}else u.textContent=t||"";let m=document.createElement("div");m.className="modal-footer modal-footer--stacked";let g=document.createElement("button");g.type="button",g.className="ghost",g.textContent=r||"\u041E\u0442\u043C\u0435\u043D\u0430";let w=document.createElement("button");return w.type="button",w.className="primary danger-btn",w.textContent=n||"\u0423\u0434\u0430\u043B\u0438\u0442\u044C",m.appendChild(w),m.appendChild(g),c.appendChild(l),c.appendChild(u),c.appendChild(m),s.appendChild(c),i.appendChild(s),{overlay:i,card:c,confirmBtn:w,cancelBtn:g,form:s}}function uh(e="",t=""){let n=String(e||"").length,r=String(t||"").length;if(n*r>2e6||n+r>2e4)return null;let s=Array.from(e),c=Array.from(t),l=s.length,d=c.length,u=Array.from({length:l+1},()=>new Array(d+1).fill(0));for(let f=l-1;f>=0;f-=1)for(let h=d-1;h>=0;h-=1)s[f]===c[h]?u[f][h]=u[f+1][h+1]+1:u[f][h]=Math.max(u[f+1][h],u[f][h+1]);let m=[],g=0,w=0;for(;g<l&&w<d;)s[g]===c[w]?(m.push({type:"same",value:s[g]}),g+=1,w+=1):u[g+1][w]>=u[g][w+1]?(m.push({type:"removed",value:s[g]}),g+=1):(m.push({type:"added",value:c[w]}),w+=1);for(;g<l;)m.push({type:"removed",value:s[g]}),g+=1;for(;w<d;)m.push({type:"added",value:c[w]}),w+=1;let y=[];return m.forEach(f=>{if(!f.value)return;let h=y[y.length-1];h&&h.type===f.type?h.value+=f.value:y.push({type:f.type,value:f.value})}),y}function no({baseText:e="",nextText:t="",mode:n="before"}={}){let r=document.createDocumentFragment(),o=uh(e,t);if(!o){let s=String(n==="before"?e||"":t||""),c=s.length>2e5?`${s.slice(0,2e5)}

\u2026(\u043E\u0431\u0440\u0435\u0437\u0430\u043D\u043E)`:s,l=document.createElement("div");l.className="meta",l.style.marginBottom="6px",l.textContent="Diff \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 \u2014 \u043F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0435\u043C \u0442\u0435\u043A\u0441\u0442 \u0431\u0435\u0437 \u043F\u043E\u0434\u0441\u0432\u0435\u0442\u043A\u0438.";let d=document.createElement("pre");return d.className="diff-plain",d.style.whiteSpace="pre-wrap",d.style.wordBreak="break-word",d.textContent=c,r.appendChild(l),r.appendChild(d),r}return o.forEach(i=>{if(n==="before"&&i.type==="added"||n==="after"&&i.type==="removed")return;let s=document.createElement("span");s.className="diff-seg",i.type==="added"&&s.classList.add("diff-seg--added"),i.type==="removed"&&s.classList.add("diff-seg--removed"),s.textContent=i.value,r.appendChild(s)}),r}function Un(e={}){let t=bn(),{overlay:n,card:r,confirmBtn:o,cancelBtn:i,form:s}=_n(e),c=!1,l=()=>{},d=()=>{n.classList.add("modal-overlay--hide"),setTimeout(()=>n.remove(),150),document.removeEventListener("keydown",m)},u=g=>{c||(c=!0,d(),l(g))},m=g=>{g.code==="Escape"&&(g.preventDefault(),u(!1)),g.code==="Enter"&&(g.preventDefault(),u(!0))};return new Promise(g=>{l=g,s.addEventListener("submit",w=>{w.preventDefault(),u(!0)}),o.addEventListener("click",()=>u(!0)),i.addEventListener("click",()=>u(!1)),n.addEventListener("click",w=>{w.target===n&&u(!1)}),document.addEventListener("keydown",m),t.appendChild(n),requestAnimationFrame(()=>{r.focus({preventScroll:!0})})})}function on(e={}){let t=bn(),n=null,r=Array.isArray(e.suggestions)?e.suggestions:[],o=null,{overlay:i,card:s,confirmBtn:c,cancelBtn:l,form:d}=_n({...e,renderBody:()=>{let b=document.createDocumentFragment();if(e.message){let x=document.createElement("p");x.className="modal-body__text",x.textContent=e.message,b.appendChild(x)}let S=document.createElement("input");return S.type=e.inputType==="password"?"password":"text",S.className="modal-input",S.placeholder=e.placeholder||"",S.value=e.defaultValue||"",S.autocomplete="off",b.appendChild(S),r.length&&(o=document.createElement("div"),o.className="modal-suggestions",b.appendChild(o)),n=S,b}}),u=!1,m=()=>{},g=()=>{i.classList.add("modal-overlay--hide"),setTimeout(()=>i.remove(),150),document.removeEventListener("keydown",y)},w=b=>{if(!u)if(u=!0,g(),e.returnMeta){let S={value:b??null,selectedId:n?.dataset?.selectedId||null};m(S)}else m(b)},y=b=>{if(b.code==="Escape"){b.preventDefault(),w(null);return}if(b.code==="Enter"&&n&&!e.hideConfirm){let S=n.value.trim();if(!S&&!e.allowEmpty)return;b.preventDefault(),w(S)}},f=()=>{if(!c||!n)return;let b=!!n.value.trim();c.disabled=!b&&!e.allowEmpty},h=()=>{if(!o||!n)return;let b=n.value.trim().toLowerCase();n.dataset.selectedId="";let S=r.filter(x=>(x.title||"").toLowerCase().includes(b)||(x.id||"").toLowerCase().includes(b)).slice(0,8);if(o.innerHTML="",!b||!S.length){o.classList.add("hidden");return}o.classList.remove("hidden"),S.forEach(x=>{let v=document.createElement("button");v.type="button",v.className="modal-suggestion",v.textContent=x.title||x.id||"",v.addEventListener("click",()=>{n.value=x.title||x.id||"",n.dataset.selectedId=x.id||"",f(),h(),w(n.value)}),o.appendChild(v)})};return new Promise(b=>{m=b,c.classList.remove("danger-btn"),e.hideConfirm?c.style.display="none":c.textContent=e.confirmText||"OK",l.textContent=e.cancelText||"Cancel";let S=()=>{if(!n){w(null);return}let x=n.value.trim();if(!x){n.focus();return}w(x)};d.addEventListener("submit",x=>{x.preventDefault(),S()}),c.addEventListener("click",S),l.addEventListener("click",()=>w(null)),i.addEventListener("click",x=>{x.target===i&&w(null)}),document.addEventListener("keydown",y),n?(n.dataset.selectedId="",n.addEventListener("input",()=>{n.dataset.selectedId="",f(),r.length&&h()}),e.hideConfirm&&n.addEventListener("keydown",x=>{x.code==="Enter"&&(x.preventDefault(),w(n.value.trim()))}),f(),r.length&&h()):f(),t.appendChild(i),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):s.focus({preventScroll:!0})})})}function fh(e={}){let t=bn(),n=null,r=null,o=Array.isArray(e.suggestions)?e.suggestions:[],i=null,{overlay:s,card:c,confirmBtn:l,cancelBtn:d,form:u}=_n({title:e.title||"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",renderBody:()=>{let S=document.createDocumentFragment();if(e.message){let z=document.createElement("p");z.className="modal-body__text",z.textContent=e.message,S.appendChild(z)}let x=document.createElement("label");x.className="modal-label",x.textContent=e.articleLabel||"\u0421\u0442\u0430\u0442\u044C\u044F";let v=document.createElement("input");v.type="text",v.className="modal-input",v.placeholder=e.articlePlaceholder||"ID \u0438\u043B\u0438 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435\u2026",v.value=e.defaultArticleValue||"",v.autocomplete="off",x.appendChild(v),S.appendChild(x),n=v,o.length&&(i=document.createElement("div"),i.className="modal-suggestions",S.appendChild(i));let B=document.createElement("label");B.className="modal-label",B.textContent=e.textLabel||"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)";let N=document.createElement("input");return N.type="text",N.className="modal-input",N.placeholder=e.textPlaceholder||"",N.value=e.defaultTextValue||"",N.autocomplete="off",B.appendChild(N),S.appendChild(B),r=N,S}}),m=!1,g=()=>{},w=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",b)},y=S=>{m||(m=!0,w(),g(S))},f=()=>{if(!l||!n)return;let S=!!n.value.trim()||!!n.dataset.selectedId;l.disabled=!S},h=()=>{if(!i||!n)return;let S=n.value.trim().toLowerCase();n.dataset.selectedId="";let x=o.filter(v=>(v.title||"").toLowerCase().includes(S)||(v.id||"").toLowerCase().includes(S)).slice(0,8);if(i.innerHTML="",!S||!x.length){i.classList.add("hidden");return}i.classList.remove("hidden"),x.forEach(v=>{let B=document.createElement("button");B.type="button",B.className="modal-suggestion",B.textContent=v.title||v.id||"",B.addEventListener("click",()=>{n.value=v.title||v.id||"",n.dataset.selectedId=v.id||"",f(),h(),r&&!r.value.trim()&&!e.lockTextValue&&(r.value=v.title||""),r?.focus?.({preventScroll:!0}),r?.select?.()}),i.appendChild(B)})},b=S=>{if(S.code==="Escape"){S.preventDefault(),y(null);return}S.code};return new Promise(S=>{g=S,l.classList.remove("danger-btn"),l.textContent=e.confirmText||"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",d.textContent=e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430";let x=()=>{if(!n||!r){y(null);return}let v=n.value.trim(),B=n.dataset.selectedId||"";if(!v&&!B){n.focus();return}y({articleValue:v,selectedId:B||null,textValue:r.value??""})};u.addEventListener("submit",v=>{v.preventDefault(),x()}),l.addEventListener("click",x),d.addEventListener("click",()=>y(null)),s.addEventListener("click",v=>{v.target===s&&y(null)}),document.addEventListener("keydown",b),n?(n.dataset.selectedId="",n.addEventListener("input",()=>{n.dataset.selectedId="",f(),o.length&&h()}),f(),o.length&&h()):f(),t.appendChild(s),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):c.focus({preventScroll:!0})})})}function Fi(e={}){let t=bn(),n=null,r=e.url||"",{overlay:o,card:i,confirmBtn:s,cancelBtn:c}=_n({title:e.title||"\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u0430\u044F \u0441\u0441\u044B\u043B\u043A\u0430",renderBody:()=>{let f=document.createDocumentFragment(),h=document.createElement("label");h.className="modal-label",h.textContent=e.label||"\u041F\u0440\u043E\u0441\u043C\u043E\u0442\u0440 \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435";let b=document.createElement("input");return b.type="text",b.className="modal-input",b.value=r,b.readOnly=!0,b.autocomplete="off",h.appendChild(b),n=b,f.appendChild(h),f}}),l=!1,d=()=>{},u=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",g)},m=()=>{l||(l=!0,u(),d())},g=f=>{f.code==="Escape"&&(f.preventDefault(),m())},w=f=>{if(!f)return!1;let h=document.createElement("textarea");h.value=f,h.setAttribute("readonly",""),h.style.position="absolute",h.style.left="-9999px",document.body.appendChild(h),h.focus(),h.select();let b=!1;try{b=document.execCommand("copy")}catch{b=!1}return document.body.removeChild(h),b},y=()=>{let f=n&&n.value||r;if(f){L("\u0421\u0441\u044B\u043B\u043A\u0430 \u0441\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u0430");try{if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function"){let h=navigator.clipboard.writeText(f);h&&typeof h.catch=="function"&&h.catch(()=>{w(f)})}else w(f)}catch{w(f)}}};return new Promise(f=>{d=f,s.classList.remove("danger-btn"),s.textContent="\u29C9 \u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443",s.setAttribute("aria-label",e.copyLabel||"\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443"),c.classList.add("hidden"),s.addEventListener("click",()=>{y(),m()}),o.addEventListener("click",h=>{h.target===o&&m()}),document.addEventListener("keydown",g),t.appendChild(o),requestAnimationFrame(()=>{n?n.focus({preventScroll:!0}):i.focus({preventScroll:!0})})})}function ka(e={}){let t=bn(),n=Array.isArray(e.versions)?e.versions:[],r=n[0]?.id||"",o=b=>{try{let S=new Date(b);return Number.isNaN(S.getTime())?String(b||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(S)}catch{return String(b||"")}},{overlay:i,card:s,confirmBtn:c,cancelBtn:l,form:d}=_n({title:e.title||"\u0412\u0435\u0440\u0441\u0438\u0438",confirmText:e.confirmText||"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",cancelText:e.cancelText||"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",renderBody:()=>{let b=document.createDocumentFragment(),S=document.createElement("p");if(S.className="modal-body__text",S.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0435\u0440\u0441\u0438\u044E \u0441\u0442\u0430\u0442\u044C\u0438 \u0434\u043B\u044F \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F.",b.appendChild(S),!n.length){let v=document.createElement("div");return v.className="modal-empty",v.textContent="\u0412\u0435\u0440\u0441\u0438\u0439 \u043F\u043E\u043A\u0430 \u043D\u0435\u0442.",b.appendChild(v),b}let x=document.createElement("div");return x.className="modal-list",n.forEach((v,B)=>{let N=document.createElement("label");N.className="modal-list__item";let z=document.createElement("input");z.type="radio",z.name="version",z.value=v.id||"",z.checked=B===0,z.addEventListener("change",()=>{r=z.value,c.disabled=!r,u.disabled=!r});let P=document.createElement("div");P.className="modal-list__meta";let W=document.createElement("div");W.className="modal-list__title",W.textContent=v.label||o(v.created_at||v.createdAt);let q=document.createElement("div");q.className="modal-list__subtitle";let ee=v.reason||"",de=o(v.created_at||v.createdAt);q.textContent=[de,ee].filter(Boolean).join(" \xB7 "),P.appendChild(W),P.appendChild(q),N.appendChild(z),N.appendChild(P),x.appendChild(N)}),b.appendChild(x),b}});s.classList.add("modal-card--diff-light"),c.classList.remove("danger-btn"),c.disabled=!r;let u=document.createElement("button");u.type="button",u.className="ghost",u.textContent=e.compareText||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C",u.disabled=!r;let m=s.querySelector(".modal-footer");m&&m.insertBefore(u,c);let g=!1,w=()=>{},y=()=>{i.classList.add("modal-overlay--hide"),setTimeout(()=>i.remove(),150),document.removeEventListener("keydown",h)},f=b=>{g||(g=!0,y(),w(b))},h=b=>{b.code==="Escape"&&(b.preventDefault(),f(null))};return new Promise(b=>{w=b;let S=()=>{r&&f({action:"restore",versionId:r})};d.addEventListener("submit",x=>{x.preventDefault(),S()}),c.addEventListener("click",S),u.addEventListener("click",()=>{r&&f({action:"compare",versionId:r})}),l.addEventListener("click",()=>f(null)),i.addEventListener("click",x=>{x.target===i&&f(null)}),document.addEventListener("keydown",h),t.appendChild(i),requestAnimationFrame(()=>{s.focus({preventScroll:!0})})})}function Aa(e={}){let t=bn(),n=Array.isArray(e.versions)?e.versions:[],r=String(e.excludeId||""),o=[{kind:"current",id:"__current__",title:"\u0422\u0435\u043A\u0443\u0449\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F"},...n.filter(h=>String(h.id||"")&&String(h.id||"")!==r).map(h=>({kind:"version",id:String(h.id),title:h.label||h.created_at||h.createdAt||h.id}))],i=o[0]?.id||"",{overlay:s,card:c,confirmBtn:l,cancelBtn:d,form:u}=_n({title:e.title||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C \u0441\u2026",confirmText:e.confirmText||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C",cancelText:e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430",renderBody:()=>{let h=document.createDocumentFragment(),b=document.createElement("p");b.className="modal-body__text",b.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0442\u043E\u0440\u0443\u044E \u0441\u0442\u043E\u0440\u043E\u043D\u0443 \u0441\u0440\u0430\u0432\u043D\u0435\u043D\u0438\u044F.",h.appendChild(b);let S=document.createElement("div");return S.className="modal-list",o.forEach((x,v)=>{let B=document.createElement("label");B.className="modal-list__item";let N=document.createElement("input");N.type="radio",N.name="compareTarget",N.value=x.id,N.checked=v===0,N.addEventListener("change",()=>{i=N.value,l.disabled=!i});let z=document.createElement("div");z.className="modal-list__meta";let P=document.createElement("div");P.className="modal-list__title",P.textContent=x.title,z.appendChild(P),B.appendChild(N),B.appendChild(z),S.appendChild(B)}),h.appendChild(S),h}});c.classList.add("modal-card--diff-light"),l.classList.remove("danger-btn"),l.disabled=!i;let m=!1,g=()=>{},w=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",f)},y=h=>{m||(m=!0,w(),g(h))},f=h=>{h.code==="Escape"&&(h.preventDefault(),y(null))};return new Promise(h=>{g=h;let b=()=>{if(!i)return;let S=o.find(x=>x.id===i)||null;if(!S){y(null);return}if(S.kind==="current"){y({target:"current"});return}y({target:"version",versionId:S.id})};u.addEventListener("submit",S=>{S.preventDefault(),b()}),l.addEventListener("click",b),d.addEventListener("click",()=>y(null)),s.addEventListener("click",S=>{S.target===s&&y(null)}),document.addEventListener("keydown",f),t.appendChild(s),requestAnimationFrame(()=>{c.focus({preventScroll:!0})})})}function Ia(e={}){let t=bn(),n=Array.isArray(e.changes)?e.changes:[],r=n.find(w=>w.type==="changed")||n[0]||null,{overlay:o,card:i,confirmBtn:s,cancelBtn:c}=_n({title:e.title||"\u041E\u0442\u043B\u0438\u0447\u0438\u044F \u0432\u0435\u0440\u0441\u0438\u0439",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:"",renderBody:()=>{let w=document.createDocumentFragment(),y=document.createElement("div");y.className="diff-summary";let f=n.reduce((W,q)=>(W[q.type]=(W[q.type]||0)+1,W),{added:0,removed:0,changed:0});if(y.textContent=`\u0418\u0437\u043C\u0435\u043D\u0435\u043D\u043E: ${f.changed||0} \xB7 \u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E: ${f.added||0} \xB7 \u0423\u0434\u0430\u043B\u0435\u043D\u043E: ${f.removed||0}`,w.appendChild(y),!n.length){let W=document.createElement("div");return W.className="modal-empty",W.textContent="\u041D\u0435\u0442 \u043E\u0442\u043B\u0438\u0447\u0438\u0439.",w.appendChild(W),w}let h=document.createElement("div");h.className="modal-list",n.forEach(W=>{let q=document.createElement("button");q.type="button",q.className=`diff-item diff-item--${W.type}${r&&r.id===W.id?" diff-item--active":""}`;let ee=W.label||W.id;q.textContent=`${W.type==="changed"?"\u2260":W.type==="added"?"+":"\u2212"} ${ee}`,q.addEventListener("click",()=>{r=W,h.querySelectorAll(".diff-item").forEach(de=>de.classList.remove("diff-item--active")),q.classList.add("diff-item--active"),P()}),h.appendChild(q)}),w.appendChild(h);let b=document.createElement("div");b.className="diff-panes";let S=document.createElement("div");S.className="diff-pane-wrap";let x=document.createElement("div");x.className="diff-pane-wrap";let v=document.createElement("div");v.className="diff-pane-title",v.textContent=e.beforeTitle||"\u0412\u0435\u0440\u0441\u0438\u044F";let B=document.createElement("div");B.className="diff-pane-title",B.textContent=e.afterTitle||"\u0422\u0435\u043A\u0443\u0449\u0430\u044F";let N=document.createElement("div");N.className="diff-pane diff-pane--before";let z=document.createElement("div");z.className="diff-pane diff-pane--after",S.appendChild(v),S.appendChild(N),x.appendChild(B),x.appendChild(z),b.appendChild(S),b.appendChild(x),w.appendChild(b);let P=()=>{let W=r?.before||"",q=r?.after||"";N.innerHTML="",z.innerHTML="",N.appendChild(no({baseText:W,nextText:q,mode:"before"})),z.appendChild(no({baseText:W,nextText:q,mode:"after"}))};return P(),w}});i.classList.add("modal-card--fullscreen"),i.classList.add("modal-card--diff-light"),s.classList.remove("danger-btn"),c&&(c.style.display="none");let l=!1,d=()=>{},u=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",g)},m=()=>{l||(l=!0,u(),d())},g=w=>{w.code==="Escape"&&(w.preventDefault(),m())};return new Promise(w=>{d=w,s.addEventListener("click",m),o.addEventListener("click",y=>{y.target===o&&m()}),document.addEventListener("keydown",g),t.appendChild(o),requestAnimationFrame(()=>{i.focus({preventScroll:!0})})})}function va(e={}){let t=bn(),n=Array.isArray(e.entries)?e.entries:[],r=n[0]||null,o=r,i=[],s=null,c=b=>{try{let S=new Date(b);return Number.isNaN(S.getTime())?String(b||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(S)}catch{return String(b||"")}},{overlay:l,card:d,confirmBtn:u,cancelBtn:m}=_n({title:e.title||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0431\u043B\u043E\u043A\u0430",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:e.canRestore?"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C (\u043F\u043E\u0441\u043B\u0435 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F)":"",renderBody:()=>{let b=document.createDocumentFragment(),S=document.createElement("p");if(S.className="modal-body__text",S.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0435. \u041C\u043E\u0436\u043D\u043E \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430 \u0434\u043E \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F.",b.appendChild(S),!n.length){let ne=document.createElement("div");return ne.className="modal-empty",ne.textContent="\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430.",b.appendChild(ne),b}let x=document.createElement("div");x.className="diff-layout";let v=document.createElement("div");v.className="modal-list diff-sidebar",i=[],n.forEach(ne=>{let pe=document.createElement("button");pe.type="button";let je=!!(r&&r.id===ne.id);pe.className=`diff-item${je?" diff-item--active":""}`,pe.setAttribute("aria-selected",je?"true":"false");let gt=c(ne.timestamp);pe.textContent=gt?`\u2260 ${gt}`:`\u2260 ${ne.id||""}`.trim(),pe.addEventListener("click",()=>{r=ne,v.querySelectorAll(".diff-item").forEach(Tt=>{Tt.classList.remove("diff-item--active"),Tt.setAttribute("aria-selected","false")}),pe.classList.add("diff-item--active"),pe.setAttribute("aria-selected","true"),Le()}),v.appendChild(pe),i.push(pe)});let B=document.createElement("div");B.className="diff-main";let N=document.createElement("div");N.className="diff-panes diff-panes--side";let z=document.createElement("div");z.className="diff-pane-wrap";let P=document.createElement("div");P.className="diff-pane-wrap";let W=document.createElement("div");W.className="diff-pane-title",W.textContent=e.beforeTitle||"\u0414\u043E";let q=document.createElement("div");q.className="diff-pane-title",q.textContent=e.afterTitle||"\u041F\u043E\u0441\u043B\u0435";let ee=document.createElement("div");ee.className="diff-pane diff-pane--before";let de=document.createElement("div");de.className="diff-pane diff-pane--after",z.appendChild(W),z.appendChild(ee),P.appendChild(q),P.appendChild(de),N.appendChild(z),N.appendChild(P),B.appendChild(N),x.appendChild(v),x.appendChild(B),b.appendChild(x);let Le=()=>{o=r;let ne=r?.beforePlain||r?.before||"",pe=r?.afterPlain||r?.after||"";ee.innerHTML="",de.innerHTML="",ee.appendChild(no({baseText:ne,nextText:pe,mode:"before"})),de.appendChild(no({baseText:ne,nextText:pe,mode:"after"}))};return s=Le,Le(),b}});d.classList.add("modal-card--fullscreen"),d.classList.add("modal-card--diff-light"),u.classList.remove("danger-btn"),!e.canRestore&&m&&(m.style.display="none"),m&&m.classList.add("danger-btn");let g=!1,w=()=>{},y=()=>{l.classList.add("modal-overlay--hide"),setTimeout(()=>l.remove(),150),document.removeEventListener("keydown",h)},f=b=>{g||(g=!0,y(),w(b))},h=b=>{if(b.code==="Escape"&&(b.preventDefault(),f(null)),b.code==="ArrowUp"||b.code==="ArrowDown"){if(!n.length)return;b.preventDefault();let S=String(r?.id||""),x=n.findIndex(N=>String(N?.id||"")===S);x<0&&(x=0),x=b.code==="ArrowUp"?Math.max(0,x-1):Math.min(n.length-1,x+1);let v=n[x]||null;if(!v)return;r=v;let B=i[x];if(i.forEach(N=>{N.classList.remove("diff-item--active"),N.setAttribute("aria-selected","false")}),B){B.classList.add("diff-item--active"),B.setAttribute("aria-selected","true"),B.focus({preventScroll:!0});try{B.scrollIntoView({block:"nearest"})}catch{}}typeof s=="function"&&s()}};return new Promise(b=>{w=b,u.addEventListener("click",()=>f(null)),m&&e.canRestore&&m.addEventListener("click",()=>f({action:"restore",entry:o||r||null})),l.addEventListener("click",S=>{S.target===l&&f(null)}),document.addEventListener("keydown",h),t.appendChild(l),requestAnimationFrame(()=>{d.focus({preventScroll:!0})})})}function Md(e){let t=[],n=r=>{if(!r)return;if(typeof r=="string"){t.push(r);return}if(Array.isArray(r)){r.forEach(n);return}if(typeof r!="object")return;typeof r.text=="string"&&t.push(r.text);let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(e),t.join("").replace(/\u00a0/g," ").trim()}function ph(e){return!e||typeof e!="object"?!1:!!(e.beforeHeadingJson||e.beforeBodyJson||e.afterHeadingJson||e.afterBodyJson)}function Ea(e={}){let t=bn(),r=(Array.isArray(e.entries)?e.entries:[]).filter(ph),o=typeof e.onRestore=="function"?e.onRestore:null,i=P=>String(P??"").replace(/\u00a0/g," ").trim(),s=r.map(P=>({...P,beforePlain:i(P.beforePlain??P.before??""),afterPlain:i(P.afterPlain??P.after??"")})),c=new Map;for(let P of s){let W=String(P?.blockId||"").trim();if(!W)continue;let q=c.get(W)||{blockId:W,entries:[],latestAt:0,label:""};q.entries.push(P);let ee=Date.parse(P.timestamp||"")||0;if(ee>q.latestAt&&(q.latestAt=ee),!q.label){let de=Md(P.afterHeadingJson)||Md(P.beforeHeadingJson)||"",Le=(P.afterPlain||P.beforePlain||"").split(`
`).map(ne=>ne.trim()).find(Boolean)||"";q.label=de||Le||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"}c.set(W,q)}let l=Array.from(c.values()).sort((P,W)=>(W.latestAt||0)-(P.latestAt||0)),d=l[0]?.blockId||null,u=null,m=!1,g=P=>{try{let W=new Date(P);return Number.isNaN(W.getTime())?String(P||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(W)}catch{return String(P||"")}},{overlay:w,card:y,confirmBtn:f,cancelBtn:h}=_n({title:e.title||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0441\u0442\u0430\u0442\u044C\u0438",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:e.canRestore?"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C":"",renderBody:()=>{let P=document.createDocumentFragment(),W=document.createElement("p");if(W.className="modal-body__text",W.textContent=e.message||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439 outline-\u0440\u0435\u0436\u0438\u043C\u0430. \u041C\u043E\u0436\u043D\u043E \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0435 \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0441\u0435\u043A\u0446\u0438\u0438 (\u0435\u0441\u043B\u0438 \u0441\u0435\u043A\u0446\u0438\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u2014 \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u043D\u0435\u0446 \u0441\u0442\u0430\u0442\u044C\u0438).",P.appendChild(W),!l.length){let se=document.createElement("div");return se.className="modal-empty",se.textContent="\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430.",P.appendChild(se),P}let q=document.createElement("div");q.className="diff-layout diff-layout--article-history";let ee=document.createElement("div");ee.className="modal-list diff-sidebar",ee.classList.add("diff-sections");let de=document.createElement("input");de.type="text",de.className="modal-input",de.placeholder="\u041F\u043E\u0438\u0441\u043A \u043F\u043E \u0438\u0441\u0442\u043E\u0440\u0438\u0438\u2026",ee.appendChild(de);let Le=document.createElement("div");Le.style.marginTop="8px",ee.appendChild(Le);let ne=document.createElement("div");ne.className="diff-main";let pe=document.createElement("div");pe.className="diff-layout diff-layout--article-history-inner";let je=document.createElement("div");je.className="modal-list diff-sidebar",je.classList.add("diff-revisions");let gt=document.createElement("div");gt.className="diff-panes diff-panes--side";let Tt=document.createElement("div");Tt.className="diff-pane-wrap";let _e=document.createElement("div");_e.className="diff-pane-wrap";let it=document.createElement("div");it.className="diff-pane-title",it.textContent=e.beforeTitle||"\u0414\u043E";let Lt=document.createElement("div");Lt.className="diff-pane-title",Lt.textContent=e.afterTitle||"\u041F\u043E\u0441\u043B\u0435";let nn=document.createElement("div");nn.className="diff-pane diff-pane--before";let G=document.createElement("div");G.className="diff-pane diff-pane--after",Tt.appendChild(it),Tt.appendChild(nn),_e.appendChild(Lt),_e.appendChild(G),gt.appendChild(Tt),gt.appendChild(_e),pe.appendChild(je),pe.appendChild(gt),ne.appendChild(pe),q.appendChild(ee),q.appendChild(ne),P.appendChild(q);let ue=()=>{let se=de.value.trim().toLowerCase(),he=se?l.filter(ye=>(ye.label||"").toLowerCase().includes(se)?!0:(ye.entries||[]).some(Z=>`${Z.beforePlain||""}
${Z.afterPlain||""}`.toLowerCase().includes(se))):l;Le.innerHTML="",he.forEach(ye=>{let Z=document.createElement("button");Z.type="button";let we=ye.blockId===d;Z.className=`diff-item${we?" diff-item--active":""}`,Z.setAttribute("aria-selected",we?"true":"false");let De=ye.latestAt?g(new Date(ye.latestAt).toISOString()):"",$e=Array.isArray(ye.entries)?ye.entries.length:0;Z.textContent=`${ye.label||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"}${De?` \xB7 ${De}`:""}${$e?` \xB7 ${$e}`:""}`,Z.addEventListener("click",()=>{d=ye.blockId,u=null,m=!1,ue(),be(),fe()}),Le.appendChild(Z)}),d&&!he.some(ye=>ye.blockId===d)&&(d=he[0]?.blockId||null,u=null,m=!1,be(),fe())},be=()=>{let se=d?c.get(d):null,he=Array.isArray(se?.entries)?se.entries.slice():[];he.sort((Z,we)=>(Date.parse(we.timestamp||"")||0)-(Date.parse(Z.timestamp||"")||0));let ye=u&&he.some(Z=>String(Z?.id||"")===String(u||""));(!m||!ye)&&(u=he[0]?.id||null),je.innerHTML="",he.forEach(Z=>{let we=document.createElement("button");we.type="button";let De=String(Z.id||"")===String(u||"");we.className=`diff-item${De?" diff-item--active":""}`,we.setAttribute("aria-selected",De?"true":"false");let $e=g(Z.timestamp),et=(Z.afterPlain||Z.beforePlain||"").slice(0,64).trim();we.textContent=`${$e?`\u2260 ${$e}`:`\u2260 ${Z.id||""}`}${et?` \xB7 ${et}`:""}`,we.addEventListener("click",()=>{u=Z.id||null,m=!0,be(),fe()}),je.appendChild(we)})},fe=()=>{let se=d?c.get(d):null,he=Array.isArray(se?.entries)?se.entries:[],ye=he.find(De=>String(De?.id||"")===String(u||""))||he[0]||null,Z=ye?.beforePlain||"",we=ye?.afterPlain||"";nn.innerHTML="",G.innerHTML="",nn.appendChild(no({baseText:Z,nextText:we,mode:"before"})),G.appendChild(no({baseText:Z,nextText:we,mode:"after"}))};return de.addEventListener("input",()=>{ue()}),ue(),be(),fe(),P}});y.classList.add("modal-card--fullscreen"),y.classList.add("modal-card--diff-light"),f.classList.remove("danger-btn"),!e.canRestore&&h&&(h.style.display="none"),h&&h.classList.add("danger-btn");let b=!1,S=()=>{},x=!1,v=()=>{w.classList.add("modal-overlay--hide"),setTimeout(()=>w.remove(),150),document.removeEventListener("keydown",N)},B=P=>{b||(b=!0,v(),S(P))},N=P=>{P.code==="Escape"&&(P.preventDefault(),B(null))},z=()=>{let P=d?c.get(d):null,W=Array.isArray(P?.entries)?P.entries:[];return W.find(q=>String(q?.id||"")===String(u||""))||W[0]||null};return new Promise(P=>{S=P,f.addEventListener("click",()=>B(null)),h&&e.canRestore&&h.addEventListener("click",async()=>{let W=z();if(!W){L("\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430");return}if(!o){B({action:"restore",entry:W});return}if(x)return;x=!0;let q=h.textContent;try{h.disabled=!0,f.disabled=!0,h.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C\u2026",await o(W)}catch(ee){L(ee?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C")}finally{x=!1,h.textContent=q,h.disabled=!1,f.disabled=!1}}),w.addEventListener("click",W=>{W.target===w&&B(null)}),document.addEventListener("keydown",N),t.appendChild(w),requestAnimationFrame(()=>{y.focus({preventScroll:!0})})})}function Ta(e={}){let t=bn(),n=null,r=null,{overlay:o,card:i,confirmBtn:s,cancelBtn:c,form:l}=_n({...e,renderBody:()=>{let f=document.createDocumentFragment();if(e.message){let v=document.createElement("p");v.className="modal-body__text",v.textContent=e.message,f.appendChild(v)}let h=document.createElement("label");h.className="modal-label",h.textContent=e.textLabel||"\u0422\u0435\u043A\u0441\u0442";let b=document.createElement("input");b.type="text",b.className="modal-input",b.placeholder=e.textPlaceholder||"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438",b.value=e.defaultText||"",b.autocomplete="off",h.appendChild(b);let S=document.createElement("label");S.className="modal-label",S.textContent=e.urlLabel||"\u0421\u0441\u044B\u043B\u043A\u0430";let x=document.createElement("input");return x.type="text",x.className="modal-input",x.placeholder=e.urlPlaceholder||"https://example.com",x.value=e.defaultUrl||"",x.autocomplete="off",S.appendChild(x),n=b,r=x,f.appendChild(h),f.appendChild(S),f}}),d=!1,u=()=>{},m=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",w)},g=f=>{d||(d=!0,m(),u(f))},w=f=>{if(f.code==="Escape"){f.preventDefault(),g(null);return}f.code==="Enter"&&!s.disabled&&(f.preventDefault(),g({text:(n?.value||"").trim(),url:(r?.value||"").trim()}))},y=()=>{let f=!!(r?.value||"").trim();s.disabled=!f};return new Promise(f=>{u=f,s.classList.remove("danger-btn"),s.textContent=e.confirmText||"OK",c.textContent=e.cancelText||"Cancel";let h=()=>{g({text:(n?.value||"").trim(),url:(r?.value||"").trim()})};l.addEventListener("submit",S=>{S.preventDefault(),s.disabled||h()}),s.addEventListener("click",h),c.addEventListener("click",()=>g(null)),o.addEventListener("click",S=>{S.target===o&&g(null)}),document.addEventListener("keydown",w);let b=S=>{S&&S.addEventListener("input",y)};b(n),b(r),y(),t.appendChild(o),requestAnimationFrame(()=>{r?(r.focus({preventScroll:!0}),r.value&&r.setSelectionRange(r.value.length,r.value.length)):i.focus({preventScroll:!0})})})}function zi(e={}){let t=bn(),n=null,r=null,{overlay:o,card:i,confirmBtn:s,cancelBtn:c,form:l}=_n({...e,renderBody:()=>{let f=document.createDocumentFragment();if(e.message){let v=document.createElement("p");v.className="modal-body__text",v.textContent=e.message,f.appendChild(v)}let h=document.createElement("label");h.className="modal-label",h.textContent="\u041F\u0430\u0440\u043E\u043B\u044C";let b=document.createElement("input");b.type="password",b.className="modal-input",b.placeholder="\u041F\u0430\u0440\u043E\u043B\u044C \u0434\u043B\u044F \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B",b.autocomplete="off",h.appendChild(b);let S=document.createElement("label");S.className="modal-label",S.textContent="\u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0430 (\u043D\u0435\u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u044C\u043D\u043E)";let x=document.createElement("input");return x.type="text",x.className="modal-input",x.placeholder="\u041D\u0430\u043F\u043E\u043C\u0438\u043D\u0430\u043D\u0438\u0435 \u043E \u043F\u0430\u0440\u043E\u043B\u0435",x.autocomplete="off",S.appendChild(x),n=b,r=x,f.appendChild(h),f.appendChild(S),f}}),d=!1,u=()=>{},m=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",w)},g=f=>{d||(d=!0,m(),u(f))},w=f=>{if(f.code==="Escape"){f.preventDefault(),g(null);return}f.code==="Enter"&&!s.disabled&&(f.preventDefault(),g({password:(n?.value||"").trim(),hint:(r?.value||"").trim()}))},y=()=>{let f=!!(n?.value||"").trim();s.disabled=!f};return new Promise(f=>{u=f,s.classList.remove("danger-btn"),s.textContent=e.confirmText||"\u0417\u0430\u0449\u0438\u0442\u0438\u0442\u044C",c.textContent=e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430";let h=()=>{s.disabled||g({password:(n?.value||"").trim(),hint:(r?.value||"").trim()})};s.addEventListener("click",h),l.addEventListener("submit",b=>{b.preventDefault(),h()}),c.addEventListener("click",()=>g(null)),o.addEventListener("click",b=>{b.target===o&&g(null)}),document.addEventListener("keydown",w),n&&n.addEventListener("input",y),y(),t.appendChild(o),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):i.focus({preventScroll:!0})})})}function Ca(e={}){let t=bn(),n=Array.isArray(e.items)?e.items:[],{overlay:r,card:o,confirmBtn:i,cancelBtn:s}=_n({title:e.title||"\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432",renderBody:()=>{let g=document.createElement("div");if(!n.length){let y=document.createElement("p");return y.className="modal-body__text",y.textContent="\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432 \u043F\u0443\u0441\u0442\u0430",g.appendChild(y),g}let w=document.createElement("div");return w.className="block-trash-list",n.forEach(y=>{let f=document.createElement("div");f.className="block-trash-item";let h=y.block&&y.block.text||"",b=Td(h),S=document.createElement("div");S.className="block-trash-item__title",S.textContent=b[0]||"(\u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A)";let x=document.createElement("div");x.className="block-trash-item__meta";let v=y.deletedAt?new Date(y.deletedAt).toLocaleString():"";x.textContent=v||"";let B=document.createElement("div");B.className="block-trash-item__info",B.appendChild(S),v&&B.appendChild(x);let N=document.createElement("button");N.type="button",N.className="primary",N.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",N.addEventListener("click",()=>{u(y)}),f.appendChild(B),f.appendChild(N),w.appendChild(f)}),g.appendChild(w),g}}),c=!1,l=()=>{},d=()=>{r.classList.add("modal-overlay--hide"),setTimeout(()=>r.remove(),150),document.removeEventListener("keydown",m)},u=g=>{c||(c=!0,d(),l(g||null))},m=g=>{g.code==="Escape"&&(g.preventDefault(),u(null))};return new Promise(g=>{l=g,i.classList.remove("hidden"),i.textContent="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u043A\u043E\u0440\u0437\u0438\u043D\u0443",i.classList.add("danger-btn"),s.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",i.addEventListener("click",()=>u({action:"clear"})),s.addEventListener("click",()=>u(null)),r.addEventListener("click",w=>{w.target===r&&u(null)}),document.addEventListener("keydown",m),t.appendChild(r),requestAnimationFrame(()=>{o.focus({preventScroll:!0})})})}function Ba(e={}){let t=bn(),{title:n,message:r,existingTitle:o,importedTitle:i,existingCreatedAt:s,existingUpdatedAt:c,importedCreatedAt:l,importedUpdatedAt:d,allowApplyToAll:u=!0}=e||{},m=document.createElement("div");m.className="modal-overlay";let g=document.createElement("div");g.className="modal-card",g.setAttribute("role","dialog"),g.setAttribute("aria-modal","true"),g.tabIndex=-1;let w=document.createElement("div");w.className="modal-header";let y=document.createElement("h3");y.textContent=n||"\u041A\u043E\u043D\u0444\u043B\u0438\u043A\u0442 \u043F\u0440\u0438 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0438",w.appendChild(y);let f=document.createElement("div");if(f.className="modal-body",r){let ee=document.createElement("p");ee.className="modal-body__text",ee.textContent=r,f.appendChild(ee)}if(o||i){let ee=document.createElement("p");ee.className="modal-body__text",ee.innerHTML=[o?`<strong>\u0412 \u0431\u0430\u0437\u0435:</strong> ${o}`:"",i?`<strong>\u0418\u0437 \u0444\u0430\u0439\u043B\u0430:</strong> ${i}`:""].filter(Boolean).join("<br />"),f.appendChild(ee)}if(s||c||l||d){let ee=ne=>{if(!ne)return"";let pe=new Date(ne);return Number.isNaN(pe.getTime())?ne:pe.toLocaleString()},de=document.createElement("p");de.className="modal-body__text";let Le=[];if(s||c){let ne=s?ee(s):"\u2014",pe=c?ee(c):"\u2014";Le.push(`<strong>\u0412 \u0431\u0430\u0437\u0435:</strong> \u0441\u043E\u0437\u0434\u0430\u043D\u0430 ${ne}, \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430 ${pe}`)}if(l||d){let ne=l?ee(l):"\u2014",pe=d?ee(d):"\u2014";Le.push(`<strong>\u0418\u0437 \u0444\u0430\u0439\u043B\u0430:</strong> \u0441\u043E\u0437\u0434\u0430\u043D\u0430 ${ne}, \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430 ${pe}`)}de.innerHTML=Le.join("<br />"),f.appendChild(de)}let h=null;if(u){let ee=document.createElement("label");ee.className="modal-label";let de=document.createElement("input");de.type="checkbox",de.style.marginRight="0.5rem",ee.appendChild(de),ee.appendChild(document.createTextNode("\u041F\u0440\u0438\u043C\u0435\u043D\u044F\u0442\u044C \u044D\u0442\u043E \u0440\u0435\u0448\u0435\u043D\u0438\u0435 \u043A\u043E \u0432\u0441\u0435\u043C \u043A\u043E\u043D\u0444\u043B\u0438\u043A\u0442\u0430\u043C")),h=de,f.appendChild(ee)}let b=document.createElement("div");b.className="modal-footer modal-footer--stacked";let S=document.createElement("button");S.type="button",S.className="ghost",S.textContent="\u041E\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0443\u044E";let x=document.createElement("button");x.type="button",x.className="primary danger-btn",x.textContent="\u041F\u0435\u0440\u0435\u0437\u0430\u043F\u0438\u0441\u0430\u0442\u044C";let v=document.createElement("button");v.type="button",v.className="ghost",v.textContent="\u0421\u043E\u0437\u0434\u0430\u0442\u044C \u043A\u043E\u043F\u0438\u044E";let B=document.createElement("button");B.type="button",B.className="ghost",B.textContent="\u041E\u0442\u043C\u0435\u043D\u0430",b.appendChild(S),b.appendChild(x),b.appendChild(v),b.appendChild(B),g.appendChild(w),g.appendChild(f),g.appendChild(b),m.appendChild(g);let N=!1,z=()=>{},P=()=>{m.classList.add("modal-overlay--hide"),setTimeout(()=>m.remove(),150),document.removeEventListener("keydown",q)},W=ee=>{if(N)return;N=!0;let de=!!(h&&h.checked);P(),z({action:ee,applyToAll:de})},q=ee=>{ee.code==="Escape"&&(ee.preventDefault(),W(null))};return new Promise(ee=>{z=ee,S.addEventListener("click",()=>W("keep")),x.addEventListener("click",()=>W("overwrite")),v.addEventListener("click",()=>W("copy")),B.addEventListener("click",()=>W(null)),m.addEventListener("click",de=>{de.target===m&&W(null)}),document.addEventListener("keydown",q),t.appendChild(m),requestAnimationFrame(()=>{g.focus({preventScroll:!0})})})}function _o(e,t=""){let n=bn(),r=document.createElement("div");r.className="modal-overlay image-modal";let o=document.createElement("div");o.className="image-modal__card",o.setAttribute("role","dialog"),o.setAttribute("aria-modal","true"),o.tabIndex=-1;let i=document.createElement("img");i.className="image-modal__img",i.src=e,t&&(i.alt=t),o.appendChild(i),r.appendChild(o);let s,c=()=>{s&&s()},l=d=>{d.code==="Escape"&&(d.preventDefault(),c())};s=()=>{document.removeEventListener("keydown",l),r.classList.add("modal-overlay--hide"),setTimeout(()=>r.remove(),150)},r.addEventListener("click",d=>{d.target===r&&c()}),document.addEventListener("keydown",l),n.appendChild(r),requestAnimationFrame(()=>{o.focus({preventScroll:!0})})}var Ld,Vn=Fe(()=>{vn();Nt();Ld="modal-root"});function Pd(e){if(typeof btoa=="function"){let t="";for(let n=0;n<e.length;n+=1)t+=String.fromCharCode(e[n]);return btoa(t)}if(typeof Buffer<"u")return Buffer.from(e).toString("base64");throw new Error("No base64 encoder available")}function Dd(e){if(!e)return new Uint8Array(0);if(typeof atob=="function"){let t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r+=1)n[r]=t.charCodeAt(r);return n}if(typeof Buffer<"u"){let t=Buffer.from(e,"base64"),n=new Uint8Array(t.length);for(let r=0;r<t.length;r+=1)n[r]=t[r];return n}throw new Error("No base64 decoder available")}function Oo(e){return typeof e=="string"&&e.startsWith(Ma)}async function Vi(e,t){if(!e)throw new Error("Password is required");let n=t&&t.length?Dd(t):_d(16),r=Ui(e||""),o=new Uint8Array(r.length+n.length);return o.set(r,0),o.set(n,r.length),{key:{raw:Ui(String.fromCharCode(...o))},salt:Pd(n)}}function Ui(e=""){let t=2166136261,n=16777619;for(let o=0;o<e.length;o+=1){let i=e.charCodeAt(o);t^=i,t=t*16777619>>>0,n^=i<<o%8,n=n*16777619>>>0}let r=new Uint8Array(32);for(let o=0;o<32;o+=1){let i=o<16?t:n;r[o]=i>>>o%4*8&255}return r}function _d(e){let t=new Uint8Array(e);for(let n=0;n<e;n+=1)t[n]=Math.floor(Math.random()*256);return t}async function Na(e,t=""){if(!e)throw new Error("Missing encryption key");let n=e&&e.raw?e.raw:Ui("fallback-key"),r=_d(12),i=new TextEncoder().encode(t||""),s=new Uint8Array(r.length+i.length);s.set(r,0);for(let c=0;c<i.length;c+=1){let l=n[c%n.length],d=r[c%r.length];s[r.length+c]=i[c]^l^d}return`${Ma}${Pd(s)}`}async function Ro(e,t){if(!e)throw new Error("Missing encryption key");if(!Oo(t))throw new Error("Data is not in encrypted format");let n=t.slice(Ma.length),r=Dd(n);if(r.length<13)throw new Error("Encrypted payload is too short");let o=r.slice(0,12),i=r.slice(12),s=e&&e.raw?e.raw:Ui("fallback-key"),c=new Uint8Array(i.length);for(let d=0;d<i.length;d+=1){let u=s[d%s.length],m=o[d%o.length];c[d]=i[d]^u^m}return new TextDecoder().decode(c)}async function Pa(e){return Na(e,Nd)}async function Od(e,t){if(!t)return!1;try{return await Ro(e,t)===Nd}catch{return!1}}async function Rd(e,t){if(!e)return;if(typeof e.text=="string"&&Oo(e.text))try{e.text=await Ro(t,e.text)}catch{e.text=""}let n=Array.isArray(e.children)?e.children:[];for(let r of n)await Rd(r,t)}async function Da(e,t){if(!(!e||!Array.isArray(e.blocks)))for(let n of e.blocks)await Rd(n,t)}async function Ho(e,t){if(!e)return;typeof e.text=="string"&&(e.text=await Na(t,e.text));let n=Array.isArray(e.children)?e.children:[];for(let r of n)await Ho(r,t)}async function qi(e,t){return Na(e,t||"")}var Ma,Nd,$o=Fe(()=>{Ma="enc-v1:",Nd="memus-article-encryption-ok"});function mh(e){return String(e||"").trim()}async function Hd(e,{blockLimit:t=30,articleLimit:n=15}={}){let r=mh(e);if(!r)return[];let o=await at(),i=r.toLowerCase(),s=o.transaction(["articles","outline_sections"],"readonly"),c=s.objectStore("articles"),l=s.objectStore("outline_sections"),d=await ve(c.getAll()).catch(()=>[])||[],u=d.filter(h=>h&&!h.deletedAt).filter(h=>String(h.title||"").toLowerCase().includes(i)).sort((h,b)=>String(b.updatedAt||"").localeCompare(String(h.updatedAt||""))).slice(0,Math.max(0,Number(n)||0)).map(h=>({type:"article",articleId:h.id,articleTitle:h.title||"",snippet:h.title||""}));try{if(!Number(await ve(l.count()).catch(()=>0)))return await ze(s),navigator.onLine?null:u}catch{}let m=await ve(l.getAll()).catch(()=>[])||[],g=new Map(d.map(h=>[h.id,h.title||""])),w=Math.max(0,Number(t)||0),y=m.filter(h=>String(h?.text||"").toLowerCase().includes(i)).sort((h,b)=>String(b?.updatedAt||"").localeCompare(String(h?.updatedAt||""))).slice(0,w).map(h=>({blockId:h.sectionId,articleId:h.articleId,articleTitle:g.get(h.articleId)||"",blockText:h.text||""})),f=[];for(let h of y){let b=h.articleTitle||"",S=h.blockText||"";f.push({type:"block",articleId:h.articleId,articleTitle:b,blockId:h.blockId,snippet:S.slice(0,160),blockText:S})}return await ze(s),[...u,...f]}var $d=Fe(()=>{rr();Pn()});function Fd(e=""){return String(e||"").replace(/\r\n/g,`
`).replace(/\u00a0/g," ").split(`
`).map(t=>t.replace(/[ \t]+$/g,""))}function zd(e=""){let t=a.searchQuery.trim();if(!t)return lt(e);let n=new RegExp(Hi(t),"gi");return lt(e).replace(n,r=>`<mark>${r}</mark>`)}function kr(){if(!p.ragOpenBtn)return;if(a.sidebarSearchView!=="search"){p.ragOpenBtn.classList.add("hidden");return}let e=a.searchMode==="semantic"&&!!a.searchQuery.trim()&&!a.searchLoading&&!a.searchError&&Array.isArray(a.searchResults)&&a.searchResults.length>0;p.ragOpenBtn.classList.toggle("hidden",!e)}function Or(){if(!p.searchResults)return;if(a.sidebarSearchView!=="search"){p.searchResults.classList.add("hidden"),p.searchResults.innerHTML="",kr();return}if(!a.searchQuery.trim()){p.searchResults.classList.add("hidden"),p.searchResults.innerHTML="",kr();return}if(p.searchResults.classList.remove("hidden"),a.searchLoading){p.searchResults.innerHTML='<div class="search-result-empty">\u041F\u043E\u0438\u0441\u043A...</div>',kr();return}if(a.searchError){p.searchResults.innerHTML=`<div class="search-result-empty">${lt(a.searchError)}</div>`,kr();return}if(!a.searchResults.length){p.searchResults.innerHTML='<div class="search-result-empty">\u041D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E</div>',kr();return}p.searchResults.innerHTML="",a.searchResults.forEach(t=>{let n=t.type==="article",r=document.createElement("div");r.className="search-result-item";let o=t.articleTitle||" ",i="",s=t.articleTitle||"";if(!n){let u=Fd(t.blockText||""),m=u.findIndex(g=>g.trim()!=="");i=m>=0?(u[m]||"").trim():"",o=i||s||" "}let c=zd(o||" "),l=n?"\u0421\u0442\u0430\u0442\u044C\u044F":"\u0411\u043B\u043E\u043A",d="";if(!n){let u=Fd(t.blockText||""),m=u.findIndex(h=>h.trim()!==""),y=(m>=0?u.slice(m+1).filter(h=>h.trim()!==""):u.filter(h=>h.trim()!=="")).slice(0,2).map(h=>zd(h)).join("<br />");d=`${s?`<div class="search-result-item__article">${lt(s)}</div>`:""}${y?`<div>${y}</div>`:""}`}r.innerHTML=`
      <div class="search-result-item__header">
        <span class="search-result-item__badge">${l}</span>
        <span class="search-result-item__title">${c}</span>
      </div>
      ${d?`<div class="search-result-item__snippet">${d}</div>`:""}
    `,r.addEventListener("mousedown",u=>{u.preventDefault(),hh(t)}),p.searchResults.appendChild(r)}),kr()}function or(){p.searchResults&&p.searchResults.classList.add("hidden")}async function Ud(e){if(a.sidebarSearchView!=="search"){or(),kr();return}let t=e.target.value;if(a.searchQuery=t,!t.trim()){a.searchResults=[],a.searchError="",a.searchLoading=!1,Or();return}a.searchLoading=!0;let n=Date.now();a.searchRequestId=n,Or();try{let r=null;if(a.searchMode!=="semantic")try{r=await Hd(t)}catch{r=null}r||(r=await(a.searchMode==="semantic"?ad:sd)(t)),a.searchRequestId===n&&(a.searchResults=r,a.searchError="")}catch(r){a.searchRequestId===n&&(a.searchError=r.message)}finally{a.searchRequestId===n&&(a.searchLoading=!1,Or())}}function hh(e){or(),p.searchInput&&(p.searchInput.value=""),a.searchQuery="",a.searchResults=[],a.searchError="",kr();let t=e.type==="article";a.scrollTargetBlockId=t?null:e.blockId,a.currentBlockId=t?null:e.blockId,a.isSidebarMobileOpen&&an(!1),bt(pt.article(e.articleId))}function Vd(){let e=a.searchQuery.trim();e&&a.searchMode==="semantic"&&(a.searchLoading||a.searchError||!Array.isArray(a.searchResults)||!a.searchResults.length||(a.ragQuery=e,a.ragResults=JSON.parse(JSON.stringify(a.searchResults)),a.ragSummaryHtml="",a.ragSummaryError="",a.ragSummaryLoading=!0,a.scrollTargetBlockId=null,a.currentBlockId=null,bt(pt.article("RAG")),(async()=>{Bt("\u0413\u0435\u043D\u0435\u0440\u0438\u0440\u0443\u044E \u0441\u0432\u043E\u0434\u043A\u0443\u2026",{protect:!0});try{let t=await cd(a.ragQuery,a.ragResults);a.ragSummaryHtml=t&&t.summaryHtml||"",a.ragSummaryError=""}catch(t){a.ragSummaryError=t.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0440\u0435\u0437\u044E\u043C\u0435",a.ragSummaryHtml=""}finally{a.ragSummaryLoading=!1,st({force:!0}),a.articleId==="RAG"&&bt(pt.article("RAG"))}})()))}var Ki=Fe(()=>{mt();Mt();vn();Ft();En();cn();Nt();$d()});function jd(){try{let e=localStorage.getItem(Jd);e==="1"?a.isSidebarCollapsed=!0:e==="0"&&(a.isSidebarCollapsed=!1)}catch{}}function Wd(){try{localStorage.setItem(Jd,a.isSidebarCollapsed?"1":"0")}catch{}}function Yd(){try{let e=localStorage.getItem(qd),t=e?JSON.parse(e):[];a.sidebarCollapsedArticleIds=Array.isArray(t)?t:[]}catch{a.sidebarCollapsedArticleIds=[]}}function Fo(){try{localStorage.setItem(qd,JSON.stringify(a.sidebarCollapsedArticleIds||[]))}catch{}}function Xd(){try{let e=localStorage.getItem(Kd),t=e?JSON.parse(e):[];a.listCollapsedArticleIds=Array.isArray(t)?t:[]}catch{a.listCollapsedArticleIds=[]}}function Rr(){try{localStorage.setItem(Kd,JSON.stringify(a.listCollapsedArticleIds||[]))}catch{}}function ir(){let e=a.sidebarSelectedArticleId||a.articleId;if(!e)return;let t=a.isTrashView?a.deletedArticlesIndex:a.articlesIndex;if(!Array.isArray(t)||!t.length)return;let n=new Map(t.map(s=>[s.id,s])),r=new Set(a.sidebarCollapsedArticleIds||[]),o=new Set,i=n.get(e)||null;for(;i&&i.parentId&&!o.has(i.parentId);)o.add(i.parentId),r.delete(i.parentId),i=n.get(i.parentId)||null;a.sidebarCollapsedArticleIds=Array.from(r),Fo()}var qd,Kd,Jd,ro=Fe(()=>{mt();qd="ttree_collapsed_articles",Kd="ttree_list_collapsed_articles",Jd="ttree_sidebar_collapsed"});function _a(){p.articlesTabBtn&&(p.articlesTabBtn.classList.toggle("active",!a.isTrashView),p.articlesTabBtn.setAttribute("aria-pressed",a.isTrashView?"false":"true")),p.trashTabBtn&&(p.trashTabBtn.classList.toggle("active",a.isTrashView),p.trashTabBtn.setAttribute("aria-pressed",a.isTrashView?"true":"false")),p.createArticleBtn&&(p.createArticleBtn.disabled=a.isTrashView),p.sidebarNewArticleBtn&&(p.sidebarNewArticleBtn.disabled=a.isTrashView)}function sr(){Yn&&(oa(!1),p.hintPopover&&p.hintPopover.classList.add("hidden"),p.hintToggleBtn&&p.hintToggleBtn.setAttribute("aria-expanded","false"))}function Oa(e){e&&e.stopPropagation(),oa(!Yn),p.hintPopover&&p.hintPopover.classList.toggle("hidden",!Yn),p.hintToggleBtn&&p.hintToggleBtn.setAttribute("aria-expanded",Yn?"true":"false")}function Hr(e){p.sidebar&&(a.isSidebarCollapsed=e,p.sidebar.classList.toggle("collapsed",e),p.sidebarToggle&&(p.sidebarToggle.setAttribute("aria-expanded",e?"false":"true"),p.sidebarToggle.title=e?"\u041F\u043E\u043A\u0430\u0437\u0430\u0442\u044C \u043F\u0430\u043D\u0435\u043B\u044C":"\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C \u043F\u0430\u043D\u0435\u043B\u044C",p.sidebarToggle.textContent=e?"\u2192":"x"),Wd(),e&&(sr(),or()))}function Ra(){Hr(!a.isSidebarCollapsed)}function an(e){a.isSidebarMobileOpen=e,p.sidebar&&p.sidebar.classList.toggle("mobile-open",e),p.sidebarBackdrop&&p.sidebarBackdrop.classList.toggle("hidden",!e),e&&(sr(),or())}function zo(){an(!1)}function Uo(e){p.articleView.classList.toggle("hidden",!e),p.articleListView.classList.toggle("hidden",e),p.articleHeader&&p.articleHeader.classList.toggle("hidden",!e),e||sr(),e&&a.isTrashView&&(a.isTrashView=!1,_a())}var Ji=Fe(()=>{mt();Mt();Ki();ro()});function tu({renderSidebarArticleList:e,renderMainArticleList:t,setArticlesIndex:n}={}){Zd=typeof e=="function"?e:null,Ha=typeof t=="function"?t:null,eu=typeof n=="function"?n:null}function Wi(){qn&&(qn.classList.remove("drop-before","drop-after","drop-inside"),qn=null)}function nu(e,t){e&&(qn&&qn!==e&&qn.classList.remove("drop-before","drop-after","drop-inside"),qn=e,qn.classList.remove("drop-before","drop-after","drop-inside"),t==="before"?qn.classList.add("drop-before"):t==="after"?qn.classList.add("drop-after"):t==="inside"&&qn.classList.add("drop-inside"))}function bh(){vt&&(vt.sourceEl instanceof Element&&vt.sourceEl.classList.remove("article-dnd-source"),typeof document<"u"&&document.body&&document.body.classList.remove("article-dnd-active"),window.removeEventListener("pointermove",za),window.removeEventListener("pointerup",Vo),window.removeEventListener("pointercancel",Vo),window.removeEventListener("touchmove",ru),window.removeEventListener("touchend",ji),window.removeEventListener("touchcancel",ji),vt=null,Wi(),window.__ttreeDraggingArticleId=null)}function Gd(e){return e instanceof Element?!!(e.closest(".star-btn")||e.closest(".row-actions")):!1}function wh(e,t){if(!t||vt||!e.touches||e.touches.length!==1)return;let n=e.touches[0],r=e.currentTarget instanceof Element?e.currentTarget:null;vt={pointerId:"legacy-touch",articleId:t,startX:n.clientX,startY:n.clientY,dragging:!1,lastTargetId:null,lastDropMode:null,sourceEl:r},window.__ttreeDraggingArticleId=t,typeof document<"u"&&document.body&&document.body.classList.add("article-dnd-active");try{let o=window.getSelection?window.getSelection():null;o&&!o.isCollapsed&&o.removeAllRanges()}catch{}window.addEventListener("touchmove",ru,{passive:!1}),window.addEventListener("touchend",ji),window.addEventListener("touchcancel",ji)}function ru(e){if(!vt||!e.touches||e.touches.length===0)return;let t=e.touches[0];za({pointerId:"legacy-touch",clientX:t.clientX,clientY:t.clientY,preventDefault:()=>{e.preventDefault()}})}function ji(){vt&&Vo({pointerId:"legacy-touch"})}function Sh(e,t){let n=document.elementFromPoint(e,t);if(!n)return null;let r=n.closest(".sidebar-article-item, #articleList li");return!r||!r.dataset||!r.dataset.articleId?null:r}function xh(e,t){if(!t||vt)return;let n=e.currentTarget instanceof Element?e.currentTarget:null;vt={pointerId:e.pointerId,articleId:t,startX:e.clientX,startY:e.clientY,dragging:!1,lastTargetId:null,lastDropMode:null,sourceEl:n},window.__ttreeDraggingArticleId=t,typeof document<"u"&&document.body&&document.body.classList.add("article-dnd-active");try{let r=window.getSelection?window.getSelection():null;r&&!r.isCollapsed&&r.removeAllRanges()}catch{}try{e.currentTarget?.setPointerCapture?.(e.pointerId)}catch{}window.addEventListener("pointermove",za),window.addEventListener("pointerup",Vo),window.addEventListener("pointercancel",Vo)}function za(e){if(!vt||e.pointerId!==vt.pointerId)return;let t=e.clientX-vt.startX,n=e.clientY-vt.startY;if(!vt.dragging){if(Math.hypot(t,n)<gh)return;vt.dragging=!0,vt.sourceEl instanceof Element&&vt.sourceEl.classList.add("article-dnd-source")}e.preventDefault();let r=Sh(e.clientX,e.clientY);if(!r||!r.dataset||!r.dataset.articleId||r.dataset.articleId===vt.articleId){Wi(),vt.lastTargetId=null,vt.lastDropMode=null;return}let o=r.getBoundingClientRect(),i=e.clientY-o.top,s=o.height/3,c;i<s?c="before":i>o.height-s?c="after":c="inside",vt.lastTargetId=r.dataset.articleId,vt.lastDropMode=c,nu(r,c)}function Vo(e){if(!vt||e.pointerId!==vt.pointerId)return;let t=vt;bh(),!(!t.dragging||!t.lastTargetId||!t.lastDropMode)&&t.lastTargetId!==t.articleId&&ou(t.articleId,t.lastTargetId,t.lastDropMode)}function Ua(e,t){e&&(yh?e.addEventListener("pointerdown",n=>{if(n.pointerType!=="touch"||typeof n.button=="number"&&n.button!==0||Gd(n.target))return;let r=n.pointerId,o=350,i=!1,s=window.setTimeout(()=>{i=!0,xh(n,t)},o),c=l=>{l.pointerId===r&&(i||window.clearTimeout(s),window.removeEventListener("pointerup",c,!0),window.removeEventListener("pointercancel",c,!0))};window.addEventListener("pointerup",c,!0),window.addEventListener("pointercancel",c,!0)}):e.addEventListener("touchstart",n=>{if(!n.touches||n.touches.length!==1)return;let r=n.target;if(Gd(r))return;let o=350,i=!1,s=window.setTimeout(()=>{i=!0,wh(n,t)},o),c=()=>{i||window.clearTimeout(s),window.removeEventListener("touchend",c,!0),window.removeEventListener("touchcancel",c,!0)};window.addEventListener("touchend",c,!0),window.addEventListener("touchcancel",c,!0)},{passive:!1}))}function Fa(e){return e&&(a.articlesIndex||[]).find(t=>t.id===e)||null}function Qd(e){let t=e||null;return(a.articlesIndex||[]).filter(n=>(n.parentId||null)===t).sort((n,r)=>n.position!==r.position?n.position-r.position:new Date(n.updatedAt||0)-new Date(r.updatedAt||0))}function kh(e,t,n,r){if(!e)return;let o=Fa(e);if(!o)return;let i=t||null,s=o.parentId||null,l=Qd(s).filter(w=>w.id!==e),d;i===s?d=l:d=Qd(i);let u=d.filter(w=>w.id!==e),m=u.length;if(n&&r&&r!=="inside"){let w=u.findIndex(y=>y.id===n);w!==-1&&(m=r==="before"?w:w+1)}r==="inside"&&(m=u.length),m<0&&(m=0),m>u.length&&(m=u.length);let g=u.slice();g.splice(m,0,o),o.parentId=i,l.forEach((w,y)=>{w.position=y}),g.forEach((w,y)=>{w.parentId=i,w.position=y})}function ou(e,t,n){if(!e||!t||!n)return;let r=Fa(e),o=Fa(t);if(!r||!o)return;let i=n==="inside"?o.id:o.parentId||null,s=n==="inside"?null:o.id;kh(e,i,s,n),Zd?.(),Ha?.(),(async()=>{try{await Id(e,{parentId:i,anchorId:s,placement:n})}catch(c){try{let l=await In();eu?.(l),Ha?.()}catch{}L(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443")}})()}function Ah(e){window.__ttreeDraggingArticleId?wn=window.__ttreeDraggingArticleId:wn=e.currentTarget?.dataset?.articleId||null,e.dataTransfer&&(e.dataTransfer.effectAllowed="move",wn&&e.dataTransfer.setData("text/plain",wn))}function Ih(e){if(!wn){let s=window.__ttreeDraggingArticleId,c=null;if(!s&&e?.dataTransfer)try{c=e.dataTransfer.getData("text/plain")||null}catch{c=null}wn=s||c||null}if(!wn||!e.currentTarget||!e.currentTarget.dataset.articleId)return;e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="move");let t=e.currentTarget,n=t.getBoundingClientRect(),r=e.clientY-n.top,o=n.height/3,i;r<o?i="before":r>n.height-o?i="after":i="inside",nu(t,i)}function vh(e){if(!wn){let c=window.__ttreeDraggingArticleId,l=null;if(!c&&e?.dataTransfer)try{l=e.dataTransfer.getData("text/plain")||null}catch{l=null}wn=c||l||null}if(!wn)return;let t=e.currentTarget,n=t?.dataset?.articleId||null;if(!n||n===wn)return;e.preventDefault(),Wi();let r=t.getBoundingClientRect(),o=e.clientY-r.top,i=r.height/3,s;o<i?s="before":o>r.height-i?s="after":s="inside",ou(wn,n,s),wn=null}function Eh(){wn=null,window.__ttreeDraggingArticleId=null,Wi()}function Va(e){e&&(e.draggable=!0,e.addEventListener("dragstart",Ah),e.addEventListener("dragover",Ih),e.addEventListener("drop",vh),e.addEventListener("dragend",Eh))}var Zd,Ha,eu,$a,wn,qn,gh,vt,yh,qa=Fe(()=>{mt();Ft();Nt();Zd=null,Ha=null,eu=null;$a=!1;typeof window<"u"&&(window.matchMedia&&window.matchMedia("(pointer: coarse)").matches||"ontouchstart"in window)&&($a=!0);wn=null,qn=null,gh=6,vt=null,yh=typeof window<"u"&&"PointerEvent"in window&&!$a});function Th(){try{let e=localStorage.getItem(iu),t=e?JSON.parse(e):[];a.favoriteArticles=Array.isArray(t)?t:[]}catch{a.favoriteArticles=[]}}function Ch(){try{localStorage.setItem(iu,JSON.stringify(a.favoriteArticles||[]))}catch{}}function su(e=[]){let t=new Set(a.favoriteArticles||[]);return[...e].sort((n,r)=>{let o=t.has(n.id),i=t.has(r.id);return o!==i?o?-1:1:new Date(r.updatedAt||r.deletedAt||0)-new Date(n.updatedAt||n.deletedAt||0)})}function oo(e){if(!e)return;a.favoriteArticles||(a.favoriteArticles=[]);let t=new Set(a.favoriteArticles);t.has(e)?t.delete(e):t.add(e),a.favoriteArticles=Array.from(t),Ch(),kt(),Gt()}function Yi(e=[]){(!a.favoriteArticles||!a.favoriteArticles.length)&&Th();let t=Array.isArray(e)?e:[];a.articlesIndex=t.map(r=>({id:r.id,title:r.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",updatedAt:r.updatedAt||new Date().toISOString(),deletedAt:r.deletedAt||null,publicSlug:r.publicSlug||null,parentId:r.parentId||null,position:typeof r.position=="number"?r.position:0}));let n=new Set(a.articlesIndex.map(r=>r.id));Array.isArray(a.sidebarCollapsedArticleIds)&&a.sidebarCollapsedArticleIds.length&&(a.sidebarCollapsedArticleIds=a.sidebarCollapsedArticleIds.filter(r=>n.has(r)),Fo()),Array.isArray(a.listCollapsedArticleIds)&&a.listCollapsedArticleIds.length&&(a.listCollapsedArticleIds=a.listCollapsedArticleIds.filter(r=>n.has(r)),Rr()),kt()}function au(e=[]){let t=su(Array.isArray(e)?e:[]);a.deletedArticlesIndex=t,kt()}function Xi(e){let t=(a.articleFilterQuery||"").trim(),n=e?.target?.value||"",r=String(n||"").trim();a.articleFilterQuery=n;let o=!!(t&&!r&&a.sidebarArticlesMode!=="recent");o&&ir(),kt(),o&&window.requestAnimationFrame(()=>{try{Gi()}catch{}})}function cu(e){let t=String(e||"").trim();if(!t||!p?.sidebarArticleList)return;let n=p.sidebarArticleList.querySelector(`li.sidebar-article-item[data-article-id="${CSS.escape(t)}"]`)||p.sidebarArticleList.querySelector(`li[data-article-id="${CSS.escape(t)}"]`);if(n)try{n.scrollIntoView({block:"center",inline:"nearest"})}catch{}}function Gi(){let e=a.sidebarSelectedArticleId||a.articleId;e&&cu(e)}function On(e){if(!e||!e.id||e.deletedAt)return;let t={id:e.id,title:e.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",updatedAt:e.updatedAt||new Date().toISOString(),publicSlug:e.publicSlug||null,parentId:e.parentId||null,position:typeof e.position=="number"?e.position:0},n=a.articlesIndex.findIndex(r=>r.id===t.id);n>=0?a.articlesIndex[n]={...a.articlesIndex[n],...t}:a.articlesIndex.unshift(t),kt()}function Ka(e){if(!e)return;let t=a.articlesIndex.length;a.articlesIndex=a.articlesIndex.filter(n=>n.id!==e),t!==a.articlesIndex.length&&(kt(),Gt())}function qo(e){if(!e)return;let t=a.deletedArticlesIndex.length;a.deletedArticlesIndex=a.deletedArticlesIndex.filter(n=>n.id!==e),t!==a.deletedArticlesIndex.length&&(kt(),Gt())}function lu(e=[]){let t=new Map;e.forEach(o=>{t.set(o.id,{...o,children:[]})});let n=[];t.forEach(o=>{let i=o.parentId||null;i&&t.has(i)?t.get(i).children.push(o):n.push(o)});let r=o=>{o.sort((i,s)=>{let c=(a.favoriteArticles||[]).includes(i.id),l=(a.favoriteArticles||[]).includes(s.id);return c!==l?c?-1:1:i.position!==s.position?i.position-s.position:new Date(s.updatedAt||0)-new Date(i.updatedAt||0)}),o.forEach(i=>r(i.children||[]))};return r(n),n}function kt(){if(!p.sidebarArticleList)return;p.sidebarArticleList.innerHTML="",p.backToList&&p.backToList.classList.toggle("active",a.sidebarArticlesMode!=="recent"),p.sidebarRecentBtn&&p.sidebarRecentBtn.classList.toggle("active",a.sidebarArticlesMode==="recent");let e=(a.articleFilterQuery||"").trim().toLowerCase(),t=a.sidebarArticlesMode==="recent"?"recent":"tree",n=a.isTrashView?a.deletedArticlesIndex:a.articlesIndex,r=new Set(a.favoriteArticles||[]),o=new Set(a.sidebarCollapsedArticleIds||[]),i=a.sidebarSelectedArticleId||a.articleId,s=Array.isArray(a.recentArticleIds)?a.recentArticleIds:[],c=[];if(!a.isTrashView&&(r.has("RAG")||t==="recent"&&s.includes("RAG"))){let f=(a.ragQuery||"").trim();c.push({id:"RAG",title:f?`AI: ${f}`:"AI: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B \u043F\u043E\u0438\u0441\u043A\u0430",updatedAt:new Date().toISOString(),deletedAt:null,publicSlug:null,parentId:null,position:0})}let d=new Set(c.map(f=>f.id)),u=c.length&&!a.isTrashView?[...(n||[]).filter(f=>!d.has(f.id)),...c]:n,m=new Set;(u||[]).forEach(f=>{let h=f.parentId||null;h&&m.add(h)});let g=(u||[]).filter(f=>(e?(f.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(e):!0)&&(a.isTrashView?!0:f.id!=="inbox"));if(!g.length){let f=document.createElement("li");f.className="sidebar-article-empty",f.textContent=a.isTrashView?e?"No deleted pages match the filter":"Trash is empty":e?"\u041D\u0435\u0442 \u0441\u043E\u0432\u043F\u0430\u0434\u0435\u043D\u0438\u0439":"\u041D\u0435\u0442 \u0441\u0442\u0430\u0442\u0435\u0439",p.sidebarArticleList.appendChild(f);return}if(t==="recent"){let f=new Map(g.map(v=>[v.id,v])),h=new Set(s),b=s.map(v=>f.get(v)).filter(Boolean),S=su(g.filter(v=>!h.has(v.id)));[...b,...S].forEach(v=>{let B=document.createElement("li");B.className="sidebar-article-item",B.dataset.articleId=v.id;let N=document.createElement("div");N.className="sidebar-article-row";let z=document.createElement("button");z.type="button",!a.isTrashView&&v.id===i&&z.classList.add("active");let P=r.has(v.id),W=lt(v.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),q=v.publicSlug?"\uE774 ":"";z.innerHTML=`<span class="sidebar-article-title">${q}${W}</span><span class="star-btn ${P?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${P?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}">${P?"\uE735":"\uE734"}</span>`,z.addEventListener("click",()=>{window.__ttreeDraggingArticleId||(a.sidebarSelectedArticleId=v.id,bt(pt.article(v.id)),a.isSidebarMobileOpen&&an(!1))});let ee=z.querySelector(".star-btn");ee&&ee.addEventListener("click",de=>{de.stopPropagation(),oo(v.id)}),N.appendChild(z),B.appendChild(N),p.sidebarArticleList.appendChild(B)});return}let w=lu(g),y=(f,h)=>{let b=document.createElement("li");b.className="sidebar-article-item",m.has(f.id)&&(b.classList.add("has-children"),o.has(f.id)&&b.classList.add("is-collapsed")),b.dataset.articleId=f.id,b.style.paddingLeft=`${h*1.25}rem`;let S=document.createElement("div");S.className="sidebar-article-row";let x=document.createElement("button");x.type="button",!a.isTrashView&&f.id===i&&x.classList.add("active");let v=r.has(f.id),B=lt(f.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),N=f.publicSlug?"\uE774 ":"";x.innerHTML=`<span class="sidebar-article-title">${N}${B}</span><span class="star-btn ${v?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${v?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}">${v?"\uE735":"\uE734"}</span>`,x.addEventListener("click",()=>{if(window.__ttreeDraggingArticleId)return;a.sidebarSelectedArticleId=f.id,a.sidebarCollapsedArticleIds||(a.sidebarCollapsedArticleIds=[]);let P=new Set(a.sidebarCollapsedArticleIds);P.has(f.id)?P.delete(f.id):P.add(f.id),a.sidebarCollapsedArticleIds=Array.from(P),Fo(),kt()}),x.addEventListener("dblclick",P=>{P.preventDefault(),P.stopPropagation(),a.sidebarSelectedArticleId=f.id,bt(pt.article(f.id)),a.isSidebarMobileOpen&&an(!1)});let z=x.querySelector(".star-btn");z&&z.addEventListener("click",P=>{P.stopPropagation(),oo(f.id)}),S.appendChild(x),b.appendChild(S),a.isTrashView||(Va(b),Ua(b,f.id)),p.sidebarArticleList.appendChild(b),o.has(f.id)||(f.children||[]).forEach(P=>y(P,h+1))};w.forEach(f=>y(f,0))}function Gt(e=null){if(!p.articleList)return;p.articleList.innerHTML="";let t="",n=Array.isArray(e)&&e.length?e:a.isTrashView?a.deletedArticlesIndex:a.articlesIndex,r=new Set(a.favoriteArticles||[]),o=new Set(a.listCollapsedArticleIds||[]),i=a.listSelectedArticleId||a.articleId,s=new Set;if(n.forEach(u=>{let m=u.parentId||null;m&&s.add(m)}),!n.length){let u=document.createElement("li");u.textContent=a.isTrashView?t?"No deleted pages match the filter":"Trash is empty":t?"\u041D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E":"\u0421\u043F\u0438\u0441\u043E\u043A \u043F\u0443\u0441\u0442.",p.articleList.appendChild(u);return}if(a.isTrashView){n.slice().filter(u=>(t?(u.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(t):!0)&&(a.isTrashView?!0:u.id!=="inbox")).forEach(u=>{let m=document.createElement("li");m.dataset.articleId=u.id,m.innerHTML=`
      <span>
        <strong>${lt(u.title)}</strong>
      </span>
      <div class="row-actions">
        <button class="ghost restore-btn" data-id="${u.id}">\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C</button>
        <button class="ghost danger delete-btn" data-id="${u.id}">\u0423\u0434\u0430\u043B\u0438\u0442\u044C</button>
      </div>
    `;let g=m.querySelector(".restore-btn"),w=m.querySelector(".delete-btn");g&&g.addEventListener("click",async y=>{y.preventDefault(),y.stopPropagation(),await Bh(u.id)}),w&&w.addEventListener("click",async y=>{y.preventDefault(),y.stopPropagation(),await Lh(u.id)}),p.articleList.appendChild(m)});return}let c=n.slice().filter(u=>(t?(u.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(t):!0)&&u.id!=="inbox"),l=lu(c),d=(u,m)=>{let g=document.createElement("li");s.has(u.id)&&(g.classList.add("has-children"),o.has(u.id)&&g.classList.add("is-collapsed")),g.dataset.articleId=u.id;let w=r.has(u.id),y=lt(u.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),f=u.publicSlug?'<span class="article-public-icon">&#xE774;</span>':"";g.style.paddingLeft=`${m*1.25}rem`,g.innerHTML=`
      <span>
        <strong>${f}${y}</strong>
      </span>
      <button class="ghost star-btn ${w?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${w?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}">${w?"\uE735":"\uE734"}</button>
    `;let h=g.querySelector(".star-btn");h&&h.addEventListener("click",b=>{b.preventDefault(),b.stopPropagation(),oo(u.id)}),u.id===i&&g.classList.add("active-article"),g.addEventListener("click",()=>{if(window.__ttreeDraggingArticleId)return;a.listSelectedArticleId=u.id,a.listCollapsedArticleIds||(a.listCollapsedArticleIds=[]);let b=new Set(a.listCollapsedArticleIds);b.has(u.id)?b.delete(u.id):b.add(u.id),a.listCollapsedArticleIds=Array.from(b),Rr(),Gt()}),g.addEventListener("dblclick",b=>{b.preventDefault(),b.stopPropagation(),a.listSelectedArticleId=u.id,bt(pt.article(u.id))}),p.articleList.appendChild(g),a.isTrashView||(Va(g),Ua(g,u.id)),o.has(u.id)||(u.children||[]).forEach(b=>d(b,m+1))};l.forEach(u=>d(u,0))}async function Bh(e){if(e)try{let t=await pd(e);qo(e),On(t),await Ko(!1),bt(pt.article(t.id)),L("Page restored")}catch(t){L(t.message)}}async function Lh(e){if(e)try{await _i(e,{force:!0}),qo(e),L("\u0421\u0442\u0430\u0442\u044C\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u0431\u0435\u0437\u0432\u043E\u0437\u0432\u0440\u0430\u0442\u043D\u043E"),Gt(),kt()}catch(t){L(t.message)}}async function Ko(e){a.isTrashView=e,_a(),e?await Qi():await ar(),kt(),Gt()}async function ar(){if(a.articlesIndex.length)return a.isTrashView||kt(),a.articlesIndex;let e=await In();return Yi(e),e}async function Qi(){if(a.deletedArticlesIndex.length)return a.isTrashView&&kt(),a.deletedArticlesIndex;let e=await rd();return au(e),e}var iu,Zi=Fe(()=>{mt();Mt();vn();En();Ft();Nt();Ji();ro();qa();iu="ttree_favorites"});function fu(){try{let t=(window.localStorage.getItem(du)||""||"").trim().toLowerCase();(t==="recent"||t==="tree")&&(a.sidebarArticlesMode=t)}catch{}try{let e=window.localStorage.getItem(uu)||"[]",t=JSON.parse(e);Array.isArray(t)&&(a.recentArticleIds=t.filter(n=>typeof n=="string"&&n&&n!=="inbox").slice(0,Ja))}catch{}}function Mh(){try{window.localStorage.setItem(du,a.sidebarArticlesMode||"tree")}catch{}}function Nh(){try{let e=Array.isArray(a.recentArticleIds)?a.recentArticleIds:[];window.localStorage.setItem(uu,JSON.stringify(e.slice(0,Ja)))}catch{}}function ja(){let e=a.sidebarArticlesMode,t=a.sidebarArticlesMode==="recent"?"tree":"recent";a.sidebarArticlesMode=t,Mh(),e==="recent"&&t==="tree"&&ir(),kt(),e==="recent"&&t==="tree"&&window.requestAnimationFrame(()=>{try{Gi()}catch{}})}function es(e){if(!e||e==="inbox"||a.isPublicView)return;let t=Array.isArray(a.recentArticleIds)?a.recentArticleIds:[],n=[e,...t.filter(r=>r!==e)];a.recentArticleIds=n.slice(0,Ja),Nh(),a.sidebarArticlesMode==="recent"&&kt()}var du,uu,Ja,Wa=Fe(()=>{mt();Zi();ro();du="ttree_sidebar_articles_mode",uu="ttree_recent_articles",Ja=300});function pu(){jd(),Yd(),Xd(),fu(),p.sidebar&&Hr(!!a.isSidebarCollapsed)}var cn=Fe(()=>{Mt();mt();Wa();ro();Ji();qa();Zi();ro();Wa();Ji();Zi();tu({renderSidebarArticleList:kt,renderMainArticleList:Gt,setArticlesIndex:Yi})});function ts(e){a.articleId&&(a.articleEncryptionKeys||(a.articleEncryptionKeys={}),e?a.articleEncryptionKeys[a.articleId]=e:delete a.articleEncryptionKeys[a.articleId])}async function hu(e){if(!e||!e.encrypted)return e;let t=a.articleEncryptionKeys?.[e.id]||null;if(t)return await Da(e,t),e;let n=0;for(;;){n+=1;let r=null;try{let o=e.encryptionHint||"",i="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C \u0434\u043B\u044F \u044D\u0442\u043E\u0439 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B.",s=o?`${i}
\u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0430: ${o}`:i;r=await on({title:"\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430",message:s,confirmText:"\u041E\u0442\u043A\u0440\u044B\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"\u041F\u0430\u0440\u043E\u043B\u044C",inputType:"password"})}catch{r=window.prompt("\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430. \u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C:")||""}if(!r)throw new Error("\u041F\u0430\u0440\u043E\u043B\u044C \u043D\u0435 \u0432\u0432\u0435\u0434\u0451\u043D");try{let{key:o}=await Vi(r,e.encryptionSalt||"");if(!await Od(o,e.encryptionVerifier||"")){if(n>=3)throw new Error("\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C");window.alert("\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C, \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437.");continue}return await Da(e,o),ts(o),e}catch(o){if(n>=3)throw new Error(o.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");window.alert("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443, \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437.")}}}async function mu(e,t){if(!e||!Array.isArray(e.blocks))return;let n=[...e.blocks];for(let r of n){let o=Array.isArray(r.children)?r.children:[];n.push(...o);let i=r.text||"",s=await qi(t,i);await Pe(`/api/articles/${e.id}/blocks/${r.id}`,{method:"PATCH",body:JSON.stringify({text:s})})}}async function ns(){if(!a.article||!a.articleId){L("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}if(a.articleId==="inbox"){L("\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438 \u043D\u0435\u043B\u044C\u0437\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C");return}if(!a.currentUser){L("\u041D\u0443\u0436\u043D\u043E \u0432\u043E\u0439\u0442\u0438 \u0432 \u0441\u0438\u0441\u0442\u0435\u043C\u0443");return}let e=a.article;if(e.encrypted){let o=null;try{o=await zi({title:"\u0421\u043C\u0435\u043D\u0438\u0442\u044C \u043F\u0430\u0440\u043E\u043B\u044C",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043D\u043E\u0432\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C \u0438 \u043F\u0440\u0438 \u0436\u0435\u043B\u0430\u043D\u0438\u0438 \u043F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0443.",confirmText:"\u041F\u0435\u0440\u0435\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"})}catch{o=null}if(!o||!o.password)return;let{password:i,hint:s}=o;try{let{key:c,salt:l}=await Vi(i,""),d=await Pa(c);L("\u041F\u0435\u0440\u0435\u0448\u0438\u0444\u0440\u043E\u0432\u044B\u0432\u0430\u0435\u043C \u0441\u043E\u0434\u0435\u0440\u0436\u0438\u043C\u043E\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B..."),await mu(e,c);let u=await Pe(`/api/articles/${a.articleId}`,{method:"PATCH",body:JSON.stringify({encrypted:!0,encryptionSalt:l,encryptionVerifier:d,encryptionHint:s||null})});e.encrypted=!0,e.encryptionSalt=l,e.encryptionVerifier=d,e.encryptionHint=s||null,e.updatedAt=u?.updatedAt||e.updatedAt,ts(c),On(u),An(),L("\u041F\u0430\u0440\u043E\u043B\u044C \u043E\u0431\u043D\u043E\u0432\u043B\u0451\u043D"),Pt("toggleArticleEncryption: password changed",{id:e.id,encrypted:e.encrypted,hasSalt:!!e.encryptionSalt,hasVerifier:!!e.encryptionVerifier})}catch(c){L(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443")}return}let t=null;try{t=await zi({title:"\u0417\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C \u0438 \u043F\u0440\u0438 \u0436\u0435\u043B\u0430\u043D\u0438\u0438 \u043F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0443.",confirmText:"\u0417\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"})}catch{t=null}if(!t||!t.password)return;let{password:n,hint:r}=t;try{let{key:o,salt:i}=await Vi(n,""),s=await Pa(o);L("\u0428\u0438\u0444\u0440\u0443\u0435\u043C \u0441\u043E\u0434\u0435\u0440\u0436\u0438\u043C\u043E\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B..."),await mu(e,o);let c=await Pe(`/api/articles/${a.articleId}`,{method:"PATCH",body:JSON.stringify({encrypted:!0,encryptionSalt:i,encryptionVerifier:s,encryptionHint:r||null})});e.encrypted=!0,e.encryptionSalt=i,e.encryptionVerifier=s,e.encryptionHint=r||null,e.updatedAt=c?.updatedAt||e.updatedAt,ts(o),On(c),An(),L("\u0428\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0432\u043A\u043B\u044E\u0447\u0435\u043D\u043E"),Pt("toggleArticleEncryption: enabled",{id:e.id,encrypted:e.encrypted,hasSalt:!!e.encryptionSalt,hasVerifier:!!e.encryptionVerifier})}catch(o){L(o.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0438\u0435")}}async function rs(){if(!a.article||!a.articleId){L("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}if(a.articleId==="inbox"){L("\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438 \u043D\u0435\u043B\u044C\u0437\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C/\u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C");return}let e=a.article;if(!e.encrypted){L("\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0443\u0436\u0435 \u043D\u0435 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430");return}let t=!1;try{t=await Un({title:"\u0421\u043D\u044F\u0442\u044C \u0437\u0430\u0449\u0438\u0442\u0443?",message:"\u0421\u043E\u0434\u0435\u0440\u0436\u0438\u043C\u043E\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B \u0431\u0443\u0434\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u0432 \u043E\u0442\u043A\u0440\u044B\u0442\u043E\u043C \u0432\u0438\u0434\u0435.",confirmText:"\u0421\u043D\u044F\u0442\u044C \u0437\u0430\u0449\u0438\u0442\u0443",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"})}catch{t=window.confirm("\u0421\u043D\u044F\u0442\u044C \u0437\u0430\u0449\u0438\u0442\u0443 \u0438 \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0432 \u043E\u0442\u043A\u0440\u044B\u0442\u043E\u043C \u0432\u0438\u0434\u0435?")}if(t)try{if(L("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0432 \u043E\u0442\u043A\u0440\u044B\u0442\u043E\u043C \u0432\u0438\u0434\u0435..."),Array.isArray(e.blocks)){let r=[...e.blocks];for(let o of r){let i=Array.isArray(o.children)?o.children:[];r.push(...i);let s=o.text||"";await Pe(`/api/articles/${e.id}/blocks/${o.id}`,{method:"PATCH",body:JSON.stringify({text:s})})}}let n=await Pe(`/api/articles/${a.articleId}`,{method:"PATCH",body:JSON.stringify({encrypted:!1,encryptionSalt:null,encryptionVerifier:null})});e.encrypted=!1,e.encryptionSalt=null,e.encryptionVerifier=null,e.encryptionHint=null,e.updatedAt=n?.updatedAt||e.updatedAt,ts(null),On(n),An(),L("\u0428\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B \u043E\u0442\u043A\u043B\u044E\u0447\u0435\u043D\u043E"),Pt("removeArticleEncryption: disabled",{id:e.id,encrypted:e.encrypted})}catch(n){L(n.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0438\u0435")}}var Ya=Fe(()=>{mt();Ft();Nt();Vn();vn();$o();cn();Eo()});function bu(e=""){return e.split(/\r?\n/).some(t=>/^(\s*)-\s+/.test(t))}function yu(e=""){if(!e)return"";let t=[],n=0,r=e.replace(/\[\[block\s+id=([a-zA-Z0-9_-]+)\]\]([\s\S]*?)\[\[\/block\]\]/gi,(i,s,c)=>{let l=`__INLINE_BLOCK_${n}__`;return t.push({token:l,html:`<span class="inline-fragment" data-inline-block-id="${lt(s.trim())}">${lt((c||"").trim())}</span>`}),n+=1,l}),o=lt(r);return t.forEach(({token:i,html:s})=>{let c=new RegExp(Hi(i),"g");o=o.replace(c,s)}),o}function Dh(e=""){if(!e||!e.trim())return"";let t=e.replace(/\r/g,""),n=t.split(/\n{2,}/).map(r=>r.trim()).filter(Boolean);return n.length?n.map(r=>`<div>${yu(r).replace(/\n/g,"<br />")}</div>`).join(""):`<div>${yu(t.trim()).replace(/\n/g,"<br />")}</div>`}function _h(e=[]){let t={title:"",content:"",comments:[],attributes:[]},n="content";e.forEach(o=>{let i=o.replace(/^\s+/,"");if(!i)return;let s=i.match(/^([A-Za-z--]+)\s*:(.*)$/);if(s){let c=s[1].toLowerCase();if(gu[c]){n=gu[c];let l=s[2]?.trim()||"";l&&(n==="comments"?t.comments.push(l.replace(/^[-*+]\s*/,"")):n==="attributes"?t.attributes.push(l):n==="title"?t.title=l:t.content=t.content?`${t.content}
${l}`:l);return}}n==="comments"?t.comments.push(i.replace(/^[-*+]\s*/,"")):n==="attributes"?t.attributes.push(i):n==="title"?t.title=t.title?`${t.title}
${i}`:i:t.content=t.content?`${t.content}
${i}`:i});let r={};return t.attributes.forEach(o=>{let i=o.match(/^\s*(?:[-*+]\s*)?([^:=]+):=$/);if(i){let s=i[1].trim(),c=i[2].trim();s&&(r[s]=c)}}),{title:t.title.trim(),content:t.content.trim(),comments:t.comments.filter(Boolean),attributes:r}}function wu(e=""){let t=e.replace(/\t/g,"  ").split(/\r?\n/),n={level:-1,children:[]},r=[n];t.forEach(i=>{if(!i.trim())return;let s=i.match(/^(\s*)-\s+(.*)$/);if(s){let l=s[1].length,d=Math.floor(l/Ph);for(;r.length&&r[r.length-1].level>=d;)r.pop();let u=r[r.length-1],m=u.block?u.block.children:u.children,g={title:s[2].trim(),detailLines:[],children:[]};m.push(g),r.push({level:d,block:g,children:g.children});return}let c=r[r.length-1];c?.block&&c.block.detailLines.push(i)});let o=i=>{let s=_h(i.detailLines||[]);return{title:s.title||i.title,content:s.content,comments:s.comments,attributes:s.attributes,children:(i.children||[]).map(c=>o(c))}};return n.children.map(i=>o(i))}function Oh(e=[]){return e?.length?`<div class="block-section block-section--comments"><strong>\u041A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0438:</strong><ul>${e.map(n=>`<li>${lt(n)}</li>`).join("")}</ul></div>`:""}function Rh(e={}){let t=Object.entries(e||{});return t.length?`<div class="block-section block-section--attributes"><strong>\u0410\u0442\u0440\u0438\u0431\u0443\u0442\u044B:</strong><ul>${t.map(([r,o])=>`<li><strong>${lt(r)}:</strong> ${lt(o)}</li>`).join("")}</ul></div>`:""}function Xa(e){if(!e)return null;let t=e.title?.trim()||"\u041D\u043E\u0432\u044B\u0439 \u0431\u043B\u043E\u043A",n=Dh(e.content),r=Oh(e.comments),o=Rh(e.attributes),i=[n,r,o].filter(Boolean).join(""),s=i?`${t}<div><br /></div>${i}`:t;return{text:Ga(s),collapsed:!1,children:(e.children||[]).map(c=>Xa(c)).filter(Boolean)}}var Ph,gu,Su=Fe(()=>{vn();ln();Ph=2,gu={\u043D\u0430\u0438\u043C\u0435\u043D\u043E\u0432\u0430\u043D\u0438\u0435:"title",\u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435:"title",\u0441\u043E\u0434\u0435\u0440\u0436\u0438\u043C\u043E\u0435:"content",\u0442\u0435\u043A\u0441\u0442:"content",\u043A\u043E\u043C\u043C\u0435\u043D\u0442\u0430\u0440\u0438\u0438:"comments",\u0430\u0442\u0440\u0438\u0431\u0443\u0442\u044B:"attributes"}});function Hh(e){if(!e)return;e.focus({preventScroll:!0});let t=window.getSelection&&window.getSelection();if(!t)return;t.removeAllRanges();let n=document.createRange();n.selectNodeContents(e),n.collapse(!1),t.addRange(n)}function xu(e,t="\u0412\u0441\u0442\u0430\u0432\u043B\u044F\u0435\u043C Markdown..."){a.isMarkdownInserting=e;let n=p.pasteProgress;if(!n)return;let r=n.querySelector(".inline-progress__text");r&&t&&(r.textContent=t),n.classList.toggle("hidden",!e)}async function Qa(e){return!a.article||!a.article.encrypted||!a.articleEncryptionKey?e:qi(a.articleEncryptionKey,e)}async function $h(e){if(!a.article||!a.article.encrypted||!a.articleEncryptionKey||!e)return e;let t=JSON.parse(JSON.stringify(e));return await Ho(t,a.articleEncryptionKey),t}async function os(){if(!a.currentBlockId||a.isRagView)return;let e=a.currentBlockId;a.editingScrollTop=p.blocksContainer?p.blocksContainer.scrollTop:null,a.mode="edit",a.scrollTargetBlockId=null,a.editingBlockId=a.currentBlockId,a.editingInitialText=Je(a.currentBlockId)?.block.text||"",a.editingUndo=null,await xt(e);let t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`);if(t||(ot(),await xt(e),t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`)),!t){a.mode="view",a.editingBlockId=null,a.editingInitialText="",a.editingUndo=null,a.currentBlockId=e,L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430");return}Hh(t)}async function Jo(){if(a.mode!=="edit"||!a.editingBlockId)return;let e=a.editingBlockId,t=Je(e),n=t?.block.text||"",o=document.querySelector(`.block[data-block-id="${a.editingBlockId}"] .block-text`)?.innerHTML||"",{cleanupEditableHtml:i}=await Promise.resolve().then(()=>(ln(),Za)),s=i(o);if(!(s||"").trim()){let l=jo(e),d=Je(e),u=!!(d?.block&&d.block.__isNew);if(d&&a.article&&Array.isArray(a.article.blocks)){let m=d.siblings||a.article.blocks,g=d.index??m.findIndex(w=>w&&w.id===e);if(g>=0&&m.splice(g,1),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}if(!u){let w=cr(d.block);Wo(w,d.parent?.id||null,d.index??null)}}a.mode="view",a.editingBlockId=null,a.editingInitialText="",a.currentBlockId=l,a.scrollTargetBlockId=l,ao(e),ot(),(async()=>{try{let m=u?`/api/articles/${a.articleId}/blocks/${e}/permanent`:`/api/articles/${a.articleId}/blocks/${e}`,g=await Pe(m,{method:"DELETE"});if(!u&&g?.block){let w=cr(g.block);dn({type:"structure",action:{kind:"delete",parentId:g.parentId||null,index:g.index??null,block:w,blockId:w?.id,fallbackId:l}})}L("\u041F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A \u0443\u0434\u0430\u043B\u0451\u043D")}catch(m){L(m.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Jt(a.articleId,{desiredBlockId:l||null}),ot()}catch{}}})();return}if(s===n){a.mode="view",a.editingBlockId=null,a.editingInitialText="",a.editingUndo=null,a.pendingEditBlockId=null,a.currentBlockId=e,a.scrollTargetBlockId=e,await xt(e);return}if(t&&a.article&&Array.isArray(a.article.blocks)&&(t.block.text=s,a.article.updatedAt))try{a.article.updatedAt=new Date().toISOString()}catch{}a.mode="view",a.editingBlockId=null,a.editingInitialText="",a.editingUndo=null,a.pendingEditBlockId=null,a.currentBlockId=e,a.scrollTargetBlockId=e,await xt(e),(async()=>{try{let l=await Qa(s),d=await Pe(`/api/articles/${a.articleId}/blocks/${e}`,{method:"PATCH",body:JSON.stringify({text:l})});n!==s&&(!!(t?.block&&t.block.__isNew)?delete t.block.__isNew:dn({type:"text",blockId:e,historyEntryId:d?.historyEntryId||null})),L("\u0411\u043B\u043E\u043A \u043E\u0431\u043D\u043E\u0432\u043B\u0451\u043D")}catch(l){L(l.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Jt(a.articleId,{desiredBlockId:e}),ot()}catch{}}})()}async function is(){if(a.mode!=="edit"||!a.editingBlockId)return;let e=a.editingBlockId,r=!(document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`)?.textContent||"").replace(/\u00a0/g," ").trim();if(a.mode="view",a.editingBlockId=null,a.editingInitialText="",a.editingUndo=null,r){let o=jo(e),i=Je(e),s=!!(i?.block&&i.block.__isNew);if(i&&a.article&&Array.isArray(a.article.blocks)){let l=i.siblings||a.article.blocks,d=i.index??l.findIndex(u=>u&&u.id===e);if(d>=0&&l.splice(d,1),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}a.currentBlockId=o,a.scrollTargetBlockId=o,ao(e);let c=i?.parent?.id||null;c?await xt(c):ot(),(async()=>{try{let l=s?`/api/articles/${a.articleId}/blocks/${e}/permanent`:`/api/articles/${a.articleId}/blocks/${e}`,d=await Pe(l,{method:"DELETE"});if(!s&&d?.block){let u=cr(d.block);dn({type:"structure",action:{kind:"delete",parentId:d.parentId||null,index:d.index??null,block:u,blockId:u?.id,fallbackId:o}})}}catch(l){L(l.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Jt(a.articleId,{desiredBlockId:o||null}),ot()}catch{}}})();return}a.currentBlockId=e,await xt(e)}async function io(){if(a.mode!=="edit"||!a.editingBlockId)return;let e=a.editingBlockId,t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`);if(!t)return;let n=window.getSelection();if(!n||n.rangeCount===0||!t.contains(n.anchorNode))return;let r=n.getRangeAt(0).cloneRange(),o=document.createElement("span"),i=`split-marker-${Date.now()}-${Math.random().toString(16).slice(2)}`;o.setAttribute("data-split-marker",i),o.textContent="",r.insertNode(o);let s=t.innerHTML;o.parentNode.removeChild(o);let c=`<span data-split-marker="${i}"></span>`,l=s.split(c);if(l.length!==2)return;let[d,u]=l,{cleanupEditableHtml:m}=await Promise.resolve().then(()=>(ln(),Za)),g=m(d||""),w=m(u||"");if(!(!w||w===g))try{let y=Je(e),f=y?.block,h=f?cr(f):null,b=await Qa(g);await Pe(`/api/articles/${a.articleId}/blocks/${e}`,{method:"PATCH",body:JSON.stringify({text:b})});let x=(await Pe(`/api/articles/${a.articleId}/blocks/${e}/siblings`,{method:"POST",body:JSON.stringify({direction:"after"})}))?.block?.id;if(!x){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043D\u043E\u0432\u044B\u0439 \u0431\u043B\u043E\u043A");return}let v=await Qa(w);if(await Pe(`/api/articles/${a.articleId}/blocks/${x}`,{method:"PATCH",body:JSON.stringify({text:v})}),y&&a.article&&Array.isArray(a.article.blocks)){y.block.text=g;let N=y.parent,z=y.siblings||a.article.blocks||[],P=(y.index??0)+1,W={id:x,text:w,children:[],collapsed:!1};if(z.splice(P,0,W),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}a.mode="edit",a.editingBlockId=x,a.pendingEditBlockId=null,a.currentBlockId=x,a.scrollTargetBlockId=x,a.editingCaretPosition="start";let B=y?.parent?.id||null;B?await xt(B):ot(),h&&dn({type:"text",blockId:e,block:h})}catch(y){L(y.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0437\u0431\u0438\u0442\u044C \u0431\u043B\u043E\u043A")}}async function Ar(e){if(!a.currentBlockId)return;if(!a.article||!Array.isArray(a.article.blocks)){L("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}let t=a.currentBlockId;try{let n=Je(t);if(!n){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u0442\u0435\u043A\u0443\u0449\u0438\u0439 \u0431\u043B\u043E\u043A");return}let r=n.parent?.id||null,o=n.siblings||a.article.blocks;Array.isArray(o)||(o=a.article.blocks);let i=typeof n.index=="number"?n.index:o.findIndex(d=>d&&d.id===t);i<0&&(i=o.length);let s=e==="before"?i:i+1,c=window.crypto&&window.crypto.randomUUID?window.crypto.randomUUID():`block-${Date.now().toString(16)}-${Math.random().toString(16).slice(2)}`,l={id:c,text:"",children:[],collapsed:!1,__isNew:!0};if(o.splice(s,0,l),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}a.mode="edit",a.editingBlockId=c,a.editingInitialText="",a.pendingEditBlockId=null,a.currentBlockId=c,r?await xt(r):ot(),(async()=>{try{let d={id:c,text:"",children:[],collapsed:!1},u=await Pe(`/api/articles/${a.articleId}/blocks/${t}/siblings`,{method:"POST",body:JSON.stringify({direction:e,payload:d})}),m=u?.block;if(!m||!m.id)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043D\u043E\u0432\u044B\u0439 \u0431\u043B\u043E\u043A");let g=cr(m);dn({type:"structure",action:{kind:"create",parentId:u.parentId||r||null,index:typeof u.index=="number"?u.index:null,blockId:m.id,block:g,fallbackId:t}})}catch(d){L(d.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043D\u043E\u0432\u044B\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Jt(a.articleId,{desiredBlockId:t}),ot()}catch{}}})()}catch(n){L(n.message)}}async function ss(){if(!a.currentBlockId)return;if(as(a.article?.blocks||[])<=1){L("\u041D\u0435\u043B\u044C\u0437\u044F \u0443\u0434\u0430\u043B\u044F\u0442\u044C \u043F\u043E\u0441\u043B\u0435\u0434\u043D\u0438\u0439 \u0431\u043B\u043E\u043A");return}if(a.isDeletingBlock)return;a.isDeletingBlock=!0;let e=jo(a.currentBlockId);try{let t=a.currentBlockId,n=Je(t),r=n?.block?cr(n.block):null,o=await Pe(`/api/articles/${a.articleId}/blocks/${a.currentBlockId}`,{method:"DELETE"});if(n&&a.article&&Array.isArray(a.article.blocks)){let s=n.siblings||a.article.blocks,c=n.index??s.findIndex(l=>l.id===t);if(c>=0&&s.splice(c,1),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}r&&r.id&&Wo(r,n.parent?.id||null,n.index??c)}ao(t),a.currentBlockId=e,a.scrollTargetBlockId=e;let i=n?.parent?.id||null;i?await xt(i):ot(),r&&r.id&&dn({type:"structure",action:{kind:"delete",parentId:n?.parent?.id||null,index:n?.index??null,block:r,blockId:r.id,fallbackId:e}})}catch(t){L(t.message)}finally{a.isDeletingBlock=!1}}async function Fh(e=[]){if(!e.length){L("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u043B\u044F\u0442\u044C \u043F\u0443\u0441\u0442\u044B\u0435 \u0431\u043B\u043E\u043A\u0438 \u0438\u0437 Markdown");return}if(!a.articleId){L("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u043B\u044F\u0442\u044C \u0431\u043B\u043E\u043A\u0438 \u0431\u0435\u0437 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0439 \u0441\u0442\u0430\u0442\u044C\u0438");return}if(!a.currentBlockId){L("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u043B\u044F\u0442\u044C \u0431\u043B\u043E\u043A\u0438 \u0431\u0435\u0437 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u0431\u043B\u043E\u043A\u0430");return}if(a.isMarkdownInserting){L("\u0418\u0434\u0451\u0442 \u0432\u0441\u0442\u0430\u0432\u043A\u0430 Markdown, \u043F\u043E\u0436\u0430\u043B\u0443\u0439\u0441\u0442\u0430, \u043F\u043E\u0434\u043E\u0436\u0434\u0438\u0442\u0435...");return}xu(!0);try{let t=a.currentBlockId,n=null,r=null;for(let o of e){let i=Xa(o);if(!i)continue;let s=await $h(i),c=await Pe(`/api/articles/${a.articleId}/blocks/${t}/siblings`,{method:"POST",body:JSON.stringify({direction:"after",payload:s})}),l=c?.block;if(l&&l.id&&(t=l.id,n=l.id,r=c.parentId||null,a.article&&Array.isArray(a.article.blocks))){let d=null;if(r){let y=Je(r)?.block||null;y&&(Array.isArray(y.children)||(y.children=[]),d=y.children)}else d=a.article.blocks;Array.isArray(d)||(d=a.article.blocks);let u=typeof c.index=="number"?c.index:null,m=u!==null&&u>=0&&u<=d.length?u:d.length,g=cr(l)||l;if(d.splice(m,0,g),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}}if(!n){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0434\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u043D\u0438 \u043E\u0434\u043D\u043E\u0433\u043E \u0431\u043B\u043E\u043A\u0430");return}a.currentBlockId=n,a.scrollTargetBlockId=n,r?await xt(r):ot(),L("\u0411\u043B\u043E\u043A\u0438 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u044B \u0438\u0437 Markdown")}finally{xu(!1)}}function ku(e){if(a.mode!=="view")return;let t=e.target;if(Cd(t))return;let n=e.clipboardData?.getData("text/plain");if(!n||!bu(n))return;e.preventDefault();let r=wu(n);Fh(r).catch(o=>{L(o.message)})}var so=Fe(()=>{mt();Ft();Mt();Nt();Qn();Qn();Kn();ln();Su();vn();$o()});function Sn(e=[],t=[]){return(e||[]).forEach(n=>{t.push(n),n.children&&n.children.length>0&&!n.collapsed&&Sn(n.children,t)}),t}function Je(e,t=a.article?.blocks||[],n=null,r=[]){for(let o=0;o<t.length;o+=1){let i=t[o];if(i.id===e)return{block:i,parent:n,index:o,siblings:t,ancestors:r};let s=Je(e,i.children||[],i,[...r,i]);if(s)return s}return null}function Yo({scrollIntoView:e=!1,scrollBehavior:t="smooth"}={}){let n=new Set(Array.isArray(a.selectedBlockIds)?a.selectedBlockIds:[]);if(a.currentBlockId&&n.add(a.currentBlockId),document.querySelectorAll(".block[data-block-id]").forEach(o=>{let i=o.getAttribute("data-block-id"),s=i&&n.has(i);o.classList.toggle("selected",!!s),o.classList.remove("block--selected-root-ancestor");let c=o.querySelector(":scope > .block-surface");c&&c.classList.remove("block--selected-root-ancestor")}),a.currentBlockId&&a.article&&Array.isArray(a.article.blocks)){let o=Je(a.currentBlockId),i=o?.ancestors||[],s=i.length>0?i[0]?.id:o?.block?.id;if(s){let c=document.querySelector(`.block[data-block-id="${s}"]`);if(c){let l=c.querySelector(":scope > .block-surface");l&&l.classList.add("block--selected-root-ancestor")}}}if(e&&a.mode==="view"&&a.currentBlockId){let o=document.querySelector(`.block[data-block-id="${a.currentBlockId}"]`);o&&o.scrollIntoView({behavior:t||"smooth",block:"nearest"})}}function Au(e,t={}){if(!e||a.currentBlockId===e)return;let{preserveSelection:n=!1,scrollIntoView:r,scrollBehavior:o}=t;a.currentBlockId=e,n||(a.selectionAnchorBlockId=null,a.selectedBlockIds=[]);let i=typeof r=="boolean"?r:a.mode==="view";Yo({scrollIntoView:i,scrollBehavior:o||"smooth"})}function Tn(e,t={}){Au(e,{preserveSelection:!1,...t})}function Xo(e){if(!a.article)return;let t=Sn(a.article.blocks),n=t.findIndex(o=>o.id===a.currentBlockId);if(n===-1)return;let r=t[n+e];r&&(a.mode==="view"&&(a.scrollTargetBlockId=r.id),Au(r.id,{preserveSelection:!1}))}function Go(e){if(!a.article)return;let t=Sn(a.article.blocks);if(!t.length)return;let n=a.selectionAnchorBlockId||a.currentBlockId||t[0].id;n||(n=t[0].id),a.selectionAnchorBlockId||(a.selectionAnchorBlockId=n);let r=t.findIndex(u=>u.id===n);if(r===-1)return;let o=a.currentBlockId||n,i=t.findIndex(u=>u.id===o);i===-1&&(i=r);let s=i+e;if(s<0||s>=t.length)return;let[c,l]=s>=r?[r,s]:[s,r],d=t.slice(c,l+1).map(u=>u.id);a.selectedBlockIds=d,a.currentBlockId=t[s].id,a.mode==="view"&&(a.scrollTargetBlockId=a.currentBlockId),Yo({scrollIntoView:a.mode==="view"})}var Iu=Fe(()=>{mt();Mt()});function Ir(e){return e?e.nodeType===Node.TEXT_NODE?/\n\s*\n/.test(e.textContent||""):e.nodeType===Node.ELEMENT_NODE&&(e.tagName==="BR"||(e.tagName==="P"||e.tagName==="DIV")&&(!(e.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&(nbsp|#160);/gi,"").trim()||!(e.textContent||"").replace(/\u00a0/g,"").trim()&&!e.querySelector("img"))):!1}function cs(e=[]){let t=document.createElement("div");return e.forEach(n=>t.appendChild(n)),t.innerHTML.trim()}function ec(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=[],r=(i="")=>{let s=document.createElement("p");i?s.innerHTML=i:s.appendChild(document.createElement("br")),n.push(s)};Array.from(t.content.childNodes).forEach(i=>{if(i.nodeType===Node.TEXT_NODE){let s=(i.textContent||"").trim();s&&r(s);return}if(i.nodeType===Node.ELEMENT_NODE){if(i.tagName==="P"){n.push(i.cloneNode(!0));return}if(i.tagName==="BR"){r("");return}if(i.tagName==="DIV"){r(i.innerHTML);return}r(i.outerHTML)}}),n.length||r("");let o=document.createElement("div");return n.forEach(i=>o.appendChild(i)),o.innerHTML}function Cn(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll(".block-header").forEach(m=>{let g=m.parentNode;if(g){for(;m.firstChild;)g.insertBefore(m.firstChild,m);g.removeChild(m)}});let n=Array.from(t.content.childNodes),r=m=>m?.nodeType===Node.TEXT_NODE&&!(m.textContent||"").trim(),o=0;for(;o<n.length&&r(n[o]);)o+=1;let i=n[o];if(!i||i.nodeType!==Node.ELEMENT_NODE||i.tagName!=="P"||Ir(i))return{titleHtml:"",bodyHtml:cs(n)};let s=o+1;for(;s<n.length&&r(n[s]);)s+=1;let c=n[s];if(!(!!c&&Ir(c)&&(c.nodeType===Node.ELEMENT_NODE?c.tagName==="P"||c.tagName==="DIV"||c.tagName==="BR":!1)))return{titleHtml:"",bodyHtml:cs(n)};let d=[i.cloneNode(!0)],u=[];for(let m=s+1;m<n.length;m+=1)u.push(n[m].cloneNode(!0));return{titleHtml:cs(d),bodyHtml:cs(u)}}function vu({event:e,element:t,range:n,selection:r,notifyEditingInput:o,logDebug:i}){if(!e||!t||!n||!r||!n.collapsed)return!1;let s=e.key==="Backspace"||e.code==="Backspace"||e.keyCode===8,c=e.key==="Delete"||e.key==="Del"||e.code==="Delete"||e.code==="Del"||e.keyCode===46;if(!s&&!c)return!1;let l=h=>{try{r.removeAllRanges(),r.addRange(h)}catch{}try{t.focus({preventScroll:!0})}catch{t.focus()}},d=h=>{let S=(n.commonAncestorContainer?.nodeType===Node.ELEMENT_NODE?n.commonAncestorContainer:n.commonAncestorContainer?.parentElement)?.closest?.("p");if(S)return S;let x=t,v=Array.from(x.childNodes),B=n.startContainer;for(;B&&B.parentNode!==x;)B=B.parentNode;let N=B?v.indexOf(B):-1,z=P=>{let W=P==="prev"?-1:1,q=N;for(q===-1?q=P==="prev"?v.length-1:0:q=P==="prev"?q-1:q;q>=0&&q<v.length;){let ee=v[q];if(ee?.nodeType===Node.ELEMENT_NODE&&ee.tagName==="P")return ee;q+=W}return null};return h==="Delete"?z("next")||z("prev"):h==="Backspace"?z("prev")||z("next"):null},u=()=>{if(n.startContainer!==t)return{prev:null,next:null};let h=Array.from(t.childNodes),b=n.startOffset,S=null,x=null;for(let v=b-1;v>=0;v-=1){let B=h[v];if(B?.nodeType===Node.ELEMENT_NODE&&B.tagName==="P"){S=B;break}}for(let v=b;v<h.length;v+=1){let B=h[v];if(B?.nodeType===Node.ELEMENT_NODE&&B.tagName==="P"){x=B;break}}return{prev:S,next:x}},m=h=>{let b=h?.previousElementSibling;for(;b&&b.tagName!=="P";)b=b.previousElementSibling;return b&&b.tagName==="P"?b:null},g=h=>{let b=h?.nextElementSibling;for(;b&&b.tagName!=="P";)b=b.nextElementSibling;return b&&b.tagName==="P"?b:null},w=h=>{if(!h)return!0;let b=new Set(["span","b","strong","i","em","u","s","mark","code"]),S=new Set(["img","video","audio","iframe"]),x=v=>{if(!v)return!1;if(v.nodeType===Node.TEXT_NODE)return(v.textContent||"").replace(/\u00a0/g,"").replace(/[\u200B-\u200D\uFEFF]/g,"").trim().length>0;if(v.nodeType!==Node.ELEMENT_NODE)return!1;let B=(v.tagName||"").toLowerCase();return B==="br"?!1:S.has(B)?!0:B==="span"&&(v.getAttribute("class")||"").includes("resizable-image__handle")?!1:b.has(B)?Array.from(v.childNodes||[]).some(x):!0};return!Array.from(h.childNodes||[]).some(x)},y=h=>{if(!h)return!1;let b=document.createRange();b.selectNodeContents(h);try{b.setEnd(n.startContainer,n.startOffset)}catch{return!1}if(w(b.cloneContents()))return!0;try{let S=document.createRange();return S.selectNodeContents(h),S.collapse(!0),n.compareBoundaryPoints(Range.START_TO_START,S)===0}catch{return!1}},f=h=>{if(!h)return!1;let b=document.createRange();b.selectNodeContents(h);try{b.setStart(n.startContainer,n.startOffset)}catch{return!1}if(w(b.cloneContents()))return!0;try{let S=document.createRange();return S.selectNodeContents(h),S.collapse(!1),n.compareBoundaryPoints(Range.END_TO_END,S)===0}catch{return!1}};if(window.__debugMergeP&&i("mergeP.keydown",{key:e.key,code:e.code,keyCode:e.keyCode,startContainer:n.startContainer?.nodeName,startOffset:n.startOffset,collapsed:n.collapsed}),s){if(n.startContainer===t){let x=u();if(x.prev&&x.next){e.preventDefault(),e.stopPropagation();let v=document.createRange();for(v.selectNodeContents(x.prev),v.collapse(!1);x.next.firstChild;)x.prev.appendChild(x.next.firstChild);return x.next.remove(),l(v),o(t),!0}return!1}let h=d("Backspace");if(!h||!t.contains(h)||!y(h))return!1;let b=m(h);if(!b||!t.contains(b))return!1;e.preventDefault(),e.stopPropagation();let S=document.createRange();for(S.selectNodeContents(b),S.collapse(!1);h.firstChild;)b.appendChild(h.firstChild);return h.remove(),l(S),o(t),!0}if(c){let h=d("Delete");if(!h||!t.contains(h)){let x=u();if(x.prev&&x.next){e.preventDefault(),e.stopPropagation();let v=document.createRange();for(v.selectNodeContents(x.prev),v.collapse(!1);x.next.firstChild;)x.prev.appendChild(x.next.firstChild);return x.next.remove(),l(v),o(t),!0}return!1}if(!f(h))return!1;let b=g(h);if(!b||!t.contains(b))return!1;e.preventDefault(),e.stopPropagation();let S=document.createRange();for(S.selectNodeContents(h),S.collapse(!1);b.firstChild;)h.appendChild(b.firstChild);return b.remove(),l(S),o(t),!0}return!1}var tc=Fe(()=>{});function Qo(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=r=>{if(r&&!(r.nodeType===Node.ELEMENT_NODE&&r.tagName==="A")){if(r.nodeType===Node.TEXT_NODE){let o=r.textContent||"";if(ls.lastIndex=0,!ls.test(o))return;let s=document.createDocumentFragment(),c=0;ls.lastIndex=0;let l;for(;(l=ls.exec(o))!==null;){let[d]=l;l.index>c&&s.appendChild(document.createTextNode(o.slice(c,l.index)));let u=d.startsWith("http")?d:`https://${d}`,m=document.createElement("a");m.href=u,m.target="_blank",m.rel="noopener noreferrer",m.textContent=d,s.appendChild(m),c=l.index+d.length}c<o.length&&s.appendChild(document.createTextNode(o.slice(c))),r.parentNode&&r.parentNode.replaceChild(s,r);return}Array.from(r.childNodes||[]).forEach(n)}};return Array.from(t.content.childNodes).forEach(n),t.innerHTML}function Eu(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll("script, style").forEach(o=>o.remove());let n=(o="")=>/^javascript:/i.test(o.trim()),r=o=>{if(!o||o.nodeType!==Node.ELEMENT_NODE){Array.from(o?.childNodes||[]).forEach(r);return}Array.from(o.attributes||[]).forEach(i=>{let s=i.name.toLowerCase(),c=i.value||"";if(s.startsWith("on")||s==="style"){o.removeAttribute(i.name);return}(s==="href"||s==="src")&&n(c)&&o.removeAttribute(i.name)}),Array.from(o.childNodes||[]).forEach(r)};return Array.from(t.content.childNodes||[]).forEach(r),t.innerHTML}function nc(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=r=>{if(!r)return!0;if(r.nodeType===Node.TEXT_NODE)return!(r.textContent||"").replace(/\u00a0/g,"").trim();if(r.nodeType!==Node.ELEMENT_NODE)return!1;if(r.tagName==="BR")return!0;let o=(r.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&nbsp;/gi,"").trim(),i=(r.textContent||"").replace(/\u00a0/g,"").trim(),s=!!r.querySelector("img,video,audio,iframe");return!o&&!i&&!s};for(;t.content.firstChild&&n(t.content.firstChild);)t.content.removeChild(t.content.firstChild);for(;t.content.lastChild&&n(t.content.lastChild);)t.content.removeChild(t.content.lastChild);return t.innerHTML}function Tu(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=(t.content.textContent||"").replace(/\u00a0/g," ").trim(),r=!!t.content.querySelector("a"),o=!1;{let y=Array.from(t.content.childNodes||[]);for(let f=0;f<y.length;f+=1){let h=y[f];if(h.nodeType===Node.TEXT_NODE){if(!(h.textContent||"").trim())continue;break}Ir(h)&&(o=!0);break}}let i=document.createElement("template");i.innerHTML=e||"";let c=(()=>{if(!Array.from(i.content.childNodes||[]).length)return!1;let f=Array.from(i.content.querySelectorAll("p"));if(f.length<2)return!1;let h=ne=>{let pe=ne.trim();return pe.startsWith("|")&&pe.indexOf("|",1)!==-1},S=f.map(ne=>(ne.textContent||"").replace(/\u00a0/g," ").trim()).filter(ne=>ne);if(S.length<2||!S.every(h))return!1;let x=S.map(ne=>{let pe=ne.trim();return(pe.endsWith("|")?pe.slice(1,-1):pe.slice(1)).split("|").map(gt=>gt.trim())}),v=x[0],B=x.slice(1),N=B.reduce((ne,pe)=>Math.max(ne,pe.length),v.length),z=document.createElement("table");z.className="memus-table";let P=document.createElement("colgroup"),W=100/Math.max(N,1);for(let ne=0;ne<N;ne+=1){let pe=document.createElement("col");pe.setAttribute("width",`${W.toFixed(4)}%`),P.appendChild(pe)}z.appendChild(P);let q=document.createElement("thead"),ee=document.createElement("tr");for(let ne=0;ne<N;ne+=1){let pe=document.createElement("th");pe.textContent=v[ne]||"",ee.appendChild(pe)}q.appendChild(ee),z.appendChild(q);let de=document.createElement("tbody");return B.forEach(ne=>{let pe=document.createElement("tr"),je=[...ne];for(let gt=0;gt<N;gt+=1){let Tt=document.createElement("td");Tt.textContent=je[gt]||"",pe.appendChild(Tt)}de.appendChild(pe)}),z.appendChild(de),i.content.innerHTML="",i.content.appendChild(z),Qo(i.innerHTML).replace(/<\/a>\s*<a/gi,"</a> <a")})();if(c)return c;i.content.querySelectorAll(".table-toolbar, .table-toolbar-btn").forEach(y=>{y.remove()}),i.content.querySelectorAll(".block-header").forEach(y=>{let f=y.parentNode;if(f){for(;y.firstChild;)f.insertBefore(y.firstChild,y);f.removeChild(y)}});let l=y=>{Array.from(y.childNodes).forEach(f=>{if(f.nodeType===Node.ELEMENT_NODE){if(f.tagName==="DIV"){let h=document.createElement("p");h.innerHTML=f.innerHTML,f.parentNode.replaceChild(h,f),l(h);return}l(f)}})};l(i.content),(y=>{Array.from(y.childNodes||[]).forEach(h=>{if(h.nodeType===Node.TEXT_NODE){let S=(h.textContent||"").replace(/\u00a0/g," ");if(!S.trim()){if(h.previousSibling&&h.nextSibling){h.textContent=" ";return}y.removeChild(h);return}let v=document.createElement("p");v.textContent=S,y.replaceChild(v,h)}})})(i.content),i.content.querySelectorAll("p").forEach(y=>{(y.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim()||(y.innerHTML="",y.appendChild(document.createElement("br")))});let u=i.content;if(!!u.querySelector("p")){if(o){let y=Array.from(u.childNodes||[]),f=null;for(let h=0;h<y.length;h+=1){let b=y[h];if(!(b.nodeType===Node.TEXT_NODE&&!(b.textContent||"").trim())){f=b;break}}if(f){if(!(f.tagName==="P"&&Ir(f))){let h=document.createElement("p");h.appendChild(document.createElement("br")),u.insertBefore(h,f)}}else{let h=document.createElement("p");h.appendChild(document.createElement("br")),u.appendChild(h)}}}else{let y=document.createElement("p");y.appendChild(document.createElement("br")),u.appendChild(y)}let w=Qo(i.innerHTML).replace(/<\/a>\s*<a/gi,"</a> <a");return!w.trim()&&(n||r)?e||"":w}var ls,Cu=Fe(()=>{tc();ls=/((?:https?:\/\/|www\.)[^\s<>"']+)/gi});function lr(e){if(!e)return;if(!(e.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&nbsp;/gi,"").trim()){e.innerHTML="";let n=document.createRange();n.selectNodeContents(e),n.collapse(!0);let r=window.getSelection();r&&(r.removeAllRanges(),r.addRange(n))}}var rc=Fe(()=>{});function $r(e){if(!e)return!1;if(e.type&&e.type.startsWith("image/"))return!0;let t=(e.name||"").toLowerCase();return t?/\.(png|jpe?g|gif|webp|bmp|svg|heic|heif)$/i.test(t):!1}function oc(e=[],t=[]){let n=[];return Array.from(e||[]).forEach(r=>{if(r.kind==="file"){let o=typeof r.getAsFile=="function"?r.getAsFile():null;o&&$r(o)&&n.push(o)}}),!n.length&&t?.length&&Array.from(t).forEach(r=>{$r(r)&&n.push(r)}),n}function ic(e=[],t=[]){let n=[];return Array.from(e||[]).forEach(r=>{if(r.kind==="file"){let o=typeof r.getAsFile=="function"?r.getAsFile():null;o&&!$r(o)&&n.push(o)}}),!n.length&&t?.length&&Array.from(t).forEach(r=>{$r(r)||n.push(r)}),n}async function ds(e,t,n){let r=`img-${Date.now()}-${Math.random().toString(16).slice(2)}`,o=t&&t.name?t.name:"image",i=lt(o).replace(/"/g,"&quot;");try{lr(e),Dn(e,`<span data-pending-image="true" data-image-token="${r}">${i} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F...)</span>`)}catch{}try{let{url:s}=await Po(t),l=`
      <span class="resizable-image" style="width:320px;max-width:100%;">
        <span class="resizable-image__inner">${`<img src="${s}" alt="${i}" draggable="false" />`}</span>
        <span class="resizable-image__handle" data-direction="e" aria-hidden="true"></span>
      </span>
    `,d=e,u=d&&d.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`);if(n&&(!u||!d.isConnected)){let m=document.querySelector(`.block[data-block-id="${n}"]`);if(m){let w=m.querySelector('.block-text[contenteditable="true"]')||m.querySelector(".block-text.block-body");w&&(d=w,u=d.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`))}}u?(u.removeAttribute("data-pending-image"),u.removeAttribute("data-image-token"),u.outerHTML=l):d&&(lr(d),Dn(d,l))}catch(s){try{let l=e;if(n&&!l.isConnected){let d=document.querySelector(`.block[data-block-id="${n}"]`);if(d){let m=d.querySelector('.block-text[contenteditable="true"]')||d.querySelector(".block-text.block-body");m&&(l=m)}}if(l){let d=l.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`);d&&(d.textContent=`${o} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F)`,d.removeAttribute("data-pending-image"))}}catch{}try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"insertImageFromFileError",data:{message:s&&s.message?String(s.message):String(s),name:t&&t.name,type:t&&t.type,size:t&&t.size}})}).catch(()=>{})}catch{}try{let l={where:"insertImageFromFile",message:s&&s.message?String(s.message):String(s),status:typeof s?.status=="number"?s.status:null,name:t&&t.name,type:t&&t.type,size:t&&t.size},d=l.status===null?"null":String(l.status);window.alert(`upload failed (status ${d}):\\n${JSON.stringify(l,null,2)}`)}catch{}let c=String(s?.message||"").toLowerCase();c.includes("status 0")||c.includes("network error")?L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 (\u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C). \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438, \u043F\u0440\u0438 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u043E\u0441\u0442\u0438, \u0432\u043E\u0439\u0434\u0438\u0442\u0435 \u0437\u0430\u043D\u043E\u0432\u043E."):L(s.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435")}}function zh(e){if(e.button!==0)return;let t=e.target?.closest(".resizable-image__handle");if(!t)return;let n=t.closest(".resizable-image"),o=n?.closest(".block")?.dataset?.blockId;if(!n||!o||a.mode!=="edit"||a.editingBlockId!==o)return;e.preventDefault(),e.stopPropagation();let i=n.getBoundingClientRect();vr={wrapper:n,startWidth:i.width,startX:e.clientX},n.classList.add("resizable-image--resizing")}function Uh(e){if(!vr)return;e.preventDefault();let t=e.clientX-vr.startX,r=parseFloat(getComputedStyle(document.documentElement).fontSize)||16,o=Math.max(r,document.documentElement.clientWidth-32),i=vr.startWidth+t;i=Math.max(r,Math.min(i,o)),vr.wrapper.style.width=`${i}px`}function Lu(){vr&&(vr.wrapper.classList.remove("resizable-image--resizing"),vr=null)}function Mu(){Bu||(Bu=!0,document.addEventListener("pointerdown",zh),document.addEventListener("pointermove",Uh),document.addEventListener("pointerup",Lu),document.addEventListener("pointercancel",Lu))}var vr,Bu,Nu=Fe(()=>{mt();Ft();Nt();vn();rc();vr=null,Bu=!1});function Pu({listTag:e,resolveTarget:t,restoreSelection:n,richContextRange:r,notifyEditingInput:o,setRichContextRange:i}){let s=t();if(!s||!document.contains(s))return;n();let c=window.getSelection(),l=null;if(r&&s.contains(r.commonAncestorContainer))l=r.cloneRange();else if(c&&c.rangeCount>0){let S=c.getRangeAt(0);s.contains(S.commonAncestorContainer)&&(l=S.cloneRange())}l||(l=document.createRange(),l.selectNodeContents(s),l.collapse(!1));let d=l.startContainer?.nodeType===Node.ELEMENT_NODE?l.startContainer:l.startContainer?.parentElement,u=d?.closest?.("li"),m=u?.closest?.("ol,ul"),g=S=>{if(!S)return;let x=document.createRange();x.selectNodeContents(S),x.collapse(!1),c&&(c.removeAllRanges(),c.addRange(x)),i(x);try{s.focus({preventScroll:!0})}catch{s.focus()}s.classList.remove("block-body--empty"),o(s)},w=S=>{let x=S.parentElement?.tagName==="P"&&S.parentElement.childNodes.length===1?S.parentElement:S,v=Array.from(S.children||[]).filter(z=>z.nodeType===Node.ELEMENT_NODE&&z.tagName==="LI"),B=document.createDocumentFragment(),N=[];v.forEach(z=>{let P=document.createElement("p");for(;z.firstChild;)P.appendChild(z.firstChild);N.push(P),B.appendChild(P)}),x.replaceWith(B),g(N[0]||null)};if(m){if(m.tagName.toLowerCase()===e){w(m);return}let x=document.createElement(e);for(;m.firstChild;)x.appendChild(m.firstChild);m.replaceWith(x),g(u||x.lastElementChild||x);return}let y=()=>{if(!l.collapsed)return null;let S=d?.closest?.("p")||null;if(S&&s.contains(S))return S;if(l.startContainer===s){let x=Array.from(s.childNodes),v=l.startOffset;for(let B=v-1;B>=0;B-=1){let N=x[B];if(N?.nodeType===Node.ELEMENT_NODE&&N.tagName==="P")return N}for(let B=v;B<x.length;B+=1){let N=x[B];if(N?.nodeType===Node.ELEMENT_NODE&&N.tagName==="P")return N}}return null},f=[];if(l.collapsed){let S=y();S&&(f=[S])}else if(f=Array.from(s.querySelectorAll(":scope > p")).filter(x=>{try{return l.intersectsNode(x)}catch{return!1}}),!f.length){let x=d?.closest?.("p");x&&s.contains(x)&&(f=[x])}if(!f.length)return;let h=document.createElement(e);f.forEach(S=>{let x=document.createElement("li");for(;S.firstChild;)x.appendChild(S.firstChild);h.appendChild(x)}),f[0].replaceWith(h),f.slice(1).forEach(S=>S.remove()),g(h.firstElementChild||h)}var Du=Fe(()=>{});var Za={};Wn(Za,{applyEditingUndoStep:()=>uo,attachRichContentHandlers:()=>uc,buildEditableBlockHtml:()=>cc,buildStoredBlockHtml:()=>Ga,cleanupEditableHtml:()=>Tu,clearEditingUndoSession:()=>Jh,countBlocks:()=>as,ensureBlockVisible:()=>fc,expandCollapsedAncestors:()=>jh,extendSelection:()=>Go,extractBlockSections:()=>Cn,findBlock:()=>Je,findCollapsibleTarget:()=>us,findFallbackBlockId:()=>jo,flattenVisible:()=>Sn,initEditingUndoForElement:()=>Kh,insertFilesIntoEditable:()=>dc,isSeparatorNode:()=>Ir,moveSelection:()=>Xo,setCollapseState:()=>Fr,setCurrentBlock:()=>Tn,toggleCollapse:()=>lc});function Hu(e=""){return e?e.startsWith("app:/")?`/api/yandex/disk/file?path=${encodeURIComponent(e)}`:e.startsWith("disk:/")?`/api/yandex/disk/file?path=${encodeURIComponent(e)}`:e:""}function qh(e,t){if(e===t)return!1;if(t.startsWith(e)){let n=t.slice(e.length);if(n.length>0&&n.length<=Vh&&/^[A-Za-z--0-9]+$/.test(n))return!1}return!0}function Kh(e,t){if(!e||!t)return;a.editingUndo={blockId:t,snapshots:[e.innerHTML],index:0,lastText:e.textContent||"",lastSnapshotAt:Date.now()};let n=()=>{let r=a.editingUndo;if(!r||r.blockId!==t)return;let o=e.innerHTML,i=e.textContent||"",{snapshots:s,index:c,lastText:l,lastSnapshotAt:d}=r,u=Date.now();if(!qh(l||"",i)){r.lastText=i;return}if(s[c]===o){r.lastText=i,r.lastSnapshotAt=u;return}c<s.length-1&&s.splice(c+1),s.push(o),r.index=s.length-1,r.lastText=i,r.lastSnapshotAt=u};e.addEventListener("input",()=>{!a.editingUndo||a.editingUndo.blockId!==t||a.mode!=="edit"||a.editingBlockId!==t||n()})}function Jh(){a.editingUndo=null}function Zo(e){if(e)try{let t=typeof InputEvent=="function"?new InputEvent("input",{bubbles:!0}):new Event("input",{bubbles:!0});e.dispatchEvent(t)}catch{try{let n=document.createEvent("Event");n.initEvent("input",!0,!1),e.dispatchEvent(n)}catch{}}}function uo(e){let t=a.editingUndo;if(!t||!t.blockId||!e||a.mode!=="edit"||a.editingBlockId!==t.blockId)return!1;let n=document.querySelector(`.block[data-block-id="${t.blockId}"] .block-text[contenteditable="true"]`);if(!n)return!1;let r=t.index+e;if(r<0||r>=t.snapshots.length)return!1;t.index=r;let o=t.snapshots[r];n.innerHTML=o;try{n.focus({preventScroll:!0})}catch{n.focus()}try{let i=window.getSelection&&window.getSelection();if(i){let s=document.createRange();s.selectNodeContents(n),s.collapse(!1),i.removeAllRanges(),i.addRange(s)}}catch{}return!0}function cc(e=""){let t=Cn(e);if(!t.titleHtml)return e||"";let n=ec(t.titleHtml),r=t.bodyHtml||"";if(r){let i=document.createElement("template");i.innerHTML=r;let s=i.content.firstChild;for(;s&&Ir(s);){let c=s;s=s.nextSibling,i.content.removeChild(c)}r=i.innerHTML}let o=ec(r||"");return`${n}<p><br /></p>${o}`}function Ga(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll(".block-header").forEach(i=>{let s=i.parentNode;if(s){for(;i.firstChild;)s.insertBefore(i.firstChild,i);s.removeChild(i)}});let n=t.innerHTML,r=Cn(n);if(!r.titleHtml)return e||"";let o=`<div class="block-header">${r.titleHtml}</div>`;return r.bodyHtml?`${o}<div><br /></div>${r.bodyHtml}`:o}async function lc(e){let t=Je(e);t&&Fr(e,!t.block.collapsed)}async function Fr(e,t){let n=Je(e);if(!n||n.block.collapsed===t)return;let r=()=>{let s=document.getElementById("blocksContainer");if(!s)return null;let c=a.currentBlockId;if(!c)return{container:s};let l=s.querySelector(`.block[data-block-id="${c}"]`);if(!l)return{container:s};let d=s.getBoundingClientRect(),u=l.getBoundingClientRect();return{container:s,currentId:c,topOffset:u.top-d.top}},o=s=>{if(!s?.container)return;let{container:c}=s;if(!s.currentId||typeof s.topOffset!="number")return;let l=c.querySelector(`.block[data-block-id="${s.currentId}"]`);if(!l)return;let d=c.getBoundingClientRect(),m=l.getBoundingClientRect().top-d.top;c.scrollTop+=m-s.topOffset},i=r();n.block.collapsed=t,await xt(e),Yo({scrollIntoView:!1}),o(i);try{let s=await Pe(`/api/articles/${a.articleId}/collapse`,{method:"PATCH",body:JSON.stringify({blockId:e,collapsed:t})});s?.updatedAt&&(a.article.updatedAt=s.updatedAt)}catch(s){n.block.collapsed=!t,await xt(e),Yo({scrollIntoView:!1}),o(i),L(s.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430")}}function us(e,t){let n=Je(e);for(;n;){let o=!!Cn(n.block.text||"").titleHtml,i=!!n.block.children?.length;if((o||i)&&n.block.collapsed!==t)return n.block.id;if(!n.parent)break;n=Je(n.parent.id)}return null}async function jh(e){let t=Je(e);if(!t)return;let n=(t.ancestors||[]).filter(r=>r.collapsed);for(let r of n)await Fr(r.id,!1)}function jo(e){let t=Je(e);if(!t)return null;let n=t.siblings?.[t.index+1];if(n)return n.id;let r=t.siblings?.[t.index-1];return r?r.id:t.parent?t.parent.id:null}function as(e=[]){return(e||[]).reduce((t,n)=>t+1+as(n.children||[]),0)}async function ac(e,t,n){if(!a.articleId){L("\u041D\u0435 \u0432\u044B\u0431\u0440\u0430\u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044F \u0434\u043B\u044F \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0444\u0430\u0439\u043B\u0430");return}let r=`att-${Date.now()}-${Math.random().toString(16).slice(2)}`,o=lt(t?.name||"\u0444\u0430\u0439\u043B"),i=t?.name||"\u0444\u0430\u0439\u043B",s="";Pt("attachment: uploading to Yandex Disk",{name:t?.name,type:t?.type,size:t?.size,articleId:a.articleId,token:r});try{lr(e),Dn(e,`<a data-pending-attachment="true" data-attachment-token="${r}">${o} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430...)</a>`)}catch{}try{let c=await Oi(a.articleId,t,{onProgress:g=>{let w=Math.max(0,Math.min(100,Math.round(g||0)));Pt("attachment upload progress",{percent:w,name:t?.name});try{let y=e,f=y.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);if(n&&(!f||!y.isConnected)){let h=document.querySelector(`.block[data-block-id="${n}"]`);if(h){let S=h.querySelector('.block-text[contenteditable="true"]')||h.querySelector(".block-text.block-body");S&&(y=S,f=y.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`))}}if(f){let h=w>=100?`${i} (\u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0430...)`:`${i} (${w}%)`;h!==s&&(s=h,f.textContent=h)}}catch{}}}),l=lt(c.originalName||t.name||"\u0444\u0430\u0439\u043B"),d=c.storedPath||c.url||"",u=Hu(d),m=lt(u);if(m){let g=e,w=g.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);if(n&&(!w||!g.isConnected)){let y=document.querySelector(`.block[data-block-id="${n}"]`);if(y){let h=y.querySelector('.block-text[contenteditable="true"]')||y.querySelector(".block-text.block-body");h&&(g=h,w=g.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`))}}w?(w.removeAttribute("data-pending-attachment"),w.removeAttribute("data-attachment-token"),w.setAttribute("href",m),w.setAttribute("target","_blank"),w.setAttribute("rel","noopener noreferrer"),w.textContent=l):(lr(g),Dn(g,`<a href="${m}" target="_blank" rel="noopener noreferrer">${l}</a>`))}}catch(c){try{let d=e;if(n&&!d.isConnected){let m=document.querySelector(`.block[data-block-id="${n}"]`);if(m){let w=m.querySelector('.block-text[contenteditable="true"]')||m.querySelector(".block-text.block-body");w&&(d=w)}}let u=d.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);u&&(u.textContent=`${o} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`)}catch{}let l=String(c?.message||"").toLowerCase();l.includes("status 0")||l.includes("network error")?L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B (\u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C). \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438, \u043F\u0440\u0438 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u043E\u0441\u0442\u0438, \u0432\u043E\u0439\u0434\u0438\u0442\u0435 \u0437\u0430\u043D\u043E\u0432\u043E."):L(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u043D\u0430 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A")}}function dc(e,t=[],n){if(!e||!t||!t.length)return;let r=Array.from(t),o=r.filter(s=>$r(s)),i=r.filter(s=>s&&!$r(s));o.forEach(s=>ds(e,s,n)),i.forEach(s=>ac(e,s,n))}function uc(e,t){Ru(e,t);let n=e.closest(".block-content");n&&n!==e&&Ru(n,t,e),e.addEventListener("paste",r=>{if(a.mode!=="edit"||a.editingBlockId!==t)return;let o=oc(r.clipboardData?.items),i=ic(r.clipboardData?.items);if(o.length>0)r.preventDefault(),o.forEach(s=>ds(e,s,t));else if(i.length>0)r.preventDefault(),Pt("paste: non-image files detected",i.map(s=>({name:s.name,type:s.type,size:s.size}))),i.forEach(s=>ac(e,s,t));else{let s=(r.clipboardData?.getData("text/html")||"").trim();if(r.preventDefault(),s){let c=Eu(s),l=nc(c);lr(e),Dn(e,Qo(l)),Zo(e)}else{let c=r.clipboardData?.getData("text/plain")||"",l=c.trim();if(/^https?:\/\/\S+$/i.test(l)){let u=lt(l);lr(e),Dn(e,`<a href="${u}" target="_blank" rel="noopener noreferrer">${u}</a>`),Zo(e)}else{let u=c.replace(/\r\n/g,`
`).replace(/\r/g,`
`),m=lt(u).replace(/\n{2,}/g,"<br /><br />").replace(/\n/g," "),g=Qo(nc(m));lr(e),Dn(e,g),Zo(e)}}}}),e.addEventListener("drop",r=>{if(a.mode!=="edit"||a.editingBlockId!==t){Pt("drop ignored",{mode:a.mode,editingBlockId:a.editingBlockId,targetBlockId:t});return}let o=Array.from(r.dataTransfer?.files||[]);if(!o.length)return;let i=o.filter(c=>c.type?.startsWith("image/")),s=o.filter(c=>!c.type||!c.type.startsWith("image/"));!i.length&&!s.length||(r.preventDefault(),Pt("drop: files detected",o.map(c=>({name:c.name,type:c.type,size:c.size}))),i.forEach(c=>ds(e,c,t)),s.forEach(c=>ac(e,c,t)))}),e.addEventListener("click",r=>{let o=r.target?.closest("img");if(o){if(r.target?.closest(".resizable-image__handle")){r.preventDefault();return}r.preventDefault(),_o(o.src,o.alt||"");return}let i=r.target?.closest("a[href]");if(!i)return;let s=i.getAttribute("href")||"";if(!s.startsWith("app:/")&&!s.startsWith("disk:/"))return;r.preventDefault();let c=Hu(s);c&&window.open(c,"_blank","noopener,noreferrer")}),a.articleId==="inbox"&&e.addEventListener("click",async r=>{if(r.target?.closest(".move-block-btn")){r.preventDefault(),r.stopPropagation();try{let s=(a.articlesIndex.length?a.articlesIndex:await In()).filter(u=>u.id!=="inbox").map(u=>({id:u.id,title:u.title||"\u0420\u2018\u0420\xB5\u0420\xB7 \u0420\u0405\u0420\xB0\u0420\xB7\u0420\u0406\u0420\xB0\u0420\u0405\u0420\u0451\u0421\u040F"})),c=await on({title:"\u0420\u045F\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451 \u0420\u0406 \u0421\u0403\u0421\u201A\u0420\xB0\u0421\u201A\u0421\u040A\u0421\u040B",message:"\u0420\u2019\u0420\u0406\u0420\xB5\u0420\u0491\u0420\u0451\u0421\u201A\u0420\xB5 ID \u0420\u0451\u0420\xBB\u0420\u0451 \u0420\u0406\u0421\u2039\u0420\xB1\u0420\xB5\u0421\u0402\u0420\u0451\u0421\u201A\u0420\xB5 \u0421\u0403\u0421\u201A\u0420\xB0\u0421\u201A\u0421\u040A\u0421\u040B",confirmText:"\u0420\u045F\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451",cancelText:"\u0420\u045B\u0421\u201A\u0420\u0458\u0420\xB5\u0420\u0405\u0420\xB0",suggestions:s,returnMeta:!0,hideConfirm:!1}),d=(c?.selectedId||(typeof c=="object"?c?.value:c)||""||"").trim();if(!d)return;await Pe(`/api/articles/${a.articleId}/blocks/${t}/move-to/${d}`,{method:"POST"}),bt(pt.article("inbox"))}catch(i){L(i.message||"\u0420\u045C\u0420\xB5 \u0421\u0453\u0420\u0491\u0420\xB0\u0420\xBB\u0420\u0455\u0421\u0403\u0421\u040A \u0420\u0457\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451 \u0420\xB1\u0420\xBB\u0420\u0455\u0420\u0454")}}}),e.addEventListener("dragover",r=>{if(a.mode!=="edit"||a.editingBlockId!==t)return;(oc(r.dataTransfer?.items).length>0||ic(r.dataTransfer?.items).length>0)&&r.preventDefault()}),e.addEventListener("keydown",r=>{if(a.mode!=="edit"||a.editingBlockId!==t)return;let o=window.getSelection();if(!o||o.rangeCount===0)return;let i=o.getRangeAt(0);if(!i||!i.collapsed||vu({event:r,element:e,range:i,selection:o,notifyEditingInput:Zo,logDebug:Pt})||r.key!=="Tab"||!(i.commonAncestorContainer?.nodeType===Node.ELEMENT_NODE?i.commonAncestorContainer:i.commonAncestorContainer?.parentElement)?.closest?.("li"))return;r.preventDefault(),r.stopPropagation();let l=r.shiftKey?"outdent":"indent";document.execCommand(l,!1,null)})}function $u(){let e=window.getSelection();if(!e||e.rangeCount===0)return;let t=e.getRangeAt(0),n=t.commonAncestorContainer,o=(n?.nodeType===Node.ELEMENT_NODE?n:n?.parentElement)?.closest('.block-text[contenteditable="true"]');if(!o){ti=null;return}let s=o.closest(".block")?.dataset?.blockId;if(a.mode!=="edit"||a.editingBlockId!==s){ti=null;return}ti=t.cloneRange()}function Wh(){if(sc)return sc;_u||(document.addEventListener("selectionchange",$u),_u=!0);let e=document.createElement("div");e.className="rich-context-menu hidden",e.innerHTML=`
    <div class="rich-context-menu__col rich-context-menu__col--buffer">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="copy" aria-label="\u041A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C" title="\u041A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C">\u29C9</button>
        <button class="rich-context-menu__icon-btn" data-action="cut" aria-label="\u0412\u044B\u0440\u0435\u0437\u0430\u0442\u044C" title="\u0412\u044B\u0440\u0435\u0437\u0430\u0442\u044C">\u2702</button>
        <button class="rich-context-menu__icon-btn" data-action="paste" aria-label="\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C" title="\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C">\u25A3</button>
        <button class="rich-context-menu__icon-btn" data-action="select-all" aria-label="\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0432\u0441\u0451" title="\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0432\u0441\u0451">\u26F6</button>
      </div>
    </div>
    <div class="rich-context-menu__col">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="bold" aria-label="\u041F\u043E\u043B\u0443\u0436\u0438\u0440\u043D\u044B\u0439" title="\u041F\u043E\u043B\u0443\u0436\u0438\u0440\u043D\u044B\u0439"><strong>\u0416</strong></button>
        <button class="rich-context-menu__icon-btn" data-action="italic" aria-label="\u041A\u0443\u0440\u0441\u0438\u0432" title="\u041A\u0443\u0440\u0441\u0438\u0432"><em>/</em></button>
        <button class="rich-context-menu__icon-btn" data-action="underline" aria-label="\u041F\u043E\u0434\u0447\u0435\u0440\u043A\u043D\u0443\u0442\u044C" title="\u041F\u043E\u0434\u0447\u0435\u0440\u043A\u043D\u0443\u0442\u044C"><u>\u0427</u></button>
        <button class="rich-context-menu__icon-btn" data-action="remove-format" aria-label="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0444\u043E\u0440\u043C\u0430\u0442" title="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0444\u043E\u0440\u043C\u0430\u0442">\u2715</button>
      </div>
    </div>
    <div class="rich-context-menu__col">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="ul" aria-label="\u041C\u0430\u0440\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A" title="\u041C\u0430\u0440\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A">\u2022</button>
        <button class="rich-context-menu__icon-btn" data-action="ol" aria-label="\u041D\u0443\u043C\u0435\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A" title="\u041D\u0443\u043C\u0435\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A">1.</button>
        <button class="rich-context-menu__icon-btn" data-action="quote" aria-label="\u0426\u0438\u0442\u0430\u0442\u0430" title="\u0426\u0438\u0442\u0430\u0442\u0430">\u275D</button>
        <button class="rich-context-menu__icon-btn" data-action="code" aria-label="\u041A\u043E\u0434" title="\u041A\u043E\u0434">&lt;/&gt;</button>
      </div>
    </div>
    <div class="rich-context-menu__col">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="link" aria-label="\u0421\u0441\u044B\u043B\u043A\u0430" title="\u0421\u0441\u044B\u043B\u043A\u0430">\u{1F517}</button>
        <button class="rich-context-menu__icon-btn" data-action="unlink" aria-label="\u0423\u0431\u0440\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443" title="\u0423\u0431\u0440\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443">\u2298</button>
        <button class="rich-context-menu__icon-btn" data-action="insert-article-link" aria-label="\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E" title="\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E">\xA7</button>
      </div>
    </div>
    <div class="rich-context-menu__col">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="split-at-caret" aria-label="\u0420\u0430\u0437\u0434\u0435\u043B\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043F\u043E \u043A\u0443\u0440\u0441\u043E\u0440\u0443" title="\u0420\u0430\u0437\u0434\u0435\u043B\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043F\u043E \u043A\u0443\u0440\u0441\u043E\u0440\u0443">|\u21B5</button>
      </div>
    </div>
  `,document.body.appendChild(e);let t=()=>{e.classList.add("hidden"),e.style.visibility="",zt=null,lo=null,ei=null},n=()=>{if(zt){let o=window.getSelection();o.removeAllRanges(),o.addRange(zt)}},r=async o=>{n();let i=()=>{if(lo&&document.contains(lo))return lo;let g=window.getSelection()?.anchorNode?.parentElement?.closest(".block-text[contenteditable]");if(g)return g;if(zt){let y=zt.commonAncestorContainer;if(y?.parentElement){let f=y.parentElement.closest(".block-text[contenteditable]");if(f)return f}}if(ei&&document.contains(ei))return ei;if(a.editingBlockId){let y=document.querySelector(`.block[data-block-id="${a.editingBlockId}"] .block-text[contenteditable="true"]`);if(y)return y}let w=document.activeElement;if(w&&w.closest){let y=w.closest(".block-text[contenteditable]");if(y)return y}return null},s=u=>{Pu({listTag:u,resolveTarget:i,restoreSelection:n,richContextRange:zt,notifyEditingInput:Zo,setRichContextRange:m=>{zt=m?m.cloneRange():null}})},c=async()=>{let u=i();if(!u){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0441\u0441\u044B\u043B\u043A\u0438");return}let m=a.articlesIndex.length?a.articlesIndex:await In(),g=m.map(x=>({id:x.id,title:x.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),w="",y="";try{let x=await on({title:"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438. \u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0438 \u043F\u043E\u043C\u043E\u0433\u0443\u0442 \u043D\u0430\u0439\u0442\u0438 \u043D\u0443\u0436\u043D\u0443\u044E.",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:g,returnMeta:!0,hideConfirm:!0});x&&typeof x=="object"?(w=x.value||"",y=x.selectedId||""):w=x||""}catch{w=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438")||""}let f=(w||"").trim().toLowerCase();if(!f&&!y)return;let h=m.find(x=>{let v=(x.title||"").toLowerCase();return y&&x.id===y||x.id&&x.id.toLowerCase()===f||v===f||v.includes(f)});if(!h){L("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}if(!u||!document.contains(u)){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0441\u0441\u044B\u043B\u043A\u0438");return}n(),u.focus();let b=`<a href="${pt.article(h.id)}" class="article-link" data-article-id="${h.id}">${lt(h.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F")}</a>`;Dn(u,b);let S=(u.innerHTML||"").trim();(!S||S==="<br>"||S==="<br/>"||S==="<br />")&&(u.innerHTML=b),u.classList.remove("block-body--empty")},l=()=>{n();let u=window.getSelection();if(!(!u||u.rangeCount===0)){document.execCommand("removeFormat");for(let m=0;m<4;m+=1)document.execCommand("outdent");document.execCommand("formatBlock",!1,"p")}},d=u=>{let m=i();if(!m||!document.contains(m))return L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u0442\u0435\u043A\u0441\u0442 \u0434\u043B\u044F \u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F"),null;let g=window.getSelection();if(!g||g.rangeCount===0)return null;let w=g.getRangeAt(0).cloneRange();if(!w||w.collapsed)return null;let y=w.cloneContents(),f=document.createElement("div");f.appendChild(y);let h=f.innerHTML||"",b=f.textContent||"",x=m.closest(".block")?.dataset.blockId||null;return co={html:h,text:b,sourceBlockId:x},Pt("clipboard.capture",{kind:u,hasHtml:!!h,length:b.length,blockId:x}),{range:w,target:m}};switch(o){case"cut":{if(!d("cut"))break;document.execCommand("cut");break}case"copy":d("copy"),document.execCommand("copy");break;case"select-all":{let u=i();if(!u||!document.contains(u))break;let m=document.createRange();m.selectNodeContents(u);let g=window.getSelection();g&&(g.removeAllRanges(),g.addRange(m)),zt=m.cloneRange();break}case"paste":{let u=i();if(!u||!document.contains(u)){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438");break}if(!co||!co.html&&!co.text){L("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0441\u043A\u043E\u043F\u0438\u0440\u0443\u0439\u0442\u0435 \u0438\u043B\u0438 \u0432\u044B\u0440\u0435\u0436\u044C\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u0432 \u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440\u0435");break}n();let m=window.getSelection(),g=null;if(zt&&u.contains(zt.commonAncestorContainer))g=zt.cloneRange();else if(m&&m.rangeCount>0){let h=m.getRangeAt(0);u.contains(h.commonAncestorContainer)&&(g=h.cloneRange())}g||(g=document.createRange(),g.selectNodeContents(u),g.collapse(!1));let w=co.html||lt(co.text).replace(/\n/g,"<br />"),y=document.createElement("div");y.innerHTML=w;let f=document.createDocumentFragment();for(;y.firstChild;)f.appendChild(y.firstChild);g.deleteContents(),g.insertNode(f),g.collapse(!1),m&&(m.removeAllRanges(),m.addRange(g)),u.focus({preventScroll:!0}),u.classList.remove("block-body--empty");break}case"bold":document.execCommand("bold");break;case"italic":document.execCommand("italic");break;case"underline":document.execCommand("underline");break;case"ul":s("ul");break;case"ol":s("ol");break;case"quote":document.execCommand("formatBlock",!1,"blockquote");break;case"code":document.execCommand("formatBlock",!1,"pre");break;case"link":{let u=window.getSelection(),m=u?u.toString():"",g=u?.anchorNode,w=g?g.parentElement?.closest("a"):null,y=w?.getAttribute("href")||"",f=await Ta({title:"\u0421\u0441\u044B\u043B\u043A\u0430",textLabel:"\u0422\u0435\u043A\u0441\u0442",urlLabel:"\u0421\u0441\u044B\u043B\u043A\u0430",defaultText:m||w?.textContent||"",defaultUrl:y,confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"});if(Pt("link action: prompt result",{hasResult:!!f,url:f?.url,text:f?.text}),!f||!f.url)break;let h=f.url.match(/^[a-z]+:/i)?f.url:`https://${f.url}`,b=f.text?.trim()||h;n();let S=i();if(Pt("link action: target",{targetExists:!!S,inDom:!!(S&&document.contains(S)),className:S?.className}),!S||!document.contains(S))break;let x=window.getSelection(),v=null;zt&&S.contains(zt.commonAncestorContainer)?v=zt.cloneRange():x&&x.rangeCount>0&&S.contains(x.getRangeAt(0).commonAncestorContainer)&&(v=x.getRangeAt(0).cloneRange()),v||(v=document.createRange(),v.selectNodeContents(S),v.collapse(!1)),Pt("link action: range chosen",{usedSelectionRange:!!(x&&x.rangeCount>0&&S.contains(x.getRangeAt(0).commonAncestorContainer)),usedStoredRange:!!(zt&&S.contains(zt.commonAncestorContainer)),selectionRangeCollapsed:!!(x&&x.rangeCount>0&&x.getRangeAt(0).collapsed),rangeStartNode:v?.startContainer?.nodeName,rangeOffset:v?.startOffset,labelLength:(b||"").length,url:h});let B=document.createElement("a");B.href=h,B.target="_blank",B.rel="noopener noreferrer",B.textContent=b,v.deleteContents(),v.insertNode(B),v.setStartAfter(B),v.setEndAfter(B),Pt("link action: inserted link",{outerHTML:B.outerHTML,parentClass:B.parentElement?.className,targetInner:S.innerHTML.slice(0,120)}),x&&(x.removeAllRanges(),x.addRange(v)),S.focus({preventScroll:!0}),S.classList.remove("block-body--empty");break}case"unlink":{let u=i();if(Pt("unlink action: target",{targetExists:!!u,inDom:!!(u&&document.contains(u)),className:u?.className}),!u||!document.contains(u))break;let m=window.getSelection(),g=null;if(m&&m.rangeCount>0){let w=m.getRangeAt(0).commonAncestorContainer;g=w?.parentElement?.closest("a")||w?.closest?.("a")}if(!g&&zt){let w=zt.commonAncestorContainer;g=w?.parentElement?.closest("a")||w?.closest?.("a")}if(g||(g=u.querySelector("a")),g){let w=document.createTextNode(g.textContent||"");g.replaceWith(w)}else document.execCommand("unlink");break}case"remove-format":l();break;case"insert-article-link":c().finally(()=>{t()});return;case"split-at-caret":await io();break;default:break}t()};return e.addEventListener("click",o=>{let i=o.target.closest("button[data-action]");if(!i)return;let s=i.dataset.action;r(s)}),document.addEventListener("click",o=>{e.classList.contains("hidden")||e.contains(o.target)||t()}),document.addEventListener("touchstart",o=>{e.classList.contains("hidden")||e.contains(o.target)||t()},{passive:!0}),document.addEventListener("keydown",o=>{o.code==="Escape"&&t()}),window.addEventListener("scroll",t,!0),sc=e,e}function Ou(e){let t=Wh();t.classList.remove("hidden"),t.style.visibility="hidden",$u();let n=window.getSelection();n&&n.rangeCount>0?zt=n.getRangeAt(0).cloneRange():ti?zt=ti.cloneRange():zt=null;let r=t.getBoundingClientRect(),o=22,i=12,s=e.clientX+14,c=e.clientY+o;c+r.height+i>window.innerHeight&&(c=Math.max(i,e.clientY-r.height-o));let l=Math.min(Math.max(s,i),window.innerWidth-r.width-i),d=Math.min(Math.max(c,i),window.innerHeight-r.height-i);t.style.left=`${l}px`,t.style.top=`${d}px`,t.style.visibility="visible"}function Ru(e,t,n){let r=n||e;e.addEventListener("focusin",()=>{ei=r}),e.addEventListener("contextmenu",s=>{a.mode!=="edit"||a.editingBlockId!==t||(s.preventDefault(),lo=r,Ou(s))});let o=null;e.addEventListener("touchstart",s=>{if(a.mode!=="edit"||a.editingBlockId!==t||s.touches.length!==1)return;let c=s.touches[0];o=window.setTimeout(()=>{lo=r,Ou({clientX:c.clientX,clientY:c.clientY})},500)},{passive:!0});let i=()=>{o!==null&&(clearTimeout(o),o=null)};e.addEventListener("touchend",i,{passive:!0}),e.addEventListener("touchcancel",i,{passive:!0})}async function fc(e){if(!e)return;let t=Je(e);if(!t)return;let n=(t.ancestors||[]).filter(r=>r.collapsed);for(let r of n)await Fr(r.id,!1)}var Vh,sc,zt,lo,ei,co,ti,_u,ln=Fe(()=>{mt();Ft();Nt();Qn();vn();Vn();Ft();En();En();so();Iu();tc();Cu();rc();Nu();Du();Vh=16;sc=null,zt=null,lo=null,ei=null,co={html:"",text:"",sourceBlockId:null},ti=null,_u=!1;Mu()});function Yh(e="",t=""){let n=Array.from(e),r=Array.from(t),o=n.length,i=r.length,s=Array.from({length:o+1},()=>new Array(i+1).fill(0));for(let m=o-1;m>=0;m-=1)for(let g=i-1;g>=0;g-=1)n[m]===r[g]?s[m][g]=s[m+1][g+1]+1:s[m][g]=Math.max(s[m+1][g],s[m][g+1]);let c=[],l=0,d=0;for(;l<o&&d<i;)n[l]===r[d]?(c.push({type:"same",value:n[l]}),l+=1,d+=1):s[l+1][d]>=s[l][d+1]?(c.push({type:"removed",value:n[l]}),l+=1):(c.push({type:"added",value:r[d]}),d+=1);for(;l<o;)c.push({type:"removed",value:n[l]}),l+=1;for(;d<i;)c.push({type:"added",value:r[d]}),d+=1;let u=[];return c.forEach(m=>{if(!m.value)return;let g=u[u.length-1];g&&g.type===m.type?g.value+=m.value:u.push({type:m.type,value:m.value})}),u}function Xh(e=[],t=[]){let n=c=>`${c.src}||${c.alt||""}`,r={};t.forEach(c=>{let l=n(c);r[l]=(r[l]||0)+1});let o=[];e.forEach(c=>{let l=n(c);r[l]?r[l]-=1:o.push({type:"removed",...c})});let i={};e.forEach(c=>{let l=n(c);i[l]=(i[l]||0)+1});let s=[];return t.forEach(c=>{let l=n(c);i[l]?i[l]-=1:s.push({type:"added",...c})}),[...o,...s]}function Gh(e,t){if(!t.length)return;let n=document.createElement("div");n.className="diff-images",t.forEach(r=>{let o=document.createElement("div");o.className=`diff-image-card diff-image-card--${r.type}`;let i=document.createElement("div");i.className="diff-image-card__label",i.textContent=r.type==="added"?"\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E":"\u0423\u0434\u0430\u043B\u0435\u043D\u043E";let s=document.createElement("img");s.src=r.src,s.alt=r.alt||"",o.append(i,s),n.appendChild(o)}),e.appendChild(n)}function zu(e,t,n,r=[]){let o=document.createElement("div");o.className="diff-inline";let i=document.createElement("div");i.className="diff-inline__content",n.forEach(c=>{let l=document.createElement("span");c.type==="added"?l.className="diff-inline__segment diff-inline__segment--added":c.type==="removed"&&(l.className="diff-inline__segment diff-inline__segment--removed"),l.textContent=c.value,i.appendChild(l)}),Gh(i,r);let s=document.createElement("div");s.className="diff-inline__hint",s.textContent=t==="undo"?"\u041F\u043E\u0432\u0442\u043E\u0440\u043D\u043E \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Ctrl+Z, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C \u043E\u0442\u043C\u0435\u043D\u0443":"\u041F\u043E\u0432\u0442\u043E\u0440\u043D\u043E \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Ctrl+Y, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C \u043F\u043E\u0432\u0442\u043E\u0440",o.append(i,s),e.innerHTML="",e.appendChild(o)}function Qh(e,t="history"){return(t==="redo"?a.article?.redoHistory||[]:a.article?.history||[]).find(r=>r.id===e)||null}async function Uu(e,t){Zn();let n=t==="undo"?"history":"redo",r=Qh(e.historyEntryId,n);if(!r)return!1;await fs(e.blockId);let o=document.querySelector(`.block[data-block-id="${e.blockId}"] .block-text`);if(!o)return!1;let i=o.innerHTML,s=t==="undo"?r.before:r.after,c=o.textContent||"",l=Bd(s),d=Yh(c,l),u=d.some(g=>g.type!=="same"),m=Xh(xa(i),xa(s));return!u&&!m.length?!1:(zu(o,t,d,m),a.pendingTextPreview={mode:t,blockId:e.blockId,originalHTML:i,chunks:d,imageDiff:m},!0)}async function Vu(e){let t=a.pendingTextPreview;if(Zn({restoreDom:!1}),!!t){if(e==="undo"){let n=a.undoStack.pop();if(!n)return;await Ju(n)?a.redoStack.push(n):a.undoStack.push(n)}else if(e==="redo"){let n=a.redoStack.pop();if(!n)return;await ju(n)?a.undoStack.push(n):a.redoStack.push(n)}}}function qu(){let e=a.pendingTextPreview;if(!e)return;let t=document.querySelector(`.block[data-block-id="${e.blockId}"] .block-text`);t&&zu(t,e.mode,e.chunks,e.imageDiff||[])}function Zh(e){return e?e.kind==="move"?{kind:"move",blockId:e.blockId,direction:e.direction==="up"?"down":"up"}:e.kind==="reorder"?{kind:"reorder",blockId:e.blockId,fromParentId:e.toParentId??null,fromIndex:e.toIndex??null,toParentId:e.fromParentId??null,toIndex:e.fromIndex??null}:e.kind==="indent"?{kind:"outdent",blockId:e.blockId}:e.kind==="outdent"?{kind:"indent",blockId:e.blockId}:e.kind==="create"?{kind:"delete",blockId:e.blockId,fallbackId:e.fallbackId||null}:e.kind==="delete"?{kind:"restore",block:e.block,parentId:e.parentId||null,index:e.index??null}:null:null}async function Ku(e,t={}){let{skipRecord:n=!1}=t;if(!e)return{success:!1};let r=!1,o=null;if(Pt("executeStructureAction start",e),e.kind==="move")r=await mc(e.blockId,e.direction,{skipRecord:n});else if(e.kind==="reorder")r=(await hs(e.blockId,e.toParentId??null,e.toIndex??null,{skipRecord:!0})).success;else if(e.kind==="indent")r=await gc(e.blockId,{skipRecord:n});else if(e.kind==="outdent")r=await yc(e.blockId,{skipRecord:n});else if(e.kind==="delete"){let i=e.blockId||e.block?.id;if(!i)return{success:!1};try{o=await Pe(`/api/articles/${a.articleId}/blocks/${i}`,{method:"DELETE"});let s=Je(i);if(s&&a.article&&Array.isArray(a.article.blocks)){let l=s.siblings||a.article.blocks,d=s.index??l.findIndex(u=>u.id===i);if(d>=0&&l.splice(d,1),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}if(o?.block&&o.block.id){let{pushLocalBlockTrashEntry:u}=await Promise.resolve().then(()=>(Qn(),Gu)),m=o.block;u(m,s.parent?.id||null,s.index??d)}}let c=e.fallbackId||o?.parentId||null;c&&await fs(c),ot(),r=!0}catch(s){L(s.message),r=!1}}else if(e.kind==="restore"||e.kind==="create"){let i=e.block||e.blockSnapshot;if(!i)return{success:!1};let s=e.parentId||null;try{let c=i;a.article&&a.article.encrypted&&a.articleEncryptionKey&&(c=JSON.parse(JSON.stringify(i)),await Ho(c,a.articleEncryptionKey)),o=await Pe(`/api/articles/${a.articleId}/blocks/restore`,{method:"POST",body:JSON.stringify({parentId:e.parentId||null,index:e.index??null,block:c})});let l=o?.block,d=o?.parentId||e.parentId||null;if(s=d,l&&a.article&&Array.isArray(a.article.blocks)){let u=cr(l)||l;if(d){let g=Je(d)?.block||null;if(g){Array.isArray(g.children)||(g.children=[]);let w=g.children,y=typeof o.index=="number"&&o.index>=0&&o.index<=w.length?o.index:w.length;w.splice(y,0,u)}}else{let m=a.article.blocks,g=typeof o.index=="number"&&o.index>=0&&o.index<=m.length?o.index:m.length;m.splice(g,0,u)}if(a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}r=!0}catch(c){L(c.message),r=!1}if(r&&a.article&&Array.isArray(a.article.blocks))if(s)try{await xt(s)}catch{ot()}else ot()}if(r){let i=e.blockId||o?.block?.id||e.block?.id;i&&await fs(i)}return Pt("executeStructureAction result",{success:r,payload:o}),{success:r,payload:o}}async function Ju(e){if(!a.articleId)return null;try{let t=await Pe(`/api/articles/${a.articleId}/blocks/undo-text`,{method:"POST",body:JSON.stringify({entryId:e?.historyEntryId||null})}),n=t?.blockId;if(!n)return null;let r=Je(n);if(!r||!a.article||!Array.isArray(a.article.blocks))return await Jt(a.articleId,{desiredBlockId:n}),ot(),n;let o=t.block&&typeof t.block.text=="string"?t.block.text:"";if(a.article.encrypted&&a.articleEncryptionKeys?.[a.article.id]&&Oo(o)){let i=a.articleEncryptionKeys[a.article.id];try{o=await Ro(i,o)}catch{o=""}}if(r.block.text=o,a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}return a.currentBlockId=n,a.selectionAnchorBlockId=null,a.selectedBlockIds=[],await xt(n),n}catch(t){return t.message!=="Nothing to undo"&&L(t.message),null}}async function ju(e){if(!a.articleId)return null;try{let t=await Pe(`/api/articles/${a.articleId}/blocks/redo-text`,{method:"POST",body:JSON.stringify({entryId:e?.historyEntryId||null})}),n=t?.blockId;if(!n)return null;let r=Je(n);if(!r||!a.article||!Array.isArray(a.article.blocks))return await Jt(a.articleId,{desiredBlockId:n}),ot(),n;let o=t.block&&typeof t.block.text=="string"?t.block.text:"";if(a.article.encrypted&&a.articleEncryptionKeys?.[a.article.id]&&Oo(o)){let i=a.articleEncryptionKeys[a.article.id];try{o=await Ro(i,o)}catch{o=""}}if(r.block.text=o,a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}return a.currentBlockId=n,a.selectionAnchorBlockId=null,a.selectedBlockIds=[],await xt(n),n}catch(t){return t.message!=="Nothing to redo"&&L(t.message),null}}async function fo(){if(a.pendingTextPreview?.mode==="redo"&&Zn(),a.pendingTextPreview?.mode==="undo"){await Vu("undo");return}if(!a.undoStack.length){L("\u041D\u0435\u0447\u0435\u0433\u043E \u043E\u0442\u043C\u0435\u043D\u044F\u0442\u044C");return}let e=a.undoStack[a.undoStack.length-1];if(Pt("handleUndoAction entry",e),e.type==="structure"){a.undoStack.pop();let n=Zh(e.action),r=await Ku(n,{skipRecord:!0});r.success?(e.action.kind==="create"&&r.payload?.block&&(e.action.block=r.payload.block,e.action.parentId=r.payload.parentId||null,e.action.index=r.payload.index??null),a.redoStack.push(e)):(a.undoStack.push(e),L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043C\u0435\u043D\u0438\u0442\u044C \u0434\u0435\u0439\u0441\u0442\u0432\u0438\u0435"));return}await Uu(e,"undo")||(a.undoStack.pop(),await Ju(e)?a.redoStack.push(e):a.undoStack.push(e))}async function po(){if(a.pendingTextPreview?.mode==="undo"&&Zn(),a.pendingTextPreview?.mode==="redo"){await Vu("redo");return}if(!a.redoStack.length){L("\u041D\u0435\u0447\u0435\u0433\u043E \u043F\u043E\u0432\u0442\u043E\u0440\u044F\u0442\u044C");return}let e=a.redoStack[a.redoStack.length-1];if(Pt("handleRedoAction entry",e),e.type==="structure"){a.redoStack.pop(),(await Ku(e.action,{skipRecord:!0})).success?a.undoStack.push(e):(a.redoStack.push(e),L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u0432\u0442\u043E\u0440\u0438\u0442\u044C \u0434\u0435\u0439\u0441\u0442\u0432\u0438\u0435"));return}await Uu(e,"redo")||(a.redoStack.pop(),await ju(e)?a.undoStack.push(e):a.redoStack.push(e))}function Wu(e){Zn({restoreDom:!1});let t=n=>({type:"text",blockId:n.blockId,historyEntryId:n.id});a.undoStack=(e.history||[]).map(t),a.redoStack=(e.redoHistory||[]).map(t)}function dn(e){e&&(Pt("pushUndoEntry",e),a.undoStack.push(e),a.redoStack=[])}function cr(e){try{return JSON.parse(JSON.stringify(e||{}))}catch{return null}}function pc(e){if(!e||!a.article||!Array.isArray(a.article.blocks))return;let t=!1,n=r=>{if(Array.isArray(r))for(let o=0;o<r.length;o+=1){let i=r[o];if(i){if(i===e)if(!t)t=!0;else{r.splice(o,1),o-=1;continue}Array.isArray(i.children)&&i.children.length&&n(i.children)}}};n(a.article.blocks)}async function eg(){if(a.articleId&&!a.isMoveQueueProcessing){a.isMoveQueueProcessing=!0;try{for(;a.moveQueue.length;){let e=a.moveQueue.shift();if(!e)break;let{blockId:t,direction:n}=e;try{await Pe(`/api/articles/${a.articleId}/blocks/${t}/move`,{method:"POST",body:JSON.stringify({direction:n})})}catch(r){L(r.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u043F\u043E\u0440\u044F\u0434\u043E\u043A \u0431\u043B\u043E\u043A\u043E\u0432, \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0441\u0442\u0430\u0442\u044C\u044E");try{await Jt(a.articleId,{desiredBlockId:t}),ot()}catch{}a.moveQueue=[];break}}}finally{a.isMoveQueueProcessing=!1}}}function tg(e,t){!e||!["up","down"].includes(t)||(Array.isArray(a.moveQueue)||(a.moveQueue=[]),a.moveQueue.push({blockId:e,direction:t}),eg())}async function fs(e){e&&(await fc(e),Tn(e))}function Zn({restoreDom:e=!0}={}){let t=a.pendingTextPreview;if(t){if(e){let n=document.querySelector(`.block[data-block-id="${t.blockId}"] .block-text`);n&&(n.innerHTML=t.originalHTML)}a.pendingTextPreview=null}}async function mc(e,t,n={}){if(!e||!["up","down"].includes(t))return!1;let{skipRecord:r=!1,internal:o=!1,suppressRerender:i=!1}=n;try{let s=Je(e);if(t==="up"&&s&&s.parent){let l=s.siblings||a.article?.blocks||[];if((s.index??l.findIndex(u=>u.id===e))===0){let u=s.parent.id,m=Je(u),g=m?.siblings||a.article?.blocks||[],w=m?.index??g.findIndex(b=>b&&b.id===(m?.block?.id||u));if(w<=0)return!1;let y=g[w-1];if(!y||!y.id)return!1;let f=Array.isArray(y.children)?y.children.length:0,h=await hs(e,y.id,f,{skipRecord:!0,anchorId:null,placement:null,suppressRerender:i});return h.success?(a.currentBlockId=e,r||dn({type:"structure",action:{kind:"reorder",blockId:e,fromParentId:u,fromIndex:s.index??0,toParentId:y.id,toIndex:h.to?.index??f}}),!0):!1}}if(s&&a.article&&Array.isArray(a.article.blocks)){let l=s.siblings||a.article.blocks,d=s.index??l.findIndex(u=>u.id===e);if(d>=0){let u=d===0,m=d===l.length-1;if(t==="up"&&u||t==="down"&&m)return!1}}let c=null;if(s&&a.article&&Array.isArray(a.article.blocks)){let l=s.siblings||a.article.blocks,d=s.index??l.findIndex(u=>u.id===e);if(d>=0){let u=t==="up"?d-1:d+1;if(u>=0&&u<l.length){let[m]=l.splice(d,1);l.splice(u,0,m)}}if(a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}c=s.parent?.id||null}return a.currentBlockId=e,tg(e,t),i||gs(e,t)||(c?await xt(c):ot()),r||dn({type:"structure",action:{kind:"move",blockId:e,direction:t}}),!0}catch(s){return L(s.message),!1}}function Fu(e){return mc(a.currentBlockId,e)}async function hc(e){if(!a.article||!Array.isArray(a.article.blocks)||!["up","down"].includes(e))return!1;let t=Array.isArray(a.selectedBlockIds)?a.selectedBlockIds:[];if(t.length<=1)return Fu(e);if(a.isMovingBlock)return!1;let r=Sn(a.article.blocks).filter(c=>t.includes(c.id));if(r.length<=1)return Fu(e);let o=Je(r[0].id)?.parent?.id||null,i=[],s=!0;if(r.forEach((c,l)=>{let d=Je(c.id);if(!d){s=!1;return}if((d.parent?.id||null)!==o){s=!1;return}i.push(d.index)}),!s||!i.length)return L("\u041C\u043D\u043E\u0436\u0435\u0441\u0442\u0432\u0435\u043D\u043D\u043E\u0435 \u043F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u043F\u043E\u0434\u0440\u044F\u0434 \u0438\u0434\u0443\u0449\u0438\u0445 \u0431\u043B\u043E\u043A\u043E\u0432 \u0441 \u043E\u0434\u043D\u0438\u043C \u0440\u043E\u0434\u0438\u0442\u0435\u043B\u0435\u043C"),!1;i.sort((c,l)=>c-l);for(let c=1;c<i.length;c+=1)if(i[c]!==i[0]+c)return L("\u041C\u043D\u043E\u0436\u0435\u0441\u0442\u0432\u0435\u043D\u043D\u043E\u0435 \u043F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 \u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u043F\u043E\u0434\u0440\u044F\u0434 \u0438\u0434\u0443\u0449\u0438\u0445 \u0431\u043B\u043E\u043A\u043E\u0432"),!1;a.isMovingBlock=!0;try{let c=e==="up"?[...r]:[...r].reverse();for(let f of c)if(!await mc(f.id,e,{skipRecord:!0,internal:!0,suppressRerender:!0}))return L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438"),!1;let l=i[0],d=i[i.length-1],u=(o?Je(o)?.block.children:a.article.blocks)||[],m=o,g=o,w=l,y=e==="up"?l-1:d+1;return dn({type:"structure",action:{kind:"reorder",blockId:r[0].id,fromParentId:m,fromIndex:w,toParentId:g,toIndex:y}}),a.currentBlockId=r[0].id,o?await xt(o):ot(),!0}finally{a.isMovingBlock=!1}}async function hs(e,t=null,n=null,r={}){if(!e)return{success:!1};let{skipRecord:o=!1,anchorId:i=null,placement:s=null,suppressRerender:c=!1}=r,l=Je(e);if(!l)return L("\u0411\u043B\u043E\u043A \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D"),{success:!1};let d=l.parent?.id||null,u=l.index??0,m=t?Je(t)?.block:null,g=m?m.children?.length||0:(a.article?.blocks||[]).length,w=typeof n=="number"&&n>=0?Math.min(n,g):g;if(d===t&&u===w)return{success:!0,noOp:!0,from:{parentId:d,index:u},to:{parentId:t,index:w}};let y=w;t===d&&u<y&&(y=Math.max(y-1,0));try{let f=await Pe(`/api/articles/${a.articleId}/blocks/${e}/relocate`,{method:"POST",body:JSON.stringify({parentId:t||null,index:y,anchorId:i||null,placement:s||null})});if(a.article&&Array.isArray(a.article.blocks)){let b=l.siblings||a.article.blocks,S=l.index??b.findIndex(N=>N.id===e),x=null;S>=0&&([x]=b.splice(S,1)),x||(x=l.block);let v;if(t){let N=Je(t);N&&N.block?(Array.isArray(N.block.children)||(N.block.children=[]),v=N.block.children):v=a.article.blocks}else v=a.article.blocks;let B=typeof y=="number"&&y>=0?Math.min(y,v.length):v.length;if(v.splice(B,0,x),pc(x),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}a.currentBlockId=e;let h=f?.parentId??t??null;return c||(d&&h?(await xt(d),h!==d&&await xt(h)):d&&!h?ot():!d&&h?ot():ot()),o||dn({type:"structure",action:{kind:"reorder",blockId:e,fromParentId:d,fromIndex:u,toParentId:f?.parentId??t??null,toIndex:f?.index??y}}),await fs(e),{success:!0,from:{parentId:d,index:u},to:{parentId:f?.parentId??t??null,index:f?.index??y}}}catch(f){return L(f.message),{success:!1}}}async function gc(e,t={}){if(!e)return!1;let{skipRecord:n=!1,keepEditing:r=!1,suppressRerender:o=!1}=t;try{if(!t.internal){if(a.isMovingBlock)return!1;a.isMovingBlock=!0}r&&(a.pendingEditBlockId=e,a.scrollTargetBlockId=e);let i=Je(e),s=i?.parent?.id||null;if(await Pe(`/api/articles/${a.articleId}/blocks/${e}/indent`,{method:"POST",body:JSON.stringify({})}),i&&a.article&&Array.isArray(a.article.blocks)){let c=i.siblings||a.article.blocks,l=i.index??c.findIndex(d=>d.id===e);if(l>0){let d=c[l-1],[u]=c.splice(l,1);if(Array.isArray(d.children)||(d.children=[]),d.children.push(u),pc(u),d.collapsed){d.collapsed=!1;try{await Pe(`/api/articles/${a.articleId}/collapse`,{method:"PATCH",body:JSON.stringify({blockId:d.id,collapsed:!1})})}catch{}}if(a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}}return a.currentBlockId=e,r&&(a.mode="edit",a.editingBlockId=e),o||(s?await xt(s):ot()),n||dn({type:"structure",action:{kind:"indent",blockId:e}}),!0}catch(i){return L(i.message),!1}finally{t.internal||(a.isMovingBlock=!1)}}function ps(e={}){return gc(a.currentBlockId,e)}async function Yu(e={}){if(!a.article||!Array.isArray(a.article.blocks))return!1;let t=Array.isArray(a.selectedBlockIds)?a.selectedBlockIds:[];if(t.length<=1)return ps(e);if(a.isMovingBlock)return!1;let r=Sn(a.article.blocks).filter(u=>t.includes(u.id));if(r.length<=1)return ps(e);let o=Je(r[0].id);if(!o||!o.siblings)return!1;let i=o.siblings;if((o.index??i.findIndex(u=>u.id===o.block.id))<=0)return L("\u041D\u0435\u043B\u044C\u0437\u044F \u0443\u0432\u0435\u043B\u0438\u0447\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u043D\u043E\u0441\u0442\u044C \u043F\u0435\u0440\u0432\u043E\u0439 \u0433\u0440\u0443\u043F\u043F\u044B \u0431\u043B\u043E\u043A\u043E\u0432"),!1;let c=o.parent?.id||null,l=[],d=!0;if(r.forEach(u=>{let m=Je(u.id);if(!m){d=!1;return}if((m.parent?.id||null)!==c){d=!1;return}l.push(m.index)}),!d||!l.length)return L("\u041C\u043D\u043E\u0436\u0435\u0441\u0442\u0432\u0435\u043D\u043D\u044B\u0439 \u043E\u0442\u0441\u0442\u0443\u043F \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u043F\u043E\u0434\u0440\u044F\u0434 \u0438\u0434\u0443\u0449\u0438\u0445 \u0431\u043B\u043E\u043A\u043E\u0432 \u0441 \u043E\u0434\u043D\u0438\u043C \u0440\u043E\u0434\u0438\u0442\u0435\u043B\u0435\u043C"),!1;l.sort((u,m)=>u-m);for(let u=1;u<l.length;u+=1)if(l[u]!==l[0]+u)return L("\u041C\u043D\u043E\u0436\u0435\u0441\u0442\u0432\u0435\u043D\u043D\u044B\u0439 \u043E\u0442\u0441\u0442\u0443\u043F \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u043F\u043E\u0434\u0440\u044F\u0434 \u0438\u0434\u0443\u0449\u0438\u0445 \u0431\u043B\u043E\u043A\u043E\u0432"),!1;a.isMovingBlock=!0;try{for(let u of r)if(!await gc(u.id,{...e,skipRecord:!0,internal:!0,suppressRerender:!0}))return L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u043D\u043E\u0441\u0442\u044C \u0431\u043B\u043E\u043A\u043E\u0432"),!1;return dn({type:"structure",action:{kind:"indent",blockId:r[0].id}}),a.currentBlockId=r[0].id,c?await xt(c):ot(),!0}finally{a.isMovingBlock=!1}}async function yc(e,t={}){if(!e)return!1;let{skipRecord:n=!1,keepEditing:r=!1,suppressRerender:o=!1}=t;try{if(!t.internal){if(a.isMovingBlock)return!1;a.isMovingBlock=!0}r&&(a.pendingEditBlockId=e,a.scrollTargetBlockId=e);let i=Je(e);await Pe(`/api/articles/${a.articleId}/blocks/${e}/outdent`,{method:"POST",body:JSON.stringify({})});let s=null;if(i&&a.article&&Array.isArray(a.article.blocks)){let c=i.parent||null,d=(c?Je(c.id):null)?.parent||null;s=d?.id||null;let u=i.siblings||(c?c.children||[]:a.article.blocks),m=i.index??u.findIndex(h=>h.id===e),g=null;m>=0&&([g]=u.splice(m,1)),g||(g=i.block);let w;d?(Array.isArray(d.children)||(d.children=[]),w=d.children):w=a.article.blocks;let y=c?w.indexOf(c):-1,f=y>=0?y+1:w.length;if(w.splice(f,0,g),pc(g),a.article.updatedAt)try{a.article.updatedAt=new Date().toISOString()}catch{}}return a.currentBlockId=e,r&&(a.mode="edit",a.editingBlockId=e),o||(s?await xt(s):ot()),n||dn({type:"structure",action:{kind:"outdent",blockId:e}}),!0}catch(i){return L(i.message),!1}finally{t.internal||(a.isMovingBlock=!1)}}function ms(e={}){return yc(a.currentBlockId,e)}async function Xu(e={}){if(!a.article||!Array.isArray(a.article.blocks))return!1;let t=Array.isArray(a.selectedBlockIds)?a.selectedBlockIds:[];if(t.length<=1)return ms(e);if(a.isMovingBlock)return!1;let r=Sn(a.article.blocks).filter(l=>t.includes(l.id));if(r.length<=1)return ms(e);let o=Je(r[0].id);if(!o||!o.parent)return L("\u041D\u0435\u043B\u044C\u0437\u044F \u0443\u043C\u0435\u043D\u044C\u0448\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u043D\u043E\u0441\u0442\u044C \u043A\u043E\u0440\u043D\u0435\u0432\u044B\u0445 \u0431\u043B\u043E\u043A\u043E\u0432"),!1;let i=o.parent.id,s=[],c=!0;if(r.forEach(l=>{let d=Je(l.id);if(!d||!d.parent){c=!1;return}if(d.parent.id!==i){c=!1;return}s.push(d.index)}),!c||!s.length)return L("\u041C\u043D\u043E\u0436\u0435\u0441\u0442\u0432\u0435\u043D\u043D\u044B\u0439 \u043E\u0442\u0441\u0442\u0443\u043F \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u043F\u043E\u0434\u0440\u044F\u0434 \u0438\u0434\u0443\u0449\u0438\u0445 \u0431\u043B\u043E\u043A\u043E\u0432 \u0441 \u043E\u0434\u043D\u0438\u043C \u0440\u043E\u0434\u0438\u0442\u0435\u043B\u0435\u043C"),!1;s.sort((l,d)=>l-d);for(let l=1;l<s.length;l+=1)if(s[l]!==s[0]+l)return L("\u041C\u043D\u043E\u0436\u0435\u0441\u0442\u0432\u0435\u043D\u043D\u044B\u0439 \u043E\u0442\u0441\u0442\u0443\u043F \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0442\u043E\u043B\u044C\u043A\u043E \u0434\u043B\u044F \u043F\u043E\u0434\u0440\u044F\u0434 \u0438\u0434\u0443\u0449\u0438\u0445 \u0431\u043B\u043E\u043A\u043E\u0432"),!1;a.isMovingBlock=!0;try{let l=[...r].reverse();for(let m of l)if(!await yc(m.id,{...e,skipRecord:!0,internal:!0,suppressRerender:!0}))return L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u043D\u043E\u0441\u0442\u044C \u0431\u043B\u043E\u043A\u043E\u0432"),!1;dn({type:"structure",action:{kind:"outdent",blockId:r[0].id}}),a.currentBlockId=r[0].id;let u=Je(r[0].id)?.parent?.id||null;return u?await xt(u):ot(),!0}finally{a.isMovingBlock=!1}}var Kn=Fe(()=>{mt();Ft();Nt();Qn();Qn();ln();vn();$o()});function ng(){let e=a?.currentUser||null;return e&&(e.id||e.username)||"anon"}async function ys(){return Ai({userKey:ng()})}async function Qu(e={}){let t=String(e?.token||"").trim(),n=String(e?.articleId||"").trim();if(!t||!n)return!1;let r=String(e?.kind||"image"),o=e?.blob||null,i=String(e?.mime||o&&o.type||"").trim(),s=String(e?.fileName||"").trim()||null,c=Date.now(),d=(await ys()).transaction(["pending_uploads"],"readwrite"),u=d.objectStore("pending_uploads"),m=await ve(u.get(t)).catch(()=>null),g=Number(m?.createdAtMs||e?.createdAtMs||c)||c,w={token:t,articleId:n,kind:r,blob:o,mime:i,fileName:s,status:String(e?.status||m?.status||"pending"),errorMessage:String(e?.errorMessage||m?.errorMessage||""),createdAtMs:g,updatedAtMs:c};return await ve(u.put(w)),await ze(d),!0}async function bc(e){let t=String(e||"").trim();if(!t)return!1;let r=(await ys()).transaction(["pending_uploads"],"readwrite"),o=r.objectStore("pending_uploads");return await ve(o.delete(t)),await ze(r),!0}async function wc(e,t){let n=String(e||"").trim();if(!n)return!1;let o=(await ys()).transaction(["pending_uploads"],"readwrite"),i=o.objectStore("pending_uploads"),s=await ve(i.get(n)).catch(()=>null);return s?(s.status="error",s.errorMessage=String(t||"error"),s.updatedAtMs=Date.now(),await ve(i.put(s)),await ze(o),!0):(await ze(o),!1)}async function Sc({articleId:e=null,limit:t=50}={}){let r=(await ys()).transaction(["pending_uploads"],"readonly"),o=r.objectStore("pending_uploads"),i=[];try{let s=Number(t||0)||0;if(e){let c=o.index("byArticleId");i=await ve(c.getAll(String(e),s>0?s:void 0))}else i=await ve(o.getAll(s>0?s:void 0))}catch{i=[]}return await ze(r),Array.isArray(i)?(i.sort((s,c)=>Number(s?.createdAtMs||0)-Number(c?.createdAtMs||0)),i):[]}var Zu=Fe(()=>{mt();aa();Pn()});var bs,ef=Fe(()=>{bs=["pending-attachment","app","disk"]});function xc(e){let n=String(e||"").replace(/\r\n/g,`
`).split(`
`),r=l=>{let d=String(l||"").match(/^(#{1,6})\s+(.*)$/);if(!d)return null;let u=String(d[2]||"").trim();return u?{level:d[1].length,title:u}:null},o=!1;try{let l=n.find(d=>String(d||"").trim().length>0)||"";o=!!r(l)}catch{o=!1}let i=[],s=null,c=()=>{if(s){try{for(;s.bodyLines.length&&!String(s.bodyLines[0]||"").trim();)s.bodyLines.shift()}catch{}s.bodyText=s.bodyLines.join(`
`).trimEnd(),delete s.bodyLines,i.push(s),s=null}};for(let l of n){let d=r(l);if(d){c(),s={level:d.level,title:d.title,bodyLines:[]};continue}s&&s.bodyLines.push(l)}return c(),{sections:i,startsWithHeading:o,headingCount:i.length}}function tf(e,t={}){let n=Array.isArray(e)?e.filter(Boolean):[],r=typeof t.makeId=="function"?t.makeId:()=>`${Date.now()}-${Math.random()}`;if(!n.length)return[];let o=Number.isFinite(t.baseLevel)?t.baseLevel:Number(n[0].level||1),i=[],s=[];for(let c of n){let l=Number(c.level||1),d=String(c.title||"").trim(),u=String(c.bodyText||"").trimEnd();if(!d)continue;let m=Math.max(0,l-o);for(;s.length>m;)s.pop();m>s.length&&(m=s.length);let g={id:r(),title:d,bodyText:u,children:[]},w=m>0?s[m-1]:null;w?w.children.push(g):i.push(g),s.push(g)}return i}var nf=Fe(()=>{});var Ss={};Wn(Ss,{addPendingQuickNote:()=>ig,buildOutlineSectionFromPlainText:()=>Ac,enqueuePendingQuickNotesForSync:()=>lg,overlayPendingQuickNotesIntoInboxDocJson:()=>ag,readPendingQuickNotes:()=>ws,refreshInboxCacheFromServer:()=>Ic,removePendingQuickNoteBySectionId:()=>kc});function rg(){return globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?globalThis.crypto.randomUUID():`id-${Date.now()}-${Math.random().toString(16).slice(2)}`}function og(){return new Date().toISOString()}function ws(){try{let e=window?.localStorage?.getItem?.(of)||"";if(!e)return[];let t=JSON.parse(e);return Array.isArray(t)?t.filter(Boolean):[]}catch{return[]}}function sf(e){try{window?.localStorage?.setItem?.(of,JSON.stringify(Array.isArray(e)?e:[]))}catch{}}function ig(e){let t=String(e||"").trim();if(!t)return null;let n=rg(),r={id:n,sectionId:n,createdAt:og(),text:t},o=ws();return o.unshift(r),sf(o),r}function kc(e){let t=String(e||"").trim();if(!t)return!1;let n=ws(),r=n.filter(o=>String(o?.sectionId||o?.id||"")!==t);return r.length===n.length?!1:(sf(r),!0)}function sg(e){let n=String(e||"").trim().split(/\r?\n/),r=[];for(let o=0;o<n.length;o+=1){let i=n[o];i&&r.push({type:"text",text:i}),o!==n.length-1&&r.push({type:"hardBreak"})}return r.length?r:null}function Ac({sectionId:e,text:t}={}){let n=String(e||"").trim();if(!n)return null;let r=sg(t);return{type:"outlineSection",attrs:{id:n,collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[r?{type:"paragraph",content:r}:{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}}function ag(e,t){let n=e&&typeof e=="object"?e:{type:"doc",content:[]},r=Array.isArray(n.content)?n.content:[],o=new Set(r.filter(c=>c&&c.type==="outlineSection"&&c.attrs&&c.attrs.id).map(c=>String(c.attrs.id))),i=Array.isArray(t)?t:[];if(!i.length)return{docJson:n,added:0};let s=[];for(let c of i){let l=String(c?.sectionId||c?.id||"").trim();if(!l||o.has(l))continue;let d=Ac({sectionId:l,text:c?.text||""});d&&s.push(d)}return s.length?{docJson:{...n,type:n.type||"doc",content:[...s,...r]},added:s.length}:{docJson:n,added:0}}function cg(e,t){try{let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return 1;let o=window.localStorage.getItem(rf)||"",i=o?JSON.parse(o):{},s=i&&typeof i=="object"?i:{},c=(s[n]&&typeof s[n]=="object"?s[n]:{})||{},d=(Number(c[r]||0)||0)+1;return c[r]=d,s[n]=c,window.localStorage.setItem(rf,JSON.stringify(s)),d}catch{return Date.now()}}async function lg(){let e=ws();if(!e.length)return{status:"empty"};let t=e.slice().sort((r,o)=>Date.parse(String(r?.createdAt||""))-Date.parse(String(o?.createdAt||""))),n=0;for(let r of t){let o=String(r?.sectionId||r?.id||"").trim(),i=String(r?.text||"").trim();if(!o||!i)continue;let s=Ac({sectionId:o,text:i});if(!s)continue;let c=s.content?.[0]||{type:"outlineHeading",content:[]},l=s.content?.[1]||{type:"outlineBody",content:[{type:"paragraph"}]},d=cg("inbox",o);await $t("section_upsert_content",{articleId:"inbox",payload:{sectionId:o,headingJson:c,bodyJson:l,seq:d,opId:o},coalesceKey:`content:inbox:${o}`}),n+=1}return{status:"enqueued",count:n}}async function dg(){let e=await fetch("/api/articles/inbox?include_history=0",{method:"GET",credentials:"include"});if(e.status===401||e.status===403){let t=new Error("auth");throw t.status=e.status,t}if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()}async function Ic(){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return{status:"offline"};let e=await dg(),t=new Date().toISOString();try{e?.docJson&&typeof e.docJson=="object"&&await yn("inbox",e.docJson,t)}catch{}return{status:"refreshed",updatedAt:e?.updatedAt||null,docJson:e?.docJson||null}}var of,rf,mo=Fe(()=>{to();Lo();of="ttree_pending_quick_notes_v1",rf="ttree_outline_section_seq_v1"});var mf={};Wn(mf,{flushOutboxOnce:()=>ho,getBackgroundFullPullStatus:()=>Bc,startBackgroundFullPull:()=>ri,startSyncLoop:()=>Mc,tryPullBootstrap:()=>Lc});function ug(e,t=null){try{if(!e)return;let n=window.localStorage.getItem(xs)||"";if(!n)return;let r=JSON.parse(n);if(!r||typeof r!="object")return;let o=String(e),i=r[o]||null;if(!i)return;let s=Number(i?.queuedAt||0)||0,c=typeof t=="number"&&Number.isFinite(t)?t:null;if(c!=null&&s>c)return;delete r[o],window.localStorage.setItem(xs,JSON.stringify(r))}catch{}}function mg(e,t){try{let n=e&&typeof e=="object"?e:{type:"doc",content:[]},r=Array.isArray(n.content)?n.content:[],o=new Map,i=u=>{if(Array.isArray(u))for(let m of u){if(!m||typeof m!="object"||m.type!=="outlineSection")continue;let g=String(m?.attrs?.id||"").trim();g&&o.set(g,m);let y=(Array.isArray(m.content)?m.content:[]).find(f=>f&&typeof f=="object"&&f.type==="outlineChildren")||null;y&&Array.isArray(y.content)&&i(y.content)}};i(r);let s=(u,m)=>{let g=u&&typeof u=="object"?u:{type:"outlineSection",attrs:{id:m,collapsed:!1},content:[]};g.type="outlineSection";let w=g.attrs&&typeof g.attrs=="object"?g.attrs:{};w.id=m,g.attrs=w;let y=Array.isArray(g.content)?g.content:[],f=y.find(S=>S&&typeof S=="object"&&S.type==="outlineHeading")||{type:"outlineHeading",content:[]},h=y.find(S=>S&&typeof S=="object"&&S.type==="outlineBody")||{type:"outlineBody",content:[{type:"paragraph"}]},b=y.find(S=>S&&typeof S=="object"&&S.type==="outlineChildren")||{type:"outlineChildren",content:[]};return Array.isArray(b.content)||(b={...b,content:[]}),g.content=[f,h,b],g},c=new Set,l=new Map;for(let u of Array.isArray(t)?t:[]){let m=String(u?.sectionId||"").trim();if(!m)continue;let g=u?.parentId,w=g!=null&&String(g).trim()?String(g).trim():null,y=Number.isFinite(Number(u?.position))?Number(u.position):0,f=!!u?.collapsed,h=s(o.get(m),m);h.attrs={...h.attrs||{},id:m,collapsed:f},o.set(m,h),c.add(m),l.has(w)||l.set(w,[]),l.get(w).push({pos:y,sid:m,sec:h})}for(let[u,m]of l.entries())m.sort((g,w)=>g.pos-w.pos||String(g.sid).localeCompare(String(w.sid))),l.set(u,m);for(let[u,m]of o.entries()){let w=(l.get(u)||[]).map(y=>y.sec);try{Array.isArray(m.content)||(m.content=[]),(!m.content[2]||m.content[2].type!=="outlineChildren")&&(m.content[2]={type:"outlineChildren",content:[]}),m.content[2].content=w}catch{}}let d=(l.get(null)||[]).map(u=>u.sec);for(let[u,m]of o.entries())c.has(u)||d.push(m);return n.type="doc",n.content=d,n}catch{return e}}function hg(e,t,n,r){try{let o=String(t||"").trim();if(!o)return e;let i=e&&typeof e=="object"?e:{type:"doc",content:[]},s=[i];for(;s.length;){let c=s.pop();if(!c||typeof c!="object")continue;if(c.type==="outlineSection"&&String(c?.attrs?.id||"").trim()===o){let u=(Array.isArray(c.content)?c.content:[]).find(m=>m&&typeof m=="object"&&m.type==="outlineChildren")||{type:"outlineChildren",content:[]};return c.content=[n,r,u],i}let l=c.content;if(Array.isArray(l))for(let d of l)s.push(d)}return i}catch{return e}}function Cc(e){let t=e?.type||"";return t==="section_upsert_content"||t==="delete_sections"||t==="structure_snapshot"}function gg(e,t,n){try{let r=String(e||"").trim(),o=String(t||"").trim(),i=Number(n);if(!r||!o||!Number.isFinite(i)||i<=0)return;let s="ttree_outline_section_seq_v1",c=window.localStorage.getItem(s)||"",l=c?JSON.parse(c):{},d=l&&typeof l=="object"?l:{},u=(d[r]&&typeof d[r]=="object"?d[r]:{})||{};if((Number(u[o]||0)||0)>=i)return;u[o]=i,d[r]=u,window.localStorage.setItem(s,JSON.stringify(d))}catch{}}function yg(e){let t=[],n=(i,s)=>{if(!Array.isArray(i))return;let c=0;for(let l of i){if(!l||typeof l!="object"||l.type!=="outlineSection")continue;let d=String(l?.attrs?.id||"").trim();if(!d)continue;t.push({sectionId:d,parentId:s||null,position:c,collapsed:!!l?.attrs?.collapsed}),c+=1;let m=(Array.isArray(l.content)?l.content:[]).find(w=>w&&typeof w=="object"&&w.type==="outlineChildren")||null,g=m&&Array.isArray(m.content)?m.content:[];n(g,d)}},r=e&&typeof e=="object"?e:null,o=r&&Array.isArray(r.content)?r.content:[];return n(o,null),t}function bg(e,t){try{let n=e&&typeof e=="object"?{...e}:null;if(!n||n.type!=="outlineHeading")return e;let r=String(t||"");if(!r)return e;let o=Array.isArray(n.content)?[...n.content]:[];return o.unshift({type:"text",text:r}),n.content=o,n}catch{return e}}function wg(e,t,n){let r=e&&typeof e=="object"?e:{type:"doc",content:[]};Array.isArray(r.content)||(r.content=[]);let o=String(t||"").trim(),i=c=>{for(let l=0;l<c.length;l+=1){let d=c[l];if(!d||typeof d!="object"||d.type!=="outlineSection")continue;let u=String(d?.attrs?.id||"").trim();if(o&&u===o)return c.splice(l+1,0,n),!0;let g=(Array.isArray(d.content)?d.content:[]).find(w=>w&&typeof w=="object"&&w.type==="outlineChildren")||null;if(g&&Array.isArray(g.content)&&i(g.content))return!0}return!1};return i(r.content)||r.content.push(n),r}function Sg(){try{return window?.localStorage?.getItem?.("ttree_debug_offline_v1")==="1"}catch{return!1}}function uf(...e){try{if(!Sg())return;console.log("[offline][queue]",...e)}catch{}}function pf(){try{let e=window.localStorage.getItem(xs)||"";if(!e)return{changed:!1,removed:0};let t=JSON.parse(e);if(!t||typeof t!="object")return{changed:!1,removed:0};let n=Object.keys(t);if(!n.length)return{changed:!1,removed:0};let r=0;for(let o of n)o!=="inbox"&&(delete t[o],r+=1);return r?(window.localStorage.setItem(xs,JSON.stringify(t)),uf("prune.queue",{removed:r}),{changed:!0,removed:r}):{changed:!1,removed:0}}catch(e){return uf("prune.queue.error",{message:e?.message||String(e||"error")}),{changed:!1,removed:0}}}function Er(){try{window.dispatchEvent(new CustomEvent("offline-full-pull-status",{detail:{...Ot}}))}catch{}}function Bc(){return{...Ot}}async function un(e,t={}){let n=await fetch(e,{headers:{"Content-Type":"application/json",...t.headers||{}},credentials:"include",...t});if(!n.ok){let r=await n.json().catch(()=>({})),o=new Error(r.detail||"Request failed");throw o.status=n.status,o.details=r,o.path=e,o}return n.status===204?null:n.json()}function ff(e){let t=Number(e?.status||0);return!t||t>=500||t===408||t===429||t===401||t===403}function xg(e,t){let n=Number(e?.status||0);return n===404||n===410?!0:n>=400&&n<500&&n!==401&&n!==403&&n!==408&&n!==429?t?.type==="save_doc_json"||String(t?.type||"").startsWith("section_")||t?.type==="structure_snapshot"||t?.type==="delete_sections":!1}async function Lc(){try{let e=await In();return Xn(e).catch(()=>{}),Array.isArray(e)?e:[]}catch{return null}}function kg(e,t){try{let n=new Set((Array.isArray(t)?t:[]).map(i=>String(i||"").trim()).filter(Boolean));if(!n.size)return e;let r=e&&typeof e=="object"?e:{type:"doc",content:[]},o=i=>{if(!Array.isArray(i))return[];let s=[];for(let c of i)if(!(!c||typeof c!="object")){if(c.type==="outlineSection"){let l=String(c?.attrs?.id||"").trim();if(l&&n.has(l))continue;let u=(Array.isArray(c.content)?c.content:[]).find(m=>m&&typeof m=="object"&&m.type==="outlineChildren")||null;u&&Array.isArray(u.content)&&(u.content=o(u.content))}s.push(c)}return s};return Array.isArray(r.content)?r.content=o(r.content):r.content=[],r.type=r.type||"doc",r}catch{return e}}async function Ag(e){if(e.type==="create_article"){let t=e.payload?.title||"\u041D\u043E\u0432\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F",n=e.payload?.id||e.articleId,r=await un("/api/articles",{method:"POST",body:JSON.stringify({title:t,id:n})});await wr(r);return}if(e.type==="save_doc_json"){let t=e.payload?.docJson||null;if(!t||typeof t!="object")return;let n=await un(`/api/articles/${encodeURIComponent(e.articleId)}/doc-json/save`,{method:"PUT",body:JSON.stringify({docJson:t,createVersionIfStaleHours:12})}),r=n?.updatedAt||null;await yn(e.articleId,t,r);try{ct("sync.flush.save_doc_json.ok",{articleId:e.articleId,opId:e.id,updatedAt:r,docHash:Kt(t)})}catch{}try{let o=Array.isArray(n?.changedBlockIds)?n.changedBlockIds:[],i=Array.isArray(n?.removedBlockIds)?n.removedBlockIds:[];if(i.length&&await Pi(i),o.length){let s=await un(`/api/articles/${encodeURIComponent(e.articleId)}/embeddings?ids=${encodeURIComponent(o.join(","))}`);await ga(e.articleId,s?.embeddings||[])}}catch{}return}if(e.type==="section_upsert_content"){let t=e.payload?.sectionId||null,n=e.payload?.headingJson||null,r=e.payload?.bodyJson||null,o=e.payload?.seq||null;if(!t||!n||!r||!o)return;let i=await un(`/api/articles/${encodeURIComponent(e.articleId)}/sections/upsert-content`,{method:"PUT",body:JSON.stringify({opId:e.payload?.opId||e.id,sectionId:t,headingJson:n,bodyJson:r,seq:o,createVersionIfStaleHours:12})});try{if(i?.updatedAt){let s=await Gn(e.articleId).catch(()=>null),c=s?.docJson&&typeof s.docJson=="object"?s.docJson:null;if(c){let l=hg(c,t,n,r);await yn(e.articleId,l,i.updatedAt)}}try{ct("sync.flush.section_upsert_content.ok",{articleId:e.articleId,opId:e.id,sectionId:t,updatedAt:i?.updatedAt||null})}catch{}}catch{}return}if(e.type==="structure_snapshot"){let t=e.payload?.nodes||null;if(!Array.isArray(t)||!t.length)return;let n=await un(`/api/articles/${encodeURIComponent(e.articleId)}/structure/snapshot`,{method:"PUT",body:JSON.stringify({opId:e.payload?.opId||e.id,nodes:t})});try{if(n?.updatedAt){let r=await Gn(e.articleId).catch(()=>null),o=r?.docJson&&typeof r.docJson=="object"?r.docJson:null;if(o){let i=mg(o,t);await yn(e.articleId,i,n.updatedAt)}}try{ct("sync.flush.structure_snapshot.ok",{articleId:e.articleId,opId:e.id,updatedAt:n?.updatedAt||null,nodesCount:Array.isArray(t)?t.length:null})}catch{}}catch{}return}if(e.type==="delete_sections"){let t=Array.isArray(e.payload?.sectionIds)?e.payload.sectionIds:[];if(!t.length)return;let n=await md(e.articleId,t,{opId:e.payload?.opId||e.id});try{let r=n?.updatedAt||null,o=await Gn(e.articleId).catch(()=>null),i=o?.docJson&&typeof o.docJson=="object"?o.docJson:null;if(i&&r){let c=kg(i,t);await yn(e.articleId,c,r)}let s=Array.isArray(n?.removedBlockIds)?n.removedBlockIds:[];s.length&&await Pi(s),ct("sync.flush.delete_sections.ok",{articleId:e.articleId,opId:e.id,updatedAt:r||null,sectionIdsCount:t.length,removedCount:s.length})}catch{}return}if(e.type==="move_article_position"){let t=e.payload?.direction||null;if(!t)return;await un(`/api/articles/${encodeURIComponent(e.articleId)}/move`,{method:"POST",body:JSON.stringify({direction:t})});return}if(e.type==="indent_article"){await un(`/api/articles/${encodeURIComponent(e.articleId)}/indent`,{method:"POST",body:JSON.stringify({})});return}if(e.type==="outdent_article"){await un(`/api/articles/${encodeURIComponent(e.articleId)}/outdent`,{method:"POST",body:JSON.stringify({})});return}if(e.type==="move_article_tree"){await un(`/api/articles/${encodeURIComponent(e.articleId)}/move-tree`,{method:"POST",body:JSON.stringify(e.payload||{})});return}}async function Ig(e){try{if(!e||!e.articleId||!(e.type==="save_doc_json"||e.type==="section_upsert_content"||e.type==="structure_snapshot"||e.type==="delete_sections"))return;let n=e.payload?.clientQueuedAt??null;if(typeof n!="number"||!Number.isFinite(n)||(await _r(500)||[]).some(i=>i&&i.articleId===e.articleId&&(i.type==="save_doc_json"||i.type==="section_upsert_content"||i.type==="structure_snapshot")&&(i.payload?.clientQueuedAt??null)===n))return;ug(e.articleId,n)}catch{}}async function vg(e,t){let n=String(e||"").trim();if(n)for(let r of t||[])try{let o=String(r?.sectionId||"").trim(),i=r?.headingJson||null,s=r?.bodyJson||null;if(!o||!i||!s)continue;let c=globalThis.crypto?.randomUUID?.()||`conflict-${Date.now()}-${Math.random().toString(16).slice(2)}`,l=await Gn(n).catch(()=>null),d=l?.docJson&&typeof l.docJson=="object"?l.docJson:null,u=bg(i,"\u041A\u043E\u043D\u0444\u043B\u0438\u043A\u0442\u043D\u0430\u044F \u043A\u043E\u043F\u0438\u044F: "),g=wg(d||{type:"doc",content:[]},o,{type:"outlineSection",attrs:{id:c,collapsed:!1,isConflictCopy:!0},content:[u||{type:"outlineHeading",content:[]},s||{type:"outlineBody",content:[{type:"paragraph"}]},{type:"outlineChildren",content:[]}]});await yn(n,g,l?.updatedAt||null).catch(()=>{}),gg(n,c,1);let w=Date.now();await $t("section_upsert_content",{articleId:n,payload:{sectionId:c,headingJson:u,bodyJson:s,seq:1,clientQueuedAt:w},coalesceKey:`content:${n}:${c}`}).catch(()=>{});let y=yg(g);y.length&&await $t("structure_snapshot",{articleId:n,payload:{nodes:y,clientQueuedAt:w},coalesceKey:`structure:${n}`}).catch(()=>{});try{window.dispatchEvent(new CustomEvent("outline-sync-conflict",{detail:{articleId:n,sectionId:o,conflictCopySectionId:c}}))}catch{}}catch{}}async function Eg(e,t){let n=String(e||"").trim();if(!n)return;let r=Date.now(),o=Number(lf.get(n)||0)||0;if(o&&r-o<fg)return;lf.set(n,r);let i=async()=>{let f=await _r(200),h=[],b=[],S=[];for(let x of f||[])!x||String(x.articleId||"")!==n||(x.type==="delete_sections"?h.push(x):x.type==="section_upsert_content"?b.push(x):x.type==="structure_snapshot"&&S.push(x));return{deleteOps:h,upsertOps:b,structureOps:S}},s=0,c=[],l=[],d=[];try{({deleteOps:c,upsertOps:l,structureOps:d}=await i())}catch{c=[],l=[],d=[];for(let f of t||[])!f||String(f.articleId||"")!==n||(f.type==="delete_sections"?c.push(f):f.type==="section_upsert_content"?l.push(f):f.type==="structure_snapshot"&&d.push(f))}let u=new Set;for(let f of c){let h=Array.isArray(f.payload?.sectionIds)?f.payload.sectionIds:[];for(let b of h){let S=String(b||"").trim();S&&u.add(S)}}if(u.size&&l.length)for(let f of l)try{let h=String(f.payload?.sectionId||"").trim();h&&u.has(h)&&await Sr(f.id)}catch{}let m=c.map(f=>{let h=Array.isArray(f.payload?.sectionIds)?f.payload.sectionIds:[];return{opId:f.payload?.opId||f.id,sectionIds:h.filter(Boolean).map(b=>String(b)),_outboxId:f.id}}).filter(f=>f.sectionIds.length),g=l.map(f=>{let h=String(f.payload?.sectionId||"").trim();return!h||u.has(h)?null:{opId:f.payload?.opId||f.id,sectionId:h,headingJson:f.payload?.headingJson||null,bodyJson:f.payload?.bodyJson||null,seq:f.payload?.seq||null,clientQueuedAt:f.payload?.clientQueuedAt??null,_outboxId:f.id}}).filter(Boolean),w=async()=>{let f=c.map(z=>{let P=Array.isArray(z.payload?.sectionIds)?z.payload.sectionIds:[];return{opId:z.payload?.opId||z.id,sectionIds:P.filter(Boolean).map(W=>String(W)),_outboxId:z.id}}).filter(z=>z.sectionIds.length),h=l.map(z=>{let P=String(z.payload?.sectionId||"").trim();return!P||u.has(P)?null:{opId:z.payload?.opId||z.id,sectionId:P,headingJson:z.payload?.headingJson||null,bodyJson:z.payload?.bodyJson||null,seq:z.payload?.seq||null,clientQueuedAt:z.payload?.clientQueuedAt??null,_outboxId:z.id}}).filter(Boolean),b=new Map;for(let z of f)b.set(String(z.opId),z._outboxId);for(let z of h)b.set(String(z.opId),z._outboxId);if(!f.length&&!h.length)return!1;try{ct("sync.flush.outline_compact.start",{articleId:n,deletesCount:f.length,upsertsCount:h.length})}catch{}let S=await un(`/api/articles/${encodeURIComponent(n)}/sync/compact`,{method:"PUT",body:JSON.stringify({deletes:f.map(({opId:z,sectionIds:P})=>({opId:z,sectionIds:P})),upserts:h.map(({opId:z,sectionId:P,headingJson:W,bodyJson:q,seq:ee})=>({opId:z,sectionId:P,headingJson:W,bodyJson:q,seq:ee}))})}),x=S?.updatedAt||null;x&&await pa(n,x).catch(()=>{});try{ct("sync.flush.outline_compact.ok",{articleId:n,updatedAt:x||null,deleteAcks:Array.isArray(S?.deleteAcks)?S.deleteAcks.length:null,upsertAcks:Array.isArray(S?.upsertAcks)?S.upsertAcks.length:null})}catch{}let v=Array.isArray(S?.deleteAcks)?S.deleteAcks:[];for(let z of v){let P=String(z?.opId||"").trim();if(!P)continue;let W=b.get(P)||P;await Sr(W).catch(()=>{});try{let q=Array.isArray(z?.removedBlockIds)?z.removedBlockIds:[];q.length&&await Pi(q)}catch{}}let B=[],N=Array.isArray(S?.upsertAcks)?S.upsertAcks:[];for(let z of N){let P=String(z?.opId||"").trim(),W=String(z?.sectionId||"").trim();if(!P||!W)continue;let q=b.get(P)||P,ee=String(z?.result||"").trim();if(ee==="ok"||ee==="duplicate")await Sr(q).catch(()=>{});else if(ee==="conflict"){await Sr(q).catch(()=>{});let de=h.find(Le=>String(Le.opId)===P)||null;de&&B.push({sectionId:W,headingJson:de.headingJson,bodyJson:de.bodyJson})}}return B.length&&await vg(n,B),!0};for(;s<2&&(s+=1,!!await w());)try{({deleteOps:c,upsertOps:l,structureOps:d}=await i())}catch{break}let y=null;try{({deleteOps:c,upsertOps:l,structureOps:d}=await i())}catch{}if(!c.length&&!l.length&&(y=d.length?d[d.length-1]:null),y){try{let h=Number(df.get(n)||0)||0,b=Date.now();if(h&&b-h<pg)return}catch{}let f=y.payload?.nodes||null;if(Array.isArray(f)&&f.length){let h=await Gn(n).catch(()=>null),b=null;try{if(h&&Object.prototype.hasOwnProperty.call(h,"outlineStructureRev")){let B=Number(h.outlineStructureRev);Number.isFinite(B)&&B>=0&&(b=B)}}catch{b=null}try{ct("sync.flush.structure_snapshot.start",{articleId:n,opId:y.id,baseStructureRev:b,nodesCount:f.length})}catch{}let S=await un(`/api/articles/${encodeURIComponent(n)}/structure/snapshot`,{method:"PUT",body:JSON.stringify({opId:y.payload?.opId||y.id,nodes:f,...b!=null?{baseStructureRev:b}:{}})}),x=S?.updatedAt||null;x&&await pa(n,x).catch(()=>{}),Number.isFinite(Number(S?.newStructureRev))?await ma(n,Number(S.newStructureRev)):Number.isFinite(Number(S?.currentStructureRev))&&await ma(n,Number(S.currentStructureRev));try{ct("sync.flush.structure_snapshot.done",{articleId:n,opId:y.id,status:String(S?.status||""),updatedAt:x||null,newStructureRev:Number.isFinite(Number(S?.newStructureRev))?Number(S.newStructureRev):null,currentStructureRev:Number.isFinite(Number(S?.currentStructureRev))?Number(S.currentStructureRev):null})}catch{}let v=String(S?.status||"");if(v==="ok"||v==="duplicate"){await Sr(y.id).catch(()=>{});try{df.set(n,Date.now())}catch{}}}}try{(await _r(200)||[]).some(b=>Cc(b)&&String(b.articleId||"")===n)||(await Ul(n).catch(()=>{}),ct("sync.flush.localDraft.cleared",{articleId:n}))}catch{}}async function ho(){if(vc)return null;if(!navigator.onLine)return!1;vc=!0;try{let e=await _r(200),t=new Set,n=[];for(let o of e||[]){if(!Cc(o))continue;let i=String(o.articleId||"").trim();!i||t.has(i)||(t.add(i),n.push(i))}for(let o of n)try{await Eg(o,e)}catch(i){if(ff(i))break}let r=await _r(50);for(let o of r)if(!Cc(o))try{await Ag(o),await Sr(o.id);try{if(o.type==="section_upsert_content"&&String(o.articleId||"")==="inbox"){let i=String(o.payload?.sectionId||"").trim();i&&kc(i)}}catch{}await Ig(o)}catch(i){let s=Number(i?.status||0)||null,c=s?`${s}: ${i?.message||"error"}`:i?.message||String(i||"error");if(await Kl(o.id,c),xg(i,o)){try{console.warn("[offline][outbox] drop op",{opId:o.id,type:o.type,articleId:o.articleId,status:s,message:i?.message||null})}catch{}try{await Sr(o.id)}catch{}continue}if(ff(i))break;break}}finally{vc=!1}try{let e=await _r(1);return Array.isArray(e)&&e.length>0}catch{return!0}}function ni(){zr||(zr=window.setInterval(async()=>{try{await ho()===!1&&(window.clearInterval(zr),zr=null,pf())}catch{}},15e3))}function Tc(){zr&&(window.clearInterval(zr),zr=null)}function Mc(){if(!af){af=!0,pf();try{Li()}catch{}window.addEventListener("online",()=>{ho().then(e=>{e?ni():Tc()}).catch(()=>{})}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&ho().then(e=>{e?ni():Tc()}).catch(()=>{})}),window.addEventListener("offline-outbox-changed",()=>{ho().then(e=>{e?ni():Tc()}).catch(()=>{ni()})}),ho().then(e=>{e&&ni()}).catch(()=>{})}}function ri(e={}){let t=!!(e&&e.force);Ec||cf&&!t||(cf=!0,Ec=!0,Ot={running:!0,processed:0,total:0,errors:0,phase:"index",lastError:null,startedAt:new Date().toISOString(),finishedAt:null},Er(),(async()=>{try{if(!navigator.onLine){Ot={...Ot,running:!1,phase:"error",lastError:"offline",finishedAt:new Date().toISOString()},Er();return}let n=new Map;try{let o=await Fl();n=new Map((o||[]).map(i=>[i.id,i]))}catch{}let r=[];try{Array.isArray(e?.initialIndex)?r=e.initialIndex:r=await un("/api/articles")||[],Xn(r).catch(()=>{})}catch(o){Ot={...Ot,running:!1,phase:"error",lastError:o?.message||String(o||"error"),finishedAt:new Date().toISOString()},Er();return}Ot={...Ot,phase:"articles",total:Array.isArray(r)?r.length:0},Er();for(let o of r||[]){try{let i=o.updatedAt||null,s=n.get(o.id);if(i&&s?.updatedAt===i&&s?.hasDocJson){try{let l=await Gn(o.id),d=l?.docJson&&typeof l.docJson=="object"?l.docJson:null;d&&Zr(o.id,d).catch(()=>{})}catch{}continue}let c=await un(`/api/articles/${encodeURIComponent(o.id)}`);await wr(c);try{let l=await un(`/api/articles/${encodeURIComponent(o.id)}/embeddings`);await ga(o.id,l?.embeddings||[])}catch{}}catch{Ot={...Ot,errors:Number(Ot.errors||0)+1}}Ot={...Ot,processed:Number(Ot.processed||0)+1},Er(),await new Promise(i=>setTimeout(i,120))}try{Ot={...Ot,phase:"inbox"},Er();let o=await un("/api/articles/inbox?include_history=0");await wr(o)}catch{Ot={...Ot,errors:Number(Ot.errors||0)+1},Er()}$l().catch(()=>{}),Ot={...Ot,running:!1,phase:"done",finishedAt:new Date().toISOString()},Er()}finally{Ec=!1}})().catch(()=>{}))}var xs,af,vc,cf,Ec,zr,fg,lf,pg,df,Ot,ks=Fe(()=>{Lo();to();ya();Co();Ft();mo();Bo();xs="ttree_outline_autosave_queue_docjson_v1";af=!1,vc=!1,cf=!1,Ec=!1,zr=null,fg=2e3,lf=new Map,pg=3e3,df=new Map;Ot={running:!1,processed:0,total:0,errors:0,phase:"idle",lastError:null,startedAt:null,finishedAt:null}});var fr={};Wn(fr,{closeOutlineEditor:()=>op,enterOutlineSectionEditMode:()=>By,flushOutlineAutosave:()=>Py,getOutlineActiveSectionId:()=>ky,getOutlineActiveSectionSnapshot:()=>Ay,insertNewOutlineSectionAtEnd:()=>Cy,insertNewOutlineSectionAtStart:()=>Ly,insertOutlineSectionFromPlainTextAtStart:()=>My,insertOutlineSectionFromSectionFragmentsAtEnd:()=>Ty,openOutlineEditor:()=>Ny,openPublicOutlineViewer:()=>Dy,restoreOutlineSectionFromBlockHtml:()=>vy,restoreOutlineSectionFromSectionFragments:()=>Ey,revealOutlineSection:()=>rp});function Vc(e,t){let n=null,r=String(t||"").trim();return!e||!r?null:(e.descendants((o,i)=>{if(n!==null)return!1;o?.type?.name==="image"&&String(o.attrs?.uploadToken||"")===r&&(n=i)}),n)}function _f(e){let t=String(e||"").trim();if(!t)return;let n=li.get(t)||null;if(n){li.delete(t);try{URL.revokeObjectURL(n)}catch{}}}function Bg(e){try{if(!e||typeof e!="object")return e;let t=typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e)),n=r=>{if(!r||typeof r!="object")return;if(r.type==="image"&&r.attrs&&typeof r.attrs=="object"){let i=String(r.attrs.uploadToken||"").trim(),s=String(r.attrs.src||"");i&&s.startsWith("blob:")&&(r.attrs={...r.attrs,src:`${Uc}${i}`})}let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(t),t}catch{return e}}async function Lg(e){try{if(!ie||ie.isDestroyed)return;let t=String(e||"").trim();if(!t)return;let n=await Sc({articleId:t,limit:200}).catch(()=>[]);if(!n.length)return;let r=new Map;for(let l of n){let d=String(l?.token||"").trim();d&&(l?.kind&&String(l.kind)!=="image"||l?.blob&&r.set(d,l.blob))}if(!r.size)return;let{state:o,view:i}=ie,s=o.tr,c=!1;o.doc.descendants((l,d)=>{if(l?.type?.name!=="image")return;let u=String(l.attrs?.uploadToken||"").trim(),m=String(l.attrs?.src||""),g=m.startsWith(Uc)?m.slice(Uc.length).trim():"",w=u||g;if(!w)return;let y=r.get(w);if(!y)return;let f=li.get(w)||null;if(!f)try{f=URL.createObjectURL(y),li.set(w,f)}catch{f=null}if(!f)return;let h={...l.attrs,src:f,uploadToken:w};s=s.setNodeMarkup(d,void 0,h),c=!0}),c&&(s=s.setMeta(le,!0),i.dispatch(s))}catch{}}async function Of(e){try{if(!navigator.onLine||!ie||ie.isDestroyed)return!1;let t=String(e||"").trim();if(!t)return!1;let n=await Sc({articleId:t,limit:50}).catch(()=>[]);if(!n.length)return!1;let r=!1;for(let o of n){let i=String(o?.token||"").trim();if(!i||o?.kind&&String(o.kind)!=="image")continue;let s=o?.blob||null;if(s)try{let c=s instanceof File?s:new File([s],o?.fileName||"image",{type:o?.mime||s.type||"application/octet-stream"}),l=await Po(c),d=String(l?.url||"").trim();if(!d)throw new Error("Upload failed");try{let{state:u,view:m}=ie,g=Vc(u.doc,i);if(typeof g=="number"){let w=u.doc.nodeAt(g);if(w?.type?.name==="image"){let y={...w.attrs,src:d,uploadToken:null,title:String(w.attrs?.title||"").replace(/\s*\( \)\s*$/i,"").trim()},f=u.tr.setNodeMarkup(g,void 0,y);f=f.setMeta(le,!0),m.dispatch(f)}}}catch{}_f(i),await bc(i).catch(()=>{}),r=!0}catch(c){let l=c?.message||String(c||"error");await wc(i,l).catch(()=>{})}}if(r)try{pn({delayMs:350})}catch{}return r}catch{return!1}}function bf(){try{let e=window?.localStorage?.getItem?.(zc)||"";if(!e)return null;let t=JSON.parse(e);return!t||typeof t!="object"||!Array.isArray(t.sections)?null:{mode:t.mode==="cut"?"cut":"copy",sourceArticleId:typeof t.sourceArticleId=="string"?t.sourceArticleId:null,createdAt:typeof t.createdAt=="string"?t.createdAt:null,sections:t.sections}}catch{return null}}function Dc(e){try{if(!e){window?.localStorage?.removeItem?.(zc);return}window?.localStorage?.setItem?.(zc,JSON.stringify(e))}catch{}}function si(e){dr=!!e,dr||(Mr=new Set);try{p?.outlineEditor&&p.outlineEditor.classList.toggle("outline-select-mode",dr)}catch{}try{Rf()}catch{}}function Mg(e){let t=String(e||"").trim();if(t){Mr.has(t)?Mr.delete(t):Mr.add(t);try{Rf()}catch{}}}function Rf(){if(!p?.outlineEditor)return;p.outlineEditor.querySelectorAll(".outline-heading[data-section-id] .outline-heading__select").forEach(t=>{let r=t.closest(".outline-heading")?.getAttribute?.("data-section-id")||"",o=r&&Mr.has(r);t.setAttribute("aria-checked",o?"true":"false"),t.style.display=dr?"inline-flex":"none"})}function Ng(e,t){let n=t instanceof Set?t:new Set,r=[];if(!e||!n.size)return r;let o=(i,s)=>{let c=String(i?.attrs?.id||"").trim(),l=c&&n.has(c);if(l&&!s){r.push({id:c,node:i});return}let d=i?.childCount>=3?i.child(2):null;if(d)try{d.forEach(u=>{u?.type?.name==="outlineSection"&&o(u,s||l)})}catch{}};try{e.forEach(i=>{i?.type?.name==="outlineSection"&&o(i,!1)})}catch{}return r}function Hf(e){return JSON.parse(JSON.stringify(e))}function Pg(e,t){let n=Hf(e),r=o=>{if(!o||typeof o!="object")return;if(o.type==="outlineSection"){let s=t();o.attrs&&typeof o.attrs=="object"?o.attrs.id=s:o.attrs={id:s,collapsed:!!o.attrs?.collapsed}}let i=Array.isArray(o.content)?o.content:[];for(let s of i)r(s)};return r(n),n}async function Dg(e){let t=String(e||"");if(t){try{if(navigator?.clipboard?.writeText){await navigator.clipboard.writeText(t);return}}catch{}try{let n=document.createElement("textarea");n.value=t,n.setAttribute("readonly","true"),n.style.position="fixed",n.style.left="-9999px",n.style.top="0",document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n)}catch{}}}function $f(e,{baseLevel:t=2,depth:n=0}={}){let r=e;if(!r||r.type?.name!=="outlineSection")return"";let o="",i="";try{let l=r.child(0);o=String(l?.textContent||"").trim()}catch{o=""}try{let l=r.child(1);i=l?String(l.textBetween(0,l.content.size,`
`)).trimEnd():""}catch{i=""}let s=Math.min(6,Math.max(1,Number(t)+Number(n||0))),c=[];o&&c.push(`${"#".repeat(s)} ${o}`),i&&c.push(i);try{let l=r.child(2);if(l){let d=[];l.forEach(u=>{if(u?.type?.name!=="outlineSection")return;let m=$f(u,{baseLevel:t,depth:n+1});m&&d.push(m)}),d.length&&c.push(d.join(`

`))}}catch{}return c.filter(Boolean).join(`

`).trim()}function Ff(e,t){try{let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return 1;let o=window.localStorage.getItem(wf)||"",i=o?JSON.parse(o):{},s=i&&typeof i=="object"?i:{},c=(s[n]&&typeof s[n]=="object"?s[n]:{})||{},d=(Number(c[r]||0)||0)+1;return c[r]=d,s[n]=c,window.localStorage.setItem(wf,JSON.stringify(s)),d}catch{return Date.now()}}function zf(e,t){try{let n=JSON.stringify({headingJson:e,bodyJson:t});return globalThis.TextEncoder?new TextEncoder().encode(n).length:n.length*2}catch{return 0}}function go(e){try{let t=String(e||"").trim();if(!t)return;Bn.add(t);let n=Dt||a.articleId||null;if(!n||a.article?.encrypted||_c)return;_c=setTimeout(()=>{_c=null;try{if(!Bn.size)return;let r=Array.from(Bn);Bn.clear();let o=Date.now();$t("delete_sections",{articleId:n,payload:{sectionIds:r,clientQueuedAt:o},coalesceKey:`delete:${n}`})}catch{}},0)}catch{}}function ui(e){let t=[],n=o=>{try{if(!o||o.type?.name!=="outlineSection")return null;for(let i=0;i<o.childCount;i+=1){let s=o.child(i);if(s?.type?.name==="outlineChildren")return s}return null}catch{return null}},r=(o,i)=>{try{if(!o)return;let s=0;o.forEach(c=>{if(!c||c.type?.name!=="outlineSection")return;let l=String(c.attrs?.id||"").trim();if(!l)return;t.push({sectionId:l,parentId:i||null,position:s,collapsed:!!c.attrs?.collapsed}),s+=1;let d=n(c);d&&r(d,l)})}catch{}};try{if(!e)return[];r(e,null)}catch{return[]}return t}function Sf(e){try{return ui(e).map(n=>`${n.parentId||""}|${n.position}|${n.sectionId}|${n.collapsed?1:0}`).join(`
`)}catch{return""}}function yo(e){let t=[];try{if(!e)return t;e.descendants((n,r)=>{n?.type?.name==="outlineSection"&&t.push(r)})}catch{}return t}function qc(e,t){try{if(!e||e.isDestroyed)return!1;let n=!!t;return e.commands.command(({state:r,dispatch:o})=>{let i=yo(r.doc);if(!i.length)return!1;let s=r.tr;for(let c of i){let l=s.doc.nodeAt(c);!l||l.type?.name!=="outlineSection"||!!l.attrs?.collapsed!==n&&(s=s.setNodeMarkup(c,void 0,{...l.attrs,collapsed:n}))}s=s.setMeta(le,!0);try{n&&ke&&(ke.getState(r)||{}).editingSectionId&&(s=s.setMeta(ke,{type:"exit"}))}catch{}try{if(n&&TextSelection){let c=Rt(r.doc,r.selection.$from),l=typeof c=="number"?c:i[0],d=s.doc.nodeAt(l);if(d?.type?.name==="outlineSection"){let u=d.child(0),g=l+1+u.nodeSize-1;s=s.setSelection(TextSelection.near(s.doc.resolve(g),-1))}}}catch{}return o(s.scrollIntoView()),!0})}catch{return!1}}function _g({articleId:e,editor:t}={}){try{let n=String(e||"").trim();if(!n||!t)return;Jn=!0;try{if((ke?.getState?.(t.state)||null)?.editingSectionId){jt&&(clearTimeout(jt),jt=null);return}}catch{}jt&&clearTimeout(jt),jt=setTimeout(()=>{jt=null;try{if(!Jn)return;let r=t.state?.doc,o=ui(r);if(!o.length)return;try{let i=null;try{i=o.filter(s=>s&&(s.parentId==null||s.parentId==="")&&Number(s.position)>=0).sort((s,c)=>Number(s.position)-Number(c.position)).slice(0,3).map(s=>String(s.sectionId||""))}catch{i=null}ct("outline.enqueue.structure_snapshot",{articleId:n,nodesCount:o.length,rootFirst:i})}catch{}$t("structure_snapshot",{articleId:n,payload:{nodes:o},coalesceKey:`structure:${n}`}),Jn=!1}catch{}},Tg)}catch{}}async function Yc({articleId:e,doc:t,sectionId:n,reason:r}){let o=String(e||"").trim(),i=String(n||"").trim();if(!o||!i||!t)return!1;let s=ht(t,i),c=typeof s=="number"?t.nodeAt(s):null;if(!c||c.type?.name!=="outlineSection")return!1;try{if(!Jr(t,i))return!1}catch{return!1}let l=c.child(0),d=c.child(1),u=l?.toJSON?l.toJSON():null,m=d?.toJSON?d.toJSON():null;if(!u||!m)return!1;let g=zf(u,m);if(g>Bs){let f=Date.now();return(!Nc||f-Nc>5e3)&&(Nc=f,L(`\u0411\u043B\u043E\u043A \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 (${Math.ceil(g/1024)} KB). \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C: ${Math.ceil(Bs/1024)} KB. \u0420\u0430\u0437\u0431\u0435\u0439\u0442\u0435 \u0431\u043B\u043E\u043A \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E.`)),!1}let w=Date.now(),y=Ff(o,i);try{ct("outline.enqueue.section_upsert_content",{articleId:o,sectionId:i,seq:y,bytes:g,reason:String(r||"")})}catch{}await $t("section_upsert_content",{articleId:o,payload:{sectionId:i,headingJson:u,bodyJson:m,seq:y,clientQueuedAt:w},coalesceKey:`content:${o}:${i}`}).catch(()=>{});try{if(Jn){let f=ui(t);if(f.length){let h=null;try{h=f.filter(b=>b&&(b.parentId==null||b.parentId==="")&&Number(b.position)>=0).sort((b,S)=>Number(b.position)-Number(S.position)).slice(0,3).map(b=>String(b.sectionId||""))}catch{h=null}try{ct("outline.enqueue.structure_snapshot",{articleId:o,nodesCount:f.length,reason:"after_section_upsert",rootFirst:h})}catch{}$t("structure_snapshot",{articleId:o,payload:{nodes:f},coalesceKey:`structure:${o}`})}Jn=!1,jt&&(clearTimeout(jt),jt=null)}}catch{}try{Yr.set(i,_s(c)),Br.delete(i)}catch{}try{Promise.resolve().then(()=>(ks(),mf)).then(f=>f.flushOutboxOnce?.()).catch(()=>{})}catch{}return!0}function Og(e){try{if(!e||e.isDestroyed)return;let t=ke?.getState?.(e.state)||null,n=String(t?.editingSectionId||"").trim();if(!n)return;let r=Dt||a.articleId||null;if(!r)return;Hc=n,qr&&clearTimeout(qr),qr=setTimeout(()=>{qr=null;try{if(!ie||ie.isDestroyed)return;let o=ke?.getState?.(ie.state)||null,i=String(o?.editingSectionId||"").trim();if(!i||i!==Hc)return;Yc({articleId:r,doc:ie.state.doc,sectionId:i,reason:"edit_heartbeat"})}catch{}},Cg)}catch{}}function Kc(){try{return window?.localStorage?.getItem?.(Rg)==="1"}catch{return!1}}function xn(...e){try{if(!Kc())return;console.log("[outline][md-table]",...e)}catch{}}function Vr(){try{return window?.localStorage?.getItem?.(Hg)==="1"}catch{return!1}}function bo(e,t={}){try{if(!Vr())return;console.log("[perf][outline]",e,t)}catch{}}function Fg(){try{return window?.localStorage?.getItem?.($g)==="1"}catch{return!1}}function er(e,t={}){try{if(!Fg())return;console.log("[outline][proofread]",e,t)}catch{}}function Uf(e){let t=String(e||"").replace(/\s+/g," ").trim();return t?t.length>60?t.slice(0,60):t:null}function Vf(e){return String(e||"").replace(/\s+/g," ").trim().toUpperCase()}function zg(e,t="tag"){let n=new Map,r=new Map,o=new Map,i=new Map;return e?(e.descendants((s,c)=>{if(s?.type?.name!=="outlineSection")return;let l=String(s.attrs?.id||"");l&&i.set(l,c);let d=new Set,u=m=>{m?.descendants?.(g=>{if(g?.type?.name!==t)return;let w=Uf(g.attrs?.label||g.textContent||"");if(!w)return;let y=Vf(g.attrs?.key||w);y&&(n.set(y,(n.get(y)||0)+1),r.set(y,y),d.add(y))})};try{u(s.child(0)),u(s.child(1))}catch{}if(l)for(let m of d)o.has(m)||o.set(m,new Set),o.get(m).add(l);return!1}),{counts:n,labelByKey:r,sectionIdsByKey:o,sectionPosById:i}):{counts:n,labelByKey:r,sectionIdsByKey:o,sectionPosById:i}}function qf(){let e=p?.outlineTagsBar;if(!e)return;let t=Array.from(Xr.counts.entries()).map(([n,r])=>({key:n,label:Xr.labelByKey.get(n)||n,count:r})).filter(n=>n.key&&n.count>0).sort((n,r)=>r.count!==n.count?r.count-n.count:n.label.localeCompare(r.label));if(!t.length){e.innerHTML="",e.classList.add("hidden");return}e.classList.remove("hidden"),e.innerHTML=t.map(n=>{let r=Lr&&Lr===n.key?"true":"false",o=Pf(n.label);return`<button type="button" class="outline-tag-pill" data-tag-key="${Pf(n.key)}" aria-pressed="${r}">${o} <span class="outline-tag-pill__count">(${n.count})</span></button>`}).join("")}function Kf(){if(ie){if(Xr=zg(ie.state.doc,"tag"),Lr&&!Xr.counts.has(Lr)){Lr=null;try{Ms?.(null)}catch{}}qf()}}function Ug(e){let t=String(e||"");if(!t||!ie)return;let n=Xr.sectionIdsByKey.get(t);if(!n||!n.size)return;let r=new Set;for(let s of n){let c=Xr.sectionPosById.get(s);if(typeof c=="number"){r.add(c);try{let l=ie.state.doc.resolve(Math.min(ie.state.doc.content.size,c+1));for(let d=l.depth;d>0;d-=1)l.node(d)?.type?.name==="outlineSection"&&r.add(l.before(d))}catch{}}}let o=ie.state.tr,i=!1;for(let s of r){let c=o.doc.nodeAt(s);!c||c.type?.name!=="outlineSection"||c.attrs?.collapsed&&(o=o.setNodeMarkup(s,void 0,{...c.attrs,collapsed:!1}),i=!0)}i&&(o=o.setMeta(le,!0),ie.view.dispatch(o))}function Vg({setActiveTagKey:e}){let t=p?.outlineTagsBar;if(!t)return()=>{};let n=r=>{let o=r.target?.closest?.("[data-tag-key]");if(!o)return;let i=String(o.getAttribute("data-tag-key")||"");if(!i)return;let s=Lr===i?null:i;Lr=s;try{e(s)}catch{}s&&Ug(s),qf()};return t.addEventListener("click",n),()=>t.removeEventListener("click",n)}function kn(e){let t=String(e||"").trim();if(!t.includes("|"))return null;let n=t;n.startsWith("|")&&(n=n.slice(1)),n.endsWith("|")&&(n=n.slice(0,-1));let r=n.split("|").map(o=>o.trim());return r.length<2||r.every(o=>!o)?null:r}function Ns(e){let t=String(e||"").trim();return t?/^:?-{3,}:?$/.test(t):!1}function jr(e){let t=(Array.isArray(e)?e:[]).map(i=>String(i||"").replace(/\r/g,"").trimEnd()).filter(i=>i.length>0);if(t.length<2)return null;let n=kn(t[0]),r=kn(t[1]);if(!n||!r||n.length!==r.length||!r.every(Ns))return null;let o=[];for(let i=2;i<t.length;i+=1){let s=kn(t[i]);if(!s||s.length!==n.length)return null;o.push(s)}return{header:n,rows:o}}function Wr(e){let t=(Array.isArray(e)?e:[]).map(s=>String(s||"").replace(/\r/g,"").trimEnd()).filter(s=>s.length>0);if(t.length<1)return null;let n=kn(t[0]);if(!n)return null;let r=n.length;if(r<2)return null;let o=[n];for(let s=1;s<t.length;s+=1){let c=kn(t[s]);if(!c||c.length!==r)break;if(s===1&&c.every(Ns))return null;o.push(c)}return o.flat().filter(s=>String(s||"").trim().length>0).length<2?null:{rows:o}}function Xc(e){let t=String(e||"").replace(/\r/g,"").split(`
`).map(n=>String(n||"").trimEnd());for(;t.length&&!t[0].trim();)t.shift();for(;t.length&&!t[t.length-1].trim();)t.pop();return t}function Tr(e,t){if(!e||!t)return null;let{header:n,rows:r,withHeader:o}=t,i=e.nodes.table,s=e.nodes.tableRow,c=e.nodes.tableCell,l=e.nodes.tableHeader,d=e.nodes.paragraph;if(!i||!s||!c||!l||!d||typeof e.text!="function")return null;let u=y=>d.create({},y?[e.text(String(y))]:[]),m=(y,f)=>y.map(h=>(f?l:c).create({},[u(h)])),g=(y,f)=>s.create({},m(y,f)),w=[];return o&&Array.isArray(n)&&n.length&&w.push(g(n,!0)),(Array.isArray(r)?r:[]).forEach(y=>w.push(g(y,!1))),w.length?i.create({},w):null}function qg(e,t){try{let n=e?.selection,r=n?.$from;if(!n?.empty||!r)return We("table.merge.skip",{reason:"no-cursor"}),!1;if(r.parent?.type?.name!=="paragraph")return!1;if(r.parentOffset!==0)return We("table.merge.skip",{reason:"not-at-paragraph-start"}),!1;let o=null,i=null,s=null;for(let ne=r.depth;ne>0;ne-=1){let pe=r.node(ne)?.type?.name;if(!s&&(pe==="tableCell"||pe==="tableHeader")?s=ne:!i&&pe==="tableRow"?i=ne:!o&&pe==="table"&&(o=ne),o&&i&&s)break}if(o==null||i==null||s==null)return We("table.merge.skip",{reason:"not-in-table"}),!1;let c=r.depth===s+1,l=r.index(o),d=r.index(i),u=r.index(s);if(We("table.merge.check",{parent:r.parent?.type?.name||null,parentOffset:r.parentOffset,tableDepth:o,rowDepth:i,cellDepth:s,isDirectParagraphInCell:c,rowIndex:l,colIndex:d,childIndexInCell:u}),!c)return We("table.merge.skip",{reason:"paragraph-not-direct-child-of-cell"}),!1;if(l!==0||d!==0||u!==0)return We("table.merge.skip",{reason:"not-in-first-cell",rowIndex:l,colIndex:d,childIndexInCell:u}),!1;let m=r.before(o),g=e.doc.nodeAt(m);if(!g||g.type?.name!=="table")return We("table.merge.skip",{reason:"no-current-table",tablePos:m}),!1;let w=e.doc.resolve(m),y=w.index(),f=w.parent;if(!f||y<=0)return We("table.merge.skip",{reason:"no-prev-sibling",idx:y,parent:f?.type?.name||null}),!1;let h=null,b=y-1;for(;b>=0;){let ne=f.child(b);if(ne?.type?.name==="paragraph"&&!String(ne.textContent||"").trim()){b-=1;continue}h=ne;break}if(!h||h.type?.name!=="table")return We("table.merge.skip",{reason:"no-prev-table"}),!1;let S=h.childCount?h.child(0):null,x=g.childCount?g.child(0):null;if(!S||!x)return We("table.merge.skip",{reason:"missing-rows"}),!1;if(S.childCount!==x.childCount)return We("table.merge.skip",{reason:"different-columns",prevCols:S.childCount,curCols:x.childCount}),!1;let v=S.childCount,B=(ne,pe)=>{try{return ne?.type?.name==="tableRow"&&ne.childCount===pe}catch{return!1}};for(let ne=0;ne<h.childCount;ne+=1){let pe=h.child(ne);if(!B(pe,v))return We("table.merge.skip",{reason:"prev-row-mismatch",rowIndex:ne,colsExpected:v,colsGot:pe?.childCount??null}),!1}for(let ne=0;ne<g.childCount;ne+=1){let pe=g.child(ne);if(!B(pe,v))return We("table.merge.skip",{reason:"cur-row-mismatch",rowIndex:ne,colsExpected:v,colsGot:pe?.childCount??null}),!1}let N=m;for(let ne=y-1;ne>=b;ne-=1)N-=f.child(ne).nodeSize;let z=h.childCount,P=e.doc.type.schema,W=N+h.nodeSize,q=e.tr;m>W&&(q=q.delete(W,m));let ee=W;q=q.delete(ee,ee+g.nodeSize);let de=q.doc.nodeAt(N);if(!de||de.type?.name!=="table")return We("table.merge.skip",{reason:"prev-after-missing",prevStart:N,prevAfterType:de?.type?.name||null}),!1;We("table.merge.plan",{idx:y,prevIdx:b,prevStart:N,prevEnd:W,tablePos:m,tablePos2:ee,cols:v,prevRowCount:z,curRowCount:g.childCount});try{let ne=de.content.append(g.content),pe=P.nodes.table.create(de.attrs,ne,de.marks);q=q.replaceWith(N,N+de.nodeSize,pe)}catch(ne){return We("table.merge.error",{message:String(ne?.message||ne||""),stack:String(ne?.stack||"")}),!1}let Le=q.doc.nodeAt(N);We("table.merge.afterReplace",{mergedType:Le?.type?.name||null,mergedRows:Le?.type?.name==="table"?Le.childCount:null});try{let ne=He?.pmStateMod?.TextSelection||He?.pm?.state?.TextSelection||null;if(Le&&Le.type?.name==="table"){let pe=Math.min(z,Math.max(0,Le.childCount-1));if(Le.child(pe)?.childCount){let gt=(()=>{let _e=N+1;for(let it=0;it<pe;it+=1)_e+=Le.child(it).nodeSize;return _e+=1,_e})(),Tt=Math.min(q.doc.content.size,gt+2);ne&&(q=q.setSelection(ne.near(q.doc.resolve(Tt),1)))}}}catch(ne){We("table.merge.selection.error",{message:String(ne?.message||ne||""),stack:String(ne?.stack||"")})}q=q.setMeta(le,!0);try{t(q.scrollIntoView())}catch(ne){return We("table.merge.dispatch.error",{message:String(ne?.message||ne||""),stack:String(ne?.stack||"")}),!1}return!0}catch(n){try{We("table.merge.exception",{message:String(n?.message||n||""),stack:String(n?.stack||"")})}catch{}return!1}}function Kg(e,t,n,r){try{let o=(pe,je={})=>{try{if(window?.localStorage?.getItem?.("ttree_debug_outline_keys_v1")!=="1")return;console.log("[outline][keys]","bodyToHeading.skip",{reason:pe,sectionId:n||null,...je})}catch{}},i=(pe={})=>{try{if(window?.localStorage?.getItem?.("ttree_debug_outline_keys_v1")!=="1")return;console.log("[outline][keys]","bodyToHeading.check",{sectionId:n||null,...pe})}catch{}};if(!n)return!1;if(!r)return o("no-TextSelection"),!1;let s=e?.selection;if(!s?.empty)return o("selection-not-empty"),!1;let c=s.$from||null;if(!c)return o("no-$from"),!1;i({from:s.from,parent:c.parent?.type?.name||null,parentOffset:c.parentOffset??null});let l=ht(e.doc,n);if(typeof l!="number")return o("section-not-found"),!1;let d=e.doc.nodeAt(l);if(!d||d.type?.name!=="outlineSection")return o("not-outlineSection",{found:d?.type?.name||null}),!1;let u=d.child(0),m=d.child(1);if(!u||u.type?.name!=="outlineHeading")return o("missing-heading",{found:u?.type?.name||null}),!1;if(!m||m.type?.name!=="outlineBody")return o("missing-body",{found:m?.type?.name||null}),!1;let g=String(u.textContent||"").replace(/\u00a0/g," "),w=!!g.trim(),y=/\s$/.test(g),f=null;for(let pe=c.depth;pe>=0;pe-=1)if(c.node(pe)?.type?.name==="outlineBody"){f=pe;break}if(f==null)return o("not-in-outlineBody",{parent:c.parent?.type?.name||null}),!1;if(c.index(f)!==0)return o("not-first-body-child",{index:c.index(f)}),!1;if(c.parent?.type?.name!=="paragraph")return o("parent-not-paragraph",{parent:c.parent?.type?.name||null}),!1;if((c.parentOffset??null)!==0)return o("not-at-paragraph-start",{parentOffset:c.parentOffset??null}),!1;let h=l+1,b=s.from,S=c.parent,x=0,v=null;for(let pe=0;pe<S.childCount;pe+=1){let je=S.child(pe);if(je.type?.name==="hardBreak"){v=x;break}x+=je.nodeSize}let B=b+(v??S.content.size);if(B<=b)return o("empty-first-line"),!1;let N=e.doc.slice(b,B);if(!N?.content||N.content.size<=0)return o("empty-slice"),!1;let z=v==null?B:B+1,P=h+1,W=h+u.nodeSize-1,q=e.tr;w&&!y&&(q=q.insertText(" ",W),q=q.setMeta(le,!0));let ee=q.mapping.map(W,1),de=ee;q=q.insert(ee,N.content);let Le=q.mapping.map(b,1),ne=q.mapping.map(z,-1);q=q.delete(Le,ne);try{q=q.setSelection(r.create(q.doc,de))}catch{}return q=q.setMeta(le,!0),t(q.scrollIntoView()),!0}catch(o){try{window?.localStorage?.getItem?.("ttree_debug_outline_keys_v1")==="1"&&console.log("[outline][keys]","bodyToHeading.error",{sectionId:n||null,message:String(o?.message||o||""),stack:String(o?.stack||"")})}catch{}return!1}}function Jg(e,t){try{if(!e?.doc||!t)return null;let n=ht(e.doc,t);if(typeof n!="number")return null;let r=e.doc.nodeAt(n);if(!r)return null;let o=r.child(0),i=r.child(1);if(!i||i.type?.name!=="outlineBody")return null;let c=n+1+o.nodeSize+1,l=[],d=0,u=0;for(;u<i.childCount;){let g=i.child(u),w=c+d;if(g.type?.name!=="paragraph"){d+=g.nodeSize,u+=1;continue}let y=Cr(g).trim();if(y.includes(`
`)&&y.includes("|")){let q=Xc(y),ee=jr(q),de=ee?null:Wr(q),Le=ee?{header:ee.header,rows:ee.rows,withHeader:!0}:de?{header:null,rows:de.rows,withHeader:!1}:null,ne=null;if(Le)try{ne=Tr(e.schema,Le)}catch(pe){xn("convert: buildTableNode error (single)",{message:String(pe?.message||pe||""),stack:String(pe?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),ne=null}if(ne){let pe=w,je=w+g.nodeSize;l.push({from:pe,to:je,tableNode:ne}),xn("convert: single-paragraph table",{sectionId:t,from:pe,to:je,lines:q}),d+=g.nodeSize,u+=1;continue}}let f=kn(y);if(!f||u+1>=i.childCount){if(f){let q=[y],ee=d+g.nodeSize,de=u+1;for(;de<i.childCount;){let je=i.child(de);if(je.type?.name!=="paragraph")break;let gt=Cr(je).trim();if(!gt)break;let Tt=kn(gt);if(!Tt||Tt.length!==f.length)break;q.push(gt),ee+=je.nodeSize,de+=1}let Le=Wr(q),ne=Le?{header:null,rows:Le.rows,withHeader:!1}:null,pe=null;if(ne)try{pe=Tr(e.schema,ne)}catch(je){xn("convert: buildTableNode error (rows-only)",{message:String(je?.message||je||""),stack:String(je?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),pe=null}if(pe){l.push({from:w,to:c+ee,tableNode:pe}),xn("convert: rows-only table",{sectionId:t,from:w,to:c+ee,lines:q}),d=ee,u=de;continue}}d+=g.nodeSize,u+=1;continue}let h=i.child(u+1);if(h.type?.name!=="paragraph"){d+=g.nodeSize,u+=1;continue}let b=Cr(h).trim(),S=kn(b);if(!S||S.length!==f.length||!S.every(Ns)){d+=g.nodeSize,u+=1;continue}let x=[y,b],v=d+g.nodeSize+h.nodeSize,B=u+2;for(;B<i.childCount;){let q=i.child(B);if(q.type?.name!=="paragraph")break;let ee=Cr(q).trim();if(!ee)break;let de=kn(ee);if(!de||de.length!==f.length)break;x.push(ee),v+=q.nodeSize,B+=1}let N=jr(x),z=N?null:Wr(x),P=N?{header:N.header,rows:N.rows,withHeader:!0}:z?{header:null,rows:z.rows,withHeader:!1}:null,W=null;if(P)try{W=Tr(e.schema,P)}catch(q){xn("convert: buildTableNode error (multi)",{message:String(q?.message||q||""),stack:String(q?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),W=null}if(!W){d+=g.nodeSize,u+=1;continue}l.push({from:w,to:c+v,tableNode:W}),xn("convert: multi-paragraph table",{sectionId:t,from:w,to:c+v,lines:x}),d=v,u=B}if(!l.length)return null;l.sort((g,w)=>w.from-g.from);let m=e.tr;for(let g of l)m=m.replaceRangeWith(g.from,g.to,g.tableNode);return m=m.setMeta(le,!0),m}catch{return null}}function Cr(e){if(!e)return"";let t="";return e.descendants(n=>{n.isText?t+=n.text||"":n.type?.name==="hardBreak"&&(t+=`
`)}),t}function kf(e){try{if(!e||e.type!=="paragraph")return"";let t=[],n=r=>{if(!r)return;if(r.type==="text"){t.push(String(r.text||""));return}if(r.type==="hardBreak"){t.push(`
`);return}let o=Array.isArray(r.content)?r.content:[];for(let i of o)n(i)};return n(e),t.join("")}catch{return""}}function jg(e){if(!e)return null;let{header:t,rows:n}=e;if(!Array.isArray(t)||t.length===0)return null;let r=s=>({type:"paragraph",content:String(s||"").length?[{type:"text",text:String(s||"")}]:[]}),o={type:"tableRow",content:t.map(s=>({type:"tableHeader",content:[r(s)]}))},i=(Array.isArray(n)?n:[]).map(s=>({type:"tableRow",content:s.map(c=>({type:"tableCell",content:[r(c)]}))}));return{type:"table",content:[o,...i]}}function Wg(e){if(!e)return!1;try{let{doc:t,schema:n}=e.state,r=[];if(t.descendants((i,s)=>{if(i.type?.name!=="outlineBody")return;let c=s+1,l=0,d=0;for(;d<i.childCount;){let u=i.child(d),m=c+l;if(u.type?.name!=="paragraph"){l+=u.nodeSize,d+=1;continue}let g=Cr(u).trim();if(g.includes(`
`)&&g.includes("|")){let z=Xc(g),P=jr(z),W=P?null:Wr(z),q=P?{header:P.header,rows:P.rows,withHeader:!0}:W?{header:null,rows:W.rows,withHeader:!1}:null,ee=q?Tr(n,q):null;if(ee){r.push({from:m,to:m+u.nodeSize,tableNode:ee}),l+=u.nodeSize,d+=1;continue}}let w=kn(g);if(!w){l+=u.nodeSize,d+=1;continue}if(d+1>=i.childCount){let z=Wr([g]),P=z?{header:null,rows:z.rows,withHeader:!1}:null,W=P?Tr(n,P):null;W&&r.push({from:m,to:m+u.nodeSize,tableNode:W}),l+=u.nodeSize,d+=1;continue}let y=i.child(d+1);if(y.type?.name!=="paragraph"){l+=u.nodeSize,d+=1;continue}let f=Cr(y).trim(),h=kn(f);if(!h||h.length!==w.length||!h.every(Ns)){let z=[g],P=l+u.nodeSize,W=d+1;for(;W<i.childCount;){let Le=i.child(W);if(Le.type?.name!=="paragraph")break;let ne=Cr(Le).trim();if(!ne)break;let pe=kn(ne);if(!pe||pe.length!==w.length)break;z.push(ne),P+=Le.nodeSize,W+=1}let q=Wr(z),ee=q?{header:null,rows:q.rows,withHeader:!1}:null,de=ee?Tr(n,ee):null;if(de){r.push({from:m,to:c+P,tableNode:de}),l=P,d=W;continue}l+=u.nodeSize,d+=1;continue}let b=[g,f],S=l+u.nodeSize+y.nodeSize,x=d+2;for(;x<i.childCount;){let z=i.child(x);if(z.type?.name!=="paragraph")break;let P=Cr(z).trim();if(!P)break;let W=kn(P);if(!W||W.length!==w.length)break;b.push(P),S+=z.nodeSize,x+=1}let v=jr(b),B=v?{header:v.header,rows:v.rows,withHeader:!0}:null,N=B?Tr(n,B):null;if(!N){l+=u.nodeSize,d+=1;continue}r.push({from:m,to:c+S,tableNode:N}),l=S,d=x}}),!r.length)return!1;r.sort((i,s)=>s.from-i.from);let o=e.state.tr;for(let i of r)o=o.replaceRangeWith(i.from,i.to,i.tableNode);return o=o.setMeta(le,!0),e.view.dispatch(o),!0}catch{return!1}}function wo(){let e=Date.now();if(!(e-xf<900)){xf=e;try{L("\u0414\u043B\u044F \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Enter \u0438\u043B\u0438 \u0434\u0432\u043E\u0439\u043D\u043E\u0439 \u043A\u043B\u0438\u043A \u043C\u044B\u0448\u043A\u043E\u0439. Esc \u0434\u043B\u044F \u0432\u044B\u0445\u043E\u0434\u0430.")}catch{}}}function Jc(e=""){let t=document.createElement("div");return t.innerHTML=e||"",(t.textContent||"").replace(/\u00a0/g," ").trim()}function Kr(e=""){return String(e||"").replace(/\u00a0/g," ").replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}function jc(e=""){let t=String(e||""),n=0;for(let r=0;r<t.length;r+=1)n=n*31+t.charCodeAt(r)>>>0;return String(n)}function Oc(e=""){return jc(String(e||"").slice(0,12e3))}function tn(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`sec-${Date.now()}-${Math.random().toString(16).slice(2)}`}function Jf({loading:e=!1}={}){p.outlineEditor&&(p.outlineEditor.innerHTML=`
    <div class="outline-editor__body">
      <div class="outline-editor__content" id="outlineEditorContent"></div>
      <div class="outline-editor__loading ${e?"":"hidden"}">\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440\u2026</div>
    </div>
  `,hf||(hf=!0))}function jf(e){let t=String(e||"").trim();if(!t)return null;let n=t.match(/(-?\d+(?:\.\d+)?)%/);if(!n)return null;let r=Number.parseFloat(n[1]);return Number.isFinite(r)?r:null}function jn(e){let t=Number(e);return Number.isFinite(t)?Math.max(0,Math.min(100,t)):0}function Wf(e){try{let t=e?.dataset?.ttPct||"",n=Number.parseFloat(String(t||""));if(Number.isFinite(n)&&n>0)return n;let r=jf(e?.style?.width||"");return r!=null&&r>0?r:null}catch{return null}}function Ps(e,t){try{let n=jn(t);return e.dataset.ttPct=n.toFixed(4),e.style.width=`${n.toFixed(4)}%`,e.style.minWidth="",!0}catch{return!1}}function Ls(e,{insertIndex:t,newColPct:n=10}={}){try{let r=e?.view;if(!r)return!1;let o=Number(t);if(!Number.isFinite(o)||o<0)return!1;let i=r.domAtPos(r.state.selection.from),c=((i?.node&&i.node.nodeType===1?i.node:i?.node?.parentElement)||null)?.closest?.("table")||null;if(!c)return!1;let l=c.querySelector("colgroup");if(!l)return!1;let d=Array.from(l.querySelectorAll("col"));if(!d.length||o>=d.length)return!1;let u=100/d.length,m=d.map(v=>Wf(v)??u),g=jn(n);m[o]=g;let w=o-1,y=w>=0?m.slice(0,w+1).reduce((v,B)=>v+B,0):0,f=o+1,h=Math.max(0,d.length-f),b=h>0?m.slice(f).reduce((v,B)=>v+B,0):0,S=100-y-g;if(S<0){let v=Math.max(0,o-1),B=Math.max(0,m[v]-1),N=Math.abs(S),z=Math.min(B,N);m[v]=Math.max(1,m[v]-z),S=100-m.slice(0,w+1).reduce((P,W)=>P+W,0)-g,S=Math.max(0,S)}if(h>0)if(b>0){let v=S/b;for(let B=f;B<d.length;B+=1)m[B]*=v}else{let v=S/h;for(let B=f;B<d.length;B+=1)m[B]=v}let x=m.reduce((v,B)=>v+B,0);if(x>0&&Math.abs(x-100)>.01){let v=100-x,B=d.length-1;m[B]=jn(m[B]+v),x=m.reduce((N,z)=>N+z,0)}for(let v=0;v<d.length;v+=1)Ps(d[v],m[v]);try{c.style.width="100%",c.style.maxWidth="100%",c.style.tableLayout="fixed"}catch{}return!0}catch{return!1}}function Cs(e){try{if(!e)return!1;let t=e.querySelector("colgroup");if(!t)return!1;let n=Array.from(t.querySelectorAll("col"));if(!n.length)return!1;let r=e.getBoundingClientRect();if(!Number.isFinite(r.width)||r.width<=0)return!1;let o=e.querySelector("tbody tr");if(!o)return!1;let i=Array.from(o.children||[]).filter(l=>l&&l.nodeType===1);if(!i.length)return!1;let s=[];for(let l=0;l<n.length;l+=1){let d=i[l]||null;if(!d){s.push(0);continue}let u=d.getBoundingClientRect();s.push(Number.isFinite(u.width)?u.width:0)}let c=s.reduce((l,d)=>l+(Number.isFinite(d)?d:0),0);if(!(c>0))return!1;for(let l=0;l<n.length;l+=1){let d=jn(s[l]/c*100);Ps(n[l],d)}return!0}catch{return!1}}function sn(e){try{if(!e?.state?.selection)return null;let t=e.state.selection;try{let o=t?.$anchorCell?.pos,i=t?.$headCell?.pos,s=Number.isFinite(o)?o:Number.isFinite(i)?i:null;if(s!=null){let c=e.nodeDOM?.(s)||null;if(c&&c.nodeType===1)return c.closest?.("table")||null}}catch{}let n=e.domAtPos(t.from);return((n?.node&&n.node.nodeType===1?n.node:n?.node?.parentElement)||null)?.closest?.("table")||null}catch{return null}}function Yg(e){try{let t=e?.state?.selection||null,n=t?.$from||null;if(!n)return null;try{let s=t?.$anchorCell?.pos,c=t?.$headCell?.pos,l=Number.isFinite(s)?s:Number.isFinite(c)?c:null;if(l!=null){let d=e.nodeDOM?.(l)||null;if(d&&d.nodeType===1)return d}}catch{}let r=null;for(let s=n.depth;s>=0;s-=1){let c=n.node(s)?.type?.name;if(c==="tableCell"||c==="tableHeader"){r=s;break}}if(r!=null){let s=n.before(r),c=e.nodeDOM?.(s)||null;if(c&&c.nodeType===1)return c}let o=e.domAtPos(t.from);return((o?.node&&o.node.nodeType===1?o.node:o?.node?.parentElement)||null)?.closest?.("td,th")||null}catch{return null}}function So(e){try{if(!e)return null;let t=e.querySelector("colgroup");if(!t)return null;let n=Array.from(t.querySelectorAll("col"));if(!n.length)return null;let r=n.map(d=>Wf(d));if(r.some(d=>typeof d=="number"&&Number.isFinite(d)&&d>0)){let d=100/n.length;return r.map(u=>typeof u=="number"&&Number.isFinite(u)&&u>0?u:d)}let i=e.querySelector("tbody tr");if(!i)return null;let s=Array.from(i.children||[]).filter(d=>d&&d.nodeType===1);if(s.length<n.length)return null;let c=[];for(let d=0;d<n.length;d+=1){let u=s[d].getBoundingClientRect();c.push(Number.isFinite(u.width)?u.width:0)}let l=c.reduce((d,u)=>d+(Number.isFinite(u)?u:0),0);return l>0?c.map(d=>jn(d/l*100)):null}catch{return null}}function xo(e,t){try{if(!e)return!1;let n=e.querySelector("colgroup");if(!n)return!1;let r=Array.from(n.querySelectorAll("col"));if(!r.length||!Array.isArray(t)||t.length!==r.length)return!1;for(let o=0;o<r.length;o+=1)Ps(r[o],t[o]);try{e.style.width="100%",e.style.maxWidth="100%",e.style.tableLayout="fixed"}catch{}return!0}catch{return!1}}function Yf(e,t){try{let n=Array.isArray(e)?e.map(m=>Number(m)||0):null,r=Number(t);if(!n||!Number.isFinite(r)||r<0||r>=n.length||n.length<=1)return null;let o=Math.max(0,n[r]||0),i=n.slice(0,r),s=n.slice(r+1),c=s.reduce((m,g)=>m+(Number.isFinite(g)?g:0),0),l=s;if(s.length)if(c>0){let m=(c+o)/c;l=s.map(g=>Number.isFinite(g)?g*m:0)}else{let m=(o||0)/s.length;l=s.map(()=>m)}else i.length&&(i[i.length-1]=Math.max(1,(i[i.length-1]||0)+o));let d=[...i,...l].map(m=>jn(m)),u=d.reduce((m,g)=>m+(Number.isFinite(g)?g:0),0);return u>0&&Math.abs(u-100)>.01&&(d[d.length-1]=jn(d[d.length-1]+(100-u))),d}catch{return null}}function Wt(e){try{let t=Et?.TableMap||null,n=e?.selection||null,r=n?.$from||null,i=n?.$anchorCell||null||r||null;if(!i)return null;let s=null;for(let h=i.depth;h>=0;h-=1)if(i.node(h)?.type?.name==="table"){s=h;break}if(s==null)return null;let c=i.before(s),l=e.doc.nodeAt(c);if(!l||l.type?.name!=="table")return null;let d=null;for(let h=s+1;h<=i.depth;h+=1){let b=i.node(h)?.type?.name;if(b==="tableCell"||b==="tableHeader"){d=h;break}}if(d==null)return null;let u=i.before(d),m=t?.get?t.get(l):null;if(!m)return null;let g=u-c-1,w=m.findCell(g),y=Number(w?.left??0),f=Number(w?.top??0);return{tablePos:c,tableNode:l,map:m,colIndex:y,rowIndex:f}}catch{return null}}function Rc(e){try{let t=[],n=e?.selection,r=e?.doc;if(!n||!r)return t;try{r.nodesBetween(n.from,n.to,(i,s)=>{let c=i?.type?.name;(c==="tableCell"||c==="tableHeader")&&t.push({node:i,pos:s})})}catch{}if(!t.length)try{let i=n.$from||null;if(i)for(let s=i.depth;s>=0;s-=1){let c=i.node(s)?.type?.name;if(c==="tableCell"||c==="tableHeader"){let l=i.before(s),d=r.nodeAt(l);d&&t.push({node:d,pos:l});break}}}catch{}let o=new Map;for(let i of t){let s=Number(i?.pos);Number.isFinite(s)&&(o.has(s)||o.set(s,i))}return Array.from(o.values()).sort((i,s)=>Number(i.pos)-Number(s.pos))}catch{return[]}}function Xg(e,t){try{let n=Et?.CellSelection||null,r=Et?.TableMap||null;return!n||!r?!1:e.commands.command(({state:o,dispatch:i})=>{let s=Wt(o);if(!s)return!1;let{tablePos:c,tableNode:l,map:d}=s,u=Number(t);if(!Number.isFinite(u)||u<0||u>=d.height)return!1;let m=d.positionAt(u,0,l),g=d.positionAt(u,d.width-1,l),w=c+1+m,y=c+1+g,f=null;try{typeof n.create=="function"&&(f=n.create(o.doc,w,y))}catch{f=null}if(!f)return!1;let h=o.tr.setSelection(f);return h=h.setMeta(le,!0),i(h.scrollIntoView()),!0})}catch{return!1}}function Gg(e,t,n){try{let r=Et?.CellSelection||null,o=Et?.TableMap||null;if(!r||!o)return!1;let i=Number(t),s=Number(n);return!Number.isFinite(i)||i<0||!Number.isFinite(s)||s<0?!1:e.commands.command(({state:c,dispatch:l})=>{let d=c?.doc?.nodeAt?.(i)||null;if(!d||d.type?.name!=="table")return!1;let u=o?.get?o.get(d):null;if(!u||s>=u.height)return!1;let m=u.positionAt(s,0,d),g=u.positionAt(s,u.width-1,d),w=i+1+m,y=i+1+g,f=null;try{typeof r.create=="function"&&(f=r.create(c.doc,w,y))}catch{f=null}if(!f)return!1;let h=c.tr.setSelection(f);return h=h.setMeta(le,!0),l(h.scrollIntoView()),!0})}catch{return!1}}function Qg(e,t){try{let n=Et?.CellSelection||null,r=Et?.TableMap||null;return!n||!r?!1:e.commands.command(({state:o,dispatch:i})=>{let s=Wt(o);if(!s)return!1;let{tablePos:c,tableNode:l,map:d}=s,u=Number(t);if(!Number.isFinite(u)||u<0||u>=d.width)return!1;let m=d.positionAt(0,u,l),g=d.positionAt(d.height-1,u,l),w=c+1+m,y=c+1+g,f=null;try{typeof n.create=="function"&&(f=n.create(o.doc,w,y))}catch{f=null}if(!f)return!1;let h=o.tr.setSelection(f);return h=h.setMeta(le,!0),i(h.scrollIntoView()),!0})}catch{return!1}}function Zg(e,t,n){try{let r=Et?.CellSelection||null,o=Et?.TableMap||null;if(!r||!o)return!1;let i=Number(t),s=Number(n);return!Number.isFinite(i)||i<0||!Number.isFinite(s)||s<0?!1:e.commands.command(({state:c,dispatch:l})=>{let d=c?.doc?.nodeAt?.(i)||null;if(!d||d.type?.name!=="table")return!1;let u=o?.get?o.get(d):null;if(!u||s>=u.width)return!1;let m=u.positionAt(0,s,d),g=u.positionAt(u.height-1,s,d),w=i+1+m,y=i+1+g,f=null;try{typeof r.create=="function"&&(f=r.create(c.doc,w,y))}catch{f=null}if(!f)return!1;let h=c.tr.setSelection(f);return h=h.setMeta(le,!0),l(h.scrollIntoView()),!0})}catch{return!1}}function ey({pmState:e,dispatch:t},{tablePos:n,rowIndex:r,attr:o,value:i}){try{let s=Et?.CellSelection||null,c=Et?.TableMap||null;if(!c)return!1;let l=Number(n),d=Number(r);if(!Number.isFinite(l)||l<0||!Number.isFinite(d)||d<0)return!1;let u=e?.doc?.nodeAt?.(l)||null;if(!u||u.type?.name!=="table")return!1;let m=c?.get?c.get(u):null;if(!m||d>=m.height)return!1;let g=e.tr;try{if(s?.create){let f=m.positionAt(d,0,u),h=m.positionAt(d,m.width-1,u),b=l+1+f,S=l+1+h;g=g.setSelection(s.create(g.doc,b,S))}}catch{}let w=new Set;for(let f=0;f<m.width;f+=1){let h=m.map[d*m.width+f];Number.isFinite(h)&&w.add(l+1+h)}if(!w.size)return!1;let y=!1;for(let f of w){let h=g.doc.nodeAt(f),b=h?.type?.name;if(b!=="tableCell"&&b!=="tableHeader")continue;let S={...h.attrs||{}};i==null||i===""?delete S[o]:S[o]=i,g=g.setNodeMarkup(f,void 0,S),y=!0}return y?(g=g.setMeta(le,!0),t(g),!0):!1}catch{return!1}}function ty({pmState:e,dispatch:t},{tablePos:n,colIndex:r,attr:o,value:i}){try{let s=Et?.CellSelection||null,c=Et?.TableMap||null;if(!c)return!1;let l=Number(n),d=Number(r);if(!Number.isFinite(l)||l<0||!Number.isFinite(d)||d<0)return!1;let u=e?.doc?.nodeAt?.(l)||null;if(!u||u.type?.name!=="table")return!1;let m=c?.get?c.get(u):null;if(!m||d>=m.width)return!1;let g=e.tr;try{if(s?.create){let f=m.positionAt(0,d,u),h=m.positionAt(m.height-1,d,u),b=l+1+f,S=l+1+h;g=g.setSelection(s.create(g.doc,b,S))}}catch{}let w=new Set;for(let f=0;f<m.height;f+=1){let h=m.map[f*m.width+d];Number.isFinite(h)&&w.add(l+1+h)}if(!w.size)return!1;let y=!1;for(let f of w){let h=g.doc.nodeAt(f),b=h?.type?.name;if(b!=="tableCell"&&b!=="tableHeader")continue;let S={...h.attrs||{}};i==null||i===""?delete S[o]:S[o]=i,g=g.setNodeMarkup(f,void 0,S),y=!0}return y?(g=g.setMeta(le,!0),t(g),!0):!1}catch{return!1}}function Ds(e,t="\u0442\u0430\u0431\u043B\u0438\u0446\u044B"){try{let n=!1;return e.descendants(r=>{if(n)return!1;let o=r?.type?.name;if(o==="tableCell"||o==="tableHeader"){let i=Number(r.attrs?.colspan||1),s=Number(r.attrs?.rowspan||1);if(i!==1||s!==1)return n=!0,!1}return!0}),n?(L(`\u041F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 ${t} \u043F\u043E\u043A\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u0445 \u044F\u0447\u0435\u0435\u043A`),!1):!0}catch{return!1}}function Xf(e,{kind:t,fromIndex:n,toIndex:r}){try{if(!e||!(Et?.TableMap||null))return!0;let i=e.map||null,s=e.tableNode||null;if(!i||!s)return!0;let c=Number(n),l=Number(r);if(!Number.isFinite(c)||!Number.isFinite(l))return!0;let d=t==="row"?Math.max(0,Math.min(i.height-1,c)):Math.max(0,Math.min(i.width-1,c)),u=t==="row"?Math.max(0,Math.min(i.height-1,l)):Math.max(0,Math.min(i.width-1,l)),m=new Set;for(let g of i.map){let w=Number(g);if(!Number.isFinite(w)||w<0||m.has(w))continue;m.add(w);let y=null;try{y=i.findCell(w)}catch{y=null}if(!y)continue;let f=Number(y.right)-Number(y.left),h=Number(y.bottom)-Number(y.top);if(f>1||h>1)if(t==="col"){let b=Number(y.left),S=Number(y.right);if(b<=d&&d<S||b<=u&&u<S)return!0}else{let b=Number(y.top),S=Number(y.bottom);if(b<=d&&d<S||b<=u&&u<S)return!0}}return!1}catch{return!0}}function Af(e,t){try{if(!e?.view)return!1;let n=Wt(e.state);if(!n)return!1;let{colIndex:r}=n,o=n.map?.width||0;if(!(o>0))return!1;let i=t<0?-1:1,s=r+i;return s>=0&&s<o?Gf(e,r,s):!1}catch{return!1}}function If(e,t){try{if(!e?.view)return!1;let n=Wt(e.state);if(!n)return!1;let{rowIndex:r}=n,o=n.map?.height||0;if(!(o>0))return!1;let i=t<0?-1:1,s=r+i;return s>=0&&s<o?Qf(e,r,s):!1}catch{return!1}}function Gf(e,t,n){try{if(!e?.view)return!1;let r=e.state,o=Wt(r);if(!o)return!1;let{tableNode:i}=o,s=o.map?.width||0;if(!(s>0))return!1;let c=Number(t),l=Number(n);if(!Number.isFinite(c)||!Number.isFinite(l)||c<0||c>=s||l<0||l>=s)return!1;if(c===l)return!0;if(Xf(o,{kind:"col",fromIndex:c,toIndex:l}))return L("\u041D\u0435\u043B\u044C\u0437\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u043E\u043B\u0431\u0435\u0446: \u0438\u0441\u0445\u043E\u0434\u043D\u0430\u044F \u0438\u043B\u0438 \u0446\u0435\u043B\u0435\u0432\u0430\u044F \u043A\u043E\u043B\u043E\u043D\u043A\u0430 \u043F\u0435\u0440\u0435\u0441\u0435\u043A\u0430\u0435\u0442\u0441\u044F \u0441 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u043C\u0438 \u044F\u0447\u0435\u0439\u043A\u0430\u043C\u0438"),!1;let d=sn(e.view),u=So(d),m=Array.isArray(u)&&u.length===s?(()=>{let f=u.slice(),h=f.splice(c,1)[0];return f.splice(l,0,h),f})():null,g=Et?.moveTableColumn||null;if(typeof g!="function")return!1;let w=g({from:c,to:l,select:!0});return e.commands.command(({state:f,dispatch:h})=>w(f,typeof h=="function"?S=>{try{S=S.setMeta(le,!0)}catch{}h(S)}:void 0))?(m&&window.requestAnimationFrame(()=>{let f=sn(e.view);xo(f,m);try{(f?.closest?.(".tableWrapper")||null)?.dispatchEvent?.(new Event("scroll"))}catch{}}),!0):!1}catch{return!1}}function Qf(e,t,n){try{if(!e?.view)return!1;let r=e.state,o=Wt(r);if(!o)return!1;let i=o.map?.height||0,s=o.map?.width||0;if(!(s>0&&i>0))return!1;let c=Number(t),l=Number(n);if(!Number.isFinite(c)||!Number.isFinite(l)||c<0||c>=i||l<0||l>=i)return!1;if(c===l)return!0;if(Xf(o,{kind:"row",fromIndex:c,toIndex:l}))return L("\u041D\u0435\u043B\u044C\u0437\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u043E\u043A\u0443: \u0438\u0441\u0445\u043E\u0434\u043D\u0430\u044F \u0438\u043B\u0438 \u0446\u0435\u043B\u0435\u0432\u0430\u044F \u0441\u0442\u0440\u043E\u043A\u0430 \u043F\u0435\u0440\u0435\u0441\u0435\u043A\u0430\u0435\u0442\u0441\u044F \u0441 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u043C\u0438 \u044F\u0447\u0435\u0439\u043A\u0430\u043C\u0438"),!1;let d=sn(e.view),u=So(d),m=Et?.moveTableRow||null;if(typeof m!="function")return!1;let g=m({from:c,to:l,select:!0});return e.commands.command(({state:y,dispatch:f})=>g(y,typeof f=="function"?b=>{try{b=b.setMeta(le,!0)}catch{}f(b)}:void 0))?(Array.isArray(u)&&u.length===s&&window.requestAnimationFrame(()=>{let y=sn(e.view);xo(y,u)}),!0):!1}catch{return!1}}function Zf(e){try{if(!e)return"";let t=e.textContent||"";return String(t).replace(/\s+/g," ").trim()}catch{return""}}function ny(e){try{if(!e)return!1;for(let t=0;t<e.childCount;t+=1)if(e.child(t)?.type?.name==="tableHeader")return!0;return!1}catch{return!1}}function vf(e,{direction:t="asc"}={}){try{if(!e?.view)return!1;let n=e.state,r=Wt(n);if(!r)return!1;let{tablePos:o,tableNode:i,colIndex:s}=r,c=i.child(0)?.childCount||0,l=i.childCount||0;if(!(c>0&&l>1)||!(s>=0&&s<c)||!Ds(i,"\u0442\u0430\u0431\u043B\u0438\u0446\u044B"))return!1;let d=ny(i.child(0))?i.child(0):null,u=d?1:0,m=[];for(let h=u;h<l;h+=1){let b=i.child(h),S=b.child(s);m.push({rowIndex:h,rowNode:b,key:Zf(S)})}let g=t==="desc"?-1:1;m.sort((h,b)=>g*h.key.localeCompare(b.key,void 0,{sensitivity:"base",numeric:!0}));let w=[];d&&w.push(d);for(let h of m)w.push(h.rowNode);let y=i.type.create(i.attrs,w),f=n.tr.replaceWith(o,o+i.nodeSize,y);return f=f.setMeta(le,!0),e.view.dispatch(f.scrollIntoView()),!0}catch{return!1}}function Ef(e,{direction:t="asc"}={}){try{if(!e?.view)return!1;let n=e.state,r=Wt(n);if(!r)return!1;let{tablePos:o,tableNode:i,rowIndex:s}=r,c=i.child(0)?.childCount||0,l=i.childCount||0;if(!(c>1&&l>0)||!(s>=0&&s<l)||!Ds(i,"\u0442\u0430\u0431\u043B\u0438\u0446\u044B"))return!1;let d=i.child(s),u=[];for(let x=0;x<c;x+=1)u.push({colIndex:x,key:Zf(d.child(x))});let m=t==="desc"?-1:1;u.sort((x,v)=>m*x.key.localeCompare(v.key,void 0,{sensitivity:"base",numeric:!0}));let g=u.map(x=>x.colIndex),w=sn(e.view),y=So(w),f=Array.isArray(y)&&y.length===c?g.map(x=>y[x]):null,h=[];for(let x=0;x<l;x+=1){let v=i.child(x),B=g.map(N=>v.child(N));h.push(v.type.create(v.attrs,B))}let b=i.type.create(i.attrs,h),S=n.tr.replaceWith(o,o+i.nodeSize,b);return S=S.setMeta(le,!0),e.view.dispatch(S.scrollIntoView()),f&&window.requestAnimationFrame(()=>{let x=sn(e.view);xo(x,f)}),!0}catch{return!1}}function ry(e){try{if(!e?.view)return!1;let t=e.state,n=Wt(t);if(!n)return!1;let{tablePos:r,tableNode:o,rowIndex:i,colIndex:s}=n,c=o.child(0)?.childCount||0,l=o.childCount||0;if(!(c>0&&l>0)||!(i>=0&&i<l)||!Ds(o,"\u0441\u0442\u0440\u043E\u043A"))return!1;let d=o.child(i),u=[];for(let w=0;w<l;w+=1)u.push(o.child(w)),w===i&&u.push(d.type.create(d.attrs,d.content,d.marks));let m=o.type.create(o.attrs,u),g=t.tr.replaceWith(r,r+o.nodeSize,m);g=g.setMeta(le,!0);try{let w=He?.pmStateMod?.TextSelection;if(w){let y=Math.min(m.childCount-1,i+1),f=Math.min(c-1,Math.max(0,s)),h=m.child(y),b=h.child(f),S=r+1;for(let N=0;N<y;N+=1)S+=m.child(N).nodeSize;S+=1;for(let N=0;N<f;N+=1)S+=h.child(N).nodeSize;let x=S,v=x+1,B=x+b.nodeSize-1;g=g.setSelection(w.near(g.doc.resolve(Math.min(B,v+1)),1))}}catch{}return e.view.dispatch(g.scrollIntoView()),!0}catch{return!1}}function oy(e){try{if(!e?.view)return!1;let t=e.state,n=Wt(t);if(!n)return!1;let{tablePos:r,tableNode:o,rowIndex:i,colIndex:s}=n,c=o.child(0)?.childCount||0,l=o.childCount||0;if(!(c>0&&l>0)||!(s>=0&&s<c)||!Ds(o,"\u0441\u0442\u043E\u043B\u0431\u0446\u043E\u0432"))return!1;let d=sn(e.view),u=So(d),m=null;if(Array.isArray(u)&&u.length===c){let f=[...u],h=Math.max(0,Number(f[s]||0)),b=jn(h/2);f[s]=b,f.splice(s+1,0,b);let S=f.reduce((x,v)=>x+(Number.isFinite(v)?v:0),0);S>0&&Math.abs(S-100)>.01&&(f[f.length-1]=jn(f[f.length-1]+(100-S))),m=f}let g=[];for(let f=0;f<l;f+=1){let h=o.child(f),b=[];for(let S=0;S<c;S+=1){let x=h.child(S);b.push(x),S===s&&b.push(x.type.create(x.attrs,x.content,x.marks))}g.push(h.type.create(h.attrs,b))}let w=o.type.create(o.attrs,g),y=t.tr.replaceWith(r,r+o.nodeSize,w);y=y.setMeta(le,!0);try{let f=He?.pmStateMod?.TextSelection;if(f){let h=Math.min(w.childCount-1,Math.max(0,i)),b=Math.min(c,Math.max(0,s+1)),S=w.child(h),x=S.child(b),v=r+1;for(let P=0;P<h;P+=1)v+=w.child(P).nodeSize;v+=1;for(let P=0;P<b;P+=1)v+=S.child(P).nodeSize;let B=v,N=B+1,z=B+x.nodeSize-1;y=y.setSelection(f.near(y.doc.resolve(Math.min(z,N+1)),1))}}catch{}return e.view.dispatch(y.scrollIntoView()),Array.isArray(m)&&m.length===c+1?window.requestAnimationFrame(()=>{let f=sn(e.view);xo(f,m)}):window.requestAnimationFrame(()=>{let f=sn(e.view);Cs(f)}),!0}catch{return!1}}function iy(e,t,n){try{if(!e?.view)return!1;let{state:r,view:o}=e,{selection:i}=r,s=i?.$from||null;if(!s)return!1;let c=n instanceof Set?n:new Set(Array.from(n||[])),l=null;for(let N=s.depth;N>0;N-=1)if(s.node(N)?.type?.name==="paragraph"){let z=s.node(N-1)?.type?.name||"";c.has(z)&&(l=N);break}if(l==null)return!1;let d=l-1,u=s.node(d),m=s.index(d);if(!u)return!1;let g=t<0?-1:1,w=m+g;if(!(w>=0&&w<u.childCount))return!1;let y=u.child(m),f=u.child(w);if(y?.type?.name!=="paragraph"||f?.type?.name!=="paragraph")return!1;let h=s.before(l),b=y.nodeSize,S=g<0?h-f.nodeSize:h+b,x=f.nodeSize,v=Math.max(0,i.from-s.start(l)),B=r.tr;if(g<0){B=B.delete(h,h+b),B=B.insert(S,y);let N=S,z=N+1,P=N+y.nodeSize-1,W=z+v,q=Math.min(Math.max(W,z),P);try{let ee=He?.pmStateMod?.TextSelection;ee&&(B=B.setSelection(ee.near(B.doc.resolve(q),1)))}catch{}}else{B=B.delete(h,h+b);let N=h+x;B=B.insert(N,y);let z=N,P=z+1,W=z+y.nodeSize-1,q=P+v,ee=Math.min(Math.max(q,P),W);try{let de=He?.pmStateMod?.TextSelection;de&&(B=B.setSelection(de.near(B.doc.resolve(ee),1)))}catch{}}return B=B.setMeta(le,!0),o.dispatch(B.scrollIntoView()),!0}catch{return!1}}function Tf(e,t){return iy(e,t,new Set(["outlineBody","tableCell","tableHeader"]))}function Cf(e,t){try{if(!e?.view)return!1;let{state:n,view:r}=e,{selection:o}=n,i=o?.$from||null;if(!i)return!1;let s=null;for(let v=i.depth;v>0;v-=1)if(i.node(v)?.type?.name==="listItem"){s=v;break}if(s==null)return!1;let c=s-1,l=i.node(c),d=l?.type?.name||"";if(d!=="bulletList"&&d!=="orderedList")return!1;let u=i.index(c),m=t<0?-1:1,g=u+m;if(!(g>=0&&g<l.childCount))return!1;let w=l.child(u),y=l.child(g);if(w?.type?.name!=="listItem"||y?.type?.name!=="listItem")return!1;let f=i.before(s),h=w.nodeSize,b=y.nodeSize,S=Math.max(0,o.from-i.start(s)),x=n.tr;if(m<0){let v=f-b;x=x.delete(f,f+h),x=x.insert(v,w);let B=v,N=B+1,z=B+w.nodeSize-1,P=N+S,W=Math.min(Math.max(P,N),z);try{let q=He?.pmStateMod?.TextSelection;q&&(x=x.setSelection(q.near(x.doc.resolve(W),1)))}catch{}}else{x=x.delete(f,f+h);let v=f+b;x=x.insert(v,w);let B=v,N=B+1,z=B+w.nodeSize-1,P=N+S,W=Math.min(Math.max(P,N),z);try{let q=He?.pmStateMod?.TextSelection;q&&(x=x.setSelection(q.near(x.doc.resolve(W),1)))}catch{}}return x=x.setMeta(le,!0),r.dispatch(x.scrollIntoView()),!0}catch{return!1}}function sy(e){if(!p.outlineToolbar||!e)return;let t=p.outlineToolbar,n=null,r={undo:p.outlineUndoBtn,redo:p.outlineRedoBtn,deleteBtn:p.outlineDeleteBtn,moveUpBtn:p.outlineMoveUpBtn,moveDownBtn:p.outlineMoveDownBtn,outdentBtn:p.outlineOutdentBtn,indentBtn:p.outlineIndentBtn,newBelowBtn:p.outlineNewBelowBtn,blocksMenuBtn:t.querySelector("#outlineBlocksMenuBtn"),textMenuBtn:t.querySelector("#outlineTextMenuBtn"),listsMenuBtn:t.querySelector("#outlineListsMenuBtn"),tableMenuBtn:t.querySelector("#outlineTableMenuBtn")},o=new Set(Array.from(t.querySelectorAll(".outline-toolbar__dropdown-btn")));r.blocksMenuBtn&&o.add(r.blocksMenuBtn),r.textMenuBtn&&o.add(r.textMenuBtn),r.listsMenuBtn&&o.add(r.listsMenuBtn),r.tableMenuBtn&&o.add(r.tableMenuBtn);let i=Array.from(o),s=Array.from(t.querySelectorAll(".outline-toolbar__menu")),c=Array.from(t.querySelectorAll("[data-outline-action]")),l=Array.from(t.querySelectorAll("[data-outline-clipboard-action]")),d=(G,ue)=>{if(!G)return()=>{};let be=fe=>{fe.preventDefault(),fe.stopPropagation(),ue()};return G.addEventListener("click",be),()=>G.removeEventListener("click",be)},u=(G,ue)=>{if(!G)return()=>{};let be=0,fe=Z=>{be=Date.now(),Z.preventDefault(),Z.stopPropagation(),ue()},se=Z=>fe(Z),he=Z=>fe(Z),ye=Z=>{if(Date.now()-be<450){Z.preventDefault(),Z.stopPropagation();return}fe(Z)};try{G.addEventListener("pointerdown",se)}catch{}try{G.addEventListener("touchstart",he,{passive:!1})}catch{try{G.addEventListener("touchstart",he)}catch{}}return G.addEventListener("click",ye),()=>{try{G.removeEventListener("pointerdown",se)}catch{}G.removeEventListener("touchstart",he),G.removeEventListener("click",ye)}},m=(G,ue)=>{G&&(G.classList.toggle("is-active",!!ue),G.setAttribute("aria-pressed",ue?"true":"false"))},g=()=>{for(let G of s)G.classList.add("hidden");for(let G of i)G.setAttribute("aria-expanded","false")},w=()=>{let G=bf(),ue=!!(G&&Array.isArray(G.sections)&&G.sections.length);for(let be of l)be?.getAttribute?.("data-outline-clipboard-action")==="paste"&&be.toggleAttribute("disabled",!ue)},y=G=>{if(!G)return;let ue=G.getAttribute("aria-controls"),be=ue?t.querySelector(`#${ue}`)||document.getElementById(ue):null;if(!be)return;let fe=!be.classList.contains("hidden");g(),fe||(ue==="outlineBlocksMenu"&&w(),be.classList.remove("hidden"),G.setAttribute("aria-expanded","true"))},f=G=>{try{let ue=e.can().chain();return b()&&ue.command(({tr:be})=>(be.setMeta(le,!0),!0)),G(ue),ue.run()}catch{return!1}},h=G=>{if(!G)return!1;try{let ue=e.chain().focus();if(b()&&ue.command(({tr:be})=>(be.setMeta(le,!0),!0)),G==="collapseAllBlocks")return qc(e,!0);if(G==="expandAllBlocks")return qc(e,!1);if(G==="toggleBold")return ue.toggleBold().run();if(G==="toggleItalic")return ue.toggleItalic().run();if(G==="toggleStrike")return ue.toggleStrike().run();if(G==="toggleCodeBlock")return e.commands.command(({state:be,dispatch:fe})=>{let se=be.schema.nodes?.codeBlock||null;if(!se)return!1;let he=be.selection,{from:ye,to:Z}=he;if(ye===Z){let Ye=be.tr.setMeta(le,!0);return fe(Ye),e.commands.toggleCodeBlock()}let we=he.$from?.blockRange?.(he.$to)||null;if(!we){let Ye=be.tr.setMeta(le,!0);return fe(Ye),e.commands.toggleCodeBlock()}if(!we.parent?.canReplaceWith?.(we.startIndex,we.endIndex,se)){let Ye=be.tr.setMeta(le,!0);return fe(Ye),e.commands.toggleCodeBlock()}let De=be.doc.textBetween(we.start,we.end,`
`,`
`),$e=String(De||"").replace(/\n+$/g,"").trimEnd();if(!$e)return!1;let et=se.create(null,be.schema.text($e)),tt=be.tr.replaceRangeWith(we.start,we.end,et);return tt=tt.setMeta(le,!0),de&&(tt=tt.setSelection(de.near(tt.doc.resolve(we.start+2),1))),fe(tt.scrollIntoView()),!0});if(G==="toggleBlockquote")return ue.toggleBlockquote().run();if(G==="unsetLink")return ue.unsetLink().run();if(G==="toggleBulletList")return e.isActive("orderedList")?ue.toggleOrderedList().toggleBulletList().run():ue.toggleBulletList().run();if(G==="toggleOrderedList")return e.isActive("bulletList")?ue.toggleBulletList().toggleOrderedList().run():ue.toggleOrderedList().run();if(G==="unsetList")return e.isActive("bulletList")?ue.toggleBulletList().run():e.isActive("orderedList")?ue.toggleOrderedList().run():ue.liftListItem("listItem").run();if(G==="insertTable")return ue.insertTable({rows:2,cols:2,withHeaderRow:!1}).run();if(G==="toggleHeaderRow")return ue.toggleHeaderRow().run();if(G==="toggleHeaderColumn")return ue.toggleHeaderColumn().run();if(G==="addRowBefore")return ue.addRowBefore().run();if(G==="addRowAfter")return ue.addRowAfter().run();if(G==="deleteRow")return ue.deleteRow().run();if(G==="addColumnBefore"){let be=Wt(e.state),fe=be?Math.max(0,Number(be.colIndex||0)):0,se=ue.addColumnBefore().run();return se&&Ls(e,{insertIndex:fe,newColPct:10}),se}if(G==="addColumnAfter"){let be=Wt(e.state),fe=be?Math.max(0,Number(be.colIndex||0)+1):1,se=ue.addColumnAfter().run();return se&&Ls(e,{insertIndex:fe,newColPct:10}),se}if(G==="deleteColumn"){let be=sn(e.view),fe=So(be),se=Wt(e.state),he=se?Number(se.colIndex||0):null,ye=fe&&he!=null?Yf(fe,he):null,Z=ue.deleteColumn().run();return Z&&Array.isArray(ye)&&window.requestAnimationFrame(()=>{let we=sn(e.view);xo(we,ye)}),Z}return G==="mergeCells"?ue.mergeCells().run():G==="splitCell"?ue.splitCell().run():G==="copyColumn"||G==="pasteColumnAfter"||G==="moveColumnRight"?!1:G==="cancelTable"?x():G==="deleteTable"?ue.deleteTable().run():!1}catch{return!1}},b=()=>{try{return!!(ke?.getState?.(e.state)||null)?.editingSectionId}catch{return!1}},S=()=>b()?!0:(wo(),!1),x=()=>{if(!S())return!1;try{let{state:G,view:ue}=e,{schema:be,selection:fe}=G,se=fe?.$from;if(!se)return!1;let he=null;for(let Xe=se.depth;Xe>=0;Xe-=1)se.node(Xe)?.type?.name==="table"&&(he=Xe);if(he==null)return!1;let ye=null,Z=null;for(let Xe=he+1;Xe<=se.depth;Xe+=1){let Ve=se.node(Xe)?.type?.name;if(ye==null&&Ve==="tableRow"&&(ye=Xe),Z==null&&(Ve==="tableCell"||Ve==="tableHeader")&&(Z=Xe),ye!=null&&Z!=null)break}let we=se.before(he),De=G.doc.nodeAt(we);if(!De||De.type?.name!=="table")return!1;let $e=ye!=null?se.index(he):null,et=ye!=null&&Z!=null?se.index(ye):null,tt=null;if(typeof $e=="number"&&typeof et=="number"){let Xe=De.childCount&&De.child(0)?.childCount||0;Xe>0&&(tt=$e*Xe+et)}let Ye=[],Ue=0,ft=0;for(let Xe=0;Xe<De.childCount;Xe+=1){let ut=De.child(Xe);for(let Ve=0;Ve<ut.childCount;Ve+=1){let gn=ut.child(Ve),Yt=[];try{for(let Qt=0;Qt<(gn?.content?.childCount||0);Qt+=1){let en=gn.content.child(Qt);en&&Yt.push(en)}}catch{}Yt.length||Yt.push(be.nodes.paragraph.create(null,[])),tt!=null&&Ue===tt&&(ft=Ye.length),Ye.push(...Yt),Ue+=1}}if(!Ye.length)return!1;let dt=be.nodes.outlineBody?be.nodes.outlineBody.create({},Ye).content:be.nodes.doc.create({},Ye).content,Ze=G.tr.replaceWith(we,we+De.nodeSize,dt);Ze=Ze.setMeta(le,!0);try{let Xe=He?.pmStateMod?.TextSelection;if(Xe){let ut=we;for(let en=0;en<ft;en+=1)ut+=Ye[en].nodeSize;let Ve=null,gn=Math.min(Ze.doc.content.size,ut),Yt=Math.min(Ze.doc.content.size,ut+2e4);Ze.doc.nodesBetween(gn,Yt,(en,Hn)=>Ve!=null?!1:en?.isTextblock?(Ve=Hn+1,!1):!0);let Qt=Ve??Math.min(Ze.doc.content.size,ut+1);Ze=Ze.setSelection(Xe.near(Ze.doc.resolve(Qt),1))}}catch{}return ue.dispatch(Ze.scrollIntoView()),ue.focus?.(),!0}catch{return!1}},v=()=>{if(!S())return!1;try{let{state:G,view:ue}=e,{selection:be}=G,fe=be?.$from;if(!fe)return!1;let se=null,he=null,ye=null;for(let Ze=fe.depth;Ze>=0;Ze-=1){let ut=fe.node(Ze)?.type?.name;if(ye==null&&(ut==="tableCell"||ut==="tableHeader")&&(ye=Ze),he==null&&ut==="tableRow"&&(he=Ze),ut==="table"){se=Ze;break}}if(se==null||he==null||ye==null)return!1;let Z=fe.before(se),we=G.doc.nodeAt(Z);if(!we||we.type?.name!=="table")return!1;let De=fe.index(se),$e=fe.index(he),et=we.child(0)?.childCount||0;if(!(et>0)||!($e>=0&&$e<et-1))return!1;let tt=!1;if(we.descendants(Ze=>{if(tt)return!1;let Xe=Ze?.type?.name;if(Xe==="tableCell"||Xe==="tableHeader"){let ut=Number(Ze.attrs?.colspan||1),Ve=Number(Ze.attrs?.rowspan||1);if(ut!==1||Ve!==1)return tt=!0,!1}return!0}),tt)return L("\u041F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 \u0441\u0442\u043E\u043B\u0431\u0446\u043E\u0432 \u043F\u043E\u043A\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u0445 \u044F\u0447\u0435\u0435\u043A"),!1;let Ye=be.from-fe.start(ye),Ue=[];for(let Ze=0;Ze<we.childCount;Ze+=1){let Xe=we.child(Ze);if(Xe.type?.name!=="tableRow"||Xe.childCount!==et)return!1;let ut=[];for(let Ve=0;Ve<et;Ve+=1)Ve===$e?ut.push(Xe.child(Ve+1)):Ve===$e+1?ut.push(Xe.child(Ve-1)):ut.push(Xe.child(Ve));Ue.push(Xe.type.create(Xe.attrs,ut))}let ft=we.type.create(we.attrs,Ue),dt=G.tr.replaceWith(Z,Z+we.nodeSize,ft);dt=dt.setMeta(le,!0);try{let Ze=He?.pmStateMod?.TextSelection;if(Ze){let Xe=Math.min(ft.childCount-1,Math.max(0,De)),ut=$e+1,Ve=ft.child(Xe),gn=Ve.child(ut),Yt=Z+1;for(let k=0;k<Xe;k+=1)Yt+=ft.child(k).nodeSize;Yt+=1;for(let k=0;k<ut;k+=1)Yt+=Ve.child(k).nodeSize;let Qt=Yt,en=Qt+1,Hn=Qt+gn.nodeSize-1,Ut=en+Math.max(0,Ye),E=Math.min(Math.max(Ut,en),Hn);dt=dt.setSelection(Ze.near(dt.doc.resolve(E),1))}}catch{}return ue.dispatch(dt.scrollIntoView()),ue.focus?.(),!0}catch{return!1}},B=(G,ue,be={})=>{let fe=String(G||"").trim();if(!fe)return!1;let se=String(ue||"").trim()||fe,{from:he,to:ye,empty:Z}=e.state.selection,we={href:fe,...be},De=e.chain().focus();return b()&&De.command(({tr:$e})=>($e.setMeta(le,!0),!0)),!Z&&he!==ye?De.setLink(we).run():De.insertContent({type:"text",text:se,marks:[{type:"link",attrs:we}]}).run()},N=async()=>{if(!S())return;let{from:G,to:ue,empty:be}=e.state.selection,fe=be?"":e.state.doc.textBetween(G,ue," ").trim(),se="",he=fe;try{let Z=await(await Promise.resolve().then(()=>(Vn(),La))).showLinkPrompt({title:"\u0421\u0441\u044B\u043B\u043A\u0430 (URL)",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0441\u0441\u044B\u043B\u043A\u0443 (\u043B\u044E\u0431\u043E\u0439 \u0444\u043E\u0440\u043C\u0430\u0442) \u0438 \u0442\u0435\u043A\u0441\u0442 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E).",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",textLabel:"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)",urlLabel:"\u0421\u0441\u044B\u043B\u043A\u0430",defaultText:fe,defaultUrl:"",urlPlaceholder:""});if(!Z||typeof Z!="object")return;se=String(Z.url||""),he=String(Z.text??fe)}catch{se=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0441\u0441\u044B\u043B\u043A\u0443")||"",he=fe||window.prompt("\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)")||""}se=(se||"").trim(),se&&B(se,he,{target:"_blank",rel:"noopener noreferrer"})},z=async()=>{if(!S())return;let G=Array.isArray(a.articlesIndex)?a.articlesIndex:[];G.length||(G=await In().catch(()=>[])||[],Array.isArray(G)&&(a.articlesIndex=G));let ue=(Array.isArray(G)?G:[]).map(Ye=>({id:Ye.id,title:Ye.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),{from:be,to:fe,empty:se}=e.state.selection,he=se?"":e.state.doc.textBetween(be,fe," ").trim(),ye=!!he,Z="",we="",De=he;try{let Ue=await(await Promise.resolve().then(()=>(Vn(),La))).showArticleLinkPrompt({title:"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E \u0438 \u0437\u0430\u0434\u0430\u0439\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438.",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:ue,defaultTextValue:he,lockTextValue:ye});if(Ue&&typeof Ue=="object")Z=Ue.articleValue||"",we=Ue.selectedId||"",De=Ue.textValue||"";else return}catch{Z=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438")||"",De=he||window.prompt("\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)")||""}let $e=(Z||"").trim().toLowerCase();if(!$e&&!we)return;let et=(Array.isArray(G)?G:[]).find(Ye=>{let Ue=(Ye.title||"").toLowerCase();return we&&Ye.id===we||Ye.id&&Ye.id.toLowerCase()===$e||Ue===$e||Ue.includes($e)});if(!et){L("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}let tt=(De||"").trim()||et.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";B(pt.article(et.id),tt,{class:"article-link"})},P=()=>{if(!a.isOutlineEditing||!e||e.isDestroyed)return;let G=b();if(t.dataset.editing=G?"true":"false",n===null?n=G:n!==G&&(g(),n=G),r.deleteBtn&&(r.deleteBtn.hidden=G),r.moveUpBtn&&(r.moveUpBtn.hidden=G),r.moveDownBtn&&(r.moveDownBtn.hidden=G),r.outdentBtn&&(r.outdentBtn.hidden=G),r.indentBtn&&(r.indentBtn.hidden=G),r.newBelowBtn&&(r.newBelowBtn.hidden=G),r.blocksMenuBtn&&(r.blocksMenuBtn.hidden=G),G&&dr&&si(!1),r.undo&&(r.undo.disabled=!f(fe=>fe.undo())),r.redo&&(r.redo.disabled=!f(fe=>fe.redo())),r.textMenuBtn){let fe=e.isActive("bold")||e.isActive("italic")||e.isActive("strike")||e.isActive("codeBlock")||e.isActive("blockquote");m(r.textMenuBtn,fe),r.textMenuBtn.hidden=!G}if(r.listsMenuBtn){let fe=e.isActive("bulletList")||e.isActive("orderedList");m(r.listsMenuBtn,fe),r.listsMenuBtn.hidden=!G}if(r.tableMenuBtn){let fe=e.isActive("table");m(r.tableMenuBtn,fe),r.tableMenuBtn.hidden=!G}let ue=null,be=()=>{if(ue)return ue;let fe={total:0,collapsed:0};try{e.state.doc.descendants(se=>{se?.type?.name==="outlineSection"&&(fe.total+=1,se.attrs?.collapsed&&(fe.collapsed+=1))})}catch{}return ue=fe,fe};for(let fe of c){let se=fe.dataset.outlineAction||"";if(!se)continue;let he=!1,ye=!1;if(se==="collapseAllBlocks"){let Z=be();he=!1,ye=Z.total===0||Z.collapsed>=Z.total}else if(se==="expandAllBlocks"){let Z=be();he=!1,ye=Z.total===0||Z.collapsed<=0}else se==="toggleBold"?(he=e.isActive("bold"),ye=!f(Z=>Z.toggleBold())):se==="toggleItalic"?(he=e.isActive("italic"),ye=!f(Z=>Z.toggleItalic())):se==="toggleStrike"?(he=e.isActive("strike"),ye=!f(Z=>Z.toggleStrike())):se==="toggleCodeBlock"?(he=e.isActive("codeBlock"),ye=!b()):se==="toggleBlockquote"?(he=e.isActive("blockquote"),ye=!f(Z=>Z.toggleBlockquote())):se==="insertHttpLink"||se==="insertArticleLink"?(he=!1,ye=!b()):se==="unsetLink"?(he=e.isActive("link"),ye=!f(Z=>Z.unsetLink())):se==="toggleBulletList"?(he=e.isActive("bulletList"),e.isActive("orderedList")?ye=!(f(Z=>Z.toggleOrderedList())&&f(Z=>Z.toggleBulletList())):ye=!f(Z=>Z.toggleBulletList())):se==="toggleOrderedList"?(he=e.isActive("orderedList"),e.isActive("bulletList")?ye=!(f(Z=>Z.toggleBulletList())&&f(Z=>Z.toggleOrderedList())):ye=!f(Z=>Z.toggleOrderedList())):se==="unsetList"?(he=!1,e.isActive("bulletList")?ye=!f(Z=>Z.toggleBulletList()):e.isActive("orderedList")?ye=!f(Z=>Z.toggleOrderedList()):ye=!f(Z=>Z.liftListItem("listItem"))):se==="insertTable"?(he=!1,ye=!f(Z=>Z.insertTable({rows:2,cols:2,withHeaderRow:!1}))):se==="toggleHeaderRow"?(he=e.isActive("tableHeader"),ye=!f(Z=>Z.toggleHeaderRow())):se==="toggleHeaderColumn"?(he=e.isActive("tableHeader"),ye=!f(Z=>Z.toggleHeaderColumn())):se==="addRowBefore"?(he=!1,ye=!f(Z=>Z.addRowBefore())):se==="addRowAfter"?(he=!1,ye=!f(Z=>Z.addRowAfter())):se==="deleteRow"?(he=!1,ye=!f(Z=>Z.deleteRow())):se==="addColumnBefore"?(he=!1,ye=!f(Z=>Z.addColumnBefore())):se==="addColumnAfter"?(he=!1,ye=!f(Z=>Z.addColumnAfter())):se==="deleteColumn"?(he=!1,ye=!f(Z=>Z.deleteColumn())):se==="copyColumn"||se==="pasteColumnAfter"||se==="moveColumnRight"?(he=!1,ye=!0):se==="mergeCells"?(he=!1,ye=!f(Z=>Z.mergeCells())):se==="splitCell"?(he=!1,ye=!f(Z=>Z.splitCell())):se==="cancelTable"?(he=!1,ye=!b()||!e.isActive("table")):se==="deleteTable"&&(he=!1,ye=!f(Z=>Z.deleteTable()));fe.disabled=!!ye,fe.classList.toggle("is-active",!!he)}},W=null,q=()=>{W||(W=window.requestAnimationFrame(()=>{W=null,P()}))},ee=[d(r.undo,()=>e.chain().focus().undo().run()),d(r.redo,()=>e.chain().focus().redo().run())],de=He?.pmStateMod?.TextSelection||null,Le=(G,ue)=>{try{let be=G.resolve(Math.min(G.content.size,ue+1)),fe=null;for(let se=be.depth;se>0;se-=1){if(be.node(se)?.type?.name!=="outlineSection")continue;if(be.before(se)===ue){fe=se;break}}if(fe===null)return null;for(let se=fe-1;se>0;se-=1)if(be.node(se)?.type?.name==="outlineSection")return be.before(se);return null}catch{return null}},ne=G=>{try{if(!de)return;e.commands.command(({state:ue,dispatch:be})=>{let fe=Rt(ue.doc,ue.selection.$from);if(typeof fe!="number")return!1;let se=ue.doc.resolve(fe),he=se.index(),ye=se.parent;if(!ye)return!1;let Z=ue.doc.nodeAt(fe);if(!Z)return!1;if(G==="up"){if(he>0){let en=ye.child(he-1),Hn=fe-en.nodeSize,Ut=ue.tr.delete(fe,fe+Z.nodeSize).insert(Hn,Z);return Ut=Ut.setMeta(le,!0),Ut=Ut.setSelection(de.near(Ut.doc.resolve(Hn+2),1)),be(Ut.scrollIntoView()),!0}let we=Le(ue.doc,fe);if(typeof we!="number")return!1;let De=ue.doc.resolve(we),$e=De.index(),et=De.parent;if(!et||$e<=0)return!1;let tt=et.child($e-1),Ye=we-tt.nodeSize,Ue=ue.doc.nodeAt(Ye);if(!Ue||Ue.type?.name!=="outlineSection")return!1;let ft=Ue.child(0),dt=Ue.child(1),Ze=Ue.child(2),ut=Ye+1+ft.nodeSize+dt.nodeSize+Ze.nodeSize-1,Ve=ue.tr.delete(fe,fe+Z.nodeSize).setMeta(le,!0),gn=Ve.mapping.map(Ye,-1),Yt=Ve.mapping.map(ut,-1);Ve=Ve.insert(Yt,Z);let Qt=Ve.doc.nodeAt(gn);return Qt?.type?.name==="outlineSection"&&Qt.attrs?.collapsed&&(Ve=Ve.setNodeMarkup(gn,void 0,{...Qt.attrs,collapsed:!1})),Ve=Ve.setSelection(de.near(Ve.doc.resolve(Yt+2),1)),be(Ve.scrollIntoView()),!0}if(G==="down"){if(he<ye.childCount-1){let en=fe+Z.nodeSize,Hn=ue.doc.nodeAt(en);if(!Hn)return!1;let Ut=ue.tr.delete(fe,fe+Z.nodeSize),E=fe+Hn.nodeSize;return Ut=Ut.insert(E,Z),Ut=Ut.setMeta(le,!0),Ut=Ut.setSelection(de.near(Ut.doc.resolve(E+2),1)),be(Ut.scrollIntoView()),!0}let we=Le(ue.doc,fe);if(typeof we!="number")return!1;let De=ue.doc.nodeAt(we);if(!De||De.type?.name!=="outlineSection")return!1;let $e=ue.doc.resolve(we),et=$e.index(),tt=$e.parent;if(!tt||et>=tt.childCount-1)return!1;let Ye=we+De.nodeSize,Ue=ue.doc.nodeAt(Ye);if(!Ue||Ue.type?.name!=="outlineSection")return!1;let ft=Ue.child(0),dt=Ue.child(1),Ze=Ue.child(2),ut=Ye+1+ft.nodeSize+dt.nodeSize+1,Ve=ue.tr.delete(fe,fe+Z.nodeSize).setMeta(le,!0),gn=Ve.mapping.map(Ye,-1),Yt=Ve.mapping.map(ut,-1);Ve=Ve.insert(Yt,Z);let Qt=Ve.doc.nodeAt(gn);return Qt?.type?.name==="outlineSection"&&Qt.attrs?.collapsed&&(Ve=Ve.setNodeMarkup(gn,void 0,{...Qt.attrs,collapsed:!1})),Ve=Ve.setSelection(de.near(Ve.doc.resolve(Yt+2),1)),be(Ve.scrollIntoView()),!0}return!1})}catch{}},pe=()=>{try{if(!de)return;e.commands.command(({state:G,dispatch:ue})=>{let be=Rt(G.doc,G.selection.$from);if(typeof be!="number")return!1;let fe=G.doc.resolve(be),se=0;for(let Xe=fe.depth;Xe>=0;Xe-=1)fe.node(Xe)?.type?.name==="outlineSection"&&(se+=1);if(se>=6)return!1;let he=fe.index(),ye=fe.parent;if(!ye||he<=0)return!1;let Z=G.doc.nodeAt(be);if(!Z)return!1;let we=ye.child(he-1),De=be-we.nodeSize,$e=G.doc.nodeAt(De);if(!$e)return!1;let et=$e.child(0),tt=$e.child(1),Ye=$e.child(2),ft=De+1+et.nodeSize+tt.nodeSize+Ye.nodeSize-1,dt=G.tr.delete(be,be+Z.nodeSize).insert(ft,Z),Ze=dt.doc.nodeAt(De);return Ze?.type?.name==="outlineSection"&&Ze.attrs?.collapsed&&(dt=dt.setNodeMarkup(De,void 0,{...Ze.attrs,collapsed:!1})),dt=dt.setMeta(le,!0),dt=dt.setSelection(de.near(dt.doc.resolve(ft+2),1)),ue(dt.scrollIntoView()),!0})}catch{}},je=()=>{try{if(!de)return;e.commands.command(({state:G,dispatch:ue})=>{let be=G.selection.$from,fe=null,se=null;for(let et=be.depth;et>0;et-=1)if(be.node(et)?.type?.name==="outlineSection")if(fe===null)fe=et;else{se=et;break}if(fe===null||se===null)return!1;let he=be.before(fe),ye=be.before(se),Z=G.doc.nodeAt(he);if(!Z)return!1;let we=G.tr.delete(he,he+Z.nodeSize),De=we.doc.nodeAt(ye);if(!De)return!1;let $e=ye+De.nodeSize;return we=we.insert($e,Z),we=we.setMeta(le,!0),we=we.setSelection(de.near(we.doc.resolve($e+2),1)),ue(we.scrollIntoView()),!0})}catch{}},gt=()=>{try{if(!de)return;e.commands.command(({state:G,dispatch:ue})=>{let be=Rt(G.doc,G.selection.$from);if(typeof be!="number")return!1;let fe=G.doc.nodeAt(be);if(!fe)return!1;let se=String(fe.attrs?.id||"").trim(),he=G.doc.resolve(be),ye=he.index(),Z=he.parent;if(!Z)return!1;let we=G.doc.type.schema;if(Z.childCount<=1){let ft=we.nodes.outlineSection.create({...fe.attrs,collapsed:!1},[we.nodes.outlineHeading.create({},[]),we.nodes.outlineBody.create({},[we.nodes.paragraph.create({},[])]),we.nodes.outlineChildren.create({},[])]),dt=G.tr.replaceWith(be,be+fe.nodeSize,ft);dt=dt.setMeta(le,!0);let Ze=ft.child(0),Xe=be+1+Ze.nodeSize;return dt=dt.setSelection(de.near(dt.doc.resolve(Xe+2),1)),ue(dt.scrollIntoView()),!0}se&&go(se);let De=ye>0,$e=De?Z.child(ye-1):null,et=De?be-$e.nodeSize:null,tt=G.tr.delete(be,be+fe.nodeSize);tt=tt.setMeta(le,!0);let Ye=De&&typeof et=="number"?et:Math.min(tt.doc.content.size,be),Ue=tt.doc.nodeAt(Ye);if(Ue?.type?.name==="outlineSection"){let ft=Ue.child(0),dt=Ue.child(1),Ze=Ye+1+ft.nodeSize;dt.childCount||(tt=tt.insert(Ze+1,we.nodes.paragraph.create({},[]))),tt=tt.setSelection(de.near(tt.doc.resolve(Ze+2),1))}return ue(tt.scrollIntoView()),!0})}catch{}},Tt=()=>{try{if(!de)return;e.commands.command(({state:G,dispatch:ue})=>{let be=Rt(G.doc,G.selection.$from);if(typeof be!="number")return!1;let fe=G.doc.nodeAt(be);if(!fe)return!1;let se=G.doc.type.schema,he=be+fe.nodeSize,ye=tn(),Z=se.nodes.outlineSection.create({id:ye,collapsed:!1},[se.nodes.outlineHeading.create({},[]),se.nodes.outlineBody.create({},[se.nodes.paragraph.create({},[])]),se.nodes.outlineChildren.create({},[])]),we=G.tr.insert(he,Z);return we=we.setSelection(de.create(we.doc,he+2)),we=we.setMeta(le,!0),ke&&(we=we.setMeta(ke,{type:"enter",sectionId:ye})),ue(we.scrollIntoView()),!0})}catch{}};ee.push(d(r.deleteBtn,()=>gt())),ee.push(d(r.moveUpBtn,()=>ne("up"))),ee.push(d(r.moveDownBtn,()=>ne("down"))),ee.push(d(r.outdentBtn,()=>je())),ee.push(d(r.indentBtn,()=>pe())),ee.push(d(r.newBelowBtn,()=>Tt()));for(let G of i)ee.push(u(G,()=>y(G)));for(let G of c)ee.push(d(G,()=>{let ue=G.dataset.outlineAction||"";if(ue==="insertHttpLink"){g(),N().finally(()=>q());return}if(ue==="insertArticleLink"){g(),z().finally(()=>q());return}let be=h(ue);g(),be&&q()}));for(let G of l)ee.push(d(G,()=>{let ue=G.getAttribute("data-outline-clipboard-action")||"";if(!ue)return;g();let be=fn||null,fe=Mr instanceof Set?Mr:new Set,se=fe.size?new Set(fe):be?new Set([be]):new Set;if(ue==="toggleSelectMode"){si(!dr);return}if(ue==="clear"){Dc(null),L("\u0411\u0443\u0444\u0435\u0440 \u043E\u0447\u0438\u0449\u0435\u043D");return}if(ie){if(ue==="copy"||ue==="cut"){if(!se.size){L("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A");return}let he=Ng(ie.state.doc,se);if(!he.length){L("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A");return}let ye=he.map(De=>De.node.toJSON());try{let De=he.map($e=>$f($e.node)).filter(Boolean).join(`

`);Dg(De)}catch{}if(Dc({mode:ue==="cut"?"cut":"copy",sourceArticleId:Dt||a.articleId||null,createdAt:new Date().toISOString(),sections:ye}),ue==="copy"){L(`\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${ye.length}`);return}let Z=[];for(let De of he){let $e=ht(ie.state.doc,De.id),et=typeof $e=="number"?ie.state.doc.nodeAt($e):null;typeof $e=="number"&&et&&Z.push({pos:$e,size:et.nodeSize})}Z.sort((De,$e)=>$e.pos-De.pos);let we=ie.state.tr;for(let{pos:De,size:$e}of Z)we=we.delete(De,De+$e);we=we.setMeta(le,!0),ie.view.dispatch(we.scrollIntoView()),ie.view.focus(),mn=!0,pn({delayMs:200}),si(!1),L(`\u0412\u044B\u0440\u0435\u0437\u0430\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${ye.length}`);return}if(ue==="paste"){let he=bf();if(!he||!Array.isArray(he.sections)||!he.sections.length){L("\u0411\u0443\u0444\u0435\u0440 \u043F\u0443\u0441\u0442");return}let ye=ie.state,Z=ye.doc.content.size;if(be){let Ue=ht(ye.doc,be),ft=typeof Ue=="number"?ye.doc.nodeAt(Ue):null;typeof Ue=="number"&&ft&&(Z=Ue+ft.nodeSize)}let we=new Set;try{ye.doc.descendants(Ue=>{if(Ue?.type?.name!=="outlineSection")return;let ft=String(Ue.attrs?.id||"").trim();ft&&we.add(ft)})}catch{}let De=[];if(he.mode==="copy")for(let Ue of he.sections)De.push(Pg(Ue,()=>tn()));else for(let Ue of he.sections){let ft=String(Ue?.attrs?.id||"").trim();if(ft&&we.has(ft)){L("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C: \u0431\u043B\u043E\u043A \u0441 \u0442\u0430\u043A\u0438\u043C id \u0443\u0436\u0435 \u0435\u0441\u0442\u044C");return}De.push(Hf(Ue))}let $e=ye.doc.type.schema,et=[];for(let Ue of De)try{let ft=$e.nodeFromJSON(Ue);ft?.type?.name==="outlineSection"&&et.push(ft)}catch{}if(!et.length){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438");return}let tt=ye.tr,Ye=Z;for(let Ue of et)tt=tt.insert(Ye,Ue),Ye+=Ue.nodeSize;tt=tt.setMeta(le,!0),ie.view.dispatch(tt.scrollIntoView()),ie.view.focus(),mn=!0,pn({delayMs:200}),he.mode==="cut"&&Dc(null),si(!1),L(`\u0412\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${et.length}`)}}}));let _e=G=>{a.isOutlineEditing&&(t.contains(G.target)||g())},it=G=>{a.isOutlineEditing&&G.key==="Escape"&&g()};document.addEventListener("pointerdown",_e),document.addEventListener("keydown",it),ee.push(()=>document.removeEventListener("pointerdown",_e)),ee.push(()=>document.removeEventListener("keydown",it));let Lt=e.on("transaction",q),nn=e.on("selectionUpdate",q);ee.push(()=>Lt?.()),ee.push(()=>nn?.());try{let G=Vg({setActiveTagKey:ue=>{try{Ms?.(ue)}catch{}}});ee.push(()=>G?.())}catch{}q(),Es=()=>{W&&(window.cancelAnimationFrame(W),W=null);for(let G of ee)try{G()}catch{}}}function ay(){if(Es)try{Es()}catch{}Es=null}function ur(e=""){let t=String(e||"");a.outlineStatusText=t,p.updatedAt&&a.isOutlineEditing&&(p.updatedAt.textContent=t)}function cy(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=r.child(1),s=t+1+o.nodeSize,c=n.tr;if(!i.childCount){let d=n.doc.type.schema;c=c.insert(s+1,d.nodes.paragraph.create({},[]))}let{TextSelection:l}=He?.pmStateMod||{};return l?(c=c.setSelection(l.near(c.doc.resolve(s+2),1)),e.view.dispatch(c.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0):!1}catch{return!1}}function ly(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=t+1,{TextSelection:s}=He?.pmStateMod||{};if(!s)return!1;let c=i+1,l=i+o.nodeSize-1,d=Math.min(Math.max(c,c),Math.max(c,l)),u=n.tr.setSelection(s.near(n.doc.resolve(d),1));return u=u.setMeta(le,!0),e.view.dispatch(u.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0}catch{return!1}}function dy(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=t+1,{TextSelection:s}=He?.pmStateMod||{};if(!s)return!1;let c=i+1,l=i+o.nodeSize-1,d=Math.max(c,l),u=n.tr.setSelection(s.near(n.doc.resolve(d),-1));return u=u.setMeta(le,!0),e.view.dispatch(u.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0}catch{return!1}}function uy(e,t){try{if(!e)return!1;let n=String(t||"").trim();if(!n)return!1;let r=e.state,o=ht(r.doc,n);if(typeof o!="number")return!1;let i=r.doc.nodeAt(o);if(!i||i.type?.name!=="outlineSection")return!1;if(i.attrs?.collapsed)return ly(e,o);try{if(!i.child(1)?.childCount)return dy(e,o)}catch{}return cy(e,o)}catch{return!1}}async function fy(){if(He)return He;if(typeof window>"u")throw new Error("Outline editor is browser-only");let e=Vr()?performance.now():0,t=await import("/outline/tiptap.bundle.js");return e&&bo("import tiptap.bundle.js",{ms:Math.round(performance.now()-e)}),He={core:t.core,starterKitMod:t.starterKitMod,htmlMod:t.htmlMod,pmStateMod:t.pmStateMod,pmViewMod:t.pmViewMod,pmTablesMod:t.pmTablesMod,linkMod:t.linkMod,imageMod:t.imageMod,tableMod:t.tableMod,tableRowMod:t.tableRowMod,tableCellMod:t.tableCellMod,tableHeaderMod:t.tableHeaderMod,uniqueIdMod:t.uniqueIdMod,markdownMod:t.markdownMod},He}function py({blocks:e,parseHtmlToNodes:t}){let n=i=>Array.isArray(i)&&i.length>0?i:[{type:"paragraph",content:[]}],r=i=>{let s=String(i?.id||tn()),c=!!i?.collapsed,l=Cn(String(i?.text||"")),d=Jc(l.titleHtml)||"",u=n(t(l.bodyHtml||"")),m=Array.isArray(i?.children)?i.children:[];return{type:"outlineSection",attrs:{id:s,collapsed:c},content:[{type:"outlineHeading",content:d?[{type:"text",text:d}]:[]},{type:"outlineBody",content:u},{type:"outlineChildren",content:m.map(r)}]}},o=(Array.isArray(e)?e:[]).map(r);return{type:"doc",content:o.length?o:[r({id:tn(),text:"",collapsed:!1,children:[]})]}}function my(e){try{let t=String(e||"").trim();if(!t)return null;let n=window?.localStorage?.getItem?.("ttree_outline_last_active_v1")||"{}",r=JSON.parse(n||"{}"),o=r&&typeof r=="object"?r[t]:null;if(!o||typeof o!="object")return null;let i=String(o.sectionId||"").trim();return i?{sectionId:i,collapsed:!!o.collapsed}:null}catch{return null}}function ep(e,t,n){try{let r=String(e||"").trim(),o=String(t||"").trim();if(!r||!o)return!1;let i=window?.localStorage?.getItem?.("ttree_outline_last_active_v1")||"{}",s=JSON.parse(i||"{}"),c=s&&typeof s=="object"?s:{};return c[r]={sectionId:o,collapsed:!!n,savedAt:new Date().toISOString()},window?.localStorage?.setItem?.("ttree_outline_last_active_v1",JSON.stringify(c)),!0}catch{return!1}}function Bf(e){try{let t=Dt||a.articleId||null;if(!t||!e||e.isDestroyed)return!1;let n=e.state,r=Rt(n.doc,n.selection.$from);if(typeof r!="number")return!1;let o=n.doc.nodeAt(r);if(!o||o.type?.name!=="outlineSection")return!1;let i=String(o.attrs?.id||"").trim();if(!i)return!1;let s=!!o.attrs?.collapsed;return As.articleId===t&&As.sectionId===i&&As.collapsed===s?!1:(As={articleId:t,sectionId:i,collapsed:s},ep(t,i,s))}catch{return!1}}function hy(e,{lines:t=4}={}){try{if(!e||e.isDestroyed)return!1;let n=e.view;if(!n||!n.state||!n.dom)return!1;let r=n.state.selection;return!r||typeof r.from!="number"?!1:(Is&&cancelAnimationFrame(Is),Is=requestAnimationFrame(()=>{Is=null;try{let o=n.coordsAtPos(r.from);if(!o||typeof o.bottom!="number")return;let s=(b=>{try{let S=b;for(;S&&S!==document.body&&S!==document.documentElement;){let x=window.getComputedStyle(S),v=String(x.overflowY||"");if((v==="auto"||v==="scroll"||v==="overlay")&&S.scrollHeight>S.clientHeight+2)return S;S=S.parentElement}}catch{}return document.scrollingElement||document.documentElement})(n.dom),c=window.getComputedStyle(n.dom),l=String(c.lineHeight||"").trim(),d=l==="normal"?20:Number.parseFloat(l)||20,u=Math.max(24,d*Math.max(1,Number(t)||4)+12),m=window.innerHeight||0,g=0;if(s&&s!==document.scrollingElement&&s!==document.documentElement&&s!==document.body){let b=s.getBoundingClientRect();g=b.top,m=b.height}if(!m)return;let w=o.bottom-g,y=m-u;if(w<=y)return;let f=w-y,h=Math.max(0,(s.scrollTop||0)+f);s.scrollTop=h}catch{}}),!0)}catch{return!1}}function Rt(e,t){try{if(t?.nodeAfter?.type?.name==="outlineSection")return t.pos}catch{}for(let n=t.depth;n>0;n-=1)if(t.node(n)?.type?.name==="outlineSection")return t.before(n);return null}function _s(e){if(!e)return"";let t=e.child(0),n=e.child(1),r=Kr(t?.textContent||""),o="";try{o=Kr(n?.textBetween?.(0,n.content.size,`
`,`
`)||"")}catch{o=Kr(n?.textContent||"")}return Kr(`${r}
${o}`)}function Lf(e){if(!e)return"";let t=e.child(1),n="";try{n=Kr(t?.textBetween?.(0,t.content.size,`
`,`
`)||"")}catch{n=Kr(t?.textContent||"")}return n}function Mf(e){if(!$c||!Fc)return"";let t=[];return e?.content?.forEach?.(o=>{t.push(o.toJSON())}),($c({type:"doc",content:t},Fc)||""||"").trim()}function gy(e,t,n){if(!e||!t||!di)return!1;let r=ht(e.state.doc,t);if(typeof r!="number")return!1;let o=e.state.doc.nodeAt(r);if(!o)return!1;let i=o.child(0),s=o.child(1),c=r+1+i.nodeSize,l=e.state.schema,d=[];try{d=di(n||"")}catch{d=[]}let u=[];try{u=(Array.isArray(d)?d:[]).map(w=>l.nodeFromJSON(w))}catch{u=[l.nodes.paragraph.create({},[])]}u.length||(u=[l.nodes.paragraph.create({},[])]);let m=l.nodes.outlineBody.create({},u),g=e.state.tr.replaceWith(c,c+s.nodeSize,m).setMeta(le,!0);return e.view.dispatch(g),!0}function Wc(e){if(!e)return!0;let t=e.child(0);return!Kr(t?.textContent||"")}function yy(e,t,n){if(!e||!t)return!1;let r=ht(e.state.doc,t);if(typeof r!="number")return!1;let o=e.state.doc.nodeAt(r);if(!o||!Wc(o))return!1;let i=o.child(0),s=r+1,c=s+1,l=s+i.nodeSize-1,d=String(n||"").trim();if(!d)return!1;let u=d.length>200?d.slice(0,200):d,m=e.state.tr.insertText(u,c,l).setMeta(le,!0);return e.view.dispatch(m),!0}function by(e){Yr.clear(),e.descendants(t=>{if(t?.type?.name!=="outlineSection")return;let n=String(t.attrs?.id||"");n&&Yr.set(n,_s(t))})}function ht(e,t){let n=null;return e.descendants((r,o)=>{if(n!==null)return!1;r?.type?.name==="outlineSection"&&String(r.attrs?.id||"")===String(t||"")&&(n=o)}),n}function wy(e,t){try{let n=e.doc,r=ht(n,t),o=typeof r=="number"?n.nodeAt(r):null;if(!o)return null;let i=e.schema,s=i.marks?.code||null,c=i.nodes?.codeBlock||null;if(!s||!c)return null;let l=o.child(0),d=o.child(1);if(!l||!d)return null;let m=r+1+l.nodeSize+1,g=[];if(d.descendants((y,f)=>{if(!y||y.type?.name!=="paragraph")return;let h=!1,b=!1,S=!0;for(let B=0;B<y.childCount;B+=1){let N=y.child(B);if(N){if(N.type?.name==="hardBreak"){b=!0;continue}if(N.isText){if(!String(N.text||""))continue;if(!(Array.isArray(N.marks)?N.marks:[]).some(q=>q?.type===s)){S=!1;break}h=!0;continue}S=!1;break}}if(!S||!h||!b)return;let x="";for(let B=0;B<y.childCount;B+=1){let N=y.child(B);if(N){if(N.type?.name==="hardBreak"){x+=`
`;continue}N.isText&&(x+=String(N.text||""))}}if(!x.trim())return;let v=m+f;g.push({from:v,to:v+y.nodeSize,text:x})}),!g.length)return null;let w=e.tr;for(let y=g.length-1;y>=0;y-=1){let{from:f,to:h,text:b}=g[y],S=w.doc.resolve(f),x=S.parent,v=S.index();if(!x?.canReplaceWith?.(v,v+1,c))continue;let B=i.text(b),N=c.create(null,B);w=w.replaceWith(f,h,N)}return w.docChanged?w.setMeta(le,!0):null}catch{return null}}function tp(e,t,n){if(!e||!t||!n||a.article?.encrypted)return;let r=ht(t,n),o=typeof r=="number"?t.nodeAt(r):null;if(!o||!Wc(o))return;let i=Lf(o);if(!i)return;let s=jc(i),c=Pc.get(n)||null;c?.inFlight||c?.bodyHash!==s&&(Pc.set(n,{bodyHash:s,inFlight:!0}),ud(i).then(l=>{let d=String(l?.title||"").trim();if(!d||d.length>200)return;let u=e.state.doc,m=ht(u,n),g=typeof m=="number"?u.nodeAt(m):null;if(!g||!Wc(g))return;let w=Lf(g);if(!(jc(w)!==s||!yy(e,n,d))){mn=!0;try{let f=Dt||a.articleId||null;f&&(Yc({articleId:f,doc:e.state.doc,sectionId:n,reason:"generate_title"}),ur("\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438 \u043D\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044E"))}catch{}pn({delayMs:900})}}).catch(()=>{}).finally(()=>{Pc.set(n,{bodyHash:s,inFlight:!1})}))}function Sy(e,t,n){if(!(!e||!t)&&!(!Array.isArray(n)||!n.length)&&!a.article?.encrypted&&!(typeof navigator<"u"&&navigator&&navigator.onLine===!1)){try{if((ke?.getState?.(e.state)||null)?.editingSectionId)return}catch{}for(let r of n)try{tp(e,t,r)}catch{}}}function Nf(e,t,n){let r=String(n||"").trim(),o=(m,g={})=>er("skip",{reason:m,sectionId:r,...g});if(!e||!t||!r){o("missing_args",{hasEditor:!!e,hasDoc:!!t,hasSectionId:!!r});return}if(a.article?.encrypted){o("encrypted_article");return}try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1){o("offline");return}}catch{}let i=ht(t,r),s=typeof i=="number"?t.nodeAt(i):null;if(!s){o("section_not_found",{pos:typeof i=="number"?i:null});return}let c=s.child(1),l=Mf(c);if(!l){o("empty_body_html");return}let d=Oc(l),u=ii.get(r)||null;if(u?.inFlight){o("already_in_flight",{htmlHash:d});return}if(u?.status==="ok"&&u?.htmlHash===d){o("already_ok_same_hash",{htmlHash:d});return}if(u?.status==="error"&&u?.htmlHash===d){let m=Number(u?.lastAttemptAtMs||0)||0;if(Date.now()-m<yf){o("error_cooldown",{htmlHash:d,lastAttemptAtMs:m,cooldownMs:yf});return}}er("start",{sectionId:r,htmlHash:d}),ii.set(r,{htmlHash:d,inFlight:!0,status:u?.status||"ok",lastAttemptAtMs:Date.now()}),fd(l).then(m=>{let g=String(m?.html||"").trim();if(!g){er("skip_apply",{sectionId:r,reason:"empty_corrected_html"});return}let w=e.state.doc,y=ht(w,r),f=typeof y=="number"?w.nodeAt(y):null;if(!f){er("skip_apply",{sectionId:r,reason:"section_not_found_current_doc"});return}let h=Mf(f.child(1));if(Oc(h)!==d){er("skip_apply",{sectionId:r,reason:"body_changed_since_request"});return}if(Oc(g)===d){er("skip_apply",{sectionId:r,reason:"no_changes_from_server"});return}if(!gy(e,r,g)){er("skip_apply",{sectionId:r,reason:"apply_failed"});return}mn=!0,pn({delayMs:900})}).catch(()=>{er("error",{sectionId:r,htmlHash:d}),ii.set(r,{htmlHash:d,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()})}).finally(()=>{(ii.get(r)||null)?.status!=="error"&&(ii.set(r,{htmlHash:d,inFlight:!1,status:"ok",lastAttemptAtMs:Date.now()}),er("done",{sectionId:r,htmlHash:d}))})}function Jr(e,t){if(!t)return!1;let n=ht(e,t);if(typeof n!="number")return!1;let r=e.nodeAt(n);if(!r)return!1;let o=_s(r),i=Yr.get(t)||"";return o===i?!1:(Br.add(t),!0)}function pn({delayMs:e=1200}={}){a.isOutlineEditing&&ie&&(a.isPublicView||Dt&&a.articleId&&Dt!==a.articleId||(tr&&clearTimeout(tr),tr=setTimeout(()=>{tr=null,ci()},Math.max(200,e))))}async function ci({force:e=!1}={}){if(a.isOutlineEditing&&ie&&!a.isPublicView&&!(Dt&&a.articleId&&Dt!==a.articleId)&&!vs&&!(!e&&!mn&&!Br.size)){vs=!0,ur("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C\u2026");try{try{let t=ie.state,n=Rt(t.doc,t.selection.$from);if(typeof n=="number"){let r=t.doc.nodeAt(n),o=String(r?.attrs?.id||"");o&&Jr(t.doc,o)}}catch{}await xy({silent:!0,mode:"queue"})}finally{vs=!1}}}async function np(){if(!p.outlineEditor)return;let e=p.outlineEditor.querySelector("#outlineEditorContent");if(!e){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043C\u043E\u043D\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440");return}if(oi)return oi;oi=(async()=>{let t=Vr()?performance.now():0,n=Vr()?performance.now():0,{core:r,starterKitMod:o,htmlMod:i,pmStateMod:s,pmViewMod:c}=await fy();n&&bo("loadTiptap()",{ms:Math.round(performance.now()-n)});let{Editor:l,Node:d,Extension:u,InputRule:m,mergeAttributes:g}=r,w=o.default||o.StarterKit||o,{generateJSON:y,generateHTML:f}=i,{TextSelection:h}=s,{Plugin:b,PluginKey:S}=s,{Decoration:x,DecorationSet:v}=c,B=He.linkMod.default||He.linkMod.Link||He.linkMod,N=He.imageMod.default||He.imageMod.Image||He.imageMod,z=He.tableMod.TableKit||He.tableMod.tableKit;Et={TableMap:He.pmTablesMod?.TableMap||null,CellSelection:He.pmTablesMod?.CellSelection||null,moveTableColumn:He.pmTablesMod?.moveTableColumn||null,moveTableRow:He.pmTablesMod?.moveTableRow||null,addRowBefore:He.pmTablesMod?.addRowBefore||null,addRowAfter:He.pmTablesMod?.addRowAfter||null,deleteRow:He.pmTablesMod?.deleteRow||null,addColumnBefore:He.pmTablesMod?.addColumnBefore||null,addColumnAfter:He.pmTablesMod?.addColumnAfter||null,deleteColumn:He.pmTablesMod?.deleteColumn||null,toggleHeaderRow:He.pmTablesMod?.toggleHeaderRow||null,toggleHeaderColumn:He.pmTablesMod?.toggleHeaderColumn||null};let P=He.uniqueIdMod.default||He.uniqueIdMod.UniqueID||He.uniqueIdMod,W=He.markdownMod?.Markdown||He.markdownMod?.default?.Markdown||He.markdownMod?.default||null,q=E=>{let k=String(E||"").trim();if(!k)return null;let O=k.match(/(\d+(?:\.\d+)?)px/i);if(!O)return null;let R=Number.parseFloat(O[1]);return Number.isFinite(R)?R:null},ee=new S("outlineTagHighlighter"),de=d.create({name:"tag",group:"inline",inline:!0,atom:!0,selectable:!1,renderText({node:E}){try{return String(E?.attrs?.label||"").trim()}catch{return""}},addAttributes(){return{label:{default:""},key:{default:""}}},parseHTML(){return[{tag:'span[data-tt-tag="1"]'}]},renderHTML({node:E,HTMLAttributes:k}){let O=String(E?.attrs?.label||"").trim(),R=String(E?.attrs?.key||"").trim();return["span",g(k,{"data-tt-tag":"1","data-tag-key":R,class:"tt-tag"}),O||R||""]},addInputRules(){let E=/(^|[\s([{"'-])\\([^\\\n]{1,60}?)\\$/;return[new m({find:E,handler:({state:k,range:O,match:R})=>{let U=String(R?.[1]||""),D=String(R?.[2]||""),M=Uf(D);if(!M)return null;let $=Vf(M);if(!$)return null;let C=k.schema.nodes?.tag;if(!C)return null;let T=C.create({label:$,key:$}),A=k.tr.delete(O.from,O.to),I=O.from;U&&(A=A.insertText(U,I),I+=U.length),A=A.insert(I,T);let H=h.near(A.doc.resolve(Math.min(A.doc.content.size,I+T.nodeSize)),1);return A=A.setSelection(H),A=A.setMeta(le,!0),A}})]}}),Le=u.create({name:"outlineTagHighlighter",addProseMirrorPlugins(){return[new b({key:ee,state:{init:()=>({activeKey:null}),apply:(E,k)=>{let O=E.getMeta(ee);return O&&Object.prototype.hasOwnProperty.call(O,"activeKey")?{activeKey:O.activeKey?String(O.activeKey):null}:k}},props:{decorations(E){let k=ee.getState(E)?.activeKey||null,O=[];return E.doc.descendants((R,U)=>{if(R?.type?.name!=="tag")return;let D=String(R.attrs?.key||"").trim();if(!D)return;let M=k&&D===k?"tt-tag tt-tag--active":"tt-tag";O.push(x.node(U,U+R.nodeSize,{class:M}))}),O.length?v.create(E.doc,O):null}}})]}}),ne=N.extend({inline:!0,group:"inline",addAttributes(){return{...typeof this.parent=="function"?this.parent():{},width:{default:320,parseHTML:k=>{try{let O=k,R=O&&O.classList&&O.classList.contains("resizable-image")?O:O?.closest?.(".resizable-image"),U=q(R?.style?.width||"");if(U!==null)return Math.round(U);let D=q(R?.getAttribute?.("style")||"")||q(O?.getAttribute?.("style")||"");if(D!==null)return Math.round(D);let M=R?.getAttribute?.("data-width")||O?.getAttribute?.("data-width")||"",$=Number.parseFloat(String(M||""));return Number.isFinite($)&&$>0?Math.round($):320}catch{return 320}},renderHTML:()=>({})},uploadToken:{default:null,parseHTML:()=>null,renderHTML:()=>({})}}},parseHTML(){return[{tag:"span.resizable-image",getAttrs:E=>{let k=E,O=k?.querySelector?.("img"),R=O?.getAttribute?.("src")||"";if(!R)return!1;let U=O?.getAttribute?.("alt")||"",D=O?.getAttribute?.("title")||"",M=q(k?.style?.width||"")??320;return{src:R,alt:U,title:D,width:Math.round(M)}}},{tag:"img[src]",getAttrs:E=>{let k=E,O=k?.getAttribute?.("src")||"";if(!O)return!1;let R=k?.getAttribute?.("alt")||"",U=k?.getAttribute?.("title")||"";return{src:O,alt:R,title:U,width:320}}}]},renderHTML({node:E,HTMLAttributes:k}){let O=E?.attrs?.width,R=Number.isFinite(Number(O))?Math.round(Number(O)):320,U={...k};return delete U.width,delete U.uploadToken,["span",g({class:"resizable-image",style:`width:${R}px;max-width:100%;`},{}),["span",{class:"resizable-image__inner"},["img",g(U,{draggable:"false"})]],["span",{class:"resizable-image__handle","data-direction":"e","aria-hidden":"true"}]]}});$c=f,Fc=[w.configure({heading:!1,link:!1}),B.configure({openOnClick:!1,protocols:bs}),ne,z.configure({table:{resizable:!0}})];let pe=u.create({name:"outlineImageUpload",addProseMirrorPlugins(){let E=U=>{if(!U)return!1;if(U.type&&String(U.type).startsWith("image/"))return!0;let D=String(U.name||"").toLowerCase();return!!(D&&/\.(png|jpe?g|gif|webp|bmp|svg|heic|heif)$/i.test(D))},k=(U,D)=>{let M=[];return Array.from(U||[]).forEach($=>{if($.kind!=="file")return;let C=typeof $.getAsFile=="function"?$.getAsFile():null;C&&E(C)&&M.push(C)}),!M.length&&D?.length&&Array.from(D).forEach($=>{E($)&&M.push($)}),M},O=(U,D)=>{let M=`upl-${Date.now()}-${Math.random().toString(16).slice(2)}`,$=URL.createObjectURL(D);try{li.set(M,$)}catch{}try{let F=Dt||a.articleId||null;Qu({token:M,articleId:F,kind:"image",blob:D,fileName:D?.name||"image",mime:D?.type||""})}catch{}let C=U.state.schema.nodes.image.create({src:$,alt:D?.name||"image",width:320,uploadToken:M}),T=U.state.tr,A=T.selection.from,I=T.selection.to;I>A&&(T=T.delete(A,I)),T=T.insertText("  ",A,A);let H=T.mapping.map(A,1);T=T.replaceRangeWith(H,H,C);let _=T.mapping.map(H+C.nodeSize,1);T=T.insertText("  ",_,_),T=T.setSelection(h.near(T.doc.resolve(Math.min(T.doc.content.size,_+1)),1)),T=T.setMeta(le,!0),U.dispatch(T.scrollIntoView());try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1){L("\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E \u0438 \u0431\u0443\u0434\u0435\u0442 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E \u043F\u0440\u0438 \u043F\u043E\u044F\u0432\u043B\u0435\u043D\u0438\u0438 \u0441\u0435\u0442\u0438");return}}catch{}Po(D).then(F=>{let K=String(F?.url||"").trim();if(!K)throw new Error("Upload failed");let X=Vc(U.state.doc,M);if(typeof X!="number")return;let J=U.state.doc.nodeAt(X);if(!J||J.type?.name!=="image")return;let j={...J.attrs,src:K,uploadToken:null},te=U.state.tr.setNodeMarkup(X,void 0,j);te=te.setMeta(le,!0),U.dispatch(te),_f(M),bc(M).catch(()=>{})}).catch(F=>{L(F?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435");try{window?.localStorage?.getItem?.("ttree_debug_outline_keys_v1")==="1"&&console.log("[outline][image]","upload.failed",{token:M,message:String(F?.message||F||"")})}catch{}try{let K=Vc(U.state.doc,M);if(typeof K!="number")return;let X=U.state.doc.nodeAt(K);if(!X||X.type?.name!=="image")return;let J=String(X.attrs?.title||"").trim(),j=J?`${J} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",te=String(X.attrs?.alt||D?.name||"image"),ce={...X.attrs,src:$,alt:te,title:j,uploadToken:M},Se=U.state.tr.setNodeMarkup(K,void 0,ce);Se=Se.setMeta(le,!0),U.dispatch(Se)}catch{}try{wc(M,String(F?.message||F||"error"))}catch{}})},R=(U,D,M,$)=>{try{if(!(ke?.getState?.(U.state)||null)?.editingSectionId)return!1}catch{return!1}let C=k(M,$);if(!C.length)return!1;D.preventDefault(),D.stopPropagation();for(let T of C)O(U,T);return!0};return[new b({props:{handleDOMEvents:{paste(U,D){let M=D?.clipboardData?.items||null,$=D?.clipboardData?.files||null;return R(U,D,M,$)},drop(U,D){let M=D?.dataTransfer?.items||null,$=D?.dataTransfer?.files||null;return R(U,D,M,$)}}},view(U){return{update(D,M){try{let $=ke?.getState?.(M)||{},C=ke?.getState?.(D.state)||{},T=$.editingSectionId||null,A=C.editingSectionId||null;if(T&&!A){let I=String(T||"").trim(),H=Dt||a.articleId||null;if(!I||!H)return;let _=!1;try{let F=ht(D.state.doc,I),K=typeof F=="number"?D.state.doc.nodeAt(F):null;K?.type?.name==="outlineSection"&&(_=!!K.attrs?.collapsed)}catch{}ep(H,I,_);try{let F=ht(D.state.doc,I),K=typeof F=="number"?D.state.doc.nodeAt(F):null;if(!K||K.type?.name!=="outlineSection")return;let X=!Yr.has(I),J=X||Jr(D.state.doc,I),j=!1;if(J){let ce=K.child(0),Se=K.child(1),me=ce?.toJSON?ce.toJSON():null,Be=Se?.toJSON?Se.toJSON():null;if(me&&Be){let Re=zf(me,Be);if(Re>Bs){L(`\u0411\u043B\u043E\u043A \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 (${Math.ceil(Re/1024)} KB). \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C: ${Math.ceil(Bs/1024)} KB. \u0420\u0430\u0437\u0431\u0435\u0439\u0442\u0435 \u0431\u043B\u043E\u043A \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E.`);try{let qe=D.state.tr.setMeta(le,!0);qe=qe.setMeta(ke,{type:"enter",sectionId:I}),D.dispatch(qe)}catch{}return}let Ge=Date.now(),wt=Ff(H,I);try{ct("outline.enqueue.section_upsert_content",{articleId:H,sectionId:I,seq:wt,bytes:Re,reason:X?"exit_edit_mode_new_section":"exit_edit_mode"})}catch{}j=!0,$t("section_upsert_content",{articleId:H,payload:{sectionId:I,headingJson:me,bodyJson:Be,seq:wt,clientQueuedAt:Ge},coalesceKey:`content:${H}:${I}`})}}let te=!1;if(X||Jn||jt){let ce=ui(D.state.doc);if(ce.length){let Se=null;try{Se=ce.filter(me=>me&&(me.parentId==null||me.parentId==="")&&Number(me.position)>=0).sort((me,Be)=>Number(me.position)-Number(Be.position)).slice(0,3).map(me=>String(me.sectionId||""))}catch{Se=null}try{ct("outline.enqueue.structure_snapshot",{articleId:H,nodesCount:ce.length,reason:X?"exit_edit_mode_new_section":"exit_edit_mode",rootFirst:Se})}catch{}$t("structure_snapshot",{articleId:H,payload:{nodes:ce},coalesceKey:`structure:${H}`}),te=!0}Jn=!1,jt&&(clearTimeout(jt),jt=null)}try{(j||X)&&(Yr.set(I,_s(K)),Br.delete(I))}catch{}try{j&&ie&&!ie.isDestroyed&&ie.view===D&&tp(ie,D.state.doc,I)}catch{}(j||te)&&ur("\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438 \u043D\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044E")}catch{}}}catch{}}}}})]}}),je=u.create({name:"outlineImageResize",addProseMirrorPlugins(){return[new b({view(E){let k=null,O=(M,$)=>{try{if((E.state.selection?.node||null)?.type?.name==="image"&&typeof E.state.selection.from=="number")return E.state.selection.from;let T=X=>{if(typeof X!="number")return null;let J=[X,X-1,X+1,X-2,X+2];for(let j of J){if(j<0)continue;if(E.state.doc.nodeAt(j)?.type?.name==="image")return j}return null},A=M?.querySelector?.("img")||null,I=T(E.posAtDOM(M,0));if(typeof I=="number")return I;let H=A?T(E.posAtDOM(A,0)):null;if(typeof H=="number")return H;let _=$&&typeof $.clientX=="number"&&typeof $.clientY=="number"?{left:$.clientX,top:$.clientY}:null,F=_?E.posAtCoords(_):null,K=F&&typeof F.pos=="number"?T(F.pos):null;return typeof K=="number"?K:null}catch{return null}},R=M=>{if(M.button!==0)return;let $=M.target?.closest?.(".resizable-image__handle");if(!$)return;let C=$.closest(".resizable-image");if(!C||!E.dom.contains(C)||!(ke?.getState?.(E.state)||null)?.editingSectionId)return;let A=O(C,M);if(typeof A!="number")return;let I=E.state.doc.nodeAt(A);if(!I||I.type?.name!=="image")return;M.preventDefault(),M.stopPropagation();let H=C.getBoundingClientRect();k={pos:A,startWidth:H.width,startX:M.clientX,wrapper:C,lastWidth:H.width},C.classList.add("resizable-image--resizing")},U=M=>{if(!k)return;M.preventDefault();let $=M.clientX-k.startX,T=parseFloat(getComputedStyle(document.documentElement).fontSize)||16,A=Math.max(T,document.documentElement.clientWidth-32),I=k.startWidth+$;I=Math.max(T,Math.min(I,A)),k.lastWidth=I,k.wrapper.style.width=`${Math.round(I)}px`},D=()=>{if(!k)return;let{pos:M,wrapper:$}=k;$.classList.remove("resizable-image--resizing");let C=E.state.doc.nodeAt(M)?.type?.name==="image"?M:O($,null),T=typeof C=="number"?E.state.doc.nodeAt(C):null;if(T&&T.type?.name==="image"){let A=Math.max(1,Math.round(Number(k.lastWidth||0)||$.getBoundingClientRect().width)),I={...T.attrs,width:A},H=E.state.tr.setNodeMarkup(C,void 0,I);H=H.setMeta(le,!0),E.dispatch(H)}k=null};return E.dom.addEventListener("pointerdown",R),document.addEventListener("pointermove",U),document.addEventListener("pointerup",D),document.addEventListener("pointercancel",D),{destroy(){E.dom.removeEventListener("pointerdown",R),document.removeEventListener("pointermove",U),document.removeEventListener("pointerup",D),document.removeEventListener("pointercancel",D)}}}})]}}),gt=u.create({name:"outlineImagePreview",addProseMirrorPlugins(){return[new b({props:{handleDOMEvents:{click(E,k){try{if((ke?.getState?.(E.state)||null)?.editingSectionId)return!1;let R=k?.target?.closest?.("img");return R?k.target?.closest?.(".resizable-image__handle")?(k.preventDefault(),!0):(k.preventDefault(),_o(R.src,R.alt||""),!0):!1}catch{return!1}}}}})]}}),Tt=u.create({name:"outlineMarkdownTablePaste",addProseMirrorPlugins(){let E=(k,O)=>{try{if(!(ke?.getState?.(k.state)||null)?.editingSectionId)return!1;let U=O?.clipboardData?.getData?.("text/plain")||"";if(xn("paste: text/plain",{len:U.length,sample:U.slice(0,200)}),!U)return!1;let D=Xc(U),M=jr(D);xn("paste: parsed",{ok:!!M,lines:D});let $=M?null:Wr(D);if(!M&&!$)return!1;let C=M?{header:M.header,rows:M.rows,withHeader:!0}:{header:null,rows:$.rows,withHeader:!1},T=null;try{T=Tr(k.state.schema,C)}catch(I){return xn("paste: buildTableNode error",{message:String(I?.message||I||""),stack:String(I?.stack||""),schemaNodes:Object.keys(k.state.schema?.nodes||{})}),!1}if(xn("paste: tableNode",{ok:!!T,schemaNodes:Kc()?Object.keys(k.state.schema?.nodes||{}):void 0}),!T)return!1;O.preventDefault(),O.stopPropagation();let A=k.state.tr;k.state.selection.empty||(A=A.deleteSelection());try{A=A.replaceSelectionWith(T,!1)}catch(I){return xn("paste: replaceSelectionWith error",{message:String(I?.message||I||""),stack:String(I?.stack||""),selection:{from:k.state.selection?.from,to:k.state.selection?.to,empty:k.state.selection?.empty,$fromParent:k.state.selection?.$from?.parent?.type?.name}}),!1}return A=A.setMeta(le,!0),k.dispatch(A.scrollIntoView()),!0}catch(R){return xn("paste: unexpected error",{message:String(R?.message||R||""),stack:String(R?.stack||"")}),!1}};return[new b({appendTransaction(k,O,R){try{let U=k?.some?.(A=>A?.docChanged),D=null;if(ke)for(let A of k||[]){let I=A?.getMeta?.(ke)||null;if(I?.type==="enter"&&I?.sectionId){D=String(I.sectionId);break}}let M=!!D;if(!U&&!M||k.some(A=>A.getMeta?.(le)))return null;let $=ke?.getState?.(R)||null,C=D||$?.editingSectionId||null;if(!C)return null;xn("appendTransaction: try convert",{didDocChange:U,didEnterEditMode:M,sectionId:C});let T=Jg(R,C);if(T)return T;if(Kc()){let A=ht(R.doc,C),I=typeof A=="number"?R.doc.nodeAt(A):null,H=I?I.child(1):null,_=H?H.textContent:"";String(_||"").includes("|")&&xn("appendTransaction: saw pipes but no conversion",{sectionId:C})}return wy(R,C)}catch{return null}},props:{handlePaste(k,O){return E(k,O)},handleDOMEvents:{paste(k,O){return E(k,O)}}}})]}}),_e=u.create({name:"outlineStructuredSectionPaste",addProseMirrorPlugins(){let E=D=>{let M=String(D||"").trim();if(!M)return{sections:[],startsWithHeading:!1,headingCount:0};if(!/<h[1-6][\s>]/i.test(M))return{sections:[],startsWithHeading:!1,headingCount:0};let $=null;try{$=new DOMParser().parseFromString(M,"text/html")}catch{return{sections:[],startsWithHeading:!1,headingCount:0}}let C=$?.body;if(!C)return{sections:[],startsWithHeading:!1,headingCount:0};let T=!1;try{let _=Array.from(C.childNodes||[]).find(F=>F?.nodeType===1&&String(F?.textContent||"").trim());T=!!(_&&/^H[1-6]$/.test(String(_.nodeName||"")))}catch{T=!1}let A=[],I=null,H=()=>{if(!I)return;let _=document.createElement("div");for(let K of I.nodes)try{_.appendChild(K.cloneNode(!0))}catch{}let F=String(_.innerText||_.textContent||"").trimEnd();A.push({level:I.level,title:I.title,bodyText:F}),I=null};for(let _ of Array.from(C.childNodes||[])){let X=(_?.nodeType===1?String(_.nodeName||"").toUpperCase():"").match(/^H([1-6])$/);if(X){H();let J=Number(X[1]),j=String(_.textContent||"").trim();if(!j)continue;I={level:J,title:j,nodes:[]};continue}I&&I.nodes.push(_)}return H(),{sections:A,startsWithHeading:T,headingCount:A.length}},k=D=>{let M=D?.selection?.$from;if(!M)return null;for(let $=M.depth;$>0;$-=1)if(M.node($)?.type?.name==="outlineSection")return M.before($);return null},O=(D,M)=>{let $=String(M||"").replace(/\r\n/g,`
`).trimEnd(),C=D.nodes.paragraph;if(!C)return[];let T=D.nodes.hardBreak||D.nodes.hard_break||null,A=_=>{let F=String(_||"").split(`
`),K=[];for(let X=0;X<F.length;X+=1){let J=F[X];X>0&&T&&K.push(T.create()),J&&K.push(D.text(J))}return C.create({},K)};if(!$.trim())return[C.create({},[])];let I=$.split(/\n{2,}/),H=[];for(let _ of I){let F=String(_||"").trimEnd();H.push(A(F))}return H.length?H:[C.create({},[])]},R=(D,M)=>{let $=D.nodes.outlineHeading.create({},M.title?[D.text(M.title)]:[]),C=O(D,M.bodyText),T=D.nodes.outlineBody.create({},C),A=(M.children||[]).map(H=>R(D,H)),I=D.nodes.outlineChildren.create({},A);return D.nodes.outlineSection.create({id:M.id,collapsed:!1},[$,T,I])},U=(D,M)=>{try{if(!(ke?.getState?.(D.state)||null)?.editingSectionId)return!1;let C=M?.clipboardData?.getData?.("text/html")||"",T=M?.clipboardData?.getData?.("text/plain")||"",A=C?E(C):{sections:[],startsWithHeading:!1,headingCount:0},I=!A.sections.length&&T?xc(T):{sections:[],startsWithHeading:!1,headingCount:0},H=A.sections.length?A:I;if(!H.sections.length||!(H.startsWithHeading||H.sections.length>=2))return!1;M.preventDefault(),M.stopPropagation();let F=k(D.state);if(typeof F!="number")return!1;let K=D.state.doc.nodeAt(F);if(!K||K.type?.name!=="outlineSection")return!1;let X=tf(H.sections,{makeId:()=>tn()});if(!X.length)return!1;let J=D.state.schema,j=X.map(Se=>R(J,Se)),te=D.state.tr,ce=F+K.nodeSize;for(let Se of j)te=te.insert(ce,Se),ce+=Se.nodeSize;return te=te.setMeta(le,!0),D.dispatch(te.scrollIntoView()),!0}catch{return!1}};return[new b({props:{handlePaste(D,M){return U(D,M)},handleDOMEvents:{paste(D,M){return U(D,M)}}}})]}}),it=(E="")=>{let k=String(E||"").trim();return k?k.startsWith("app:/")||k.startsWith("disk:/")?`/api/yandex/disk/file?path=${encodeURIComponent(k)}`:k:""},Lt=u.create({name:"outlineAttachmentUpload",addProseMirrorPlugins(){let E=M=>{let $=String(M?.type||"");return!($&&$.startsWith("image/"))},k=(M,$)=>{let C=[];try{let T=[];if($&&typeof $.length=="number")T.push(...Array.from($||[]));else if(M&&typeof M.length=="number")for(let A of Array.from(M||[])){if(!A||A.kind!=="file")continue;let I=A.getAsFile?.();I&&T.push(I)}for(let A of T)A&&E(A)&&C.push(A)}catch{}return C},O=M=>`pending-attachment:${String(M||"")}`,R=(M,$)=>{let C=O($),T=M?.type?.schema?.marks?.link||null;if(!T)return null;let A=null;return M.descendants((I,H)=>{if(A)return!1;!I||!I.isText||!(Array.isArray(I.marks)?I.marks:[]).find(K=>K?.type===T&&String(K?.attrs?.href||"")===C)||(A={from:H,to:H+I.nodeSize})}),A},U=(M,$)=>{let C=M?.state?.schema,T=C?.marks?.link||null;if(!C||!T){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u0438\u0435: \u043D\u0435\u0442 \u0441\u0445\u0435\u043C\u044B \u0441\u0441\u044B\u043B\u043E\u043A");return}if(!a.articleId){L("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}let A=tn(),I=O(A),H=String($?.name||"\u0444\u0430\u0439\u043B"),_=`${H} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430...)`,{from:F,to:K}=M.state.selection,X=M.state.tr.insertText(_,F,K);X=X.addMark(F,F+_.length,T.create({href:I})),X=X.setMeta(le,!0),M.dispatch(X.scrollIntoView()),Oi(a.articleId,$).then(J=>{let j=String(J?.storedPath||J?.url||J?.path||"").trim();if(!j)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443 \u043D\u0430 \u0444\u0430\u0439\u043B");let te=String(J?.originalName||$?.name||"\u0444\u0430\u0439\u043B"),ce=R(M.state.doc,A);if(!ce)return;let Se=M.state.tr.insertText(te,ce.from,ce.to);Se=Se.addMark(ce.from,ce.from+te.length,T.create({href:j})),Se=Se.setMeta(le,!0),M.dispatch(Se)}).catch(J=>{let j=R(M.state.doc,A);if(j){let te=`${H} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`,ce=M.state.tr.insertText(te,j.from,j.to);ce=ce.setMeta(le,!0),M.dispatch(ce)}L(J?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u043D\u0430 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A")})},D=(M,$,C,T)=>{let A=k(C,T);if(!A.length)return!1;$.preventDefault(),$.stopPropagation();try{if(!(ke?.getState?.(M.state)||null)?.editingSectionId)return wo(),!0}catch{return wo(),!0}for(let I of A)U(M,I);return!0};return[new b({props:{handleDOMEvents:{drop(M,$){let C=$?.dataTransfer?.items||null,T=$?.dataTransfer?.files||null;return D(M,$,C,T)},paste(M,$){let C=$?.clipboardData?.items||null,T=$?.clipboardData?.files||null;return D(M,$,C,T)}}}})]}}),nn=d.create({name:"doc",topNode:!0,content:"outlineSection+"}),G=d.create({name:"outlineChildren",content:"outlineSection*",defining:!0,renderHTML(){return["div",{class:"outline-children","data-outline-children":"true"},0]},parseHTML(){return[{tag:"div[data-outline-children]"}]},addNodeView(){return({node:E})=>{let k=document.createElement("div");k.className="outline-children",k.setAttribute("data-outline-children","true");let O=R=>{let U=!R||R.childCount===0;k.setAttribute("data-empty",U?"true":"false")};return O(E),{dom:k,contentDOM:k,update(R){return!R||R.type?.name!=="outlineChildren"?!1:(O(R),!0)}}}}}),ue=E=>{try{if(!E||E.childCount===0)return!0;let k=!1;return E.descendants(O=>{if(k)return!1;let R=O?.type?.name;return R==="image"||R==="table"||O.isText&&String(O.text||"").replace(/\u00a0/g," ").trim()?(k=!0,!1):!0}),!k}catch{return!1}},be=d.create({name:"outlineBody",content:"block*",defining:!0,renderHTML(){return["div",{class:"outline-body","data-outline-body":"true"},0]},parseHTML(){return[{tag:"div[data-outline-body]"}]},addNodeView(){return({node:E})=>{let k=document.createElement("div");k.className="outline-body",k.setAttribute("data-outline-body","true");let O=R=>{let U=ue(R);k.setAttribute("data-empty",U?"true":"false")};return O(E),{dom:k,contentDOM:k,update(R){return!R||R.type?.name!=="outlineBody"?!1:(O(R),!0)}}}}}),fe=d.create({name:"outlineHeading",content:"inline*",defining:!0,renderHTML(){return["div",{class:"outline-heading","data-outline-heading":"true"},0]},parseHTML(){return[{tag:"div[data-outline-heading]"}]},addNodeView(){return({editor:E,getPos:k,node:O})=>{let R=document.createElement("div");R.className="outline-heading",R.setAttribute("data-outline-heading","true");let U=document.createElement("button");U.type="button",U.className="outline-heading__toggle",U.title="\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C/\u0440\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C (Ctrl+\u2190/\u2192), \u0441 \u0434\u0435\u0442\u044C\u043C\u0438 (Ctrl+\u2191/\u2193)",U.setAttribute("aria-label","\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C/\u0440\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C");let D=document.createElement("div");D.className="outline-heading__content";let M=document.createElement("button");M.type="button",M.className="outline-heading__select",M.setAttribute("role","checkbox"),M.setAttribute("aria-checked","false"),M.setAttribute("aria-label","\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0431\u043B\u043E\u043A"),M.textContent="\u2713",M.addEventListener("pointerdown",C=>{C.preventDefault()}),M.addEventListener("click",C=>{if(C.preventDefault(),C.stopPropagation(),!dr)return;let T=typeof k=="function"?k():null;if(typeof T!="number")return;let A=T-1,I=E.state.doc.nodeAt(A),H=String(I?.attrs?.id||"").trim();H&&Mg(H)});let $=()=>{let C=typeof k=="function"?k():null;if(typeof C!="number")return;let T=C-1,A=E.state.doc.nodeAt(T),I=String(A?.attrs?.id||"");I&&R.setAttribute("data-section-id",I),R.dataset.empty=O.content.size===0?"true":"false";let H=E.state.doc.resolve(Math.max(0,T+1)),_=0;for(let K=H.depth;K>=0;K-=1)H.node(K)?.type?.name==="outlineSection"&&(_+=1);R.dataset.depth=String(Math.min(6,Math.max(1,_||1)));let F=dr&&I&&Mr.has(I);M.setAttribute("aria-checked",F?"true":"false"),M.style.display=dr?"inline-flex":"none"};return U.addEventListener("click",C=>{C.preventDefault(),C.stopPropagation();let T=typeof k=="function"?k():null;if(typeof T!="number")return;let A=T-1,I=E.state.doc.nodeAt(A);if(!I)return;let H=!I.attrs?.collapsed,_=E.state.tr.setNodeMarkup(A,void 0,{...I.attrs,collapsed:H});try{H&&ke&&(ke.getState(E.state)||{}).editingSectionId&&(_=_.setMeta(ke,{type:"exit"}))}catch{}_.setMeta(le,!0),E.view.dispatch(_),E.view.focus()}),R.appendChild(U),R.appendChild(D),R.appendChild(M),$(),{dom:R,contentDOM:D,update:C=>C.type.name!=="outlineHeading"?!1:(O=C,$(),!0)}}}}),se=d.create({name:"outlineSection",group:"block",content:"outlineHeading outlineBody outlineChildren",defining:!0,isolating:!0,draggable:!0,addAttributes(){return{collapsed:{default:!1}}},renderHTML({node:E,HTMLAttributes:k}){let O={...k,class:`outline-section${k?.class?` ${k.class}`:""}`,"data-outline-section":"true","data-section-id":E.attrs.id||"","data-collapsed":E.attrs.collapsed?"true":"false"};return["div",g(O),0]},parseHTML(){return[{tag:"div[data-outline-section]"}]}}),he=E=>{if(!E)return!0;if((E.textContent||"").replace(/\u00a0/g," ").trim())return!1;if(E.childCount)for(let O=0;O<E.childCount;O+=1){let R=E.child(O);if(R.type?.name!=="paragraph"||(R.textContent||"").replace(/\u00a0/g," ").trim())return!1}return!0},ye=E=>{if(!E)return!0;try{let k=E.child(0),O=E.child(1),R=E.child(2);return he(k)&&he(O)&&(!R||R.childCount===0)}catch{return!0}},Z=(E,k,O)=>{let R=E.doc.nodeAt(O);if(!R)return!1;let U=String(R.attrs?.id||"").trim(),D=E.doc.resolve(O),M=D.index(),$=D.parent;if(!$)return!1;if($.childCount<=1){if($.type?.name==="doc"){let J=E.doc.type.schema,j=J.nodes.outlineSection.create({...R.attrs,collapsed:!1},[J.nodes.outlineHeading.create({},[]),J.nodes.outlineBody.create({},[J.nodes.paragraph.create({},[])]),J.nodes.outlineChildren.create({},[])]),te=E.tr.replaceWith(O,O+R.nodeSize,j);te=te.setMeta(le,!0);let ce=j.child(0),Se=O+1+ce.nodeSize;return k(te.setSelection(h.near(te.doc.resolve(Se+2),1)).scrollIntoView()),!0}U&&go(U);let K=null;try{for(let J=D.depth;J>0;J-=1)if(D.node(J)?.type?.name==="outlineSection"){K=D.before(J);break}}catch{K=null}let X=E.tr.delete(O,O+R.nodeSize);X=X.setMeta(le,!0);try{if(typeof K=="number"){let J=X.mapping.map(K,-1),j=X.doc.nodeAt(J);if(j&&j.type?.name==="outlineSection"){let te=j.child(0),ce=j.child(1),Se=J+1+te.nodeSize;if(!ce.childCount){let me=X.doc.type.schema;X=X.insert(Se+1,me.nodes.paragraph.create({},[]))}X=X.setSelection(h.near(X.doc.resolve(Se+2),1))}}}catch{}return k(X.scrollIntoView()),!0}let C=M>0,T=M<$.childCount-1,A=C?$.child(M-1):null,I=C?O-A.nodeSize:null,H=O+R.nodeSize;U&&go(U);let _=E.tr.delete(O,O+R.nodeSize),F=(K,X)=>{try{let J=K.doc.nodeAt(X);if(!J||J.type?.name!=="outlineSection")return K;let j=J.child(0),ce=X+1+j.nodeSize-1;return K.setSelection(h.near(K.doc.resolve(ce),-1))}catch{return K}};if(T){let K=O<_.doc.content.size?O:H;_.doc.nodeAt(K)&&(_=F(_,K))}else C&&typeof I=="number"&&_.doc.nodeAt(I)&&(_=F(_,I));return _=_.setMeta(le,!0),k(_.scrollIntoView()),!0},we=(E,k,O)=>{let R=E.doc.nodeAt(O);if(!R)return!1;let U=E.doc.resolve(O),D=U.index(),M=U.parent;if(!M||D<=0)return!1;let $=M.child(D-1),C=O-$.nodeSize,T=R.child(0),A=R.child(1),I=R.child(2),H=E.tr.delete(O,O+R.nodeSize),_=H.doc.nodeAt(C);if(!_)return H=H.setMeta(le,!0),k(H.scrollIntoView()),!0;let F=H.doc.type.schema,K=_.child(0),X=_.child(1),J=_.child(2),j=[],te=(T?.textContent||"").replace(/\u00a0/g," ").trim();te&&j.push(F.nodes.paragraph.create({},[F.text(te)])),A?.content?.forEach?.(Ge=>{j.push(Ge)});let ce=j.length?F.nodes.outlineBody.create({},j).content:null,Se=ce?X.content.append(ce):X.content,me=J.content.append(I.content),Be=F.nodes.outlineSection.create(_.attrs,[K,F.nodes.outlineBody.create({},Se),F.nodes.outlineChildren.create({},me)]);H=H.replaceWith(C,C+_.nodeSize,Be);let Re=H.doc.nodeAt(C);if(Re){let Ge=Re.child(0),wt=Re.child(1),At=C+1+Ge.nodeSize+wt.nodeSize-1;H=H.setSelection(h.near(H.doc.resolve(At),-1))}return H=H.setMeta(le,!0),k(H.scrollIntoView()),!0},De=(E,k,O)=>{let R=E.doc.nodeAt(O);if(!R)return!1;let U=E.selection.$from,D=null,M=null;for(let Ge=U.depth;Ge>0;Ge-=1)if(U.node(Ge)?.type?.name==="outlineSection")if(D===null)D=Ge;else{M=Ge;break}if(D===null||M===null)return!1;let $=U.before(M);if(!E.doc.nodeAt($))return!1;let T=E.doc.type.schema,A=R.child(0),I=R.child(1),H=R.child(2),_=E.tr.delete(O,O+R.nodeSize),F=_.doc.nodeAt($);if(!F)return _=_.setMeta(le,!0),k(_.scrollIntoView()),!0;let K=F.child(0),X=F.child(1),J=F.child(2),j=[],te=(A?.textContent||"").replace(/\u00a0/g," ").trim();te&&j.push(T.nodes.paragraph.create({},[T.text(te)])),I?.content?.forEach?.(Ge=>{j.push(Ge)});let ce=j.length?T.nodes.outlineBody.create({},j).content:null,Se=ce?X.content.append(ce):X.content,me=H.content.append(J.content),Be=T.nodes.outlineSection.create({...F.attrs,collapsed:!1},[K,T.nodes.outlineBody.create({},Se),T.nodes.outlineChildren.create({},me)]);_=_.replaceWith($,$+F.nodeSize,Be);let Re=_.doc.nodeAt($);if(Re){let Ge=Re.child(0),wt=Re.child(1),At=$+1+Ge.nodeSize+wt.nodeSize-1;_=_.setSelection(h.near(_.doc.resolve(At),-1))}return _=_.setMeta(le,!0),k(_.scrollIntoView()),!0},$e=u.create({name:"outlineCommands",addKeyboardShortcuts(){let E=(V,re)=>{for(let Q=re.depth;Q>0;Q-=1)if(re.node(Q)?.type?.name==="outlineSection")return re.before(Q);return null},k=(V,re)=>{for(let Q=V.depth;Q>0;Q-=1)if(V.node(Q)?.type?.name===re)return Q;return null},O=V=>{if(!V)return!0;if((V.textContent||"").replace(/\u00a0/g," ").trim())return!1;if(V.childCount)for(let Q=0;Q<V.childCount;Q+=1){let Y=V.child(Q);if(Y.type?.name!=="paragraph"||(Y.textContent||"").replace(/\u00a0/g," ").trim())return!1}return!0},R=(V,re)=>{let{selection:Q}=V;if(!Q||Q.empty)return!1;let Y=E(V.doc,Q.$from),oe=E(V.doc,Q.$to);if(typeof Y!="number"||typeof oe!="number"||Y===oe||k(Q.$from,"outlineBody")===null||Q.$to.parent?.type?.name!=="outlineHeading"||Q.$to.parentOffset!==0)return!1;let ge=V.doc.nodeAt(Y);if(!ge)return!1;let xe=ge.child(0),Ee=ge.child(1),Me=Y+1+xe.nodeSize,Ae=Me+1,Oe=Me+Ee.nodeSize-1,Ne=Math.max(Q.from,Ae),Ce=Math.min(Q.to,Oe);if(Ce<Ne)return!0;let Ie=V.tr.delete(Ne,Ce),Te=Ie.doc.nodeAt(Me);if(Te&&Te.content.size===0){let Ke=Ie.doc.type.schema;Ie=Ie.insert(Ae,Ke.nodes.paragraph.create({},[]))}return Ie=Ie.setSelection(h.near(Ie.doc.resolve(Ae+1),1)),re(Ie.scrollIntoView()),!0},U=(V,re,Q={})=>{let{selection:Y}=V;if(!Y||Y.empty)return!1;let oe=E(V.doc,Y.$from),ae=E(V.doc,Y.$to);if(typeof oe!="number"||typeof ae!="number"||oe!==ae)return!1;let ge=k(Y.$from,"outlineHeading"),xe=k(Y.$to,"outlineHeading");if(ge===null||xe===null)return!1;let Ee=V.doc.nodeAt(oe);if(!Ee)return!1;let Me=Ee.child(0),Ae=oe+1,Oe=Ae+1,Ne=Ae+Me.nodeSize-1;if(Y.from<Oe||Y.to>Ne)return!1;let Ce=Math.max(Y.from,Oe),Ie=Math.min(Y.to,Ne);if(Ie<Ce)return!0;if(typeof Q.onClipboard=="function")try{let Ke=V.doc.textBetween(Ce,Ie,`
`,`
`);Q.onClipboard(Ke)}catch{}let Te=V.tr.delete(Ce,Ie);return Te=Te.setSelection(h.near(Te.doc.resolve(Oe),1)),re(Te.scrollIntoView()),!0},D=V=>{if(!V)return!0;let re=V.child(0),Q=V.child(1),Y=V.child(2);return O(re)&&O(Q)&&(!Y||Y.childCount===0)},M=(V,re,Q)=>{let Y=V.doc.nodeAt(Q);if(!Y)return!1;let oe=Y.child(0),ae=Y.child(1),xe=Q+1+oe.nodeSize+ae.nodeSize-1,Ee=V.tr.setSelection(h.near(V.doc.resolve(xe),-1));return re(Ee.scrollIntoView()),!0},$=(V,re,Q)=>{let Y=V.doc.nodeAt(Q);if(!Y)return!1;let oe=Y.child(0),ae=Q+1,ge=V.tr.setSelection(h.near(V.doc.resolve(ae+1),1));return re(ge.scrollIntoView()),!0},C=(V,re,Q)=>{let Y=V.doc.nodeAt(Q);if(!Y)return!1;let oe=Y.child(0),ae=Y.child(1),ge=Q+1+oe.nodeSize,xe=V.tr;if(!ae.childCount){let Ee=V.doc.type.schema;xe=xe.insert(ge+1,Ee.nodes.paragraph.create({},[]))}return xe=xe.setSelection(h.near(xe.doc.resolve(ge+2),1)),re(xe.scrollIntoView()),!0},T=(V,re,Q)=>{let Y=V.doc.nodeAt(Q);if(!Y)return!1;let oe=Y.child(0),ae=Y.child(1);if(!!Y.attrs?.collapsed){let Oe=Q+1+oe.nodeSize-1,Ne=V.tr.setSelection(h.near(V.doc.resolve(Oe),-1));return re(Ne),!0}let Ee=Q+1+oe.nodeSize+ae.nodeSize-1,Me=V.tr.setSelection(h.near(V.doc.resolve(Ee),-1));return re(Me),!0},A=(V,re)=>{try{let Q=V.resolve(Math.min(V.content.size,Math.max(0,re+1)));for(let Y=Q.depth;Y>0;Y-=1){let oe=Q.node(Y);if(!(oe?.type?.name!=="outlineSection"||Q.before(Y)===re)&&oe.attrs?.collapsed)return!1}return!0}catch{return!0}},I=(V,re)=>{let Q=null;return V.nodesBetween(0,re,(Y,oe)=>{if(oe>=re)return!1;Y?.type?.name==="outlineSection"&&A(V,oe)&&(Q=oe)}),Q},H=(V,re,Q)=>{let Y=V.doc.nodeAt(Q);if(!Y)return!1;let oe=String(Y.attrs?.id||"").trim(),ae=V.doc.resolve(Q),ge=ae.index(),xe=ae.parent;if(!xe)return!1;if(xe.childCount<=1){if(xe.type?.name==="doc"){let Te=V.doc.type.schema,Ke=Te.nodes.outlineSection.create({...Y.attrs,collapsed:!1},[Te.nodes.outlineHeading.create({},[]),Te.nodes.outlineBody.create({},[Te.nodes.paragraph.create({},[])]),Te.nodes.outlineChildren.create({},[])]),nt=V.tr.replaceWith(Q,Q+Y.nodeSize,Ke);nt=nt.setMeta(le,!0);let Qe=Ke.child(0),rt=Q+1+Qe.nodeSize;return re(nt.setSelection(h.near(nt.doc.resolve(rt+2),1)).scrollIntoView()),!0}let Ce=null;try{for(let Te=ae.depth;Te>0;Te-=1)if(ae.node(Te)?.type?.name==="outlineSection"){Ce=ae.before(Te);break}}catch{Ce=null}let Ie=V.tr.delete(Q,Q+Y.nodeSize);Ie=Ie.setMeta(le,!0);try{if(typeof Ce=="number"){let Te=Ie.mapping.map(Ce,-1),Ke=Ie.doc.nodeAt(Te);if(Ke&&Ke.type?.name==="outlineSection"){let nt=Ke.child(0),Qe=Ke.child(1),rt=Te+1+nt.nodeSize;if(!Qe.childCount){let It=Ie.doc.type.schema;Ie=Ie.insert(rt+1,It.nodes.paragraph.create({},[]))}Ie=Ie.setSelection(h.near(Ie.doc.resolve(rt+2),1))}}}catch{}return re(Ie.scrollIntoView()),!0}oe&&go(oe);let Ee=ge>0,Me=Ee?xe.child(ge-1):null,Ae=Ee?Q-Me.nodeSize:null,Oe=Q+Y.nodeSize,Ne=V.tr.delete(Q,Q+Y.nodeSize);if(Ee&&typeof Ae=="number"){let Ce=Ne.doc.nodeAt(Ae);if(Ce){let Ie=Ce.child(0),Te=Ce.child(1),Ke=Ae+1+Ie.nodeSize;if(!Te.childCount){let nt=Ne.doc.type.schema;Ne=Ne.insert(Ke+1,nt.nodes.paragraph.create({},[]))}Ne=Ne.setSelection(h.near(Ne.doc.resolve(Ke+2),1))}}else{let Ce=Q<Ne.doc.content.size?Q:Oe,Ie=Ne.doc.nodeAt(Ce);if(Ie){let Te=Ie.child(0),Ke=Ie.child(1),nt=Ce+1+Te.nodeSize;if(!Ke.childCount){let Qe=Ne.doc.type.schema;Ne=Ne.insert(nt+1,Qe.nodes.paragraph.create({},[]))}Ne=Ne.setSelection(h.near(Ne.doc.resolve(nt+2),1))}}return Ne=Ne.setMeta(le,!0),re(Ne.scrollIntoView()),!0},_=(V,re,Q)=>{let Y=V.doc.nodeAt(Q);if(!Y)return!1;let oe=String(Y.attrs?.id||"").trim(),ae=V.doc.resolve(Q),ge=ae.index(),xe=ae.parent;if(!xe||ge<=0)return!1;oe&&go(oe);let Ee=xe.child(ge-1),Me=Q-Ee.nodeSize,Ae=Y.child(0),Oe=Y.child(1),Ne=Y.child(2),Ce=V.tr.delete(Q,Q+Y.nodeSize),Ie=Ce.doc.nodeAt(Me);if(!Ie)return Ce=Ce.setMeta(le,!0),re(Ce.scrollIntoView()),!0;let Te=Ce.doc.type.schema,Ke=Ie.child(0),nt=Ie.child(1),Qe=Ie.child(2),rt=[],It=(Ae?.textContent||"").replace(/\u00a0/g," ").trim();It&&rt.push(Te.nodes.paragraph.create({},[Te.text(It)])),Oe?.content?.forEach?.(_t=>{rt.push(_t)});let Ct=rt.length?Te.nodes.outlineBody.create({},rt).content:null,Ln=Ct?nt.content.append(Ct):nt.content,Xt=Qe.content.append(Ne.content),Mn=Te.nodes.outlineSection.create(Ie.attrs,[Ke,Te.nodes.outlineBody.create({},Ln),Te.nodes.outlineChildren.create({},Xt)]);Ce=Ce.replaceWith(Me,Me+Ie.nodeSize,Mn);let yt=Ce.doc.nodeAt(Me);if(yt){let _t=yt.child(0),$n=yt.child(1),Vt=Me+1+_t.nodeSize+$n.nodeSize-1;Ce=Ce.setSelection(h.near(Ce.doc.resolve(Vt),-1))}return Ce=Ce.setMeta(le,!0),re(Ce.scrollIntoView()),!0},F=(V,re,Q)=>{let Y=V.doc.nodeAt(Q);if(!Y)return!1;let oe=String(Y.attrs?.id||"").trim(),ae=V.selection.$from,ge=null,xe=null;for(let _t=ae.depth;_t>0;_t-=1)if(ae.node(_t)?.type?.name==="outlineSection")if(ge===null)ge=_t;else{xe=_t;break}if(ge===null||xe===null)return!1;let Ee=ae.before(xe);if(!V.doc.nodeAt(Ee))return!1;let Ae=V.doc.type.schema,Oe=Y.child(0),Ne=Y.child(1),Ce=Y.child(2);oe&&go(oe);let Ie=V.tr.delete(Q,Q+Y.nodeSize),Te=Ie.doc.nodeAt(Ee);if(!Te)return Ie=Ie.setMeta(le,!0),re(Ie.scrollIntoView()),!0;let Ke=Te.child(0),nt=Te.child(1),Qe=Te.child(2),rt=[],It=(Oe?.textContent||"").replace(/\u00a0/g," ").trim();It&&rt.push(Ae.nodes.paragraph.create({},[Ae.text(It)])),Ne?.content?.forEach?.(_t=>{rt.push(_t)});let Ct=rt.length?Ae.nodes.outlineBody.create({},rt).content:null,Ln=Ct?nt.content.append(Ct):nt.content,Xt=Ce.content.append(Qe.content),Mn=Ae.nodes.outlineSection.create({...Te.attrs,collapsed:!1},[Ke,Ae.nodes.outlineBody.create({},Ln),Ae.nodes.outlineChildren.create({},Xt)]);Ie=Ie.replaceWith(Ee,Ee+Te.nodeSize,Mn);let yt=Ie.doc.nodeAt(Ee);if(yt){let _t=yt.child(0),$n=yt.child(1),Vt=Ee+1+_t.nodeSize+$n.nodeSize-1;Ie=Ie.setSelection(h.near(Ie.doc.resolve(Vt),-1))}return Ie=Ie.setMeta(le,!0),re(Ie.scrollIntoView()),!0},K=(V,re,Q)=>{let Y=V.doc.nodeAt(Q);if(!Y)return!1;let oe=V.doc.resolve(Q),ae=oe.index(),ge=oe.parent;if(!ge||ae>=ge.childCount-1)return!1;let xe=Q+Y.nodeSize,Ee=V.doc.nodeAt(xe);if(!Ee||Ee.type?.name!=="outlineSection")return!1;let Me=V.doc.type.schema,Ae=Y.child(0),Oe=Y.child(1),Ne=Y.child(2),Ce=Ee.child(1),Ie=Ee.child(2),Te=Oe.content.append(Ce.content),Ke=Ne.content.append(Ie.content),nt=Me.nodes.outlineSection.create({...Y.attrs,collapsed:!1},[Ae,Me.nodes.outlineBody.create({},Te),Me.nodes.outlineChildren.create({},Ke)]),Qe=V.tr;Qe=Qe.delete(xe,xe+Ee.nodeSize),Qe=Qe.replaceWith(Q,Q+Y.nodeSize,nt);let rt=Qe.doc.nodeAt(Q);if(rt){let It=rt.child(0),Ct=rt.child(1),Xt=Q+1+It.nodeSize+Ct.nodeSize-1;Qe=Qe.setSelection(h.near(Qe.doc.resolve(Xt),-1))}return Qe=Qe.setMeta(le,!0),re(Qe.scrollIntoView()),!0},X=V=>this.editor.commands.command(({state:re,dispatch:Q})=>{let Y=Ce=>{try{if(typeof CSS<"u"&&CSS&&typeof CSS.escape=="function")return CSS.escape(String(Ce||""))}catch{}return String(Ce||"").replace(/["\\]/g,"\\$&")},oe=Ce=>{try{let Ie=Ce;for(;Ie&&Ie!==document.body;){let Te=Ie.parentElement;if(!Te)break;let Ke=window.getComputedStyle(Te),nt=String(Ke?.overflowY||"");if((nt==="auto"||nt==="scroll")&&Te.scrollHeight>Te.clientHeight+1)return Te;Ie=Te}}catch{}return document.scrollingElement||document.documentElement},ae=Ce=>{try{let Ie=String(Ce||"").trim();if(!Ie)return null;let Te=document.querySelector(`.outline-heading[data-section-id="${Y(Ie)}"]`);if(!Te)return null;let Ke=oe(Te);return{sid:Ie,scrollEl:Ke,top:Te.getBoundingClientRect().top}}catch{return null}},ge=Ce=>{if(!Ce)return;let{sid:Ie,scrollEl:Te,top:Ke}=Ce,nt=()=>{try{let Qe=document.querySelector(`.outline-heading[data-section-id="${Y(Ie)}"]`);if(!Qe)return;let It=Qe.getBoundingClientRect().top-Ke;if(!Number.isFinite(It)||Math.abs(It)<1)return;Te.scrollTop+=It}catch{}};try{requestAnimationFrame(()=>requestAnimationFrame(nt))}catch{setTimeout(nt,0)}},xe=E(re.doc,re.selection.$from);if(typeof xe!="number")return!1;let Ee=re.doc.resolve(xe),Me=Ee.index(),Ae=Ee.parent;if(!Ae)return!1;let Oe=re.doc.nodeAt(xe);if(!Oe)return!1;let Ne=ae(String(Oe.attrs?.id||"").trim());if(V==="up"){if(Me>0){let br=Ae.child(Me-1),nr=xe-br.nodeSize,qt=re.tr.delete(xe,xe+Oe.nodeSize).insert(nr,Oe).setMeta(le,!0),Dr=h.near(qt.doc.resolve(nr+2),1);return qt.setSelection(Dr),Q(qt.scrollIntoView()),ge(Ne),!0}let Ce=me(re.doc,xe);if(typeof Ce!="number")return!1;let Ie=re.doc.resolve(Ce),Te=Ie.index(),Ke=Ie.parent;if(!Ke||Te<=0)return!1;let nt=Ke.child(Te-1),Qe=Ce-nt.nodeSize,rt=re.doc.nodeAt(Qe);if(!rt||rt.type?.name!=="outlineSection")return!1;let It=rt.child(0),Ct=rt.child(1),Ln=rt.child(2),Mn=Qe+1+It.nodeSize+Ct.nodeSize+Ln.nodeSize-1,yt=re.tr.delete(xe,xe+Oe.nodeSize).setMeta(le,!0),_t=yt.mapping.map(Qe,-1),$n=yt.mapping.map(Mn,-1);yt=yt.insert($n,Oe);let Nn=yt.doc.nodeAt(_t);Nn?.type?.name==="outlineSection"&&Nn.attrs?.collapsed&&(yt=yt.setNodeMarkup(_t,void 0,{...Nn.attrs,collapsed:!1}));let Vt=h.near(yt.doc.resolve($n+2),1);return yt.setSelection(Vt),Q(yt.scrollIntoView()),ge(Ne),!0}if(V==="down"){if(Me<Ae.childCount-1){let br=xe+Oe.nodeSize,nr=re.doc.nodeAt(br);if(!nr)return!1;let qt=re.tr.delete(xe,xe+Oe.nodeSize).setMeta(le,!0),Dr=xe+nr.nodeSize;qt.insert(Dr,Oe);let Si=h.near(qt.doc.resolve(Dr+2),1);return qt.setSelection(Si),Q(qt.scrollIntoView()),ge(Ne),!0}let Ce=me(re.doc,xe);if(typeof Ce!="number")return!1;let Ie=re.doc.nodeAt(Ce);if(!Ie||Ie.type?.name!=="outlineSection")return!1;let Te=re.doc.resolve(Ce),Ke=Te.index(),nt=Te.parent;if(!nt||Ke>=nt.childCount-1)return!1;let Qe=Ce+Ie.nodeSize,rt=re.doc.nodeAt(Qe);if(!rt||rt.type?.name!=="outlineSection")return!1;let It=rt.child(0),Ct=rt.child(1),Ln=rt.child(2),Mn=Qe+1+It.nodeSize+Ct.nodeSize+1,yt=re.tr.delete(xe,xe+Oe.nodeSize).setMeta(le,!0),_t=yt.mapping.map(Qe,-1),$n=yt.mapping.map(Mn,-1);yt=yt.insert($n,Oe);let Nn=yt.doc.nodeAt(_t);Nn?.type?.name==="outlineSection"&&Nn.attrs?.collapsed&&(yt=yt.setNodeMarkup(_t,void 0,{...Nn.attrs,collapsed:!1}));let Vt=h.near(yt.doc.resolve($n+2),1);return yt.setSelection(Vt),Q(yt.scrollIntoView()),ge(Ne),!0}return!1}),J=()=>this.editor.commands.command(({state:V,dispatch:re})=>{let{selection:Q}=V;if(!Q?.empty)return!1;let{$from:Y}=Q,oe=E(V.doc,Y);if(typeof oe!="number")return!1;let ae=V.doc.nodeAt(oe);if(!ae)return!1;let ge=V.doc.type.schema;if(ae.attrs?.collapsed){let Vt=oe+ae.nodeSize,br=tn(),nr=ge.nodes.outlineSection.create({id:br,collapsed:!1},[ge.nodes.outlineHeading.create({},[]),ge.nodes.outlineBody.create({},[ge.nodes.paragraph.create({},[])]),ge.nodes.outlineChildren.create({},[])]),qt=V.tr.insert(Vt,nr);return qt=qt.setSelection(h.create(qt.doc,Vt+2)),qt=qt.setMeta(le,!0),ke&&(qt=qt.setMeta(ke,{type:"enter",sectionId:br})),re(qt.scrollIntoView()),!0}let xe=ge.nodes.outlineChildren.create({},[]),Ee=Vt=>Vt&&Vt.childCount?Vt:ge.nodes.outlineBody.create({},[ge.nodes.paragraph.create({},[])]);if(Y.parent?.type?.name==="outlineHeading"){let Vt=ae.child(0),br=ae.child(1),nr=ae.child(2),qt=Y.parentOffset||0,Dr=Vt.textBetween(0,Math.max(0,Math.min(qt,Vt.content.size)),"",""),Si=Vt.textBetween(Math.max(0,Math.min(qt,Vt.content.size)),Vt.content.size,"",""),Em=ge.nodes.outlineHeading.create({},Dr?[ge.text(Dr)]:[]),Tm=ge.nodes.outlineHeading.create({},Si?[ge.text(Si)]:[]),hl=tn(),gl=ge.nodes.outlineSection.create({...ae.attrs,collapsed:!1},[Em,Ee(ge.nodes.outlineBody.create({},[])),xe]),Cm=ge.nodes.outlineSection.create({id:hl,collapsed:!1},[Tm,Ee(br),nr]),Fn=V.tr.replaceWith(oe,oe+ae.nodeSize,gl),yl=Fn.doc.nodeAt(oe),bl=oe+(yl?yl.nodeSize:gl.nodeSize);return Fn=Fn.insert(bl,Cm),Fn=Fn.setSelection(h.create(Fn.doc,bl+2)),Fn=Fn.setMeta(le,!0),ke&&(Fn=Fn.setMeta(ke,{type:"enter",sectionId:hl})),re(Fn.scrollIntoView()),!0}if(k(Y,"outlineBody")===null||!Y.parent?.isTextblock)return!1;let Ae=V.tr,Oe=Q.from;try{Ae=Ae.split(Oe)}catch{return!1}let Ne=Ae.mapping.map(Oe);try{Ae=Ae.setSelection(h.near(Ae.doc.resolve(Math.min(Ae.doc.content.size,Ne+1)),1))}catch{}let Ce=Ae.selection.$from,Ie=k(Ce,"outlineBody"),Te=k(Ce,"paragraph");if(Ie===null||Te===null)return!1;let Ke=Ce.before(Te),nt=Ce.end(Ie);if(typeof Ke!="number"||typeof nt!="number"||nt<Ke)return!1;let Qe=Ae.doc.slice(Ke,nt).content;Ae=Ae.delete(Ke,nt);let rt=Ae.mapping.map(oe,-1),It=Ae.doc.nodeAt(rt);if(!It)return re(Ae.scrollIntoView()),!0;let Ct=It.child(0),Ln=Ee(It.child(1)),Xt=It.child(2),Mn=ge.nodes.outlineSection.create({...It.attrs,collapsed:!1},[Ct,Ln,xe]),yt=Qe&&Qe.childCount?ge.nodes.outlineBody.create({},Qe):ge.nodes.outlineBody.create({},[ge.nodes.paragraph.create({},[])]),_t=tn(),$n=ge.nodes.outlineSection.create({id:_t,collapsed:!1},[ge.nodes.outlineHeading.create({},[]),yt,Xt]);Ae=Ae.replaceWith(rt,rt+It.nodeSize,Mn);let Nn=rt+Mn.nodeSize;return Ae=Ae.insert(Nn,$n),Ae=Ae.setSelection(h.create(Ae.doc,Nn+2)),Ae=Ae.setMeta(le,!0),ke&&(Ae=Ae.setMeta(ke,{type:"enter",sectionId:_t})),re(Ae.scrollIntoView()),!0}),j=()=>this.editor.commands.command(({state:V,dispatch:re})=>{let Q=E(V.doc,V.selection.$from);if(typeof Q!="number")return!1;let Y=V.doc.resolve(Q),oe=0;for(let rt=Y.depth;rt>=0;rt-=1)Y.node(rt)?.type?.name==="outlineSection"&&(oe+=1);if(oe>=6)return!1;let ae=Y.index(),ge=Y.parent;if(!ge||ae<=0)return!1;let xe=V.doc.nodeAt(Q);if(!xe)return!1;let Ee=ge.child(ae-1),Me=Q-Ee.nodeSize,Ae=V.doc.nodeAt(Me);if(!Ae)return!1;let Oe=Ae.child(0),Ne=Ae.child(1),Ce=Ae.child(2),Te=Me+1+Oe.nodeSize+Ne.nodeSize+Ce.nodeSize-1,Ke=V.tr.delete(Q,Q+xe.nodeSize).insert(Te,xe).setMeta(le,!0),nt=Ke.doc.nodeAt(Me);nt?.type?.name==="outlineSection"&&nt.attrs?.collapsed&&(Ke=Ke.setNodeMarkup(Me,void 0,{...nt.attrs,collapsed:!1}));let Qe=h.near(Ke.doc.resolve(Te+2),1);return Ke.setSelection(Qe),re(Ke.scrollIntoView()),!0}),te=()=>this.editor.commands.command(({state:V,dispatch:re})=>{let Q=V.selection.$from,Y=null,oe=null;for(let Ne=Q.depth;Ne>0;Ne-=1)if(Q.node(Ne)?.type?.name==="outlineSection")if(Y===null)Y=Ne;else{oe=Ne;break}if(Y===null||oe===null)return!1;let ae=Q.before(Y),ge=Q.before(oe),xe=V.doc.nodeAt(ae);if(!xe)return!1;let Ee=V.tr.delete(ae,ae+xe.nodeSize).setMeta(le,!0),Me=Ee.doc.nodeAt(ge);if(!Me)return!1;let Ae=ge+Me.nodeSize;Ee.insert(Ae,xe);let Oe=h.near(Ee.doc.resolve(Ae+2),1);return Ee.setSelection(Oe),re(Ee.scrollIntoView()),!0}),ce=V=>this.editor.commands.command(({state:re,dispatch:Q})=>{let Y=E(re.doc,re.selection.$from);if(typeof Y!="number")return!1;let oe=re.doc.nodeAt(Y);if(!oe)return!1;let ae=typeof V=="boolean"?V:!oe.attrs?.collapsed,ge=re.tr.setNodeMarkup(Y,void 0,{...oe.attrs,collapsed:ae}).setMeta(le,!0);try{ae&&ke&&(ke.getState(re)||{}).editingSectionId&&(ge=ge.setMeta(ke,{type:"exit"}))}catch{}return Q(ge),!0}),Se=(V,re)=>{let Q=V.nodeAt(re);if(!Q||Q.type?.name!=="outlineSection")return[];let Y=[re];return Q.descendants((oe,ae)=>{oe?.type?.name==="outlineSection"&&Y.push(re+1+ae)}),Y},me=(V,re)=>{try{let Q=V.resolve(Math.min(V.content.size,re+1)),Y=null;for(let oe=Q.depth;oe>0;oe-=1){if(Q.node(oe)?.type?.name!=="outlineSection")continue;if(Q.before(oe)===re){Y=oe;break}}if(Y===null)return null;for(let oe=Y-1;oe>0;oe-=1)if(Q.node(oe)?.type?.name==="outlineSection")return Q.before(oe);return null}catch{return null}},Be=(V,re,Q,Y)=>{let oe=!!Y,ae=V.tr;for(let ge of Q){let xe=ae.doc.nodeAt(ge);!xe||xe.type?.name!=="outlineSection"||!!xe.attrs?.collapsed!==oe&&(ae=ae.setNodeMarkup(ge,void 0,{...xe.attrs,collapsed:oe}))}ae=ae.setMeta(le,!0);try{oe&&ke&&(ke.getState(V)||{}).editingSectionId&&(ae=ae.setMeta(ke,{type:"exit"}))}catch{}re(ae)},Re=()=>this.editor.commands.command(({state:V,dispatch:re})=>{let Q=E(V.doc,V.selection.$from);if(typeof Q!="number")return!1;let Y=me(V.doc,Q),oe=typeof Y=="number"?Y:Q,ae=Se(V.doc,oe);if(!ae.length)return!1;let ge=V.tr;for(let Ee of ae){let Me=ge.doc.nodeAt(Ee);!Me||Me.type?.name!=="outlineSection"||Me.attrs?.collapsed||(ge=ge.setNodeMarkup(Ee,void 0,{...Me.attrs,collapsed:!0}))}ge=ge.setMeta(le,!0);let xe=ge.doc.nodeAt(oe);if(xe){let Ee=xe.child(0),Ae=oe+1+Ee.nodeSize-1;ge=ge.setSelection(h.near(ge.doc.resolve(Ae),-1))}return re(ge.scrollIntoView()),!0}),Ge=()=>this.editor.commands.command(({state:V,dispatch:re})=>{let Q=E(V.doc,V.selection.$from);if(typeof Q!="number")return!1;let Y=Se(V.doc,Q);return Y.length?(Be(V,re,Y,!1),!0):!1}),wt=(V,re)=>{try{let Q=V.nodeAt(re);if(!Q||Q.type?.name!=="outlineSection")return[];if(Q.childCount<3)return[];let Y=Q.child(0),oe=Q.child(1),ae=Q.child(2);if(!ae||ae.type?.name!=="outlineChildren")return[];let ge=re+1+Y.nodeSize+oe.nodeSize,xe=[];return ae.descendants((Ee,Me)=>{Ee?.type?.name==="outlineSection"&&xe.push(ge+1+Me)}),xe}catch{return[]}},qe=(V,re)=>{try{let Q=me(V,re);if(typeof Q!="number")return yo(V);let Y=V.nodeAt(Q);if(!Y||Y.type?.name!=="outlineSection"||Y.childCount<3)return yo(V);let oe=Y.child(0),ae=Y.child(1),ge=Y.child(2);if(!ge||ge.type?.name!=="outlineChildren")return yo(V);let xe=Q+1+oe.nodeSize+ae.nodeSize,Ee=[];return ge.descendants((Me,Ae)=>{Me?.type?.name==="outlineSection"&&Ee.push(xe+1+Ae)}),Ee}catch{return yo(V)}},At=(V,re)=>{try{for(let Q of re||[]){let Y=V.nodeAt(Q);if(!(!Y||Y.type?.name!=="outlineSection")&&Y.attrs?.collapsed)return!0}}catch{}return!1},St=()=>this.editor.commands.command(({state:V,dispatch:re})=>{let Q=E(V.doc,V.selection.$from);if(typeof Q!="number")return!1;let Y=V.doc.nodeAt(Q);if(!Y||Y.type?.name!=="outlineSection")return!1;if(Y.attrs?.collapsed)return Be(V,re,[Q],!1),!0;let oe=wt(V.doc,Q);if(oe.length&&At(V.doc,oe))return Be(V,re,oe,!1),!0;let ae=Q;for(let xe=0;xe<64;xe+=1){let Ee=qe(V.doc,ae);if(Ee.length&&At(V.doc,Ee))return Be(V,re,Ee,!1),!0;let Me=me(V.doc,ae);if(typeof Me!="number")break;ae=Me}let ge=yo(V.doc);return ge.length&&At(V.doc,ge)?(Be(V,re,ge,!1),!0):!1}),rn=V=>this.editor.commands.command(({state:re,dispatch:Q})=>{let{selection:Y}=re,ae=(Y?.node||null)?.type?.name==="outlineSection"?Y.from:E(re.doc,re.selection.$from);if(typeof ae!="number"||!re.doc.nodeAt(ae))return!1;let xe=!!V,Ee=Se(re.doc,ae);return Ee.length?(Be(re,Q,Ee,xe),!0):!1});return{"Alt-ArrowUp":()=>this.editor.isActive("table")?!1:X("up"),"Alt-ArrowDown":()=>this.editor.isActive("table")?!1:X("down"),"Alt-ArrowRight":()=>this.editor.isActive("table")?!1:j(),"Alt-ArrowLeft":()=>this.editor.isActive("table")?!1:te(),"Mod-ArrowRight":()=>ce(!1),"Mod-ArrowLeft":()=>ce(!0),"Mod-ArrowUp":()=>{try{let V=this.editor.state,re=E(V.doc,V.selection.$from);if(typeof re=="number"){let Q=V.doc.nodeAt(re);if(Q?.type?.name==="outlineSection"&&typeof me(V.doc,re)!="number"&&Q.attrs?.collapsed)return qc(this.editor,!0)}}catch{}return Re()},"Mod-ArrowDown":()=>St(),"Mod-Enter":()=>{try{if(ke&&!(ke.getState(this.editor.state)||{}).editingSectionId)return!1}catch{}return J()},Backspace:()=>this.editor.commands.command(({state:V,dispatch:re})=>{let{selection:Q}=V;if(U(V,re)||R(V,re))return!0;if(!Q?.empty)return!1;let{$from:Y}=Q;if(Y.parent?.type?.name!=="outlineHeading"||Y.parentOffset!==0)return!1;let oe=E(V.doc,Y);if(typeof oe!="number")return!1;let ae=V.doc.nodeAt(oe);if(!ae)return!1;if(D(ae))return H(V,re,oe);try{if(V.doc.resolve(oe).index()<=0)return F(V,re,oe)}catch{}return _(V,re,oe)}),Delete:()=>this.editor.commands.command(({state:V,dispatch:re})=>{let{selection:Q}=V;if(U(V,re)||R(V,re))return!0;if(!Q?.empty)return!1;let{$from:Y}=Q;if(k(Y,"outlineBody")!==null){let Ee=E(V.doc,Y);if(typeof Ee!="number")return!1;let Me=V.doc.nodeAt(Ee);if(!Me)return!1;let Ae=Me.child(0),Oe=Me.child(1),Ce=Ee+1+Ae.nodeSize+Oe.nodeSize-1;return Y.pos===Ce?K(V,re,Ee):!1}if(Y.parent?.type?.name!=="outlineHeading")return!1;let ae=E(V.doc,Y);if(typeof ae!="number")return!1;let ge=V.doc.nodeAt(ae);if(!ge)return!1;let xe=ge.child(0);if(Y.parentOffset===xe.content.size){if(D(ge))return H(V,re,ae);let Ee=ge.child(1),Me=ae+1+xe.nodeSize,Ae=V.tr;if(!Ee.childCount){let Oe=V.doc.type.schema;Ae=Ae.insert(Me+1,Oe.nodes.paragraph.create({},[]))}return Ae=Ae.setSelection(h.near(Ae.doc.resolve(Me+2),1)),re(Ae.scrollIntoView()),!0}return!1}),Enter:()=>this.editor.commands.command(({state:V,dispatch:re})=>{let{selection:Q}=V;if(!Q?.empty)return!1;let{$from:Y}=Q;if(Y.parent?.type?.name!=="outlineHeading")return!1;try{if(ke&&!(ke.getState(V)||{}).editingSectionId)return!1}catch{}let oe=E(V.doc,Y);if(typeof oe!="number")return!1;let ae=V.doc.nodeAt(oe);if(!ae)return!1;let ge=ae.child(0),xe=ae.child(1),Ee=oe+1+ge.nodeSize,Me=ge.content?.size??0;if(ae.attrs?.collapsed&&Y.parentOffset===Me){let Oe=oe+ae.nodeSize,Ne=V.doc.type.schema,Ce=tn(),Ie=Ne.nodes.outlineSection.create({id:Ce,collapsed:!1},[Ne.nodes.outlineHeading.create({},[]),Ne.nodes.outlineBody.create({},[Ne.nodes.paragraph.create({},[])]),Ne.nodes.outlineChildren.create({},[])]),Te=V.tr.insert(Oe,Ie);return Te=Te.setSelection(h.create(Te.doc,Oe+2)),Te=Te.setMeta(le,!0),ke&&(Te=Te.setMeta(ke,{type:"enter",sectionId:Ce})),re(Te.scrollIntoView()),!0}if(Y.parentOffset===0){let Oe=V.doc.type.schema,Ne=tn(),Ce=Oe.nodes.outlineSection.create({id:Ne,collapsed:!1},[Oe.nodes.outlineHeading.create({},[]),Oe.nodes.outlineBody.create({},[Oe.nodes.paragraph.create({},[])]),Oe.nodes.outlineChildren.create({},[])]),Ie=V.tr.insert(oe,Ce);return Ie=Ie.setSelection(h.create(Ie.doc,oe+2)),Ie=Ie.setMeta(le,!0),ke&&(Ie=Ie.setMeta(ke,{type:"enter",sectionId:Ne})),re(Ie.scrollIntoView()),!0}if(Y.parentOffset>0&&Y.parentOffset<Me){let Oe=V.doc.type.schema,Ne=ge.textBetween(0,Math.max(0,Math.min(Y.parentOffset,Me)),"",""),Ce=ge.textBetween(Math.max(0,Math.min(Y.parentOffset,Me)),Me,"",""),Ie=Oe.nodes.outlineHeading.create({},Ne?[Oe.text(Ne)]:[]),Te=ae.child(2),Ke=[];try{for(let Xt=0;Xt<xe.childCount;Xt+=1)Ke.push(xe.child(Xt))}catch{}let nt=Oe.nodes.paragraph.create({},Ce?[Oe.text(Ce)]:[]),Qe=[];if(Ce){let Xt=Ke[0]||null;Xt&&Xt.type?.name==="paragraph"&&O(Xt)?Qe=[nt,...Ke.slice(1)]:Qe=[nt,...Ke]}else Qe=Ke;Qe.length||(Qe=[Oe.nodes.paragraph.create({},[])]);let rt=Oe.nodes.outlineBody.create({},Qe),It=Oe.nodes.outlineSection.create({...ae.attrs,collapsed:!1},[Ie,rt,Te]),Ct=V.tr.replaceWith(oe,oe+ae.nodeSize,It),Ln=Ct.doc.nodeAt(oe);if(Ln){let Xt=Ln.child(0),Mn=oe+1+Xt.nodeSize;Ct=Ct.setSelection(h.near(Ct.doc.resolve(Mn+2),1))}else Ct=Ct.setSelection(h.near(Ct.doc.resolve(Ee+2),1));return Ct=Ct.setMeta(le,!0),re(Ct.scrollIntoView()),!0}let Ae=V.tr;if(!xe.childCount){let Oe=V.doc.type.schema;Ae=Ae.insert(Ee+1,Oe.nodes.paragraph.create({},[]))}return Ae=Ae.setSelection(h.near(Ae.doc.resolve(Ee+2),1)),re(Ae.scrollIntoView()),!0}),ArrowUp:()=>this.editor.commands.command(({state:V,dispatch:re})=>{let{selection:Q}=V;if(!Q?.empty)return!1;let{$from:Y}=Q;if(Y.parent?.type?.name!=="outlineHeading"||Y.parentOffset!==0)return!1;let oe=E(V.doc,Y);if(typeof oe!="number")return!1;let ae=I(V.doc,oe);if(typeof ae=="number")return $(V,re,ae);let ge=V.doc.resolve(oe),xe=ge.index(),Ee=ge.parent;if(!Ee)return!1;if(xe>0){let Ne=Ee.child(xe-1),Ce=oe-Ne.nodeSize;return $(V,re,Ce)}let Me=null,Ae=null;for(let Ne=Y.depth;Ne>0;Ne-=1)if(Y.node(Ne)?.type?.name==="outlineSection")if(Me===null)Me=Ne;else{Ae=Ne;break}if(Ae===null)return!1;let Oe=Y.before(Ae);return $(V,re,Oe)})}},addProseMirrorPlugins(){let E=(k,O)=>{for(let R=k.depth;R>0;R-=1)if(k.node(R)?.type?.name===O)return R;return null};return[new b({key:new S("outlineAltMoveRepeatGuard"),props:{handleKeyDown:(k,O)=>{try{if(!O||!O.altKey||O.metaKey||O.ctrlKey)return!1;let R=String(O.key||"");if(R!=="ArrowUp"&&R!=="ArrowDown"||!O.repeat)return!1;let U=k?.state,D=U?.selection?.$from;if(!D)return!1;for(let A=D.depth;A>0;A-=1){let I=D.node(A)?.type?.name;if(I&&String(I).startsWith("table"))return!1}let M=null;for(let A=D.depth;A>0;A-=1)if(D.node(A)?.type?.name==="outlineSection"){M=D.before(A);break}if(typeof M!="number")return!1;let $=U.doc.resolve(M),C=$.parent;if(!C)return!1;let T=$.index();return R==="ArrowUp"&&T<=0||R==="ArrowDown"&&T>=C.childCount-1}catch{return!1}}}}),new b({props:{handleDOMEvents:{cut:(k,O)=>{try{let{state:R}=k,{selection:U}=R;if(!U||U.empty)return!1;let D=(Se,me)=>{for(let Be=me.depth;Be>0;Be-=1)if(me.node(Be)?.type?.name==="outlineSection")return me.before(Be);return null},M=D(R.doc,U.$from),$=D(R.doc,U.$to);if(typeof M!="number"||typeof $!="number")return!1;let C=(Se="")=>String(Se||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");if(M===$){let Se=E(U.$from,"outlineHeading"),me=E(U.$to,"outlineHeading");if(Se!==null&&me!==null){let Be=R.doc.nodeAt(M);if(!Be)return!1;let Re=Be.child(0),Ge=M+1,wt=Ge+1,qe=Ge+Re.nodeSize-1;if(U.from>=wt&&U.to<=qe){let At=Math.max(U.from,wt),St=Math.min(U.to,qe),rn=R.doc.textBetween(At,St,`
`,`
`);if(O?.clipboardData)try{O.clipboardData.setData("text/plain",rn),O.clipboardData.setData("text/html",`<pre>${C(rn)}</pre>`)}catch{}O.preventDefault(),O.stopPropagation();let V=R.tr.delete(At,St);return V=V.setSelection(h.near(V.doc.resolve(wt),1)),k.dispatch(V.scrollIntoView()),!0}}return!1}if(E(U.$from,"outlineBody")===null||U.$to.parent?.type?.name!=="outlineHeading"||U.$to.parentOffset!==0)return!1;let A=R.doc.nodeAt(M);if(!A)return!1;let I=A.child(0),H=A.child(1),_=M+1+I.nodeSize,F=_+1,K=_+H.nodeSize-1,X=Math.max(U.from,F),J=Math.min(U.to,K);if(J<X)return!0;let j=R.doc.textBetween(X,J,`
`,`
`);if(O?.clipboardData)try{O.clipboardData.setData("text/plain",j),O.clipboardData.setData("text/html",`<pre>${C(j)}</pre>`)}catch{}O.preventDefault(),O.stopPropagation();let te=R.tr.delete(X,J),ce=te.doc.nodeAt(_);if(ce&&ce.content.size===0){let Se=te.doc.type.schema;te=te.insert(F,Se.nodes.paragraph.create({},[]))}return te=te.setSelection(h.near(te.doc.resolve(F+1),1)),k.dispatch(te.scrollIntoView()),!0}catch{return!1}}}}}),new b({props:{handleKeyDown:(k,O)=>{if(O.key!=="Backspace")return!1;let{state:R}=k,{selection:U}=R;if(!U?.empty)return!1;let{$from:D}=U;if(D.parent?.type?.name!=="paragraph"||D.parentOffset!==0)return!1;let M=null;for(let te=D.depth;te>0;te-=1)if(D.node(te)?.type?.name==="listItem"){M=te;break}if(M===null||D.index(M)!==0)return!1;let $=M-1,C=D.node($);if(!C)return!1;let T=D.index($);if(T<=0)return!1;let A=D.before(M),I=C.child(T-1),H=A-I.nodeSize,_=R.doc.nodeAt(A);if(!_||_.type?.name!=="listItem")return!1;O.preventDefault(),O.stopPropagation();let F=I.type.create(I.attrs,I.content.append(_.content),I.marks),K=R.tr.replaceWith(H,H+I.nodeSize,F),X=H+1+I.content.size,J=K.mapping.map(X,1),j=K.mapping.map(A);K=K.delete(j,j+_.nodeSize);try{K=K.setSelection(h.near(K.doc.resolve(J+1),1))}catch{}return k.dispatch(K.scrollIntoView()),!0}}}),new b({props:{handleKeyDown:(k,O)=>(O.key!=="Tab"||O.preventDefault(),!1)}}),new b({props:{handleKeyDown:(k,O)=>{if(!O.ctrlKey||O.shiftKey||O.altKey||O.metaKey||O.key!=="ArrowUp"&&O.key!=="ArrowDown")return!1;let{state:R}=k,{selection:U}=R;if(!U)return!1;let M=(()=>{if((U?.node||null)?.type?.name==="outlineSection")return U.from;let H=U.$from;for(let _=H.depth;_>0;_-=1)if(H.node(_)?.type?.name==="outlineSection")return H.before(_);return null})();if(typeof M!="number")return!1;let $=(I,H)=>{try{let _=I.resolve(Math.min(I.content.size,H+1)),F=null;for(let K=_.depth;K>0;K-=1)if(_.node(K)?.type?.name==="outlineSection"&&_.before(K)===H){F=K;break}if(F===null)return null;for(let K=F-1;K>0;K-=1)if(_.node(K)?.type?.name==="outlineSection")return _.before(K);return null}catch{return null}},C=(I,H)=>{let _=I.nodeAt(H);if(!_||_.type?.name!=="outlineSection")return[];let F=[H];return _.descendants((K,X)=>{K?.type?.name==="outlineSection"&&F.push(H+1+X)}),F};if(O.preventDefault(),O.stopPropagation(),O.key==="ArrowUp"){let I=$(R.doc,M),H=typeof I=="number"?I:M,_=C(R.doc,H);if(!_.length)return!0;let F=R.tr;for(let X of _){let J=F.doc.nodeAt(X);!J||J.type?.name!=="outlineSection"||J.attrs?.collapsed||(F=F.setNodeMarkup(X,void 0,{...J.attrs,collapsed:!0}))}let K=F.doc.nodeAt(H);if(K){let X=K.child(0),j=H+1+X.nodeSize-1;F=F.setSelection(h.near(F.doc.resolve(j),-1))}return k.dispatch(F.scrollIntoView()),!0}let T=C(R.doc,M);if(!T.length)return!0;let A=R.tr;for(let I of T){let H=A.doc.nodeAt(I);!H||H.type?.name!=="outlineSection"||H.attrs?.collapsed&&(A=A.setNodeMarkup(I,void 0,{...H.attrs,collapsed:!1}))}return k.dispatch(A),!0}}}),new b({props:{handleKeyDown:(k,O)=>{if(O.key!=="Enter")return!1;let{state:R}=k,{$from:U}=R.selection;if(!R.selection.empty)return!1;let D=E(U,"outlineBody");if(D===null)return!1;let M=E(U,"paragraph");if(M===null||U.node(M-1)?.type?.name!=="outlineBody")return!1;let $=U.node(M);if(!$||$.content.size!==0||U.parentOffset!==0&&U.parentOffset!==$.content.size)return!1;let C=U.node(D),T=U.index(D);if(T!==C.childCount-1||T<1)return!1;let A=C.child(T-1);if(!A||A.type?.name!=="paragraph"||A.content.size!==0)return!1;let I=E(U,"outlineSection");if(I===null)return!1;let H=U.before(I);O.preventDefault(),O.stopPropagation();let _=R.tr,F=U.start(D),K=F;for(let Re=0;Re<T;Re+=1)K+=C.child(Re).nodeSize;let X=T;for(let Re=T;Re>=0;Re-=1){let Ge=C.child(Re);if(!Ge||Ge.type?.name!=="paragraph"||Ge.content.size!==0)break;X=Re}let J=F;for(let Re=0;Re<X;Re+=1)J+=C.child(Re).nodeSize;let j=K+C.child(T).nodeSize;_=_.delete(J,j);let te=_.doc.nodeAt(H);if(!te)return!0;let ce=H+te.nodeSize,Se=_.doc.type.schema,me=tn(),Be=Se.nodes.outlineSection.create({id:me,collapsed:!1},[Se.nodes.outlineHeading.create({},[]),Se.nodes.outlineBody.create({},[Se.nodes.paragraph.create({},[])]),Se.nodes.outlineChildren.create({},[])]);return _=_.insert(ce,Be),_=_.setSelection(h.create(_.doc,ce+2)),_=_.setMeta(le,!0),ke&&(_=_.setMeta(ke,{type:"enter",sectionId:me})),k.dispatch(_.scrollIntoView()),!0}}})]}}),et=u.create({name:"outlineActiveSection",addProseMirrorPlugins(){return[new b({props:{decorations(E){try{let k=Rt(E.doc,E.selection.$from);if(typeof k!="number")return null;let O=E.doc.nodeAt(k);return O?v.create(E.doc,[x.node(k,k+O.nodeSize,{"data-active":"true"})]):null}catch{return null}}}})]}}),tt=u.create({name:"outlineEditMode",addProseMirrorPlugins(){let E=new S("outlineEditMode");ke=E;let k=null,O=C=>{let T=Rt(C.doc,C.selection.$from);if(typeof T!="number")return null;let A=C.doc.nodeAt(T);return String(A?.attrs?.id||"")||null},R=(C,T,A)=>{if(!T.docChanged)return!0;if(!A)return!1;let I=ht(C.doc,A);if(typeof I!="number")return!1;let H=C.doc.nodeAt(I);if(!H)return!1;let _=H.child(0),F=H.child(1),K=I+1,X=K+1,J=K+_.nodeSize-1,j=I+1+_.nodeSize,te=j+1,ce=j+F.nodeSize-1,Se=(me,Be)=>{let Re=me>=X&&Be<=J,Ge=me>=te&&Be<=ce;return Re||Ge};for(let me of T.steps){let Be=me.getMap(),Re=!0;if(Be.forEach((Ge,wt)=>{Se(Ge,wt)||(Re=!1)}),!Re)return!1}return!0},U=()=>{try{L("\u0414\u043B\u044F \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Enter \u0438\u043B\u0438 \u0434\u0432\u043E\u0439\u043D\u043E\u0439 \u043A\u043B\u0438\u043A \u043C\u044B\u0448\u043A\u043E\u0439. Esc \u0434\u043B\u044F \u0432\u044B\u0445\u043E\u0434\u0430.")}catch{}},D=()=>{try{L("\u041D\u0430\u0436\u043C\u0438\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437, \u0447\u0442\u043E\u0431\u044B \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438")}catch{}},M=C=>{try{let{selection:T}=C;if(!T?.empty)return!1;let{$from:A}=T,I=null;for(let J=A.depth;J>0;J-=1)if(A.node(J)?.type?.name==="outlineHeading"){I=J;break}if(I===null||!(A.pos===A.start(I)))return!1;let _=Rt(C.doc,A);if(typeof _!="number")return!1;if(C.doc.resolve(_).index()>0)return!0;let X=!1;for(let J=A.depth;J>0;J-=1)if(A.node(J)?.type?.name==="outlineSection"){if(!X){X=!0;continue}return!0}return!1}catch{return!1}},$=(C,T)=>{try{if(!T)return!1;let{selection:A}=C;if(!A?.empty)return!1;let{$from:I}=A,H=Rt(C.doc,I);if(typeof H!="number")return!1;let _=C.doc.nodeAt(H);if(!_||String(_.attrs?.id||"")!==String(T))return!1;let F=_.child(0),K=_.child(1),J=H+1+F.nodeSize+K.nodeSize-1;if(I.pos!==J)return!1;let j=C.doc.resolve(H),te=j.index(),ce=j.parent;return ce?te<ce.childCount-1:!1}catch{return!1}};return[new b({key:E,state:{init(){return{editingSectionId:null}},apply(C,T){let A=C.getMeta(E);return A?A.type==="enter"?{editingSectionId:A.sectionId||null}:A.type==="exit"?{editingSectionId:null}:T:T}},filterTransaction(C,T){let I=(E.getState(T)||{}).editingSectionId||null;return C.getMeta(le)||C.getMeta("history$")!=null||C.getMeta("closeHistory$")!=null||!C.docChanged?!0:R(T,C,I)},props:{decorations(C){try{let A=(E.getState(C)||{}).editingSectionId||null;if(!A)return null;let I=ht(C.doc,A);if(typeof I!="number")return null;let H=C.doc.nodeAt(I);return H?v.create(C.doc,[x.node(I,I+H.nodeSize,{"data-editing":"true"})]):null}catch{return null}},handleKeyDown(C,T){let A=C.state,H=(E.getState(A)||{}).editingSectionId||null;We("keydown",{key:T?.key||null,repeat:!!T?.repeat,editingSectionId:H||null,selection:{empty:!!A?.selection?.empty,parent:A?.selection?.$from?.parent?.type?.name||null,parentOffset:A?.selection?.$from?.parentOffset??null}});let _=O(A);if(!H&&(T.key==="Delete"||T.key==="Del"||T.key==="Backspace")&&(T.ctrlKey||T.metaKey)&&!T.shiftKey&&!T.altKey){try{deleteActiveSection()}catch{}return T.preventDefault(),T.stopPropagation(),!0}if(H&&T.key==="Backspace"&&!T.ctrlKey&&!T.metaKey&&!T.altKey){let K=Kg(A,C.dispatch,H,h);if(We("editorProps.backspace.bodyToHeading",{promoted:K,editingSectionId:H}),K)return T.preventDefault(),T.stopPropagation(),!0;let X=qg(A,C.dispatch);if(We("editorProps.backspace.tableMerge",{merged:X,editingSectionId:H||null}),X)return T.preventDefault(),T.stopPropagation(),!0}try{let K=(T.key==="Enter"||T.code==="Enter"||T.code==="NumpadEnter")&&(T.ctrlKey||T.metaKey)&&!T.shiftKey&&!T.altKey;if(!a.isPublicView&&!H&&K){let X=A.selection,J=X?.$from||null;if(J){let j=Rt(A.doc,J),te=typeof j=="number"?A.doc.nodeAt(j):null;if(typeof j=="number"&&te&&te.type?.name==="outlineSection"){let ce=!!(X&&X.empty),Se=J.parent?.type?.name==="outlineHeading",Be=ce&&Se&&J.parentOffset===0?j:j+te.nodeSize;T.preventDefault(),T.stopPropagation();let Re=A.schema,Ge=tn(),wt=Re.nodes.outlineSection.create({id:Ge,collapsed:!1},[Re.nodes.outlineHeading.create({},[]),Re.nodes.outlineBody.create({},[Re.nodes.paragraph.create({},[])]),Re.nodes.outlineChildren.create({},[])]),qe=A.tr.insert(Be,wt);try{let St=qe.doc.nodeAt(Be)?.child?.(0)||wt.child(0),rn=Be+1+St.nodeSize;qe=qe.setSelection(h.near(qe.doc.resolve(rn+2),1))}catch{qe=qe.setSelection(h.create(qe.doc,Be+2))}qe=qe.setMeta(le,!0),qe=qe.setMeta(E,{type:"enter",sectionId:Ge}),C.dispatch(qe.scrollIntoView());try{C.focus()}catch{}return!0}}}}catch{}if((!k||k.sectionId!==_||k.key!==T.key)&&(k=null),a.isPublicView&&!H&&(T.key==="Enter"&&!T.shiftKey&&!T.ctrlKey&&!T.metaKey&&!T.altKey||T.key==="F2"&&!T.shiftKey&&!T.ctrlKey&&!T.metaKey&&!T.altKey))return T.preventDefault(),T.stopPropagation(),!0;if(!H&&(T.key==="Enter"&&!T.shiftKey&&!T.ctrlKey&&!T.metaKey&&!T.altKey||T.key==="F2"&&!T.shiftKey&&!T.ctrlKey&&!T.metaKey&&!T.altKey)){let K=O(A);return K?(T.preventDefault(),T.stopPropagation(),C.dispatch(A.tr.setMeta(E,{type:"enter",sectionId:K})),!0):!1}if(H&&T.key==="Escape")return T.preventDefault(),T.stopPropagation(),C.dispatch(A.tr.setMeta(E,{type:"exit"})),!0;if(!H){let K=T.key&&T.key.length===1&&!T.metaKey&&!T.ctrlKey&&!T.altKey;if(T.key==="Backspace"||T.key==="Delete"){if(T.key==="Backspace"&&M(A))try{let{selection:J}=A,{$from:j}=J,te=findSectionPos(A.doc,j);if(typeof te!="number")return!1;let ce=A.doc.nodeAt(te);if(!ce)return!1;let Se=String(ce.attrs?.id||""),me=null;try{let Re=A.doc.resolve(te),Ge=Re.index(),wt=Re.parent;if(wt&&Ge>0){let qe=wt.child(Ge-1),At=te-qe.nodeSize,St=A.doc.nodeAt(At);me=String(St?.attrs?.id||"")||null}else for(let qe=j.depth-1;qe>0;qe-=1){let At=j.node(qe);if(At?.type?.name==="outlineSection"){let St=String(At.attrs?.id||"");if(St&&St!==Se){me=St;break}}}}catch{me=null}let Be=!1;if(ye(ce))Be=Z(A,C.dispatch,te);else try{A.doc.resolve(te).index()<=0?Be=De(A,C.dispatch,te):Be=we(A,C.dispatch,te)}catch{Be=we(A,C.dispatch,te)}return Be&&me&&window.setTimeout(()=>{try{if((E.getState(C.state)||{}).editingSectionId)return;let Ge=ht(C.state.doc,me),wt=typeof Ge=="number"?C.state.doc.nodeAt(Ge):null;if(!wt)return;let qe=C.state.tr;wt?.attrs?.collapsed&&(qe=qe.setNodeMarkup(Ge,void 0,{...wt.attrs,collapsed:!1}),qe=qe.setMeta(le,!0)),qe=qe.setMeta(E,{type:"enter",sectionId:me});try{let At=qe.doc.nodeAt(Ge);if(At&&At.type?.name==="outlineSection"){let St=At.child(0),rn=At.child(1),re=Ge+1+St.nodeSize+rn.nodeSize-1;qe=qe.setSelection(h.near(qe.doc.resolve(re),-1))}}catch{}C.dispatch(qe.scrollIntoView());try{C.focus()}catch{}}catch{}},0),T.preventDefault(),T.stopPropagation(),!0}catch{}return T.preventDefault(),T.stopPropagation(),!0}if(K)return T.preventDefault(),T.stopPropagation(),U(),!0}let F=T.key==="Backspace"&&M(A)||T.key==="Delete"&&$(A,H);if(H&&(T.key==="Backspace"||T.key==="Delete")&&F){if(T.repeat)return T.preventDefault(),T.stopPropagation(),!0;let K=Date.now();return k&&k.sectionId===H&&k.key===T.key&&K-k.ts<1200?(k=null,!1):(k={sectionId:H,key:T.key,ts:K},T.preventDefault(),T.stopPropagation(),D(),!0)}return!1},handleTextInput(){let C=arguments[0],T=C?.state?E.getState(C.state):null;return T&&T.editingSectionId?!1:(U(),!0)},handleDOMEvents:{paste(C,T){let A=C.state;return(E.getState(A)||{}).editingSectionId?!1:(T.preventDefault(),T.stopPropagation(),U(),!0)},drop(C,T){let A=C.state;return(E.getState(A)||{}).editingSectionId?!1:(T.preventDefault(),T.stopPropagation(),U(),!0)}}}})]}}),Ye=E=>{let k=(E||"").trim();if(!k)return[];let O=y(k,[w.configure({heading:!1,link:!1}),B.configure({openOnClick:!1,protocols:bs}),ne,z.configure({table:{resizable:!0}})]),R=Array.isArray(O?.content)?O.content:[],U=[];for(let D=0;D<R.length;D+=1){let M=R[D];if(M?.type!=="paragraph"){U.push(M);continue}let C=kf(M).trim();if(!kn(C)){U.push(M);continue}let A=[],I=D,H=D;for(;H<R.length;H+=1){let K=R[H];if(K?.type!=="paragraph")break;let X=kf(K).trim();if(!X)break;A.push(X)}let _=jr(A);if(!_){U.push(M);continue}let F=jg(_);if(!F){U.push(M);continue}U.push(F),D=H-1,D<I&&(D=I)}return U};di=Ye;let Ue=u.create({name:"outlineMarkdown",addCommands(){return{insertMarkdown:E=>({editor:k})=>{if(!ke)return!1;if(!(ke.getState(k.state)||{}).editingSectionId)return wo(),!1;if(!k?.storage?.markdown?.parser)return L("Markdown \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F"),!1;let R=k.storage.markdown.parser.parse(String(E||""),{inline:!0}),U=Ye(R);return U.length?k.chain().focus().insertContent(U).run():!1}}}}),ft=u.create({name:"outlineFormattedPaste",addProseMirrorPlugins(){let E=this.editor,k=$=>{let C=String($||"").trim();if(!C)return"";let T=null;try{T=new DOMParser().parseFromString(C,"text/html")}catch{return C}let A=T?.body;if(!A)return C;try{for(let I of Array.from(A.querySelectorAll("h1,h2,h3,h4,h5,h6"))){let H=T.createElement("p"),_=T.createElement("strong");try{for(;I.firstChild;)_.appendChild(I.firstChild)}catch{_.textContent=String(I.textContent||"")}H.appendChild(_),I.replaceWith(H)}}catch{}return String(A.innerHTML||"").trim()},O=$=>{let C=String($||"").trim();if(!C||!C.includes("<")||!C.includes(">")||!/<\s*\/?\s*[a-z][^>]*>/i.test(C))return!1;try{let A=new DOMParser().parseFromString(C,"text/html")?.body;if(!A)return!1;let I=new Set(["p","br","strong","b","em","i","u","s","a","ul","ol","li","blockquote","pre","code","table","thead","tbody","tr","td","th","img","span","div","h1","h2","h3","h4","h5","h6"]);return!!Array.from(A.querySelectorAll("*")).find(_=>I.has(String(_.tagName||"").toLowerCase()))}catch{return!1}},R=$=>{let C=String($||"").replace(/\r\n/g,`
`).trim();return C?[/```[\s\S]*```/m,/^\s{0,3}([-*+]|\d+\.)\s+\S/m,/^\s{0,3}>\s+\S/m,/\[[^\]]+\]\([^)]+\)/,/!\[[^\]]*\]\([^)]+\)/,/\*\*[^*\n]+\*\*/,/__[^_\n]+__/,/`[^`\n]+`/].some(A=>A.test(C)):!1},U=$=>{try{let C=String($||"").replace(/\r\n/g,`
`).split(`
`).map(T=>String(T||"").trim()).filter(Boolean);return C.length<2?!1:!!jr(C)}catch{return!1}},D=($,C)=>{if(!C||!Array.isArray(C)||!C.length)return!1;let T=$?.state?.selection?.from,A=$?.state?.selection?.to;if(!Number.isFinite(T)||!Number.isFinite(A))return!1;try{return E.chain().focus().command(({tr:I})=>(I.setMeta(le,!0),!0)).insertContentAt({from:T,to:A},C).run()}catch{return!1}},M=($,C)=>{try{if(!(ke?.getState?.($.state)||null)?.editingSectionId)return!1;let A=C?.clipboardData?.items||null,I=C?.clipboardData?.files||null;if(I&&I.length||A&&Array.from(A).some(F=>F?.kind==="file"))return!1;let H=String(C?.clipboardData?.getData?.("text/html")||"").trim(),_=String(C?.clipboardData?.getData?.("text/plain")||"").trim();if(H)try{if(!!/<h[1-6][\s>]/i.test(H))return!1}catch{}if(H){let F=k(H),K=Ye(F);return K.length?(C.preventDefault(),C.stopPropagation(),D($,K)):!1}if(_&&O(_)){let F=k(_),K=Ye(F);return K.length?(C.preventDefault(),C.stopPropagation(),D($,K)):!1}if(_&&R(_)){if(U(_))return!1;try{let te=xc(_);if(te?.startsWithHeading||(te?.sections?.length||0)>=2)return!1}catch{}let F=E?.storage?.markdown?.parser||null;if(!F?.parse)return!1;let K=!_.includes(`
`)&&!/^\s{0,3}([-*+]|\d+\.)\s+\S/m.test(_)&&!/```[\s\S]*```/m.test(_)&&!/^\s{0,3}>\s+\S/m.test(_),X=String(F.parse(_,{inline:K})).trim();if(!X)return!1;let J=k(X),j=Ye(J);return j.length?(C.preventDefault(),C.stopPropagation(),D($,j)):!1}return!1}catch{return!1}};return[new b({props:{handlePaste($,C){return M($,C)},handleDOMEvents:{paste($,C){return M($,C)}}}})]}}),dt=!1,Ze=null,Xe=Vr()?performance.now():0,ut=a.article?.docJson||null;if(ut&&typeof ut=="object"&&ut.type==="doc"&&Array.isArray(ut.content)&&(Ze=ut),Ze||(Ze=py({blocks:a.article?.blocks||[],parseHtmlToNodes:Ye}),dt=!!(a.article&&!a.article?.docJson&&!a.article?.encrypted)),Xe&&bo("build initial content",{ms:Math.round(performance.now()-Xe)}),ie){try{ie.destroy()}catch{}ie=null}let Ve=W?W.configure({html:!0,tightLists:!0,transformPastedText:!1,transformCopiedText:!1}):null,gn=u.create({name:"outlineTableCellStyling",addOptions(){return{types:["tableCell","tableHeader"],textAlignValues:["left","center","right","justify"],verticalAlignValues:["top","middle","bottom"]}},addGlobalAttributes(){let E=(O,R)=>{try{let U=O?.style?.[R];return U?String(U).trim():""}catch{return""}},k=O=>{let R=[],U=O?.nodeTextAlign?String(O.nodeTextAlign):"",D=O?.nodeVerticalAlign?String(O.nodeVerticalAlign):"",M=O?.nodeTextColor?String(O.nodeTextColor):"",$=O?.nodeBackground?String(O.nodeBackground):"";return U&&this.options.textAlignValues.includes(U)&&R.push(`text-align: ${U}`),D&&this.options.verticalAlignValues.includes(D)&&R.push(`vertical-align: ${D}`),M&&R.push(`color: ${M}`),$&&R.push(`background-color: ${$}`),R.length?{style:R.join("; ")}:{}};return[{types:this.options.types,attributes:{nodeTextAlign:{default:null,parseHTML:O=>{let R=E(O,"textAlign");return R&&this.options.textAlignValues.includes(R)?R:null},renderHTML:O=>k(O)},nodeVerticalAlign:{default:null,parseHTML:O=>{let R=E(O,"verticalAlign");return R&&this.options.verticalAlignValues.includes(R)?R:null},renderHTML:O=>k(O)},nodeTextColor:{default:null,parseHTML:O=>{let R=E(O,"color");return R?String(R).replace(/['"]+/g,""):null},renderHTML:O=>k(O)},nodeBackground:{default:null,parseHTML:O=>{let R=E(O,"backgroundColor");return R?String(R).replace(/['"]+/g,""):null},renderHTML:O=>k(O)}}}]},addCommands(){let E=(O,R)=>({state:U,dispatch:D})=>{try{let M=Rc(U);if(!M.length)return!1;let $=U.tr,C=!1;for(let{node:T,pos:A}of M){if(!T||typeof A!="number")continue;let I={...T.attrs||{}};R==null||R===""?delete I[O]:I[O]=R,$=$.setNodeMarkup(A,void 0,I),C=!0}return C?($=$.setMeta(le,!0),D($),!0):!1}catch{return!1}},k=()=>({state:O,dispatch:R})=>{try{let U=Rc(O);if(!U.length)return!1;let D=O.schema.nodes?.paragraph||null;if(!D)return!1;let M=O.tr,$=[...U].sort((T,A)=>Number(A.pos)-Number(T.pos)),C=!1;for(let{node:T,pos:A}of $){if(!T||typeof A!="number")continue;let I=A+1,H=A+T.nodeSize-1;if(!(H>=I))continue;let _=D.createAndFill();_&&(M=M.replaceWith(I,H,_),C=!0)}return C?(M=M.setMeta(le,!0),R(M.scrollIntoView()),!0):!1}catch{return!1}};return{setNodeTextAlign:O=>E("nodeTextAlign",O),setNodeVAlign:O=>E("nodeVerticalAlign",O),setNodeTextColor:O=>E("nodeTextColor",O),setNodeBackground:O=>E("nodeBackground",O),unsetNodeAlignment:()=>({state:O,dispatch:R})=>{try{let U=Rc(O);if(!U.length)return!1;let D=O.tr,M=!1;for(let{node:$,pos:C}of U){if(!$||typeof C!="number")continue;let T=$.attrs?.nodeTextAlign||null,A=$.attrs?.nodeVerticalAlign||null;if(!T&&!A)continue;let I={...$.attrs||{}};delete I.nodeTextAlign,delete I.nodeVerticalAlign,D=D.setNodeMarkup(C,void 0,I),M=!0}return M?(D=D.setMeta(le,!0),R(D),!0):!1}catch{return!1}},clearNodeContents:()=>k()}}}),Yt=u.create({name:"outlineTablePercentWidths",addProseMirrorPlugins(){return[new b({view(E){let k=null,O=D=>{let M=String(D||"").trim();if(!M)return 0;let $=M.match(/(-?\\d+(?:\\.\\d+)?)px/i);return $&&Number($[1])||0},R=()=>{k=null;try{let D=E?.dom;if(!D)return;let M=D.querySelectorAll(".tableWrapper > table");for(let $ of M){let C=$.querySelector("colgroup");if(!C)continue;let T=Array.from(C.querySelectorAll("col"));if(!T.length||Ur)continue;try{$.style.width="100%",$.style.maxWidth="100%",$.style.tableLayout="fixed"}catch{}let A=!1;for(let I of T){let H=I?.dataset?.ttPct||"",_=Number.parseFloat(String(H||""));if(Number.isFinite(_)&&_>0)A=!0,I.style.width=`${_.toFixed(4)}%`,I.style.minWidth="";else{let F=jf(I.style.width);F!=null&&F>0&&(A=!0,I.dataset.ttPct=F.toFixed(4),I.style.width=`${F.toFixed(4)}%`,I.style.minWidth="")}}if(!A)try{let I=$.querySelector("tbody tr");if(!I)continue;let H=Array.from(I.children||[]).filter(J=>J&&J.nodeType===1);if(H.length<T.length)continue;let _=[];for(let J=0;J<T.length;J+=1){let j=H[J].getBoundingClientRect();_.push(Number.isFinite(j.width)?j.width:0)}let F=_.reduce((J,j)=>J+(Number.isFinite(j)?j:0),0);if(!(F>0))continue;let K=_.map(J=>jn(J/F*100)),X=K.reduce((J,j)=>J+j,0);Math.abs(X-100)>.01&&(K[K.length-1]=jn(K[K.length-1]+(100-X)));for(let J=0;J<T.length;J+=1)Ps(T[J],K[J])}catch{}}}catch{}},U=()=>{k==null&&(k=window.requestAnimationFrame(R))};return U(),{update(){U()},destroy(){k!=null&&(window.cancelAnimationFrame(k),k=null)}}}})]}}),Qt=u.create({name:"outlineTableSmartMouseSelection",addProseMirrorPlugins(){let E=Et?.CellSelection||null;return E?[new b({view(k){let O=U=>{try{for(let D=U.depth;D>=0;D-=1){let M=U.node(D)?.type?.name;if(M==="tableCell"||M==="tableHeader")return U.before(D)}}catch{}return null},R=()=>{try{if(!(ke?.getState?.(k.state)||null)?.editingSectionId)return;let D=k.state.selection;if(!D||D.empty)return;let M=O(D.$anchor),$=O(D.$head);if(M==null||$==null||M===$)return;let C=typeof E.create=="function"?E.create(k.state.doc,M,$):null;if(!C)return;let T=k.state.tr.setSelection(C);T=T.setMeta(le,!0),k.dispatch(T)}catch{}};return k.dom.addEventListener("mouseup",R,!0),{destroy(){k.dom.removeEventListener("mouseup",R,!0)}}}})]:[]}}),en=u.create({name:"outlineTableResizeCapture",addProseMirrorPlugins(){return[new b({view(E){let k=R=>{try{if(!R?.target?.closest?.(".column-resize-handle")||!(ke?.getState?.(E.state)||null)?.editingSectionId)return;Ur=!0}catch{}},O=()=>{if(Ur){Ur=!1;try{let R=E.domAtPos(E.state.selection.from),D=((R?.node&&R.node.nodeType===1?R.node:R?.node?.parentElement)||null)?.closest?.("table")||null;D&&Cs(D)}catch{}}};return E.dom.addEventListener("pointerdown",k,!0),document.addEventListener("pointerup",O,!0),document.addEventListener("pointercancel",O,!0),{destroy(){E.dom.removeEventListener("pointerdown",k,!0),document.removeEventListener("pointerup",O,!0),document.removeEventListener("pointercancel",O,!0)}}}})]}}),Hn=u.create({name:"outlineTableNodeUi",addProseMirrorPlugins(){let E=this.editor,k=[{label:"Default text",value:null},{label:"Gray text",value:"var(--tt-color-text-gray)"},{label:"Brown text",value:"var(--tt-color-text-brown)"},{label:"Orange text",value:"var(--tt-color-text-orange)"},{label:"Yellow text",value:"var(--tt-color-text-yellow)"},{label:"Green text",value:"var(--tt-color-text-green)"},{label:"Blue text",value:"var(--tt-color-text-blue)"},{label:"Purple text",value:"var(--tt-color-text-purple)"},{label:"Pink text",value:"var(--tt-color-text-pink)"},{label:"Red text",value:"var(--tt-color-text-red)"}],O=[{label:"Default background",value:null},{label:"Gray background",value:"var(--tt-color-highlight-gray)"},{label:"Brown background",value:"var(--tt-color-highlight-brown)"},{label:"Orange background",value:"var(--tt-color-highlight-orange)"},{label:"Yellow background",value:"var(--tt-color-highlight-yellow)"},{label:"Green background",value:"var(--tt-color-highlight-green)"},{label:"Blue background",value:"var(--tt-color-highlight-blue)"},{label:"Purple background",value:"var(--tt-color-highlight-purple)"},{label:"Pink background",value:"var(--tt-color-highlight-pink)"},{label:"Red background",value:"var(--tt-color-highlight-red)"}],R=[{label:"Align left",value:"left"},{label:"Align center",value:"center"},{label:"Align right",value:"right"},{label:"Justify",value:"justify"}],U=[{label:"Align top",value:"top"},{label:"Align middle",value:"middle"},{label:"Align bottom",value:"bottom"}],D=T=>{try{if(!T)return null;let A={left:Number(T.left),top:Number(T.top),right:Number(T.right),bottom:Number(T.bottom),width:Number(T.width),height:Number(T.height)};return!Number.isFinite(A.left)||!Number.isFinite(A.top)?null:A}catch{return null}},M=(T,A,I,H,_=8)=>{try{let F=window.innerWidth||0,K=window.innerHeight||0,X=Math.max(_,Math.min(T,Math.max(_,F-I-_))),J=Math.max(_,Math.min(A,Math.max(_,K-H-_)));return{left:X,top:J}}catch{return{left:T,top:A}}};class ${constructor(){this.panels=[],this.onDocPointerDown=A=>{try{let I=A?.target||null,H=typeof A?.composedPath=="function"?A.composedPath():null,_=Array.isArray(H)&&H.length?H:I?[I]:[];if(!_.length)return;for(let F of _)for(let K of this.panels)if(K&&(F===K||K.contains(F)))return;this.closeAll()}catch{this.closeAll()}},this.onKeyDown=A=>{A?.key==="Escape"&&this.closeAll()}}isOpen(){return this.panels.length>0}closeAll(){try{for(let A of this.panels)A?.remove?.()}catch{}this.panels=[];try{document.removeEventListener("pointerdown",this.onDocPointerDown,!1),window.removeEventListener("keydown",this.onKeyDown,!1)}catch{}}openPanel({anchorRect:A,items:I,level:H=0}){let _=D(A);if(!_)return;for(;this.panels.length>H;){let te=this.panels.pop();try{te?.remove?.()}catch{}}let F=document.createElement("div");F.className="tt-table-menu",F.setAttribute("role","menu"),F.setAttribute("data-level",String(H)),F.addEventListener("pointerdown",te=>{te.stopPropagation()}),F.addEventListener("mousedown",te=>{te.stopPropagation()});for(let te of I){if(te.type==="separator"){let Se=document.createElement("div");Se.className="tt-table-menu-sep",F.appendChild(Se);continue}let ce=document.createElement("button");if(ce.type="button",ce.className="tt-table-menu-item",ce.textContent=te.label,ce.disabled=!!te.disabled,te.swatch){ce.classList.add("has-swatch");try{let Se=te.swatchValue==null?"transparent":String(te.swatchValue);ce.style.setProperty("--tt-swatch",Se)}catch{}}te.submenu&&ce.classList.add("has-submenu"),ce.addEventListener("click",Se=>{if(Se.preventDefault(),Se.stopPropagation(),!te.disabled){if(te.submenu){let me=ce.getBoundingClientRect();this.openPanel({anchorRect:me,items:te.submenu(),level:H+1});return}try{te.onClick?.()}finally{this.closeAll()}}}),F.appendChild(ce)}document.body.appendChild(F);let K=F.getBoundingClientRect(),X=_.right+8,J=_.top,j=M(X,J,K.width,K.height);F.style.left=`${j.left}px`,F.style.top=`${j.top}px`,this.panels.push(F);try{this.panels.length===1&&(document.addEventListener("pointerdown",this.onDocPointerDown,!1),window.addEventListener("keydown",this.onKeyDown,!1))}catch{}}}class C{constructor(A){this.view=A,this.menu=new $,this.wrapper=null,this.table=null,this.observedTable=null,this.resizeObserver=null,this.layoutRaf=null,this.resizeRaf=null,this.destroyed=!1,this.root=document.createElement("div"),this.root.className="tt-table-ui",this.root.style.display="none",this.cellOutline=document.createElement("div"),this.cellOutline.className="tt-table-active-cell-outline",this.cellOutline.style.display="none",this.root.appendChild(this.cellOutline),this.scheduleLayout=()=>{this.layoutRaf==null&&(this.layoutRaf=window.requestAnimationFrame(()=>{this.layoutRaf=null,!this.destroyed&&this.update(this.view)}))},this.scheduleResizeLoop=()=>{this.resizeRaf==null&&(this.resizeRaf=window.requestAnimationFrame(()=>{this.resizeRaf=null,!this.destroyed&&Ur&&this.update(this.view)}))},this.onWrapperScroll=()=>this.scheduleLayout(),this.onWindowResize=()=>this.scheduleLayout();try{window.addEventListener("resize",this.onWindowResize,{passive:!0})}catch{}this.rowHandles=[],this.colHandles=[],this.dragState=null,this.suppressClickUntil=0,this.colDropIndicator=document.createElement("div"),this.colDropIndicator.className="tt-table-drop-indicator tt-table-drop-indicator-col",this.colDropIndicator.style.display="none",this.root.appendChild(this.colDropIndicator),this.rowDropIndicator=document.createElement("div"),this.rowDropIndicator.className="tt-table-drop-indicator tt-table-drop-indicator-row",this.rowDropIndicator.style.display="none",this.root.appendChild(this.rowDropIndicator),this.cellHandle=document.createElement("button"),this.cellHandle.type="button",this.cellHandle.className="tt-table-handle tt-table-cell-handle",this.cellHandle.setAttribute("aria-label","Cell actions"),this.cellHandle.addEventListener("click",I=>{I.preventDefault(),I.stopPropagation();let H=this.cellHandle.getBoundingClientRect();this.openCellMenu(H)}),this.root.appendChild(this.cellHandle)}hideDropIndicators(){try{this.colDropIndicator&&(this.colDropIndicator.style.display="none")}catch{}try{this.rowDropIndicator&&(this.rowDropIndicator.style.display="none")}catch{}}cancelDrag(){let A=this.dragState;if(A){this.dragState=null,this.hideDropIndicators();try{window.removeEventListener("pointermove",A.onMove),window.removeEventListener("pointerup",A.onUp),window.removeEventListener("pointercancel",A.onUp)}catch{}try{document.body.classList.remove("tt-table-dragging")}catch{}}}destroy(){this.destroyed=!0,this.cancelDrag();try{this.cellOutline.style.display="none"}catch{}this.menu.closeAll();try{this.layoutRaf!=null&&window.cancelAnimationFrame(this.layoutRaf)}catch{}this.layoutRaf=null;try{this.resizeRaf!=null&&window.cancelAnimationFrame(this.resizeRaf)}catch{}this.resizeRaf=null;try{window.removeEventListener("resize",this.onWindowResize)}catch{}try{this.wrapper?.removeEventListener?.("scroll",this.onWrapperScroll)}catch{}try{this.resizeObserver?.disconnect?.()}catch{}this.resizeObserver=null,this.observedTable=null;try{this.root.remove()}catch{}this.wrapper=null,this.table=null}ensureAttached(A){if(A&&this.wrapper!==A){try{this.wrapper?.removeEventListener?.("scroll",this.onWrapperScroll)}catch{}try{this.root.remove()}catch{}this.wrapper=A;try{this.wrapper.addEventListener("scroll",this.onWrapperScroll,{passive:!0})}catch{}this.wrapper.appendChild(this.root)}}buildRowHandles(A){for(;this.rowHandles.length>A;){let I=this.rowHandles.pop();try{I?.remove?.()}catch{}}for(;this.rowHandles.length<A;){let I=document.createElement("button");I.type="button",I.className="tt-table-handle tt-table-row-handle",I.setAttribute("aria-label","Row actions"),I.dataset.idx=String(this.rowHandles.length),I.addEventListener("pointerdown",H=>this.onHandlePointerDown(H,I,"row")),I.addEventListener("click",H=>{if(Date.now()<this.suppressClickUntil){H.preventDefault(),H.stopPropagation();return}H.preventDefault(),H.stopPropagation();let _=Wt(this.view?.state)?.tablePos,F=I.getBoundingClientRect();E?.chain?.().focus?.().run?.();let K=Number(I.dataset.idx||0);Xg(E,K),this.openRowMenu(F,K,_)}),this.rowHandles.push(I),this.root.appendChild(I)}}buildColHandles(A){for(;this.colHandles.length>A;){let I=this.colHandles.pop();try{I?.remove?.()}catch{}}for(;this.colHandles.length<A;){let I=document.createElement("button");I.type="button",I.className="tt-table-handle tt-table-col-handle",I.setAttribute("aria-label","Column actions"),I.dataset.idx=String(this.colHandles.length),I.addEventListener("pointerdown",H=>this.onHandlePointerDown(H,I,"col")),I.addEventListener("click",H=>{if(Date.now()<this.suppressClickUntil){H.preventDefault(),H.stopPropagation();return}H.preventDefault(),H.stopPropagation();let _=Wt(this.view?.state)?.tablePos,F=I.getBoundingClientRect();E?.chain?.().focus?.().run?.();let K=Number(I.dataset.idx||0);Qg(E,K),this.openColumnMenu(F,K,_)}),this.colHandles.push(I),this.root.appendChild(I)}}onHandlePointerDown(A,I,H){try{if(!A||A.button!==0)return;A.preventDefault(),A.stopPropagation(),E?.chain?.().focus?.().run?.();let _=Number(I?.dataset?.idx||0);try{typeof I.setPointerCapture=="function"&&I.setPointerCapture(A.pointerId)}catch{}let F={kind:H,btn:I,pointerId:A.pointerId,fromIndex:_,startX:A.clientX,startY:A.clientY,moved:!1};this.dragState=F;let K=J=>this.onHandlePointerMove(J),X=J=>this.onHandlePointerUp(J);F.onMove=K,F.onUp=X,window.addEventListener("pointermove",K,{passive:!1}),window.addEventListener("pointerup",X,{passive:!1}),window.addEventListener("pointercancel",X,{passive:!1})}catch{}}onHandlePointerMove(A){let I=this.dragState;if(!I||!A||A.pointerId!==I.pointerId)return;try{A.preventDefault()}catch{}let H=A.clientX-I.startX,_=A.clientY-I.startY;if(!I.moved&&Math.hypot(H,_)>=4){I.moved=!0;try{document.body.classList.add("tt-table-dragging")}catch{}}if(I.moved){let F=this.getDropIndexFromPointer(I.kind,A.clientX,A.clientY);I.dropIndex=F,F==null?this.hideDropIndicators():this.updateDropIndicator(I.kind,F,A.clientX,A.clientY)}}getDropIndexFromPointer(A,I,H){try{let _=this.table;if(!_)return null;let F=Array.from(_.querySelectorAll("tbody tr"));if(!F.length)return null;if(A==="col"){let X=Array.from(F[0].children||[]).filter(j=>j&&j.nodeType===1);if(!X.length)return null;let J=X.map(j=>{let te=j.getBoundingClientRect();return te.left+te.width/2});if(!J.length)return null;if(I<J[0])return 0;for(let j=0;j<J.length-1;j+=1)if(I>=J[j]&&I<J[j+1])return j+1;return J.length-1}let K=F.map(X=>{let J=X.children&&X.children[0];if(!J)return null;let j=J.getBoundingClientRect();return j.top+j.height/2}).filter(X=>typeof X=="number");if(!K.length)return null;if(H<K[0])return 0;for(let X=0;X<K.length-1;X+=1)if(H>=K[X]&&H<K[X+1])return X+1;return K.length-1}catch{return null}}updateDropIndicator(A,I,H,_){try{let F=this.table,K=this.wrapper;if(!F||!K)return;let X=K.getBoundingClientRect(),J=F.getBoundingClientRect(),j=J.top-X.top,te=J.left-X.left,ce=J.width,Se=J.height,me=Array.from(F.querySelectorAll("tbody tr"));if(!me.length)return;if(A==="col"){let rn=Array.from(me[0].children||[]).filter(ae=>ae&&ae.nodeType===1);if(!rn.length)return;let V=Math.max(0,Math.min(rn.length-1,Number(I))),re=rn[V].getBoundingClientRect(),Q=rn[rn.length-1].getBoundingClientRect(),Y=Q.left+Q.width/2,oe=V===rn.length-1&&H>Y?Q.right-X.left:re.left-X.left;this.colDropIndicator.style.display="",this.rowDropIndicator.style.display="none",this.colDropIndicator.style.left=`${Math.round(oe)}px`,this.colDropIndicator.style.top=`${Math.round(j)}px`,this.colDropIndicator.style.height=`${Math.max(0,Math.round(Se))}px`;return}let Be=Math.max(0,Math.min(me.length-1,Number(I))),Re=me[Be]?.children?.[0];if(!Re)return;let Ge=Re.getBoundingClientRect(),qe=(me[me.length-1]?.children?.[0]||null)?.getBoundingClientRect?.()||null,At=qe?qe.top+qe.height/2:null,St=Be===me.length-1&&qe&&typeof At=="number"&&_>At?qe.bottom-X.top:Ge.top-X.top;this.rowDropIndicator.style.display="",this.colDropIndicator.style.display="none",this.rowDropIndicator.style.left=`${Math.round(te)}px`,this.rowDropIndicator.style.top=`${Math.round(St)}px`,this.rowDropIndicator.style.width=`${Math.max(0,Math.round(ce))}px`}catch{}}onHandlePointerUp(A){let I=this.dragState;if(!I||!A||A.pointerId!==I.pointerId)return;try{A.preventDefault(),A.stopPropagation()}catch{}this.dragState=null;try{window.removeEventListener("pointermove",I.onMove),window.removeEventListener("pointerup",I.onUp),window.removeEventListener("pointercancel",I.onUp)}catch{}try{document.body.classList.remove("tt-table-dragging")}catch{}if(this.hideDropIndicators(),!I.moved)return;this.suppressClickUntil=Date.now()+250;let H=I.dropIndex??this.getDropIndexFromPointer(I.kind,A.clientX,A.clientY);if(H!=null){try{E?.chain?.().focus?.().run?.()}catch{}I.kind==="col"?Gf(E,I.fromIndex,H):Qf(E,I.fromIndex,H),this.scheduleLayout()}}isEnabled(){try{return!!(ke?.getState?.(this.view.state)||null)?.editingSectionId&&!a.isPublicView}catch{return!1}}update(A){if(this.view=A,!Ur&&this.resizeRaf!=null){try{window.cancelAnimationFrame(this.resizeRaf)}catch{}this.resizeRaf=null}if(!this.isEnabled()){this.root.style.display="none",this.menu.closeAll();try{this.cellOutline.style.display="none"}catch{}return}let I=Wt(A.state),H=Yg(A),_=H?.closest?.("table")||sn(A),F=_?.closest?.(".tableWrapper")||null;if(!I||!_||!F||!H){this.root.style.display="none",this.menu.isOpen()||this.menu.closeAll();try{this.cellOutline.style.display="none"}catch{}return}this.ensureAttached(F),this.table=_;try{typeof ResizeObserver=="function"&&(this.resizeObserver||(this.resizeObserver=new ResizeObserver(()=>this.scheduleLayout())),this.observedTable!==_&&(this.resizeObserver.disconnect(),this.resizeObserver.observe(_),this.observedTable=_))}catch{}this.root.style.display="";let K=Array.from(_.querySelectorAll("tbody tr")),X=Number(I.map?.height||K.length||0),J=Number(I.map?.width||0);this.buildRowHandles(Math.max(0,X)),this.buildColHandles(Math.max(0,J));let j=F.getBoundingClientRect(),te=_.getBoundingClientRect(),ce=te.top-j.top,Se=te.left-j.left,me=14,Be=4,Re=me/2,Ge=Math.max(0,Math.min(Math.max(0,X-1),Number(I.rowIndex||0))),wt=Math.max(0,Math.min(Math.max(0,J-1),Number(I.colIndex||0))),qe=Math.max(Re,ce-(me/2+Be)),At=Math.max(Re,Se-(me/2+Be)),St=H.getBoundingClientRect(),rn=St.left-j.left+St.width/2,V=St.top-j.top+St.height/2,re=St.left-j.left,Q=St.top-j.top,Y="cell";try{let oe=A.state.selection,ae=oe?.$anchorCell?.pos,ge=oe?.$headCell?.pos;if(typeof ae=="number"&&typeof ge=="number"&&ae!==ge){let xe=ae-(I.tablePos+1),Ee=ge-(I.tablePos+1),Me=I.map?.rectBetween?.(xe,Ee)||null;if(Me){let Ae=Number(Me.right)-Number(Me.left),Oe=Number(Me.bottom)-Number(Me.top);Ae===1&&Oe>1?Y="col":Oe===1&&Ae>1?Y="row":Y="range"}else Y="range"}}catch{Y="cell"}try{Y==="cell"?(this.cellOutline.style.display="",this.cellOutline.style.left=`${Math.round(re)}px`,this.cellOutline.style.top=`${Math.round(Q)}px`,this.cellOutline.style.width=`${Math.max(0,Math.round(St.width))}px`,this.cellOutline.style.height=`${Math.max(0,Math.round(St.height))}px`):this.cellOutline.style.display="none"}catch{try{this.cellOutline.style.display="none"}catch{}}for(let oe=0;oe<this.colHandles.length;oe+=1){let ae=this.colHandles[oe];if(ae){if(ae.dataset.idx=String(oe),oe!==wt){ae.style.display="none";continue}ae.style.display="",ae.style.width=`${Math.max(18,Math.round(St.width))}px`,ae.style.height=`${me}px`,ae.style.left=`${Math.round(rn)}px`,ae.style.top=`${Math.round(qe)}px`}}for(let oe=0;oe<this.rowHandles.length;oe+=1){let ae=this.rowHandles[oe];if(ae){if(ae.dataset.idx=String(oe),oe!==Ge){ae.style.display="none";continue}ae.style.display="",ae.style.width=`${me}px`,ae.style.height=`${Math.max(18,Math.round(St.height))}px`,ae.style.left=`${Math.round(At)}px`,ae.style.top=`${Math.round(V)}px`}}try{if(Y!=="cell")this.cellHandle.style.display="none";else{let oe=St.right-j.left;this.cellHandle.style.display="",this.cellHandle.style.left=`${Math.round(oe)}px`,this.cellHandle.style.top=`${Math.round(V)}px`}}catch{this.cellHandle.style.display="none"}Ur&&this.scheduleResizeLoop()}openCellMenu(A){let I=()=>{try{E?.chain?.().focus?.().run?.()}catch{}},H=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>k.map(_=>({label:_.label,swatch:!0,swatchValue:_.value,onClick:()=>{I(),E.commands.setNodeTextColor(_.value)}}))},{label:"Background color",submenu:()=>O.map(_=>({label:_.label,swatch:!0,swatchValue:_.value,onClick:()=>{I(),E.commands.setNodeBackground(_.value)}}))}]},{label:"Alignment",submenu:()=>[...R.map(_=>({label:_.label,onClick:()=>{I(),E.commands.setNodeTextAlign(_.value)}})),{type:"separator"},...U.map(_=>({label:_.label,onClick:()=>{I(),E.commands.setNodeVAlign(_.value)}}))]},{type:"separator"},{label:"Clear contents",onClick:()=>{I(),E.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:A,items:H,level:0})}openRowMenu(A,I,H){let _=()=>{try{E?.chain?.().focus?.().run?.()}catch{}Number.isFinite(Number(H))&&Gg(E,H,I)},F=(j,te)=>{try{E?.chain?.().focus?.().run?.()}catch{}return E.commands.command(({state:ce,dispatch:Se})=>{let me=Number.isFinite(Number(H))?Number(H):Wt(ce)?.tablePos,Be=Number.isFinite(Number(I))?Number(I):Wt(ce)?.rowIndex;return!Number.isFinite(Number(me))||!Number.isFinite(Number(Be))?!1:ey({pmState:ce,dispatch:Se},{tablePos:me,rowIndex:Be,attr:j,value:te})})},K=j=>()=>(_(),j?.()),X=j=>{try{return typeof j!="function"?!1:(_(),E.commands.command(({state:te,dispatch:ce})=>j(te,typeof ce=="function"?me=>{try{me=me.setMeta(le,!0)}catch{}ce(me)}:void 0)))}catch{return!1}},J=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>k.map(j=>({label:j.label,swatch:!0,swatchValue:j.value,onClick:()=>F("nodeTextColor",j.value)}))},{label:"Background color",submenu:()=>O.map(j=>({label:j.label,swatch:!0,swatchValue:j.value,onClick:()=>F("nodeBackground",j.value)}))}]},{label:"Alignment",submenu:()=>[...R.map(j=>({label:j.label,onClick:()=>F("nodeTextAlign",j.value)})),{type:"separator"},...U.map(j=>({label:j.label,onClick:()=>F("nodeVerticalAlign",j.value)}))]},{type:"separator"},{label:"Insert row above",onClick:()=>X(Et?.addRowBefore)},{label:"Insert row below",onClick:()=>X(Et?.addRowAfter)},{label:"Sort ",submenu:()=>[{label:"Sort column A-Z",onClick:K(()=>Ef(E,{direction:"asc"}))},{label:"Sort column Z-A",onClick:K(()=>Ef(E,{direction:"desc"}))}]},{label:"Header row",onClick:()=>X(Et?.toggleHeaderRow)},{label:"Move ",submenu:()=>[{label:"Move row up",onClick:K(()=>If(E,-1))},{label:"Move row down",onClick:K(()=>If(E,1))},{label:"Move row left",disabled:!0,onClick:()=>{}},{label:"Move row right",disabled:!0,onClick:()=>{}}]},{label:"Duplicate row",onClick:K(()=>ry(E))},{label:"Delete row",onClick:()=>X(Et?.deleteRow)},{type:"separator"},{label:"Clear row contents",onClick:()=>{_(),E.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:A,items:J,level:0})}openColumnMenu(A,I,H){let _=()=>{try{E?.chain?.().focus?.().run?.()}catch{}Number.isFinite(Number(H))&&Zg(E,H,I)},F=(j,te)=>{try{E?.chain?.().focus?.().run?.()}catch{}return E.commands.command(({state:ce,dispatch:Se})=>{let me=Number.isFinite(Number(H))?Number(H):Wt(ce)?.tablePos,Be=Number.isFinite(Number(I))?Number(I):Wt(ce)?.colIndex;return!Number.isFinite(Number(me))||!Number.isFinite(Number(Be))?!1:ty({pmState:ce,dispatch:Se},{tablePos:me,colIndex:Be,attr:j,value:te})})},K=j=>()=>(_(),j?.()),X=j=>{try{return typeof j!="function"?!1:(_(),E.commands.command(({state:te,dispatch:ce})=>j(te,typeof ce=="function"?me=>{try{me=me.setMeta(le,!0)}catch{}ce(me)}:void 0)))}catch{return!1}},J=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>k.map(j=>({label:j.label,swatch:!0,swatchValue:j.value,onClick:()=>F("nodeTextColor",j.value)}))},{label:"Background color",submenu:()=>O.map(j=>({label:j.label,swatch:!0,swatchValue:j.value,onClick:()=>F("nodeBackground",j.value)}))}]},{label:"Alignment",submenu:()=>[...R.map(j=>({label:j.label,onClick:()=>F("nodeTextAlign",j.value)})),{type:"separator"},...U.map(j=>({label:j.label,onClick:()=>F("nodeVerticalAlign",j.value)}))]},{type:"separator"},{label:"Insert column left",onClick:()=>{_();let j=Math.max(0,Number(I||0));X(Et?.addColumnBefore)&&window.requestAnimationFrame(()=>{try{Ls(E,{insertIndex:j,newColPct:10})}catch{let ce=sn(E.view);Cs(ce)}})}},{label:"Insert column right",onClick:()=>{_();let j=Math.max(0,Number(I||0)+1);X(Et?.addColumnAfter)&&window.requestAnimationFrame(()=>{try{Ls(E,{insertIndex:j,newColPct:10})}catch{let ce=sn(E.view);Cs(ce)}})}},{label:"Sort ",submenu:()=>[{label:"Sort row A-Z",onClick:K(()=>vf(E,{direction:"asc"}))},{label:"Sort row Z-A",onClick:K(()=>vf(E,{direction:"desc"}))}]},{label:"Header column",onClick:()=>X(Et?.toggleHeaderColumn)},{label:"Move ",submenu:()=>[{label:"Move column up",disabled:!0,onClick:()=>{}},{label:"Move column down",disabled:!0,onClick:()=>{}},{label:"Move column left",onClick:K(()=>Af(E,-1))},{label:"Move column right",onClick:K(()=>Af(E,1))}]},{label:"Duplicate column",onClick:K(()=>oy(E))},{label:"Delete column",onClick:()=>{_();let j=sn(E.view),te=So(j),ce=Number.isFinite(Number(I))?Number(I):null,Se=te&&ce!=null?Yf(te,ce):null;X(Et?.deleteColumn)&&Array.isArray(Se)&&window.requestAnimationFrame(()=>{let Be=sn(E.view);xo(Be,Se)})}},{type:"separator"},{label:"Clear column contents",onClick:()=>{_(),E.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:A,items:J,level:0})}}return[new b({view(T){let A=new C(T);return A.update(T),{update(I){A.update(I)},destroy(){A.destroy()}}}})]}}),Ut=Vr()?performance.now():0;ie=new l({element:e,extensions:[nn,se,fe,be,G,de,Le,et,tt,pe,Lt,je,gt,_e,Tt,ft,P.configure({types:["outlineSection"],attributeName:"id",generateID:()=>tn()}),w.configure({document:!1,heading:!1,link:!1}),B.configure({openOnClick:!1,protocols:bs}),Ve,ne,$e,gn,z.configure({table:{resizable:!0}}),Hn,Qt,en,Yt,Ue].filter(Boolean),content:Ze,editorProps:{attributes:{class:"outline-prosemirror"},handleKeyDown(E,k){try{if(k?.altKey&&!k.ctrlKey&&!k.metaKey){let O=String(k.key||"");if((O==="ArrowUp"||O==="ArrowDown")&&k.repeat){let R=E?.state?.selection?.$from;if(R){let U=!1;for(let D=R.depth;D>0;D-=1){let M=R.node(D)?.type?.name;if(M&&String(M).startsWith("table")){U=!0;break}}if(!U){let D=null;for(let M=R.depth;M>0;M-=1)if(R.node(M)?.type?.name==="outlineSection"){D=R.before(M);break}if(typeof D=="number"){let M=E.state.doc.resolve(D),$=M.parent;if($){let C=M.index();if(O==="ArrowUp"&&C<=0||O==="ArrowDown"&&C>=$.childCount-1)return!0}}}}}}}catch{}We("editorProps.keydown",{key:k?.key||null,repeat:!!k?.repeat,selection:{empty:!!E.state?.selection?.empty,parent:E.state?.selection?.$from?.parent?.type?.name||null,parentOffset:E.state?.selection?.$from?.parentOffset??null,pos:E.state?.selection?.$from?.pos??null}});try{let O=He?.pmStateMod?.TextSelection;if(O){let U=(ke?.getState?.(E.state)||null)?.editingSectionId||null,D=(k.key==="Enter"||k.code==="Enter"||k.code==="NumpadEnter")&&(k.ctrlKey||k.metaKey)&&!k.shiftKey&&!k.altKey;if(!a.isPublicView&&!U&&D){let M=E.state.selection,$=M?.$from||null;if($){let C=Rt(E.state.doc,$),T=typeof C=="number"?E.state.doc.nodeAt(C):null;if(typeof C=="number"&&T?.type?.name==="outlineSection"){let A=!!(M&&M.empty),I=$.parent?.type?.name==="outlineHeading",_=A&&I&&$.parentOffset===0?C:C+T.nodeSize,F=E.state.schema,K=tn(),X=F.nodes.outlineSection.create({id:K,collapsed:!1},[F.nodes.outlineHeading.create({},[]),F.nodes.outlineBody.create({},[F.nodes.paragraph.create({},[])]),F.nodes.outlineChildren.create({},[])]),J=E.state.tr.insert(_,X);try{let te=J.doc.nodeAt(_)?.child?.(0)||X.child(0),ce=_+1+te.nodeSize;J=J.setSelection(O.near(J.doc.resolve(ce+2),1))}catch{J=J.setSelection(O.create(J.doc,_+2))}J=J.setMeta(le,!0),ke&&(J=J.setMeta(ke,{type:"enter",sectionId:K})),E.dispatch(J.scrollIntoView());try{E.focus()}catch{}return k.preventDefault(),k.stopPropagation(),!0}}}}}catch{}try{let O=k.altKey&&!k.ctrlKey&&!k.metaKey&&!k.shiftKey,R=String(k.key||"");if(O&&(R==="ArrowLeft"||R==="ArrowRight"||R==="ArrowUp"||R==="ArrowDown")&&(ke?.getState?.(E.state)||null)?.editingSectionId&&ie){let D=()=>{try{let M=E?.state?.selection?.$from||null;if(!M)return!1;for(let $=M.depth;$>0;$-=1){let C=M.node($)?.type?.name;if(C==="table"||C==="tableRow"||C==="tableCell"||C==="tableHeader")return!0}return!1}catch{return!1}};if(R==="ArrowLeft"||R==="ArrowRight"){let M=ie.chain().focus();M.command(({tr:C})=>(C.setMeta(le,!0),!0));let $=!1;if(ie.isActive("bulletList")||ie.isActive("orderedList")?R==="ArrowRight"?$=M.sinkListItem("listItem").run():($=M.liftListItem("listItem").run(),!$&&ie.isActive("bulletList")&&($=M.toggleBulletList().run()),!$&&ie.isActive("orderedList")&&($=M.toggleOrderedList().run())):R==="ArrowRight"&&($=M.toggleBulletList().run()),$)return k.preventDefault(),k.stopPropagation(),!0}else if((R==="ArrowUp"||R==="ArrowDown")&&(R==="ArrowUp"?Cf(ie,-1)||Tf(ie,-1):Cf(ie,1)||Tf(ie,1)))return k.preventDefault(),k.stopPropagation(),!0}}catch{}try{if((k.ctrlKey||k.metaKey)&&!k.altKey&&!k.shiftKey&&(k.code==="KeyA"||String(k.key||"").toLowerCase()==="a")){let R=He?.pmStateMod?.TextSelection;if(!R)return We("editorProps.modA",{handled:!1,reason:"no-TextSelection"}),!1;let U=E.state,D=U.selection,M=D?.$from||null;if(!M)return We("editorProps.modA",{handled:!1,reason:"no-$from"}),!1;let $=Rt(U.doc,M);if(typeof $!="number")return We("editorProps.modA",{handled:!1,reason:"no-sectionPos"}),!1;let C=U.doc.nodeAt($);if(!C||C.type?.name!=="outlineSection")return We("editorProps.modA",{handled:!1,reason:"not-outlineSection"}),!1;let T=C.child(0),A=C.child(1);if(!T||!A)return We("editorProps.modA",{handled:!1,reason:"missing-heading/body"}),!1;let I=$+1,H=I+1,_=I+T.nodeSize-1,F=$+1+T.nodeSize,K=F+1,X=F+A.nodeSize-1,J=X;try{let me=null;U.doc.nodesBetween(K,Math.min(U.doc.content.size,X),(Be,Re)=>{Be?.isTextblock&&(me=Re+Be.nodeSize-1)}),typeof me=="number"&&(J=me)}catch{}J<K&&(J=_);let j=H,te=(()=>{try{for(let me=M.depth;me>0;me-=1)if(M.node(me)?.type?.name==="outlineHeading")return!0}catch{}return!1})(),ce=!!D&&typeof D.from=="number"&&typeof D.to=="number"&&Math.min(D.from,D.to)===j&&Math.max(D.from,D.to)===J;if(te&&ce)return We("editorProps.modA",{handled:!1,reason:"pass-through-doc-select"}),!1;k.preventDefault(),k.stopPropagation();let Se=R.create(U.doc,j,J);return E.dispatch(U.tr.setSelection(Se)),We("editorProps.modA",{handled:!0,blockFrom:j,blockTo:J,isInHeading:te,alreadySelectedBlock:ce}),!0}}catch{}try{if(!ke)return!1;let R=(ke.getState(E.state)||{}).editingSectionId||null;if(!R){let U=(k.ctrlKey||k.metaKey)&&!k.altKey&&!k.shiftKey&&(k.key==="Delete"||k.key==="Del"||k.key==="Backspace"),D=k.key==="Backspace"||k.key==="Delete",M=k.key&&k.key.length===1&&!k.metaKey&&!k.ctrlKey&&!k.altKey,$=!k.metaKey&&!k.ctrlKey&&!k.altKey&&!k.shiftKey&&(k.key===" "||k.key==="Spacebar");if(U){let C=Rt(E.state.doc,E.state.selection.$from),T=!1;try{typeof C=="number"&&(T=Z(E.state,E.dispatch,C))}catch{T=!1}return We("editorProps.modDelete",{ok:T,sectionPos:C}),k.preventDefault(),k.stopPropagation(),!0}if($){let C=document.activeElement;if(!(!!(C&&C.closest&&C.closest(".outline-editor"))||!!(k?.target&&k.target.closest&&k.target.closest(".outline-editor"))))return!1;if(k.repeat)return k.preventDefault(),k.stopPropagation(),!0;let A=k?.target||null,I=String(A?.tagName||"").toLowerCase();if(I==="button"||I==="input"||I==="textarea"||I==="select"||A?.closest?.("button, a[href], input, textarea, select")||!!!A?.closest?.(".outline-prosemirror")&&A?.closest?.('[contenteditable="true"]'))return!1;let _=Rt(E.state.doc,E.state.selection.$from);if(typeof _!="number")return k.preventDefault(),k.stopPropagation(),!0;let F=E.state.doc.nodeAt(_);if(!F)return k.preventDefault(),k.stopPropagation(),!0;let K=!F.attrs?.collapsed,X=E.state.tr.setNodeMarkup(_,void 0,{...F.attrs,collapsed:K});X=X.setMeta(le,!0);try{let J=F.child(0),te=_+1+J.nodeSize-1,{TextSelection:ce}=He?.pmStateMod||{};ce&&(X=X.setSelection(ce.near(X.doc.resolve(te),-1)))}catch{}return k.preventDefault(),k.stopPropagation(),E.dispatch(X.scrollIntoView()),!0}if(D){if(k.key==="Backspace")try{let C=E.state,T=C.selection,A=T?.$from||null,I=null;try{for(let F=A?.depth||0;F>0;F-=1)if(A.node(F)?.type?.name==="outlineHeading"){I=F;break}}catch{I=null}let H=I!==null&&A?A.start(I):null,_=!!(T&&T.empty)&&!!A&&I!==null&&typeof H=="number"&&A.pos===H;if(We("editorProps.backspace.check",{empty:!!T?.empty,headingDepth:I,headingStart:H,pos:A?.pos??null,parent:A?.parent?.type?.name||null,parentOffset:A?.parentOffset??null,atHeadingStart:_}),_){let F=Rt(C.doc,A),K=typeof F=="number"?C.doc.nodeAt(F):null;if(We("editorProps.backspace.sectionPos",{sectionPos:F,hasNode:!!K}),typeof F=="number"&&K){let X=String(K.attrs?.id||""),J=null;try{let te=C.doc.resolve(F),ce=te.index(),Se=te.parent;if(Se&&ce>0){let me=Se.child(ce-1),Be=F-me.nodeSize,Re=C.doc.nodeAt(Be);J=String(Re?.attrs?.id||"")||null}else for(let me=A.depth-1;me>0;me-=1){let Be=A.node(me);if(Be?.type?.name==="outlineSection"){let Re=String(Be.attrs?.id||"");if(Re&&Re!==X){J=Re;break}}}}catch{J=null}We("editorProps.backspace.mergeCandidate",{sectionPos:F,currentSectionId:X,targetSectionId:J});let j=!1;if(ye(K))j=Z(C,E.dispatch,F);else try{C.doc.resolve(F).index()<=0?j=De(C,E.dispatch,F):j=we(C,E.dispatch,F)}catch{j=we(C,E.dispatch,F)}return We("editorProps.backspace.mergeDone",{ok:j,targetSectionId:J}),j&&J&&ke&&window.setTimeout(()=>{try{if((ke.getState(E.state)||{}).editingSectionId)return;let ce=ht(E.state.doc,J),Se=typeof ce=="number"?E.state.doc.nodeAt(ce):null;if(!Se)return;let me=E.state.tr;Se?.attrs?.collapsed&&(me=me.setNodeMarkup(ce,void 0,{...Se.attrs,collapsed:!1}),me=me.setMeta(le,!0)),me=me.setMeta(ke,{type:"enter",sectionId:J});try{let Be=me.doc.nodeAt(ce);if(Be&&Be.type?.name==="outlineSection"){let Re=Be.child(0),Ge=Be.child(1),qe=ce+1+Re.nodeSize+Ge.nodeSize-1;me=me.setSelection(h.near(me.doc.resolve(qe),-1))}}catch{}E.dispatch(me.scrollIntoView());try{E.focus()}catch{}We("editorProps.backspace.enterEdit.done",{targetSectionId:J})}catch{}},0),k.preventDefault(),k.stopPropagation(),!0}}}catch{}return k.preventDefault(),k.stopPropagation(),!0}if(M)return k.preventDefault(),k.stopPropagation(),wo(),!0}if(a.isPublicView&&!R&&(k.key==="Enter"&&!k.shiftKey&&!k.ctrlKey&&!k.metaKey&&!k.altKey||k.key==="F2"&&!k.shiftKey&&!k.ctrlKey&&!k.metaKey&&!k.altKey))return k.preventDefault(),k.stopPropagation(),!0;if(!R&&(k.key==="Enter"&&!k.shiftKey&&!k.ctrlKey&&!k.metaKey&&!k.altKey||k.key==="F2"&&!k.shiftKey&&!k.ctrlKey&&!k.metaKey&&!k.altKey)){let U=Rt(E.state.doc,E.state.selection.$from);if(typeof U!="number")return!1;let D=E.state.doc.nodeAt(U),M=String(D?.attrs?.id||"");if(!M)return!1;if(k.preventDefault(),k.stopPropagation(),D?.attrs?.collapsed){let $=E.state.tr.setNodeMarkup(U,void 0,{...D.attrs,collapsed:!1});return $.setMeta(le,!0),E.dispatch($.scrollIntoView()),!0}return E.dispatch(E.state.tr.setMeta(ke,{type:"enter",sectionId:M})),!0}if(R&&k.key==="Escape"){k.preventDefault(),k.stopPropagation();let U=R;E.dispatch(E.state.tr.setMeta(ke,{type:"exit"}));try{let D=ie;if(D&&!D.isDestroyed){let M=Jr(E.state.doc,U);Nf(D,E.state.doc,U),M&&pn({delayMs:350})}}catch{}return!0}}catch{}return!1},handleDOMEvents:{click(E,k){try{let O=k.target?.closest?.("a[href]");if(!O||!ke||(ke.getState(E.state)||{}).editingSectionId||null)return!1;let D=String(O.getAttribute("href")||"").trim();if(!D)return!1;if(a.isPublicView){let A=String(O.getAttribute("rel")||"").split(/\s+/).filter(Boolean);if(O.getAttribute("data-unpublished")==="1"||A.includes("unpublished")||D==="#")return alert("\u042D\u0442\u0430 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435 \u043E\u043F\u0443\u0431\u043B\u0438\u043A\u043E\u0432\u0430\u043D\u0430"),k.preventDefault(),k.stopPropagation(),!0}if(D.startsWith("app:/")||D.startsWith("disk:/")){k.preventDefault(),k.stopPropagation();let T=it(D);if(T)return window.open(T,"_blank","noopener,noreferrer"),!0}let M=T=>{let A=String(T||"").trim();if(!A||A.startsWith("/")||A.startsWith("#")||/\s/.test(A)||A.includes("://")||/^[a-z][a-z0-9+.-]*:/i.test(A))return!1;let I=A.split(/[/?#]/,1)[0];return!(!I||!I.includes(".")||I.startsWith(".")||I.endsWith(".")||I.includes(".."))},$=T=>{let A=String(T||"").trim();return A&&(A.startsWith("//")?`https:${A}`:M(A)?`https://${A}`:A)};if(k.preventDefault(),k.stopPropagation(),D.startsWith("/"))return a.isPublicView?(window.location.href=D,!0):(bt(D),!0);let C=$(D);return/^https?:\/\//i.test(C)||/^mailto:/i.test(C)||/^tel:/i.test(C),window.open(C,"_blank","noopener,noreferrer"),!0}catch{return!1}},beforeinput(E,k){try{if(!ke)return!1;let R=(ke.getState(E.state)||{}).editingSectionId||null;if(R)return!1;let U=String(k?.inputType||"");if(U.startsWith("history"))return!1;if(We("beforeinput",{inputType:U,key:k?.data??null,editingSectionId:R||null,selection:{empty:!!E.state?.selection?.empty,parent:E.state?.selection?.$from?.parent?.type?.name||null,parentOffset:E.state?.selection?.$from?.parentOffset??null}}),U==="deleteContentBackward"){try{let D=E.state,M=D.selection,$=M?.$from||null,C=null;try{for(let I=$?.depth||0;I>0;I-=1)if($.node(I)?.type?.name==="outlineHeading"){C=I;break}}catch{C=null}let T=C!==null&&$?$.start(C):null,A=!!(M&&M.empty)&&!!$&&C!==null&&typeof T=="number"&&$.pos===T;if(We("beforeinput.deleteContentBackward.check",{empty:!!M?.empty,headingDepth:C,headingStart:T,pos:$?.pos??null,parent:$?.parent?.type?.name||null,parentOffset:$?.parentOffset??null,atHeadingStart:A}),A){let I=Rt(D.doc,$),H=typeof I=="number"?D.doc.nodeAt(I):null;if(typeof I=="number"&&H){let _=String(H.attrs?.id||"");We("beforeinput.deleteContentBackward.candidate",{sectionPos:I,currentSectionId:_});let F=null;try{let X=D.doc.resolve(I),J=X.index(),j=X.parent;if(j&&J>0){let te=j.child(J-1),ce=I-te.nodeSize,Se=D.doc.nodeAt(ce);F=String(Se?.attrs?.id||"")||null}else for(let te=$.depth-1;te>0;te-=1){let ce=$.node(te);if(ce?.type?.name==="outlineSection"){let Se=String(ce.attrs?.id||"");if(Se&&Se!==_){F=Se;break}}}}catch{F=null}let K=!1;if(ye(H))We("beforeinput.merge",{kind:"deleteEmpty",sectionPos:I}),K=Z(D,E.dispatch,I);else try{D.doc.resolve(I).index()<=0?(We("beforeinput.merge",{kind:"intoParent",sectionPos:I,targetSectionId:F}),K=De(D,E.dispatch,I)):(We("beforeinput.merge",{kind:"intoPrev",sectionPos:I,targetSectionId:F}),K=we(D,E.dispatch,I))}catch{We("beforeinput.merge",{kind:"intoPrev.catch",sectionPos:I,targetSectionId:F}),K=we(D,E.dispatch,I)}return We("beforeinput.merge.done",{ok:K,targetSectionId:F}),K&&F&&window.setTimeout(()=>{try{if((ke.getState(E.state)||{}).editingSectionId)return;let J=ht(E.state.doc,F),j=typeof J=="number"?E.state.doc.nodeAt(J):null;if(!j)return;let te=E.state.tr;j?.attrs?.collapsed&&(te=te.setNodeMarkup(J,void 0,{...j.attrs,collapsed:!1}),te=te.setMeta(le,!0)),te=te.setMeta(ke,{type:"enter",sectionId:F});try{let ce=E.state.doc.nodeAt(J);if(ce&&ce.type?.name==="outlineSection"){let Se=ce.child(0),me=J+1+Se.nodeSize,Be=Math.min(te.doc.content.size,me+2);te=te.setSelection(h.create(te.doc,Be))}}catch{}E.dispatch(te.scrollIntoView());try{E.focus()}catch{}We("beforeinput.enterEdit.done",{targetSectionId:F})}catch{}},0),k.preventDefault(),k.stopPropagation(),!0}}}catch{}return We("beforeinput.deleteContentBackward.block",{inputType:U}),k.preventDefault(),k.stopPropagation(),!0}return U.startsWith("delete")?(We("beforeinput.delete.block",{inputType:U}),k.preventDefault(),k.stopPropagation(),!0):(k.preventDefault(),k.stopPropagation(),wo(),!0)}catch{return!1}},dblclick(E,k){try{if(a.isPublicView||!ke||(ke.getState(E.state)||{}).editingSectionId||null)return!1;let U=k?.target&&k.target.closest&&k.target.closest('[data-outline-heading="true"]')||k?.target&&k.target.closest&&k.target.closest(".outline-heading"),D=k?.target&&k.target.closest&&k.target.closest('[data-outline-body="true"]')||k?.target&&k.target.closest&&k.target.closest(".outline-body");if(!U&&!D)return!1;let M={left:k.clientX,top:k.clientY},$=E.posAtCoords(M),C=$&&typeof $.pos=="number"?$.pos:null;if(typeof C!="number")return!1;let T=E.state.doc.resolve(Math.max(0,Math.min(E.state.doc.content.size,C))),A=Rt(E.state.doc,T);if(typeof A!="number")return!1;let I=E.state.doc.nodeAt(A),H=String(I?.attrs?.id||"");if(!H)return!1;window.setTimeout(()=>{try{if((ke.getState(E.state)||{}).editingSectionId)return;let F=ht(E.state.doc,H),K=typeof F=="number"?E.state.doc.nodeAt(F):null,X=!!K?.attrs?.collapsed,J=E.state.tr;if(X&&typeof F=="number"&&K&&(J=J.setNodeMarkup(F,void 0,{...K.attrs,collapsed:!1}),J=J.setMeta(le,!0)),X){E.dispatch(J.scrollIntoView());try{E.focus()}catch{}return}J=J.setMeta(ke,{type:"enter",sectionId:H});try{let{TextSelection:j}=He?.pmStateMod||{},te=typeof F=="number"?J.doc.nodeAt(F):null;if(te&&te.type?.name==="outlineSection"){let ce=te.child(0),Se=F+1+ce.nodeSize,me=Math.min(J.doc.content.size,Se+2);j&&(J=J.setSelection(j.near(J.doc.resolve(me),1)))}}catch{}E.dispatch(J.scrollIntoView());try{E.focus()}catch{}}catch{}},0)}catch{}return!1}}},onCreate:({editor:E})=>{if(dt&&a.articleId&&a.article&&!a.article.encrypted)try{let k=E.getJSON();a.article.docJson=k,dd(a.articleId,k).catch(()=>{})}catch{}try{by(E.state.doc)}catch{}Br.clear(),mn=!1,Df=null,fn=null;try{Ts=Sf(E.state.doc),Jn=!1;try{Bn.clear()}catch{Bn.clear()}jt&&(clearTimeout(jt),jt=null)}catch{}ur("")},onUpdate:()=>{mn=!0;try{let E=ke?.getState?.(ie?.state)||null,k=String(E?.editingSectionId||"").trim();if(k){let O=ie?.state?.doc||null;O&&Jr(O,k)&&Og(ie)}}catch{}try{let E=ie?.state?.doc||null;if(E){let k=Sf(E);k&&k!==Ts&&(Ts=k,_g({articleId:Dt||a.articleId,editor:ie}))}}catch{}try{Bf(ie)}catch{}pn({delayMs:1500})},onSelectionUpdate:({editor:E})=>{let{state:k}=E,{selection:O}=k;if(!O)return;let R=Rt(k.doc,O.$from);if(typeof R!="number")return;let U=k.doc.nodeAt(R),D=String(U?.attrs?.id||"");if(!D)return;try{let C=(ke?.getState?.(k)||null)?.editingSectionId||null;C&&C!==D&&E.view.dispatch(k.tr.setMeta(ke,{type:"exit"}))}catch{}if(fn&&fn!==D){let $=Jr(k.doc,fn);try{er("leave_section",{from:fn,to:D,changed:$})}catch{}try{Br.has(fn)&&Nf(E,k.doc,fn)}catch{}$&&pn({delayMs:350})}let M=fn;fn=D;try{Bf(E)}catch{}try{!(ke?.getState?.(k)||null)?.editingSectionId&&M&&M!==D&&hy(E,{lines:4})}catch{}}}),Ut&&bo("new Editor()",{ms:Math.round(performance.now()-Ut)});try{(Dt||a.articleId)&&(Lg(Dt||a.articleId),navigator.onLine&&Of(Dt||a.articleId))}catch{}e.focus?.({preventScroll:!0}),Ms=E=>{try{if(!ie)return;let k=ie.state.tr.setMeta(ee,{activeKey:E||null});ie.view.dispatch(k)}catch{}};try{Kf()}catch{}try{let E=Vr()?performance.now():0;Wg(ie),E&&bo("convertMarkdownTablesInOutlineDoc()",{ms:Math.round(performance.now()-E)})}catch{}t&&bo("mountOutlineEditor() total",{ms:Math.round(performance.now()-t)})})();try{await oi}finally{oi=null}}function Pf(e=""){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}async function xy(e={}){if(a.isPublicView||!a.articleId||!a.article||!ie)return;let t=Dt||a.articleId;if(!t)return;let n=!!e.silent,r=e&&typeof e.mode=="string"?e.mode:"network",o=Array.from(new Set([...Br||[],fn].filter(Boolean))),i=(s,c)=>{let l=s?String(s):"",d=c?String(c):"";return l?d?l>=d?l:d:l||null:d||null};try{if(n||Bt("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C outline\u2026"),a.article.encrypted){n||(st(),L("Outline-\u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u0435 docJson \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0434\u043B\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0445 \u0441\u0442\u0430\u0442\u0435\u0439"));return}let s=ie.getJSON(),c=Bg(s);if(a.articleId&&t!==a.articleId){await yn(t,c,a.article?.updatedAt||null).catch(()=>{}),n||st(),ur("\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0447\u0435\u0440\u043D\u043E\u0432\u0438\u043A \u0441\u043E\u0445\u0440\u0430\u043D\u0451\u043D \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E");return}let l=Date.now();await yn(t,c,a.article?.updatedAt||null).catch(()=>{});try{fn&&Jr(ie.state.doc,fn)}catch{}if(!0){let u=Bn.size?Array.from(Bn):[];try{u.length&&(Bn.clear(),await $t("delete_sections",{articleId:t,payload:{sectionIds:u,clientQueuedAt:l},coalesceKey:`delete:${t}`}))}catch{}n||st(),a.article&&(a.article.docJson=c),mn=!1,Df=new Date,ur("\u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E");try{Kf()}catch{}try{Sy(ie,ie.state.doc,o)}catch{}return}}catch(s){n?ur("\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F"):(st(),L(s?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C outline"));try{let c=ie.getJSON();c&&typeof c=="object"&&await yn(t,c,a.article?.updatedAt||null).catch(()=>{})}catch{}pn({delayMs:5e3})}}function ky(){return fn||null}function Ay(){try{if(!ie||ie.isDestroyed)return null;let e=ie.state,t=Rt(e.doc,e.selection.$from);if(typeof t!="number")return null;let n=e.doc.nodeAt(t);if(!n||n.type?.name!=="outlineSection")return null;let r=String(n.attrs?.id||"").trim();return r?{sectionId:r,collapsed:!!n.attrs?.collapsed}:null}catch{return null}}function Iy(e,t){try{let n=String(t||"");if(!e||!n)return null;let r=(i,s,c)=>{if(!i||i.type?.name!=="outlineSection")return null;let l=String(i.attrs?.id||""),d=[...c,s];if(l===n)return d;let u=i.child(0),m=i.child(1),g=i.child(2);if(!g||g.type?.name!=="outlineChildren")return null;let y=s+1+u.nodeSize+m.nodeSize+1;for(let f=0;f<g.childCount;f+=1){let h=g.child(f),b=y;y+=h.nodeSize;let S=r(h,b,d);if(S)return S}return null},o=0;for(let i=0;i<e.childCount;i+=1){let s=e.child(i),c=o;o+=s.nodeSize;let l=r(s,c,[]);if(l)return l}return null}catch{return null}}function rp(e,t={}){try{if(!ie||ie.isDestroyed)return!1;let n=String(e||"");if(!n)return!1;let{state:r,view:o}=ie,i=He?.pmStateMod?.TextSelection,s=Iy(r.doc,n);if(!Array.isArray(s)||!s.length)return!1;let c=r.tr;for(let l of s){let d=c.doc.nodeAt(l);!d||d.type?.name!=="outlineSection"||d.attrs?.collapsed&&(c=c.setNodeMarkup(l,void 0,{...d.attrs,collapsed:!1}))}c=c.setMeta(le,!0);try{let l=ht(c.doc,n),d=typeof l=="number"?c.doc.nodeAt(l):null;if(typeof l=="number"&&d?.type?.name==="outlineSection"){let u=d.child(0),m=l+1+u.nodeSize,g=Math.min(c.doc.content.size,m+2);i&&(c=c.setSelection(i.create(c.doc,g)))}}catch{}o.dispatch(c.scrollIntoView());try{let l=typeof CSS<"u"&&CSS.escape?CSS.escape(n):n.replace(/"/g,'\\"');window.requestAnimationFrame(()=>{try{let d=o.dom?.querySelector?.(`[data-outline-section][data-section-id="${l}"]`)||o.dom?.querySelector?.(`[data-section-id="${l}"]`);d&&typeof d.scrollIntoView=="function"&&d.scrollIntoView({block:"center",inline:"nearest"})}catch{}})}catch{}if(t&&t.focus)try{o.focus()}catch{}return!0}catch{return!1}}function vy(e,t){if(!ie)return!1;let n=String(e||"");if(!n)return!1;let r=ht(ie.state.doc,n);if(typeof r!="number")return!1;let o=ie.state.doc.nodeAt(r);if(!o)return!1;let i=ie.state.doc.type.schema,s=Cn(String(t||"")),c=Jc(s.titleHtml||"")||Jc(s.bodyHtml||"").slice(0,80)||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",l=di?di(s.bodyHtml||""):[],d=[];for(let f of l||[])try{d.push(i.nodeFromJSON(f))}catch{}d.length||d.push(i.nodes.paragraph.create({},[]));let u=i.nodes.outlineHeading.create({},c?[i.text(c)]:[]),m=i.nodes.outlineBody.create({},d),g=o.child(2),w=i.nodes.outlineSection.create(o.attrs,[u,m,g]),y=ie.state.tr.replaceWith(r,r+o.nodeSize,w);try{let f=He?.pmStateMod?.TextSelection;f&&(y=y.setSelection(f.create(y.doc,r+2)))}catch{}return ie.view.dispatch(y),ie.view.focus(),mn=!0,pn({delayMs:200}),!0}function Ey(e,t){if(!ie)return!1;let n=String(e||"");if(!n)return!1;let r=ht(ie.state.doc,n);if(typeof r!="number")return!1;let o=ie.state.doc.nodeAt(r);if(!o)return!1;let i=t&&typeof t=="object"?t:{},s=ie.state.doc.type.schema,c=null,l=null;try{i.heading&&typeof i.heading=="object"&&(c=s.nodeFromJSON(i.heading))}catch{c=null}try{i.body&&typeof i.body=="object"&&(l=s.nodeFromJSON(i.body))}catch{l=null}(!c||c.type?.name!=="outlineHeading")&&(c=s.nodes.outlineHeading.create({},[])),(!l||l.type?.name!=="outlineBody")&&(l=s.nodes.outlineBody.create({},[s.nodes.paragraph.create({},[])])),l.childCount||(l=s.nodes.outlineBody.create({},[s.nodes.paragraph.create({},[])]));let d=o.child(2),u=s.nodes.outlineSection.create(o.attrs,[c,l,d]),m=ie.state.tr.replaceWith(r,r+o.nodeSize,u);try{let g=He?.pmStateMod?.TextSelection;g&&(m=m.setSelection(g.create(m.doc,r+2)))}catch{}return ie.view.dispatch(m),ie.view.focus(),mn=!0,pn({delayMs:200}),!0}function Ty(e,t){if(!ie)return!1;let n=String(e||"").trim();if(!n||typeof ht(ie.state.doc,n)=="number")return!1;let o=t&&typeof t=="object"?t:{},i=ie.state.doc.type.schema,s=null,c=null;try{o.heading&&typeof o.heading=="object"&&(s=i.nodeFromJSON(o.heading))}catch{s=null}try{o.body&&typeof o.body=="object"&&(c=i.nodeFromJSON(o.body))}catch{c=null}(!s||s.type?.name!=="outlineHeading")&&(s=i.nodes.outlineHeading.create({},[])),(!c||c.type?.name!=="outlineBody")&&(c=i.nodes.outlineBody.create({},[i.nodes.paragraph.create({},[])])),c.childCount||(c=i.nodes.outlineBody.create({},[i.nodes.paragraph.create({},[])]));let l=i.nodes.outlineChildren.create({},[]),d=i.nodes.outlineSection.create({id:n,collapsed:!1},[s,c,l]),u=ie.state.doc.content.size,m=ie.state.tr.insert(u,d);try{let g=He?.pmStateMod?.TextSelection;if(g){let w=Math.min(m.doc.content.size,u+2);m=m.setSelection(g.near(m.doc.resolve(Math.max(0,w)),1))}}catch{}return m=m.setMeta(le,!0),ie.view.dispatch(m.scrollIntoView()),ie.view.focus(),mn=!0,pn({delayMs:200}),!0}function Cy({enterEditMode:e=!0}={}){if(!ie)return null;let t=ie.state.doc.type.schema,n=ie.state.doc.content.size,r=tn(),o=t.nodes.outlineSection.create({id:r,collapsed:!1},[t.nodes.outlineHeading.create({},[]),t.nodes.outlineBody.create({},[t.nodes.paragraph.create({},[])]),t.nodes.outlineChildren.create({},[])]),i=ie.state.tr.insert(n,o);try{let s=He?.pmStateMod?.TextSelection;if(s){let c=ht(i.doc,r),l=typeof c=="number"?Os(i.doc,c):null;typeof l=="number"?i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,l+2)),1)):i=i.setSelection(s.create(i.doc,n+2))}}catch{}return i=i.setMeta(le,!0),e&&ke&&(i=i.setMeta(ke,{type:"enter",sectionId:r})),ie.view.dispatch(i.scrollIntoView()),ie.view.focus(),mn=!0,pn({delayMs:200}),r}function Os(e,t){try{let n=e.nodeAt(t);if(!n||n.type?.name!=="outlineSection")return null;let r=n.child(0);return t+1+r.nodeSize}catch{return null}}function By(e,{focusBody:t=!0}={}){if(!ie||!ke)return!1;let n=String(e||"").trim();if(!n)return!1;let r=ht(ie.state.doc,n);if(typeof r!="number"||ie.state.doc.nodeAt(r)?.attrs?.collapsed)return!1;let i=ie.state.tr;if(t)try{let s=He?.pmStateMod?.TextSelection,c=Os(i.doc,r);s&&typeof c=="number"&&(i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,c+2)),1)))}catch{}return i=i.setMeta(le,!0),i=i.setMeta(ke,{type:"enter",sectionId:n}),ie.view.dispatch(i.scrollIntoView()),ie.view.focus(),!0}function Ly({enterEditMode:e=!0}={}){if(!ie)return null;let t=ie.state.doc.type.schema,n=0,r=tn(),o=t.nodes.outlineSection.create({id:r,collapsed:!1},[t.nodes.outlineHeading.create({},[]),t.nodes.outlineBody.create({},[t.nodes.paragraph.create({},[])]),t.nodes.outlineChildren.create({},[])]),i=ie.state.tr.insert(n,o);try{let s=He?.pmStateMod?.TextSelection;if(s){let c=ht(i.doc,r),l=typeof c=="number"?Os(i.doc,c):null;typeof l=="number"?i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,l+2)),1)):i=i.setSelection(s.create(i.doc,n+2))}}catch{}return i=i.setMeta(le,!0),e&&ke&&(i=i.setMeta(ke,{type:"enter",sectionId:r})),ie.view.dispatch(i.scrollIntoView()),ie.view.focus(),mn=!0,pn({delayMs:200}),r}function My(e,t,{enterEditMode:n=!1}={}){if(!ie)return!1;let r=String(e||"").trim();if(!r||typeof ht(ie.state.doc,r)=="number")return!1;let i=ie.state.doc.type.schema,s=i.nodes.paragraph,c=i.nodes.hardBreak||i.nodes.hard_break||null,l=String(t||"").replace(/\r\n/g,`
`).trimEnd(),d=()=>{if(!s)return[];if(!l.trim())return[s.create({},[])];let h=l.split(/\n{2,}/),b=[];for(let S of h){let x=String(S||"").split(`
`),v=[];for(let B=0;B<x.length;B+=1){let N=x[B];B>0&&c&&v.push(c.create()),N&&v.push(i.text(N))}b.push(s.create({},v))}return b.length?b:[s.create({},[])]},u=i.nodes.outlineHeading.create({},[]),m=i.nodes.outlineBody.create({},d()),g=i.nodes.outlineChildren.create({},[]),w=i.nodes.outlineSection.create({id:r,collapsed:!1},[u,m,g]),y=0,f=ie.state.tr.insert(y,w);try{let h=He?.pmStateMod?.TextSelection;if(h){let b=ht(f.doc,r),S=typeof b=="number"?Os(f.doc,b):null;typeof S=="number"?f=f.setSelection(h.near(f.doc.resolve(Math.min(f.doc.content.size,S+2)),1)):f=f.setSelection(h.create(f.doc,y+2))}}catch{}return f=f.setMeta(le,!0),n&&ke&&(f=f.setMeta(ke,{type:"enter",sectionId:r})),ie.view.dispatch(f.scrollIntoView()),ie.view.focus(),mn=!0,pn({delayMs:200}),!0}async function Ny(){if(a.isPublicView||a.isRagView){L("Outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0432 \u044D\u0442\u043E\u043C \u0440\u0435\u0436\u0438\u043C\u0435");return}if(!a.articleId||!a.article){L("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}if(Dt=a.articleId,!p.outlineEditor||!p.blocksContainer){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440");return}a.isOutlineEditing=!0,p.articleToolbar&&p.articleToolbar.classList.add("hidden"),p.outlineToolbar&&p.outlineToolbar.classList.remove("hidden"),p.outlineTagsBar&&p.outlineTagsBar.classList.remove("hidden"),p.outlineEditor.classList.remove("hidden"),p.blocksContainer.classList.add("hidden"),Jf({loading:!0});try{ct("outline.open",{articleId:Dt,updatedAt:a.article?.updatedAt||null,docHash:Kt(a.article?.docJson||null)})}catch{}try{if(!a.scrollTargetBlockId&&Dt){let e=my(Dt);e?.sectionId&&(a.currentBlockId=e.sectionId)}}catch{}try{await np();try{sy(ie)}catch{}try{let t=a.scrollTargetBlockId||null;t&&(rp(t,{focus:!1}),a.scrollTargetBlockId=null,a.currentBlockId=t)}catch{}try{let t=a.currentBlockId||null;t&&uy(ie,t)}catch{}let e=p.outlineEditor.querySelector(".outline-editor__loading");if(e&&e.classList.add("hidden"),ur("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u0442\u0441\u044F \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438"),gf||(gf=!0,window.addEventListener("online",()=>{if(a.isOutlineEditing){try{Of(Dt||a.articleId)}catch{}ci({force:!0})}}),window.addEventListener("blur",()=>{a.isOutlineEditing&&ci({force:!0})}),document.addEventListener("visibilitychange",()=>{a.isOutlineEditing&&document.visibilityState!=="visible"&&ci({force:!0})})),!ai){let t=r=>{if(!a.isOutlineEditing)return;let o=r?.dataTransfer;if(!(o&&(o.files&&o.files.length||o.items&&o.items.length)))return;let s=r?.target;p.outlineEditor&&s&&p.outlineEditor.contains(s)||r.preventDefault()},n=r=>{if(!a.isOutlineEditing)return;let o=r?.dataTransfer;if(!(o&&o.files&&o.files.length))return;let s=r?.target;p.outlineEditor&&s&&p.outlineEditor.contains(s)||(r.preventDefault(),r.stopPropagation())};window.addEventListener("dragover",t,{passive:!1}),window.addEventListener("drop",n,{passive:!1}),ai=()=>{window.removeEventListener("dragover",t),window.removeEventListener("drop",n),ai=null}}}catch(e){L(e?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440"),op()}}function op(){a.isOutlineEditing=!1,ay(),ke=null,Dt=null,Lr=null,Ms=null,Xr={counts:new Map,labelByKey:new Map,sectionIdsByKey:new Map,sectionPosById:new Map};try{p.outlineTagsBar&&(p.outlineTagsBar.innerHTML="",p.outlineTagsBar.classList.add("hidden"))}catch{}si(!1),ai&&ai(),p.outlineToolbar&&p.outlineToolbar.classList.add("hidden"),p.articleToolbar&&p.articleToolbar.classList.remove("hidden"),tr&&(clearTimeout(tr),tr=null),jt&&(clearTimeout(jt),jt=null),qr&&(clearTimeout(qr),qr=null),Hc=null,Jn=!1,Ts="";try{Bn.clear()}catch{}if(vs=!1,Br.clear(),Yr.clear(),fn=null,mn=!1,ie){try{ie.destroy()}catch{}ie=null}He=null,p.outlineEditor&&p.outlineEditor.classList.add("hidden"),p.blocksContainer&&p.blocksContainer.classList.remove("hidden")}async function Py(e={}){let t=e&&typeof e.mode=="string"?e.mode:"network",n=e&&typeof e.timeoutMs=="number"?Math.max(0,Math.floor(e.timeoutMs)):0;if(!ie)return;tr&&(clearTimeout(tr),tr=null);try{let o=Dt||a.articleId;if(o&&!a.article?.encrypted){let i=ie.getJSON();if(i&&typeof i=="object")try{await yn(o,i,a.article?.updatedAt||null)}catch{}try{try{let s=ke?.getState?.(ie?.state)||null,c=String(s?.editingSectionId||"").trim();c&&await Yc({articleId:o,doc:ie.state.doc,sectionId:c,reason:"pagehide"})}catch{}if(Jn){let s=ui(ie.state.doc);s.length&&($t("structure_snapshot",{articleId:o,payload:{nodes:s},coalesceKey:`structure:${o}`}),Jn=!1)}}catch{}try{if(Bn.size){let s=Array.from(Bn);Bn.clear();let c=Date.now();await $t("delete_sections",{articleId:o,payload:{sectionIds:s,clientQueuedAt:c},coalesceKey:`delete:${o}:${c}`})}}catch{}}}catch{}if(t==="queue")return;let r=ci({force:!0,silent:!0});if(n>0){await Promise.race([r,new Promise(o=>setTimeout(o,n))]);return}await r}async function Dy({docJson:e}={}){if(p.outlineEditor){if(!e||typeof e!="object"){L("\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F: \u043D\u0435\u0442 \u0434\u043E\u043A\u0443\u043C\u0435\u043D\u0442\u0430");return}a.isPublicView=!0,a.isRagView=!1,a.isOutlineEditing=!1,a.articleId=null,a.article={docJson:e,encrypted:!1};try{p.outlineEditor.classList.add("outline-editor")}catch{}p.outlineEditor.classList.remove("hidden"),p.outlineEditor.querySelector("#outlineEditorContent")||Jf({loading:!0});try{await np();let t=p.outlineEditor.querySelector(".outline-editor__loading");t&&t.classList.add("hidden"),ur("\u0422\u043E\u043B\u044C\u043A\u043E \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440")}catch(t){L(t?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E")}}}var hf,He,ie,oi,tr,vs,qr,Hc,Nc,Df,fn,li,Yr,Br,mn,gf,di,$c,Fc,Et,Ur,Pc,yf,ii,Es,ke,ai,Dt,Lr,Ms,Xr,dr,Mr,Tg,As,zc,Uc,Cg,wf,Bs,Jn,Ts,jt,Bn,_c,le,xf,Rg,Hg,$g,Is,_y,Oy,We,pr=Fe(()=>{mt();Mt();Nt();ln();Vn();Ft();$o();Kn();Lo();to();Zu();En();ef();nf();Bo();hf=!1,He=null,ie=null,oi=null,tr=null,vs=!1,qr=null,Hc=null,Nc=0,Df=null,fn=null,li=new Map,Yr=new Map,Br=new Set,mn=!1,gf=!1,di=null,$c=null,Fc=null,Et={TableMap:null,CellSelection:null,moveTableColumn:null,moveTableRow:null,addRowBefore:null,addRowAfter:null,deleteRow:null,addColumnBefore:null,addColumnAfter:null,deleteColumn:null,toggleHeaderRow:null,toggleHeaderColumn:null},Ur=!1,Pc=new Map,yf=30*1e3,ii=new Map,Es=null,ke=null,ai=null,Dt=null,Lr=null,Ms=null,Xr={counts:new Map,labelByKey:new Map,sectionIdsByKey:new Map,sectionPosById:new Map},dr=!1,Mr=new Set,Tg=650,As={articleId:null,sectionId:null,collapsed:null},zc="ttree_outline_section_clipboard_v1",Uc="pending-attachment:",Cg=2e3;wf="ttree_outline_section_seq_v1",Bs=262144;Jn=!1,Ts="",jt=null,Bn=new Set,_c=null;le="outlineAllowMutation",xf=0,Rg="ttree_outline_debug_md_table";Hg="ttree_profile_v1";$g="ttree_outline_debug_proofread_v1";Is=null;_y="ttree_debug_outline_keys_v1",Oy=()=>{try{return window?.localStorage?.getItem?.(_y)==="1"}catch{return!1}},We=(e,t={})=>{try{if(!Oy())return;console.log("[outline][keys]",e,t)}catch{}}});function $y(){try{return window?.localStorage?.getItem?.(Ry)==="1"}catch{return!1}}function sp(){try{return window?.localStorage?.getItem?.(Hy)==="1"}catch{return!1}}function ko(...e){try{if(!$y())return;console.log("[article-load]",...e)}catch{}}function Fy(e){try{let t=e?.content;if(!Array.isArray(t))return null;for(let n of t)if(n?.type==="outlineSection"){let r=String(n?.attrs?.id||"");if(r)return r}return null}catch{return null}}async function Jt(e,t={}){let{desiredBlockId:n,resetUndoStacks:r,editBlockId:o}=t,i=a.articleId!==e;if(ko("load.start",{id:e,switchingArticle:i,mode:a.mode,isOutlineEditing:a.isOutlineEditing}),i)try{let g=a.articleId,w=await Promise.resolve().then(()=>(pr(),fr));try{let y=w?.getOutlineActiveSectionSnapshot?.()||null;if(g&&y?.sectionId){let f=window?.localStorage?.getItem?.(ip)||"{}",h=JSON.parse(f||"{}"),b=h&&typeof h=="object"?h:{};b[String(g)]={sectionId:y.sectionId,collapsed:!!y.collapsed,savedAt:new Date().toISOString()},window?.localStorage?.setItem?.(ip,JSON.stringify(b))}}catch{}w?.flushOutlineAutosave&&await w.flushOutlineAutosave({mode:"queue"}),w?.closeOutlineEditor&&w.closeOutlineEditor()}catch{}a.articleId=e,a.isEditingTitle=!1,a.pendingTextPreview=null,a.article=null,a.currentBlockId=null;let s=performance.now(),c=await od(e);sp()&&console.log("[perf][article-load] fetchArticle",{id:e,ms:Math.round(performance.now()-s)}),ko("load.fetched",{id:e,ms:Math.round(performance.now()-s),hasDocJson:!!c?.docJson,docContent:Array.isArray(c?.docJson?.content)?c.docJson.content.length:null,blocksCount:Array.isArray(c?.blocks)?c.blocks.length:null,updatedAt:c?.updatedAt});let l=c;try{l=await hu(c)}catch(g){throw L(g.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u0443\u044E \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443"),g}a.article=l,(typeof r=="boolean"?r:i)&&Wu(l);let u=n||o||a.pendingEditBlockId||null;a.pendingEditBlockId=null;let m=Fy(l.docJson)||l.blocks?.[0]?.id||null;if(a.currentBlockId=u||m,a.mode="view",a.editingBlockId=null,On(l),wl(),!a.isPublicView&&!a.isRagView&&!l.encrypted)try{let g=await Promise.resolve().then(()=>(pr(),fr));if(g?.openOutlineEditor){ko("outline.open.start",{id:e});let w=sp()?performance.now():0;g.openOutlineEditor(),w&&console.log("[perf][article-load] outline.open scheduled",{id:e,ms:Math.round(performance.now()-w)}),ko("outline.open.scheduled",{id:e,isOutlineEditing:a.isOutlineEditing})}}catch(g){a.isOutlineEditing=!1,ko("outline.open.failed",{id:e,message:g?.message||String(g||"error")}),L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C outline-\u0440\u0435\u0436\u0438\u043C (\u0441\u043C. \u043A\u043E\u043D\u0441\u043E\u043B\u044C)")}return ko("load.done",{id:e,currentBlockId:a.currentBlockId}),l}var Ry,Hy,ip,Gc=Fe(()=>{mt();Ft();Kn();Nt();cn();Ya();Eo();Ry="ttree_debug_article_load_v1",Hy="ttree_profile_v1",ip="ttree_outline_last_active_v1"});function up(){if(!Ht||!pi()||Ht.pointerType==="mouse")return;let e=window.getSelection?window.getSelection():null;if(!(!e||e.isCollapsed))try{e.removeAllRanges()}catch{}}function Ky(){Rs||(document.addEventListener("selectionchange",up),Rs=!0)}function Jy(){Rs&&(document.removeEventListener("selectionchange",up),Rs=!1)}function pi(){return!!(a.isDragModeEnabled&&a.mode==="view"&&a.articleId!=="inbox")}function fp(e){return e instanceof Element?!!e.closest(qy):!1}function Qc(){if(Ht){window.removeEventListener("pointermove",yp),window.removeEventListener("pointerup",Hs),window.removeEventListener("pointercancel",Hs);try{Ht.sourceEl?.releasePointerCapture?.(Ht.pointerId)}catch{}Ht=null,Jy(),Yy()}}function jy(e,t,n,{bypassInteractiveCheck:r=!1}={}){if(!a.article||!a.isDragModeEnabled||!pi()||e.pointerType==="mouse"&&e.button!==0||!r&&fp(e.target))return;let o=Je(t);if(o){Ht={pointerType:e.pointerType||"mouse",blockId:t,pointerId:e.pointerId,originParentId:o.parent?.id||null,originIndex:o.index??0,startX:e.clientX,startY:e.clientY,dragging:!1,forbidden:mp(o.block),lastDrop:null,sourceEl:n};try{n?.setPointerCapture?.(e.pointerId)}catch{}window.addEventListener("pointermove",yp),window.addEventListener("pointerup",Hs),window.addEventListener("pointercancel",Hs),Ky()}}function pp(e,t,{allowInteractive:n=!1}={}){e&&e.addEventListener("pointerdown",r=>{if(!n&&fp(r.target))return;(r.pointerType==="touch"||r.pointerType==="pen")&&pi()&&r.preventDefault(),jy(r,t,e,{bypassInteractiveCheck:n})})}function Nr(){let e=!!a.article,t=p.dragModeToggleBtn;if(t){t.disabled=!e,t.classList.toggle("active",!!a.isDragModeEnabled),t.setAttribute("aria-pressed",a.isDragModeEnabled?"true":"false");let o=a.isDragModeEnabled?"\u041F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435 \u0431\u043B\u043E\u043A \u0437\u0430 \u0435\u0433\u043E \u043F\u043E\u0432\u0435\u0440\u0445\u043D\u043E\u0441\u0442\u044C":"\u0412\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0440\u0435\u0436\u0438\u043C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u044F \u0431\u043B\u043E\u043A\u043E\u0432";e?a.articleId==="inbox"?o="\u041F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0432 \u0431\u044B\u0441\u0442\u0440\u044B\u0445 \u0437\u0430\u043C\u0435\u0442\u043A\u0430\u0445":a.mode!=="view"&&(o="\u041F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043C\u043E\u0436\u043D\u043E \u0442\u043E\u043B\u044C\u043A\u043E \u0432 \u0440\u0435\u0436\u0438\u043C\u0435 \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440\u0430"):o="\u041E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E, \u0447\u0442\u043E\u0431\u044B \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0442\u044C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435\u043C",t.title=o}let n=pi();[p.articleView,p.blocksContainer].forEach(o=>{o&&o.classList.toggle("drag-mode-enabled",n)}),document.body.classList.toggle("drag-mode-enabled",n)}function mp(e,t=new Set){return e&&(t.add(e.id),(e.children||[]).forEach(n=>mp(n,t))),t}function Wy(){if(fi)return fi;let e=document.createElement("div");return e.className="block-drop-line hidden",document.body.appendChild(e),fi=e,e}function Yy(){fi&&fi.classList.add("hidden"),hn&&(hn.classList.remove("drop-inside-target"),hn=null),Gr&&(Gr.remove(),Gr=null),document.body.classList.remove("block-dnd-active")}function Xy(e){Gr&&(Gr.style.left=`${e.clientX+12}px`,Gr.style.top=`${e.clientY+12}px`)}function Gy(e){let t=document.createElement("div");t.className="block-drag-preview";let n=p.blocksContainer?.querySelector(`.block[data-block-id="${e}"]`),r=n?.querySelector(".block-title")?.textContent?.trim(),o=n?.querySelector(".block-text")?.textContent?.trim();t.textContent=r||o||"\u0411\u043B\u043E\u043A",document.body.appendChild(t),Gr=t}function hp(){return Rn&&Rn.isConnected?(p.blocksContainer&&Rn.parentNode!==p.blocksContainer&&p.blocksContainer.appendChild(Rn),Rn):(Rn=document.createElement("div"),Rn.className="drag-layer",p.blocksContainer&&(p.blocksContainer.appendChild(Rn),ap||(p.blocksContainer.addEventListener("scroll",cp,{passive:!0}),window.addEventListener("resize",cp,{passive:!0}),ap=!0)),Rn)}function gp(){dp.clear(),Rn&&(Rn.innerHTML="")}function cp(){let e=p.blocksContainer;if(!e||!Rn)return;let t=e.getBoundingClientRect(),n=e.scrollTop;dp.forEach(({handle:r,blockEl:o})=>{let i=o.getBoundingClientRect(),s=o.querySelector(".block-header__left"),c=o.querySelector(".block-header"),l=o.querySelector(".collapse-btn"),d=s?.getBoundingClientRect(),u=c?.getBoundingClientRect(),m=l?.getBoundingClientRect(),g=(d&&d.height>0?d:null)||(u&&u.height>0?u:null)||(m&&m.height>0?m:null)||i,w=g.top-t.top+n+g.height/2;r.style.top=`${w}px`,r.style.right="8px"})}function Qy(e){let t=Wy();if(!e){t.classList.add("hidden"),hn&&(hn.classList.remove("drop-inside-target"),hn=null);return}if(e.placement==="inside"){t.classList.add("hidden"),hn&&hn.dataset.blockId!==e.targetId&&hn.classList.remove("drop-inside-target"),hn=p.blocksContainer?.querySelector(`.block[data-block-id="${e.targetId}"]`)||null,hn&&hn.classList.add("drop-inside-target");return}hn&&(hn.classList.remove("drop-inside-target"),hn=null),t.classList.remove("hidden");let n=e.placement==="before"?e.rect.top:e.rect.top+e.rect.height,r=Math.min(e.depth*lp,e.rect.width-32),o=e.rect.left+r,i=Math.max(e.rect.width-r,48);t.style.top=`${n}px`,t.style.left=`${o}px`,t.style.width=`${i}px`}function Zy(e,t){if(!p.blocksContainer||!Ht)return null;let r=Array.from(p.blocksContainer.querySelectorAll(".block")).filter(x=>{let v=x.dataset.blockId;return v&&!Ht.forbidden.has(v)});if(!r.length)return null;let o=null,i=1/0;if(r.forEach(x=>{let v=x.getBoundingClientRect(),B=v.top+v.height/2,N=Math.abs(t-B);N<i&&(i=N,o=x)}),!o)return null;let s=o.getBoundingClientRect(),c=s.height>0?(t-s.top)/s.height:.5,l=c<Uy?"before":c>Vy?"after":"inside",d=o.dataset.blockId,u=Je(d);if(!u)return null;let m=(u.ancestors||[]).length,g=l==="inside"?d:u.parent?.id||null;if(Ht.forbidden.has(g||""))return null;let w=d,y=g,f=l,h=s,b=l==="inside"?m+1:m,S=f==="after"?u.index+1:u.index;if(f!=="inside"&&u.parent){let x=u,v=s,B=s.left+lp;for(;x.parent;){let N=e<=B,z=t<=v.top||t>=v.bottom;if(!N&&!z)break;let P=Je(x.parent.id);if(!P)break;let q=p.blocksContainer?.querySelector(`.block[data-block-id="${P.block.id}"]`)?.getBoundingClientRect();x=P,v=q||v,w=x.block.id,h=v,b=(x.ancestors||[]).length,y=x.parent?.id||null,S=f==="after"?x.index+1:x.index}}return{targetId:w,placement:f,parentId:y,index:S,depth:b,rect:h}}function eb(e){if(!p.blocksContainer)return;let t=p.blocksContainer.getBoundingClientRect(),n=60;e.clientY<t.top+n?p.blocksContainer.scrollTop-=12:e.clientY>t.bottom-n&&(p.blocksContainer.scrollTop+=12)}function yp(e){if(!Ht||e.pointerId!==Ht.pointerId)return;if(!pi()){Qc();return}let t=e.clientX-Ht.startX,n=e.clientY-Ht.startY;if(!Ht.dragging){if(Math.hypot(t,n)<zy)return;Ht.dragging=!0;let o=Ht.pointerType||e.pointerType||"mouse";(o==="touch"||o==="pen")&&document.body.classList.add("block-dnd-active"),Gy(Ht.blockId)}e.preventDefault(),Xy(e);let r=Zy(e.clientX,e.clientY);Ht.lastDrop=r,Qy(r),eb(e)}async function Hs(e){if(!Ht||e.pointerId!==Ht.pointerId)return;let t=Ht;Qc();let n=t.dragging&&t.lastDrop,r=t.lastDrop,o=t.blockId;!n||!r||await hs(o,r.parentId||null,r.index,{anchorId:r.targetId,placement:r.placement})}function $s(){if(!a.article){L("\u041E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E, \u0447\u0442\u043E\u0431\u044B \u043F\u0435\u0440\u0435\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435");return}if(a.isDragModeEnabled=!a.isDragModeEnabled,!a.isDragModeEnabled){Qc(),Nr(),L("\u041F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435 \u0432\u044B\u043A\u043B\u044E\u0447\u0435\u043D\u043E");return}if(Nr(),a.articleId==="inbox"){L("\u0420\u0435\u0436\u0438\u043C \u0432\u043A\u043B\u044E\u0447\u0451\u043D, \u043D\u043E \u0432 \u0431\u044B\u0441\u0442\u0440\u044B\u0445 \u0437\u0430\u043C\u0435\u0442\u043A\u0430\u0445 \u043F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E");return}if(a.mode!=="view"){L("\u0420\u0435\u0436\u0438\u043C \u0432\u043A\u043B\u044E\u0447\u0451\u043D, \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u0442\u0435 \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435, \u0447\u0442\u043E\u0431\u044B \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u0442\u044C \u0431\u043B\u043E\u043A\u0438");return}L("\u041F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435 \u0432\u043A\u043B\u044E\u0447\u0435\u043D\u043E \u2014 \u043F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435 \u0431\u043B\u043E\u043A \u0437\u0430 \u0435\u0433\u043E \u043F\u043E\u0432\u0435\u0440\u0445\u043D\u043E\u0441\u0442\u044C")}var zy,lp,Uy,Vy,qy,Ht,fi,hn,Gr,Rn,dp,ap,Rs,mi=Fe(()=>{mt();Mt();ln();Kn();Nt();zy=6,lp=20,Uy=.35,Vy=.65,qy='button, a, input, textarea, select, [contenteditable="true"], .block-edit-actions, .move-block-btn, .collapse-btn',Ht=null,fi=null,hn=null,Gr=null,Rn=null,dp=new Map,ap=!1,Rs=!1});function bp(e){Zc=typeof e=="function"?e:null}function tb(e){let t=new Set,n=r=>{if(Array.isArray(r))for(let o=0;o<r.length;o+=1){let i=r[o];if(!i||!i.id){r.splice(o,1),o-=1;continue}if(t.has(i.id)){r.splice(o,1),o-=1;continue}t.add(i.id),Array.isArray(i.children)&&i.children.length&&n(i.children)}};n(e)}function wp(){if(!p.blocksContainer)return;let e=new Set;p.blocksContainer.querySelectorAll(".block[data-block-id]").forEach(n=>{let r=n.getAttribute("data-block-id");if(r)if(e.has(r)){let o=n.parentNode;o&&o.removeChild(n)}else e.add(r)})}function Sp(){if(!p.blocksContainer||!a.article||!Array.isArray(a.article.blocks))return;let e=Sn(a.article.blocks),t=new Set(e.map(r=>r.id));p.blocksContainer.querySelectorAll(".block[data-block-id]").forEach(r=>{let o=r.getAttribute("data-block-id");if(o&&!t.has(o)){let i=r.parentNode;i&&i.removeChild(r)}})}function Wo(e,t,n,r){if(!a.article||!e||!e.id)return;let o=Array.isArray(a.article.blockTrash)?a.article.blockTrash:[],i=r||new Date().toISOString();o.push({id:e.id,block:e,parentId:t||null,index:typeof n=="number"?n:null,deletedAt:i}),a.article.blockTrash=o}function ao(e){if(!e||!p.blocksContainer)return;p.blocksContainer.querySelectorAll(`.block[data-block-id="${e}"]`).forEach(n=>{let r=n.parentElement;if(!r)return;let o=n.nextElementSibling;if(o&&o.classList.contains("block-children")){let i=o;o=o.nextElementSibling,i.parentNode===r&&r.removeChild(i)}n.parentNode===r&&r.removeChild(n)})}async function el(e,t,n=1){for(let r of e){let o=document.createElement("div");o.className="block",o.dataset.blockId=r.id,typeof r.collapsed=="boolean"&&(o.dataset.collapsed=r.collapsed?"true":"false"),(r.id===a.currentBlockId||Array.isArray(a.selectedBlockIds)&&a.selectedBlockIds.includes(r.id))&&o.classList.add("selected"),r.id===a.editingBlockId&&o.classList.add("editing");let s=document.createElement("div");s.className="block-surface";let c=document.createElement("div");c.className="block-content";let l=Cn(r.text||""),d=!!l.titleHtml,u=!!(l.bodyHtml&&l.bodyHtml.trim()),m=!!r.children?.length;if(!d&&m){let B=document.createElement("div");B.innerHTML=l.bodyHtml||r.text||"";let N=Array.from(B.childNodes||[]).filter(z=>z.nodeType===Node.TEXT_NODE?(z.textContent||"").trim().length>0:z.nodeType===Node.ELEMENT_NODE?z.tagName==="BR"?!1:z.tagName==="P"?(z.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim().length>0:!0:!1);if(N.length===1){let z=N[0];z.nodeType===Node.ELEMENT_NODE&&z.tagName==="P"&&(l={titleHtml:z.outerHTML,bodyHtml:""},d=!0,u=!1)}}let g=d||m,w=!d&&!m;o.classList.toggle("block--no-title",!d);let y=a.mode==="edit"&&a.editingBlockId===r.id,f=null;if(g||w){let B=document.createElement("button");B.className="collapse-btn",w?(B.classList.add("collapse-btn--placeholder"),B.setAttribute("aria-hidden","true"),B.removeAttribute("aria-expanded"),B.removeAttribute("title")):(B.setAttribute("aria-expanded",r.collapsed?"false":"true"),B.title=r.collapsed?"\u0420\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C":"\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C"),f=document.createElement("div"),f.className="block-header",d||f.classList.add("block-header--no-title");let N=document.createElement("div");if(N.className="block-header__left",N.appendChild(B),d){let z=Math.min(Math.max(n,1),6),P=document.createElement(`h${z}`);P.className="block-title",P.innerHTML=l.titleHtml||"",N.appendChild(P)}else{let z=document.createElement("div");z.className="block-title-spacer",z.style.flex="1",z.style.minWidth="0",N.appendChild(z)}f.appendChild(N)}let h=document.createElement("div");h.className="block-text block-body";let b=y?cc(r.text||""):l.bodyHtml||"";if(h.innerHTML=b,(!b||!b.trim())&&(h.classList.add("block-body--empty"),y&&(h.innerHTML="<p><br /></p>")),h.classList.toggle("block-body--no-title",!d),y?(h.setAttribute("contenteditable","true"),h.setAttribute("spellcheck","false"),h.dataset.placeholder="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0442\u0435\u043A\u0441\u0442"):h.removeAttribute("contenteditable"),f&&c.appendChild(f),(y||!d||b)&&c.appendChild(h),a.articleId==="inbox"&&!y){let B=document.createElement("div");B.className="block-footer";let N=document.createElement("button");N.type="button",N.className="ghost small move-block-btn",N.innerHTML="&#10140;",N.title="\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0431\u043B\u043E\u043A \u0432 \u0434\u0440\u0443\u0433\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E",N.addEventListener("click",z=>{z.stopPropagation(),Zc?Zc(r.id):L("\u041F\u0435\u0440\u0435\u043D\u043E\u0441 \u0431\u043B\u043E\u043A\u0430 \u0432\u0440\u0435\u043C\u0435\u043D\u043D\u043E \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D")}),B.appendChild(N),c.appendChild(B)}if(s.appendChild(c),y&&("ontouchstart"in window||navigator.maxTouchPoints>0)&&c.addEventListener("click",N=>{let z=c.querySelector('.block-text[contenteditable="true"]');z&&(z.contains(N.target)||(N.stopPropagation(),z.focus(),a.editingCaretPosition==="start"?(z.scrollTop=0,Sa(z)):$i(z)))}),pp(s,r.id),y){let B=document.createElement("div");B.className="block-edit-actions";let N=document.createElement("button");N.type="button",N.className="ghost small block-attach-btn",N.innerHTML='<span class="block-attach-btn__icon">&#xE723;</span><span class="block-attach-btn__label">\u0424\u0430\u0439\u043B</span>',N.title="\u041F\u0440\u0438\u043A\u0440\u0435\u043F\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u0438\u043B\u0438 \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0443",N.addEventListener("click",W=>{W.preventDefault(),W.stopPropagation();let q=o.querySelector('.block-text[contenteditable="true"]');if(!q)return;let ee=document.createElement("input");ee.type="file",ee.multiple=!0,ee.style.display="none",ee.addEventListener("change",()=>{let de=Array.from(ee.files||[]);de.length&&dc(q,de,r.id),ee.remove()}),document.body.appendChild(ee),ee.click()});let z=document.createElement("button");z.type="button",z.className="ghost small",z.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C",z.addEventListener("click",async W=>{W.preventDefault(),W.stopPropagation(),await Jo()});let P=document.createElement("button");P.type="button",P.className="ghost small",P.textContent="\u041E\u0442\u043C\u0435\u043D\u0430",P.addEventListener("click",W=>{W.preventDefault(),W.stopPropagation(),is()}),B.appendChild(N),B.appendChild(z),B.appendChild(P),c.appendChild(B)}uc(h,r.id),o.appendChild(s),o.addEventListener("click",B=>{if(B.stopPropagation(),a.isRagView&&a.ragBlockMap&&a.ragBlockMap[r.id]){let je=a.ragBlockMap[r.id];if(je&&je.articleId&&je.blockId){a.scrollTargetBlockId=je.blockId,a.currentBlockId=je.blockId,bt(pt.article(je.articleId));return}}let N=B.target.closest('button, a, [contenteditable="true"], .block-edit-actions'),z=o.querySelector(".block-header"),P=o.querySelector(".block-text.block-body"),W=!!z,q=!!(z&&!z.classList.contains("block-header--no-title")),ee=W&&z.contains(B.target),de=P&&P.contains(B.target),Le=q,ne=a.currentBlockId===r.id,pe=!1;(Le&&ee||!Le&&ne&&de&&!N)&&(pe=!0),pe&&lc(r.id),Tn(r.id)}),s.addEventListener("dblclick",B=>{if(a.mode!=="view"||a.isPublicView||a.isRagView)return;let N=B.target.closest('button, a, [contenteditable="true"]');N&&!N.matches('.block-text[contenteditable="true"]')||(B.stopPropagation(),Tn(r.id),os())});let x=r.collapsed&&r.id!==a.editingBlockId&&d;h.classList.contains("block-body--empty")||h.classList.toggle("collapsed",x);let v=null;r.children?.length>0&&!r.collapsed&&(v=document.createElement("div"),v.className="block-children",await el(r.children,v,n+1)),t.appendChild(o),v&&(y?t.appendChild(v):o.appendChild(v))}}function gs(e,t){if(!e||!["up","down"].includes(t))return!1;let n=document.querySelector(`.block[data-block-id="${e}"]`);if(!n||n.classList.contains("editing"))return!1;let r=n.parentElement;if(!r)return!1;if(t==="up"){let s=n.previousElementSibling;for(;s&&!s.classList.contains("block");)s=s.previousElementSibling;return s?(r.insertBefore(n,s),!0):!1}let o=n.nextElementSibling;for(;o&&!o.classList.contains("block");)o=o.nextElementSibling;if(!o)return!1;let i=o.nextSibling;return i?r.insertBefore(n,i):r.appendChild(n),!0}async function xt(e){if(!a.article||!Array.isArray(a.article.blocks))return;let t=Je(e);if(!t)return;let n=(Array.isArray(t.ancestors)?t.ancestors.length:0)+1,r=document.querySelector(`.block[data-block-id="${e}"]`);if(!r)return;let o=r.parentElement;if(!o)return;let i=[],s=r.nextElementSibling;s&&s.classList.contains("block-children")&&i.push(s);let c=(i[i.length-1]||r).nextSibling;o.removeChild(r),i.forEach(u=>{u.parentNode===o&&o.removeChild(u)});let l=document.createElement("div");await el([t.block],l,n),Array.from(l.childNodes).forEach(u=>{o.insertBefore(u,c)}),wp(),Sp()}function ot(){let e=a.article;if(!e)return;if(!a.isPublicView&&!a.isRagView&&a.isOutlineEditing){kt(),An();return}Array.isArray(e.blocks)&&tb(e.blocks),kt();let t=e.id==="inbox"?[...e.blocks||[]].reverse():e.blocks;An(),p.blocksContainer.innerHTML="",Nr(),gp(),hp();let n=()=>{if(a.mode!=="edit"||!a.editingBlockId||a.editingCaretPosition==="start")return;let r=p.blocksContainer?.querySelector(`.block[data-block-id="${a.editingBlockId}"] .block-text[contenteditable="true"]`);if(!r)return;let o=document.activeElement;r===o||r.contains(o)||(r.focus({preventScroll:!0}),r.scrollHeight>r.clientHeight&&(r.scrollTop=r.scrollHeight),$i(r))};el(t,p.blocksContainer).then(()=>{if(Sp(),wp(),qu(),a.scrollTargetBlockId&&a.mode==="view"){let r=a.scrollTargetBlockId;requestAnimationFrame(()=>{let o=document.querySelector(`.block[data-block-id="${r}"]`);if(o){(o.querySelector(".block-content")||o).scrollIntoView({behavior:"smooth",block:"nearest"});let s=o.querySelector('.block-text[contenteditable="true"]');s&&a.mode==="edit"&&a.editingBlockId===r?(s.focus({preventScroll:!0}),a.editingCaretPosition==="start"?(s.scrollTop=0,Sa(s)):$i(s)):(o.setAttribute("tabindex","-1"),o.focus({preventScroll:!0}))}a.currentBlockId=r,a.scrollTargetBlockId=null})}n(),a.mode==="edit"&&typeof a.editingScrollTop=="number"&&p.blocksContainer&&(p.blocksContainer.scrollTop=a.editingScrollTop)})}var Zc,tl=Fe(()=>{mt();Mt();Ft();Nt();Vn();so();vn();ln();ln();cn();Kn();En();Eo();mi();Zc=null});async function nb(e){try{let n=(a.articlesIndex.length?a.articlesIndex:await In()).filter(u=>u.id!=="inbox"),r=n.map(u=>({id:u.id,title:u.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),o=await on({title:"\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0432 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0438\u043B\u0438 \u0432\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E",confirmText:"\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:r,returnMeta:!0,hideConfirm:!1}),s=(o?.selectedId||(typeof o=="object"?o?.value:o)||""||"").trim();if(!s)return;let c=s.toLowerCase(),l=n.find(u=>u.id&&u.id.toLowerCase()===c||(u.title||"").toLowerCase()===c),d=l?l.id:s;if(!d||d==="inbox"){L("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}await apiRequest(`/api/articles/${a.articleId}/blocks/${e}/move-to/${d}`,{method:"POST"}),await Jt("inbox",{resetUndoStacks:!0}),ot(),L("\u0411\u043B\u043E\u043A \u043F\u0435\u0440\u0435\u043D\u0435\u0441\u0451\u043D")}catch(t){L(t.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0431\u043B\u043E\u043A")}}async function Fs(){if(a.isMergingBlocks)return;if(!a.article||!Array.isArray(a.article.blocks)||!a.article.blocks.length){L("\u041D\u0435\u0442 \u0431\u043B\u043E\u043A\u043E\u0432 \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u044F");return}let e=Array.isArray(a.selectedBlockIds)?a.selectedBlockIds:[];if(!e.length){L("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A\u0438 (Shift+\u2191/\u2193), \u043A\u043E\u0442\u043E\u0440\u044B\u0435 \u043D\u0443\u0436\u043D\u043E \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0438\u0442\u044C");return}let n=Sn(a.article.blocks).filter(d=>e.includes(d.id));if(n.length<2){L("\u0414\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u044F \u043D\u0443\u0436\u043D\u043E \u0432\u044B\u0431\u0440\u0430\u0442\u044C \u043A\u0430\u043A \u043C\u0438\u043D\u0438\u043C\u0443\u043C \u0434\u0432\u0430 \u0431\u043B\u043E\u043A\u0430");return}let r=n[0],o=n.slice(1),i=new Set(o.map(d=>d.id)),s=o.filter(d=>{let u=Je(d.id,a.article?.blocks||[]);return u?!u.ancestors?.some(m=>i.has(m.id)):!1}),c=[];r.text&&c.push(r.text),o.forEach(d=>{d.text&&c.push(d.text)});let l=c.join("");a.isMergingBlocks=!0,p.mergeBlocksBtn&&(p.mergeBlocksBtn.disabled=!0),L("\u041E\u0431\u044A\u0435\u0434\u0438\u043D\u044F\u0435\u043C \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u044B\u0435 \u0431\u043B\u043E\u043A\u0438...");try{await apiRequest(`/api/articles/${a.articleId}/blocks/${r.id}`,{method:"PATCH",body:JSON.stringify({text:l})});for(let d of s)await apiRequest(`/api/articles/${a.articleId}/blocks/${d.id}`,{method:"DELETE"});await Jt(a.articleId,{resetUndoStacks:!1}),ot(),a.mode="view",a.editingBlockId=null,a.pendingEditBlockId=null,Tn(r.id),L("\u0411\u043B\u043E\u043A\u0438 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0435\u043D\u044B \u0432 \u043E\u0434\u0438\u043D")}catch(d){L(d.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438")}finally{a.isMergingBlocks=!1,p.mergeBlocksBtn&&(p.mergeBlocksBtn.disabled=!1)}}async function hi(e){try{String(e||"").startsWith("inbox-")&&(e="inbox")}catch{}a.isPublicView=!1,a.isRagView=!1,document.body.classList.remove("public-embedded"),a.isEditingTitle=!1,await ar(),Uo(!0),p.usersView&&p.usersView.classList.add("hidden"),p.blocksContainer.innerHTML="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...";try{if(e==="RAG"){a.isRagView=!0,a.mode="view",a.editingBlockId=null,a.pendingEditBlockId=null,a.scrollTargetBlockId=null,a.ragBlockMap={},es("RAG");let r=(a.ragQuery||"").trim(),o=Array.isArray(a.ragResults)?a.ragResults:[],i=o.length,s=Array.from(new Set(o.map(m=>m&&m.articleTitle?String(m.articleTitle):"").filter(Boolean))),c=s.slice(0,8),l=["<p><strong>\u0421\u0432\u043E\u0434\u043A\u0430</strong></p>"];a.ragSummaryLoading?l.push('<p class="meta">\u0413\u0435\u043D\u0435\u0440\u0438\u0440\u0443\u044E \u0441\u0432\u043E\u0434\u043A\u0443\u2026</p>'):a.ragSummaryError?l.push(`<p class="meta">\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0432\u043E\u0434\u043A\u0438: ${a.ragSummaryError}</p>`):a.ragSummaryHtml?l.push(a.ragSummaryHtml):l.push('<p class="meta">\u0421\u0432\u043E\u0434\u043A\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435 \u0433\u043E\u0442\u043E\u0432\u0430.</p>');let d=["<p><strong>AI-\u043F\u043E\u0438\u0441\u043A: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B</strong></p>",`<p><span class="meta">\u0417\u0430\u043F\u0440\u043E\u0441:</span> ${r||"\u2014"}</p>`,`<p><span class="meta">\u041D\u0430\u0439\u0434\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432:</span> ${i}</p>`];c.length&&d.push(`<p><span class="meta">\u0421\u0442\u0430\u0442\u044C\u0438:</span> ${c.join(" \xB7 ")}</p>`),s.length>c.length&&d.push(`<p><span class="meta">\u2026\u0438 \u0435\u0449\u0451:</span> ${s.length-c.length}</p>`);let u=[{id:"rag-ai-summary",text:l.join(""),children:[],collapsed:!1},{id:"rag-meta",text:d.join(""),children:[],collapsed:!1},...o.filter(m=>m&&m.type==="block").map((m,g)=>{let w=m.blockText||"",y=m.articleTitle?String(m.articleTitle):"",f=y?`<p><strong>${y}</strong></p>`:`<p><strong>\u0420\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442 ${g+1}</strong></p>`,h=`rag-${m.blockId||g}`;return m.articleId&&m.blockId&&(a.ragBlockMap[h]={articleId:m.articleId,blockId:m.blockId}),{id:h,text:`${f}${w}`,children:[],collapsed:!1}})];a.article={id:"RAG",title:r?`AI: ${r}`:"AI: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B \u043F\u043E\u0438\u0441\u043A\u0430",blocks:u,updated_at:new Date().toISOString()},a.articleId="RAG",a.currentBlockId=u[0]?.id||null,ot();return}let t=a.pendingEditBlockId||void 0,n=a.scrollTargetBlockId||void 0;if(await Jt(e,{resetUndoStacks:!0,desiredBlockId:n,editBlockId:t}),ot(),es(e),e==="inbox"&&navigator.onLine&&a.serverStatus==="ok")try{await Ic().catch(()=>{}),a.articleId==="inbox"&&!a.editingBlockId&&(await Jt("inbox",{resetUndoStacks:!1}),ot())}catch{}}catch(t){p.blocksContainer.innerHTML=`<p class="meta">\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u044C\u044E: ${t.message}</p>`}}async function zs(){a.isPublicView=!1,a.isRagView=!1,document.body.classList.remove("public-embedded"),p.usersView&&p.usersView.classList.add("hidden"),a.article=null,a.articleId=null,a.currentBlockId=null,a.isEditingTitle=!1,a.mode="view",a.editingBlockId=null,a.undoStack=[],a.redoStack=[],a.pendingEditBlockId=null,Zn({restoreDom:!1}),Uo(!1),Nr();try{if(a.isTrashView){let e=await Qi();Gt(e)}else{let e=await ar();Gt(e)}}catch(e){p.articleList.innerHTML=`<li>\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u043F\u0438\u0441\u043E\u043A: ${e.message}</li>`}}async function Us(e){a.isPublicView=!0,a.isRagView=!1,document.body.classList.add("public-embedded"),p.usersView&&p.usersView.classList.add("hidden"),Uo(!0),a.isEditingTitle=!1,a.mode="view",a.editingBlockId=null,a.pendingEditBlockId=null,a.selectionAnchorBlockId=null,a.selectedBlockIds=[],a.undoStack=[],a.redoStack=[],Zn({restoreDom:!1}),p.blocksContainer&&(p.blocksContainer.innerHTML="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...");try{let t=await apiRequest(`/api/public/articles/${encodeURIComponent(e)}`,{method:"GET",credentials:"omit"});a.article=t,a.articleId=t?.id||null;let n=Sn(t?.blocks||[])[0];a.currentBlockId=n?n.id:null,ot()}catch(t){p.blocksContainer&&(p.blocksContainer.innerHTML=`<p class="meta">\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E: ${t.message}</p>`)}}async function gi(){p.createArticleBtn&&(p.createArticleBtn.disabled=!0),p.sidebarNewArticleBtn&&(p.sidebarNewArticleBtn.disabled=!0);try{let e="";try{e=await on({title:"\u041D\u043E\u0432\u0430\u044F \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0430",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0437\u0430\u0433\u043E\u043B\u043E\u0432\u043E\u043A \u0434\u043B\u044F \u043D\u043E\u0432\u043E\u0439 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B.",confirmText:"\u0421\u043E\u0437\u0434\u0430\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"\u0417\u0430\u0433\u043E\u043B\u043E\u0432\u043E\u043A \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B",defaultValue:""})}catch{e=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0437\u0430\u0433\u043E\u043B\u043E\u0432\u043E\u043A \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B")||""}if(e=(e||"").trim(),!e)return;let t=await ld(e);On(t),a.pendingEditBlockId=t?.blocks?.[0]?.id||null,a.scrollTargetBlockId=a.pendingEditBlockId,bt(pt.article(t.id)),L("\u0421\u0442\u0430\u0442\u044C\u044F \u0441\u043E\u0437\u0434\u0430\u043D\u0430")}catch(e){L(e.message)}finally{p.createArticleBtn&&(p.createArticleBtn.disabled=!1),p.sidebarNewArticleBtn&&(p.sidebarNewArticleBtn.disabled=!1)}}async function Vs(){bt(pt.article("inbox"))}async function qs(){try{let e=pt.article("inbox");a.articleId==="inbox"&&window.location.pathname===e||bt(e);let n=await Promise.resolve().then(()=>(pr(),fr)),r=null,o=performance.now()+15e3;for(;!r&&performance.now()<o;){if(!(a.articleId==="inbox"&&a.article&&(String(a.article.id||"")==="inbox"||String(a.article.id||"").startsWith("inbox-"))&&String(a.article.title||"")==="\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438")){await new Promise(s=>setTimeout(s,50));continue}if(a.article?.encrypted){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u0437\u0430\u043C\u0435\u0442\u043A\u0443 (\u0438\u043D\u0431\u043E\u043A\u0441 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D)");return}r=n?.insertNewOutlineSectionAtStart?.({enterEditMode:!0})||null,r||await new Promise(s=>setTimeout(s,50))}if(!r){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u0437\u0430\u043C\u0435\u0442\u043A\u0443");return}a.currentBlockId=r;try{n?.enterOutlineSectionEditMode?.(r,{focusBody:!0})}catch{}}catch(e){L(e.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u0437\u0430\u043C\u0435\u0442\u043A\u0443")}}var xp=Fe(()=>{mt();Mt();Ft();Nt();Vn();En();cn();cn();cn();Kn();ln();Gc();tl();mi();mo();bp(nb)});var Gu={};Wn(Gu,{createArticle:()=>gi,createInboxNote:()=>qs,loadArticle:()=>Jt,loadArticleView:()=>hi,loadListView:()=>zs,loadPublicArticleView:()=>Us,mergeAllBlocksIntoFirst:()=>Fs,openInboxArticle:()=>Vs,pushLocalBlockTrashEntry:()=>Wo,removeArticleEncryption:()=>rs,removeDomBlockById:()=>ao,renderArticle:()=>ot,reorderDomBlock:()=>gs,rerenderSingleBlock:()=>xt,toggleArticleEncryption:()=>ns,toggleDragMode:()=>$s,updateArticleHeaderUi:()=>An});var Qn=Fe(()=>{Eo();Ya();Gc();tl();xp();mi();mi();Nr()});function bt(e){if(window.location.pathname===e){Ao(e);return}window.history.pushState({},"",e),Ao(e)}function Ao(e){let t=e.match(/^\/p\/([^/?#]+)/);if(t){Us(decodeURIComponent(t[1]));return}let n=e.match(/^\/article\/([0-9a-zA-Z-]+)/);if(n){let r=String(n[1]||"");if(r.startsWith("inbox-")){try{window.history.replaceState({},"",pt.article("inbox"))}catch{}hi("inbox");return}hi(r);return}zs()}function nl(){window.addEventListener("popstate",()=>Ao(window.location.pathname))}var pt,En=Fe(()=>{Qn();pt={list:"/",article:e=>`/article/${e}`,public:e=>`/p/${e}`}});var Up={};Wn(Up,{exportCurrentArticleAsHtml:()=>cb,exportCurrentBlockAsHtml:()=>lb});async function cb(){if(!a.article||!a.articleId){L("\u041D\u0435\u0442 \u043E\u0442\u043A\u0440\u044B\u0442\u043E\u0439 \u0441\u0442\u0430\u0442\u044C\u0438 \u0434\u043B\u044F \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0430");return}try{L("\u0413\u043E\u0442\u043E\u0432\u0438\u043C \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u2026");let e=await fetch(`/api/articles/${encodeURIComponent(a.articleId)}/export/html`,{credentials:"include",cache:"no-store"});if(!e.ok)throw new Error(`\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u044B\u0433\u0440\u0443\u0437\u0438\u0442\u044C HTML (HTTP ${e.status})`);let t=await e.text();zp(t,Hp(a.article.title||"article")),L("HTML \u0441\u043E\u0445\u0440\u0430\u043D\u0451\u043D")}catch(e){console.error("Export failed",e),L(e.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u044B\u0433\u0440\u0443\u0437\u0438\u0442\u044C HTML")}}async function lb(e){if(a.article?.docJson||a.isOutlineEditing){L("\u042D\u043A\u0441\u043F\u043E\u0440\u0442 \u0444\u0440\u0430\u0433\u043C\u0435\u043D\u0442\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0432 outline \u0440\u0435\u0436\u0438\u043C\u0435");return}if(!a.article){L("\u041D\u0435\u0442 \u043E\u0442\u043A\u0440\u044B\u0442\u043E\u0439 \u0441\u0442\u0430\u0442\u044C\u0438 \u0434\u043B\u044F \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0430");return}let t=e||a.currentBlockId;if(!t){L("\u041D\u0435 \u0432\u044B\u0431\u0440\u0430\u043D \u0431\u043B\u043E\u043A \u0434\u043B\u044F \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0430");return}let n=Je(t);if(!n||!n.block){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u044B\u0439 \u0431\u043B\u043E\u043A");return}let r=n.block,{titleHtml:o}=Cn(r.text||""),i="";o?i=Do(o):r.text&&(i=Do(r.text).slice(0,80)),i||(i="\u0424\u0440\u0430\u0433\u043C\u0435\u043D\u0442");let s=a.article.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",c=`${i} \u2014 \u0444\u0440\u0430\u0433\u043C\u0435\u043D\u0442 \u0438\u0437 \xAB${s}\xBB`;try{L("\u0413\u043E\u0442\u043E\u0432\u0438\u043C \u044D\u043A\u0441\u043F\u043E\u0440\u0442 \u0444\u0440\u0430\u0433\u043C\u0435\u043D\u0442\u0430...");let l=await db(),{bodyHtml:d,plainText:u,wordCount:m}=fb([r],{title:i,updatedAt:a.article.updatedAt||null,suppressRootTitleInBody:!0}),{html:g,failures:w}=await mb(d),y=ub(u),f={...a.article,blocks:[r],title:c},h=pb(f),b=hb({cssText:l,contentHtml:g,title:c,description:y,article:f,wordCount:m,lang:document.documentElement.lang||"ru",exportPayload:h});zp(b,Hp(i||"fragment")),w.length?(L(`\u042D\u043A\u0441\u043F\u043E\u0440\u0442 \u0444\u0440\u0430\u0433\u043C\u0435\u043D\u0442\u0430 \u0437\u0430\u0432\u0435\u0440\u0448\u0451\u043D \u0441 \u043F\u0440\u0435\u0434\u0443\u043F\u0440\u0435\u0436\u0434\u0435\u043D\u0438\u044F\u043C\u0438: ${w.length} \u0432\u043B\u043E\u0436\u0435\u043D\u0438\u0439 \u043D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u043D\u043B\u0430\u0439\u043D\u0438\u0442\u044C`),console.warn("Inline failures (fragment export)",w)):L("\u0424\u0440\u0430\u0433\u043C\u0435\u043D\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0451\u043D \u0432 HTML")}catch(l){console.error("Export fragment failed",l),L(l.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u044B\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0440\u0430\u0433\u043C\u0435\u043D\u0442 \u0432 HTML")}}async function db(){let e=await fetch("/style.css",{cache:"no-cache"});if(!e.ok)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0438\u043B\u0438 \u0434\u043B\u044F \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0430");return e.text()}function ub(e=""){if(!e)return"";let t=e.trim().replace(/\s+/g," ");return t.length<=Rp?t:`${t.slice(0,Rp).trimEnd()}\u2026`}function Hp(e=""){return`${(e||"article").toLowerCase().replace(/[^a-z0-9\u0400-\u04ff]+/gi,"-").replace(/^-+|-+$/g,"").slice(0,60)||"article"}.html`}function $p(e=[]){let t=[];return e.forEach(n=>{n?.text&&t.push(Do(n.text)),n?.children?.length&&t.push($p(n.children))}),t.flat().filter(Boolean)}function Fp(e,t=1,n={}){let r=!!n.suppressTitle,o=Cn(e.text||""),i=!!o.titleHtml,s=!!e.children?.length;if(!i&&s&&typeof document<"u"){let P=document.createElement("div");P.innerHTML=o.bodyHtml||e.text||"";let W=Array.from(P.childNodes||[]).filter(q=>q.nodeType===Node.TEXT_NODE?(q.textContent||"").trim().length>0:q.nodeType===Node.ELEMENT_NODE?q.tagName==="BR"?!1:q.tagName==="P"?(q.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim().length>0:!0:!1);if(W.length===1){let q=W[0];q.nodeType===Node.ELEMENT_NODE&&q.tagName==="P"&&(o={titleHtml:q.outerHTML,bodyHtml:""},i=!0)}}let c=i?o.bodyHtml:e.text||"",l=i&&!r,d=!!(c&&c.trim()),u=l||s,m=!l&&!s,g=!!e.collapsed,w="";(u||m)&&(m?w='<button class="collapse-btn collapse-btn--placeholder" type="button" aria-hidden="true"></button>':w=`<button class="collapse-btn" type="button" data-block-id="${e.id}" aria-expanded="${g?"false":"true"}"></button>`);let y="";if(l){let W=`h${Math.min(Math.max(t,1),6)}`;y=`<${W} class="block-title">${o.titleHtml}</${W}>`}let f=y?`<div class="block-header${l?"":" block-header--no-title"}">${y}</div>`:"",h=["block-text","block-body"];l||h.push("block-body--no-title"),d||h.push("block-body--empty"),g&&l&&h.push("collapsed");let b=`<div class="${h.join(" ")}" data-block-body>${c||""}</div>`,S=`<div class="block-content">${f}${b}</div>`,x=l?t+1:t,v=(e.children||[]).map(P=>Fp(P,x)).join(""),B=`<div class="block-children${g?" collapsed":""}" data-children>${v}</div>`,N=["block"];l||N.push("block--no-title");let z=`<div class="block-surface">${w}${S}</div>`;return`<div class="${N.join(" ")}" data-block-id="${e.id}" data-collapsed="${g?"true":"false"}" tabindex="0">${z}${B}</div>`}function fb(e=[],{title:t,updatedAt:n,suppressRootTitleInBody:r}={}){let o=e||[],i=o.map((g,w)=>Fp(g,1,{suppressTitle:!!(r&&w===0)})).join(""),c=$p(o).join(" ").replace(/\s+/g," ").trim(),l=c?c.split(/\s+/).length:0,d=n?new Date(n).toLocaleString():"";return{bodyHtml:`
    <section aria-label="\u042D\u043A\u0441\u043F\u043E\u0440\u0442 \u0441\u0442\u0430\u0442\u044C\u0438">
      ${`
    <div class="panel-header article-header">
      <div class="title-block">
        <div class="title-row">
          <h1>${lt(t||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F")}</h1>
        </div>
        ${d?`<p class="meta">\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${lt(d)}</p>`:""}
      </div>
    </div>
  `}
      <div id="exportBlocksRoot" class="blocks" role="tree">
        ${i}
      </div>
    </section>
  `,plainText:c,wordCount:l}}function pb(e){if(!e)return{version:1,source:"memus",article:null,blocks:[]};let t=(n=[])=>(n||[]).map(r=>({id:r.id,text:r.text||"",collapsed:!!r.collapsed,children:t(r.children||[])}));return{version:1,source:"memus",article:{id:e.id,title:e.title||"",createdAt:e.createdAt||null,updatedAt:e.updatedAt||null,deletedAt:e.deletedAt||null,isInbox:e.id==="inbox",encrypted:!!e.encrypted,encryptionHint:e.encryptionHint||null},blocks:t(e.blocks||[])}}async function mb(e){let t=document.createElement("template");t.innerHTML=e;let n=new Map,r=[],o=async d=>{if(n.has(d))return n.get(d);let u=new URL(d,window.location.href).toString(),m=fetch(u).then(async g=>{if(!g.ok)throw new Error(`\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0440\u0435\u0441\u0443\u0440\u0441 ${d}`);return g.blob()});return n.set(d,m),m},i=d=>new Promise((u,m)=>{let g=new FileReader;g.onloadend=()=>u(g.result),g.onerror=m,g.readAsDataURL(d)}),s=async d=>{let u=URL.createObjectURL(d);try{let m=await new Promise((f,h)=>{let b=new Image;b.onload=()=>f(b),b.onerror=h,b.crossOrigin="anonymous",b.src=u}),g=document.createElement("canvas");g.width=m.naturalWidth||m.width||1,g.height=m.naturalHeight||m.height||1,g.getContext("2d").drawImage(m,0,0);let y=g.toDataURL("image/webp",ab);if(!y||y==="data:,")throw new Error("Canvas returned empty webp");return y}finally{URL.revokeObjectURL(u)}},c=Array.from(t.content.querySelectorAll("img"));await Promise.all(c.map(async d=>{let u=d.getAttribute("src")||"";if(!(!u||u.startsWith("data:")))try{let m=await o(u);try{let g=await s(m);d.setAttribute("data-original-src",u),d.setAttribute("src",g)}catch(g){console.warn("WebP convert failed, fallback to base64",g);let w=await i(m);d.setAttribute("data-original-src",u),d.setAttribute("src",w)}}catch(m){console.warn("Inline image failed",u,m),r.push(u)}}));let l=Array.from(t.content.querySelectorAll("a")).filter(d=>{let u=d.getAttribute("href")||"";return!u||u.startsWith("#")||u.startsWith("mailto:")||u.startsWith("data:")?!1:d.classList.contains("attachment-link")?!0:u.startsWith("/uploads")||u.includes("/uploads/")});return await Promise.all(l.map(async d=>{let u=d.getAttribute("href")||"";if(!(!u||u.startsWith("data:")))try{let m=await o(u),g=await i(m);d.setAttribute("data-original-href",u),d.setAttribute("href",g)}catch(m){console.warn("Inline attachment failed",u,m),r.push(u)}})),{html:t.innerHTML,failures:r}}function hb({cssText:e,contentHtml:t,title:n,description:r,article:o,wordCount:i,lang:s,exportPayload:c}){let l=o.updatedAt||"",d=o.createdAt||l||"",u={"@context":"https://schema.org","@type":"Article",headline:n,description:r,dateModified:l,datePublished:d,wordCount:i,inLanguage:s||"ru"};return`
<!doctype html>
<html lang="${lt(s||"ru")}">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>${lt(n)}</title>
  <link rel="icon" href="/icons/favicon.ico" type="image/x-icon" />
  <meta name="description" content="${lt(r||n)}" />
  <meta name="x-memus-export" content="memus;v=1" />
  <meta name="robots" content="index,follow" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="${lt(n)}" />
  <meta property="og:description" content="${lt(r||n)}" />
  <meta name="twitter:card" content="summary_large_image" />
  <style>
${e}

    body.export-page {
      margin: 0;
      background: #eef2f8;
    }
    .block-children.collapsed {
      display: none;
    }
    .block {
      cursor: default;
    }
    body.export-page .title-row h1 {
      margin: 0;
    }
  
  </style>
  <script type="application/ld+json">
${JSON.stringify(u,null,2)}
  <\/script>
</head>
<body class="export-page export-static">
<div class="page">
<script type="application/json" id="memus-export">
${JSON.stringify(c||null,null,2)}
<\/script>
${t}
</div>
<script>
(() => {
  const root = document.getElementById('exportBlocksRoot');
  if (!root) return;
  const collapseIcon = { open: '${sb}', closed: '${ib}' };
  let currentId = root.querySelector('.block')?.dataset.blockId || null;

  const getParentBlock = (block) => (block?.parentElement ? block.parentElement.closest('.block') : null);

  const updateBlockView = (block, collapsed) => {
    block.dataset.collapsed = collapsed ? 'true' : 'false';
    const body = block.querySelector('.block-body');
    const noTitle = block.classList.contains('block--no-title');
    if (body && !noTitle) {
      body.classList.toggle('collapsed', collapsed);
    }
    const children = block.querySelector('.block-children');
    if (children) children.classList.toggle('collapsed', collapsed);
    const btn = block.querySelector('.collapse-btn');
    if (btn) {
      btn.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
      btn.textContent = collapsed ? collapseIcon.closed : collapseIcon.open;
    }
  };

  const collectVisible = () => {
    const result = [];
    const walk = (container) => {
      const blocks = Array.from(container.children).filter((node) => node.classList?.contains('block'));
      blocks.forEach((block) => {
        result.push(block);
        const isCollapsed = block.dataset.collapsed === 'true';
        const children = block.querySelector('.block-children');
        if (!isCollapsed && children) walk(children);
      });
    };
    walk(root);
    return result;
  };

  const setCurrent = (block) => {
    if (!block) return;
    currentId = block.dataset.blockId || null;
    root.querySelectorAll('.block.selected').forEach((el) => el.classList.remove('selected'));
    block.classList.add('selected');
    block.focus({ preventScroll: false });
  };

  const toggleBlock = (block, desired) => {
    if (!block) return;
    const collapsed = block.dataset.collapsed === 'true';
    const next = typeof desired === 'boolean' ? desired : !collapsed;
    updateBlockView(block, next);
  };

  const moveSelection = (offset) => {
    if (!currentId) {
      const first = root.querySelector('.block');
      if (first) setCurrent(first);
      return;
    }
    const ordered = collectVisible();
    const index = ordered.findIndex((b) => b.dataset.blockId === currentId);
    if (index === -1) return;
    const next = ordered[index + offset];
    if (next) setCurrent(next);
  };

  const scrollCurrentBlockStep = (direction) => {
    if (!currentId) return false;
    const el =
      root.querySelector(\`.block[data-block-id="\${currentId}"] > .block-surface\`) ||
      root.querySelector(\`.block[data-block-id="\${currentId}"]\`);
    if (!el) return false;
    const rect = el.getBoundingClientRect();
    const margin = 24;
    const visibleHeight = window.innerHeight - margin * 2;
    if (visibleHeight <= 0) return false;
    if (rect.height <= visibleHeight) return false;
    if (direction === 'down') {
      const bottomLimit = window.innerHeight - margin;
      if (rect.bottom <= bottomLimit) return false;
      const delta = rect.bottom - bottomLimit;
      const baseStep = Math.min(Math.max(delta, 40), 160);
      const step = Math.max(24, Math.round(baseStep / 3));
      window.scrollBy({ top: step, behavior: 'smooth' });
      return true;
    }
    if (direction === 'up') {
      const topLimit = margin;
      if (rect.top >= topLimit) return false;
      const delta = topLimit - rect.top;
      const baseStep = Math.min(Math.max(delta, 40), 160);
      const step = Math.max(24, Math.round(baseStep / 3));
      window.scrollBy({ top: -step, behavior: 'smooth' });
      return true;
    }
    return false;
  };

  const handleArrowLeft = () => {
    if (!currentId) return;
    const block = root.querySelector(\`.block[data-block-id="\${currentId}"]\`);
    if (!block) return;
    const collapsed = block.dataset.collapsed === 'true';
    if (!collapsed) {
      toggleBlock(block, true);
      return;
    }
    const parent = getParentBlock(block);
    if (parent) setCurrent(parent);
  };

  const handleArrowRight = () => {
    if (!currentId) return;
    const block = root.querySelector(\`.block[data-block-id="\${currentId}"]\`);
    if (!block) return;
    const collapsed = block.dataset.collapsed === 'true';
    const firstChild = block.querySelector('.block-children .block');
    if (collapsed) {
      toggleBlock(block, false);
      if (firstChild) setCurrent(firstChild);
      return;
    }
    if (firstChild) {
      setCurrent(firstChild);
    }
  };

  root.addEventListener('click', (event) => {
    const btn = event.target.closest('.collapse-btn');
    if (btn) {
      const targetId = btn.dataset.blockId;
      const block = root.querySelector(\`.block[data-block-id="\${targetId}"]\`);
      toggleBlock(block);
      setCurrent(block);
      return;
    }
    const block = event.target.closest('.block');
    if (block) {
      const isInteractive = event.target.closest('a, button, input, textarea, select');
      if (!isInteractive) {
        const header = block.querySelector('.block-header');
        const body = block.querySelector('.block-text.block-body');
        const bodyHasNoTitle = body?.classList.contains('block-body--no-title');
        const clickedInHeader = header && header.contains(event.target);
        const clickedInBody = body && body.contains(event.target);
        const hasLogicalTitle = Boolean(header && !bodyHasNoTitle);
        let shouldToggle = false;
        if (hasLogicalTitle && clickedInHeader) {
          shouldToggle = true;
        } else if (!hasLogicalTitle && clickedInBody) {
          shouldToggle = true;
        }
        if (shouldToggle) {
          toggleBlock(block);
        }
      }
      setCurrent(block);
    }
  });

  function scrollCurrentBlockStep(direction) {
    if (!currentId) return false;
    const el =
      root.querySelector('.block[data-block-id="' + currentId + '"] > .block-surface') ||
      root.querySelector('.block[data-block-id="' + currentId + '"]');
    if (!el) return false;
    const rect = el.getBoundingClientRect();
    const margin = 24;
    const visibleHeight = window.innerHeight - margin * 2;
    if (visibleHeight <= 0) return false;
    if (rect.height <= visibleHeight) return false;
    if (direction === 'down') {
      const bottomLimit = window.innerHeight - margin;
      if (rect.bottom <= bottomLimit) return false;
      const delta = rect.bottom - bottomLimit;
      const baseStep = Math.min(Math.max(delta, 40), 160);
      const step = Math.max(24, Math.round(baseStep / 3));
      window.scrollBy({ top: step, behavior: 'smooth' });
      return true;
    }
    if (direction === 'up') {
      const topLimit = margin;
      if (rect.top >= topLimit) return false;
      const deltaUp = topLimit - rect.top;
      const baseStepUp = Math.min(Math.max(deltaUp, 40), 160);
      const stepUp = Math.max(24, Math.round(baseStepUp / 3));
      window.scrollBy({ top: -stepUp, behavior: 'smooth' });
      return true;
    }
    return false;
  }

  document.addEventListener('keydown', (event) => {
    if (['ArrowDown', 'ArrowUp', 'ArrowLeft', 'ArrowRight', 'Enter', 'Space', ' '].includes(event.code)) {
      event.preventDefault();
    } else {
      return;
    }
    if (event.code === 'ArrowDown') {
      const scrolled = scrollCurrentBlockStep('down');
      if (!scrolled) moveSelection(1);
      return;
    }
    if (event.code === 'ArrowUp') {
      const scrolled = scrollCurrentBlockStep('up');
      if (!scrolled) moveSelection(-1);
      return;
    }
    if (event.code === 'ArrowLeft') {
      handleArrowLeft();
      return;
    }
    if (event.code === 'ArrowRight') {
      handleArrowRight();
      return;
    }
    if (event.code === 'Enter' || event.code === 'Space' || event.code === ' ') {
      if (!currentId) return;
      const block = root.querySelector(\`.block[data-block-id="\${currentId}"]\`);
      toggleBlock(block);
    }
  });

  const initial = currentId ? root.querySelector(\`.block[data-block-id="\${currentId}"]\`) : root.querySelector('.block');
  if (initial) setCurrent(initial);
})();
<\/script>
</body>
</html>
`}function zp(e,t){let n=new Blob([e],{type:"text/html"}),r=URL.createObjectURL(n),o=document.createElement("a");o.href=r,o.download=t,o.rel="noopener",o.click(),setTimeout(()=>URL.revokeObjectURL(r),0)}var Rp,ib,sb,ab,Vp=Fe(()=>{mt();ln();vn();Nt();Rp=160,ib="\u25B8",sb="\u25BE",ab=.82});var mm={};Wn(mm,{initGraphView:()=>_b,openGraphView:()=>pm});function Gs(){if(typeof window>"u")return null;let e=window.vis;return!e||!e.Network?null:e}function Lb(){return bi||(bi=new Promise((e,t)=>{try{if(document.querySelector('link[data-vis-network-css="1"]')){e();return}let r=document.createElement("link");r.rel="stylesheet",r.href="https://unpkg.com/vis-network@9.1.6/styles/vis-network.min.css",r.dataset.visNetworkCss="1",r.onload=()=>e(),r.onerror=()=>t(new Error("vis-network css load failed")),document.head.appendChild(r)}catch(n){t(n)}}).finally(()=>{document.querySelector('link[data-vis-network-css="1"]')||(bi=null)}),bi)}function Mb(){let e=Gs();return e?Promise.resolve(e):yi||(yi=(async()=>{if(!navigator.onLine)throw new Error("offline");await Lb(),await new Promise((n,r)=>{let o=document.createElement("script");o.src="https://unpkg.com/vis-network@9.1.6/dist/vis-network.min.js",o.async=!0,o.onload=()=>n(),o.onerror=()=>r(new Error("vis-network load failed")),document.head.appendChild(o)});let t=Gs();if(!t)throw new Error("vis-network not available");return t})().finally(()=>{Gs()||(yi=null)}),yi)}function Nb(e,t){let n=new Map;e.forEach(s=>{n.set(s,new Set)}),t.forEach(s=>{let{from:c,to:l}=s;!n.has(c)||!n.has(l)||(n.get(c).add(l),n.get(l).add(c))});let r=new Map,o=new Map,i=0;return e.forEach(s=>{if(r.has(s))return;let c=[s];r.set(s,i);let l=new Set([s]);for(;c.length;){let d=c.shift();(n.get(d)||new Set).forEach(m=>{r.has(m)||(r.set(m,i),l.add(m),c.push(m))})}o.set(i,l),i+=1}),{nodeToComp:r,compToNodes:o}}function Pb(){if(!wi)return{nodes:[],edges:[]};let e=wi.nodes||[],t=wi.edges||[],n=["#fecaca","#fde68a","#bbf7d0","#bfdbfe","#ddd6fe","#f9a8d4"],r=e.map(l=>l.id),o=t.map((l,d)=>({id:`e-${d}`,from:l.source,to:l.target})),{nodeToComp:i,compToNodes:s}=Nb(r,o);ul=i,um=s,Qs=new Map,Zs=new Map;let c=e.map(l=>{let d=l.id,u=t.filter(v=>v.source===d||v.target===d).length,m=ul.get(d)??0,g=n[m%n.length],w=a.articleId===d,y=w?"#f97316":l.public?"#0ea5e9":"#64748b",f=w?3:u>=4?2:1.5,h={size:18,color:"#111827",face:"system-ui, -apple-system, BlinkMacSystemFont, sans-serif"},b={background:g,border:y},S={background:"#e5e7eb",border:"#cbd5f5"},x={background:g,border:"#f97316"};return Qs.set(d,{color:b,dimColor:S,highlightColor:x,borderWidth:f,font:h}),{id:d,label:l.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",title:l.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",value:Math.max(1,u),shape:"dot",size:fm/2,color:b,borderWidth:f,font:h}});return o.forEach(l=>{Zs.set(l.id,{color:"#d1d5db",highlightColor:"#f97316",width:1,highlightWidth:1.5})}),{nodes:c,edges:o}}function fl(){let t=p.graphCanvas.getBoundingClientRect(),n=t.width||600,r=t.height||400;return{autoResize:!0,width:`${n}px`,height:`${r}px`,interaction:{hover:!0,tooltipDelay:80},physics:{enabled:!0,solver:"forceAtlas2Based",stabilization:{enabled:!0,iterations:300,updateInterval:30,fit:!1},forceAtlas2Based:{gravitationalConstant:-100,centralGravity:.005,springLength:fm*5,springConstant:.1,damping:.4,avoidOverlap:1},minVelocity:.7},nodes:{shape:"dot",scaling:{min:10,max:20},font:{size:14,color:"#111827",face:"system-ui, -apple-system, BlinkMacSystemFont, sans-serif",strokeWidth:2,strokeColor:"#f8fafc"}},edges:{smooth:!1,color:{color:"#d1d5db",highlight:"#f97316"}}}}function dm(e){if(!gr||!yr)return;if(e==null){let o=[];gr.forEach(s=>{let c=Qs.get(s.id);c&&o.push({id:s.id,color:c.color,borderWidth:c.borderWidth,font:c.font})}),gr.update(o);let i=[];yr.forEach(s=>{let c=Zs.get(s.id);c&&i.push({id:s.id,color:c.color,width:c.width})}),yr.update(i);return}let t=um.get(e)||new Set,n=[];gr.forEach(o=>{let i=Qs.get(o.id);if(!i)return;let s=t.has(o.id);n.push({id:o.id,color:s?i.highlightColor:i.dimColor,borderWidth:i.borderWidth,font:i.font})}),gr.update(n);let r=[];yr.forEach(o=>{let i=Zs.get(o.id);if(!i)return;let s=t.has(o.from)&&t.has(o.to);r.push({id:o.id,color:s?i.highlightColor:i.color,width:s?i.highlightWidth:i.width})}),yr.update(r)}function Db(){let e=Gs();if(!e||!p.graphCanvas){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0431\u0438\u0431\u043B\u0438\u043E\u0442\u0435\u043A\u0443 \u0433\u0440\u0430\u0444\u0430 (vis-network)");return}let{nodes:t,edges:n}=Pb();if(Pr){gr.clear(),yr.clear(),gr.add(t),yr.add(n);let r=fl();Pr.setOptions(r)}else{gr=new e.DataSet(t),yr=new e.DataSet(n);let r=fl();Pr=new e.Network(p.graphCanvas,{nodes:gr,edges:yr},r),Pr.on("click",o=>{if(!o.nodes||!o.nodes.length)return;let i=o.nodes[0];i&&bt(pt.article(i))}),Pr.on("hoverNode",o=>{let i=o.node,s=ul.get(i);s!==void 0&&dm(s)}),Pr.on("blurNode",()=>{dm(null)})}}async function pm(){if(!(!p.graphView||!p.graphCanvas)){p.articleListView&&p.articleListView.classList.add("hidden"),p.articleView&&p.articleView.classList.add("hidden"),p.articleHeader&&p.articleHeader.classList.add("hidden"),p.usersView&&p.usersView.classList.add("hidden"),p.graphView.classList.remove("hidden");try{await Mb()}catch(e){!navigator.onLine||e?.message==="offline"?L("\u0413\u0440\u0430\u0444 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0431\u0435\u0437 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430"):L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0431\u0438\u0431\u043B\u0438\u043E\u0442\u0435\u043A\u0443 \u0433\u0440\u0430\u0444\u0430 (vis-network)");return}if(!wi)try{wi=await Pe("/api/graph")}catch(e){L(e.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0434\u0430\u043D\u043D\u044B\u0435 \u0433\u0440\u0430\u0444\u0430");return}Db()}}function _b(){!p.graphView||!p.graphCanvas||!p.graphToggleBtn||(p.graphToggleBtn.addEventListener("click",()=>{pm()}),p.graphBackBtn&&p.graphBackBtn.addEventListener("click",()=>{p.graphView.classList.add("hidden"),p.articleView&&p.articleView.classList.add("hidden"),p.articleHeader&&p.articleHeader.classList.add("hidden"),p.articleListView&&p.articleListView.classList.remove("hidden")}),window.addEventListener("resize",()=>{if(!p.graphView.classList.contains("hidden")&&Pr){let e=fl();Pr.setOptions(e)}}))}var wi,Pr,gr,yr,ul,um,Qs,Zs,fm,yi,bi,hm=Fe(()=>{Mt();Ft();En();mt();Nt();wi=null,Pr=null,gr=null,yr=null,ul=new Map,um=new Map,Qs=new Map,Zs=new Map,fm=22;yi=null,bi=null});var bm={};Wn(bm,{initUsersPanel:()=>$b,openUsersPage:()=>ym});function Ob(){p.articleListView&&p.articleListView.classList.add("hidden"),p.articleView&&p.articleView.classList.add("hidden"),p.graphView&&p.graphView.classList.add("hidden"),p.articleHeader&&p.articleHeader.classList.add("hidden")}function Rb(){Ob(),p.usersView&&p.usersView.classList.remove("hidden")}function Hb(){p.usersView&&p.usersView.classList.add("hidden"),p.articleListView&&p.articleListView.classList.remove("hidden"),p.articleView&&p.articleView.classList.add("hidden"),p.articleHeader&&p.articleHeader.classList.add("hidden")}async function gm(e){if(p.usersList){p.usersList.textContent="";try{let t=await hd(e);if(!t.length){let n=document.createElement("li");n.textContent="\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439 \u043D\u0435\u0442",p.usersList.appendChild(n);return}t.forEach(n=>{let r=document.createElement("li");r.className="users-list-item";let o=document.createElement("span");if(o.className="users-list-item__info",o.textContent=`${n.username}${n.displayName&&n.displayName!==n.username?` (${n.displayName})`:""}`,n.isSuperuser){let i=document.createElement("span");i.className="users-list-item__badge",i.textContent="superuser",o.appendChild(i)}if(r.appendChild(o),!n.isSuperuser){let i=document.createElement("button");i.type="button",i.className="ghost small users-list-item__delete",i.textContent="\u0423\u0434\u0430\u043B\u0438\u0442\u044C",i.addEventListener("click",async()=>{if(window.confirm(`\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F "${n.username}" \u0441\u043E \u0432\u0441\u0435\u043C\u0438 \u0441\u0442\u0430\u0442\u044C\u044F\u043C\u0438 \u0438 \u0444\u0430\u0439\u043B\u0430\u043C\u0438?`))try{await gd(n.id),L("\u041F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044C \u0443\u0434\u0430\u043B\u0451\u043D"),await gm()}catch(c){L(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F")}}),r.appendChild(i)}p.usersList.appendChild(r)})}catch(t){let n=document.createElement("li");n.textContent=t.message||"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u0435\u0439",p.usersList.appendChild(n)}}}async function ym(e){Rb(),await gm(e)}function $b(){p.openUsersViewBtn&&p.openUsersViewBtn.addEventListener("click",async()=>{let e="";try{e=await on({title:"\u0414\u043E\u0441\u0442\u0443\u043F \u043A \u0443\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u044E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\u043C\u0438",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u0430.",confirmText:"\u041E\u0442\u043A\u0440\u044B\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"\u041F\u0430\u0440\u043E\u043B\u044C",inputType:"password"})}catch{e=""}e&&ym(e)}),p.usersBackBtn&&p.usersBackBtn.addEventListener("click",()=>{Hb()})}var wm=Fe(()=>{Mt();Ft();Nt();Vn()});var Sm={};Wn(Sm,{initTables:()=>Yb});function Fb(e){if(!e)return null;let t=e.target;return!t||!(t instanceof Element)?null:t.closest("td,th")}function zb(e){if(!e)return;let t=e.parentElement,n=t&&t.closest("table.memus-table");if(!t||!n)return;let r=n.tBodies[0]||n.createTBody(),o=Array.from(r.rows),i=o.indexOf(t),s=t.cells.length,c=document.createElement("tr");for(let l=0;l<s;l+=1){let d=document.createElement("td");d.innerHTML="&nbsp;",c.appendChild(d)}i>=0&&i<o.length-1?r.insertBefore(c,o[i+1]):r.appendChild(c)}function Ub(e){if(!e)return;let t=e.parentElement,n=t&&t.closest("table.memus-table");if(!t||!n)return;let r=n.tBodies[0];r&&(r.rows.length<=1||r.removeChild(t))}function Vb(e){if(!e)return;let t=e.closest("table.memus-table");if(!t)return;let n=e.cellIndex,r=Array.from(t.rows);r.forEach(l=>{let d=document.createElement(l.sectionRowIndex===0&&l.parentElement===t.tHead?"th":"td");d.innerHTML="&nbsp;",n>=0&&n<l.cells.length-1?l.insertBefore(d,l.cells[n+1]):l.appendChild(d)});let o=t.querySelector("colgroup");o||(o=document.createElement("colgroup"),t.insertBefore(o,t.firstChild));let i=Array.from(o.querySelectorAll("col")),s=r[0]?.cells.length||i.length+1||1;for(;i.length<s;){let l=document.createElement("col");o.appendChild(l),i=Array.from(o.querySelectorAll("col"))}let c=100/s;i.forEach(l=>{l.setAttribute("width",`${c}%`)})}function qb(e){if(!e)return;let t=e.closest("table.memus-table");if(!t)return;let n=e.cellIndex;if(n<0)return;let r=Array.from(t.rows);if(r.length&&r[0].cells.length<=1)return;r.forEach(i=>{i.cells[n]&&i.deleteCell(n)});let o=t.querySelector("colgroup");if(o){let i=Array.from(o.querySelectorAll("col"));i[n]&&i[n].remove();let s=Array.from(o.querySelectorAll("col")),c=s.length||t.tHead?.rows[0]?.cells.length||0;if(c>0){let l=100/c;if(s.length)s.forEach(d=>{d.setAttribute("width",`${l}%`)});else for(let d=0;d<c;d+=1){let u=document.createElement("col");u.setAttribute("width",`${l}%`),o.appendChild(u)}}}}function ml(){vo&&vo.parentElement&&vo.parentElement.removeChild(vo),vo=null}function Kb(e){if(ml(),!e)return;let t=e.closest("table.memus-table");if(!t)return;let n=document.createElement("div");n.className="table-toolbar";let r=(d,u)=>{let m=document.createElement("button");return m.type="button",m.className="table-toolbar-btn",m.textContent=d,u&&(m.title=u),m},o=r("+\u0441\u0442\u0440","\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0441\u0442\u0440\u043E\u043A\u0443 \u043D\u0438\u0436\u0435"),i=r("\u2212\u0441\u0442\u0440","\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0441\u0442\u0440\u043E\u043A\u0443"),s=r("+\u043A\u043E\u043B","\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u043A\u043E\u043B\u043E\u043D\u043A\u0443 \u0441\u043F\u0440\u0430\u0432\u0430"),c=r("\u2212\u043A\u043E\u043B","\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043A\u043E\u043B\u043E\u043D\u043A\u0443");o.addEventListener("click",d=>{d.preventDefault(),d.stopPropagation(),zb(e)}),i.addEventListener("click",d=>{d.preventDefault(),d.stopPropagation(),Ub(e)}),s.addEventListener("click",d=>{d.preventDefault(),d.stopPropagation(),Vb(e)}),c.addEventListener("click",d=>{d.preventDefault(),d.stopPropagation(),qb(e)}),n.appendChild(o),n.appendChild(i),n.appendChild(s),n.appendChild(c),(t.parentElement||t).insertBefore(n,t),vo=n}function Jb(e,t,n){let r=t.closest("table.memus-table");if(!r)return;let o=r.querySelector("colgroup");if(!o)return;let i=Array.from(o.querySelectorAll("col"));if(!i[n])return;let s=r.getBoundingClientRect(),c=e.clientX,l=i.map(u=>{let m=u.getAttribute("width")||"";return m.endsWith("%")&&parseFloat(m.replace("%","").trim())||0}),d=l.reduce((u,m)=>u+m,0)||100;ea={table:r,colgroup:o,cols:i,startX:c,startWidths:l,totalPercent:d,colIndex:n,tableWidthPx:s.width||1},e.preventDefault(),e.stopPropagation()}function jb(e){if(!ea)return;let{cols:t,colIndex:n,startX:r,startWidths:o,totalPercent:i,tableWidthPx:s}=ea,l=(e.clientX-r)/s*i,d=[...o],u=d[n]||i/t.length,m=n+1,g=d[m]||i/t.length,w=u+l,y=g-l,f=i*.05;if(w<f){let h=f-w;w=f,y-=h}if(y<f){let h=f-y;y=f,w-=h}d[n]=w,t[m]&&(d[m]=y),d.forEach((h,b)=>{if(t[b]){let S=h/i*100;t[b].setAttribute("width",`${S}%`)}})}function Wb(){ea=null}function pl(e){let t=e.tHead;if(!t)return;let n=t.rows[0];if(!n)return;let r=e.querySelector("colgroup");if(!r){let o=Math.max(n.cells.length||1,1),i=100/o;r=document.createElement("colgroup");for(let s=0;s<o;s+=1){let c=document.createElement("col");c.setAttribute("width",`${i.toFixed(4)}%`),r.appendChild(c)}e.insertBefore(r,t)}Array.from(n.cells).forEach((o,i)=>{let s=document.createElement("div");s.className="table-col-resize-handle",s.addEventListener("mousedown",c=>Jb(c,o,i)),o.style.position="relative",o.appendChild(s)})}function Yb(){p.articleView&&(p.articleView.addEventListener("click",t=>{let n=Fb(t);if(!n||a.mode!=="edit"||!a.editingBlockId){ml();return}if(!n.closest('[contenteditable="true"]')){ml();return}Kb(n)},!0),p.articleView.addEventListener("wheel",t=>{let n=t.target;!n||!(n instanceof Element)||n.closest("table.memus-table")&&p.blocksContainer&&(p.blocksContainer.scrollTop+=t.deltaY,t.preventDefault())},{capture:!0,passive:!1})),document.addEventListener("mousemove",jb),document.addEventListener("mouseup",Wb);let e=new MutationObserver(t=>{t.forEach(n=>{n.addedNodes.forEach(r=>{r instanceof HTMLElement&&(r.matches&&r.matches("table.memus-table")?pl(r):r.querySelectorAll?.("table.memus-table").forEach(o=>{pl(o)}))})})});p.articleView&&(e.observe(p.articleView,{childList:!0,subtree:!0}),p.articleView.querySelectorAll("table.memus-table").forEach(t=>{pl(t)}))}var vo,ea,xm=Fe(()=>{Mt();mt();vo=null;ea=null});En();mt();Mt();Kn();so();ln();Ki();mt();Mt();Ft();Nt();cn();Ki();En();Vn();var rl=!1;function kp(){p.articleTitleInput&&requestAnimationFrame(()=>{p.articleTitleInput.focus(),p.articleTitleInput.select()})}function Ks(){if(!(!a.article||!p.articleTitleInput)){if(a.isEditingTitle){kp();return}a.isEditingTitle=!0,p.articleTitleInput.value=a.article.title||"",p.articleTitle&&p.articleTitle.classList.add("hidden"),p.articleTitleInput&&p.articleTitleInput.classList.remove("hidden"),p.editTitleBtn&&p.editTitleBtn.classList.add("hidden"),kp()}}function Ap(){a.article&&(a.isEditingTitle||Ks())}function rb(){if(!a.isEditingTitle)return;a.isEditingTitle=!1,p.articleTitleInput&&a.article&&(p.articleTitleInput.value=a.article.title||"");let e=a.article?.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";p.articleTitle&&(p.articleTitle.textContent=e,p.articleTitle.classList.remove("hidden")),p.articleTitleInput&&p.articleTitleInput.classList.add("hidden"),p.editTitleBtn&&p.editTitleBtn.classList.remove("hidden")}function ob(e){if(!e)return;let t=!1;a.searchResults=a.searchResults.map(n=>n.articleId===e.id&&n.articleTitle!==e.title?(t=!0,{...n,articleTitle:e.title}):n),t&&Or()}async function Ip(){if(!a.isEditingTitle||!p.articleTitleInput||!a.articleId||!a.article)return;let e=p.articleTitleInput.value.trim(),t=(a.article.title||"").trim();if(e===t){a.isEditingTitle=!1,p.articleTitle&&(p.articleTitle.textContent=t||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",p.articleTitle.classList.remove("hidden")),p.articleTitleInput&&p.articleTitleInput.classList.add("hidden"),p.editTitleBtn&&p.editTitleBtn.classList.remove("hidden");return}if(!xi){ra(!0),p.articleTitleInput.disabled=!0;try{let n=await Pe(`/api/articles/${a.articleId}`,{method:"PATCH",body:JSON.stringify({title:e})});a.article={...a.article,title:n.title,updatedAt:n.updatedAt},On(n),a.isEditingTitle=!1;let r=a.article.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";p.articleTitle&&(p.articleTitle.textContent=r,p.articleTitle.classList.remove("hidden")),p.articleTitleInput&&(p.articleTitleInput.classList.add("hidden"),p.articleTitleInput.value=r),p.editTitleBtn&&p.editTitleBtn.classList.remove("hidden"),ob(n),L("Title saved")}catch(n){L(n.message||"Failed to save title")}finally{ra(!1),p.articleTitleInput&&(p.articleTitleInput.disabled=!1)}}}function vp(e){a.isEditingTitle&&(e.code==="Enter"?Ip():e.code==="Escape"&&rb())}function Ep(){!a.isEditingTitle||xi||Ip()}function Tp(e){!p.articleMenu||!p.articleMenuBtn||(rl=e,p.articleMenu.classList.toggle("hidden",!e),p.articleMenuBtn.setAttribute("aria-expanded",e?"true":"false"))}function Cp(e){e&&e.stopPropagation(),a.article&&Tp(!rl)}function mr(){Tp(!1)}function Bp(){return rl}async function Lp(e){if(e&&e.stopPropagation(),mr(),!a.articleId)return;if(a.articleId==="inbox"){L("\u0421\u0442\u0430\u0442\u044C\u044E Inbox \u043D\u0435\u043B\u044C\u0437\u044F \u0443\u0434\u0430\u043B\u0438\u0442\u044C");return}let t=!!(a.article?.deletedAt||a.isTrashView),n=!1;try{n=await Un({title:t?"\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0431\u0435\u0437\u0432\u043E\u0437\u0432\u0440\u0430\u0442\u043D\u043E?":"\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443?",message:t?"\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0431\u0443\u0434\u0435\u0442 \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u0431\u0435\u0437 \u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E\u0441\u0442\u0438 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F.":"\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0431\u0443\u0434\u0435\u0442 \u043F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0430 \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443.",confirmText:t?"\u0423\u0434\u0430\u043B\u0438\u0442\u044C":"\u0412 \u043A\u043E\u0440\u0437\u0438\u043D\u0443",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"})}catch{n=window.confirm(t?"\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0431\u0435\u0437\u0432\u043E\u0437\u0432\u0440\u0430\u0442\u043D\u043E?":"\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443?")}if(n)try{await _i(a.articleId,{force:t}),t?qo(a.articleId):Ka(a.articleId),a.article=null,a.articleId=null,a.currentBlockId=null,bt(pt.list),L(t?"\u0421\u0442\u0430\u0442\u044C\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u0431\u0435\u0437\u0432\u043E\u0437\u0432\u0440\u0430\u0442\u043D\u043E":"\u0421\u0442\u0430\u0442\u044C\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0430 \u0432 \u043A\u043E\u0440\u0437\u0438\u043D\u0443")}catch(r){L(r.message)}}cn();cn();Qn();En();Ft();Nt();vn();Vn();Qn();Co();Co();rr();Pn();async function Mp(){let t=(await at()).transaction(["articles","media_refs","media_assets"],"readonly"),n=t.objectStore("articles"),r=t.objectStore("media_refs"),o=t.objectStore("media_assets"),i=await ve(n.getAll()).catch(()=>[])||[],s=0,c=0;for(let y of i)!y||y.deletedAt||Number(y.encrypted||0)===0&&(s+=1,y.docJsonStr&&(c+=1));let l=await ve(r.getAll()).catch(()=>[])||[],d=new Set;for(let y of l){let f=String(y?.url||"");f&&d.add(f)}let u=0,m=0,g={notFound:0,noAccess:0,network:0,other:0};for(let y of d){let f=await ve(o.get(y)).catch(()=>null);if(f?.status==="ok"&&(u+=1),f?.status==="error"){m+=1;let h=String(f?.lastError||"");/\bHTTP\s+404\b/.test(h)?g.notFound+=1:/\bHTTP\s+(401|403)\b/.test(h)?g.noAccess+=1:/Failed to fetch/i.test(h)||/Network/i.test(h)||/timeout/i.test(h)||/ERR_/i.test(h)?g.network+=1:g.other+=1}}let w=d.size;return await ze(t),{articles:{total:s,withDoc:c},media:{total:w,ok:u,error:m,errorKinds:g}}}ks();to();mt();Mt();Kn();Kn();so();ln();cn();function ol(e){if(!e)return!1;let t=e instanceof Node?e:null;if(!t||t.nodeType!==Node.ELEMENT_NODE)return!!(e&&e.isContentEditable);let n=t.tagName;return n==="INPUT"||n==="TEXTAREA"||n==="SELECT"?!0:t.isContentEditable}function Np(e){if(!a.currentBlockId)return!1;let t=document.querySelector(`.block[data-block-id="${a.currentBlockId}"] > .block-surface`)||document.querySelector(`.block[data-block-id="${a.currentBlockId}"]`);if(!t)return!1;let n=p.blocksContainer||document.scrollingElement||document.documentElement;if(!n)return!1;let r=n.getBoundingClientRect(),o=t.getBoundingClientRect(),i=24,s=r.height-i*2;if(s<=0||o.height<=s)return!1;if(e==="down"){let c=r.bottom-i;if(o.bottom<=c)return!1;let d=o.bottom-c,u=Math.min(Math.max(d,40),160),m=Math.max(24,Math.round(u/3));return n.scrollBy({top:m,behavior:"smooth"}),!0}if(e==="up"){let c=r.top+i;if(o.top>=c)return!1;let d=c-o.top,u=Math.min(Math.max(d,40),160),m=Math.max(24,Math.round(u/3));return n.scrollBy({top:-m,behavior:"smooth"}),!0}return!1}function Pp(e){if(!a.article||ol(e.target)||a.isEditingTitle&&p.articleTitleInput&&p.articleTitleInput.contains(e.target))return;if(a.isPublicView||a.isRagView){let s=typeof e.code=="string"?e.code:"";if(s==="Enter"){e.preventDefault();return}if(e.ctrlKey&&(s==="KeyZ"||s==="KeyY"||s==="Delete"||s==="ArrowDown"||s==="ArrowUp"||s==="ArrowLeft"||s==="ArrowRight")){e.preventDefault();return}}if(Yn&&e.code==="Escape"){e.preventDefault(),sr();return}let t=typeof e.code=="string"?e.code:"",n=s=>{let c=p.blocksContainer;if(!c)return;let l=c.getBoundingClientRect(),d=24,u=Math.max(0,l.height-d*2);if(u<=0)return;let m=Math.max(40,Math.round(u*.92)),g=s==="down"?m:-m,w=Math.max(0,c.scrollHeight-c.clientHeight),y=c.scrollTop,f=Math.max(0,Math.min(y+g,w));c.scrollTop=f;let h=l.top+d,b=Array.from(c.querySelectorAll(".block[data-block-id]"));if(!b.length)return;let S=b.map(v=>{let B=v.getAttribute("data-block-id")||"",N=v.getBoundingClientRect();return{id:B,rect:N}}).filter(v=>v.id);if(!S.length)return;let x=S.find(v=>v.rect.top>=h)||null;!x&&s==="down"&&(x=S[S.length-1]),!x&&s==="up"&&(x=S[0]),f===y&&a.currentBlockId&&(s==="down"?x=S[S.length-1]:x=S[0]),x&&x.id&&(a.scrollTargetBlockId=x.id,Tn(x.id,{scrollIntoView:!1}))},r=s=>{let c=p.blocksContainer;if(!c)return;let l=Array.from(c.querySelectorAll(".block[data-block-id]"));if(!l.length)return;let u=(s==="end"?l[l.length-1]:l[0]).getAttribute("data-block-id");u&&(a.scrollTargetBlockId=u,Tn(u,{scrollIntoView:!0,scrollBehavior:"auto"}))};if(!e.ctrlKey&&!e.shiftKey&&!e.altKey&&!e.metaKey){if(t==="PageDown"){e.preventDefault(),n("down");return}if(t==="PageUp"){e.preventDefault(),n("up");return}if(t==="Home"){e.preventDefault(),r("home");return}if(t==="End"){e.preventDefault(),r("end");return}}let o=e.ctrlKey&&!e.shiftKey&&t==="KeyZ",i=e.ctrlKey&&!e.shiftKey&&t==="KeyY";if(a.pendingTextPreview){if(a.pendingTextPreview.mode==="undo"&&o){e.preventDefault(),fo();return}if(a.pendingTextPreview.mode==="redo"&&i){e.preventDefault(),po();return}if(t==="Escape"){e.preventDefault(),Zn();return}e.preventDefault();return}if(o){e.preventDefault(),fo();return}if(i){e.preventDefault(),po();return}if(e.ctrlKey&&e.shiftKey&&e.code==="ArrowDown"){e.preventDefault(),hc("down");return}if(e.ctrlKey&&e.shiftKey&&e.code==="ArrowUp"){e.preventDefault(),hc("up");return}if(e.ctrlKey&&!e.shiftKey&&e.code==="ArrowDown"){e.preventDefault();let s=a.articleId==="inbox"?"before":"after";Ar(s);return}if(e.ctrlKey&&!e.shiftKey&&e.code==="ArrowUp"){e.preventDefault();let s=a.articleId==="inbox"?"after":"before";Ar(s);return}if(e.ctrlKey&&e.code==="Delete"){e.preventDefault(),ss();return}if(e.ctrlKey&&e.code==="ArrowRight"){e.preventDefault(),Yu();return}if(e.ctrlKey&&e.code==="ArrowLeft"){e.preventDefault(),Xu();return}if(e.code==="ArrowDown"){if(!e.ctrlKey&&e.shiftKey){e.preventDefault(),Go(1);return}if(!e.ctrlKey&&!e.shiftKey){if(e.preventDefault(),!Np("down")){let c=a.articleId==="inbox"?-1:1;Xo(c)}return}}if(e.code==="ArrowUp"){if(!e.ctrlKey&&e.shiftKey){e.preventDefault(),Go(-1);return}if(!e.ctrlKey&&!e.shiftKey){if(e.preventDefault(),!Np("up")){let c=a.articleId==="inbox"?1:-1;Xo(c)}return}}if(e.code==="ArrowLeft"){e.preventDefault();let s=us(a.currentBlockId,!0);s&&(a.currentBlockId!==s&&Tn(s),Fr(s,!0));return}if(e.code==="ArrowRight"){e.preventDefault();let s=us(a.currentBlockId,!1);s&&Fr(s,!1);return}e.code==="Enter"&&(e.preventDefault(),os())}ln();Kn();so();function Dp(e){let t=typeof e.code=="string"?e.code:"",n=e.ctrlKey&&!e.shiftKey&&t==="KeyZ",r=e.ctrlKey&&!e.shiftKey&&t==="KeyY",o=e.ctrlKey&&e.shiftKey&&t==="KeyZ";if(n&&uo(-1)){e.preventDefault();return}if((r||o)&&uo(1)){e.preventDefault();return}if(e.ctrlKey&&!e.shiftKey&&e.code==="ArrowDown"){e.preventDefault(),io();return}if(e.ctrlKey&&!e.shiftKey&&e.code==="ArrowUp"){e.preventDefault(),(async()=>(await Jo(),await Ar("before")))();return}if(e.code==="Enter"&&e.ctrlKey){e.preventDefault(),Jo();return}if(e.code==="Tab"&&!e.ctrlKey&&!e.altKey&&!e.metaKey){e.preventDefault();return}if(e.ctrlKey&&e.code==="ArrowRight"){e.preventDefault(),ps({keepEditing:!0});return}if(e.ctrlKey&&e.code==="ArrowLeft"){e.preventDefault(),ms({keepEditing:!0});return}e.code==="Escape"&&(e.preventDefault(),is())}mt();Mt();En();cn();Nt();Ft();function _p(e){let{code:t,ctrlKey:n,shiftKey:r,altKey:o,metaKey:i}=e;if(o||i||!p.articleListView||p.articleListView.classList.contains("hidden")||!p.articleList)return;let s=p.articleList,c=Array.from(s.querySelectorAll("li[data-article-id]"));if(!c.length)return;let l=a.listSelectedArticleId||a.articleId,d=l&&c.findIndex(y=>y.dataset.articleId===l),u=d!=null&&d>=0?d:0,m=y=>{if(!c.length)return;u=Math.max(0,Math.min(c.length-1,u+y));let f=c[u];if(!f)return;let h=f.dataset.articleId;h&&(a.listSelectedArticleId=h,Gt(),f.scrollIntoView({block:"nearest"}))},w=(()=>{if(a.listSelectedArticleId)return a.listSelectedArticleId;if(a.articleId)return a.articleId;let y=c[0];return y?y.dataset.articleId:null})();if(w){if(!n&&!r&&(t==="ArrowDown"||t==="ArrowUp")){e.preventDefault(),m(t==="ArrowDown"?1:-1);return}if(!n&&!r&&(t==="ArrowLeft"||t==="ArrowRight")){if(!(a.articlesIndex||[]).some(h=>(h.parentId||null)===w))return;e.preventDefault(),a.listCollapsedArticleIds||(a.listCollapsedArticleIds=[]);let f=new Set(a.listCollapsedArticleIds);t==="ArrowLeft"?f.has(w)||(f.add(w),a.listCollapsedArticleIds=Array.from(f),Rr(),Gt()):t==="ArrowRight"&&f.has(w)&&(f.delete(w),a.listCollapsedArticleIds=Array.from(f),Rr(),Gt());return}if(!n&&!r&&t==="Enter"){e.preventDefault(),a.listSelectedArticleId=w,bt(pt.article(w));return}if(n&&r&&(t==="ArrowUp"||t==="ArrowDown")){e.preventDefault(),xd(w,t==="ArrowUp"?"up":"down").then(()=>ar()).then(y=>Gt(y)).catch(y=>L(y.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443"));return}if(n&&!r&&t==="ArrowRight"){e.preventDefault(),kd(w).then(()=>ar()).then(y=>Gt(y)).catch(y=>L(y.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u043D\u043E\u0441\u0442\u044C"));return}if(n&&!r&&t==="ArrowLeft"){e.preventDefault(),Ad(w).then(()=>ar()).then(y=>Gt(y)).catch(y=>L(y.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u043D\u043E\u0441\u0442\u044C"));return}}}mt();Mt();cn();function Op(){p.mobileSidebarBtn&&p.mobileSidebarBtn.addEventListener("click",e=>{e.preventDefault(),Hr(!1),an(!0)}),p.listSidebarBtn&&p.listSidebarBtn.addEventListener("click",e=>{e.preventDefault(),Hr(!1),an(!0)}),p.sidebarBackdrop&&p.sidebarBackdrop.addEventListener("click",()=>{zo()}),p.sidebar&&p.sidebar.addEventListener("click",e=>{if(!a.isSidebarMobileOpen)return;let t=e.target,n=(()=>{try{if(t&&typeof t.closest=="function")return t.closest("button");if(t&&t.parentElement&&typeof t.parentElement.closest=="function")return t.parentElement.closest("button")}catch{}return null})();n&&(n.closest(".sidebar-article-item")||p.userMenuBtn&&n===p.userMenuBtn||p.userMenu&&p.userMenu.contains(t)||p.sidebarSyncStatusPill&&(n===p.sidebarSyncStatusPill||n.id==="sidebarSyncStatusPill")||p.syncMenu&&p.syncMenu.contains(t)||p.sidebarRecentBtn&&n===p.sidebarRecentBtn||p.sidebarSearchViewToggle&&n===p.sidebarSearchViewToggle||p.searchModeToggle&&n===p.searchModeToggle||p.searchClearBtn&&n===p.searchClearBtn||zo())},!0),document.addEventListener("click",e=>{if(window.matchMedia("(min-width: 768px)").matches||!a.isSidebarMobileOpen||!p.sidebar)return;let n=e.target;p.sidebar.contains(n)||p.mobileSidebarBtn&&p.mobileSidebarBtn.contains(n)||zo()},!0)}var hr=0,Js=null,il=!1,Wp="\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043F\u043E\u0438\u0441\u043A",gb="\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F",Yp="ttree_sidebar_search_view_v1",qp=null,sl=!1;function yb(){return Promise.resolve().then(()=>(pr(),fr))}function Kp(){return Promise.resolve().then(()=>(Vp(),Up))}function Ws(e){return e==="search"?"search":"list"}function bb(){try{return Ws(localStorage.getItem(Yp)||"")}catch{return"list"}}function wb(){try{localStorage.setItem(Yp,a.sidebarSearchView||"list")}catch{}}function al(){let e=Ws(a.sidebarSearchView),t=e==="search",n=t?"\u041F\u043E\u0438\u0441\u043A":"\u0424\u0438\u043B\u044C\u0442\u0440";if(p.sidebarSearchViewToggle){p.sidebarSearchViewToggle.dataset.view=e;let r=p.sidebarSearchViewToggle.querySelector("span")||p.sidebarSearchViewToggle;r.textContent=n;let o=t?"\u041F\u0435\u0440\u0435\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0432 \u0440\u0435\u0436\u0438\u043C \u0444\u0438\u043B\u044C\u0442\u0440\u0430 \u0441\u0442\u0430\u0442\u0435\u0439":"\u041F\u0435\u0440\u0435\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0432 \u0440\u0435\u0436\u0438\u043C \u043F\u043E\u0438\u0441\u043A\u0430";p.sidebarSearchViewToggle.setAttribute("title",o),p.sidebarSearchViewToggle.setAttribute("aria-label",o),p.sidebarSearchViewToggle.classList.toggle("search-panel__toggle--active",t)}p.searchModeToggle&&p.searchModeToggle.classList.toggle("hidden",!t),t||(or(),p.ragOpenBtn&&p.ragOpenBtn.classList.add("hidden")),p.searchInput&&(p.searchInput.placeholder=t?a.searchMode==="semantic"?"\u0421\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A...":"\u041F\u043E\u0438\u0441\u043A...":"\u0424\u0438\u043B\u044C\u0442\u0440 \u0441\u0442\u0430\u0442\u0435\u0439\u2026")}function Sb(e,{persist:t=!0}={}){let n=Ws(e);a.sidebarSearchView!==n&&(a.sidebarSearchView=n,t&&wb(),a.sidebarSearchView==="list"?(a.searchQuery="",a.searchResults=[],a.searchError="",a.searchLoading=!1,a.searchRequestId=0):(a.articleFilterQuery="",kt(),ir()),hr=0,al(),p.searchInput&&p.searchInput.dispatchEvent(new Event("input",{bubbles:!0})))}function Jp(e){let t=new Map,n=[],r=c=>String(c||"").replace(/\u00a0/g," ").replace(/\r\n/g,`
`),o=(c,l=`
`)=>c.map(d=>r(d)).filter(Boolean).join(l),i=c=>{if(!c)return"";if(Array.isArray(c))return c.map(i).join("");if(c.type==="text")return r(c.text||"");if(c.type==="hardBreak")return`
`;if(c.type==="table"){let u=[];return(c.content||[]).forEach(m=>{if(m?.type!=="tableRow")return;let g=[];(m.content||[]).forEach(w=>{!w||w.type!=="tableCell"&&w.type!=="tableHeader"||g.push(i(w).trim())}),u.push(g.join("	"))}),`${u.join(`
`)}
`}let l=Array.isArray(c.content)?c.content:[],d=l.map(i).join("");if(c.type==="paragraph"||c.type==="heading")return`${d}
`;if(c.type==="bulletList")return`${l.filter(m=>m?.type==="listItem").map(m=>{let g=i(m).trimEnd();if(!g)return"";let w=g.split(`
`);return w[0]=`- ${w[0]}`,w.join(`
`)}).filter(Boolean).join(`
`)}
`;if(c.type==="orderedList"){let u=1;return`${l.filter(g=>g?.type==="listItem").map(g=>{let w=i(g).trimEnd();if(!w)return"";let y=w.split(`
`);return y[0]=`${u}. ${y[0]}`,u+=1,y.join(`
`)}).filter(Boolean).join(`
`)}
`}return d},s=c=>{if(c){if(Array.isArray(c)){c.forEach(s);return}if(c.type==="outlineSection"){let l=String(c?.attrs?.id||c?.attrs?.sectionId||""),d=(c.content||[]).find(f=>f?.type==="outlineHeading")||null,u=(c.content||[]).find(f=>f?.type==="outlineBody")||null,m=(c.content||[]).find(f=>f?.type==="outlineChildren")||null,g=r(i(d)).trim(),w=r(i(u)).trim(),y=o([g,w],`
`).trim();l&&(t.set(l,{indexText:y,label:g||l}),n.push(l)),m?.content&&s(m.content);return}c.content&&s(c.content)}};return s(e?.content||[]),{map:t,order:n}}function js(e){if(!p.semanticReindexBtn)return;let t=p.semanticReindexBtn.querySelector(".sidebar-user-menu-label");if(!t)return;if(e&&e.status==="running"){let r=Number(e.processed||0),o=Number(e.total||0),i=o>0?`${r}/${o}`:`${r}`;t.textContent=`${gb}: ${i}`;return}let n="";if(e&&e.status==="cooldown"){let r=Number(e.cooldownRemainingSeconds||0);n=r>0?` (\u0447\u0435\u0440\u0435\u0437 ${Math.ceil(r/60)} \u043C\u0438\u043D)`:" (\u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u043F\u043E\u0437\u0436\u0435)"}else e&&e.status==="completed"&&(n=` (${e.indexed||0})`);t.textContent=`${Wp}${n}`}async function xb(){if(p.semanticReindexBtn)try{let e=await fetch("/api/search/semantic/reindex/status",{method:"GET",credentials:"include"});if(!e.ok)return;let t=await e.json();js(t)}catch{}}function kb(e){let{key:t,ctrlKey:n,altKey:r,metaKey:o}=e;if(n||r||o)return!1;let i=e.target;if(ol(i)||a.sidebarSearchView!=="list"||!p.sidebar||!p.searchInput||p.sidebar.classList.contains("hidden"))return!1;let s=p.searchInput;if(t==="Escape")return!a.articleFilterQuery&&!s.value?!1:(e.preventDefault(),a.articleFilterQuery="",s.value="",hr=0,ir(),kt(),!0);if(t.length!==1)return!1;e.preventDefault();let c=Date.now(),u=(!hr||c-hr>2e3?"":s.value||a.articleFilterQuery||"")+t;s.value=u,a.articleFilterQuery=u,kt(),s.focus();try{let m=s.value.length;s.setSelectionRange(m,m)}catch{}return hr=c,!0}async function Ab(e){if(!e)return null;let t;try{t=await e.text()}catch(l){return console.error("Failed to read HTML file",l),null}let n=t.indexOf('id="memus-export"'),r=n===-1?t.indexOf("id='memus-export'"):n;if(r===-1)return null;let o=t.lastIndexOf("<script",r),i=t.indexOf("<\/script>",r);if(o===-1||i===-1)return null;let s=t.indexOf(">",o)+1;if(s===0||s>i)return null;let c=t.slice(s,i).trim();if(!c)return null;try{let l=JSON.parse(c);return!l||typeof l!="object"||l.source!=="memus"||Number(l.version||0)!==1?null:l}catch(l){return console.error("Failed to parse memus-export JSON",l),null}}async function Ib(e){if(!e)return{exists:!1,article:null};try{let t=await fetch(`/api/articles/${encodeURIComponent(e)}`,{method:"GET",credentials:"include"});if(t.status===404)return{exists:!1,article:null};if(!t.ok){let r=await t.json().catch(()=>null),o=r&&r.detail||`\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0438 \u0441\u0442\u0430\u0442\u044C\u0438 (status ${t.status})`;throw new Error(o)}return{exists:!0,article:await t.json()}}catch(t){throw console.error("Failed to check article existence",t),t}}function vb(e){let t=typeof e.lastModified=="number"&&e.lastModified>0?e.lastModified:Date.now(),n=new Date(t),r=o=>String(o).padStart(2,"0");return`ver_${n.getFullYear()}${r(n.getMonth()+1)}${r(n.getDate())}_${r(n.getHours())}${r(n.getMinutes())}${r(n.getSeconds())}`}async function jp(e,t,{allowApplyToAll:n}={allowApplyToAll:!1}){if(!e)return null;let r=await Ab(e),o=r&&r.article,i=o&&o.id||"",s=o&&o.title||e.name||"\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F",c=o&&o.createdAt||null,l=o&&o.updatedAt||null,d={exists:!1,article:null};if(i&&(d=await Ib(i).catch(g=>{throw Bt(g.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0440\u043E\u0432\u0435\u0440\u0438\u0442\u044C \u043D\u0430\u043B\u0438\u0447\u0438\u0435 \u0441\u0442\u0430\u0442\u044C\u0438"),g})),!d.exists||!i)return Ri(e);let u=t&&t.decision,m=t&&t.applyToAll;if(!u||!m){let g=await Ba({title:"\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0443\u0436\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442",message:"\u0427\u0442\u043E \u0441\u0434\u0435\u043B\u0430\u0442\u044C \u0441 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0435\u0439 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0435\u0439 \u043F\u0440\u0438 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0438?",existingTitle:d.article&&d.article.title,importedTitle:s,existingCreatedAt:d.article&&d.article.createdAt,existingUpdatedAt:d.article&&d.article.updatedAt,importedCreatedAt:c,importedUpdatedAt:l,allowApplyToAll:n});if(!g||!g.action)return null;u=g.action,m=!!g.applyToAll,t&&(t.decision=u,t.applyToAll=m)}if(u==="keep")return null;if(u==="overwrite")return Ri(e,{mode:"overwrite"});if(u==="copy"){let g=vb(e);return Ri(e,{mode:"copy",versionPrefix:g})}return null}function Xp(e){!p.listMenu||!p.listMenuBtn||(p.listMenu.classList.toggle("hidden",!e),p.listMenuBtn.setAttribute("aria-expanded",e?"true":"false"))}function Io(){!p.listMenu||!p.listMenuBtn||p.listMenu.classList.contains("hidden")||Xp(!1)}function cl(){a.sidebarSearchView=bb(),al();let e=async()=>{if(!sl){sl=!0;try{let y=Bi();a.mediaPrefetchPaused=y;let f="";try{let{total:h,ok:b,error:S}=await Rl(a.articleId);h>0&&(f=`\u041C\u0435\u0434\u0438\u0430: ${b}/${h}`,S>0&&(f+=`, \u043E\u0448\u0438\u0431\u043E\u043A: ${S}`))}catch{}!f&&y&&(f="\u041C\u0435\u0434\u0438\u0430: \u043F\u0430\u0443\u0437\u0430"),f&&y&&(f+=" (\u043F\u0430\u0443\u0437\u0430)"),a.mediaStatusText=f,An()}finally{sl=!1}}};qp||!p.mediaStatusText&&!p.mediaPrefetchToggleBtn||(e().catch(()=>{}),qp=window.setInterval(()=>{e().catch(()=>{})},2e3));let n=!1,r=0,o=0,i=!1,s=()=>{try{return window?.localStorage?.getItem?.("ttree_debug_offline_v1")==="1"}catch{return!1}},c=()=>{try{let f=String(navigator?.userAgent||"");if(!/HuaweiBrowser/i.test(f))return!1}catch{return!1}let y=Date.now();return y-o<15e3?!1:(o=y,!0)},l=(y,f)=>{try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:y,data:f})}).catch(()=>{})}catch{}},d=async()=>{if(!n&&!(!p.sidebarSyncStatusPill&&!p.offlineStatusLabel&&!p.offlineFetchBtn)){n=!0;try{c()&&l("offline.ui.tick",{t:new Date().toISOString(),serverStatus:String(a.serverStatus||""),serverStatusText:String(a.serverStatusText||""),offlineReady:!!a.offlineReady,offlineInitStatus:String(a.offlineInitStatus||""),offlineInitError:String(a.offlineInitError||""),offlineInitStartedAt:a.offlineInitStartedAt||null,buildId:(()=>{try{return String(window.__BUILD_ID__||"")}catch{return""}})(),hasOfflineStatusLabel:!!p.offlineStatusLabel});let y=(_e,it)=>{p.sidebarSyncStatusPill&&(p.sidebarSyncStatusPill.dataset.offline=_e,it&&(p.sidebarSyncStatusPill.title=it))};if(a.serverStatus==="auth"){let _e="\u0422\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044F \u0432\u0445\u043E\u0434";p.offlineStatusLabel&&(p.offlineStatusLabel.textContent=_e),p.offlineFetchBtn&&p.offlineFetchBtn.classList.add("hidden"),y("auth",`\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 ${_e}`);return}let f=(()=>{try{return navigator?.onLine!==!1}catch{return!0}})();if(a.serverStatus==="down"&&!a.offlineReady){let _e=f?"\u041D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0430 \u043A \u0441\u0435\u0440\u0432\u0435\u0440\u0443":"\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430";p.offlineStatusLabel&&(p.offlineStatusLabel.textContent=_e),p.offlineFetchBtn&&p.offlineFetchBtn.classList.add("hidden"),y("off",`\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 ${_e}`),c()&&l("offline.ui.not_ready",{t:new Date().toISOString(),reason:"server_down_no_offline",serverStatus:a.serverStatus,offlineReady:!!a.offlineReady,offlineInitStatus:String(a.offlineInitStatus||""),offlineInitError:String(a.offlineInitError||""),onLine:(()=>{try{return navigator?.onLine!==!1}catch{return null}})(),buildId:(()=>{try{return String(window.__BUILD_ID__||"")}catch{return""}})()});return}if(!a.offlineReady){let _e=String(a.offlineInitStatus||"idle"),it=String(a.offlineInitError||"").trim();if(_e==="initializing"){let nn=Number(a.offlineInitStartedAt||0)||0,G=Date.now(),ue=nn?G-nn:0;if(ue>8e3&&G-r>8e3){r=G;try{s()&&console.warn("[offline] still initializing",{ms:ue})}catch{}}p.offlineStatusLabel&&(p.offlineStatusLabel.textContent="\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0438\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0430\u0446\u0438\u044F\u2026"),p.offlineFetchBtn&&p.offlineFetchBtn.classList.add("hidden"),y("loading","\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 \u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0438\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0430\u0446\u0438\u044F\u2026"),c()&&l("offline.ui.not_ready",{t:new Date().toISOString(),reason:"initializing",initStatus:_e,offlineInitError:it,offlineInitStartedAt:a.offlineInitStartedAt||null,buildId:(()=>{try{return String(window.__BUILD_ID__||"")}catch{return""}})()});return}let Lt=it?`\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E (${it})`:"\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E";p.offlineStatusLabel&&(p.offlineStatusLabel.textContent=Lt),p.offlineFetchBtn&&p.offlineFetchBtn.classList.add("hidden"),y("off",`\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 ${Lt}`),c()&&l("offline.ui.not_ready",{t:new Date().toISOString(),reason:"not_ready",initStatus:_e,offlineInitError:it,serverStatus:a.serverStatus,onLine:(()=>{try{return navigator?.onLine!==!1}catch{return null}})(),buildId:(()=>{try{return String(window.__BUILD_ID__||"")}catch{return""}})()});return}let h=null;try{h=await Promise.race([Mp(),new Promise(_e=>setTimeout(()=>_e(null),700))])}catch{h=null}if(!h){p.offlineStatusLabel&&(p.offlineStatusLabel.textContent="\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u2026"),p.offlineFetchBtn&&p.offlineFetchBtn.classList.remove("hidden"),y("loading","\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 \u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u2026"),c()&&l("offline.ui.summary_pending",{t:new Date().toISOString(),serverStatus:a.serverStatus,offlineReady:!!a.offlineReady,buildId:(()=>{try{return String(window.__BUILD_ID__||"")}catch{return""}})()});return}let b=Number(h.articles?.total||0),S=Number(h.articles?.withDoc||0),x=Number(h.media?.total||0),v=Number(h.media?.ok||0),B=Number(h.media?.error||0),N=h.media?.errorKinds||null,z=b===0?!0:S>=b,P=x===0?!0:v>=x,W=z&&P&&B===0,q=Math.max(0,b-S),ee=Math.max(0,x-v),de=ee>0&&N&&Number(N.noAccess||0)>0&&navigator.onLine,Le=Bc?.()||null,ne=!!Le?.running,pe=Number(Le?.processed||0),je=Number(Le?.total||0),gt=Number(Le?.errors||0),Tt=String(Le?.lastError||"").trim();if(W)p.offlineStatusLabel&&(p.offlineStatusLabel.textContent="\u041E\u0444\u0444\u043B\u0430\u0439\u043D \u0440\u0435\u0436\u0438\u043C OK"),p.offlineFetchBtn&&p.offlineFetchBtn.classList.add("hidden"),y("ok","\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 \u041E\u0444\u0444\u043B\u0430\u0439\u043D OK");else{let _e=[];if(ne?(_e.push(`\u0434\u043E\u043A\u0430\u0447\u043A\u0430: ${pe}/${je||"\u2026"}`),gt>0&&_e.push(`\u043E\u0448\u0438\u0431\u043E\u043A: ${gt}`)):Tt&&_e.push(`\u043E\u0448\u0438\u0431\u043A\u0430: ${Tt}`),de&&_e.push("\u043D\u0443\u0436\u043D\u043E \u0432\u043E\u0439\u0442\u0438, \u0447\u0442\u043E\u0431\u044B \u0434\u043E\u043A\u0430\u0447\u0430\u0442\u044C \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0438"),b>0&&_e.push(`\u0441\u0442\u0430\u0442\u044C\u0438: ${S}/${b}`),x>0&&_e.push(`\u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0438: ${v}/${x}`),ee>0&&N){let Lt=Number(N.notFound||0),nn=Number(N.noAccess||0),G=Number(N.network||0);Lt>0?_e.push(`\u0431\u0438\u0442\u044B\u0435: ${Lt}`):nn>0?_e.push(`\u043D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0430: ${nn}`):G>0&&_e.push(`\u043E\u0448\u0438\u0431\u043A\u043E\u043A \u0441\u0435\u0442\u0438: ${G}`)}let it=_e.length?`\u041E\u0444\u0444\u043B\u0430\u0439\u043D: ${_e.join(" \xB7 ")}`:"\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0434\u043E\u043A\u0430\u0447\u043A\u0430\u2026";if(p.offlineStatusLabel&&(p.offlineStatusLabel.textContent=it),p.offlineFetchBtn){let Lt=!!a.mediaPrefetchPaused,nn=!ne&&!de&&(Lt||q>0||ee>0);p.offlineFetchBtn.classList.toggle("hidden",!nn);try{let G=p.offlineFetchBtn.querySelector(".sidebar-user-menu-label");G&&(Lt?G.textContent="\u0412\u043E\u0437\u043E\u0431\u043D\u043E\u0432\u0438\u0442\u044C \u0434\u043E\u043A\u0430\u0447\u043A\u0443":ee>0&&B>0?G.textContent="\u041F\u043E\u0432\u0442\u043E\u0440\u0438\u0442\u044C \u0434\u043E\u043A\u0430\u0447\u043A\u0443":G.textContent="\u0414\u043E\u043A\u0430\u0447\u0430\u0442\u044C \u0441\u0435\u0439\u0447\u0430\u0441")}catch{}}y("loading",`\u0410\u043A\u043A\u0430\u0443\u043D\u0442 \xB7 ${it}`)}}finally{n=!1}}},u=async()=>{if(!i&&p.sidebarSyncStatusPill){i=!0;try{let y=p.sidebarSyncStatusPill,f="offline";if(a.serverStatus==="auth")f="auth";else if(a.serverStatus==="ok")f="online";else try{f=navigator?.onLine===!1?"offline":"online"}catch{f="offline"}let h=null;if(a.offlineReady)try{h=await Promise.race([ql(),new Promise(x=>setTimeout(()=>x(null),300))]),Number.isFinite(Number(h))||(h=null),h=h==null?null:Number(h)||0}catch{h=null}let b=h!=null&&h>0?"dirty":"clean",S="";f==="auth"?S=h!=null&&h>0?`\u0412\u0445\u043E\u0434 \xB7 ${h}`:"\u0412\u0445\u043E\u0434":f==="online"?S=h!=null&&h>0?`\u0421\u0438\u043D\u0445\u0440\u2026 ${h}`:"\u041E\u043D\u043B\u0430\u0439\u043D":S=h!=null&&h>0?`\u041E\u0444\u0444\u043B\u0430\u0439\u043D \xB7 ${h}`:"\u041E\u0444\u0444\u043B\u0430\u0439\u043D",y.dataset.net=f,y.dataset.sync=b,y.textContent=S,y.title=h!=null&&h>0?`\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439: ${h}`:f==="online"?"\u041E\u043D\u043B\u0430\u0439\u043D: \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u043D\u043E":f==="auth"?"\u0422\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044F \u0432\u0445\u043E\u0434":"\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439 \u043D\u0435\u0442",p.syncMenuStatusLabel&&(p.syncMenuStatusLabel.textContent=f==="online"?"\u0421\u0442\u0430\u0442\u0443\u0441: \u043E\u043D\u043B\u0430\u0439\u043D":f==="auth"?"\u0421\u0442\u0430\u0442\u0443\u0441: \u0442\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044F \u0432\u0445\u043E\u0434":"\u0421\u0442\u0430\u0442\u0443\u0441: \u043E\u0444\u0444\u043B\u0430\u0439\u043D"),p.syncMenuOutboxLabel&&(p.syncMenuOutboxLabel.textContent=h==null?"\u041E\u0447\u0435\u0440\u0435\u0434\u044C: \u2014":h>0?`\u041E\u0447\u0435\u0440\u0435\u0434\u044C: ${h}`:"\u041E\u0447\u0435\u0440\u0435\u0434\u044C: \u043F\u0443\u0441\u0442\u043E")}finally{i=!1}}};d().catch(()=>{}),u().catch(()=>{}),window.setInterval(()=>{d().catch(()=>{}),u().catch(()=>{})},4e3),window.addEventListener("offline-full-pull-status",()=>{d().catch(()=>{})}),window.addEventListener("media-prefetch-paused",()=>{e().catch(()=>{}),d().catch(()=>{}),u().catch(()=>{})}),window.addEventListener("online",()=>{e().catch(()=>{}),d().catch(()=>{}),u().catch(()=>{})}),window.addEventListener("offline",()=>{e().catch(()=>{}),d().catch(()=>{}),u().catch(()=>{})}),window.addEventListener("offline-outbox-changed",()=>{u().catch(()=>{})}),p.sidebarSyncStatusPill&&p.syncMenu&&p.sidebarSyncStatusPill.addEventListener("click",y=>{y.preventDefault(),y.stopPropagation();let f=!p.syncMenu.classList.contains("hidden");try{p.userMenu?.classList.add("hidden"),p.userMenuBtn?.setAttribute("aria-expanded","false")}catch{}f?(p.syncMenu.classList.add("hidden"),p.sidebarSyncStatusPill.setAttribute("aria-expanded","false")):(p.syncMenu.classList.remove("hidden"),p.sidebarSyncStatusPill.setAttribute("aria-expanded","true"),u().catch(()=>{}),d().catch(()=>{}))}),p.mediaPrefetchToggleBtn&&p.mediaPrefetchToggleBtn.addEventListener("click",y=>{y.preventDefault(),y.stopPropagation(),Ol(),e().catch(()=>{})}),p.offlineFetchBtn&&p.offlineFetchBtn.addEventListener("click",async y=>{y.preventDefault(),y.stopPropagation();try{if(!a.offlineReady){L("Offline \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0432 \u044D\u0442\u043E\u043C \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435");return}fa(!1),Hl({maxFailCountOnly:!0}).catch(()=>{});try{Li()}catch{}ri({force:!0}),L("\u0414\u043E\u043A\u0430\u0447\u0438\u0432\u0430\u0435\u043C \u043E\u0444\u043B\u0430\u0439\u043D\u2011\u0434\u0430\u043D\u043D\u044B\u0435 \u0432 \u0444\u043E\u043D\u0435\u2026"),p.syncMenu?.classList.add("hidden"),p.sidebarSyncStatusPill?.setAttribute("aria-expanded","false"),d().catch(()=>{})}catch(f){L(f?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u0434\u043E\u043A\u0430\u0447\u043A\u0443")}}),document.addEventListener("keydown",y=>{a.isOutlineEditing||kb(y)||(a.mode==="view"?(_p(y),Pp(y)):Dp(y))}),document.addEventListener("beforeinput",y=>{if(!a.isOutlineEditing&&(y.inputType==="historyUndo"||y.inputType==="historyRedo")){if(a.mode==="edit"&&a.editingBlockId&&y.target instanceof HTMLElement&&y.target.closest('.block-text[contenteditable="true"]')){y.preventDefault();let h=y.inputType==="historyUndo"?-1:1;uo(h);return}y.preventDefault(),y.inputType==="historyUndo"?fo():po()}},!0),document.addEventListener("paste",ku),p.createArticleBtn&&p.createArticleBtn.addEventListener("click",()=>{gi(),a.isSidebarMobileOpen&&an(!1)}),p.sidebarNewArticleBtn&&p.sidebarNewArticleBtn.addEventListener("click",()=>{gi(),a.isSidebarMobileOpen&&an(!1)}),p.openInboxBtn&&p.openInboxBtn.addEventListener("click",()=>{Vs(),a.isSidebarMobileOpen&&an(!1)}),p.quickNoteAddBtn&&p.quickNoteAddBtn.addEventListener("click",()=>{qs(),a.isSidebarMobileOpen&&an(!1)}),p.backToList&&p.backToList.addEventListener("click",()=>bt(pt.list)),p.sidebarRecentBtn&&p.sidebarRecentBtn.addEventListener("click",()=>{ja()});let m=y=>{if(Ws(a.sidebarSearchView)==="search"){Ud(y);return}a.searchQuery="",a.searchResults=[],a.searchError="",a.searchLoading=!1,a.searchRequestId=0,or(),p.ragOpenBtn&&p.ragOpenBtn.classList.add("hidden"),Xi(y)};p.searchInput&&(p.searchInput.addEventListener("input",m),p.searchInput.addEventListener("focus",()=>{a.sidebarSearchView==="search"&&a.searchQuery.trim()&&Or()})),p.sidebarSearchViewToggle&&p.sidebarSearchViewToggle.addEventListener("click",y=>{y.preventDefault(),y.stopPropagation();let f=a.sidebarSearchView==="search"?"list":"search";Sb(f),p.searchInput&&p.searchInput.focus({preventScroll:!0})});let g=()=>{!p.searchClearBtn||!p.searchInput||p.searchClearBtn.classList.toggle("hidden",!(p.searchInput.value||"").trim())};p.searchInput&&(p.searchInput.addEventListener("input",g),p.searchInput.addEventListener("focus",g),g()),p.searchClearBtn&&p.searchInput&&p.searchClearBtn.addEventListener("click",y=>{y.preventDefault(),y.stopPropagation(),p.searchInput.value="",p.searchInput.focus({preventScroll:!0}),p.searchInput.dispatchEvent(new Event("input",{bubbles:!0})),g()}),p.ragOpenBtn&&p.ragOpenBtn.addEventListener("click",y=>{y.preventDefault(),y.stopPropagation(),Vd()});let w=()=>{if(!p.searchModeToggle)return;let y=a.searchMode==="semantic";p.searchModeToggle.classList.toggle("search-panel__toggle--active",y),p.searchModeToggle.dataset.mode=y?"semantic":"classic",p.searchModeToggle.setAttribute("title",y?"\u0421\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A \u0432\u043A\u043B\u044E\u0447\u0451\u043D":"\u041F\u0435\u0440\u0435\u043A\u043B\u044E\u0447\u0438\u0442\u044C\u0441\u044F \u043D\u0430 \u0441\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A"),p.searchModeToggle.setAttribute("aria-label",y?"\u0421\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A":"\u041A\u043B\u0430\u0441\u0441\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A"),al()};if(p.searchModeToggle&&(p.searchModeToggle.addEventListener("click",y=>{y.preventDefault(),y.stopPropagation(),a.searchMode=a.searchMode==="semantic"?"classic":"semantic",w(),p.searchInput&&p.searchInput.dispatchEvent(new Event("input",{bubbles:!0}))}),w()),p.editTitleBtn&&p.editTitleBtn.addEventListener("click",Ks),p.articleTitle&&(p.articleTitle.addEventListener("dblclick",Ks),p.articleTitle.addEventListener("click",Ap),p.articleTitle.draggable=!0,p.articleTitle.addEventListener("dragstart",y=>{a.articleId&&(y.dataTransfer&&(y.dataTransfer.effectAllowed="move",y.dataTransfer.setData("text/plain",a.articleId)),window.__ttreeDraggingArticleId=a.articleId)}),p.articleTitle.addEventListener("dragend",()=>{window.__ttreeDraggingArticleId=null})),p.articleMenuBtn&&p.articleMenuBtn.addEventListener("click",Cp),p.articleFavoriteBtn&&p.articleFavoriteBtn.addEventListener("click",y=>{y.stopPropagation(),!(!a.article||!a.article.id||a.article.id==="inbox")&&(oo(a.article.id),An())}),p.listMenuBtn&&p.listMenu&&(p.listMenuBtn.addEventListener("click",y=>{y.stopPropagation();let f=p.listMenu.classList.contains("hidden");Xp(f)}),document.addEventListener("click",y=>{let f=y.target;!p.listMenu||p.listMenu.classList.contains("hidden")||p.listMenu.contains(f)||p.listMenuBtn.contains(f)||Io()},!0)),p.articleEncryptionBtn&&p.articleEncryptionBtn.addEventListener("click",y=>{y.stopPropagation(),ns()}),p.articleEncryptionRemoveBtn&&p.articleEncryptionRemoveBtn.addEventListener("click",y=>{y.stopPropagation(),rs()}),p.articlePublicLinkBtn&&p.articlePublicLinkBtn.addEventListener("click",async y=>{if(y.stopPropagation(),!a.article||!a.article.publicSlug){L("\u0421\u0434\u0435\u043B\u0430\u0439\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u043E\u0439, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443");return}let f=a.article.publicSlug,h=`${window.location.origin}/p/${encodeURIComponent(f)}`;await Fi({url:h})}),p.articlePublicToggleBtn&&p.articlePublicToggleBtn.addEventListener("click",async y=>{if(y.stopPropagation(),mr(),!a.article||!a.articleId){L("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}if(!a.currentUser){L("\u041D\u0443\u0436\u043D\u043E \u0432\u043E\u0439\u0442\u0438 \u0432 \u0441\u0438\u0441\u0442\u0435\u043C\u0443");return}let f=!a.article.publicSlug;try{let b=(await Pe(`/api/articles/${a.articleId}/public`,{method:"POST",body:JSON.stringify({public:f})})).publicSlug||null;if(a.article={...a.article,publicSlug:b},p.articlePublicToggleBtn&&(p.articlePublicToggleBtn.textContent=b?"\u041E\u0442\u043C\u0435\u043D\u0438\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435":"\u0414\u0430\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435"),An(),f&&b){let S=`${window.location.origin}/p/${encodeURIComponent(b)}`;await Fi({url:S})}else f||L("\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u044B\u0439 \u0434\u043E\u0441\u0442\u0443\u043F \u043A \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0435 \u0432\u044B\u043A\u043B\u044E\u0447\u0435\u043D")}catch(h){L(h.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u044B\u0439 \u0434\u043E\u0441\u0442\u0443\u043F")}}),p.exportArticleBtn&&p.exportArticleBtn.addEventListener("click",async y=>{y.stopPropagation(),mr();try{let{exportCurrentArticleAsHtml:f}=await Kp();f?.()}catch{L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C")}}),p.saveVersionBtn&&p.saveVersionBtn.addEventListener("click",async y=>{if(y.stopPropagation(),mr(),!!a.articleId)try{let f=await on({title:"\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0432\u0435\u0440\u0441\u0438\u044E",message:"\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u0432\u0435\u0440\u0441\u0438\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u044B\u043C)",placeholder:"\u041D\u0430\u043F\u0440\u0438\u043C\u0435\u0440: \u043F\u0435\u0440\u0435\u0434 \u0440\u0435\u0444\u0430\u043A\u0442\u043E\u0440\u0438\u043D\u0433\u043E\u043C",confirmText:"\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",allowEmpty:!0});if(f===null)return;Bt("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C \u0432\u0435\u0440\u0441\u0438\u044E\u2026"),await bd(a.articleId,(f||"").trim()||null),st(),L("\u0412\u0435\u0440\u0441\u0438\u044F \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0430")}catch(f){st(),L(f?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0432\u0435\u0440\u0441\u0438\u044E")}}),p.versionsBtn&&p.versionsBtn.addEventListener("click",async y=>{if(y.stopPropagation(),mr(),!!a.articleId){if(a.article?.encrypted){L("\u0421\u0440\u0430\u0432\u043D\u0435\u043D\u0438\u0435 \u0432\u0435\u0440\u0441\u0438\u0439 \u043F\u043E\u043A\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0434\u043B\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0445 \u0441\u0442\u0430\u0442\u0435\u0439");return}try{Bt("\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0432\u0435\u0440\u0441\u0438\u0438\u2026");let f=await wd(a.articleId);st();let h=Array.isArray(f?.versions)?f.versions:[],b=await ka({versions:h});if(!b)return;let S=typeof b=="string"?{action:"restore",versionId:b}:b;if(!S||!S.versionId)return;let{action:x,versionId:v}=S;if(x==="compare"){let z=_e=>{try{let it=new Date(_e);return Number.isNaN(it.getTime())?String(_e||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(it)}catch{return String(_e||"")}},P=_e=>{let it=h.find(Lt=>String(Lt?.id||"")===String(_e));return String(it&&(it?.label||z(it?.created_at||it?.createdAt))||_e)},W=await Aa({versions:h,excludeId:v});if(!W)return;Bt("\u0421\u0440\u0430\u0432\u043D\u0438\u0432\u0430\u0435\u043C\u2026");let q=await wa(a.articleId,v),ee=q?.docJson||q?.doc_json||null,de=null,Le=`\u0412\u0435\u0440\u0441\u0438\u044F: ${P(v)}`,ne="\u0422\u0435\u043A\u0443\u0449\u0430\u044F";if(W.target==="current")de=a.article?.docJson||a.article?.doc_json||null;else{let _e=await wa(a.articleId,W.versionId);de=_e?.docJson||_e?.doc_json||null,ne=`\u0412\u0435\u0440\u0441\u0438\u044F: ${P(W.versionId)}`}st();let pe=Jp(ee||{}),je=Jp(de||{}),gt=[],Tt=new Set;pe.order.forEach(_e=>{Tt.add(_e);let it=pe.map.get(_e),Lt=je.map.get(_e);if(!Lt){gt.push({type:"removed",id:_e,label:it?.label||_e,before:it?.indexText||"",after:""});return}(it?.indexText||"")!==(Lt?.indexText||"")&&gt.push({type:"changed",id:_e,label:Lt?.label||it?.label||_e,before:it?.indexText||"",after:Lt?.indexText||""})}),je.order.forEach(_e=>{if(Tt.has(_e))return;let it=je.map.get(_e);gt.push({type:"added",id:_e,label:it?.label||_e,before:"",after:it?.indexText||""})}),await Ia({title:"\u041E\u0442\u043B\u0438\u0447\u0438\u044F",beforeTitle:Le,afterTitle:ne,changes:gt});return}if(!await Un({title:"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0432\u0435\u0440\u0441\u0438\u044E?",message:"\u0422\u0435\u043A\u0443\u0449\u0435\u0435 \u0441\u043E\u0434\u0435\u0440\u0436\u0438\u043C\u043E\u0435 \u0441\u0442\u0430\u0442\u044C\u0438 \u0431\u0443\u0434\u0435\u0442 \u0437\u0430\u043C\u0435\u043D\u0435\u043D\u043E \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0439 \u0432\u0435\u0440\u0441\u0438\u0435\u0439.",confirmText:"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"}))return;let N=!!a.isOutlineEditing;if(Bt("\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C\u2026"),await Sd(a.articleId,v),await Jt(a.articleId,{resetUndoStacks:!0}),N){let{closeOutlineEditor:z,openOutlineEditor:P}=await yb();z?.(),await P?.()}else ot();st(),L("\u0412\u0435\u0440\u0441\u0438\u044F \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0430")}catch(f){st(),L(f?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0432\u0435\u0440\u0441\u0438\u0438")}}}),p.blockHistoryBtn&&p.blockHistoryBtn.addEventListener("click",async y=>{if(y.stopPropagation(),mr(),!(!a.articleId||!a.article)){if(a.article.encrypted){L("\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0431\u043B\u043E\u043A\u043E\u0432 \u043F\u043E\u043A\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0434\u043B\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0445 \u0441\u0442\u0430\u0442\u0435\u0439");return}try{let f=a.currentBlockId||null;if(a.isOutlineEditing)try{let N=await Promise.resolve().then(()=>(pr(),fr));N?.getOutlineActiveSectionId&&(f=N.getOutlineActiveSectionId()||f)}catch{}if(!f){L("\u041D\u0435 \u0432\u044B\u0431\u0440\u0430\u043D \u0431\u043B\u043E\u043A");return}Bt("\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0438\u0441\u0442\u043E\u0440\u0438\u044E\u2026");let h=await Pe(`/api/articles/${encodeURIComponent(a.articleId)}/blocks/${encodeURIComponent(f)}/history?limit=200`);st();let S=(Array.isArray(h?.entries)?h.entries:[]).map(N=>({...N,beforePlain:String(N.beforePlain??N.before??""),afterPlain:String(N.afterPlain??N.after??"")})),x=await va({title:"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0431\u043B\u043E\u043A\u0430",entries:S,canRestore:!0,beforeTitle:"\u0414\u043E",afterTitle:"\u041F\u043E\u0441\u043B\u0435"});if(!x||x.action!=="restore"||!x.entry||!await Un({title:"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0431\u043B\u043E\u043A?",message:"\u0411\u043B\u043E\u043A \u0431\u0443\u0434\u0435\u0442 \u0437\u0430\u043C\u0435\u043D\u0451\u043D \u043D\u0430 \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u043F\u043E\u0441\u043B\u0435 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F.",confirmText:"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"}))return;if(a.isOutlineEditing){let N=await Promise.resolve().then(()=>(pr(),fr)),z={heading:x.entry.afterHeadingJson||null,body:x.entry.afterBodyJson||null};if(N?.restoreOutlineSectionFromSectionFragments){if(N.restoreOutlineSectionFromSectionFragments(f,z)){L("\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u043E (\u0431\u0443\u0434\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438)");return}if(N?.insertOutlineSectionFromSectionFragmentsAtEnd){if(!await Un({title:"\u0411\u043B\u043E\u043A \u0443\u0434\u0430\u043B\u0451\u043D",message:"\u0421\u0435\u043A\u0446\u0438\u044F \u0441 \u044D\u0442\u0438\u043C ID \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430 \u0432 \u0442\u0435\u043A\u0443\u0449\u0435\u0439 \u0441\u0442\u0430\u0442\u044C\u0435. \u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u043D\u0443\u044E \u0441\u0435\u043A\u0446\u0438\u044E \u0432 \u043A\u043E\u043D\u0435\u0446 \u0441\u0442\u0430\u0442\u044C\u0438?",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u043D\u0435\u0446",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"}))return;if(N.insertOutlineSectionFromSectionFragmentsAtEnd(f,z)){L("\u0412\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u043E \u0432 \u043A\u043E\u043D\u0435\u0446 (\u0431\u0443\u0434\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438)");return}}L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C: \u0441\u0435\u043A\u0446\u0438\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}}let B=String(x.entry.after||"");Bt("\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C\u2026"),await Pe(`/api/articles/${encodeURIComponent(a.articleId)}/blocks/${encodeURIComponent(f)}`,{method:"PATCH",body:JSON.stringify({text:B})}),st(),await Jt(a.articleId,{desiredBlockId:f,resetUndoStacks:!0}),ot(),L("\u0411\u043B\u043E\u043A \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D")}catch(f){st(),L(f?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0441\u0442\u043E\u0440\u0438\u044E \u0431\u043B\u043E\u043A\u0430")}}}),p.articleHistoryBtn&&p.articleHistoryBtn.addEventListener("click",async y=>{if(y.stopPropagation(),mr(),!(!a.articleId||!a.article)){if(a.article.encrypted){L("\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u043E\u043A\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0434\u043B\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0445 \u0441\u0442\u0430\u0442\u0435\u0439");return}try{let f=Array.isArray(a.article.history)?a.article.history:[];if(!f.length){Bt("\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0438\u0441\u0442\u043E\u0440\u0438\u044E\u2026");let b=await id(a.articleId);st(),a.article&&a.articleId&&(a.article.history=Array.isArray(b?.history)?b.history:[],a.article.redoHistory=Array.isArray(b?.redoHistory)?b.redoHistory:[],a.article.blockTrash=Array.isArray(b?.blockTrash)?b.blockTrash:[]),f=Array.isArray(a.article?.history)?a.article.history:[]}let h=f.filter(b=>b&&(b.beforeHeadingJson||b.beforeBodyJson||b.afterHeadingJson||b.afterBodyJson));await Ea({title:"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0441\u0442\u0430\u0442\u044C\u0438",entries:h,canRestore:!0,beforeTitle:"\u0414\u043E",afterTitle:"\u041F\u043E\u0441\u043B\u0435",onRestore:async b=>{try{if(!a.articleId||!a.article)return;let S=String(b?.blockId||"").trim();if(!S){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C: \u043D\u0435\u0442 ID \u0441\u0435\u043A\u0446\u0438\u0438");return}if(!await Un({title:"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C?",message:"\u0415\u0441\u043B\u0438 \u0441\u0435\u043A\u0446\u0438\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430, \u043E\u043D\u0430 \u0431\u0443\u0434\u0435\u0442 \u0432\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u0430 \u0432 \u043A\u043E\u043D\u0435\u0446 \u0441\u0442\u0430\u0442\u044C\u0438.",confirmText:"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"}))return;if(!a.isOutlineEditing){L("\u041E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 outline-\u0440\u0435\u0436\u0438\u043C, \u0447\u0442\u043E\u0431\u044B \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u0435\u043A\u0446\u0438\u044E");return}let v=await Promise.resolve().then(()=>(pr(),fr)),B={heading:b.afterHeadingJson||null,body:b.afterBodyJson||null};if(v?.restoreOutlineSectionFromSectionFragments&&v.restoreOutlineSectionFromSectionFragments(S,B)){L("\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u043E (\u0431\u0443\u0434\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438)");return}if(v?.insertOutlineSectionFromSectionFragmentsAtEnd&&v.insertOutlineSectionFromSectionFragmentsAtEnd(S,B)){L("\u0412\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u043E \u0432 \u043A\u043E\u043D\u0435\u0446 (\u0431\u0443\u0434\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438)");return}L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u0435\u043A\u0446\u0438\u044E")}catch(S){L(S?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u0435\u043A\u0446\u0438\u044E")}}})}catch(f){L(f?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0438\u0441\u0442\u043E\u0440\u0438\u044E \u0441\u0442\u0430\u0442\u044C\u0438")}}}),p.exportCurrentBlockBtn&&p.exportCurrentBlockBtn.addEventListener("click",async y=>{y.preventDefault();try{let{exportCurrentBlockAsHtml:f}=await Kp();await f?.()}catch{L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C")}}),p.exportAllHtmlZipBtn&&p.exportAllHtmlZipBtn.addEventListener("click",async y=>{y.stopPropagation(),Io();try{Bt("\u0413\u043E\u0442\u043E\u0432\u0438\u043C \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u0443\u044E \u043A\u043E\u043F\u0438\u044E (ZIP)...");let f=await fetch("/api/export/html-zip",{method:"GET"});if(!f.ok){st(),L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u0443\u044E \u043A\u043E\u043F\u0438\u044E");return}if(f.status===204){st(),L("\u041D\u0435\u0442 \u0441\u0442\u0440\u0430\u043D\u0438\u0446 \u0434\u043B\u044F \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438");return}let h=await f.blob();if(!h||h.size===0){st(),L("\u041D\u0435\u0442 \u0434\u0430\u043D\u043D\u044B\u0445 \u0434\u043B\u044F \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438 (\u043F\u0443\u0441\u0442\u043E\u0439 \u0430\u0440\u0445\u0438\u0432)");return}let b=URL.createObjectURL(h),S=document.createElement("a"),x=f.headers.get("Content-Disposition")||"",v="memus-backup.zip",B=x.match(/filename=\"?([^\";]+)\"?/i);B&&B[1]&&(v=B[1]),S.href=b,S.download=v,S.rel="noopener",document.body.appendChild(S),st(),S.click(),document.body.removeChild(S),setTimeout(()=>URL.revokeObjectURL(b),0),L("\u0420\u0435\u0437\u0435\u0440\u0432\u043D\u0430\u044F \u043A\u043E\u043F\u0438\u044F \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u0430")}catch(f){st(),L(f.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u0443\u044E \u043A\u043E\u043F\u0438\u044E")}}),p.importArticleBtn&&p.importArticleBtn.addEventListener("click",async y=>{y.stopPropagation(),Io();try{let f=document.createElement("input");f.type="file",f.accept=".html,text/html",f.multiple=!1,f.addEventListener("change",async()=>{let h=f.files&&f.files[0];if(h)try{Bt("\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0438 \u043E\u0431\u0440\u0430\u0431\u0430\u0442\u044B\u0432\u0430\u0435\u043C HTML...");let S=await jp(h,{decision:null,applyToAll:!1},{allowApplyToAll:!1});st(),S&&S.id?(bt(pt.article(S.id)),L("\u0421\u0442\u0430\u0442\u044C\u044F \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0430")):L("\u0418\u043C\u043F\u043E\u0440\u0442 \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u043B\u0441\u044F \u0431\u0435\u0437 \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u0430")}catch(b){st(),Bt(b.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C HTML")}}),f.click()}catch(f){L(f.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u0438\u043C\u043F\u043E\u0440\u0442")}}),p.importMarkdownBtn&&p.importMarkdownBtn.addEventListener("click",async y=>{y.stopPropagation(),Io();try{let f="";try{let b=window.localStorage.getItem("logseqAssetsBaseUrl")||"";f=await on({title:"\u0410\u0434\u0440\u0435\u0441 assets \u0434\u043B\u044F Markdown",message:"\u0415\u0441\u043B\u0438 \u0432 \u0444\u0430\u0439\u043B\u0435 \u0435\u0441\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0438 \u0432\u0438\u0434\u0430 ../assets/..., \u0443\u043A\u0430\u0436\u0438 \u0431\u0430\u0437\u043E\u0432\u044B\u0439 URL, \u0433\u0434\u0435 \u043B\u0435\u0436\u0430\u0442 \u044D\u0442\u0438 \u0444\u0430\u0439\u043B\u044B (\u043D\u0430\u043F\u0440\u0438\u043C\u0435\u0440 https://prismatic-salamander-2afe94.netlify.app). \u0412\u043D\u0443\u0442\u0440\u0438 \u043D\u0435\u0433\u043E \u0431\u0443\u0434\u0443\u0442 \u0438\u0441\u043A\u0430\u0442\u044C\u0441\u044F \u0444\u0430\u0439\u043B\u044B \u0432 \u043A\u043E\u0440\u043D\u0435 \u0438\u043B\u0438 \u0432 \u043F\u043E\u0434\u043F\u0430\u043F\u043A\u0435 /assets.",confirmText:"\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"https://example.netlify.app",defaultValue:b})}catch{return}if(f=(f||"").trim(),f)try{window.localStorage.setItem("logseqAssetsBaseUrl",f)}catch{}let h=document.createElement("input");h.type="file",h.accept=".md,text/markdown,text/plain",h.multiple=!1,h.addEventListener("change",async()=>{let b=h.files&&h.files[0];if(b)try{Bt("\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0438 \u043E\u0431\u0440\u0430\u0431\u0430\u0442\u044B\u0432\u0430\u0435\u043C Markdown...");let S=await vd(b,f);st(),S&&S.id?(bt(pt.article(S.id)),L("\u0421\u0442\u0430\u0442\u044C\u044F \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0430 \u0438\u0437 Markdown")):L("\u0418\u043C\u043F\u043E\u0440\u0442 \u0438\u0437 Markdown \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u043B\u0441\u044F \u0431\u0435\u0437 \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u0430")}catch(S){st(),Bt(S.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C Markdown")}}),h.click()}catch(f){L(f.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u0438\u043C\u043F\u043E\u0440\u0442 Markdown")}}),p.importBackupFolderBtn&&p.importBackupFolderBtn.addEventListener("click",async y=>{y.stopPropagation(),Io();try{let f=document.createElement("input");f.type="file",f.webkitdirectory=!0,f.multiple=!0,f.addEventListener("change",async()=>{let b=Array.from(f.files||[]).filter(v=>v.name&&v.name.toLowerCase().endsWith(".html"));if(!b.length){L("\u0412 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0439 \u043F\u0430\u043F\u043A\u0435 \u043D\u0435\u0442 HTML\u2011\u0444\u0430\u0439\u043B\u043E\u0432 Memus");return}let S={decision:null,applyToAll:!1},x=0;Bt(`\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u0443\u0435\u043C \u0438\u0437 \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438... (0 / ${b.length})`);for(let v of b){let B=await jp(v,S,{allowApplyToAll:!0});B&&B.id&&(x+=1),Bt(`\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u0443\u0435\u043C \u0438\u0437 \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438... (${x} / ${b.length})`)}st(),x>0?(L(`\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0441\u0442\u0440\u0430\u043D\u0438\u0446 \u0438\u0437 \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438: ${x}`),bt(pt.list)):L("\u0418\u043C\u043F\u043E\u0440\u0442 \u0438\u0437 \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438 \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u043B\u0441\u044F \u0431\u0435\u0437 \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u0430")}),f.click()}catch(f){L(f.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u0438\u043C\u043F\u043E\u0440\u0442 \u0438\u0437 \u0440\u0435\u0437\u0435\u0440\u0432\u043D\u043E\u0439 \u043A\u043E\u043F\u0438\u0438")}}),p.importLogseqBtn&&p.importLogseqBtn.addEventListener("click",async y=>{y.stopPropagation(),Io();try{if(!await Un({title:"\u0418\u043C\u043F\u043E\u0440\u0442 \u0438\u0437 Logseq",message:"\u0412\u0441\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0438\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B \u0441 \u0442\u0430\u043A\u0438\u043C\u0438 \u0436\u0435 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F\u043C\u0438 \u0431\u0443\u0434\u0443\u0442 \u0443\u0434\u0430\u043B\u0435\u043D\u044B \u0438 \u0437\u0430\u043C\u0435\u043D\u0435\u043D\u044B \u0432\u0435\u0440\u0441\u0438\u044F\u043C\u0438 \u0438\u0437 \u0430\u0440\u0445\u0438\u0432\u0430 Logseq. \u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C?",confirmText:"\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"}))return;let h="";try{let S=window.localStorage.getItem("logseqAssetsBaseUrl")||"";h=await on({title:"\u0410\u0434\u0440\u0435\u0441 assets \u0434\u043B\u044F Logseq",message:"\u0423\u043A\u0430\u0436\u0438 \u0431\u0430\u0437\u043E\u0432\u044B\u0439 URL, \u0433\u0434\u0435 \u043B\u0435\u0436\u0430\u0442 assets (\u043D\u0430\u043F\u0440\u0438\u043C\u0435\u0440 https://prismatic-salamander-2afe94.netlify.app). \u0412\u043D\u0443\u0442\u0440\u0438 \u043D\u0435\u0433\u043E \u0434\u043E\u043B\u0436\u043D\u044B \u0431\u044B\u0442\u044C \u0444\u0430\u0439\u043B\u044B \u0432 \u043F\u0430\u043F\u043A\u0435 /assets.",confirmText:"\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"https://example.netlify.app",defaultValue:S})}catch{return}if(h=(h||"").trim(),!h)return;try{window.localStorage.setItem("logseqAssetsBaseUrl",h)}catch{}L("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 ZIP-\u0430\u0440\u0445\u0438\u0432 Logseq \u0441 \u043F\u0430\u043F\u043A\u043E\u0439 pages/");let b=document.createElement("input");b.type="file",b.accept=".zip,application/zip",b.multiple=!1,b.addEventListener("change",async()=>{let S=b.files&&b.files[0];if(S)try{Bt("\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0438 \u043E\u0431\u0440\u0430\u0431\u0430\u0442\u044B\u0432\u0430\u0435\u043C \u0430\u0440\u0445\u0438\u0432 Logseq...");let x=await Ed(S,h);st();let v=Array.isArray(x)?x:[];v.length>0&&v[0].id?(bt(pt.article(v[0].id)),v.length===1?L("\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0430 \u0438\u0437 Logseq"):L(`\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0441\u0442\u0440\u0430\u043D\u0438\u0446 \u0438\u0437 Logseq: ${v.length}`)):L("\u0418\u043C\u043F\u043E\u0440\u0442 \u0438\u0437 Logseq \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u043B\u0441\u044F \u0431\u0435\u0437 \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u0430")}catch(x){st(),Bt(x.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0430\u0440\u0445\u0438\u0432 Logseq")}}),b.click()}catch(f){L(f.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u0438\u043C\u043F\u043E\u0440\u0442 Logseq")}}),p.deleteArticleBtn&&p.deleteArticleBtn.addEventListener("click",Lp),p.articleTitleInput&&(p.articleTitleInput.addEventListener("keydown",vp),p.articleTitleInput.addEventListener("blur",Ep)),p.hintToggleBtn&&p.hintToggleBtn.addEventListener("click",y=>{y.preventDefault(),y.stopPropagation(),window.open("/help.html","_blank","noopener,noreferrer")||Oa(y)}),p.sidebarToggle&&p.sidebarToggle.addEventListener("click",Ra),Op(),p.dragModeToggleBtn&&p.dragModeToggleBtn.addEventListener("click",()=>{$s()}),p.blocksContainer&&p.blocksContainer.addEventListener("click",y=>{if(a.mode!=="view"||!a.article||!Array.isArray(a.article.blocks)||!a.article.blocks.length||y.target.closest(".block"))return;let h=p.blocksContainer.querySelectorAll(".block[data-block-id]");if(!h.length)return;let b=h[h.length-1],S=b.getBoundingClientRect();if(y.clientY<=S.bottom+4)return;let x=b.getAttribute("data-block-id");x&&(a.currentBlockId=x,Ar("after"))}),p.articleFilterInput&&p.articleFilterInput.addEventListener("input",Xi),p.searchInput&&p.searchInput.addEventListener("keydown",y=>{if(a.sidebarSearchView!=="list")return;if(y.key==="Escape"){y.stopPropagation(),y.preventDefault(),p.searchInput.value="",a.articleFilterQuery="",ir(),kt(),hr=0,g();return}let{key:f,ctrlKey:h,altKey:b,metaKey:S}=y;if(h||b||S||f.length!==1)return;let x=Date.now();(!hr||x-hr>2e3)&&(p.searchInput.value="",a.articleFilterQuery="",kt(),g()),hr=x}),p.articleUndoBtn&&p.articleUndoBtn.addEventListener("click",y=>{y.preventDefault(),fo()}),p.articleRedoBtn&&p.articleRedoBtn.addEventListener("click",y=>{y.preventDefault(),po()}),p.deleteCurrentBlockBtn&&p.deleteCurrentBlockBtn.addEventListener("click",async y=>{y.preventDefault(),await ss()}),p.articleBlockTrashBtn&&p.articleBlockTrashBtn.addEventListener("click",async y=>{if(y.preventDefault(),!a.article||!a.articleId){L("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}let f=Array.isArray(a.article.blockTrash)?a.article.blockTrash:[];if(!f.length){L("\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432 \u043F\u0443\u0441\u0442\u0430");return}try{let h=await Ca({items:f});if(!h)return;let b=a.articleId;if(h.action==="clear"){await Pe(`/api/articles/${b}/blocks/trash/clear`,{method:"POST",body:JSON.stringify({})}),a.article&&(a.article.blockTrash=[]),L("\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432 \u043E\u0447\u0438\u0449\u0435\u043D\u0430");return}if(!h.id)return;let S=await Pe(`/api/articles/${b}/blocks/trash/restore`,{method:"POST",body:JSON.stringify({id:h.id})}),x=S&&S.block&&S.block.id||S.blockId||h.id,v=await Jt(b,{desiredBlockId:x||null,resetUndoStacks:!0});a.article=v,ot(),L("\u0411\u043B\u043E\u043A \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D \u0438\u0437 \u043A\u043E\u0440\u0437\u0438\u043D\u044B")}catch(h){L(h.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u0438\u0437 \u043A\u043E\u0440\u0437\u0438\u043D\u044B")}}),p.articleNewBlockBtn&&p.articleNewBlockBtn.addEventListener("click",y=>{if(y.preventDefault(),!a.article||!a.currentBlockId){L("\u041D\u0435\u0442 \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u0431\u043B\u043E\u043A\u0430");return}Ar("after")}),p.mergeBlocksBtn&&p.mergeBlocksBtn.addEventListener("click",async y=>{y.preventDefault(),await Fs()}),p.splitBlockBtn&&p.splitBlockBtn.addEventListener("click",async y=>{if(y.preventDefault(),a.mode!=="edit"||!a.editingBlockId){L("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0432\u043A\u043B\u044E\u0447\u0438\u0442\u0435 \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430");return}await io()}),p.insertTableBtn&&p.insertTableBtn.addEventListener("click",y=>{if(y.preventDefault(),a.mode!=="edit"||!a.editingBlockId){L("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0432\u043A\u043B\u044E\u0447\u0438\u0442\u0435 \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430");return}let f=document.querySelector(`.block[data-block-id="${a.editingBlockId}"] .block-text[contenteditable="true"]`);if(!f){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u0431\u043B\u043E\u043A \u0434\u043B\u044F \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0442\u0430\u0431\u043B\u0438\u0446\u044B");return}let h=['<table class="memus-table">',"<thead>","<tr>","<th>\u0417\u0430\u0433\u043E\u043B\u043E\u0432\u043E\u043A 1</th>","<th>\u0417\u0430\u0433\u043E\u043B\u043E\u0432\u043E\u043A 2</th>","</tr>","</thead>","<tbody>","<tr>","<td>\u042F\u0447\u0435\u0439\u043A\u0430 1</td>","<td>\u042F\u0447\u0435\u0439\u043A\u0430 2</td>","</tr>","</tbody>","</table>","<p><br /></p>"].join("");Dn(f,h),f.classList.remove("block-body--empty")}),p.articlesTabBtn&&p.articlesTabBtn.addEventListener("click",()=>Ko(!1)),p.trashTabBtn&&p.trashTabBtn.addEventListener("click",()=>Ko(!0)),p.telegramLinkBtn&&p.telegramLinkBtn.addEventListener("click",async y=>{y.preventDefault(),y.stopPropagation();try{let f=await yd(),h=f&&f.token||"";if(!h){L("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u043A\u043E\u0434 \u043F\u0440\u0438\u0432\u044F\u0437\u043A\u0438 Telegram");return}let b=`/link ${h}`;await on({title:"\u041F\u0440\u0438\u0432\u044F\u0437\u0430\u0442\u044C Telegram",message:["\u0427\u0442\u043E\u0431\u044B \u043F\u0440\u0438\u0432\u044F\u0437\u0430\u0442\u044C \u044D\u0442\u043E\u0442 \u0430\u043A\u043A\u0430\u0443\u043D\u0442 Memus \u043A \u0447\u0430\u0442\u0443 \u0432 Telegram:","","1. \u041E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0447\u0430\u0442 \u0441 \u0431\u043E\u0442\u043E\u043C.","2. \u041E\u0442\u043F\u0440\u0430\u0432\u044C\u0442\u0435 \u0435\u043C\u0443 \u044D\u0442\u0443 \u043A\u043E\u043C\u0430\u043D\u0434\u0443:","",b].join(`
`),defaultValue:b,placeholder:"/link \u2026",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",hideConfirm:!0})}catch(f){L(f.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043A\u043E\u0434 \u043F\u0440\u0438\u0432\u044F\u0437\u043A\u0438 Telegram")}}),p.userMenuBtn&&p.userMenu&&p.userMenuBtn.addEventListener("click",y=>{if(y.preventDefault(),y.stopPropagation(),!p.userMenu.classList.contains("hidden"))p.userMenu.classList.add("hidden"),p.userMenuBtn.setAttribute("aria-expanded","false");else{try{p.syncMenu?.classList.add("hidden"),p.sidebarSyncStatusPill?.setAttribute("aria-expanded","false")}catch{}p.userMenu.classList.remove("hidden"),p.userMenuBtn.setAttribute("aria-expanded","true"),xb()}}),p.semanticReindexBtn){let y=p.semanticReindexBtn.querySelector(".sidebar-user-menu-label");y&&y.textContent&&(Wp=y.textContent.trim()),p.semanticReindexBtn.addEventListener("click",async f=>{if(f.preventDefault(),f.stopPropagation(),il){L("\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F \u0443\u0436\u0435 \u0432\u044B\u043F\u043E\u043B\u043D\u044F\u0435\u0442\u0441\u044F");return}let b=window.confirm(`\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A:

OK \u2014 \u0432\u0441\u0451 \u0437\u0430\u043D\u043E\u0432\u043E (\u043F\u0435\u0440\u0435\u0441\u0447\u0438\u0442\u0430\u0442\u044C \u0432\u0441\u0435 embeddings)
\u041E\u0442\u043C\u0435\u043D\u0430 \u2014 \u0442\u043E\u043B\u044C\u043A\u043E \u043E\u0442\u0441\u0443\u0442\u0441\u0442\u0432\u0443\u044E\u0449\u0438\u0435 (\u0431\u044B\u0441\u0442\u0440\u0435\u0435)`)?"all":"missing";p.userMenu?.classList.add("hidden"),p.userMenuBtn?.setAttribute("aria-expanded","false");let S=p.semanticReindexBtn;S&&(S.disabled=!0);let x=()=>{il=!1,Js!==null&&(clearTimeout(Js),Js=null),S&&(S.disabled=!1)},v=N=>{if(!N||typeof N!="object"){Bt("\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F \u0441\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u043E\u0433\u043E \u043F\u043E\u0438\u0441\u043A\u0430...",{protect:!0});return}let z=N.status||"unknown";if(z==="running"){let P=Number(N.total||0),W=Number(N.processed||0),q=Number(N.failed||0),ee=Number(N.indexed||0),de=[];P>0?de.push(`${W}/${P}`):de.push(`${W}`),de.push(`\u0433\u043E\u0442\u043E\u0432\u043E: ${ee}`),q&&de.push(`\u043E\u0448\u0438\u0431\u043A\u0438: ${q}`),Bt(`\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F\u2026 ${de.join(" \u2022 ")}`,{protect:!0});return}if(z==="cooldown"){let P=Number(N.cooldownRemainingSeconds||0);if(P>0){let W=Math.ceil(P/60);L(`\u0421\u043B\u0438\u0448\u043A\u043E\u043C \u0447\u0430\u0441\u0442\u043E: \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0447\u0435\u0440\u0435\u0437 ~${W} \u043C\u0438\u043D`)}else L("\u0421\u043B\u0438\u0448\u043A\u043E\u043C \u0447\u0430\u0441\u0442\u043E: \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u043F\u043E\u0437\u0436\u0435");return}if(z==="completed"){L(`\u0418\u043D\u0434\u0435\u043A\u0441 \u043E\u0431\u043D\u043E\u0432\u043B\u0451\u043D: ${N.indexed||0} \u0431\u043B\u043E\u043A\u043E\u0432`);return}if(z==="cancelled"){L("\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F \u043E\u0442\u043C\u0435\u043D\u0435\u043D\u0430");return}if(z==="failed"){L(N.error||"\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F \u0437\u0430\u0432\u0435\u0440\u0448\u0438\u043B\u0430\u0441\u044C \u0441 \u043E\u0448\u0438\u0431\u043A\u043E\u0439");return}L(`\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F: ${z}`)},B=async()=>{try{let N=await fetch("/api/search/semantic/reindex/status",{method:"GET",credentials:"include"});if(!N.ok){let P=await N.text().catch(()=>"");throw new Error(P||N.statusText)}let z=await N.json();if(!z||z.status==="idle"){st({force:!0}),L("\u041F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u044F \u043D\u0435 \u0437\u0430\u043F\u0443\u0449\u0435\u043D\u0430"),x();return}if(z.status==="running"){v(z),js(z),Js=setTimeout(B,1e3);return}st({force:!0}),v(z),js(z),x()}catch(N){st({force:!0}),L(N.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u0443\u0441 \u043F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0430\u0446\u0438\u0438"),x()}};try{let N=await fetch("/api/search/semantic/reindex",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:b})});if(!N.ok){let P=await N.text().catch(()=>"");throw new Error(P||N.statusText)}let z=await N.json();if(z&&z.status==="cooldown"){v(z),x();return}il=!0,v(z),js(z),await B()}catch(N){st({force:!0}),L(N.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u0438\u043D\u0434\u0435\u043A\u0441\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0435\u043C\u0430\u043D\u0442\u0438\u0447\u0435\u0441\u043A\u0438\u0439 \u043F\u043E\u0438\u0441\u043A"),x()}})}p.telegramBotOpenBtn&&p.telegramBotOpenBtn.addEventListener("click",()=>{try{window.open("https://t.me/Memus_pro_bot","_blank","noopener,noreferrer")}catch{window.location.href="https://t.me/Memus_pro_bot"}}),p.telegramFeedbackBotOpenBtn&&p.telegramFeedbackBotOpenBtn.addEventListener("click",()=>{try{window.open("https://t.me/Memus_feedback_bot","_blank","noopener,noreferrer")}catch{window.location.href="https://t.me/Memus_feedback_bot"}}),document.addEventListener("click",y=>{if(p.searchPanel&&!p.searchPanel.contains(y.target)&&or(),Yn&&p.hintPopover&&!p.hintPopover.contains(y.target)&&!(p.hintToggleBtn&&p.hintToggleBtn.contains(y.target))&&sr(),Bp()&&p.articleMenu&&!p.articleMenu.contains(y.target)&&!(p.articleMenuBtn&&p.articleMenuBtn.contains(y.target))&&mr(),p.userMenu&&p.userMenuBtn){let f=y.target;p.userMenu.classList.contains("hidden")||p.userMenu.contains(f)||p.userMenuBtn.contains(f)||(p.userMenu.classList.add("hidden"),p.userMenuBtn.setAttribute("aria-expanded","false"))}if(p.syncMenu&&p.sidebarSyncStatusPill){let f=y.target;p.syncMenu.classList.contains("hidden")||p.syncMenu.contains(f)||p.sidebarSyncStatusPill.contains(f)||(p.syncMenu.classList.add("hidden"),p.sidebarSyncStatusPill.setAttribute("aria-expanded","false"))}})}mt();Mt();Ft();Nt();rr();ks();var Eb="ttree_debug_quick_notes_v1";function Tb(){try{return window?.localStorage?.getItem?.(Eb)==="1"}catch{return!1}}function Ys(...e){try{if(!Tb())return;console.log("[quick-notes][auth]",...e)}catch{}}var Gp=!1;function em(){if(Gp)return;Gp=!0;let e=null,t=null,n=async i=>{try{let s=String(i?.id||"").trim(),c=String(i?.text||"").trim();if(!s||!c||String(a.articleId||"")!=="inbox"||!a.article)return!1;let l=await Promise.resolve().then(()=>(pr(),fr));if(!l?.insertOutlineSectionFromPlainTextAtStart)return!1;let d=l.insertOutlineSectionFromPlainTextAtStart(s,c);return d&&Ys("inbox.inserted",{noteId:s}),!!d}catch{return!1}},r=()=>{typeof navigator<"u"&&navigator&&navigator.onLine===!1||t||(e&&clearTimeout(e),e=setTimeout(()=>{e=null;try{Ys("sync.start"),t=Promise.resolve().then(()=>(mo(),Ss)).then(i=>i.enqueuePendingQuickNotesForSync?.()).then(i=>{Ys("sync.done",i||null)}).catch(()=>{}).finally(()=>{t=null})}catch{t=null}},7e3))},o=i=>{let s=i?.detail?.note;s&&n(s).catch(()=>{}),r()};try{window.addEventListener("memus:queued-inbox-changed",o),Ys("listener.attached")}catch{}}var Qp=!1,ll=null,tm="ttree_last_user_v1",nm="ttree_offline_user_key_v1";function rm(e){try{let t=String(e?.id||"").trim();if(!t)return;window.localStorage.setItem(nm,t)}catch{}}function Cb(){try{window.localStorage.removeItem(nm)}catch{}}async function Bb(e){let t=typeof e=="number"?Math.max(0,Math.floor(e)):8e3;try{let n=typeof AbortController<"u"?new AbortController:null,r=!1,o=new Promise(c=>{setTimeout(()=>{r=!0;try{n?.abort?.()}catch{}c({status:"down",message:"timeout"})},t)}),i=(async()=>{try{let c=await fetch("/api/auth/me",{method:"GET",credentials:"include",signal:n?.signal});return r?null:c.status===401||c.status===403?{status:"auth"}:c.ok?{status:"ok",user:await c.json()}:{status:"down",message:(await c.json().catch(()=>({})))?.detail||`HTTP ${c.status}`}}catch(c){return r?null:c?.name==="AbortError"?{status:"down",message:"timeout"}:{status:"down",message:c?.message||"network"}}})(),s=await Promise.race([i,o]);return s&&typeof s=="object"?s:{status:"down",message:"timeout"}}catch(n){return{status:"down",message:n?.message||"network"}}}async function Zp(e={}){let{reason:t}=e||{};try{let n=localStorage.getItem(tm),r=n?JSON.parse(n):null;if(!r||!r.id&&!r.username)return!1;sm(r),rm(r),om(),am(),em();try{await Ei(r);try{await Promise.resolve().then(()=>(mo(),Ss)).then(o=>o.enqueuePendingQuickNotesForSync?.())}catch{}}catch(o){try{console.warn("[offline] init failed",o)}catch{}}return t&&L(`\u041E\u0444\u0444\u043B\u0430\u0439\u043D \u0440\u0435\u0436\u0438\u043C: \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 (${t})`),!0}catch{return!1}}function Xs(){p.authOverlay&&p.authOverlay.classList.remove("hidden")}function om(){p.authOverlay&&p.authOverlay.classList.add("hidden")}function im(e){p.authError&&(p.authError.textContent=e||"",p.authError.classList.toggle("hidden",!e))}function dl(e){im(""),e==="login"&&(p.authSubtitle&&(p.authSubtitle.textContent="\u0417\u0430\u0445\u043E\u0434\u0438\u0442\u0435, \u044F \u0441\u043E\u0441\u043A\u0443\u0447\u0438\u043B\u0441\u044F! :)"),p.authStorageInfo&&(p.authStorageInfo.textContent="\u0423\u0432\u0435\u0434\u043E\u043C\u043B\u0435\u043D\u0438\u0435 \u043E \u0431\u0435\u0437\u043E\u043F\u0430\u0441\u043D\u043E\u0441\u0442\u0438: \u0422\u0435\u043A\u0441\u0442\u044B \u0438 \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0438 \u0445\u0440\u0430\u043D\u044F\u0442\u0441\u044F \u043D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0430\u0445 Memus.pro, \u0438\u043D\u044B\u0435 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043D\u044B\u0435 \u0444\u0430\u0439\u043B\u044B \u0441\u043E\u0445\u0440\u0430\u043D\u044F\u044E\u0442\u0441\u044F \u043D\u0430\u043F\u0440\u044F\u043C\u0443\u044E \u043D\u0430 \u0432\u0430\u0448 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A. \u0412\u044B \u043C\u043E\u0436\u0435\u0442\u0435 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u043F\u0440\u0438\u0432\u0430\u0442\u043D\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435.",p.authStorageInfo.classList.remove("hidden")),p.authGoogleLoginBtn&&p.authGoogleLoginBtn.classList.remove("hidden"),p.authYandexLoginBtn&&p.authYandexLoginBtn.classList.remove("hidden"))}function sm(e){a.currentUser=e,rm(e);try{let n={id:e?.id||null,username:e?.username||null,displayName:e?.displayName||null,isSuperuser:!!e?.isSuperuser};(n.id||n.username)&&localStorage.setItem(tm,JSON.stringify(n))}catch{}p.currentUserLabel&&(p.currentUserLabel.textContent=e?.displayName||e?.username||"");let t=!!(e&&e.isSuperuser);p.openUsersViewBtn&&p.openUsersViewBtn.classList.toggle("hidden",!t),p.semanticReindexBtn&&p.semanticReindexBtn.classList.toggle("hidden",!t)}function am(){Qp||!ll||(Qp=!0,ll())}function cm(e){ll=e;try{window.addEventListener("memus:auth-required",()=>{try{if(navigator?.onLine===!1)return}catch{}try{a.serverStatus="auth",a.serverStatusText="auth"}catch{}dl("login"),Xs()})}catch{}p.logoutBtn&&p.logoutBtn.addEventListener("click",async()=>{try{await nd()}catch{}Cb(),a.currentUser=null,Xs(),L("\u0412\u044B \u0432\u044B\u0448\u043B\u0438 \u0438\u0437 \u0430\u043A\u043A\u0430\u0443\u043D\u0442\u0430"),window.location.reload()}),p.authGoogleLoginBtn&&p.authGoogleLoginBtn.addEventListener("click",()=>{window.location.href="/api/auth/google/login"}),p.authYandexLoginBtn&&p.authYandexLoginBtn.addEventListener("click",()=>{window.location.href="/api/auth/yandex/login"})}async function lm(){try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw a.serverStatus="down",a.serverStatusText="offline",new Error("offline");p.authSubtitle&&(p.authSubtitle.textContent="\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0431\u0430\u0437\u0443 \u0437\u043D\u0430\u043D\u0438\u0439\u2026"),p.authGoogleLoginBtn&&p.authGoogleLoginBtn.classList.add("hidden"),p.authYandexLoginBtn&&p.authYandexLoginBtn.classList.add("hidden");let e=await Bb(8e3);if(e?.status==="ok"&&e.user){a.serverStatus="ok",a.serverStatusText="",sm(e.user),om(),am(),em();try{let r=()=>import("/outline/tiptap.bundle.js").catch(()=>{});typeof requestIdleCallback=="function"?requestIdleCallback(()=>r(),{timeout:2500}):setTimeout(()=>r(),800)}catch{}(r=>{let o=!1,i=()=>{if(!o){o=!0;try{r()}catch{}}},s=setTimeout(i,1500);try{if(typeof requestIdleCallback=="function"){requestIdleCallback(()=>{try{clearTimeout(s)}catch{}i()},{timeout:3e3});return}}catch{}})(()=>{(async()=>{let r=!1,o=!1,i=setTimeout(()=>{r=!0,L("\u0418\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0438\u0440\u0443\u0435\u043C offline-\u0431\u0430\u0437\u0443\u2026 (\u043C\u043E\u0436\u0435\u0442 \u0437\u0430\u043D\u044F\u0442\u044C \u0432\u0440\u0435\u043C\u044F)")},5e3);try{await Ei(e.user);try{await Promise.resolve().then(()=>(mo(),Ss)).then(c=>c.enqueuePendingQuickNotesForSync?.())}catch{}let s=await Lc();Mc(),ri({initialIndex:s||void 0}),o=!0}catch(s){L("Offline \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0432 \u044D\u0442\u043E\u043C \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435");try{console.warn("[offline] init failed",s)}catch{}}finally{clearTimeout(i),r&&o&&L("Offline-\u0431\u0430\u0437\u0430 \u0433\u043E\u0442\u043E\u0432\u0430")}})()});return}if(e?.status==="auth"){a.serverStatus="auth",a.serverStatusText="auth",dl("login"),Xs();return}if(a.serverStatus="down",a.serverStatusText=e?.message?String(e.message):"down",await Zp({reason:"\u043D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0430 \u043A \u0441\u0435\u0440\u0432\u0435\u0440\u0443"}))return}catch{}try{if(!navigator.onLine){if(await Zp({reason:"\u043D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430"}))return;im("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430. \u041E\u0444\u0444\u043B\u0430\u0439\u043D-\u0440\u0435\u0436\u0438\u043C \u0431\u0443\u0434\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u043F\u043E\u0441\u043B\u0435 \u043F\u0435\u0440\u0432\u043E\u0433\u043E \u0432\u0445\u043E\u0434\u0430 \u043E\u043D\u043B\u0430\u0439\u043D.")}}catch{}dl("login"),Xs()}cn();Mt();try{window.__memusAppStarted=!0}catch{}function km(){try{let e=new URLSearchParams(window.location.search||""),t=e.get("profile")??e.get("perf");if(t==null)return;let n=String(t).trim().toLowerCase();if(n==="1"||n==="true"||n==="yes"||n==="on"){window.localStorage.setItem("ttree_profile_v1","1");return}(n==="0"||n==="false"||n==="no"||n==="off")&&window.localStorage.removeItem("ttree_profile_v1")}catch{}}function Am(){if("serviceWorker"in navigator)try{navigator.serviceWorker.register("/uploads-sw.js",{scope:"/",updateViaCache:"none"}).then(e=>{try{let t=e?.update?.();t&&typeof t.catch=="function"&&t.catch(()=>{})}catch{}}).catch(()=>{})}catch{}}function ta(e,t){if(!(typeof navigator<"u"&&navigator&&navigator.onLine===!1)){try{if(window?.localStorage?.getItem?.("ttree_client_log_v1")!=="1")return}catch{return}try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:e,data:t})}).catch(()=>{})}catch{}}}function Im(e,{timeout:t=3e3,fallbackDelay:n=1200}={}){try{if(typeof requestIdleCallback=="function"){requestIdleCallback(()=>e(),{timeout:t});return}}catch{}setTimeout(()=>e(),n)}function Xb(e){try{let n=new URL(String(e||""),window.location.href).searchParams.get("v");return n?String(n):""}catch{return""}}function Gb(e){try{let t=performance.getEntriesByType?.("resource")||[];for(let n=t.length-1;n>=0;n-=1){let r=t[n]?.name;if(r&&e.test(String(r)))return Xb(r)}}catch{}return""}async function Qb(){try{if(!("serviceWorker"in navigator))return null;let e=async t=>await new Promise(n=>{if(!t)return n(null);let r=new MessageChannel,o=setTimeout(()=>n(null),500);r.port1.onmessage=i=>{clearTimeout(o),n(i.data||null)};try{t.postMessage({type:"memus:get-sw-build"},[r.port2])}catch{clearTimeout(o),n(null)}});if(navigator.serviceWorker.controller)return await e(navigator.serviceWorker.controller);try{let t=await navigator.serviceWorker.getRegistration();if(t?.active)return await e(t.active)}catch{}return await new Promise(t=>{let n=new MessageChannel,r=setTimeout(()=>t(null),300);n.port1.onmessage=o=>{clearTimeout(r),t(o.data||null)},navigator.serviceWorker.controller?.postMessage?.({type:"memus:get-sw-build"},[n.port2])})}catch{return null}}async function na(){let e=document.getElementById("sidebarVersionLabel");if(e)try{let t=Gb(/\/api\.js(\?|$)/),n=await Qb(),r=n?.buildId?String(n.buildId):"";if(r){try{window.__BUILD_ID__=r}catch{}e.textContent=`v${r}`;return}t&&(e.textContent=`api v${t}`)}catch{}}try{"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("controllerchange",()=>{na().catch(()=>{})})}catch{}function vm(){if(!p.graphToggleBtn)return;let e=null,t=async()=>{e||(e=Promise.resolve().then(()=>(hm(),mm)).then(n=>{p.graphToggleBtn?.removeEventListener("click",t,!0),n.initGraphView?.(),n.openGraphView?.()}).catch(()=>{}).finally(()=>{e=null}))};p.graphToggleBtn.addEventListener("click",t,!0)}function Zb(){if(!p.openUsersViewBtn)return;let e=null,t=async()=>{e||(e=Promise.resolve().then(()=>(wm(),bm)).then(n=>{p.openUsersViewBtn?.removeEventListener("click",t,!0),n.initUsersPanel?.(),setTimeout(()=>p.openUsersViewBtn?.click(),0)}).catch(()=>{}).finally(()=>{e=null}))};p.openUsersViewBtn.addEventListener("click",t,!0)}Im(()=>na(),{timeout:1500,fallbackDelay:50});setTimeout(()=>na(),3e3);try{navigator?.serviceWorker?.addEventListener?.("controllerchange",()=>na())}catch{}function ew(){km(),ta("app.start",{ua:navigator.userAgent}),Am(),nl(),cl(),pu(),vm(),Zb(),Im(()=>{Promise.resolve().then(()=>(xm(),Sm)).then(e=>e.initTables?.()).catch(()=>{})}),Ao(window.location.pathname)}function tw(){km(),ta("app.public.start",{ua:navigator.userAgent,path:window.location.pathname}),p.authOverlay&&p.authOverlay.classList.add("hidden"),Am(),nl(),cl(),vm(),Ao(window.location.pathname)}async function nw(){if(/^\/p\/[^/?#]+/.test(window.location.pathname)){tw();return}ta("auth.bootstrap.start",{ua:navigator.userAgent}),cm(ew),await lm(),ta("auth.bootstrap.done",{ua:navigator.userAgent})}nw().catch(()=>{});
