var fu=Object.defineProperty;var Xe=(e,t)=>()=>(e&&(t=e(e=0)),t);var $o=(e,t)=>{for(var n in t)fu(e,n,{get:t[n],enumerable:!0})};function Ua(e){Yi=e}var d,Yi,Pt=Xe(()=>{d={mode:"view",serverStatus:"unknown",serverStatusText:"",offlineReady:!1,offlineInitStatus:"idle",offlineInitError:"",offlineInitStartedAt:null,mediaStatusText:"",mediaPrefetchPaused:!1,isOutlineEditing:!1,outlineStatusText:"",isPublicView:!1,isRagView:!1,currentUser:null,articleId:null,article:null,currentBlockId:null,editingBlockId:null,selectionAnchorBlockId:null,selectedBlockIds:[],undoStack:[],redoStack:[],pendingTextPreview:null,editingUndo:null,editingInitialText:"",searchQuery:"",searchResults:[],searchError:"",searchLoading:!1,searchRequestId:0,searchMode:"classic",sidebarSearchView:"list",ragQuery:"",ragResults:[],ragBlockMap:{},ragSummaryHtml:"",ragSummaryLoading:!1,ragSummaryError:"",scrollTargetBlockId:null,pendingEditBlockId:null,isEditingTitle:!1,isSidebarCollapsed:!1,isSidebarMobileOpen:!1,articlesIndex:[],deletedArticlesIndex:[],articleFilterQuery:"",isMarkdownInserting:!1,isTrashView:!1,favoriteArticles:[],sidebarArticlesMode:"tree",recentArticleIds:[],sidebarSelectedArticleId:null,listSelectedArticleId:null,sidebarCollapsedArticleIds:[],listCollapsedArticleIds:[],isDragModeEnabled:!1,articleEncryptionKeys:{},isMergingBlocks:!1,isMovingBlock:!1,isDeletingBlock:!1,moveQueue:[],isMoveQueueProcessing:!1,editingScrollTop:null,editingCaretPosition:"start",outboxCount:null,offlineArticlesWithDoc:null,offlineArticlesTotal:null},Yi=!1});var V,Cn=Xe(()=>{V={authOverlay:document.getElementById("authOverlay"),authLoginTab:document.getElementById("authLoginTab"),authRegisterTab:document.getElementById("authRegisterTab"),authLoginForm:document.getElementById("authLoginForm"),authRegisterForm:document.getElementById("authRegisterForm"),authLoginUsername:document.getElementById("authLoginUsername"),authLoginPassword:document.getElementById("authLoginPassword"),authRegisterUsername:document.getElementById("authRegisterUsername"),authRegisterPassword:document.getElementById("authRegisterPassword"),authRegisterDisplayName:document.getElementById("authRegisterDisplayName"),authError:document.getElementById("authError"),authSubtitle:document.getElementById("authSubtitle"),authGoogleLoginBtn:document.getElementById("authGoogleLoginBtn"),authYandexLoginBtn:document.getElementById("authYandexLoginBtn"),authStorageInfo:document.getElementById("authStorageInfo"),currentUserLabel:document.getElementById("currentUserLabel"),logoutBtn:document.getElementById("logoutBtn"),userMenuBtn:document.getElementById("userMenuBtn"),userMenu:document.getElementById("userMenu"),sidebarSyncStatusPill:document.getElementById("sidebarSyncStatusPill"),syncMenu:document.getElementById("syncMenu"),syncMenuStatusLabel:document.getElementById("syncMenuStatusLabel"),syncMenuArticlesLabel:document.getElementById("syncMenuArticlesLabel"),syncMenuOutboxLabel:document.getElementById("syncMenuOutboxLabel"),offlineStatusItem:document.getElementById("offlineStatusItem"),offlineStatusLabel:document.getElementById("offlineStatusLabel"),offlineFetchBtn:document.getElementById("offlineFetchBtn"),offlineRepairBtn:document.getElementById("offlineRepairBtn"),telegramLinkBtn:document.getElementById("telegramLinkBtn"),telegramBotOpenBtn:document.getElementById("telegramBotOpenBtn"),telegramFeedbackBotOpenBtn:document.getElementById("telegramFeedbackBotOpenBtn"),openUsersViewBtn:document.getElementById("openUsersViewBtn"),usersView:document.getElementById("usersView"),usersList:document.getElementById("usersList"),usersBackBtn:document.getElementById("usersBackBtn"),graphView:document.getElementById("graphView"),graphCanvas:document.getElementById("graphCanvas"),graphBackBtn:document.getElementById("graphBackBtn"),articleListView:document.getElementById("articleListView"),articleView:document.getElementById("articleView"),articleHeader:document.getElementById("articleHeader"),articleTitle:document.getElementById("articleTitle"),updatedAt:document.getElementById("updatedAt"),articleStatusText:document.getElementById("articleStatusText"),mediaStatusText:document.getElementById("mediaStatusText"),mediaPrefetchToggleBtn:document.getElementById("mediaPrefetchToggleBtn"),blocksContainer:document.getElementById("blocksContainer"),articleList:document.getElementById("articleList"),createArticleBtn:document.getElementById("createArticleBtn"),backToList:document.getElementById("backToList"),toast:document.getElementById("toast"),searchInput:document.getElementById("searchInput"),searchClearBtn:document.getElementById("searchClearBtn"),searchResults:document.getElementById("searchResults"),searchPanel:document.querySelector(".search-panel"),searchModeToggle:document.getElementById("searchModeToggle"),sidebarSearchViewToggle:document.getElementById("sidebarSearchViewToggle"),ragOpenBtn:document.getElementById("ragOpenBtn"),articleTitleInput:document.getElementById("articleTitleInput"),editTitleBtn:document.getElementById("editTitleBtn"),hintToggleBtn:document.getElementById("hintToggleBtn"),hintPopover:document.getElementById("hintPopover"),sidebar:document.getElementById("sidebar"),sidebarToggle:document.getElementById("sidebarToggle"),sidebarArticleList:document.getElementById("sidebarArticleList"),sidebarNewArticleBtn:document.getElementById("sidebarNewArticleBtn"),sidebarRecentBtn:document.getElementById("sidebarRecentBtn"),openInboxBtn:document.getElementById("openInboxBtn"),quickNoteAddBtn:document.getElementById("quickNoteAddBtn"),articleFilterInput:document.getElementById("articleFilterInput"),trashTabBtn:document.getElementById("trashTabBtn"),articlesTabBtn:document.getElementById("articlesTabBtn"),semanticReindexBtn:document.getElementById("semanticReindexBtn"),graphToggleBtn:document.getElementById("graphToggleBtn"),listMenuBtn:document.getElementById("listMenuBtn"),listMenu:document.getElementById("listMenu"),articleMenuBtn:document.getElementById("articleMenuBtn"),articleMenu:document.getElementById("articleMenu"),articleFavoriteBtn:document.getElementById("articleFavoriteBtn"),articlePublicLinkBtn:document.getElementById("articlePublicLinkBtn"),articlePublicToggleBtn:document.getElementById("articlePublicToggleBtn"),articleEncryptionBtn:document.getElementById("articleEncryptionBtn"),articleEncryptionRemoveBtn:document.getElementById("articleEncryptionRemoveBtn"),deleteArticleBtn:document.getElementById("deleteArticleBtn"),exportArticleBtn:document.getElementById("exportArticleBtn"),outlineEditBtn:document.getElementById("outlineEditBtn"),saveVersionBtn:document.getElementById("saveVersionBtn"),versionsBtn:document.getElementById("versionsBtn"),blockHistoryBtn:document.getElementById("blockHistoryBtn"),articleHistoryBtn:document.getElementById("articleHistoryBtn"),exportAllHtmlZipBtn:document.getElementById("exportAllHtmlZipBtn"),importArticleBtn:document.getElementById("importArticleBtn"),importMarkdownBtn:document.getElementById("importMarkdownBtn"),importLogseqBtn:document.getElementById("importLogseqBtn"),importBackupFolderBtn:document.getElementById("importBackupFolderBtn"),articleUndoBtn:document.getElementById("articleUndoBtn"),articleRedoBtn:document.getElementById("articleRedoBtn"),mergeBlocksBtn:document.getElementById("mergeBlocksBtn"),splitBlockBtn:document.getElementById("splitBlockBtn"),insertTableBtn:document.getElementById("insertTableBtn"),deleteCurrentBlockBtn:document.getElementById("deleteCurrentBlockBtn"),exportCurrentBlockBtn:document.getElementById("exportCurrentBlockBtn"),articleBlockTrashBtn:document.getElementById("articleBlockTrashBtn"),articleNewBlockBtn:document.getElementById("articleNewBlockBtn"),articleToolbar:document.getElementById("articleToolbar"),outlineToolbar:document.getElementById("outlineToolbar"),outlineTagsBar:document.getElementById("outlineTagsBar"),outlineUndoBtn:document.getElementById("outlineUndoBtn"),outlineRedoBtn:document.getElementById("outlineRedoBtn"),outlineDeleteBtn:document.getElementById("outlineDeleteBtn"),outlineMoveUpBtn:document.getElementById("outlineMoveUpBtn"),outlineMoveDownBtn:document.getElementById("outlineMoveDownBtn"),outlineOutdentBtn:document.getElementById("outlineOutdentBtn"),outlineIndentBtn:document.getElementById("outlineIndentBtn"),outlineNewBelowBtn:document.getElementById("outlineNewBelowBtn"),outlineBoldBtn:document.getElementById("outlineBoldBtn"),outlineBulletListBtn:document.getElementById("outlineBulletListBtn"),outlineOrderedListBtn:document.getElementById("outlineOrderedListBtn"),outlineBlockquoteBtn:document.getElementById("outlineBlockquoteBtn"),outlineCodeBtn:document.getElementById("outlineCodeBtn"),outlineInsertTableBtn:document.getElementById("outlineInsertTableBtn"),outlineDeleteTableBtn:document.getElementById("outlineDeleteTableBtn"),outlineAddRowBtn:document.getElementById("outlineAddRowBtn"),outlineAddColBtn:document.getElementById("outlineAddColBtn"),pasteProgress:document.getElementById("pasteProgress"),mobileSidebarBtn:document.getElementById("mobileSidebarBtn"),sidebarBackdrop:document.getElementById("sidebarBackdrop"),dragModeToggleBtn:document.getElementById("dragModeToggleBtn"),listSidebarBtn:document.getElementById("listSidebarBtn"),outlineEditor:document.getElementById("outlineEditor")}});function qa(){ao!==null&&(clearTimeout(ao),ao=null)}function Xi(e){Gi=!!e,V.toast&&(Gi?V.toast.dataset.protected="true":V.toast.removeAttribute("data-protected"))}function Ee(e,t={}){if(!V.toast)return;let n=typeof t.duration=="number"?t.duration:2500;t.protect?Xi(!0):Xi(!1),qa(),V.toast.textContent=e,V.toast.classList.remove("hidden"),requestAnimationFrame(()=>{V.toast.classList.add("show")}),n>0&&(ao=setTimeout(()=>{V.toast.classList.remove("show"),setTimeout(()=>V.toast.classList.add("hidden"),200),ao=null},n))}function Qi(e,t={}){Ee(e,{...t,duration:0})}function Sr(e={}){V.toast&&(Gi&&!e.force||(qa(),Xi(!1),V.toast.classList.remove("show"),V.toast.classList.add("hidden")))}var ao,Gi,rn=Xe(()=>{Cn();ao=null,Gi=!1;V.toast&&V.toast.addEventListener("click",()=>{Sr()})});function He(e){return new Promise((t,n)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error||new Error("IndexedDB request failed"))})}function Dr(e,t,n={}){let r=t instanceof Error?t:new Error(String(t?.message||t||"IndexedDB error"));try{r.idbKind=String(e||"unknown"),r.cause=t,r.extra=n}catch{}return r}function Ze(e){return new Promise((t,n)=>{e.oncomplete=()=>t(),e.onabort=()=>n(e.error||new Error("IndexedDB transaction aborted")),e.onerror=()=>n(e.error||new Error("IndexedDB transaction failed"))})}function pu(e){return String(e||"anon").replace(/[^a-zA-Z0-9_-]/g,"_")}function mu(e){return`memus_offline_v1_${pu(e)}`}function gu(e){try{let t=String(e||"").trim();if(!t)return;let n=window?.localStorage?.getItem?.(Ka)||"[]",r=JSON.parse(n),o=Array.isArray(r)?r:[];o.includes(t)||o.push(t),window.localStorage.setItem(Ka,JSON.stringify(o.slice(-200)))}catch{}}async function Va({userKey:e}={}){let t=e||"anon";gu(t);let n=mu(t);if(typeof indexedDB>"u"){let a=new Error("IndexedDB is not available in this browser");throw a.name="IDBNotSupportedError",Dr("no_idb",a,{name:n})}let r=indexedDB.open(n,hu),o=3e3,i=!1;r.onblocked=()=>{i=!0},r.onupgradeneeded=()=>{let a=r.result;if(a.objectStoreNames.contains("meta")||a.createObjectStore("meta",{keyPath:"key"}),!a.objectStoreNames.contains("articles")){let c=a.createObjectStore("articles",{keyPath:"id"});c.createIndex("byUpdatedAt","updatedAt",{unique:!1}),c.createIndex("byDeletedAt","deletedAt",{unique:!1})}if(!a.objectStoreNames.contains("outline_sections")){let c=a.createObjectStore("outline_sections",{keyPath:"sectionId"});c.createIndex("byArticleId","articleId",{unique:!1}),c.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!a.objectStoreNames.contains("section_embeddings")){let c=a.createObjectStore("section_embeddings",{keyPath:"sectionId"});c.createIndex("byArticleId","articleId",{unique:!1}),c.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!a.objectStoreNames.contains("media_assets")){let c=a.createObjectStore("media_assets",{keyPath:"url"});c.createIndex("byStatus","status",{unique:!1}),c.createIndex("byFetchedAtMs","fetchedAtMs",{unique:!1}),c.createIndex("byStatusFetchedAtMs",["status","fetchedAtMs"],{unique:!1})}if(!a.objectStoreNames.contains("media_refs")){let c=a.createObjectStore("media_refs",{keyPath:"key"});c.createIndex("byArticleId","articleId",{unique:!1}),c.createIndex("byUrl","url",{unique:!1})}if(a.objectStoreNames.contains("outbox")){let c=r.transaction;try{let l=c.objectStore("outbox");l.indexNames.contains("byTypeCoalesceKey")||l.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}catch{}}else{let c=a.createObjectStore("outbox",{keyPath:"id"});c.createIndex("byCreatedAtMs","createdAtMs",{unique:!1}),c.createIndex("byTypeArticleId",["type","articleId"],{unique:!1}),c.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}if(!a.objectStoreNames.contains("pending_uploads")){let c=a.createObjectStore("pending_uploads",{keyPath:"token"});c.createIndex("byArticleId","articleId",{unique:!1}),c.createIndex("byCreatedAtMs","createdAtMs",{unique:!1})}if(!a.objectStoreNames.contains("tags_global")){let c=a.createObjectStore("tags_global",{keyPath:"key"});c.createIndex("byCount","count",{unique:!1}),c.createIndex("byLastSeenAtMs","lastSeenAtMs",{unique:!1})}a.objectStoreNames.contains("tags_by_article")||a.createObjectStore("tags_by_article",{keyPath:"articleId"}).createIndex("byUpdatedAt","updatedAt",{unique:!1})};let s=await Promise.race([He(r),new Promise((a,c)=>{setTimeout(()=>{let l=new Error(i?"IndexedDB upgrade is blocked by another tab":"IndexedDB open timeout");l.name=i?"IDBBlockedError":"IDBTimeoutError",c(Dr(i?"blocked":"timeout",l,{name:n}))},o)})]).catch(a=>{let c=String(a?.name||"");throw c==="IDBBlockedError"||c==="IDBTimeoutError"?a:c==="SecurityError"?Dr("security",a,{name:n}):c==="InvalidStateError"?Dr("invalid_state",a,{name:n}):c==="QuotaExceededError"?Dr("quota",a,{name:n}):Dr("unknown",a,{name:n})});try{s.onversionchange=()=>{try{s.close()}catch{}}}catch{}return s}async function ja(e){let t=e.transaction(["meta"],"readonly"),n=t.objectStore("meta");await He(n.get("ping")),await Ze(t)}var hu,Ka,Bn=Xe(()=>{hu=4,Ka="ttree_offline_known_user_keys_v1"});async function zo({userKey:e}={}){let t=String(e||"").trim();if(!t||t==="anon")try{let n=window?.localStorage?.getItem?.("ttree_offline_user_key_v1")||"",r=String(n||"").trim();r&&(t=r)}catch{}if(!t||t==="anon")try{let n=window?.localStorage?.getItem?.("ttree_last_user_v1")||"",r=n?JSON.parse(n):null,o=String(r?.id||r?.username||"").trim();o&&(t=o)}catch{}return t||(t="anon"),Fo&&Ja===t||(Ja=t,Fo=(async()=>await Va({userKey:t}))()),Fo}var Fo,Ja,Zi=Xe(()=>{Bn();Fo=null,Ja=null});function qo(){try{return window?.localStorage?.getItem?.(yu)==="1"}catch{return!1}}function Xa(){try{return window?.localStorage?.getItem?.(bu)==="1"}catch{return!1}}function es(e,t={}){try{if(!qo())return;console.log("[perf][offline]",e,t)}catch{}}function Su(){try{let e=window.__BUILD_ID__;return e?String(e):""}catch{return""}}function ts(e,t){try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:e,data:t})}).catch(()=>{})}catch{}}async function ns(){let e={};try{e.ua=navigator?.userAgent||""}catch{e.ua=""}try{e.buildId=Su()}catch{e.buildId=""}try{e.onLine=navigator?.onLine!==!1}catch{e.onLine=null}try{e.indexedDB=typeof indexedDB<"u"}catch{e.indexedDB=null}try{e.storagePersist=typeof navigator?.storage?.persist=="function"}catch{e.storagePersist=null}try{e.storageEstimate=typeof navigator?.storage?.estimate=="function"}catch{e.storageEstimate=null}try{if(navigator?.storage?.estimate){let t=await navigator.storage.estimate().catch(()=>null);t&&typeof t=="object"&&(e.quota=Number(t.quota||0)||null,e.usage=Number(t.usage||0)||null)}}catch{}return e}function wu(e){try{let t=window?.localStorage?.getItem?.("ttree_offline_user_key_v1")||"",n=String(t||"").trim();if(n)return n}catch{}return e&&(e.id||e.username)||"anon"}function xu(e){let t=String(e?.idbKind||"").trim(),n=String(e?.name||"").trim(),r=String(e?.message||"").trim();return t==="no_idb"||n==="IDBNotSupportedError"?{status:"unavailable",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0432 \u044D\u0442\u043E\u043C \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435 (\u043D\u0435\u0442 IndexedDB). \u041E\u0444\u0444\u043B\u0430\u0439\u043D \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u0435\u0442."}:t==="security"||n==="SecurityError"?{status:"unavailable",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u0430 \u043D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0430\u043C\u0438 \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0430/\u043F\u0440\u0438\u0432\u0430\u0442\u043D\u044B\u043C \u0440\u0435\u0436\u0438\u043C\u043E\u043C. \u041E\u0444\u0444\u043B\u0430\u0439\u043D \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u0435\u0442."}:t==="blocked"||n==="IDBBlockedError"?{status:"blocked",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u0437\u0430\u043D\u044F\u0442\u0430 \u0434\u0440\u0443\u0433\u043E\u0439 \u0432\u043A\u043B\u0430\u0434\u043A\u043E\u0439 Memus. \u0417\u0430\u043A\u0440\u043E\u0439\u0442\u0435 \u0434\u0440\u0443\u0433\u0438\u0435 \u0432\u043A\u043B\u0430\u0434\u043A\u0438 \u0438 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443."}:t==="timeout"||n==="IDBTimeoutError"?{status:"timeout",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435 \u043E\u0442\u0432\u0435\u0447\u0430\u0435\u0442 (\u0432\u043A\u043B\u0430\u0434\u043A\u0430 \u043C\u043E\u0433\u043B\u0430 \u201C\u0443\u0441\u043D\u0443\u0442\u044C\u201D). \u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443."}:t==="quota"||n==="QuotaExceededError"?{status:"quota",message:"\u041D\u0435\u0434\u043E\u0441\u0442\u0430\u0442\u043E\u0447\u043D\u043E \u043C\u0435\u0441\u0442\u0430 \u0434\u043B\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u043A\u044D\u0448\u0430. \u041E\u0447\u0438\u0441\u0442\u0438\u0442\u0435 \u043A\u044D\u0448 \u043A\u0430\u0440\u0442\u0438\u043D\u043E\u043A \u0438\u043B\u0438 \u043E\u0441\u0432\u043E\u0431\u043E\u0434\u0438\u0442\u0435 \u043C\u0435\u0441\u0442\u043E \u0432 \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435."}:t==="invalid_state"||n==="InvalidStateError"?{status:"error",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043F\u043E\u0432\u0440\u0435\u0436\u0434\u0435\u043D\u0430 \u0438\u043B\u0438 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430. \u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438\u043B\u0438 \u0441\u0431\u0440\u043E\u0441\u0438\u0442\u044C \u043E\u0444\u0444\u043B\u0430\u0439\u043D\u2011\u043A\u044D\u0448."}:r?{status:"error",message:`\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430: ${r}`}:{status:"error",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430."}}async function Au(e){let t=wu(e);if(Or&&Wa===t)return Or;Wa=t,Ya+=1;let n=Ya;return Or=(async()=>{let r=qo()?performance.now():0;d.offlineReady=!1,d.offlineInitStatus="initializing",d.offlineInitError="",d.offlineInitStartedAt=Date.now();try{if(Ga!==n){Ga=n;let o=await ns().catch(()=>({}));ts("offline.init.start",{t:new Date().toISOString(),attempt:n,userKey:t,env:o})}}catch{}try{Xa()&&console.log("[offline] init start",{userKey:t})}catch{}try{let o=qo()?performance.now():0,i=await zo({userKey:t});o&&es("getOfflineDb()",{ms:Math.round(performance.now()-o)});let s=qo()?performance.now():0;await ja(i),s&&es("idb.ping",{ms:Math.round(performance.now()-s)});try{navigator?.storage?.persist&&navigator.storage.persist().catch(()=>{})}catch{}d.offlineReady=!0,d.offlineInitStatus="ready",d.offlineInitError="",d.offlineInitStartedAt=null;try{if(Uo!==n){Uo=n;let a=await ns().catch(()=>({}));ts("offline.init.ready",{t:new Date().toISOString(),attempt:n,userKey:t,env:a})}}catch{}try{Xa()&&console.log("[offline] init ready")}catch{}return r&&es("initOfflineForUser.total",{userKey:t,ms:Math.round(performance.now()-r)}),i}catch(o){d.offlineReady=!1;let i=xu(o);d.offlineInitStatus=i.status||"error",d.offlineInitStartedAt=null;try{console.error("[offline] init failed",o)}catch{}let s=i.message;d.offlineInitError=s,Ee(s);try{if(Uo!==n){Uo=n;let a=await ns().catch(()=>({}));ts("offline.init.failed",{t:new Date().toISOString(),attempt:n,userKey:t,msg:s,err:{name:String(o?.name||""),message:String(o?.message||""),stack:String(o?.stack||"").slice(0,1500)},env:a})}}catch{}throw o}})(),Or}async function wt(){return Or||Au(d.currentUser)}var Or,Wa,Ya,Ga,Uo,yu,bu,nr=Xe(()=>{Pt();rn();Zi();Bn();Or=null,Wa=null,Ya=0,Ga=null,Uo=null,yu="ttree_profile_v1",bu="ttree_debug_offline_v1"});function rs(e){if(!e)return"";if(e.type==="text")return String(e.text||"");let t=Array.isArray(e.content)?e.content:[];if(!t.length)return"";let n=[];for(let r of t){let o=rs(r);o&&n.push(o),r&&(r.type==="paragraph"||r.type==="hardBreak"||r.type==="heading")&&n.push(`
`)}return n.join("")}function Qa(e){return String(e||"").replace(/\r\n/g,`
`).replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}function Za(e,t=[]){for(let n of e||[]){if(!n||n.type!=="outlineSection")continue;let r=String(n.attrs?.id||""),o=n.content?.[0],i=n.content?.[1],s=n.content?.[2],a=Qa(rs(o))||"",c=Qa(rs(i))||"",l=`${a}
${c}`.trim();r&&t.push({sectionId:r,title:a,text:l});let u=s?.content||[];Za(u,t)}return t}function ku(e){let t=Array.isArray(e?.content)?e.content:[];return Za(t,[])}function Iu(e){return String(e||"").trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9а-яё_-]/gi,"")}function ec(e,t){for(let n of e||[]){if(!n)continue;if(n.type==="tag"){let o=n.attrs?.key||n.attrs?.label||"",i=Iu(o);i&&t.add(i)}let r=Array.isArray(n.content)?n.content:[];r.length&&ec(r,t)}}function Eu(e){let t=new Set,n=Array.isArray(e?.content)?e.content:[];return ec(n,t),Array.from(t)}async function Ko(e,{articleId:t,docJson:n,updatedAt:r}){if(!e||!t||!n||typeof n!="object")return;let o=String(t),i=Eu(n),s=Date.now(),a=e.transaction(["tags_by_article","tags_global"],"readwrite"),c=a.objectStore("tags_by_article"),l=a.objectStore("tags_global"),u=await He(c.get(o)).catch(()=>null),h=new Set(Array.isArray(u?.tags)?u.tags.map(p=>String(p||"").trim()).filter(Boolean):[]),g=new Set(i),b=[],S=[];for(let p of h)g.has(p)||b.push(p);for(let p of g)h.has(p)||S.push(p);for(let p of b){let f=await He(l.get(p)).catch(()=>null),w=Math.max(0,(Number(f?.count||0)||0)-1);w<=0?await He(l.delete(p)).catch(()=>{}):await He(l.put({...f||{},key:p,label:String(f?.label||p),count:w,lastSeenAtMs:Number(f?.lastSeenAtMs||0)||0})).catch(()=>{})}for(let p of g){let f=await He(l.get(p)).catch(()=>null),w=(Number(f?.count||0)||0)+(S.includes(p)?1:0);await He(l.put({...f||{},key:p,label:String(f?.label||p),count:Math.max(1,w),lastSeenAtMs:s})).catch(()=>{})}await He(c.put({articleId:o,tags:i,updatedAt:r||null,indexedAtMs:s})),await Ze(a)}async function Vo(e,{articleId:t,docJson:n,updatedAt:r}){if(!e||!t||!n||typeof n!="object")return;let o=ku(n),i=e.transaction(["outline_sections"],"readwrite"),s=i.objectStore("outline_sections"),a=s.index("byArticleId"),c=IDBKeyRange.only(String(t)),l=await He(a.openCursor(c));for(;l;)l.delete(),l=await He(l.continue());for(let u of o)await He(s.put({sectionId:u.sectionId,articleId:String(t),title:u.title||"",text:u.text||"",updatedAt:r||null}));await Ze(i)}var tc=Xe(()=>{Bn()});function vu(){try{return localStorage.getItem(Cu)==="1"}catch{return!1}}function Tu(e){let t=String(e||"").trim();if(!t)return null;try{let n=new URL(t,window.location.origin);return n.origin!==window.location.origin?/^https?:\/\/memus\.pro\b/i.test(t)&&n.pathname.startsWith("/uploads/")?n.pathname+(n.search||""):null:n.pathname.startsWith("/uploads/")?n.pathname+(n.search||""):null}catch{return t.startsWith("/uploads/")?t:null}}function Bu(e){let t=new Set,n=r=>{if(!r)return;if(Array.isArray(r)){r.forEach(n);return}if(r.type==="image"){let i=Tu(r.attrs?.src);i&&t.add(i)}(Array.isArray(r.content)?r.content:[]).forEach(n)};return n(e?.content||[]),Array.from(t)}async function Rr(e,t){let n=await wt(),r=Bu(t),o=n.transaction(["media_refs","media_assets"],"readwrite"),i=o.objectStore("media_refs"),s=o.objectStore("media_assets"),a=i.index("byArticleId"),c=IDBKeyRange.only(String(e)),l=await He(a.openCursor(c)).catch(()=>null);for(;l;)l.delete(),l=await He(l.continue()).catch(()=>null);for(let u of r){let h=`${String(e)}|${String(u)}`;await He(i.put({key:h,articleId:String(e),url:String(u)})),await He(s.get(u)).catch(()=>null)||await He(s.put({url:String(u),status:"needed",fetchedAtMs:0,failCount:0,lastError:null}))}await Ze(o)}async function nc(e,t){let n=e.transaction(["media_assets"],"readwrite"),r=n.objectStore("media_assets"),o=await He(r.get(t)).catch(()=>null);await He(r.put({...o||{},url:String(t),status:"ok",fetchedAtMs:Date.now(),failCount:0,lastError:null})),await Ze(n)}async function Nu(e,t,n){let r=String(n?.message||n||"error"),o=e.transaction(["media_assets"],"readwrite"),i=o.objectStore("media_assets"),s=await He(i.get(t)).catch(()=>null),a=Number(s?.failCount||0)+1;await He(i.put({...s||{},url:String(t),status:"error",fetchedAtMs:Date.now(),failCount:a,lastError:r})),await Ze(o)}async function Mu(e,t){let n=e.transaction(["media_assets"],"readonly"),o=n.objectStore("media_assets").index("byFetchedAtMs"),i=[],s=await He(o.openCursor()).catch(()=>null);for(;s;){let a=s.value,c=String(a?.status||""),l=Number(a?.failCount||0);if(c!=="ok"&&l<5){let u=String(a?.url||"");if(u&&i.push(u),i.length>=t)break}s=await He(s.continue()).catch(()=>null)}return await Ze(n),i}async function Lu(e,t){try{return!!await e.match(t,{ignoreSearch:!1})}catch{return!1}}async function Pu(e,t){let n=await fetch(t,{credentials:"include"});if(!n||!n.ok)throw new Error(`HTTP ${n?.status||0}`);await e.put(t,n.clone())}function _u(){try{let e=navigator.connection||navigator.mozConnection||navigator.webkitConnection,t=String(e?.effectiveType||"");if(!!e?.saveData||t.includes("2g"))return 1;if(t.includes("3g"))return 2}catch{}return 3}function ic(){if(rc)return;rc=!0;let e=async()=>{if(!navigator.onLine||vu())return;let t=_u();if(jo>=t)return;let n=await wt(),r=await caches.open(oc),o=await Mu(n,Math.max(5,t*3));if(o.length)for(let i of o){if(jo>=t)break;jo+=1,(async()=>{try{if(await Lu(r,i)){await nc(n,i);return}await Pu(r,i),await nc(n,i)}catch(s){await Nu(n,i,s)}finally{jo-=1}})()}};setInterval(()=>{e().catch(()=>{})},1200),window.addEventListener("online",()=>{e().catch(()=>{})})}async function sc(){let e=await wt(),t=await caches.open(oc),n=e.transaction(["media_assets","media_refs"],"readwrite"),r=n.objectStore("media_assets"),i=n.objectStore("media_refs").index("byUrl"),s=[],a=await He(r.openCursor()).catch(()=>null);for(;a&&s.length<500;){let c=String(a.value?.url||"");c&&(await He(i.count(IDBKeyRange.only(c))).catch(()=>0)||(s.push(c),a.delete())),a=await He(a.continue()).catch(()=>null)}if(await Ze(n),!s.length)return 0;for(let c of s)try{await t.delete(c)}catch{}return s.length}var oc,Cu,rc,jo,os=Xe(()=>{nr();Bn();oc="memus-uploads-v1",Cu="ttree_media_prefetch_paused_v1";rc=!1,jo=0});function is(){try{window.dispatchEvent(new CustomEvent("offline-outbox-changed"))}catch{}}function Du(){return globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?globalThis.crypto.randomUUID():`id-${Date.now()}-${Math.random().toString(16).slice(2)}`}function ac(){return new Date().toISOString()}async function on(e,{articleId:t,payload:n,coalesceKey:r}={}){let o=await wt(),i=Du(),s=ac(),a=n?JSON.stringify(n):"{}",c=o.transaction(["outbox"],"readwrite"),l=c.objectStore("outbox"),u=l.index("byTypeArticleId"),h=l.index("byTypeCoalesceKey");if(r){let g=[String(e||""),String(r||"")],b=await He(h.openCursor(IDBKeyRange.only(g))).catch(()=>null);for(;b;)b.delete(),b=await He(b.continue()).catch(()=>null)}else if(t){let g=[String(e||""),t||null],b=await He(u.openCursor(IDBKeyRange.only(g))).catch(()=>null);for(;b;)b.delete(),b=await He(b.continue()).catch(()=>null)}return await He(l.put({id:i,createdAt:s,createdAtMs:Date.now(),type:String(e||""),articleId:t||null,coalesceKey:r?String(r):null,payloadJson:a,attempts:0,lastError:null,lastAttemptAt:null})),await Ze(c),is(),i}async function wr(e=50){let n=(await wt()).transaction(["outbox"],"readonly"),o=n.objectStore("outbox").index("byCreatedAtMs"),i=[],s=await He(o.openCursor()).catch(()=>null);for(;s&&(i.push(s.value),!(i.length>=e));)s=await He(s.continue()).catch(()=>null);return await Ze(n),i.map(a=>{let c={};try{c=JSON.parse(a?.payloadJson||"{}")}catch{c={}}return{id:a.id,createdAt:a.createdAt,type:a.type,articleId:a.articleId,payload:c,attempts:a.attempts||0}})}async function Ou(e=[],t=null){let n=String(t||"").trim(),r=Array.isArray(e)?e.map(c=>String(c||"").trim()).filter(Boolean):[];if(!n||!r.length)return!1;let i=(await wt()).transaction(["outbox"],"readonly"),a=i.objectStore("outbox").index("byTypeArticleId");for(let c of r)try{let l=[String(c),n];if(await He(a.openCursor(IDBKeyRange.only(l))).catch(()=>null))return await Ze(i),!0}catch{}return await Ze(i),!1}async function cc(e){return Ou(["delete_sections","section_upsert_content","structure_snapshot","save_doc_json"],e)}async function lc(e,t){let r=(await wt()).transaction(["outbox"],"readwrite"),o=r.objectStore("outbox"),i=await He(o.get(e)).catch(()=>null);i&&await He(o.put({...i,attempts:Number(i.attempts||0)+1,lastError:String(t||"error"),lastAttemptAt:ac()})),await Ze(r),is()}async function rr(e){let n=(await wt()).transaction(["outbox"],"readwrite"),r=n.objectStore("outbox");await He(r.delete(e)),await Ze(n),is()}var Hr=Xe(()=>{nr();Bn()});function uc(e){co.counts=new Map,co.labelByKey=new Map;for(let t of e||[]){let n=String(t?.key||"").trim();if(!n)continue;let r=Number(t?.count||0)||0,o=String(t?.label||n);co.counts.set(n,r),co.labelByKey.set(n,o)}dc=!0}async function fc(e){let t=e.transaction(["tags_global"],"readonly"),n=t.objectStore("tags_global"),r=await He(n.getAll()).catch(()=>[]);return await Ze(t),Array.isArray(r)?r:[]}function pc(){return co}function mc(){dc||ss||(ss=(async()=>{try{let e=await wt(),t=await fc(e);uc(t)}catch{}finally{ss=null}})())}function Jo(){as||(as=setTimeout(()=>{as=null,Ru().catch(()=>{})},800))}async function Ru(){try{let e=await wt(),t=await fc(e);uc(t)}catch{}}var dc,ss,as,co,cs=Xe(()=>{nr();Bn();dc=!1,ss=null,as=null,co={counts:new Map,labelByKey:new Map}});function zu(e=null){try{if(window?.localStorage?.getItem?.(Hu)!=="1")return!1;let t=String(window?.localStorage?.getItem?.($u)||"").trim();if(!t)return!0;let n=String(e||"").trim();return n?n===t:!0}catch{return!1}}function Uu(){try{return window?.localStorage?.getItem?.(Fu)==="1"}catch{return!1}}function qu(e){try{return JSON.stringify(e)}catch{return'"[unserializable]"'}}function Ku(e){try{let t=String(e||""),n=2166136261;for(let r=0;r<t.length;r+=1)n^=t.charCodeAt(r),n=Math.imul(n,16777619);return(n>>>0).toString(16)}catch{return"0"}}function Ht(e){try{return!e||typeof e!="object"?null:Ku(qu(e))}catch{return null}}function pt(e,t={}){try{let n=t?.articleId?String(t.articleId):null;if(!zu(n))return!1;let r={t:new Date().toISOString(),kind:String(e||"event"),data:t&&typeof t=="object"?t:{value:t}},o=[];try{let i=window?.localStorage?.getItem?.(Wo)||"";o=i?JSON.parse(i):[],Array.isArray(o)||(o=[])}catch{o=[]}o.push(r),o.length>250&&(o=o.slice(o.length-250));try{window?.localStorage?.setItem?.(Wo,JSON.stringify(o))}catch{}if(Uu()&&navigator.onLine!==!1)try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:`revert:${r.kind}`,data:r})}).catch(()=>{})}catch{}return!0}catch{return!1}}function Vu(){try{let e=window?.localStorage?.getItem?.(Wo)||"",t=e?JSON.parse(e):[];return Array.isArray(t)?t:[]}catch{return[]}}function ju(){try{window?.localStorage?.removeItem?.(Wo)}catch{}}var Hu,$u,Fu,Wo,lo=Xe(()=>{Hu="ttree_debug_revert_v1",$u="ttree_debug_revert_article_v1",Fu="ttree_client_log_v1",Wo="ttree_revert_log_v1";try{window.memusRevertLogDump=()=>Vu(),window.memusRevertLogClear=()=>ju()}catch{}});function Ju(e){return{id:e.id,title:e.title,updatedAt:e.updatedAt,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:!!e.encrypted}}async function Kn(e){let t=await wt(),n=Array.isArray(e)?e:[],r=50;for(let o=0;o<n.length;o+=r){let i=n.slice(o,o+r),s=t.transaction(["articles"],"readwrite"),a=s.objectStore("articles");for(let c of i){let l=Ju(c),h={...await He(a.get(l.id)).catch(()=>null)||{},id:l.id,title:l.title||"",updatedAt:l.updatedAt||null,parentId:l.parentId??null,position:typeof l.position=="number"?l.position:0,publicSlug:l.publicSlug??null,encrypted:l.encrypted?1:0,deletedAt:null};await He(a.put(h))}await Ze(s),await new Promise(c=>setTimeout(c,0))}}async function $r(){let t=(await wt()).transaction(["articles"],"readonly"),n=t.objectStore("articles"),r=1200,o=null,i=await Promise.race([He(n.getAll()),new Promise((s,a)=>{o=setTimeout(()=>{try{t.abort()}catch{}let c=new Error("IndexedDB read timeout (articles index)");c.name="IDBTimeoutError";try{c.idbKind="timeout"}catch{}a(c)},r)})]).catch(s=>{try{String(s?.name||"")==="QuotaExceededError"&&(s.idbKind="quota")}catch{}throw s});return o&&clearTimeout(o),await Ze(t),i.filter(s=>s&&!s.deletedAt).sort((s,a)=>Number(s.position||0)-Number(a.position||0)).map(s=>({id:s.id,title:s.title||"",updatedAt:s.updatedAt||null,parentId:s.parentId??null,position:typeof s.position=="number"?s.position:0,publicSlug:s.publicSlug??null,encrypted:!!s.encrypted}))}async function hc(){let t=(await wt()).transaction(["articles"],"readonly"),n=t.objectStore("articles"),r=await He(n.getAll()).catch(()=>[])||[];return await Ze(t),r.filter(o=>o&&!o.deletedAt).map(o=>({id:o.id,updatedAt:o.updatedAt||null,hasDocJson:!!o.docJsonStr}))}async function Fr(e){if(!e||!e.id)return;let t=await wt(),n=e.docJson&&typeof e.docJson=="object"?e.docJson:null,r=e.updatedAt||null,o=t.transaction(["articles"],"readwrite"),i=o.objectStore("articles"),s=await He(i.get(e.id)).catch(()=>null),a=null;try{a=s?.articleJsonStr?JSON.parse(s.articleJsonStr):null}catch{a=null}let c=!!(a&&a.localDraft),l=e&&Object.prototype.hasOwnProperty.call(e,"outlineStructureRev")?Number(e.outlineStructureRev):null;try{let h=String(s?.updatedAt||"").trim(),g=String(r||"").trim();if(h&&g&&g<h){pt("cache.article.put.skip_older",{articleId:e.id,existingUpdatedAt:h,incomingUpdatedAt:g,incomingDocHash:Ht(n)}),await Ze(o);return}if(c&&h&&g&&h===g){let b=!1;try{b=await cc(e.id)}catch{b=!1}if(b){let S=Ht(s?.docJsonStr?JSON.parse(s.docJsonStr):null),p=Ht(n);if(S&&p&&S!==p){let f=a&&typeof a=="object"?{...a}:{};f.id=e.id,f.title=e.title||f.title||"",f.updatedAt=h,f.parentId=e.parentId??f.parentId??null,f.position=typeof e.position=="number"?e.position:f.position??0,f.publicSlug=e.publicSlug??f.publicSlug??null,f.encrypted=!!e.encrypted,Object.prototype.hasOwnProperty.call(e,"outlineStructureRev")&&(f.outlineStructureRev=Number(e.outlineStructureRev)||0),f.localDraft=!0;let w={...s||{},id:e.id,title:e.title||"",updatedAt:h,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:e.encrypted?1:0,deletedAt:null,outlineStructureRev:Number.isFinite(l)?l:Number(s?.outlineStructureRev),docJsonStr:s?.docJsonStr??null,articleJsonStr:JSON.stringify(f)};await He(i.put(w)),await Ze(o);try{pt("cache.article.put.skip_localDraft",{articleId:e.id,updatedAt:h,existingDocHash:S,incomingDocHash:p})}catch{}return}}else try{pt("cache.article.put.clear_stale_localDraft",{articleId:e.id,updatedAt:h})}catch{}}}catch{}let u={...s||{},id:e.id,title:e.title||"",updatedAt:r,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:e.encrypted?1:0,deletedAt:null,outlineStructureRev:Number.isFinite(l)?l:Number(s?.outlineStructureRev),docJsonStr:n?JSON.stringify(n):null,articleJsonStr:JSON.stringify(e)};await He(i.put(u)),await Ze(o);try{pt("cache.article.put",{articleId:e.id,updatedAt:r,hasDocJson:!!n,docHash:Ht(n)})}catch{}n&&(Vo(t,{articleId:e.id,docJson:n,updatedAt:r}).catch(()=>{}),Ko(t,{articleId:e.id,docJson:n,updatedAt:r}).then(Jo).catch(()=>{}),Rr(e.id,n).catch(()=>{}))}async function gc(e,t){if(!e||!t)return;let n=await wt(),r=String(t),o=e.docJson&&typeof e.docJson=="object"?e.docJson:null,i=e.updatedAt||null,s=n.transaction(["articles"],"readwrite"),a=s.objectStore("articles"),c=await He(a.get(r)).catch(()=>null);try{let u=String(c?.updatedAt||"").trim(),h=String(i||"").trim();if(u&&h&&h<u){pt("cache.articleUnderId.put.skip_older",{articleId:r,existingUpdatedAt:u,incomingUpdatedAt:h,incomingDocHash:Ht(o)}),await Ze(s);return}}catch{}let l={...c||{},id:r,title:e.title||c?.title||"",updatedAt:i||c?.updatedAt||null,parentId:e.parentId??c?.parentId??null,position:typeof e.position=="number"?e.position:c?.position||0,publicSlug:e.publicSlug??c?.publicSlug??null,encrypted:e.encrypted||c?.encrypted?1:0,deletedAt:null,docJsonStr:o?JSON.stringify(o):c?.docJsonStr??null,articleJsonStr:JSON.stringify(e)};await He(a.put(l)),await Ze(s),o&&(Vo(n,{articleId:r,docJson:o,updatedAt:i}).catch(()=>{}),Ko(n,{articleId:r,docJson:o,updatedAt:i}).then(Jo).catch(()=>{}),Rr(r,o).catch(()=>{}))}async function Gn(e){if(!e)return null;let n=(await wt()).transaction(["articles"],"readonly"),r=n.objectStore("articles"),o=await He(r.get(e)).catch(()=>null);if(await Ze(n),!o)return null;try{let i=JSON.parse(o.articleJsonStr||"null");return i&&!i.docJson&&o.docJsonStr&&(i.docJson=JSON.parse(o.docJsonStr)),i}catch{try{let i=o.docJsonStr?JSON.parse(o.docJsonStr):null,s={id:e,title:o.title||"",createdAt:o.createdAt||o.updatedAt||null,updatedAt:o.updatedAt||null,deletedAt:o.deletedAt||null,parentId:o.parentId??null,position:typeof o.position=="number"?o.position:0,authorId:null,publicSlug:o.publicSlug??null,encrypted:!!o.encrypted,outlineStructureRev:Number.isFinite(Number(o.outlineStructureRev))?Number(o.outlineStructureRev):void 0,docJson:i&&typeof i=="object"?i:null,history:[],redoHistory:[],blockTrash:[]};try{pt("cache.article.get.fallback_docJsonStr",{articleId:e,updatedAt:s.updatedAt||null,docHash:Ht(s.docJson)})}catch{}return s}catch{return null}}}async function bn(e,t,n){if(!e)return;let r=await wt(),o=r.transaction(["articles"],"readwrite"),i=o.objectStore("articles"),s=await He(i.get(e)).catch(()=>null),a=n||s&&s.updatedAt||null,c=()=>{let h=String(e)==="inbox"?"\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438":"",g=(s&&typeof s.title=="string"?s.title:"")||h,b=a,S={id:e,title:g,createdAt:s&&s.createdAt||b||null,updatedAt:b,deletedAt:s&&s.deletedAt||null,parentId:(s&&s.parentId)??null,position:typeof(s&&s.position)=="number"?s.position:0,authorId:null,publicSlug:(s&&s.publicSlug)??null,encrypted:!!(s&&s.encrypted),docJson:null,history:[],blocks:[]};return JSON.stringify(S)},l=()=>{let h=s&&s.articleJsonStr||"",g=null;try{g=h?JSON.parse(h):null}catch{g=null}if(!g||typeof g!="object")try{g=JSON.parse(c())}catch{g={id:e}}return g.id=e,g.updatedAt=a||g.updatedAt||null,g.docJson=t&&typeof t=="object"?t:null,t&&typeof t=="object"&&(g.localDraft=!0),!g.title&&s?.title&&(g.title=s.title),g.deletedAt===void 0&&(g.deletedAt=null),g.parentId===void 0&&(g.parentId=s?.parentId??null),g.position===void 0&&(g.position=typeof s?.position=="number"?s.position:0),g.publicSlug===void 0&&(g.publicSlug=s?.publicSlug??null),g.encrypted===void 0&&(g.encrypted=!!s?.encrypted),g.history===void 0&&(g.history=[]),g.blocks===void 0&&(g.blocks=[]),JSON.stringify(g)},u={...s||{id:e},id:e,outlineStructureRev:s?.outlineStructureRev,docJsonStr:t?JSON.stringify(t):null,updatedAt:a,articleJsonStr:l()};await He(i.put(u)),await Ze(o);try{pt("cache.docJson.put",{articleId:e,updatedAt:a,docHash:Ht(t)})}catch{}t&&typeof t=="object"&&(Vo(r,{articleId:e,docJson:t,updatedAt:n}).catch(()=>{}),Ko(r,{articleId:e,docJson:t,updatedAt:n}).then(Jo).catch(()=>{}),Rr(e,t).catch(()=>{}))}async function Yo(e,t){let n=String(e||"").trim();if(!n)return;let r=String(t||new Date().toISOString()).trim(),i=(await wt()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),a=await He(s.get(n)).catch(()=>null);if(!a){await Ze(i);return}let c=null;try{c=a.articleJsonStr?JSON.parse(a.articleJsonStr):null}catch{c=null}(!c||typeof c!="object")&&(c={id:n}),c.id=n,c.deletedAt=r;let l={...a,deletedAt:r,articleJsonStr:JSON.stringify(c)};await He(s.put(l)),await Ze(i)}async function yc(e){let t=String(e||"").trim();if(!t)return;let r=(await wt()).transaction(["articles"],"readwrite"),o=r.objectStore("articles"),i=await He(o.get(t)).catch(()=>null);if(!i){await Ze(r);return}let s=null;try{s=i.articleJsonStr?JSON.parse(i.articleJsonStr):null}catch{s=null}(!s||typeof s!="object")&&(s={id:t}),s.id=t,delete s.localDraft;let a={...i,articleJsonStr:JSON.stringify(s)};await He(o.put(a)),await Ze(r)}async function bc(e){let t=await wt(),n=Array.isArray(e)?e:[];if(!n.length)return;let r=t.transaction(["articles"],"readwrite"),o=r.objectStore("articles");for(let i of n){if(!i||!i.id)continue;let s=await He(o.get(i.id)).catch(()=>null);if(!s)continue;let a={...s,parentId:i.parentId??null,position:typeof i.position=="number"?i.position:0};await He(o.put(a))}await Ze(r)}async function ls(e,t){let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return;let i=(await wt()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),a=await He(s.get(n)).catch(()=>null);if(!a){await Ze(i);return}let c=null;try{c=a.articleJsonStr?JSON.parse(a.articleJsonStr):null}catch{c=null}(!c||typeof c!="object")&&(c={id:n}),c.id=n,c.updatedAt=r;let l={...a,updatedAt:r,articleJsonStr:JSON.stringify(c)};await He(s.put(l)),await Ze(i)}async function ds(e,t){let n=String(e||"").trim();if(!n)return;let r=Number(t);if(!Number.isFinite(r)||r<0)return;let i=(await wt()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),a=await He(s.get(n)).catch(()=>null);if(!a){await Ze(i);return}let c=null;try{c=a.articleJsonStr?JSON.parse(a.articleJsonStr):null}catch{c=null}(!c||typeof c!="object")&&(c={id:n}),c.id=n,c.outlineStructureRev=r;let l={...a,outlineStructureRev:r,articleJsonStr:JSON.stringify(c)};await He(s.put(l)),await Ze(i)}var zr=Xe(()=>{nr();Bn();tc();os();Hr();cs();lo()});function Gu(e){let t=Array.isArray(e)?e:[],n=new Float32Array(t.length),r=0;for(let o=0;o<t.length;o+=1){let i=Number(t[o]||0);n[o]=i,r+=i*i}if(r>0){let o=1/Math.sqrt(r);for(let i=0;i<n.length;i+=1)n[i]*=o}return n}function Sc(){Wu=null,Yu=0}async function us(e,t){if(!e)return;let n=await wt(),r=Array.isArray(t)?t:[],o=n.transaction(["section_embeddings"],"readwrite"),i=o.objectStore("section_embeddings");for(let s of r){let a=String(s?.blockId||s?.sectionId||""),c=String(s?.updatedAt||"")||null,l=s?.embedding;if(!a||!Array.isArray(l)||!l.length)continue;let u=Gu(l);await He(i.put({sectionId:a,articleId:String(e),updatedAt:c,vec:u}))}await Ze(o),Sc()}async function Go(e){let t=(e||[]).map(i=>String(i||"")).filter(Boolean);if(!t.length)return;let r=(await wt()).transaction(["section_embeddings"],"readwrite"),o=r.objectStore("section_embeddings");for(let i of t)await He(o.delete(i));await Ze(r),Sc()}var Wu,Yu,fs=Xe(()=>{nr();Bn();Wu=null,Yu=0});var wc=Xe(()=>{nr();fs();Bn()});function Xo(){try{return window?.localStorage?.getItem?.(Xu)==="1"}catch{return!1}}function Yt(...e){try{if(!Xo())return;console.log(...e)}catch{}}async function Tt(e,t={}){let n=Xo()?performance.now():0,r=n?performance.now():0,o=await fetch(e,{headers:{"Content-Type":"application/json",...t.headers||{}},credentials:"include",...t}),i=r?performance.now():0;if(!o.ok){if(o.status===401||o.status===403){try{d.serverStatus="auth",d.serverStatusText="auth"}catch{}try{window.dispatchEvent(new CustomEvent("memus:auth-required",{detail:{path:e,status:o.status}}))}catch{}}let l=await o.json().catch(()=>({}));n&&console.log("[perf][api]",e,{status:o.status,ms:Math.round(performance.now()-n),fetchMs:i?Math.round(i-r):null});let u=new Error(l.detail||"Request failed");try{u.status=o.status,u.path=e}catch{}throw u}try{d.serverStatus==="down"&&(d.serverStatus="ok",d.serverStatusText="")}catch{}if(o.status===204)return n&&console.log("[perf][api]",e,{status:204,ms:Math.round(performance.now()-n),fetchMs:i?Math.round(i-r):null}),null;let s=n?performance.now():0,a=await o.json(),c=n?performance.now():0;try{if(window?.localStorage?.getItem?.("ttree_debug_article_load_v1")==="1"){let l=o.headers.get("X-Memus-Article-ms"),u=o.headers.get("X-Memus-DocJson-bytes");(l||u)&&console.log("[api]",e,{ms:l,docJsonBytes:u})}}catch{}if(n){let l=o.headers.get("X-Memus-Article-ms")||o.headers.get("X-Memus-Articles-ms")||o.headers.get("X-Memus-Server-ms"),u=o.headers.get("X-Memus-DocJson-bytes"),h=o.headers.get("X-Memus-Articles-count"),g=o.headers.get("Content-Length");console.log("[perf][api]",e,{status:o.status,ms:Math.round(c-n),fetchMs:i?Math.round(i-r):null,jsonMs:s?Math.round(c-s):null,serverMs:l?Number(l):null,docJsonBytes:u?Number(u):null,articlesCount:h?Number(h):null,contentLength:g?Number(g):null})}return a}function Zu(){try{return window?.localStorage?.getItem?.(Qu)==="1"}catch{return!1}}async function xc({timeoutMs:e}){let t=typeof e=="number"?Math.max(0,Math.floor(e)):0,n=null,r=null;try{return t>0&&typeof AbortController<"u"&&(r=new AbortController,n=setTimeout(()=>{try{r.abort()}catch{}},t)),await Tt("/api/articles",r?{signal:r.signal}:{})}catch(o){if((o?.message||String(o||"")).toLowerCase().includes("abort"))try{d.serverStatus="down",d.serverStatusText="timeout"}catch{}throw o}finally{n&&clearTimeout(n)}}function vn(){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return $r().catch(()=>[]);if(uo)return uo;let e=d?.offlineReady?600:250,t=2200;return uo=(async()=>{let n=Xo()?performance.now():0,r=null,o=!1,i=new Promise(l=>{r=setTimeout(()=>{!o&&n&&Yt("[offline-first][articles] cache.lookup.timeout",{preferCacheMs:e}),l(null)},e)}),s=$r().then(l=>(o=!0,r&&clearTimeout(r),r=null,n&&Yt("[offline-first][articles] cache.lookup.done",{ms:Math.round(performance.now()-n),hit:!!(l&&l.length)}),l)).catch(l=>{o=!0,r&&clearTimeout(r),r=null;try{if(d.offlineReady){let u=String(l?.idbKind||l?.name||"").toLowerCase();u.includes("timeout")?(d.offlineInitStatus="timeout",d.offlineInitError="\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435 \u043E\u0442\u0432\u0435\u0447\u0430\u0435\u0442 (\u0442\u0430\u0439\u043C\u0430\u0443\u0442 \u0447\u0442\u0435\u043D\u0438\u044F \u0441\u043F\u0438\u0441\u043A\u0430 \u0441\u0442\u0430\u0442\u0435\u0439). \u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443."):u.includes("quota")?(d.offlineInitStatus="quota",d.offlineInitError="\u041D\u0435\u0434\u043E\u0441\u0442\u0430\u0442\u043E\u0447\u043D\u043E \u043C\u0435\u0441\u0442\u0430 \u0434\u043B\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u043A\u044D\u0448\u0430. \u041E\u0447\u0438\u0441\u0442\u0438\u0442\u0435 \u043A\u044D\u0448 \u043A\u0430\u0440\u0442\u0438\u043D\u043E\u043A \u0438\u043B\u0438 \u043E\u0441\u0432\u043E\u0431\u043E\u0434\u0438\u0442\u0435 \u043C\u0435\u0441\u0442\u043E."):(d.offlineInitStatus="error",d.offlineInitError="\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0440\u043E\u0447\u0438\u0442\u0430\u0442\u044C \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A \u0441\u0442\u0430\u0442\u0435\u0439. \u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438\u043B\u0438 \u0441\u0431\u0440\u043E\u0441\u044C\u0442\u0435 \u043E\u0444\u0444\u043B\u0430\u0439\u043D\u2011\u043A\u044D\u0448.")}}catch{}return null}),a=await Promise.race([s,i]);if(a&&a.length)return ps||(ps=xc({timeoutMs:t}).then(async l=>{try{typeof requestIdleCallback=="function"?requestIdleCallback(()=>Kn(l).catch(()=>{}),{timeout:2500}):setTimeout(()=>Kn(l).catch(()=>{}),250)}catch{Kn(l).catch(()=>{})}}).catch(()=>{}).finally(()=>{ps=null})),a;let c=await xc({timeoutMs:t});try{typeof requestIdleCallback=="function"?requestIdleCallback(()=>Kn(c).catch(()=>{}),{timeout:2500}):setTimeout(()=>Kn(c).catch(()=>{}),250)}catch{Kn(c).catch(()=>{})}try{let l=await $r().catch(()=>null),u=Array.isArray(c)?c.length:0,h=l&&Array.isArray(l)?l.length:0;if(h>=20&&u<=3||Zu()&&h&&h>u)return l}catch{}return c})().catch(async n=>{let r=await $r().catch(()=>null);if(r&&r.length)return r;throw n}).finally(()=>{uo=null}),uo}function Ic(){return typeof navigator<"u"&&navigator&&navigator.onLine===!1?Promise.resolve([]):Tt("/api/articles/deleted").catch(async e=>[])}function Ec(e,t={}){let n=String(e||"").trim();e=n.startsWith("inbox-")?"inbox":n;let{cacheTimeoutMs:o,metaTimeoutMs:i,...s}=t||{},a=d?.offlineReady?400:150,c=typeof o=="number"?Math.max(0,Math.floor(o)):a,l=typeof i=="number"?Math.max(0,Math.floor(i)):350,u=Xo()?performance.now():0,h=null,g=!1,b=new Promise(H=>{h=setTimeout(()=>{!g&&u&&Yt("[offline-first][article] cache.lookup.timeout",{id:e,cacheTimeoutMs:c}),H(null)},c)}),S=Gn(e).then(H=>(g=!0,h&&clearTimeout(h),h=null,u&&Yt("[offline-first][article] cache.lookup.done",{id:e,ms:Math.round(performance.now()-u),hit:!!H}),H)).catch(H=>(g=!0,h&&clearTimeout(h),h=null,u&&Yt("[offline-first][article] cache.lookup.failed",{id:e,ms:Math.round(performance.now()-u),message:H?.message||String(H||"")}),null)),p=Promise.race([S,b]),f=()=>Tt(`/api/articles/${e}?include_history=0`,{...s,cache:"no-store"}).then(async H=>{try{pt("article.fetch.network.ok",{articleId:e,updatedAt:H?.updatedAt||null,docHash:Ht(H?.docJson||null)})}catch{}return Fr(H).catch(()=>{}),H&&H.id&&String(H.id)!==String(e)&&gc(H,e).catch(()=>{}),H}).catch(async H=>{let X=await Gn(e).catch(()=>null);try{pt("article.fetch.network.err",{articleId:e,message:H?.message||String(H||""),cachedHit:!!X,cachedUpdatedAt:X?.updatedAt||null,cachedDocHash:Ht(X?.docJson||null)})}catch{}if(X)return X;throw H}),w=()=>{let H=new Date().toISOString(),G={type:"doc",content:[{type:"outlineSection",attrs:{id:(globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?()=>globalThis.crypto.randomUUID():()=>`id-${Date.now()}-${Math.random().toString(16).slice(2)}`)(),collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}]};return{id:"inbox",title:"\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438",createdAt:H,updatedAt:H,deletedAt:null,parentId:null,position:0,authorId:null,publicSlug:null,encrypted:!1,docJson:G,history:[]}},x="ttree_pending_quick_notes_v1",A=()=>{try{let H=window?.localStorage?.getItem?.(x)||"";if(!H)return[];let X=JSON.parse(H);return Array.isArray(X)?X.filter(Boolean):[]}catch{return[]}},I=(H,X)=>{let G=String(H||"").trim();if(!G)return null;let xe=String(X||"").trim().split(/\r?\n/),ve=[];for(let te=0;te<xe.length;te+=1){let be=xe[te];be&&ve.push({type:"text",text:be}),te!==xe.length-1&&ve.push({type:"hardBreak"})}return{type:"outlineSection",attrs:{id:G,collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[ve.length?{type:"paragraph",content:ve}:{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}},N=H=>{try{if(!H||String(H.id||"")!=="inbox")return H;let X=A();if(!X.length)return H;let G=H?.docJson&&typeof H.docJson=="object"?H.docJson:{type:"doc",content:[]},oe=Array.isArray(G.content)?G.content:[],xe=new Set(oe.filter(te=>te&&te.type==="outlineSection"&&te.attrs&&te.attrs.id).map(te=>String(te.attrs.id))),ve=[];for(let te of X){let be=String(te?.sectionId||te?.id||"").trim();if(!be||xe.has(be))continue;let Qe=I(be,te?.text||"");Qe&&ve.push(Qe)}return ve.length?{...H,docJson:{...G,type:G.type||"doc",content:[...ve,...oe]}}:H}catch{return H}},O=()=>Tt(`/api/articles/${encodeURIComponent(e)}/meta`,{method:"GET",headers:{...s.headers||{}},cache:"no-store"}),U=()=>l?Promise.race([O(),new Promise((H,X)=>setTimeout(()=>{let G=new Error("meta_timeout");G.name="TimeoutError",X(G)},l))]):O();return p.then(async H=>{if(!H){if(!navigator.onLine&&String(e)==="inbox"){try{let ve=await Promise.race([S,new Promise(te=>setTimeout(()=>te(null),Math.max(500,l*5)))]);if(ve){Yt("[offline-first][article] choose.cache.late.offline.inbox",{id:e});try{pt("article.choose",{articleId:e,choose:"cache.late.offline.inbox"})}catch{}return N(ve)}}catch{}return Yt("[offline-first][article] choose.local.inbox.offline",{id:e}),N(w())}let G=S.then(ve=>ve?{src:"cache",article:N(ve)}:new Promise(()=>{})).catch(()=>new Promise(()=>{})),oe=(async()=>({src:"network",article:await N(f())}))(),xe=await Promise.race([G,oe]);if(xe?.src==="cache"){Yt("[offline-first][article] choose.cache.late",{id:e});try{pt("article.choose",{articleId:e,choose:"cache.late"})}catch{}return oe.catch(()=>{}),xe.article}Yt("[offline-first][article] choose.network.no-cache",{id:e});try{pt("article.choose",{articleId:e,choose:"network.no_cache"})}catch{}return xe.article}if(!navigator.onLine){Yt("[offline-first][article] choose.cache.offline",{id:e,updatedAt:H?.updatedAt||null});try{pt("article.choose",{articleId:e,choose:"cache.offline",cachedUpdatedAt:H?.updatedAt||null,cachedDocHash:Ht(H?.docJson||null)})}catch{}return N(H)}let X=String(H.updatedAt||H.updated_at||"").trim();if(!X){Yt("[offline-first][article] choose.network.no-cached-updatedAt",{id:e});try{pt("article.choose",{articleId:e,choose:"network.no_cached_updatedAt",cachedDocHash:Ht(H?.docJson||null)})}catch{}return N(await f())}try{Yt("[offline-first][article] meta.check.start",{id:e,cachedUpdatedAt:X});let G=await U(),oe=String(G?.updatedAt||"").trim();if(oe&&oe===X){Yt("[offline-first][article] choose.cache.meta.same",{id:e,cachedUpdatedAt:X});try{pt("article.choose",{articleId:e,choose:"cache.meta.same",cachedUpdatedAt:X,serverUpdatedAt:oe,cachedDocHash:Ht(H?.docJson||null)})}catch{}return N(H)}Yt("[offline-first][article] choose.network.meta.diff",{id:e,cachedUpdatedAt:X,serverUpdatedAt:oe||null});try{pt("article.choose",{articleId:e,choose:"network.meta.diff",cachedUpdatedAt:X,serverUpdatedAt:oe||null,cachedDocHash:Ht(cached?.docJson||null)})}catch{}return N(await f())}catch(G){String(G?.name||"")==="TimeoutError"||String(G?.message||"")==="meta_timeout"?Yt("[offline-first][article] meta.check.timeout",{id:e,metaTimeoutMs:l}):Yt("[offline-first][article] meta.check.failed",{id:e,message:G?.message||String(G||"")}),f().catch(()=>{}),String(G?.name||"")==="TimeoutError"||String(G?.message||"")==="meta_timeout"?Yt("[offline-first][article] choose.cache.meta.timeout",{id:e,cachedUpdatedAt:X,metaTimeoutMs:l}):Yt("[offline-first][article] choose.cache.meta.failed",{id:e,cachedUpdatedAt:X});try{pt("article.choose",{articleId:e,choose:String(G?.name||"")==="TimeoutError"||String(G?.message||"")==="meta_timeout"?"cache.meta.timeout":"cache.meta.failed",cachedUpdatedAt:X,cachedDocHash:Ht(H?.docJson||null),error:G?.message||String(G||"")})}catch{}return N(H)}})}function Cc(e,t){return e?!t||typeof t!="object"?Promise.reject(new Error("docJson must be object")):Tt(`/api/articles/${encodeURIComponent(e)}/doc-json`,{method:"PUT",body:JSON.stringify({docJson:t})}):Promise.reject(new Error("articleId is required"))}function vc(e){return typeof e!="string"?Promise.reject(new Error("text must be string")):Tt("/api/outline/generate-title",{method:"POST",body:JSON.stringify({text:e})})}function ms(e){return typeof e!="string"?Promise.reject(new Error("html must be string")):Tt("/api/outline/proofread-html",{method:"POST",body:JSON.stringify({html:e})})}function Tc(e,t={}){let n=t.force?"?force=true":"";return Tt(`/api/articles/${e}${n}`,{method:"DELETE"}).then(r=>{let o=n?new Date().toISOString():new Date().toISOString();return Yo(e,o).catch(()=>{}),r})}function Bc(e){return Tt(`/api/articles/${e}/restore`,{method:"POST"})}function Nc(e,t,n={}){let r=Array.isArray(t)?t.filter(Boolean).map(o=>String(o)):[];return e?r.length?Tt(`/api/articles/${encodeURIComponent(e)}/sections/delete`,{method:"PUT",cache:"no-store",body:JSON.stringify({opId:n?.opId||null,sectionIds:r})}):Promise.resolve({status:"ok",removedBlockIds:[]}):Promise.reject(new Error("articleId is required"))}function fo(e){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return Promise.reject(new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D"));let t=new FormData;t.append("file",e);let n=i=>{if(!(typeof navigator<"u"&&navigator&&navigator.onLine===!1))try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"uploadImageFile",data:i})}).catch(()=>{})}catch{}},r=()=>fetch("/api/uploads",{method:"POST",credentials:"include",body:t}).then(async i=>{let s=await i.json().catch(()=>null);if(n({transport:"fetch",status:i.status,ok:i.ok,details:s,name:e&&e.name,type:e&&e.type,size:e&&e.size}),!i.ok){let a=s?.detail||`Upload failed (status ${i.status})`,c=new Error(a);throw c.status=i.status,c.details=s,c}return s}),o=()=>new Promise((i,s)=>{let a=new XMLHttpRequest;a.open("POST","/api/uploads"),a.withCredentials=!0,a.onreadystatechange=()=>{if(a.readyState===XMLHttpRequest.DONE)try{let c=a.status,l=null;try{l=JSON.parse(a.responseText||"null")}catch{l=null}if(n({transport:"xhr",status:c,ok:c>=200&&c<300,details:l,name:e&&e.name,type:e&&e.type,size:e&&e.size}),c>=200&&c<300)i(l);else{let u=l&&l.detail||`Upload failed (status ${c})`,h=new Error(u);h.status=c,h.details=l,s(h)}}catch(c){s(c)}},a.onerror=()=>{n({transport:"xhr",status:0,ok:!1,details:{detail:"Network error during image upload"},name:e&&e.name,type:e&&e.type,size:e&&e.size});let c=new Error("Upload failed (network error)");c.status=0,c.details={detail:"Network error during image upload"},s(c)},a.send(t)});return r().catch(i=>{let s=String(i&&i.message?i.message:"").toLowerCase();if(s.includes("status ")||s.includes("upload failed"))throw i;return o()})}function ef(e,t,n=()=>{},{sectionId:r}={}){return typeof navigator<"u"&&navigator&&navigator.onLine===!1?Promise.reject(new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D")):new Promise((o,i)=>{let s=new XMLHttpRequest;s.open("POST",`/api/articles/${e}/attachments`),s.withCredentials=!0,s.upload.onprogress=c=>{if(c.lengthComputable){let l=Math.round(c.loaded/c.total*100);n(l)}},s.onreadystatechange=()=>{if(s.readyState===XMLHttpRequest.DONE)if(s.status>=200&&s.status<300)try{let c=JSON.parse(s.responseText||"{}");o(c)}catch(c){i(c)}else{let c=`Attachment upload failed (status ${s.status})`;try{let l=JSON.parse(s.responseText||"{}");l?.detail&&(c=l.detail)}catch{}i(new Error(c))}},s.onerror=()=>i(new Error("Network error during upload"));let a=new FormData;a.append("file",t),r&&a.append("sectionId",String(r)),s.send(a)})}function tf(e){let t=new Map;for(let n of e||[]){let r=n.parentId??null;t.has(r)||t.set(r,[]),t.get(r).push(n)}for(let n of t.values())n.sort((r,o)=>(r.position||0)-(o.position||0));return t}function Ac(e){let t=[];for(let n=0;n<e.length;n+=1){let r=e[n];if(!r)continue;let o=n;(r.position||0)!==o&&(r.position=o,t.push({id:r.id,parentId:r.parentId??null,position:o}))}return t}function hs(e,t){return e?Tt(`/api/articles/${encodeURIComponent(e)}/move-tree`,{method:"POST",body:JSON.stringify(t||{})}).catch(async()=>{let r=await $r().catch(()=>[]),o=tf(r),i=(r||[]).find(f=>f.id===e);if(!i)return null;let s=t&&t.placement||null,a=t&&t.anchorId||null,c=t?t.parentId??null:null;s==="inside"&&a&&(c=a);let l=i.parentId??null,h=(o.get(l)||[]).filter(f=>f.id!==e),b=(o.get(c)||[]).filter(f=>f.id!==e),S=b.length;if(a){let f=b.findIndex(w=>w.id===a);f!==-1&&(s==="before"?S=f:s==="after"?S=f+1:s==="inside"&&(S=b.length))}i.parentId=c,b.splice(S,0,i);let p=[];return p.push(...Ac(h)),p.push(...Ac(b)),bc(p).catch(()=>{}),on("move_article_tree",{articleId:e,payload:t||{},coalesceKey:`${e}:move-tree`}).catch(()=>{}),{id:e}}):Promise.resolve(null)}async function nf({articleId:e,filename:t,overwrite:n=!1,sha256:r="",size:o=0}){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D");let s=await fetch("/api/yandex/disk/upload-url",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({filename:t||"",articleId:e||"",overwrite:!!n,sha256:r||"",size:typeof o=="number"?o:0})}),a=await s.json().catch(()=>null);if(!s.ok){let c=a&&a.detail||`Yandex upload URL failed (status ${s.status})`;throw new Error(c)}return a}async function kc(e,{path:t,originalName:n,contentType:r,size:o,sectionId:i}){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D");let s={path:t||"",originalName:n||"",contentType:r||"",size:typeof o=="number"?o:0};i&&(s.sectionId=String(i));let a=await fetch(`/api/articles/${e}/attachments/yandex`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),c=await a.json().catch(()=>null);if(!a.ok){let l=c&&c.detail||`Register Yandex attachment failed (status ${a.status})`;throw new Error(l)}return c}async function Qo(e,t,{onProgress:n,sectionId:r}={}){if(!t)throw new Error("\u0424\u0430\u0439\u043B \u043D\u0435 \u0443\u043A\u0430\u0437\u0430\u043D");let o="";try{if(window.crypto&&window.crypto.subtle&&typeof t.arrayBuffer=="function"){let g=await t.arrayBuffer(),b=await window.crypto.subtle.digest("SHA-256",g),S=new Uint8Array(b);o=Array.from(S).map(p=>p.toString(16).padStart(2,"0")).join("")}}catch{o=""}let{href:i,method:s,path:a,exists:c,same:l}=await nf({articleId:e,filename:t.name||"attachment",overwrite:!1,sha256:o,size:t.size||0});if(c&&l&&!i)return await kc(e,{path:a,originalName:t.name||"attachment",contentType:t.type||"",size:t.size||0,sectionId:r});let u=!1;if(i)try{await new Promise((g,b)=>{let S=new XMLHttpRequest;S.open(s||"PUT",i),S.upload.onprogress=p=>{if(n&&p.lengthComputable){let f=Math.round(p.loaded/p.total*100);try{n(f)}catch{}}},S.onreadystatechange=()=>{S.readyState===XMLHttpRequest.DONE&&(S.status>=200&&S.status<300?g():b(new Error(`Yandex upload failed (status ${S.status})`)))},S.onerror=()=>b(new Error("Network error during Yandex upload")),S.send(t)}),u=!0}catch(g){console.warn("[attachments] Direct Yandex upload failed, falling back to server upload",g),u=!1}return u?await kc(e,{path:a,originalName:t.name||"attachment",contentType:t.type||"",size:t.size||0,sectionId:r}):await ef(e,t,n,{sectionId:r})}var Xu,uo,ps,Qu,un=Xe(()=>{zr();Hr();wc();Pt();lo();Xu="ttree_profile_v1";uo=null,ps=null,Qu="ttree_offline_recovery_force_index_v1"});function Mc(){if(!V.articlePublicToggleBtn)return;let e=d.article?.publicSlug||null;V.articlePublicToggleBtn.textContent=e?"\u041E\u0442\u043C\u0435\u043D\u0438\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435":"\u0414\u0430\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435"}function po(){let e=d.article;if(!e)return;let t=e.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";if(V.articleTitle&&(V.articleTitle.textContent=t,V.articleTitle.classList.toggle("article-title--encrypted",!!e.encrypted),V.articleTitle.classList.toggle("hidden",d.isEditingTitle)),V.articleTitleInput&&(d.isEditingTitle||(V.articleTitleInput.value=t),V.articleTitleInput.classList.toggle("hidden",!d.isEditingTitle)),V.editTitleBtn&&V.editTitleBtn.classList.toggle("hidden",d.isEditingTitle),V.articleFavoriteBtn){let r=new Set(d.favoriteArticles||[]).has(e.id),o=V.articleFavoriteBtn.querySelector?.("i.bx")||V.articleFavoriteBtn.querySelector?.("span.bx")||V.articleFavoriteBtn.querySelector?.(".bx")||null;o&&o.classList?(o.classList.toggle("bxs-star",r),o.classList.toggle("bx-star",!r)):V.articleFavoriteBtn.innerHTML=`<i class="bx ${r?"bxs-star":"bx-star"}" aria-hidden="true"></i>`,V.articleFavoriteBtn.title=r?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}if(V.articlePublicLinkBtn){let n=!!e.publicSlug;V.articlePublicLinkBtn.classList.toggle("hidden",!n),n&&(V.articlePublicLinkBtn.title="\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0441\u044B\u043B\u043A\u0443")}if(V.deleteArticleBtn&&V.deleteArticleBtn.classList.toggle("hidden",e.id==="inbox"),V.articleEncryptionBtn&&(V.articleEncryptionBtn.textContent=e.encrypted?"\u0421\u043C\u0435\u043D\u0438\u0442\u044C \u043F\u0430\u0440\u043E\u043B\u044C":"\u0417\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C"),V.articleEncryptionRemoveBtn&&V.articleEncryptionRemoveBtn.classList.toggle("hidden",!e.encrypted),V.updatedAt&&(d.isOutlineEditing?V.updatedAt.textContent=d.outlineStatusText||"":e.updatedAt?V.updatedAt.textContent=`\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${new Date(e.updatedAt).toLocaleString()}`:V.updatedAt.textContent=""),V.articleStatusText&&(d.isOutlineEditing?V.articleStatusText.textContent=d.outlineStatusText||"":e.updatedAt?V.articleStatusText.textContent=`\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${new Date(e.updatedAt).toLocaleString()}`:V.articleStatusText.textContent=""),V.mediaStatusText&&(V.mediaStatusText.textContent=d.mediaStatusText||""),V.mediaPrefetchToggleBtn){let n=!!d.mediaPrefetchPaused;V.mediaPrefetchToggleBtn.textContent=n?"\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C":"\u041F\u0430\u0443\u0437\u0430",V.mediaPrefetchToggleBtn.classList.toggle("is-active",n)}}var mo=Xe(()=>{Pt();Cn()});function sn(...e){console.log("[debug]",...e)}function Gt(e=""){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Lc(e=""){let t=(e||"").replace(/<br\s*\/?>/gi,`
`).replace(/<\/(?:div|p|li|h[1-6])>/gi,`
`),n=document.createElement("template");return n.innerHTML=t,(n.content.textContent||"").split(`
`).map(r=>r.replace(/\s+/g," ").trim()).filter(r=>r.length)}function Zo(e){if(!e||!e.isConnected)return;let t=window.getSelection();if(!t)return;let n=document.createRange();n.selectNodeContents(e),n.collapse(!1),t.removeAllRanges(),t.addRange(n)}function gs(e){if(!e||!e.isConnected)return;let t=window.getSelection();if(!t)return;let n=document.createRange();n.selectNodeContents(e),n.collapse(!0),t.removeAllRanges(),t.addRange(n)}function Xn(e,t){if(!e||!document.contains(e))return;e.focus();let n=window.getSelection();if(!n)return;let r=n.rangeCount>0?n.getRangeAt(0):document.createRange();e.contains(r.commonAncestorContainer)||(r=document.createRange(),r.selectNodeContents(e),r.collapse(!1)),n.removeAllRanges(),n.addRange(r);let o=r.createContextualFragment(t);r.deleteContents(),r.insertNode(o),r.collapse(!1),n.removeAllRanges(),n.addRange(r)}var Rn=Xe(()=>{});var bs={};$o(bs,{showArticleHistoryModal:()=>ff,showArticleLinkPrompt:()=>of,showBlockHistoryModal:()=>df,showBlockTrashPicker:()=>pf,showConfirm:()=>Dc,showImagePreview:()=>ho,showImportConflictDialog:()=>mf,showLinkPrompt:()=>ys,showPasswordWithHintPrompt:()=>Oc,showPrompt:()=>or,showPublicLinkModal:()=>sf,showVersionCompareTargetPicker:()=>cf,showVersionDiffModal:()=>lf,showVersionsPicker:()=>af});function Sn(){let e=document.getElementById(Pc);return e||(e=document.createElement("div"),e.id=Pc,document.body.appendChild(e)),e}function Nn({title:e,message:t,confirmText:n,cancelText:r,renderBody:o}){let i=document.createElement("div");i.className="modal-overlay";let s=document.createElement("form");s.className="modal-form",s.addEventListener("submit",S=>{S.preventDefault()});let a=document.createElement("div");a.className="modal-card",a.setAttribute("role","dialog"),a.setAttribute("aria-modal","true"),a.tabIndex=-1;let c=document.createElement("div");c.className="modal-header";let l=document.createElement("h3");l.textContent=e||"\u041F\u043E\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043D\u0438\u0435",c.appendChild(l);let u=document.createElement("div");if(u.className="modal-body",typeof o=="function"){let S=o();Array.isArray(S)?S.forEach(p=>{p&&u.appendChild(p)}):S&&u.appendChild(S)}else u.textContent=t||"";let h=document.createElement("div");h.className="modal-footer modal-footer--stacked";let g=document.createElement("button");g.type="button",g.className="ghost",g.textContent=r||"\u041E\u0442\u043C\u0435\u043D\u0430";let b=document.createElement("button");return b.type="button",b.className="primary danger-btn",b.textContent=n||"\u0423\u0434\u0430\u043B\u0438\u0442\u044C",h.appendChild(b),h.appendChild(g),a.appendChild(c),a.appendChild(u),a.appendChild(h),s.appendChild(a),i.appendChild(s),{overlay:i,card:a,confirmBtn:b,cancelBtn:g,form:s}}function rf(e="",t=""){let n=String(e||"").length,r=String(t||"").length;if(n*r>2e6||n+r>2e4)return null;let s=Array.from(e),a=Array.from(t),c=s.length,l=a.length,u=Array.from({length:c+1},()=>new Array(l+1).fill(0));for(let p=c-1;p>=0;p-=1)for(let f=l-1;f>=0;f-=1)s[p]===a[f]?u[p][f]=u[p+1][f+1]+1:u[p][f]=Math.max(u[p+1][f],u[p][f+1]);let h=[],g=0,b=0;for(;g<c&&b<l;)s[g]===a[b]?(h.push({type:"same",value:s[g]}),g+=1,b+=1):u[g+1][b]>=u[g][b+1]?(h.push({type:"removed",value:s[g]}),g+=1):(h.push({type:"added",value:a[b]}),b+=1);for(;g<c;)h.push({type:"removed",value:s[g]}),g+=1;for(;b<l;)h.push({type:"added",value:a[b]}),b+=1;let S=[];return h.forEach(p=>{if(!p.value)return;let f=S[S.length-1];f&&f.type===p.type?f.value+=p.value:S.push({type:p.type,value:p.value})}),S}function Ur({baseText:e="",nextText:t="",mode:n="before"}={}){let r=document.createDocumentFragment(),o=rf(e,t);if(!o){let s=String(n==="before"?e||"":t||""),a=s.length>2e5?`${s.slice(0,2e5)}

\u2026(\u043E\u0431\u0440\u0435\u0437\u0430\u043D\u043E)`:s,c=document.createElement("div");c.className="meta",c.style.marginBottom="6px",c.textContent="Diff \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 \u2014 \u043F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0435\u043C \u0442\u0435\u043A\u0441\u0442 \u0431\u0435\u0437 \u043F\u043E\u0434\u0441\u0432\u0435\u0442\u043A\u0438.";let l=document.createElement("pre");return l.className="diff-plain",l.style.whiteSpace="pre-wrap",l.style.wordBreak="break-word",l.textContent=a,r.appendChild(c),r.appendChild(l),r}return o.forEach(i=>{if(n==="before"&&i.type==="added"||n==="after"&&i.type==="removed")return;let s=document.createElement("span");s.className="diff-seg",i.type==="added"&&s.classList.add("diff-seg--added"),i.type==="removed"&&s.classList.add("diff-seg--removed"),s.textContent=i.value,r.appendChild(s)}),r}function Dc(e={}){let t=Sn(),{overlay:n,card:r,confirmBtn:o,cancelBtn:i,form:s}=Nn(e),a=!1,c=()=>{},l=()=>{n.classList.add("modal-overlay--hide"),setTimeout(()=>n.remove(),150),document.removeEventListener("keydown",h)},u=g=>{a||(a=!0,l(),c(g))},h=g=>{g.code==="Escape"&&(g.preventDefault(),u(!1)),g.code==="Enter"&&(g.preventDefault(),u(!0))};return new Promise(g=>{c=g,s.addEventListener("submit",b=>{b.preventDefault(),u(!0)}),o.addEventListener("click",()=>u(!0)),i.addEventListener("click",()=>u(!1)),n.addEventListener("click",b=>{b.target===n&&u(!1)}),document.addEventListener("keydown",h),t.appendChild(n),requestAnimationFrame(()=>{r.focus({preventScroll:!0})})})}function or(e={}){let t=Sn(),n=null,r=null,o=Array.isArray(e.suggestions)?e.suggestions:[],i=null,{overlay:s,card:a,confirmBtn:c,cancelBtn:l,form:u}=Nn({...e,renderBody:()=>{let x=document.createDocumentFragment();if(e.message){let I=document.createElement("p");I.className="modal-body__text",I.textContent=e.message,x.appendChild(I)}let A=document.createElement("input");if(A.type=e.inputType==="password"?"password":"text",A.className="modal-input",A.placeholder=e.placeholder||"",A.value=e.defaultValue||"",A.autocomplete="off",x.appendChild(A),e.checkbox&&typeof e.checkbox=="object"){let I=document.createElement("label");I.className="modal-checkbox";let N=document.createElement("input");N.type="checkbox",N.checked=!!e.checkbox.checked,N.disabled=!!e.checkbox.disabled;let O=document.createElement("span");O.className="modal-checkbox__label",O.textContent=String(e.checkbox.label||"").trim(),I.appendChild(N),I.appendChild(O),x.appendChild(I),r=N}return o.length&&(i=document.createElement("div"),i.className="modal-suggestions",x.appendChild(i)),n=A,x}}),h=!1,g=()=>{},b=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",p)},S=x=>{if(!h)if(h=!0,b(),e.returnMeta){let A={value:x??null,selectedId:n?.dataset?.selectedId||null,checkboxChecked:r?!!r.checked:null};g(A)}else g(x)},p=x=>{if(x.code==="Escape"){x.preventDefault(),S(null);return}if(x.code==="Enter"&&n&&!e.hideConfirm){let A=n.value.trim();if(!A&&!e.allowEmpty)return;x.preventDefault(),S(A)}},f=()=>{if(!c||!n)return;let x=!!n.value.trim();c.disabled=!x&&!e.allowEmpty},w=()=>{if(!i||!n)return;let x=n.value.trim().toLowerCase();n.dataset.selectedId="";let A=o.filter(I=>(I.title||"").toLowerCase().includes(x)||(I.id||"").toLowerCase().includes(x)).slice(0,8);if(i.innerHTML="",!x||!A.length){i.classList.add("hidden");return}i.classList.remove("hidden"),A.forEach(I=>{let N=document.createElement("button");N.type="button",N.className="modal-suggestion",N.textContent=I.title||I.id||"",N.addEventListener("click",()=>{n.value=I.title||I.id||"",n.dataset.selectedId=I.id||"",f(),w(),S(n.value)}),i.appendChild(N)})};return new Promise(x=>{g=x,c.classList.remove("danger-btn"),e.hideConfirm?c.style.display="none":c.textContent=e.confirmText||"OK",l.textContent=e.cancelText||"Cancel";let A=()=>{if(!n){S(null);return}let I=n.value.trim();if(!I){n.focus();return}S(I)};u.addEventListener("submit",I=>{I.preventDefault(),A()}),c.addEventListener("click",A),l.addEventListener("click",()=>S(null)),s.addEventListener("click",I=>{I.target===s&&S(null)}),document.addEventListener("keydown",p),n?(n.dataset.selectedId="",n.addEventListener("input",()=>{n.dataset.selectedId="",f(),o.length&&w()}),e.hideConfirm&&n.addEventListener("keydown",I=>{I.code==="Enter"&&(I.preventDefault(),S(n.value.trim()))}),f(),o.length&&w()):f(),t.appendChild(s),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):a.focus({preventScroll:!0})})})}function of(e={}){let t=Sn(),n=null,r=null,o=Array.isArray(e.suggestions)?e.suggestions:[],i=null,{overlay:s,card:a,confirmBtn:c,cancelBtn:l,form:u}=Nn({title:e.title||"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",renderBody:()=>{let x=document.createDocumentFragment();if(e.message){let U=document.createElement("p");U.className="modal-body__text",U.textContent=e.message,x.appendChild(U)}let A=document.createElement("label");A.className="modal-label",A.textContent=e.articleLabel||"\u0421\u0442\u0430\u0442\u044C\u044F";let I=document.createElement("input");I.type="text",I.className="modal-input",I.placeholder=e.articlePlaceholder||"ID \u0438\u043B\u0438 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435\u2026",I.value=e.defaultArticleValue||"",I.autocomplete="off",A.appendChild(I),x.appendChild(A),n=I,o.length&&(i=document.createElement("div"),i.className="modal-suggestions",x.appendChild(i));let N=document.createElement("label");N.className="modal-label",N.textContent=e.textLabel||"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)";let O=document.createElement("input");return O.type="text",O.className="modal-input",O.placeholder=e.textPlaceholder||"",O.value=e.defaultTextValue||"",O.autocomplete="off",N.appendChild(O),x.appendChild(N),r=O,x}}),h=!1,g=()=>{},b=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",w)},S=x=>{h||(h=!0,b(),g(x))},p=()=>{if(!c||!n)return;let x=!!n.value.trim()||!!n.dataset.selectedId;c.disabled=!x},f=()=>{if(!i||!n)return;let x=n.value.trim().toLowerCase();n.dataset.selectedId="";let A=o.filter(I=>(I.title||"").toLowerCase().includes(x)||(I.id||"").toLowerCase().includes(x)).slice(0,8);if(i.innerHTML="",!x||!A.length){i.classList.add("hidden");return}i.classList.remove("hidden"),A.forEach(I=>{let N=document.createElement("button");N.type="button",N.className="modal-suggestion",N.textContent=I.title||I.id||"",N.addEventListener("click",()=>{n.value=I.title||I.id||"",n.dataset.selectedId=I.id||"",p(),f(),r&&!r.value.trim()&&!e.lockTextValue&&(r.value=I.title||""),r?.focus?.({preventScroll:!0}),r?.select?.()}),i.appendChild(N)})},w=x=>{if(x.code==="Escape"){x.preventDefault(),S(null);return}x.code};return new Promise(x=>{g=x,c.classList.remove("danger-btn"),c.textContent=e.confirmText||"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",l.textContent=e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430";let A=()=>{if(!n||!r){S(null);return}let I=n.value.trim(),N=n.dataset.selectedId||"";if(!I&&!N){n.focus();return}S({articleValue:I,selectedId:N||null,textValue:r.value??""})};u.addEventListener("submit",I=>{I.preventDefault(),A()}),c.addEventListener("click",A),l.addEventListener("click",()=>S(null)),s.addEventListener("click",I=>{I.target===s&&S(null)}),document.addEventListener("keydown",w),n?(n.dataset.selectedId="",n.addEventListener("input",()=>{n.dataset.selectedId="",p(),o.length&&f()}),p(),o.length&&f()):p(),t.appendChild(s),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):a.focus({preventScroll:!0})})})}function sf(e={}){let t=Sn(),n=null,r=e.url||"",{overlay:o,card:i,confirmBtn:s,cancelBtn:a}=Nn({title:e.title||"\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u0430\u044F \u0441\u0441\u044B\u043B\u043A\u0430",renderBody:()=>{let p=document.createDocumentFragment(),f=document.createElement("label");f.className="modal-label",f.textContent=e.label||"\u041F\u0440\u043E\u0441\u043C\u043E\u0442\u0440 \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435";let w=document.createElement("input");return w.type="text",w.className="modal-input",w.value=r,w.readOnly=!0,w.autocomplete="off",f.appendChild(w),n=w,p.appendChild(f),p}}),c=!1,l=()=>{},u=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",g)},h=()=>{c||(c=!0,u(),l())},g=p=>{p.code==="Escape"&&(p.preventDefault(),h())},b=p=>{if(!p)return!1;let f=document.createElement("textarea");f.value=p,f.setAttribute("readonly",""),f.style.position="absolute",f.style.left="-9999px",document.body.appendChild(f),f.focus(),f.select();let w=!1;try{w=document.execCommand("copy")}catch{w=!1}return document.body.removeChild(f),w},S=()=>{let p=n&&n.value||r;if(p){Ee("\u0421\u0441\u044B\u043B\u043A\u0430 \u0441\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u0430");try{if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function"){let f=navigator.clipboard.writeText(p);f&&typeof f.catch=="function"&&f.catch(()=>{b(p)})}else b(p)}catch{b(p)}}};return new Promise(p=>{l=p,s.classList.remove("danger-btn"),s.innerHTML='<i class="bx bx-copy" aria-hidden="true"></i> \u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443',s.setAttribute("aria-label",e.copyLabel||"\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443"),a.classList.add("hidden"),s.addEventListener("click",()=>{S(),h()}),o.addEventListener("click",f=>{f.target===o&&h()}),document.addEventListener("keydown",g),t.appendChild(o),requestAnimationFrame(()=>{n?n.focus({preventScroll:!0}):i.focus({preventScroll:!0})})})}function af(e={}){let t=Sn(),n=Array.isArray(e.versions)?e.versions:[],r=n[0]?.id||"",o=w=>{try{let x=new Date(w);return Number.isNaN(x.getTime())?String(w||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(x)}catch{return String(w||"")}},{overlay:i,card:s,confirmBtn:a,cancelBtn:c,form:l}=Nn({title:e.title||"\u0412\u0435\u0440\u0441\u0438\u0438",confirmText:e.confirmText||"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",cancelText:e.cancelText||"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",renderBody:()=>{let w=document.createDocumentFragment(),x=document.createElement("p");if(x.className="modal-body__text",x.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0435\u0440\u0441\u0438\u044E \u0441\u0442\u0430\u0442\u044C\u0438 \u0434\u043B\u044F \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F.",w.appendChild(x),!n.length){let I=document.createElement("div");return I.className="modal-empty",I.textContent="\u0412\u0435\u0440\u0441\u0438\u0439 \u043F\u043E\u043A\u0430 \u043D\u0435\u0442.",w.appendChild(I),w}let A=document.createElement("div");return A.className="modal-list",n.forEach((I,N)=>{let O=document.createElement("label");O.className="modal-list__item";let U=document.createElement("input");U.type="radio",U.name="version",U.value=I.id||"",U.checked=N===0,U.addEventListener("change",()=>{r=U.value,a.disabled=!r,u.disabled=!r});let H=document.createElement("div");H.className="modal-list__meta";let X=document.createElement("div");X.className="modal-list__title",X.textContent=I.label||o(I.created_at||I.createdAt);let G=document.createElement("div");G.className="modal-list__subtitle";let oe=I.reason||"",xe=o(I.created_at||I.createdAt);G.textContent=[xe,oe].filter(Boolean).join(" \xB7 "),H.appendChild(X),H.appendChild(G),O.appendChild(U),O.appendChild(H),A.appendChild(O)}),w.appendChild(A),w}});s.classList.add("modal-card--diff-light"),a.classList.remove("danger-btn"),a.disabled=!r;let u=document.createElement("button");u.type="button",u.className="ghost",u.textContent=e.compareText||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C",u.disabled=!r;let h=s.querySelector(".modal-footer");h&&h.insertBefore(u,a);let g=!1,b=()=>{},S=()=>{i.classList.add("modal-overlay--hide"),setTimeout(()=>i.remove(),150),document.removeEventListener("keydown",f)},p=w=>{g||(g=!0,S(),b(w))},f=w=>{w.code==="Escape"&&(w.preventDefault(),p(null))};return new Promise(w=>{b=w;let x=()=>{r&&p({action:"restore",versionId:r})};l.addEventListener("submit",A=>{A.preventDefault(),x()}),a.addEventListener("click",x),u.addEventListener("click",()=>{r&&p({action:"compare",versionId:r})}),c.addEventListener("click",()=>p(null)),i.addEventListener("click",A=>{A.target===i&&p(null)}),document.addEventListener("keydown",f),t.appendChild(i),requestAnimationFrame(()=>{s.focus({preventScroll:!0})})})}function cf(e={}){let t=Sn(),n=Array.isArray(e.versions)?e.versions:[],r=String(e.excludeId||""),o=[{kind:"current",id:"__current__",title:"\u0422\u0435\u043A\u0443\u0449\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F"},...n.filter(f=>String(f.id||"")&&String(f.id||"")!==r).map(f=>({kind:"version",id:String(f.id),title:f.label||f.created_at||f.createdAt||f.id}))],i=o[0]?.id||"",{overlay:s,card:a,confirmBtn:c,cancelBtn:l,form:u}=Nn({title:e.title||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C \u0441\u2026",confirmText:e.confirmText||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C",cancelText:e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430",renderBody:()=>{let f=document.createDocumentFragment(),w=document.createElement("p");w.className="modal-body__text",w.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0442\u043E\u0440\u0443\u044E \u0441\u0442\u043E\u0440\u043E\u043D\u0443 \u0441\u0440\u0430\u0432\u043D\u0435\u043D\u0438\u044F.",f.appendChild(w);let x=document.createElement("div");return x.className="modal-list",o.forEach((A,I)=>{let N=document.createElement("label");N.className="modal-list__item";let O=document.createElement("input");O.type="radio",O.name="compareTarget",O.value=A.id,O.checked=I===0,O.addEventListener("change",()=>{i=O.value,c.disabled=!i});let U=document.createElement("div");U.className="modal-list__meta";let H=document.createElement("div");H.className="modal-list__title",H.textContent=A.title,U.appendChild(H),N.appendChild(O),N.appendChild(U),x.appendChild(N)}),f.appendChild(x),f}});a.classList.add("modal-card--diff-light"),c.classList.remove("danger-btn"),c.disabled=!i;let h=!1,g=()=>{},b=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",p)},S=f=>{h||(h=!0,b(),g(f))},p=f=>{f.code==="Escape"&&(f.preventDefault(),S(null))};return new Promise(f=>{g=f;let w=()=>{if(!i)return;let x=o.find(A=>A.id===i)||null;if(!x){S(null);return}if(x.kind==="current"){S({target:"current"});return}S({target:"version",versionId:x.id})};u.addEventListener("submit",x=>{x.preventDefault(),w()}),c.addEventListener("click",w),l.addEventListener("click",()=>S(null)),s.addEventListener("click",x=>{x.target===s&&S(null)}),document.addEventListener("keydown",p),t.appendChild(s),requestAnimationFrame(()=>{a.focus({preventScroll:!0})})})}function lf(e={}){let t=Sn(),n=Array.isArray(e.changes)?e.changes:[],r=n.find(b=>b.type==="changed")||n[0]||null,{overlay:o,card:i,confirmBtn:s,cancelBtn:a}=Nn({title:e.title||"\u041E\u0442\u043B\u0438\u0447\u0438\u044F \u0432\u0435\u0440\u0441\u0438\u0439",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:"",renderBody:()=>{let b=document.createDocumentFragment(),S=document.createElement("div");S.className="diff-summary";let p=n.reduce((X,G)=>(X[G.type]=(X[G.type]||0)+1,X),{added:0,removed:0,changed:0});if(S.textContent=`\u0418\u0437\u043C\u0435\u043D\u0435\u043D\u043E: ${p.changed||0} \xB7 \u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E: ${p.added||0} \xB7 \u0423\u0434\u0430\u043B\u0435\u043D\u043E: ${p.removed||0}`,b.appendChild(S),!n.length){let X=document.createElement("div");return X.className="modal-empty",X.textContent="\u041D\u0435\u0442 \u043E\u0442\u043B\u0438\u0447\u0438\u0439.",b.appendChild(X),b}let f=document.createElement("div");f.className="modal-list",n.forEach(X=>{let G=document.createElement("button");G.type="button",G.className=`diff-item diff-item--${X.type}${r&&r.id===X.id?" diff-item--active":""}`;let oe=X.label||X.id;G.textContent=`${X.type==="changed"?"\u2260":X.type==="added"?"+":"\u2212"} ${oe}`,G.addEventListener("click",()=>{r=X,f.querySelectorAll(".diff-item").forEach(xe=>xe.classList.remove("diff-item--active")),G.classList.add("diff-item--active"),H()}),f.appendChild(G)}),b.appendChild(f);let w=document.createElement("div");w.className="diff-panes";let x=document.createElement("div");x.className="diff-pane-wrap";let A=document.createElement("div");A.className="diff-pane-wrap";let I=document.createElement("div");I.className="diff-pane-title",I.textContent=e.beforeTitle||"\u0412\u0435\u0440\u0441\u0438\u044F";let N=document.createElement("div");N.className="diff-pane-title",N.textContent=e.afterTitle||"\u0422\u0435\u043A\u0443\u0449\u0430\u044F";let O=document.createElement("div");O.className="diff-pane diff-pane--before";let U=document.createElement("div");U.className="diff-pane diff-pane--after",x.appendChild(I),x.appendChild(O),A.appendChild(N),A.appendChild(U),w.appendChild(x),w.appendChild(A),b.appendChild(w);let H=()=>{let X=r?.before||"",G=r?.after||"";O.innerHTML="",U.innerHTML="",O.appendChild(Ur({baseText:X,nextText:G,mode:"before"})),U.appendChild(Ur({baseText:X,nextText:G,mode:"after"}))};return H(),b}});i.classList.add("modal-card--fullscreen"),i.classList.add("modal-card--diff-light"),s.classList.remove("danger-btn"),a&&(a.style.display="none");let c=!1,l=()=>{},u=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",g)},h=()=>{c||(c=!0,u(),l())},g=b=>{b.code==="Escape"&&(b.preventDefault(),h())};return new Promise(b=>{l=b,s.addEventListener("click",h),o.addEventListener("click",S=>{S.target===o&&h()}),document.addEventListener("keydown",g),t.appendChild(o),requestAnimationFrame(()=>{i.focus({preventScroll:!0})})})}function df(e={}){let t=Sn(),n=Array.isArray(e.entries)?e.entries:[],r=n[0]||null,o=r,i=[],s=null,a=w=>{try{let x=new Date(w);return Number.isNaN(x.getTime())?String(w||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(x)}catch{return String(w||"")}},{overlay:c,card:l,confirmBtn:u,cancelBtn:h}=Nn({title:e.title||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0431\u043B\u043E\u043A\u0430",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:e.canRestore?"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C (\u043F\u043E\u0441\u043B\u0435 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F)":"",renderBody:()=>{let w=document.createDocumentFragment(),x=document.createElement("p");if(x.className="modal-body__text",x.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0435. \u041C\u043E\u0436\u043D\u043E \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430 \u0434\u043E \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F.",w.appendChild(x),!n.length){let te=document.createElement("div");return te.className="modal-empty",te.textContent="\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430.",w.appendChild(te),w}let A=document.createElement("div");A.className="diff-layout";let I=document.createElement("div");I.className="modal-list diff-sidebar",i=[],n.forEach(te=>{let be=document.createElement("button");be.type="button";let Qe=!!(r&&r.id===te.id);be.className=`diff-item${Qe?" diff-item--active":""}`,be.setAttribute("aria-selected",Qe?"true":"false");let kt=a(te.timestamp);be.textContent=kt?`\u2260 ${kt}`:`\u2260 ${te.id||""}`.trim(),be.addEventListener("click",()=>{r=te,I.querySelectorAll(".diff-item").forEach(Ot=>{Ot.classList.remove("diff-item--active"),Ot.setAttribute("aria-selected","false")}),be.classList.add("diff-item--active"),be.setAttribute("aria-selected","true"),ve()}),I.appendChild(be),i.push(be)});let N=document.createElement("div");N.className="diff-main";let O=document.createElement("div");O.className="diff-panes diff-panes--side";let U=document.createElement("div");U.className="diff-pane-wrap";let H=document.createElement("div");H.className="diff-pane-wrap";let X=document.createElement("div");X.className="diff-pane-title",X.textContent=e.beforeTitle||"\u0414\u043E";let G=document.createElement("div");G.className="diff-pane-title",G.textContent=e.afterTitle||"\u041F\u043E\u0441\u043B\u0435";let oe=document.createElement("div");oe.className="diff-pane diff-pane--before";let xe=document.createElement("div");xe.className="diff-pane diff-pane--after",U.appendChild(X),U.appendChild(oe),H.appendChild(G),H.appendChild(xe),O.appendChild(U),O.appendChild(H),N.appendChild(O),A.appendChild(I),A.appendChild(N),w.appendChild(A);let ve=()=>{o=r;let te=r?.beforePlain||r?.before||"",be=r?.afterPlain||r?.after||"";oe.innerHTML="",xe.innerHTML="",oe.appendChild(Ur({baseText:te,nextText:be,mode:"before"})),xe.appendChild(Ur({baseText:te,nextText:be,mode:"after"}))};return s=ve,ve(),w}});l.classList.add("modal-card--fullscreen"),l.classList.add("modal-card--diff-light"),u.classList.remove("danger-btn"),!e.canRestore&&h&&(h.style.display="none"),h&&h.classList.add("danger-btn");let g=!1,b=()=>{},S=()=>{c.classList.add("modal-overlay--hide"),setTimeout(()=>c.remove(),150),document.removeEventListener("keydown",f)},p=w=>{g||(g=!0,S(),b(w))},f=w=>{if(w.code==="Escape"&&(w.preventDefault(),p(null)),w.code==="ArrowUp"||w.code==="ArrowDown"){if(!n.length)return;w.preventDefault();let x=String(r?.id||""),A=n.findIndex(O=>String(O?.id||"")===x);A<0&&(A=0),A=w.code==="ArrowUp"?Math.max(0,A-1):Math.min(n.length-1,A+1);let I=n[A]||null;if(!I)return;r=I;let N=i[A];if(i.forEach(O=>{O.classList.remove("diff-item--active"),O.setAttribute("aria-selected","false")}),N){N.classList.add("diff-item--active"),N.setAttribute("aria-selected","true"),N.focus({preventScroll:!0});try{N.scrollIntoView({block:"nearest"})}catch{}}typeof s=="function"&&s()}};return new Promise(w=>{b=w,u.addEventListener("click",()=>p(null)),h&&e.canRestore&&h.addEventListener("click",()=>p({action:"restore",entry:o||r||null})),c.addEventListener("click",x=>{x.target===c&&p(null)}),document.addEventListener("keydown",f),t.appendChild(c),requestAnimationFrame(()=>{l.focus({preventScroll:!0})})})}function _c(e){let t=[],n=r=>{if(!r)return;if(typeof r=="string"){t.push(r);return}if(Array.isArray(r)){r.forEach(n);return}if(typeof r!="object")return;typeof r.text=="string"&&t.push(r.text);let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(e),t.join("").replace(/\u00a0/g," ").trim()}function uf(e){return!e||typeof e!="object"?!1:!!(e.beforeHeadingJson||e.beforeBodyJson||e.afterHeadingJson||e.afterBodyJson)}function ff(e={}){let t=Sn(),r=(Array.isArray(e.entries)?e.entries:[]).filter(uf),o=typeof e.onRestore=="function"?e.onRestore:null,i=H=>String(H??"").replace(/\u00a0/g," ").trim(),s=r.map(H=>({...H,beforePlain:i(H.beforePlain??H.before??""),afterPlain:i(H.afterPlain??H.after??"")})),a=new Map;for(let H of s){let X=String(H?.blockId||"").trim();if(!X)continue;let G=a.get(X)||{blockId:X,entries:[],latestAt:0,label:""};G.entries.push(H);let oe=Date.parse(H.timestamp||"")||0;if(oe>G.latestAt&&(G.latestAt=oe),!G.label){let xe=_c(H.afterHeadingJson)||_c(H.beforeHeadingJson)||"",ve=(H.afterPlain||H.beforePlain||"").split(`
`).map(te=>te.trim()).find(Boolean)||"";G.label=xe||ve||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"}a.set(X,G)}let c=Array.from(a.values()).sort((H,X)=>(X.latestAt||0)-(H.latestAt||0)),l=c[0]?.blockId||null,u=null,h=!1,g=H=>{try{let X=new Date(H);return Number.isNaN(X.getTime())?String(H||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(X)}catch{return String(H||"")}},{overlay:b,card:S,confirmBtn:p,cancelBtn:f}=Nn({title:e.title||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0441\u0442\u0430\u0442\u044C\u0438",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:e.canRestore?"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C":"",renderBody:()=>{let H=document.createDocumentFragment(),X=document.createElement("p");if(X.className="modal-body__text",X.textContent=e.message||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439 outline-\u0440\u0435\u0436\u0438\u043C\u0430. \u041C\u043E\u0436\u043D\u043E \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0435 \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0441\u0435\u043A\u0446\u0438\u0438 (\u0435\u0441\u043B\u0438 \u0441\u0435\u043A\u0446\u0438\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u2014 \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u043D\u0435\u0446 \u0441\u0442\u0430\u0442\u044C\u0438).",H.appendChild(X),!c.length){let Rt=document.createElement("div");return Rt.className="modal-empty",Rt.textContent="\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430.",H.appendChild(Rt),H}let G=document.createElement("div");G.className="diff-layout diff-layout--article-history";let oe=document.createElement("div");oe.className="modal-list diff-sidebar",oe.classList.add("diff-sections");let xe=document.createElement("input");xe.type="text",xe.className="modal-input",xe.placeholder="\u041F\u043E\u0438\u0441\u043A \u043F\u043E \u0438\u0441\u0442\u043E\u0440\u0438\u0438\u2026",oe.appendChild(xe);let ve=document.createElement("div");ve.style.marginTop="8px",oe.appendChild(ve);let te=document.createElement("div");te.className="diff-main";let be=document.createElement("div");be.className="diff-layout diff-layout--article-history-inner";let Qe=document.createElement("div");Qe.className="modal-list diff-sidebar",Qe.classList.add("diff-revisions");let kt=document.createElement("div");kt.className="diff-panes diff-panes--side";let Ot=document.createElement("div");Ot.className="diff-pane-wrap";let ln=document.createElement("div");ln.className="diff-pane-wrap";let gn=document.createElement("div");gn.className="diff-pane-title",gn.textContent=e.beforeTitle||"\u0414\u043E";let In=document.createElement("div");In.className="diff-pane-title",In.textContent=e.afterTitle||"\u041F\u043E\u0441\u043B\u0435";let Pn=document.createElement("div");Pn.className="diff-pane diff-pane--before";let Un=document.createElement("div");Un.className="diff-pane diff-pane--after",Ot.appendChild(gn),Ot.appendChild(Pn),ln.appendChild(In),ln.appendChild(Un),kt.appendChild(Ot),kt.appendChild(ln),be.appendChild(Qe),be.appendChild(kt),te.appendChild(be),G.appendChild(oe),G.appendChild(te),H.appendChild(G);let qn=()=>{let Rt=xe.value.trim().toLowerCase(),jt=Rt?c.filter(Ct=>(Ct.label||"").toLowerCase().includes(Rt)?!0:(Ct.entries||[]).some(yt=>`${yt.beforePlain||""}
${yt.afterPlain||""}`.toLowerCase().includes(Rt))):c;ve.innerHTML="",jt.forEach(Ct=>{let yt=document.createElement("button");yt.type="button";let zt=Ct.blockId===l;yt.className=`diff-item${zt?" diff-item--active":""}`,yt.setAttribute("aria-selected",zt?"true":"false");let En=Ct.latestAt?g(new Date(Ct.latestAt).toISOString()):"",W=Array.isArray(Ct.entries)?Ct.entries.length:0;yt.textContent=`${Ct.label||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"}${En?` \xB7 ${En}`:""}${W?` \xB7 ${W}`:""}`,yt.addEventListener("click",()=>{l=Ct.blockId,u=null,h=!1,qn(),_n(),Dn()}),ve.appendChild(yt)}),l&&!jt.some(Ct=>Ct.blockId===l)&&(l=jt[0]?.blockId||null,u=null,h=!1,_n(),Dn())},_n=()=>{let Rt=l?a.get(l):null,jt=Array.isArray(Rt?.entries)?Rt.entries.slice():[];jt.sort((yt,zt)=>(Date.parse(zt.timestamp||"")||0)-(Date.parse(yt.timestamp||"")||0));let Ct=u&&jt.some(yt=>String(yt?.id||"")===String(u||""));(!h||!Ct)&&(u=jt[0]?.id||null),Qe.innerHTML="",jt.forEach(yt=>{let zt=document.createElement("button");zt.type="button";let En=String(yt.id||"")===String(u||"");zt.className=`diff-item${En?" diff-item--active":""}`,zt.setAttribute("aria-selected",En?"true":"false");let W=g(yt.timestamp),ce=(yt.afterPlain||yt.beforePlain||"").slice(0,64).trim();zt.textContent=`${W?`\u2260 ${W}`:`\u2260 ${yt.id||""}`}${ce?` \xB7 ${ce}`:""}`,zt.addEventListener("click",()=>{u=yt.id||null,h=!0,_n(),Dn()}),Qe.appendChild(zt)})},Dn=()=>{let Rt=l?a.get(l):null,jt=Array.isArray(Rt?.entries)?Rt.entries:[],Ct=jt.find(En=>String(En?.id||"")===String(u||""))||jt[0]||null,yt=Ct?.beforePlain||"",zt=Ct?.afterPlain||"";Pn.innerHTML="",Un.innerHTML="",Pn.appendChild(Ur({baseText:yt,nextText:zt,mode:"before"})),Un.appendChild(Ur({baseText:yt,nextText:zt,mode:"after"}))};return xe.addEventListener("input",()=>{qn()}),qn(),_n(),Dn(),H}});S.classList.add("modal-card--fullscreen"),S.classList.add("modal-card--diff-light"),p.classList.remove("danger-btn"),!e.canRestore&&f&&(f.style.display="none"),f&&f.classList.add("danger-btn");let w=!1,x=()=>{},A=!1,I=()=>{b.classList.add("modal-overlay--hide"),setTimeout(()=>b.remove(),150),document.removeEventListener("keydown",O)},N=H=>{w||(w=!0,I(),x(H))},O=H=>{H.code==="Escape"&&(H.preventDefault(),N(null))},U=()=>{let H=l?a.get(l):null,X=Array.isArray(H?.entries)?H.entries:[];return X.find(G=>String(G?.id||"")===String(u||""))||X[0]||null};return new Promise(H=>{x=H,p.addEventListener("click",()=>N(null)),f&&e.canRestore&&f.addEventListener("click",async()=>{let X=U();if(!X){Ee("\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430");return}if(!o){N({action:"restore",entry:X});return}if(A)return;A=!0;let G=f.textContent;try{f.disabled=!0,p.disabled=!0,f.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C\u2026",await o(X)}catch(oe){Ee(oe?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C")}finally{A=!1,f.textContent=G,f.disabled=!1,p.disabled=!1}}),b.addEventListener("click",X=>{X.target===b&&N(null)}),document.addEventListener("keydown",O),t.appendChild(b),requestAnimationFrame(()=>{S.focus({preventScroll:!0})})})}function ys(e={}){let t=Sn(),n=null,r=null,{overlay:o,card:i,confirmBtn:s,cancelBtn:a,form:c}=Nn({...e,renderBody:()=>{let p=document.createDocumentFragment();if(e.message){let I=document.createElement("p");I.className="modal-body__text",I.textContent=e.message,p.appendChild(I)}let f=document.createElement("label");f.className="modal-label",f.textContent=e.textLabel||"\u0422\u0435\u043A\u0441\u0442";let w=document.createElement("input");w.type="text",w.className="modal-input",w.placeholder=e.textPlaceholder||"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438",w.value=e.defaultText||"",w.autocomplete="off",f.appendChild(w);let x=document.createElement("label");x.className="modal-label",x.textContent=e.urlLabel||"\u0421\u0441\u044B\u043B\u043A\u0430";let A=document.createElement("input");return A.type="text",A.className="modal-input",A.placeholder=e.urlPlaceholder||"https://example.com",A.value=e.defaultUrl||"",A.autocomplete="off",x.appendChild(A),n=w,r=A,p.appendChild(f),p.appendChild(x),p}}),l=!1,u=()=>{},h=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",b)},g=p=>{l||(l=!0,h(),u(p))},b=p=>{if(p.code==="Escape"){p.preventDefault(),g(null);return}p.code==="Enter"&&!s.disabled&&(p.preventDefault(),g({text:(n?.value||"").trim(),url:(r?.value||"").trim()}))},S=()=>{let p=!!(r?.value||"").trim();s.disabled=!p};return new Promise(p=>{u=p,s.classList.remove("danger-btn"),s.textContent=e.confirmText||"OK",a.textContent=e.cancelText||"Cancel";let f=()=>{g({text:(n?.value||"").trim(),url:(r?.value||"").trim()})};c.addEventListener("submit",x=>{x.preventDefault(),s.disabled||f()}),s.addEventListener("click",f),a.addEventListener("click",()=>g(null)),o.addEventListener("click",x=>{x.target===o&&g(null)}),document.addEventListener("keydown",b);let w=x=>{x&&x.addEventListener("input",S)};w(n),w(r),S(),t.appendChild(o),requestAnimationFrame(()=>{r?(r.focus({preventScroll:!0}),r.value&&r.setSelectionRange(r.value.length,r.value.length)):i.focus({preventScroll:!0})})})}function Oc(e={}){let t=Sn(),n=null,r=null,{overlay:o,card:i,confirmBtn:s,cancelBtn:a,form:c}=Nn({...e,renderBody:()=>{let p=document.createDocumentFragment();if(e.message){let I=document.createElement("p");I.className="modal-body__text",I.textContent=e.message,p.appendChild(I)}let f=document.createElement("label");f.className="modal-label",f.textContent="\u041F\u0430\u0440\u043E\u043B\u044C";let w=document.createElement("input");w.type="password",w.className="modal-input",w.placeholder="\u041F\u0430\u0440\u043E\u043B\u044C \u0434\u043B\u044F \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B",w.autocomplete="off",f.appendChild(w);let x=document.createElement("label");x.className="modal-label",x.textContent="\u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0430 (\u043D\u0435\u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u044C\u043D\u043E)";let A=document.createElement("input");return A.type="text",A.className="modal-input",A.placeholder="\u041D\u0430\u043F\u043E\u043C\u0438\u043D\u0430\u043D\u0438\u0435 \u043E \u043F\u0430\u0440\u043E\u043B\u0435",A.autocomplete="off",x.appendChild(A),n=w,r=A,p.appendChild(f),p.appendChild(x),p}}),l=!1,u=()=>{},h=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",b)},g=p=>{l||(l=!0,h(),u(p))},b=p=>{if(p.code==="Escape"){p.preventDefault(),g(null);return}p.code==="Enter"&&!s.disabled&&(p.preventDefault(),g({password:(n?.value||"").trim(),hint:(r?.value||"").trim()}))},S=()=>{let p=!!(n?.value||"").trim();s.disabled=!p};return new Promise(p=>{u=p,s.classList.remove("danger-btn"),s.textContent=e.confirmText||"\u0417\u0430\u0449\u0438\u0442\u0438\u0442\u044C",a.textContent=e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430";let f=()=>{s.disabled||g({password:(n?.value||"").trim(),hint:(r?.value||"").trim()})};s.addEventListener("click",f),c.addEventListener("submit",w=>{w.preventDefault(),f()}),a.addEventListener("click",()=>g(null)),o.addEventListener("click",w=>{w.target===o&&g(null)}),document.addEventListener("keydown",b),n&&n.addEventListener("input",S),S(),t.appendChild(o),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):i.focus({preventScroll:!0})})})}function pf(e={}){let t=Sn(),n=Array.isArray(e.items)?e.items:[],{overlay:r,card:o,confirmBtn:i,cancelBtn:s}=Nn({title:e.title||"\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432",renderBody:()=>{let g=document.createElement("div");if(!n.length){let S=document.createElement("p");return S.className="modal-body__text",S.textContent="\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432 \u043F\u0443\u0441\u0442\u0430",g.appendChild(S),g}let b=document.createElement("div");return b.className="block-trash-list",n.forEach(S=>{let p=document.createElement("div");p.className="block-trash-item";let f=S.block&&S.block.text||"",w=Lc(f),x=document.createElement("div");x.className="block-trash-item__title",x.textContent=w[0]||"(\u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A)";let A=document.createElement("div");A.className="block-trash-item__meta";let I=S.deletedAt?new Date(S.deletedAt).toLocaleString():"";A.textContent=I||"";let N=document.createElement("div");N.className="block-trash-item__info",N.appendChild(x),I&&N.appendChild(A);let O=document.createElement("button");O.type="button",O.className="primary",O.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",O.addEventListener("click",()=>{u(S)}),p.appendChild(N),p.appendChild(O),b.appendChild(p)}),g.appendChild(b),g}}),a=!1,c=()=>{},l=()=>{r.classList.add("modal-overlay--hide"),setTimeout(()=>r.remove(),150),document.removeEventListener("keydown",h)},u=g=>{a||(a=!0,l(),c(g||null))},h=g=>{g.code==="Escape"&&(g.preventDefault(),u(null))};return new Promise(g=>{c=g,i.classList.remove("hidden"),i.textContent="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u043A\u043E\u0440\u0437\u0438\u043D\u0443",i.classList.add("danger-btn"),s.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",i.addEventListener("click",()=>u({action:"clear"})),s.addEventListener("click",()=>u(null)),r.addEventListener("click",b=>{b.target===r&&u(null)}),document.addEventListener("keydown",h),t.appendChild(r),requestAnimationFrame(()=>{o.focus({preventScroll:!0})})})}function mf(e={}){let t=Sn(),{title:n,message:r,existingTitle:o,importedTitle:i,existingCreatedAt:s,existingUpdatedAt:a,importedCreatedAt:c,importedUpdatedAt:l,allowApplyToAll:u=!0}=e||{},h=document.createElement("div");h.className="modal-overlay";let g=document.createElement("div");g.className="modal-card",g.setAttribute("role","dialog"),g.setAttribute("aria-modal","true"),g.tabIndex=-1;let b=document.createElement("div");b.className="modal-header";let S=document.createElement("h3");S.textContent=n||"\u041A\u043E\u043D\u0444\u043B\u0438\u043A\u0442 \u043F\u0440\u0438 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0438",b.appendChild(S);let p=document.createElement("div");if(p.className="modal-body",r){let oe=document.createElement("p");oe.className="modal-body__text",oe.textContent=r,p.appendChild(oe)}if(o||i){let oe=document.createElement("p");oe.className="modal-body__text",oe.innerHTML=[o?`<strong>\u0412 \u0431\u0430\u0437\u0435:</strong> ${o}`:"",i?`<strong>\u0418\u0437 \u0444\u0430\u0439\u043B\u0430:</strong> ${i}`:""].filter(Boolean).join("<br />"),p.appendChild(oe)}if(s||a||c||l){let oe=te=>{if(!te)return"";let be=new Date(te);return Number.isNaN(be.getTime())?te:be.toLocaleString()},xe=document.createElement("p");xe.className="modal-body__text";let ve=[];if(s||a){let te=s?oe(s):"\u2014",be=a?oe(a):"\u2014";ve.push(`<strong>\u0412 \u0431\u0430\u0437\u0435:</strong> \u0441\u043E\u0437\u0434\u0430\u043D\u0430 ${te}, \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430 ${be}`)}if(c||l){let te=c?oe(c):"\u2014",be=l?oe(l):"\u2014";ve.push(`<strong>\u0418\u0437 \u0444\u0430\u0439\u043B\u0430:</strong> \u0441\u043E\u0437\u0434\u0430\u043D\u0430 ${te}, \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430 ${be}`)}xe.innerHTML=ve.join("<br />"),p.appendChild(xe)}let f=null;if(u){let oe=document.createElement("label");oe.className="modal-label";let xe=document.createElement("input");xe.type="checkbox",xe.style.marginRight="0.5rem",oe.appendChild(xe),oe.appendChild(document.createTextNode("\u041F\u0440\u0438\u043C\u0435\u043D\u044F\u0442\u044C \u044D\u0442\u043E \u0440\u0435\u0448\u0435\u043D\u0438\u0435 \u043A\u043E \u0432\u0441\u0435\u043C \u043A\u043E\u043D\u0444\u043B\u0438\u043A\u0442\u0430\u043C")),f=xe,p.appendChild(oe)}let w=document.createElement("div");w.className="modal-footer modal-footer--stacked";let x=document.createElement("button");x.type="button",x.className="ghost",x.textContent="\u041E\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0443\u044E";let A=document.createElement("button");A.type="button",A.className="primary danger-btn",A.textContent="\u041F\u0435\u0440\u0435\u0437\u0430\u043F\u0438\u0441\u0430\u0442\u044C";let I=document.createElement("button");I.type="button",I.className="ghost",I.textContent="\u0421\u043E\u0437\u0434\u0430\u0442\u044C \u043A\u043E\u043F\u0438\u044E";let N=document.createElement("button");N.type="button",N.className="ghost",N.textContent="\u041E\u0442\u043C\u0435\u043D\u0430",w.appendChild(x),w.appendChild(A),w.appendChild(I),w.appendChild(N),g.appendChild(b),g.appendChild(p),g.appendChild(w),h.appendChild(g);let O=!1,U=()=>{},H=()=>{h.classList.add("modal-overlay--hide"),setTimeout(()=>h.remove(),150),document.removeEventListener("keydown",G)},X=oe=>{if(O)return;O=!0;let xe=!!(f&&f.checked);H(),U({action:oe,applyToAll:xe})},G=oe=>{oe.code==="Escape"&&(oe.preventDefault(),X(null))};return new Promise(oe=>{U=oe,x.addEventListener("click",()=>X("keep")),A.addEventListener("click",()=>X("overwrite")),I.addEventListener("click",()=>X("copy")),N.addEventListener("click",()=>X(null)),h.addEventListener("click",xe=>{xe.target===h&&X(null)}),document.addEventListener("keydown",G),t.appendChild(h),requestAnimationFrame(()=>{g.focus({preventScroll:!0})})})}function ho(e,t=""){let n=Sn(),r=document.createElement("div");r.className="modal-overlay image-modal";let o=document.createElement("div");o.className="image-modal__card",o.setAttribute("role","dialog"),o.setAttribute("aria-modal","true"),o.tabIndex=-1;let i=document.createElement("img");i.className="image-modal__img",i.src=e,t&&(i.alt=t),o.appendChild(i),r.appendChild(o);let s,a=()=>{s&&s()},c=l=>{l.code==="Escape"&&(l.preventDefault(),a())};s=()=>{document.removeEventListener("keydown",c),r.classList.add("modal-overlay--hide"),setTimeout(()=>r.remove(),150)},r.addEventListener("click",l=>{l.target===r&&a()}),document.addEventListener("keydown",c),n.appendChild(r),requestAnimationFrame(()=>{o.focus({preventScroll:!0})})}var Pc,ir=Xe(()=>{Rn();rn();Pc="modal-root"});function Rc(e){if(typeof btoa=="function"){let t="";for(let n=0;n<e.length;n+=1)t+=String.fromCharCode(e[n]);return btoa(t)}if(typeof Buffer<"u")return Buffer.from(e).toString("base64");throw new Error("No base64 encoder available")}function Hc(e){if(!e)return new Uint8Array(0);if(typeof atob=="function"){let t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r+=1)n[r]=t.charCodeAt(r);return n}if(typeof Buffer<"u"){let t=Buffer.from(e,"base64"),n=new Uint8Array(t.length);for(let r=0;r<t.length;r+=1)n[r]=t[r];return n}throw new Error("No base64 decoder available")}function ws(e){return typeof e=="string"&&e.startsWith(Ss)}async function $c(e,t){if(!e)throw new Error("Password is required");let n=t&&t.length?Hc(t):Fc(16),r=ei(e||""),o=new Uint8Array(r.length+n.length);return o.set(r,0),o.set(n,r.length),{key:{raw:ei(String.fromCharCode(...o))},salt:Rc(n)}}function ei(e=""){let t=2166136261,n=16777619;for(let o=0;o<e.length;o+=1){let i=e.charCodeAt(o);t^=i,t=t*16777619>>>0,n^=i<<o%8,n=n*16777619>>>0}let r=new Uint8Array(32);for(let o=0;o<32;o+=1){let i=o<16?t:n;r[o]=i>>>o%4*8&255}return r}function Fc(e){let t=new Uint8Array(e);for(let n=0;n<e;n+=1)t[n]=Math.floor(Math.random()*256);return t}async function gf(e,t=""){if(!e)throw new Error("Missing encryption key");let n=e&&e.raw?e.raw:ei("fallback-key"),r=Fc(12),i=new TextEncoder().encode(t||""),s=new Uint8Array(r.length+i.length);s.set(r,0);for(let a=0;a<i.length;a+=1){let c=n[a%n.length],l=r[a%r.length];s[r.length+a]=i[a]^c^l}return`${Ss}${Rc(s)}`}async function xs(e,t){if(!e)throw new Error("Missing encryption key");if(!ws(t))throw new Error("Data is not in encrypted format");let n=t.slice(Ss.length),r=Hc(n);if(r.length<13)throw new Error("Encrypted payload is too short");let o=r.slice(0,12),i=r.slice(12),s=e&&e.raw?e.raw:ei("fallback-key"),a=new Uint8Array(i.length);for(let l=0;l<i.length;l+=1){let u=s[l%s.length],h=o[l%o.length];a[l]=i[l]^u^h}return new TextDecoder().decode(a)}async function zc(e,t){if(!t)return!1;try{return await xs(e,t)===hf}catch{return!1}}async function Uc(e,t){if(!e)return;if(typeof e.text=="string"&&ws(e.text))try{e.text=await xs(t,e.text)}catch{e.text=""}let n=Array.isArray(e.children)?e.children:[];for(let r of n)await Uc(r,t)}async function As(e,t){if(!(!e||!Array.isArray(e.blocks)))for(let n of e.blocks)await Uc(n,t)}async function ks(e,t){return gf(e,t||"")}var Ss,hf,go=Xe(()=>{Ss="enc-v1:",hf="memus-article-encryption-ok"});function wn(e){if(window.location.pathname===e){qc(e);return}window.history.pushState({},"",e),qc(e)}function qc(e){let t=e.match(/^\/p\/([^/?#]+)/);if(t){Es(decodeURIComponent(t[1]));return}let n=e.match(/^\/article\/([0-9a-zA-Z-]+)/);if(n){let r=String(n[1]||"");if(r.startsWith("inbox-")){try{window.history.replaceState({},"",an.article("inbox"))}catch{}ti("inbox");return}ti(r);return}Is()}var an,sr=Xe(()=>{xr();an={list:"/",article:e=>`/article/${e}`,public:e=>`/p/${e}`}});var Kc=Xe(()=>{nr();Bn()});function Vc(){V.searchResults&&V.searchResults.classList.add("hidden")}var jc=Xe(()=>{Pt();Cn();Rn();un();sr();ar();rn();Kc()});function ni(){try{localStorage.setItem(bf,JSON.stringify(d.sidebarCollapsedArticleIds||[]))}catch{}}function ri(){try{localStorage.setItem(Sf,JSON.stringify(d.listCollapsedArticleIds||[]))}catch{}}var bf,Sf,qr=Xe(()=>{Pt();bf="ttree_collapsed_articles",Sf="ttree_list_collapsed_articles"});function Cs(){V.articlesTabBtn&&(V.articlesTabBtn.classList.toggle("active",!d.isTrashView),V.articlesTabBtn.setAttribute("aria-pressed",d.isTrashView?"false":"true")),V.trashTabBtn&&(V.trashTabBtn.classList.toggle("active",d.isTrashView),V.trashTabBtn.setAttribute("aria-pressed",d.isTrashView?"true":"false")),V.createArticleBtn&&(V.createArticleBtn.disabled=d.isTrashView),V.sidebarNewArticleBtn&&(V.sidebarNewArticleBtn.disabled=d.isTrashView)}function oi(){Yi&&(Ua(!1),V.hintPopover&&V.hintPopover.classList.add("hidden"),V.hintToggleBtn&&V.hintToggleBtn.setAttribute("aria-expanded","false"))}function yo(e){d.isSidebarMobileOpen=e,V.sidebar&&V.sidebar.classList.toggle("mobile-open",e),V.sidebarBackdrop&&V.sidebarBackdrop.classList.toggle("hidden",!e),e&&(oi(),Vc())}function bo(e){V.articleView.classList.toggle("hidden",!e),V.articleListView.classList.toggle("hidden",e),V.articleHeader&&V.articleHeader.classList.toggle("hidden",!e),e||oi(),e&&d.isTrashView&&(d.isTrashView=!1,Cs())}var ii=Xe(()=>{Pt();Cn();jc();qr()});function Xc({renderSidebarArticleList:e,renderMainArticleList:t,setArticlesIndex:n}={}){Yc=typeof e=="function"?e:null,vs=typeof t=="function"?t:null,Gc=typeof n=="function"?n:null}function ai(){Hn&&(Hn.classList.remove("drop-before","drop-after","drop-inside"),Hn=null)}function Qc(e,t){e&&(Hn&&Hn!==e&&Hn.classList.remove("drop-before","drop-after","drop-inside"),Hn=e,Hn.classList.remove("drop-before","drop-after","drop-inside"),t==="before"?Hn.classList.add("drop-before"):t==="after"?Hn.classList.add("drop-after"):t==="inside"&&Hn.classList.add("drop-inside"))}function Af(){It&&(It.sourceEl instanceof Element&&It.sourceEl.classList.remove("article-dnd-source"),typeof document<"u"&&document.body&&document.body.classList.remove("article-dnd-active"),window.removeEventListener("pointermove",Ns),window.removeEventListener("pointerup",So),window.removeEventListener("pointercancel",So),window.removeEventListener("touchmove",Zc),window.removeEventListener("touchend",si),window.removeEventListener("touchcancel",si),It=null,ai(),window.__ttreeDraggingArticleId=null)}function Jc(e){return e instanceof Element?!!(e.closest(".star-btn")||e.closest(".row-actions")):!1}function kf(e,t){if(!t||It||!e.touches||e.touches.length!==1)return;let n=e.touches[0],r=e.currentTarget instanceof Element?e.currentTarget:null;It={pointerId:"legacy-touch",articleId:t,startX:n.clientX,startY:n.clientY,dragging:!1,lastTargetId:null,lastDropMode:null,sourceEl:r},window.__ttreeDraggingArticleId=t,typeof document<"u"&&document.body&&document.body.classList.add("article-dnd-active");try{let o=window.getSelection?window.getSelection():null;o&&!o.isCollapsed&&o.removeAllRanges()}catch{}window.addEventListener("touchmove",Zc,{passive:!1}),window.addEventListener("touchend",si),window.addEventListener("touchcancel",si)}function Zc(e){if(!It||!e.touches||e.touches.length===0)return;let t=e.touches[0];Ns({pointerId:"legacy-touch",clientX:t.clientX,clientY:t.clientY,preventDefault:()=>{e.preventDefault()}})}function si(){It&&So({pointerId:"legacy-touch"})}function If(e,t){let n=document.elementFromPoint(e,t);if(!n)return null;let r=n.closest(".sidebar-article-item, #articleList li");return!r||!r.dataset||!r.dataset.articleId?null:r}function Ef(e,t){if(!t||It)return;let n=e.currentTarget instanceof Element?e.currentTarget:null;It={pointerId:e.pointerId,articleId:t,startX:e.clientX,startY:e.clientY,dragging:!1,lastTargetId:null,lastDropMode:null,sourceEl:n},window.__ttreeDraggingArticleId=t,typeof document<"u"&&document.body&&document.body.classList.add("article-dnd-active");try{let r=window.getSelection?window.getSelection():null;r&&!r.isCollapsed&&r.removeAllRanges()}catch{}try{e.currentTarget?.setPointerCapture?.(e.pointerId)}catch{}window.addEventListener("pointermove",Ns),window.addEventListener("pointerup",So),window.addEventListener("pointercancel",So)}function Ns(e){if(!It||e.pointerId!==It.pointerId)return;let t=e.clientX-It.startX,n=e.clientY-It.startY;if(!It.dragging){if(Math.hypot(t,n)<wf)return;It.dragging=!0,It.sourceEl instanceof Element&&It.sourceEl.classList.add("article-dnd-source")}e.preventDefault();let r=If(e.clientX,e.clientY);if(!r||!r.dataset||!r.dataset.articleId||r.dataset.articleId===It.articleId){ai(),It.lastTargetId=null,It.lastDropMode=null;return}let o=r.getBoundingClientRect(),i=e.clientY-o.top,s=o.height/3,a;i<s?a="before":i>o.height-s?a="after":a="inside",It.lastTargetId=r.dataset.articleId,It.lastDropMode=a,Qc(r,a)}function So(e){if(!It||e.pointerId!==It.pointerId)return;let t=It;Af(),!(!t.dragging||!t.lastTargetId||!t.lastDropMode)&&t.lastTargetId!==t.articleId&&el(t.articleId,t.lastTargetId,t.lastDropMode)}function Ms(e,t){e&&(xf?e.addEventListener("pointerdown",n=>{if(n.pointerType!=="touch"||typeof n.button=="number"&&n.button!==0||Jc(n.target))return;let r=n.pointerId,o=350,i=!1,s=window.setTimeout(()=>{i=!0,Ef(n,t)},o),a=c=>{c.pointerId===r&&(i||window.clearTimeout(s),window.removeEventListener("pointerup",a,!0),window.removeEventListener("pointercancel",a,!0))};window.addEventListener("pointerup",a,!0),window.addEventListener("pointercancel",a,!0)}):e.addEventListener("touchstart",n=>{if(!n.touches||n.touches.length!==1)return;let r=n.target;if(Jc(r))return;let o=350,i=!1,s=window.setTimeout(()=>{i=!0,kf(n,t)},o),a=()=>{i||window.clearTimeout(s),window.removeEventListener("touchend",a,!0),window.removeEventListener("touchcancel",a,!0)};window.addEventListener("touchend",a,!0),window.addEventListener("touchcancel",a,!0)},{passive:!1}))}function Bs(e){return e&&(d.articlesIndex||[]).find(t=>t.id===e)||null}function Wc(e){let t=e||null;return(d.articlesIndex||[]).filter(n=>(n.parentId||null)===t).sort((n,r)=>n.position!==r.position?n.position-r.position:new Date(n.updatedAt||0)-new Date(r.updatedAt||0))}function Cf(e,t,n,r){if(!e)return;let o=Bs(e);if(!o)return;let i=t||null,s=o.parentId||null,c=Wc(s).filter(b=>b.id!==e),l;i===s?l=c:l=Wc(i);let u=l.filter(b=>b.id!==e),h=u.length;if(n&&r&&r!=="inside"){let b=u.findIndex(S=>S.id===n);b!==-1&&(h=r==="before"?b:b+1)}r==="inside"&&(h=u.length),h<0&&(h=0),h>u.length&&(h=u.length);let g=u.slice();g.splice(h,0,o),o.parentId=i,c.forEach((b,S)=>{b.position=S}),g.forEach((b,S)=>{b.parentId=i,b.position=S})}function el(e,t,n){if(!e||!t||!n)return;let r=Bs(e),o=Bs(t);if(!r||!o)return;let i=n==="inside"?o.id:o.parentId||null,s=n==="inside"?null:o.id;Cf(e,i,s,n),Yc?.(),vs?.(),(async()=>{try{await hs(e,{parentId:i,anchorId:s,placement:n})}catch(a){try{let c=await vn();Gc?.(c),vs?.()}catch{}Ee(a.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443")}})()}function vf(e){window.__ttreeDraggingArticleId?xn=window.__ttreeDraggingArticleId:xn=e.currentTarget?.dataset?.articleId||null,e.dataTransfer&&(e.dataTransfer.effectAllowed="move",xn&&e.dataTransfer.setData("text/plain",xn))}function Tf(e){if(!xn){let s=window.__ttreeDraggingArticleId,a=null;if(!s&&e?.dataTransfer)try{a=e.dataTransfer.getData("text/plain")||null}catch{a=null}xn=s||a||null}if(!xn||!e.currentTarget||!e.currentTarget.dataset.articleId)return;e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="move");let t=e.currentTarget,n=t.getBoundingClientRect(),r=e.clientY-n.top,o=n.height/3,i;r<o?i="before":r>n.height-o?i="after":i="inside",Qc(t,i)}function Bf(e){if(!xn){let a=window.__ttreeDraggingArticleId,c=null;if(!a&&e?.dataTransfer)try{c=e.dataTransfer.getData("text/plain")||null}catch{c=null}xn=a||c||null}if(!xn)return;let t=e.currentTarget,n=t?.dataset?.articleId||null;if(!n||n===xn)return;e.preventDefault(),ai();let r=t.getBoundingClientRect(),o=e.clientY-r.top,i=r.height/3,s;o<i?s="before":o>r.height-i?s="after":s="inside",el(xn,n,s),xn=null}function Nf(){xn=null,window.__ttreeDraggingArticleId=null,ai()}function Ls(e){e&&(e.draggable=!0,e.addEventListener("dragstart",vf),e.addEventListener("dragover",Tf),e.addEventListener("drop",Bf),e.addEventListener("dragend",Nf))}var Yc,vs,Gc,Ts,xn,Hn,wf,It,xf,Ps=Xe(()=>{Pt();un();rn();Yc=null,vs=null,Gc=null;Ts=!1;typeof window<"u"&&(window.matchMedia&&window.matchMedia("(pointer: coarse)").matches||"ontouchstart"in window)&&(Ts=!0);xn=null,Hn=null,wf=6,It=null,xf=typeof window<"u"&&"PointerEvent"in window&&!Ts});function tl(){try{if(d.sidebarSearchView!=="list"||!V.searchInput||!!!((V.searchInput.value||"").trim()||(d.articleFilterQuery||"").trim()))return;V.searchInput.value="",d.articleFilterQuery="",V.searchInput.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}function Mf(){try{let e=localStorage.getItem(rl),t=e?JSON.parse(e):[];d.favoriteArticles=Array.isArray(t)?t:[]}catch{d.favoriteArticles=[]}}function Lf(){try{localStorage.setItem(rl,JSON.stringify(d.favoriteArticles||[]))}catch{}}function ol(e=[]){let t=new Set(d.favoriteArticles||[]);return[...e].sort((n,r)=>{let o=t.has(n.id),i=t.has(r.id);return o!==i?o?-1:1:new Date(r.updatedAt||r.deletedAt||0)-new Date(n.updatedAt||n.deletedAt||0)})}function ci(e){if(!e)return;d.favoriteArticles||(d.favoriteArticles=[]);let t=new Set(d.favoriteArticles);t.has(e)?t.delete(e):t.add(e),d.favoriteArticles=Array.from(t),Lf(),Kt(),Mn()}function li(e=[]){(!d.favoriteArticles||!d.favoriteArticles.length)&&Mf();let t=Array.isArray(e)?e:[];d.articlesIndex=t.map(r=>({id:r.id,title:r.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",updatedAt:r.updatedAt||new Date().toISOString(),deletedAt:r.deletedAt||null,publicSlug:r.publicSlug||null,parentId:r.parentId||null,position:typeof r.position=="number"?r.position:0}));let n=new Set(d.articlesIndex.map(r=>r.id));Array.isArray(d.sidebarCollapsedArticleIds)&&d.sidebarCollapsedArticleIds.length&&(d.sidebarCollapsedArticleIds=d.sidebarCollapsedArticleIds.filter(r=>n.has(r)),ni()),Array.isArray(d.listCollapsedArticleIds)&&d.listCollapsedArticleIds.length&&(d.listCollapsedArticleIds=d.listCollapsedArticleIds.filter(r=>n.has(r)),ri()),Kt()}function il(e=[]){let t=ol(Array.isArray(e)?e:[]);d.deletedArticlesIndex=t,Kt()}function Kr(e){if(!e||!e.id||e.deletedAt)return;let t={id:e.id,title:e.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",updatedAt:e.updatedAt||new Date().toISOString(),publicSlug:e.publicSlug||null,parentId:e.parentId||null,position:typeof e.position=="number"?e.position:0},n=d.articlesIndex.findIndex(r=>r.id===t.id);n>=0?d.articlesIndex[n]={...d.articlesIndex[n],...t}:d.articlesIndex.unshift(t),Kt()}function _s(e){if(!e)return;let t=d.articlesIndex.length;d.articlesIndex=d.articlesIndex.filter(n=>n.id!==e),t!==d.articlesIndex.length&&(Kt(),Mn())}function Ds(e){if(!e)return;let t=d.deletedArticlesIndex.length;d.deletedArticlesIndex=d.deletedArticlesIndex.filter(n=>n.id!==e),t!==d.deletedArticlesIndex.length&&(Kt(),Mn())}function sl(e=[]){let t=new Map;e.forEach(o=>{t.set(o.id,{...o,children:[]})});let n=[];t.forEach(o=>{let i=o.parentId||null;i&&t.has(i)?t.get(i).children.push(o):n.push(o)});let r=o=>{o.sort((i,s)=>{let a=(d.favoriteArticles||[]).includes(i.id),c=(d.favoriteArticles||[]).includes(s.id);return a!==c?a?-1:1:i.position!==s.position?i.position-s.position:new Date(s.updatedAt||0)-new Date(i.updatedAt||0)}),o.forEach(i=>r(i.children||[]))};return r(n),n}function Kt(){if(!V.sidebarArticleList)return;V.sidebarArticleList.innerHTML="",V.backToList&&V.backToList.classList.toggle("active",d.sidebarArticlesMode!=="recent"),V.sidebarRecentBtn&&V.sidebarRecentBtn.classList.toggle("active",d.sidebarArticlesMode==="recent");let e=(d.articleFilterQuery||"").trim().toLowerCase(),t=d.sidebarArticlesMode==="recent"?"recent":"tree",n=d.isTrashView?d.deletedArticlesIndex:d.articlesIndex,r=new Set(d.favoriteArticles||[]),o=new Set(d.sidebarCollapsedArticleIds||[]),i=d.sidebarSelectedArticleId||d.articleId,s=Array.isArray(d.recentArticleIds)?d.recentArticleIds:[],a=[];if(!d.isTrashView&&(r.has("RAG")||t==="recent"&&s.includes("RAG"))){let p=(d.ragQuery||"").trim();a.push({id:"RAG",title:p?`AI: ${p}`:"AI: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B \u043F\u043E\u0438\u0441\u043A\u0430",updatedAt:new Date().toISOString(),deletedAt:null,publicSlug:null,parentId:null,position:0})}let l=new Set(a.map(p=>p.id)),u=a.length&&!d.isTrashView?[...(n||[]).filter(p=>!l.has(p.id)),...a]:n,h=new Set;(u||[]).forEach(p=>{let f=p.parentId||null;f&&h.add(f)});let g=(u||[]).filter(p=>(e?(p.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(e):!0)&&(d.isTrashView?!0:p.id!=="inbox"));if(!g.length){let p=document.createElement("li");p.className="sidebar-article-empty",p.textContent=d.isTrashView?e?"No deleted pages match the filter":"Trash is empty":e?"\u041D\u0435\u0442 \u0441\u043E\u0432\u043F\u0430\u0434\u0435\u043D\u0438\u0439":"\u041D\u0435\u0442 \u0441\u0442\u0430\u0442\u0435\u0439",V.sidebarArticleList.appendChild(p);return}if(t==="recent"){let p=new Map(g.map(I=>[I.id,I])),f=new Set(s),w=s.map(I=>p.get(I)).filter(Boolean),x=ol(g.filter(I=>!f.has(I.id)));[...w,...x].forEach(I=>{let N=document.createElement("li");N.className="sidebar-article-item",N.dataset.articleId=I.id;let O=document.createElement("div");O.className="sidebar-article-row";let U=document.createElement("button");U.type="button",!d.isTrashView&&I.id===i&&U.classList.add("active");let H=r.has(I.id),X=Gt(I.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),G=I.publicSlug?'<i class="bx bx-link-external article-public-icon" aria-hidden="true"></i>':"",oe=H?"bxs-star":"bx-star";U.innerHTML=`<span class="sidebar-article-title">${G}${X}</span><span class="star-btn ${H?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${H?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}"><i class="bx ${oe}" aria-hidden="true"></i></span>`,U.addEventListener("click",()=>{window.__ttreeDraggingArticleId||(d.sidebarSelectedArticleId=I.id,tl(),wn(an.article(I.id)),d.isSidebarMobileOpen&&yo(!1))});let xe=U.querySelector(".star-btn");xe&&xe.addEventListener("click",ve=>{ve.stopPropagation(),ci(I.id)}),O.appendChild(U),N.appendChild(O),V.sidebarArticleList.appendChild(N)});return}let b=sl(g),S=(p,f)=>{let w=document.createElement("li");w.className="sidebar-article-item",h.has(p.id)&&(w.classList.add("has-children"),o.has(p.id)&&w.classList.add("is-collapsed")),w.dataset.articleId=p.id,w.style.paddingLeft=`${f*1.25}rem`;let x=document.createElement("div");x.className="sidebar-article-row";let A=document.createElement("button");A.type="button",!d.isTrashView&&p.id===i&&A.classList.add("active");let I=r.has(p.id),N=Gt(p.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),O=p.publicSlug?'<i class="bx bx-link-external article-public-icon" aria-hidden="true"></i>':"",U=I?"bxs-star":"bx-star";A.innerHTML=`<span class="sidebar-article-title">${O}${N}</span><span class="star-btn ${I?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${I?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}"><i class="bx ${U}" aria-hidden="true"></i></span>`,A.addEventListener("click",()=>{if(window.__ttreeDraggingArticleId)return;d.sidebarSelectedArticleId=p.id,d.sidebarCollapsedArticleIds||(d.sidebarCollapsedArticleIds=[]);let X=new Set(d.sidebarCollapsedArticleIds);X.has(p.id)?X.delete(p.id):X.add(p.id),d.sidebarCollapsedArticleIds=Array.from(X),ni(),Kt()}),A.addEventListener("dblclick",X=>{X.preventDefault(),X.stopPropagation(),d.sidebarSelectedArticleId=p.id,tl(),wn(an.article(p.id)),d.isSidebarMobileOpen&&yo(!1)});let H=A.querySelector(".star-btn");H&&H.addEventListener("click",X=>{X.stopPropagation(),ci(p.id)}),x.appendChild(A),w.appendChild(x),d.isTrashView||(Ls(w),Ms(w,p.id)),V.sidebarArticleList.appendChild(w),o.has(p.id)||(p.children||[]).forEach(X=>S(X,f+1))};b.forEach(p=>S(p,0))}function Mn(e=null){if(!V.articleList)return;V.articleList.innerHTML="";let t="",n=Array.isArray(e)&&e.length?e:d.isTrashView?d.deletedArticlesIndex:d.articlesIndex,r=new Set(d.favoriteArticles||[]),o=new Set(d.listCollapsedArticleIds||[]),i=d.listSelectedArticleId||d.articleId,s=new Set;if(n.forEach(u=>{let h=u.parentId||null;h&&s.add(h)}),!n.length){let u=document.createElement("li");u.textContent=d.isTrashView?t?"No deleted pages match the filter":"Trash is empty":t?"\u041D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E":"\u0421\u043F\u0438\u0441\u043E\u043A \u043F\u0443\u0441\u0442.",V.articleList.appendChild(u);return}if(d.isTrashView){n.slice().filter(u=>(t?(u.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(t):!0)&&(d.isTrashView?!0:u.id!=="inbox")).forEach(u=>{let h=document.createElement("li");h.dataset.articleId=u.id,h.innerHTML=`
      <span>
        <strong>${Gt(u.title)}</strong>
      </span>
      <div class="row-actions">
        <button class="ghost restore-btn" data-id="${u.id}">\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C</button>
        <button class="ghost danger delete-btn" data-id="${u.id}">\u0423\u0434\u0430\u043B\u0438\u0442\u044C</button>
      </div>
    `;let g=h.querySelector(".restore-btn"),b=h.querySelector(".delete-btn");g&&g.addEventListener("click",async S=>{S.preventDefault(),S.stopPropagation(),await Pf(u.id)}),b&&b.addEventListener("click",async S=>{S.preventDefault(),S.stopPropagation(),await _f(u.id)}),V.articleList.appendChild(h)});return}let a=n.slice().filter(u=>(t?(u.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(t):!0)&&u.id!=="inbox"),c=sl(a),l=(u,h)=>{let g=document.createElement("li");s.has(u.id)&&(g.classList.add("has-children"),o.has(u.id)&&g.classList.add("is-collapsed")),g.dataset.articleId=u.id;let b=r.has(u.id),S=Gt(u.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),p=u.publicSlug?'<i class="bx bx-link-external article-public-icon" aria-hidden="true"></i>':"",f=b?"bxs-star":"bx-star";g.style.paddingLeft=`${h*1.25}rem`,g.innerHTML=`
      <span>
        <strong>${p}${S}</strong>
      </span>
      <button class="ghost star-btn ${b?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${b?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}"><i class="bx ${f}" aria-hidden="true"></i></button>
    `;let w=g.querySelector(".star-btn");w&&w.addEventListener("click",x=>{x.preventDefault(),x.stopPropagation(),ci(u.id)}),u.id===i&&g.classList.add("active-article"),g.addEventListener("click",()=>{if(window.__ttreeDraggingArticleId)return;d.listSelectedArticleId=u.id,d.listCollapsedArticleIds||(d.listCollapsedArticleIds=[]);let x=new Set(d.listCollapsedArticleIds);x.has(u.id)?x.delete(u.id):x.add(u.id),d.listCollapsedArticleIds=Array.from(x),ri(),Mn()}),g.addEventListener("dblclick",x=>{x.preventDefault(),x.stopPropagation(),d.listSelectedArticleId=u.id,wn(an.article(u.id))}),V.articleList.appendChild(g),d.isTrashView||(Ls(g),Ms(g,u.id)),o.has(u.id)||(u.children||[]).forEach(x=>l(x,h+1))};c.forEach(u=>l(u,0))}async function Pf(e){if(e)try{let t=await Bc(e);Ds(e),Kr(t),await al(!1),wn(an.article(t.id)),Ee("Page restored")}catch(t){Ee(t.message)}}async function _f(e){if(e)try{await Tc(e,{force:!0}),Ds(e),Ee("\u0421\u0442\u0430\u0442\u044C\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u0431\u0435\u0437\u0432\u043E\u0437\u0432\u0440\u0430\u0442\u043D\u043E"),Mn(),Kt()}catch(t){Ee(t.message)}}async function al(e){d.isTrashView=e,Cs(),e?await di():await wo(),Kt(),Mn()}async function wo(){if(d.articlesIndex.length)return d.isTrashView||Kt(),d.articlesIndex;let e=await vn();return li(e),e}async function di(){if(d.deletedArticlesIndex.length)return d.isTrashView&&Kt(),d.deletedArticlesIndex;let e=await Ic();return il(e),e}var rl,ui=Xe(()=>{Pt();Cn();Rn();sr();un();rn();ii();qr();Ps();rl="ttree_favorites"});function Rf(){try{let e=Array.isArray(d.recentArticleIds)?d.recentArticleIds:[];window.localStorage.setItem(Of,JSON.stringify(e.slice(0,cl)))}catch{}}function fi(e){if(!e||e==="inbox"||d.isPublicView)return;let t=Array.isArray(d.recentArticleIds)?d.recentArticleIds:[],n=[e,...t.filter(r=>r!==e)];d.recentArticleIds=n.slice(0,cl),Rf(),d.sidebarArticlesMode==="recent"&&Kt()}var Of,cl,Os=Xe(()=>{Pt();ui();qr();Of="ttree_recent_articles",cl=300});var ar=Xe(()=>{Cn();Pt();Os();qr();ii();Ps();ui();qr();Os();ii();ui();Xc({renderSidebarArticleList:Kt,renderMainArticleList:Mn,setArticlesIndex:li})});function $f(e){d.articleId&&(d.articleEncryptionKeys||(d.articleEncryptionKeys={}),e?d.articleEncryptionKeys[d.articleId]=e:delete d.articleEncryptionKeys[d.articleId])}async function ll(e){if(!e||!e.encrypted)return e;let t=d.articleEncryptionKeys?.[e.id]||null;if(t)return await As(e,t),e;let n=0;for(;;){n+=1;let r=null;try{let o=e.encryptionHint||"",i="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C \u0434\u043B\u044F \u044D\u0442\u043E\u0439 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B.",s=o?`${i}
\u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0430: ${o}`:i;r=await or({title:"\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430",message:s,confirmText:"\u041E\u0442\u043A\u0440\u044B\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"\u041F\u0430\u0440\u043E\u043B\u044C",inputType:"password"})}catch{r=window.prompt("\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430. \u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C:")||""}if(!r)throw new Error("\u041F\u0430\u0440\u043E\u043B\u044C \u043D\u0435 \u0432\u0432\u0435\u0434\u0451\u043D");try{let{key:o}=await $c(r,e.encryptionSalt||"");if(!await zc(o,e.encryptionVerifier||"")){if(n>=3)throw new Error("\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C");window.alert("\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C, \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437.");continue}return await As(e,o),$f(o),e}catch(o){if(n>=3)throw new Error(o.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");window.alert("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443, \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437.")}}}var Rs=Xe(()=>{Pt();un();rn();ir();Rn();go();ar();mo()});function zf(e,t){if(!t.length)return;let n=document.createElement("div");n.className="diff-images",t.forEach(r=>{let o=document.createElement("div");o.className=`diff-image-card diff-image-card--${r.type}`;let i=document.createElement("div");i.className="diff-image-card__label",i.textContent=r.type==="added"?"\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E":"\u0423\u0434\u0430\u043B\u0435\u043D\u043E";let s=document.createElement("img");s.src=r.src,s.alt=r.alt||"",o.append(i,s),n.appendChild(o)}),e.appendChild(n)}function Uf(e,t,n,r=[]){let o=document.createElement("div");o.className="diff-inline";let i=document.createElement("div");i.className="diff-inline__content",n.forEach(a=>{let c=document.createElement("span");a.type==="added"?c.className="diff-inline__segment diff-inline__segment--added":a.type==="removed"&&(c.className="diff-inline__segment diff-inline__segment--removed"),c.textContent=a.value,i.appendChild(c)}),zf(i,r);let s=document.createElement("div");s.className="diff-inline__hint",s.textContent=t==="undo"?"\u041F\u043E\u0432\u0442\u043E\u0440\u043D\u043E \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Ctrl+Z, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C \u043E\u0442\u043C\u0435\u043D\u0443":"\u041F\u043E\u0432\u0442\u043E\u0440\u043D\u043E \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Ctrl+Y, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C \u043F\u043E\u0432\u0442\u043E\u0440",o.append(i,s),e.innerHTML="",e.appendChild(o)}function dl(){let e=d.pendingTextPreview;if(!e)return;let t=document.querySelector(`.block[data-block-id="${e.blockId}"] .block-text`);t&&Uf(t,e.mode,e.chunks,e.imageDiff||[])}function ul(e){pi({restoreDom:!1});let t=n=>({type:"text",blockId:n.blockId,historyEntryId:n.id});d.undoStack=(e.history||[]).map(t),d.redoStack=(e.redoHistory||[]).map(t)}function Vr(e){e&&(sn("pushUndoEntry",e),d.undoStack.push(e),d.redoStack=[])}function xo(e){try{return JSON.parse(JSON.stringify(e||{}))}catch{return null}}function qf(e){if(!e||!d.article||!Array.isArray(d.article.blocks))return;let t=!1,n=r=>{if(Array.isArray(r))for(let o=0;o<r.length;o+=1){let i=r[o];if(i){if(i===e)if(!t)t=!0;else{r.splice(o,1),o-=1;continue}Array.isArray(i.children)&&i.children.length&&n(i.children)}}};n(d.article.blocks)}async function Kf(e){e&&(await Hs(e),cr(e))}function pi({restoreDom:e=!0}={}){let t=d.pendingTextPreview;if(t){if(e){let n=document.querySelector(`.block[data-block-id="${t.blockId}"] .block-text`);n&&(n.innerHTML=t.originalHTML)}d.pendingTextPreview=null}}async function fl(e,t=null,n=null,r={}){if(!e)return{success:!1};let{skipRecord:o=!1,anchorId:i=null,placement:s=null,suppressRerender:a=!1}=r,c=At(e);if(!c)return Ee("\u0411\u043B\u043E\u043A \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D"),{success:!1};let l=c.parent?.id||null,u=c.index??0,h=t?At(t)?.block:null,g=h?h.children?.length||0:(d.article?.blocks||[]).length,b=typeof n=="number"&&n>=0?Math.min(n,g):g;if(l===t&&u===b)return{success:!0,noOp:!0,from:{parentId:l,index:u},to:{parentId:t,index:b}};let S=b;t===l&&u<S&&(S=Math.max(S-1,0));try{let p=await Tt(`/api/articles/${d.articleId}/blocks/${e}/relocate`,{method:"POST",body:JSON.stringify({parentId:t||null,index:S,anchorId:i||null,placement:s||null})});if(d.article&&Array.isArray(d.article.blocks)){let w=c.siblings||d.article.blocks,x=c.index??w.findIndex(O=>O.id===e),A=null;x>=0&&([A]=w.splice(x,1)),A||(A=c.block);let I;if(t){let O=At(t);O&&O.block?(Array.isArray(O.block.children)||(O.block.children=[]),I=O.block.children):I=d.article.blocks}else I=d.article.blocks;let N=typeof S=="number"&&S>=0?Math.min(S,I.length):I.length;if(I.splice(N,0,A),qf(A),d.article.updatedAt)try{d.article.updatedAt=new Date().toISOString()}catch{}}d.currentBlockId=e;let f=p?.parentId??t??null;return a||(l&&f?(await fn(l),f!==l&&await fn(f)):l&&!f?Vt("undo.moveBlockToParent.toRoot.fullRender"):!l&&f?Vt("undo.moveBlockToParent.fromRoot.fullRender"):Vt("undo.moveBlockToParent.rootReorder.fullRender")),o||Vr({type:"structure",action:{kind:"reorder",blockId:e,fromParentId:l,fromIndex:u,toParentId:p?.parentId??t??null,toIndex:p?.index??S}}),await Kf(e),{success:!0,from:{parentId:l,index:u},to:{parentId:p?.parentId??t??null,index:p?.index??S}}}catch(p){return Ee(p.message),{success:!1}}}var Ar=Xe(()=>{Pt();un();rn();xr();xr();$n();Rn();go()});function Wf(){try{return window?.localStorage?.getItem?.(jf)==="1"}catch{return!1}}function ml(){try{return window?.localStorage?.getItem?.(Jf)==="1"}catch{return!1}}function jr(...e){try{if(!Wf())return;console.log("[article-load]",...e)}catch{}}function Yf(e){try{let t=e?.content;if(!Array.isArray(t))return null;for(let n of t)if(n?.type==="outlineSection"){let r=String(n?.attrs?.id||"");if(r)return r}return null}catch{return null}}async function Vn(e,t={}){let{desiredBlockId:n,resetUndoStacks:r,editBlockId:o}=t,i=d.articleId!==e;if(jr("load.start",{id:e,switchingArticle:i,mode:d.mode,isOutlineEditing:d.isOutlineEditing}),i)try{let g=d.articleId,b=await Promise.resolve().then(()=>(hi(),mi));try{let S=b?.getOutlineActiveSectionSnapshot?.()||null;if(g&&S?.sectionId){let p=window?.localStorage?.getItem?.(pl)||"{}",f=JSON.parse(p||"{}"),w=f&&typeof f=="object"?f:{};w[String(g)]={sectionId:S.sectionId,collapsed:!!S.collapsed,savedAt:new Date().toISOString()},window?.localStorage?.setItem?.(pl,JSON.stringify(w))}}catch{}b?.flushOutlineAutosave&&await b.flushOutlineAutosave({mode:"queue"}),b?.closeOutlineEditor&&b.closeOutlineEditor()}catch{}d.articleId=e,d.isEditingTitle=!1,d.pendingTextPreview=null,d.article=null,d.currentBlockId=null;let s=performance.now(),a=await Ec(e);ml()&&console.log("[perf][article-load] fetchArticle",{id:e,ms:Math.round(performance.now()-s)}),jr("load.fetched",{id:e,ms:Math.round(performance.now()-s),hasDocJson:!!a?.docJson,docContent:Array.isArray(a?.docJson?.content)?a.docJson.content.length:null,blocksCount:Array.isArray(a?.blocks)?a.blocks.length:null,updatedAt:a?.updatedAt});let c=a;try{c=await ll(a)}catch(g){throw Ee(g.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u0443\u044E \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443"),g}d.article=c,(typeof r=="boolean"?r:i)&&ul(c);let u=n||o||d.pendingEditBlockId||null;d.pendingEditBlockId=null;let h=Yf(c.docJson)||c.blocks?.[0]?.id||null;if(d.currentBlockId=u||h,d.mode="view",d.editingBlockId=null,Kr(c),Mc(),!d.isPublicView&&!d.isRagView&&!c.encrypted)try{let g=await Promise.resolve().then(()=>(hi(),mi));if(g?.openOutlineEditor){jr("outline.open.start",{id:e});let b=ml()?performance.now():0;g.openOutlineEditor(),b&&console.log("[perf][article-load] outline.open scheduled",{id:e,ms:Math.round(performance.now()-b)}),jr("outline.open.scheduled",{id:e,isOutlineEditing:d.isOutlineEditing})}}catch(g){d.isOutlineEditing=!1,jr("outline.open.failed",{id:e,message:g?.message||String(g||"error")}),Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C outline-\u0440\u0435\u0436\u0438\u043C (\u0441\u043C. \u043A\u043E\u043D\u0441\u043E\u043B\u044C)")}return jr("load.done",{id:e,currentBlockId:d.currentBlockId}),c}var jf,Jf,pl,$s=Xe(()=>{Pt();un();Ar();rn();ar();Rs();mo();jf="ttree_debug_article_load_v1",Jf="ttree_profile_v1",pl="ttree_outline_last_active_v1"});var hl=Xe(()=>{Rn();$n()});function Gf(e){if(!e)return;e.focus({preventScroll:!0});let t=window.getSelection&&window.getSelection();if(!t)return;t.removeAllRanges();let n=document.createRange();n.selectNodeContents(e),n.collapse(!1),t.addRange(n)}async function Fs(e){return!d.article||!d.article.encrypted||!d.articleEncryptionKey?e:ks(d.articleEncryptionKey,e)}async function yl(){if(!d.currentBlockId||d.isRagView)return;let e=d.currentBlockId;d.editingScrollTop=V.blocksContainer?V.blocksContainer.scrollTop:null,d.mode="edit",d.scrollTargetBlockId=null,d.editingBlockId=d.currentBlockId,d.editingInitialText=At(d.currentBlockId)?.block.text||"",d.editingUndo=null,await fn(e);let t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`);if(t||(Vt("actions.startEditing.fallback.fullRender"),await fn(e),t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`)),!t){d.mode="view",d.editingBlockId=null,d.editingInitialText="",d.editingUndo=null,d.currentBlockId=e,Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430");return}Gf(t)}async function bl(){if(d.mode!=="edit"||!d.editingBlockId)return;let e=d.editingBlockId,t=At(e),n=t?.block.text||"",o=document.querySelector(`.block[data-block-id="${d.editingBlockId}"] .block-text`)?.innerHTML||"",{cleanupEditableHtml:i}=await Promise.resolve().then(()=>($n(),Ks)),s=i(o);if(!(s||"").trim()){let c=yi(e),l=At(e),u=!!(l?.block&&l.block.__isNew);if(l&&d.article&&Array.isArray(d.article.blocks)){let h=l.siblings||d.article.blocks,g=l.index??h.findIndex(b=>b&&b.id===e);if(g>=0&&h.splice(g,1),d.article.updatedAt)try{d.article.updatedAt=new Date().toISOString()}catch{}if(!u){let b=xo(l.block);Us(b,l.parent?.id||null,l.index??null)}}d.mode="view",d.editingBlockId=null,d.editingInitialText="",d.currentBlockId=c,d.scrollTargetBlockId=c,gi(e),Vt("actions.saveEditing.empty.delete.localRender"),(async()=>{try{let h=u?`/api/articles/${d.articleId}/blocks/${e}/permanent`:`/api/articles/${d.articleId}/blocks/${e}`,g=await Tt(h,{method:"DELETE"});if(!u&&g?.block){let b=xo(g.block);Vr({type:"structure",action:{kind:"delete",parentId:g.parentId||null,index:g.index??null,block:b,blockId:b?.id,fallbackId:c}})}Ee("\u041F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A \u0443\u0434\u0430\u043B\u0451\u043D")}catch(h){Ee(h.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Vn(d.articleId,{desiredBlockId:c||null}),Vt("actions.saveEditing.empty.delete.reloadAfterError")}catch{}}})();return}if(s===n){d.mode="view",d.editingBlockId=null,d.editingInitialText="",d.editingUndo=null,d.pendingEditBlockId=null,d.currentBlockId=e,d.scrollTargetBlockId=e,await fn(e);return}if(t&&d.article&&Array.isArray(d.article.blocks)&&(t.block.text=s,d.article.updatedAt))try{d.article.updatedAt=new Date().toISOString()}catch{}d.mode="view",d.editingBlockId=null,d.editingInitialText="",d.editingUndo=null,d.pendingEditBlockId=null,d.currentBlockId=e,d.scrollTargetBlockId=e,await fn(e),(async()=>{try{let c=await Fs(s),l=await Tt(`/api/articles/${d.articleId}/blocks/${e}`,{method:"PATCH",body:JSON.stringify({text:c})});n!==s&&(!!(t?.block&&t.block.__isNew)?delete t.block.__isNew:Vr({type:"text",blockId:e,historyEntryId:l?.historyEntryId||null})),Ee("\u0411\u043B\u043E\u043A \u043E\u0431\u043D\u043E\u0432\u043B\u0451\u043D")}catch(c){Ee(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Vn(d.articleId,{desiredBlockId:e}),Vt("actions.saveEditing.patchError.reload")}catch{}}})()}async function Sl(){if(d.mode!=="edit"||!d.editingBlockId)return;let e=d.editingBlockId,r=!(document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`)?.textContent||"").replace(/\u00a0/g," ").trim();if(d.mode="view",d.editingBlockId=null,d.editingInitialText="",d.editingUndo=null,r){let o=yi(e),i=At(e),s=!!(i?.block&&i.block.__isNew);if(i&&d.article&&Array.isArray(d.article.blocks)){let c=i.siblings||d.article.blocks,l=i.index??c.findIndex(u=>u&&u.id===e);if(l>=0&&c.splice(l,1),d.article.updatedAt)try{d.article.updatedAt=new Date().toISOString()}catch{}}d.currentBlockId=o,d.scrollTargetBlockId=o,gi(e);let a=i?.parent?.id||null;a?await fn(a):Vt("actions.cancelEditing.empty.delete.localRender"),(async()=>{try{let c=s?`/api/articles/${d.articleId}/blocks/${e}/permanent`:`/api/articles/${d.articleId}/blocks/${e}`,l=await Tt(c,{method:"DELETE"});if(!s&&l?.block){let u=xo(l.block);Vr({type:"structure",action:{kind:"delete",parentId:l.parentId||null,index:l.index??null,block:u,blockId:u?.id,fallbackId:o}})}}catch(c){Ee(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Vn(d.articleId,{desiredBlockId:o||null}),Vt("actions.cancelEditing.empty.delete.reloadAfterError")}catch{}}})();return}d.currentBlockId=e,await fn(e)}async function wl(){if(d.mode!=="edit"||!d.editingBlockId)return;let e=d.editingBlockId,t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`);if(!t)return;let n=window.getSelection();if(!n||n.rangeCount===0||!t.contains(n.anchorNode))return;let r=n.getRangeAt(0).cloneRange(),o=document.createElement("span"),i=`split-marker-${Date.now()}-${Math.random().toString(16).slice(2)}`;o.setAttribute("data-split-marker",i),o.textContent="",r.insertNode(o);let s=t.innerHTML;o.parentNode.removeChild(o);let a=`<span data-split-marker="${i}"></span>`,c=s.split(a);if(c.length!==2)return;let[l,u]=c,{cleanupEditableHtml:h}=await Promise.resolve().then(()=>($n(),Ks)),g=h(l||""),b=h(u||"");if(!(!b||b===g))try{let S=At(e),p=S?.block,f=p?xo(p):null,w=await Fs(g);await Tt(`/api/articles/${d.articleId}/blocks/${e}`,{method:"PATCH",body:JSON.stringify({text:w})});let A=(await Tt(`/api/articles/${d.articleId}/blocks/${e}/siblings`,{method:"POST",body:JSON.stringify({direction:"after"})}))?.block?.id;if(!A){Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043D\u043E\u0432\u044B\u0439 \u0431\u043B\u043E\u043A");return}let I=await Fs(b);if(await Tt(`/api/articles/${d.articleId}/blocks/${A}`,{method:"PATCH",body:JSON.stringify({text:I})}),S&&d.article&&Array.isArray(d.article.blocks)){S.block.text=g;let O=S.parent,U=S.siblings||d.article.blocks||[],H=(S.index??0)+1,X={id:A,text:b,children:[],collapsed:!1};if(U.splice(H,0,X),d.article.updatedAt)try{d.article.updatedAt=new Date().toISOString()}catch{}}d.mode="edit",d.editingBlockId=A,d.pendingEditBlockId=null,d.currentBlockId=A,d.scrollTargetBlockId=A,d.editingCaretPosition="start";let N=S?.parent?.id||null;N?await fn(N):Vt(),f&&Vr({type:"text",blockId:e,block:f})}catch(S){Ee(S.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0437\u0431\u0438\u0442\u044C \u0431\u043B\u043E\u043A")}}var zs=Xe(()=>{Pt();un();Cn();rn();xr();xr();Ar();$n();hl();Rn();go()});function El(){if(!_t||!ko()||_t.pointerType==="mouse")return;let e=window.getSelection?window.getSelection():null;if(!(!e||e.isCollapsed))try{e.removeAllRanges()}catch{}}function tp(){bi||(document.addEventListener("selectionchange",El),bi=!0)}function np(){bi&&(document.removeEventListener("selectionchange",El),bi=!1)}function ko(){return!!(d.isDragModeEnabled&&d.mode==="view"&&d.articleId!=="inbox")}function Cl(e){return e instanceof Element?!!e.closest(ep):!1}function vl(){if(_t){window.removeEventListener("pointermove",Ll),window.removeEventListener("pointerup",Si),window.removeEventListener("pointercancel",Si);try{_t.sourceEl?.releasePointerCapture?.(_t.pointerId)}catch{}_t=null,np(),ip()}}function rp(e,t,n,{bypassInteractiveCheck:r=!1}={}){if(!d.article||!d.isDragModeEnabled||!ko()||e.pointerType==="mouse"&&e.button!==0||!r&&Cl(e.target))return;let o=At(t);if(o){_t={pointerType:e.pointerType||"mouse",blockId:t,pointerId:e.pointerId,originParentId:o.parent?.id||null,originIndex:o.index??0,startX:e.clientX,startY:e.clientY,dragging:!1,forbidden:Bl(o.block),lastDrop:null,sourceEl:n};try{n?.setPointerCapture?.(e.pointerId)}catch{}window.addEventListener("pointermove",Ll),window.addEventListener("pointerup",Si),window.addEventListener("pointercancel",Si),tp()}}function Tl(e,t,{allowInteractive:n=!1}={}){e&&e.addEventListener("pointerdown",r=>{if(!n&&Cl(r.target))return;(r.pointerType==="touch"||r.pointerType==="pen")&&ko()&&r.preventDefault(),rp(r,t,e,{bypassInteractiveCheck:n})})}function Jr(){let e=!!d.article,t=V.dragModeToggleBtn;if(t){t.disabled=!e,t.classList.toggle("active",!!d.isDragModeEnabled),t.setAttribute("aria-pressed",d.isDragModeEnabled?"true":"false");let o=d.isDragModeEnabled?"\u041F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435 \u0431\u043B\u043E\u043A \u0437\u0430 \u0435\u0433\u043E \u043F\u043E\u0432\u0435\u0440\u0445\u043D\u043E\u0441\u0442\u044C":"\u0412\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0440\u0435\u0436\u0438\u043C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u044F \u0431\u043B\u043E\u043A\u043E\u0432";e?d.articleId==="inbox"?o="\u041F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0432 \u0431\u044B\u0441\u0442\u0440\u044B\u0445 \u0437\u0430\u043C\u0435\u0442\u043A\u0430\u0445":d.mode!=="view"&&(o="\u041F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043C\u043E\u0436\u043D\u043E \u0442\u043E\u043B\u044C\u043A\u043E \u0432 \u0440\u0435\u0436\u0438\u043C\u0435 \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440\u0430"):o="\u041E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E, \u0447\u0442\u043E\u0431\u044B \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0442\u044C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435\u043C",t.title=o}let n=ko();[V.articleView,V.blocksContainer].forEach(o=>{o&&o.classList.toggle("drag-mode-enabled",n)}),document.body.classList.toggle("drag-mode-enabled",n)}function Bl(e,t=new Set){return e&&(t.add(e.id),(e.children||[]).forEach(n=>Bl(n,t))),t}function op(){if(Ao)return Ao;let e=document.createElement("div");return e.className="block-drop-line hidden",document.body.appendChild(e),Ao=e,e}function ip(){Ao&&Ao.classList.add("hidden"),pn&&(pn.classList.remove("drop-inside-target"),pn=null),kr&&(kr.remove(),kr=null),document.body.classList.remove("block-dnd-active")}function sp(e){kr&&(kr.style.left=`${e.clientX+12}px`,kr.style.top=`${e.clientY+12}px`)}function ap(e){let t=document.createElement("div");t.className="block-drag-preview";let n=V.blocksContainer?.querySelector(`.block[data-block-id="${e}"]`),r=n?.querySelector(".block-title")?.textContent?.trim(),o=n?.querySelector(".block-text")?.textContent?.trim();t.textContent=r||o||"\u0411\u043B\u043E\u043A",document.body.appendChild(t),kr=t}function Nl(){return Ln&&Ln.isConnected?(V.blocksContainer&&Ln.parentNode!==V.blocksContainer&&V.blocksContainer.appendChild(Ln),Ln):(Ln=document.createElement("div"),Ln.className="drag-layer",V.blocksContainer&&(V.blocksContainer.appendChild(Ln),xl||(V.blocksContainer.addEventListener("scroll",Al,{passive:!0}),window.addEventListener("resize",Al,{passive:!0}),xl=!0)),Ln)}function Ml(){Il.clear(),Ln&&(Ln.innerHTML="")}function Al(){let e=V.blocksContainer;if(!e||!Ln)return;let t=e.getBoundingClientRect(),n=e.scrollTop;Il.forEach(({handle:r,blockEl:o})=>{let i=o.getBoundingClientRect(),s=o.querySelector(".block-header__left"),a=o.querySelector(".block-header"),c=o.querySelector(".collapse-btn"),l=s?.getBoundingClientRect(),u=a?.getBoundingClientRect(),h=c?.getBoundingClientRect(),g=(l&&l.height>0?l:null)||(u&&u.height>0?u:null)||(h&&h.height>0?h:null)||i,b=g.top-t.top+n+g.height/2;r.style.top=`${b}px`,r.style.right="8px"})}function cp(e){let t=op();if(!e){t.classList.add("hidden"),pn&&(pn.classList.remove("drop-inside-target"),pn=null);return}if(e.placement==="inside"){t.classList.add("hidden"),pn&&pn.dataset.blockId!==e.targetId&&pn.classList.remove("drop-inside-target"),pn=V.blocksContainer?.querySelector(`.block[data-block-id="${e.targetId}"]`)||null,pn&&pn.classList.add("drop-inside-target");return}pn&&(pn.classList.remove("drop-inside-target"),pn=null),t.classList.remove("hidden");let n=e.placement==="before"?e.rect.top:e.rect.top+e.rect.height,r=Math.min(e.depth*kl,e.rect.width-32),o=e.rect.left+r,i=Math.max(e.rect.width-r,48);t.style.top=`${n}px`,t.style.left=`${o}px`,t.style.width=`${i}px`}function lp(e,t){if(!V.blocksContainer||!_t)return null;let r=Array.from(V.blocksContainer.querySelectorAll(".block")).filter(A=>{let I=A.dataset.blockId;return I&&!_t.forbidden.has(I)});if(!r.length)return null;let o=null,i=1/0;if(r.forEach(A=>{let I=A.getBoundingClientRect(),N=I.top+I.height/2,O=Math.abs(t-N);O<i&&(i=O,o=A)}),!o)return null;let s=o.getBoundingClientRect(),a=s.height>0?(t-s.top)/s.height:.5,c=a<Qf?"before":a>Zf?"after":"inside",l=o.dataset.blockId,u=At(l);if(!u)return null;let h=(u.ancestors||[]).length,g=c==="inside"?l:u.parent?.id||null;if(_t.forbidden.has(g||""))return null;let b=l,S=g,p=c,f=s,w=c==="inside"?h+1:h,x=p==="after"?u.index+1:u.index;if(p!=="inside"&&u.parent){let A=u,I=s,N=s.left+kl;for(;A.parent;){let O=e<=N,U=t<=I.top||t>=I.bottom;if(!O&&!U)break;let H=At(A.parent.id);if(!H)break;let G=V.blocksContainer?.querySelector(`.block[data-block-id="${H.block.id}"]`)?.getBoundingClientRect();A=H,I=G||I,b=A.block.id,f=I,w=(A.ancestors||[]).length,S=A.parent?.id||null,x=p==="after"?A.index+1:A.index}}return{targetId:b,placement:p,parentId:S,index:x,depth:w,rect:f}}function dp(e){if(!V.blocksContainer)return;let t=V.blocksContainer.getBoundingClientRect(),n=60;e.clientY<t.top+n?V.blocksContainer.scrollTop-=12:e.clientY>t.bottom-n&&(V.blocksContainer.scrollTop+=12)}function Ll(e){if(!_t||e.pointerId!==_t.pointerId)return;if(!ko()){vl();return}let t=e.clientX-_t.startX,n=e.clientY-_t.startY;if(!_t.dragging){if(Math.hypot(t,n)<Xf)return;_t.dragging=!0;let o=_t.pointerType||e.pointerType||"mouse";(o==="touch"||o==="pen")&&document.body.classList.add("block-dnd-active"),ap(_t.blockId)}e.preventDefault(),sp(e);let r=lp(e.clientX,e.clientY);_t.lastDrop=r,cp(r),dp(e)}async function Si(e){if(!_t||e.pointerId!==_t.pointerId)return;let t=_t;vl();let n=t.dragging&&t.lastDrop,r=t.lastDrop,o=t.blockId;!n||!r||await fl(o,r.parentId||null,r.index,{anchorId:r.targetId,placement:r.placement})}var Xf,kl,Qf,Zf,ep,_t,Ao,pn,kr,Ln,Il,xl,bi,Io=Xe(()=>{Pt();Cn();$n();Ar();rn();Xf=6,kl=20,Qf=.35,Zf=.65,ep='button, a, input, textarea, select, [contenteditable="true"], .block-edit-actions, .move-block-btn, .collapse-btn',_t=null,Ao=null,pn=null,kr=null,Ln=null,Il=new Map,xl=!1,bi=!1});function _l(){try{return window?.localStorage?.getItem?.(up)==="1"}catch{return!1}}function pp(){try{let e=window?.localStorage?.getItem?.(fp);return e==="0"?!1:e==="1"?!0:_l()}catch{return!1}}function mp(e){try{let t=String(e||""),n=2166136261;for(let r=0;r<t.length;r+=1)n^=t.charCodeAt(r),n=Math.imul(n,16777619);return(n>>>0).toString(16)}catch{return"0"}}function hp(e){try{let t=window?.localStorage?.getItem?.(Pl)||"",n=t?JSON.parse(t):[],r=Array.isArray(n)?n:[];r.push(e);let o=r.length>250?r.slice(r.length-250):r;window?.localStorage?.setItem?.(Pl,JSON.stringify(o))}catch{}}function wi(e,t={}){try{let n={t:new Date().toISOString(),kind:String(e||"event"),data:t&&typeof t=="object"?t:{value:t}};if(hp(n),pp()&&console.log(`[client] ${n.kind}`,n.data),_l()&&navigator.onLine!==!1)try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:`client:${n.kind}`,data:n})}).catch(()=>{})}catch{}return!0}catch{return!1}}function xi(e){try{let t=typeof e=="string"?e:String(e?.stack||""),r=t.split(`
`).map(s=>s.trim()).filter(Boolean).filter(s=>!s.includes("stackSummary")&&!s.includes("clientLog")),o=r.slice(0,6).join(`
`),i=mp(r.slice(0,20).join(`
`));return{top:o,hash:i,bytes:t.length,raw:t.slice(0,1600)}}catch{return{top:"",hash:"0",bytes:0,raw:""}}}var up,fp,Pl,Vs=Xe(()=>{up="ttree_client_log_v1",fp="ttree_client_log_console_v1",Pl="ttree_client_event_log_v1"});function Dl(e){Js=typeof e=="function"?e:null}function gp(e){let t=new Set,n=r=>{if(Array.isArray(r))for(let o=0;o<r.length;o+=1){let i=r[o];if(!i||!i.id){r.splice(o,1),o-=1;continue}if(t.has(i.id)){r.splice(o,1),o-=1;continue}t.add(i.id),Array.isArray(i.children)&&i.children.length&&n(i.children)}};n(e)}function Ol(){if(!V.blocksContainer)return;let e=new Set;V.blocksContainer.querySelectorAll(".block[data-block-id]").forEach(n=>{let r=n.getAttribute("data-block-id");if(r)if(e.has(r)){let o=n.parentNode;o&&o.removeChild(n)}else e.add(r)})}function Rl(){if(!V.blocksContainer||!d.article||!Array.isArray(d.article.blocks))return;let e=jn(d.article.blocks),t=new Set(e.map(r=>r.id));V.blocksContainer.querySelectorAll(".block[data-block-id]").forEach(r=>{let o=r.getAttribute("data-block-id");if(o&&!t.has(o)){let i=r.parentNode;i&&i.removeChild(r)}})}function Us(e,t,n,r){if(!d.article||!e||!e.id)return;let o=Array.isArray(d.article.blockTrash)?d.article.blockTrash:[],i=r||new Date().toISOString();o.push({id:e.id,block:e,parentId:t||null,index:typeof n=="number"?n:null,deletedAt:i}),d.article.blockTrash=o}function gi(e){if(!e||!V.blocksContainer)return;V.blocksContainer.querySelectorAll(`.block[data-block-id="${e}"]`).forEach(n=>{let r=n.parentElement;if(!r)return;let o=n.nextElementSibling;if(o&&o.classList.contains("block-children")){let i=o;o=o.nextElementSibling,i.parentNode===r&&r.removeChild(i)}n.parentNode===r&&r.removeChild(n)})}async function Ws(e,t,n=1){for(let r of e){let o=document.createElement("div");o.className="block",o.dataset.blockId=r.id,typeof r.collapsed=="boolean"&&(o.dataset.collapsed=r.collapsed?"true":"false"),(r.id===d.currentBlockId||Array.isArray(d.selectedBlockIds)&&d.selectedBlockIds.includes(r.id))&&o.classList.add("selected"),r.id===d.editingBlockId&&o.classList.add("editing");let s=document.createElement("div");s.className="block-surface";let a=document.createElement("div");a.className="block-content";let c=Jn(r.text||""),l=!!c.titleHtml,u=!!(c.bodyHtml&&c.bodyHtml.trim()),h=!!r.children?.length;if(!l&&h){let N=document.createElement("div");N.innerHTML=c.bodyHtml||r.text||"";let O=Array.from(N.childNodes||[]).filter(U=>U.nodeType===Node.TEXT_NODE?(U.textContent||"").trim().length>0:U.nodeType===Node.ELEMENT_NODE?U.tagName==="BR"?!1:U.tagName==="P"?(U.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim().length>0:!0:!1);if(O.length===1){let U=O[0];U.nodeType===Node.ELEMENT_NODE&&U.tagName==="P"&&(c={titleHtml:U.outerHTML,bodyHtml:""},l=!0,u=!1)}}let g=l||h,b=!l&&!h;o.classList.toggle("block--no-title",!l);let S=d.mode==="edit"&&d.editingBlockId===r.id,p=null;if(g||b){let N=document.createElement("button");N.className="collapse-btn",b?(N.classList.add("collapse-btn--placeholder"),N.setAttribute("aria-hidden","true"),N.removeAttribute("aria-expanded"),N.removeAttribute("title")):(N.setAttribute("aria-expanded",r.collapsed?"false":"true"),N.title=r.collapsed?"\u0420\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C":"\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C"),p=document.createElement("div"),p.className="block-header",l||p.classList.add("block-header--no-title");let O=document.createElement("div");if(O.className="block-header__left",O.appendChild(N),l){let U=Math.min(Math.max(n,1),6),H=document.createElement(`h${U}`);H.className="block-title",H.innerHTML=c.titleHtml||"",O.appendChild(H)}else{let U=document.createElement("div");U.className="block-title-spacer",U.style.flex="1",U.style.minWidth="0",O.appendChild(U)}p.appendChild(O)}let f=document.createElement("div");f.className="block-text block-body";let w=S?Gs(r.text||""):c.bodyHtml||"";if(f.innerHTML=w,(!w||!w.trim())&&(f.classList.add("block-body--empty"),S&&(f.innerHTML="<p><br /></p>")),f.classList.toggle("block-body--no-title",!l),S?(f.setAttribute("contenteditable","true"),f.setAttribute("spellcheck","false"),f.dataset.placeholder="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0442\u0435\u043A\u0441\u0442"):f.removeAttribute("contenteditable"),p&&a.appendChild(p),(S||!l||w)&&a.appendChild(f),d.articleId==="inbox"&&!S){let N=document.createElement("div");N.className="block-footer";let O=document.createElement("button");O.type="button",O.className="ghost small move-block-btn",O.innerHTML='<i class="bx bx-transfer-alt" aria-hidden="true"></i>',O.title="\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0431\u043B\u043E\u043A \u0432 \u0434\u0440\u0443\u0433\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E",O.addEventListener("click",U=>{U.stopPropagation(),Js?Js(r.id):Ee("\u041F\u0435\u0440\u0435\u043D\u043E\u0441 \u0431\u043B\u043E\u043A\u0430 \u0432\u0440\u0435\u043C\u0435\u043D\u043D\u043E \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D")}),N.appendChild(O),a.appendChild(N)}if(s.appendChild(a),S&&("ontouchstart"in window||navigator.maxTouchPoints>0)&&a.addEventListener("click",O=>{let U=a.querySelector('.block-text[contenteditable="true"]');U&&(U.contains(O.target)||(O.stopPropagation(),U.focus(),d.editingCaretPosition==="start"?(U.scrollTop=0,gs(U)):Zo(U)))}),Tl(s,r.id),S){let N=document.createElement("div");N.className="block-edit-actions";let O=document.createElement("button");O.type="button",O.className="ghost small block-attach-btn",O.innerHTML='<i class="bx bx-paperclip block-attach-btn__icon" aria-hidden="true"></i><span class="block-attach-btn__label">\u0424\u0430\u0439\u043B</span>',O.title="\u041F\u0440\u0438\u043A\u0440\u0435\u043F\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u0438\u043B\u0438 \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0443",O.addEventListener("click",X=>{X.preventDefault(),X.stopPropagation();let G=o.querySelector('.block-text[contenteditable="true"]');if(!G)return;let oe=document.createElement("input");oe.type="file",oe.multiple=!0,oe.style.display="none",oe.addEventListener("change",()=>{let xe=Array.from(oe.files||[]);xe.length&&Qs(G,xe,r.id),oe.remove()}),document.body.appendChild(oe),oe.click()});let U=document.createElement("button");U.type="button",U.className="ghost small",U.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C",U.addEventListener("click",async X=>{X.preventDefault(),X.stopPropagation(),await bl()});let H=document.createElement("button");H.type="button",H.className="ghost small",H.textContent="\u041E\u0442\u043C\u0435\u043D\u0430",H.addEventListener("click",X=>{X.preventDefault(),X.stopPropagation(),Sl()}),N.appendChild(O),N.appendChild(U),N.appendChild(H),a.appendChild(N)}Zs(f,r.id),o.appendChild(s),o.addEventListener("click",N=>{if(N.stopPropagation(),d.isRagView&&d.ragBlockMap&&d.ragBlockMap[r.id]){let Qe=d.ragBlockMap[r.id];if(Qe&&Qe.articleId&&Qe.blockId){d.scrollTargetBlockId=Qe.blockId,d.currentBlockId=Qe.blockId,wn(an.article(Qe.articleId));return}}let O=N.target.closest('button, a, [contenteditable="true"], .block-edit-actions'),U=o.querySelector(".block-header"),H=o.querySelector(".block-text.block-body"),X=!!U,G=!!(U&&!U.classList.contains("block-header--no-title")),oe=X&&U.contains(N.target),xe=H&&H.contains(N.target),ve=G,te=d.currentBlockId===r.id,be=!1;(ve&&oe||!ve&&te&&xe&&!O)&&(be=!0),be&&Xs(r.id),cr(r.id)}),s.addEventListener("dblclick",N=>{if(d.mode!=="view"||d.isPublicView||d.isRagView)return;let O=N.target.closest('button, a, [contenteditable="true"]');O&&!O.matches('.block-text[contenteditable="true"]')||(N.stopPropagation(),cr(r.id),yl())});let A=r.collapsed&&r.id!==d.editingBlockId&&l;f.classList.contains("block-body--empty")||f.classList.toggle("collapsed",A);let I=null;r.children?.length>0&&!r.collapsed&&(I=document.createElement("div"),I.className="block-children",await Ws(r.children,I,n+1)),t.appendChild(o),I&&(S?t.appendChild(I):o.appendChild(I))}}async function fn(e){if(!d.article||!Array.isArray(d.article.blocks))return;let t=At(e);if(!t)return;let n=(Array.isArray(t.ancestors)?t.ancestors.length:0)+1,r=document.querySelector(`.block[data-block-id="${e}"]`);if(!r)return;let o=r.parentElement;if(!o)return;let i=[],s=r.nextElementSibling;s&&s.classList.contains("block-children")&&i.push(s);let a=(i[i.length-1]||r).nextSibling;o.removeChild(r),i.forEach(u=>{u.parentNode===o&&o.removeChild(u)});let c=document.createElement("div");await Ws([t.block],c,n),Array.from(c.childNodes).forEach(u=>{o.insertBefore(u,a)}),Ol(),Rl()}function Vt(e=null){let t=d.article;if(!t)return;try{let o=!(!d.isPublicView&&!d.isRagView&&d.isOutlineEditing),i=xi(new Error),s=Date.now();if(!(js.hash===i.hash&&s-js.atMs<400)){js={atMs:s,hash:i.hash};let c=Array.isArray(t.blocks)?t.blocks.length:null,l=null;try{l=o?V.blocksContainer?.querySelectorAll?.(".block[data-block-id]")?.length??null:null}catch{l=null}wi("ui.renderArticle",{articleId:d.articleId||null,mode:d.mode,isOutlineEditing:!!d.isOutlineEditing,willFullRender:o,currentBlockId:d.currentBlockId||null,editingBlockId:d.editingBlockId||null,blocksCount:c,domBlocksCount:l,trace:e?String(e).slice(0,120):null,stackHash:i.hash,stackTop:i.top})}}catch{}if(!d.isPublicView&&!d.isRagView&&d.isOutlineEditing){Kt(),po();return}Array.isArray(t.blocks)&&gp(t.blocks),Kt();let n=t.id==="inbox"?[...t.blocks||[]].reverse():t.blocks;po(),V.blocksContainer.innerHTML="",Jr(),Ml(),Nl();let r=()=>{if(d.mode!=="edit"||!d.editingBlockId||d.editingCaretPosition==="start")return;let o=V.blocksContainer?.querySelector(`.block[data-block-id="${d.editingBlockId}"] .block-text[contenteditable="true"]`);if(!o)return;let i=document.activeElement;o===i||o.contains(i)||(o.focus({preventScroll:!0}),o.scrollHeight>o.clientHeight&&(o.scrollTop=o.scrollHeight),Zo(o))};Ws(n,V.blocksContainer).then(()=>{if(Rl(),Ol(),dl(),d.scrollTargetBlockId&&d.mode==="view"){let o=d.scrollTargetBlockId;requestAnimationFrame(()=>{let i=document.querySelector(`.block[data-block-id="${o}"]`);if(i){(i.querySelector(".block-content")||i).scrollIntoView({behavior:"smooth",block:"nearest"});let a=i.querySelector('.block-text[contenteditable="true"]');a&&d.mode==="edit"&&d.editingBlockId===o?(a.focus({preventScroll:!0}),d.editingCaretPosition==="start"?(a.scrollTop=0,gs(a)):Zo(a)):(i.setAttribute("tabindex","-1"),i.focus({preventScroll:!0}))}d.currentBlockId=o,d.scrollTargetBlockId=null})}r(),d.mode==="edit"&&typeof d.editingScrollTop=="number"&&V.blocksContainer&&(V.blocksContainer.scrollTop=d.editingScrollTop)})}var Js,js,Ys=Xe(()=>{Pt();Cn();un();rn();ir();zs();Rn();$n();$n();ar();Ar();sr();mo();Io();Vs();Js=null;js={atMs:0,hash:null}});function yp(){try{let e=window?.localStorage?.getItem?.(Hl)||"";if(!e)return[];let t=JSON.parse(e);return Array.isArray(t)?t.filter(Boolean):[]}catch{return[]}}function bp(e){try{window?.localStorage?.setItem?.(Hl,JSON.stringify(Array.isArray(e)?e:[]))}catch{}}function $l(e){let t=String(e||"").trim();if(!t)return!1;let n=yp(),r=n.filter(o=>String(o?.sectionId||o?.id||"")!==t);return r.length===n.length?!1:(bp(r),!0)}async function Sp(){let e=await fetch("/api/articles/inbox?include_history=0",{method:"GET",credentials:"include"});if(e.status===401||e.status===403){let t=new Error("auth");throw t.status=e.status,t}if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()}async function Fl(){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return{status:"offline"};let e=await Sp(),t=new Date().toISOString();try{e?.docJson&&typeof e.docJson=="object"&&await bn("inbox",e.docJson,t)}catch{}return{status:"refreshed",updatedAt:e?.updatedAt||null,docJson:e?.docJson||null}}var Hl,ea=Xe(()=>{Hr();zr();Hl="ttree_pending_quick_notes_v1"});async function wp(e){try{let n=(d.articlesIndex.length?d.articlesIndex:await vn()).filter(u=>u.id!=="inbox"),r=n.map(u=>({id:u.id,title:u.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),o=await or({title:"\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0432 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0438\u043B\u0438 \u0432\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E",confirmText:"\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:r,returnMeta:!0,hideConfirm:!1}),s=(o?.selectedId||(typeof o=="object"?o?.value:o)||""||"").trim();if(!s)return;let a=s.toLowerCase(),c=n.find(u=>u.id&&u.id.toLowerCase()===a||(u.title||"").toLowerCase()===a),l=c?c.id:s;if(!l||l==="inbox"){Ee("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}await apiRequest(`/api/articles/${d.articleId}/blocks/${e}/move-to/${l}`,{method:"POST"}),await Vn("inbox",{resetUndoStacks:!0}),Vt("views.moveBlockFromInbox.reloadInbox"),Ee("\u0411\u043B\u043E\u043A \u043F\u0435\u0440\u0435\u043D\u0435\u0441\u0451\u043D")}catch(t){Ee(t.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0431\u043B\u043E\u043A")}}async function ti(e){try{String(e||"").startsWith("inbox-")&&(e="inbox")}catch{}d.isPublicView=!1,d.isRagView=!1,document.body.classList.remove("public-embedded"),d.isEditingTitle=!1,await wo(),bo(!0),V.usersView&&V.usersView.classList.add("hidden"),V.blocksContainer.innerHTML="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...";try{if(e==="RAG"){d.isRagView=!0,d.mode="view",d.editingBlockId=null,d.pendingEditBlockId=null,d.scrollTargetBlockId=null,d.ragBlockMap={},fi("RAG");let r=(d.ragQuery||"").trim(),o=Array.isArray(d.ragResults)?d.ragResults:[],i=o.length,s=Array.from(new Set(o.map(h=>h&&h.articleTitle?String(h.articleTitle):"").filter(Boolean))),a=s.slice(0,8),c=["<p><strong>\u0421\u0432\u043E\u0434\u043A\u0430</strong></p>"];d.ragSummaryLoading?c.push('<p class="meta">\u0413\u0435\u043D\u0435\u0440\u0438\u0440\u0443\u044E \u0441\u0432\u043E\u0434\u043A\u0443\u2026</p>'):d.ragSummaryError?c.push(`<p class="meta">\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0432\u043E\u0434\u043A\u0438: ${d.ragSummaryError}</p>`):d.ragSummaryHtml?c.push(d.ragSummaryHtml):c.push('<p class="meta">\u0421\u0432\u043E\u0434\u043A\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435 \u0433\u043E\u0442\u043E\u0432\u0430.</p>');let l=["<p><strong>AI-\u043F\u043E\u0438\u0441\u043A: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B</strong></p>",`<p><span class="meta">\u0417\u0430\u043F\u0440\u043E\u0441:</span> ${r||"\u2014"}</p>`,`<p><span class="meta">\u041D\u0430\u0439\u0434\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432:</span> ${i}</p>`];a.length&&l.push(`<p><span class="meta">\u0421\u0442\u0430\u0442\u044C\u0438:</span> ${a.join(" \xB7 ")}</p>`),s.length>a.length&&l.push(`<p><span class="meta">\u2026\u0438 \u0435\u0449\u0451:</span> ${s.length-a.length}</p>`);let u=[{id:"rag-ai-summary",text:c.join(""),children:[],collapsed:!1},{id:"rag-meta",text:l.join(""),children:[],collapsed:!1},...o.filter(h=>h&&h.type==="block").map((h,g)=>{let b=h.blockText||"",S=h.articleTitle?String(h.articleTitle):"",p=S?`<p><strong>${S}</strong></p>`:`<p><strong>\u0420\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442 ${g+1}</strong></p>`,f=`rag-${h.blockId||g}`;return h.articleId&&h.blockId&&(d.ragBlockMap[f]={articleId:h.articleId,blockId:h.blockId}),{id:f,text:`${p}${b}`,children:[],collapsed:!1}})];d.article={id:"RAG",title:r?`AI: ${r}`:"AI: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B \u043F\u043E\u0438\u0441\u043A\u0430",blocks:u,updated_at:new Date().toISOString()},d.articleId="RAG",d.currentBlockId=u[0]?.id||null,Vt("views.loadArticleView.rag.render");return}let t=d.pendingEditBlockId||void 0,n=d.scrollTargetBlockId||void 0;if(await Vn(e,{resetUndoStacks:!0,desiredBlockId:n,editBlockId:t}),Vt("views.loadArticleView.afterLoadArticle"),fi(e),e==="inbox"&&navigator.onLine&&d.serverStatus==="ok")try{await Fl().catch(()=>{}),d.articleId==="inbox"&&!d.editingBlockId&&(await Vn("inbox",{resetUndoStacks:!1}),Vt("views.loadArticleView.inbox.refreshCache"))}catch{}}catch(t){try{if((Number(t?.status||0)||null)===404&&e&&e!=="inbox"){Yo(e,new Date().toISOString()).catch(()=>{}),_s(e),Ee("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430 (\u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E, \u0443\u0434\u0430\u043B\u0435\u043D\u0430)."),wn(an.list);return}}catch{}V.blocksContainer.innerHTML=`<p class="meta">\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u044C\u044E: ${t.message}</p>`}}async function Is(){d.isPublicView=!1,d.isRagView=!1,document.body.classList.remove("public-embedded"),V.usersView&&V.usersView.classList.add("hidden"),d.article=null,d.articleId=null,d.currentBlockId=null,d.isEditingTitle=!1,d.mode="view",d.editingBlockId=null,d.undoStack=[],d.redoStack=[],d.pendingEditBlockId=null,pi({restoreDom:!1}),bo(!1),Jr();try{if(d.isTrashView){let e=await di();Mn(e)}else{let e=await wo();Mn(e)}}catch(e){V.articleList.innerHTML=`<li>\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u043F\u0438\u0441\u043E\u043A: ${e.message}</li>`}}async function Es(e){d.isPublicView=!0,d.isRagView=!1,document.body.classList.add("public-embedded"),V.usersView&&V.usersView.classList.add("hidden"),bo(!0),d.isEditingTitle=!1,d.mode="view",d.editingBlockId=null,d.pendingEditBlockId=null,d.selectionAnchorBlockId=null,d.selectedBlockIds=[],d.undoStack=[],d.redoStack=[],pi({restoreDom:!1}),V.blocksContainer&&(V.blocksContainer.innerHTML="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...");try{let t=await apiRequest(`/api/public/articles/${encodeURIComponent(e)}`,{method:"GET",credentials:"omit"});d.article=t,d.articleId=t?.id||null;let n=jn(t?.blocks||[])[0];d.currentBlockId=n?n.id:null,Vt("views.loadPublicArticleView.render")}catch(t){V.blocksContainer&&(V.blocksContainer.innerHTML=`<p class="meta">\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E: ${t.message}</p>`)}}var zl=Xe(()=>{Pt();Cn();un();rn();ir();sr();zr();ar();ar();ar();Ar();$n();$s();Ys();Io();ea();Dl(wp)});var xr=Xe(()=>{mo();Rs();$s();Ys();zl();Io();Io();Jr()});function xp(e){try{let t=window.getComputedStyle(e).lineHeight,n=Number.parseFloat(t);if(Number.isFinite(n)&&n>0)return n}catch{}return 24}function Ap(e,{behavior:t="smooth",topLines:n=2,bottomLines:r=5}={}){if(!e)return;let o=V.blocksContainer||document.scrollingElement||document.documentElement;if(!o)return;let i=o.getBoundingClientRect(),s=e.getBoundingClientRect(),a=xp(o),c=Math.round(a*n),l=Math.round(a*r),u=0,h=i.top+c,g=i.bottom-l;if(s.bottom>g)u=s.bottom-g;else if(s.top<h)u=s.top-h;else return;if(o===document.body||o===document.documentElement||o===document.scrollingElement){window.scrollBy({top:u,behavior:t});return}o.scrollBy({top:u,behavior:t})}function jn(e=[],t=[]){return(e||[]).forEach(n=>{t.push(n),n.children&&n.children.length>0&&!n.collapsed&&jn(n.children,t)}),t}function At(e,t=d.article?.blocks||[],n=null,r=[]){for(let o=0;o<t.length;o+=1){let i=t[o];if(i.id===e)return{block:i,parent:n,index:o,siblings:t,ancestors:r};let s=At(e,i.children||[],i,[...r,i]);if(s)return s}return null}function Eo({scrollIntoView:e=!1,scrollBehavior:t="smooth"}={}){let n=new Set(Array.isArray(d.selectedBlockIds)?d.selectedBlockIds:[]);if(d.currentBlockId&&n.add(d.currentBlockId),document.querySelectorAll(".block[data-block-id]").forEach(o=>{let i=o.getAttribute("data-block-id"),s=i&&n.has(i);o.classList.toggle("selected",!!s),o.classList.remove("block--selected-root-ancestor");let a=o.querySelector(":scope > .block-surface");a&&a.classList.remove("block--selected-root-ancestor")}),d.currentBlockId&&d.article&&Array.isArray(d.article.blocks)){let o=At(d.currentBlockId),i=o?.ancestors||[],s=i.length>0?i[0]?.id:o?.block?.id;if(s){let a=document.querySelector(`.block[data-block-id="${s}"]`);if(a){let c=a.querySelector(":scope > .block-surface");c&&c.classList.add("block--selected-root-ancestor")}}}if(e&&d.mode==="view"&&d.currentBlockId){let o=document.querySelector(`.block[data-block-id="${d.currentBlockId}"]`);o&&Ap(o,{behavior:t||"smooth",topLines:2,bottomLines:5})}}function Ul(e,t={}){if(!e||d.currentBlockId===e)return;let{preserveSelection:n=!1,scrollIntoView:r,scrollBehavior:o}=t;d.currentBlockId=e,n||(d.selectionAnchorBlockId=null,d.selectedBlockIds=[]);let i=typeof r=="boolean"?r:d.mode==="view";Eo({scrollIntoView:i,scrollBehavior:o||"smooth"})}function cr(e,t={}){Ul(e,{preserveSelection:!1,...t})}function ql(e){if(!d.article)return;let t=jn(d.article.blocks),n=t.findIndex(o=>o.id===d.currentBlockId);if(n===-1)return;let r=t[n+e];r&&(d.mode==="view"&&(d.scrollTargetBlockId=r.id),Ul(r.id,{preserveSelection:!1}))}function Kl(e){if(!d.article)return;let t=jn(d.article.blocks);if(!t.length)return;let n=d.selectionAnchorBlockId||d.currentBlockId||t[0].id;n||(n=t[0].id),d.selectionAnchorBlockId||(d.selectionAnchorBlockId=n);let r=t.findIndex(u=>u.id===n);if(r===-1)return;let o=d.currentBlockId||n,i=t.findIndex(u=>u.id===o);i===-1&&(i=r);let s=i+e;if(s<0||s>=t.length)return;let[a,c]=s>=r?[r,s]:[s,r],l=t.slice(a,c+1).map(u=>u.id);d.selectedBlockIds=l,d.currentBlockId=t[s].id,d.mode==="view"&&(d.scrollTargetBlockId=d.currentBlockId),Eo({scrollIntoView:d.mode==="view"})}var Vl=Xe(()=>{Pt();Cn()});function lr(e){return e?e.nodeType===Node.TEXT_NODE?/\n\s*\n/.test(e.textContent||""):e.nodeType===Node.ELEMENT_NODE&&(e.tagName==="BR"||(e.tagName==="P"||e.tagName==="DIV")&&(!(e.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&(nbsp|#160);/gi,"").trim()||!(e.textContent||"").replace(/\u00a0/g,"").trim()&&!e.querySelector("img"))):!1}function Ai(e=[]){let t=document.createElement("div");return e.forEach(n=>t.appendChild(n)),t.innerHTML.trim()}function ta(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=[],r=(i="")=>{let s=document.createElement("p");i?s.innerHTML=i:s.appendChild(document.createElement("br")),n.push(s)};Array.from(t.content.childNodes).forEach(i=>{if(i.nodeType===Node.TEXT_NODE){let s=(i.textContent||"").trim();s&&r(s);return}if(i.nodeType===Node.ELEMENT_NODE){if(i.tagName==="P"){n.push(i.cloneNode(!0));return}if(i.tagName==="BR"){r("");return}if(i.tagName==="DIV"){r(i.innerHTML);return}r(i.outerHTML)}}),n.length||r("");let o=document.createElement("div");return n.forEach(i=>o.appendChild(i)),o.innerHTML}function Jn(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll(".block-header").forEach(h=>{let g=h.parentNode;if(g){for(;h.firstChild;)g.insertBefore(h.firstChild,h);g.removeChild(h)}});let n=Array.from(t.content.childNodes),r=h=>h?.nodeType===Node.TEXT_NODE&&!(h.textContent||"").trim(),o=0;for(;o<n.length&&r(n[o]);)o+=1;let i=n[o];if(!i||i.nodeType!==Node.ELEMENT_NODE||i.tagName!=="P"||lr(i))return{titleHtml:"",bodyHtml:Ai(n)};let s=o+1;for(;s<n.length&&r(n[s]);)s+=1;let a=n[s];if(!(!!a&&lr(a)&&(a.nodeType===Node.ELEMENT_NODE?a.tagName==="P"||a.tagName==="DIV"||a.tagName==="BR":!1)))return{titleHtml:"",bodyHtml:Ai(n)};let l=[i.cloneNode(!0)],u=[];for(let h=s+1;h<n.length;h+=1)u.push(n[h].cloneNode(!0));return{titleHtml:Ai(l),bodyHtml:Ai(u)}}function jl({event:e,element:t,range:n,selection:r,notifyEditingInput:o,logDebug:i}){if(!e||!t||!n||!r||!n.collapsed)return!1;let s=e.key==="Backspace"||e.code==="Backspace"||e.keyCode===8,a=e.key==="Delete"||e.key==="Del"||e.code==="Delete"||e.code==="Del"||e.keyCode===46;if(!s&&!a)return!1;let c=f=>{try{r.removeAllRanges(),r.addRange(f)}catch{}try{t.focus({preventScroll:!0})}catch{t.focus()}},l=f=>{let x=(n.commonAncestorContainer?.nodeType===Node.ELEMENT_NODE?n.commonAncestorContainer:n.commonAncestorContainer?.parentElement)?.closest?.("p");if(x)return x;let A=t,I=Array.from(A.childNodes),N=n.startContainer;for(;N&&N.parentNode!==A;)N=N.parentNode;let O=N?I.indexOf(N):-1,U=H=>{let X=H==="prev"?-1:1,G=O;for(G===-1?G=H==="prev"?I.length-1:0:G=H==="prev"?G-1:G;G>=0&&G<I.length;){let oe=I[G];if(oe?.nodeType===Node.ELEMENT_NODE&&oe.tagName==="P")return oe;G+=X}return null};return f==="Delete"?U("next")||U("prev"):f==="Backspace"?U("prev")||U("next"):null},u=()=>{if(n.startContainer!==t)return{prev:null,next:null};let f=Array.from(t.childNodes),w=n.startOffset,x=null,A=null;for(let I=w-1;I>=0;I-=1){let N=f[I];if(N?.nodeType===Node.ELEMENT_NODE&&N.tagName==="P"){x=N;break}}for(let I=w;I<f.length;I+=1){let N=f[I];if(N?.nodeType===Node.ELEMENT_NODE&&N.tagName==="P"){A=N;break}}return{prev:x,next:A}},h=f=>{let w=f?.previousElementSibling;for(;w&&w.tagName!=="P";)w=w.previousElementSibling;return w&&w.tagName==="P"?w:null},g=f=>{let w=f?.nextElementSibling;for(;w&&w.tagName!=="P";)w=w.nextElementSibling;return w&&w.tagName==="P"?w:null},b=f=>{if(!f)return!0;let w=new Set(["span","b","strong","i","em","u","s","mark","code"]),x=new Set(["img","video","audio","iframe"]),A=I=>{if(!I)return!1;if(I.nodeType===Node.TEXT_NODE)return(I.textContent||"").replace(/\u00a0/g,"").replace(/[\u200B-\u200D\uFEFF]/g,"").trim().length>0;if(I.nodeType!==Node.ELEMENT_NODE)return!1;let N=(I.tagName||"").toLowerCase();return N==="br"?!1:x.has(N)?!0:N==="span"&&(I.getAttribute("class")||"").includes("resizable-image__handle")?!1:w.has(N)?Array.from(I.childNodes||[]).some(A):!0};return!Array.from(f.childNodes||[]).some(A)},S=f=>{if(!f)return!1;let w=document.createRange();w.selectNodeContents(f);try{w.setEnd(n.startContainer,n.startOffset)}catch{return!1}if(b(w.cloneContents()))return!0;try{let x=document.createRange();return x.selectNodeContents(f),x.collapse(!0),n.compareBoundaryPoints(Range.START_TO_START,x)===0}catch{return!1}},p=f=>{if(!f)return!1;let w=document.createRange();w.selectNodeContents(f);try{w.setStart(n.startContainer,n.startOffset)}catch{return!1}if(b(w.cloneContents()))return!0;try{let x=document.createRange();return x.selectNodeContents(f),x.collapse(!1),n.compareBoundaryPoints(Range.END_TO_END,x)===0}catch{return!1}};if(window.__debugMergeP&&i("mergeP.keydown",{key:e.key,code:e.code,keyCode:e.keyCode,startContainer:n.startContainer?.nodeName,startOffset:n.startOffset,collapsed:n.collapsed}),s){if(n.startContainer===t){let A=u();if(A.prev&&A.next){e.preventDefault(),e.stopPropagation();let I=document.createRange();for(I.selectNodeContents(A.prev),I.collapse(!1);A.next.firstChild;)A.prev.appendChild(A.next.firstChild);return A.next.remove(),c(I),o(t),!0}return!1}let f=l("Backspace");if(!f||!t.contains(f)||!S(f))return!1;let w=h(f);if(!w||!t.contains(w))return!1;e.preventDefault(),e.stopPropagation();let x=document.createRange();for(x.selectNodeContents(w),x.collapse(!1);f.firstChild;)w.appendChild(f.firstChild);return f.remove(),c(x),o(t),!0}if(a){let f=l("Delete");if(!f||!t.contains(f)){let A=u();if(A.prev&&A.next){e.preventDefault(),e.stopPropagation();let I=document.createRange();for(I.selectNodeContents(A.prev),I.collapse(!1);A.next.firstChild;)A.prev.appendChild(A.next.firstChild);return A.next.remove(),c(I),o(t),!0}return!1}if(!p(f))return!1;let w=g(f);if(!w||!t.contains(w))return!1;e.preventDefault(),e.stopPropagation();let x=document.createRange();for(x.selectNodeContents(f),x.collapse(!1);w.firstChild;)f.appendChild(w.firstChild);return w.remove(),c(x),o(t),!0}return!1}var na=Xe(()=>{});function Co(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=r=>{if(r&&!(r.nodeType===Node.ELEMENT_NODE&&r.tagName==="A")){if(r.nodeType===Node.TEXT_NODE){let o=r.textContent||"";if(ki.lastIndex=0,!ki.test(o))return;let s=document.createDocumentFragment(),a=0;ki.lastIndex=0;let c;for(;(c=ki.exec(o))!==null;){let[l]=c;c.index>a&&s.appendChild(document.createTextNode(o.slice(a,c.index)));let u=l.startsWith("http")?l:`https://${l}`,h=document.createElement("a");h.href=u,h.target="_blank",h.rel="noopener noreferrer",h.textContent=l,s.appendChild(h),a=c.index+l.length}a<o.length&&s.appendChild(document.createTextNode(o.slice(a))),r.parentNode&&r.parentNode.replaceChild(s,r);return}Array.from(r.childNodes||[]).forEach(n)}};return Array.from(t.content.childNodes).forEach(n),t.innerHTML}function Jl(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll("script, style").forEach(o=>o.remove());let n=(o="")=>/^javascript:/i.test(o.trim()),r=o=>{if(!o||o.nodeType!==Node.ELEMENT_NODE){Array.from(o?.childNodes||[]).forEach(r);return}Array.from(o.attributes||[]).forEach(i=>{let s=i.name.toLowerCase(),a=i.value||"";if(s.startsWith("on")||s==="style"){o.removeAttribute(i.name);return}(s==="href"||s==="src")&&n(a)&&o.removeAttribute(i.name)}),Array.from(o.childNodes||[]).forEach(r)};return Array.from(t.content.childNodes||[]).forEach(r),t.innerHTML}function Ii(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=r=>{if(!r)return!0;if(r.nodeType===Node.TEXT_NODE)return!(r.textContent||"").replace(/\u00a0/g,"").trim();if(r.nodeType!==Node.ELEMENT_NODE)return!1;if(r.tagName==="BR")return!0;let o=(r.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&nbsp;/gi,"").trim(),i=(r.textContent||"").replace(/\u00a0/g,"").trim(),s=!!r.querySelector("img,video,audio,iframe");return!o&&!i&&!s};for(;t.content.firstChild&&n(t.content.firstChild);)t.content.removeChild(t.content.firstChild);for(;t.content.lastChild&&n(t.content.lastChild);)t.content.removeChild(t.content.lastChild);return t.innerHTML}function Wl(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=(t.content.textContent||"").replace(/\u00a0/g," ").trim(),r=!!t.content.querySelector("a"),o=!1;{let S=Array.from(t.content.childNodes||[]);for(let p=0;p<S.length;p+=1){let f=S[p];if(f.nodeType===Node.TEXT_NODE){if(!(f.textContent||"").trim())continue;break}lr(f)&&(o=!0);break}}let i=document.createElement("template");i.innerHTML=e||"",i.content.querySelectorAll("img").forEach(S=>{let p=String(S.getAttribute("src")||"").trim();if(!/^(blob:|filesystem:)/i.test(p))return;let f=String(S.getAttribute("alt")||"").trim()||"image",w=S.closest?.(".resizable-image")||S;try{w.replaceWith(document.createTextNode(`[${f} \u2014 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0431\u044B\u043B\u043E blob: \u0438 \u043D\u0435 \u0431\u044B\u043B\u043E \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E]`))}catch{}});let a=(()=>{if(!Array.from(i.content.childNodes||[]).length)return!1;let p=Array.from(i.content.querySelectorAll("p"));if(p.length<2)return!1;let f=te=>{let be=te.trim();return be.startsWith("|")&&be.indexOf("|",1)!==-1},x=p.map(te=>(te.textContent||"").replace(/\u00a0/g," ").trim()).filter(te=>te);if(x.length<2||!x.every(f))return!1;let A=x.map(te=>{let be=te.trim();return(be.endsWith("|")?be.slice(1,-1):be.slice(1)).split("|").map(kt=>kt.trim())}),I=A[0],N=A.slice(1),O=N.reduce((te,be)=>Math.max(te,be.length),I.length),U=document.createElement("table");U.className="memus-table";let H=document.createElement("colgroup"),X=100/Math.max(O,1);for(let te=0;te<O;te+=1){let be=document.createElement("col");be.setAttribute("width",`${X.toFixed(4)}%`),H.appendChild(be)}U.appendChild(H);let G=document.createElement("thead"),oe=document.createElement("tr");for(let te=0;te<O;te+=1){let be=document.createElement("th");be.textContent=I[te]||"",oe.appendChild(be)}G.appendChild(oe),U.appendChild(G);let xe=document.createElement("tbody");return N.forEach(te=>{let be=document.createElement("tr"),Qe=[...te];for(let kt=0;kt<O;kt+=1){let Ot=document.createElement("td");Ot.textContent=Qe[kt]||"",be.appendChild(Ot)}xe.appendChild(be)}),U.appendChild(xe),i.content.innerHTML="",i.content.appendChild(U),Co(i.innerHTML).replace(/<\/a>\s*<a/gi,"</a> <a")})();if(a)return a;i.content.querySelectorAll(".table-toolbar, .table-toolbar-btn").forEach(S=>{S.remove()}),i.content.querySelectorAll(".block-header").forEach(S=>{let p=S.parentNode;if(p){for(;S.firstChild;)p.insertBefore(S.firstChild,S);p.removeChild(S)}});let c=S=>{Array.from(S.childNodes).forEach(p=>{if(p.nodeType===Node.ELEMENT_NODE){if(p.tagName==="DIV"){let f=document.createElement("p");f.innerHTML=p.innerHTML,p.parentNode.replaceChild(f,p),c(f);return}c(p)}})};c(i.content),(S=>{Array.from(S.childNodes||[]).forEach(f=>{if(f.nodeType===Node.TEXT_NODE){let x=(f.textContent||"").replace(/\u00a0/g," ");if(!x.trim()){if(f.previousSibling&&f.nextSibling){f.textContent=" ";return}S.removeChild(f);return}let I=document.createElement("p");I.textContent=x,S.replaceChild(I,f)}})})(i.content),i.content.querySelectorAll("p").forEach(S=>{(S.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim()||(S.innerHTML="",S.appendChild(document.createElement("br")))});let u=i.content;if(!!u.querySelector("p")){if(o){let S=Array.from(u.childNodes||[]),p=null;for(let f=0;f<S.length;f+=1){let w=S[f];if(!(w.nodeType===Node.TEXT_NODE&&!(w.textContent||"").trim())){p=w;break}}if(p){if(!(p.tagName==="P"&&lr(p))){let f=document.createElement("p");f.appendChild(document.createElement("br")),u.insertBefore(f,p)}}else{let f=document.createElement("p");f.appendChild(document.createElement("br")),u.appendChild(f)}}}else{let S=document.createElement("p");S.appendChild(document.createElement("br")),u.appendChild(S)}let b=Co(i.innerHTML).replace(/<\/a>\s*<a/gi,"</a> <a");return!b.trim()&&(n||r)?e||"":b}var ki,Yl=Xe(()=>{na();ki=/((?:https?:\/\/|www\.)[^\s<>"']+)/gi});function dr(e){if(!e)return;if(!(e.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&nbsp;/gi,"").trim()){e.innerHTML="";let n=document.createRange();n.selectNodeContents(e),n.collapse(!0);let r=window.getSelection();r&&(r.removeAllRanges(),r.addRange(n))}}var ra=Xe(()=>{});function Ir(e){if(!e)return!1;if(e.type&&e.type.startsWith("image/"))return!0;let t=(e.name||"").toLowerCase();return t?/\.(png|jpe?g|gif|webp|bmp|svg|heic|heif)$/i.test(t):!1}function oa(e=[],t=[]){let n=[];return Array.from(e||[]).forEach(r=>{if(r.kind==="file"){let o=typeof r.getAsFile=="function"?r.getAsFile():null;o&&Ir(o)&&n.push(o)}}),!n.length&&t?.length&&Array.from(t).forEach(r=>{Ir(r)&&n.push(r)}),n}function ia(e=[],t=[]){let n=[];return Array.from(e||[]).forEach(r=>{if(r.kind==="file"){let o=typeof r.getAsFile=="function"?r.getAsFile():null;o&&!Ir(o)&&n.push(o)}}),!n.length&&t?.length&&Array.from(t).forEach(r=>{Ir(r)||n.push(r)}),n}async function Ei(e,t,n){let r=`img-${Date.now()}-${Math.random().toString(16).slice(2)}`,o=t&&t.name?t.name:"image",i=Gt(o).replace(/"/g,"&quot;");try{dr(e),Xn(e,`<span data-pending-image="true" data-image-token="${r}">${i} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F...)</span>`)}catch{}try{let{url:s}=await fo(t),c=`
      <span class="resizable-image" style="width:320px;max-width:100%;">
        <span class="resizable-image__inner">${`<img src="${s}" alt="${i}" draggable="false" />`}</span>
        <span class="resizable-image__handle" data-direction="e" aria-hidden="true"></span>
      </span>
    `,l=e,u=l&&l.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`);if(n&&(!u||!l.isConnected)){let h=document.querySelector(`.block[data-block-id="${n}"]`);if(h){let b=h.querySelector('.block-text[contenteditable="true"]')||h.querySelector(".block-text.block-body");b&&(l=b,u=l.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`))}}u?(u.removeAttribute("data-pending-image"),u.removeAttribute("data-image-token"),u.outerHTML=c):l&&(dr(l),Xn(l,c))}catch(s){try{let c=e;if(n&&!c.isConnected){let l=document.querySelector(`.block[data-block-id="${n}"]`);if(l){let h=l.querySelector('.block-text[contenteditable="true"]')||l.querySelector(".block-text.block-body");h&&(c=h)}}if(c){let l=c.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`);l&&(l.textContent=`${o} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F)`,l.removeAttribute("data-pending-image"))}}catch{}try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"insertImageFromFileError",data:{message:s&&s.message?String(s.message):String(s),name:t&&t.name,type:t&&t.type,size:t&&t.size}})}).catch(()=>{})}catch{}try{let c={where:"insertImageFromFile",message:s&&s.message?String(s.message):String(s),status:typeof s?.status=="number"?s.status:null,name:t&&t.name,type:t&&t.type,size:t&&t.size},l=c.status===null?"null":String(c.status);window.alert(`upload failed (status ${l}):\\n${JSON.stringify(c,null,2)}`)}catch{}let a=String(s?.message||"").toLowerCase();a.includes("status 0")||a.includes("network error")?Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 (\u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C). \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438, \u043F\u0440\u0438 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u043E\u0441\u0442\u0438, \u0432\u043E\u0439\u0434\u0438\u0442\u0435 \u0437\u0430\u043D\u043E\u0432\u043E."):Ee(s.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435")}}function kp(e){if(e.button!==0)return;let t=e.target?.closest(".resizable-image__handle");if(!t)return;let n=t.closest(".resizable-image"),o=n?.closest(".block")?.dataset?.blockId;if(!n||!o||d.mode!=="edit"||d.editingBlockId!==o)return;e.preventDefault(),e.stopPropagation();let i=n.getBoundingClientRect();ur={wrapper:n,startWidth:i.width,startX:e.clientX},n.classList.add("resizable-image--resizing")}function Ip(e){if(!ur)return;e.preventDefault();let t=e.clientX-ur.startX,r=parseFloat(getComputedStyle(document.documentElement).fontSize)||16,o=Math.max(r,document.documentElement.clientWidth-32),i=ur.startWidth+t;i=Math.max(r,Math.min(i,o)),ur.wrapper.style.width=`${i}px`}function Xl(){ur&&(ur.wrapper.classList.remove("resizable-image--resizing"),ur=null)}function Ql(){Gl||(Gl=!0,document.addEventListener("pointerdown",kp),document.addEventListener("pointermove",Ip),document.addEventListener("pointerup",Xl),document.addEventListener("pointercancel",Xl))}var ur,Gl,Zl=Xe(()=>{Pt();un();rn();Rn();ra();ur=null,Gl=!1});function ed({listTag:e,resolveTarget:t,restoreSelection:n,richContextRange:r,notifyEditingInput:o,setRichContextRange:i}){let s=t();if(!s||!document.contains(s))return;n();let a=window.getSelection(),c=null;if(r&&s.contains(r.commonAncestorContainer))c=r.cloneRange();else if(a&&a.rangeCount>0){let x=a.getRangeAt(0);s.contains(x.commonAncestorContainer)&&(c=x.cloneRange())}c||(c=document.createRange(),c.selectNodeContents(s),c.collapse(!1));let l=c.startContainer?.nodeType===Node.ELEMENT_NODE?c.startContainer:c.startContainer?.parentElement,u=l?.closest?.("li"),h=u?.closest?.("ol,ul"),g=x=>{if(!x)return;let A=document.createRange();A.selectNodeContents(x),A.collapse(!1),a&&(a.removeAllRanges(),a.addRange(A)),i(A);try{s.focus({preventScroll:!0})}catch{s.focus()}s.classList.remove("block-body--empty"),o(s)},b=x=>{let A=x.parentElement?.tagName==="P"&&x.parentElement.childNodes.length===1?x.parentElement:x,I=Array.from(x.children||[]).filter(U=>U.nodeType===Node.ELEMENT_NODE&&U.tagName==="LI"),N=document.createDocumentFragment(),O=[];I.forEach(U=>{let H=document.createElement("p");for(;U.firstChild;)H.appendChild(U.firstChild);O.push(H),N.appendChild(H)}),A.replaceWith(N),g(O[0]||null)};if(h){if(h.tagName.toLowerCase()===e){b(h);return}let A=document.createElement(e);for(;h.firstChild;)A.appendChild(h.firstChild);h.replaceWith(A),g(u||A.lastElementChild||A);return}let S=()=>{if(!c.collapsed)return null;let x=l?.closest?.("p")||null;if(x&&s.contains(x))return x;if(c.startContainer===s){let A=Array.from(s.childNodes),I=c.startOffset;for(let N=I-1;N>=0;N-=1){let O=A[N];if(O?.nodeType===Node.ELEMENT_NODE&&O.tagName==="P")return O}for(let N=I;N<A.length;N+=1){let O=A[N];if(O?.nodeType===Node.ELEMENT_NODE&&O.tagName==="P")return O}}return null},p=[];if(c.collapsed){let x=S();x&&(p=[x])}else if(p=Array.from(s.querySelectorAll(":scope > p")).filter(A=>{try{return c.intersectsNode(A)}catch{return!1}}),!p.length){let A=l?.closest?.("p");A&&s.contains(A)&&(p=[A])}if(!p.length)return;let f=document.createElement(e);p.forEach(x=>{let A=document.createElement("li");for(;x.firstChild;)A.appendChild(x.firstChild);f.appendChild(A)}),p[0].replaceWith(f),p.slice(1).forEach(x=>x.remove()),g(f.firstElementChild||f)}var td=Xe(()=>{});var Ks={};$o(Ks,{applyEditingUndoStep:()=>Bp,attachRichContentHandlers:()=>Zs,buildEditableBlockHtml:()=>Gs,buildStoredBlockHtml:()=>gl,cleanupEditableHtml:()=>Wl,clearEditingUndoSession:()=>Tp,countBlocks:()=>qs,ensureBlockVisible:()=>Hs,expandCollapsedAncestors:()=>Mp,extendSelection:()=>Kl,extractBlockSections:()=>Jn,findBlock:()=>At,findCollapsibleTarget:()=>Np,findFallbackBlockId:()=>yi,flattenVisible:()=>jn,initEditingUndoForElement:()=>vp,insertFilesIntoEditable:()=>Qs,isSeparatorNode:()=>lr,moveSelection:()=>ql,setCollapseState:()=>Ci,setCurrentBlock:()=>cr,toggleCollapse:()=>Xs});function id(e=""){return e?e.startsWith("app:/")?`/api/yandex/disk/file?path=${encodeURIComponent(e)}`:e.startsWith("disk:/")?`/api/yandex/disk/file?path=${encodeURIComponent(e)}`:e:""}function Cp(e,t){if(e===t)return!1;if(t.startsWith(e)){let n=t.slice(e.length);if(n.length>0&&n.length<=Ep&&/^[A-Za-zА-Яа-я0-9]+$/.test(n))return!1}return!0}function vp(e,t){if(!e||!t)return;d.editingUndo={blockId:t,snapshots:[e.innerHTML],index:0,lastText:e.textContent||"",lastSnapshotAt:Date.now()};let n=()=>{let r=d.editingUndo;if(!r||r.blockId!==t)return;let o=e.innerHTML,i=e.textContent||"",{snapshots:s,index:a,lastText:c,lastSnapshotAt:l}=r,u=Date.now();if(!Cp(c||"",i)){r.lastText=i;return}if(s[a]===o){r.lastText=i,r.lastSnapshotAt=u;return}a<s.length-1&&s.splice(a+1),s.push(o),r.index=s.length-1,r.lastText=i,r.lastSnapshotAt=u};e.addEventListener("input",()=>{!d.editingUndo||d.editingUndo.blockId!==t||d.mode!=="edit"||d.editingBlockId!==t||n()})}function Tp(){d.editingUndo=null}function vo(e){if(e)try{let t=typeof InputEvent=="function"?new InputEvent("input",{bubbles:!0}):new Event("input",{bubbles:!0});e.dispatchEvent(t)}catch{try{let n=document.createEvent("Event");n.initEvent("input",!0,!1),e.dispatchEvent(n)}catch{}}}function Bp(e){let t=d.editingUndo;if(!t||!t.blockId||!e||d.mode!=="edit"||d.editingBlockId!==t.blockId)return!1;let n=document.querySelector(`.block[data-block-id="${t.blockId}"] .block-text[contenteditable="true"]`);if(!n)return!1;let r=t.index+e;if(r<0||r>=t.snapshots.length)return!1;t.index=r;let o=t.snapshots[r];n.innerHTML=o;try{n.focus({preventScroll:!0})}catch{n.focus()}try{let i=window.getSelection&&window.getSelection();if(i){let s=document.createRange();s.selectNodeContents(n),s.collapse(!1),i.removeAllRanges(),i.addRange(s)}}catch{}return!0}function Gs(e=""){let t=Jn(e);if(!t.titleHtml)return e||"";let n=ta(t.titleHtml),r=t.bodyHtml||"";if(r){let i=document.createElement("template");i.innerHTML=r;let s=i.content.firstChild;for(;s&&lr(s);){let a=s;s=s.nextSibling,i.content.removeChild(a)}r=i.innerHTML}let o=ta(r||"");return`${n}<p><br /></p>${o}`}function gl(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll(".block-header").forEach(i=>{let s=i.parentNode;if(s){for(;i.firstChild;)s.insertBefore(i.firstChild,i);s.removeChild(i)}});let n=t.innerHTML,r=Jn(n);if(!r.titleHtml)return e||"";let o=`<div class="block-header">${r.titleHtml}</div>`;return r.bodyHtml?`${o}<div><br /></div>${r.bodyHtml}`:o}async function Xs(e){let t=At(e);t&&Ci(e,!t.block.collapsed)}async function Ci(e,t){let n=At(e);if(!n||n.block.collapsed===t)return;let r=()=>{let s=document.getElementById("blocksContainer");if(!s)return null;let a=d.currentBlockId;if(!a)return{container:s};let c=s.querySelector(`.block[data-block-id="${a}"]`);if(!c)return{container:s};let l=s.getBoundingClientRect(),u=c.getBoundingClientRect();return{container:s,currentId:a,topOffset:u.top-l.top}},o=s=>{if(!s?.container)return;let{container:a}=s;if(!s.currentId||typeof s.topOffset!="number")return;let c=a.querySelector(`.block[data-block-id="${s.currentId}"]`);if(!c)return;let l=a.getBoundingClientRect(),h=c.getBoundingClientRect().top-l.top;a.scrollTop+=h-s.topOffset},i=r();n.block.collapsed=t,await fn(e),Eo({scrollIntoView:!1}),o(i);try{let s=await Tt(`/api/articles/${d.articleId}/collapse`,{method:"PATCH",body:JSON.stringify({blockId:e,collapsed:t})});s?.updatedAt&&(d.article.updatedAt=s.updatedAt)}catch(s){n.block.collapsed=!t,await fn(e),Eo({scrollIntoView:!1}),o(i),Ee(s.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430")}}function Np(e,t){let n=At(e);for(;n;){let o=!!Jn(n.block.text||"").titleHtml,i=!!n.block.children?.length;if((o||i)&&n.block.collapsed!==t)return n.block.id;if(!n.parent)break;n=At(n.parent.id)}return null}async function Mp(e){let t=At(e);if(!t)return;let n=(t.ancestors||[]).filter(r=>r.collapsed);for(let r of n)await Ci(r.id,!1)}function yi(e){let t=At(e);if(!t)return null;let n=t.siblings?.[t.index+1];if(n)return n.id;let r=t.siblings?.[t.index-1];return r?r.id:t.parent?t.parent.id:null}function qs(e=[]){return(e||[]).reduce((t,n)=>t+1+qs(n.children||[]),0)}async function aa(e,t,n){if(!d.articleId){Ee("\u041D\u0435 \u0432\u044B\u0431\u0440\u0430\u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044F \u0434\u043B\u044F \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0444\u0430\u0439\u043B\u0430");return}let r=`att-${Date.now()}-${Math.random().toString(16).slice(2)}`,o=Gt(t?.name||"\u0444\u0430\u0439\u043B"),i=t?.name||"\u0444\u0430\u0439\u043B",s="";sn("attachment: uploading to Yandex Disk",{name:t?.name,type:t?.type,size:t?.size,articleId:d.articleId,token:r});try{dr(e),Xn(e,`<a data-pending-attachment="true" data-attachment-token="${r}">${o} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430...)</a>`)}catch{}try{let a=await Qo(d.articleId,t,{onProgress:g=>{let b=Math.max(0,Math.min(100,Math.round(g||0)));sn("attachment upload progress",{percent:b,name:t?.name});try{let S=e,p=S.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);if(n&&(!p||!S.isConnected)){let f=document.querySelector(`.block[data-block-id="${n}"]`);if(f){let x=f.querySelector('.block-text[contenteditable="true"]')||f.querySelector(".block-text.block-body");x&&(S=x,p=S.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`))}}if(p){let f=b>=100?`${i} (\u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0430...)`:`${i} (${b}%)`;f!==s&&(s=f,p.textContent=f)}}catch{}}}),c=Gt(a.originalName||t.name||"\u0444\u0430\u0439\u043B"),l=a.storedPath||a.url||"",u=id(l),h=Gt(u);if(h){let g=e,b=g.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);if(n&&(!b||!g.isConnected)){let S=document.querySelector(`.block[data-block-id="${n}"]`);if(S){let f=S.querySelector('.block-text[contenteditable="true"]')||S.querySelector(".block-text.block-body");f&&(g=f,b=g.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`))}}b?(b.removeAttribute("data-pending-attachment"),b.removeAttribute("data-attachment-token"),b.setAttribute("href",h),b.setAttribute("target","_blank"),b.setAttribute("rel","noopener noreferrer"),b.textContent=c):(dr(g),Xn(g,`<a href="${h}" target="_blank" rel="noopener noreferrer">${c}</a>`))}}catch(a){try{let l=e;if(n&&!l.isConnected){let h=document.querySelector(`.block[data-block-id="${n}"]`);if(h){let b=h.querySelector('.block-text[contenteditable="true"]')||h.querySelector(".block-text.block-body");b&&(l=b)}}let u=l.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);u&&(u.textContent=`${o} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`)}catch{}let c=String(a?.message||"").toLowerCase();c.includes("status 0")||c.includes("network error")?Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B (\u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C). \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438, \u043F\u0440\u0438 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u043E\u0441\u0442\u0438, \u0432\u043E\u0439\u0434\u0438\u0442\u0435 \u0437\u0430\u043D\u043E\u0432\u043E."):Ee(a.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u043D\u0430 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A")}}function Qs(e,t=[],n){if(!e||!t||!t.length)return;let r=Array.from(t),o=r.filter(s=>Ir(s)),i=r.filter(s=>s&&!Ir(s));o.forEach(s=>Ei(e,s,n)),i.forEach(s=>aa(e,s,n))}function Zs(e,t){od(e,t);let n=e.closest(".block-content");n&&n!==e&&od(n,t,e),e.addEventListener("paste",r=>{if(d.mode!=="edit"||d.editingBlockId!==t)return;let o=oa(r.clipboardData?.items),i=ia(r.clipboardData?.items);if(o.length>0)r.preventDefault(),o.forEach(s=>Ei(e,s,t));else if(i.length>0)r.preventDefault(),sn("paste: non-image files detected",i.map(s=>({name:s.name,type:s.type,size:s.size}))),i.forEach(s=>aa(e,s,t));else{r.preventDefault();let s=g=>{let b=String(g||"").trim();if(!b)return"";let S=document.createElement("template");S.innerHTML=b;let p=S.content.querySelector("body");return((p?p.innerHTML:S.innerHTML)||"").replace(/<!--\s*StartFragment\s*-->/gi,"").replace(/<!--\s*EndFragment\s*-->/gi,"").trim()},a=g=>{let b=String(g||"").trim();if(!b)return"";if(/<\s*(table|ul|ol)\b/i.test(b)||!/<\s*(p|div|h[1-6])\b/i.test(b))return b;let S=document.createElement("template");S.innerHTML=b,(A=>{S.content.querySelectorAll(A).forEach(I=>{let N=I.parentNode;if(N){for(;I.firstChild;)N.insertBefore(I.firstChild,I);N.removeChild(I)}})})("ms-cmark-node");let f=[],w=A=>{let I=String(A||"").replace(/^\s*(<br\s*\/?>\s*)+/gi,"").replace(/(\s*<br\s*\/?>\s*)+$/gi,"").trim();I&&f.push(I)},x=Array.from(S.content.childNodes||[]);for(let A of x){if(!A)continue;if(A.nodeType===Node.TEXT_NODE){let N=(A.textContent||"").replace(/\u00a0/g," ").trim();N&&w(Gt(N));continue}if(A.nodeType!==Node.ELEMENT_NODE)continue;let I=(A.tagName||"").toUpperCase();if(/^H[1-6]$/.test(I)){w(`<strong>${A.innerHTML||""}</strong>`);continue}if(I==="P"||I==="DIV"||I==="LI"||I==="BLOCKQUOTE"){w(A.innerHTML||"");continue}if(I==="BR"){w("<br />");continue}w(A.outerHTML||A.innerHTML||"")}return f.length?f.join("<br /><br />"):""},c=g=>{dr(e);try{e.focus({preventScroll:!0})}catch{e.focus()}try{if(typeof document.execCommand=="function"&&document.execCommand("insertHTML",!1,g))return!0}catch{}return Xn(e,g),!0},l=g=>{let b=s(g);if(!b)return!1;let p=(I=>{let N=document.createElement("template");N.innerHTML=String(I||"");let O=!1;return N.content.querySelectorAll("img").forEach(U=>{let H=String(U.getAttribute("src")||"").trim();if(!/^(blob:|filesystem:)/i.test(H))return;O=!0;let X=String(U.getAttribute("alt")||"").trim()||"image",G=U.closest?.(".resizable-image")||U;try{G.replaceWith(document.createTextNode(`[${X} \u2014 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0438\u0437 \u0431\u0443\u0444\u0435\u0440\u0430 \u043E\u0431\u043C\u0435\u043D\u0430 (blob:) \u043D\u0435 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E]`))}catch{}}),{html:N.innerHTML,hadUnstable:O}})(b);p.hadUnstable&&Ee("\u041A\u0430\u0440\u0442\u0438\u043D\u043A\u0430 \u0431\u044B\u043B\u0430 \u0432\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u0430 \u043A\u0430\u043A blob: URL \u0438 \u043D\u0435 \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u0441\u044F \u043F\u043E\u0441\u043B\u0435 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438. \u0412\u0441\u0442\u0430\u0432\u044C\u0442\u0435 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u043A\u0430\u043A \u0444\u0430\u0439\u043B (\u043F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435/\u0432\u0441\u0442\u0430\u0432\u044C\u0442\u0435 \u0444\u0430\u0439\u043B \u0438\u043B\u0438 \u0441\u043A\u0440\u0438\u043D\u0448\u043E\u0442).");let f=Jl(p.html),w=a(f);if(!w)return!1;let x=Ii(f),A=Ii(w)||x;return c(Co(A)),vo(e),!0},u=g=>{let b=String(g||""),S=b.trim();if(/^https?:\/\/\S+$/i.test(S)){let A=Gt(S);return dr(e),Xn(e,`<a href="${A}" target="_blank" rel="noopener noreferrer">${A}</a>`),vo(e),!0}let f=b.replace(/\r\n/g,`
`).replace(/\r/g,`
`),w=Gt(f).replace(/\n{2,}/g,"<br /><br />").replace(/\n/g,"<br />"),x=Co(Ii(w));return c(x),vo(e),!0},h=(r.clipboardData?.getData("text/html")||"").trim();if(h&&l(h))return;try{let b=Array.from(r.clipboardData?.items||[]).find(S=>S&&S.kind==="string"&&S.type==="text/html");if(b&&typeof b.getAsString=="function"){b.getAsString(S=>{try{if(l(S))return}catch{}try{let p=r.clipboardData?.getData("text/plain")||"";u(p)}catch{}});return}}catch{}{let g=r.clipboardData?.getData("text/plain")||"";u(g)}}}),e.addEventListener("drop",r=>{if(d.mode!=="edit"||d.editingBlockId!==t){sn("drop ignored",{mode:d.mode,editingBlockId:d.editingBlockId,targetBlockId:t});return}let o=Array.from(r.dataTransfer?.files||[]);if(!o.length)return;let i=o.filter(a=>a.type?.startsWith("image/")),s=o.filter(a=>!a.type||!a.type.startsWith("image/"));!i.length&&!s.length||(r.preventDefault(),sn("drop: files detected",o.map(a=>({name:a.name,type:a.type,size:a.size}))),i.forEach(a=>Ei(e,a,t)),s.forEach(a=>aa(e,a,t)))}),e.addEventListener("click",r=>{let o=r.target?.closest("img");if(o){if(r.target?.closest(".resizable-image__handle")){r.preventDefault();return}r.preventDefault(),ho(o.src,o.alt||"");return}let i=r.target?.closest("a[href]");if(!i)return;let s=i.getAttribute("href")||"";if(!s.startsWith("app:/")&&!s.startsWith("disk:/"))return;r.preventDefault();let a=id(s);a&&window.open(a,"_blank","noopener,noreferrer")}),d.articleId==="inbox"&&e.addEventListener("click",async r=>{if(r.target?.closest(".move-block-btn")){r.preventDefault(),r.stopPropagation();try{let s=(d.articlesIndex.length?d.articlesIndex:await vn()).filter(u=>u.id!=="inbox").map(u=>({id:u.id,title:u.title||"\u0420\u2018\u0420\xB5\u0420\xB7 \u0420\u0405\u0420\xB0\u0420\xB7\u0420\u0406\u0420\xB0\u0420\u0405\u0420\u0451\u0421\u040F"})),a=await or({title:"\u0420\u045F\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451 \u0420\u0406 \u0421\u0403\u0421\u201A\u0420\xB0\u0421\u201A\u0421\u040A\u0421\u040B",message:"\u0420\u2019\u0420\u0406\u0420\xB5\u0420\u0491\u0420\u0451\u0421\u201A\u0420\xB5 ID \u0420\u0451\u0420\xBB\u0420\u0451 \u0420\u0406\u0421\u2039\u0420\xB1\u0420\xB5\u0421\u0402\u0420\u0451\u0421\u201A\u0420\xB5 \u0421\u0403\u0421\u201A\u0420\xB0\u0421\u201A\u0421\u040A\u0421\u040B",confirmText:"\u0420\u045F\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451",cancelText:"\u0420\u045B\u0421\u201A\u0420\u0458\u0420\xB5\u0420\u0405\u0420\xB0",suggestions:s,returnMeta:!0,hideConfirm:!1}),l=(a?.selectedId||(typeof a=="object"?a?.value:a)||""||"").trim();if(!l)return;await Tt(`/api/articles/${d.articleId}/blocks/${t}/move-to/${l}`,{method:"POST"}),wn(an.article("inbox"))}catch(i){Ee(i.message||"\u0420\u045C\u0420\xB5 \u0421\u0453\u0420\u0491\u0420\xB0\u0420\xBB\u0420\u0455\u0421\u0403\u0421\u040A \u0420\u0457\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451 \u0420\xB1\u0420\xBB\u0420\u0455\u0420\u0454")}}}),e.addEventListener("dragover",r=>{if(d.mode!=="edit"||d.editingBlockId!==t)return;(oa(r.dataTransfer?.items).length>0||ia(r.dataTransfer?.items).length>0)&&r.preventDefault()}),e.addEventListener("keydown",r=>{if(d.mode!=="edit"||d.editingBlockId!==t)return;let o=window.getSelection();if(!o||o.rangeCount===0)return;let i=o.getRangeAt(0);if(!i||!i.collapsed||jl({event:r,element:e,range:i,selection:o,notifyEditingInput:vo,logDebug:sn})||r.key!=="Tab"||!(i.commonAncestorContainer?.nodeType===Node.ELEMENT_NODE?i.commonAncestorContainer:i.commonAncestorContainer?.parentElement)?.closest?.("li"))return;r.preventDefault(),r.stopPropagation();let c=r.shiftKey?"outdent":"indent";document.execCommand(c,!1,null)})}function sd(){let e=window.getSelection();if(!e||e.rangeCount===0)return;let t=e.getRangeAt(0),n=t.commonAncestorContainer,o=(n?.nodeType===Node.ELEMENT_NODE?n:n?.parentElement)?.closest('.block-text[contenteditable="true"]');if(!o){Bo=null;return}let s=o.closest(".block")?.dataset?.blockId;if(d.mode!=="edit"||d.editingBlockId!==s){Bo=null;return}Bo=t.cloneRange()}function Lp(){if(sa)return sa;nd||(document.addEventListener("selectionchange",sd),nd=!0);let e=document.createElement("div");e.className="rich-context-menu hidden",e.innerHTML=`
	    <div class="rich-context-menu__col rich-context-menu__col--buffer">
	      <div class="rich-context-menu__grid">
	        <button class="rich-context-menu__icon-btn" data-action="copy" aria-label="\u041A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C" title="\u041A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C"><i class="bx bx-copy" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="cut" aria-label="\u0412\u044B\u0440\u0435\u0437\u0430\u0442\u044C" title="\u0412\u044B\u0440\u0435\u0437\u0430\u0442\u044C"><i class="bx bx-cut" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="paste" aria-label="\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C" title="\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C"><i class="bx bx-paste" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="select-all" aria-label="\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0432\u0441\u0451" title="\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0432\u0441\u0451"><i class="bx bx-select-multiple" aria-hidden="true"></i></button>
	      </div>
	    </div>
	    <div class="rich-context-menu__col">
	      <div class="rich-context-menu__grid">
	        <button class="rich-context-menu__icon-btn" data-action="bold" aria-label="\u041F\u043E\u043B\u0443\u0436\u0438\u0440\u043D\u044B\u0439" title="\u041F\u043E\u043B\u0443\u0436\u0438\u0440\u043D\u044B\u0439"><strong>\u0416</strong></button>
	        <button class="rich-context-menu__icon-btn" data-action="italic" aria-label="\u041A\u0443\u0440\u0441\u0438\u0432" title="\u041A\u0443\u0440\u0441\u0438\u0432"><em>/</em></button>
	        <button class="rich-context-menu__icon-btn" data-action="underline" aria-label="\u041F\u043E\u0434\u0447\u0435\u0440\u043A\u043D\u0443\u0442\u044C" title="\u041F\u043E\u0434\u0447\u0435\u0440\u043A\u043D\u0443\u0442\u044C"><u>\u0427</u></button>
	        <button class="rich-context-menu__icon-btn" data-action="remove-format" aria-label="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0444\u043E\u0440\u043C\u0430\u0442" title="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0444\u043E\u0440\u043C\u0430\u0442"><i class="bx bx-eraser" aria-hidden="true"></i></button>
	      </div>
	    </div>
	    <div class="rich-context-menu__col">
	      <div class="rich-context-menu__grid">
	        <button class="rich-context-menu__icon-btn" data-action="ul" aria-label="\u041C\u0430\u0440\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A" title="\u041C\u0430\u0440\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A"><i class="bx bx-list-ul" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="ol" aria-label="\u041D\u0443\u043C\u0435\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A" title="\u041D\u0443\u043C\u0435\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A"><i class="bx bx-list-ol" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="quote" aria-label="\u0426\u0438\u0442\u0430\u0442\u0430" title="\u0426\u0438\u0442\u0430\u0442\u0430"><i class="bx bx-quote-left" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="code" aria-label="\u041A\u043E\u0434" title="\u041A\u043E\u0434"><i class="bx bx-code-alt" aria-hidden="true"></i></button>
	      </div>
	    </div>
	    <div class="rich-context-menu__col">
	      <div class="rich-context-menu__grid">
	        <button class="rich-context-menu__icon-btn" data-action="link" aria-label="\u0421\u0441\u044B\u043B\u043A\u0430" title="\u0421\u0441\u044B\u043B\u043A\u0430"><i class="bx bx-link" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="unlink" aria-label="\u0423\u0431\u0440\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443" title="\u0423\u0431\u0440\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443"><i class="bx bx-unlink" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="insert-article-link" aria-label="\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E" title="\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E"><i class="bx bx-link-alt" aria-hidden="true"></i></button>
	      </div>
	    </div>
	    <div class="rich-context-menu__col">
	      <div class="rich-context-menu__grid">
	        <button class="rich-context-menu__icon-btn" data-action="split-at-caret" aria-label="\u0420\u0430\u0437\u0434\u0435\u043B\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043F\u043E \u043A\u0443\u0440\u0441\u043E\u0440\u0443" title="\u0420\u0430\u0437\u0434\u0435\u043B\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043F\u043E \u043A\u0443\u0440\u0441\u043E\u0440\u0443"><i class="bx bx-cut" aria-hidden="true"></i></button>
	      </div>
	    </div>
	  `,document.body.appendChild(e);let t=()=>{e.classList.add("hidden"),e.style.visibility="",$t=null,Yr=null,To=null},n=()=>{if($t){let o=window.getSelection();o.removeAllRanges(),o.addRange($t)}},r=async o=>{n();let i=()=>{if(Yr&&document.contains(Yr))return Yr;let g=window.getSelection()?.anchorNode?.parentElement?.closest(".block-text[contenteditable]");if(g)return g;if($t){let S=$t.commonAncestorContainer;if(S?.parentElement){let p=S.parentElement.closest(".block-text[contenteditable]");if(p)return p}}if(To&&document.contains(To))return To;if(d.editingBlockId){let S=document.querySelector(`.block[data-block-id="${d.editingBlockId}"] .block-text[contenteditable="true"]`);if(S)return S}let b=document.activeElement;if(b&&b.closest){let S=b.closest(".block-text[contenteditable]");if(S)return S}return null},s=u=>{ed({listTag:u,resolveTarget:i,restoreSelection:n,richContextRange:$t,notifyEditingInput:vo,setRichContextRange:h=>{$t=h?h.cloneRange():null}})},a=async()=>{let u=i();if(!u){Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0441\u0441\u044B\u043B\u043A\u0438");return}let h=d.articlesIndex.length?d.articlesIndex:await vn(),g=h.map(A=>({id:A.id,title:A.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),b="",S="";try{let A=await or({title:"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438. \u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0438 \u043F\u043E\u043C\u043E\u0433\u0443\u0442 \u043D\u0430\u0439\u0442\u0438 \u043D\u0443\u0436\u043D\u0443\u044E.",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:g,returnMeta:!0,hideConfirm:!0});A&&typeof A=="object"?(b=A.value||"",S=A.selectedId||""):b=A||""}catch{b=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438")||""}let p=(b||"").trim().toLowerCase();if(!p&&!S)return;let f=h.find(A=>{let I=(A.title||"").toLowerCase();return S&&A.id===S||A.id&&A.id.toLowerCase()===p||I===p||I.includes(p)});if(!f){Ee("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}if(!u||!document.contains(u)){Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0441\u0441\u044B\u043B\u043A\u0438");return}n(),u.focus();let w=`<a href="${an.article(f.id)}" class="article-link" data-article-id="${f.id}">${Gt(f.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F")}</a>`;Xn(u,w);let x=(u.innerHTML||"").trim();(!x||x==="<br>"||x==="<br/>"||x==="<br />")&&(u.innerHTML=w),u.classList.remove("block-body--empty")},c=()=>{n();let u=window.getSelection();if(!(!u||u.rangeCount===0)){document.execCommand("removeFormat");for(let h=0;h<4;h+=1)document.execCommand("outdent");document.execCommand("formatBlock",!1,"p")}},l=u=>{let h=i();if(!h||!document.contains(h))return Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u0442\u0435\u043A\u0441\u0442 \u0434\u043B\u044F \u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F"),null;let g=window.getSelection();if(!g||g.rangeCount===0)return null;let b=g.getRangeAt(0).cloneRange();if(!b||b.collapsed)return null;let S=b.cloneContents(),p=document.createElement("div");p.appendChild(S);let f=p.innerHTML||"",w=p.textContent||"",A=h.closest(".block")?.dataset.blockId||null;return Wr={html:f,text:w,sourceBlockId:A},sn("clipboard.capture",{kind:u,hasHtml:!!f,length:w.length,blockId:A}),{range:b,target:h}};switch(o){case"cut":{if(!l("cut"))break;document.execCommand("cut");break}case"copy":l("copy"),document.execCommand("copy");break;case"select-all":{let u=i();if(!u||!document.contains(u))break;let h=document.createRange();h.selectNodeContents(u);let g=window.getSelection();g&&(g.removeAllRanges(),g.addRange(h)),$t=h.cloneRange();break}case"paste":{let u=i();if(!u||!document.contains(u)){Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438");break}if(!Wr||!Wr.html&&!Wr.text){Ee("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0441\u043A\u043E\u043F\u0438\u0440\u0443\u0439\u0442\u0435 \u0438\u043B\u0438 \u0432\u044B\u0440\u0435\u0436\u044C\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u0432 \u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440\u0435");break}n();let h=window.getSelection(),g=null;if($t&&u.contains($t.commonAncestorContainer))g=$t.cloneRange();else if(h&&h.rangeCount>0){let f=h.getRangeAt(0);u.contains(f.commonAncestorContainer)&&(g=f.cloneRange())}g||(g=document.createRange(),g.selectNodeContents(u),g.collapse(!1));let b=Wr.html||Gt(Wr.text).replace(/\n/g,"<br />"),S=document.createElement("div");S.innerHTML=b;let p=document.createDocumentFragment();for(;S.firstChild;)p.appendChild(S.firstChild);g.deleteContents(),g.insertNode(p),g.collapse(!1),h&&(h.removeAllRanges(),h.addRange(g)),u.focus({preventScroll:!0}),u.classList.remove("block-body--empty");break}case"bold":document.execCommand("bold");break;case"italic":document.execCommand("italic");break;case"underline":document.execCommand("underline");break;case"ul":s("ul");break;case"ol":s("ol");break;case"quote":document.execCommand("formatBlock",!1,"blockquote");break;case"code":document.execCommand("formatBlock",!1,"pre");break;case"link":{let u=window.getSelection(),h=u?u.toString():"",g=u?.anchorNode,b=g?g.parentElement?.closest("a"):null,S=b?.getAttribute("href")||"",p=await ys({title:"\u0421\u0441\u044B\u043B\u043A\u0430",textLabel:"\u0422\u0435\u043A\u0441\u0442",urlLabel:"\u0421\u0441\u044B\u043B\u043A\u0430",defaultText:h||b?.textContent||"",defaultUrl:S,confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"});if(sn("link action: prompt result",{hasResult:!!p,url:p?.url,text:p?.text}),!p||!p.url)break;let f=p.url.match(/^[a-z]+:/i)?p.url:`https://${p.url}`,w=p.text?.trim()||f;n();let x=i();if(sn("link action: target",{targetExists:!!x,inDom:!!(x&&document.contains(x)),className:x?.className}),!x||!document.contains(x))break;let A=window.getSelection(),I=null;$t&&x.contains($t.commonAncestorContainer)?I=$t.cloneRange():A&&A.rangeCount>0&&x.contains(A.getRangeAt(0).commonAncestorContainer)&&(I=A.getRangeAt(0).cloneRange()),I||(I=document.createRange(),I.selectNodeContents(x),I.collapse(!1)),sn("link action: range chosen",{usedSelectionRange:!!(A&&A.rangeCount>0&&x.contains(A.getRangeAt(0).commonAncestorContainer)),usedStoredRange:!!($t&&x.contains($t.commonAncestorContainer)),selectionRangeCollapsed:!!(A&&A.rangeCount>0&&A.getRangeAt(0).collapsed),rangeStartNode:I?.startContainer?.nodeName,rangeOffset:I?.startOffset,labelLength:(w||"").length,url:f});let N=document.createElement("a");N.href=f,N.target="_blank",N.rel="noopener noreferrer",N.textContent=w,I.deleteContents(),I.insertNode(N),I.setStartAfter(N),I.setEndAfter(N),sn("link action: inserted link",{outerHTML:N.outerHTML,parentClass:N.parentElement?.className,targetInner:x.innerHTML.slice(0,120)}),A&&(A.removeAllRanges(),A.addRange(I)),x.focus({preventScroll:!0}),x.classList.remove("block-body--empty");break}case"unlink":{let u=i();if(sn("unlink action: target",{targetExists:!!u,inDom:!!(u&&document.contains(u)),className:u?.className}),!u||!document.contains(u))break;let h=window.getSelection(),g=null;if(h&&h.rangeCount>0){let b=h.getRangeAt(0).commonAncestorContainer;g=b?.parentElement?.closest("a")||b?.closest?.("a")}if(!g&&$t){let b=$t.commonAncestorContainer;g=b?.parentElement?.closest("a")||b?.closest?.("a")}if(g||(g=u.querySelector("a")),g){let b=document.createTextNode(g.textContent||"");g.replaceWith(b)}else document.execCommand("unlink");break}case"remove-format":c();break;case"insert-article-link":a().finally(()=>{t()});return;case"split-at-caret":await wl();break;default:break}t()};return e.addEventListener("click",o=>{let i=o.target.closest("button[data-action]");if(!i)return;let s=i.dataset.action;r(s)}),document.addEventListener("click",o=>{e.classList.contains("hidden")||e.contains(o.target)||t()}),document.addEventListener("touchstart",o=>{e.classList.contains("hidden")||e.contains(o.target)||t()},{passive:!0}),document.addEventListener("keydown",o=>{o.code==="Escape"&&t()}),window.addEventListener("scroll",t,!0),sa=e,e}function rd(e){let t=Lp();t.classList.remove("hidden"),t.style.visibility="hidden",sd();let n=window.getSelection();n&&n.rangeCount>0?$t=n.getRangeAt(0).cloneRange():Bo?$t=Bo.cloneRange():$t=null;let r=t.getBoundingClientRect(),o=22,i=12,s=e.clientX+14,a=e.clientY+o;a+r.height+i>window.innerHeight&&(a=Math.max(i,e.clientY-r.height-o));let c=Math.min(Math.max(s,i),window.innerWidth-r.width-i),l=Math.min(Math.max(a,i),window.innerHeight-r.height-i);t.style.left=`${c}px`,t.style.top=`${l}px`,t.style.visibility="visible"}function od(e,t,n){let r=n||e;e.addEventListener("focusin",()=>{To=r}),e.addEventListener("contextmenu",s=>{d.mode!=="edit"||d.editingBlockId!==t||(s.preventDefault(),Yr=r,rd(s))});let o=null;e.addEventListener("touchstart",s=>{if(d.mode!=="edit"||d.editingBlockId!==t||s.touches.length!==1)return;let a=s.touches[0];o=window.setTimeout(()=>{Yr=r,rd({clientX:a.clientX,clientY:a.clientY})},500)},{passive:!0});let i=()=>{o!==null&&(clearTimeout(o),o=null)};e.addEventListener("touchend",i,{passive:!0}),e.addEventListener("touchcancel",i,{passive:!0})}async function Hs(e){if(!e)return;let t=At(e);if(!t)return;let n=(t.ancestors||[]).filter(r=>r.collapsed);for(let r of n)await Ci(r.id,!1)}var Ep,sa,$t,Yr,To,Wr,Bo,nd,$n=Xe(()=>{Pt();un();rn();xr();Rn();ir();un();sr();sr();zs();Vl();na();Yl();ra();Zl();td();Ep=16;sa=null,$t=null,Yr=null,To=null,Wr={html:"",text:"",sourceBlockId:null},Bo=null,nd=!1;Ql()});function Pp(){let e=d?.currentUser||null;return e&&(e.id||e.username)||"anon"}async function vi(){return zo({userKey:Pp()})}async function ad(e={}){let t=String(e?.token||"").trim(),n=String(e?.articleId||"").trim();if(!t||!n)return!1;let r=String(e?.kind||"image"),o=e?.blob||null,i=String(e?.mime||o&&o.type||"").trim(),s=String(e?.fileName||"").trim()||null,a=Date.now(),l=(await vi()).transaction(["pending_uploads"],"readwrite"),u=l.objectStore("pending_uploads"),h=await He(u.get(t)).catch(()=>null),g=Number(h?.createdAtMs||e?.createdAtMs||a)||a,b={token:t,articleId:n,kind:r,blob:o,mime:i,fileName:s,status:String(e?.status||h?.status||"pending"),errorMessage:String(e?.errorMessage||h?.errorMessage||""),createdAtMs:g,updatedAtMs:a};return await He(u.put(b)),await Ze(l),!0}async function ca(e){let t=String(e||"").trim();if(!t)return!1;let r=(await vi()).transaction(["pending_uploads"],"readwrite"),o=r.objectStore("pending_uploads");return await He(o.delete(t)),await Ze(r),!0}async function la(e,t){let n=String(e||"").trim();if(!n)return!1;let o=(await vi()).transaction(["pending_uploads"],"readwrite"),i=o.objectStore("pending_uploads"),s=await He(i.get(n)).catch(()=>null);return s?(s.status="error",s.errorMessage=String(t||"error"),s.updatedAtMs=Date.now(),await He(i.put(s)),await Ze(o),!0):(await Ze(o),!1)}async function da({articleId:e=null,limit:t=50}={}){let r=(await vi()).transaction(["pending_uploads"],"readonly"),o=r.objectStore("pending_uploads"),i=[];try{let s=Number(t||0)||0;if(e){let a=o.index("byArticleId");i=await He(a.getAll(String(e),s>0?s:void 0))}else i=await He(o.getAll(s>0?s:void 0))}catch{i=[]}return await Ze(r),Array.isArray(i)?(i.sort((s,a)=>Number(s?.createdAtMs||0)-Number(a?.createdAtMs||0)),i):[]}var cd=Xe(()=>{Pt();Zi();Bn()});var Ti,ld=Xe(()=>{Ti=["pending-attachment","app","disk"]});function ua(e){let n=String(e||"").replace(/\r\n/g,`
`).split(`
`),r=c=>{let l=String(c||"").match(/^(#{1,6})\s+(.*)$/);if(!l)return null;let u=String(l[2]||"").trim();return u?{level:l[1].length,title:u}:null},o=!1;try{let c=n.find(l=>String(l||"").trim().length>0)||"";o=!!r(c)}catch{o=!1}let i=[],s=null,a=()=>{if(s){try{for(;s.bodyLines.length&&!String(s.bodyLines[0]||"").trim();)s.bodyLines.shift()}catch{}s.bodyText=s.bodyLines.join(`
`).trimEnd(),delete s.bodyLines,i.push(s),s=null}};for(let c of n){let l=r(c);if(l){a(),s={level:l.level,title:l.title,bodyLines:[]};continue}s&&s.bodyLines.push(c)}return a(),{sections:i,startsWithHeading:o,headingCount:i.length}}function dd(e,t={}){let n=Array.isArray(e)?e.filter(Boolean):[],r=typeof t.makeId=="function"?t.makeId:()=>`${Date.now()}-${Math.random()}`;if(!n.length)return[];let o=Number.isFinite(t.baseLevel)?t.baseLevel:Number(n[0].level||1),i=[],s=[];for(let a of n){let c=Number(a.level||1),l=String(a.title||"").trim(),u=String(a.bodyText||"").trimEnd();if(!l)continue;let h=Math.max(0,c-o);for(;s.length>h;)s.pop();h>s.length&&(h=s.length);let g={id:r(),title:l,bodyText:u,children:[]},b=h>0?s[h-1]:null;b?b.children.push(g):i.push(g),s.push(g)}return i}var ud=Xe(()=>{});var ga={};$o(ga,{flushOutboxOnce:()=>Gr,getBackgroundFullPullStatus:()=>Kp,startBackgroundFullPull:()=>Zp,startSyncLoop:()=>Qp,tryPullBootstrap:()=>jp});function _p(e,t=null){try{if(!e)return;let n=window.localStorage.getItem(Bi)||"";if(!n)return;let r=JSON.parse(n);if(!r||typeof r!="object")return;let o=String(e),i=r[o]||null;if(!i)return;let s=Number(i?.queuedAt||0)||0,a=typeof t=="number"&&Number.isFinite(t)?t:null;if(a!=null&&s>a)return;delete r[o],window.localStorage.setItem(Bi,JSON.stringify(r))}catch{}}function Rp(e,t){try{let n=e&&typeof e=="object"?e:{type:"doc",content:[]},r=Array.isArray(n.content)?n.content:[],o=new Map,i=u=>{if(Array.isArray(u))for(let h of u){if(!h||typeof h!="object"||h.type!=="outlineSection")continue;let g=String(h?.attrs?.id||"").trim();g&&o.set(g,h);let S=(Array.isArray(h.content)?h.content:[]).find(p=>p&&typeof p=="object"&&p.type==="outlineChildren")||null;S&&Array.isArray(S.content)&&i(S.content)}};i(r);let s=(u,h)=>{let g=u&&typeof u=="object"?u:{type:"outlineSection",attrs:{id:h,collapsed:!1},content:[]};g.type="outlineSection";let b=g.attrs&&typeof g.attrs=="object"?g.attrs:{};b.id=h,g.attrs=b;let S=Array.isArray(g.content)?g.content:[],p=S.find(x=>x&&typeof x=="object"&&x.type==="outlineHeading")||{type:"outlineHeading",content:[]},f=S.find(x=>x&&typeof x=="object"&&x.type==="outlineBody")||{type:"outlineBody",content:[{type:"paragraph"}]},w=S.find(x=>x&&typeof x=="object"&&x.type==="outlineChildren")||{type:"outlineChildren",content:[]};return Array.isArray(w.content)||(w={...w,content:[]}),g.content=[p,f,w],g},a=new Set,c=new Map;for(let u of Array.isArray(t)?t:[]){let h=String(u?.sectionId||"").trim();if(!h)continue;let g=u?.parentId,b=g!=null&&String(g).trim()?String(g).trim():null,S=Number.isFinite(Number(u?.position))?Number(u.position):0,p=!!u?.collapsed,f=s(o.get(h),h);f.attrs={...f.attrs||{},id:h,collapsed:p},o.set(h,f),a.add(h),c.has(b)||c.set(b,[]),c.get(b).push({pos:S,sid:h,sec:f})}for(let[u,h]of c.entries())h.sort((g,b)=>g.pos-b.pos||String(g.sid).localeCompare(String(b.sid))),c.set(u,h);for(let[u,h]of o.entries()){let b=(c.get(u)||[]).map(S=>S.sec);try{Array.isArray(h.content)||(h.content=[]),(!h.content[2]||h.content[2].type!=="outlineChildren")&&(h.content[2]={type:"outlineChildren",content:[]}),h.content[2].content=b}catch{}}let l=(c.get(null)||[]).map(u=>u.sec);for(let[u,h]of o.entries())a.has(u)||l.push(h);return n.type="doc",n.content=l,n}catch{return e}}function Hp(e,t,n,r){try{let o=String(t||"").trim();if(!o)return e;let i=e&&typeof e=="object"?e:{type:"doc",content:[]},s=[i];for(;s.length;){let a=s.pop();if(!a||typeof a!="object")continue;if(a.type==="outlineSection"&&String(a?.attrs?.id||"").trim()===o){let u=(Array.isArray(a.content)?a.content:[]).find(h=>h&&typeof h=="object"&&h.type==="outlineChildren")||{type:"outlineChildren",content:[]};return a.content=[n,r,u],i}let c=a.content;if(Array.isArray(c))for(let l of c)s.push(l)}return i}catch{return e}}function ha(e){let t=e?.type||"";return t==="section_upsert_content"||t==="delete_sections"||t==="structure_snapshot"}function $p(e,t,n){try{let r=String(e||"").trim(),o=String(t||"").trim(),i=Number(n);if(!r||!o||!Number.isFinite(i)||i<=0)return;let s="ttree_outline_section_seq_v1",a=window.localStorage.getItem(s)||"",c=a?JSON.parse(a):{},l=c&&typeof c=="object"?c:{},u=(l[r]&&typeof l[r]=="object"?l[r]:{})||{};if((Number(u[o]||0)||0)>=i)return;u[o]=i,l[r]=u,window.localStorage.setItem(s,JSON.stringify(l))}catch{}}function Fp(e){let t=[],n=(i,s)=>{if(!Array.isArray(i))return;let a=0;for(let c of i){if(!c||typeof c!="object"||c.type!=="outlineSection")continue;let l=String(c?.attrs?.id||"").trim();if(!l)continue;t.push({sectionId:l,parentId:s||null,position:a,collapsed:!!c?.attrs?.collapsed}),a+=1;let h=(Array.isArray(c.content)?c.content:[]).find(b=>b&&typeof b=="object"&&b.type==="outlineChildren")||null,g=h&&Array.isArray(h.content)?h.content:[];n(g,l)}},r=e&&typeof e=="object"?e:null,o=r&&Array.isArray(r.content)?r.content:[];return n(o,null),t}function zp(e,t){try{let n=e&&typeof e=="object"?{...e}:null;if(!n||n.type!=="outlineHeading")return e;let r=String(t||"");if(!r)return e;let o=Array.isArray(n.content)?[...n.content]:[];return o.unshift({type:"text",text:r}),n.content=o,n}catch{return e}}function Up(e,t,n){let r=e&&typeof e=="object"?e:{type:"doc",content:[]};Array.isArray(r.content)||(r.content=[]);let o=String(t||"").trim(),i=a=>{for(let c=0;c<a.length;c+=1){let l=a[c];if(!l||typeof l!="object"||l.type!=="outlineSection")continue;let u=String(l?.attrs?.id||"").trim();if(o&&u===o)return a.splice(c+1,0,n),!0;let g=(Array.isArray(l.content)?l.content:[]).find(b=>b&&typeof b=="object"&&b.type==="outlineChildren")||null;if(g&&Array.isArray(g.content)&&i(g.content))return!0}return!1};return i(r.content)||r.content.push(n),r}function qp(){try{return window?.localStorage?.getItem?.("ttree_debug_offline_v1")==="1"}catch{return!1}}function gd(...e){try{if(!qp())return;console.log("[offline][queue]",...e)}catch{}}function bd(){try{let e=window.localStorage.getItem(Bi)||"";if(!e)return{changed:!1,removed:0};let t=JSON.parse(e);if(!t||typeof t!="object")return{changed:!1,removed:0};let n=Object.keys(t);if(!n.length)return{changed:!1,removed:0};let r=0;for(let o of n)o!=="inbox"&&(delete t[o],r+=1);return r?(window.localStorage.setItem(Bi,JSON.stringify(t)),gd("prune.queue",{removed:r}),{changed:!0,removed:r}):{changed:!1,removed:0}}catch(e){return gd("prune.queue.error",{message:e?.message||String(e||"error")}),{changed:!1,removed:0}}}function fr(){try{window.dispatchEvent(new CustomEvent("offline-full-pull-status",{detail:{...Dt}}))}catch{}}function Kp(){return{...Dt}}async function mn(e,t={}){let n=await fetch(e,{headers:{"Content-Type":"application/json",...t.headers||{}},credentials:"include",...t});if(!n.ok){let r=await n.json().catch(()=>({})),o=new Error(r.detail||"Request failed");throw o.status=n.status,o.details=r,o.path=e,o}return n.status===204?null:n.json()}function yd(e){let t=Number(e?.status||0);return!t||t>=500||t===408||t===429||t===401||t===403}function Vp(e,t){let n=Number(e?.status||0);return n===404||n===410?!0:n>=400&&n<500&&n!==401&&n!==403&&n!==408&&n!==429?t?.type==="save_doc_json"||String(t?.type||"").startsWith("section_")||t?.type==="structure_snapshot"||t?.type==="delete_sections":!1}async function jp(){try{let e=await vn();return Kn(e).catch(()=>{}),Array.isArray(e)?e:[]}catch{return null}}function Jp(e,t){try{let n=new Set((Array.isArray(t)?t:[]).map(i=>String(i||"").trim()).filter(Boolean));if(!n.size)return e;let r=e&&typeof e=="object"?e:{type:"doc",content:[]},o=i=>{if(!Array.isArray(i))return[];let s=[];for(let a of i)if(!(!a||typeof a!="object")){if(a.type==="outlineSection"){let c=String(a?.attrs?.id||"").trim();if(c&&n.has(c))continue;let u=(Array.isArray(a.content)?a.content:[]).find(h=>h&&typeof h=="object"&&h.type==="outlineChildren")||null;u&&Array.isArray(u.content)&&(u.content=o(u.content))}s.push(a)}return s};return Array.isArray(r.content)?r.content=o(r.content):r.content=[],r.type=r.type||"doc",r}catch{return e}}async function Wp(e){if(e.type==="create_article"){let t=e.payload?.title||"\u041D\u043E\u0432\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F",n=e.payload?.id||e.articleId,r=e.payload?.parentId??null,o=await mn("/api/articles",{method:"POST",body:JSON.stringify({title:t,id:n,parentId:r})});await Fr(o);return}if(e.type==="save_doc_json"){let t=e.payload?.docJson||null;if(!t||typeof t!="object")return;let n=await mn(`/api/articles/${encodeURIComponent(e.articleId)}/doc-json/save`,{method:"PUT",body:JSON.stringify({docJson:t,createVersionIfStaleHours:12})}),r=n?.updatedAt||null;await bn(e.articleId,t,r);try{pt("sync.flush.save_doc_json.ok",{articleId:e.articleId,opId:e.id,updatedAt:r,docHash:Ht(t)})}catch{}try{let o=Array.isArray(n?.changedBlockIds)?n.changedBlockIds:[],i=Array.isArray(n?.removedBlockIds)?n.removedBlockIds:[];if(i.length&&await Go(i),o.length){let s=await mn(`/api/articles/${encodeURIComponent(e.articleId)}/embeddings?ids=${encodeURIComponent(o.join(","))}`);await us(e.articleId,s?.embeddings||[])}}catch{}return}if(e.type==="section_upsert_content"){let t=e.payload?.sectionId||null,n=e.payload?.headingJson||null,r=e.payload?.bodyJson||null,o=e.payload?.seq||null;if(!t||!n||!r||!o)return;let i=await mn(`/api/articles/${encodeURIComponent(e.articleId)}/sections/upsert-content`,{method:"PUT",body:JSON.stringify({opId:e.payload?.opId||e.id,sectionId:t,headingJson:n,bodyJson:r,seq:o,createVersionIfStaleHours:12})});try{if(i?.updatedAt){let s=await Gn(e.articleId).catch(()=>null),a=s?.docJson&&typeof s.docJson=="object"?s.docJson:null;if(a){let c=Hp(a,t,n,r);await bn(e.articleId,c,i.updatedAt)}}try{pt("sync.flush.section_upsert_content.ok",{articleId:e.articleId,opId:e.id,sectionId:t,updatedAt:i?.updatedAt||null})}catch{}}catch{}return}if(e.type==="structure_snapshot"){let t=e.payload?.nodes||null;if(!Array.isArray(t)||!t.length)return;let n=await mn(`/api/articles/${encodeURIComponent(e.articleId)}/structure/snapshot`,{method:"PUT",body:JSON.stringify({opId:e.payload?.opId||e.id,nodes:t})});try{if(n?.updatedAt){let r=await Gn(e.articleId).catch(()=>null),o=r?.docJson&&typeof r.docJson=="object"?r.docJson:null;if(o){let i=Rp(o,t);await bn(e.articleId,i,n.updatedAt)}}try{pt("sync.flush.structure_snapshot.ok",{articleId:e.articleId,opId:e.id,updatedAt:n?.updatedAt||null,nodesCount:Array.isArray(t)?t.length:null})}catch{}}catch{}return}if(e.type==="delete_sections"){let t=Array.isArray(e.payload?.sectionIds)?e.payload.sectionIds:[];if(!t.length)return;let n=await Nc(e.articleId,t,{opId:e.payload?.opId||e.id});try{let r=n?.updatedAt||null,o=await Gn(e.articleId).catch(()=>null),i=o?.docJson&&typeof o.docJson=="object"?o.docJson:null;if(i&&r){let a=Jp(i,t);await bn(e.articleId,a,r)}let s=Array.isArray(n?.removedBlockIds)?n.removedBlockIds:[];s.length&&await Go(s),pt("sync.flush.delete_sections.ok",{articleId:e.articleId,opId:e.id,updatedAt:r||null,sectionIdsCount:t.length,removedCount:s.length})}catch{}return}if(e.type==="move_article_position"){let t=e.payload?.direction||null;if(!t)return;await mn(`/api/articles/${encodeURIComponent(e.articleId)}/move`,{method:"POST",body:JSON.stringify({direction:t})});return}if(e.type==="indent_article"){await mn(`/api/articles/${encodeURIComponent(e.articleId)}/indent`,{method:"POST",body:JSON.stringify({})});return}if(e.type==="outdent_article"){await mn(`/api/articles/${encodeURIComponent(e.articleId)}/outdent`,{method:"POST",body:JSON.stringify({})});return}if(e.type==="move_article_tree"){await mn(`/api/articles/${encodeURIComponent(e.articleId)}/move-tree`,{method:"POST",body:JSON.stringify(e.payload||{})});return}}async function Yp(e){try{if(!e||!e.articleId||!(e.type==="save_doc_json"||e.type==="section_upsert_content"||e.type==="structure_snapshot"||e.type==="delete_sections"))return;let n=e.payload?.clientQueuedAt??null;if(typeof n!="number"||!Number.isFinite(n)||(await wr(500)||[]).some(i=>i&&i.articleId===e.articleId&&(i.type==="save_doc_json"||i.type==="section_upsert_content"||i.type==="structure_snapshot")&&(i.payload?.clientQueuedAt??null)===n))return;_p(e.articleId,n)}catch{}}async function Gp(e,t){let n=String(e||"").trim();if(n)for(let r of t||[])try{let o=String(r?.sectionId||"").trim(),i=r?.headingJson||null,s=r?.bodyJson||null;if(!o||!i||!s)continue;let a=globalThis.crypto?.randomUUID?.()||`conflict-${Date.now()}-${Math.random().toString(16).slice(2)}`,c=await Gn(n).catch(()=>null),l=c?.docJson&&typeof c.docJson=="object"?c.docJson:null,u=zp(i,"\u041A\u043E\u043D\u0444\u043B\u0438\u043A\u0442\u043D\u0430\u044F \u043A\u043E\u043F\u0438\u044F: "),g=Up(l||{type:"doc",content:[]},o,{type:"outlineSection",attrs:{id:a,collapsed:!1,isConflictCopy:!0},content:[u||{type:"outlineHeading",content:[]},s||{type:"outlineBody",content:[{type:"paragraph"}]},{type:"outlineChildren",content:[]}]});await bn(n,g,c?.updatedAt||null).catch(()=>{}),$p(n,a,1);let b=Date.now();await on("section_upsert_content",{articleId:n,payload:{sectionId:a,headingJson:u,bodyJson:s,seq:1,clientQueuedAt:b},coalesceKey:`content:${n}:${a}`}).catch(()=>{});let S=Fp(g);S.length&&await on("structure_snapshot",{articleId:n,payload:{nodes:S,clientQueuedAt:b},coalesceKey:`structure:${n}`}).catch(()=>{});try{window.dispatchEvent(new CustomEvent("outline-sync-conflict",{detail:{articleId:n,sectionId:o,conflictCopySectionId:a}}))}catch{}}catch{}}async function Xp(e,t){let n=String(e||"").trim();if(!n)return;let r=Date.now(),o=Number(md.get(n)||0)||0;if(o&&r-o<Dp)return;md.set(n,r);let i=async()=>{let p=await wr(200),f=[],w=[],x=[];for(let A of p||[])!A||String(A.articleId||"")!==n||(A.type==="delete_sections"?f.push(A):A.type==="section_upsert_content"?w.push(A):A.type==="structure_snapshot"&&x.push(A));return{deleteOps:f,upsertOps:w,structureOps:x}},s=0,a=[],c=[],l=[];try{({deleteOps:a,upsertOps:c,structureOps:l}=await i())}catch{a=[],c=[],l=[];for(let p of t||[])!p||String(p.articleId||"")!==n||(p.type==="delete_sections"?a.push(p):p.type==="section_upsert_content"?c.push(p):p.type==="structure_snapshot"&&l.push(p))}let u=new Set;for(let p of a){let f=Array.isArray(p.payload?.sectionIds)?p.payload.sectionIds:[];for(let w of f){let x=String(w||"").trim();x&&u.add(x)}}if(u.size&&c.length)for(let p of c)try{let f=String(p.payload?.sectionId||"").trim();f&&u.has(f)&&await rr(p.id)}catch{}let h=a.map(p=>{let f=Array.isArray(p.payload?.sectionIds)?p.payload.sectionIds:[];return{opId:p.payload?.opId||p.id,sectionIds:f.filter(Boolean).map(w=>String(w)),_outboxId:p.id}}).filter(p=>p.sectionIds.length),g=c.map(p=>{let f=String(p.payload?.sectionId||"").trim();return!f||u.has(f)?null:{opId:p.payload?.opId||p.id,sectionId:f,headingJson:p.payload?.headingJson||null,bodyJson:p.payload?.bodyJson||null,seq:p.payload?.seq||null,clientQueuedAt:p.payload?.clientQueuedAt??null,_outboxId:p.id}}).filter(Boolean),b=async()=>{let p=a.map(U=>{let H=Array.isArray(U.payload?.sectionIds)?U.payload.sectionIds:[];return{opId:U.payload?.opId||U.id,sectionIds:H.filter(Boolean).map(X=>String(X)),_outboxId:U.id}}).filter(U=>U.sectionIds.length),f=c.map(U=>{let H=String(U.payload?.sectionId||"").trim();return!H||u.has(H)?null:{opId:U.payload?.opId||U.id,sectionId:H,headingJson:U.payload?.headingJson||null,bodyJson:U.payload?.bodyJson||null,seq:U.payload?.seq||null,clientQueuedAt:U.payload?.clientQueuedAt??null,_outboxId:U.id}}).filter(Boolean),w=new Map;for(let U of p)w.set(String(U.opId),U._outboxId);for(let U of f)w.set(String(U.opId),U._outboxId);if(!p.length&&!f.length)return!1;try{pt("sync.flush.outline_compact.start",{articleId:n,deletesCount:p.length,upsertsCount:f.length})}catch{}let x=await mn(`/api/articles/${encodeURIComponent(n)}/sync/compact`,{method:"PUT",body:JSON.stringify({deletes:p.map(({opId:U,sectionIds:H})=>({opId:U,sectionIds:H})),upserts:f.map(({opId:U,sectionId:H,headingJson:X,bodyJson:G,seq:oe})=>({opId:U,sectionId:H,headingJson:X,bodyJson:G,seq:oe}))})}),A=x?.updatedAt||null;A&&await ls(n,A).catch(()=>{});try{pt("sync.flush.outline_compact.ok",{articleId:n,updatedAt:A||null,deleteAcks:Array.isArray(x?.deleteAcks)?x.deleteAcks.length:null,upsertAcks:Array.isArray(x?.upsertAcks)?x.upsertAcks.length:null})}catch{}let I=Array.isArray(x?.deleteAcks)?x.deleteAcks:[];for(let U of I){let H=String(U?.opId||"").trim();if(!H)continue;let X=w.get(H)||H;await rr(X).catch(()=>{});try{let G=Array.isArray(U?.removedBlockIds)?U.removedBlockIds:[];G.length&&await Go(G)}catch{}}let N=[],O=Array.isArray(x?.upsertAcks)?x.upsertAcks:[];for(let U of O){let H=String(U?.opId||"").trim(),X=String(U?.sectionId||"").trim();if(!H||!X)continue;let G=w.get(H)||H,oe=String(U?.result||"").trim();if(oe==="ok"||oe==="duplicate")await rr(G).catch(()=>{});else if(oe==="conflict"){await rr(G).catch(()=>{});let xe=f.find(ve=>String(ve.opId)===H)||null;xe&&N.push({sectionId:X,headingJson:xe.headingJson,bodyJson:xe.bodyJson})}}return N.length&&await Gp(n,N),!0};for(;s<2&&(s+=1,!!await b());)try{({deleteOps:a,upsertOps:c,structureOps:l}=await i())}catch{break}let S=null;try{({deleteOps:a,upsertOps:c,structureOps:l}=await i())}catch{}if(!a.length&&!c.length&&(S=l.length?l[l.length-1]:null),S){try{let f=Number(hd.get(n)||0)||0,w=Date.now();if(f&&w-f<Op)return}catch{}let p=S.payload?.nodes||null;if(Array.isArray(p)&&p.length){try{pt("sync.flush.structure_snapshot.start",{articleId:n,opId:S.id,nodesCount:p.length})}catch{}let f=await mn(`/api/articles/${encodeURIComponent(n)}/structure/snapshot`,{method:"PUT",body:JSON.stringify({opId:S.payload?.opId||S.id,nodes:p})}),w=f?.updatedAt||null;w&&await ls(n,w).catch(()=>{}),Number.isFinite(Number(f?.newStructureRev))?await ds(n,Number(f.newStructureRev)):Number.isFinite(Number(f?.currentStructureRev))&&await ds(n,Number(f.currentStructureRev));try{pt("sync.flush.structure_snapshot.done",{articleId:n,opId:S.id,status:String(f?.status||""),updatedAt:w||null,newStructureRev:Number.isFinite(Number(f?.newStructureRev))?Number(f.newStructureRev):null,currentStructureRev:Number.isFinite(Number(f?.currentStructureRev))?Number(f.currentStructureRev):null})}catch{}let x=String(f?.status||"");if(x==="ok"||x==="duplicate"){await rr(S.id).catch(()=>{});try{hd.set(n,Date.now())}catch{}}}}try{(await wr(200)||[]).some(w=>ha(w)&&String(w.articleId||"")===n)||(await yc(n).catch(()=>{}),pt("sync.flush.localDraft.cleared",{articleId:n}))}catch{}}async function Gr(){if(fa)return null;if(!navigator.onLine)return!1;fa=!0;try{let e=await wr(200),t=new Set,n=[];for(let o of e||[]){if(!ha(o))continue;let i=String(o.articleId||"").trim();!i||t.has(i)||(t.add(i),n.push(i))}for(let o of n)try{await Xp(o,e)}catch(i){if(yd(i))break}let r=await wr(50);for(let o of r)if(!ha(o))try{await Wp(o),await rr(o.id);try{if(o.type==="section_upsert_content"&&String(o.articleId||"")==="inbox"){let i=String(o.payload?.sectionId||"").trim();i&&$l(i)}}catch{}await Yp(o)}catch(i){let s=Number(i?.status||0)||null,a=s?`${s}: ${i?.message||"error"}`:i?.message||String(i||"error");if(await lc(o.id,a),Vp(i,o)){try{console.warn("[offline][outbox] drop op",{opId:o.id,type:o.type,articleId:o.articleId,status:s,message:i?.message||null})}catch{}try{await rr(o.id)}catch{}continue}if(yd(i))break;break}}finally{fa=!1}try{let e=await wr(1);return Array.isArray(e)&&e.length>0}catch{return!0}}function No(){Er||(Er=window.setInterval(async()=>{try{await Gr()===!1&&(window.clearInterval(Er),Er=null,bd())}catch{}},15e3))}function ma(){Er&&(window.clearInterval(Er),Er=null)}function Qp(){if(!fd){fd=!0,bd();try{ic()}catch{}window.addEventListener("online",()=>{Gr().then(e=>{e?No():ma()}).catch(()=>{})}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&Gr().then(e=>{e?No():ma()}).catch(()=>{})}),window.addEventListener("offline-outbox-changed",()=>{Gr().then(e=>{e?No():ma()}).catch(()=>{No()})}),Gr().then(e=>{e&&No()}).catch(()=>{})}}function Zp(e={}){let t=!!(e&&e.force);pa||pd&&!t||(pd=!0,pa=!0,Dt={running:!0,processed:0,total:0,errors:0,phase:"index",lastError:null,startedAt:new Date().toISOString(),finishedAt:null},fr(),(async()=>{try{if(!navigator.onLine){Dt={...Dt,running:!1,phase:"error",lastError:"offline",finishedAt:new Date().toISOString()},fr();return}let n=new Map;try{let o=await hc();n=new Map((o||[]).map(i=>[i.id,i]))}catch{}let r=[];try{Array.isArray(e?.initialIndex)?r=e.initialIndex:r=await mn("/api/articles")||[],Kn(r).catch(()=>{})}catch(o){Dt={...Dt,running:!1,phase:"error",lastError:o?.message||String(o||"error"),finishedAt:new Date().toISOString()},fr();return}Dt={...Dt,phase:"articles",total:Array.isArray(r)?r.length:0},fr();for(let o of r||[]){try{let i=o.updatedAt||null,s=n.get(o.id);if(i&&s?.updatedAt===i&&s?.hasDocJson){try{let c=await Gn(o.id),l=c?.docJson&&typeof c.docJson=="object"?c.docJson:null;l&&Rr(o.id,l).catch(()=>{})}catch{}continue}let a=await mn(`/api/articles/${encodeURIComponent(o.id)}`);await Fr(a);try{let c=await mn(`/api/articles/${encodeURIComponent(o.id)}/embeddings`);await us(o.id,c?.embeddings||[])}catch{}}catch{Dt={...Dt,errors:Number(Dt.errors||0)+1}}Dt={...Dt,processed:Number(Dt.processed||0)+1},fr(),await new Promise(i=>setTimeout(i,120))}try{Dt={...Dt,phase:"inbox"},fr();let o=await mn("/api/articles/inbox?include_history=0");await Fr(o)}catch{Dt={...Dt,errors:Number(Dt.errors||0)+1},fr()}sc().catch(()=>{}),Dt={...Dt,running:!1,phase:"done",finishedAt:new Date().toISOString()},fr()}finally{pa=!1}})().catch(()=>{}))}var Bi,fd,fa,pd,pa,Er,Dp,md,Op,hd,Dt,ya=Xe(()=>{zr();Hr();fs();os();un();ea();lo();Bi="ttree_outline_autosave_queue_docjson_v1";fd=!1,fa=!1,pd=!1,pa=!1,Er=null,Dp=2e3,md=new Map,Op=3e3,hd=new Map;Dt={running:!1,processed:0,total:0,errors:0,phase:"idle",lastError:null,startedAt:null,finishedAt:null}});var mi={};$o(mi,{closeOutlineEditor:()=>cu,enterOutlineSectionEditMode:()=>sh,flushOutlineAutosave:()=>dh,getOutlineActiveSectionId:()=>Zm,getOutlineActiveSectionSnapshot:()=>eh,insertNewOutlineSectionAtEnd:()=>ih,insertNewOutlineSectionAtStart:()=>ah,insertOutlineSectionFromPlainTextAtStart:()=>ch,insertOutlineSectionFromSectionFragmentsAtEnd:()=>oh,openOutlineEditor:()=>lh,openPublicOutlineViewer:()=>uh,restoreOutlineSectionFromBlockHtml:()=>nh,restoreOutlineSectionFromSectionFragments:()=>rh,revealOutlineSection:()=>au});function pr(e,t={},{dedupeMs:n=250}={}){try{let r=xi(new Error),o=Date.now();if(wa.hash===r.hash&&o-wa.atMs<n)return;wa={atMs:o,hash:r.hash},wi(e,{articleId:bt||d.articleId||null,isOutlineEditing:!!d.isOutlineEditing,mode:d.mode,stackHash:r.hash,stackTop:r.top,...t})}catch{}}function Di(e,t){let n=null,r=String(t||"").trim();return!e||!r?null:(e.descendants((o,i)=>{if(n!==null)return!1;o?.type?.name==="image"&&String(o.attrs?.uploadToken||"")===r&&(n=i)}),n)}function rm(e){let t=String(e||"").trim();if(!t)return;let n=Lr.get(t)||null;if(n){Lr.delete(t);try{URL.revokeObjectURL(n)}catch{}}}function Rd(e,t=3e4){let n=String(e||"").trim();if(n){try{let r=_o.get(n)||null;r&&clearTimeout(r)}catch{}try{let r=setTimeout(()=>{try{_o.delete(n)}catch{}rm(n)},Math.max(0,Number(t)||0));_o.set(n,r)}catch{}}}function Ta(e){if(!e)return!1;if(e.type&&String(e.type).startsWith("image/"))return!0;let t=String(e.name||"").toLowerCase();return!!(t&&/\.(png|jpe?g|gif|webp|bmp|svg|heic|heif)$/i.test(t))}function Hd(e,t){try{let n=e?.state?.schema,r=n?.nodes?.image||null;if(!n||!r)return Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435"),!1;let o=`upl-${Date.now()}-${Math.random().toString(16).slice(2)}`,i=URL.createObjectURL(t);try{Lr.set(o,i)}catch{}try{let f=bt||d.articleId||null;ad({token:o,articleId:f,kind:"image",blob:t,fileName:t?.name||"image",mime:t?.type||""})}catch{}let s=r.create({src:i,alt:t?.name||"image",width:320,uploadToken:o}),a=je?.pmStateMod?.TextSelection,c=e.state.tr,l=c.selection.from,u=c.selection.to,h="\xA0\xA0";u>l&&(c=c.delete(l,u));let g=Math.max(0,Math.min(c.doc.content.size,l));c=c.insertText(h,g,g);let b=Math.max(0,Math.min(c.doc.content.size,g+h.length));c=c.replaceRangeWith(b,b,s);let S=Math.max(0,Math.min(c.doc.content.size,b+s.nodeSize));c=c.insertText(h,S,S);let p=Math.max(0,Math.min(c.doc.content.size,S+h.length));a&&(c=c.setSelection(a.create(c.doc,p))),c=c.setMeta(ue,!0),e.dispatch(c.scrollIntoView());try{let f=new Image;f.decoding="async",f.onload=()=>{try{let w=Number(f.naturalWidth||0),x=Number(f.naturalHeight||0);if(!(w>0&&x>0))return;let A=w/x,I=Di(e.state.doc,o);if(typeof I!="number")return;let N=e.state.doc.nodeAt(I);if(!N||N.type?.name!=="image"||Number.isFinite(Number(N.attrs?.aspectRatio))&&Number(N.attrs.aspectRatio)>0)return;let O={...N.attrs,aspectRatio:A},U=e.state.tr.setNodeMarkup(I,void 0,O);U=U.setMeta(ue,!0),e.dispatch(U)}catch{}},f.onerror=()=>{},f.src=i}catch{}try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return Ee("\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E \u0438 \u0431\u0443\u0434\u0435\u0442 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E \u043F\u0440\u0438 \u043F\u043E\u044F\u0432\u043B\u0435\u043D\u0438\u0438 \u0441\u0435\u0442\u0438"),!0}catch{}return fo(t).then(f=>{let w=String(f?.url||"").trim();if(!w)throw new Error("Upload failed");let x=Di(e.state.doc,o);if(typeof x!="number")return;let A=e.state.doc.nodeAt(x);if(!A||A.type?.name!=="image")return;let I={...A.attrs,src:w,uploadToken:null},N=e.state.tr.setNodeMarkup(x,void 0,I);N=N.setMeta(ue,!0),e.dispatch(N),Rd(o),ca(o).catch(()=>{})}).catch(f=>{Ee(f?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435");try{let w=Di(e.state.doc,o);if(typeof w!="number")return;let x=e.state.doc.nodeAt(w);if(!x||x.type?.name!=="image")return;let A=String(x.attrs?.title||"").trim(),I=A?`${A} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",N=String(x.attrs?.alt||t?.name||"image"),O={...x.attrs,src:i,alt:N,title:I,uploadToken:o},U=e.state.tr.setNodeMarkup(w,void 0,O);U=U.setMeta(ue,!0),e.dispatch(U)}catch{}try{la(o,String(f?.message||f||"error"))}catch{}}),!0}catch{return!1}}function $d(e,t){try{let n=e?.state?.schema,r=n?.marks?.link||null;if(!n||!r)return Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u0438\u0435: \u043D\u0435\u0442 \u0441\u0445\u0435\u043C\u044B \u0441\u0441\u044B\u043B\u043E\u043A"),!1;if(!d.articleId)return Ee("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E"),!1;let o=Xt(),i=`pending-attachment:${String(o||"")}`,s=String(t?.name||"\u0444\u0430\u0439\u043B"),a=`${s} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430...)`,{from:c,to:l}=e.state.selection,u=e.state.tr.insertText(a,c,l);u=u.addMark(c,c+a.length,r.create({href:i})),u=u.setMeta(ue,!0),e.dispatch(u.scrollIntoView());let h=null;try{h=(Ie?.getState?.(e.state)||null)?.editingSectionId||null}catch{h=null}let g=(b,S)=>{let p=`pending-attachment:${String(S||"")}`,f=b?.type?.schema?.marks?.link||null;if(!f)return null;let w=null;return b.descendants((x,A)=>{if(w)return!1;!x||!x.isText||!(Array.isArray(x.marks)?x.marks:[]).find(O=>O?.type===f&&String(O?.attrs?.href||"")===p)||(w={from:A,to:A+x.nodeSize})}),w};return Qo(d.articleId,t,{sectionId:h}).then(b=>{let S=String(b?.storedPath||b?.url||b?.path||"").trim();if(!S)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443 \u043D\u0430 \u0444\u0430\u0439\u043B");let p=String(b?.originalName||t?.name||"\u0444\u0430\u0439\u043B"),f=g(e.state.doc,o);if(!f)return;let w=e.state.tr.insertText(p,f.from,f.to);w=w.addMark(f.from,f.from+p.length,r.create({href:S})),w=w.setMeta(ue,!0),e.dispatch(w)}).catch(b=>{let S=g(e.state.doc,o);if(S){let p=`${s} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`,f=e.state.tr.insertText(p,S.from,S.to);f=f.setMeta(ue,!0),e.dispatch(f)}Ee(b?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u043D\u0430 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A")}),!0}catch{return!1}}function om(e){try{if(!e||typeof e!="object")return e;let t=typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e)),n=r=>{if(!r||typeof r!="object")return;if(r.type==="image"&&r.attrs&&typeof r.attrs=="object"){let i=String(r.attrs.uploadToken||"").trim(),s=String(r.attrs.src||"");i&&s.startsWith("blob:")&&(r.attrs={...r.attrs,src:`${Fi}${i}`})}let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(t),t}catch{return e}}function wd(e){try{if(!e||typeof e!="object")return e;let t=typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e)),n=r=>{if(!r||typeof r!="object")return;if(r.type==="image"&&r.attrs&&typeof r.attrs=="object"){let i=String(r.attrs.uploadToken||"").trim(),s=String(r.attrs.src||"");i&&s.startsWith("blob:")&&(r.attrs={...r.attrs,src:`${Fi}${i}`})}let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(t),t}catch{return e}}async function im(e){try{if(!ie||ie.isDestroyed)return;let t=String(e||"").trim();if(!t)return;let n=await da({articleId:t,limit:200}).catch(()=>[]);if(!n.length)return;let r=new Map;for(let c of n){let l=String(c?.token||"").trim();l&&(c?.kind&&String(c.kind)!=="image"||c?.blob&&r.set(l,c.blob))}if(!r.size)return;let{state:o,view:i}=ie,s=o.tr,a=!1;o.doc.descendants((c,l)=>{if(c?.type?.name!=="image")return;let u=String(c.attrs?.uploadToken||"").trim(),h=String(c.attrs?.src||""),g=h.startsWith(Fi)?h.slice(Fi.length).trim():"",b=u||g;if(!b)return;let S=r.get(b);if(!S)return;let p=Lr.get(b)||null;if(!p)try{p=URL.createObjectURL(S),Lr.set(b,p)}catch{p=null}if(!p)return;let f={...c.attrs,src:p,uploadToken:b};s=s.setNodeMarkup(l,void 0,f),a=!0}),a&&(s=s.setMeta(ue,!0),i.dispatch(s))}catch{}}async function Fd(e){try{if(!navigator.onLine||!ie||ie.isDestroyed)return!1;let t=String(e||"").trim();if(!t)return!1;let n=await da({articleId:t,limit:50}).catch(()=>[]);if(!n.length)return!1;let r=!1;for(let o of n){let i=String(o?.token||"").trim();if(!i||o?.kind&&String(o.kind)!=="image")continue;let s=o?.blob||null;if(s)try{let a=s instanceof File?s:new File([s],o?.fileName||"image",{type:o?.mime||s.type||"application/octet-stream"}),c=await fo(a),l=String(c?.url||"").trim();if(!l)throw new Error("Upload failed");try{let{state:u,view:h}=ie,g=Di(u.doc,i);if(typeof g=="number"){let b=u.doc.nodeAt(g);if(b?.type?.name==="image"){let S={...b.attrs,src:l,uploadToken:null,title:String(b.attrs?.title||"").replace(/\s*\(ошибка загрузки\)\s*$/i,"").trim()},p=u.tr.setNodeMarkup(g,void 0,S);p=p.setMeta(ue,!0),h.dispatch(p)}}}catch{}Rd(i),await ca(i).catch(()=>{}),r=!0}catch(a){let c=a?.message||String(a||"error");await la(i,c).catch(()=>{})}}if(r)try{en({delayMs:350})}catch{}return r}catch{return!1}}function Ba(){try{let e=window?.localStorage?.getItem?.(va)||"";if(!e)return null;let t=JSON.parse(e);return!t||typeof t!="object"||!Array.isArray(t.sections)?null:{mode:t.mode==="cut"?"cut":"copy",sourceArticleId:typeof t.sourceArticleId=="string"?t.sourceArticleId:null,createdAt:typeof t.createdAt=="string"?t.createdAt:null,sections:t.sections}}catch{return null}}function Oi(e){try{if(!e){window?.localStorage?.removeItem?.(va);return}window?.localStorage?.setItem?.(va,JSON.stringify(e))}catch{}}function ro(e){Zn=!!e,Zn||(yr=new Set);try{V?.outlineEditor&&V.outlineEditor.classList.toggle("outline-select-mode",Zn)}catch{}try{zd()}catch{}}function sm(e){let t=String(e||"").trim();if(t){yr.has(t)?yr.delete(t):yr.add(t);try{zd()}catch{}}}function zd(){if(!V?.outlineEditor)return;V.outlineEditor.querySelectorAll(".outline-heading[data-section-id] .outline-heading__select").forEach(t=>{let r=t.closest(".outline-heading")?.getAttribute?.("data-section-id")||"",o=r&&yr.has(r);t.setAttribute("aria-checked",o?"true":"false"),t.style.display=Zn?"inline-flex":"none"})}function am(e,t){let n=t instanceof Set?t:new Set,r=[];if(!e||!n.size)return r;let o=(i,s)=>{let a=String(i?.attrs?.id||"").trim(),c=a&&n.has(a);if(c&&!s){r.push({id:a,node:i});return}let l=i?.childCount>=3?i.child(2):null;if(l)try{l.forEach(u=>{u?.type?.name==="outlineSection"&&o(u,s||c)})}catch{}};try{e.forEach(i=>{i?.type?.name==="outlineSection"&&o(i,!1)})}catch{}return r}function Da(e){return JSON.parse(JSON.stringify(e))}function Ud(e,t){let n=Da(e),r=o=>{if(!o||typeof o!="object")return;if(o.type==="outlineSection"){let s=t();o.attrs&&typeof o.attrs=="object"?o.attrs.id=s:o.attrs={id:s,collapsed:!!o.attrs?.collapsed}}let i=Array.isArray(o.content)?o.content:[];for(let s of i)r(s)};return r(n),n}async function cm(e){let t=String(e||"");if(t){try{if(navigator?.clipboard?.writeText){await navigator.clipboard.writeText(t);return}}catch{}try{let n=document.createElement("textarea");n.value=t,n.setAttribute("readonly","true"),n.style.position="fixed",n.style.left="-9999px",n.style.top="0",document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n)}catch{}}}function qd(e,{baseLevel:t=2,depth:n=0}={}){let r=e;if(!r||r.type?.name!=="outlineSection")return"";let o="",i="";try{let c=r.child(0);o=String(c?.textContent||"").trim()}catch{o=""}try{let c=r.child(1);i=c?String(c.textBetween(0,c.content.size,`
`)).trimEnd():""}catch{i=""}let s=Math.min(6,Math.max(1,Number(t)+Number(n||0))),a=[];o&&a.push(`${"#".repeat(s)} ${o}`),i&&a.push(i);try{let c=r.child(2);if(c){let l=[];c.forEach(u=>{if(u?.type?.name!=="outlineSection")return;let h=qd(u,{baseLevel:t,depth:n+1});h&&l.push(h)}),l.length&&a.push(l.join(`

`))}}catch{}return a.filter(Boolean).join(`

`).trim()}function Kd(e,t){try{let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return 1;let o=window.localStorage.getItem(xd)||"",i=o?JSON.parse(o):{},s=i&&typeof i=="object"?i:{},a=(s[n]&&typeof s[n]=="object"?s[n]:{})||{},l=(Number(a[r]||0)||0)+1;return a[r]=l,s[n]=a,window.localStorage.setItem(xd,JSON.stringify(s)),l}catch{return Date.now()}}function Vd(e,t){try{let n=JSON.stringify({headingJson:e,bodyJson:t});return globalThis.TextEncoder?new TextEncoder().encode(n).length:n.length*2}catch{return 0}}function eo(e){try{let t=String(e||"").trim();if(!t)return;Tn.add(t);let n=bt||d.articleId||null;if(!n||d.article?.encrypted||xa)return;xa=setTimeout(()=>{xa=null;try{if(!Tn.size)return;let r=Array.from(Tn);Tn.clear();let o=Date.now();on("delete_sections",{articleId:n,payload:{sectionIds:r,clientQueuedAt:o},coalesceKey:`delete:${n}`})}catch{}},0)}catch{}}function Ho(e){let t=[],n=o=>{try{if(!o||o.type?.name!=="outlineSection")return null;for(let i=0;i<o.childCount;i+=1){let s=o.child(i);if(s?.type?.name==="outlineChildren")return s}return null}catch{return null}},r=(o,i)=>{try{if(!o)return;let s=0;o.forEach(a=>{if(!a||a.type?.name!=="outlineSection")return;let c=String(a.attrs?.id||"").trim();if(!c)return;t.push({sectionId:c,parentId:i||null,position:s,collapsed:!!a.attrs?.collapsed}),s+=1;let l=n(a);l&&r(l,c)})}catch{}};try{if(!e)return[];r(e,null)}catch{return[]}return t}function Ad(e){try{return Ho(e).map(n=>`${n.parentId||""}|${n.position}|${n.sectionId}|${n.collapsed?1:0}`).join(`
`)}catch{return""}}function to(e){let t=[];try{if(!e)return t;e.descendants((n,r)=>{n?.type?.name==="outlineSection"&&t.push(r)})}catch{}return t}function Na(e,t){try{if(!e||e.isDestroyed)return!1;let n=!!t;return e.commands.command(({state:r,dispatch:o})=>{let i=to(r.doc);if(!i.length)return!1;let s=r.tr;for(let a of i){let c=s.doc.nodeAt(a);!c||c.type?.name!=="outlineSection"||!!c.attrs?.collapsed!==n&&(s=s.setNodeMarkup(a,void 0,{...c.attrs,collapsed:n}))}s=s.setMeta(ue,!0);try{n&&Ie&&(Ie.getState(r)||{}).editingSectionId&&(s=s.setMeta(Ie,{type:"exit"}))}catch{}try{if(n&&TextSelection){let a=Bt(r.doc,r.selection.$from),c=typeof a=="number"?a:i[0],l=s.doc.nodeAt(c);if(l?.type?.name==="outlineSection"){let u=l.child(0),g=c+1+u.nodeSize-1;s=s.setSelection(TextSelection.near(s.doc.resolve(g),-1))}}}catch{}return o(s.scrollIntoView()),!0})}catch{return!1}}function lm({articleId:e,editor:t}={}){try{let n=String(e||"").trim();if(!n||!t)return;Fn=!0;try{if((Ie?.getState?.(t.state)||null)?.editingSectionId){Ut&&(clearTimeout(Ut),Ut=null);return}}catch{}Ut&&clearTimeout(Ut),Ut=setTimeout(()=>{Ut=null;try{if(!Fn)return;let r=t.state?.doc,o=Ho(r);if(!o.length)return;try{let i=null;try{i=o.filter(s=>s&&(s.parentId==null||s.parentId==="")&&Number(s.position)>=0).sort((s,a)=>Number(s.position)-Number(a.position)).slice(0,3).map(s=>String(s.sectionId||""))}catch{i=null}pt("outline.enqueue.structure_snapshot",{articleId:n,nodesCount:o.length,rootFirst:i})}catch{}on("structure_snapshot",{articleId:n,payload:{nodes:o},coalesceKey:`structure:${n}`}),Fn=!1}catch{}},tm)}catch{}}async function Oa({articleId:e,doc:t,sectionId:n,reason:r}){let o=String(e||"").trim(),i=String(n||"").trim();if(!o||!i||!t)return!1;let s=gt(t,i),a=typeof s=="number"?t.nodeAt(s):null;if(!a||a.type?.name!=="outlineSection")return!1;try{if(!Br(t,i))return!1}catch{return!1}let c=a.child(0),l=a.child(1),u=c?.toJSON?c.toJSON():null,h=l?.toJSON?l.toJSON():null;if(!u||!h)return!1;try{u=wd(u),h=wd(h)}catch{}let g=Vd(u,h);if(g>zi){let p=Date.now();return(!ba||p-ba>5e3)&&(ba=p,Ee(`\u0411\u043B\u043E\u043A \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 (${Math.ceil(g/1024)} KB). \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C: ${Math.ceil(zi/1024)} KB. \u0420\u0430\u0437\u0431\u0435\u0439\u0442\u0435 \u0431\u043B\u043E\u043A \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E.`)),!1}let b=Date.now(),S=Kd(o,i);try{pt("outline.enqueue.section_upsert_content",{articleId:o,sectionId:i,seq:S,bytes:g,reason:String(r||"")})}catch{}await on("section_upsert_content",{articleId:o,payload:{sectionId:i,headingJson:u,bodyJson:h,seq:S,clientQueuedAt:b},coalesceKey:`content:${o}:${i}`}).catch(()=>{});try{if(Fn){let p=Ho(t);if(p.length){let f=null;try{f=p.filter(w=>w&&(w.parentId==null||w.parentId==="")&&Number(w.position)>=0).sort((w,x)=>Number(w.position)-Number(x.position)).slice(0,3).map(w=>String(w.sectionId||""))}catch{f=null}try{pt("outline.enqueue.structure_snapshot",{articleId:o,nodesCount:p.length,reason:"after_section_upsert",rootFirst:f})}catch{}on("structure_snapshot",{articleId:o,payload:{nodes:p},coalesceKey:`structure:${o}`})}Fn=!1,Ut&&(clearTimeout(Ut),Ut=null)}}catch{}try{Pr.set(i,Ji(a)),_r.delete(i)}catch{}try{Promise.resolve().then(()=>(ya(),ga)).then(p=>p.flushOutboxOnce?.()).catch(()=>{})}catch{}return!0}function dm(e){try{if(!e||e.isDestroyed)return;let t=Ie?.getState?.(e.state)||null,n=String(t?.editingSectionId||"").trim();if(!n)return;let r=bt||d.articleId||null;if(!r)return;Ia=n,Tr&&clearTimeout(Tr),Tr=setTimeout(()=>{Tr=null;try{if(!ie||ie.isDestroyed)return;let o=Ie?.getState?.(ie.state)||null,i=String(o?.editingSectionId||"").trim();if(!i||i!==Ia)return;Oa({articleId:r,doc:ie.state.doc,sectionId:i,reason:"edit_heartbeat"})}catch{}},nm)}catch{}}function Ma(){try{return window?.localStorage?.getItem?.(um)==="1"}catch{return!1}}function An(...e){Ma()}function vr(){try{return window?.localStorage?.getItem?.(fm)==="1"}catch{return!1}}function no(e,t={}){vr()}function mm(){try{return window?.localStorage?.getItem?.(pm)==="1"}catch{return!1}}function Ft(e,t={}){mm()}function Hi(e){let t=String(e||"").replace(/\s+/g," ").trim().toLowerCase();return t?t.length>60?t.slice(0,60):t:null}function Lo(e){return String(e||"").replace(/\s+/g," ").trim().toLowerCase()}function hm(e,t="tag"){let n=new Map,r=new Map,o=new Map,i=new Map;return e?(e.descendants((s,a)=>{if(s?.type?.name!=="outlineSection")return;let c=String(s.attrs?.id||"");c&&i.set(c,a);let l=new Set,u=h=>{h?.descendants?.(g=>{if(g?.type?.name!==t)return;let b=Hi(g.attrs?.label||g.textContent||"");if(!b)return;let S=Lo(g.attrs?.key||b);S&&(n.set(S,(n.get(S)||0)+1),r.set(S,S),l.add(S))})};try{u(s.child(0)),u(s.child(1))}catch{}if(c)for(let h of l)o.has(h)||o.set(h,new Set),o.get(h).add(c);return!1}),{counts:n,labelByKey:r,sectionIdsByKey:o,sectionPosById:i}):{counts:n,labelByKey:r,sectionIdsByKey:o,sectionPosById:i}}function jd(){let e=V?.outlineTagsBar;if(!e)return;let t=Array.from(tr.counts.entries()).map(([n,r])=>({key:n,label:tr.labelByKey.get(n)||n,count:r})).filter(n=>n.key&&n.count>0).sort((n,r)=>r.count!==n.count?r.count-n.count:n.label.localeCompare(r.label));if(!t.length){e.innerHTML="",e.classList.add("hidden");return}e.classList.remove("hidden"),e.innerHTML=t.map(n=>{let r=gr&&gr===n.key?"true":"false",o=Oo(n.label);return`<button type="button" class="outline-tag-pill" data-tag-key="${Oo(n.key)}" aria-pressed="${r}">${o} <span class="outline-tag-pill__count">(${n.count})</span></button>`}).join("")}function Jd(){if(ie){if(tr=hm(ie.state.doc,"tag"),gr&&!tr.counts.has(gr)){gr=null;try{qi?.(null)}catch{}}jd()}}function gm(e){let t=String(e||"");if(!t||!ie)return;let n=tr.sectionIdsByKey.get(t);if(!n||!n.size)return;let r=new Set;for(let s of n){let a=tr.sectionPosById.get(s);if(typeof a=="number"){r.add(a);try{let c=ie.state.doc.resolve(Math.min(ie.state.doc.content.size,a+1));for(let l=c.depth;l>0;l-=1)c.node(l)?.type?.name==="outlineSection"&&r.add(c.before(l))}catch{}}}let o=ie.state.tr,i=!1;for(let s of r){let a=o.doc.nodeAt(s);!a||a.type?.name!=="outlineSection"||a.attrs?.collapsed&&(o=o.setNodeMarkup(s,void 0,{...a.attrs,collapsed:!1}),i=!0)}i&&(o=o.setMeta(ue,!0),ie.view.dispatch(o))}function ym({setActiveTagKey:e}){let t=V?.outlineTagsBar;if(!t)return()=>{};let n=r=>{let o=r.target?.closest?.("[data-tag-key]");if(!o)return;let i=String(o.getAttribute("data-tag-key")||"");if(!i)return;let s=gr===i?null:i;gr=s;try{e(s)}catch{}s&&gm(s),jd()};return t.addEventListener("click",n),()=>t.removeEventListener("click",n)}function kn(e){let t=String(e||"").trim();if(!t.includes("|"))return null;let n=t;n.startsWith("|")&&(n=n.slice(1)),n.endsWith("|")&&(n=n.slice(0,-1));let r=n.split("|").map(o=>o.trim());return r.length<2||r.every(o=>!o)?null:r}function Ki(e){let t=String(e||"").trim();return t?/^:?-{3,}:?$/.test(t):!1}function Nr(e){let t=(Array.isArray(e)?e:[]).map(i=>String(i||"").replace(/\r/g,"").trimEnd()).filter(i=>i.length>0);if(t.length<2)return null;let n=kn(t[0]),r=kn(t[1]);if(!n||!r||n.length!==r.length||!r.every(Ki))return null;let o=[];for(let i=2;i<t.length;i+=1){let s=kn(t[i]);if(!s||s.length!==n.length)return null;o.push(s)}return{header:n,rows:o}}function Mr(e){let t=(Array.isArray(e)?e:[]).map(s=>String(s||"").replace(/\r/g,"").trimEnd()).filter(s=>s.length>0);if(t.length<1)return null;let n=kn(t[0]);if(!n)return null;let r=n.length;if(r<2)return null;let o=[n];for(let s=1;s<t.length;s+=1){let a=kn(t[s]);if(!a||a.length!==r)break;if(s===1&&a.every(Ki))return null;o.push(a)}return o.flat().filter(s=>String(s||"").trim().length>0).length<2?null:{rows:o}}function Ra(e){let t=String(e||"").replace(/\r/g,"").split(`
`).map(n=>String(n||"").trimEnd());for(;t.length&&!t[0].trim();)t.shift();for(;t.length&&!t[t.length-1].trim();)t.pop();return t}function mr(e,t){if(!e||!t)return null;let{header:n,rows:r,withHeader:o}=t,i=e.nodes.table,s=e.nodes.tableRow,a=e.nodes.tableCell,c=e.nodes.tableHeader,l=e.nodes.paragraph;if(!i||!s||!a||!c||!l||typeof e.text!="function")return null;let u=S=>l.create({},S?[e.text(String(S))]:[]),h=(S,p)=>S.map(f=>(p?c:a).create({},[u(f)])),g=(S,p)=>s.create({},h(S,p)),b=[];return o&&Array.isArray(n)&&n.length&&b.push(g(n,!0)),(Array.isArray(r)?r:[]).forEach(S=>b.push(g(S,!1))),b.length?i.create({},b):null}function bm(e,t){try{let n=e?.selection,r=n?.$from;if(!n?.empty||!r)return ot("table.merge.skip",{reason:"no-cursor"}),!1;if(r.parent?.type?.name!=="paragraph")return!1;if(r.parentOffset!==0)return ot("table.merge.skip",{reason:"not-at-paragraph-start"}),!1;let o=null,i=null,s=null;for(let te=r.depth;te>0;te-=1){let be=r.node(te)?.type?.name;if(!s&&(be==="tableCell"||be==="tableHeader")?s=te:!i&&be==="tableRow"?i=te:!o&&be==="table"&&(o=te),o&&i&&s)break}if(o==null||i==null||s==null)return ot("table.merge.skip",{reason:"not-in-table"}),!1;let a=r.depth===s+1,c=r.index(o),l=r.index(i),u=r.index(s);if(ot("table.merge.check",{parent:r.parent?.type?.name||null,parentOffset:r.parentOffset,tableDepth:o,rowDepth:i,cellDepth:s,isDirectParagraphInCell:a,rowIndex:c,colIndex:l,childIndexInCell:u}),!a)return ot("table.merge.skip",{reason:"paragraph-not-direct-child-of-cell"}),!1;if(c!==0||l!==0||u!==0)return ot("table.merge.skip",{reason:"not-in-first-cell",rowIndex:c,colIndex:l,childIndexInCell:u}),!1;let h=r.before(o),g=e.doc.nodeAt(h);if(!g||g.type?.name!=="table")return ot("table.merge.skip",{reason:"no-current-table",tablePos:h}),!1;let b=e.doc.resolve(h),S=b.index(),p=b.parent;if(!p||S<=0)return ot("table.merge.skip",{reason:"no-prev-sibling",idx:S,parent:p?.type?.name||null}),!1;let f=null,w=S-1;for(;w>=0;){let te=p.child(w);if(te?.type?.name==="paragraph"&&!String(te.textContent||"").trim()){w-=1;continue}f=te;break}if(!f||f.type?.name!=="table")return ot("table.merge.skip",{reason:"no-prev-table"}),!1;let x=f.childCount?f.child(0):null,A=g.childCount?g.child(0):null;if(!x||!A)return ot("table.merge.skip",{reason:"missing-rows"}),!1;if(x.childCount!==A.childCount)return ot("table.merge.skip",{reason:"different-columns",prevCols:x.childCount,curCols:A.childCount}),!1;let I=x.childCount,N=(te,be)=>{try{return te?.type?.name==="tableRow"&&te.childCount===be}catch{return!1}};for(let te=0;te<f.childCount;te+=1){let be=f.child(te);if(!N(be,I))return ot("table.merge.skip",{reason:"prev-row-mismatch",rowIndex:te,colsExpected:I,colsGot:be?.childCount??null}),!1}for(let te=0;te<g.childCount;te+=1){let be=g.child(te);if(!N(be,I))return ot("table.merge.skip",{reason:"cur-row-mismatch",rowIndex:te,colsExpected:I,colsGot:be?.childCount??null}),!1}let O=h;for(let te=S-1;te>=w;te-=1)O-=p.child(te).nodeSize;let U=f.childCount,H=e.doc.type.schema,X=O+f.nodeSize,G=e.tr;h>X&&(G=G.delete(X,h));let oe=X;G=G.delete(oe,oe+g.nodeSize);let xe=G.doc.nodeAt(O);if(!xe||xe.type?.name!=="table")return ot("table.merge.skip",{reason:"prev-after-missing",prevStart:O,prevAfterType:xe?.type?.name||null}),!1;ot("table.merge.plan",{idx:S,prevIdx:w,prevStart:O,prevEnd:X,tablePos:h,tablePos2:oe,cols:I,prevRowCount:U,curRowCount:g.childCount});try{let te=xe.content.append(g.content),be=H.nodes.table.create(xe.attrs,te,xe.marks);G=G.replaceWith(O,O+xe.nodeSize,be)}catch(te){return ot("table.merge.error",{message:String(te?.message||te||""),stack:String(te?.stack||"")}),!1}let ve=G.doc.nodeAt(O);ot("table.merge.afterReplace",{mergedType:ve?.type?.name||null,mergedRows:ve?.type?.name==="table"?ve.childCount:null});try{let te=je?.pmStateMod?.TextSelection||je?.pm?.state?.TextSelection||null;if(ve&&ve.type?.name==="table"){let be=Math.min(U,Math.max(0,ve.childCount-1));if(ve.child(be)?.childCount){let kt=(()=>{let ln=O+1;for(let gn=0;gn<be;gn+=1)ln+=ve.child(gn).nodeSize;return ln+=1,ln})(),Ot=Math.min(G.doc.content.size,kt+2);te&&(G=G.setSelection(te.near(G.doc.resolve(Ot),1)))}}}catch(te){ot("table.merge.selection.error",{message:String(te?.message||te||""),stack:String(te?.stack||"")})}G=G.setMeta(ue,!0);try{t(G.scrollIntoView())}catch(te){return ot("table.merge.dispatch.error",{message:String(te?.message||te||""),stack:String(te?.stack||"")}),!1}return!0}catch(n){try{ot("table.merge.exception",{message:String(n?.message||n||""),stack:String(n?.stack||"")})}catch{}return!1}}function Sm(e,t,n,r){try{let o=(be,Qe={})=>{},i=(be={})=>{};if(!n)return!1;if(!r)return o("no-TextSelection"),!1;let s=e?.selection;if(!s?.empty)return o("selection-not-empty"),!1;let a=s.$from||null;if(!a)return o("no-$from"),!1;i({from:s.from,parent:a.parent?.type?.name||null,parentOffset:a.parentOffset??null});let c=gt(e.doc,n);if(typeof c!="number")return o("section-not-found"),!1;let l=e.doc.nodeAt(c);if(!l||l.type?.name!=="outlineSection")return o("not-outlineSection",{found:l?.type?.name||null}),!1;let u=l.child(0),h=l.child(1);if(!u||u.type?.name!=="outlineHeading")return o("missing-heading",{found:u?.type?.name||null}),!1;if(!h||h.type?.name!=="outlineBody")return o("missing-body",{found:h?.type?.name||null}),!1;let g=String(u.textContent||"").replace(/\u00a0/g," "),b=!!g.trim(),S=/\s$/.test(g),p=null;for(let be=a.depth;be>=0;be-=1)if(a.node(be)?.type?.name==="outlineBody"){p=be;break}if(p==null)return o("not-in-outlineBody",{parent:a.parent?.type?.name||null}),!1;if(a.index(p)!==0)return o("not-first-body-child",{index:a.index(p)}),!1;if(a.parent?.type?.name!=="paragraph")return o("parent-not-paragraph",{parent:a.parent?.type?.name||null}),!1;if((a.parentOffset??null)!==0)return o("not-at-paragraph-start",{parentOffset:a.parentOffset??null}),!1;let f=c+1,w=s.from,x=a.parent,A=0,I=null;for(let be=0;be<x.childCount;be+=1){let Qe=x.child(be);if(Qe.type?.name==="hardBreak"){I=A;break}A+=Qe.nodeSize}let N=w+(I??x.content.size);if(N<=w)return o("empty-first-line"),!1;let O=e.doc.slice(w,N);if(!O?.content||O.content.size<=0)return o("empty-slice"),!1;let U=I==null?N:N+1,H=f+1,X=f+u.nodeSize-1,G=e.tr;b&&!S&&(G=G.insertText(" ",X),G=G.setMeta(ue,!0));let oe=G.mapping.map(X,1),xe=oe;G=G.insert(oe,O.content);let ve=G.mapping.map(w,1),te=G.mapping.map(U,-1);G=G.delete(ve,te);try{G=G.setSelection(r.create(G.doc,xe))}catch{}return G=G.setMeta(ue,!0),t(G.scrollIntoView()),!0}catch(o){return!1}}function wm(e,t){try{if(!e?.doc||!t)return null;let n=gt(e.doc,t);if(typeof n!="number")return null;let r=e.doc.nodeAt(n);if(!r)return null;let o=r.child(0),i=r.child(1);if(!i||i.type?.name!=="outlineBody")return null;let a=n+1+o.nodeSize+1,c=[],l=0,u=0;for(;u<i.childCount;){let g=i.child(u),b=a+l;if(g.type?.name!=="paragraph"){l+=g.nodeSize,u+=1;continue}let S=hr(g).trim();if(S.includes(`
`)&&S.includes("|")){let G=Ra(S),oe=Nr(G),xe=oe?null:Mr(G),ve=oe?{header:oe.header,rows:oe.rows,withHeader:!0}:xe?{header:null,rows:xe.rows,withHeader:!1}:null,te=null;if(ve)try{te=mr(e.schema,ve)}catch(be){An("convert: buildTableNode error (single)",{message:String(be?.message||be||""),stack:String(be?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),te=null}if(te){let be=b,Qe=b+g.nodeSize;c.push({from:be,to:Qe,tableNode:te}),An("convert: single-paragraph table",{sectionId:t,from:be,to:Qe,lines:G}),l+=g.nodeSize,u+=1;continue}}let p=kn(S);if(!p||u+1>=i.childCount){if(p){let G=[S],oe=l+g.nodeSize,xe=u+1;for(;xe<i.childCount;){let Qe=i.child(xe);if(Qe.type?.name!=="paragraph")break;let kt=hr(Qe).trim();if(!kt)break;let Ot=kn(kt);if(!Ot||Ot.length!==p.length)break;G.push(kt),oe+=Qe.nodeSize,xe+=1}let ve=Mr(G),te=ve?{header:null,rows:ve.rows,withHeader:!1}:null,be=null;if(te)try{be=mr(e.schema,te)}catch(Qe){An("convert: buildTableNode error (rows-only)",{message:String(Qe?.message||Qe||""),stack:String(Qe?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),be=null}if(be){c.push({from:b,to:a+oe,tableNode:be}),An("convert: rows-only table",{sectionId:t,from:b,to:a+oe,lines:G}),l=oe,u=xe;continue}}l+=g.nodeSize,u+=1;continue}let f=i.child(u+1);if(f.type?.name!=="paragraph"){l+=g.nodeSize,u+=1;continue}let w=hr(f).trim(),x=kn(w);if(!x||x.length!==p.length||!x.every(Ki)){l+=g.nodeSize,u+=1;continue}let A=[S,w],I=l+g.nodeSize+f.nodeSize,N=u+2;for(;N<i.childCount;){let G=i.child(N);if(G.type?.name!=="paragraph")break;let oe=hr(G).trim();if(!oe)break;let xe=kn(oe);if(!xe||xe.length!==p.length)break;A.push(oe),I+=G.nodeSize,N+=1}let O=Nr(A),U=O?null:Mr(A),H=O?{header:O.header,rows:O.rows,withHeader:!0}:U?{header:null,rows:U.rows,withHeader:!1}:null,X=null;if(H)try{X=mr(e.schema,H)}catch(G){An("convert: buildTableNode error (multi)",{message:String(G?.message||G||""),stack:String(G?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),X=null}if(!X){l+=g.nodeSize,u+=1;continue}c.push({from:b,to:a+I,tableNode:X}),An("convert: multi-paragraph table",{sectionId:t,from:b,to:a+I,lines:A}),l=I,u=N}if(!c.length)return null;c.sort((g,b)=>b.from-g.from);let h=e.tr;for(let g of c)h=h.replaceRangeWith(g.from,g.to,g.tableNode);return h=h.setMeta(ue,!0),h}catch{return null}}function hr(e){if(!e)return"";let t="";return e.descendants(n=>{n.isText?t+=n.text||"":n.type?.name==="hardBreak"&&(t+=`
`)}),t}function Id(e){try{if(!e||e.type!=="paragraph")return"";let t=[],n=r=>{if(!r)return;if(r.type==="text"){t.push(String(r.text||""));return}if(r.type==="hardBreak"){t.push(`
`);return}let o=Array.isArray(r.content)?r.content:[];for(let i of o)n(i)};return n(e),t.join("")}catch{return""}}function xm(e){if(!e)return null;let{header:t,rows:n}=e;if(!Array.isArray(t)||t.length===0)return null;let r=s=>({type:"paragraph",content:String(s||"").length?[{type:"text",text:String(s||"")}]:[]}),o={type:"tableRow",content:t.map(s=>({type:"tableHeader",content:[r(s)]}))},i=(Array.isArray(n)?n:[]).map(s=>({type:"tableRow",content:s.map(a=>({type:"tableCell",content:[r(a)]}))}));return{type:"table",content:[o,...i]}}function Am(e){if(!e)return!1;try{let{doc:t,schema:n}=e.state,r=[];if(t.descendants((i,s)=>{if(i.type?.name!=="outlineBody")return;let a=s+1,c=0,l=0;for(;l<i.childCount;){let u=i.child(l),h=a+c;if(u.type?.name!=="paragraph"){c+=u.nodeSize,l+=1;continue}let g=hr(u).trim();if(g.includes(`
`)&&g.includes("|")){let U=Ra(g),H=Nr(U),X=H?null:Mr(U),G=H?{header:H.header,rows:H.rows,withHeader:!0}:X?{header:null,rows:X.rows,withHeader:!1}:null,oe=G?mr(n,G):null;if(oe){r.push({from:h,to:h+u.nodeSize,tableNode:oe}),c+=u.nodeSize,l+=1;continue}}let b=kn(g);if(!b){c+=u.nodeSize,l+=1;continue}if(l+1>=i.childCount){let U=Mr([g]),H=U?{header:null,rows:U.rows,withHeader:!1}:null,X=H?mr(n,H):null;X&&r.push({from:h,to:h+u.nodeSize,tableNode:X}),c+=u.nodeSize,l+=1;continue}let S=i.child(l+1);if(S.type?.name!=="paragraph"){c+=u.nodeSize,l+=1;continue}let p=hr(S).trim(),f=kn(p);if(!f||f.length!==b.length||!f.every(Ki)){let U=[g],H=c+u.nodeSize,X=l+1;for(;X<i.childCount;){let ve=i.child(X);if(ve.type?.name!=="paragraph")break;let te=hr(ve).trim();if(!te)break;let be=kn(te);if(!be||be.length!==b.length)break;U.push(te),H+=ve.nodeSize,X+=1}let G=Mr(U),oe=G?{header:null,rows:G.rows,withHeader:!1}:null,xe=oe?mr(n,oe):null;if(xe){r.push({from:h,to:a+H,tableNode:xe}),c=H,l=X;continue}c+=u.nodeSize,l+=1;continue}let w=[g,p],x=c+u.nodeSize+S.nodeSize,A=l+2;for(;A<i.childCount;){let U=i.child(A);if(U.type?.name!=="paragraph")break;let H=hr(U).trim();if(!H)break;let X=kn(H);if(!X||X.length!==b.length)break;w.push(H),x+=U.nodeSize,A+=1}let I=Nr(w),N=I?{header:I.header,rows:I.rows,withHeader:!0}:null,O=N?mr(n,N):null;if(!O){c+=u.nodeSize,l+=1;continue}r.push({from:h,to:a+x,tableNode:O}),c=x,l=A}}),!r.length)return!1;r.sort((i,s)=>s.from-i.from);let o=e.state.tr;for(let i of r)o=o.replaceRangeWith(i.from,i.to,i.tableNode);return o=o.setMeta(ue,!0),e.view.dispatch(o),!0}catch{return!1}}function Wn(){let e=Date.now();if(!(e-kd<900)){kd=e;try{Ee("\u0414\u043B\u044F \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Enter \u0438\u043B\u0438 \u0434\u0432\u043E\u0439\u043D\u043E\u0439 \u043A\u043B\u0438\u043A \u043C\u044B\u0448\u043A\u043E\u0439. Esc \u0434\u043B\u044F \u0432\u044B\u0445\u043E\u0434\u0430.")}catch{}}}function La(e=""){let t=document.createElement("div");return t.innerHTML=e||"",(t.textContent||"").replace(/\u00a0/g," ").trim()}function Qn(e=""){return String(e||"").replace(/\u00a0/g," ").replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}function Pa(e=""){let t=String(e||""),n=0;for(let r=0;r<t.length;r+=1)n=n*31+t.charCodeAt(r)>>>0;return String(n)}function Zr(e=""){return Pa(String(e||"").slice(0,12e3))}function Xt(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`sec-${Date.now()}-${Math.random().toString(16).slice(2)}`}function Wd({loading:e=!1}={}){V.outlineEditor&&(V.outlineEditor.innerHTML=`
    <div class="outline-editor__body">
      <div class="outline-editor__content" id="outlineEditorContent"></div>
      <div class="outline-editor__loading ${e?"":"hidden"}">\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440\u2026</div>
    </div>
  `,ka||(ka=!0))}function Yd(e){let t=String(e||"").trim();if(!t)return null;let n=t.match(/(-?\d+(?:\.\d+)?)%/);if(!n)return null;let r=Number.parseFloat(n[1]);return Number.isFinite(r)?r:null}function zn(e){let t=Number(e);return Number.isFinite(t)?Math.max(0,Math.min(100,t)):0}function Gd(e){try{let t=e?.dataset?.ttPct||"",n=Number.parseFloat(String(t||""));if(Number.isFinite(n)&&n>0)return n;let r=Yd(e?.style?.width||"");return r!=null&&r>0?r:null}catch{return null}}function Vi(e,t){try{let n=zn(t);return e.dataset.ttPct=n.toFixed(4),e.style.width=`${n.toFixed(4)}%`,e.style.minWidth="",!0}catch{return!1}}function Ui(e,{insertIndex:t,newColPct:n=10}={}){try{let r=e?.view;if(!r)return!1;let o=Number(t);if(!Number.isFinite(o)||o<0)return!1;let i=r.domAtPos(r.state.selection.from),a=((i?.node&&i.node.nodeType===1?i.node:i?.node?.parentElement)||null)?.closest?.("table")||null;if(!a)return!1;let c=a.querySelector("colgroup");if(!c)return!1;let l=Array.from(c.querySelectorAll("col"));if(!l.length||o>=l.length)return!1;let u=100/l.length,h=l.map(I=>Gd(I)??u),g=zn(n);h[o]=g;let b=o-1,S=b>=0?h.slice(0,b+1).reduce((I,N)=>I+N,0):0,p=o+1,f=Math.max(0,l.length-p),w=f>0?h.slice(p).reduce((I,N)=>I+N,0):0,x=100-S-g;if(x<0){let I=Math.max(0,o-1),N=Math.max(0,h[I]-1),O=Math.abs(x),U=Math.min(N,O);h[I]=Math.max(1,h[I]-U),x=100-h.slice(0,b+1).reduce((H,X)=>H+X,0)-g,x=Math.max(0,x)}if(f>0)if(w>0){let I=x/w;for(let N=p;N<l.length;N+=1)h[N]*=I}else{let I=x/f;for(let N=p;N<l.length;N+=1)h[N]=I}let A=h.reduce((I,N)=>I+N,0);if(A>0&&Math.abs(A-100)>.01){let I=100-A,N=l.length-1;h[N]=zn(h[N]+I),A=h.reduce((O,U)=>O+U,0)}for(let I=0;I<l.length;I+=1)Vi(l[I],h[I]);try{a.style.width="100%",a.style.maxWidth="100%",a.style.tableLayout="fixed"}catch{}return!0}catch{return!1}}function $i(e){try{if(!e)return!1;let t=e.querySelector("colgroup");if(!t)return!1;let n=Array.from(t.querySelectorAll("col"));if(!n.length)return!1;let r=e.getBoundingClientRect();if(!Number.isFinite(r.width)||r.width<=0)return!1;let o=e.querySelector("tbody tr");if(!o)return!1;let i=Array.from(o.children||[]).filter(c=>c&&c.nodeType===1);if(!i.length)return!1;let s=[];for(let c=0;c<n.length;c+=1){let l=i[c]||null;if(!l){s.push(0);continue}let u=l.getBoundingClientRect();s.push(Number.isFinite(u.width)?u.width:0)}let a=s.reduce((c,l)=>c+(Number.isFinite(l)?l:0),0);if(!(a>0))return!1;for(let c=0;c<n.length;c+=1){let l=zn(s[c]/a*100);Vi(n[c],l)}return!0}catch{return!1}}function cn(e){try{if(!e?.state?.selection)return null;let t=e.state.selection;try{let o=t?.$anchorCell?.pos,i=t?.$headCell?.pos,s=Number.isFinite(o)?o:Number.isFinite(i)?i:null;if(s!=null){let a=e.nodeDOM?.(s)||null;if(a&&a.nodeType===1)return a.closest?.("table")||null}}catch{}let n=e.domAtPos(t.from);return((n?.node&&n.node.nodeType===1?n.node:n?.node?.parentElement)||null)?.closest?.("table")||null}catch{return null}}function km(e){try{let t=e?.state?.selection||null,n=t?.$from||null;if(!n)return null;try{let s=t?.$anchorCell?.pos,a=t?.$headCell?.pos,c=Number.isFinite(s)?s:Number.isFinite(a)?a:null;if(c!=null){let l=e.nodeDOM?.(c)||null;if(l&&l.nodeType===1)return l}}catch{}let r=null;for(let s=n.depth;s>=0;s-=1){let a=n.node(s)?.type?.name;if(a==="tableCell"||a==="tableHeader"){r=s;break}}if(r!=null){let s=n.before(r),a=e.nodeDOM?.(s)||null;if(a&&a.nodeType===1)return a}let o=e.domAtPos(t.from);return((o?.node&&o.node.nodeType===1?o.node:o?.node?.parentElement)||null)?.closest?.("td,th")||null}catch{return null}}function io(e){try{if(!e)return null;let t=e.querySelector("colgroup");if(!t)return null;let n=Array.from(t.querySelectorAll("col"));if(!n.length)return null;let r=n.map(l=>Gd(l));if(r.some(l=>typeof l=="number"&&Number.isFinite(l)&&l>0)){let l=100/n.length;return r.map(u=>typeof u=="number"&&Number.isFinite(u)&&u>0?u:l)}let i=e.querySelector("tbody tr");if(!i)return null;let s=Array.from(i.children||[]).filter(l=>l&&l.nodeType===1);if(s.length<n.length)return null;let a=[];for(let l=0;l<n.length;l+=1){let u=s[l].getBoundingClientRect();a.push(Number.isFinite(u.width)?u.width:0)}let c=a.reduce((l,u)=>l+(Number.isFinite(u)?u:0),0);return c>0?a.map(l=>zn(l/c*100)):null}catch{return null}}function so(e,t){try{if(!e)return!1;let n=e.querySelector("colgroup");if(!n)return!1;let r=Array.from(n.querySelectorAll("col"));if(!r.length||!Array.isArray(t)||t.length!==r.length)return!1;for(let o=0;o<r.length;o+=1)Vi(r[o],t[o]);try{e.style.width="100%",e.style.maxWidth="100%",e.style.tableLayout="fixed"}catch{}return!0}catch{return!1}}function Xd(e,t){try{let n=Array.isArray(e)?e.map(h=>Number(h)||0):null,r=Number(t);if(!n||!Number.isFinite(r)||r<0||r>=n.length||n.length<=1)return null;let o=Math.max(0,n[r]||0),i=n.slice(0,r),s=n.slice(r+1),a=s.reduce((h,g)=>h+(Number.isFinite(g)?g:0),0),c=s;if(s.length)if(a>0){let h=(a+o)/a;c=s.map(g=>Number.isFinite(g)?g*h:0)}else{let h=(o||0)/s.length;c=s.map(()=>h)}else i.length&&(i[i.length-1]=Math.max(1,(i[i.length-1]||0)+o));let l=[...i,...c].map(h=>zn(h)),u=l.reduce((h,g)=>h+(Number.isFinite(g)?g:0),0);return u>0&&Math.abs(u-100)>.01&&(l[l.length-1]=zn(l[l.length-1]+(100-u))),l}catch{return null}}function qt(e){try{let t=Et?.TableMap||null,n=e?.selection||null,r=n?.$from||null,i=n?.$anchorCell||null||r||null;if(!i)return null;let s=null;for(let f=i.depth;f>=0;f-=1)if(i.node(f)?.type?.name==="table"){s=f;break}if(s==null)return null;let a=i.before(s),c=e.doc.nodeAt(a);if(!c||c.type?.name!=="table")return null;let l=null;for(let f=s+1;f<=i.depth;f+=1){let w=i.node(f)?.type?.name;if(w==="tableCell"||w==="tableHeader"){l=f;break}}if(l==null)return null;let u=i.before(l),h=t?.get?t.get(c):null;if(!h)return null;let g=u-a-1,b=h.findCell(g),S=Number(b?.left??0),p=Number(b?.top??0);return{tablePos:a,tableNode:c,map:h,colIndex:S,rowIndex:p}}catch{return null}}function Aa(e){try{let t=[],n=e?.selection,r=e?.doc;if(!n||!r)return t;try{r.nodesBetween(n.from,n.to,(i,s)=>{let a=i?.type?.name;(a==="tableCell"||a==="tableHeader")&&t.push({node:i,pos:s})})}catch{}if(!t.length)try{let i=n.$from||null;if(i)for(let s=i.depth;s>=0;s-=1){let a=i.node(s)?.type?.name;if(a==="tableCell"||a==="tableHeader"){let c=i.before(s),l=r.nodeAt(c);l&&t.push({node:l,pos:c});break}}}catch{}let o=new Map;for(let i of t){let s=Number(i?.pos);Number.isFinite(s)&&(o.has(s)||o.set(s,i))}return Array.from(o.values()).sort((i,s)=>Number(i.pos)-Number(s.pos))}catch{return[]}}function Im(e,t){try{let n=Et?.CellSelection||null,r=Et?.TableMap||null;return!n||!r?!1:e.commands.command(({state:o,dispatch:i})=>{let s=qt(o);if(!s)return!1;let{tablePos:a,tableNode:c,map:l}=s,u=Number(t);if(!Number.isFinite(u)||u<0||u>=l.height)return!1;let h=l.positionAt(u,0,c),g=l.positionAt(u,l.width-1,c),b=a+1+h,S=a+1+g,p=null;try{typeof n.create=="function"&&(p=n.create(o.doc,b,S))}catch{p=null}if(!p)return!1;let f=o.tr.setSelection(p);return f=f.setMeta(ue,!0),i(f.scrollIntoView()),!0})}catch{return!1}}function Em(e,t,n){try{let r=Et?.CellSelection||null,o=Et?.TableMap||null;if(!r||!o)return!1;let i=Number(t),s=Number(n);return!Number.isFinite(i)||i<0||!Number.isFinite(s)||s<0?!1:e.commands.command(({state:a,dispatch:c})=>{let l=a?.doc?.nodeAt?.(i)||null;if(!l||l.type?.name!=="table")return!1;let u=o?.get?o.get(l):null;if(!u||s>=u.height)return!1;let h=u.positionAt(s,0,l),g=u.positionAt(s,u.width-1,l),b=i+1+h,S=i+1+g,p=null;try{typeof r.create=="function"&&(p=r.create(a.doc,b,S))}catch{p=null}if(!p)return!1;let f=a.tr.setSelection(p);return f=f.setMeta(ue,!0),c(f.scrollIntoView()),!0})}catch{return!1}}function Cm(e,t){try{let n=Et?.CellSelection||null,r=Et?.TableMap||null;return!n||!r?!1:e.commands.command(({state:o,dispatch:i})=>{let s=qt(o);if(!s)return!1;let{tablePos:a,tableNode:c,map:l}=s,u=Number(t);if(!Number.isFinite(u)||u<0||u>=l.width)return!1;let h=l.positionAt(0,u,c),g=l.positionAt(l.height-1,u,c),b=a+1+h,S=a+1+g,p=null;try{typeof n.create=="function"&&(p=n.create(o.doc,b,S))}catch{p=null}if(!p)return!1;let f=o.tr.setSelection(p);return f=f.setMeta(ue,!0),i(f.scrollIntoView()),!0})}catch{return!1}}function vm(e,t,n){try{let r=Et?.CellSelection||null,o=Et?.TableMap||null;if(!r||!o)return!1;let i=Number(t),s=Number(n);return!Number.isFinite(i)||i<0||!Number.isFinite(s)||s<0?!1:e.commands.command(({state:a,dispatch:c})=>{let l=a?.doc?.nodeAt?.(i)||null;if(!l||l.type?.name!=="table")return!1;let u=o?.get?o.get(l):null;if(!u||s>=u.width)return!1;let h=u.positionAt(0,s,l),g=u.positionAt(u.height-1,s,l),b=i+1+h,S=i+1+g,p=null;try{typeof r.create=="function"&&(p=r.create(a.doc,b,S))}catch{p=null}if(!p)return!1;let f=a.tr.setSelection(p);return f=f.setMeta(ue,!0),c(f.scrollIntoView()),!0})}catch{return!1}}function Tm({pmState:e,dispatch:t},{tablePos:n,rowIndex:r,attr:o,value:i}){try{let s=Et?.CellSelection||null,a=Et?.TableMap||null;if(!a)return!1;let c=Number(n),l=Number(r);if(!Number.isFinite(c)||c<0||!Number.isFinite(l)||l<0)return!1;let u=e?.doc?.nodeAt?.(c)||null;if(!u||u.type?.name!=="table")return!1;let h=a?.get?a.get(u):null;if(!h||l>=h.height)return!1;let g=e.tr;try{if(s?.create){let p=h.positionAt(l,0,u),f=h.positionAt(l,h.width-1,u),w=c+1+p,x=c+1+f;g=g.setSelection(s.create(g.doc,w,x))}}catch{}let b=new Set;for(let p=0;p<h.width;p+=1){let f=h.map[l*h.width+p];Number.isFinite(f)&&b.add(c+1+f)}if(!b.size)return!1;let S=!1;for(let p of b){let f=g.doc.nodeAt(p),w=f?.type?.name;if(w!=="tableCell"&&w!=="tableHeader")continue;let x={...f.attrs||{}};i==null||i===""?delete x[o]:x[o]=i,g=g.setNodeMarkup(p,void 0,x),S=!0}return S?(g=g.setMeta(ue,!0),t(g),!0):!1}catch{return!1}}function Bm({pmState:e,dispatch:t},{tablePos:n,colIndex:r,attr:o,value:i}){try{let s=Et?.CellSelection||null,a=Et?.TableMap||null;if(!a)return!1;let c=Number(n),l=Number(r);if(!Number.isFinite(c)||c<0||!Number.isFinite(l)||l<0)return!1;let u=e?.doc?.nodeAt?.(c)||null;if(!u||u.type?.name!=="table")return!1;let h=a?.get?a.get(u):null;if(!h||l>=h.width)return!1;let g=e.tr;try{if(s?.create){let p=h.positionAt(0,l,u),f=h.positionAt(h.height-1,l,u),w=c+1+p,x=c+1+f;g=g.setSelection(s.create(g.doc,w,x))}}catch{}let b=new Set;for(let p=0;p<h.height;p+=1){let f=h.map[p*h.width+l];Number.isFinite(f)&&b.add(c+1+f)}if(!b.size)return!1;let S=!1;for(let p of b){let f=g.doc.nodeAt(p),w=f?.type?.name;if(w!=="tableCell"&&w!=="tableHeader")continue;let x={...f.attrs||{}};i==null||i===""?delete x[o]:x[o]=i,g=g.setNodeMarkup(p,void 0,x),S=!0}return S?(g=g.setMeta(ue,!0),t(g),!0):!1}catch{return!1}}function ji(e,t="\u0442\u0430\u0431\u043B\u0438\u0446\u044B"){try{let n=!1;return e.descendants(r=>{if(n)return!1;let o=r?.type?.name;if(o==="tableCell"||o==="tableHeader"){let i=Number(r.attrs?.colspan||1),s=Number(r.attrs?.rowspan||1);if(i!==1||s!==1)return n=!0,!1}return!0}),n?(Ee(`\u041F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 ${t} \u043F\u043E\u043A\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u0445 \u044F\u0447\u0435\u0435\u043A`),!1):!0}catch{return!1}}function Qd(e,{kind:t,fromIndex:n,toIndex:r}){try{if(!e||!(Et?.TableMap||null))return!0;let i=e.map||null,s=e.tableNode||null;if(!i||!s)return!0;let a=Number(n),c=Number(r);if(!Number.isFinite(a)||!Number.isFinite(c))return!0;let l=t==="row"?Math.max(0,Math.min(i.height-1,a)):Math.max(0,Math.min(i.width-1,a)),u=t==="row"?Math.max(0,Math.min(i.height-1,c)):Math.max(0,Math.min(i.width-1,c)),h=new Set;for(let g of i.map){let b=Number(g);if(!Number.isFinite(b)||b<0||h.has(b))continue;h.add(b);let S=null;try{S=i.findCell(b)}catch{S=null}if(!S)continue;let p=Number(S.right)-Number(S.left),f=Number(S.bottom)-Number(S.top);if(p>1||f>1)if(t==="col"){let w=Number(S.left),x=Number(S.right);if(w<=l&&l<x||w<=u&&u<x)return!0}else{let w=Number(S.top),x=Number(S.bottom);if(w<=l&&l<x||w<=u&&u<x)return!0}}return!1}catch{return!0}}function Ed(e,t){try{if(!e?.view)return!1;let n=qt(e.state);if(!n)return!1;let{colIndex:r}=n,o=n.map?.width||0;if(!(o>0))return!1;let i=t<0?-1:1,s=r+i;return s>=0&&s<o?Zd(e,r,s):!1}catch{return!1}}function Cd(e,t){try{if(!e?.view)return!1;let n=qt(e.state);if(!n)return!1;let{rowIndex:r}=n,o=n.map?.height||0;if(!(o>0))return!1;let i=t<0?-1:1,s=r+i;return s>=0&&s<o?eu(e,r,s):!1}catch{return!1}}function Zd(e,t,n){try{if(!e?.view)return!1;let r=e.state,o=qt(r);if(!o)return!1;let{tableNode:i}=o,s=o.map?.width||0;if(!(s>0))return!1;let a=Number(t),c=Number(n);if(!Number.isFinite(a)||!Number.isFinite(c)||a<0||a>=s||c<0||c>=s)return!1;if(a===c)return!0;if(Qd(o,{kind:"col",fromIndex:a,toIndex:c}))return Ee("\u041D\u0435\u043B\u044C\u0437\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u043E\u043B\u0431\u0435\u0446: \u0438\u0441\u0445\u043E\u0434\u043D\u0430\u044F \u0438\u043B\u0438 \u0446\u0435\u043B\u0435\u0432\u0430\u044F \u043A\u043E\u043B\u043E\u043D\u043A\u0430 \u043F\u0435\u0440\u0435\u0441\u0435\u043A\u0430\u0435\u0442\u0441\u044F \u0441 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u043C\u0438 \u044F\u0447\u0435\u0439\u043A\u0430\u043C\u0438"),!1;let l=cn(e.view),u=io(l),h=Array.isArray(u)&&u.length===s?(()=>{let p=u.slice(),f=p.splice(a,1)[0];return p.splice(c,0,f),p})():null,g=Et?.moveTableColumn||null;if(typeof g!="function")return!1;let b=g({from:a,to:c,select:!0});return e.commands.command(({state:p,dispatch:f})=>b(p,typeof f=="function"?x=>{try{x=x.setMeta(ue,!0)}catch{}f(x)}:void 0))?(h&&window.requestAnimationFrame(()=>{let p=cn(e.view);so(p,h);try{(p?.closest?.(".tableWrapper")||null)?.dispatchEvent?.(new Event("scroll"))}catch{}}),!0):!1}catch{return!1}}function eu(e,t,n){try{if(!e?.view)return!1;let r=e.state,o=qt(r);if(!o)return!1;let i=o.map?.height||0,s=o.map?.width||0;if(!(s>0&&i>0))return!1;let a=Number(t),c=Number(n);if(!Number.isFinite(a)||!Number.isFinite(c)||a<0||a>=i||c<0||c>=i)return!1;if(a===c)return!0;if(Qd(o,{kind:"row",fromIndex:a,toIndex:c}))return Ee("\u041D\u0435\u043B\u044C\u0437\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u043E\u043A\u0443: \u0438\u0441\u0445\u043E\u0434\u043D\u0430\u044F \u0438\u043B\u0438 \u0446\u0435\u043B\u0435\u0432\u0430\u044F \u0441\u0442\u0440\u043E\u043A\u0430 \u043F\u0435\u0440\u0435\u0441\u0435\u043A\u0430\u0435\u0442\u0441\u044F \u0441 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u043C\u0438 \u044F\u0447\u0435\u0439\u043A\u0430\u043C\u0438"),!1;let l=cn(e.view),u=io(l),h=Et?.moveTableRow||null;if(typeof h!="function")return!1;let g=h({from:a,to:c,select:!0});return e.commands.command(({state:S,dispatch:p})=>g(S,typeof p=="function"?w=>{try{w=w.setMeta(ue,!0)}catch{}p(w)}:void 0))?(Array.isArray(u)&&u.length===s&&window.requestAnimationFrame(()=>{let S=cn(e.view);so(S,u)}),!0):!1}catch{return!1}}function tu(e){try{if(!e)return"";let t=e.textContent||"";return String(t).replace(/\s+/g," ").trim()}catch{return""}}function Nm(e){try{if(!e)return!1;for(let t=0;t<e.childCount;t+=1)if(e.child(t)?.type?.name==="tableHeader")return!0;return!1}catch{return!1}}function vd(e,{direction:t="asc"}={}){try{if(!e?.view)return!1;let n=e.state,r=qt(n);if(!r)return!1;let{tablePos:o,tableNode:i,colIndex:s}=r,a=i.child(0)?.childCount||0,c=i.childCount||0;if(!(a>0&&c>1)||!(s>=0&&s<a)||!ji(i,"\u0442\u0430\u0431\u043B\u0438\u0446\u044B"))return!1;let l=Nm(i.child(0))?i.child(0):null,u=l?1:0,h=[];for(let f=u;f<c;f+=1){let w=i.child(f),x=w.child(s);h.push({rowIndex:f,rowNode:w,key:tu(x)})}let g=t==="desc"?-1:1;h.sort((f,w)=>g*f.key.localeCompare(w.key,void 0,{sensitivity:"base",numeric:!0}));let b=[];l&&b.push(l);for(let f of h)b.push(f.rowNode);let S=i.type.create(i.attrs,b),p=n.tr.replaceWith(o,o+i.nodeSize,S);return p=p.setMeta(ue,!0),e.view.dispatch(p.scrollIntoView()),!0}catch{return!1}}function Td(e,{direction:t="asc"}={}){try{if(!e?.view)return!1;let n=e.state,r=qt(n);if(!r)return!1;let{tablePos:o,tableNode:i,rowIndex:s}=r,a=i.child(0)?.childCount||0,c=i.childCount||0;if(!(a>1&&c>0)||!(s>=0&&s<c)||!ji(i,"\u0442\u0430\u0431\u043B\u0438\u0446\u044B"))return!1;let l=i.child(s),u=[];for(let A=0;A<a;A+=1)u.push({colIndex:A,key:tu(l.child(A))});let h=t==="desc"?-1:1;u.sort((A,I)=>h*A.key.localeCompare(I.key,void 0,{sensitivity:"base",numeric:!0}));let g=u.map(A=>A.colIndex),b=cn(e.view),S=io(b),p=Array.isArray(S)&&S.length===a?g.map(A=>S[A]):null,f=[];for(let A=0;A<c;A+=1){let I=i.child(A),N=g.map(O=>I.child(O));f.push(I.type.create(I.attrs,N))}let w=i.type.create(i.attrs,f),x=n.tr.replaceWith(o,o+i.nodeSize,w);return x=x.setMeta(ue,!0),e.view.dispatch(x.scrollIntoView()),p&&window.requestAnimationFrame(()=>{let A=cn(e.view);so(A,p)}),!0}catch{return!1}}function Mm(e){try{if(!e?.view)return!1;let t=e.state,n=qt(t);if(!n)return!1;let{tablePos:r,tableNode:o,rowIndex:i,colIndex:s}=n,a=o.child(0)?.childCount||0,c=o.childCount||0;if(!(a>0&&c>0)||!(i>=0&&i<c)||!ji(o,"\u0441\u0442\u0440\u043E\u043A"))return!1;let l=o.child(i),u=[];for(let b=0;b<c;b+=1)u.push(o.child(b)),b===i&&u.push(l.type.create(l.attrs,l.content,l.marks));let h=o.type.create(o.attrs,u),g=t.tr.replaceWith(r,r+o.nodeSize,h);g=g.setMeta(ue,!0);try{let b=je?.pmStateMod?.TextSelection;if(b){let S=Math.min(h.childCount-1,i+1),p=Math.min(a-1,Math.max(0,s)),f=h.child(S),w=f.child(p),x=r+1;for(let O=0;O<S;O+=1)x+=h.child(O).nodeSize;x+=1;for(let O=0;O<p;O+=1)x+=f.child(O).nodeSize;let A=x,I=A+1,N=A+w.nodeSize-1;g=g.setSelection(b.near(g.doc.resolve(Math.min(N,I+1)),1))}}catch{}return e.view.dispatch(g.scrollIntoView()),!0}catch{return!1}}function Lm(e){try{if(!e?.view)return!1;let t=e.state,n=qt(t);if(!n)return!1;let{tablePos:r,tableNode:o,rowIndex:i,colIndex:s}=n,a=o.child(0)?.childCount||0,c=o.childCount||0;if(!(a>0&&c>0)||!(s>=0&&s<a)||!ji(o,"\u0441\u0442\u043E\u043B\u0431\u0446\u043E\u0432"))return!1;let l=cn(e.view),u=io(l),h=null;if(Array.isArray(u)&&u.length===a){let p=[...u],f=Math.max(0,Number(p[s]||0)),w=zn(f/2);p[s]=w,p.splice(s+1,0,w);let x=p.reduce((A,I)=>A+(Number.isFinite(I)?I:0),0);x>0&&Math.abs(x-100)>.01&&(p[p.length-1]=zn(p[p.length-1]+(100-x))),h=p}let g=[];for(let p=0;p<c;p+=1){let f=o.child(p),w=[];for(let x=0;x<a;x+=1){let A=f.child(x);w.push(A),x===s&&w.push(A.type.create(A.attrs,A.content,A.marks))}g.push(f.type.create(f.attrs,w))}let b=o.type.create(o.attrs,g),S=t.tr.replaceWith(r,r+o.nodeSize,b);S=S.setMeta(ue,!0);try{let p=je?.pmStateMod?.TextSelection;if(p){let f=Math.min(b.childCount-1,Math.max(0,i)),w=Math.min(a,Math.max(0,s+1)),x=b.child(f),A=x.child(w),I=r+1;for(let H=0;H<f;H+=1)I+=b.child(H).nodeSize;I+=1;for(let H=0;H<w;H+=1)I+=x.child(H).nodeSize;let N=I,O=N+1,U=N+A.nodeSize-1;S=S.setSelection(p.near(S.doc.resolve(Math.min(U,O+1)),1))}}catch{}return e.view.dispatch(S.scrollIntoView()),Array.isArray(h)&&h.length===a+1?window.requestAnimationFrame(()=>{let p=cn(e.view);so(p,h)}):window.requestAnimationFrame(()=>{let p=cn(e.view);$i(p)}),!0}catch{return!1}}function Pm(e,t,n){try{if(!e?.view)return!1;let{state:r,view:o}=e,{selection:i}=r,s=i?.$from||null;if(!s)return!1;let a=n instanceof Set?n:new Set(Array.from(n||[])),c=null;for(let O=s.depth;O>0;O-=1)if(s.node(O)?.type?.name==="paragraph"){let U=s.node(O-1)?.type?.name||"";a.has(U)&&(c=O);break}if(c==null)return!1;let l=c-1,u=s.node(l),h=s.index(l);if(!u)return!1;let g=t<0?-1:1,b=h+g;if(!(b>=0&&b<u.childCount))return!1;let S=u.child(h),p=u.child(b);if(S?.type?.name!=="paragraph"||p?.type?.name!=="paragraph")return!1;let f=s.before(c),w=S.nodeSize,x=g<0?f-p.nodeSize:f+w,A=p.nodeSize,I=Math.max(0,i.from-s.start(c)),N=r.tr;if(g<0){N=N.delete(f,f+w),N=N.insert(x,S);let O=x,U=O+1,H=O+S.nodeSize-1,X=U+I,G=Math.min(Math.max(X,U),H);try{let oe=je?.pmStateMod?.TextSelection;oe&&(N=N.setSelection(oe.near(N.doc.resolve(G),1)))}catch{}}else{N=N.delete(f,f+w);let O=f+A;N=N.insert(O,S);let U=O,H=U+1,X=U+S.nodeSize-1,G=H+I,oe=Math.min(Math.max(G,H),X);try{let xe=je?.pmStateMod?.TextSelection;xe&&(N=N.setSelection(xe.near(N.doc.resolve(oe),1)))}catch{}}return N=N.setMeta(ue,!0),o.dispatch(N.scrollIntoView()),!0}catch{return!1}}function Bd(e,t){return Pm(e,t,new Set(["outlineBody","tableCell","tableHeader"]))}function Nd(e,t){try{if(!e?.view)return!1;let{state:n,view:r}=e,{selection:o}=n,i=o?.$from||null;if(!i)return!1;let s=null;for(let I=i.depth;I>0;I-=1)if(i.node(I)?.type?.name==="listItem"){s=I;break}if(s==null)return!1;let a=s-1,c=i.node(a),l=c?.type?.name||"";if(l!=="bulletList"&&l!=="orderedList")return!1;let u=i.index(a),h=t<0?-1:1,g=u+h;if(!(g>=0&&g<c.childCount))return!1;let b=c.child(u),S=c.child(g);if(b?.type?.name!=="listItem"||S?.type?.name!=="listItem")return!1;let p=i.before(s),f=b.nodeSize,w=S.nodeSize,x=Math.max(0,o.from-i.start(s)),A=n.tr;if(h<0){let I=p-w;A=A.delete(p,p+f),A=A.insert(I,b);let N=I,O=N+1,U=N+b.nodeSize-1,H=O+x,X=Math.min(Math.max(H,O),U);try{let G=je?.pmStateMod?.TextSelection;G&&(A=A.setSelection(G.near(A.doc.resolve(X),1)))}catch{}}else{A=A.delete(p,p+f);let I=p+w;A=A.insert(I,b);let N=I,O=N+1,U=N+b.nodeSize-1,H=O+x,X=Math.min(Math.max(H,O),U);try{let G=je?.pmStateMod?.TextSelection;G&&(A=A.setSelection(G.near(A.doc.resolve(X),1)))}catch{}}return A=A.setMeta(ue,!0),r.dispatch(A.scrollIntoView()),!0}catch{return!1}}function _m(e){if(!V.outlineToolbar||!e)return;let t=V.outlineToolbar,n=null,r={undo:V.outlineUndoBtn,redo:V.outlineRedoBtn,attachBtn:t.querySelector("#outlineAttachBtn"),attachInput:t.querySelector("#outlineAttachInput"),deleteBtn:V.outlineDeleteBtn,moveUpBtn:V.outlineMoveUpBtn,moveDownBtn:V.outlineMoveDownBtn,outdentBtn:V.outlineOutdentBtn,indentBtn:V.outlineIndentBtn,newBelowBtn:V.outlineNewBelowBtn,blocksMenuBtn:t.querySelector("#outlineBlocksMenuBtn"),textMenuBtn:t.querySelector("#outlineTextMenuBtn"),calloutMenuBtn:t.querySelector("#outlineCalloutMenuBtn"),listsMenuBtn:t.querySelector("#outlineListsMenuBtn"),tableMenuBtn:t.querySelector("#outlineTableMenuBtn")},o=new Set(Array.from(t.querySelectorAll(".outline-toolbar__dropdown-btn")));r.blocksMenuBtn&&o.add(r.blocksMenuBtn),r.textMenuBtn&&o.add(r.textMenuBtn),r.calloutMenuBtn&&o.add(r.calloutMenuBtn),r.listsMenuBtn&&o.add(r.listsMenuBtn),r.tableMenuBtn&&o.add(r.tableMenuBtn);let i=Array.from(o),s=Array.from(t.querySelectorAll(".outline-toolbar__menu")),a=Array.from(t.querySelectorAll("[data-outline-action]")),c=Array.from(t.querySelectorAll("[data-outline-clipboard-action]")),l=(W,ce)=>{if(!W)return()=>{};let me=pe=>{pe.preventDefault(),pe.stopPropagation(),ce()};return W.addEventListener("click",me),()=>W.removeEventListener("click",me)},u=(W,ce)=>{W&&(W.classList.toggle("is-active",!!ce),W.setAttribute("aria-pressed",ce?"true":"false"))},h=()=>{for(let W of s)W.classList.add("hidden");for(let W of i)W.setAttribute("aria-expanded","false")},g=()=>{let W=Ba(),ce=!!(W&&Array.isArray(W.sections)&&W.sections.length);for(let me of c)me?.getAttribute?.("data-outline-clipboard-action")==="paste"&&me.toggleAttribute("disabled",!ce)},b=W=>{if(!W)return;let ce=W.getAttribute("aria-controls"),me=ce?t.querySelector(`#${ce}`)||document.getElementById(ce):null;if(!me)return!1;let pe=!me.classList.contains("hidden");return h(),pe||(ce==="outlineBlocksMenu"&&g(),me.classList.remove("hidden"),W.setAttribute("aria-expanded","true")),!0},S="ttree_outline_debug_dropdown_v1",p=()=>{try{return window?.localStorage?.getItem?.(S)==="1"}catch{return!1}},f=(W,ce={})=>{try{if(!p())return;console.log("[outline][dropdown]",W,ce)}catch{}},w=W=>{try{let ce=e.can().chain();return A()&&ce.command(({tr:me})=>(me.setMeta(ue,!0),!0)),W(ce),ce.run()}catch{return!1}},x=W=>{if(!W)return!1;try{let ce=e.chain().focus();if(A()&&ce.command(({tr:me})=>(me.setMeta(ue,!0),!0)),W==="collapseAllBlocks")return Na(e,!0);if(W==="expandAllBlocks")return Na(e,!1);if(W==="toggleBold")return ce.toggleBold().run();if(W==="toggleItalic")return ce.toggleItalic().run();if(W==="toggleStrike")return ce.toggleStrike().run();if(W==="toggleCodeBlock")return e.commands.command(({state:me,dispatch:pe})=>{let fe=me.schema.nodes?.codeBlock||null;if(!fe)return!1;let Ce=me.selection,{from:Be,to:le}=Ce;if(Be===le){let it=me.tr.setMeta(ue,!0);return pe(it),e.commands.toggleCodeBlock()}let Me=Ce.$from?.blockRange?.(Ce.$to)||null;if(!Me){let it=me.tr.setMeta(ue,!0);return pe(it),e.commands.toggleCodeBlock()}if(!Me.parent?.canReplaceWith?.(Me.startIndex,Me.endIndex,fe)){let it=me.tr.setMeta(ue,!0);return pe(it),e.commands.toggleCodeBlock()}let Je=me.doc.textBetween(Me.start,Me.end,`
`,`
`),Ye=String(Je||"").replace(/\n+$/g,"").trimEnd();if(!Ye)return!1;let at=fe.create(null,me.schema.text(Ye)),st=me.tr.replaceRangeWith(Me.start,Me.end,at);return st=st.setMeta(ue,!0),te&&(st=st.setSelection(te.near(st.doc.resolve(Me.start+2),1))),pe(st.scrollIntoView()),!0});if(W==="toggleBlockquote")return ce.toggleBlockquote().run();if(W.startsWith("setCallout:")){try{if(!(Ie?.getState?.(e.state)||null)?.editingSectionId)return Wn(),!1}catch{return Wn(),!1}let me=W.split(":")[1]||"";return e.commands.setCallout(me)}if(W==="unsetCallout"){try{if(!(Ie?.getState?.(e.state)||null)?.editingSectionId)return Wn(),!1}catch{return Wn(),!1}return e.commands.unsetCallout()}if(W==="unsetLink")return ce.unsetLink().run();if(W==="toggleBulletList")return e.isActive("orderedList")?ce.toggleOrderedList().toggleBulletList().run():ce.toggleBulletList().run();if(W==="toggleOrderedList")return e.isActive("bulletList")?ce.toggleBulletList().toggleOrderedList().run():ce.toggleOrderedList().run();if(W==="unsetList")return e.isActive("bulletList")?ce.toggleBulletList().run():e.isActive("orderedList")?ce.toggleOrderedList().run():ce.liftListItem("listItem").run();if(W==="insertTable")return ce.insertTable({rows:2,cols:2,withHeaderRow:!1}).run();if(W==="toggleHeaderRow")return ce.toggleHeaderRow().run();if(W==="toggleHeaderColumn")return ce.toggleHeaderColumn().run();if(W==="addRowBefore")return ce.addRowBefore().run();if(W==="addRowAfter")return ce.addRowAfter().run();if(W==="deleteRow")return ce.deleteRow().run();if(W==="addColumnBefore"){let me=qt(e.state),pe=me?Math.max(0,Number(me.colIndex||0)):0,fe=ce.addColumnBefore().run();return fe&&Ui(e,{insertIndex:pe,newColPct:10}),fe}if(W==="addColumnAfter"){let me=qt(e.state),pe=me?Math.max(0,Number(me.colIndex||0)+1):1,fe=ce.addColumnAfter().run();return fe&&Ui(e,{insertIndex:pe,newColPct:10}),fe}if(W==="deleteColumn"){let me=cn(e.view),pe=io(me),fe=qt(e.state),Ce=fe?Number(fe.colIndex||0):null,Be=pe&&Ce!=null?Xd(pe,Ce):null,le=ce.deleteColumn().run();return le&&Array.isArray(Be)&&window.requestAnimationFrame(()=>{let Me=cn(e.view);so(Me,Be)}),le}return W==="mergeCells"?ce.mergeCells().run():W==="splitCell"?ce.splitCell().run():W==="copyColumn"||W==="pasteColumnAfter"||W==="moveColumnRight"?!1:W==="cancelTable"?N():W==="deleteTable"?ce.deleteTable().run():!1}catch{return!1}},A=()=>{try{return!!(Ie?.getState?.(e.state)||null)?.editingSectionId}catch{return!1}},I=()=>A()?!0:(Wn(),!1),N=()=>{if(!I())return!1;try{let{state:W,view:ce}=e,{schema:me,selection:pe}=W,fe=pe?.$from;if(!fe)return!1;let Ce=null;for(let ee=fe.depth;ee>=0;ee-=1)fe.node(ee)?.type?.name==="table"&&(Ce=ee);if(Ce==null)return!1;let Be=null,le=null;for(let ee=Ce+1;ee<=fe.depth;ee+=1){let ye=fe.node(ee)?.type?.name;if(Be==null&&ye==="tableRow"&&(Be=ee),le==null&&(ye==="tableCell"||ye==="tableHeader")&&(le=ee),Be!=null&&le!=null)break}let Me=fe.before(Ce),Je=W.doc.nodeAt(Me);if(!Je||Je.type?.name!=="table")return!1;let Ye=Be!=null?fe.index(Ce):null,at=Be!=null&&le!=null?fe.index(Be):null,st=null;if(typeof Ye=="number"&&typeof at=="number"){let ee=Je.childCount&&Je.child(0)?.childCount||0;ee>0&&(st=Ye*ee+at)}let it=[],We=0,lt=0;for(let ee=0;ee<Je.childCount;ee+=1){let de=Je.child(ee);for(let ye=0;ye<de.childCount;ye+=1){let Ue=de.child(ye),Pe=[];try{for(let y=0;y<(Ue?.content?.childCount||0);y+=1){let m=Ue.content.child(y);m&&Pe.push(m)}}catch{}Pe.length||Pe.push(me.nodes.paragraph.create(null,[])),st!=null&&We===st&&(lt=it.length),it.push(...Pe),We+=1}}if(!it.length)return!1;let ut=me.nodes.outlineBody?me.nodes.outlineBody.create({},it).content:me.nodes.doc.create({},it).content,ct=W.tr.replaceWith(Me,Me+Je.nodeSize,ut);ct=ct.setMeta(ue,!0);try{let ee=je?.pmStateMod?.TextSelection;if(ee){let de=Me;for(let m=0;m<lt;m+=1)de+=it[m].nodeSize;let ye=null,Ue=Math.min(ct.doc.content.size,de),Pe=Math.min(ct.doc.content.size,de+2e4);ct.doc.nodesBetween(Ue,Pe,(m,B)=>ye!=null?!1:m?.isTextblock?(ye=B+1,!1):!0);let y=ye??Math.min(ct.doc.content.size,de+1);ct=ct.setSelection(ee.near(ct.doc.resolve(y),1))}}catch{}return ce.dispatch(ct.scrollIntoView()),ce.focus?.(),!0}catch{return!1}},O=()=>{if(!I())return!1;try{let{state:W,view:ce}=e,{selection:me}=W,pe=me?.$from;if(!pe)return!1;let fe=null,Ce=null,Be=null;for(let ct=pe.depth;ct>=0;ct-=1){let de=pe.node(ct)?.type?.name;if(Be==null&&(de==="tableCell"||de==="tableHeader")&&(Be=ct),Ce==null&&de==="tableRow"&&(Ce=ct),de==="table"){fe=ct;break}}if(fe==null||Ce==null||Be==null)return!1;let le=pe.before(fe),Me=W.doc.nodeAt(le);if(!Me||Me.type?.name!=="table")return!1;let Je=pe.index(fe),Ye=pe.index(Ce),at=Me.child(0)?.childCount||0;if(!(at>0)||!(Ye>=0&&Ye<at-1))return!1;let st=!1;if(Me.descendants(ct=>{if(st)return!1;let ee=ct?.type?.name;if(ee==="tableCell"||ee==="tableHeader"){let de=Number(ct.attrs?.colspan||1),ye=Number(ct.attrs?.rowspan||1);if(de!==1||ye!==1)return st=!0,!1}return!0}),st)return Ee("\u041F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 \u0441\u0442\u043E\u043B\u0431\u0446\u043E\u0432 \u043F\u043E\u043A\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u0445 \u044F\u0447\u0435\u0435\u043A"),!1;let it=me.from-pe.start(Be),We=[];for(let ct=0;ct<Me.childCount;ct+=1){let ee=Me.child(ct);if(ee.type?.name!=="tableRow"||ee.childCount!==at)return!1;let de=[];for(let ye=0;ye<at;ye+=1)ye===Ye?de.push(ee.child(ye+1)):ye===Ye+1?de.push(ee.child(ye-1)):de.push(ee.child(ye));We.push(ee.type.create(ee.attrs,de))}let lt=Me.type.create(Me.attrs,We),ut=W.tr.replaceWith(le,le+Me.nodeSize,lt);ut=ut.setMeta(ue,!0);try{let ct=je?.pmStateMod?.TextSelection;if(ct){let ee=Math.min(lt.childCount-1,Math.max(0,Je)),de=Ye+1,ye=lt.child(ee),Ue=ye.child(de),Pe=le+1;for(let P=0;P<ee;P+=1)Pe+=lt.child(P).nodeSize;Pe+=1;for(let P=0;P<de;P+=1)Pe+=ye.child(P).nodeSize;let y=Pe,m=y+1,B=y+Ue.nodeSize-1,v=m+Math.max(0,it),R=Math.min(Math.max(v,m),B);ut=ut.setSelection(ct.near(ut.doc.resolve(R),1))}}catch{}return ce.dispatch(ut.scrollIntoView()),ce.focus?.(),!0}catch{return!1}},U=(W,ce,me={})=>{let pe=String(W||"").trim();if(!pe)return!1;let fe=String(ce||"").trim()||pe,{from:Ce,to:Be,empty:le}=e.state.selection,Me={href:pe,...me},Je=e.chain().focus();return A()&&Je.command(({tr:Ye})=>(Ye.setMeta(ue,!0),!0)),!le&&Ce!==Be?Je.setLink(Me).run():Je.insertContent({type:"text",text:fe,marks:[{type:"link",attrs:Me}]}).run()},H=async()=>{if(!I())return;let{from:W,to:ce,empty:me}=e.state.selection,pe=me?"":e.state.doc.textBetween(W,ce," ").trim(),fe="",Ce=pe;try{let le=await(await Promise.resolve().then(()=>(ir(),bs))).showLinkPrompt({title:"\u0421\u0441\u044B\u043B\u043A\u0430 (URL)",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0441\u0441\u044B\u043B\u043A\u0443 (\u043B\u044E\u0431\u043E\u0439 \u0444\u043E\u0440\u043C\u0430\u0442) \u0438 \u0442\u0435\u043A\u0441\u0442 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E).",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",textLabel:"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)",urlLabel:"\u0421\u0441\u044B\u043B\u043A\u0430",defaultText:pe,defaultUrl:"",urlPlaceholder:""});if(!le||typeof le!="object")return;fe=String(le.url||""),Ce=String(le.text??pe)}catch{fe=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0441\u0441\u044B\u043B\u043A\u0443")||"",Ce=pe||window.prompt("\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)")||""}fe=(fe||"").trim(),fe&&U(fe,Ce,{target:"_blank",rel:"noopener noreferrer"})},X=async()=>{if(!I())return;let W=Array.isArray(d.articlesIndex)?d.articlesIndex:[];W.length||(W=await vn().catch(()=>[])||[],Array.isArray(W)&&(d.articlesIndex=W));let ce=(Array.isArray(W)?W:[]).map(it=>({id:it.id,title:it.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),{from:me,to:pe,empty:fe}=e.state.selection,Ce=fe?"":e.state.doc.textBetween(me,pe," ").trim(),Be=!!Ce,le="",Me="",Je=Ce;try{let We=await(await Promise.resolve().then(()=>(ir(),bs))).showArticleLinkPrompt({title:"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E \u0438 \u0437\u0430\u0434\u0430\u0439\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438.",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:ce,defaultTextValue:Ce,lockTextValue:Be});if(We&&typeof We=="object")le=We.articleValue||"",Me=We.selectedId||"",Je=We.textValue||"";else return}catch{le=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438")||"",Je=Ce||window.prompt("\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)")||""}let Ye=(le||"").trim().toLowerCase();if(!Ye&&!Me)return;let at=(Array.isArray(W)?W:[]).find(it=>{let We=(it.title||"").toLowerCase();return Me&&it.id===Me||it.id&&it.id.toLowerCase()===Ye||We===Ye||We.includes(Ye)});if(!at){Ee("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}let st=(Je||"").trim()||at.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";U(an.article(at.id),st,{class:"article-link"})},G=()=>{if(!d.isOutlineEditing||!e||e.isDestroyed)return;let W=A();if(t.dataset.editing=W?"true":"false",n===null?n=W:n!==W&&(h(),n=W),r.deleteBtn&&(r.deleteBtn.hidden=W),r.moveUpBtn&&(r.moveUpBtn.hidden=W),r.moveDownBtn&&(r.moveDownBtn.hidden=W),r.outdentBtn&&(r.outdentBtn.hidden=W),r.indentBtn&&(r.indentBtn.hidden=W),r.newBelowBtn&&(r.newBelowBtn.hidden=W),r.blocksMenuBtn&&(r.blocksMenuBtn.hidden=W),r.attachBtn&&(r.attachBtn.hidden=!W),W&&Zn&&ro(!1),r.undo&&(r.undo.disabled=!w(pe=>pe.undo())),r.redo&&(r.redo.disabled=!w(pe=>pe.redo())),r.textMenuBtn){let pe=e.isActive("bold")||e.isActive("italic")||e.isActive("strike")||e.isActive("codeBlock")||e.isActive("blockquote");u(r.textMenuBtn,pe),r.textMenuBtn.hidden=!W}if(r.listsMenuBtn){let pe=e.isActive("bulletList")||e.isActive("orderedList");u(r.listsMenuBtn,pe),r.listsMenuBtn.hidden=!W}if(r.tableMenuBtn){let pe=e.isActive("table");u(r.tableMenuBtn,pe),r.tableMenuBtn.hidden=!W}if(r.calloutMenuBtn){let pe=e.isActive("callout");u(r.calloutMenuBtn,pe),r.calloutMenuBtn.hidden=!W}let ce=null,me=()=>{if(ce)return ce;let pe={total:0,collapsed:0};try{e.state.doc.descendants(fe=>{fe?.type?.name==="outlineSection"&&(pe.total+=1,fe.attrs?.collapsed&&(pe.collapsed+=1))})}catch{}return ce=pe,pe};for(let pe of a){let fe=pe.dataset.outlineAction||"";if(!fe)continue;let Ce=!1,Be=!1;if(fe==="collapseAllBlocks"){let le=me();Ce=!1,Be=le.total===0||le.collapsed>=le.total}else if(fe==="expandAllBlocks"){let le=me();Ce=!1,Be=le.total===0||le.collapsed<=0}else if(fe==="toggleBold")Ce=e.isActive("bold"),Be=!w(le=>le.toggleBold());else if(fe==="toggleItalic")Ce=e.isActive("italic"),Be=!w(le=>le.toggleItalic());else if(fe==="toggleStrike")Ce=e.isActive("strike"),Be=!w(le=>le.toggleStrike());else if(fe==="toggleCodeBlock")Ce=e.isActive("codeBlock"),Be=!A();else if(fe==="toggleBlockquote")Ce=e.isActive("blockquote"),Be=!w(le=>le.toggleBlockquote());else if(fe.startsWith("setCallout:")){let le=fe.split(":")[1]||"";Ce=e.isActive("callout",{kind:le}),Be=!A()||!w(Me=>Me.setCallout(le))}else fe==="unsetCallout"?(Ce=!1,Be=!A()||!e.isActive("callout")||!w(le=>le.unsetCallout())):fe==="insertHttpLink"||fe==="insertArticleLink"?(Ce=!1,Be=!A()):fe==="unsetLink"?(Ce=e.isActive("link"),Be=!w(le=>le.unsetLink())):fe==="toggleBulletList"?(Ce=e.isActive("bulletList"),e.isActive("orderedList")?Be=!(w(le=>le.toggleOrderedList())&&w(le=>le.toggleBulletList())):Be=!w(le=>le.toggleBulletList())):fe==="toggleOrderedList"?(Ce=e.isActive("orderedList"),e.isActive("bulletList")?Be=!(w(le=>le.toggleBulletList())&&w(le=>le.toggleOrderedList())):Be=!w(le=>le.toggleOrderedList())):fe==="unsetList"?(Ce=!1,e.isActive("bulletList")?Be=!w(le=>le.toggleBulletList()):e.isActive("orderedList")?Be=!w(le=>le.toggleOrderedList()):Be=!w(le=>le.liftListItem("listItem"))):fe==="insertTable"?(Ce=!1,Be=!w(le=>le.insertTable({rows:2,cols:2,withHeaderRow:!1}))):fe==="toggleHeaderRow"?(Ce=e.isActive("tableHeader"),Be=!w(le=>le.toggleHeaderRow())):fe==="toggleHeaderColumn"?(Ce=e.isActive("tableHeader"),Be=!w(le=>le.toggleHeaderColumn())):fe==="addRowBefore"?(Ce=!1,Be=!w(le=>le.addRowBefore())):fe==="addRowAfter"?(Ce=!1,Be=!w(le=>le.addRowAfter())):fe==="deleteRow"?(Ce=!1,Be=!w(le=>le.deleteRow())):fe==="addColumnBefore"?(Ce=!1,Be=!w(le=>le.addColumnBefore())):fe==="addColumnAfter"?(Ce=!1,Be=!w(le=>le.addColumnAfter())):fe==="deleteColumn"?(Ce=!1,Be=!w(le=>le.deleteColumn())):fe==="copyColumn"||fe==="pasteColumnAfter"||fe==="moveColumnRight"?(Ce=!1,Be=!0):fe==="mergeCells"?(Ce=!1,Be=!w(le=>le.mergeCells())):fe==="splitCell"?(Ce=!1,Be=!w(le=>le.splitCell())):fe==="cancelTable"?(Ce=!1,Be=!A()||!e.isActive("table")):fe==="deleteTable"&&(Ce=!1,Be=!w(le=>le.deleteTable()));pe.disabled=!!Be,pe.classList.toggle("is-active",!!Ce)}},oe=null,xe=()=>{oe||(oe=window.requestAnimationFrame(()=>{oe=null,G()}))},ve=[l(r.undo,()=>e.chain().focus().undo().run()),l(r.redo,()=>e.chain().focus().redo().run()),l(r.attachBtn,()=>{if(!I())return;let W=r.attachInput;if(!W){Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0432\u044B\u0431\u043E\u0440 \u0444\u0430\u0439\u043B\u0430");return}try{W.value=""}catch{}try{if(typeof W.showPicker=="function"){W.showPicker();return}}catch{}W.click()})];try{let W=r.attachInput;W&&!W.__ttreeOutlineAttachBound&&(Object.defineProperty(W,"__ttreeOutlineAttachBound",{value:!0}),W.addEventListener("change",()=>{if(!I())return;let ce=Array.from(W.files||[]);if(ce.length){for(let me of ce)if(me)try{Ta(me)?Hd(e.view,me):$d(e.view,me)}catch{}}},{passive:!0}))}catch{}let te=je?.pmStateMod?.TextSelection||null,be=(W,ce)=>{try{let me=W.resolve(Math.min(W.content.size,ce+1)),pe=null;for(let fe=me.depth;fe>0;fe-=1){if(me.node(fe)?.type?.name!=="outlineSection")continue;if(me.before(fe)===ce){pe=fe;break}}if(pe===null)return null;for(let fe=pe-1;fe>0;fe-=1)if(me.node(fe)?.type?.name==="outlineSection")return me.before(fe);return null}catch{return null}},Qe=W=>{try{if(!te)return;e.commands.command(({state:ce,dispatch:me})=>{let pe=Bt(ce.doc,ce.selection.$from);if(typeof pe!="number")return!1;let fe=ce.doc.resolve(pe),Ce=fe.index(),Be=fe.parent;if(!Be)return!1;let le=ce.doc.nodeAt(pe);if(!le)return!1;if(W==="up"){if(Ce>0){let m=Be.child(Ce-1),B=pe-m.nodeSize,v=ce.tr.delete(pe,pe+le.nodeSize).insert(B,le);return v=v.setMeta(ue,!0),v=v.setSelection(te.near(v.doc.resolve(B+2),1)),me(v.scrollIntoView()),!0}let Me=be(ce.doc,pe);if(typeof Me!="number")return!1;let Je=ce.doc.resolve(Me),Ye=Je.index(),at=Je.parent;if(!at||Ye<=0)return!1;let st=at.child(Ye-1),it=Me-st.nodeSize,We=ce.doc.nodeAt(it);if(!We||We.type?.name!=="outlineSection")return!1;let lt=We.child(0),ut=We.child(1),ct=We.child(2),de=it+1+lt.nodeSize+ut.nodeSize+ct.nodeSize-1,ye=ce.tr.delete(pe,pe+le.nodeSize).setMeta(ue,!0),Ue=ye.mapping.map(it,-1),Pe=ye.mapping.map(de,-1);ye=ye.insert(Pe,le);let y=ye.doc.nodeAt(Ue);return y?.type?.name==="outlineSection"&&y.attrs?.collapsed&&(ye=ye.setNodeMarkup(Ue,void 0,{...y.attrs,collapsed:!1})),ye=ye.setSelection(te.near(ye.doc.resolve(Pe+2),1)),me(ye.scrollIntoView()),!0}if(W==="down"){if(Ce<Be.childCount-1){let m=pe+le.nodeSize,B=ce.doc.nodeAt(m);if(!B)return!1;let v=ce.tr.delete(pe,pe+le.nodeSize),R=pe+B.nodeSize;return v=v.insert(R,le),v=v.setMeta(ue,!0),v=v.setSelection(te.near(v.doc.resolve(R+2),1)),me(v.scrollIntoView()),!0}let Me=be(ce.doc,pe);if(typeof Me!="number")return!1;let Je=ce.doc.nodeAt(Me);if(!Je||Je.type?.name!=="outlineSection")return!1;let Ye=ce.doc.resolve(Me),at=Ye.index(),st=Ye.parent;if(!st||at>=st.childCount-1)return!1;let it=Me+Je.nodeSize,We=ce.doc.nodeAt(it);if(!We||We.type?.name!=="outlineSection")return!1;let lt=We.child(0),ut=We.child(1),ct=We.child(2),de=it+1+lt.nodeSize+ut.nodeSize+1,ye=ce.tr.delete(pe,pe+le.nodeSize).setMeta(ue,!0),Ue=ye.mapping.map(it,-1),Pe=ye.mapping.map(de,-1);ye=ye.insert(Pe,le);let y=ye.doc.nodeAt(Ue);return y?.type?.name==="outlineSection"&&y.attrs?.collapsed&&(ye=ye.setNodeMarkup(Ue,void 0,{...y.attrs,collapsed:!1})),ye=ye.setSelection(te.near(ye.doc.resolve(Pe+2),1)),me(ye.scrollIntoView()),!0}return!1})}catch{}},kt=()=>{try{if(!te)return;e.commands.command(({state:W,dispatch:ce})=>{let me=Bt(W.doc,W.selection.$from);if(typeof me!="number")return!1;let pe=W.doc.resolve(me),fe=0;for(let ee=pe.depth;ee>=0;ee-=1)pe.node(ee)?.type?.name==="outlineSection"&&(fe+=1);if(fe>=6)return!1;let Ce=pe.index(),Be=pe.parent;if(!Be||Ce<=0)return!1;let le=W.doc.nodeAt(me);if(!le)return!1;let Me=Be.child(Ce-1),Je=me-Me.nodeSize,Ye=W.doc.nodeAt(Je);if(!Ye)return!1;let at=Ye.child(0),st=Ye.child(1),it=Ye.child(2),lt=Je+1+at.nodeSize+st.nodeSize+it.nodeSize-1,ut=W.tr.delete(me,me+le.nodeSize).insert(lt,le),ct=ut.doc.nodeAt(Je);return ct?.type?.name==="outlineSection"&&ct.attrs?.collapsed&&(ut=ut.setNodeMarkup(Je,void 0,{...ct.attrs,collapsed:!1})),ut=ut.setMeta(ue,!0),ut=ut.setSelection(te.near(ut.doc.resolve(lt+2),1)),ce(ut.scrollIntoView()),!0})}catch{}},Ot=()=>{try{if(!te)return;e.commands.command(({state:W,dispatch:ce})=>{let me=W.selection.$from,pe=null,fe=null;for(let at=me.depth;at>0;at-=1)if(me.node(at)?.type?.name==="outlineSection")if(pe===null)pe=at;else{fe=at;break}if(pe===null||fe===null)return!1;let Ce=me.before(pe),Be=me.before(fe),le=W.doc.nodeAt(Ce);if(!le)return!1;let Me=W.tr.delete(Ce,Ce+le.nodeSize),Je=Me.doc.nodeAt(Be);if(!Je)return!1;let Ye=Be+Je.nodeSize;return Me=Me.insert(Ye,le),Me=Me.setMeta(ue,!0),Me=Me.setSelection(te.near(Me.doc.resolve(Ye+2),1)),ce(Me.scrollIntoView()),!0})}catch{}},ln=()=>{try{if(!te)return;e.commands.command(({state:W,dispatch:ce})=>{let me=Bt(W.doc,W.selection.$from);if(typeof me!="number")return!1;let pe=W.doc.nodeAt(me);if(!pe)return!1;let fe=String(pe.attrs?.id||"").trim(),Ce=W.doc.resolve(me),Be=Ce.index(),le=Ce.parent;if(!le)return!1;let Me=W.doc.type.schema;if(le.childCount<=1){let lt=Me.nodes.outlineSection.create({...pe.attrs,collapsed:!1},[Me.nodes.outlineHeading.create({},[]),Me.nodes.outlineBody.create({},[Me.nodes.paragraph.create({},[])]),Me.nodes.outlineChildren.create({},[])]),ut=W.tr.replaceWith(me,me+pe.nodeSize,lt);ut=ut.setMeta(ue,!0);let ct=lt.child(0),ee=me+1+ct.nodeSize;return ut=ut.setSelection(te.near(ut.doc.resolve(ee+2),1)),ce(ut.scrollIntoView()),!0}fe&&eo(fe);let Je=Be>0,Ye=Je?le.child(Be-1):null,at=Je?me-Ye.nodeSize:null,st=W.tr.delete(me,me+pe.nodeSize);st=st.setMeta(ue,!0);let it=Je&&typeof at=="number"?at:Math.min(st.doc.content.size,me),We=st.doc.nodeAt(it);if(We?.type?.name==="outlineSection"){let lt=We.child(0),ut=We.child(1),ct=it+1+lt.nodeSize;ut.childCount||(st=st.insert(ct+1,Me.nodes.paragraph.create({},[]))),st=st.setSelection(te.near(st.doc.resolve(ct+2),1))}return ce(st.scrollIntoView()),!0})}catch{}},gn=()=>{try{if(!te)return;e.commands.command(({state:W,dispatch:ce})=>{let me=Bt(W.doc,W.selection.$from);if(typeof me!="number")return!1;let pe=W.doc.nodeAt(me);if(!pe)return!1;let fe=W.doc.type.schema,Ce=me+pe.nodeSize,Be=Xt(),le=fe.nodes.outlineSection.create({id:Be,collapsed:!1},[fe.nodes.outlineHeading.create({},[]),fe.nodes.outlineBody.create({},[fe.nodes.paragraph.create({},[])]),fe.nodes.outlineChildren.create({},[])]),Me=W.tr.insert(Ce,le);return Me=Me.setSelection(te.create(Me.doc,Ce+2)),Me=Me.setMeta(ue,!0),Ie&&(Me=Me.setMeta(Ie,{type:"enter",sectionId:Be})),ce(Me.scrollIntoView()),!0})}catch{}};ve.push(l(r.deleteBtn,()=>ln())),ve.push(l(r.moveUpBtn,()=>Qe("up"))),ve.push(l(r.moveDownBtn,()=>Qe("down"))),ve.push(l(r.outdentBtn,()=>Ot())),ve.push(l(r.indentBtn,()=>kt())),ve.push(l(r.newBelowBtn,()=>gn()));let In=0,Pn=W=>{try{return W?.target&&W.target.nodeType===1?W.target:W?.target?.parentElement||null}catch{return null}},Un=W=>{let ce=Pn(W);if(!ce)return null;let me=ce.closest?.(".outline-toolbar__dropdown-btn")||null;return!me||!t.contains(me)?null:me},qn=(W,{source:ce})=>{try{let me=Date.now();if(In&&me-In<700){f("toggle.skip.dedupe",{source:ce,dtMs:me-In});return}let pe=Un(W);if(!pe){f("toggle.skip.no-btn",{source:ce,targetClass:String(Pn(W)?.className||"")});return}if(pe.disabled){f("toggle.skip.disabled",{source:ce,btnId:pe.id||null});return}W?.cancelable&&W.preventDefault(),W.stopPropagation();let fe=b(pe);f("toggle",{source:ce,ok:fe,btnId:pe.id||null,menuId:pe.getAttribute("aria-controls")||null,expanded:pe.getAttribute("aria-expanded")||null}),fe&&(In=me)}catch(me){f("toggle.error",{source:ce,message:String(me?.message||me||"")})}},_n=W=>{try{let ce=String(W?.pointerType||"");if(ce!=="touch"&&ce!=="pen")return}catch{return}qn(W,{source:"pointerdown"})},Dn=W=>{qn(W,{source:"click"})};try{t.addEventListener("pointerdown",_n,!0),ve.push(()=>t.removeEventListener("pointerdown",_n,!0))}catch{}t.addEventListener("click",Dn,!0),ve.push(()=>t.removeEventListener("click",Dn,!0));let Rt=W=>{try{if(!d.isOutlineEditing)return;t.contains(W.target)||h()}catch{}},jt=W=>{try{if(!d.isOutlineEditing)return;t.contains(W.target)||h()}catch{}};try{document.addEventListener("touchstart",Rt,{passive:!0}),ve.push(()=>document.removeEventListener("touchstart",Rt))}catch{}document.addEventListener("click",jt),ve.push(()=>document.removeEventListener("click",jt));for(let W of a)ve.push(l(W,()=>{let ce=W.dataset.outlineAction||"";if(ce==="insertHttpLink"){h(),H().finally(()=>xe());return}if(ce==="insertArticleLink"){h(),X().finally(()=>xe());return}let me=x(ce);h(),me&&xe()}));for(let W of c)ve.push(l(W,()=>{let ce=W.getAttribute("data-outline-clipboard-action")||"";if(!ce)return;h();let me=hn||null,pe=yr instanceof Set?yr:new Set,fe=pe.size?new Set(pe):me?new Set([me]):new Set;if(ce==="toggleSelectMode"){ro(!Zn);return}if(ce==="clear"){Oi(null),Ee("\u0411\u0443\u0444\u0435\u0440 \u043E\u0447\u0438\u0449\u0435\u043D");return}if(ie){if(ce==="copy"||ce==="cut"){if(!fe.size){Ee("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A");return}let Ce=am(ie.state.doc,fe);if(!Ce.length){Ee("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A");return}let Be=Ce.map(Je=>Je.node.toJSON());try{let Je=Ce.map(Ye=>qd(Ye.node)).filter(Boolean).join(`

`);cm(Je)}catch{}if(Oi({mode:ce==="cut"?"cut":"copy",sourceArticleId:bt||d.articleId||null,createdAt:new Date().toISOString(),sections:Be}),ce==="copy"){Ee(`\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${Be.length}`);return}let le=[];for(let Je of Ce){let Ye=gt(ie.state.doc,Je.id),at=typeof Ye=="number"?ie.state.doc.nodeAt(Ye):null;typeof Ye=="number"&&at&&le.push({pos:Ye,size:at.nodeSize})}le.sort((Je,Ye)=>Ye.pos-Je.pos);let Me=ie.state.tr;for(let{pos:Je,size:Ye}of le)Me=Me.delete(Je,Je+Ye);Me=Me.setMeta(ue,!0),ie.view.dispatch(Me.scrollIntoView()),ie.view.focus(),tn=!0,en({delayMs:200}),ro(!1),Ee(`\u0412\u044B\u0440\u0435\u0437\u0430\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${Be.length}`);return}if(ce==="paste"){let Ce=Ba();if(!Ce||!Array.isArray(Ce.sections)||!Ce.sections.length){Ee("\u0411\u0443\u0444\u0435\u0440 \u043F\u0443\u0441\u0442");return}let Be=ie.state,le=Be.doc.content.size;if(me){let We=gt(Be.doc,me),lt=typeof We=="number"?Be.doc.nodeAt(We):null;typeof We=="number"&&lt&&(le=We+lt.nodeSize)}let Me=new Set;try{Be.doc.descendants(We=>{if(We?.type?.name!=="outlineSection")return;let lt=String(We.attrs?.id||"").trim();lt&&Me.add(lt)})}catch{}let Je=[];if(Ce.mode==="copy")for(let We of Ce.sections)Je.push(Ud(We,()=>Xt()));else for(let We of Ce.sections){let lt=String(We?.attrs?.id||"").trim();if(lt&&Me.has(lt)){Ee("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C: \u0431\u043B\u043E\u043A \u0441 \u0442\u0430\u043A\u0438\u043C id \u0443\u0436\u0435 \u0435\u0441\u0442\u044C");return}Je.push(Da(We))}let Ye=Be.doc.type.schema,at=[];for(let We of Je)try{let lt=Ye.nodeFromJSON(We);lt?.type?.name==="outlineSection"&&at.push(lt)}catch{}if(!at.length){Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438");return}let st=Be.tr,it=le;for(let We of at)st=st.insert(it,We),it+=We.nodeSize;st=st.setMeta(ue,!0),ie.view.dispatch(st.scrollIntoView()),ie.view.focus(),tn=!0,en({delayMs:200}),Ce.mode==="cut"&&Oi(null),ro(!1),Ee(`\u0412\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${at.length}`)}}}));let Ct=W=>{d.isOutlineEditing&&(t.contains(W.target)||h())},yt=W=>{d.isOutlineEditing&&W.key==="Escape"&&h()};document.addEventListener("pointerdown",Ct),document.addEventListener("keydown",yt),ve.push(()=>document.removeEventListener("pointerdown",Ct)),ve.push(()=>document.removeEventListener("keydown",yt));let zt=e.on("transaction",xe),En=e.on("selectionUpdate",xe);ve.push(()=>zt?.()),ve.push(()=>En?.());try{let W=ym({setActiveTagKey:ce=>{try{qi?.(ce)}catch{}}});ve.push(()=>W?.())}catch{}xe(),_i=()=>{oe&&(window.cancelAnimationFrame(oe),oe=null);for(let W of ve)try{W()}catch{}}}function Dm(){if(_i)try{_i()}catch{}_i=null}function er(e=""){let t=String(e||"");d.outlineStatusText=t,V.updatedAt&&d.isOutlineEditing&&(V.updatedAt.textContent=t)}function Om(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=r.child(1),s=t+1+o.nodeSize,a=n.tr;if(!i.childCount){let l=n.doc.type.schema;a=a.insert(s+1,l.nodes.paragraph.create({},[]))}let{TextSelection:c}=je?.pmStateMod||{};return c?(a=a.setSelection(c.near(a.doc.resolve(s+2),1)),e.view.dispatch(a.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0):!1}catch{return!1}}function Rm(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=t+1,{TextSelection:s}=je?.pmStateMod||{};if(!s)return!1;let a=i+1,c=i+o.nodeSize-1,l=Math.min(Math.max(a,a),Math.max(a,c)),u=n.tr.setSelection(s.near(n.doc.resolve(l),1));return u=u.setMeta(ue,!0),e.view.dispatch(u.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0}catch{return!1}}function Hm(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=t+1,{TextSelection:s}=je?.pmStateMod||{};if(!s)return!1;let a=i+1,c=i+o.nodeSize-1,l=Math.max(a,c),u=n.tr.setSelection(s.near(n.doc.resolve(l),-1));return u=u.setMeta(ue,!0),e.view.dispatch(u.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0}catch{return!1}}function $m(e,t){try{if(!e)return!1;let n=String(t||"").trim();if(!n)return!1;let r=e.state,o=gt(r.doc,n);if(typeof o!="number")return!1;let i=r.doc.nodeAt(o);if(!i||i.type?.name!=="outlineSection")return!1;if(i.attrs?.collapsed)return Rm(e,o);try{if(!i.child(1)?.childCount)return Hm(e,o)}catch{}return Om(e,o)}catch{return!1}}function Fm(e,t,{block:n="center"}={}){try{let r=String(t||"").trim();if(!e||!r)return!1;let o=e.view;if(!o?.dom?.querySelector)return!1;let i=typeof CSS<"u"&&CSS.escape?CSS.escape(r):r.replace(/"/g,'\\"'),s=()=>{try{let a=o.dom?.querySelector?.(`[data-outline-section][data-section-id="${i}"]`)||o.dom?.querySelector?.(`[data-section-id="${i}"]`);a&&typeof a.scrollIntoView=="function"&&a.scrollIntoView({block:n||"center",inline:"nearest"})}catch{}};try{window.requestAnimationFrame(s)}catch{}try{setTimeout(s,80)}catch{}return!0}catch{return!1}}async function zm(){if(je)return je;if(typeof window>"u")throw new Error("Outline editor is browser-only");let e=vr()?performance.now():0,t=await import("/outline/tiptap.bundle.js");return e&&no("import tiptap.bundle.js",{ms:Math.round(performance.now()-e)}),je={core:t.core,starterKitMod:t.starterKitMod,htmlMod:t.htmlMod,pmStateMod:t.pmStateMod,pmViewMod:t.pmViewMod,pmTablesMod:t.pmTablesMod,linkMod:t.linkMod,imageMod:t.imageMod,mentionMod:t.mentionMod,tableMod:t.tableMod,tableRowMod:t.tableRowMod,tableCellMod:t.tableCellMod,tableHeaderMod:t.tableHeaderMod,uniqueIdMod:t.uniqueIdMod,markdownMod:t.markdownMod},je}function Um({blocks:e,parseHtmlToNodes:t}){let n=i=>Array.isArray(i)&&i.length>0?i:[{type:"paragraph",content:[]}],r=i=>{let s=String(i?.id||Xt()),a=!!i?.collapsed,c=Jn(String(i?.text||"")),l=La(c.titleHtml)||"",u=n(t(c.bodyHtml||"")),h=Array.isArray(i?.children)?i.children:[];return{type:"outlineSection",attrs:{id:s,collapsed:a},content:[{type:"outlineHeading",content:l?[{type:"text",text:l}]:[]},{type:"outlineBody",content:u},{type:"outlineChildren",content:h.map(r)}]}},o=(Array.isArray(e)?e:[]).map(r);return{type:"doc",content:o.length?o:[r({id:Xt(),text:"",collapsed:!1,children:[]})]}}function qm(e){try{let t=String(e||"").trim();if(!t)return null;let n=window?.localStorage?.getItem?.("ttree_outline_last_active_v1")||"{}",r=JSON.parse(n||"{}"),o=r&&typeof r=="object"?r[t]:null;if(!o||typeof o!="object")return null;let i=String(o.sectionId||"").trim();return i?{sectionId:i,collapsed:!!o.collapsed}:null}catch{return null}}function nu(e,t,n){try{let r=String(e||"").trim(),o=String(t||"").trim();if(!r||!o)return!1;let i=window?.localStorage?.getItem?.("ttree_outline_last_active_v1")||"{}",s=JSON.parse(i||"{}"),a=s&&typeof s=="object"?s:{};return a[r]={sectionId:o,collapsed:!!n,savedAt:new Date().toISOString()},window?.localStorage?.setItem?.("ttree_outline_last_active_v1",JSON.stringify(a)),!0}catch{return!1}}function Md(e){try{let t=bt||d.articleId||null;if(!t||!e||e.isDestroyed)return!1;let n=e.state,r=Bt(n.doc,n.selection.$from);if(typeof r!="number")return!1;let o=n.doc.nodeAt(r);if(!o||o.type?.name!=="outlineSection")return!1;let i=String(o.attrs?.id||"").trim();if(!i)return!1;let s=!!o.attrs?.collapsed;return Mi.articleId===t&&Mi.sectionId===i&&Mi.collapsed===s?!1:(Mi={articleId:t,sectionId:i,collapsed:s},nu(t,i,s))}catch{return!1}}function Km(e,{lines:t=4}={}){try{if(!e||e.isDestroyed)return!1;let n=e.view;if(!n||!n.state||!n.dom)return!1;let r=n.state.selection;return!r||typeof r.from!="number"?!1:(Li&&cancelAnimationFrame(Li),Li=requestAnimationFrame(()=>{Li=null;try{let o=n.coordsAtPos(r.from);if(!o||typeof o.bottom!="number")return;let s=(w=>{try{let x=w;for(;x&&x!==document.body&&x!==document.documentElement;){let A=window.getComputedStyle(x),I=String(A.overflowY||"");if((I==="auto"||I==="scroll"||I==="overlay")&&x.scrollHeight>x.clientHeight+2)return x;x=x.parentElement}}catch{}return document.scrollingElement||document.documentElement})(n.dom),a=window.getComputedStyle(n.dom),c=String(a.lineHeight||"").trim(),l=c==="normal"?20:Number.parseFloat(c)||20,u=Math.max(24,l*Math.max(1,Number(t)||4)+12),h=window.innerHeight||0,g=0;if(s&&s!==document.scrollingElement&&s!==document.documentElement&&s!==document.body){let w=s.getBoundingClientRect();g=w.top,h=w.height}if(!h)return;let b=o.bottom-g,S=h-u;if(b<=S)return;let p=b-S,f=Math.max(0,(s.scrollTop||0)+p);s.scrollTop=f}catch{}}),!0)}catch{return!1}}function Bt(e,t){try{if(t?.nodeAfter?.type?.name==="outlineSection")return t.pos}catch{}for(let n=t.depth;n>0;n-=1)if(t.node(n)?.type?.name==="outlineSection")return t.before(n);return null}function Ji(e){if(!e)return"";let t=e.child(0),n=e.child(1),r=Qn(t?.textContent||""),o="";try{o=Qn(n?.textBetween?.(0,n.content.size,`
`,`
`)||"")}catch{o=Qn(n?.textContent||"")}return Qn(`${r}
${o}`)}function Ld(e){if(!e)return"";let t=e.child(1),n="";try{n=Qn(t?.textBetween?.(0,t.content.size,`
`,`
`)||"")}catch{n=Qn(t?.textContent||"")}return n}function Pd(e){if(!Ea||!Ca)return"";let t=[];return e?.content?.forEach?.(o=>{t.push(o.toJSON())}),(Ea({type:"doc",content:t},Ca)||""||"").trim()}function _d(e){try{return Qn(String(e?.textContent||"").replace(/\u00a0/g," ")).trim()}catch{return""}}function Vm(e){try{let t=document.createElement("template");return t.innerHTML=String(e||""),Qn(String(t.content.textContent||"").replace(/\u00a0/g," ")).trim()}catch{return""}}function ru(e){try{if(!e)return null;let t=e.state?.selection||null;if(!t)return null;let n=Number.isFinite(t.anchor)?t.anchor:t.from,r=Number.isFinite(t.head)?t.head:t.to,o=t.$from||null,i=null;try{let s=o?Bt(e.state.doc,o):null;if(typeof s=="number"){let a=e.state.doc.nodeAt(s);i=String(a?.attrs?.id||"")||null}}catch{i=null}return!Number.isFinite(n)||!Number.isFinite(r)?null:{anchor:n,head:r,sectionId:i}}catch{return null}}function ou(e,t,n){try{if(!e?.view||!t)return!1;let{TextSelection:r}=je?.pmStateMod||{};if(!r||!n)return e.view.dispatch(t),!0;let o=t.doc?.content?.size??null;if(!Number.isFinite(o))return e.view.dispatch(t),!0;let i=t.mapping.map(Math.max(0,Math.min(n.anchor,o)),1),s=t.mapping.map(Math.max(0,Math.min(n.head,o)),1);try{t=t.setSelection(r.create(t.doc,i,s))}catch{}return e.view.dispatch(t),!0}catch{try{return e?.view?.dispatch?.(t),!0}catch{return!1}}}function jm(e,t,n,r={}){if(!e||!t)return!1;let o=gt(e.state.doc,t);if(typeof o!="number")return!1;let i=e.state.doc.nodeAt(o);if(!i)return!1;let s=e.state.schema,a=i.child(0),c=o+1,l=String(n||"").replace(/\u00a0/g," ").trim(),u=s.nodes.outlineHeading.create({},l?[s.text(l)]:[]),h=e.state.tr.replaceWith(c,c+a.nodeSize,u).setMeta(ue,!0),g=r?.preserveSelection?ru(e):null;return ou(e,h,g),!0}function Jm(e,t,n,r={}){if(!e||!t||!Ro)return!1;let o=gt(e.state.doc,t);if(typeof o!="number")return!1;let i=e.state.doc.nodeAt(o);if(!i)return!1;let s=i.child(0),a=i.child(1),c=o+1+s.nodeSize,l=e.state.schema,u=[];try{u=Ro(n||"")}catch{u=[]}let h=[];try{h=(Array.isArray(u)?u:[]).map(p=>l.nodeFromJSON(p))}catch{h=[l.nodes.paragraph.create({},[])]}h.length||(h=[l.nodes.paragraph.create({},[])]);let g=l.nodes.outlineBody.create({},h),b=e.state.tr.replaceWith(c,c+a.nodeSize,g).setMeta(ue,!0),S=r?.preserveSelection?ru(e):null;return ou(e,b,S),!0}function _a(e){if(!e)return!0;let t=e.child(0);return!Qn(t?.textContent||"")}function Wm(e,t,n){if(!e||!t)return!1;let r=gt(e.state.doc,t);if(typeof r!="number")return!1;let o=e.state.doc.nodeAt(r);if(!o||!_a(o))return!1;let i=o.child(0),s=r+1,a=s+1,c=s+i.nodeSize-1,l=String(n||"").trim();if(!l)return!1;let u=l.length>200?l.slice(0,200):l,h=e.state.tr.insertText(u,a,c).setMeta(ue,!0);return e.view.dispatch(h),!0}function Ym(e){Pr.clear(),e.descendants(t=>{if(t?.type?.name!=="outlineSection")return;let n=String(t.attrs?.id||"");n&&Pr.set(n,Ji(t))})}function gt(e,t){let n=null;return e.descendants((r,o)=>{if(n!==null)return!1;r?.type?.name==="outlineSection"&&String(r.attrs?.id||"")===String(t||"")&&(n=o)}),n}function Gm(e,t){try{let n=e.doc,r=gt(n,t),o=typeof r=="number"?n.nodeAt(r):null;if(!o)return null;let i=e.schema,s=i.marks?.code||null,a=i.nodes?.codeBlock||null;if(!s||!a)return null;let c=o.child(0),l=o.child(1);if(!c||!l)return null;let h=r+1+c.nodeSize+1,g=[];if(l.descendants((S,p)=>{if(!S||S.type?.name!=="paragraph")return;let f=!1,w=!1,x=!0;for(let N=0;N<S.childCount;N+=1){let O=S.child(N);if(O){if(O.type?.name==="hardBreak"){w=!0;continue}if(O.isText){if(!String(O.text||""))continue;if(!(Array.isArray(O.marks)?O.marks:[]).some(G=>G?.type===s)){x=!1;break}f=!0;continue}x=!1;break}}if(!x||!f||!w)return;let A="";for(let N=0;N<S.childCount;N+=1){let O=S.child(N);if(O){if(O.type?.name==="hardBreak"){A+=`
`;continue}O.isText&&(A+=String(O.text||""))}}if(!A.trim())return;let I=h+p;g.push({from:I,to:I+S.nodeSize,text:A})}),!g.length)return null;let b=e.tr;for(let S=g.length-1;S>=0;S-=1){let{from:p,to:f,text:w}=g[S],x=b.doc.resolve(p),A=x.parent,I=x.index();if(!A?.canReplaceWith?.(I,I+1,a))continue;let N=i.text(w),O=a.create(null,N);b=b.replaceWith(p,f,O)}return b.docChanged?b.setMeta(ue,!0):null}catch{return null}}function iu(e,t,n){if(!e||!t||!n||d.article?.encrypted)return;let r=gt(t,n),o=typeof r=="number"?t.nodeAt(r):null;if(!o||!_a(o))return;let i=Ld(o);if(!i)return;let s=Pa(i),a=Sa.get(n)||null;a?.inFlight||a?.bodyHash!==s&&(Sa.set(n,{bodyHash:s,inFlight:!0}),vc(i).then(c=>{let l=String(c?.title||"").trim();if(!l||l.length>200)return;let u=e.state.doc,h=gt(u,n),g=typeof h=="number"?u.nodeAt(h):null;if(!g||!_a(g))return;let b=Ld(g);if(!(Pa(b)!==s||!Wm(e,n,l))){tn=!0;try{let p=bt||d.articleId||null;p&&(Oa({articleId:p,doc:e.state.doc,sectionId:n,reason:"generate_title"}),er("\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438 \u043D\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044E"))}catch{}en({delayMs:900})}}).catch(()=>{}).finally(()=>{Sa.set(n,{bodyHash:s,inFlight:!1})}))}function Xm(e,t,n){if(!(!e||!t)&&!(!Array.isArray(n)||!n.length)&&!d.article?.encrypted&&!(typeof navigator<"u"&&navigator&&navigator.onLine===!1)){try{if((Ie?.getState?.(e.state)||null)?.editingSectionId)return}catch{}for(let r of n)try{iu(e,t,r)}catch{}}}function Dd(e,t,n){let r=String(n||"").trim(),o=(O,U={})=>Ft("skip",{reason:O,sectionId:r,...U});if(!e||!t||!r){o("missing_args",{hasEditor:!!e,hasDoc:!!t,hasSectionId:!!r});return}if(d.article?.encrypted){o("encrypted_article");return}try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1){o("offline");return}}catch{}let i=gt(t,r),s=typeof i=="number"?t.nodeAt(i):null;if(!s){o("section_not_found",{pos:typeof i=="number"?i:null});return}let a=s.child(0),c=s.child(1),l=_d(a),u=l?`<p>${Oo(l)}</p>`:"",h=Pd(c);if(!u&&!h){o("empty_heading_and_body");return}let g=u?Zr(u):"",b=h?Zr(h):"",S=(O,U)=>{if(!U||O?.inFlight||O?.status==="ok"&&O?.htmlHash===U)return!0;if(O?.status==="error"&&O?.htmlHash===U){let H=Number(O?.lastAttemptAtMs||0)||0;if(Date.now()-H<em)return!0}return!1},p=Qr.get(r)||null,f=Xr.get(r)||null,w=S(p,g),x=S(f,b);if(w&&x){o("already_ok_or_in_flight",{headingHash:g||null,bodyHash:b||null});try{oo.delete(r)}catch{}return}let A=w,I=x,N=()=>{try{A&&I&&oo.delete(r)}catch{}};w||(Ft("start_heading",{sectionId:r,htmlHash:g}),Qr.set(r,{htmlHash:g,inFlight:!0,status:p?.status||"ok",lastAttemptAtMs:Date.now()}),ms(u).then(O=>{if(O&&O.ok===!1){Ft("unavailable_heading",{sectionId:r,reason:String(O.reason||"")}),Qr.set(r,{htmlHash:g,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()});let Qe=Date.now();Qe-Ni>6e4&&(Ni=Qe,Ee("\u041A\u043E\u0440\u0440\u0435\u043A\u0442\u0443\u0440\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 (\u043D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0430 \u043A OpenAI)."));return}let U=String(O?.html||"").trim();if(!U){Ft("skip_apply_heading",{sectionId:r,reason:"empty_corrected_html"});return}let H=Vm(U);if(!H){Ft("skip_apply_heading",{sectionId:r,reason:"empty_corrected_plain"});return}let X=e.state.doc,G=gt(X,r),oe=typeof G=="number"?X.nodeAt(G):null;if(!oe){Ft("skip_apply_heading",{sectionId:r,reason:"section_not_found_current_doc"});return}let xe=_d(oe.child(0)),ve=xe?`<p>${Oo(xe)}</p>`:"";if(Zr(ve)!==g){Ft("skip_apply_heading",{sectionId:r,reason:"heading_changed_since_request"});return}if(Zr(`<p>${Oo(H)}</p>`)===g){Ft("skip_apply_heading",{sectionId:r,reason:"no_changes_from_server"});return}if(!jm(e,r,H,{preserveSelection:!0})){Ft("skip_apply_heading",{sectionId:r,reason:"apply_failed"});return}tn=!0,en({delayMs:900})}).catch(()=>{Ft("error_heading",{sectionId:r,htmlHash:g}),Qr.set(r,{htmlHash:g,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()})}).finally(()=>{(Qr.get(r)||null)?.status!=="error"&&Qr.set(r,{htmlHash:g,inFlight:!1,status:"ok",lastAttemptAtMs:Date.now()}),Ft("done_heading",{sectionId:r,htmlHash:g}),A=!0,N()})),x||(Ft("start",{sectionId:r,htmlHash:b}),Xr.set(r,{htmlHash:b,inFlight:!0,status:f?.status||"ok",lastAttemptAtMs:Date.now()}),ms(h).then(O=>{if(O&&O.ok===!1){Ft("unavailable",{sectionId:r,reason:String(O.reason||"")}),Xr.set(r,{htmlHash:b,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()});let ve=Date.now();ve-Ni>6e4&&(Ni=ve,Ee("\u041A\u043E\u0440\u0440\u0435\u043A\u0442\u0443\u0440\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 (\u043D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0430 \u043A OpenAI)."));return}let U=String(O?.html||"").trim();if(!U){Ft("skip_apply",{sectionId:r,reason:"empty_corrected_html"});return}let H=e.state.doc,X=gt(H,r),G=typeof X=="number"?H.nodeAt(X):null;if(!G){Ft("skip_apply",{sectionId:r,reason:"section_not_found_current_doc"});return}let oe=Pd(G.child(1));if(Zr(oe)!==b){Ft("skip_apply",{sectionId:r,reason:"body_changed_since_request"});return}if(Zr(U)===b){Ft("skip_apply",{sectionId:r,reason:"no_changes_from_server"});return}if(!Jm(e,r,U,{preserveSelection:!0})){Ft("skip_apply",{sectionId:r,reason:"apply_failed"});return}tn=!0,en({delayMs:900})}).catch(()=>{Ft("error",{sectionId:r,htmlHash:b}),Xr.set(r,{htmlHash:b,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()})}).finally(()=>{(Xr.get(r)||null)?.status!=="error"&&Xr.set(r,{htmlHash:b,inFlight:!1,status:"ok",lastAttemptAtMs:Date.now()}),Ft("done",{sectionId:r,htmlHash:b}),I=!0,N()}))}function Br(e,t){if(!t)return!1;let n=gt(e,t);if(typeof n!="number")return!1;let r=e.nodeAt(n);if(!r)return!1;let o=Ji(r),i=Pr.get(t)||"";if(o===i)return!1;_r.add(t);try{oo.add(t)}catch{}return!0}function en({delayMs:e=1200}={}){d.isOutlineEditing&&ie&&(d.isPublicView||bt&&d.articleId&&bt!==d.articleId||(Yn&&clearTimeout(Yn),Yn=setTimeout(()=>{Yn=null,Do()},Math.max(200,e))))}async function Do({force:e=!1}={}){if(d.isOutlineEditing&&ie&&!d.isPublicView&&!(bt&&d.articleId&&bt!==d.articleId)&&!Pi&&!(!e&&!tn&&!_r.size)){Pi=!0,er("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C\u2026");try{try{let t=ie.state,n=Bt(t.doc,t.selection.$from);if(typeof n=="number"){let r=t.doc.nodeAt(n),o=String(r?.attrs?.id||"");o&&Br(t.doc,o)}}catch{}await Qm({silent:!0,mode:"queue"})}finally{Pi=!1}}}async function su(){if(!V.outlineEditor)return;let e=V.outlineEditor.querySelector("#outlineEditorContent");if(!e){Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043C\u043E\u043D\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440");return}if(mc(),Mo)return Mo;pr("outline.mount.start",{outlineArticleId:bt,hadInstance:!!ie,hadTiptap:!!je,mounted:ka}),Mo=(async()=>{let t=vr()?performance.now():0,n=vr()?performance.now():0,{core:r,starterKitMod:o,htmlMod:i,pmStateMod:s,pmViewMod:a}=await zm();n&&no("loadTiptap()",{ms:Math.round(performance.now()-n)});let{Editor:c,Node:l,Extension:u,InputRule:h,mergeAttributes:g}=r,b=o.default||o.StarterKit||o,{generateJSON:S,generateHTML:p}=i,{TextSelection:f}=s,{Plugin:w,PluginKey:x}=s,{Decoration:A,DecorationSet:I}=a,N=je.linkMod.default||je.linkMod.Link||je.linkMod,O=je.imageMod.default||je.imageMod.Image||je.imageMod,U=je.mentionMod?.default||je.mentionMod?.Mention||je.mentionMod,H=je.tableMod.TableKit||je.tableMod.tableKit;Et={TableMap:je.pmTablesMod?.TableMap||null,CellSelection:je.pmTablesMod?.CellSelection||null,moveTableColumn:je.pmTablesMod?.moveTableColumn||null,moveTableRow:je.pmTablesMod?.moveTableRow||null,addRowBefore:je.pmTablesMod?.addRowBefore||null,addRowAfter:je.pmTablesMod?.addRowAfter||null,deleteRow:je.pmTablesMod?.deleteRow||null,addColumnBefore:je.pmTablesMod?.addColumnBefore||null,addColumnAfter:je.pmTablesMod?.addColumnAfter||null,deleteColumn:je.pmTablesMod?.deleteColumn||null,toggleHeaderRow:je.pmTablesMod?.toggleHeaderRow||null,toggleHeaderColumn:je.pmTablesMod?.toggleHeaderColumn||null};let X=je.uniqueIdMod.default||je.uniqueIdMod.UniqueID||je.uniqueIdMod,G=je.markdownMod?.Markdown||je.markdownMod?.default?.Markdown||je.markdownMod?.default||null,oe=y=>{let m=String(y||"").trim();if(!m)return null;let B=m.match(/(\d+(?:\.\d+)?)px/i);if(!B)return null;let v=Number.parseFloat(B[1]);return Number.isFinite(v)?v:null},xe=new x("outlineTagHighlighter"),ve=null,te=u.create({name:"outlineTagSuggestKeys",addProseMirrorPlugins(){return[new w({key:new x("outlineTagSuggestKeys"),props:{handleKeyDown(y,m){try{return ve?.isOpen?.()?!!ve.handleKeyDown?.(m):!1}catch{return!1}}}})]}}),be=(()=>{if(!U||typeof U.extend!="function")return null;let y=()=>{let m=null,B=null,v=[],R=0,P=null,z=null,j=()=>{m||(m=document.createElement("div"),m.className="tt-tag-suggest",B=document.createElement("div"),B.className="tt-tag-suggest__list",m.appendChild(B),document.body.appendChild(m))},D=()=>{try{m?.remove()}catch{}m=null,B=null,v=[],R=0,P=null,ve===z&&(ve=null)},T=C=>{if(!m||!C)return;let L=C();L&&(m.style.left=`${Math.max(8,L.left)}px`,m.style.top=`${Math.max(8,L.bottom+6)}px`)},E=C=>{if(!(!m||!B)&&(P=C||null,v=Array.isArray(C?.items)?C.items:[],B.innerHTML="",v.forEach((L,$)=>{let J=document.createElement("button");J.type="button",J.className=$===R?"tt-tag-suggest__item active":"tt-tag-suggest__item",J.textContent=String(L?.label||L?.key||""),J.addEventListener("pointerdown",K=>{K.preventDefault(),K.stopPropagation(),C.command(L)}),B.appendChild(J)}),!v.length)){let L=document.createElement("div");L.className="tt-tag-suggest__empty",L.textContent="\u041D\u0435\u0442 \u0441\u043E\u0432\u043F\u0430\u0434\u0435\u043D\u0438\u0439",B.appendChild(L)}},k=C=>{let L=v.length;L&&(R=(R+C+L)%L)},M=C=>{if(!C||!m)return!1;if(C.key==="Escape")return C.preventDefault(),C.stopPropagation(),D(),!0;if(C.key===" "||C.code==="Space"){if(!P)return!1;if(!v.length){let $=Lo(P?.query||"");return $?(C.preventDefault(),C.stopPropagation(),P.command({key:$,label:$}),!0):!1}C.preventDefault(),C.stopPropagation();let L=v[R];return L&&P.command(L),!0}if(C.key==="ArrowDown")return C.preventDefault(),C.stopPropagation(),k(1),E(P),!0;if(C.key==="ArrowUp")return C.preventDefault(),C.stopPropagation(),k(-1),E(P),!0;if(C.key==="Enter"){if(!P)return!1;C.preventDefault(),C.stopPropagation();let L=v[R];return L&&P.command(L),!0}return!1};return z={isOpen:()=>!!m,handleKeyDown:M},ve=z,{char:"\\",allowedPrefixes:null,allowSpaces:!1,startOfLine:!1,items:({query:C})=>{let L=String(C||""),$=Lo(L),J=pc(),K=new Map,q=new Map;try{for(let[ge,ke]of J?.counts?.entries?.()||[]){let Se=String(ge||"").trim();Se&&(K.set(Se,Number(ke||0)||0),q.set(Se,String(J?.labelByKey?.get?.(Se)||Se)))}}catch{}for(let[ge,ke]of tr.counts.entries()){let Se=String(ge||"").trim();Se&&(K.has(Se)||K.set(Se,Number(ke||0)||0),q.has(Se)||q.set(Se,String(tr.labelByKey.get(Se)||Se)))}let Z=Array.from(K.entries()).map(([ge,ke])=>({key:ge,label:q.get(ge)||ge,count:ke})).sort((ge,ke)=>(ke.count||0)-(ge.count||0));return($?Z.filter(ge=>String(ge.key||"").includes($)||String(ge.label||"").toLowerCase().includes($.toLowerCase())):Z).slice(0,8)},command:({editor:C,range:L,props:$})=>{try{let J=String($?.key||$?.label||""),K=Hi(J),q=Lo(K);if(!q)return;C.chain().focus().insertContentAt(L,[{type:"tag",attrs:{label:q,key:q}}]).insertContent(" ").run()}catch{}},render:()=>({onStart:C=>{R=0,j(),E(C),T(C.clientRect)},onUpdate:C=>{R=0,j(),E(C),T(C.clientRect)},onKeyDown:C=>M(C?.event),onExit:()=>D()})}};return U.extend({name:"tag",group:"inline",inline:!0,atom:!0,selectable:!1,addAttributes(){return{label:{default:""},key:{default:""}}},parseHTML(){return[{tag:'span[data-tt-tag="1"]'}]},renderText({node:m}){try{return Hi(m?.attrs?.label||m?.attrs?.key||"")||""}catch{return""}},renderHTML({node:m,HTMLAttributes:B}){let v=Hi(m?.attrs?.label||m?.attrs?.key||"")||"",R=Lo(m?.attrs?.key||v)||"";return["span",g(B,{"data-tt-tag":"1","data-tag-key":R,class:"tt-tag"}),v||R||""]}}).configure({suggestion:y()})})(),Qe=u.create({name:"outlineTagHighlighter",addProseMirrorPlugins(){return[new w({key:xe,state:{init:()=>({activeKey:null}),apply:(y,m)=>{let B=y.getMeta(xe);return B&&Object.prototype.hasOwnProperty.call(B,"activeKey")?{activeKey:B.activeKey?String(B.activeKey):null}:m}},props:{decorations(y){let m=xe.getState(y)?.activeKey||null,B=[];return y.doc.descendants((v,R)=>{if(v?.type?.name!=="tag")return;let P=String(v.attrs?.key||"").trim();if(!P)return;let z=m&&P===m?"tt-tag tt-tag--active":"tt-tag";B.push(A.node(R,R+v.nodeSize,{class:z}))}),B.length?I.create(y.doc,B):null}}})]}}),kt=O.extend({inline:!0,group:"inline",addAttributes(){return{...typeof this.parent=="function"?this.parent():{},width:{default:320,parseHTML:m=>{try{let B=m,v=B&&B.classList&&B.classList.contains("resizable-image")?B:B?.closest?.(".resizable-image"),R=oe(v?.style?.width||"");if(R!==null)return Math.round(R);let P=oe(v?.getAttribute?.("style")||"")||oe(B?.getAttribute?.("style")||"");if(P!==null)return Math.round(P);let z=v?.getAttribute?.("data-width")||B?.getAttribute?.("data-width")||"",j=Number.parseFloat(String(z||""));return Number.isFinite(j)&&j>0?Math.round(j):320}catch{return 320}},renderHTML:()=>({})},aspectRatio:{default:null,parseHTML:m=>{try{let B=m,v=B&&B.classList&&B.classList.contains("resizable-image")?B:B?.closest?.(".resizable-image"),R=v?.style?.aspectRatio||v?.getAttribute?.("data-aspect-ratio")||B?.getAttribute?.("data-aspect-ratio")||"",P=Number.parseFloat(String(R||"").replace(",","."));return Number.isFinite(P)&&P>0?P:null}catch{return null}},renderHTML:()=>({})},uploadToken:{default:null,parseHTML:()=>null,renderHTML:()=>({})}}},parseHTML(){return[{tag:"span.resizable-image",getAttrs:y=>{let m=y,B=m?.querySelector?.("img"),v=B?.getAttribute?.("src")||"";if(!v)return!1;let R=B?.getAttribute?.("alt")||"",P=B?.getAttribute?.("title")||"",z=oe(m?.style?.width||"")??320;return{src:v,alt:R,title:P,width:Math.round(z)}}},{tag:"img[src]",getAttrs:y=>{let m=y,B=m?.getAttribute?.("src")||"";if(!B)return!1;let v=m?.getAttribute?.("alt")||"",R=m?.getAttribute?.("title")||"";return{src:B,alt:v,title:R,width:320}}}]},renderHTML({node:y,HTMLAttributes:m}){let B=y?.attrs?.width,v=Number.isFinite(Number(B))?Math.round(Number(B)):320,R=y?.attrs?.aspectRatio,P=Number.isFinite(Number(R))&&Number(R)>0?Number(R):null,z={...m};return delete z.width,delete z.aspectRatio,delete z.uploadToken,z.style=`${String(z.style||"").trim()};width:100%;height:auto;display:block;`.replace(/^;\s*/,""),["span",g({class:"resizable-image",style:`width:${v}px;max-width:100%;${P?`aspect-ratio:${P.toFixed(6)};`:""}`,...P?{"data-aspect-ratio":String(P)}:{}},{}),["span",{class:"resizable-image__inner"},["img",g(z,{draggable:"false"})]],["span",{class:"resizable-image__handle","data-direction":"e","aria-hidden":"true"}]]}});Ea=p,Ca=[b.configure({heading:!1,link:!1}),N.configure({openOnClick:!1,protocols:Ti}),kt,H.configure({table:{resizable:!0}})];let Ot=u.create({name:"outlineImageUpload",addProseMirrorPlugins(){let y=(B,v)=>{let R=[];return Array.from(B||[]).forEach(P=>{if(P.kind!=="file")return;let z=typeof P.getAsFile=="function"?P.getAsFile():null;z&&Ta(z)&&R.push(z)}),!R.length&&v?.length&&Array.from(v).forEach(P=>{Ta(P)&&R.push(P)}),R},m=(B,v,R,P)=>{try{if(!(Ie?.getState?.(B.state)||null)?.editingSectionId)return!1}catch{return!1}let z=y(R,P);if(!z.length)return!1;v.preventDefault(),v.stopPropagation();for(let j of z)Hd(B,j);return!0};return[new w({props:{handleDOMEvents:{paste(B,v){let R=v?.clipboardData?.items||null,P=v?.clipboardData?.files||null;return m(B,v,R,P)},drop(B,v){let R=v?.dataTransfer?.items||null,P=v?.dataTransfer?.files||null;return m(B,v,R,P)}}},view(B){return{update(v,R){try{let P=Ie?.getState?.(R)||{},z=Ie?.getState?.(v.state)||{},j=P.editingSectionId||null,D=z.editingSectionId||null;if(j&&!D){let T=String(j||"").trim(),E=bt||d.articleId||null;if(!T||!E)return;let k=!1;try{let M=gt(v.state.doc,T),C=typeof M=="number"?v.state.doc.nodeAt(M):null;C?.type?.name==="outlineSection"&&(k=!!C.attrs?.collapsed)}catch{}nu(E,T,k);try{let M=gt(v.state.doc,T),C=typeof M=="number"?v.state.doc.nodeAt(M):null;if(!C||C.type?.name!=="outlineSection")return;let L=!Pr.has(T),$=L||Br(v.state.doc,T),J=!1;if($){let q=C.child(0),Z=C.child(1),ae=q?.toJSON?q.toJSON():null,Ae=Z?.toJSON?Z.toJSON():null;if(ae&&Ae){let ge=Vd(ae,Ae);if(ge>zi){Ee(`\u0411\u043B\u043E\u043A \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 (${Math.ceil(ge/1024)} KB). \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C: ${Math.ceil(zi/1024)} KB. \u0420\u0430\u0437\u0431\u0435\u0439\u0442\u0435 \u0431\u043B\u043E\u043A \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E.`);try{let Oe=v.state.tr.setMeta(ue,!0);Oe=Oe.setMeta(Ie,{type:"enter",sectionId:T}),v.dispatch(Oe)}catch{}return}let ke=Date.now(),Se=Kd(E,T);try{pt("outline.enqueue.section_upsert_content",{articleId:E,sectionId:T,seq:Se,bytes:ge,reason:L?"exit_edit_mode_new_section":"exit_edit_mode"})}catch{}J=!0,on("section_upsert_content",{articleId:E,payload:{sectionId:T,headingJson:ae,bodyJson:Ae,seq:Se,clientQueuedAt:ke},coalesceKey:`content:${E}:${T}`})}}let K=!1;if(L||Fn||Ut){let q=Ho(v.state.doc);if(q.length){let Z=null;try{Z=q.filter(ae=>ae&&(ae.parentId==null||ae.parentId==="")&&Number(ae.position)>=0).sort((ae,Ae)=>Number(ae.position)-Number(Ae.position)).slice(0,3).map(ae=>String(ae.sectionId||""))}catch{Z=null}try{pt("outline.enqueue.structure_snapshot",{articleId:E,nodesCount:q.length,reason:L?"exit_edit_mode_new_section":"exit_edit_mode",rootFirst:Z})}catch{}on("structure_snapshot",{articleId:E,payload:{nodes:q},coalesceKey:`structure:${E}`}),K=!0}Fn=!1,Ut&&(clearTimeout(Ut),Ut=null)}try{(J||L)&&(Pr.set(T,Ji(C)),_r.delete(T))}catch{}try{J&&ie&&!ie.isDestroyed&&ie.view===v&&iu(ie,v.state.doc,T)}catch{}(J||K)&&er("\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438 \u043D\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044E")}catch{}}}catch{}}}}})]}}),ln=u.create({name:"outlineImageResize",addProseMirrorPlugins(){return[new w({view(y){let m=null,B=(z,j)=>{try{if((y.state.selection?.node||null)?.type?.name==="image"&&typeof y.state.selection.from=="number")return y.state.selection.from;let T=J=>{if(typeof J!="number")return null;let K=[J,J-1,J+1,J-2,J+2];for(let q of K){if(q<0)continue;if(y.state.doc.nodeAt(q)?.type?.name==="image")return q}return null},E=z?.querySelector?.("img")||null,k=T(y.posAtDOM(z,0));if(typeof k=="number")return k;let M=E?T(y.posAtDOM(E,0)):null;if(typeof M=="number")return M;let C=j&&typeof j.clientX=="number"&&typeof j.clientY=="number"?{left:j.clientX,top:j.clientY}:null,L=C?y.posAtCoords(C):null,$=L&&typeof L.pos=="number"?T(L.pos):null;return typeof $=="number"?$:null}catch{return null}},v=z=>{if(z.button!==0)return;let j=z.target?.closest?.(".resizable-image__handle");if(!j)return;let D=j.closest(".resizable-image");if(!D||!y.dom.contains(D)||!(Ie?.getState?.(y.state)||null)?.editingSectionId)return;let E=B(D,z);if(typeof E!="number")return;let k=y.state.doc.nodeAt(E);if(!k||k.type?.name!=="image")return;z.preventDefault(),z.stopPropagation();let M=D.getBoundingClientRect();m={pos:E,startWidth:M.width,startX:z.clientX,wrapper:D,lastWidth:M.width},D.classList.add("resizable-image--resizing")},R=z=>{if(!m)return;z.preventDefault();let j=z.clientX-m.startX,T=parseFloat(getComputedStyle(document.documentElement).fontSize)||16,E=Math.max(T,document.documentElement.clientWidth-32),k=10,M=m.startWidth+j;M=Math.max(T,Math.min(M,E)),M=Math.round(M/k)*k,M=Math.max(T,Math.min(M,E)),m.lastWidth=M,m.wrapper.style.width=`${Math.round(M)}px`},P=()=>{if(!m)return;let{pos:z,wrapper:j}=m;j.classList.remove("resizable-image--resizing");let D=y.state.doc.nodeAt(z)?.type?.name==="image"?z:B(j,null),T=typeof D=="number"?y.state.doc.nodeAt(D):null;if(T&&T.type?.name==="image"){let k=Number(m.lastWidth||0)||j.getBoundingClientRect().width,M=Math.max(1,Math.round(k/10)*10),C={...T.attrs,width:M},L=y.state.tr.setNodeMarkup(D,void 0,C);L=L.setMeta(ue,!0),y.dispatch(L)}m=null};return y.dom.addEventListener("pointerdown",v),document.addEventListener("pointermove",R),document.addEventListener("pointerup",P),document.addEventListener("pointercancel",P),{destroy(){y.dom.removeEventListener("pointerdown",v),document.removeEventListener("pointermove",R),document.removeEventListener("pointerup",P),document.removeEventListener("pointercancel",P)}}}})]}}),gn=u.create({name:"outlineImagePreview",addProseMirrorPlugins(){return[new w({props:{handleDOMEvents:{click(y,m){try{if((Ie?.getState?.(y.state)||null)?.editingSectionId)return!1;let v=m?.target?.closest?.("img");return v?m.target?.closest?.(".resizable-image__handle")?(m.preventDefault(),!0):(m.preventDefault(),ho(v.src,v.alt||""),!0):!1}catch{return!1}}}}})]}}),In=u.create({name:"outlineMarkdownTablePaste",addProseMirrorPlugins(){let y=(m,B)=>{try{if(!(Ie?.getState?.(m.state)||null)?.editingSectionId)return!1;let R=B?.clipboardData?.getData?.("text/plain")||"";if(An("paste: text/plain",{len:R.length,sample:R.slice(0,200)}),!R)return!1;let P=Ra(R),z=Nr(P);An("paste: parsed",{ok:!!z,lines:P});let j=z?null:Mr(P);if(!z&&!j)return!1;let D=z?{header:z.header,rows:z.rows,withHeader:!0}:{header:null,rows:j.rows,withHeader:!1},T=null;try{T=mr(m.state.schema,D)}catch(k){return An("paste: buildTableNode error",{message:String(k?.message||k||""),stack:String(k?.stack||""),schemaNodes:Object.keys(m.state.schema?.nodes||{})}),!1}if(An("paste: tableNode",{ok:!!T,schemaNodes:Ma()?Object.keys(m.state.schema?.nodes||{}):void 0}),!T)return!1;B.preventDefault(),B.stopPropagation();let E=m.state.tr;m.state.selection.empty||(E=E.deleteSelection());try{E=E.replaceSelectionWith(T,!1)}catch(k){return An("paste: replaceSelectionWith error",{message:String(k?.message||k||""),stack:String(k?.stack||""),selection:{from:m.state.selection?.from,to:m.state.selection?.to,empty:m.state.selection?.empty,$fromParent:m.state.selection?.$from?.parent?.type?.name}}),!1}return E=E.setMeta(ue,!0),m.dispatch(E.scrollIntoView()),!0}catch(v){return An("paste: unexpected error",{message:String(v?.message||v||""),stack:String(v?.stack||"")}),!1}};return[new w({appendTransaction(m,B,v){try{let R=m?.some?.(E=>E?.docChanged),P=null;if(Ie)for(let E of m||[]){let k=E?.getMeta?.(Ie)||null;if(k?.type==="enter"&&k?.sectionId){P=String(k.sectionId);break}}let z=!!P;if(!R&&!z||m.some(E=>E.getMeta?.(ue)))return null;let j=Ie?.getState?.(v)||null,D=P||j?.editingSectionId||null;if(!D)return null;An("appendTransaction: try convert",{didDocChange:R,didEnterEditMode:z,sectionId:D});let T=wm(v,D);if(T)return T;if(Ma()){let E=gt(v.doc,D),k=typeof E=="number"?v.doc.nodeAt(E):null,M=k?k.child(1):null,C=M?M.textContent:"";String(C||"").includes("|")&&An("appendTransaction: saw pipes but no conversion",{sectionId:D})}return Gm(v,D)}catch{return null}},props:{handlePaste(m,B){return y(m,B)},handleDOMEvents:{paste(m,B){return y(m,B)}}}})]}}),Pn=u.create({name:"outlineStructuredSectionPaste",addProseMirrorPlugins(){let y=P=>{let z=String(P||"").trim();if(!z)return{sections:[],startsWithHeading:!1,headingCount:0};if(!/<h[1-6][\s>]/i.test(z))return{sections:[],startsWithHeading:!1,headingCount:0};let j=null;try{j=new DOMParser().parseFromString(z,"text/html")}catch{return{sections:[],startsWithHeading:!1,headingCount:0}}let D=j?.body;if(!D)return{sections:[],startsWithHeading:!1,headingCount:0};let T=!1;try{let C=Array.from(D.childNodes||[]).find(L=>L?.nodeType===1&&String(L?.textContent||"").trim());T=!!(C&&/^H[1-6]$/.test(String(C.nodeName||"")))}catch{T=!1}let E=[],k=null,M=()=>{if(!k)return;let C=document.createElement("div");for(let $ of k.nodes)try{C.appendChild($.cloneNode(!0))}catch{}let L=String(C.innerText||C.textContent||"").trimEnd();E.push({level:k.level,title:k.title,bodyText:L}),k=null};for(let C of Array.from(D.childNodes||[])){let J=(C?.nodeType===1?String(C.nodeName||"").toUpperCase():"").match(/^H([1-6])$/);if(J){M();let K=Number(J[1]),q=String(C.textContent||"").trim();if(!q)continue;k={level:K,title:q,nodes:[]};continue}k&&k.nodes.push(C)}return M(),{sections:E,startsWithHeading:T,headingCount:E.length}},m=P=>{let z=P?.selection?.$from;if(!z)return null;for(let j=z.depth;j>0;j-=1)if(z.node(j)?.type?.name==="outlineSection")return z.before(j);return null},B=(P,z)=>{let j=String(z||"").replace(/\r\n/g,`
`).trimEnd(),D=P.nodes.paragraph;if(!D)return[];let T=P.nodes.hardBreak||P.nodes.hard_break||null,E=C=>{let L=String(C||"").split(`
`),$=[];for(let J=0;J<L.length;J+=1){let K=L[J];J>0&&T&&$.push(T.create()),K&&$.push(P.text(K))}return D.create({},$)};if(!j.trim())return[D.create({},[])];let k=j.split(/\n{2,}/),M=[];for(let C of k){let L=String(C||"").trimEnd();M.push(E(L))}return M.length?M:[D.create({},[])]},v=(P,z)=>{let j=P.nodes.outlineHeading.create({},z.title?[P.text(z.title)]:[]),D=B(P,z.bodyText),T=P.nodes.outlineBody.create({},D),E=(z.children||[]).map(M=>v(P,M)),k=P.nodes.outlineChildren.create({},E);return P.nodes.outlineSection.create({id:z.id,collapsed:!1},[j,T,k])},R=(P,z)=>{try{if(!(Ie?.getState?.(P.state)||null)?.editingSectionId)return!1;let D=z?.clipboardData?.getData?.("text/html")||"",T=z?.clipboardData?.getData?.("text/plain")||"",E=D?y(D):{sections:[],startsWithHeading:!1,headingCount:0},k=!E.sections.length&&T?ua(T):{sections:[],startsWithHeading:!1,headingCount:0},M=E.sections.length?E:k;if(!M.sections.length||!(M.startsWithHeading||M.sections.length>=2))return!1;z.preventDefault(),z.stopPropagation();let L=m(P.state);if(typeof L!="number")return!1;let $=P.state.doc.nodeAt(L);if(!$||$.type?.name!=="outlineSection")return!1;let J=dd(M.sections,{makeId:()=>Xt()});if(!J.length)return!1;let K=P.state.schema,q=J.map(Ae=>v(K,Ae)),Z=P.state.tr,ae=L+$.nodeSize;for(let Ae of q)Z=Z.insert(ae,Ae),ae+=Ae.nodeSize;return Z=Z.setMeta(ue,!0),P.dispatch(Z.scrollIntoView()),!0}catch{return!1}};return[new w({props:{handlePaste(P,z){return R(P,z)},handleDOMEvents:{paste(P,z){return R(P,z)}}}})]}}),Un=(y="")=>{let m=String(y||"").trim();return m?m.startsWith("app:/")||m.startsWith("disk:/")?`/api/yandex/disk/file?path=${encodeURIComponent(m)}`:m:""},qn=u.create({name:"outlineAttachmentUpload",addProseMirrorPlugins(){let y=v=>{let R=String(v?.type||"");return!(R&&R.startsWith("image/"))},m=(v,R)=>{let P=[];try{let z=[];if(R&&typeof R.length=="number")z.push(...Array.from(R||[]));else if(v&&typeof v.length=="number")for(let j of Array.from(v||[])){if(!j||j.kind!=="file")continue;let D=j.getAsFile?.();D&&z.push(D)}for(let j of z)j&&y(j)&&P.push(j)}catch{}return P},B=(v,R,P,z)=>{let j=m(P,z);if(!j.length)return!1;R.preventDefault(),R.stopPropagation();try{if(!(Ie?.getState?.(v.state)||null)?.editingSectionId)return Wn(),!0}catch{return Wn(),!0}for(let D of j)$d(v,D);return!0};return[new w({props:{handleDOMEvents:{drop(v,R){let P=R?.dataTransfer?.items||null,z=R?.dataTransfer?.files||null;return B(v,R,P,z)},paste(v,R){let P=R?.clipboardData?.items||null,z=R?.clipboardData?.files||null;return B(v,R,P,z)}}}})]}}),_n=l.create({name:"doc",topNode:!0,content:"outlineSection+"}),Dn=l.create({name:"outlineChildren",content:"outlineSection*",defining:!0,renderHTML(){return["div",{class:"outline-children","data-outline-children":"true"},0]},parseHTML(){return[{tag:"div[data-outline-children]"}]},addNodeView(){return({node:y})=>{let m=document.createElement("div");m.className="outline-children",m.setAttribute("data-outline-children","true");let B=v=>{let R=!v||v.childCount===0;m.setAttribute("data-empty",R?"true":"false")};return B(y),{dom:m,contentDOM:m,update(v){return!v||v.type?.name!=="outlineChildren"?!1:(B(v),!0)}}}}}),Rt=y=>{try{if(!y||y.childCount===0)return!0;let m=!1;return y.descendants(B=>{if(m)return!1;let v=B?.type?.name;return v==="image"||v==="table"||B.isText&&String(B.text||"").replace(/\u00a0/g," ").trim()?(m=!0,!1):!0}),!m}catch{return!1}},jt=l.create({name:"outlineBody",content:"block*",defining:!0,renderHTML(){return["div",{class:"outline-body","data-outline-body":"true"},0]},parseHTML(){return[{tag:"div[data-outline-body]"}]},addNodeView(){return({node:y})=>{let m=document.createElement("div");m.className="outline-body",m.setAttribute("data-outline-body","true");let B=v=>{let R=Rt(v);m.setAttribute("data-empty",R?"true":"false")};return B(y),{dom:m,contentDOM:m,update(v){return!v||v.type?.name!=="outlineBody"?!1:(B(v),!0)}}}}}),Ct=["note","info","success","warning","danger"],yt=y=>{let m=String(y||"").trim().toLowerCase();return Ct.includes(m)?m:"note"},zt=l.create({name:"callout",group:"block",content:"block+",defining:!0,addAttributes(){return{kind:{default:"note",parseHTML:y=>yt(y?.getAttribute?.("data-kind")),renderHTML:y=>({"data-kind":yt(y?.kind)})}}},parseHTML(){return[{tag:"div[data-tt-callout]"}]},renderHTML({node:y,HTMLAttributes:m}){let B=yt(y?.attrs?.kind),v=String(m?.class||"").trim(),R=`tt-callout tt-callout--${B}${v?` ${v}`:""}`;return["div",{...m,class:R,"data-tt-callout":"1","data-kind":B},0]},addCommands(){return{setCallout:y=>({editor:m,commands:B})=>{let v=yt(y);return m.isActive("callout")?B.updateAttributes("callout",{kind:v}):B.toggleWrap("callout",{kind:v})},unsetCallout:()=>({editor:y,commands:m})=>y.isActive("callout")?m.toggleWrap("callout"):!1}}}),En=l.create({name:"outlineHeading",content:"inline*",defining:!0,renderHTML(){return["div",{class:"outline-heading","data-outline-heading":"true"},0]},parseHTML(){return[{tag:"div[data-outline-heading]"}]},addNodeView(){return({editor:y,getPos:m,node:B})=>{let v=document.createElement("div");v.className="outline-heading",v.setAttribute("data-outline-heading","true");let R=document.createElement("button");R.type="button",R.className="outline-heading__toggle",R.title="\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C/\u0440\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C (Ctrl+\u2190/\u2192), \u0441 \u0434\u0435\u0442\u044C\u043C\u0438 (Ctrl+\u2191/\u2193)",R.setAttribute("aria-label","\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C/\u0440\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C");let P=document.createElement("div");P.className="outline-heading__content";let z=document.createElement("button");z.type="button",z.className="outline-heading__select",z.setAttribute("role","checkbox"),z.setAttribute("aria-checked","false"),z.setAttribute("aria-label","\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0431\u043B\u043E\u043A"),z.textContent="\u2713",z.addEventListener("pointerdown",D=>{D.preventDefault()}),z.addEventListener("click",D=>{if(D.preventDefault(),D.stopPropagation(),!Zn)return;let T=typeof m=="function"?m():null;if(typeof T!="number")return;let E=T-1,k=y.state.doc.nodeAt(E),M=String(k?.attrs?.id||"").trim();M&&sm(M)});let j=()=>{let D=typeof m=="function"?m():null;if(typeof D!="number")return;let T=D-1,E=y.state.doc.nodeAt(T),k=String(E?.attrs?.id||"");k&&v.setAttribute("data-section-id",k),v.dataset.empty=B.content.size===0?"true":"false";let M=y.state.doc.resolve(Math.max(0,T+1)),C=0;for(let $=M.depth;$>=0;$-=1)M.node($)?.type?.name==="outlineSection"&&(C+=1);v.dataset.depth=String(Math.min(6,Math.max(1,C||1)));let L=Zn&&k&&yr.has(k);z.setAttribute("aria-checked",L?"true":"false"),z.style.display=Zn?"inline-flex":"none"};return R.addEventListener("click",D=>{D.preventDefault(),D.stopPropagation();let T=typeof m=="function"?m():null;if(typeof T!="number")return;let E=T-1,k=y.state.doc.nodeAt(E);if(!k)return;let M=!k.attrs?.collapsed,C=y.state.tr.setNodeMarkup(E,void 0,{...k.attrs,collapsed:M});try{M&&Ie&&(Ie.getState(y.state)||{}).editingSectionId&&(C=C.setMeta(Ie,{type:"exit"}))}catch{}C.setMeta(ue,!0),y.view.dispatch(C),y.view.focus()}),v.appendChild(R),v.appendChild(P),v.appendChild(z),j(),{dom:v,contentDOM:P,update:D=>D.type.name!=="outlineHeading"?!1:(B=D,j(),!0)}}}}),W=l.create({name:"outlineSection",group:"block",content:"outlineHeading outlineBody outlineChildren",defining:!0,isolating:!0,draggable:!0,addAttributes(){return{collapsed:{default:!1}}},renderHTML({node:y,HTMLAttributes:m}){let B={...m,class:`outline-section${m?.class?` ${m.class}`:""}`,"data-outline-section":"true","data-section-id":y.attrs.id||"","data-collapsed":y.attrs.collapsed?"true":"false"};return["div",g(B),0]},parseHTML(){return[{tag:"div[data-outline-section]"}]}}),ce=y=>{if(!y)return!0;if((y.textContent||"").replace(/\u00a0/g," ").trim())return!1;if(y.childCount)for(let B=0;B<y.childCount;B+=1){let v=y.child(B);if(v.type?.name!=="paragraph"||(v.textContent||"").replace(/\u00a0/g," ").trim())return!1}return!0},me=y=>{if(!y)return!0;try{let m=y.child(0),B=y.child(1),v=y.child(2);return ce(m)&&ce(B)&&(!v||v.childCount===0)}catch{return!0}},pe=(y,m,B)=>{let v=y.doc.nodeAt(B);if(!v)return!1;let R=String(v.attrs?.id||"").trim(),P=y.doc.resolve(B),z=P.index(),j=P.parent;if(!j)return!1;if(j.childCount<=1){if(j.type?.name==="doc"){let K=y.doc.type.schema,q=K.nodes.outlineSection.create({...v.attrs,collapsed:!1},[K.nodes.outlineHeading.create({},[]),K.nodes.outlineBody.create({},[K.nodes.paragraph.create({},[])]),K.nodes.outlineChildren.create({},[])]),Z=y.tr.replaceWith(B,B+v.nodeSize,q);Z=Z.setMeta(ue,!0);let ae=q.child(0),Ae=B+1+ae.nodeSize;return m(Z.setSelection(f.near(Z.doc.resolve(Ae+2),1)).scrollIntoView()),!0}R&&eo(R);let $=null;try{for(let K=P.depth;K>0;K-=1)if(P.node(K)?.type?.name==="outlineSection"){$=P.before(K);break}}catch{$=null}let J=y.tr.delete(B,B+v.nodeSize);J=J.setMeta(ue,!0);try{if(typeof $=="number"){let K=J.mapping.map($,-1),q=J.doc.nodeAt(K);if(q&&q.type?.name==="outlineSection"){let Z=q.child(0),ae=q.child(1),Ae=K+1+Z.nodeSize;if(!ae.childCount){let ge=J.doc.type.schema;J=J.insert(Ae+1,ge.nodes.paragraph.create({},[]))}J=J.setSelection(f.near(J.doc.resolve(Ae+2),1))}}}catch{}return m(J.scrollIntoView()),!0}let D=z>0,T=z<j.childCount-1,E=D?j.child(z-1):null,k=D?B-E.nodeSize:null,M=B+v.nodeSize;R&&eo(R);let C=y.tr.delete(B,B+v.nodeSize),L=($,J)=>{try{let K=$.doc.nodeAt(J);if(!K||K.type?.name!=="outlineSection")return $;let q=K.child(0),ae=J+1+q.nodeSize-1;return $.setSelection(f.near($.doc.resolve(ae),-1))}catch{return $}};if(T){let $=B<C.doc.content.size?B:M;C.doc.nodeAt($)&&(C=L(C,$))}else D&&typeof k=="number"&&C.doc.nodeAt(k)&&(C=L(C,k));return C=C.setMeta(ue,!0),m(C.scrollIntoView()),!0},fe=(y,m,B)=>{let v=y.doc.nodeAt(B);if(!v)return!1;let R=y.doc.resolve(B),P=R.index(),z=R.parent;if(!z||P<=0)return!1;let j=z.child(P-1),D=B-j.nodeSize,T=v.child(0),E=v.child(1),k=v.child(2),M=y.tr.delete(B,B+v.nodeSize),C=M.doc.nodeAt(D);if(!C)return M=M.setMeta(ue,!0),m(M.scrollIntoView()),!0;let L=M.doc.type.schema,$=C.child(0),J=C.child(1),K=C.child(2),q=[],Z=(T?.textContent||"").replace(/\u00a0/g," ").trim();Z&&q.push(L.nodes.paragraph.create({},[L.text(Z)])),E?.content?.forEach?.(Oe=>{q.push(Oe)});let ae=q.length?L.nodes.outlineBody.create({},q).content:null,Ae=ae?J.content.append(ae):J.content,ge=K.content.append(k.content),ke=L.nodes.outlineSection.create(C.attrs,[$,L.nodes.outlineBody.create({},Ae),L.nodes.outlineChildren.create({},ge)]);M=M.replaceWith(D,D+C.nodeSize,ke);let Se=M.doc.nodeAt(D);if(Se){let Oe=Se.child(0),De=Se.child(1),qe=D+1+Oe.nodeSize+De.nodeSize-1;M=M.setSelection(f.near(M.doc.resolve(qe),-1))}return M=M.setMeta(ue,!0),m(M.scrollIntoView()),!0},Ce=(y,m,B)=>{let v=y.doc.nodeAt(B);if(!v)return!1;let R=y.selection.$from,P=null,z=null;for(let Oe=R.depth;Oe>0;Oe-=1)if(R.node(Oe)?.type?.name==="outlineSection")if(P===null)P=Oe;else{z=Oe;break}if(P===null||z===null)return!1;let j=R.before(z);if(!y.doc.nodeAt(j))return!1;let T=y.doc.type.schema,E=v.child(0),k=v.child(1),M=v.child(2),C=y.tr.delete(B,B+v.nodeSize),L=C.doc.nodeAt(j);if(!L)return C=C.setMeta(ue,!0),m(C.scrollIntoView()),!0;let $=L.child(0),J=L.child(1),K=L.child(2),q=[],Z=(E?.textContent||"").replace(/\u00a0/g," ").trim();Z&&q.push(T.nodes.paragraph.create({},[T.text(Z)])),k?.content?.forEach?.(Oe=>{q.push(Oe)});let ae=q.length?T.nodes.outlineBody.create({},q).content:null,Ae=ae?J.content.append(ae):J.content,ge=M.content.append(K.content),ke=T.nodes.outlineSection.create({...L.attrs,collapsed:!1},[$,T.nodes.outlineBody.create({},Ae),T.nodes.outlineChildren.create({},ge)]);C=C.replaceWith(j,j+L.nodeSize,ke);let Se=C.doc.nodeAt(j);if(Se){let Oe=Se.child(0),De=Se.child(1),qe=j+1+Oe.nodeSize+De.nodeSize-1;C=C.setSelection(f.near(C.doc.resolve(qe),-1))}return C=C.setMeta(ue,!0),m(C.scrollIntoView()),!0},Be=u.create({name:"outlineCommands",addKeyboardShortcuts(){let y=(_,Q)=>{for(let Y=Q.depth;Y>0;Y-=1)if(Q.node(Y)?.type?.name==="outlineSection")return Q.before(Y);return null},m=(_,Q)=>{for(let Y=_.depth;Y>0;Y-=1)if(_.node(Y)?.type?.name===Q)return Y;return null},B=_=>{if(!_)return!0;if((_.textContent||"").replace(/\u00a0/g," ").trim())return!1;if(_.childCount)for(let Y=0;Y<_.childCount;Y+=1){let F=_.child(Y);if(F.type?.name!=="paragraph"||(F.textContent||"").replace(/\u00a0/g," ").trim())return!1}return!0},v=(_,Q)=>{let{selection:Y}=_;if(!Y||Y.empty)return!1;let F=y(_.doc,Y.$from),ne=y(_.doc,Y.$to);if(typeof F!="number"||typeof ne!="number"||F===ne||m(Y.$from,"outlineBody")===null||Y.$to.parent?.type?.name!=="outlineHeading"||Y.$to.parentOffset!==0)return!1;let se=_.doc.nodeAt(F);if(!se)return!1;let we=se.child(0),Te=se.child(1),$e=F+1+we.nodeSize,Ne=$e+1,ze=$e+Te.nodeSize-1,Fe=Math.max(Y.from,Ne),Re=Math.min(Y.to,ze);if(Re<Fe)return!0;let _e=_.tr.delete(Fe,Re),Le=_e.doc.nodeAt($e);if(Le&&Le.content.size===0){let Ve=_e.doc.type.schema;_e=_e.insert(Ne,Ve.nodes.paragraph.create({},[]))}return _e=_e.setSelection(f.near(_e.doc.resolve(Ne+1),1)),Q(_e.scrollIntoView()),!0},R=(_,Q,Y={})=>{let{selection:F}=_;if(!F||F.empty)return!1;let ne=y(_.doc,F.$from),re=y(_.doc,F.$to);if(typeof ne!="number"||typeof re!="number"||ne!==re)return!1;let se=m(F.$from,"outlineHeading"),we=m(F.$to,"outlineHeading");if(se===null||we===null)return!1;let Te=_.doc.nodeAt(ne);if(!Te)return!1;let $e=Te.child(0),Ne=ne+1,ze=Ne+1,Fe=Ne+$e.nodeSize-1;if(F.from<ze||F.to>Fe)return!1;let Re=Math.max(F.from,ze),_e=Math.min(F.to,Fe);if(_e<Re)return!0;if(typeof Y.onClipboard=="function")try{let Ve=_.doc.textBetween(Re,_e,`
`,`
`);Y.onClipboard(Ve)}catch{}let Le=_.tr.delete(Re,_e);return Le=Le.setSelection(f.near(Le.doc.resolve(ze),1)),Q(Le.scrollIntoView()),!0},P=_=>{if(!_)return!0;let Q=_.child(0),Y=_.child(1),F=_.child(2);return B(Q)&&B(Y)&&(!F||F.childCount===0)},z=(_,Q,Y)=>{let F=_.doc.nodeAt(Y);if(!F)return!1;let ne=F.child(0),re=F.child(1),we=Y+1+ne.nodeSize+re.nodeSize-1,Te=_.tr.setSelection(f.near(_.doc.resolve(we),-1));return Q(Te.scrollIntoView()),!0},j=(_,Q,Y)=>{let F=_.doc.nodeAt(Y);if(!F)return!1;let ne=F.child(0),re=Y+1,se=_.tr.setSelection(f.near(_.doc.resolve(re+1),1));return Q(se.scrollIntoView()),!0},D=(_,Q,Y)=>{let F=_.doc.nodeAt(Y);if(!F)return!1;let ne=F.child(0),re=F.child(1);if(!re||re.childCount<=0)return E(_,Q,Y);let we=Y+1+ne.nodeSize+1,Te=null;try{re.descendants((ze,Fe)=>{ze?.isTextblock&&(Te=Fe)})}catch{Te=null}if(typeof Te!="number")return z(_,Q,Y);let $e=we+Te+1,Ne=_.tr.setSelection(f.near(_.doc.resolve($e),1));return Q(Ne.scrollIntoView()),!0},T=(_,Q,Y)=>{let F=_.doc.nodeAt(Y);return F?F.attrs?.collapsed?j(_,Q,Y):D(_,Q,Y):!1},E=(_,Q,Y)=>{let F=_.doc.nodeAt(Y);if(!F)return!1;let ne=F.child(0),re=F.child(1),se=Y+1+ne.nodeSize,we=_.tr;if(!re.childCount){let Te=_.doc.type.schema;we=we.insert(se+1,Te.nodes.paragraph.create({},[]))}return we=we.setSelection(f.near(we.doc.resolve(se+2),1)),Q(we.scrollIntoView()),!0},k=(_,Q,Y)=>{let F=_.doc.nodeAt(Y);if(!F)return!1;let ne=F.child(0),re=F.child(1);if(!!F.attrs?.collapsed){let ze=Y+1+ne.nodeSize-1,Fe=_.tr.setSelection(f.near(_.doc.resolve(ze),-1));return Q(Fe),!0}let Te=Y+1+ne.nodeSize+re.nodeSize-1,$e=_.tr.setSelection(f.near(_.doc.resolve(Te),-1));return Q($e),!0},M=(_,Q)=>{try{let Y=_.resolve(Math.min(_.content.size,Math.max(0,Q+1)));for(let F=Y.depth;F>0;F-=1){let ne=Y.node(F);if(!(ne?.type?.name!=="outlineSection"||Y.before(F)===Q)&&ne.attrs?.collapsed)return!1}return!0}catch{return!0}},C=(_,Q)=>{let Y=null;return _.nodesBetween(0,Q,(F,ne)=>{if(ne>=Q)return!1;F?.type?.name==="outlineSection"&&M(_,ne)&&(Y=ne)}),Y},L=(_,Q,Y)=>{let F=_.doc.nodeAt(Y);if(!F)return!1;let ne=String(F.attrs?.id||"").trim(),re=_.doc.resolve(Y),se=re.index(),we=re.parent;if(!we)return!1;if(we.childCount<=1){if(we.type?.name==="doc"){let Le=_.doc.type.schema,Ve=Le.nodes.outlineSection.create({...F.attrs,collapsed:!1},[Le.nodes.outlineHeading.create({},[]),Le.nodes.outlineBody.create({},[Le.nodes.paragraph.create({},[])]),Le.nodes.outlineChildren.create({},[])]),rt=_.tr.replaceWith(Y,Y+F.nodeSize,Ve);rt=rt.setMeta(ue,!0);let Ge=Ve.child(0),tt=Y+1+Ge.nodeSize;return Q(rt.setSelection(f.near(rt.doc.resolve(tt+2),1)).scrollIntoView()),!0}let Re=null;try{for(let Le=re.depth;Le>0;Le-=1)if(re.node(Le)?.type?.name==="outlineSection"){Re=re.before(Le);break}}catch{Re=null}let _e=_.tr.delete(Y,Y+F.nodeSize);_e=_e.setMeta(ue,!0);try{if(typeof Re=="number"){let Le=_e.mapping.map(Re,-1),Ve=_e.doc.nodeAt(Le);if(Ve&&Ve.type?.name==="outlineSection"){let rt=Ve.child(0),Ge=Ve.child(1),tt=Le+1+rt.nodeSize;if(!Ge.childCount){let mt=_e.doc.type.schema;_e=_e.insert(tt+1,mt.nodes.paragraph.create({},[]))}_e=_e.setSelection(f.near(_e.doc.resolve(tt+2),1))}}}catch{}return Q(_e.scrollIntoView()),!0}ne&&eo(ne);let Te=se>0,$e=Te?we.child(se-1):null,Ne=Te?Y-$e.nodeSize:null,ze=Y+F.nodeSize,Fe=_.tr.delete(Y,Y+F.nodeSize);if(Te&&typeof Ne=="number"){let Re=Fe.doc.nodeAt(Ne);if(Re){let _e=Re.child(0),Le=Re.child(1),Ve=Ne+1+_e.nodeSize;if(!Le.childCount){let rt=Fe.doc.type.schema;Fe=Fe.insert(Ve+1,rt.nodes.paragraph.create({},[]))}Fe=Fe.setSelection(f.near(Fe.doc.resolve(Ve+2),1))}}else{let Re=Y<Fe.doc.content.size?Y:ze,_e=Fe.doc.nodeAt(Re);if(_e){let Le=_e.child(0),Ve=_e.child(1),rt=Re+1+Le.nodeSize;if(!Ve.childCount){let Ge=Fe.doc.type.schema;Fe=Fe.insert(rt+1,Ge.nodes.paragraph.create({},[]))}Fe=Fe.setSelection(f.near(Fe.doc.resolve(rt+2),1))}}return Fe=Fe.setMeta(ue,!0),Q(Fe.scrollIntoView()),!0},$=(_,Q,Y)=>{let F=_.doc.nodeAt(Y);if(!F)return!1;let ne=String(F.attrs?.id||"").trim(),re=_.doc.resolve(Y),se=re.index(),we=re.parent;if(!we||se<=0)return!1;ne&&eo(ne);let Te=we.child(se-1),$e=Y-Te.nodeSize,Ne=F.child(0),ze=F.child(1),Fe=F.child(2),Re=_.tr.delete(Y,Y+F.nodeSize),_e=Re.doc.nodeAt($e);if(!_e)return Re=Re.setMeta(ue,!0),Q(Re.scrollIntoView()),!0;let Le=Re.doc.type.schema,Ve=_e.child(0),rt=_e.child(1),Ge=_e.child(2),tt=Number(rt?.content?.size||0)||0,mt=[],ft=(Ne?.textContent||"").replace(/\u00a0/g," ").trim();ft&&mt.push(Le.nodes.paragraph.create({},[Le.text(ft)])),ze?.content?.forEach?.(Nt=>{mt.push(Nt)});let Lt=mt.length?Le.nodes.outlineBody.create({},mt).content:null,vt=Lt?rt.content.append(Lt):rt.content,Qt=Ge.content.append(Fe.content),xt=Le.nodes.outlineSection.create(_e.attrs,[Ve,Le.nodes.outlineBody.create({},vt),Le.nodes.outlineChildren.create({},Qt)]);Re=Re.replaceWith($e,$e+_e.nodeSize,xt);let Wt=Re.doc.nodeAt($e);if(Wt){let Nt=Wt.child(0),yn=Wt.child(1),Zt=$e+1+Nt.nodeSize+1+tt,dn=Math.min(Re.doc.content.size,Math.max(0,Zt+1));Re=Re.setSelection(f.near(Re.doc.resolve(dn),1))}return Re=Re.setMeta(ue,!0),Q(Re.scrollIntoView()),!0},J=(_,Q,Y)=>{let F=_.doc.nodeAt(Y);if(!F)return!1;let ne=String(F.attrs?.id||"").trim(),re=_.selection.$from,se=null,we=null;for(let Nt=re.depth;Nt>0;Nt-=1)if(re.node(Nt)?.type?.name==="outlineSection")if(se===null)se=Nt;else{we=Nt;break}if(se===null||we===null)return!1;let Te=re.before(we);if(!_.doc.nodeAt(Te))return!1;let Ne=_.doc.type.schema,ze=F.child(0),Fe=F.child(1),Re=F.child(2);ne&&eo(ne);let _e=_.tr.delete(Y,Y+F.nodeSize),Le=_e.doc.nodeAt(Te);if(!Le)return _e=_e.setMeta(ue,!0),Q(_e.scrollIntoView()),!0;let Ve=Le.child(0),rt=Le.child(1),Ge=Le.child(2),tt=Number(rt?.content?.size||0)||0,mt=[],ft=(ze?.textContent||"").replace(/\u00a0/g," ").trim();ft&&mt.push(Ne.nodes.paragraph.create({},[Ne.text(ft)])),Fe?.content?.forEach?.(Nt=>{mt.push(Nt)});let Lt=mt.length?Ne.nodes.outlineBody.create({},mt).content:null,vt=Lt?rt.content.append(Lt):rt.content,Qt=Re.content.append(Ge.content),xt=Ne.nodes.outlineSection.create({...Le.attrs,collapsed:!1},[Ve,Ne.nodes.outlineBody.create({},vt),Ne.nodes.outlineChildren.create({},Qt)]);_e=_e.replaceWith(Te,Te+Le.nodeSize,xt);let Wt=_e.doc.nodeAt(Te);if(Wt){let Nt=Wt.child(0),ht=Te+1+Nt.nodeSize+1+tt,Zt=Math.min(_e.doc.content.size,Math.max(0,ht+1));_e=_e.setSelection(f.near(_e.doc.resolve(Zt),1))}return _e=_e.setMeta(ue,!0),Q(_e.scrollIntoView()),!0},K=(_,Q,Y)=>{let F=_.doc.nodeAt(Y);if(!F)return!1;let ne=_.doc.resolve(Y),re=ne.index(),se=ne.parent;if(!se||re>=se.childCount-1)return!1;let we=Y+F.nodeSize,Te=_.doc.nodeAt(we);if(!Te||Te.type?.name!=="outlineSection")return!1;let $e=_.doc.type.schema,Ne=F.child(0),ze=F.child(1),Fe=F.child(2),Re=Te.child(1),_e=Te.child(2),Le=ze.content.append(Re.content),Ve=Fe.content.append(_e.content),rt=$e.nodes.outlineSection.create({...F.attrs,collapsed:!1},[Ne,$e.nodes.outlineBody.create({},Le),$e.nodes.outlineChildren.create({},Ve)]),Ge=_.tr;Ge=Ge.delete(we,we+Te.nodeSize),Ge=Ge.replaceWith(Y,Y+F.nodeSize,rt);let tt=Ge.doc.nodeAt(Y);if(tt){let mt=tt.child(0),ft=tt.child(1),vt=Y+1+mt.nodeSize+ft.nodeSize-1;Ge=Ge.setSelection(f.near(Ge.doc.resolve(vt),-1))}return Ge=Ge.setMeta(ue,!0),Q(Ge.scrollIntoView()),!0},q=_=>this.editor.commands.command(({state:Q,dispatch:Y})=>{let F=Re=>{try{if(typeof CSS<"u"&&CSS&&typeof CSS.escape=="function")return CSS.escape(String(Re||""))}catch{}return String(Re||"").replace(/["\\]/g,"\\$&")},ne=Re=>{try{let _e=Re;for(;_e&&_e!==document.body;){let Le=_e.parentElement;if(!Le)break;let Ve=window.getComputedStyle(Le),rt=String(Ve?.overflowY||"");if((rt==="auto"||rt==="scroll")&&Le.scrollHeight>Le.clientHeight+1)return Le;_e=Le}}catch{}return document.scrollingElement||document.documentElement},re=Re=>{try{let _e=String(Re||"").trim();if(!_e)return null;let Le=document.querySelector(`.outline-heading[data-section-id="${F(_e)}"]`);if(!Le)return null;let Ve=ne(Le);return{sid:_e,scrollEl:Ve,top:Le.getBoundingClientRect().top}}catch{return null}},se=Re=>{if(!Re)return;let{sid:_e,scrollEl:Le,top:Ve}=Re,rt=()=>{try{let Ge=document.querySelector(`.outline-heading[data-section-id="${F(_e)}"]`);if(!Ge)return;let mt=Ge.getBoundingClientRect().top-Ve;if(!Number.isFinite(mt)||Math.abs(mt)<1)return;Le.scrollTop+=mt}catch{}};try{requestAnimationFrame(()=>requestAnimationFrame(rt))}catch{setTimeout(rt,0)}},we=y(Q.doc,Q.selection.$from);if(typeof we!="number")return!1;let Te=Q.doc.resolve(we),$e=Te.index(),Ne=Te.parent;if(!Ne)return!1;let ze=Q.doc.nodeAt(we);if(!ze)return!1;let Fe=re(String(ze.attrs?.id||"").trim());if(_==="up"){if($e>0){let Zt=Ne.child($e-1),dn=we-Zt.nodeSize,dt=Q.tr.delete(we,we+ze.nodeSize).insert(dn,ze).setMeta(ue,!0),nn=f.near(dt.doc.resolve(dn+2),1);return dt.setSelection(nn),Y(dt.scrollIntoView()),se(Fe),!0}let Re=De(Q.doc,we);if(typeof Re!="number")return!1;let _e=Q.doc.resolve(Re),Le=_e.index(),Ve=_e.parent;if(!Ve||Le<=0)return!1;let rt=Ve.child(Le-1),Ge=Re-rt.nodeSize,tt=Q.doc.nodeAt(Ge);if(!tt||tt.type?.name!=="outlineSection")return!1;let mt=tt.child(0),ft=tt.child(1),Lt=tt.child(2),Qt=Ge+1+mt.nodeSize+ft.nodeSize+Lt.nodeSize-1,xt=Q.tr.delete(we,we+ze.nodeSize).setMeta(ue,!0),Wt=xt.mapping.map(Ge,-1),Nt=xt.mapping.map(Qt,-1);xt=xt.insert(Nt,ze);let yn=xt.doc.nodeAt(Wt);yn?.type?.name==="outlineSection"&&yn.attrs?.collapsed&&(xt=xt.setNodeMarkup(Wt,void 0,{...yn.attrs,collapsed:!1}));let ht=f.near(xt.doc.resolve(Nt+2),1);return xt.setSelection(ht),Y(xt.scrollIntoView()),se(Fe),!0}if(_==="down"){if($e<Ne.childCount-1){let Zt=we+ze.nodeSize,dn=Q.doc.nodeAt(Zt);if(!dn)return!1;let dt=Q.tr.delete(we,we+ze.nodeSize).setMeta(ue,!0),nn=we+dn.nodeSize;dt.insert(nn,ze);let br=f.near(dt.doc.resolve(nn+2),1);return dt.setSelection(br),Y(dt.scrollIntoView()),se(Fe),!0}let Re=De(Q.doc,we);if(typeof Re!="number")return!1;let _e=Q.doc.nodeAt(Re);if(!_e||_e.type?.name!=="outlineSection")return!1;let Le=Q.doc.resolve(Re),Ve=Le.index(),rt=Le.parent;if(!rt||Ve>=rt.childCount-1)return!1;let Ge=Re+_e.nodeSize,tt=Q.doc.nodeAt(Ge);if(!tt||tt.type?.name!=="outlineSection")return!1;let mt=tt.child(0),ft=tt.child(1),Lt=tt.child(2),Qt=Ge+1+mt.nodeSize+ft.nodeSize+1,xt=Q.tr.delete(we,we+ze.nodeSize).setMeta(ue,!0),Wt=xt.mapping.map(Ge,-1),Nt=xt.mapping.map(Qt,-1);xt=xt.insert(Nt,ze);let yn=xt.doc.nodeAt(Wt);yn?.type?.name==="outlineSection"&&yn.attrs?.collapsed&&(xt=xt.setNodeMarkup(Wt,void 0,{...yn.attrs,collapsed:!1}));let ht=f.near(xt.doc.resolve(Nt+2),1);return xt.setSelection(ht),Y(xt.scrollIntoView()),se(Fe),!0}return!1}),Z=()=>this.editor.commands.command(({state:_,dispatch:Q})=>{let{selection:Y}=_;if(!Y?.empty)return!1;let{$from:F}=Y,ne=y(_.doc,F);if(typeof ne!="number")return!1;let re=_.doc.nodeAt(ne);if(!re)return!1;let se=_.doc.type.schema;if(re.attrs?.collapsed){let ht=ne+re.nodeSize,Zt=Xt(),dn=se.nodes.outlineSection.create({id:Zt,collapsed:!1},[se.nodes.outlineHeading.create({},[]),se.nodes.outlineBody.create({},[se.nodes.paragraph.create({},[])]),se.nodes.outlineChildren.create({},[])]),dt=_.tr.insert(ht,dn);return dt=dt.setSelection(f.create(dt.doc,ht+2)),dt=dt.setMeta(ue,!0),Ie&&(dt=dt.setMeta(Ie,{type:"enter",sectionId:Zt})),Q(dt.scrollIntoView()),!0}let we=se.nodes.outlineChildren.create({},[]),Te=ht=>ht&&ht.childCount?ht:se.nodes.outlineBody.create({},[se.nodes.paragraph.create({},[])]);if(F.parent?.type?.name==="outlineHeading"){let ht=re.child(0),Zt=re.child(1),dn=re.child(2),dt=F.parentOffset||0,nn=ht.textBetween(0,Math.max(0,Math.min(dt,ht.content.size)),"",""),br=ht.textBetween(Math.max(0,Math.min(dt,ht.content.size)),ht.content.size,"",""),lu=se.nodes.outlineHeading.create({},nn?[se.text(nn)]:[]),du=se.nodes.outlineHeading.create({},br?[se.text(br)]:[]),Ha=Xt(),$a=se.nodes.outlineSection.create({...re.attrs,collapsed:!1},[lu,Te(se.nodes.outlineBody.create({},[])),we]),uu=se.nodes.outlineSection.create({id:Ha,collapsed:!1},[du,Te(Zt),dn]),On=_.tr.replaceWith(ne,ne+re.nodeSize,$a),Fa=On.doc.nodeAt(ne),za=ne+(Fa?Fa.nodeSize:$a.nodeSize);return On=On.insert(za,uu),On=On.setSelection(f.create(On.doc,za+2)),On=On.setMeta(ue,!0),Ie&&(On=On.setMeta(Ie,{type:"enter",sectionId:Ha})),Q(On.scrollIntoView()),!0}if(m(F,"outlineBody")===null||!F.parent?.isTextblock)return!1;let Ne=_.tr,ze=Y.from;try{Ne=Ne.split(ze)}catch{return!1}let Fe=Ne.mapping.map(ze);try{Ne=Ne.setSelection(f.near(Ne.doc.resolve(Math.min(Ne.doc.content.size,Fe+1)),1))}catch{}let Re=Ne.selection.$from,_e=m(Re,"outlineBody"),Le=m(Re,"paragraph");if(_e===null||Le===null)return!1;let Ve=Re.before(Le),rt=Re.end(_e);if(typeof Ve!="number"||typeof rt!="number"||rt<Ve)return!1;let Ge=Ne.doc.slice(Ve,rt).content;Ne=Ne.delete(Ve,rt);let tt=Ne.mapping.map(ne,-1),mt=Ne.doc.nodeAt(tt);if(!mt)return Q(Ne.scrollIntoView()),!0;let ft=mt.child(0),Lt=Te(mt.child(1)),vt=mt.child(2),Qt=se.nodes.outlineSection.create({...mt.attrs,collapsed:!1},[ft,Lt,we]),xt=Ge&&Ge.childCount?se.nodes.outlineBody.create({},Ge):se.nodes.outlineBody.create({},[se.nodes.paragraph.create({},[])]),Wt=Xt(),Nt=se.nodes.outlineSection.create({id:Wt,collapsed:!1},[se.nodes.outlineHeading.create({},[]),xt,vt]);Ne=Ne.replaceWith(tt,tt+mt.nodeSize,Qt);let yn=tt+Qt.nodeSize;return Ne=Ne.insert(yn,Nt),Ne=Ne.setSelection(f.create(Ne.doc,yn+2)),Ne=Ne.setMeta(ue,!0),Ie&&(Ne=Ne.setMeta(Ie,{type:"enter",sectionId:Wt})),Q(Ne.scrollIntoView()),!0}),ae=()=>this.editor.commands.command(({state:_,dispatch:Q})=>{let Y=y(_.doc,_.selection.$from);if(typeof Y!="number")return!1;let F=_.doc.resolve(Y),ne=0;for(let tt=F.depth;tt>=0;tt-=1)F.node(tt)?.type?.name==="outlineSection"&&(ne+=1);if(ne>=6)return!1;let re=F.index(),se=F.parent;if(!se||re<=0)return!1;let we=_.doc.nodeAt(Y);if(!we)return!1;let Te=se.child(re-1),$e=Y-Te.nodeSize,Ne=_.doc.nodeAt($e);if(!Ne)return!1;let ze=Ne.child(0),Fe=Ne.child(1),Re=Ne.child(2),Le=$e+1+ze.nodeSize+Fe.nodeSize+Re.nodeSize-1,Ve=_.tr.delete(Y,Y+we.nodeSize).insert(Le,we).setMeta(ue,!0),rt=Ve.doc.nodeAt($e);rt?.type?.name==="outlineSection"&&rt.attrs?.collapsed&&(Ve=Ve.setNodeMarkup($e,void 0,{...rt.attrs,collapsed:!1}));let Ge=f.near(Ve.doc.resolve(Le+2),1);return Ve.setSelection(Ge),Q(Ve.scrollIntoView()),!0}),Ae=()=>this.editor.commands.command(({state:_,dispatch:Q})=>{let Y=_.selection.$from,F=null,ne=null;for(let Fe=Y.depth;Fe>0;Fe-=1)if(Y.node(Fe)?.type?.name==="outlineSection")if(F===null)F=Fe;else{ne=Fe;break}if(F===null||ne===null)return!1;let re=Y.before(F),se=Y.before(ne),we=_.doc.nodeAt(re);if(!we)return!1;let Te=_.tr.delete(re,re+we.nodeSize).setMeta(ue,!0),$e=Te.doc.nodeAt(se);if(!$e)return!1;let Ne=se+$e.nodeSize;Te.insert(Ne,we);let ze=f.near(Te.doc.resolve(Ne+2),1);return Te.setSelection(ze),Q(Te.scrollIntoView()),!0}),ge=_=>this.editor.commands.command(({state:Q,dispatch:Y})=>{let F=y(Q.doc,Q.selection.$from);if(typeof F!="number")return!1;let ne=Q.doc.nodeAt(F);if(!ne)return!1;let re=typeof _=="boolean"?_:!ne.attrs?.collapsed,se=Q.tr.setNodeMarkup(F,void 0,{...ne.attrs,collapsed:re}).setMeta(ue,!0);try{re&&Ie&&(Ie.getState(Q)||{}).editingSectionId&&(se=se.setMeta(Ie,{type:"exit"}))}catch{}return Y(se),!0}),ke=()=>this.editor.commands.command(({state:_,dispatch:Q})=>{let Y=y(_.doc,_.selection.$from);if(typeof Y!="number")return!1;let F=_.doc.nodeAt(Y);if(!F||F.type?.name!=="outlineSection"||!F.attrs?.collapsed)return!1;let ne=De(_.doc,Y);if(typeof ne!="number"){let Te=Y+1,$e=_.tr.setSelection(f.near(_.doc.resolve(Te+1),1));return Q($e.scrollIntoView()),!0}let re=_.doc.nodeAt(ne);if(!re||re.type?.name!=="outlineSection")return!1;let se=_.tr.setNodeMarkup(ne,void 0,{...re.attrs,collapsed:!0}).setMeta(ue,!0);try{Ie&&(Ie.getState(_)||{}).editingSectionId&&(se=se.setMeta(Ie,{type:"exit"}))}catch{}let we=ne+1;return se=se.setSelection(f.near(se.doc.resolve(we+1),1)),Q(se.scrollIntoView()),!0}),Se=()=>this.editor.commands.command(({state:_,dispatch:Q})=>{let{selection:Y}=_;if(!Y?.empty)return!1;let{$from:F}=Y;if(F.parent?.type?.name==="outlineHeading")return!1;let ne=y(_.doc,F);if(typeof ne!="number")return!1;let re=_.doc.nodeAt(ne);if(!re||re.type?.name!=="outlineSection"||re.attrs?.collapsed)return!1;let se=_.doc.type.schema,we=m(F,"outlineBody");if(we===null)return!1;let Te=null;for(let dt=F.depth;dt>we;dt-=1){let nn=F.node(dt),br=F.node(dt-1);if(nn?.type?.name==="paragraph"&&br?.type?.name==="outlineBody"){Te=dt;break}}if(Te===null)return!1;let $e=F.node(Te);if(!$e)return!1;let Ne=re.child(0),ze=re.child(1),Fe=re.child(2),_e=ne+1+Ne.nodeSize+1,Le=F.before(Te),Ve=null;try{let dt=0;for(let nn=0;nn<ze.childCount;nn+=1){if(_e+dt===Le){Ve=nn;break}dt+=ze.child(nn).nodeSize}}catch{Ve=null}if(Ve===null)return!1;let rt=F.pos-F.start(Te),Ge=Math.max(0,Math.min(rt,$e.content.size)),tt=$e.textBetween(0,Ge,"",""),mt=$e.textBetween(Ge,$e.content.size,"",""),ft=String(tt||"").trimEnd(),Lt=String(mt||"").trim(),vt=[];for(let dt=0;dt<Ve;dt+=1)vt.push(ze.child(dt));vt.push(se.nodes.paragraph.create({},ft?[se.text(ft)]:[])),vt.length||vt.push(se.nodes.paragraph.create({},[]));let Qt=[];for(let dt=Ve+1;dt<ze.childCount;dt+=1)Qt.push(ze.child(dt));Qt.length||Qt.push(se.nodes.paragraph.create({},[]));let xt=se.nodes.outlineChildren.create({},[]),Wt=se.nodes.outlineSection.create({...re.attrs,collapsed:!1},[Ne,se.nodes.outlineBody.create({},vt),xt]),Nt=Xt(),yn=se.nodes.outlineSection.create({id:Nt,collapsed:!1},[se.nodes.outlineHeading.create({},Lt?[se.text(Lt)]:[]),se.nodes.outlineBody.create({},Qt),Fe]),ht=_.tr.replaceWith(ne,ne+re.nodeSize,Wt),Zt=ne+Wt.nodeSize;ht=ht.insert(Zt,yn);let dn=ht.doc.nodeAt(Zt);if(dn&&dn.type?.name==="outlineSection"){let dt=dn.child(0),nn=Zt+1+dt.nodeSize;ht=ht.setSelection(f.near(ht.doc.resolve(nn+2),1))}else ht=ht.setSelection(f.near(ht.doc.resolve(Zt+2),1));return ht=ht.setMeta(ue,!0),Ie&&(ht=ht.setMeta(Ie,{type:"enter",sectionId:Nt})),Q(ht.scrollIntoView()),!0}),Oe=(_,Q)=>{let Y=_.nodeAt(Q);if(!Y||Y.type?.name!=="outlineSection")return[];let F=[Q];return Y.descendants((ne,re)=>{ne?.type?.name==="outlineSection"&&F.push(Q+1+re)}),F},De=(_,Q)=>{try{let Y=_.resolve(Math.min(_.content.size,Q+1)),F=null;for(let ne=Y.depth;ne>0;ne-=1){if(Y.node(ne)?.type?.name!=="outlineSection")continue;if(Y.before(ne)===Q){F=ne;break}}if(F===null)return null;for(let ne=F-1;ne>0;ne-=1)if(Y.node(ne)?.type?.name==="outlineSection")return Y.before(ne);return null}catch{return null}},he=(_,Q,Y,F)=>{let ne=!!F,re=_.tr;for(let se of Y){let we=re.doc.nodeAt(se);!we||we.type?.name!=="outlineSection"||!!we.attrs?.collapsed!==ne&&(re=re.setNodeMarkup(se,void 0,{...we.attrs,collapsed:ne}))}re=re.setMeta(ue,!0);try{ne&&Ie&&(Ie.getState(_)||{}).editingSectionId&&(re=re.setMeta(Ie,{type:"exit"}))}catch{}Q(re)},qe=()=>this.editor.commands.command(({state:_,dispatch:Q})=>{let Y=y(_.doc,_.selection.$from);if(typeof Y!="number")return!1;let F=De(_.doc,Y),ne=typeof F=="number"?F:Y,re=Oe(_.doc,ne);if(!re.length)return!1;let se=_.tr;for(let Te of re){let $e=se.doc.nodeAt(Te);!$e||$e.type?.name!=="outlineSection"||$e.attrs?.collapsed||(se=se.setNodeMarkup(Te,void 0,{...$e.attrs,collapsed:!0}))}se=se.setMeta(ue,!0);let we=se.doc.nodeAt(ne);if(we){let Te=we.child(0),Ne=ne+1+Te.nodeSize-1;se=se.setSelection(f.near(se.doc.resolve(Ne),-1))}return Q(se.scrollIntoView()),!0}),Ke=()=>this.editor.commands.command(({state:_,dispatch:Q})=>{let Y=y(_.doc,_.selection.$from);if(typeof Y!="number")return!1;let F=Oe(_.doc,Y);return F.length?(he(_,Q,F,!1),!0):!1}),et=(_,Q)=>{try{let Y=_.nodeAt(Q);if(!Y||Y.type?.name!=="outlineSection")return[];if(Y.childCount<3)return[];let F=Y.child(0),ne=Y.child(1),re=Y.child(2);if(!re||re.type?.name!=="outlineChildren")return[];let se=Q+1+F.nodeSize+ne.nodeSize,we=[];return re.descendants((Te,$e)=>{Te?.type?.name==="outlineSection"&&we.push(se+1+$e)}),we}catch{return[]}},nt=(_,Q)=>{try{let Y=De(_,Q);if(typeof Y!="number")return to(_);let F=_.nodeAt(Y);if(!F||F.type?.name!=="outlineSection"||F.childCount<3)return to(_);let ne=F.child(0),re=F.child(1),se=F.child(2);if(!se||se.type?.name!=="outlineChildren")return to(_);let we=Y+1+ne.nodeSize+re.nodeSize,Te=[];return se.descendants(($e,Ne)=>{$e?.type?.name==="outlineSection"&&Te.push(we+1+Ne)}),Te}catch{return to(_)}},St=(_,Q)=>{try{for(let Y of Q||[]){let F=_.nodeAt(Y);if(!(!F||F.type?.name!=="outlineSection")&&F.attrs?.collapsed)return!0}}catch{}return!1},Mt=()=>this.editor.commands.command(({state:_,dispatch:Q})=>{let Y=y(_.doc,_.selection.$from);if(typeof Y!="number")return!1;let F=_.doc.nodeAt(Y);if(!F||F.type?.name!=="outlineSection")return!1;if(F.attrs?.collapsed)return he(_,Q,[Y],!1),!0;let ne=et(_.doc,Y);if(ne.length&&St(_.doc,ne))return he(_,Q,ne,!1),!0;let re=Y;for(let we=0;we<64;we+=1){let Te=nt(_.doc,re);if(Te.length&&St(_.doc,Te))return he(_,Q,Te,!1),!0;let $e=De(_.doc,re);if(typeof $e!="number")break;re=$e}let se=to(_.doc);return se.length&&St(_.doc,se)?(he(_,Q,se,!1),!0):!1}),Jt=_=>this.editor.commands.command(({state:Q,dispatch:Y})=>{let{selection:F}=Q,re=(F?.node||null)?.type?.name==="outlineSection"?F.from:y(Q.doc,Q.selection.$from);if(typeof re!="number"||!Q.doc.nodeAt(re))return!1;let we=!!_,Te=Oe(Q.doc,re);return Te.length?(he(Q,Y,Te,we),!0):!1});return{"Alt-ArrowUp":()=>this.editor.isActive("table")?!1:q("up"),"Alt-ArrowDown":()=>this.editor.isActive("table")?!1:q("down"),"Alt-ArrowRight":()=>this.editor.isActive("table")?!1:ae(),"Alt-ArrowLeft":()=>this.editor.isActive("table")?!1:Ae(),"Ctrl-Alt-ArrowUp":()=>this.editor.isActive("table")?!1:q("up"),"Alt-Ctrl-ArrowUp":()=>this.editor.isActive("table")?!1:q("up"),"Ctrl-Alt-ArrowDown":()=>this.editor.isActive("table")?!1:q("down"),"Alt-Ctrl-ArrowDown":()=>this.editor.isActive("table")?!1:q("down"),"Ctrl-Alt-ArrowRight":()=>this.editor.isActive("table")?!1:ae(),"Alt-Ctrl-ArrowRight":()=>this.editor.isActive("table")?!1:ae(),"Ctrl-Alt-ArrowLeft":()=>this.editor.isActive("table")?!1:Ae(),"Alt-Ctrl-ArrowLeft":()=>this.editor.isActive("table")?!1:Ae(),"Mod-ArrowRight":()=>ge(!1),"Mod-ArrowLeft":()=>ke()?!0:ge(!0),"Mod-ArrowUp":()=>{try{let _=this.editor.state,Q=y(_.doc,_.selection.$from);if(typeof Q=="number"){let Y=_.doc.nodeAt(Q);if(Y?.type?.name==="outlineSection"&&typeof De(_.doc,Q)!="number"&&Y.attrs?.collapsed)return Na(this.editor,!0)}}catch{}return qe()},"Mod-ArrowDown":()=>Mt(),"Mod-Enter":()=>{try{if(Ie&&!(Ie.getState(this.editor.state)||{}).editingSectionId)return!1}catch{}try{if(this.editor.state.selection?.$from?.parent?.type?.name==="outlineHeading")return Z()}catch{}return Se()?!0:Z()},Backspace:()=>this.editor.commands.command(({state:_,dispatch:Q})=>{let{selection:Y}=_;if(R(_,Q)||v(_,Q))return!0;if(!Y?.empty)return!1;let{$from:F}=Y;if(F.parent?.type?.name!=="outlineHeading"||F.parentOffset!==0)return!1;let ne=y(_.doc,F);if(typeof ne!="number")return!1;let re=_.doc.nodeAt(ne);if(!re)return!1;if(P(re))return L(_,Q,ne);try{if(_.doc.resolve(ne).index()<=0)return J(_,Q,ne)}catch{}return $(_,Q,ne)}),Delete:()=>this.editor.commands.command(({state:_,dispatch:Q})=>{let{selection:Y}=_;if(R(_,Q)||v(_,Q))return!0;if(!Y?.empty)return!1;let{$from:F}=Y;if(m(F,"outlineBody")!==null){let Te=y(_.doc,F);if(typeof Te!="number")return!1;let $e=_.doc.nodeAt(Te);if(!$e)return!1;let Ne=$e.child(0),ze=$e.child(1),Re=Te+1+Ne.nodeSize+ze.nodeSize-1;return F.pos===Re?K(_,Q,Te):!1}if(F.parent?.type?.name!=="outlineHeading")return!1;let re=y(_.doc,F);if(typeof re!="number")return!1;let se=_.doc.nodeAt(re);if(!se)return!1;let we=se.child(0);if(F.parentOffset===we.content.size){if(P(se))return L(_,Q,re);let Te=se.child(1),$e=re+1+we.nodeSize,Ne=_.tr;if(!Te.childCount){let ze=_.doc.type.schema;Ne=Ne.insert($e+1,ze.nodes.paragraph.create({},[]))}return Ne=Ne.setSelection(f.near(Ne.doc.resolve($e+2),1)),Q(Ne.scrollIntoView()),!0}return!1}),Enter:()=>this.editor.commands.command(({state:_,dispatch:Q})=>{let{selection:Y}=_;if(!Y?.empty)return!1;let{$from:F}=Y;if(F.parent?.type?.name!=="outlineHeading")return!1;try{if(Ie&&!(Ie.getState(_)||{}).editingSectionId)return!1}catch{}let ne=y(_.doc,F);if(typeof ne!="number")return!1;let re=_.doc.nodeAt(ne);if(!re)return!1;let se=re.child(0),we=re.child(1),Te=ne+1+se.nodeSize,$e=se.content?.size??0;if(re.attrs?.collapsed&&F.parentOffset===$e){let ze=ne+re.nodeSize,Fe=_.doc.type.schema,Re=Xt(),_e=Fe.nodes.outlineSection.create({id:Re,collapsed:!1},[Fe.nodes.outlineHeading.create({},[]),Fe.nodes.outlineBody.create({},[Fe.nodes.paragraph.create({},[])]),Fe.nodes.outlineChildren.create({},[])]),Le=_.tr.insert(ze,_e);return Le=Le.setSelection(f.create(Le.doc,ze+2)),Le=Le.setMeta(ue,!0),Ie&&(Le=Le.setMeta(Ie,{type:"enter",sectionId:Re})),Q(Le.scrollIntoView()),!0}if(F.parentOffset===0){let ze=_.doc.type.schema,Fe=se.textBetween(0,$e,"",""),Re=ze.nodes.outlineHeading.create({},[]),_e=re.child(2),Le=[];try{for(let ft=0;ft<we.childCount;ft+=1)Le.push(we.child(ft))}catch{}let Ve=[];if(Fe){let ft=ze.nodes.paragraph.create({},[ze.text(Fe)]),Lt=Le[0]||null;Lt&&Lt.type?.name==="paragraph"&&B(Lt)?Ve=[ft,...Le.slice(1)]:Ve=[ft,...Le]}else Ve=Le;Ve.length||(Ve=[ze.nodes.paragraph.create({},[])]);let rt=ze.nodes.outlineBody.create({},Ve),Ge=ze.nodes.outlineSection.create({...re.attrs,collapsed:!1},[Re,rt,_e]),tt=_.tr.replaceWith(ne,ne+re.nodeSize,Ge),mt=tt.doc.nodeAt(ne);if(mt){let ft=mt.child(0),Lt=ne+1+ft.nodeSize;tt=tt.setSelection(f.near(tt.doc.resolve(Lt+2),1))}else tt=tt.setSelection(f.near(tt.doc.resolve(Te+2),1));return tt=tt.setMeta(ue,!0),Q(tt.scrollIntoView()),!0}if(F.parentOffset>0&&F.parentOffset<$e){let ze=_.doc.type.schema,Fe=se.textBetween(0,Math.max(0,Math.min(F.parentOffset,$e)),"",""),Re=se.textBetween(Math.max(0,Math.min(F.parentOffset,$e)),$e,"",""),_e=ze.nodes.outlineHeading.create({},Fe?[ze.text(Fe)]:[]),Le=re.child(2),Ve=[];try{for(let vt=0;vt<we.childCount;vt+=1)Ve.push(we.child(vt))}catch{}let rt=ze.nodes.paragraph.create({},Re?[ze.text(Re)]:[]),Ge=[];if(Re){let vt=Ve[0]||null;vt&&vt.type?.name==="paragraph"&&B(vt)?Ge=[rt,...Ve.slice(1)]:Ge=[rt,...Ve]}else Ge=Ve;Ge.length||(Ge=[ze.nodes.paragraph.create({},[])]);let tt=ze.nodes.outlineBody.create({},Ge),mt=ze.nodes.outlineSection.create({...re.attrs,collapsed:!1},[_e,tt,Le]),ft=_.tr.replaceWith(ne,ne+re.nodeSize,mt),Lt=ft.doc.nodeAt(ne);if(Lt){let vt=Lt.child(0),Qt=ne+1+vt.nodeSize;ft=ft.setSelection(f.near(ft.doc.resolve(Qt+2),1))}else ft=ft.setSelection(f.near(ft.doc.resolve(Te+2),1));return ft=ft.setMeta(ue,!0),Q(ft.scrollIntoView()),!0}let Ne=_.tr;if(!we.childCount){let ze=_.doc.type.schema;Ne=Ne.insert(Te+1,ze.nodes.paragraph.create({},[]))}return Ne=Ne.setSelection(f.near(Ne.doc.resolve(Te+2),1)),Q(Ne.scrollIntoView()),!0}),ArrowUp:()=>this.editor.commands.command(({state:_,dispatch:Q})=>{let{selection:Y}=_;if(!Y?.empty)return!1;let{$from:F}=Y;if(F.parent?.type?.name!=="outlineHeading"||F.parentOffset!==0)return!1;let ne=y(_.doc,F);if(typeof ne!="number")return!1;let re=C(_.doc,ne);if(typeof re=="number")return T(_,Q,re);let se=_.doc.resolve(ne),we=se.index(),Te=se.parent;if(!Te)return!1;if(we>0){let Fe=Te.child(we-1),Re=ne-Fe.nodeSize;return j(_,Q,Re)}let $e=null,Ne=null;for(let Fe=F.depth;Fe>0;Fe-=1)if(F.node(Fe)?.type?.name==="outlineSection")if($e===null)$e=Fe;else{Ne=Fe;break}if(Ne===null)return!1;let ze=F.before(Ne);return j(_,Q,ze)})}},addProseMirrorPlugins(){let y=(m,B)=>{for(let v=m.depth;v>0;v-=1)if(m.node(v)?.type?.name===B)return v;return null};return[new w({key:new x("outlineAltMoveRepeatGuard"),props:{handleKeyDown:(m,B)=>{let v=P=>{try{return!!P?.getModifierState?.("AltGraph")}catch{return!1}},R=P=>{try{return(!!P?.altKey||v(P))&&!P?.metaKey&&(!P?.ctrlKey||v(P))}catch{return!1}};try{if(!B||!R(B))return!1;let P=String(B.key||"");if(P!=="ArrowUp"&&P!=="ArrowDown"||!B.repeat)return!1;let z=m?.state,j=z?.selection?.$from;if(!j)return!1;for(let M=j.depth;M>0;M-=1){let C=j.node(M)?.type?.name;if(C&&String(C).startsWith("table"))return!1}let D=null;for(let M=j.depth;M>0;M-=1)if(j.node(M)?.type?.name==="outlineSection"){D=j.before(M);break}if(typeof D!="number")return!1;let T=z.doc.resolve(D),E=T.parent;if(!E)return!1;let k=T.index();return P==="ArrowUp"&&k<=0||P==="ArrowDown"&&k>=E.childCount-1}catch{return!1}}}}),new w({props:{handleDOMEvents:{cut:(m,B)=>{try{let{state:v}=m,{selection:R}=v;if(!R||R.empty)return!1;let P=(Ae,ge)=>{for(let ke=ge.depth;ke>0;ke-=1)if(ge.node(ke)?.type?.name==="outlineSection")return ge.before(ke);return null},z=P(v.doc,R.$from),j=P(v.doc,R.$to);if(typeof z!="number"||typeof j!="number")return!1;let D=(Ae="")=>String(Ae||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");if(z===j){let Ae=y(R.$from,"outlineHeading"),ge=y(R.$to,"outlineHeading");if(Ae!==null&&ge!==null){let ke=v.doc.nodeAt(z);if(!ke)return!1;let Se=ke.child(0),Oe=z+1,De=Oe+1,he=Oe+Se.nodeSize-1;if(R.from>=De&&R.to<=he){let qe=Math.max(R.from,De),Ke=Math.min(R.to,he),et=v.doc.textBetween(qe,Ke,`
`,`
`);if(B?.clipboardData)try{B.clipboardData.setData("text/plain",et),B.clipboardData.setData("text/html",`<pre>${D(et)}</pre>`)}catch{}B.preventDefault(),B.stopPropagation();let nt=v.tr.delete(qe,Ke);return nt=nt.setSelection(f.near(nt.doc.resolve(De),1)),m.dispatch(nt.scrollIntoView()),!0}}return!1}if(y(R.$from,"outlineBody")===null||R.$to.parent?.type?.name!=="outlineHeading"||R.$to.parentOffset!==0)return!1;let E=v.doc.nodeAt(z);if(!E)return!1;let k=E.child(0),M=E.child(1),C=z+1+k.nodeSize,L=C+1,$=C+M.nodeSize-1,J=Math.max(R.from,L),K=Math.min(R.to,$);if(K<J)return!0;let q=v.doc.textBetween(J,K,`
`,`
`);if(B?.clipboardData)try{B.clipboardData.setData("text/plain",q),B.clipboardData.setData("text/html",`<pre>${D(q)}</pre>`)}catch{}B.preventDefault(),B.stopPropagation();let Z=v.tr.delete(J,K),ae=Z.doc.nodeAt(C);if(ae&&ae.content.size===0){let Ae=Z.doc.type.schema;Z=Z.insert(L,Ae.nodes.paragraph.create({},[]))}return Z=Z.setSelection(f.near(Z.doc.resolve(L+1),1)),m.dispatch(Z.scrollIntoView()),!0}catch{return!1}}}}}),new w({props:{handleKeyDown:(m,B)=>{if(B.key!=="Backspace")return!1;let{state:v}=m,{selection:R}=v;if(!R?.empty)return!1;let{$from:P}=R;if(P.parent?.type?.name!=="paragraph"||P.parentOffset!==0)return!1;let z=null;for(let Z=P.depth;Z>0;Z-=1)if(P.node(Z)?.type?.name==="listItem"){z=Z;break}if(z===null||P.index(z)!==0)return!1;let j=z-1,D=P.node(j);if(!D)return!1;let T=P.index(j);if(T<=0)return!1;let E=P.before(z),k=D.child(T-1),M=E-k.nodeSize,C=v.doc.nodeAt(E);if(!C||C.type?.name!=="listItem")return!1;B.preventDefault(),B.stopPropagation();let L=k.type.create(k.attrs,k.content.append(C.content),k.marks),$=v.tr.replaceWith(M,M+k.nodeSize,L),J=M+1+k.content.size,K=$.mapping.map(J,1),q=$.mapping.map(E);$=$.delete(q,q+C.nodeSize);try{$=$.setSelection(f.near($.doc.resolve(K+1),1))}catch{}return m.dispatch($.scrollIntoView()),!0}}}),new w({props:{handleKeyDown:(m,B)=>(B.key!=="Tab"||B.preventDefault(),!1)}}),new w({props:{handleKeyDown:(m,B)=>{if(!B.ctrlKey||B.shiftKey||B.altKey||B.metaKey||B.key!=="ArrowUp"&&B.key!=="ArrowDown")return!1;let{state:v}=m,{selection:R}=v;if(!R)return!1;let z=(()=>{if((R?.node||null)?.type?.name==="outlineSection")return R.from;let M=R.$from;for(let C=M.depth;C>0;C-=1)if(M.node(C)?.type?.name==="outlineSection")return M.before(C);return null})();if(typeof z!="number")return!1;let j=(k,M)=>{try{let C=k.resolve(Math.min(k.content.size,M+1)),L=null;for(let $=C.depth;$>0;$-=1)if(C.node($)?.type?.name==="outlineSection"&&C.before($)===M){L=$;break}if(L===null)return null;for(let $=L-1;$>0;$-=1)if(C.node($)?.type?.name==="outlineSection")return C.before($);return null}catch{return null}},D=(k,M)=>{let C=k.nodeAt(M);if(!C||C.type?.name!=="outlineSection")return[];let L=[M];return C.descendants(($,J)=>{$?.type?.name==="outlineSection"&&L.push(M+1+J)}),L};if(B.preventDefault(),B.stopPropagation(),B.key==="ArrowUp"){let k=j(v.doc,z),M=typeof k=="number"?k:z,C=D(v.doc,M);if(!C.length)return!0;let L=v.tr;for(let J of C){let K=L.doc.nodeAt(J);!K||K.type?.name!=="outlineSection"||K.attrs?.collapsed||(L=L.setNodeMarkup(J,void 0,{...K.attrs,collapsed:!0}))}let $=L.doc.nodeAt(M);if($){let J=$.child(0),q=M+1+J.nodeSize-1;L=L.setSelection(f.near(L.doc.resolve(q),-1))}return m.dispatch(L.scrollIntoView()),!0}let T=D(v.doc,z);if(!T.length)return!0;let E=v.tr;for(let k of T){let M=E.doc.nodeAt(k);!M||M.type?.name!=="outlineSection"||M.attrs?.collapsed&&(E=E.setNodeMarkup(k,void 0,{...M.attrs,collapsed:!1}))}return m.dispatch(E),!0}}}),new w({props:{handleKeyDown:(m,B)=>{if(B.key!=="Enter")return!1;let{state:v}=m,{$from:R}=v.selection;if(!v.selection.empty)return!1;let P=y(R,"outlineBody");if(P===null)return!1;let z=y(R,"paragraph");if(z===null||R.node(z-1)?.type?.name!=="outlineBody")return!1;let j=R.node(z);if(!j||j.content.size!==0||R.parentOffset!==0&&R.parentOffset!==j.content.size)return!1;let D=R.node(P),T=R.index(P);if(T!==D.childCount-1||T<1)return!1;let E=D.child(T-1);if(!E||E.type?.name!=="paragraph"||E.content.size!==0)return!1;let k=y(R,"outlineSection");if(k===null)return!1;let M=R.before(k);B.preventDefault(),B.stopPropagation();let C=v.tr,L=R.start(P),$=L;for(let Se=0;Se<T;Se+=1)$+=D.child(Se).nodeSize;let J=T;for(let Se=T;Se>=0;Se-=1){let Oe=D.child(Se);if(!Oe||Oe.type?.name!=="paragraph"||Oe.content.size!==0)break;J=Se}let K=L;for(let Se=0;Se<J;Se+=1)K+=D.child(Se).nodeSize;let q=$+D.child(T).nodeSize;C=C.delete(K,q);let Z=C.doc.nodeAt(M);if(!Z)return!0;let ae=M+Z.nodeSize,Ae=C.doc.type.schema,ge=Xt(),ke=Ae.nodes.outlineSection.create({id:ge,collapsed:!1},[Ae.nodes.outlineHeading.create({},[]),Ae.nodes.outlineBody.create({},[Ae.nodes.paragraph.create({},[])]),Ae.nodes.outlineChildren.create({},[])]);return C=C.insert(ae,ke),C=C.setSelection(f.create(C.doc,ae+2)),C=C.setMeta(ue,!0),Ie&&(C=C.setMeta(Ie,{type:"enter",sectionId:ge})),m.dispatch(C.scrollIntoView()),!0}}})]}}),le=u.create({name:"outlineActiveSection",addProseMirrorPlugins(){return[new w({props:{decorations(y){try{let m=Bt(y.doc,y.selection.$from);if(typeof m!="number")return null;let B=y.doc.nodeAt(m);return B?I.create(y.doc,[A.node(m,m+B.nodeSize,{"data-active":"true"})]):null}catch{return null}}}})]}}),Me=u.create({name:"outlineEditMode",addProseMirrorPlugins(){let y=new x("outlineEditMode");Ie=y;let m=null,B=D=>{let T=Bt(D.doc,D.selection.$from);if(typeof T!="number")return null;let E=D.doc.nodeAt(T);return String(E?.attrs?.id||"")||null},v=(D,T,E)=>{if(!T.docChanged)return!0;if(!E)return!1;let k=gt(D.doc,E);if(typeof k!="number")return!1;let M=D.doc.nodeAt(k);if(!M)return!1;let C=M.child(0),L=M.child(1),$=k+1,J=$+1,K=$+C.nodeSize-1,q=k+1+C.nodeSize,Z=q+1,ae=q+L.nodeSize-1,Ae=(ge,ke)=>{let Se=ge>=J&&ke<=K,Oe=ge>=Z&&ke<=ae;return Se||Oe};for(let ge of T.steps){let ke=ge.getMap(),Se=!0;if(ke.forEach((Oe,De)=>{Ae(Oe,De)||(Se=!1)}),!Se)return!1}return!0},R=()=>{try{Ee("\u0414\u043B\u044F \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Enter \u0438\u043B\u0438 \u0434\u0432\u043E\u0439\u043D\u043E\u0439 \u043A\u043B\u0438\u043A \u043C\u044B\u0448\u043A\u043E\u0439. Esc \u0434\u043B\u044F \u0432\u044B\u0445\u043E\u0434\u0430.")}catch{}},P=()=>{try{Ee("\u041D\u0430\u0436\u043C\u0438\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437, \u0447\u0442\u043E\u0431\u044B \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438")}catch{}},z=D=>{try{let{selection:T}=D;if(!T?.empty)return!1;let{$from:E}=T,k=null;for(let K=E.depth;K>0;K-=1)if(E.node(K)?.type?.name==="outlineHeading"){k=K;break}if(k===null||!(E.pos===E.start(k)))return!1;let C=Bt(D.doc,E);if(typeof C!="number")return!1;if(D.doc.resolve(C).index()>0)return!0;let J=!1;for(let K=E.depth;K>0;K-=1)if(E.node(K)?.type?.name==="outlineSection"){if(!J){J=!0;continue}return!0}return!1}catch{return!1}},j=(D,T)=>{try{if(!T)return!1;let{selection:E}=D;if(!E?.empty)return!1;let{$from:k}=E,M=Bt(D.doc,k);if(typeof M!="number")return!1;let C=D.doc.nodeAt(M);if(!C||String(C.attrs?.id||"")!==String(T))return!1;let L=C.child(0),$=C.child(1),K=M+1+L.nodeSize+$.nodeSize-1;if(k.pos!==K)return!1;let q=D.doc.resolve(M),Z=q.index(),ae=q.parent;return ae?Z<ae.childCount-1:!1}catch{return!1}};return[new w({key:y,state:{init(){return{editingSectionId:null}},apply(D,T){let E=D.getMeta(y);return E?E.type==="enter"?{editingSectionId:E.sectionId||null}:E.type==="exit"?{editingSectionId:null}:T:T}},filterTransaction(D,T){let k=(y.getState(T)||{}).editingSectionId||null;return D.getMeta(ue)||D.getMeta("history$")!=null||D.getMeta("closeHistory$")!=null||!D.docChanged?!0:v(T,D,k)},props:{decorations(D){try{let E=(y.getState(D)||{}).editingSectionId||null;if(!E)return null;let k=gt(D.doc,E);if(typeof k!="number")return null;let M=D.doc.nodeAt(k);return M?I.create(D.doc,[A.node(k,k+M.nodeSize,{"data-editing":"true"})]):null}catch{return null}},handleKeyDown(D,T){let E=D.state,M=(y.getState(E)||{}).editingSectionId||null;ot("keydown",{key:T?.key||null,repeat:!!T?.repeat,editingSectionId:M||null,selection:{empty:!!E?.selection?.empty,parent:E?.selection?.$from?.parent?.type?.name||null,parentOffset:E?.selection?.$from?.parentOffset??null}});let C=B(E);if(!M&&(T.key==="Delete"||T.key==="Del"||T.key==="Backspace")&&(T.ctrlKey||T.metaKey)&&!T.shiftKey&&!T.altKey){try{deleteActiveSection()}catch{}return T.preventDefault(),T.stopPropagation(),!0}if(M&&T.key==="Backspace"&&!T.ctrlKey&&!T.metaKey&&!T.altKey){let $=Sm(E,D.dispatch,M,f);if(ot("editorProps.backspace.bodyToHeading",{promoted:$,editingSectionId:M}),$)return T.preventDefault(),T.stopPropagation(),!0;let J=bm(E,D.dispatch);if(ot("editorProps.backspace.tableMerge",{merged:J,editingSectionId:M||null}),J)return T.preventDefault(),T.stopPropagation(),!0}try{let $=(T.key==="Enter"||T.code==="Enter"||T.code==="NumpadEnter")&&(T.ctrlKey||T.metaKey)&&!T.shiftKey&&!T.altKey;if(!d.isPublicView&&!M&&$){let J=E.selection,K=J?.$from||null;if(K){let q=Bt(E.doc,K),Z=typeof q=="number"?E.doc.nodeAt(q):null;if(typeof q=="number"&&Z&&Z.type?.name==="outlineSection"){let ae=!!(J&&J.empty),Ae=K.parent?.type?.name==="outlineHeading",ke=ae&&Ae&&K.parentOffset===0?q:q+Z.nodeSize;T.preventDefault(),T.stopPropagation();let Se=E.schema,Oe=Xt(),De=Se.nodes.outlineSection.create({id:Oe,collapsed:!1},[Se.nodes.outlineHeading.create({},[]),Se.nodes.outlineBody.create({},[Se.nodes.paragraph.create({},[])]),Se.nodes.outlineChildren.create({},[])]),he=E.tr.insert(ke,De);try{let Ke=he.doc.nodeAt(ke)?.child?.(0)||De.child(0),et=ke+1+Ke.nodeSize;he=he.setSelection(f.near(he.doc.resolve(et+2),1))}catch{he=he.setSelection(f.create(he.doc,ke+2))}he=he.setMeta(ue,!0),he=he.setMeta(y,{type:"enter",sectionId:Oe}),D.dispatch(he.scrollIntoView());try{D.focus()}catch{}return!0}}}}catch{}if((!m||m.sectionId!==C||m.key!==T.key)&&(m=null),d.isPublicView&&!M&&(T.key==="Enter"&&!T.shiftKey&&!T.ctrlKey&&!T.metaKey&&!T.altKey||T.key==="F2"&&!T.shiftKey&&!T.ctrlKey&&!T.metaKey&&!T.altKey))return T.preventDefault(),T.stopPropagation(),!0;if(!M&&(T.key==="Enter"&&!T.shiftKey&&!T.ctrlKey&&!T.metaKey&&!T.altKey||T.key==="F2"&&!T.shiftKey&&!T.ctrlKey&&!T.metaKey&&!T.altKey)){let $=B(E);return $?(T.preventDefault(),T.stopPropagation(),D.dispatch(E.tr.setMeta(y,{type:"enter",sectionId:$})),!0):!1}if(M&&T.key==="Escape")return T.preventDefault(),T.stopPropagation(),D.dispatch(E.tr.setMeta(y,{type:"exit"})),!0;if(!M){let $=T.key&&T.key.length===1&&!T.metaKey&&!T.ctrlKey&&!T.altKey;if(T.key==="Backspace"||T.key==="Delete"){if(T.key==="Backspace"&&z(E))try{let{selection:K}=E,{$from:q}=K,Z=findSectionPos(E.doc,q);if(typeof Z!="number")return!1;let ae=E.doc.nodeAt(Z);if(!ae)return!1;let Ae=String(ae.attrs?.id||""),ge=null;try{let Se=E.doc.resolve(Z),Oe=Se.index(),De=Se.parent;if(De&&Oe>0){let he=De.child(Oe-1),qe=Z-he.nodeSize,Ke=E.doc.nodeAt(qe);ge=String(Ke?.attrs?.id||"")||null}else for(let he=q.depth-1;he>0;he-=1){let qe=q.node(he);if(qe?.type?.name==="outlineSection"){let Ke=String(qe.attrs?.id||"");if(Ke&&Ke!==Ae){ge=Ke;break}}}}catch{ge=null}let ke=!1;if(me(ae))ke=pe(E,D.dispatch,Z);else try{E.doc.resolve(Z).index()<=0?ke=Ce(E,D.dispatch,Z):ke=fe(E,D.dispatch,Z)}catch{ke=fe(E,D.dispatch,Z)}return ke&&ge&&window.setTimeout(()=>{try{if((y.getState(D.state)||{}).editingSectionId)return;let Oe=gt(D.state.doc,ge),De=typeof Oe=="number"?D.state.doc.nodeAt(Oe):null;if(!De)return;let he=D.state.tr;De?.attrs?.collapsed&&(he=he.setNodeMarkup(Oe,void 0,{...De.attrs,collapsed:!1}),he=he.setMeta(ue,!0)),he=he.setMeta(y,{type:"enter",sectionId:ge});try{let qe=he.doc.nodeAt(Oe);if(qe&&qe.type?.name==="outlineSection"){let Ke=qe.child(0),et=qe.child(1),St=Oe+1+Ke.nodeSize+et.nodeSize-1;he=he.setSelection(f.near(he.doc.resolve(St),-1))}}catch{}D.dispatch(he.scrollIntoView());try{D.focus()}catch{}}catch{}},0),T.preventDefault(),T.stopPropagation(),!0}catch{}return T.preventDefault(),T.stopPropagation(),!0}if($)return T.preventDefault(),T.stopPropagation(),R(),!0}let L=T.key==="Backspace"&&z(E)||T.key==="Delete"&&j(E,M);if(M&&(T.key==="Backspace"||T.key==="Delete")&&L){if(T.repeat)return T.preventDefault(),T.stopPropagation(),!0;let $=Date.now();return m&&m.sectionId===M&&m.key===T.key&&$-m.ts<1200?(m=null,!1):(m={sectionId:M,key:T.key,ts:$},T.preventDefault(),T.stopPropagation(),P(),!0)}return!1},handleTextInput(){let D=arguments[0],T=D?.state?y.getState(D.state):null;return T&&T.editingSectionId?!1:(R(),!0)},handleDOMEvents:{paste(D,T){let E=D.state;return(y.getState(E)||{}).editingSectionId?!1:(T.preventDefault(),T.stopPropagation(),R(),!0)},drop(D,T){let E=D.state;return(y.getState(E)||{}).editingSectionId?!1:(T.preventDefault(),T.stopPropagation(),R(),!0)}}}})]}}),Je=y=>{let m=(y||"").trim();if(!m)return[];let B=S(m,[b.configure({heading:!1,link:!1}),N.configure({openOnClick:!1,protocols:Ti}),kt,H.configure({table:{resizable:!0}})]),v=Array.isArray(B?.content)?B.content:[],R=[];for(let P=0;P<v.length;P+=1){let z=v[P];if(z?.type!=="paragraph"){R.push(z);continue}let D=Id(z).trim();if(!kn(D)){R.push(z);continue}let E=[],k=P,M=P;for(;M<v.length;M+=1){let $=v[M];if($?.type!=="paragraph")break;let J=Id($).trim();if(!J)break;E.push(J)}let C=Nr(E);if(!C){R.push(z);continue}let L=xm(C);if(!L){R.push(z);continue}R.push(L),P=M-1,P<k&&(P=k)}return R};Ro=Je;let Ye=u.create({name:"outlineMarkdown",addCommands(){return{insertMarkdown:y=>({editor:m})=>{if(!Ie)return!1;if(!(Ie.getState(m.state)||{}).editingSectionId)return Wn(),!1;if(!m?.storage?.markdown?.parser)return Ee("Markdown \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F"),!1;let v=m.storage.markdown.parser.parse(String(y||""),{inline:!0}),R=Je(v);return R.length?m.chain().focus().insertContent(R).run():!1}}}}),at=u.create({name:"outlineFormattedPaste",addProseMirrorPlugins(){let y=this.editor,m=j=>{let D=String(j||"").trim();if(!D)return"";let T=null;try{T=new DOMParser().parseFromString(D,"text/html")}catch{return D}let E=T?.body;if(!E)return D;try{for(let k of Array.from(E.querySelectorAll("ms-cmark-node"))){let M=k.parentNode;if(M){for(;k.firstChild;)M.insertBefore(k.firstChild,k);M.removeChild(k)}}}catch{}try{for(let k of Array.from(E.querySelectorAll("h1,h2,h3,h4,h5,h6"))){let M=T.createElement("p"),C=T.createElement("strong");try{for(;k.firstChild;)C.appendChild(k.firstChild)}catch{C.textContent=String(k.textContent||"")}M.appendChild(C),k.replaceWith(M)}}catch{}return String(E.innerHTML||"").replace(/<!--\s*StartFragment\s*-->/gi,"").replace(/<!--\s*EndFragment\s*-->/gi,"").trim()},B=j=>{let D=String(j||"").trim();if(!D||!D.includes("<")||!D.includes(">")||!/<\s*\/?\s*[a-z][^>]*>/i.test(D))return!1;try{let E=new DOMParser().parseFromString(D,"text/html")?.body;if(!E)return!1;let k=new Set(["p","br","strong","b","em","i","u","s","a","ul","ol","li","blockquote","pre","code","table","thead","tbody","tr","td","th","img","span","div","h1","h2","h3","h4","h5","h6"]);return!!Array.from(E.querySelectorAll("*")).find(C=>k.has(String(C.tagName||"").toLowerCase()))}catch{return!1}},v=j=>{let D=String(j||"").replace(/\r\n/g,`
`).trim();return D?[/```[\s\S]*```/m,/^\s{0,3}([-*+]|\d+\.)\s+\S/m,/^\s{0,3}>\s+\S/m,/\[[^\]]+\]\([^)]+\)/,/!\[[^\]]*\]\([^)]+\)/,/\*\*[^*\n]+\*\*/,/__[^_\n]+__/,/`[^`\n]+`/].some(E=>E.test(D)):!1},R=j=>{try{let D=String(j||"").replace(/\r\n/g,`
`).split(`
`).map(T=>String(T||"").trim()).filter(Boolean);return D.length<2?!1:!!Nr(D)}catch{return!1}},P=(j,D)=>{if(!D||!Array.isArray(D)||!D.length)return!1;let T=j?.state?.selection?.from,E=j?.state?.selection?.to;if(!Number.isFinite(T)||!Number.isFinite(E))return!1;try{return y.chain().focus().command(({tr:k})=>(k.setMeta(ue,!0),!0)).insertContentAt({from:T,to:E},D).run()}catch{return!1}},z=(j,D)=>{try{if(!(Ie?.getState?.(j.state)||null)?.editingSectionId)return!1;let E=D?.clipboardData?.items||null,k=D?.clipboardData?.files||null;if(k&&k.length||E&&Array.from(E).some(L=>L?.kind==="file"))return!1;let M=String(D?.clipboardData?.getData?.("text/html")||"").trim(),C=String(D?.clipboardData?.getData?.("text/plain")||"").trim();if(M)try{let L=String(M).match(/<h[1-6][\s>]/gi);if((Array.isArray(L)?L.length:0)>=2)return!1}catch{}if(M){let L=m(M),$=Je(L);return $.length?(D.preventDefault(),D.stopPropagation(),P(j,$)):!1}if(C&&B(C)){let L=m(C),$=Je(L);return $.length?(D.preventDefault(),D.stopPropagation(),P(j,$)):!1}if(C&&v(C)){if(R(C))return!1;try{let Z=ua(C);if(Z?.startsWithHeading||(Z?.sections?.length||0)>=2)return!1}catch{}let L=y?.storage?.markdown?.parser||null;if(!L?.parse)return!1;let $=!C.includes(`
`)&&!/^\s{0,3}([-*+]|\d+\.)\s+\S/m.test(C)&&!/```[\s\S]*```/m.test(C)&&!/^\s{0,3}>\s+\S/m.test(C),J=String(L.parse(C,{inline:$})).trim();if(!J)return!1;let K=m(J),q=Je(K);return q.length?(D.preventDefault(),D.stopPropagation(),P(j,q)):!1}return!1}catch{return!1}};return[new w({props:{handlePaste(j,D){return z(j,D)},handleDOMEvents:{paste(j,D){return z(j,D)}}}})]}}),st=!1,it=null,We=vr()?performance.now():0,lt=d.article?.docJson||null;if(lt&&typeof lt=="object"&&lt.type==="doc"&&Array.isArray(lt.content)&&(it=lt),it||(it=Um({blocks:d.article?.blocks||[],parseHtmlToNodes:Je}),st=!!(d.article&&!d.article?.docJson&&!d.article?.encrypted)),We&&no("build initial content",{ms:Math.round(performance.now()-We)}),ie){try{ie.destroy()}catch{}ie=null}let ut=G?G.configure({html:!0,tightLists:!0,transformPastedText:!1,transformCopiedText:!1}):null,ct=u.create({name:"outlineTableCellStyling",addOptions(){return{types:["tableCell","tableHeader"],textAlignValues:["left","center","right","justify"],verticalAlignValues:["top","middle","bottom"]}},addGlobalAttributes(){let y=(B,v)=>{try{let R=B?.style?.[v];return R?String(R).trim():""}catch{return""}},m=B=>{let v=[],R=B?.nodeTextAlign?String(B.nodeTextAlign):"",P=B?.nodeVerticalAlign?String(B.nodeVerticalAlign):"",z=B?.nodeTextColor?String(B.nodeTextColor):"",j=B?.nodeBackground?String(B.nodeBackground):"";return R&&this.options.textAlignValues.includes(R)&&v.push(`text-align: ${R}`),P&&this.options.verticalAlignValues.includes(P)&&v.push(`vertical-align: ${P}`),z&&v.push(`color: ${z}`),j&&v.push(`background-color: ${j}`),v.length?{style:v.join("; ")}:{}};return[{types:this.options.types,attributes:{nodeTextAlign:{default:null,parseHTML:B=>{let v=y(B,"textAlign");return v&&this.options.textAlignValues.includes(v)?v:null},renderHTML:B=>m(B)},nodeVerticalAlign:{default:null,parseHTML:B=>{let v=y(B,"verticalAlign");return v&&this.options.verticalAlignValues.includes(v)?v:null},renderHTML:B=>m(B)},nodeTextColor:{default:null,parseHTML:B=>{let v=y(B,"color");return v?String(v).replace(/['"]+/g,""):null},renderHTML:B=>m(B)},nodeBackground:{default:null,parseHTML:B=>{let v=y(B,"backgroundColor");return v?String(v).replace(/['"]+/g,""):null},renderHTML:B=>m(B)}}}]},addCommands(){let y=(B,v)=>({state:R,dispatch:P})=>{try{let z=Aa(R);if(!z.length)return!1;let j=R.tr,D=!1;for(let{node:T,pos:E}of z){if(!T||typeof E!="number")continue;let k={...T.attrs||{}};v==null||v===""?delete k[B]:k[B]=v,j=j.setNodeMarkup(E,void 0,k),D=!0}return D?(j=j.setMeta(ue,!0),P(j),!0):!1}catch{return!1}},m=()=>({state:B,dispatch:v})=>{try{let R=Aa(B);if(!R.length)return!1;let P=B.schema.nodes?.paragraph||null;if(!P)return!1;let z=B.tr,j=[...R].sort((T,E)=>Number(E.pos)-Number(T.pos)),D=!1;for(let{node:T,pos:E}of j){if(!T||typeof E!="number")continue;let k=E+1,M=E+T.nodeSize-1;if(!(M>=k))continue;let C=P.createAndFill();C&&(z=z.replaceWith(k,M,C),D=!0)}return D?(z=z.setMeta(ue,!0),v(z.scrollIntoView()),!0):!1}catch{return!1}};return{setNodeTextAlign:B=>y("nodeTextAlign",B),setNodeVAlign:B=>y("nodeVerticalAlign",B),setNodeTextColor:B=>y("nodeTextColor",B),setNodeBackground:B=>y("nodeBackground",B),unsetNodeAlignment:()=>({state:B,dispatch:v})=>{try{let R=Aa(B);if(!R.length)return!1;let P=B.tr,z=!1;for(let{node:j,pos:D}of R){if(!j||typeof D!="number")continue;let T=j.attrs?.nodeTextAlign||null,E=j.attrs?.nodeVerticalAlign||null;if(!T&&!E)continue;let k={...j.attrs||{}};delete k.nodeTextAlign,delete k.nodeVerticalAlign,P=P.setNodeMarkup(D,void 0,k),z=!0}return z?(P=P.setMeta(ue,!0),v(P),!0):!1}catch{return!1}},clearNodeContents:()=>m()}}}),ee=u.create({name:"outlineTablePercentWidths",addProseMirrorPlugins(){return[new w({view(y){let m=null,B=P=>{let z=String(P||"").trim();if(!z)return 0;let j=z.match(/(-?\\d+(?:\\.\\d+)?)px/i);return j&&Number(j[1])||0},v=()=>{m=null;try{let P=y?.dom;if(!P)return;let z=P.querySelectorAll(".tableWrapper > table");for(let j of z){let D=j.querySelector("colgroup");if(!D)continue;let T=Array.from(D.querySelectorAll("col"));if(!T.length||Cr)continue;try{j.style.width="100%",j.style.maxWidth="100%",j.style.tableLayout="fixed"}catch{}let E=!1;for(let k of T){let M=k?.dataset?.ttPct||"",C=Number.parseFloat(String(M||""));if(Number.isFinite(C)&&C>0)E=!0,k.style.width=`${C.toFixed(4)}%`,k.style.minWidth="";else{let L=Yd(k.style.width);L!=null&&L>0&&(E=!0,k.dataset.ttPct=L.toFixed(4),k.style.width=`${L.toFixed(4)}%`,k.style.minWidth="")}}if(!E)try{let k=j.querySelector("tbody tr");if(!k)continue;let M=Array.from(k.children||[]).filter(K=>K&&K.nodeType===1);if(M.length<T.length)continue;let C=[];for(let K=0;K<T.length;K+=1){let q=M[K].getBoundingClientRect();C.push(Number.isFinite(q.width)?q.width:0)}let L=C.reduce((K,q)=>K+(Number.isFinite(q)?q:0),0);if(!(L>0))continue;let $=C.map(K=>zn(K/L*100)),J=$.reduce((K,q)=>K+q,0);Math.abs(J-100)>.01&&($[$.length-1]=zn($[$.length-1]+(100-J)));for(let K=0;K<T.length;K+=1)Vi(T[K],$[K])}catch{}}}catch{}},R=()=>{m==null&&(m=window.requestAnimationFrame(v))};return R(),{update(){R()},destroy(){m!=null&&(window.cancelAnimationFrame(m),m=null)}}}})]}}),de=u.create({name:"outlineTableSmartMouseSelection",addProseMirrorPlugins(){let y=Et?.CellSelection||null;return y?[new w({view(m){let B=R=>{try{for(let P=R.depth;P>=0;P-=1){let z=R.node(P)?.type?.name;if(z==="tableCell"||z==="tableHeader")return R.before(P)}}catch{}return null},v=()=>{try{if(!(Ie?.getState?.(m.state)||null)?.editingSectionId)return;let P=m.state.selection;if(!P||P.empty)return;let z=B(P.$anchor),j=B(P.$head);if(z==null||j==null||z===j)return;let D=typeof y.create=="function"?y.create(m.state.doc,z,j):null;if(!D)return;let T=m.state.tr.setSelection(D);T=T.setMeta(ue,!0),m.dispatch(T)}catch{}};return m.dom.addEventListener("mouseup",v,!0),{destroy(){m.dom.removeEventListener("mouseup",v,!0)}}}})]:[]}}),ye=u.create({name:"outlineTableResizeCapture",addProseMirrorPlugins(){return[new w({view(y){let m=v=>{try{if(!v?.target?.closest?.(".column-resize-handle")||!(Ie?.getState?.(y.state)||null)?.editingSectionId)return;Cr=!0}catch{}},B=()=>{if(Cr){Cr=!1;try{let v=y.domAtPos(y.state.selection.from),P=((v?.node&&v.node.nodeType===1?v.node:v?.node?.parentElement)||null)?.closest?.("table")||null;P&&$i(P)}catch{}}};return y.dom.addEventListener("pointerdown",m,!0),document.addEventListener("pointerup",B,!0),document.addEventListener("pointercancel",B,!0),{destroy(){y.dom.removeEventListener("pointerdown",m,!0),document.removeEventListener("pointerup",B,!0),document.removeEventListener("pointercancel",B,!0)}}}})]}}),Ue=u.create({name:"outlineTableNodeUi",addProseMirrorPlugins(){let y=this.editor,m=[{label:"Default text",value:null},{label:"Gray text",value:"var(--tt-color-text-gray)"},{label:"Brown text",value:"var(--tt-color-text-brown)"},{label:"Orange text",value:"var(--tt-color-text-orange)"},{label:"Yellow text",value:"var(--tt-color-text-yellow)"},{label:"Green text",value:"var(--tt-color-text-green)"},{label:"Blue text",value:"var(--tt-color-text-blue)"},{label:"Purple text",value:"var(--tt-color-text-purple)"},{label:"Pink text",value:"var(--tt-color-text-pink)"},{label:"Red text",value:"var(--tt-color-text-red)"}],B=[{label:"Default background",value:null},{label:"Gray background",value:"var(--tt-color-highlight-gray)"},{label:"Brown background",value:"var(--tt-color-highlight-brown)"},{label:"Orange background",value:"var(--tt-color-highlight-orange)"},{label:"Yellow background",value:"var(--tt-color-highlight-yellow)"},{label:"Green background",value:"var(--tt-color-highlight-green)"},{label:"Blue background",value:"var(--tt-color-highlight-blue)"},{label:"Purple background",value:"var(--tt-color-highlight-purple)"},{label:"Pink background",value:"var(--tt-color-highlight-pink)"},{label:"Red background",value:"var(--tt-color-highlight-red)"}],v=[{label:"Align left",value:"left"},{label:"Align center",value:"center"},{label:"Align right",value:"right"},{label:"Justify",value:"justify"}],R=[{label:"Align top",value:"top"},{label:"Align middle",value:"middle"},{label:"Align bottom",value:"bottom"}],P=T=>{try{if(!T)return null;let E={left:Number(T.left),top:Number(T.top),right:Number(T.right),bottom:Number(T.bottom),width:Number(T.width),height:Number(T.height)};return!Number.isFinite(E.left)||!Number.isFinite(E.top)?null:E}catch{return null}},z=(T,E,k,M,C=8)=>{try{let L=window.innerWidth||0,$=window.innerHeight||0,J=Math.max(C,Math.min(T,Math.max(C,L-k-C))),K=Math.max(C,Math.min(E,Math.max(C,$-M-C)));return{left:J,top:K}}catch{return{left:T,top:E}}};class j{constructor(){this.panels=[],this.onDocPointerDown=E=>{try{let k=E?.target||null,M=typeof E?.composedPath=="function"?E.composedPath():null,C=Array.isArray(M)&&M.length?M:k?[k]:[];if(!C.length)return;for(let L of C)for(let $ of this.panels)if($&&(L===$||$.contains(L)))return;this.closeAll()}catch{this.closeAll()}},this.onKeyDown=E=>{E?.key==="Escape"&&this.closeAll()}}isOpen(){return this.panels.length>0}closeAll(){try{for(let E of this.panels)E?.remove?.()}catch{}this.panels=[];try{document.removeEventListener("pointerdown",this.onDocPointerDown,!1),window.removeEventListener("keydown",this.onKeyDown,!1)}catch{}}openPanel({anchorRect:E,items:k,level:M=0}){let C=P(E);if(!C)return;for(;this.panels.length>M;){let Z=this.panels.pop();try{Z?.remove?.()}catch{}}let L=document.createElement("div");L.className="tt-table-menu",L.setAttribute("role","menu"),L.setAttribute("data-level",String(M)),L.addEventListener("pointerdown",Z=>{Z.stopPropagation()}),L.addEventListener("mousedown",Z=>{Z.stopPropagation()});for(let Z of k){if(Z.type==="separator"){let Ae=document.createElement("div");Ae.className="tt-table-menu-sep",L.appendChild(Ae);continue}let ae=document.createElement("button");if(ae.type="button",ae.className="tt-table-menu-item",ae.textContent=Z.label,ae.disabled=!!Z.disabled,Z.swatch){ae.classList.add("has-swatch");try{let Ae=Z.swatchValue==null?"transparent":String(Z.swatchValue);ae.style.setProperty("--tt-swatch",Ae)}catch{}}Z.submenu&&ae.classList.add("has-submenu"),ae.addEventListener("click",Ae=>{if(Ae.preventDefault(),Ae.stopPropagation(),!Z.disabled){if(Z.submenu){let ge=ae.getBoundingClientRect();this.openPanel({anchorRect:ge,items:Z.submenu(),level:M+1});return}try{Z.onClick?.()}finally{this.closeAll()}}}),L.appendChild(ae)}document.body.appendChild(L);let $=L.getBoundingClientRect(),J=C.right+8,K=C.top,q=z(J,K,$.width,$.height);L.style.left=`${q.left}px`,L.style.top=`${q.top}px`,this.panels.push(L);try{this.panels.length===1&&(document.addEventListener("pointerdown",this.onDocPointerDown,!1),window.addEventListener("keydown",this.onKeyDown,!1))}catch{}}}class D{constructor(E){this.view=E,this.menu=new j,this.wrapper=null,this.table=null,this.observedTable=null,this.resizeObserver=null,this.layoutRaf=null,this.resizeRaf=null,this.destroyed=!1,this.root=document.createElement("div"),this.root.className="tt-table-ui",this.root.style.display="none",this.cellOutline=document.createElement("div"),this.cellOutline.className="tt-table-active-cell-outline",this.cellOutline.style.display="none",this.root.appendChild(this.cellOutline),this.scheduleLayout=()=>{this.layoutRaf==null&&(this.layoutRaf=window.requestAnimationFrame(()=>{this.layoutRaf=null,!this.destroyed&&this.update(this.view)}))},this.scheduleResizeLoop=()=>{this.resizeRaf==null&&(this.resizeRaf=window.requestAnimationFrame(()=>{this.resizeRaf=null,!this.destroyed&&Cr&&this.update(this.view)}))},this.onWrapperScroll=()=>this.scheduleLayout(),this.onWindowResize=()=>this.scheduleLayout();try{window.addEventListener("resize",this.onWindowResize,{passive:!0})}catch{}this.rowHandles=[],this.colHandles=[],this.dragState=null,this.suppressClickUntil=0,this.colDropIndicator=document.createElement("div"),this.colDropIndicator.className="tt-table-drop-indicator tt-table-drop-indicator-col",this.colDropIndicator.style.display="none",this.root.appendChild(this.colDropIndicator),this.rowDropIndicator=document.createElement("div"),this.rowDropIndicator.className="tt-table-drop-indicator tt-table-drop-indicator-row",this.rowDropIndicator.style.display="none",this.root.appendChild(this.rowDropIndicator),this.cellHandle=document.createElement("button"),this.cellHandle.type="button",this.cellHandle.className="tt-table-handle tt-table-cell-handle",this.cellHandle.setAttribute("aria-label","Cell actions"),this.cellHandle.addEventListener("click",k=>{k.preventDefault(),k.stopPropagation();let M=this.cellHandle.getBoundingClientRect();this.openCellMenu(M)}),this.root.appendChild(this.cellHandle)}hideDropIndicators(){try{this.colDropIndicator&&(this.colDropIndicator.style.display="none")}catch{}try{this.rowDropIndicator&&(this.rowDropIndicator.style.display="none")}catch{}}cancelDrag(){let E=this.dragState;if(E){this.dragState=null,this.hideDropIndicators();try{window.removeEventListener("pointermove",E.onMove),window.removeEventListener("pointerup",E.onUp),window.removeEventListener("pointercancel",E.onUp)}catch{}try{document.body.classList.remove("tt-table-dragging")}catch{}}}destroy(){this.destroyed=!0,this.cancelDrag();try{this.cellOutline.style.display="none"}catch{}this.menu.closeAll();try{this.layoutRaf!=null&&window.cancelAnimationFrame(this.layoutRaf)}catch{}this.layoutRaf=null;try{this.resizeRaf!=null&&window.cancelAnimationFrame(this.resizeRaf)}catch{}this.resizeRaf=null;try{window.removeEventListener("resize",this.onWindowResize)}catch{}try{this.wrapper?.removeEventListener?.("scroll",this.onWrapperScroll)}catch{}try{this.resizeObserver?.disconnect?.()}catch{}this.resizeObserver=null,this.observedTable=null;try{this.root.remove()}catch{}this.wrapper=null,this.table=null}ensureAttached(E){if(E&&this.wrapper!==E){try{this.wrapper?.removeEventListener?.("scroll",this.onWrapperScroll)}catch{}try{this.root.remove()}catch{}this.wrapper=E;try{this.wrapper.addEventListener("scroll",this.onWrapperScroll,{passive:!0})}catch{}this.wrapper.appendChild(this.root)}}buildRowHandles(E){for(;this.rowHandles.length>E;){let k=this.rowHandles.pop();try{k?.remove?.()}catch{}}for(;this.rowHandles.length<E;){let k=document.createElement("button");k.type="button",k.className="tt-table-handle tt-table-row-handle",k.setAttribute("aria-label","Row actions"),k.dataset.idx=String(this.rowHandles.length),k.addEventListener("pointerdown",M=>this.onHandlePointerDown(M,k,"row")),k.addEventListener("click",M=>{if(Date.now()<this.suppressClickUntil){M.preventDefault(),M.stopPropagation();return}M.preventDefault(),M.stopPropagation();let C=qt(this.view?.state)?.tablePos,L=k.getBoundingClientRect();y?.chain?.().focus?.().run?.();let $=Number(k.dataset.idx||0);Im(y,$),this.openRowMenu(L,$,C)}),this.rowHandles.push(k),this.root.appendChild(k)}}buildColHandles(E){for(;this.colHandles.length>E;){let k=this.colHandles.pop();try{k?.remove?.()}catch{}}for(;this.colHandles.length<E;){let k=document.createElement("button");k.type="button",k.className="tt-table-handle tt-table-col-handle",k.setAttribute("aria-label","Column actions"),k.dataset.idx=String(this.colHandles.length),k.addEventListener("pointerdown",M=>this.onHandlePointerDown(M,k,"col")),k.addEventListener("click",M=>{if(Date.now()<this.suppressClickUntil){M.preventDefault(),M.stopPropagation();return}M.preventDefault(),M.stopPropagation();let C=qt(this.view?.state)?.tablePos,L=k.getBoundingClientRect();y?.chain?.().focus?.().run?.();let $=Number(k.dataset.idx||0);Cm(y,$),this.openColumnMenu(L,$,C)}),this.colHandles.push(k),this.root.appendChild(k)}}onHandlePointerDown(E,k,M){try{if(!E||E.button!==0)return;E.preventDefault(),E.stopPropagation(),y?.chain?.().focus?.().run?.();let C=Number(k?.dataset?.idx||0);try{typeof k.setPointerCapture=="function"&&k.setPointerCapture(E.pointerId)}catch{}let L={kind:M,btn:k,pointerId:E.pointerId,fromIndex:C,startX:E.clientX,startY:E.clientY,moved:!1};this.dragState=L;let $=K=>this.onHandlePointerMove(K),J=K=>this.onHandlePointerUp(K);L.onMove=$,L.onUp=J,window.addEventListener("pointermove",$,{passive:!1}),window.addEventListener("pointerup",J,{passive:!1}),window.addEventListener("pointercancel",J,{passive:!1})}catch{}}onHandlePointerMove(E){let k=this.dragState;if(!k||!E||E.pointerId!==k.pointerId)return;try{E.preventDefault()}catch{}let M=E.clientX-k.startX,C=E.clientY-k.startY;if(!k.moved&&Math.hypot(M,C)>=4){k.moved=!0;try{document.body.classList.add("tt-table-dragging")}catch{}}if(k.moved){let L=this.getDropIndexFromPointer(k.kind,E.clientX,E.clientY);k.dropIndex=L,L==null?this.hideDropIndicators():this.updateDropIndicator(k.kind,L,E.clientX,E.clientY)}}getDropIndexFromPointer(E,k,M){try{let C=this.table;if(!C)return null;let L=Array.from(C.querySelectorAll("tbody tr"));if(!L.length)return null;if(E==="col"){let J=Array.from(L[0].children||[]).filter(q=>q&&q.nodeType===1);if(!J.length)return null;let K=J.map(q=>{let Z=q.getBoundingClientRect();return Z.left+Z.width/2});if(!K.length)return null;if(k<K[0])return 0;for(let q=0;q<K.length-1;q+=1)if(k>=K[q]&&k<K[q+1])return q+1;return K.length-1}let $=L.map(J=>{let K=J.children&&J.children[0];if(!K)return null;let q=K.getBoundingClientRect();return q.top+q.height/2}).filter(J=>typeof J=="number");if(!$.length)return null;if(M<$[0])return 0;for(let J=0;J<$.length-1;J+=1)if(M>=$[J]&&M<$[J+1])return J+1;return $.length-1}catch{return null}}updateDropIndicator(E,k,M,C){try{let L=this.table,$=this.wrapper;if(!L||!$)return;let J=$.getBoundingClientRect(),K=L.getBoundingClientRect(),q=K.top-J.top,Z=K.left-J.left,ae=K.width,Ae=K.height,ge=Array.from(L.querySelectorAll("tbody tr"));if(!ge.length)return;if(E==="col"){let et=Array.from(ge[0].children||[]).filter(Q=>Q&&Q.nodeType===1);if(!et.length)return;let nt=Math.max(0,Math.min(et.length-1,Number(k))),St=et[nt].getBoundingClientRect(),Mt=et[et.length-1].getBoundingClientRect(),Jt=Mt.left+Mt.width/2,_=nt===et.length-1&&M>Jt?Mt.right-J.left:St.left-J.left;this.colDropIndicator.style.display="",this.rowDropIndicator.style.display="none",this.colDropIndicator.style.left=`${Math.round(_)}px`,this.colDropIndicator.style.top=`${Math.round(q)}px`,this.colDropIndicator.style.height=`${Math.max(0,Math.round(Ae))}px`;return}let ke=Math.max(0,Math.min(ge.length-1,Number(k))),Se=ge[ke]?.children?.[0];if(!Se)return;let Oe=Se.getBoundingClientRect(),he=(ge[ge.length-1]?.children?.[0]||null)?.getBoundingClientRect?.()||null,qe=he?he.top+he.height/2:null,Ke=ke===ge.length-1&&he&&typeof qe=="number"&&C>qe?he.bottom-J.top:Oe.top-J.top;this.rowDropIndicator.style.display="",this.colDropIndicator.style.display="none",this.rowDropIndicator.style.left=`${Math.round(Z)}px`,this.rowDropIndicator.style.top=`${Math.round(Ke)}px`,this.rowDropIndicator.style.width=`${Math.max(0,Math.round(ae))}px`}catch{}}onHandlePointerUp(E){let k=this.dragState;if(!k||!E||E.pointerId!==k.pointerId)return;try{E.preventDefault(),E.stopPropagation()}catch{}this.dragState=null;try{window.removeEventListener("pointermove",k.onMove),window.removeEventListener("pointerup",k.onUp),window.removeEventListener("pointercancel",k.onUp)}catch{}try{document.body.classList.remove("tt-table-dragging")}catch{}if(this.hideDropIndicators(),!k.moved)return;this.suppressClickUntil=Date.now()+250;let M=k.dropIndex??this.getDropIndexFromPointer(k.kind,E.clientX,E.clientY);if(M!=null){try{y?.chain?.().focus?.().run?.()}catch{}k.kind==="col"?Zd(y,k.fromIndex,M):eu(y,k.fromIndex,M),this.scheduleLayout()}}isEnabled(){try{return!!(Ie?.getState?.(this.view.state)||null)?.editingSectionId&&!d.isPublicView}catch{return!1}}update(E){if(this.view=E,!Cr&&this.resizeRaf!=null){try{window.cancelAnimationFrame(this.resizeRaf)}catch{}this.resizeRaf=null}if(!this.isEnabled()){this.root.style.display="none",this.menu.closeAll();try{this.cellOutline.style.display="none"}catch{}return}let k=qt(E.state),M=km(E),C=M?.closest?.("table")||cn(E),L=C?.closest?.(".tableWrapper")||null;if(!k||!C||!L||!M){this.root.style.display="none",this.menu.isOpen()||this.menu.closeAll();try{this.cellOutline.style.display="none"}catch{}return}this.ensureAttached(L),this.table=C;try{typeof ResizeObserver=="function"&&(this.resizeObserver||(this.resizeObserver=new ResizeObserver(()=>this.scheduleLayout())),this.observedTable!==C&&(this.resizeObserver.disconnect(),this.resizeObserver.observe(C),this.observedTable=C))}catch{}this.root.style.display="";let $=Array.from(C.querySelectorAll("tbody tr")),J=Number(k.map?.height||$.length||0),K=Number(k.map?.width||0);this.buildRowHandles(Math.max(0,J)),this.buildColHandles(Math.max(0,K));let q=L.getBoundingClientRect(),Z=C.getBoundingClientRect(),ae=Z.top-q.top,Ae=Z.left-q.left,ge=14,ke=4,Se=ge/2,Oe=Math.max(0,Math.min(Math.max(0,J-1),Number(k.rowIndex||0))),De=Math.max(0,Math.min(Math.max(0,K-1),Number(k.colIndex||0))),he=Math.max(Se,ae-(ge/2+ke)),qe=Math.max(Se,Ae-(ge/2+ke)),Ke=M.getBoundingClientRect(),et=Ke.left-q.left+Ke.width/2,nt=Ke.top-q.top+Ke.height/2,St=Ke.left-q.left,Mt=Ke.top-q.top,Jt="cell";try{let _=E.state.selection,Q=_?.$anchorCell?.pos,Y=_?.$headCell?.pos;if(typeof Q=="number"&&typeof Y=="number"&&Q!==Y){let F=Q-(k.tablePos+1),ne=Y-(k.tablePos+1),re=k.map?.rectBetween?.(F,ne)||null;if(re){let se=Number(re.right)-Number(re.left),we=Number(re.bottom)-Number(re.top);se===1&&we>1?Jt="col":we===1&&se>1?Jt="row":Jt="range"}else Jt="range"}}catch{Jt="cell"}try{Jt==="cell"?(this.cellOutline.style.display="",this.cellOutline.style.left=`${Math.round(St)}px`,this.cellOutline.style.top=`${Math.round(Mt)}px`,this.cellOutline.style.width=`${Math.max(0,Math.round(Ke.width))}px`,this.cellOutline.style.height=`${Math.max(0,Math.round(Ke.height))}px`):this.cellOutline.style.display="none"}catch{try{this.cellOutline.style.display="none"}catch{}}for(let _=0;_<this.colHandles.length;_+=1){let Q=this.colHandles[_];if(Q){if(Q.dataset.idx=String(_),_!==De){Q.style.display="none";continue}Q.style.display="",Q.style.width=`${Math.max(18,Math.round(Ke.width))}px`,Q.style.height=`${ge}px`,Q.style.left=`${Math.round(et)}px`,Q.style.top=`${Math.round(he)}px`}}for(let _=0;_<this.rowHandles.length;_+=1){let Q=this.rowHandles[_];if(Q){if(Q.dataset.idx=String(_),_!==Oe){Q.style.display="none";continue}Q.style.display="",Q.style.width=`${ge}px`,Q.style.height=`${Math.max(18,Math.round(Ke.height))}px`,Q.style.left=`${Math.round(qe)}px`,Q.style.top=`${Math.round(nt)}px`}}try{if(Jt!=="cell")this.cellHandle.style.display="none";else{let _=Ke.right-q.left;this.cellHandle.style.display="",this.cellHandle.style.left=`${Math.round(_)}px`,this.cellHandle.style.top=`${Math.round(nt)}px`}}catch{this.cellHandle.style.display="none"}Cr&&this.scheduleResizeLoop()}openCellMenu(E){let k=()=>{try{y?.chain?.().focus?.().run?.()}catch{}},M=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>m.map(C=>({label:C.label,swatch:!0,swatchValue:C.value,onClick:()=>{k(),y.commands.setNodeTextColor(C.value)}}))},{label:"Background color",submenu:()=>B.map(C=>({label:C.label,swatch:!0,swatchValue:C.value,onClick:()=>{k(),y.commands.setNodeBackground(C.value)}}))}]},{label:"Alignment",submenu:()=>[...v.map(C=>({label:C.label,onClick:()=>{k(),y.commands.setNodeTextAlign(C.value)}})),{type:"separator"},...R.map(C=>({label:C.label,onClick:()=>{k(),y.commands.setNodeVAlign(C.value)}}))]},{type:"separator"},{label:"Clear contents",onClick:()=>{k(),y.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:E,items:M,level:0})}openRowMenu(E,k,M){let C=()=>{try{y?.chain?.().focus?.().run?.()}catch{}Number.isFinite(Number(M))&&Em(y,M,k)},L=(q,Z)=>{try{y?.chain?.().focus?.().run?.()}catch{}return y.commands.command(({state:ae,dispatch:Ae})=>{let ge=Number.isFinite(Number(M))?Number(M):qt(ae)?.tablePos,ke=Number.isFinite(Number(k))?Number(k):qt(ae)?.rowIndex;return!Number.isFinite(Number(ge))||!Number.isFinite(Number(ke))?!1:Tm({pmState:ae,dispatch:Ae},{tablePos:ge,rowIndex:ke,attr:q,value:Z})})},$=q=>()=>(C(),q?.()),J=q=>{try{return typeof q!="function"?!1:(C(),y.commands.command(({state:Z,dispatch:ae})=>q(Z,typeof ae=="function"?ge=>{try{ge=ge.setMeta(ue,!0)}catch{}ae(ge)}:void 0)))}catch{return!1}},K=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>m.map(q=>({label:q.label,swatch:!0,swatchValue:q.value,onClick:()=>L("nodeTextColor",q.value)}))},{label:"Background color",submenu:()=>B.map(q=>({label:q.label,swatch:!0,swatchValue:q.value,onClick:()=>L("nodeBackground",q.value)}))}]},{label:"Alignment",submenu:()=>[...v.map(q=>({label:q.label,onClick:()=>L("nodeTextAlign",q.value)})),{type:"separator"},...R.map(q=>({label:q.label,onClick:()=>L("nodeVerticalAlign",q.value)}))]},{type:"separator"},{label:"Insert row above",onClick:()=>J(Et?.addRowBefore)},{label:"Insert row below",onClick:()=>J(Et?.addRowAfter)},{label:"Sort ",submenu:()=>[{label:"Sort column A-Z",onClick:$(()=>Td(y,{direction:"asc"}))},{label:"Sort column Z-A",onClick:$(()=>Td(y,{direction:"desc"}))}]},{label:"Header row",onClick:()=>J(Et?.toggleHeaderRow)},{label:"Move ",submenu:()=>[{label:"Move row up",onClick:$(()=>Cd(y,-1))},{label:"Move row down",onClick:$(()=>Cd(y,1))},{label:"Move row left",disabled:!0,onClick:()=>{}},{label:"Move row right",disabled:!0,onClick:()=>{}}]},{label:"Duplicate row",onClick:$(()=>Mm(y))},{label:"Delete row",onClick:()=>J(Et?.deleteRow)},{type:"separator"},{label:"Clear row contents",onClick:()=>{C(),y.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:E,items:K,level:0})}openColumnMenu(E,k,M){let C=()=>{try{y?.chain?.().focus?.().run?.()}catch{}Number.isFinite(Number(M))&&vm(y,M,k)},L=(q,Z)=>{try{y?.chain?.().focus?.().run?.()}catch{}return y.commands.command(({state:ae,dispatch:Ae})=>{let ge=Number.isFinite(Number(M))?Number(M):qt(ae)?.tablePos,ke=Number.isFinite(Number(k))?Number(k):qt(ae)?.colIndex;return!Number.isFinite(Number(ge))||!Number.isFinite(Number(ke))?!1:Bm({pmState:ae,dispatch:Ae},{tablePos:ge,colIndex:ke,attr:q,value:Z})})},$=q=>()=>(C(),q?.()),J=q=>{try{return typeof q!="function"?!1:(C(),y.commands.command(({state:Z,dispatch:ae})=>q(Z,typeof ae=="function"?ge=>{try{ge=ge.setMeta(ue,!0)}catch{}ae(ge)}:void 0)))}catch{return!1}},K=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>m.map(q=>({label:q.label,swatch:!0,swatchValue:q.value,onClick:()=>L("nodeTextColor",q.value)}))},{label:"Background color",submenu:()=>B.map(q=>({label:q.label,swatch:!0,swatchValue:q.value,onClick:()=>L("nodeBackground",q.value)}))}]},{label:"Alignment",submenu:()=>[...v.map(q=>({label:q.label,onClick:()=>L("nodeTextAlign",q.value)})),{type:"separator"},...R.map(q=>({label:q.label,onClick:()=>L("nodeVerticalAlign",q.value)}))]},{type:"separator"},{label:"Insert column left",onClick:()=>{C();let q=Math.max(0,Number(k||0));J(Et?.addColumnBefore)&&window.requestAnimationFrame(()=>{try{Ui(y,{insertIndex:q,newColPct:10})}catch{let ae=cn(y.view);$i(ae)}})}},{label:"Insert column right",onClick:()=>{C();let q=Math.max(0,Number(k||0)+1);J(Et?.addColumnAfter)&&window.requestAnimationFrame(()=>{try{Ui(y,{insertIndex:q,newColPct:10})}catch{let ae=cn(y.view);$i(ae)}})}},{label:"Sort ",submenu:()=>[{label:"Sort row A-Z",onClick:$(()=>vd(y,{direction:"asc"}))},{label:"Sort row Z-A",onClick:$(()=>vd(y,{direction:"desc"}))}]},{label:"Header column",onClick:()=>J(Et?.toggleHeaderColumn)},{label:"Move ",submenu:()=>[{label:"Move column up",disabled:!0,onClick:()=>{}},{label:"Move column down",disabled:!0,onClick:()=>{}},{label:"Move column left",onClick:$(()=>Ed(y,-1))},{label:"Move column right",onClick:$(()=>Ed(y,1))}]},{label:"Duplicate column",onClick:$(()=>Lm(y))},{label:"Delete column",onClick:()=>{C();let q=cn(y.view),Z=io(q),ae=Number.isFinite(Number(k))?Number(k):null,Ae=Z&&ae!=null?Xd(Z,ae):null;J(Et?.deleteColumn)&&Array.isArray(Ae)&&window.requestAnimationFrame(()=>{let ke=cn(y.view);so(ke,Ae)})}},{type:"separator"},{label:"Clear column contents",onClick:()=>{C(),y.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:E,items:K,level:0})}}return[new w({view(T){let E=new D(T);return E.update(T),{update(k){E.update(k)},destroy(){E.destroy()}}}})]}}),Pe=vr()?performance.now():0;if(ie){pr("outline.mount.remountDetected",{outlineArticleId:bt,hadInstance:!0});try{ie.destroy()}catch{}ie=null}ie=new c({element:e,extensions:[_n,W,En,jt,zt,Dn,be,Qe,te,le,Me,Ot,qn,ln,gn,Pn,In,at,X.configure({types:["outlineSection"],attributeName:"id",generateID:()=>Xt()}),b.configure({document:!1,heading:!1,link:!1}),N.configure({openOnClick:!1,protocols:Ti}),ut,kt,Be,ct,H.configure({table:{resizable:!0}}),Ue,de,ye,ee,Ye].filter(Boolean),content:it,editorProps:{attributes:{class:"outline-prosemirror"},handleKeyDown(y,m){try{if(ve?.isOpen?.()&&ve.isOpen()&&!!ve.handleKeyDown?.(m))return!0}catch{}try{if((m?.ctrlKey||m?.metaKey)&&!m?.shiftKey&&!m?.altKey&&(String(m?.key||"").toLowerCase()==="v"||String(m?.code||"")==="KeyV")&&!d.isPublicView&&!((Ie?.getState?.(y.state)||null)?.editingSectionId||null)){let L=Ba();if(L&&Array.isArray(L.sections)&&L.sections.length){m.preventDefault(),m.stopPropagation();let $=y.state,K=$.selection?.$from||null,q=K?Bt($.doc,K):null,Z=typeof q=="number"?$.doc.nodeAt(q):null,ae=$.doc.content.size;typeof q=="number"&&Z&&(ae=q+Z.nodeSize);let Ae=new Set;try{$.doc.descendants(he=>{if(he?.type?.name!=="outlineSection")return;let qe=String(he.attrs?.id||"").trim();qe&&Ae.add(qe)})}catch{}let ge=[];if(L.mode==="copy")for(let he of L.sections)ge.push(Ud(he,()=>Xt()));else for(let he of L.sections){let qe=String(he?.attrs?.id||"").trim();if(qe&&Ae.has(qe))return Ee("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C: \u0431\u043B\u043E\u043A \u0441 \u0442\u0430\u043A\u0438\u043C id \u0443\u0436\u0435 \u0435\u0441\u0442\u044C"),!0;ge.push(Da(he))}let ke=$.doc.type.schema,Se=[];for(let he of ge)try{let qe=ke.nodeFromJSON(he);qe?.type?.name==="outlineSection"&&Se.push(qe)}catch{}if(!Se.length)return Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438"),!0;let Oe=$.tr,De=ae;for(let he of Se)Oe=Oe.insert(De,he),De+=he.nodeSize;return Oe=Oe.setMeta(ue,!0),y.dispatch(Oe.scrollIntoView()),tn=!0,en({delayMs:200}),L.mode==="cut"&&Oi(null),ro(!1),Ee(`\u0412\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${Se.length}`),!0}}}catch{}try{let k=m&&!m.defaultPrevented&&!m.isComposing&&!m.metaKey&&!m.ctrlKey&&!m.altKey,M=k&&String(m?.key||"")==="\\",C=k&&(String(m?.code||"")==="Backslash"||String(m?.code||"")==="IntlBackslash");if(M){m.preventDefault();let{from:L,to:$}=y.state.selection,J=y.state.tr.insertText("\\",L,$).setMeta(ue,!0);return y.dispatch(J),!0}if(C)try{window?.localStorage?.getItem?.("ttree_outline_debug_tag_v1")==="1"&&console.log("[outline][tag-debug] backslash-code",{key:String(m?.key||""),code:String(m?.code||""),shiftKey:!!m?.shiftKey,altKey:!!m?.altKey,ctrlKey:!!m?.ctrlKey,metaKey:!!m?.metaKey})}catch{}}catch{}if(m&&m.__memusSyntheticAltProxy)return!1;let B="ttree_outline_debug_alt_v1",v=()=>{try{return window?.localStorage?.getItem?.(B)==="1"}catch{return!1}},R=k=>{try{return!!k?.getModifierState?.("AltGraph")}catch{return!1}};((k,M)=>{try{if(!v())return;let C=String(k?.key||""),L=String(k?.code||"");if(!C.startsWith("Arrow")&&L!=="Enter"&&L!=="NumpadEnter")return;let $={altKey:!!k?.altKey,ctrlKey:!!k?.ctrlKey,metaKey:!!k?.metaKey,shiftKey:!!k?.shiftKey,altGraph:R(k),repeat:!!k?.repeat,location:k?.location??null},J=[];$.metaKey&&J.push("Meta"),$.ctrlKey&&J.push("Ctrl"),$.altKey&&J.push($.altGraph?"AltGraph":"Alt"),$.shiftKey&&J.push("Shift"),J.push(L||C||"?"),console.log("[outline][alt-debug]",M,{key:C,code:L,name:J.join("-"),...$})}catch{}})(m,"keydown");let z=k=>{try{return!!k?.getModifierState?.("AltGraph")}catch{return!1}},j=k=>{try{return(!!k?.altKey||z(k))&&!k?.metaKey&&(!k?.ctrlKey||z(k))}catch{return!1}},D="ttree_outline_debug_nav_v1",T=()=>{try{return window?.localStorage?.getItem?.(D)==="1"}catch{return!1}},E=(k,M)=>{if(T())try{console.log("[outline][nav-debug]",k,M)}catch{}};try{let M=(Ie?.getState?.(y.state)||null)?.editingSectionId||null;E("keydown",{key:String(m?.key||""),code:String(m?.code||""),altKey:!!m?.altKey,altGraph:!!R(m),ctrlKey:!!m?.ctrlKey,metaKey:!!m?.metaKey,shiftKey:!!m?.shiftKey,repeat:!!m?.repeat,editingSectionId:M?String(M):null,selection:{empty:!!y.state?.selection?.empty,parent:y.state?.selection?.$from?.parent?.type?.name||null,parentOffset:y.state?.selection?.$from?.parentOffset??null,pos:y.state?.selection?.$from?.pos??null}});try{let K=(ae,Ae,ge)=>{try{let ke=je?.pmStateMod?.TextSelection;if(!ke)return!1;let Se=ae.doc.nodeAt(ge);if(!Se||Se.type?.name!=="outlineSection")return!1;let Oe=Se.child(0),he=ge+1+1,qe=ae.tr;return qe=qe.setSelection(ke.near(qe.doc.resolve(he),1)),Ae(qe.scrollIntoView()),!0}catch{return!1}},q=String(m?.key||""),Z=!m?.shiftKey&&!m?.metaKey&&!m?.ctrlKey&&!m?.altKey&&!R(m);if(!M&&Z&&(q==="ArrowUp"||q==="ArrowDown")){let ae=y.state,Ae=Bt(ae.doc,ae.selection.$from);if(E("nav.check",{key:q,sectionPos:Ae}),typeof Ae=="number"){let ge=(De,he)=>{try{let qe=De.resolve(Math.min(De.content.size,Math.max(0,he+1)));for(let Ke=qe.depth;Ke>0;Ke-=1){let et=qe.node(Ke);if(!(et?.type?.name!=="outlineSection"||qe.before(Ke)===he)&&et.attrs?.collapsed)return!1}return!0}catch{return!0}},Oe=q==="ArrowUp"?((De,he)=>{let qe=null;return De.nodesBetween(0,he,(Ke,et)=>{if(et>=he)return!1;Ke?.type?.name==="outlineSection"&&ge(De,et)&&(qe=et)}),qe})(ae.doc,Ae):((De,he)=>{let qe=null;return De.nodesBetween(he+1,De.content.size,(Ke,et)=>{if(qe!==null)return!1;et<=he||Ke?.type?.name==="outlineSection"&&ge(De,et)&&(qe=et)}),qe})(ae.doc,Ae);if(E("nav.target",{key:q,sectionPos:Ae,target:Oe}),typeof Oe=="number"){let De=K(ae,y.dispatch,Oe);if(E("nav.apply",{ok:De}),De)return m.preventDefault(),m.stopPropagation(),!0}}}}catch{}let C=!!R(m)&&!m?.altKey&&!m?.ctrlKey&&!m?.metaKey&&!m?.shiftKey,L=String(m?.key||""),$=String(m?.code||"");if(!M&&C&&(L==="ArrowUp"||L==="ArrowDown"||L==="ArrowLeft"||L==="ArrowRight")){let K=null;try{K=new KeyboardEvent("keydown",{key:L,code:$||L,altKey:!0,ctrlKey:!1,metaKey:!1,shiftKey:!1,bubbles:!0,cancelable:!0});try{Object.defineProperty(K,"__memusSyntheticAltProxy",{value:!0})}catch{}}catch{K=null}if(K||(K={key:L,code:$||L,altKey:!0,ctrlKey:!1,metaKey:!1,shiftKey:!1,bubbles:!0,cancelable:!0,__memusSyntheticAltProxy:!0,preventDefault(){},stopPropagation(){},getModifierState(Z){return!1}}),!!y?.someProp?.("handleKeyDown",Z=>Z(y,K)))return m.preventDefault(),m.stopPropagation(),!0}}catch{}try{if(j(m)){let k=String(m.key||"");if((k==="ArrowUp"||k==="ArrowDown")&&m.repeat){let M=y?.state?.selection?.$from}}}catch{}ot("editorProps.keydown",{key:m?.key||null,repeat:!!m?.repeat,selection:{empty:!!y.state?.selection?.empty,parent:y.state?.selection?.$from?.parent?.type?.name||null,parentOffset:y.state?.selection?.$from?.parentOffset??null,pos:y.state?.selection?.$from?.pos??null}});try{let k=je?.pmStateMod?.TextSelection;if(k){let C=(Ie?.getState?.(y.state)||null)?.editingSectionId||null,L=(m.key==="Enter"||m.code==="Enter"||m.code==="NumpadEnter")&&(m.ctrlKey||m.metaKey)&&!m.shiftKey&&!m.altKey;if(!d.isPublicView&&!C&&L){let $=y.state.selection,J=$?.$from||null;if(J){let K=Bt(y.state.doc,J),q=typeof K=="number"?y.state.doc.nodeAt(K):null;if(typeof K=="number"&&q?.type?.name==="outlineSection"){let Z=!!($&&$.empty),ae=J.parent?.type?.name==="outlineHeading",ge=Z&&ae&&J.parentOffset===0?K:K+q.nodeSize,ke=y.state.schema,Se=Xt(),Oe=ke.nodes.outlineSection.create({id:Se,collapsed:!1},[ke.nodes.outlineHeading.create({},[]),ke.nodes.outlineBody.create({},[ke.nodes.paragraph.create({},[])]),ke.nodes.outlineChildren.create({},[])]),De=y.state.tr.insert(ge,Oe);try{let qe=De.doc.nodeAt(ge)?.child?.(0)||Oe.child(0),Ke=ge+1+qe.nodeSize;De=De.setSelection(k.near(De.doc.resolve(Ke+2),1))}catch{De=De.setSelection(k.create(De.doc,ge+2))}De=De.setMeta(ue,!0),Ie&&(De=De.setMeta(Ie,{type:"enter",sectionId:Se})),y.dispatch(De.scrollIntoView());try{y.focus()}catch{}return m.preventDefault(),m.stopPropagation(),!0}}}}}catch{}try{let k=j(m)&&!m.shiftKey,M=String(m.key||"");if(k&&(M==="ArrowLeft"||M==="ArrowRight"||M==="ArrowUp"||M==="ArrowDown")&&(Ie?.getState?.(y.state)||null)?.editingSectionId&&ie){let L=()=>{try{let $=y?.state?.selection?.$from||null;if(!$)return!1;for(let J=$.depth;J>0;J-=1){let K=$.node(J)?.type?.name;if(K==="table"||K==="tableRow"||K==="tableCell"||K==="tableHeader")return!0}return!1}catch{return!1}};if(M==="ArrowLeft"||M==="ArrowRight"){let $=ie.chain().focus();$.command(({tr:K})=>(K.setMeta(ue,!0),!0));let J=!1;if(ie.isActive("bulletList")||ie.isActive("orderedList")?M==="ArrowRight"?J=$.sinkListItem("listItem").run():(J=$.liftListItem("listItem").run(),!J&&ie.isActive("bulletList")&&(J=$.toggleBulletList().run()),!J&&ie.isActive("orderedList")&&(J=$.toggleOrderedList().run())):M==="ArrowRight"&&(J=$.toggleBulletList().run()),J)return m.preventDefault(),m.stopPropagation(),!0}else if((M==="ArrowUp"||M==="ArrowDown")&&(M==="ArrowUp"?Nd(ie,-1)||Bd(ie,-1):Nd(ie,1)||Bd(ie,1)))return m.preventDefault(),m.stopPropagation(),!0}}catch{}try{if((m.ctrlKey||m.metaKey)&&!m.altKey&&!m.shiftKey&&(m.code==="KeyA"||String(m.key||"").toLowerCase()==="a")){let M=je?.pmStateMod?.TextSelection;if(!M)return ot("editorProps.modA",{handled:!1,reason:"no-TextSelection"}),!1;let C=y.state,L=C.selection,$=L?.$from||null;if(!$)return ot("editorProps.modA",{handled:!1,reason:"no-$from"}),!1;let J=Bt(C.doc,$);if(typeof J!="number")return ot("editorProps.modA",{handled:!1,reason:"no-sectionPos"}),!1;let K=C.doc.nodeAt(J);if(!K||K.type?.name!=="outlineSection")return ot("editorProps.modA",{handled:!1,reason:"not-outlineSection"}),!1;let q=K.child(0),Z=K.child(1);if(!q||!Z)return ot("editorProps.modA",{handled:!1,reason:"missing-heading/body"}),!1;let ae=J+1,Ae=ae+1,ge=ae+q.nodeSize-1,ke=J+1+q.nodeSize,Se=ke+1,Oe=ke+Z.nodeSize-1,De=Oe;try{let nt=null;C.doc.nodesBetween(Se,Math.min(C.doc.content.size,Oe),(St,Mt)=>{St?.isTextblock&&(nt=Mt+St.nodeSize-1)}),typeof nt=="number"&&(De=nt)}catch{}De<Se&&(De=ge);let he=Ae,qe=(()=>{try{for(let nt=$.depth;nt>0;nt-=1)if($.node(nt)?.type?.name==="outlineHeading")return!0}catch{}return!1})(),Ke=!!L&&typeof L.from=="number"&&typeof L.to=="number"&&Math.min(L.from,L.to)===he&&Math.max(L.from,L.to)===De;if(qe&&Ke)return ot("editorProps.modA",{handled:!1,reason:"pass-through-doc-select"}),!1;m.preventDefault(),m.stopPropagation();let et=M.create(C.doc,he,De);return y.dispatch(C.tr.setSelection(et)),ot("editorProps.modA",{handled:!0,blockFrom:he,blockTo:De,isInHeading:qe,alreadySelectedBlock:Ke}),!0}}catch{}try{if(!Ie)return!1;let M=(Ie.getState(y.state)||{}).editingSectionId||null;if(!M){let C=(m.ctrlKey||m.metaKey)&&!m.altKey&&!m.shiftKey&&(m.key==="Delete"||m.key==="Del"||m.key==="Backspace"),L=m.key==="Backspace"||m.key==="Delete",$=m.key&&m.key.length===1&&!m.metaKey&&!m.ctrlKey&&!m.altKey,J=!m.metaKey&&!m.ctrlKey&&!m.altKey&&!m.shiftKey&&(m.key===" "||m.key==="Spacebar");if(C){let K=Bt(y.state.doc,y.state.selection.$from),q=!1;try{typeof K=="number"&&(q=pe(y.state,y.dispatch,K))}catch{q=!1}return ot("editorProps.modDelete",{ok:q,sectionPos:K}),m.preventDefault(),m.stopPropagation(),!0}if(J){let K=document.activeElement;if(!(!!(K&&K.closest&&K.closest(".outline-editor"))||!!(m?.target&&m.target.closest&&m.target.closest(".outline-editor"))))return!1;if(m.repeat)return m.preventDefault(),m.stopPropagation(),!0;let Z=m?.target||null,ae=String(Z?.tagName||"").toLowerCase();if(ae==="button"||ae==="input"||ae==="textarea"||ae==="select"||Z?.closest?.("button, a[href], input, textarea, select")||!!!Z?.closest?.(".outline-prosemirror")&&Z?.closest?.('[contenteditable="true"]'))return!1;let ge=Bt(y.state.doc,y.state.selection.$from);if(typeof ge!="number")return m.preventDefault(),m.stopPropagation(),!0;let ke=y.state.doc.nodeAt(ge);if(!ke)return m.preventDefault(),m.stopPropagation(),!0;let Se=!ke.attrs?.collapsed,Oe=y.state.tr.setNodeMarkup(ge,void 0,{...ke.attrs,collapsed:Se});Oe=Oe.setMeta(ue,!0);try{let De=ke.child(0),qe=ge+1+De.nodeSize-1,{TextSelection:Ke}=je?.pmStateMod||{};Ke&&(Oe=Oe.setSelection(Ke.near(Oe.doc.resolve(qe),-1)))}catch{}return m.preventDefault(),m.stopPropagation(),y.dispatch(Oe.scrollIntoView()),!0}if(L){if(m.key==="Backspace")try{let K=y.state,q=K.selection,Z=q?.$from||null,ae=null;try{for(let ke=Z?.depth||0;ke>0;ke-=1)if(Z.node(ke)?.type?.name==="outlineHeading"){ae=ke;break}}catch{ae=null}let Ae=ae!==null&&Z?Z.start(ae):null,ge=!!(q&&q.empty)&&!!Z&&ae!==null&&typeof Ae=="number"&&Z.pos===Ae;if(ot("editorProps.backspace.check",{empty:!!q?.empty,headingDepth:ae,headingStart:Ae,pos:Z?.pos??null,parent:Z?.parent?.type?.name||null,parentOffset:Z?.parentOffset??null,atHeadingStart:ge}),ge){let ke=Bt(K.doc,Z),Se=typeof ke=="number"?K.doc.nodeAt(ke):null;if(ot("editorProps.backspace.sectionPos",{sectionPos:ke,hasNode:!!Se}),typeof ke=="number"&&Se){let Oe=String(Se.attrs?.id||""),De=null;try{let qe=K.doc.resolve(ke),Ke=qe.index(),et=qe.parent;if(et&&Ke>0){let nt=et.child(Ke-1),St=ke-nt.nodeSize,Mt=K.doc.nodeAt(St);De=String(Mt?.attrs?.id||"")||null}else for(let nt=Z.depth-1;nt>0;nt-=1){let St=Z.node(nt);if(St?.type?.name==="outlineSection"){let Mt=String(St.attrs?.id||"");if(Mt&&Mt!==Oe){De=Mt;break}}}}catch{De=null}ot("editorProps.backspace.mergeCandidate",{sectionPos:ke,currentSectionId:Oe,targetSectionId:De});let he=!1;if(me(Se))he=pe(K,y.dispatch,ke);else try{K.doc.resolve(ke).index()<=0?he=Ce(K,y.dispatch,ke):he=fe(K,y.dispatch,ke)}catch{he=fe(K,y.dispatch,ke)}return ot("editorProps.backspace.mergeDone",{ok:he,targetSectionId:De}),he&&De&&Ie&&window.setTimeout(()=>{try{if((Ie.getState(y.state)||{}).editingSectionId)return;let Ke=gt(y.state.doc,De),et=typeof Ke=="number"?y.state.doc.nodeAt(Ke):null;if(!et)return;let nt=y.state.tr;et?.attrs?.collapsed&&(nt=nt.setNodeMarkup(Ke,void 0,{...et.attrs,collapsed:!1}),nt=nt.setMeta(ue,!0)),nt=nt.setMeta(Ie,{type:"enter",sectionId:De});try{let St=nt.doc.nodeAt(Ke);if(St&&St.type?.name==="outlineSection"){let Mt=St.child(0),Jt=St.child(1),Q=Ke+1+Mt.nodeSize+Jt.nodeSize-1;nt=nt.setSelection(f.near(nt.doc.resolve(Q),-1))}}catch{}y.dispatch(nt.scrollIntoView());try{y.focus()}catch{}ot("editorProps.backspace.enterEdit.done",{targetSectionId:De})}catch{}},0),m.preventDefault(),m.stopPropagation(),!0}}}catch{}return m.preventDefault(),m.stopPropagation(),!0}if($)return m.preventDefault(),m.stopPropagation(),Wn(),!0}if(d.isPublicView&&!M&&(m.key==="Enter"&&!m.shiftKey&&!m.ctrlKey&&!m.metaKey&&!m.altKey||m.key==="F2"&&!m.shiftKey&&!m.ctrlKey&&!m.metaKey&&!m.altKey))return m.preventDefault(),m.stopPropagation(),!0;if(!M&&(m.key==="Enter"&&!m.shiftKey&&!m.ctrlKey&&!m.metaKey&&!m.altKey||m.key==="F2"&&!m.shiftKey&&!m.ctrlKey&&!m.metaKey&&!m.altKey)){let C=Bt(y.state.doc,y.state.selection.$from);if(typeof C!="number")return!1;let L=y.state.doc.nodeAt(C),$=String(L?.attrs?.id||"");if(!$)return!1;if(m.preventDefault(),m.stopPropagation(),L?.attrs?.collapsed){let J=y.state.tr.setNodeMarkup(C,void 0,{...L.attrs,collapsed:!1});return J.setMeta(ue,!0),y.dispatch(J.scrollIntoView()),!0}return y.dispatch(y.state.tr.setMeta(Ie,{type:"enter",sectionId:$})),!0}if(M&&m.key==="Escape"){m.preventDefault(),m.stopPropagation();let C=M;y.dispatch(y.state.tr.setMeta(Ie,{type:"exit"}));try{let L=ie;if(L&&!L.isDestroyed){let $=Br(y.state.doc,C);Dd(L,y.state.doc,C),$&&en({delayMs:350})}}catch{}return!0}}catch{}return!1},handleDOMEvents:{click(y,m){try{let B=m.target?.closest?.("a[href]");if(!B||!Ie)return!1;let v=String(B.getAttribute("href")||"").trim();if(!v)return!1;if(d.isPublicView){let E=String(B.getAttribute("rel")||"").split(/\s+/).filter(Boolean);if(B.getAttribute("data-unpublished")==="1"||E.includes("unpublished")||v==="#")return alert("\u042D\u0442\u0430 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435 \u043E\u043F\u0443\u0431\u043B\u0438\u043A\u043E\u0432\u0430\u043D\u0430"),m.preventDefault(),m.stopPropagation(),!0}if(v.startsWith("app:/")||v.startsWith("disk:/")){m.preventDefault(),m.stopPropagation();let T=Un(v);if(T)return window.open(T,"_blank","noopener,noreferrer"),!0}if((Ie.getState(y.state)||{}).editingSectionId||null)return!1;let z=T=>{let E=String(T||"").trim();if(!E||E.startsWith("/")||E.startsWith("#")||/\s/.test(E)||E.includes("://")||/^[a-z][a-z0-9+.-]*:/i.test(E))return!1;let k=E.split(/[/?#]/,1)[0];return!(!k||!k.includes(".")||k.startsWith(".")||k.endsWith(".")||k.includes(".."))},j=T=>{let E=String(T||"").trim();return E&&(E.startsWith("//")?`https:${E}`:z(E)?`https://${E}`:E)};if(m.preventDefault(),m.stopPropagation(),v.startsWith("/"))return d.isPublicView?(window.location.href=v,!0):(wn(v),!0);let D=j(v);return/^https?:\/\//i.test(D)||/^mailto:/i.test(D)||/^tel:/i.test(D),window.open(D,"_blank","noopener,noreferrer"),!0}catch{return!1}},beforeinput(y,m){try{if(!Ie)return!1;let v=(Ie.getState(y.state)||{}).editingSectionId||null;if(v)return!1;let R=String(m?.inputType||"");if(R.startsWith("history"))return!1;if(ot("beforeinput",{inputType:R,key:m?.data??null,editingSectionId:v||null,selection:{empty:!!y.state?.selection?.empty,parent:y.state?.selection?.$from?.parent?.type?.name||null,parentOffset:y.state?.selection?.$from?.parentOffset??null}}),R==="deleteContentBackward"){try{let P=y.state,z=P.selection,j=z?.$from||null,D=null;try{for(let k=j?.depth||0;k>0;k-=1)if(j.node(k)?.type?.name==="outlineHeading"){D=k;break}}catch{D=null}let T=D!==null&&j?j.start(D):null,E=!!(z&&z.empty)&&!!j&&D!==null&&typeof T=="number"&&j.pos===T;if(ot("beforeinput.deleteContentBackward.check",{empty:!!z?.empty,headingDepth:D,headingStart:T,pos:j?.pos??null,parent:j?.parent?.type?.name||null,parentOffset:j?.parentOffset??null,atHeadingStart:E}),E){let k=Bt(P.doc,j),M=typeof k=="number"?P.doc.nodeAt(k):null;if(typeof k=="number"&&M){let C=String(M.attrs?.id||"");ot("beforeinput.deleteContentBackward.candidate",{sectionPos:k,currentSectionId:C});let L=null;try{let J=P.doc.resolve(k),K=J.index(),q=J.parent;if(q&&K>0){let Z=q.child(K-1),ae=k-Z.nodeSize,Ae=P.doc.nodeAt(ae);L=String(Ae?.attrs?.id||"")||null}else for(let Z=j.depth-1;Z>0;Z-=1){let ae=j.node(Z);if(ae?.type?.name==="outlineSection"){let Ae=String(ae.attrs?.id||"");if(Ae&&Ae!==C){L=Ae;break}}}}catch{L=null}let $=!1;if(me(M))ot("beforeinput.merge",{kind:"deleteEmpty",sectionPos:k}),$=pe(P,y.dispatch,k);else try{P.doc.resolve(k).index()<=0?(ot("beforeinput.merge",{kind:"intoParent",sectionPos:k,targetSectionId:L}),$=Ce(P,y.dispatch,k)):(ot("beforeinput.merge",{kind:"intoPrev",sectionPos:k,targetSectionId:L}),$=fe(P,y.dispatch,k))}catch{ot("beforeinput.merge",{kind:"intoPrev.catch",sectionPos:k,targetSectionId:L}),$=fe(P,y.dispatch,k)}return ot("beforeinput.merge.done",{ok:$,targetSectionId:L}),$&&L&&window.setTimeout(()=>{try{if((Ie.getState(y.state)||{}).editingSectionId)return;let K=gt(y.state.doc,L),q=typeof K=="number"?y.state.doc.nodeAt(K):null;if(!q)return;let Z=y.state.tr;q?.attrs?.collapsed&&(Z=Z.setNodeMarkup(K,void 0,{...q.attrs,collapsed:!1}),Z=Z.setMeta(ue,!0)),Z=Z.setMeta(Ie,{type:"enter",sectionId:L});try{let ae=y.state.doc.nodeAt(K);if(ae&&ae.type?.name==="outlineSection"){let Ae=ae.child(0),ge=K+1+Ae.nodeSize,ke=Math.min(Z.doc.content.size,ge+2);Z=Z.setSelection(f.create(Z.doc,ke))}}catch{}y.dispatch(Z.scrollIntoView());try{y.focus()}catch{}ot("beforeinput.enterEdit.done",{targetSectionId:L})}catch{}},0),m.preventDefault(),m.stopPropagation(),!0}}}catch{}return ot("beforeinput.deleteContentBackward.block",{inputType:R}),m.preventDefault(),m.stopPropagation(),!0}return R.startsWith("delete")?(ot("beforeinput.delete.block",{inputType:R}),m.preventDefault(),m.stopPropagation(),!0):(m.preventDefault(),m.stopPropagation(),Wn(),!0)}catch{return!1}},dblclick(y,m){try{if(d.isPublicView||!Ie||(Ie.getState(y.state)||{}).editingSectionId||null)return!1;let R=m?.target&&m.target.closest&&m.target.closest('[data-outline-heading="true"]')||m?.target&&m.target.closest&&m.target.closest(".outline-heading"),P=m?.target&&m.target.closest&&m.target.closest('[data-outline-body="true"]')||m?.target&&m.target.closest&&m.target.closest(".outline-body");if(!R&&!P)return!1;let z={left:m.clientX,top:m.clientY},j=y.posAtCoords(z),D=j&&typeof j.pos=="number"?j.pos:null;if(typeof D!="number")return!1;let T=y.state.doc.resolve(Math.max(0,Math.min(y.state.doc.content.size,D))),E=Bt(y.state.doc,T);if(typeof E!="number")return!1;let k=y.state.doc.nodeAt(E),M=String(k?.attrs?.id||"");if(!M)return!1;window.setTimeout(()=>{try{if((Ie.getState(y.state)||{}).editingSectionId)return;let L=gt(y.state.doc,M),$=typeof L=="number"?y.state.doc.nodeAt(L):null,J=!!$?.attrs?.collapsed,K=y.state.tr;if(J&&typeof L=="number"&&$&&(K=K.setNodeMarkup(L,void 0,{...$.attrs,collapsed:!1}),K=K.setMeta(ue,!0)),J){y.dispatch(K.scrollIntoView());try{y.focus()}catch{}return}K=K.setMeta(Ie,{type:"enter",sectionId:M});try{let{TextSelection:q}=je?.pmStateMod||{},Z=typeof L=="number"?K.doc.nodeAt(L):null;if(Z&&Z.type?.name==="outlineSection"){let ae=Z.child(0),Ae=L+1+ae.nodeSize,ge=Math.min(K.doc.content.size,Ae+2);q&&(K=K.setSelection(q.near(K.doc.resolve(ge),1)))}}catch{}y.dispatch(K.scrollIntoView());try{y.focus()}catch{}}catch{}},0)}catch{}return!1}}},onCreate:({editor:y})=>{if(st&&d.articleId&&d.article&&!d.article.encrypted)try{let m=y.getJSON();d.article.docJson=m,Cc(d.articleId,m).catch(()=>{})}catch{}try{Ym(y.state.doc)}catch{}_r.clear();try{oo.clear()}catch{}tn=!1,Od=null,hn=null;try{Ri=Ad(y.state.doc),Fn=!1;try{Tn.clear()}catch{Tn.clear()}Ut&&(clearTimeout(Ut),Ut=null)}catch{}er("")},onUpdate:()=>{tn=!0;try{let y=Ie?.getState?.(ie?.state)||null,m=String(y?.editingSectionId||"").trim();if(m){let B=ie?.state?.doc||null;B&&Br(B,m)&&dm(ie)}}catch{}try{let y=ie?.state?.doc||null;if(y){let m=Ad(y);m&&m!==Ri&&(Ri=m,lm({articleId:bt||d.articleId,editor:ie}))}}catch{}try{Md(ie)}catch{}en({delayMs:1500})},onSelectionUpdate:({editor:y})=>{let{state:m}=y,{selection:B}=m;if(!B)return;let v=Bt(m.doc,B.$from);if(typeof v!="number")return;let R=m.doc.nodeAt(v),P=String(R?.attrs?.id||"");if(!P)return;try{let D=(Ie?.getState?.(m)||null)?.editingSectionId||null;D&&D!==P&&y.view.dispatch(m.tr.setMeta(Ie,{type:"exit"}))}catch{}if(hn&&hn!==P){let j=Br(m.doc,hn);try{Ft("leave_section",{from:hn,to:P,changed:j})}catch{}try{oo.has(hn)&&Dd(y,m.doc,hn)}catch{}j&&en({delayMs:350})}let z=hn;hn=P;try{Md(y)}catch{}try{(Ie?.getState?.(m)||null)?.editingSectionId||Km(y,{lines:5})}catch{}}}),Pe&&no("new Editor()",{ms:Math.round(performance.now()-Pe)});try{let y=ie?.state?.doc?.content?.size??null;pr("outline.mount.editorCreated",{outlineArticleId:bt,docSize:y})}catch{}try{(bt||d.articleId)&&(im(bt||d.articleId),navigator.onLine&&Fd(bt||d.articleId))}catch{}e.focus?.({preventScroll:!0}),qi=y=>{try{if(!ie)return;let m=ie.state.tr.setMeta(xe,{activeKey:y||null});ie.view.dispatch(m)}catch{}};try{Jd()}catch{}try{let y=vr()?performance.now():0;Am(ie),y&&no("convertMarkdownTablesInOutlineDoc()",{ms:Math.round(performance.now()-y)})}catch{}t&&no("mountOutlineEditor() total",{ms:Math.round(performance.now()-t)})})();try{await Mo}finally{Mo=null,pr("outline.mount.done",{outlineArticleId:bt,hasInstance:!!ie})}}function Oo(e=""){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}async function Qm(e={}){if(d.isPublicView||!d.articleId||!d.article||!ie)return;let t=bt||d.articleId;if(!t)return;let n=!!e.silent,r=e&&typeof e.mode=="string"?e.mode:"network",o=Array.from(new Set([..._r||[],hn].filter(Boolean))),i=(s,a)=>{let c=s?String(s):"",l=a?String(a):"";return c?l?c>=l?c:l:c||null:l||null};try{if(n||Qi("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C outline\u2026"),d.article.encrypted){n||(Sr(),Ee("Outline-\u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u0435 docJson \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0434\u043B\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0445 \u0441\u0442\u0430\u0442\u0435\u0439"));return}let s=ie.getJSON(),a=om(s);if(d.articleId&&t!==d.articleId){await bn(t,a,d.article?.updatedAt||null).catch(()=>{}),n||Sr(),er("\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0447\u0435\u0440\u043D\u043E\u0432\u0438\u043A \u0441\u043E\u0445\u0440\u0430\u043D\u0451\u043D \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E");return}let c=Date.now();await bn(t,a,d.article?.updatedAt||null).catch(()=>{});try{hn&&Br(ie.state.doc,hn)}catch{}if(!0){let u=Tn.size?Array.from(Tn):[];try{u.length&&(Tn.clear(),await on("delete_sections",{articleId:t,payload:{sectionIds:u,clientQueuedAt:c},coalesceKey:`delete:${t}`}))}catch{}n||Sr(),d.article&&(d.article.docJson=a),tn=!1,Od=new Date,er("\u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E");try{Jd()}catch{}try{Xm(ie,ie.state.doc,o)}catch{}return}}catch(s){n?er("\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F"):(Sr(),Ee(s?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C outline"));try{let a=ie.getJSON();a&&typeof a=="object"&&await bn(t,a,d.article?.updatedAt||null).catch(()=>{})}catch{}en({delayMs:5e3})}}function Zm(){return hn||null}function eh(){try{if(!ie||ie.isDestroyed)return null;let e=ie.state,t=Bt(e.doc,e.selection.$from);if(typeof t!="number")return null;let n=e.doc.nodeAt(t);if(!n||n.type?.name!=="outlineSection")return null;let r=String(n.attrs?.id||"").trim();return r?{sectionId:r,collapsed:!!n.attrs?.collapsed}:null}catch{return null}}function th(e,t){try{let n=String(t||"");if(!e||!n)return null;let r=(i,s,a)=>{if(!i||i.type?.name!=="outlineSection")return null;let c=String(i.attrs?.id||""),l=[...a,s];if(c===n)return l;let u=i.child(0),h=i.child(1),g=i.child(2);if(!g||g.type?.name!=="outlineChildren")return null;let S=s+1+u.nodeSize+h.nodeSize+1;for(let p=0;p<g.childCount;p+=1){let f=g.child(p),w=S;S+=f.nodeSize;let x=r(f,w,l);if(x)return x}return null},o=0;for(let i=0;i<e.childCount;i+=1){let s=e.child(i),a=o;o+=s.nodeSize;let c=r(s,a,[]);if(c)return c}return null}catch{return null}}function au(e,t={}){try{if(!ie||ie.isDestroyed)return!1;let n=String(e||"");if(!n)return!1;let{state:r,view:o}=ie,i=je?.pmStateMod?.TextSelection,s=th(r.doc,n);if(!Array.isArray(s)||!s.length)return!1;let a=r.tr;for(let c of s){let l=a.doc.nodeAt(c);!l||l.type?.name!=="outlineSection"||l.attrs?.collapsed&&(a=a.setNodeMarkup(c,void 0,{...l.attrs,collapsed:!1}))}a=a.setMeta(ue,!0);try{let c=gt(a.doc,n),l=typeof c=="number"?a.doc.nodeAt(c):null;if(typeof c=="number"&&l?.type?.name==="outlineSection"){let u=l.child(0),h=c+1+u.nodeSize,g=Math.min(a.doc.content.size,h+2);i&&(a=a.setSelection(i.create(a.doc,g)))}}catch{}o.dispatch(a.scrollIntoView());try{let c=typeof CSS<"u"&&CSS.escape?CSS.escape(n):n.replace(/"/g,'\\"');window.requestAnimationFrame(()=>{try{let l=o.dom?.querySelector?.(`[data-outline-section][data-section-id="${c}"]`)||o.dom?.querySelector?.(`[data-section-id="${c}"]`);l&&typeof l.scrollIntoView=="function"&&l.scrollIntoView({block:"center",inline:"nearest"})}catch{}})}catch{}if(t&&t.focus)try{o.focus()}catch{}return!0}catch{return!1}}function nh(e,t){if(!ie)return!1;let n=String(e||"");if(!n)return!1;let r=gt(ie.state.doc,n);if(typeof r!="number")return!1;let o=ie.state.doc.nodeAt(r);if(!o)return!1;let i=ie.state.doc.type.schema,s=Jn(String(t||"")),a=La(s.titleHtml||"")||La(s.bodyHtml||"").slice(0,80)||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",c=Ro?Ro(s.bodyHtml||""):[],l=[];for(let p of c||[])try{l.push(i.nodeFromJSON(p))}catch{}l.length||l.push(i.nodes.paragraph.create({},[]));let u=i.nodes.outlineHeading.create({},a?[i.text(a)]:[]),h=i.nodes.outlineBody.create({},l),g=o.child(2),b=i.nodes.outlineSection.create(o.attrs,[u,h,g]),S=ie.state.tr.replaceWith(r,r+o.nodeSize,b);try{let p=je?.pmStateMod?.TextSelection;p&&(S=S.setSelection(p.create(S.doc,r+2)))}catch{}return ie.view.dispatch(S),ie.view.focus(),tn=!0,en({delayMs:200}),!0}function rh(e,t){if(!ie)return!1;let n=String(e||"");if(!n)return!1;let r=gt(ie.state.doc,n);if(typeof r!="number")return!1;let o=ie.state.doc.nodeAt(r);if(!o)return!1;let i=t&&typeof t=="object"?t:{},s=ie.state.doc.type.schema,a=null,c=null;try{i.heading&&typeof i.heading=="object"&&(a=s.nodeFromJSON(i.heading))}catch{a=null}try{i.body&&typeof i.body=="object"&&(c=s.nodeFromJSON(i.body))}catch{c=null}(!a||a.type?.name!=="outlineHeading")&&(a=s.nodes.outlineHeading.create({},[])),(!c||c.type?.name!=="outlineBody")&&(c=s.nodes.outlineBody.create({},[s.nodes.paragraph.create({},[])])),c.childCount||(c=s.nodes.outlineBody.create({},[s.nodes.paragraph.create({},[])]));let l=o.child(2),u=s.nodes.outlineSection.create(o.attrs,[a,c,l]),h=ie.state.tr.replaceWith(r,r+o.nodeSize,u);try{let g=je?.pmStateMod?.TextSelection;g&&(h=h.setSelection(g.create(h.doc,r+2)))}catch{}return ie.view.dispatch(h),ie.view.focus(),tn=!0,en({delayMs:200}),!0}function oh(e,t){if(!ie)return!1;let n=String(e||"").trim();if(!n||typeof gt(ie.state.doc,n)=="number")return!1;let o=t&&typeof t=="object"?t:{},i=ie.state.doc.type.schema,s=null,a=null;try{o.heading&&typeof o.heading=="object"&&(s=i.nodeFromJSON(o.heading))}catch{s=null}try{o.body&&typeof o.body=="object"&&(a=i.nodeFromJSON(o.body))}catch{a=null}(!s||s.type?.name!=="outlineHeading")&&(s=i.nodes.outlineHeading.create({},[])),(!a||a.type?.name!=="outlineBody")&&(a=i.nodes.outlineBody.create({},[i.nodes.paragraph.create({},[])])),a.childCount||(a=i.nodes.outlineBody.create({},[i.nodes.paragraph.create({},[])]));let c=i.nodes.outlineChildren.create({},[]),l=i.nodes.outlineSection.create({id:n,collapsed:!1},[s,a,c]),u=ie.state.doc.content.size,h=ie.state.tr.insert(u,l);try{let g=je?.pmStateMod?.TextSelection;if(g){let b=Math.min(h.doc.content.size,u+2);h=h.setSelection(g.near(h.doc.resolve(Math.max(0,b)),1))}}catch{}return h=h.setMeta(ue,!0),ie.view.dispatch(h.scrollIntoView()),ie.view.focus(),tn=!0,en({delayMs:200}),!0}function ih({enterEditMode:e=!0}={}){if(!ie)return null;let t=ie.state.doc.type.schema,n=ie.state.doc.content.size,r=Xt(),o=t.nodes.outlineSection.create({id:r,collapsed:!1},[t.nodes.outlineHeading.create({},[]),t.nodes.outlineBody.create({},[t.nodes.paragraph.create({},[])]),t.nodes.outlineChildren.create({},[])]),i=ie.state.tr.insert(n,o);try{let s=je?.pmStateMod?.TextSelection;if(s){let a=gt(i.doc,r),c=typeof a=="number"?Wi(i.doc,a):null;typeof c=="number"?i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,c+2)),1)):i=i.setSelection(s.create(i.doc,n+2))}}catch{}return i=i.setMeta(ue,!0),e&&Ie&&(i=i.setMeta(Ie,{type:"enter",sectionId:r})),ie.view.dispatch(i.scrollIntoView()),ie.view.focus(),tn=!0,en({delayMs:200}),r}function Wi(e,t){try{let n=e.nodeAt(t);if(!n||n.type?.name!=="outlineSection")return null;let r=n.child(0);return t+1+r.nodeSize}catch{return null}}function sh(e,{focusBody:t=!0}={}){if(!ie||!Ie)return!1;let n=String(e||"").trim();if(!n)return!1;let r=gt(ie.state.doc,n);if(typeof r!="number"||ie.state.doc.nodeAt(r)?.attrs?.collapsed)return!1;let i=ie.state.tr;if(t)try{let s=je?.pmStateMod?.TextSelection,a=Wi(i.doc,r);s&&typeof a=="number"&&(i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,a+2)),1)))}catch{}return i=i.setMeta(ue,!0),i=i.setMeta(Ie,{type:"enter",sectionId:n}),ie.view.dispatch(i.scrollIntoView()),ie.view.focus(),!0}function ah({enterEditMode:e=!0}={}){if(!ie)return null;let t=ie.state.doc.type.schema,n=0,r=Xt(),o=t.nodes.outlineSection.create({id:r,collapsed:!1},[t.nodes.outlineHeading.create({},[]),t.nodes.outlineBody.create({},[t.nodes.paragraph.create({},[])]),t.nodes.outlineChildren.create({},[])]),i=ie.state.tr.insert(n,o);try{let s=je?.pmStateMod?.TextSelection;if(s){let a=gt(i.doc,r),c=typeof a=="number"?Wi(i.doc,a):null;typeof c=="number"?i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,c+2)),1)):i=i.setSelection(s.create(i.doc,n+2))}}catch{}return i=i.setMeta(ue,!0),e&&Ie&&(i=i.setMeta(Ie,{type:"enter",sectionId:r})),ie.view.dispatch(i.scrollIntoView()),ie.view.focus(),tn=!0,en({delayMs:200}),r}function ch(e,t,{enterEditMode:n=!1}={}){if(!ie)return!1;let r=String(e||"").trim();if(!r||typeof gt(ie.state.doc,r)=="number")return!1;let i=ie.state.doc.type.schema,s=i.nodes.paragraph,a=i.nodes.hardBreak||i.nodes.hard_break||null,c=String(t||"").replace(/\r\n/g,`
`).trimEnd(),l=()=>{if(!s)return[];if(!c.trim())return[s.create({},[])];let f=c.split(/\n{2,}/),w=[];for(let x of f){let A=String(x||"").split(`
`),I=[];for(let N=0;N<A.length;N+=1){let O=A[N];N>0&&a&&I.push(a.create()),O&&I.push(i.text(O))}w.push(s.create({},I))}return w.length?w:[s.create({},[])]},u=i.nodes.outlineHeading.create({},[]),h=i.nodes.outlineBody.create({},l()),g=i.nodes.outlineChildren.create({},[]),b=i.nodes.outlineSection.create({id:r,collapsed:!1},[u,h,g]),S=0,p=ie.state.tr.insert(S,b);try{let f=je?.pmStateMod?.TextSelection;if(f){let w=gt(p.doc,r),x=typeof w=="number"?Wi(p.doc,w):null;typeof x=="number"?p=p.setSelection(f.near(p.doc.resolve(Math.min(p.doc.content.size,x+2)),1)):p=p.setSelection(f.create(p.doc,S+2))}}catch{}return p=p.setMeta(ue,!0),n&&Ie&&(p=p.setMeta(Ie,{type:"enter",sectionId:r})),ie.view.dispatch(p.scrollIntoView()),ie.view.focus(),tn=!0,en({delayMs:200}),!0}async function lh(){if(d.isPublicView||d.isRagView){Ee("Outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0432 \u044D\u0442\u043E\u043C \u0440\u0435\u0436\u0438\u043C\u0435");return}if(!d.articleId||!d.article){Ee("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}if(bt=d.articleId,pr("outline.open.start",{outlineArticleId:bt,updatedAt:d.article?.updatedAt||null,docHash:Ht(d.article?.docJson||null)}),!V.outlineEditor||!V.blocksContainer){Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440");return}d.isOutlineEditing=!0,V.articleToolbar&&V.articleToolbar.classList.add("hidden"),V.outlineToolbar&&V.outlineToolbar.classList.remove("hidden"),V.outlineTagsBar&&V.outlineTagsBar.classList.remove("hidden"),V.outlineEditor.classList.remove("hidden"),V.blocksContainer.classList.add("hidden"),Wd({loading:!0});try{pt("outline.open",{articleId:bt,updatedAt:d.article?.updatedAt||null,docHash:Ht(d.article?.docJson||null)})}catch{}try{if(!d.scrollTargetBlockId&&bt){let e=qm(bt);e?.sectionId&&(d.currentBlockId=e.sectionId)}}catch{}try{await su(),pr("outline.open.mounted",{outlineArticleId:bt,hasInstance:!!ie});try{_m(ie)}catch{}try{let t=d.scrollTargetBlockId||null;t&&(au(t,{focus:!1}),d.scrollTargetBlockId=null,d.currentBlockId=t)}catch{}try{let t=d.currentBlockId||null;t&&($m(ie,t),Fm(ie,t,{block:"center"}))}catch{}let e=V.outlineEditor.querySelector(".outline-editor__loading");if(e&&e.classList.add("hidden"),er("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u0442\u0441\u044F \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438"),pr("outline.open.ready",{outlineArticleId:bt,currentBlockId:d.currentBlockId||null}),Sd||(Sd=!0,window.addEventListener("online",()=>{if(d.isOutlineEditing){try{Fd(bt||d.articleId)}catch{}Do({force:!0})}}),window.addEventListener("blur",()=>{d.isOutlineEditing&&Do({force:!0})}),document.addEventListener("visibilitychange",()=>{d.isOutlineEditing&&document.visibilityState!=="visible"&&Do({force:!0})})),!Po){let t=r=>{if(!d.isOutlineEditing)return;let o=r?.dataTransfer;if(!(o&&(o.files&&o.files.length||o.items&&o.items.length)))return;let s=r?.target;V.outlineEditor&&s&&V.outlineEditor.contains(s)||r.preventDefault()},n=r=>{if(!d.isOutlineEditing)return;let o=r?.dataTransfer;if(!(o&&o.files&&o.files.length))return;let s=r?.target;V.outlineEditor&&s&&V.outlineEditor.contains(s)||(r.preventDefault(),r.stopPropagation())};window.addEventListener("dragover",t,{passive:!1}),window.addEventListener("drop",n,{passive:!1}),Po=()=>{window.removeEventListener("dragover",t),window.removeEventListener("drop",n),Po=null}}}catch(e){Ee(e?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440"),cu()}}function cu(){pr("outline.close",{outlineArticleId:bt,hadInstance:!!ie}),d.isOutlineEditing=!1,Dm(),Ie=null,bt=null,gr=null,qi=null,tr={counts:new Map,labelByKey:new Map,sectionIdsByKey:new Map,sectionPosById:new Map};try{V.outlineTagsBar&&(V.outlineTagsBar.innerHTML="",V.outlineTagsBar.classList.add("hidden"))}catch{}ro(!1),Po&&Po(),V.outlineToolbar&&V.outlineToolbar.classList.add("hidden"),V.articleToolbar&&V.articleToolbar.classList.remove("hidden"),Yn&&(clearTimeout(Yn),Yn=null),Ut&&(clearTimeout(Ut),Ut=null),Tr&&(clearTimeout(Tr),Tr=null),Ia=null,Fn=!1,Ri="";try{Tn.clear()}catch{}Pi=!1,_r.clear();try{oo.clear()}catch{}Pr.clear(),hn=null,tn=!1;try{for(let[,e]of _o)try{clearTimeout(e)}catch{}_o.clear()}catch{}try{for(let[,e]of Lr)try{URL.revokeObjectURL(e)}catch{}Lr.clear()}catch{}if(ie){try{ie.destroy()}catch{}ie=null}je=null,V.outlineEditor&&V.outlineEditor.classList.add("hidden"),V.blocksContainer&&V.blocksContainer.classList.remove("hidden")}async function dh(e={}){let t=e&&typeof e.mode=="string"?e.mode:"network",n=e&&typeof e.timeoutMs=="number"?Math.max(0,Math.floor(e.timeoutMs)):0;if(!ie)return;Yn&&(clearTimeout(Yn),Yn=null);try{let o=bt||d.articleId;if(o&&!d.article?.encrypted){let i=ie.getJSON();if(i&&typeof i=="object")try{await bn(o,i,d.article?.updatedAt||null)}catch{}try{try{let s=Ie?.getState?.(ie?.state)||null,a=String(s?.editingSectionId||"").trim();a&&await Oa({articleId:o,doc:ie.state.doc,sectionId:a,reason:"pagehide"})}catch{}if(Fn){let s=Ho(ie.state.doc);s.length&&(on("structure_snapshot",{articleId:o,payload:{nodes:s},coalesceKey:`structure:${o}`}),Fn=!1)}}catch{}try{if(Tn.size){let s=Array.from(Tn);Tn.clear();let a=Date.now();await on("delete_sections",{articleId:o,payload:{sectionIds:s,clientQueuedAt:a},coalesceKey:`delete:${o}:${a}`})}}catch{}}}catch{}if(t==="queue")return;let r=Do({force:!0,silent:!0});if(n>0){await Promise.race([r,new Promise(o=>setTimeout(o,n))]);return}await r}async function uh({docJson:e}={}){if(V.outlineEditor){if(!e||typeof e!="object"){Ee("\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F: \u043D\u0435\u0442 \u0434\u043E\u043A\u0443\u043C\u0435\u043D\u0442\u0430");return}d.isPublicView=!0,d.isRagView=!1,d.isOutlineEditing=!1,d.articleId=null,d.article={docJson:e,encrypted:!1};try{V.outlineEditor.classList.add("outline-editor")}catch{}V.outlineEditor.classList.remove("hidden"),V.outlineEditor.querySelector("#outlineEditorContent")||Wd({loading:!0});try{await su();let t=V.outlineEditor.querySelector(".outline-editor__loading");t&&t.classList.add("hidden"),er("\u0422\u043E\u043B\u044C\u043A\u043E \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440")}catch(t){Ee(t?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E")}}}var ka,je,ie,Mo,Yn,Pi,Tr,Ia,ba,Od,hn,Lr,Pr,_r,oo,tn,Sd,Ro,Ea,Ca,Et,Cr,Sa,em,Xr,Qr,Ni,_i,Ie,Po,bt,gr,qi,tr,Zn,yr,wa,tm,Mi,va,Fi,nm,_o,xd,zi,Fn,Ri,Ut,Tn,xa,ue,kd,um,fm,pm,Li,fh,ph,ot,hi=Xe(()=>{Pt();Cn();rn();$n();ir();un();go();Ar();zr();Hr();cs();cd();sr();ld();ud();lo();Vs();ka=!1,je=null,ie=null,Mo=null,Yn=null,Pi=!1,Tr=null,Ia=null,ba=0,Od=null,hn=null,Lr=new Map,Pr=new Map,_r=new Set,oo=new Set,tn=!1,Sd=!1,Ro=null,Ea=null,Ca=null,Et={TableMap:null,CellSelection:null,moveTableColumn:null,moveTableRow:null,addRowBefore:null,addRowAfter:null,deleteRow:null,addColumnBefore:null,addColumnAfter:null,deleteColumn:null,toggleHeaderRow:null,toggleHeaderColumn:null},Cr=!1,Sa=new Map,em=30*1e3,Xr=new Map,Qr=new Map,Ni=0,_i=null,Ie=null,Po=null,bt=null,gr=null,qi=null,tr={counts:new Map,labelByKey:new Map,sectionIdsByKey:new Map,sectionPosById:new Map},Zn=!1,yr=new Set,wa={atMs:0,hash:null};tm=650,Mi={articleId:null,sectionId:null,collapsed:null},va="ttree_outline_section_clipboard_v1",Fi="pending-attachment:",nm=2e3,_o=new Map;xd="ttree_outline_section_seq_v1",zi=262144;Fn=!1,Ri="",Ut=null,Tn=new Set,xa=null;ue="outlineAllowMutation",kd=0,um="ttree_outline_debug_md_table";fm="ttree_profile_v1";pm="ttree_outline_debug_proofread_v1";Li=null;fh="ttree_debug_outline_keys_v1",ph=()=>{try{return window?.localStorage?.getItem?.(fh)==="1"}catch{return!1}},ot=(e,t={})=>{ph()}});(()=>{let e=window.__memusAppModule||"/app.js",t="ttree_boot_session_v1",n="ttree_last_user_v1",r="ttree_last_active_at_v1",o=200,i=900*1e3,s=2500,a="ttree_debug_quick_notes_v1",c="ttree_offline_known_user_keys_v1",l="memus_offline_v1_",u="ttree_offline_recovery_force_index_v1",h="ttree_boot_open_offline_requested_v1",g=!1;try{g=window.sessionStorage?.getItem?.(h)==="1",g&&window.sessionStorage?.removeItem?.(h)}catch{}function b(){try{return window?.localStorage?.getItem?.(a)==="1"}catch{return!1}}function S(...ee){try{if(!b())return;console.log("[quick-notes][boot]",...ee)}catch{}}function p(...ee){try{console.log("[quick-notes][recovery]",...ee)}catch{}}function f(...ee){try{console.error("[quick-notes][recovery]",...ee)}catch{}}function w(){if("serviceWorker"in navigator)try{navigator.serviceWorker.register("/uploads-sw.js",{scope:"/",updateViaCache:"none"}).then(ee=>{try{ee&&ee.waiting&&ee.waiting.postMessage({type:"memus:skipWaiting"}),ee?.addEventListener?.("updatefound",()=>{try{let de=ee.installing;if(!de)return;de.addEventListener("statechange",()=>{if(de.state==="installed"&&navigator.serviceWorker.controller)try{ee.waiting?.postMessage?.({type:"memus:skipWaiting"})}catch{}})}catch{}})}catch{}try{let de=ee?.update?.();de&&typeof de.catch=="function"&&de.catch(()=>{})}catch{}}).catch(()=>{});try{let ee=!!navigator.serviceWorker.controller,de=I(),ye=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{if(!ye&&(ye=!0,!g&&ee&&!de))try{window.location.reload()}catch{}})}catch{}}catch{}}function x(){try{return String(window.location.pathname||"").startsWith("/p/")}catch{return!1}}function A(){try{return!!(typeof navigator<"u"&&navigator&&navigator.onLine===!1)}catch{return!1}}function I(){try{let ee=performance.getEntriesByType?.("navigation")||[],de=ee&&ee[0];return String(de?.type||"")==="reload"}catch{return!1}}function N(){try{let ee=window.localStorage.getItem(r)||"",de=Number(ee);return Number.isFinite(de)?de:0}catch{return 0}}function O(){try{window.localStorage.setItem(r,String(Date.now()))}catch{}}function U(){let ee=N();return ee?Date.now()-ee>i:!0}function H(){try{return window.sessionStorage.getItem(t)?!1:(window.sessionStorage.setItem(t,"1"),!0)}catch{return!0}}function X(){try{let ee=window.localStorage.getItem(n);if(!ee)return!1;let de=JSON.parse(ee);return!!(de&&(de.id||de.username))}catch{return!1}}function G(){try{if(globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function")return globalThis.crypto.randomUUID()}catch{}return`id-${Date.now()}-${Math.random().toString(16).slice(2)}`}function oe(){return new Date().toISOString()}function xe(){try{let ee=window.localStorage.getItem(c)||"[]",de=JSON.parse(ee);return Array.isArray(de)?de.filter(Boolean).map(String):[]}catch{return[]}}async function ve(){try{if(!("indexedDB"in window))return[];if(typeof indexedDB.databases=="function"){let ye=(await indexedDB.databases()||[]).map(Pe=>Pe&&Pe.name).filter(Boolean).filter(Pe=>String(Pe).startsWith(l)).map(Pe=>String(Pe).slice(l.length)).filter(Boolean);return Array.from(new Set(ye))}}catch{}return Array.from(new Set(xe()))}function te(ee,de){return new Promise((ye,Ue)=>{try{let Pe=de?indexedDB.open(ee,de):indexedDB.open(ee);de&&(Pe.onupgradeneeded=()=>{try{let y=Pe.result;if(y.objectStoreNames.contains("meta")||y.createObjectStore("meta",{keyPath:"key"}),!y.objectStoreNames.contains("articles")){let m=y.createObjectStore("articles",{keyPath:"id"});m.createIndex("byUpdatedAt","updatedAt",{unique:!1}),m.createIndex("byDeletedAt","deletedAt",{unique:!1})}if(!y.objectStoreNames.contains("outline_sections")){let m=y.createObjectStore("outline_sections",{keyPath:"sectionId"});m.createIndex("byArticleId","articleId",{unique:!1}),m.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!y.objectStoreNames.contains("section_embeddings")){let m=y.createObjectStore("section_embeddings",{keyPath:"sectionId"});m.createIndex("byArticleId","articleId",{unique:!1}),m.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!y.objectStoreNames.contains("media_assets")){let m=y.createObjectStore("media_assets",{keyPath:"url"});m.createIndex("byStatus","status",{unique:!1}),m.createIndex("byFetchedAtMs","fetchedAtMs",{unique:!1}),m.createIndex("byStatusFetchedAtMs",["status","fetchedAtMs"],{unique:!1})}if(!y.objectStoreNames.contains("media_refs")){let m=y.createObjectStore("media_refs",{keyPath:"key"});m.createIndex("byArticleId","articleId",{unique:!1}),m.createIndex("byUrl","url",{unique:!1})}if(y.objectStoreNames.contains("outbox"))try{let B=Pe.transaction.objectStore("outbox");B.indexNames.contains("byTypeCoalesceKey")||B.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}catch{}else{let m=y.createObjectStore("outbox",{keyPath:"id"});m.createIndex("byCreatedAtMs","createdAtMs",{unique:!1}),m.createIndex("byTypeArticleId",["type","articleId"],{unique:!1}),m.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}if(!y.objectStoreNames.contains("pending_uploads")){let m=y.createObjectStore("pending_uploads",{keyPath:"token"});m.createIndex("byArticleId","articleId",{unique:!1}),m.createIndex("byCreatedAtMs","createdAtMs",{unique:!1})}}catch{}}),Pe.onsuccess=()=>ye(Pe.result),Pe.onerror=()=>{let y=Pe.error||new Error("IndexedDB open failed");f("idb.open.error",{name:ee,version:de||null,message:String(y?.message||y)}),Ue(y)}}catch(Pe){f("idb.open.throw",{name:ee,version:de||null,message:String(Pe?.message||Pe)}),Ue(Pe)}})}function be(ee,de){return new Promise((ye,Ue)=>{try{let m=ee.transaction([de],"readonly").objectStore(de).getAll();m.onsuccess=()=>ye(Array.isArray(m.result)?m.result:[]),m.onerror=()=>{let B=m.error||new Error("IndexedDB getAll failed");f("idb.getAll.error",{storeName:de,message:String(B?.message||B)}),Ue(B)}}catch(Pe){f("idb.getAll.throw",{storeName:de,message:String(Pe?.message||Pe)}),Ue(Pe)}})}function Qe(ee,de){return new Promise((ye,Ue)=>{try{let m=ee.transaction([de],"readonly").objectStore(de).count();m.onsuccess=()=>ye(Number(m.result||0)),m.onerror=()=>{let B=m.error||new Error("IndexedDB count failed");f("idb.count.error",{storeName:de,message:String(B?.message||B)}),Ue(B)}}catch(Pe){f("idb.count.throw",{storeName:de,message:String(Pe?.message||Pe)}),Ue(Pe)}})}function kt(ee,de){try{let ye=JSON.stringify(de),Ue=new Blob([ye],{type:"application/json;charset=utf-8"}),Pe=URL.createObjectURL(Ue),y=document.createElement("a");return y.href=Pe,y.download=ee,y.rel="noopener",document.body.appendChild(y),y.click(),setTimeout(()=>{try{y.remove(),URL.revokeObjectURL(Pe)}catch{}},0),!0}catch{return!1}}function Ot(ee,de){try{let ye=URL.createObjectURL(de),Ue=document.createElement("a");return Ue.href=ye,Ue.download=ee,Ue.rel="noopener",document.body.appendChild(Ue),Ue.click(),setTimeout(()=>{try{Ue.remove(),URL.revokeObjectURL(ye)}catch{}},0),!0}catch{return!1}}async function ln(ee,{method:de="GET",body:ye=null,timeoutMs:Ue=2e4}={}){let Pe=typeof AbortController<"u"?new AbortController:null,y={method:de,credentials:"include",headers:{},signal:Pe?.signal};ye!==null&&(y.headers["Content-Type"]="application/json",y.body=JSON.stringify(ye));let m=null,B=!1;Pe&&typeof Ue=="number"&&Ue>0&&(m=setTimeout(()=>{try{B=!0;try{Pe.abort(new Error(`timeout after ${Ue}ms`))}catch{Pe.abort()}}catch{}},Ue));let v;try{v=await fetch(ee,y)}finally{m&&clearTimeout(m)}let R=await v.text().catch(()=>""),P=null;try{P=R?JSON.parse(R):null}catch{P=null}if(!v.ok){let z=P&&(P.detail||P.error)||R||`${v.status} ${v.statusText}`,j=new Error(z);throw j.status=v.status,j.payload=P,j}return P}async function gn(ee,de){try{return await ln(ee,de)}catch(ye){if(String(ye?.name||"")==="AbortError"||String(ye?.message||"").toLowerCase().includes("aborted")){let Pe=typeof de?.timeoutMs=="number"?de.timeoutMs:null,y=new Error(Pe?`timeout after ${Pe}ms`:"request aborted");throw y.name="TimeoutError",y}throw ye}}function In(ee){try{return ee?JSON.parse(ee):null}catch{return null}}function Pn(ee){let de=String(ee||"");return!!(!de||de==="inbox"||de.startsWith("inbox-"))}async function Un({userKey:ee,onProgress:de}){let ye=String(ee||"").trim();if(!ye)throw new Error("No userKey");let Ue=await te(`${l}${ye}`).catch(T=>{throw f("restore.server.idb.open.error",{userKey:ye,message:String(T?.message||T)}),T}),Pe=await be(Ue,"articles").catch(T=>{throw f("restore.server.idb.read.error",{userKey:ye,message:String(T?.message||T)}),T});try{Ue.close()}catch{}let y=(Array.isArray(Pe)?Pe:[]).filter(T=>T&&!T.deletedAt&&!Pn(T.id)).map(T=>{let E=In(T.articleJsonStr)||{},k=In(T.docJsonStr)||E.docJson||null;return{id:String(T.id),title:(T.title||E.title||"").toString(),parentId:T.parentId??E.parentId??null,position:typeof T.position=="number"?T.position:typeof E.position=="number"?E.position:0,docJson:k&&typeof k=="object"?k:null}}).filter(T=>T.id&&T.docJson),m=y.length,B={n:0},v={n:0},R={n:0},P=(T,E={})=>{try{de?.({phase:T,total:m,created:B.n,saved:v.n,moved:R.n,...E})}catch{}};P("start");for(let T=0;T<y.length;T+=1){let E=y[T];P("content",{idx:T+1,articleId:E.id,title:E.title});try{p("restore.server.create.start",{idx:T+1,id:E.id}),await gn("/api/articles",{method:"POST",body:{id:E.id,title:E.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"},timeoutMs:15e3}),B.n+=1,p("restore.server.create.done",{idx:T+1,id:E.id})}catch(k){p("restore.server.create.skip",{idx:T+1,id:E.id,status:k?.status||null,message:String(k?.message||k)})}try{p("restore.server.save.start",{idx:T+1,id:E.id}),await gn(`/api/articles/${encodeURIComponent(E.id)}/doc-json`,{method:"PUT",body:{docJson:E.docJson},timeoutMs:3e4}),v.n+=1,p("restore.server.save.done",{idx:T+1,id:E.id})}catch(k){f("restore.server.save.error",{idx:T+1,id:E.id,status:k?.status||null,message:String(k?.message||k),stack:String(k?.stack||"")})}}let z=new Map;for(let T of y){let E=T.parentId||null;z.has(E)||z.set(E,[]),z.get(E).push(T)}for(let[T,E]of z.entries())E.sort((k,M)=>Number(k.position||0)-Number(M.position||0)),z.set(T,E);let j=[null],D=new Set;for(P("structure");j.length;){let T=j.shift(),E=T||"__root__";if(D.has(E))continue;D.add(E);let k=z.get(T||null)||[];for(let M of k){P("structure",{articleId:M.id,title:M.title});try{await ln(`/api/articles/${encodeURIComponent(M.id)}/move-tree`,{method:"POST",body:{parentId:T||null,anchorId:null,placement:"inside"}}),R.n+=1}catch(C){p("restore.server.move.skip",{id:M.id,status:C?.status||null,message:String(C?.message||C)})}z.has(M.id)&&j.push(M.id)}}return P("done"),{total:m,created:B.n,saved:v.n,moved:R.n}}function qn(ee){let de=new TextEncoder,ye=Object.entries(ee?.stores||{}),Ue={type:"meta",exportedAt:ee?.exportedAt||oe(),sourceUserKey:ee?.sourceUserKey||null,dbName:ee?.dbName||null,format:"ndjson.v1"},Pe=!1,y=0,m=-1;return new ReadableStream({pull(B){try{if(!Pe){Pe=!0,B.enqueue(de.encode(`${JSON.stringify(Ue)}
`));return}for(;y<ye.length;){let[v,R]=ye[y],P=Array.isArray(R)?R:[];if(m===-1){m=0,B.enqueue(de.encode(`${JSON.stringify({type:"store",store:v,count:P.length})}
`));return}if(m>=P.length){y+=1,m=-1;continue}let z={type:"item",store:v,value:P[m]};m+=1,B.enqueue(de.encode(`${JSON.stringify(z)}
`));return}B.close()}catch(v){f("ndjson.stream.error",{message:String(v?.message||v),stack:String(v?.stack||"")}),B.error(v)}}})}async function _n(ee,de){let ye=qn(de),Ue=typeof CompressionStream<"u",Pe=Ue?ye.pipeThrough(new CompressionStream("gzip")):ye,y=await new Response(Pe).blob(),m=Ue?`${ee}.ndjson.gz`:`${ee}.ndjson`;if(Ot(m,y))return{ok:!0,method:"download",filename:m};try{let B=URL.createObjectURL(y);try{window.open(B,"_blank","noopener")}catch{window.location.href=B}return{ok:!0,method:"open",filename:m}}catch(B){f("export.open.error",{filename:m,message:String(B?.message||B),stack:String(B?.stack||"")})}return{ok:!1,method:"none",filename:m}}function Dn(){try{let ee=window.localStorage.getItem(n)||"",de=ee?JSON.parse(ee):null;return de?.id||de?.username||""}catch{return""}}async function Rt(ee){let de=String(ee||"").trim();if(!de)throw new Error("No userKey");let ye=`${l}${de}`,Ue=await te(ye,3),Pe=["articles","outline_sections","media_assets","media_refs","outbox","pending_uploads","section_embeddings","meta"].filter(m=>{try{return Ue.objectStoreNames.contains(m)}catch{return!1}}),y={exportedAt:oe(),sourceUserKey:de,dbName:ye,stores:{}};for(let m of Pe)y.stores[m]=await be(Ue,m).catch(B=>(f("export.store.read.error",{userKey:de,store:m,message:String(B?.message||B)}),[]));try{Ue.close()}catch{}return y}async function jt(ee,de){let ye=String(de||"").trim();if(!ye)throw new Error("No target userKey");if(!ee||typeof ee!="object"||!ee.stores||typeof ee.stores!="object")throw new Error("Invalid dump");let Ue=`${l}${ye}`,Pe=await te(Ue,3),y=async(B,v)=>{if(!Pe.objectStoreNames.contains(B))return 0;let R=Array.isArray(v)?v:[];if(!R.length)return 0;let P=Pe.transaction([B],"readwrite"),z=P.objectStore(B),j=0;return await new Promise((D,T)=>{P.oncomplete=()=>D(),P.onerror=()=>{let E=P.error||new Error("tx failed");f("import.tx.error",{storeName:B,message:String(E?.message||E)}),T(E)},P.onabort=()=>{let E=P.error||new Error("tx aborted");f("import.tx.abort",{storeName:B,message:String(E?.message||E)}),T(E)};for(let E of R)try{z.put(E),j+=1}catch{}}),j},m=0;m+=await y("articles",ee.stores.articles),m+=await y("outline_sections",ee.stores.outline_sections),m+=await y("media_assets",ee.stores.media_assets),m+=await y("media_refs",ee.stores.media_refs),m+=await y("pending_uploads",ee.stores.pending_uploads),m+=await y("section_embeddings",ee.stores.section_embeddings);try{Pe.close()}catch{}return m}let Ct="ttree_pending_quick_notes_v1";function yt(){try{let ee=window.localStorage.getItem(Ct)||"";if(!ee)return[];let de=JSON.parse(ee);return Array.isArray(de)?de.filter(Boolean):[]}catch{return[]}}function zt(ee){try{window.localStorage.setItem(Ct,JSON.stringify(Array.isArray(ee)?ee:[]))}catch{}}function En(ee){let de=String(ee||"").trim();if(!de)return null;let ye=G(),Ue={id:ye,sectionId:ye,createdAt:oe(),text:de},Pe=yt(),y=[Ue,...Pe].slice(0,o);return zt(y),S("saved.pending",{id:Ue.id,len:y.length}),Ue}function W(){if(document.getElementById("quickNoteBootStyles"))return;let ee=document.createElement("style");ee.id="quickNoteBootStyles",ee.textContent=`
      .boot-modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.22);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);z-index:99999;display:flex;align-items:center;justify-content:center;padding:16px}
      .boot-modal{width:min(720px,100%);background:rgba(255,255,255,.92);border:1px solid rgba(203,213,225,.9);border-radius:16px;box-shadow:0 24px 80px rgba(15,23,42,.18);color:#0f172a}
      .boot-modal__hdr{padding:14px 16px;border-bottom:1px solid rgba(203,213,225,.7);display:flex;align-items:center;justify-content:space-between;gap:12px}
      .boot-modal__title{font-size:14px;font-weight:600;letter-spacing:.2px}
      .boot-modal__meta{font-size:12px;color:#64748b}
      .boot-modal__body{padding:12px 16px}
      .boot-note{width:100%;min-height:34vh;max-height:52vh;resize:vertical;background:rgba(255,255,255,.95);color:#0f172a;border:1px solid rgba(203,213,225,.9);border-radius:12px;padding:12px 12px;font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;outline:none}
      .boot-note:focus{border-color:rgba(37,99,235,.65);box-shadow:0 0 0 4px rgba(37,99,235,.14)}
      .boot-modal__ftr{padding:12px 16px;border-top:1px solid rgba(203,213,225,.7);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
      .boot-actions{display:flex;gap:10px;flex-wrap:wrap}
      .boot-btn{appearance:none;border:1px solid rgba(203,213,225,.9);background:rgba(255,255,255,.7);color:#0f172a;border-radius:999px;padding:10px 14px;font:600 13px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;cursor:pointer}
      .boot-btn:hover{background:rgba(241,245,249,.9)}
      .boot-btn--primary{background:#007ACC;border-color:#007ACC;color:#ffffff}
      .boot-btn--primary:hover{background:#0062A3}
      .boot-btn--ghost{background:transparent}
      .boot-hint{font-size:12px;color:#64748b}
      .boot-toast{margin-left:auto;font-size:12px;color:#16a34a}
    `,document.head.appendChild(ee)}function ce(ee,{timeout:de=5e3,fallbackDelay:ye=1200}={}){try{if(typeof requestIdleCallback=="function"){requestIdleCallback(()=>ee(),{timeout:de});return}}catch{}setTimeout(()=>ee(),ye)}function me(){ce(()=>{try{import(e).catch(()=>{})}catch{}})}function pe({reason:ee=""}={}){W();let de=document.createElement("div");de.className="boot-modal-backdrop";let ye=document.createElement("div");ye.className="boot-modal";let Ue=document.createElement("div");Ue.className="boot-modal__hdr";let Pe=document.createElement("div"),y=document.createElement("div");y.className="boot-modal__title",y.textContent="\u0411\u044B\u0441\u0442\u0440\u0430\u044F \u0437\u0430\u043C\u0435\u0442\u043A\u0430",Pe.appendChild(y);let m=document.createElement("button");m.type="button",m.className="boot-btn boot-btn--ghost",m.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",Ue.appendChild(Pe),Ue.appendChild(m);let B=document.createElement("div");B.className="boot-modal__body";let v=document.createElement("textarea");v.className="boot-note",v.placeholder=`\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0443\u2026

Ctrl+Enter \u2014 \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C
Esc \u2014 \u0437\u0430\u043A\u0440\u044B\u0442\u044C`,B.appendChild(v);let R=document.createElement("div");R.className="boot-modal__ftr";let P=document.createElement("div");P.className="boot-hint",P.textContent="\u0417\u0430\u043C\u0435\u0442\u043A\u0438 \u0441\u043E\u0445\u0440\u0430\u043D\u044F\u044E\u0442\u0441\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E \u0438 \u0431\u0443\u0434\u0443\u0442 \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u044B \u0432 \u201C\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438\u201D \u043F\u0440\u0438 \u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0435\u043C \u0432\u0445\u043E\u0434\u0435.";let z=document.createElement("div");z.className="boot-actions";let j=document.createElement("button");j.type="button",j.className="boot-btn boot-btn--primary",j.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C";let D=document.createElement("button");D.type="button",D.className="boot-btn",D.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0438 \u0435\u0449\u0451",z.appendChild(j),z.appendChild(D);let T=document.createElement("div");T.className="boot-toast",R.appendChild(P),R.appendChild(z),R.appendChild(T),ye.appendChild(Ue),ye.appendChild(B),ye.appendChild(R),de.appendChild(ye);let E=()=>{try{de.remove()}catch{}},k=C=>{let L=En(v.value);if(L){v.value="",T.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E",O();try{window.dispatchEvent(new CustomEvent("memus:queued-inbox-changed",{detail:{note:L}})),S("event.dispatched",{type:"memus:queued-inbox-changed"})}catch{}C||E(),setTimeout(()=>{try{T.textContent=""}catch{}},1200)}};m.addEventListener("click",E),de.addEventListener("click",C=>{C.target===de&&E()}),j.addEventListener("click",()=>k(!1)),D.addEventListener("click",()=>k(!0)),v.addEventListener("keydown",C=>{if(C.key==="Escape"){C.preventDefault(),E();return}C.key==="Enter"&&(C.ctrlKey||C.metaKey)&&(C.preventDefault(),k(!0))});let M=async()=>{W();let C=document.createElement("div");C.className="boot-modal-backdrop";let L=document.createElement("div");L.className="boot-modal";let $=document.createElement("div");$.className="boot-modal__hdr";let J=document.createElement("div"),K=document.createElement("div");K.className="boot-modal__title",K.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0445 \u0434\u0430\u043D\u043D\u044B\u0445";let q=document.createElement("div");q.className="boot-modal__meta",q.textContent="\u0418\u0449\u0435\u043C \u0441\u0442\u0430\u0440\u044B\u0435 \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0435 \u0431\u0430\u0437\u044B\u2026",J.appendChild(K),J.appendChild(q);let Z=document.createElement("button");Z.type="button",Z.className="boot-btn boot-btn--ghost",Z.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",$.appendChild(J),$.appendChild(Z);let ae=document.createElement("div");ae.className="boot-modal__body";let Ae=document.createElement("div");Ae.style.display="flex",Ae.style.flexDirection="column",Ae.style.gap="10px",ae.appendChild(Ae);let ge=document.createElement("div");ge.className="boot-modal__ftr";let ke=document.createElement("div");ke.className="boot-hint",ke.textContent="\u0415\u0441\u043B\u0438 \u043F\u043E\u0441\u043B\u0435 \u0432\u0445\u043E\u0434\u0430 \u0432\u0441\u0435 \u0441\u0442\u0430\u0442\u044C\u0438 \u043F\u0440\u043E\u043F\u0430\u043B\u0438, \u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E \u0438\u0437\u043C\u0435\u043D\u0438\u043B\u0441\u044F userKey. \u0417\u0434\u0435\u0441\u044C \u043C\u043E\u0436\u043D\u043E \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0430\u0440\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 \u0438\u043B\u0438 \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0438\u0445 \u0432 \u0442\u0435\u043A\u0443\u0449\u0435\u0433\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F.";let Se=document.createElement("div");Se.className="boot-toast",ge.appendChild(ke),ge.appendChild(Se),L.appendChild($),L.appendChild(ae),L.appendChild(ge),C.appendChild(L);let Oe=()=>{try{C.remove()}catch{}};Z.addEventListener("click",Oe),C.addEventListener("click",he=>{he.target===C&&Oe()}),document.body.appendChild(C);let De=(he,{articleCount:qe}={})=>{let Ke=document.createElement("div");Ke.style.border="1px solid rgba(255,255,255,.12)",Ke.style.borderRadius="12px",Ke.style.padding="12px",Ke.style.display="flex",Ke.style.flexDirection="column",Ke.style.gap="10px";let et=document.createElement("div");et.style.display="flex",et.style.alignItems="baseline",et.style.justifyContent="space-between",et.style.gap="12px";let nt=document.createElement("div");nt.style.fontWeight="600",nt.style.fontSize="13px",nt.textContent=he;let St=document.createElement("div");St.dataset.recoveryMeta="1",St.style.fontSize="12px",St.style.color="#9ca3af",St.textContent=typeof qe=="number"?`\u0421\u0442\u0430\u0442\u0435\u0439: ${qe}`:"",et.appendChild(nt),et.appendChild(St);let Mt=document.createElement("div");Mt.className="boot-actions";let Jt=document.createElement("button");Jt.type="button",Jt.className="boot-btn",Jt.textContent="\u042D\u043A\u0441\u043F\u043E\u0440\u0442 JSON";let _=document.createElement("button");_.type="button",_.className="boot-btn boot-btn--primary",_.textContent="\u0418\u043C\u043F\u043E\u0440\u0442 \u0432 \u0442\u0435\u043A\u0443\u0449\u0435\u0433\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F";let Q=document.createElement("button");return Q.type="button",Q.className="boot-btn",Q.textContent="\u041D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440",Mt.appendChild(Jt),Mt.appendChild(_),Mt.appendChild(Q),Ke.appendChild(et),Ke.appendChild(Mt),Jt.addEventListener("click",async()=>{let Y=performance.now();try{Se.textContent="\u042D\u043A\u0441\u043F\u043E\u0440\u0442\u2026",p("export.start",{userKey:he});let F=await Rt(he),ne=`memus-offline-recovery-${he}-${new Date().toISOString().replace(/[:.]/g,"-")}`,re=await _n(ne,F);p("export.done",{userKey:he,ok:re.ok,method:re.method,filename:re.filename,ms:Math.round(performance.now()-Y)}),Se.textContent=re.ok?re.method==="download"?`\u0421\u043A\u0430\u0447\u0438\u0432\u0430\u043D\u0438\u0435 \u043D\u0430\u0447\u0430\u043B\u043E\u0441\u044C: ${re.filename}`:re.method==="open"?`\u041E\u0442\u043A\u0440\u044B\u043B \u0444\u0430\u0439\u043B \u0432 \u043D\u043E\u0432\u043E\u0439 \u0432\u043A\u043B\u0430\u0434\u043A\u0435: ${re.filename}`:`\u042D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043E: ${re.filename}`:"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C (\u043E\u0433\u0440\u0430\u043D\u0438\u0447\u0435\u043D\u0438\u044F \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0430)"}catch(F){f("export.button.error",{userKey:he,message:String(F?.message||F),stack:String(F?.stack||"")}),Se.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430 \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0430: ${String(F&&F.message?F.message:F)}`}finally{setTimeout(()=>{try{Se.textContent=""}catch{}},8e3)}}),_.addEventListener("click",async()=>{let Y=performance.now();try{let F=Dn();if(!F){Se.textContent="\u041D\u0435\u0442 \u201C\u0442\u0435\u043A\u0443\u0449\u0435\u0433\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\u201D \u0432 localStorage. \u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0434\u0438\u043D \u0440\u0430\u0437 \u0432\u043E\u0439\u0434\u0438\u0442\u0435.";return}Se.textContent="\u0418\u043C\u043F\u043E\u0440\u0442\u2026",p("import.start",{from:he,to:F});let ne=await Rt(he),re=await jt(ne,F);try{window.localStorage.setItem(u,"1")}catch{}let se=await te(`${l}${F}`).catch(()=>null),we=null,Te=null;if(se){we=await Qe(se,"articles").catch(()=>null),Te=await Qe(se,"outline_sections").catch(()=>null);try{se.close()}catch{}}p("import.done",{from:he,to:F,imported:re,targetArticles:we,targetSections:Te,ms:Math.round(performance.now()-Y)});let $e=typeof we=="number"?` (\u0432 \u0431\u0430\u0437\u0435 \u0441\u0442\u0430\u0442\u0435\u0439: ${we})`:"";Se.textContent=`\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0437\u0430\u043F\u0438\u0441\u0435\u0439: ${re}${$e}`;try{window.dispatchEvent(new CustomEvent("memus:offline-recovery-imported",{detail:{from:he,to:F}}))}catch{}}catch(F){f("import.button.error",{userKey:he,message:String(F?.message||F),stack:String(F?.stack||"")}),Se.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430 \u0438\u043C\u043F\u043E\u0440\u0442\u0430: ${String(F&&F.message?F.message:F)}`}finally{setTimeout(()=>{try{Se.textContent=""}catch{}},8e3)}}),Q.addEventListener("click",async()=>{let Y=performance.now();try{Se.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u043D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u2026",p("restore.server.start",{userKey:he});let F=await Un({userKey:he,onProgress:ne=>{let re=ne.phase;re==="content"?Se.textContent=`\u041D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440: ${ne.idx}/${ne.total} \xB7 ${ne.title||ne.articleId}`:re==="structure"?Se.textContent=`\u0421\u0442\u0440\u0443\u043A\u0442\u0443\u0440\u0430\u2026 (${ne.moved}/${ne.total})`:re==="done"&&(Se.textContent=`\u0413\u043E\u0442\u043E\u0432\u043E: \u0441\u0442\u0430\u0442\u0435\u0439=${ne.total}, \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E=${ne.saved}`),p("restore.server.progress",ne)}});p("restore.server.done",{...F,ms:Math.round(performance.now()-Y)}),Se.textContent=`\u041D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440: \u0441\u0442\u0430\u0442\u0435\u0439=${F.total}, \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E=${F.saved}`}catch(F){f("restore.server.error",{userKey:he,message:String(F?.message||F),stack:String(F?.stack||"")}),Se.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430: ${String(F?.message||F)}`}finally{setTimeout(()=>{try{Se.textContent=""}catch{}},12e3)}}),Ke};try{let he=await ve();if(!he.length){q.textContent="\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0435 \u0431\u0430\u0437\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B. \u0415\u0441\u043B\u0438 \u0432\u044B \u0442\u043E\u0447\u043D\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043B\u0438\u0441\u044C Memus \u043D\u0430 \u044D\u0442\u043E\u043C \u0443\u0441\u0442\u0440\u043E\u0439\u0441\u0442\u0432\u0435, \u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E \u0431\u0440\u0430\u0443\u0437\u0435\u0440 \u043D\u0435 \u0434\u0430\u0451\u0442 \u043F\u0435\u0440\u0435\u0447\u0438\u0441\u043B\u044F\u0442\u044C IndexedDB.";return}q.textContent=`\u041D\u0430\u0439\u0434\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0445 \u0431\u0430\u0437: ${he.length}`;for(let qe of he){let Ke=De(qe);Ae.appendChild(Ke);let et=await te(`${l}${qe}`).catch(()=>null);if(et){let nt=await Qe(et,"articles").catch(()=>null);try{et.close()}catch{}if(typeof nt=="number")try{let St=Ke.querySelector('[data-recovery-meta="1"]');St&&(St.textContent=`\u0421\u0442\u0430\u0442\u0435\u0439: ${nt}`)}catch{}}}}catch(he){q.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430: ${String(he&&he.message?he.message:he)}`}};document.body.appendChild(de),setTimeout(()=>v.focus({preventScroll:!0}),0)}function fe(){let ee=()=>O();try{window.addEventListener("pointerdown",ee,{passive:!0}),window.addEventListener("keydown",ee,{passive:!0}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&ee()})}catch{}}function Ce(){let ee=()=>{try{Promise.resolve().then(()=>(hi(),mi)).then(de=>de.flushOutlineAutosave?.({mode:"queue"})).catch(()=>{})}catch{}try{Promise.resolve().then(()=>(ya(),ga)).then(de=>de.flushOutboxOnce?.()).catch(()=>{})}catch{}};try{window.addEventListener("pagehide",ee),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&ee()})}catch{}}let Be=!1,le=ee=>{if(!Be){Be=!0;try{document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>pe({reason:ee}),{once:!0}):pe({reason:ee})}catch{}}};function Me({subtitle:ee=null,error:de=null,showRetry:ye=!1,showOffline:Ue=!1}={}){try{let Pe=document.getElementById("authOverlay");if(!Pe)return;let y=document.getElementById("authSubtitle"),m=document.getElementById("authError");if(y&&ee!=null&&(y.textContent=String(ee)),m){let P=de!=null?String(de):"";m.textContent=P,m.classList.toggle("hidden",!P)}let B=Pe.querySelector(".auth-card")||Pe,v=document.getElementById("bootLoadActions");v||(v=document.createElement("div"),v.id="bootLoadActions",v.style.display="flex",v.style.gap="10px",v.style.flexWrap="wrap",v.style.marginTop="12px",B.appendChild(v)),v.innerHTML="";let R=(P,z)=>{let j=document.createElement("button");return j.type="button",j.className="auth-submit",j.style.padding="10px 14px",j.style.borderRadius="999px",j.style.fontSize="13px",j.textContent=P,j.addEventListener("click",z),j};if(ye&&v.appendChild(R("\u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C",()=>{try{window.location.reload()}catch{}})),Ue){let P=()=>{let z=!1;try{z=!!("serviceWorker"in navigator&&navigator.serviceWorker?.controller)}catch{z=!1}if(A()&&!z){Me({subtitle:"\u041D\u0435\u0442 \u0441\u0435\u0442\u0438",error:`\u041E\u0444\u0444\u043B\u0430\u0439\u043D-\u0440\u0435\u0436\u0438\u043C \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u043F\u043E\u0441\u043B\u0435 \u0442\u043E\u0433\u043E, \u043A\u0430\u043A \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435 \u0445\u043E\u0442\u044F \u0431\u044B \u043E\u0434\u0438\u043D \u0440\u0430\u0437 \u043E\u0442\u043A\u0440\u044B\u043B\u043E\u0441\u044C \u0441 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u043E\u043C \u0438 \u0437\u0430\u043A\u0435\u0448\u0438\u0440\u043E\u0432\u0430\u043B\u043E \u0444\u0430\u0439\u043B\u044B.

\u0415\u0441\u043B\u0438 \u0432\u044B \u0442\u043E\u043B\u044C\u043A\u043E \u0447\u0442\u043E \u0443\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u043B\u0438 PWA \u2014 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0435\u0433\u043E \u043E\u043D\u043B\u0430\u0439\u043D, \u0434\u043E\u0436\u0434\u0438\u0442\u0435\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438, \u0437\u0430\u0442\u0435\u043C \u043C\u043E\u0436\u043D\u043E \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u0431\u0435\u0437 \u0441\u0435\u0442\u0438.`,showRetry:!0,showOffline:!0});return}try{window.sessionStorage?.setItem?.(h,"1")}catch{}try{let D=document.getElementById("authSubtitle");D&&(D.textContent="\u041E\u0442\u043A\u0440\u044B\u0432\u0430\u0435\u043C \u0430\u0432\u0442\u043E\u043D\u043E\u043C\u043D\u044B\u0439 \u0440\u0435\u0436\u0438\u043C\u2026");let T=document.getElementById("authError");T&&(T.textContent="",T.classList.add("hidden"))}catch{}try{if(z){window.location.reload();return}}catch{}try{window.location.reload();return}catch{}try{at({reason:"offline_button",background:!1})}catch{}};v.appendChild(R("\u041E\u0442\u043A\u0440\u044B\u0442\u044C \u043E\u0444\u0444\u043B\u0430\u0439\u043D-\u0431\u0443\u0444\u0435\u0440",()=>{try{P()}catch{}}))}}catch{}}let Je=!1,Ye=!1;function at({reason:ee="",background:de=!1}={}){if(!Ye&&!(Je&&!de)){Je=!0;try{let ye=import(e);ye&&typeof ye.catch=="function"&&ye.catch(Ue=>{Ye=!0;let y="\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435. "+(A()?"\u041F\u043E\u0445\u043E\u0436\u0435, \u0441\u0435\u0439\u0447\u0430\u0441 \u043D\u0435\u0442 \u0441\u0435\u0442\u0438.":"\u041F\u043E\u0445\u043E\u0436\u0435, \u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u0435\u0442\u044C\u044E/\u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C.")+" \u041C\u043E\u0436\u043D\u043E \u043F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C \u0432 \u0430\u0432\u0442\u043E\u043D\u043E\u043C\u043D\u043E\u043C \u0440\u0435\u0436\u0438\u043C\u0435 \u0438\u043B\u0438 \u043F\u043E\u043F\u0440\u043E\u0431\u043E\u0432\u0430\u0442\u044C \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443.";if(Me({subtitle:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",error:y,showRetry:!0,showOffline:!0}),!g)try{Be||le("\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438")}catch{}S("app.import.failed",{reason:ee,message:String(Ue?.message||Ue||"")})})}catch(ye){Ye=!0,Me({subtitle:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",error:"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435. \u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443.",showRetry:!0,showOffline:!0}),S("app.import.throw",{reason:ee,message:String(ye?.message||ye||"")})}}}if(x()){w(),at({reason:"public",background:!1});return}w();let st=H(),it=X(),We=A(),lt=I(),ut=U();fe(),Ce(),O(),(We&&!g||lt||ut||st&&it)&&le(We?"\u043D\u0435\u0442 \u0441\u0435\u0442\u0438":lt?"\u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430":ut?"\u043F\u0440\u043E\u0441\u0442\u043E\u0439 > 15 \u043C\u0438\u043D":"\u0445\u043E\u043B\u043E\u0434\u043D\u044B\u0439 \u0441\u0442\u0430\u0440\u0442"),window.setTimeout(()=>{try{if(Be||window.__memusAppStarted||g)return;Me({subtitle:"\u041C\u0435\u0434\u043B\u0435\u043D\u043D\u0430\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430\u2026",error:"\u0415\u0441\u043B\u0438 \u0441\u0435\u0442\u044C \u043D\u0435\u0441\u0442\u0430\u0431\u0438\u043B\u044C\u043D\u0430, \u043C\u043E\u0436\u043D\u043E \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u043E\u0444\u0444\u043B\u0430\u0439\u043D-\u0431\u0443\u0444\u0435\u0440. \u041F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435 \u043F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442 \u043F\u044B\u0442\u0430\u0442\u044C\u0441\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C\u0441\u044F \u0432 \u0444\u043E\u043D\u0435.",showRetry:!0,showOffline:!0}),le("\u043C\u0435\u0434\u043B\u0435\u043D\u043D\u0430\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430")}catch{}},s),Be||We?ce(()=>at({reason:"idle",background:!0}),{timeout:5e3,fallbackDelay:1200}):at({reason:"foreground",background:!1})})();
