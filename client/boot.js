var Ed=Object.defineProperty;var je=(e,t)=>()=>(e&&(t=e(e=0)),t);var vo=(e,t)=>{for(var n in t)Ed(e,n,{get:t[n],enumerable:!0})};function la(e){Ci=e}var u,Ci,bt=je(()=>{u={mode:"view",serverStatus:"unknown",serverStatusText:"",offlineReady:!1,offlineInitStatus:"idle",offlineInitError:"",offlineInitStartedAt:null,mediaStatusText:"",mediaPrefetchPaused:!1,isOutlineEditing:!1,outlineStatusText:"",isPublicView:!1,isRagView:!1,currentUser:null,articleId:null,article:null,currentBlockId:null,editingBlockId:null,selectionAnchorBlockId:null,selectedBlockIds:[],undoStack:[],redoStack:[],pendingTextPreview:null,editingUndo:null,editingInitialText:"",searchQuery:"",searchResults:[],searchError:"",searchLoading:!1,searchRequestId:0,searchMode:"classic",sidebarSearchView:"list",ragQuery:"",ragResults:[],ragBlockMap:{},ragSummaryHtml:"",ragSummaryLoading:!1,ragSummaryError:"",scrollTargetBlockId:null,pendingEditBlockId:null,isEditingTitle:!1,isSidebarCollapsed:!1,isSidebarMobileOpen:!1,articlesIndex:[],deletedArticlesIndex:[],articleFilterQuery:"",isMarkdownInserting:!1,isTrashView:!1,favoriteArticles:[],sidebarArticlesMode:"tree",recentArticleIds:[],sidebarSelectedArticleId:null,listSelectedArticleId:null,sidebarCollapsedArticleIds:[],listCollapsedArticleIds:[],isDragModeEnabled:!1,articleEncryptionKeys:{},isMergingBlocks:!1,isMovingBlock:!1,isDeletingBlock:!1,moveQueue:[],isMoveQueueProcessing:!1,editingScrollTop:null,editingCaretPosition:"start"},Ci=!1});var J,ln=je(()=>{J={authOverlay:document.getElementById("authOverlay"),authLoginTab:document.getElementById("authLoginTab"),authRegisterTab:document.getElementById("authRegisterTab"),authLoginForm:document.getElementById("authLoginForm"),authRegisterForm:document.getElementById("authRegisterForm"),authLoginUsername:document.getElementById("authLoginUsername"),authLoginPassword:document.getElementById("authLoginPassword"),authRegisterUsername:document.getElementById("authRegisterUsername"),authRegisterPassword:document.getElementById("authRegisterPassword"),authRegisterDisplayName:document.getElementById("authRegisterDisplayName"),authError:document.getElementById("authError"),authSubtitle:document.getElementById("authSubtitle"),authGoogleLoginBtn:document.getElementById("authGoogleLoginBtn"),authYandexLoginBtn:document.getElementById("authYandexLoginBtn"),authStorageInfo:document.getElementById("authStorageInfo"),currentUserLabel:document.getElementById("currentUserLabel"),logoutBtn:document.getElementById("logoutBtn"),userMenuBtn:document.getElementById("userMenuBtn"),userMenu:document.getElementById("userMenu"),sidebarSyncStatusPill:document.getElementById("sidebarSyncStatusPill"),syncMenu:document.getElementById("syncMenu"),syncMenuStatusLabel:document.getElementById("syncMenuStatusLabel"),syncMenuOutboxLabel:document.getElementById("syncMenuOutboxLabel"),offlineStatusItem:document.getElementById("offlineStatusItem"),offlineStatusLabel:document.getElementById("offlineStatusLabel"),offlineFetchBtn:document.getElementById("offlineFetchBtn"),telegramLinkBtn:document.getElementById("telegramLinkBtn"),telegramBotOpenBtn:document.getElementById("telegramBotOpenBtn"),telegramFeedbackBotOpenBtn:document.getElementById("telegramFeedbackBotOpenBtn"),openUsersViewBtn:document.getElementById("openUsersViewBtn"),usersView:document.getElementById("usersView"),usersList:document.getElementById("usersList"),usersBackBtn:document.getElementById("usersBackBtn"),graphView:document.getElementById("graphView"),graphCanvas:document.getElementById("graphCanvas"),graphBackBtn:document.getElementById("graphBackBtn"),articleListView:document.getElementById("articleListView"),articleView:document.getElementById("articleView"),articleHeader:document.getElementById("articleHeader"),articleTitle:document.getElementById("articleTitle"),updatedAt:document.getElementById("updatedAt"),articleStatusText:document.getElementById("articleStatusText"),mediaStatusText:document.getElementById("mediaStatusText"),mediaPrefetchToggleBtn:document.getElementById("mediaPrefetchToggleBtn"),blocksContainer:document.getElementById("blocksContainer"),articleList:document.getElementById("articleList"),createArticleBtn:document.getElementById("createArticleBtn"),backToList:document.getElementById("backToList"),toast:document.getElementById("toast"),searchInput:document.getElementById("searchInput"),searchClearBtn:document.getElementById("searchClearBtn"),searchResults:document.getElementById("searchResults"),searchPanel:document.querySelector(".search-panel"),searchModeToggle:document.getElementById("searchModeToggle"),sidebarSearchViewToggle:document.getElementById("sidebarSearchViewToggle"),ragOpenBtn:document.getElementById("ragOpenBtn"),articleTitleInput:document.getElementById("articleTitleInput"),editTitleBtn:document.getElementById("editTitleBtn"),hintToggleBtn:document.getElementById("hintToggleBtn"),hintPopover:document.getElementById("hintPopover"),sidebar:document.getElementById("sidebar"),sidebarToggle:document.getElementById("sidebarToggle"),sidebarArticleList:document.getElementById("sidebarArticleList"),sidebarNewArticleBtn:document.getElementById("sidebarNewArticleBtn"),sidebarRecentBtn:document.getElementById("sidebarRecentBtn"),openInboxBtn:document.getElementById("openInboxBtn"),quickNoteAddBtn:document.getElementById("quickNoteAddBtn"),articleFilterInput:document.getElementById("articleFilterInput"),trashTabBtn:document.getElementById("trashTabBtn"),articlesTabBtn:document.getElementById("articlesTabBtn"),semanticReindexBtn:document.getElementById("semanticReindexBtn"),graphToggleBtn:document.getElementById("graphToggleBtn"),listMenuBtn:document.getElementById("listMenuBtn"),listMenu:document.getElementById("listMenu"),articleMenuBtn:document.getElementById("articleMenuBtn"),articleMenu:document.getElementById("articleMenu"),articleFavoriteBtn:document.getElementById("articleFavoriteBtn"),articlePublicLinkBtn:document.getElementById("articlePublicLinkBtn"),articlePublicToggleBtn:document.getElementById("articlePublicToggleBtn"),articleEncryptionBtn:document.getElementById("articleEncryptionBtn"),articleEncryptionRemoveBtn:document.getElementById("articleEncryptionRemoveBtn"),deleteArticleBtn:document.getElementById("deleteArticleBtn"),exportArticleBtn:document.getElementById("exportArticleBtn"),outlineEditBtn:document.getElementById("outlineEditBtn"),saveVersionBtn:document.getElementById("saveVersionBtn"),versionsBtn:document.getElementById("versionsBtn"),blockHistoryBtn:document.getElementById("blockHistoryBtn"),articleHistoryBtn:document.getElementById("articleHistoryBtn"),exportAllHtmlZipBtn:document.getElementById("exportAllHtmlZipBtn"),importArticleBtn:document.getElementById("importArticleBtn"),importMarkdownBtn:document.getElementById("importMarkdownBtn"),importLogseqBtn:document.getElementById("importLogseqBtn"),importBackupFolderBtn:document.getElementById("importBackupFolderBtn"),articleUndoBtn:document.getElementById("articleUndoBtn"),articleRedoBtn:document.getElementById("articleRedoBtn"),mergeBlocksBtn:document.getElementById("mergeBlocksBtn"),splitBlockBtn:document.getElementById("splitBlockBtn"),insertTableBtn:document.getElementById("insertTableBtn"),deleteCurrentBlockBtn:document.getElementById("deleteCurrentBlockBtn"),exportCurrentBlockBtn:document.getElementById("exportCurrentBlockBtn"),articleBlockTrashBtn:document.getElementById("articleBlockTrashBtn"),articleNewBlockBtn:document.getElementById("articleNewBlockBtn"),articleToolbar:document.getElementById("articleToolbar"),outlineToolbar:document.getElementById("outlineToolbar"),outlineTagsBar:document.getElementById("outlineTagsBar"),outlineUndoBtn:document.getElementById("outlineUndoBtn"),outlineRedoBtn:document.getElementById("outlineRedoBtn"),outlineDeleteBtn:document.getElementById("outlineDeleteBtn"),outlineMoveUpBtn:document.getElementById("outlineMoveUpBtn"),outlineMoveDownBtn:document.getElementById("outlineMoveDownBtn"),outlineOutdentBtn:document.getElementById("outlineOutdentBtn"),outlineIndentBtn:document.getElementById("outlineIndentBtn"),outlineNewBelowBtn:document.getElementById("outlineNewBelowBtn"),outlineBoldBtn:document.getElementById("outlineBoldBtn"),outlineBulletListBtn:document.getElementById("outlineBulletListBtn"),outlineOrderedListBtn:document.getElementById("outlineOrderedListBtn"),outlineBlockquoteBtn:document.getElementById("outlineBlockquoteBtn"),outlineCodeBtn:document.getElementById("outlineCodeBtn"),outlineInsertTableBtn:document.getElementById("outlineInsertTableBtn"),outlineDeleteTableBtn:document.getElementById("outlineDeleteTableBtn"),outlineAddRowBtn:document.getElementById("outlineAddRowBtn"),outlineAddColBtn:document.getElementById("outlineAddColBtn"),pasteProgress:document.getElementById("pasteProgress"),mobileSidebarBtn:document.getElementById("mobileSidebarBtn"),sidebarBackdrop:document.getElementById("sidebarBackdrop"),dragModeToggleBtn:document.getElementById("dragModeToggleBtn"),listSidebarBtn:document.getElementById("listSidebarBtn"),outlineEditor:document.getElementById("outlineEditor")}});function da(){qr!==null&&(clearTimeout(qr),qr=null)}function Bi(e){Ti=!!e,J.toast&&(Ti?J.toast.dataset.protected="true":J.toast.removeAttribute("data-protected"))}function Ee(e,t={}){if(!J.toast)return;let n=typeof t.duration=="number"?t.duration:2500;t.protect?Bi(!0):Bi(!1),da(),J.toast.textContent=e,J.toast.classList.remove("hidden"),requestAnimationFrame(()=>{J.toast.classList.add("show")}),n>0&&(qr=setTimeout(()=>{J.toast.classList.remove("show"),setTimeout(()=>J.toast.classList.add("hidden"),200),qr=null},n))}function Ni(e,t={}){Ee(e,{...t,duration:0})}function or(e={}){J.toast&&(Ti&&!e.force||(da(),Bi(!1),J.toast.classList.remove("show"),J.toast.classList.add("hidden")))}var qr,Ti,Ft=je(()=>{ln();qr=null,Ti=!1;J.toast&&J.toast.addEventListener("click",()=>{or()})});function De(e){return new Promise((t,n)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error||new Error("IndexedDB request failed"))})}function et(e){return new Promise((t,n)=>{e.oncomplete=()=>t(),e.onabort=()=>n(e.error||new Error("IndexedDB transaction aborted")),e.onerror=()=>n(e.error||new Error("IndexedDB transaction failed"))})}function Cd(e){return String(e||"anon").replace(/[^a-zA-Z0-9_-]/g,"_")}function Td(e){return`memus_offline_v1_${Cd(e)}`}function Nd(e){try{let t=String(e||"").trim();if(!t)return;let n=window?.localStorage?.getItem?.(ua)||"[]",r=JSON.parse(n),o=Array.isArray(r)?r:[];o.includes(t)||o.push(t),window.localStorage.setItem(ua,JSON.stringify(o.slice(-200)))}catch{}}async function fa({userKey:e}={}){let t=e||"anon";Nd(t);let n=Td(t),r=indexedDB.open(n,Bd);r.onupgradeneeded=()=>{let i=r.result;if(i.objectStoreNames.contains("meta")||i.createObjectStore("meta",{keyPath:"key"}),!i.objectStoreNames.contains("articles")){let s=i.createObjectStore("articles",{keyPath:"id"});s.createIndex("byUpdatedAt","updatedAt",{unique:!1}),s.createIndex("byDeletedAt","deletedAt",{unique:!1})}if(!i.objectStoreNames.contains("outline_sections")){let s=i.createObjectStore("outline_sections",{keyPath:"sectionId"});s.createIndex("byArticleId","articleId",{unique:!1}),s.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!i.objectStoreNames.contains("section_embeddings")){let s=i.createObjectStore("section_embeddings",{keyPath:"sectionId"});s.createIndex("byArticleId","articleId",{unique:!1}),s.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!i.objectStoreNames.contains("media_assets")){let s=i.createObjectStore("media_assets",{keyPath:"url"});s.createIndex("byStatus","status",{unique:!1}),s.createIndex("byFetchedAtMs","fetchedAtMs",{unique:!1}),s.createIndex("byStatusFetchedAtMs",["status","fetchedAtMs"],{unique:!1})}if(!i.objectStoreNames.contains("media_refs")){let s=i.createObjectStore("media_refs",{keyPath:"key"});s.createIndex("byArticleId","articleId",{unique:!1}),s.createIndex("byUrl","url",{unique:!1})}if(i.objectStoreNames.contains("outbox")){let s=r.transaction;try{let a=s.objectStore("outbox");a.indexNames.contains("byTypeCoalesceKey")||a.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}catch{}}else{let s=i.createObjectStore("outbox",{keyPath:"id"});s.createIndex("byCreatedAtMs","createdAtMs",{unique:!1}),s.createIndex("byTypeArticleId",["type","articleId"],{unique:!1}),s.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}if(!i.objectStoreNames.contains("pending_uploads")){let s=i.createObjectStore("pending_uploads",{keyPath:"token"});s.createIndex("byArticleId","articleId",{unique:!1}),s.createIndex("byCreatedAtMs","createdAtMs",{unique:!1})}};let o=await De(r);try{o.onversionchange=()=>{try{o.close()}catch{}}}catch{}return o}async function pa(e){let t=e.transaction(["meta"],"readonly"),n=t.objectStore("meta");await De(n.get("ping")),await et(t)}var Bd,ua,An=je(()=>{Bd=3,ua="ttree_offline_known_user_keys_v1"});async function Co({userKey:e}={}){let t=String(e||"").trim();if(!t||t==="anon")try{let n=window?.localStorage?.getItem?.("ttree_offline_user_key_v1")||"",r=String(n||"").trim();r&&(t=r)}catch{}if(!t||t==="anon")try{let n=window?.localStorage?.getItem?.("ttree_last_user_v1")||"",r=n?JSON.parse(n):null,o=String(r?.id||r?.username||"").trim();o&&(t=o)}catch{}return t||(t="anon"),Eo&&ma===t||(ma=t,Eo=(async()=>await fa({userKey:t}))()),Eo}var Eo,ma,Mi=je(()=>{An();Eo=null,ma=null});function Bo(){try{return window?.localStorage?.getItem?.(Md)==="1"}catch{return!1}}function ba(){try{return window?.localStorage?.getItem?.(Ld)==="1"}catch{return!1}}function Li(e,t={}){try{if(!Bo())return;console.log("[perf][offline]",e,t)}catch{}}function Pd(){try{let e=window.__BUILD_ID__;return e?String(e):""}catch{return""}}function Pi(e,t){try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:e,data:t})}).catch(()=>{})}catch{}}async function _i(){let e={};try{e.ua=navigator?.userAgent||""}catch{e.ua=""}try{e.buildId=Pd()}catch{e.buildId=""}try{e.onLine=navigator?.onLine!==!1}catch{e.onLine=null}try{e.indexedDB=typeof indexedDB<"u"}catch{e.indexedDB=null}try{e.storagePersist=typeof navigator?.storage?.persist=="function"}catch{e.storagePersist=null}try{e.storageEstimate=typeof navigator?.storage?.estimate=="function"}catch{e.storageEstimate=null}try{if(navigator?.storage?.estimate){let t=await navigator.storage.estimate().catch(()=>null);t&&typeof t=="object"&&(e.quota=Number(t.quota||0)||null,e.usage=Number(t.usage||0)||null)}}catch{}return e}function _d(e){try{let t=window?.localStorage?.getItem?.("ttree_offline_user_key_v1")||"",n=String(t||"").trim();if(n)return n}catch{}return e&&(e.id||e.username)||"anon"}async function Dd(e){let t=_d(e);if(Ar&&ha===t)return Ar;ha=t,ga+=1;let n=ga;return Ar=(async()=>{let r=Bo()?performance.now():0;u.offlineReady=!1,u.offlineInitStatus="initializing",u.offlineInitError="",u.offlineInitStartedAt=Date.now();try{if(ya!==n){ya=n;let o=await _i().catch(()=>({}));Pi("offline.init.start",{t:new Date().toISOString(),attempt:n,userKey:t,env:o})}}catch{}try{ba()&&console.log("[offline] init start",{userKey:t})}catch{}try{let o=Bo()?performance.now():0,i=await Co({userKey:t});o&&Li("getOfflineDb()",{ms:Math.round(performance.now()-o)});let s=Bo()?performance.now():0;await pa(i),s&&Li("idb.ping",{ms:Math.round(performance.now()-s)});try{navigator?.storage?.persist&&navigator.storage.persist().catch(()=>{})}catch{}u.offlineReady=!0,u.offlineInitStatus="ready",u.offlineInitError="",u.offlineInitStartedAt=null;try{if(To!==n){To=n;let a=await _i().catch(()=>({}));Pi("offline.init.ready",{t:new Date().toISOString(),attempt:n,userKey:t,env:a})}}catch{}try{ba()&&console.log("[offline] init ready")}catch{}return r&&Li("initOfflineForUser.total",{userKey:t,ms:Math.round(performance.now()-r)}),i}catch(o){u.offlineReady=!1,u.offlineInitStatus="error",u.offlineInitStartedAt=null;try{console.error("[offline] init failed",o)}catch{}let i=o?.message?`Offline \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430: ${o.message}`:"Offline \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0432 \u044D\u0442\u043E\u043C \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435";u.offlineInitError=i,Ee(i);try{if(To!==n){To=n;let s=await _i().catch(()=>({}));Pi("offline.init.failed",{t:new Date().toISOString(),attempt:n,userKey:t,msg:i,err:{name:String(o?.name||""),message:String(o?.message||""),stack:String(o?.stack||"").slice(0,1500)},env:s})}}catch{}throw o}})(),Ar}async function ft(){return Ar||Dd(u.currentUser)}var Ar,ha,ga,ya,To,Md,Ld,ir=je(()=>{bt();Ft();Mi();An();Ar=null,ha=null,ga=0,ya=null,To=null,Md="ttree_profile_v1",Ld="ttree_debug_offline_v1"});function Di(e){if(!e)return"";if(e.type==="text")return String(e.text||"");let t=Array.isArray(e.content)?e.content:[];if(!t.length)return"";let n=[];for(let r of t){let o=Di(r);o&&n.push(o),r&&(r.type==="paragraph"||r.type==="hardBreak"||r.type==="heading")&&n.push(`
`)}return n.join("")}function wa(e){return String(e||"").replace(/\r\n/g,`
`).replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}function Sa(e,t=[]){for(let n of e||[]){if(!n||n.type!=="outlineSection")continue;let r=String(n.attrs?.id||""),o=n.content?.[0],i=n.content?.[1],s=n.content?.[2],a=wa(Di(o))||"",c=wa(Di(i))||"",l=`${a}
${c}`.trim();r&&t.push({sectionId:r,title:a,text:l});let d=s?.content||[];Sa(d,t)}return t}function Od(e){let t=Array.isArray(e?.content)?e.content:[];return Sa(t,[])}async function No(e,{articleId:t,docJson:n,updatedAt:r}){if(!e||!t||!n||typeof n!="object")return;let o=Od(n),i=e.transaction(["outline_sections"],"readwrite"),s=i.objectStore("outline_sections"),a=s.index("byArticleId"),c=IDBKeyRange.only(String(t)),l=await De(a.openCursor(c));for(;l;)l.delete(),l=await De(l.continue());for(let d of o)await De(s.put({sectionId:d.sectionId,articleId:String(t),title:d.title||"",text:d.text||"",updatedAt:r||null}));await et(i)}var xa=je(()=>{An()});function Hd(){try{return localStorage.getItem(Rd)==="1"}catch{return!1}}function $d(e){let t=String(e||"").trim();if(!t)return null;try{let n=new URL(t,window.location.origin);return n.origin!==window.location.origin?/^https?:\/\/memus\.pro\b/i.test(t)&&n.pathname.startsWith("/uploads/")?n.pathname+(n.search||""):null:n.pathname.startsWith("/uploads/")?n.pathname+(n.search||""):null}catch{return t.startsWith("/uploads/")?t:null}}function Fd(e){let t=new Set,n=r=>{if(!r)return;if(Array.isArray(r)){r.forEach(n);return}if(r.type==="image"){let i=$d(r.attrs?.src);i&&t.add(i)}(Array.isArray(r.content)?r.content:[]).forEach(n)};return n(e?.content||[]),Array.from(t)}async function Ir(e,t){let n=await ft(),r=Fd(t),o=n.transaction(["media_refs","media_assets"],"readwrite"),i=o.objectStore("media_refs"),s=o.objectStore("media_assets"),a=i.index("byArticleId"),c=IDBKeyRange.only(String(e)),l=await De(a.openCursor(c)).catch(()=>null);for(;l;)l.delete(),l=await De(l.continue()).catch(()=>null);for(let d of r){let h=`${String(e)}|${String(d)}`;await De(i.put({key:h,articleId:String(e),url:String(d)})),await De(s.get(d)).catch(()=>null)||await De(s.put({url:String(d),status:"needed",fetchedAtMs:0,failCount:0,lastError:null}))}await et(o)}async function Aa(e,t){let n=e.transaction(["media_assets"],"readwrite"),r=n.objectStore("media_assets"),o=await De(r.get(t)).catch(()=>null);await De(r.put({...o||{},url:String(t),status:"ok",fetchedAtMs:Date.now(),failCount:0,lastError:null})),await et(n)}async function zd(e,t,n){let r=String(n?.message||n||"error"),o=e.transaction(["media_assets"],"readwrite"),i=o.objectStore("media_assets"),s=await De(i.get(t)).catch(()=>null),a=Number(s?.failCount||0)+1;await De(i.put({...s||{},url:String(t),status:"error",fetchedAtMs:Date.now(),failCount:a,lastError:r})),await et(o)}async function Ud(e,t){let n=e.transaction(["media_assets"],"readonly"),o=n.objectStore("media_assets").index("byFetchedAtMs"),i=[],s=await De(o.openCursor()).catch(()=>null);for(;s;){let a=s.value,c=String(a?.status||""),l=Number(a?.failCount||0);if(c!=="ok"&&l<5){let d=String(a?.url||"");if(d&&i.push(d),i.length>=t)break}s=await De(s.continue()).catch(()=>null)}return await et(n),i}async function qd(e,t){try{return!!await e.match(t,{ignoreSearch:!1})}catch{return!1}}async function Vd(e,t){let n=await fetch(t,{credentials:"include"});if(!n||!n.ok)throw new Error(`HTTP ${n?.status||0}`);await e.put(t,n.clone())}function Jd(){try{let e=navigator.connection||navigator.mozConnection||navigator.webkitConnection,t=String(e?.effectiveType||"");if(!!e?.saveData||t.includes("2g"))return 1;if(t.includes("3g"))return 2}catch{}return 3}function va(){if(Ia)return;Ia=!0;let e=async()=>{if(!navigator.onLine||Hd())return;let t=Jd();if(Mo>=t)return;let n=await ft(),r=await caches.open(ka),o=await Ud(n,Math.max(5,t*3));if(o.length)for(let i of o){if(Mo>=t)break;Mo+=1,(async()=>{try{if(await qd(r,i)){await Aa(n,i);return}await Vd(r,i),await Aa(n,i)}catch(s){await zd(n,i,s)}finally{Mo-=1}})()}};setInterval(()=>{e().catch(()=>{})},1200),window.addEventListener("online",()=>{e().catch(()=>{})})}async function Ea(){let e=await ft(),t=await caches.open(ka),n=e.transaction(["media_assets","media_refs"],"readwrite"),r=n.objectStore("media_assets"),i=n.objectStore("media_refs").index("byUrl"),s=[],a=await De(r.openCursor()).catch(()=>null);for(;a&&s.length<500;){let c=String(a.value?.url||"");c&&(await De(i.count(IDBKeyRange.only(c))).catch(()=>0)||(s.push(c),a.delete())),a=await De(a.continue()).catch(()=>null)}if(await et(n),!s.length)return 0;for(let c of s)try{await t.delete(c)}catch{}return s.length}var ka,Rd,Ia,Mo,Oi=je(()=>{ir();An();ka="memus-uploads-v1",Rd="ttree_media_prefetch_paused_v1";Ia=!1,Mo=0});function Yd(e=null){try{if(window?.localStorage?.getItem?.(jd)!=="1")return!1;let t=String(window?.localStorage?.getItem?.(Kd)||"").trim();if(!t)return!0;let n=String(e||"").trim();return n?n===t:!0}catch{return!1}}function Xd(){try{return window?.localStorage?.getItem?.(Wd)==="1"}catch{return!1}}function Gd(e){try{return JSON.stringify(e)}catch{return'"[unserializable]"'}}function Qd(e){try{let t=String(e||""),n=2166136261;for(let r=0;r<t.length;r+=1)n^=t.charCodeAt(r),n=Math.imul(n,16777619);return(n>>>0).toString(16)}catch{return"0"}}function Bt(e){try{return!e||typeof e!="object"?null:Qd(Gd(e))}catch{return null}}function ot(e,t={}){try{let n=t?.articleId?String(t.articleId):null;if(!Yd(n))return!1;let r={t:new Date().toISOString(),kind:String(e||"event"),data:t&&typeof t=="object"?t:{value:t}},o=[];try{let i=window?.localStorage?.getItem?.(Lo)||"";o=i?JSON.parse(i):[],Array.isArray(o)||(o=[])}catch{o=[]}o.push(r),o.length>250&&(o=o.slice(o.length-250));try{window?.localStorage?.setItem?.(Lo,JSON.stringify(o))}catch{}if(Xd()&&navigator.onLine!==!1)try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:`revert:${r.kind}`,data:r})}).catch(()=>{})}catch{}return!0}catch{return!1}}function Zd(){try{let e=window?.localStorage?.getItem?.(Lo)||"",t=e?JSON.parse(e):[];return Array.isArray(t)?t:[]}catch{return[]}}function eu(){try{window?.localStorage?.removeItem?.(Lo)}catch{}}var jd,Kd,Wd,Lo,Vr=je(()=>{jd="ttree_debug_revert_v1",Kd="ttree_debug_revert_article_v1",Wd="ttree_client_log_v1",Lo="ttree_revert_log_v1";try{window.memusRevertLogDump=()=>Zd(),window.memusRevertLogClear=()=>eu()}catch{}});function tu(e){return{id:e.id,title:e.title,updatedAt:e.updatedAt,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:!!e.encrypted}}async function Mn(e){let t=await ft(),n=Array.isArray(e)?e:[],r=50;for(let o=0;o<n.length;o+=r){let i=n.slice(o,o+r),s=t.transaction(["articles"],"readwrite"),a=s.objectStore("articles");for(let c of i){let l=tu(c),h={...await De(a.get(l.id)).catch(()=>null)||{},id:l.id,title:l.title||"",updatedAt:l.updatedAt||null,parentId:l.parentId??null,position:typeof l.position=="number"?l.position:0,publicSlug:l.publicSlug??null,encrypted:l.encrypted?1:0,deletedAt:null};await De(a.put(h))}await et(s),await new Promise(c=>setTimeout(c,0))}}async function kr(){let t=(await ft()).transaction(["articles"],"readonly"),n=t.objectStore("articles"),r=await De(n.getAll()).catch(()=>[])||[];return await et(t),r.filter(o=>o&&!o.deletedAt).sort((o,i)=>Number(o.position||0)-Number(i.position||0)).map(o=>({id:o.id,title:o.title||"",updatedAt:o.updatedAt||null,parentId:o.parentId??null,position:typeof o.position=="number"?o.position:0,publicSlug:o.publicSlug??null,encrypted:!!o.encrypted}))}async function Ca(){let t=(await ft()).transaction(["articles"],"readonly"),n=t.objectStore("articles"),r=await De(n.getAll()).catch(()=>[])||[];return await et(t),r.filter(o=>o&&!o.deletedAt).map(o=>({id:o.id,updatedAt:o.updatedAt||null,hasDocJson:!!o.docJsonStr}))}async function vr(e){if(!e||!e.id)return;let t=await ft(),n=e.docJson&&typeof e.docJson=="object"?e.docJson:null,r=e.updatedAt||null,o=t.transaction(["articles"],"readwrite"),i=o.objectStore("articles"),s=await De(i.get(e.id)).catch(()=>null),a=null;try{a=s?.articleJsonStr?JSON.parse(s.articleJsonStr):null}catch{a=null}let c=!!(a&&a.localDraft),l=e&&Object.prototype.hasOwnProperty.call(e,"outlineStructureRev")?Number(e.outlineStructureRev):null;try{let h=String(s?.updatedAt||"").trim(),g=String(r||"").trim();if(h&&g&&g<h){ot("cache.article.put.skip_older",{articleId:e.id,existingUpdatedAt:h,incomingUpdatedAt:g,incomingDocHash:Bt(n)}),await et(o);return}if(c&&h&&g&&h===g){let w=Bt(s?.docJsonStr?JSON.parse(s.docJsonStr):null),S=Bt(n);if(w&&S&&w!==S){let f=a&&typeof a=="object"?{...a}:{};f.id=e.id,f.title=e.title||f.title||"",f.updatedAt=h,f.parentId=e.parentId??f.parentId??null,f.position=typeof e.position=="number"?e.position:f.position??0,f.publicSlug=e.publicSlug??f.publicSlug??null,f.encrypted=!!e.encrypted,Object.prototype.hasOwnProperty.call(e,"outlineStructureRev")&&(f.outlineStructureRev=Number(e.outlineStructureRev)||0),f.localDraft=!0;let p={...s||{},id:e.id,title:e.title||"",updatedAt:h,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:e.encrypted?1:0,deletedAt:null,outlineStructureRev:Number.isFinite(l)?l:Number(s?.outlineStructureRev),docJsonStr:s?.docJsonStr??null,articleJsonStr:JSON.stringify(f)};await De(i.put(p)),await et(o);try{ot("cache.article.put.skip_localDraft",{articleId:e.id,updatedAt:h,existingDocHash:w,incomingDocHash:S})}catch{}return}}}catch{}let d={...s||{},id:e.id,title:e.title||"",updatedAt:r,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:e.encrypted?1:0,deletedAt:null,outlineStructureRev:Number.isFinite(l)?l:Number(s?.outlineStructureRev),docJsonStr:n?JSON.stringify(n):null,articleJsonStr:JSON.stringify(e)};await De(i.put(d)),await et(o);try{ot("cache.article.put",{articleId:e.id,updatedAt:r,hasDocJson:!!n,docHash:Bt(n)})}catch{}n&&(No(t,{articleId:e.id,docJson:n,updatedAt:r}).catch(()=>{}),Ir(e.id,n).catch(()=>{}))}async function Ta(e,t){if(!e||!t)return;let n=await ft(),r=String(t),o=e.docJson&&typeof e.docJson=="object"?e.docJson:null,i=e.updatedAt||null,s=n.transaction(["articles"],"readwrite"),a=s.objectStore("articles"),c=await De(a.get(r)).catch(()=>null);try{let d=String(c?.updatedAt||"").trim(),h=String(i||"").trim();if(d&&h&&h<d){ot("cache.articleUnderId.put.skip_older",{articleId:r,existingUpdatedAt:d,incomingUpdatedAt:h,incomingDocHash:Bt(o)}),await et(s);return}}catch{}let l={...c||{},id:r,title:e.title||c?.title||"",updatedAt:i||c?.updatedAt||null,parentId:e.parentId??c?.parentId??null,position:typeof e.position=="number"?e.position:c?.position||0,publicSlug:e.publicSlug??c?.publicSlug??null,encrypted:e.encrypted||c?.encrypted?1:0,deletedAt:null,docJsonStr:o?JSON.stringify(o):c?.docJsonStr??null,articleJsonStr:JSON.stringify(e)};await De(a.put(l)),await et(s),o&&(No(n,{articleId:r,docJson:o,updatedAt:i}).catch(()=>{}),Ir(r,o).catch(()=>{}))}async function Rn(e){if(!e)return null;let n=(await ft()).transaction(["articles"],"readonly"),r=n.objectStore("articles"),o=await De(r.get(e)).catch(()=>null);if(await et(n),!o)return null;try{let i=JSON.parse(o.articleJsonStr||"null");return i&&!i.docJson&&o.docJsonStr&&(i.docJson=JSON.parse(o.docJsonStr)),i}catch{try{let i=o.docJsonStr?JSON.parse(o.docJsonStr):null,s={id:e,title:o.title||"",createdAt:o.createdAt||o.updatedAt||null,updatedAt:o.updatedAt||null,deletedAt:o.deletedAt||null,parentId:o.parentId??null,position:typeof o.position=="number"?o.position:0,authorId:null,publicSlug:o.publicSlug??null,encrypted:!!o.encrypted,outlineStructureRev:Number.isFinite(Number(o.outlineStructureRev))?Number(o.outlineStructureRev):void 0,docJson:i&&typeof i=="object"?i:null,history:[],redoHistory:[],blockTrash:[]};try{ot("cache.article.get.fallback_docJsonStr",{articleId:e,updatedAt:s.updatedAt||null,docHash:Bt(s.docJson)})}catch{}return s}catch{return null}}}async function nn(e,t,n){if(!e)return;let r=await ft(),o=r.transaction(["articles"],"readwrite"),i=o.objectStore("articles"),s=await De(i.get(e)).catch(()=>null),a=n||s&&s.updatedAt||null,c=()=>{let h=String(e)==="inbox"?"\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438":"",g=(s&&typeof s.title=="string"?s.title:"")||h,w=a,S={id:e,title:g,createdAt:s&&s.createdAt||w||null,updatedAt:w,deletedAt:s&&s.deletedAt||null,parentId:(s&&s.parentId)??null,position:typeof(s&&s.position)=="number"?s.position:0,authorId:null,publicSlug:(s&&s.publicSlug)??null,encrypted:!!(s&&s.encrypted),docJson:null,history:[],blocks:[]};return JSON.stringify(S)},l=()=>{let h=s&&s.articleJsonStr||"",g=null;try{g=h?JSON.parse(h):null}catch{g=null}if(!g||typeof g!="object")try{g=JSON.parse(c())}catch{g={id:e}}return g.id=e,g.updatedAt=a||g.updatedAt||null,g.docJson=t&&typeof t=="object"?t:null,t&&typeof t=="object"&&(g.localDraft=!0),!g.title&&s?.title&&(g.title=s.title),g.deletedAt===void 0&&(g.deletedAt=null),g.parentId===void 0&&(g.parentId=s?.parentId??null),g.position===void 0&&(g.position=typeof s?.position=="number"?s.position:0),g.publicSlug===void 0&&(g.publicSlug=s?.publicSlug??null),g.encrypted===void 0&&(g.encrypted=!!s?.encrypted),g.history===void 0&&(g.history=[]),g.blocks===void 0&&(g.blocks=[]),JSON.stringify(g)},d={...s||{id:e},id:e,outlineStructureRev:s?.outlineStructureRev,docJsonStr:t?JSON.stringify(t):null,updatedAt:a,articleJsonStr:l()};await De(i.put(d)),await et(o);try{ot("cache.docJson.put",{articleId:e,updatedAt:a,docHash:Bt(t)})}catch{}t&&typeof t=="object"&&(No(r,{articleId:e,docJson:t,updatedAt:n}).catch(()=>{}),Ir(e,t).catch(()=>{}))}async function Ba(e){let t=String(e||"").trim();if(!t)return;let r=(await ft()).transaction(["articles"],"readwrite"),o=r.objectStore("articles"),i=await De(o.get(t)).catch(()=>null);if(!i){await et(r);return}let s=null;try{s=i.articleJsonStr?JSON.parse(i.articleJsonStr):null}catch{s=null}(!s||typeof s!="object")&&(s={id:t}),s.id=t,delete s.localDraft;let a={...i,articleJsonStr:JSON.stringify(s)};await De(o.put(a)),await et(r)}async function Na(e){let t=await ft(),n=Array.isArray(e)?e:[];if(!n.length)return;let r=t.transaction(["articles"],"readwrite"),o=r.objectStore("articles");for(let i of n){if(!i||!i.id)continue;let s=await De(o.get(i.id)).catch(()=>null);if(!s)continue;let a={...s,parentId:i.parentId??null,position:typeof i.position=="number"?i.position:0};await De(o.put(a))}await et(r)}async function Ri(e,t){let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return;let i=(await ft()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),a=await De(s.get(n)).catch(()=>null);if(!a){await et(i);return}let c=null;try{c=a.articleJsonStr?JSON.parse(a.articleJsonStr):null}catch{c=null}(!c||typeof c!="object")&&(c={id:n}),c.id=n,c.updatedAt=r;let l={...a,updatedAt:r,articleJsonStr:JSON.stringify(c)};await De(s.put(l)),await et(i)}async function Hi(e,t){let n=String(e||"").trim();if(!n)return;let r=Number(t);if(!Number.isFinite(r)||r<0)return;let i=(await ft()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),a=await De(s.get(n)).catch(()=>null);if(!a){await et(i);return}let c=null;try{c=a.articleJsonStr?JSON.parse(a.articleJsonStr):null}catch{c=null}(!c||typeof c!="object")&&(c={id:n}),c.id=n,c.outlineStructureRev=r;let l={...a,outlineStructureRev:r,articleJsonStr:JSON.stringify(c)};await De(s.put(l)),await et(i)}var Jr=je(()=>{ir();An();xa();Oi();Vr()});function $i(){try{window.dispatchEvent(new CustomEvent("offline-outbox-changed"))}catch{}}function nu(){return globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?globalThis.crypto.randomUUID():`id-${Date.now()}-${Math.random().toString(16).slice(2)}`}function Ma(){return new Date().toISOString()}async function zt(e,{articleId:t,payload:n,coalesceKey:r}={}){let o=await ft(),i=nu(),s=Ma(),a=n?JSON.stringify(n):"{}",c=o.transaction(["outbox"],"readwrite"),l=c.objectStore("outbox"),d=l.index("byTypeArticleId"),h=l.index("byTypeCoalesceKey");if(r){let g=[String(e||""),String(r||"")],w=await De(h.openCursor(IDBKeyRange.only(g))).catch(()=>null);for(;w;)w.delete(),w=await De(w.continue()).catch(()=>null)}else if(t){let g=[String(e||""),t||null],w=await De(d.openCursor(IDBKeyRange.only(g))).catch(()=>null);for(;w;)w.delete(),w=await De(w.continue()).catch(()=>null)}return await De(l.put({id:i,createdAt:s,createdAtMs:Date.now(),type:String(e||""),articleId:t||null,coalesceKey:r?String(r):null,payloadJson:a,attempts:0,lastError:null,lastAttemptAt:null})),await et(c),$i(),i}async function sr(e=50){let n=(await ft()).transaction(["outbox"],"readonly"),o=n.objectStore("outbox").index("byCreatedAtMs"),i=[],s=await De(o.openCursor()).catch(()=>null);for(;s&&(i.push(s.value),!(i.length>=e));)s=await De(s.continue()).catch(()=>null);return await et(n),i.map(a=>{let c={};try{c=JSON.parse(a?.payloadJson||"{}")}catch{c={}}return{id:a.id,createdAt:a.createdAt,type:a.type,articleId:a.articleId,payload:c,attempts:a.attempts||0}})}async function La(e,t){let r=(await ft()).transaction(["outbox"],"readwrite"),o=r.objectStore("outbox"),i=await De(o.get(e)).catch(()=>null);i&&await De(o.put({...i,attempts:Number(i.attempts||0)+1,lastError:String(t||"error"),lastAttemptAt:Ma()})),await et(r),$i()}async function qn(e){let n=(await ft()).transaction(["outbox"],"readwrite"),r=n.objectStore("outbox");await De(r.delete(e)),await et(n),$i()}var jr=je(()=>{ir();An()});function iu(e){let t=Array.isArray(e)?e:[],n=new Float32Array(t.length),r=0;for(let o=0;o<t.length;o+=1){let i=Number(t[o]||0);n[o]=i,r+=i*i}if(r>0){let o=1/Math.sqrt(r);for(let i=0;i<n.length;i+=1)n[i]*=o}return n}function Pa(){ru=null,ou=0}async function Fi(e,t){if(!e)return;let n=await ft(),r=Array.isArray(t)?t:[],o=n.transaction(["section_embeddings"],"readwrite"),i=o.objectStore("section_embeddings");for(let s of r){let a=String(s?.blockId||s?.sectionId||""),c=String(s?.updatedAt||"")||null,l=s?.embedding;if(!a||!Array.isArray(l)||!l.length)continue;let d=iu(l);await De(i.put({sectionId:a,articleId:String(e),updatedAt:c,vec:d}))}await et(o),Pa()}async function Po(e){let t=(e||[]).map(i=>String(i||"")).filter(Boolean);if(!t.length)return;let r=(await ft()).transaction(["section_embeddings"],"readwrite"),o=r.objectStore("section_embeddings");for(let i of t)await De(o.delete(i));await et(r),Pa()}var ru,ou,zi=je(()=>{ir();An();ru=null,ou=0});var _a=je(()=>{ir();zi();An()});function _o(){try{return window?.localStorage?.getItem?.(su)==="1"}catch{return!1}}function Ot(...e){try{if(!_o())return;console.log(...e)}catch{}}async function gt(e,t={}){let n=_o()?performance.now():0,r=n?performance.now():0,o=await fetch(e,{headers:{"Content-Type":"application/json",...t.headers||{}},credentials:"include",...t}),i=r?performance.now():0;if(!o.ok){if(o.status===401||o.status===403){try{u.serverStatus="auth",u.serverStatusText="auth"}catch{}try{window.dispatchEvent(new CustomEvent("memus:auth-required",{detail:{path:e,status:o.status}}))}catch{}}let l=await o.json().catch(()=>({}));throw n&&console.log("[perf][api]",e,{status:o.status,ms:Math.round(performance.now()-n),fetchMs:i?Math.round(i-r):null}),new Error(l.detail||"Request failed")}try{u.serverStatus==="down"&&(u.serverStatus="ok",u.serverStatusText="")}catch{}if(o.status===204)return n&&console.log("[perf][api]",e,{status:204,ms:Math.round(performance.now()-n),fetchMs:i?Math.round(i-r):null}),null;let s=n?performance.now():0,a=await o.json(),c=n?performance.now():0;try{if(window?.localStorage?.getItem?.("ttree_debug_article_load_v1")==="1"){let l=o.headers.get("X-Memus-Article-ms"),d=o.headers.get("X-Memus-DocJson-bytes");(l||d)&&console.log("[api]",e,{ms:l,docJsonBytes:d})}}catch{}if(n){let l=o.headers.get("X-Memus-Article-ms")||o.headers.get("X-Memus-Articles-ms")||o.headers.get("X-Memus-Server-ms"),d=o.headers.get("X-Memus-DocJson-bytes"),h=o.headers.get("X-Memus-Articles-count"),g=o.headers.get("Content-Length");console.log("[perf][api]",e,{status:o.status,ms:Math.round(c-n),fetchMs:i?Math.round(i-r):null,jsonMs:s?Math.round(c-s):null,serverMs:l?Number(l):null,docJsonBytes:d?Number(d):null,articlesCount:h?Number(h):null,contentLength:g?Number(g):null})}return a}function cu(){try{return window?.localStorage?.getItem?.(au)==="1"}catch{return!1}}async function Da({timeoutMs:e}){let t=typeof e=="number"?Math.max(0,Math.floor(e)):0,n=null,r=null;try{return t>0&&typeof AbortController<"u"&&(r=new AbortController,n=setTimeout(()=>{try{r.abort()}catch{}},t)),await gt("/api/articles",r?{signal:r.signal}:{})}catch(o){if((o?.message||String(o||"")).toLowerCase().includes("abort"))try{u.serverStatus="down",u.serverStatusText="timeout"}catch{}throw o}finally{n&&clearTimeout(n)}}function dn(){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return kr().catch(()=>[]);if(Kr)return Kr;let e=u?.offlineReady?600:250,t=2200;return Kr=(async()=>{let n=_o()?performance.now():0,r=null,o=!1,i=new Promise(l=>{r=setTimeout(()=>{!o&&n&&Ot("[offline-first][articles] cache.lookup.timeout",{preferCacheMs:e}),l(null)},e)}),s=kr().then(l=>(o=!0,r&&clearTimeout(r),r=null,n&&Ot("[offline-first][articles] cache.lookup.done",{ms:Math.round(performance.now()-n),hit:!!(l&&l.length)}),l)).catch(()=>(o=!0,r&&clearTimeout(r),r=null,null)),a=await Promise.race([s,i]);if(a&&a.length)return Ui||(Ui=Da({timeoutMs:t}).then(async l=>{try{typeof requestIdleCallback=="function"?requestIdleCallback(()=>Mn(l).catch(()=>{}),{timeout:2500}):setTimeout(()=>Mn(l).catch(()=>{}),250)}catch{Mn(l).catch(()=>{})}}).catch(()=>{}).finally(()=>{Ui=null})),a;let c=await Da({timeoutMs:t});try{typeof requestIdleCallback=="function"?requestIdleCallback(()=>Mn(c).catch(()=>{}),{timeout:2500}):setTimeout(()=>Mn(c).catch(()=>{}),250)}catch{Mn(c).catch(()=>{})}try{let l=await kr().catch(()=>null),d=Array.isArray(c)?c.length:0,h=l&&Array.isArray(l)?l.length:0;if(h>=20&&d<=3||cu()&&h&&h>d)return l}catch{}return c})().catch(async n=>{let r=await kr().catch(()=>null);if(r&&r.length)return r;throw n}).finally(()=>{Kr=null}),Kr}function Ha(){return typeof navigator<"u"&&navigator&&navigator.onLine===!1?Promise.resolve([]):gt("/api/articles/deleted").catch(async e=>[])}function $a(e,t={}){let n=String(e||"").trim();e=n.startsWith("inbox-")?"inbox":n;let{cacheTimeoutMs:o,metaTimeoutMs:i,...s}=t||{},a=u?.offlineReady?400:150,c=typeof o=="number"?Math.max(0,Math.floor(o)):a,l=typeof i=="number"?Math.max(0,Math.floor(i)):350,d=_o()?performance.now():0,h=null,g=!1,w=new Promise($=>{h=setTimeout(()=>{!g&&d&&Ot("[offline-first][article] cache.lookup.timeout",{id:e,cacheTimeoutMs:c}),$(null)},c)}),S=Rn(e).then($=>(g=!0,h&&clearTimeout(h),h=null,d&&Ot("[offline-first][article] cache.lookup.done",{id:e,ms:Math.round(performance.now()-d),hit:!!$}),$)).catch($=>(g=!0,h&&clearTimeout(h),h=null,d&&Ot("[offline-first][article] cache.lookup.failed",{id:e,ms:Math.round(performance.now()-d),message:$?.message||String($||"")}),null)),f=Promise.race([S,w]),p=()=>gt(`/api/articles/${e}?include_history=0`,{...s,cache:"no-store"}).then(async $=>{try{ot("article.fetch.network.ok",{articleId:e,updatedAt:$?.updatedAt||null,docHash:Bt($?.docJson||null)})}catch{}return vr($).catch(()=>{}),$&&$.id&&String($.id)!==String(e)&&Ta($,e).catch(()=>{}),$}).catch(async $=>{let Q=await Rn(e).catch(()=>null);try{ot("article.fetch.network.err",{articleId:e,message:$?.message||String($||""),cachedHit:!!Q,cachedUpdatedAt:Q?.updatedAt||null,cachedDocHash:Bt(Q?.docJson||null)})}catch{}if(Q)return Q;throw $}),y=()=>{let $=new Date().toISOString(),W={type:"doc",content:[{type:"outlineSection",attrs:{id:(globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?()=>globalThis.crypto.randomUUID():()=>`id-${Date.now()}-${Math.random().toString(16).slice(2)}`)(),collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}]};return{id:"inbox",title:"\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438",createdAt:$,updatedAt:$,deletedAt:null,parentId:null,position:0,authorId:null,publicSlug:null,encrypted:!1,docJson:W,history:[]}},k="ttree_pending_quick_notes_v1",E=()=>{try{let $=window?.localStorage?.getItem?.(k)||"";if(!$)return[];let Q=JSON.parse($);return Array.isArray(Q)?Q.filter(Boolean):[]}catch{return[]}},L=($,Q)=>{let W=String($||"").trim();if(!W)return null;let we=String(Q||"").trim().split(/\r?\n/),Ne=[];for(let Z=0;Z<we.length;Z+=1){let pe=we[Z];pe&&Ne.push({type:"text",text:pe}),Z!==we.length-1&&Ne.push({type:"hardBreak"})}return{type:"outlineSection",attrs:{id:W,collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[Ne.length?{type:"paragraph",content:Ne}:{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}},O=$=>{try{if(!$||String($.id||"")!=="inbox")return $;let Q=E();if(!Q.length)return $;let W=$?.docJson&&typeof $.docJson=="object"?$.docJson:{type:"doc",content:[]},re=Array.isArray(W.content)?W.content:[],we=new Set(re.filter(Z=>Z&&Z.type==="outlineSection"&&Z.attrs&&Z.attrs.id).map(Z=>String(Z.attrs.id))),Ne=[];for(let Z of Q){let pe=String(Z?.sectionId||Z?.id||"").trim();if(!pe||we.has(pe))continue;let We=L(pe,Z?.text||"");We&&Ne.push(We)}return Ne.length?{...$,docJson:{...W,type:W.type||"doc",content:[...Ne,...re]}}:$}catch{return $}},z=()=>gt(`/api/articles/${encodeURIComponent(e)}/meta`,{method:"GET",headers:{...s.headers||{}},cache:"no-store"}),q=()=>l?Promise.race([z(),new Promise(($,Q)=>setTimeout(()=>{let W=new Error("meta_timeout");W.name="TimeoutError",Q(W)},l))]):z();return f.then(async $=>{if(!$){if(!navigator.onLine&&String(e)==="inbox"){try{let Ne=await Promise.race([S,new Promise(Z=>setTimeout(()=>Z(null),Math.max(500,l*5)))]);if(Ne){Ot("[offline-first][article] choose.cache.late.offline.inbox",{id:e});try{ot("article.choose",{articleId:e,choose:"cache.late.offline.inbox"})}catch{}return O(Ne)}}catch{}return Ot("[offline-first][article] choose.local.inbox.offline",{id:e}),O(y())}let W=S.then(Ne=>Ne?{src:"cache",article:O(Ne)}:new Promise(()=>{})).catch(()=>new Promise(()=>{})),re=(async()=>({src:"network",article:await O(p())}))(),we=await Promise.race([W,re]);if(we?.src==="cache"){Ot("[offline-first][article] choose.cache.late",{id:e});try{ot("article.choose",{articleId:e,choose:"cache.late"})}catch{}return re.catch(()=>{}),we.article}Ot("[offline-first][article] choose.network.no-cache",{id:e});try{ot("article.choose",{articleId:e,choose:"network.no_cache"})}catch{}return we.article}if(!navigator.onLine){Ot("[offline-first][article] choose.cache.offline",{id:e,updatedAt:$?.updatedAt||null});try{ot("article.choose",{articleId:e,choose:"cache.offline",cachedUpdatedAt:$?.updatedAt||null,cachedDocHash:Bt($?.docJson||null)})}catch{}return O($)}let Q=String($.updatedAt||$.updated_at||"").trim();if(!Q){Ot("[offline-first][article] choose.network.no-cached-updatedAt",{id:e});try{ot("article.choose",{articleId:e,choose:"network.no_cached_updatedAt",cachedDocHash:Bt($?.docJson||null)})}catch{}return O(await p())}try{Ot("[offline-first][article] meta.check.start",{id:e,cachedUpdatedAt:Q});let W=await q(),re=String(W?.updatedAt||"").trim();if(re&&re===Q){Ot("[offline-first][article] choose.cache.meta.same",{id:e,cachedUpdatedAt:Q});try{ot("article.choose",{articleId:e,choose:"cache.meta.same",cachedUpdatedAt:Q,serverUpdatedAt:re,cachedDocHash:Bt($?.docJson||null)})}catch{}return O($)}Ot("[offline-first][article] choose.network.meta.diff",{id:e,cachedUpdatedAt:Q,serverUpdatedAt:re||null});try{ot("article.choose",{articleId:e,choose:"network.meta.diff",cachedUpdatedAt:Q,serverUpdatedAt:re||null,cachedDocHash:Bt(cached?.docJson||null)})}catch{}return O(await p())}catch(W){String(W?.name||"")==="TimeoutError"||String(W?.message||"")==="meta_timeout"?Ot("[offline-first][article] meta.check.timeout",{id:e,metaTimeoutMs:l}):Ot("[offline-first][article] meta.check.failed",{id:e,message:W?.message||String(W||"")}),p().catch(()=>{}),String(W?.name||"")==="TimeoutError"||String(W?.message||"")==="meta_timeout"?Ot("[offline-first][article] choose.cache.meta.timeout",{id:e,cachedUpdatedAt:Q,metaTimeoutMs:l}):Ot("[offline-first][article] choose.cache.meta.failed",{id:e,cachedUpdatedAt:Q});try{ot("article.choose",{articleId:e,choose:String(W?.name||"")==="TimeoutError"||String(W?.message||"")==="meta_timeout"?"cache.meta.timeout":"cache.meta.failed",cachedUpdatedAt:Q,cachedDocHash:Bt($?.docJson||null),error:W?.message||String(W||"")})}catch{}return O($)}})}function Fa(e,t){return e?!t||typeof t!="object"?Promise.reject(new Error("docJson must be object")):gt(`/api/articles/${encodeURIComponent(e)}/doc-json`,{method:"PUT",body:JSON.stringify({docJson:t})}):Promise.reject(new Error("articleId is required"))}function za(e){return typeof e!="string"?Promise.reject(new Error("text must be string")):gt("/api/outline/generate-title",{method:"POST",body:JSON.stringify({text:e})})}function qi(e){return typeof e!="string"?Promise.reject(new Error("html must be string")):gt("/api/outline/proofread-html",{method:"POST",body:JSON.stringify({html:e})})}function Ua(e,t={}){let n=t.force?"?force=true":"";return gt(`/api/articles/${e}${n}`,{method:"DELETE"})}function qa(e){return gt(`/api/articles/${e}/restore`,{method:"POST"})}function Va(e,t,n={}){let r=Array.isArray(t)?t.filter(Boolean).map(o=>String(o)):[];return e?r.length?gt(`/api/articles/${encodeURIComponent(e)}/sections/delete`,{method:"PUT",cache:"no-store",body:JSON.stringify({opId:n?.opId||null,sectionIds:r})}):Promise.resolve({status:"ok",removedBlockIds:[]}):Promise.reject(new Error("articleId is required"))}function Wr(e){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return Promise.reject(new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D"));let t=new FormData;t.append("file",e);let n=i=>{if(!(typeof navigator<"u"&&navigator&&navigator.onLine===!1))try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"uploadImageFile",data:i})}).catch(()=>{})}catch{}},r=()=>fetch("/api/uploads",{method:"POST",credentials:"include",body:t}).then(async i=>{let s=await i.json().catch(()=>null);if(n({transport:"fetch",status:i.status,ok:i.ok,details:s,name:e&&e.name,type:e&&e.type,size:e&&e.size}),!i.ok){let a=s?.detail||`Upload failed (status ${i.status})`,c=new Error(a);throw c.status=i.status,c.details=s,c}return s}),o=()=>new Promise((i,s)=>{let a=new XMLHttpRequest;a.open("POST","/api/uploads"),a.withCredentials=!0,a.onreadystatechange=()=>{if(a.readyState===XMLHttpRequest.DONE)try{let c=a.status,l=null;try{l=JSON.parse(a.responseText||"null")}catch{l=null}if(n({transport:"xhr",status:c,ok:c>=200&&c<300,details:l,name:e&&e.name,type:e&&e.type,size:e&&e.size}),c>=200&&c<300)i(l);else{let d=l&&l.detail||`Upload failed (status ${c})`,h=new Error(d);h.status=c,h.details=l,s(h)}}catch(c){s(c)}},a.onerror=()=>{n({transport:"xhr",status:0,ok:!1,details:{detail:"Network error during image upload"},name:e&&e.name,type:e&&e.type,size:e&&e.size});let c=new Error("Upload failed (network error)");c.status=0,c.details={detail:"Network error during image upload"},s(c)},a.send(t)});return r().catch(i=>{let s=String(i&&i.message?i.message:"").toLowerCase();if(s.includes("status ")||s.includes("upload failed"))throw i;return o()})}function lu(e,t,n=()=>{},{sectionId:r}={}){return typeof navigator<"u"&&navigator&&navigator.onLine===!1?Promise.reject(new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D")):new Promise((o,i)=>{let s=new XMLHttpRequest;s.open("POST",`/api/articles/${e}/attachments`),s.withCredentials=!0,s.upload.onprogress=c=>{if(c.lengthComputable){let l=Math.round(c.loaded/c.total*100);n(l)}},s.onreadystatechange=()=>{if(s.readyState===XMLHttpRequest.DONE)if(s.status>=200&&s.status<300)try{let c=JSON.parse(s.responseText||"{}");o(c)}catch(c){i(c)}else{let c=`Attachment upload failed (status ${s.status})`;try{let l=JSON.parse(s.responseText||"{}");l?.detail&&(c=l.detail)}catch{}i(new Error(c))}},s.onerror=()=>i(new Error("Network error during upload"));let a=new FormData;a.append("file",t),r&&a.append("sectionId",String(r)),s.send(a)})}function du(e){let t=new Map;for(let n of e||[]){let r=n.parentId??null;t.has(r)||t.set(r,[]),t.get(r).push(n)}for(let n of t.values())n.sort((r,o)=>(r.position||0)-(o.position||0));return t}function Oa(e){let t=[];for(let n=0;n<e.length;n+=1){let r=e[n];if(!r)continue;let o=n;(r.position||0)!==o&&(r.position=o,t.push({id:r.id,parentId:r.parentId??null,position:o}))}return t}function Ja(e,t){return e?gt(`/api/articles/${encodeURIComponent(e)}/move-tree`,{method:"POST",body:JSON.stringify(t||{})}).catch(async()=>{let r=await kr().catch(()=>[]),o=du(r),i=(r||[]).find(p=>p.id===e);if(!i)return null;let s=t&&t.placement||null,a=t&&t.anchorId||null,c=t?t.parentId??null:null;s==="inside"&&a&&(c=a);let l=i.parentId??null,h=(o.get(l)||[]).filter(p=>p.id!==e),w=(o.get(c)||[]).filter(p=>p.id!==e),S=w.length;if(a){let p=w.findIndex(y=>y.id===a);p!==-1&&(s==="before"?S=p:s==="after"?S=p+1:s==="inside"&&(S=w.length))}i.parentId=c,w.splice(S,0,i);let f=[];return f.push(...Oa(h)),f.push(...Oa(w)),Na(f).catch(()=>{}),zt("move_article_tree",{articleId:e,payload:t||{},coalesceKey:`${e}:move-tree`}).catch(()=>{}),{id:e}}):Promise.resolve(null)}async function uu({articleId:e,filename:t,overwrite:n=!1,sha256:r="",size:o=0}){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D");let s=await fetch("/api/yandex/disk/upload-url",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({filename:t||"",articleId:e||"",overwrite:!!n,sha256:r||"",size:typeof o=="number"?o:0})}),a=await s.json().catch(()=>null);if(!s.ok){let c=a&&a.detail||`Yandex upload URL failed (status ${s.status})`;throw new Error(c)}return a}async function Ra(e,{path:t,originalName:n,contentType:r,size:o,sectionId:i}){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D");let s={path:t||"",originalName:n||"",contentType:r||"",size:typeof o=="number"?o:0};i&&(s.sectionId=String(i));let a=await fetch(`/api/articles/${e}/attachments/yandex`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),c=await a.json().catch(()=>null);if(!a.ok){let l=c&&c.detail||`Register Yandex attachment failed (status ${a.status})`;throw new Error(l)}return c}async function Do(e,t,{onProgress:n,sectionId:r}={}){if(!t)throw new Error("\u0424\u0430\u0439\u043B \u043D\u0435 \u0443\u043A\u0430\u0437\u0430\u043D");let o="";try{if(window.crypto&&window.crypto.subtle&&typeof t.arrayBuffer=="function"){let g=await t.arrayBuffer(),w=await window.crypto.subtle.digest("SHA-256",g),S=new Uint8Array(w);o=Array.from(S).map(f=>f.toString(16).padStart(2,"0")).join("")}}catch{o=""}let{href:i,method:s,path:a,exists:c,same:l}=await uu({articleId:e,filename:t.name||"attachment",overwrite:!1,sha256:o,size:t.size||0});if(c&&l&&!i)return await Ra(e,{path:a,originalName:t.name||"attachment",contentType:t.type||"",size:t.size||0,sectionId:r});let d=!1;if(i)try{await new Promise((g,w)=>{let S=new XMLHttpRequest;S.open(s||"PUT",i),S.upload.onprogress=f=>{if(n&&f.lengthComputable){let p=Math.round(f.loaded/f.total*100);try{n(p)}catch{}}},S.onreadystatechange=()=>{S.readyState===XMLHttpRequest.DONE&&(S.status>=200&&S.status<300?g():w(new Error(`Yandex upload failed (status ${S.status})`)))},S.onerror=()=>w(new Error("Network error during Yandex upload")),S.send(t)}),d=!0}catch(g){console.warn("[attachments] Direct Yandex upload failed, falling back to server upload",g),d=!1}return d?await Ra(e,{path:a,originalName:t.name||"attachment",contentType:t.type||"",size:t.size||0,sectionId:r}):await lu(e,t,n,{sectionId:r})}var su,Kr,Ui,au,Wt=je(()=>{Jr();jr();_a();bt();Vr();su="ttree_profile_v1";Kr=null,Ui=null,au="ttree_offline_recovery_force_index_v1"});function ja(){if(!J.articlePublicToggleBtn)return;let e=u.article?.publicSlug||null;J.articlePublicToggleBtn.textContent=e?"\u041E\u0442\u043C\u0435\u043D\u0438\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435":"\u0414\u0430\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435"}function Yr(){let e=u.article;if(!e)return;let t=e.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";if(J.articleTitle&&(J.articleTitle.textContent=t,J.articleTitle.classList.toggle("article-title--encrypted",!!e.encrypted),J.articleTitle.classList.toggle("hidden",u.isEditingTitle)),J.articleTitleInput&&(u.isEditingTitle||(J.articleTitleInput.value=t),J.articleTitleInput.classList.toggle("hidden",!u.isEditingTitle)),J.editTitleBtn&&J.editTitleBtn.classList.toggle("hidden",u.isEditingTitle),J.articleFavoriteBtn){let r=new Set(u.favoriteArticles||[]).has(e.id);J.articleFavoriteBtn.textContent=r?"\uE735":"\uE734",J.articleFavoriteBtn.title=r?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}if(J.articlePublicLinkBtn){let n=!!e.publicSlug;J.articlePublicLinkBtn.classList.toggle("hidden",!n),n&&(J.articlePublicLinkBtn.title="\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0441\u044B\u043B\u043A\u0443")}if(J.deleteArticleBtn&&J.deleteArticleBtn.classList.toggle("hidden",e.id==="inbox"),J.articleEncryptionBtn&&(J.articleEncryptionBtn.textContent=e.encrypted?"\u0421\u043C\u0435\u043D\u0438\u0442\u044C \u043F\u0430\u0440\u043E\u043B\u044C":"\u0417\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C"),J.articleEncryptionRemoveBtn&&J.articleEncryptionRemoveBtn.classList.toggle("hidden",!e.encrypted),J.updatedAt&&(u.isOutlineEditing?J.updatedAt.textContent=u.outlineStatusText||"":e.updatedAt?J.updatedAt.textContent=`\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${new Date(e.updatedAt).toLocaleString()}`:J.updatedAt.textContent=""),J.articleStatusText&&(u.isOutlineEditing?J.articleStatusText.textContent=u.outlineStatusText||"":e.updatedAt?J.articleStatusText.textContent=`\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${new Date(e.updatedAt).toLocaleString()}`:J.articleStatusText.textContent=""),J.mediaStatusText&&(J.mediaStatusText.textContent=u.mediaStatusText||""),J.mediaPrefetchToggleBtn){let n=!!u.mediaPrefetchPaused;J.mediaPrefetchToggleBtn.textContent=n?"\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C":"\u041F\u0430\u0443\u0437\u0430",J.mediaPrefetchToggleBtn.classList.toggle("is-active",n)}}var Xr=je(()=>{bt();ln()});function Ut(...e){console.log("[debug]",...e)}function Rt(e=""){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Ka(e=""){let t=(e||"").replace(/<br\s*\/?>/gi,`
`).replace(/<\/(?:div|p|li|h[1-6])>/gi,`
`),n=document.createElement("template");return n.innerHTML=t,(n.content.textContent||"").split(`
`).map(r=>r.replace(/\s+/g," ").trim()).filter(r=>r.length)}function Oo(e){if(!e||!e.isConnected)return;let t=window.getSelection();if(!t)return;let n=document.createRange();n.selectNodeContents(e),n.collapse(!1),t.removeAllRanges(),t.addRange(n)}function Vi(e){if(!e||!e.isConnected)return;let t=window.getSelection();if(!t)return;let n=document.createRange();n.selectNodeContents(e),n.collapse(!0),t.removeAllRanges(),t.addRange(n)}function Hn(e,t){if(!e||!document.contains(e))return;e.focus();let n=window.getSelection();if(!n)return;let r=n.rangeCount>0?n.getRangeAt(0):document.createRange();e.contains(r.commonAncestorContainer)||(r=document.createRange(),r.selectNodeContents(e),r.collapse(!1)),n.removeAllRanges(),n.addRange(r);let o=r.createContextualFragment(t);r.deleteContents(),r.insertNode(o),r.collapse(!1),n.removeAllRanges(),n.addRange(r)}var In=je(()=>{});var ji={};vo(ji,{showArticleHistoryModal:()=>Su,showArticleLinkPrompt:()=>pu,showBlockHistoryModal:()=>bu,showBlockTrashPicker:()=>xu,showConfirm:()=>Xa,showImagePreview:()=>Gr,showImportConflictDialog:()=>Au,showLinkPrompt:()=>Ji,showPasswordWithHintPrompt:()=>Ga,showPrompt:()=>Vn,showPublicLinkModal:()=>mu,showVersionCompareTargetPicker:()=>gu,showVersionDiffModal:()=>yu,showVersionsPicker:()=>hu});function rn(){let e=document.getElementById(Wa);return e||(e=document.createElement("div"),e.id=Wa,document.body.appendChild(e)),e}function hn({title:e,message:t,confirmText:n,cancelText:r,renderBody:o}){let i=document.createElement("div");i.className="modal-overlay";let s=document.createElement("form");s.className="modal-form",s.addEventListener("submit",S=>{S.preventDefault()});let a=document.createElement("div");a.className="modal-card",a.setAttribute("role","dialog"),a.setAttribute("aria-modal","true"),a.tabIndex=-1;let c=document.createElement("div");c.className="modal-header";let l=document.createElement("h3");l.textContent=e||"\u041F\u043E\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043D\u0438\u0435",c.appendChild(l);let d=document.createElement("div");if(d.className="modal-body",typeof o=="function"){let S=o();Array.isArray(S)?S.forEach(f=>{f&&d.appendChild(f)}):S&&d.appendChild(S)}else d.textContent=t||"";let h=document.createElement("div");h.className="modal-footer modal-footer--stacked";let g=document.createElement("button");g.type="button",g.className="ghost",g.textContent=r||"\u041E\u0442\u043C\u0435\u043D\u0430";let w=document.createElement("button");return w.type="button",w.className="primary danger-btn",w.textContent=n||"\u0423\u0434\u0430\u043B\u0438\u0442\u044C",h.appendChild(w),h.appendChild(g),a.appendChild(c),a.appendChild(d),a.appendChild(h),s.appendChild(a),i.appendChild(s),{overlay:i,card:a,confirmBtn:w,cancelBtn:g,form:s}}function fu(e="",t=""){let n=String(e||"").length,r=String(t||"").length;if(n*r>2e6||n+r>2e4)return null;let s=Array.from(e),a=Array.from(t),c=s.length,l=a.length,d=Array.from({length:c+1},()=>new Array(l+1).fill(0));for(let f=c-1;f>=0;f-=1)for(let p=l-1;p>=0;p-=1)s[f]===a[p]?d[f][p]=d[f+1][p+1]+1:d[f][p]=Math.max(d[f+1][p],d[f][p+1]);let h=[],g=0,w=0;for(;g<c&&w<l;)s[g]===a[w]?(h.push({type:"same",value:s[g]}),g+=1,w+=1):d[g+1][w]>=d[g][w+1]?(h.push({type:"removed",value:s[g]}),g+=1):(h.push({type:"added",value:a[w]}),w+=1);for(;g<c;)h.push({type:"removed",value:s[g]}),g+=1;for(;w<l;)h.push({type:"added",value:a[w]}),w+=1;let S=[];return h.forEach(f=>{if(!f.value)return;let p=S[S.length-1];p&&p.type===f.type?p.value+=f.value:S.push({type:f.type,value:f.value})}),S}function Er({baseText:e="",nextText:t="",mode:n="before"}={}){let r=document.createDocumentFragment(),o=fu(e,t);if(!o){let s=String(n==="before"?e||"":t||""),a=s.length>2e5?`${s.slice(0,2e5)}

\u2026(\u043E\u0431\u0440\u0435\u0437\u0430\u043D\u043E)`:s,c=document.createElement("div");c.className="meta",c.style.marginBottom="6px",c.textContent="Diff \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 \u2014 \u043F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0435\u043C \u0442\u0435\u043A\u0441\u0442 \u0431\u0435\u0437 \u043F\u043E\u0434\u0441\u0432\u0435\u0442\u043A\u0438.";let l=document.createElement("pre");return l.className="diff-plain",l.style.whiteSpace="pre-wrap",l.style.wordBreak="break-word",l.textContent=a,r.appendChild(c),r.appendChild(l),r}return o.forEach(i=>{if(n==="before"&&i.type==="added"||n==="after"&&i.type==="removed")return;let s=document.createElement("span");s.className="diff-seg",i.type==="added"&&s.classList.add("diff-seg--added"),i.type==="removed"&&s.classList.add("diff-seg--removed"),s.textContent=i.value,r.appendChild(s)}),r}function Xa(e={}){let t=rn(),{overlay:n,card:r,confirmBtn:o,cancelBtn:i,form:s}=hn(e),a=!1,c=()=>{},l=()=>{n.classList.add("modal-overlay--hide"),setTimeout(()=>n.remove(),150),document.removeEventListener("keydown",h)},d=g=>{a||(a=!0,l(),c(g))},h=g=>{g.code==="Escape"&&(g.preventDefault(),d(!1)),g.code==="Enter"&&(g.preventDefault(),d(!0))};return new Promise(g=>{c=g,s.addEventListener("submit",w=>{w.preventDefault(),d(!0)}),o.addEventListener("click",()=>d(!0)),i.addEventListener("click",()=>d(!1)),n.addEventListener("click",w=>{w.target===n&&d(!1)}),document.addEventListener("keydown",h),t.appendChild(n),requestAnimationFrame(()=>{r.focus({preventScroll:!0})})})}function Vn(e={}){let t=rn(),n=null,r=Array.isArray(e.suggestions)?e.suggestions:[],o=null,{overlay:i,card:s,confirmBtn:a,cancelBtn:c,form:l}=hn({...e,renderBody:()=>{let y=document.createDocumentFragment();if(e.message){let E=document.createElement("p");E.className="modal-body__text",E.textContent=e.message,y.appendChild(E)}let k=document.createElement("input");return k.type=e.inputType==="password"?"password":"text",k.className="modal-input",k.placeholder=e.placeholder||"",k.value=e.defaultValue||"",k.autocomplete="off",y.appendChild(k),r.length&&(o=document.createElement("div"),o.className="modal-suggestions",y.appendChild(o)),n=k,y}}),d=!1,h=()=>{},g=()=>{i.classList.add("modal-overlay--hide"),setTimeout(()=>i.remove(),150),document.removeEventListener("keydown",S)},w=y=>{if(!d)if(d=!0,g(),e.returnMeta){let k={value:y??null,selectedId:n?.dataset?.selectedId||null};h(k)}else h(y)},S=y=>{if(y.code==="Escape"){y.preventDefault(),w(null);return}if(y.code==="Enter"&&n&&!e.hideConfirm){let k=n.value.trim();if(!k&&!e.allowEmpty)return;y.preventDefault(),w(k)}},f=()=>{if(!a||!n)return;let y=!!n.value.trim();a.disabled=!y&&!e.allowEmpty},p=()=>{if(!o||!n)return;let y=n.value.trim().toLowerCase();n.dataset.selectedId="";let k=r.filter(E=>(E.title||"").toLowerCase().includes(y)||(E.id||"").toLowerCase().includes(y)).slice(0,8);if(o.innerHTML="",!y||!k.length){o.classList.add("hidden");return}o.classList.remove("hidden"),k.forEach(E=>{let L=document.createElement("button");L.type="button",L.className="modal-suggestion",L.textContent=E.title||E.id||"",L.addEventListener("click",()=>{n.value=E.title||E.id||"",n.dataset.selectedId=E.id||"",f(),p(),w(n.value)}),o.appendChild(L)})};return new Promise(y=>{h=y,a.classList.remove("danger-btn"),e.hideConfirm?a.style.display="none":a.textContent=e.confirmText||"OK",c.textContent=e.cancelText||"Cancel";let k=()=>{if(!n){w(null);return}let E=n.value.trim();if(!E){n.focus();return}w(E)};l.addEventListener("submit",E=>{E.preventDefault(),k()}),a.addEventListener("click",k),c.addEventListener("click",()=>w(null)),i.addEventListener("click",E=>{E.target===i&&w(null)}),document.addEventListener("keydown",S),n?(n.dataset.selectedId="",n.addEventListener("input",()=>{n.dataset.selectedId="",f(),r.length&&p()}),e.hideConfirm&&n.addEventListener("keydown",E=>{E.code==="Enter"&&(E.preventDefault(),w(n.value.trim()))}),f(),r.length&&p()):f(),t.appendChild(i),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):s.focus({preventScroll:!0})})})}function pu(e={}){let t=rn(),n=null,r=null,o=Array.isArray(e.suggestions)?e.suggestions:[],i=null,{overlay:s,card:a,confirmBtn:c,cancelBtn:l,form:d}=hn({title:e.title||"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",renderBody:()=>{let k=document.createDocumentFragment();if(e.message){let q=document.createElement("p");q.className="modal-body__text",q.textContent=e.message,k.appendChild(q)}let E=document.createElement("label");E.className="modal-label",E.textContent=e.articleLabel||"\u0421\u0442\u0430\u0442\u044C\u044F";let L=document.createElement("input");L.type="text",L.className="modal-input",L.placeholder=e.articlePlaceholder||"ID \u0438\u043B\u0438 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435\u2026",L.value=e.defaultArticleValue||"",L.autocomplete="off",E.appendChild(L),k.appendChild(E),n=L,o.length&&(i=document.createElement("div"),i.className="modal-suggestions",k.appendChild(i));let O=document.createElement("label");O.className="modal-label",O.textContent=e.textLabel||"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)";let z=document.createElement("input");return z.type="text",z.className="modal-input",z.placeholder=e.textPlaceholder||"",z.value=e.defaultTextValue||"",z.autocomplete="off",O.appendChild(z),k.appendChild(O),r=z,k}}),h=!1,g=()=>{},w=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",y)},S=k=>{h||(h=!0,w(),g(k))},f=()=>{if(!c||!n)return;let k=!!n.value.trim()||!!n.dataset.selectedId;c.disabled=!k},p=()=>{if(!i||!n)return;let k=n.value.trim().toLowerCase();n.dataset.selectedId="";let E=o.filter(L=>(L.title||"").toLowerCase().includes(k)||(L.id||"").toLowerCase().includes(k)).slice(0,8);if(i.innerHTML="",!k||!E.length){i.classList.add("hidden");return}i.classList.remove("hidden"),E.forEach(L=>{let O=document.createElement("button");O.type="button",O.className="modal-suggestion",O.textContent=L.title||L.id||"",O.addEventListener("click",()=>{n.value=L.title||L.id||"",n.dataset.selectedId=L.id||"",f(),p(),r&&!r.value.trim()&&!e.lockTextValue&&(r.value=L.title||""),r?.focus?.({preventScroll:!0}),r?.select?.()}),i.appendChild(O)})},y=k=>{if(k.code==="Escape"){k.preventDefault(),S(null);return}k.code};return new Promise(k=>{g=k,c.classList.remove("danger-btn"),c.textContent=e.confirmText||"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",l.textContent=e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430";let E=()=>{if(!n||!r){S(null);return}let L=n.value.trim(),O=n.dataset.selectedId||"";if(!L&&!O){n.focus();return}S({articleValue:L,selectedId:O||null,textValue:r.value??""})};d.addEventListener("submit",L=>{L.preventDefault(),E()}),c.addEventListener("click",E),l.addEventListener("click",()=>S(null)),s.addEventListener("click",L=>{L.target===s&&S(null)}),document.addEventListener("keydown",y),n?(n.dataset.selectedId="",n.addEventListener("input",()=>{n.dataset.selectedId="",f(),o.length&&p()}),f(),o.length&&p()):f(),t.appendChild(s),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):a.focus({preventScroll:!0})})})}function mu(e={}){let t=rn(),n=null,r=e.url||"",{overlay:o,card:i,confirmBtn:s,cancelBtn:a}=hn({title:e.title||"\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u0430\u044F \u0441\u0441\u044B\u043B\u043A\u0430",renderBody:()=>{let f=document.createDocumentFragment(),p=document.createElement("label");p.className="modal-label",p.textContent=e.label||"\u041F\u0440\u043E\u0441\u043C\u043E\u0442\u0440 \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435";let y=document.createElement("input");return y.type="text",y.className="modal-input",y.value=r,y.readOnly=!0,y.autocomplete="off",p.appendChild(y),n=y,f.appendChild(p),f}}),c=!1,l=()=>{},d=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",g)},h=()=>{c||(c=!0,d(),l())},g=f=>{f.code==="Escape"&&(f.preventDefault(),h())},w=f=>{if(!f)return!1;let p=document.createElement("textarea");p.value=f,p.setAttribute("readonly",""),p.style.position="absolute",p.style.left="-9999px",document.body.appendChild(p),p.focus(),p.select();let y=!1;try{y=document.execCommand("copy")}catch{y=!1}return document.body.removeChild(p),y},S=()=>{let f=n&&n.value||r;if(f){Ee("\u0421\u0441\u044B\u043B\u043A\u0430 \u0441\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u0430");try{if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function"){let p=navigator.clipboard.writeText(f);p&&typeof p.catch=="function"&&p.catch(()=>{w(f)})}else w(f)}catch{w(f)}}};return new Promise(f=>{l=f,s.classList.remove("danger-btn"),s.textContent="\u29C9 \u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443",s.setAttribute("aria-label",e.copyLabel||"\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443"),a.classList.add("hidden"),s.addEventListener("click",()=>{S(),h()}),o.addEventListener("click",p=>{p.target===o&&h()}),document.addEventListener("keydown",g),t.appendChild(o),requestAnimationFrame(()=>{n?n.focus({preventScroll:!0}):i.focus({preventScroll:!0})})})}function hu(e={}){let t=rn(),n=Array.isArray(e.versions)?e.versions:[],r=n[0]?.id||"",o=y=>{try{let k=new Date(y);return Number.isNaN(k.getTime())?String(y||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(k)}catch{return String(y||"")}},{overlay:i,card:s,confirmBtn:a,cancelBtn:c,form:l}=hn({title:e.title||"\u0412\u0435\u0440\u0441\u0438\u0438",confirmText:e.confirmText||"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",cancelText:e.cancelText||"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",renderBody:()=>{let y=document.createDocumentFragment(),k=document.createElement("p");if(k.className="modal-body__text",k.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0435\u0440\u0441\u0438\u044E \u0441\u0442\u0430\u0442\u044C\u0438 \u0434\u043B\u044F \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F.",y.appendChild(k),!n.length){let L=document.createElement("div");return L.className="modal-empty",L.textContent="\u0412\u0435\u0440\u0441\u0438\u0439 \u043F\u043E\u043A\u0430 \u043D\u0435\u0442.",y.appendChild(L),y}let E=document.createElement("div");return E.className="modal-list",n.forEach((L,O)=>{let z=document.createElement("label");z.className="modal-list__item";let q=document.createElement("input");q.type="radio",q.name="version",q.value=L.id||"",q.checked=O===0,q.addEventListener("change",()=>{r=q.value,a.disabled=!r,d.disabled=!r});let $=document.createElement("div");$.className="modal-list__meta";let Q=document.createElement("div");Q.className="modal-list__title",Q.textContent=L.label||o(L.created_at||L.createdAt);let W=document.createElement("div");W.className="modal-list__subtitle";let re=L.reason||"",we=o(L.created_at||L.createdAt);W.textContent=[we,re].filter(Boolean).join(" \xB7 "),$.appendChild(Q),$.appendChild(W),z.appendChild(q),z.appendChild($),E.appendChild(z)}),y.appendChild(E),y}});s.classList.add("modal-card--diff-light"),a.classList.remove("danger-btn"),a.disabled=!r;let d=document.createElement("button");d.type="button",d.className="ghost",d.textContent=e.compareText||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C",d.disabled=!r;let h=s.querySelector(".modal-footer");h&&h.insertBefore(d,a);let g=!1,w=()=>{},S=()=>{i.classList.add("modal-overlay--hide"),setTimeout(()=>i.remove(),150),document.removeEventListener("keydown",p)},f=y=>{g||(g=!0,S(),w(y))},p=y=>{y.code==="Escape"&&(y.preventDefault(),f(null))};return new Promise(y=>{w=y;let k=()=>{r&&f({action:"restore",versionId:r})};l.addEventListener("submit",E=>{E.preventDefault(),k()}),a.addEventListener("click",k),d.addEventListener("click",()=>{r&&f({action:"compare",versionId:r})}),c.addEventListener("click",()=>f(null)),i.addEventListener("click",E=>{E.target===i&&f(null)}),document.addEventListener("keydown",p),t.appendChild(i),requestAnimationFrame(()=>{s.focus({preventScroll:!0})})})}function gu(e={}){let t=rn(),n=Array.isArray(e.versions)?e.versions:[],r=String(e.excludeId||""),o=[{kind:"current",id:"__current__",title:"\u0422\u0435\u043A\u0443\u0449\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F"},...n.filter(p=>String(p.id||"")&&String(p.id||"")!==r).map(p=>({kind:"version",id:String(p.id),title:p.label||p.created_at||p.createdAt||p.id}))],i=o[0]?.id||"",{overlay:s,card:a,confirmBtn:c,cancelBtn:l,form:d}=hn({title:e.title||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C \u0441\u2026",confirmText:e.confirmText||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C",cancelText:e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430",renderBody:()=>{let p=document.createDocumentFragment(),y=document.createElement("p");y.className="modal-body__text",y.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0442\u043E\u0440\u0443\u044E \u0441\u0442\u043E\u0440\u043E\u043D\u0443 \u0441\u0440\u0430\u0432\u043D\u0435\u043D\u0438\u044F.",p.appendChild(y);let k=document.createElement("div");return k.className="modal-list",o.forEach((E,L)=>{let O=document.createElement("label");O.className="modal-list__item";let z=document.createElement("input");z.type="radio",z.name="compareTarget",z.value=E.id,z.checked=L===0,z.addEventListener("change",()=>{i=z.value,c.disabled=!i});let q=document.createElement("div");q.className="modal-list__meta";let $=document.createElement("div");$.className="modal-list__title",$.textContent=E.title,q.appendChild($),O.appendChild(z),O.appendChild(q),k.appendChild(O)}),p.appendChild(k),p}});a.classList.add("modal-card--diff-light"),c.classList.remove("danger-btn"),c.disabled=!i;let h=!1,g=()=>{},w=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",f)},S=p=>{h||(h=!0,w(),g(p))},f=p=>{p.code==="Escape"&&(p.preventDefault(),S(null))};return new Promise(p=>{g=p;let y=()=>{if(!i)return;let k=o.find(E=>E.id===i)||null;if(!k){S(null);return}if(k.kind==="current"){S({target:"current"});return}S({target:"version",versionId:k.id})};d.addEventListener("submit",k=>{k.preventDefault(),y()}),c.addEventListener("click",y),l.addEventListener("click",()=>S(null)),s.addEventListener("click",k=>{k.target===s&&S(null)}),document.addEventListener("keydown",f),t.appendChild(s),requestAnimationFrame(()=>{a.focus({preventScroll:!0})})})}function yu(e={}){let t=rn(),n=Array.isArray(e.changes)?e.changes:[],r=n.find(w=>w.type==="changed")||n[0]||null,{overlay:o,card:i,confirmBtn:s,cancelBtn:a}=hn({title:e.title||"\u041E\u0442\u043B\u0438\u0447\u0438\u044F \u0432\u0435\u0440\u0441\u0438\u0439",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:"",renderBody:()=>{let w=document.createDocumentFragment(),S=document.createElement("div");S.className="diff-summary";let f=n.reduce((Q,W)=>(Q[W.type]=(Q[W.type]||0)+1,Q),{added:0,removed:0,changed:0});if(S.textContent=`\u0418\u0437\u043C\u0435\u043D\u0435\u043D\u043E: ${f.changed||0} \xB7 \u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E: ${f.added||0} \xB7 \u0423\u0434\u0430\u043B\u0435\u043D\u043E: ${f.removed||0}`,w.appendChild(S),!n.length){let Q=document.createElement("div");return Q.className="modal-empty",Q.textContent="\u041D\u0435\u0442 \u043E\u0442\u043B\u0438\u0447\u0438\u0439.",w.appendChild(Q),w}let p=document.createElement("div");p.className="modal-list",n.forEach(Q=>{let W=document.createElement("button");W.type="button",W.className=`diff-item diff-item--${Q.type}${r&&r.id===Q.id?" diff-item--active":""}`;let re=Q.label||Q.id;W.textContent=`${Q.type==="changed"?"\u2260":Q.type==="added"?"+":"\u2212"} ${re}`,W.addEventListener("click",()=>{r=Q,p.querySelectorAll(".diff-item").forEach(we=>we.classList.remove("diff-item--active")),W.classList.add("diff-item--active"),$()}),p.appendChild(W)}),w.appendChild(p);let y=document.createElement("div");y.className="diff-panes";let k=document.createElement("div");k.className="diff-pane-wrap";let E=document.createElement("div");E.className="diff-pane-wrap";let L=document.createElement("div");L.className="diff-pane-title",L.textContent=e.beforeTitle||"\u0412\u0435\u0440\u0441\u0438\u044F";let O=document.createElement("div");O.className="diff-pane-title",O.textContent=e.afterTitle||"\u0422\u0435\u043A\u0443\u0449\u0430\u044F";let z=document.createElement("div");z.className="diff-pane diff-pane--before";let q=document.createElement("div");q.className="diff-pane diff-pane--after",k.appendChild(L),k.appendChild(z),E.appendChild(O),E.appendChild(q),y.appendChild(k),y.appendChild(E),w.appendChild(y);let $=()=>{let Q=r?.before||"",W=r?.after||"";z.innerHTML="",q.innerHTML="",z.appendChild(Er({baseText:Q,nextText:W,mode:"before"})),q.appendChild(Er({baseText:Q,nextText:W,mode:"after"}))};return $(),w}});i.classList.add("modal-card--fullscreen"),i.classList.add("modal-card--diff-light"),s.classList.remove("danger-btn"),a&&(a.style.display="none");let c=!1,l=()=>{},d=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",g)},h=()=>{c||(c=!0,d(),l())},g=w=>{w.code==="Escape"&&(w.preventDefault(),h())};return new Promise(w=>{l=w,s.addEventListener("click",h),o.addEventListener("click",S=>{S.target===o&&h()}),document.addEventListener("keydown",g),t.appendChild(o),requestAnimationFrame(()=>{i.focus({preventScroll:!0})})})}function bu(e={}){let t=rn(),n=Array.isArray(e.entries)?e.entries:[],r=n[0]||null,o=r,i=[],s=null,a=y=>{try{let k=new Date(y);return Number.isNaN(k.getTime())?String(y||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(k)}catch{return String(y||"")}},{overlay:c,card:l,confirmBtn:d,cancelBtn:h}=hn({title:e.title||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0431\u043B\u043E\u043A\u0430",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:e.canRestore?"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C (\u043F\u043E\u0441\u043B\u0435 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F)":"",renderBody:()=>{let y=document.createDocumentFragment(),k=document.createElement("p");if(k.className="modal-body__text",k.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0435. \u041C\u043E\u0436\u043D\u043E \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430 \u0434\u043E \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F.",y.appendChild(k),!n.length){let Z=document.createElement("div");return Z.className="modal-empty",Z.textContent="\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430.",y.appendChild(Z),y}let E=document.createElement("div");E.className="diff-layout";let L=document.createElement("div");L.className="modal-list diff-sidebar",i=[],n.forEach(Z=>{let pe=document.createElement("button");pe.type="button";let We=!!(r&&r.id===Z.id);pe.className=`diff-item${We?" diff-item--active":""}`,pe.setAttribute("aria-selected",We?"true":"false");let yt=a(Z.timestamp);pe.textContent=yt?`\u2260 ${yt}`:`\u2260 ${Z.id||""}`.trim(),pe.addEventListener("click",()=>{r=Z,L.querySelectorAll(".diff-item").forEach(kt=>{kt.classList.remove("diff-item--active"),kt.setAttribute("aria-selected","false")}),pe.classList.add("diff-item--active"),pe.setAttribute("aria-selected","true"),Ne()}),L.appendChild(pe),i.push(pe)});let O=document.createElement("div");O.className="diff-main";let z=document.createElement("div");z.className="diff-panes diff-panes--side";let q=document.createElement("div");q.className="diff-pane-wrap";let $=document.createElement("div");$.className="diff-pane-wrap";let Q=document.createElement("div");Q.className="diff-pane-title",Q.textContent=e.beforeTitle||"\u0414\u043E";let W=document.createElement("div");W.className="diff-pane-title",W.textContent=e.afterTitle||"\u041F\u043E\u0441\u043B\u0435";let re=document.createElement("div");re.className="diff-pane diff-pane--before";let we=document.createElement("div");we.className="diff-pane diff-pane--after",q.appendChild(Q),q.appendChild(re),$.appendChild(W),$.appendChild(we),z.appendChild(q),z.appendChild($),O.appendChild(z),E.appendChild(L),E.appendChild(O),y.appendChild(E);let Ne=()=>{o=r;let Z=r?.beforePlain||r?.before||"",pe=r?.afterPlain||r?.after||"";re.innerHTML="",we.innerHTML="",re.appendChild(Er({baseText:Z,nextText:pe,mode:"before"})),we.appendChild(Er({baseText:Z,nextText:pe,mode:"after"}))};return s=Ne,Ne(),y}});l.classList.add("modal-card--fullscreen"),l.classList.add("modal-card--diff-light"),d.classList.remove("danger-btn"),!e.canRestore&&h&&(h.style.display="none"),h&&h.classList.add("danger-btn");let g=!1,w=()=>{},S=()=>{c.classList.add("modal-overlay--hide"),setTimeout(()=>c.remove(),150),document.removeEventListener("keydown",p)},f=y=>{g||(g=!0,S(),w(y))},p=y=>{if(y.code==="Escape"&&(y.preventDefault(),f(null)),y.code==="ArrowUp"||y.code==="ArrowDown"){if(!n.length)return;y.preventDefault();let k=String(r?.id||""),E=n.findIndex(z=>String(z?.id||"")===k);E<0&&(E=0),E=y.code==="ArrowUp"?Math.max(0,E-1):Math.min(n.length-1,E+1);let L=n[E]||null;if(!L)return;r=L;let O=i[E];if(i.forEach(z=>{z.classList.remove("diff-item--active"),z.setAttribute("aria-selected","false")}),O){O.classList.add("diff-item--active"),O.setAttribute("aria-selected","true"),O.focus({preventScroll:!0});try{O.scrollIntoView({block:"nearest"})}catch{}}typeof s=="function"&&s()}};return new Promise(y=>{w=y,d.addEventListener("click",()=>f(null)),h&&e.canRestore&&h.addEventListener("click",()=>f({action:"restore",entry:o||r||null})),c.addEventListener("click",k=>{k.target===c&&f(null)}),document.addEventListener("keydown",p),t.appendChild(c),requestAnimationFrame(()=>{l.focus({preventScroll:!0})})})}function Ya(e){let t=[],n=r=>{if(!r)return;if(typeof r=="string"){t.push(r);return}if(Array.isArray(r)){r.forEach(n);return}if(typeof r!="object")return;typeof r.text=="string"&&t.push(r.text);let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(e),t.join("").replace(/\u00a0/g," ").trim()}function wu(e){return!e||typeof e!="object"?!1:!!(e.beforeHeadingJson||e.beforeBodyJson||e.afterHeadingJson||e.afterBodyJson)}function Su(e={}){let t=rn(),r=(Array.isArray(e.entries)?e.entries:[]).filter(wu),o=typeof e.onRestore=="function"?e.onRestore:null,i=$=>String($??"").replace(/\u00a0/g," ").trim(),s=r.map($=>({...$,beforePlain:i($.beforePlain??$.before??""),afterPlain:i($.afterPlain??$.after??"")})),a=new Map;for(let $ of s){let Q=String($?.blockId||"").trim();if(!Q)continue;let W=a.get(Q)||{blockId:Q,entries:[],latestAt:0,label:""};W.entries.push($);let re=Date.parse($.timestamp||"")||0;if(re>W.latestAt&&(W.latestAt=re),!W.label){let we=Ya($.afterHeadingJson)||Ya($.beforeHeadingJson)||"",Ne=($.afterPlain||$.beforePlain||"").split(`
`).map(Z=>Z.trim()).find(Boolean)||"";W.label=we||Ne||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"}a.set(Q,W)}let c=Array.from(a.values()).sort(($,Q)=>(Q.latestAt||0)-($.latestAt||0)),l=c[0]?.blockId||null,d=null,h=!1,g=$=>{try{let Q=new Date($);return Number.isNaN(Q.getTime())?String($||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(Q)}catch{return String($||"")}},{overlay:w,card:S,confirmBtn:f,cancelBtn:p}=hn({title:e.title||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0441\u0442\u0430\u0442\u044C\u0438",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:e.canRestore?"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C":"",renderBody:()=>{let $=document.createDocumentFragment(),Q=document.createElement("p");if(Q.className="modal-body__text",Q.textContent=e.message||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439 outline-\u0440\u0435\u0436\u0438\u043C\u0430. \u041C\u043E\u0436\u043D\u043E \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0435 \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0441\u0435\u043A\u0446\u0438\u0438 (\u0435\u0441\u043B\u0438 \u0441\u0435\u043A\u0446\u0438\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u2014 \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u043D\u0435\u0446 \u0441\u0442\u0430\u0442\u044C\u0438).",$.appendChild(Q),!c.length){let vt=document.createElement("div");return vt.className="modal-empty",vt.textContent="\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430.",$.appendChild(vt),$}let W=document.createElement("div");W.className="diff-layout diff-layout--article-history";let re=document.createElement("div");re.className="modal-list diff-sidebar",re.classList.add("diff-sections");let we=document.createElement("input");we.type="text",we.className="modal-input",we.placeholder="\u041F\u043E\u0438\u0441\u043A \u043F\u043E \u0438\u0441\u0442\u043E\u0440\u0438\u0438\u2026",re.appendChild(we);let Ne=document.createElement("div");Ne.style.marginTop="8px",re.appendChild(Ne);let Z=document.createElement("div");Z.className="diff-main";let pe=document.createElement("div");pe.className="diff-layout diff-layout--article-history-inner";let We=document.createElement("div");We.className="modal-list diff-sidebar",We.classList.add("diff-revisions");let yt=document.createElement("div");yt.className="diff-panes diff-panes--side";let kt=document.createElement("div");kt.className="diff-pane-wrap";let jt=document.createElement("div");jt.className="diff-pane-wrap";let en=document.createElement("div");en.className="diff-pane-title",en.textContent=e.beforeTitle||"\u0414\u043E";let cn=document.createElement("div");cn.className="diff-pane-title",cn.textContent=e.afterTitle||"\u041F\u043E\u0441\u043B\u0435";let yn=document.createElement("div");yn.className="diff-pane diff-pane--before";let Bn=document.createElement("div");Bn.className="diff-pane diff-pane--after",kt.appendChild(en),kt.appendChild(yn),jt.appendChild(cn),jt.appendChild(Bn),yt.appendChild(kt),yt.appendChild(jt),pe.appendChild(We),pe.appendChild(yt),Z.appendChild(pe),W.appendChild(re),W.appendChild(Z),$.appendChild(W);let Nn=()=>{let vt=we.value.trim().toLowerCase(),Lt=vt?c.filter(dt=>(dt.label||"").toLowerCase().includes(vt)?!0:(dt.entries||[]).some(rt=>`${rt.beforePlain||""}
${rt.afterPlain||""}`.toLowerCase().includes(vt))):c;Ne.innerHTML="",Lt.forEach(dt=>{let rt=document.createElement("button");rt.type="button";let ht=dt.blockId===l;rt.className=`diff-item${ht?" diff-item--active":""}`,rt.setAttribute("aria-selected",ht?"true":"false");let Kt=dt.latestAt?g(new Date(dt.latestAt).toISOString()):"",G=Array.isArray(dt.entries)?dt.entries.length:0;rt.textContent=`${dt.label||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"}${Kt?` \xB7 ${Kt}`:""}${G?` \xB7 ${G}`:""}`,rt.addEventListener("click",()=>{l=dt.blockId,d=null,h=!1,Nn(),bn(),wn()}),Ne.appendChild(rt)}),l&&!Lt.some(dt=>dt.blockId===l)&&(l=Lt[0]?.blockId||null,d=null,h=!1,bn(),wn())},bn=()=>{let vt=l?a.get(l):null,Lt=Array.isArray(vt?.entries)?vt.entries.slice():[];Lt.sort((rt,ht)=>(Date.parse(ht.timestamp||"")||0)-(Date.parse(rt.timestamp||"")||0));let dt=d&&Lt.some(rt=>String(rt?.id||"")===String(d||""));(!h||!dt)&&(d=Lt[0]?.id||null),We.innerHTML="",Lt.forEach(rt=>{let ht=document.createElement("button");ht.type="button";let Kt=String(rt.id||"")===String(d||"");ht.className=`diff-item${Kt?" diff-item--active":""}`,ht.setAttribute("aria-selected",Kt?"true":"false");let G=g(rt.timestamp),ce=(rt.afterPlain||rt.beforePlain||"").slice(0,64).trim();ht.textContent=`${G?`\u2260 ${G}`:`\u2260 ${rt.id||""}`}${ce?` \xB7 ${ce}`:""}`,ht.addEventListener("click",()=>{d=rt.id||null,h=!0,bn(),wn()}),We.appendChild(ht)})},wn=()=>{let vt=l?a.get(l):null,Lt=Array.isArray(vt?.entries)?vt.entries:[],dt=Lt.find(Kt=>String(Kt?.id||"")===String(d||""))||Lt[0]||null,rt=dt?.beforePlain||"",ht=dt?.afterPlain||"";yn.innerHTML="",Bn.innerHTML="",yn.appendChild(Er({baseText:rt,nextText:ht,mode:"before"})),Bn.appendChild(Er({baseText:rt,nextText:ht,mode:"after"}))};return we.addEventListener("input",()=>{Nn()}),Nn(),bn(),wn(),$}});S.classList.add("modal-card--fullscreen"),S.classList.add("modal-card--diff-light"),f.classList.remove("danger-btn"),!e.canRestore&&p&&(p.style.display="none"),p&&p.classList.add("danger-btn");let y=!1,k=()=>{},E=!1,L=()=>{w.classList.add("modal-overlay--hide"),setTimeout(()=>w.remove(),150),document.removeEventListener("keydown",z)},O=$=>{y||(y=!0,L(),k($))},z=$=>{$.code==="Escape"&&($.preventDefault(),O(null))},q=()=>{let $=l?a.get(l):null,Q=Array.isArray($?.entries)?$.entries:[];return Q.find(W=>String(W?.id||"")===String(d||""))||Q[0]||null};return new Promise($=>{k=$,f.addEventListener("click",()=>O(null)),p&&e.canRestore&&p.addEventListener("click",async()=>{let Q=q();if(!Q){Ee("\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430");return}if(!o){O({action:"restore",entry:Q});return}if(E)return;E=!0;let W=p.textContent;try{p.disabled=!0,f.disabled=!0,p.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C\u2026",await o(Q)}catch(re){Ee(re?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C")}finally{E=!1,p.textContent=W,p.disabled=!1,f.disabled=!1}}),w.addEventListener("click",Q=>{Q.target===w&&O(null)}),document.addEventListener("keydown",z),t.appendChild(w),requestAnimationFrame(()=>{S.focus({preventScroll:!0})})})}function Ji(e={}){let t=rn(),n=null,r=null,{overlay:o,card:i,confirmBtn:s,cancelBtn:a,form:c}=hn({...e,renderBody:()=>{let f=document.createDocumentFragment();if(e.message){let L=document.createElement("p");L.className="modal-body__text",L.textContent=e.message,f.appendChild(L)}let p=document.createElement("label");p.className="modal-label",p.textContent=e.textLabel||"\u0422\u0435\u043A\u0441\u0442";let y=document.createElement("input");y.type="text",y.className="modal-input",y.placeholder=e.textPlaceholder||"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438",y.value=e.defaultText||"",y.autocomplete="off",p.appendChild(y);let k=document.createElement("label");k.className="modal-label",k.textContent=e.urlLabel||"\u0421\u0441\u044B\u043B\u043A\u0430";let E=document.createElement("input");return E.type="text",E.className="modal-input",E.placeholder=e.urlPlaceholder||"https://example.com",E.value=e.defaultUrl||"",E.autocomplete="off",k.appendChild(E),n=y,r=E,f.appendChild(p),f.appendChild(k),f}}),l=!1,d=()=>{},h=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",w)},g=f=>{l||(l=!0,h(),d(f))},w=f=>{if(f.code==="Escape"){f.preventDefault(),g(null);return}f.code==="Enter"&&!s.disabled&&(f.preventDefault(),g({text:(n?.value||"").trim(),url:(r?.value||"").trim()}))},S=()=>{let f=!!(r?.value||"").trim();s.disabled=!f};return new Promise(f=>{d=f,s.classList.remove("danger-btn"),s.textContent=e.confirmText||"OK",a.textContent=e.cancelText||"Cancel";let p=()=>{g({text:(n?.value||"").trim(),url:(r?.value||"").trim()})};c.addEventListener("submit",k=>{k.preventDefault(),s.disabled||p()}),s.addEventListener("click",p),a.addEventListener("click",()=>g(null)),o.addEventListener("click",k=>{k.target===o&&g(null)}),document.addEventListener("keydown",w);let y=k=>{k&&k.addEventListener("input",S)};y(n),y(r),S(),t.appendChild(o),requestAnimationFrame(()=>{r?(r.focus({preventScroll:!0}),r.value&&r.setSelectionRange(r.value.length,r.value.length)):i.focus({preventScroll:!0})})})}function Ga(e={}){let t=rn(),n=null,r=null,{overlay:o,card:i,confirmBtn:s,cancelBtn:a,form:c}=hn({...e,renderBody:()=>{let f=document.createDocumentFragment();if(e.message){let L=document.createElement("p");L.className="modal-body__text",L.textContent=e.message,f.appendChild(L)}let p=document.createElement("label");p.className="modal-label",p.textContent="\u041F\u0430\u0440\u043E\u043B\u044C";let y=document.createElement("input");y.type="password",y.className="modal-input",y.placeholder="\u041F\u0430\u0440\u043E\u043B\u044C \u0434\u043B\u044F \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B",y.autocomplete="off",p.appendChild(y);let k=document.createElement("label");k.className="modal-label",k.textContent="\u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0430 (\u043D\u0435\u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u044C\u043D\u043E)";let E=document.createElement("input");return E.type="text",E.className="modal-input",E.placeholder="\u041D\u0430\u043F\u043E\u043C\u0438\u043D\u0430\u043D\u0438\u0435 \u043E \u043F\u0430\u0440\u043E\u043B\u0435",E.autocomplete="off",k.appendChild(E),n=y,r=E,f.appendChild(p),f.appendChild(k),f}}),l=!1,d=()=>{},h=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",w)},g=f=>{l||(l=!0,h(),d(f))},w=f=>{if(f.code==="Escape"){f.preventDefault(),g(null);return}f.code==="Enter"&&!s.disabled&&(f.preventDefault(),g({password:(n?.value||"").trim(),hint:(r?.value||"").trim()}))},S=()=>{let f=!!(n?.value||"").trim();s.disabled=!f};return new Promise(f=>{d=f,s.classList.remove("danger-btn"),s.textContent=e.confirmText||"\u0417\u0430\u0449\u0438\u0442\u0438\u0442\u044C",a.textContent=e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430";let p=()=>{s.disabled||g({password:(n?.value||"").trim(),hint:(r?.value||"").trim()})};s.addEventListener("click",p),c.addEventListener("submit",y=>{y.preventDefault(),p()}),a.addEventListener("click",()=>g(null)),o.addEventListener("click",y=>{y.target===o&&g(null)}),document.addEventListener("keydown",w),n&&n.addEventListener("input",S),S(),t.appendChild(o),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):i.focus({preventScroll:!0})})})}function xu(e={}){let t=rn(),n=Array.isArray(e.items)?e.items:[],{overlay:r,card:o,confirmBtn:i,cancelBtn:s}=hn({title:e.title||"\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432",renderBody:()=>{let g=document.createElement("div");if(!n.length){let S=document.createElement("p");return S.className="modal-body__text",S.textContent="\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432 \u043F\u0443\u0441\u0442\u0430",g.appendChild(S),g}let w=document.createElement("div");return w.className="block-trash-list",n.forEach(S=>{let f=document.createElement("div");f.className="block-trash-item";let p=S.block&&S.block.text||"",y=Ka(p),k=document.createElement("div");k.className="block-trash-item__title",k.textContent=y[0]||"(\u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A)";let E=document.createElement("div");E.className="block-trash-item__meta";let L=S.deletedAt?new Date(S.deletedAt).toLocaleString():"";E.textContent=L||"";let O=document.createElement("div");O.className="block-trash-item__info",O.appendChild(k),L&&O.appendChild(E);let z=document.createElement("button");z.type="button",z.className="primary",z.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",z.addEventListener("click",()=>{d(S)}),f.appendChild(O),f.appendChild(z),w.appendChild(f)}),g.appendChild(w),g}}),a=!1,c=()=>{},l=()=>{r.classList.add("modal-overlay--hide"),setTimeout(()=>r.remove(),150),document.removeEventListener("keydown",h)},d=g=>{a||(a=!0,l(),c(g||null))},h=g=>{g.code==="Escape"&&(g.preventDefault(),d(null))};return new Promise(g=>{c=g,i.classList.remove("hidden"),i.textContent="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u043A\u043E\u0440\u0437\u0438\u043D\u0443",i.classList.add("danger-btn"),s.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",i.addEventListener("click",()=>d({action:"clear"})),s.addEventListener("click",()=>d(null)),r.addEventListener("click",w=>{w.target===r&&d(null)}),document.addEventListener("keydown",h),t.appendChild(r),requestAnimationFrame(()=>{o.focus({preventScroll:!0})})})}function Au(e={}){let t=rn(),{title:n,message:r,existingTitle:o,importedTitle:i,existingCreatedAt:s,existingUpdatedAt:a,importedCreatedAt:c,importedUpdatedAt:l,allowApplyToAll:d=!0}=e||{},h=document.createElement("div");h.className="modal-overlay";let g=document.createElement("div");g.className="modal-card",g.setAttribute("role","dialog"),g.setAttribute("aria-modal","true"),g.tabIndex=-1;let w=document.createElement("div");w.className="modal-header";let S=document.createElement("h3");S.textContent=n||"\u041A\u043E\u043D\u0444\u043B\u0438\u043A\u0442 \u043F\u0440\u0438 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0438",w.appendChild(S);let f=document.createElement("div");if(f.className="modal-body",r){let re=document.createElement("p");re.className="modal-body__text",re.textContent=r,f.appendChild(re)}if(o||i){let re=document.createElement("p");re.className="modal-body__text",re.innerHTML=[o?`<strong>\u0412 \u0431\u0430\u0437\u0435:</strong> ${o}`:"",i?`<strong>\u0418\u0437 \u0444\u0430\u0439\u043B\u0430:</strong> ${i}`:""].filter(Boolean).join("<br />"),f.appendChild(re)}if(s||a||c||l){let re=Z=>{if(!Z)return"";let pe=new Date(Z);return Number.isNaN(pe.getTime())?Z:pe.toLocaleString()},we=document.createElement("p");we.className="modal-body__text";let Ne=[];if(s||a){let Z=s?re(s):"\u2014",pe=a?re(a):"\u2014";Ne.push(`<strong>\u0412 \u0431\u0430\u0437\u0435:</strong> \u0441\u043E\u0437\u0434\u0430\u043D\u0430 ${Z}, \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430 ${pe}`)}if(c||l){let Z=c?re(c):"\u2014",pe=l?re(l):"\u2014";Ne.push(`<strong>\u0418\u0437 \u0444\u0430\u0439\u043B\u0430:</strong> \u0441\u043E\u0437\u0434\u0430\u043D\u0430 ${Z}, \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430 ${pe}`)}we.innerHTML=Ne.join("<br />"),f.appendChild(we)}let p=null;if(d){let re=document.createElement("label");re.className="modal-label";let we=document.createElement("input");we.type="checkbox",we.style.marginRight="0.5rem",re.appendChild(we),re.appendChild(document.createTextNode("\u041F\u0440\u0438\u043C\u0435\u043D\u044F\u0442\u044C \u044D\u0442\u043E \u0440\u0435\u0448\u0435\u043D\u0438\u0435 \u043A\u043E \u0432\u0441\u0435\u043C \u043A\u043E\u043D\u0444\u043B\u0438\u043A\u0442\u0430\u043C")),p=we,f.appendChild(re)}let y=document.createElement("div");y.className="modal-footer modal-footer--stacked";let k=document.createElement("button");k.type="button",k.className="ghost",k.textContent="\u041E\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0443\u044E";let E=document.createElement("button");E.type="button",E.className="primary danger-btn",E.textContent="\u041F\u0435\u0440\u0435\u0437\u0430\u043F\u0438\u0441\u0430\u0442\u044C";let L=document.createElement("button");L.type="button",L.className="ghost",L.textContent="\u0421\u043E\u0437\u0434\u0430\u0442\u044C \u043A\u043E\u043F\u0438\u044E";let O=document.createElement("button");O.type="button",O.className="ghost",O.textContent="\u041E\u0442\u043C\u0435\u043D\u0430",y.appendChild(k),y.appendChild(E),y.appendChild(L),y.appendChild(O),g.appendChild(w),g.appendChild(f),g.appendChild(y),h.appendChild(g);let z=!1,q=()=>{},$=()=>{h.classList.add("modal-overlay--hide"),setTimeout(()=>h.remove(),150),document.removeEventListener("keydown",W)},Q=re=>{if(z)return;z=!0;let we=!!(p&&p.checked);$(),q({action:re,applyToAll:we})},W=re=>{re.code==="Escape"&&(re.preventDefault(),Q(null))};return new Promise(re=>{q=re,k.addEventListener("click",()=>Q("keep")),E.addEventListener("click",()=>Q("overwrite")),L.addEventListener("click",()=>Q("copy")),O.addEventListener("click",()=>Q(null)),h.addEventListener("click",we=>{we.target===h&&Q(null)}),document.addEventListener("keydown",W),t.appendChild(h),requestAnimationFrame(()=>{g.focus({preventScroll:!0})})})}function Gr(e,t=""){let n=rn(),r=document.createElement("div");r.className="modal-overlay image-modal";let o=document.createElement("div");o.className="image-modal__card",o.setAttribute("role","dialog"),o.setAttribute("aria-modal","true"),o.tabIndex=-1;let i=document.createElement("img");i.className="image-modal__img",i.src=e,t&&(i.alt=t),o.appendChild(i),r.appendChild(o);let s,a=()=>{s&&s()},c=l=>{l.code==="Escape"&&(l.preventDefault(),a())};s=()=>{document.removeEventListener("keydown",c),r.classList.add("modal-overlay--hide"),setTimeout(()=>r.remove(),150)},r.addEventListener("click",l=>{l.target===r&&a()}),document.addEventListener("keydown",c),n.appendChild(r),requestAnimationFrame(()=>{o.focus({preventScroll:!0})})}var Wa,Jn=je(()=>{In();Ft();Wa="modal-root"});function Qa(e){if(typeof btoa=="function"){let t="";for(let n=0;n<e.length;n+=1)t+=String.fromCharCode(e[n]);return btoa(t)}if(typeof Buffer<"u")return Buffer.from(e).toString("base64");throw new Error("No base64 encoder available")}function Za(e){if(!e)return new Uint8Array(0);if(typeof atob=="function"){let t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r+=1)n[r]=t.charCodeAt(r);return n}if(typeof Buffer<"u"){let t=Buffer.from(e,"base64"),n=new Uint8Array(t.length);for(let r=0;r<t.length;r+=1)n[r]=t[r];return n}throw new Error("No base64 decoder available")}function Wi(e){return typeof e=="string"&&e.startsWith(Ki)}async function ec(e,t){if(!e)throw new Error("Password is required");let n=t&&t.length?Za(t):tc(16),r=Ro(e||""),o=new Uint8Array(r.length+n.length);return o.set(r,0),o.set(n,r.length),{key:{raw:Ro(String.fromCharCode(...o))},salt:Qa(n)}}function Ro(e=""){let t=2166136261,n=16777619;for(let o=0;o<e.length;o+=1){let i=e.charCodeAt(o);t^=i,t=t*16777619>>>0,n^=i<<o%8,n=n*16777619>>>0}let r=new Uint8Array(32);for(let o=0;o<32;o+=1){let i=o<16?t:n;r[o]=i>>>o%4*8&255}return r}function tc(e){let t=new Uint8Array(e);for(let n=0;n<e;n+=1)t[n]=Math.floor(Math.random()*256);return t}async function ku(e,t=""){if(!e)throw new Error("Missing encryption key");let n=e&&e.raw?e.raw:Ro("fallback-key"),r=tc(12),i=new TextEncoder().encode(t||""),s=new Uint8Array(r.length+i.length);s.set(r,0);for(let a=0;a<i.length;a+=1){let c=n[a%n.length],l=r[a%r.length];s[r.length+a]=i[a]^c^l}return`${Ki}${Qa(s)}`}async function Yi(e,t){if(!e)throw new Error("Missing encryption key");if(!Wi(t))throw new Error("Data is not in encrypted format");let n=t.slice(Ki.length),r=Za(n);if(r.length<13)throw new Error("Encrypted payload is too short");let o=r.slice(0,12),i=r.slice(12),s=e&&e.raw?e.raw:Ro("fallback-key"),a=new Uint8Array(i.length);for(let l=0;l<i.length;l+=1){let d=s[l%s.length],h=o[l%o.length];a[l]=i[l]^d^h}return new TextDecoder().decode(a)}async function nc(e,t){if(!t)return!1;try{return await Yi(e,t)===Iu}catch{return!1}}async function rc(e,t){if(!e)return;if(typeof e.text=="string"&&Wi(e.text))try{e.text=await Yi(t,e.text)}catch{e.text=""}let n=Array.isArray(e.children)?e.children:[];for(let r of n)await rc(r,t)}async function Xi(e,t){if(!(!e||!Array.isArray(e.blocks)))for(let n of e.blocks)await rc(n,t)}async function Gi(e,t){return ku(e,t||"")}var Ki,Iu,Qr=je(()=>{Ki="enc-v1:",Iu="memus-article-encryption-ok"});function un(e){if(window.location.pathname===e){oc(e);return}window.history.pushState({},"",e),oc(e)}function oc(e){let t=e.match(/^\/p\/([^/?#]+)/);if(t){Zi(decodeURIComponent(t[1]));return}let n=e.match(/^\/article\/([0-9a-zA-Z-]+)/);if(n){let r=String(n[1]||"");if(r.startsWith("inbox-")){try{window.history.replaceState({},"",Yt.article("inbox"))}catch{}Ho("inbox");return}Ho(r);return}Qi()}var Yt,jn=je(()=>{ar();Yt={list:"/",article:e=>`/article/${e}`,public:e=>`/p/${e}`}});var ic=je(()=>{ir();An()});function sc(){J.searchResults&&J.searchResults.classList.add("hidden")}var ac=je(()=>{bt();ln();In();Wt();jn();Kn();Ft();ic()});function $o(){try{localStorage.setItem(Eu,JSON.stringify(u.sidebarCollapsedArticleIds||[]))}catch{}}function Fo(){try{localStorage.setItem(Cu,JSON.stringify(u.listCollapsedArticleIds||[]))}catch{}}var Eu,Cu,Cr=je(()=>{bt();Eu="ttree_collapsed_articles",Cu="ttree_list_collapsed_articles"});function es(){J.articlesTabBtn&&(J.articlesTabBtn.classList.toggle("active",!u.isTrashView),J.articlesTabBtn.setAttribute("aria-pressed",u.isTrashView?"false":"true")),J.trashTabBtn&&(J.trashTabBtn.classList.toggle("active",u.isTrashView),J.trashTabBtn.setAttribute("aria-pressed",u.isTrashView?"true":"false")),J.createArticleBtn&&(J.createArticleBtn.disabled=u.isTrashView),J.sidebarNewArticleBtn&&(J.sidebarNewArticleBtn.disabled=u.isTrashView)}function zo(){Ci&&(la(!1),J.hintPopover&&J.hintPopover.classList.add("hidden"),J.hintToggleBtn&&J.hintToggleBtn.setAttribute("aria-expanded","false"))}function Zr(e){u.isSidebarMobileOpen=e,J.sidebar&&J.sidebar.classList.toggle("mobile-open",e),J.sidebarBackdrop&&J.sidebarBackdrop.classList.toggle("hidden",!e),e&&(zo(),sc())}function eo(e){J.articleView.classList.toggle("hidden",!e),J.articleListView.classList.toggle("hidden",e),J.articleHeader&&J.articleHeader.classList.toggle("hidden",!e),e||zo(),e&&u.isTrashView&&(u.isTrashView=!1,es())}var Uo=je(()=>{bt();ln();ac();Cr()});function fc({renderSidebarArticleList:e,renderMainArticleList:t,setArticlesIndex:n}={}){dc=typeof e=="function"?e:null,ts=typeof t=="function"?t:null,uc=typeof n=="function"?n:null}function Vo(){kn&&(kn.classList.remove("drop-before","drop-after","drop-inside"),kn=null)}function pc(e,t){e&&(kn&&kn!==e&&kn.classList.remove("drop-before","drop-after","drop-inside"),kn=e,kn.classList.remove("drop-before","drop-after","drop-inside"),t==="before"?kn.classList.add("drop-before"):t==="after"?kn.classList.add("drop-after"):t==="inside"&&kn.classList.add("drop-inside"))}function Nu(){pt&&(pt.sourceEl instanceof Element&&pt.sourceEl.classList.remove("article-dnd-source"),typeof document<"u"&&document.body&&document.body.classList.remove("article-dnd-active"),window.removeEventListener("pointermove",os),window.removeEventListener("pointerup",to),window.removeEventListener("pointercancel",to),window.removeEventListener("touchmove",mc),window.removeEventListener("touchend",qo),window.removeEventListener("touchcancel",qo),pt=null,Vo(),window.__ttreeDraggingArticleId=null)}function cc(e){return e instanceof Element?!!(e.closest(".star-btn")||e.closest(".row-actions")):!1}function Mu(e,t){if(!t||pt||!e.touches||e.touches.length!==1)return;let n=e.touches[0],r=e.currentTarget instanceof Element?e.currentTarget:null;pt={pointerId:"legacy-touch",articleId:t,startX:n.clientX,startY:n.clientY,dragging:!1,lastTargetId:null,lastDropMode:null,sourceEl:r},window.__ttreeDraggingArticleId=t,typeof document<"u"&&document.body&&document.body.classList.add("article-dnd-active");try{let o=window.getSelection?window.getSelection():null;o&&!o.isCollapsed&&o.removeAllRanges()}catch{}window.addEventListener("touchmove",mc,{passive:!1}),window.addEventListener("touchend",qo),window.addEventListener("touchcancel",qo)}function mc(e){if(!pt||!e.touches||e.touches.length===0)return;let t=e.touches[0];os({pointerId:"legacy-touch",clientX:t.clientX,clientY:t.clientY,preventDefault:()=>{e.preventDefault()}})}function qo(){pt&&to({pointerId:"legacy-touch"})}function Lu(e,t){let n=document.elementFromPoint(e,t);if(!n)return null;let r=n.closest(".sidebar-article-item, #articleList li");return!r||!r.dataset||!r.dataset.articleId?null:r}function Pu(e,t){if(!t||pt)return;let n=e.currentTarget instanceof Element?e.currentTarget:null;pt={pointerId:e.pointerId,articleId:t,startX:e.clientX,startY:e.clientY,dragging:!1,lastTargetId:null,lastDropMode:null,sourceEl:n},window.__ttreeDraggingArticleId=t,typeof document<"u"&&document.body&&document.body.classList.add("article-dnd-active");try{let r=window.getSelection?window.getSelection():null;r&&!r.isCollapsed&&r.removeAllRanges()}catch{}try{e.currentTarget?.setPointerCapture?.(e.pointerId)}catch{}window.addEventListener("pointermove",os),window.addEventListener("pointerup",to),window.addEventListener("pointercancel",to)}function os(e){if(!pt||e.pointerId!==pt.pointerId)return;let t=e.clientX-pt.startX,n=e.clientY-pt.startY;if(!pt.dragging){if(Math.hypot(t,n)<Tu)return;pt.dragging=!0,pt.sourceEl instanceof Element&&pt.sourceEl.classList.add("article-dnd-source")}e.preventDefault();let r=Lu(e.clientX,e.clientY);if(!r||!r.dataset||!r.dataset.articleId||r.dataset.articleId===pt.articleId){Vo(),pt.lastTargetId=null,pt.lastDropMode=null;return}let o=r.getBoundingClientRect(),i=e.clientY-o.top,s=o.height/3,a;i<s?a="before":i>o.height-s?a="after":a="inside",pt.lastTargetId=r.dataset.articleId,pt.lastDropMode=a,pc(r,a)}function to(e){if(!pt||e.pointerId!==pt.pointerId)return;let t=pt;Nu(),!(!t.dragging||!t.lastTargetId||!t.lastDropMode)&&t.lastTargetId!==t.articleId&&hc(t.articleId,t.lastTargetId,t.lastDropMode)}function is(e,t){e&&(Bu?e.addEventListener("pointerdown",n=>{if(n.pointerType!=="touch"||typeof n.button=="number"&&n.button!==0||cc(n.target))return;let r=n.pointerId,o=350,i=!1,s=window.setTimeout(()=>{i=!0,Pu(n,t)},o),a=c=>{c.pointerId===r&&(i||window.clearTimeout(s),window.removeEventListener("pointerup",a,!0),window.removeEventListener("pointercancel",a,!0))};window.addEventListener("pointerup",a,!0),window.addEventListener("pointercancel",a,!0)}):e.addEventListener("touchstart",n=>{if(!n.touches||n.touches.length!==1)return;let r=n.target;if(cc(r))return;let o=350,i=!1,s=window.setTimeout(()=>{i=!0,Mu(n,t)},o),a=()=>{i||window.clearTimeout(s),window.removeEventListener("touchend",a,!0),window.removeEventListener("touchcancel",a,!0)};window.addEventListener("touchend",a,!0),window.addEventListener("touchcancel",a,!0)},{passive:!1}))}function rs(e){return e&&(u.articlesIndex||[]).find(t=>t.id===e)||null}function lc(e){let t=e||null;return(u.articlesIndex||[]).filter(n=>(n.parentId||null)===t).sort((n,r)=>n.position!==r.position?n.position-r.position:new Date(n.updatedAt||0)-new Date(r.updatedAt||0))}function _u(e,t,n,r){if(!e)return;let o=rs(e);if(!o)return;let i=t||null,s=o.parentId||null,c=lc(s).filter(w=>w.id!==e),l;i===s?l=c:l=lc(i);let d=l.filter(w=>w.id!==e),h=d.length;if(n&&r&&r!=="inside"){let w=d.findIndex(S=>S.id===n);w!==-1&&(h=r==="before"?w:w+1)}r==="inside"&&(h=d.length),h<0&&(h=0),h>d.length&&(h=d.length);let g=d.slice();g.splice(h,0,o),o.parentId=i,c.forEach((w,S)=>{w.position=S}),g.forEach((w,S)=>{w.parentId=i,w.position=S})}function hc(e,t,n){if(!e||!t||!n)return;let r=rs(e),o=rs(t);if(!r||!o)return;let i=n==="inside"?o.id:o.parentId||null,s=n==="inside"?null:o.id;_u(e,i,s,n),dc?.(),ts?.(),(async()=>{try{await Ja(e,{parentId:i,anchorId:s,placement:n})}catch(a){try{let c=await dn();uc?.(c),ts?.()}catch{}Ee(a.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443")}})()}function Du(e){window.__ttreeDraggingArticleId?on=window.__ttreeDraggingArticleId:on=e.currentTarget?.dataset?.articleId||null,e.dataTransfer&&(e.dataTransfer.effectAllowed="move",on&&e.dataTransfer.setData("text/plain",on))}function Ou(e){if(!on){let s=window.__ttreeDraggingArticleId,a=null;if(!s&&e?.dataTransfer)try{a=e.dataTransfer.getData("text/plain")||null}catch{a=null}on=s||a||null}if(!on||!e.currentTarget||!e.currentTarget.dataset.articleId)return;e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="move");let t=e.currentTarget,n=t.getBoundingClientRect(),r=e.clientY-n.top,o=n.height/3,i;r<o?i="before":r>n.height-o?i="after":i="inside",pc(t,i)}function Ru(e){if(!on){let a=window.__ttreeDraggingArticleId,c=null;if(!a&&e?.dataTransfer)try{c=e.dataTransfer.getData("text/plain")||null}catch{c=null}on=a||c||null}if(!on)return;let t=e.currentTarget,n=t?.dataset?.articleId||null;if(!n||n===on)return;e.preventDefault(),Vo();let r=t.getBoundingClientRect(),o=e.clientY-r.top,i=r.height/3,s;o<i?s="before":o>r.height-i?s="after":s="inside",hc(on,n,s),on=null}function Hu(){on=null,window.__ttreeDraggingArticleId=null,Vo()}function ss(e){e&&(e.draggable=!0,e.addEventListener("dragstart",Du),e.addEventListener("dragover",Ou),e.addEventListener("drop",Ru),e.addEventListener("dragend",Hu))}var dc,ts,uc,ns,on,kn,Tu,pt,Bu,as=je(()=>{bt();Wt();Ft();dc=null,ts=null,uc=null;ns=!1;typeof window<"u"&&(window.matchMedia&&window.matchMedia("(pointer: coarse)").matches||"ontouchstart"in window)&&(ns=!0);on=null,kn=null,Tu=6,pt=null,Bu=typeof window<"u"&&"PointerEvent"in window&&!ns});function $u(){try{let e=localStorage.getItem(yc),t=e?JSON.parse(e):[];u.favoriteArticles=Array.isArray(t)?t:[]}catch{u.favoriteArticles=[]}}function Fu(){try{localStorage.setItem(yc,JSON.stringify(u.favoriteArticles||[]))}catch{}}function bc(e=[]){let t=new Set(u.favoriteArticles||[]);return[...e].sort((n,r)=>{let o=t.has(n.id),i=t.has(r.id);return o!==i?o?-1:1:new Date(r.updatedAt||r.deletedAt||0)-new Date(n.updatedAt||n.deletedAt||0)})}function Jo(e){if(!e)return;u.favoriteArticles||(u.favoriteArticles=[]);let t=new Set(u.favoriteArticles);t.has(e)?t.delete(e):t.add(e),u.favoriteArticles=Array.from(t),Fu(),Ht(),vn()}function jo(e=[]){(!u.favoriteArticles||!u.favoriteArticles.length)&&$u();let t=Array.isArray(e)?e:[];u.articlesIndex=t.map(r=>({id:r.id,title:r.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",updatedAt:r.updatedAt||new Date().toISOString(),deletedAt:r.deletedAt||null,publicSlug:r.publicSlug||null,parentId:r.parentId||null,position:typeof r.position=="number"?r.position:0}));let n=new Set(u.articlesIndex.map(r=>r.id));Array.isArray(u.sidebarCollapsedArticleIds)&&u.sidebarCollapsedArticleIds.length&&(u.sidebarCollapsedArticleIds=u.sidebarCollapsedArticleIds.filter(r=>n.has(r)),$o()),Array.isArray(u.listCollapsedArticleIds)&&u.listCollapsedArticleIds.length&&(u.listCollapsedArticleIds=u.listCollapsedArticleIds.filter(r=>n.has(r)),Fo()),Ht()}function wc(e=[]){let t=bc(Array.isArray(e)?e:[]);u.deletedArticlesIndex=t,Ht()}function Tr(e){if(!e||!e.id||e.deletedAt)return;let t={id:e.id,title:e.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",updatedAt:e.updatedAt||new Date().toISOString(),publicSlug:e.publicSlug||null,parentId:e.parentId||null,position:typeof e.position=="number"?e.position:0},n=u.articlesIndex.findIndex(r=>r.id===t.id);n>=0?u.articlesIndex[n]={...u.articlesIndex[n],...t}:u.articlesIndex.unshift(t),Ht()}function cs(e){if(!e)return;let t=u.deletedArticlesIndex.length;u.deletedArticlesIndex=u.deletedArticlesIndex.filter(n=>n.id!==e),t!==u.deletedArticlesIndex.length&&(Ht(),vn())}function Sc(e=[]){let t=new Map;e.forEach(o=>{t.set(o.id,{...o,children:[]})});let n=[];t.forEach(o=>{let i=o.parentId||null;i&&t.has(i)?t.get(i).children.push(o):n.push(o)});let r=o=>{o.sort((i,s)=>{let a=(u.favoriteArticles||[]).includes(i.id),c=(u.favoriteArticles||[]).includes(s.id);return a!==c?a?-1:1:i.position!==s.position?i.position-s.position:new Date(s.updatedAt||0)-new Date(i.updatedAt||0)}),o.forEach(i=>r(i.children||[]))};return r(n),n}function Ht(){if(!J.sidebarArticleList)return;J.sidebarArticleList.innerHTML="",J.backToList&&J.backToList.classList.toggle("active",u.sidebarArticlesMode!=="recent"),J.sidebarRecentBtn&&J.sidebarRecentBtn.classList.toggle("active",u.sidebarArticlesMode==="recent");let e=(u.articleFilterQuery||"").trim().toLowerCase(),t=u.sidebarArticlesMode==="recent"?"recent":"tree",n=u.isTrashView?u.deletedArticlesIndex:u.articlesIndex,r=new Set(u.favoriteArticles||[]),o=new Set(u.sidebarCollapsedArticleIds||[]),i=u.sidebarSelectedArticleId||u.articleId,s=Array.isArray(u.recentArticleIds)?u.recentArticleIds:[],a=[];if(!u.isTrashView&&(r.has("RAG")||t==="recent"&&s.includes("RAG"))){let f=(u.ragQuery||"").trim();a.push({id:"RAG",title:f?`AI: ${f}`:"AI: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B \u043F\u043E\u0438\u0441\u043A\u0430",updatedAt:new Date().toISOString(),deletedAt:null,publicSlug:null,parentId:null,position:0})}let l=new Set(a.map(f=>f.id)),d=a.length&&!u.isTrashView?[...(n||[]).filter(f=>!l.has(f.id)),...a]:n,h=new Set;(d||[]).forEach(f=>{let p=f.parentId||null;p&&h.add(p)});let g=(d||[]).filter(f=>(e?(f.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(e):!0)&&(u.isTrashView?!0:f.id!=="inbox"));if(!g.length){let f=document.createElement("li");f.className="sidebar-article-empty",f.textContent=u.isTrashView?e?"No deleted pages match the filter":"Trash is empty":e?"\u041D\u0435\u0442 \u0441\u043E\u0432\u043F\u0430\u0434\u0435\u043D\u0438\u0439":"\u041D\u0435\u0442 \u0441\u0442\u0430\u0442\u0435\u0439",J.sidebarArticleList.appendChild(f);return}if(t==="recent"){let f=new Map(g.map(L=>[L.id,L])),p=new Set(s),y=s.map(L=>f.get(L)).filter(Boolean),k=bc(g.filter(L=>!p.has(L.id)));[...y,...k].forEach(L=>{let O=document.createElement("li");O.className="sidebar-article-item",O.dataset.articleId=L.id;let z=document.createElement("div");z.className="sidebar-article-row";let q=document.createElement("button");q.type="button",!u.isTrashView&&L.id===i&&q.classList.add("active");let $=r.has(L.id),Q=Rt(L.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),W=L.publicSlug?"\uE774 ":"";q.innerHTML=`<span class="sidebar-article-title">${W}${Q}</span><span class="star-btn ${$?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${$?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}">${$?"\uE735":"\uE734"}</span>`,q.addEventListener("click",()=>{window.__ttreeDraggingArticleId||(u.sidebarSelectedArticleId=L.id,un(Yt.article(L.id)),u.isSidebarMobileOpen&&Zr(!1))});let re=q.querySelector(".star-btn");re&&re.addEventListener("click",we=>{we.stopPropagation(),Jo(L.id)}),z.appendChild(q),O.appendChild(z),J.sidebarArticleList.appendChild(O)});return}let w=Sc(g),S=(f,p)=>{let y=document.createElement("li");y.className="sidebar-article-item",h.has(f.id)&&(y.classList.add("has-children"),o.has(f.id)&&y.classList.add("is-collapsed")),y.dataset.articleId=f.id,y.style.paddingLeft=`${p*1.25}rem`;let k=document.createElement("div");k.className="sidebar-article-row";let E=document.createElement("button");E.type="button",!u.isTrashView&&f.id===i&&E.classList.add("active");let L=r.has(f.id),O=Rt(f.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),z=f.publicSlug?"\uE774 ":"";E.innerHTML=`<span class="sidebar-article-title">${z}${O}</span><span class="star-btn ${L?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${L?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}">${L?"\uE735":"\uE734"}</span>`,E.addEventListener("click",()=>{if(window.__ttreeDraggingArticleId)return;u.sidebarSelectedArticleId=f.id,u.sidebarCollapsedArticleIds||(u.sidebarCollapsedArticleIds=[]);let $=new Set(u.sidebarCollapsedArticleIds);$.has(f.id)?$.delete(f.id):$.add(f.id),u.sidebarCollapsedArticleIds=Array.from($),$o(),Ht()}),E.addEventListener("dblclick",$=>{$.preventDefault(),$.stopPropagation(),u.sidebarSelectedArticleId=f.id,un(Yt.article(f.id)),u.isSidebarMobileOpen&&Zr(!1)});let q=E.querySelector(".star-btn");q&&q.addEventListener("click",$=>{$.stopPropagation(),Jo(f.id)}),k.appendChild(E),y.appendChild(k),u.isTrashView||(ss(y),is(y,f.id)),J.sidebarArticleList.appendChild(y),o.has(f.id)||(f.children||[]).forEach($=>S($,p+1))};w.forEach(f=>S(f,0))}function vn(e=null){if(!J.articleList)return;J.articleList.innerHTML="";let t="",n=Array.isArray(e)&&e.length?e:u.isTrashView?u.deletedArticlesIndex:u.articlesIndex,r=new Set(u.favoriteArticles||[]),o=new Set(u.listCollapsedArticleIds||[]),i=u.listSelectedArticleId||u.articleId,s=new Set;if(n.forEach(d=>{let h=d.parentId||null;h&&s.add(h)}),!n.length){let d=document.createElement("li");d.textContent=u.isTrashView?t?"No deleted pages match the filter":"Trash is empty":t?"\u041D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E":"\u0421\u043F\u0438\u0441\u043E\u043A \u043F\u0443\u0441\u0442.",J.articleList.appendChild(d);return}if(u.isTrashView){n.slice().filter(d=>(t?(d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(t):!0)&&(u.isTrashView?!0:d.id!=="inbox")).forEach(d=>{let h=document.createElement("li");h.dataset.articleId=d.id,h.innerHTML=`
      <span>
        <strong>${Rt(d.title)}</strong>
      </span>
      <div class="row-actions">
        <button class="ghost restore-btn" data-id="${d.id}">\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C</button>
        <button class="ghost danger delete-btn" data-id="${d.id}">\u0423\u0434\u0430\u043B\u0438\u0442\u044C</button>
      </div>
    `;let g=h.querySelector(".restore-btn"),w=h.querySelector(".delete-btn");g&&g.addEventListener("click",async S=>{S.preventDefault(),S.stopPropagation(),await zu(d.id)}),w&&w.addEventListener("click",async S=>{S.preventDefault(),S.stopPropagation(),await Uu(d.id)}),J.articleList.appendChild(h)});return}let a=n.slice().filter(d=>(t?(d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(t):!0)&&d.id!=="inbox"),c=Sc(a),l=(d,h)=>{let g=document.createElement("li");s.has(d.id)&&(g.classList.add("has-children"),o.has(d.id)&&g.classList.add("is-collapsed")),g.dataset.articleId=d.id;let w=r.has(d.id),S=Rt(d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),f=d.publicSlug?'<span class="article-public-icon">&#xE774;</span>':"";g.style.paddingLeft=`${h*1.25}rem`,g.innerHTML=`
      <span>
        <strong>${f}${S}</strong>
      </span>
      <button class="ghost star-btn ${w?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${w?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}">${w?"\uE735":"\uE734"}</button>
    `;let p=g.querySelector(".star-btn");p&&p.addEventListener("click",y=>{y.preventDefault(),y.stopPropagation(),Jo(d.id)}),d.id===i&&g.classList.add("active-article"),g.addEventListener("click",()=>{if(window.__ttreeDraggingArticleId)return;u.listSelectedArticleId=d.id,u.listCollapsedArticleIds||(u.listCollapsedArticleIds=[]);let y=new Set(u.listCollapsedArticleIds);y.has(d.id)?y.delete(d.id):y.add(d.id),u.listCollapsedArticleIds=Array.from(y),Fo(),vn()}),g.addEventListener("dblclick",y=>{y.preventDefault(),y.stopPropagation(),u.listSelectedArticleId=d.id,un(Yt.article(d.id))}),J.articleList.appendChild(g),u.isTrashView||(ss(g),is(g,d.id)),o.has(d.id)||(d.children||[]).forEach(y=>l(y,h+1))};c.forEach(d=>l(d,0))}async function zu(e){if(e)try{let t=await qa(e);cs(e),Tr(t),await xc(!1),un(Yt.article(t.id)),Ee("Page restored")}catch(t){Ee(t.message)}}async function Uu(e){if(e)try{await Ua(e,{force:!0}),cs(e),Ee("\u0421\u0442\u0430\u0442\u044C\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u0431\u0435\u0437\u0432\u043E\u0437\u0432\u0440\u0430\u0442\u043D\u043E"),vn(),Ht()}catch(t){Ee(t.message)}}async function xc(e){u.isTrashView=e,es(),e?await Ko():await no(),Ht(),vn()}async function no(){if(u.articlesIndex.length)return u.isTrashView||Ht(),u.articlesIndex;let e=await dn();return jo(e),e}async function Ko(){if(u.deletedArticlesIndex.length)return u.isTrashView&&Ht(),u.deletedArticlesIndex;let e=await Ha();return wc(e),e}var yc,Wo=je(()=>{bt();ln();In();jn();Wt();Ft();Uo();Cr();as();yc="ttree_favorites"});function Ju(){try{let e=Array.isArray(u.recentArticleIds)?u.recentArticleIds:[];window.localStorage.setItem(Vu,JSON.stringify(e.slice(0,Ac)))}catch{}}function Yo(e){if(!e||e==="inbox"||u.isPublicView)return;let t=Array.isArray(u.recentArticleIds)?u.recentArticleIds:[],n=[e,...t.filter(r=>r!==e)];u.recentArticleIds=n.slice(0,Ac),Ju(),u.sidebarArticlesMode==="recent"&&Ht()}var Vu,Ac,ls=je(()=>{bt();Wo();Cr();Vu="ttree_recent_articles",Ac=300});var Kn=je(()=>{ln();bt();ls();Cr();Uo();as();Wo();Cr();ls();Uo();Wo();fc({renderSidebarArticleList:Ht,renderMainArticleList:vn,setArticlesIndex:jo})});function Ku(e){u.articleId&&(u.articleEncryptionKeys||(u.articleEncryptionKeys={}),e?u.articleEncryptionKeys[u.articleId]=e:delete u.articleEncryptionKeys[u.articleId])}async function Ic(e){if(!e||!e.encrypted)return e;let t=u.articleEncryptionKeys?.[e.id]||null;if(t)return await Xi(e,t),e;let n=0;for(;;){n+=1;let r=null;try{let o=e.encryptionHint||"",i="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C \u0434\u043B\u044F \u044D\u0442\u043E\u0439 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B.",s=o?`${i}
\u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0430: ${o}`:i;r=await Vn({title:"\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430",message:s,confirmText:"\u041E\u0442\u043A\u0440\u044B\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"\u041F\u0430\u0440\u043E\u043B\u044C",inputType:"password"})}catch{r=window.prompt("\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430. \u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C:")||""}if(!r)throw new Error("\u041F\u0430\u0440\u043E\u043B\u044C \u043D\u0435 \u0432\u0432\u0435\u0434\u0451\u043D");try{let{key:o}=await ec(r,e.encryptionSalt||"");if(!await nc(o,e.encryptionVerifier||"")){if(n>=3)throw new Error("\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C");window.alert("\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C, \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437.");continue}return await Xi(e,o),Ku(o),e}catch(o){if(n>=3)throw new Error(o.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");window.alert("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443, \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437.")}}}var ds=je(()=>{bt();Wt();Ft();Jn();In();Qr();Kn();Xr()});function Yu(e,t){if(!t.length)return;let n=document.createElement("div");n.className="diff-images",t.forEach(r=>{let o=document.createElement("div");o.className=`diff-image-card diff-image-card--${r.type}`;let i=document.createElement("div");i.className="diff-image-card__label",i.textContent=r.type==="added"?"\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E":"\u0423\u0434\u0430\u043B\u0435\u043D\u043E";let s=document.createElement("img");s.src=r.src,s.alt=r.alt||"",o.append(i,s),n.appendChild(o)}),e.appendChild(n)}function Xu(e,t,n,r=[]){let o=document.createElement("div");o.className="diff-inline";let i=document.createElement("div");i.className="diff-inline__content",n.forEach(a=>{let c=document.createElement("span");a.type==="added"?c.className="diff-inline__segment diff-inline__segment--added":a.type==="removed"&&(c.className="diff-inline__segment diff-inline__segment--removed"),c.textContent=a.value,i.appendChild(c)}),Yu(i,r);let s=document.createElement("div");s.className="diff-inline__hint",s.textContent=t==="undo"?"\u041F\u043E\u0432\u0442\u043E\u0440\u043D\u043E \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Ctrl+Z, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C \u043E\u0442\u043C\u0435\u043D\u0443":"\u041F\u043E\u0432\u0442\u043E\u0440\u043D\u043E \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Ctrl+Y, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C \u043F\u043E\u0432\u0442\u043E\u0440",o.append(i,s),e.innerHTML="",e.appendChild(o)}function kc(){let e=u.pendingTextPreview;if(!e)return;let t=document.querySelector(`.block[data-block-id="${e.blockId}"] .block-text`);t&&Xu(t,e.mode,e.chunks,e.imageDiff||[])}function vc(e){Xo({restoreDom:!1});let t=n=>({type:"text",blockId:n.blockId,historyEntryId:n.id});u.undoStack=(e.history||[]).map(t),u.redoStack=(e.redoHistory||[]).map(t)}function Br(e){e&&(Ut("pushUndoEntry",e),u.undoStack.push(e),u.redoStack=[])}function ro(e){try{return JSON.parse(JSON.stringify(e||{}))}catch{return null}}function Gu(e){if(!e||!u.article||!Array.isArray(u.article.blocks))return;let t=!1,n=r=>{if(Array.isArray(r))for(let o=0;o<r.length;o+=1){let i=r[o];if(i){if(i===e)if(!t)t=!0;else{r.splice(o,1),o-=1;continue}Array.isArray(i.children)&&i.children.length&&n(i.children)}}};n(u.article.blocks)}async function Qu(e){e&&(await us(e),Wn(e))}function Xo({restoreDom:e=!0}={}){let t=u.pendingTextPreview;if(t){if(e){let n=document.querySelector(`.block[data-block-id="${t.blockId}"] .block-text`);n&&(n.innerHTML=t.originalHTML)}u.pendingTextPreview=null}}async function Ec(e,t=null,n=null,r={}){if(!e)return{success:!1};let{skipRecord:o=!1,anchorId:i=null,placement:s=null,suppressRerender:a=!1}=r,c=lt(e);if(!c)return Ee("\u0411\u043B\u043E\u043A \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D"),{success:!1};let l=c.parent?.id||null,d=c.index??0,h=t?lt(t)?.block:null,g=h?h.children?.length||0:(u.article?.blocks||[]).length,w=typeof n=="number"&&n>=0?Math.min(n,g):g;if(l===t&&d===w)return{success:!0,noOp:!0,from:{parentId:l,index:d},to:{parentId:t,index:w}};let S=w;t===l&&d<S&&(S=Math.max(S-1,0));try{let f=await gt(`/api/articles/${u.articleId}/blocks/${e}/relocate`,{method:"POST",body:JSON.stringify({parentId:t||null,index:S,anchorId:i||null,placement:s||null})});if(u.article&&Array.isArray(u.article.blocks)){let y=c.siblings||u.article.blocks,k=c.index??y.findIndex(z=>z.id===e),E=null;k>=0&&([E]=y.splice(k,1)),E||(E=c.block);let L;if(t){let z=lt(t);z&&z.block?(Array.isArray(z.block.children)||(z.block.children=[]),L=z.block.children):L=u.article.blocks}else L=u.article.blocks;let O=typeof S=="number"&&S>=0?Math.min(S,L.length):L.length;if(L.splice(O,0,E),Gu(E),u.article.updatedAt)try{u.article.updatedAt=new Date().toISOString()}catch{}}u.currentBlockId=e;let p=f?.parentId??t??null;return a||(l&&p?(await Xt(l),p!==l&&await Xt(p)):l&&!p?_t():!l&&p?_t():_t()),o||Br({type:"structure",action:{kind:"reorder",blockId:e,fromParentId:l,fromIndex:d,toParentId:f?.parentId??t??null,toIndex:f?.index??S}}),await Qu(e),{success:!0,from:{parentId:l,index:d},to:{parentId:f?.parentId??t??null,index:f?.index??S}}}catch(f){return Ee(f.message),{success:!1}}}var cr=je(()=>{bt();Wt();Ft();ar();ar();En();In();Qr()});function nf(){try{return window?.localStorage?.getItem?.(ef)==="1"}catch{return!1}}function Tc(){try{return window?.localStorage?.getItem?.(tf)==="1"}catch{return!1}}function Nr(...e){try{if(!nf())return;console.log("[article-load]",...e)}catch{}}function rf(e){try{let t=e?.content;if(!Array.isArray(t))return null;for(let n of t)if(n?.type==="outlineSection"){let r=String(n?.attrs?.id||"");if(r)return r}return null}catch{return null}}async function Ln(e,t={}){let{desiredBlockId:n,resetUndoStacks:r,editBlockId:o}=t,i=u.articleId!==e;if(Nr("load.start",{id:e,switchingArticle:i,mode:u.mode,isOutlineEditing:u.isOutlineEditing}),i)try{let g=u.articleId,w=await Promise.resolve().then(()=>(Qo(),Go));try{let S=w?.getOutlineActiveSectionSnapshot?.()||null;if(g&&S?.sectionId){let f=window?.localStorage?.getItem?.(Cc)||"{}",p=JSON.parse(f||"{}"),y=p&&typeof p=="object"?p:{};y[String(g)]={sectionId:S.sectionId,collapsed:!!S.collapsed,savedAt:new Date().toISOString()},window?.localStorage?.setItem?.(Cc,JSON.stringify(y))}}catch{}w?.flushOutlineAutosave&&await w.flushOutlineAutosave({mode:"queue"}),w?.closeOutlineEditor&&w.closeOutlineEditor()}catch{}u.articleId=e,u.isEditingTitle=!1,u.pendingTextPreview=null,u.article=null,u.currentBlockId=null;let s=performance.now(),a=await $a(e);Tc()&&console.log("[perf][article-load] fetchArticle",{id:e,ms:Math.round(performance.now()-s)}),Nr("load.fetched",{id:e,ms:Math.round(performance.now()-s),hasDocJson:!!a?.docJson,docContent:Array.isArray(a?.docJson?.content)?a.docJson.content.length:null,blocksCount:Array.isArray(a?.blocks)?a.blocks.length:null,updatedAt:a?.updatedAt});let c=a;try{c=await Ic(a)}catch(g){throw Ee(g.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u0443\u044E \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443"),g}u.article=c,(typeof r=="boolean"?r:i)&&vc(c);let d=n||o||u.pendingEditBlockId||null;u.pendingEditBlockId=null;let h=rf(c.docJson)||c.blocks?.[0]?.id||null;if(u.currentBlockId=d||h,u.mode="view",u.editingBlockId=null,Tr(c),ja(),!u.isPublicView&&!u.isRagView&&!c.encrypted)try{let g=await Promise.resolve().then(()=>(Qo(),Go));if(g?.openOutlineEditor){Nr("outline.open.start",{id:e});let w=Tc()?performance.now():0;g.openOutlineEditor(),w&&console.log("[perf][article-load] outline.open scheduled",{id:e,ms:Math.round(performance.now()-w)}),Nr("outline.open.scheduled",{id:e,isOutlineEditing:u.isOutlineEditing})}}catch(g){u.isOutlineEditing=!1,Nr("outline.open.failed",{id:e,message:g?.message||String(g||"error")}),Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C outline-\u0440\u0435\u0436\u0438\u043C (\u0441\u043C. \u043A\u043E\u043D\u0441\u043E\u043B\u044C)")}return Nr("load.done",{id:e,currentBlockId:u.currentBlockId}),c}var ef,tf,Cc,fs=je(()=>{bt();Wt();cr();Ft();Kn();ds();Xr();ef="ttree_debug_article_load_v1",tf="ttree_profile_v1",Cc="ttree_outline_last_active_v1"});var Bc=je(()=>{In();En()});function of(e){if(!e)return;e.focus({preventScroll:!0});let t=window.getSelection&&window.getSelection();if(!t)return;t.removeAllRanges();let n=document.createRange();n.selectNodeContents(e),n.collapse(!1),t.addRange(n)}async function ps(e){return!u.article||!u.article.encrypted||!u.articleEncryptionKey?e:Gi(u.articleEncryptionKey,e)}async function Mc(){if(!u.currentBlockId||u.isRagView)return;let e=u.currentBlockId;u.editingScrollTop=J.blocksContainer?J.blocksContainer.scrollTop:null,u.mode="edit",u.scrollTargetBlockId=null,u.editingBlockId=u.currentBlockId,u.editingInitialText=lt(u.currentBlockId)?.block.text||"",u.editingUndo=null,await Xt(e);let t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`);if(t||(_t(),await Xt(e),t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`)),!t){u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.editingUndo=null,u.currentBlockId=e,Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430");return}of(t)}async function Lc(){if(u.mode!=="edit"||!u.editingBlockId)return;let e=u.editingBlockId,t=lt(e),n=t?.block.text||"",o=document.querySelector(`.block[data-block-id="${u.editingBlockId}"] .block-text`)?.innerHTML||"",{cleanupEditableHtml:i}=await Promise.resolve().then(()=>(En(),ys)),s=i(o);if(!(s||"").trim()){let c=ei(e),l=lt(e),d=!!(l?.block&&l.block.__isNew);if(l&&u.article&&Array.isArray(u.article.blocks)){let h=l.siblings||u.article.blocks,g=l.index??h.findIndex(w=>w&&w.id===e);if(g>=0&&h.splice(g,1),u.article.updatedAt)try{u.article.updatedAt=new Date().toISOString()}catch{}if(!d){let w=ro(l.block);hs(w,l.parent?.id||null,l.index??null)}}u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.currentBlockId=c,u.scrollTargetBlockId=c,Zo(e),_t(),(async()=>{try{let h=d?`/api/articles/${u.articleId}/blocks/${e}/permanent`:`/api/articles/${u.articleId}/blocks/${e}`,g=await gt(h,{method:"DELETE"});if(!d&&g?.block){let w=ro(g.block);Br({type:"structure",action:{kind:"delete",parentId:g.parentId||null,index:g.index??null,block:w,blockId:w?.id,fallbackId:c}})}Ee("\u041F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A \u0443\u0434\u0430\u043B\u0451\u043D")}catch(h){Ee(h.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Ln(u.articleId,{desiredBlockId:c||null}),_t()}catch{}}})();return}if(s===n){u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.editingUndo=null,u.pendingEditBlockId=null,u.currentBlockId=e,u.scrollTargetBlockId=e,await Xt(e);return}if(t&&u.article&&Array.isArray(u.article.blocks)&&(t.block.text=s,u.article.updatedAt))try{u.article.updatedAt=new Date().toISOString()}catch{}u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.editingUndo=null,u.pendingEditBlockId=null,u.currentBlockId=e,u.scrollTargetBlockId=e,await Xt(e),(async()=>{try{let c=await ps(s),l=await gt(`/api/articles/${u.articleId}/blocks/${e}`,{method:"PATCH",body:JSON.stringify({text:c})});n!==s&&(!!(t?.block&&t.block.__isNew)?delete t.block.__isNew:Br({type:"text",blockId:e,historyEntryId:l?.historyEntryId||null})),Ee("\u0411\u043B\u043E\u043A \u043E\u0431\u043D\u043E\u0432\u043B\u0451\u043D")}catch(c){Ee(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Ln(u.articleId,{desiredBlockId:e}),_t()}catch{}}})()}async function Pc(){if(u.mode!=="edit"||!u.editingBlockId)return;let e=u.editingBlockId,r=!(document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`)?.textContent||"").replace(/\u00a0/g," ").trim();if(u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.editingUndo=null,r){let o=ei(e),i=lt(e),s=!!(i?.block&&i.block.__isNew);if(i&&u.article&&Array.isArray(u.article.blocks)){let c=i.siblings||u.article.blocks,l=i.index??c.findIndex(d=>d&&d.id===e);if(l>=0&&c.splice(l,1),u.article.updatedAt)try{u.article.updatedAt=new Date().toISOString()}catch{}}u.currentBlockId=o,u.scrollTargetBlockId=o,Zo(e);let a=i?.parent?.id||null;a?await Xt(a):_t(),(async()=>{try{let c=s?`/api/articles/${u.articleId}/blocks/${e}/permanent`:`/api/articles/${u.articleId}/blocks/${e}`,l=await gt(c,{method:"DELETE"});if(!s&&l?.block){let d=ro(l.block);Br({type:"structure",action:{kind:"delete",parentId:l.parentId||null,index:l.index??null,block:d,blockId:d?.id,fallbackId:o}})}}catch(c){Ee(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Ln(u.articleId,{desiredBlockId:o||null}),_t()}catch{}}})();return}u.currentBlockId=e,await Xt(e)}async function _c(){if(u.mode!=="edit"||!u.editingBlockId)return;let e=u.editingBlockId,t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`);if(!t)return;let n=window.getSelection();if(!n||n.rangeCount===0||!t.contains(n.anchorNode))return;let r=n.getRangeAt(0).cloneRange(),o=document.createElement("span"),i=`split-marker-${Date.now()}-${Math.random().toString(16).slice(2)}`;o.setAttribute("data-split-marker",i),o.textContent="",r.insertNode(o);let s=t.innerHTML;o.parentNode.removeChild(o);let a=`<span data-split-marker="${i}"></span>`,c=s.split(a);if(c.length!==2)return;let[l,d]=c,{cleanupEditableHtml:h}=await Promise.resolve().then(()=>(En(),ys)),g=h(l||""),w=h(d||"");if(!(!w||w===g))try{let S=lt(e),f=S?.block,p=f?ro(f):null,y=await ps(g);await gt(`/api/articles/${u.articleId}/blocks/${e}`,{method:"PATCH",body:JSON.stringify({text:y})});let E=(await gt(`/api/articles/${u.articleId}/blocks/${e}/siblings`,{method:"POST",body:JSON.stringify({direction:"after"})}))?.block?.id;if(!E){Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043D\u043E\u0432\u044B\u0439 \u0431\u043B\u043E\u043A");return}let L=await ps(w);if(await gt(`/api/articles/${u.articleId}/blocks/${E}`,{method:"PATCH",body:JSON.stringify({text:L})}),S&&u.article&&Array.isArray(u.article.blocks)){S.block.text=g;let z=S.parent,q=S.siblings||u.article.blocks||[],$=(S.index??0)+1,Q={id:E,text:w,children:[],collapsed:!1};if(q.splice($,0,Q),u.article.updatedAt)try{u.article.updatedAt=new Date().toISOString()}catch{}}u.mode="edit",u.editingBlockId=E,u.pendingEditBlockId=null,u.currentBlockId=E,u.scrollTargetBlockId=E,u.editingCaretPosition="start";let O=S?.parent?.id||null;O?await Xt(O):_t(),p&&Br({type:"text",blockId:e,block:p})}catch(S){Ee(S.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0437\u0431\u0438\u0442\u044C \u0431\u043B\u043E\u043A")}}var ms=je(()=>{bt();Wt();ln();Ft();ar();ar();cr();En();Bc();In();Qr()});function $c(){if(!At||!io()||At.pointerType==="mouse")return;let e=window.getSelection?window.getSelection():null;if(!(!e||e.isCollapsed))try{e.removeAllRanges()}catch{}}function df(){ti||(document.addEventListener("selectionchange",$c),ti=!0)}function uf(){ti&&(document.removeEventListener("selectionchange",$c),ti=!1)}function io(){return!!(u.isDragModeEnabled&&u.mode==="view"&&u.articleId!=="inbox")}function Fc(e){return e instanceof Element?!!e.closest(lf):!1}function zc(){if(At){window.removeEventListener("pointermove",jc),window.removeEventListener("pointerup",ni),window.removeEventListener("pointercancel",ni);try{At.sourceEl?.releasePointerCapture?.(At.pointerId)}catch{}At=null,uf(),mf()}}function ff(e,t,n,{bypassInteractiveCheck:r=!1}={}){if(!u.article||!u.isDragModeEnabled||!io()||e.pointerType==="mouse"&&e.button!==0||!r&&Fc(e.target))return;let o=lt(t);if(o){At={pointerType:e.pointerType||"mouse",blockId:t,pointerId:e.pointerId,originParentId:o.parent?.id||null,originIndex:o.index??0,startX:e.clientX,startY:e.clientY,dragging:!1,forbidden:qc(o.block),lastDrop:null,sourceEl:n};try{n?.setPointerCapture?.(e.pointerId)}catch{}window.addEventListener("pointermove",jc),window.addEventListener("pointerup",ni),window.addEventListener("pointercancel",ni),df()}}function Uc(e,t,{allowInteractive:n=!1}={}){e&&e.addEventListener("pointerdown",r=>{if(!n&&Fc(r.target))return;(r.pointerType==="touch"||r.pointerType==="pen")&&io()&&r.preventDefault(),ff(r,t,e,{bypassInteractiveCheck:n})})}function Mr(){let e=!!u.article,t=J.dragModeToggleBtn;if(t){t.disabled=!e,t.classList.toggle("active",!!u.isDragModeEnabled),t.setAttribute("aria-pressed",u.isDragModeEnabled?"true":"false");let o=u.isDragModeEnabled?"\u041F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435 \u0431\u043B\u043E\u043A \u0437\u0430 \u0435\u0433\u043E \u043F\u043E\u0432\u0435\u0440\u0445\u043D\u043E\u0441\u0442\u044C":"\u0412\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0440\u0435\u0436\u0438\u043C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u044F \u0431\u043B\u043E\u043A\u043E\u0432";e?u.articleId==="inbox"?o="\u041F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0432 \u0431\u044B\u0441\u0442\u0440\u044B\u0445 \u0437\u0430\u043C\u0435\u0442\u043A\u0430\u0445":u.mode!=="view"&&(o="\u041F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043C\u043E\u0436\u043D\u043E \u0442\u043E\u043B\u044C\u043A\u043E \u0432 \u0440\u0435\u0436\u0438\u043C\u0435 \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440\u0430"):o="\u041E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E, \u0447\u0442\u043E\u0431\u044B \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0442\u044C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435\u043C",t.title=o}let n=io();[J.articleView,J.blocksContainer].forEach(o=>{o&&o.classList.toggle("drag-mode-enabled",n)}),document.body.classList.toggle("drag-mode-enabled",n)}function qc(e,t=new Set){return e&&(t.add(e.id),(e.children||[]).forEach(n=>qc(n,t))),t}function pf(){if(oo)return oo;let e=document.createElement("div");return e.className="block-drop-line hidden",document.body.appendChild(e),oo=e,e}function mf(){oo&&oo.classList.add("hidden"),Gt&&(Gt.classList.remove("drop-inside-target"),Gt=null),lr&&(lr.remove(),lr=null),document.body.classList.remove("block-dnd-active")}function hf(e){lr&&(lr.style.left=`${e.clientX+12}px`,lr.style.top=`${e.clientY+12}px`)}function gf(e){let t=document.createElement("div");t.className="block-drag-preview";let n=J.blocksContainer?.querySelector(`.block[data-block-id="${e}"]`),r=n?.querySelector(".block-title")?.textContent?.trim(),o=n?.querySelector(".block-text")?.textContent?.trim();t.textContent=r||o||"\u0411\u043B\u043E\u043A",document.body.appendChild(t),lr=t}function Vc(){return gn&&gn.isConnected?(J.blocksContainer&&gn.parentNode!==J.blocksContainer&&J.blocksContainer.appendChild(gn),gn):(gn=document.createElement("div"),gn.className="drag-layer",J.blocksContainer&&(J.blocksContainer.appendChild(gn),Dc||(J.blocksContainer.addEventListener("scroll",Oc,{passive:!0}),window.addEventListener("resize",Oc,{passive:!0}),Dc=!0)),gn)}function Jc(){Hc.clear(),gn&&(gn.innerHTML="")}function Oc(){let e=J.blocksContainer;if(!e||!gn)return;let t=e.getBoundingClientRect(),n=e.scrollTop;Hc.forEach(({handle:r,blockEl:o})=>{let i=o.getBoundingClientRect(),s=o.querySelector(".block-header__left"),a=o.querySelector(".block-header"),c=o.querySelector(".collapse-btn"),l=s?.getBoundingClientRect(),d=a?.getBoundingClientRect(),h=c?.getBoundingClientRect(),g=(l&&l.height>0?l:null)||(d&&d.height>0?d:null)||(h&&h.height>0?h:null)||i,w=g.top-t.top+n+g.height/2;r.style.top=`${w}px`,r.style.right="8px"})}function yf(e){let t=pf();if(!e){t.classList.add("hidden"),Gt&&(Gt.classList.remove("drop-inside-target"),Gt=null);return}if(e.placement==="inside"){t.classList.add("hidden"),Gt&&Gt.dataset.blockId!==e.targetId&&Gt.classList.remove("drop-inside-target"),Gt=J.blocksContainer?.querySelector(`.block[data-block-id="${e.targetId}"]`)||null,Gt&&Gt.classList.add("drop-inside-target");return}Gt&&(Gt.classList.remove("drop-inside-target"),Gt=null),t.classList.remove("hidden");let n=e.placement==="before"?e.rect.top:e.rect.top+e.rect.height,r=Math.min(e.depth*Rc,e.rect.width-32),o=e.rect.left+r,i=Math.max(e.rect.width-r,48);t.style.top=`${n}px`,t.style.left=`${o}px`,t.style.width=`${i}px`}function bf(e,t){if(!J.blocksContainer||!At)return null;let r=Array.from(J.blocksContainer.querySelectorAll(".block")).filter(E=>{let L=E.dataset.blockId;return L&&!At.forbidden.has(L)});if(!r.length)return null;let o=null,i=1/0;if(r.forEach(E=>{let L=E.getBoundingClientRect(),O=L.top+L.height/2,z=Math.abs(t-O);z<i&&(i=z,o=E)}),!o)return null;let s=o.getBoundingClientRect(),a=s.height>0?(t-s.top)/s.height:.5,c=a<af?"before":a>cf?"after":"inside",l=o.dataset.blockId,d=lt(l);if(!d)return null;let h=(d.ancestors||[]).length,g=c==="inside"?l:d.parent?.id||null;if(At.forbidden.has(g||""))return null;let w=l,S=g,f=c,p=s,y=c==="inside"?h+1:h,k=f==="after"?d.index+1:d.index;if(f!=="inside"&&d.parent){let E=d,L=s,O=s.left+Rc;for(;E.parent;){let z=e<=O,q=t<=L.top||t>=L.bottom;if(!z&&!q)break;let $=lt(E.parent.id);if(!$)break;let W=J.blocksContainer?.querySelector(`.block[data-block-id="${$.block.id}"]`)?.getBoundingClientRect();E=$,L=W||L,w=E.block.id,p=L,y=(E.ancestors||[]).length,S=E.parent?.id||null,k=f==="after"?E.index+1:E.index}}return{targetId:w,placement:f,parentId:S,index:k,depth:y,rect:p}}function wf(e){if(!J.blocksContainer)return;let t=J.blocksContainer.getBoundingClientRect(),n=60;e.clientY<t.top+n?J.blocksContainer.scrollTop-=12:e.clientY>t.bottom-n&&(J.blocksContainer.scrollTop+=12)}function jc(e){if(!At||e.pointerId!==At.pointerId)return;if(!io()){zc();return}let t=e.clientX-At.startX,n=e.clientY-At.startY;if(!At.dragging){if(Math.hypot(t,n)<sf)return;At.dragging=!0;let o=At.pointerType||e.pointerType||"mouse";(o==="touch"||o==="pen")&&document.body.classList.add("block-dnd-active"),gf(At.blockId)}e.preventDefault(),hf(e);let r=bf(e.clientX,e.clientY);At.lastDrop=r,yf(r),wf(e)}async function ni(e){if(!At||e.pointerId!==At.pointerId)return;let t=At;zc();let n=t.dragging&&t.lastDrop,r=t.lastDrop,o=t.blockId;!n||!r||await Ec(o,r.parentId||null,r.index,{anchorId:r.targetId,placement:r.placement})}var sf,Rc,af,cf,lf,At,oo,Gt,lr,gn,Hc,Dc,ti,so=je(()=>{bt();ln();En();cr();Ft();sf=6,Rc=20,af=.35,cf=.65,lf='button, a, input, textarea, select, [contenteditable="true"], .block-edit-actions, .move-block-btn, .collapse-btn',At=null,oo=null,Gt=null,lr=null,gn=null,Hc=new Map,Dc=!1,ti=!1});function Kc(e){bs=typeof e=="function"?e:null}function Sf(e){let t=new Set,n=r=>{if(Array.isArray(r))for(let o=0;o<r.length;o+=1){let i=r[o];if(!i||!i.id){r.splice(o,1),o-=1;continue}if(t.has(i.id)){r.splice(o,1),o-=1;continue}t.add(i.id),Array.isArray(i.children)&&i.children.length&&n(i.children)}};n(e)}function Wc(){if(!J.blocksContainer)return;let e=new Set;J.blocksContainer.querySelectorAll(".block[data-block-id]").forEach(n=>{let r=n.getAttribute("data-block-id");if(r)if(e.has(r)){let o=n.parentNode;o&&o.removeChild(n)}else e.add(r)})}function Yc(){if(!J.blocksContainer||!u.article||!Array.isArray(u.article.blocks))return;let e=Pn(u.article.blocks),t=new Set(e.map(r=>r.id));J.blocksContainer.querySelectorAll(".block[data-block-id]").forEach(r=>{let o=r.getAttribute("data-block-id");if(o&&!t.has(o)){let i=r.parentNode;i&&i.removeChild(r)}})}function hs(e,t,n,r){if(!u.article||!e||!e.id)return;let o=Array.isArray(u.article.blockTrash)?u.article.blockTrash:[],i=r||new Date().toISOString();o.push({id:e.id,block:e,parentId:t||null,index:typeof n=="number"?n:null,deletedAt:i}),u.article.blockTrash=o}function Zo(e){if(!e||!J.blocksContainer)return;J.blocksContainer.querySelectorAll(`.block[data-block-id="${e}"]`).forEach(n=>{let r=n.parentElement;if(!r)return;let o=n.nextElementSibling;if(o&&o.classList.contains("block-children")){let i=o;o=o.nextElementSibling,i.parentNode===r&&r.removeChild(i)}n.parentNode===r&&r.removeChild(n)})}async function ws(e,t,n=1){for(let r of e){let o=document.createElement("div");o.className="block",o.dataset.blockId=r.id,typeof r.collapsed=="boolean"&&(o.dataset.collapsed=r.collapsed?"true":"false"),(r.id===u.currentBlockId||Array.isArray(u.selectedBlockIds)&&u.selectedBlockIds.includes(r.id))&&o.classList.add("selected"),r.id===u.editingBlockId&&o.classList.add("editing");let s=document.createElement("div");s.className="block-surface";let a=document.createElement("div");a.className="block-content";let c=_n(r.text||""),l=!!c.titleHtml,d=!!(c.bodyHtml&&c.bodyHtml.trim()),h=!!r.children?.length;if(!l&&h){let O=document.createElement("div");O.innerHTML=c.bodyHtml||r.text||"";let z=Array.from(O.childNodes||[]).filter(q=>q.nodeType===Node.TEXT_NODE?(q.textContent||"").trim().length>0:q.nodeType===Node.ELEMENT_NODE?q.tagName==="BR"?!1:q.tagName==="P"?(q.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim().length>0:!0:!1);if(z.length===1){let q=z[0];q.nodeType===Node.ELEMENT_NODE&&q.tagName==="P"&&(c={titleHtml:q.outerHTML,bodyHtml:""},l=!0,d=!1)}}let g=l||h,w=!l&&!h;o.classList.toggle("block--no-title",!l);let S=u.mode==="edit"&&u.editingBlockId===r.id,f=null;if(g||w){let O=document.createElement("button");O.className="collapse-btn",w?(O.classList.add("collapse-btn--placeholder"),O.setAttribute("aria-hidden","true"),O.removeAttribute("aria-expanded"),O.removeAttribute("title")):(O.setAttribute("aria-expanded",r.collapsed?"false":"true"),O.title=r.collapsed?"\u0420\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C":"\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C"),f=document.createElement("div"),f.className="block-header",l||f.classList.add("block-header--no-title");let z=document.createElement("div");if(z.className="block-header__left",z.appendChild(O),l){let q=Math.min(Math.max(n,1),6),$=document.createElement(`h${q}`);$.className="block-title",$.innerHTML=c.titleHtml||"",z.appendChild($)}else{let q=document.createElement("div");q.className="block-title-spacer",q.style.flex="1",q.style.minWidth="0",z.appendChild(q)}f.appendChild(z)}let p=document.createElement("div");p.className="block-text block-body";let y=S?xs(r.text||""):c.bodyHtml||"";if(p.innerHTML=y,(!y||!y.trim())&&(p.classList.add("block-body--empty"),S&&(p.innerHTML="<p><br /></p>")),p.classList.toggle("block-body--no-title",!l),S?(p.setAttribute("contenteditable","true"),p.setAttribute("spellcheck","false"),p.dataset.placeholder="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0442\u0435\u043A\u0441\u0442"):p.removeAttribute("contenteditable"),f&&a.appendChild(f),(S||!l||y)&&a.appendChild(p),u.articleId==="inbox"&&!S){let O=document.createElement("div");O.className="block-footer";let z=document.createElement("button");z.type="button",z.className="ghost small move-block-btn",z.innerHTML="&#10140;",z.title="\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0431\u043B\u043E\u043A \u0432 \u0434\u0440\u0443\u0433\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E",z.addEventListener("click",q=>{q.stopPropagation(),bs?bs(r.id):Ee("\u041F\u0435\u0440\u0435\u043D\u043E\u0441 \u0431\u043B\u043E\u043A\u0430 \u0432\u0440\u0435\u043C\u0435\u043D\u043D\u043E \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D")}),O.appendChild(z),a.appendChild(O)}if(s.appendChild(a),S&&("ontouchstart"in window||navigator.maxTouchPoints>0)&&a.addEventListener("click",z=>{let q=a.querySelector('.block-text[contenteditable="true"]');q&&(q.contains(z.target)||(z.stopPropagation(),q.focus(),u.editingCaretPosition==="start"?(q.scrollTop=0,Vi(q)):Oo(q)))}),Uc(s,r.id),S){let O=document.createElement("div");O.className="block-edit-actions";let z=document.createElement("button");z.type="button",z.className="ghost small block-attach-btn",z.innerHTML='<span class="block-attach-btn__icon">&#xE723;</span><span class="block-attach-btn__label">\u0424\u0430\u0439\u043B</span>',z.title="\u041F\u0440\u0438\u043A\u0440\u0435\u043F\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u0438\u043B\u0438 \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0443",z.addEventListener("click",Q=>{Q.preventDefault(),Q.stopPropagation();let W=o.querySelector('.block-text[contenteditable="true"]');if(!W)return;let re=document.createElement("input");re.type="file",re.multiple=!0,re.style.display="none",re.addEventListener("change",()=>{let we=Array.from(re.files||[]);we.length&&Is(W,we,r.id),re.remove()}),document.body.appendChild(re),re.click()});let q=document.createElement("button");q.type="button",q.className="ghost small",q.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C",q.addEventListener("click",async Q=>{Q.preventDefault(),Q.stopPropagation(),await Lc()});let $=document.createElement("button");$.type="button",$.className="ghost small",$.textContent="\u041E\u0442\u043C\u0435\u043D\u0430",$.addEventListener("click",Q=>{Q.preventDefault(),Q.stopPropagation(),Pc()}),O.appendChild(z),O.appendChild(q),O.appendChild($),a.appendChild(O)}ks(p,r.id),o.appendChild(s),o.addEventListener("click",O=>{if(O.stopPropagation(),u.isRagView&&u.ragBlockMap&&u.ragBlockMap[r.id]){let We=u.ragBlockMap[r.id];if(We&&We.articleId&&We.blockId){u.scrollTargetBlockId=We.blockId,u.currentBlockId=We.blockId,un(Yt.article(We.articleId));return}}let z=O.target.closest('button, a, [contenteditable="true"], .block-edit-actions'),q=o.querySelector(".block-header"),$=o.querySelector(".block-text.block-body"),Q=!!q,W=!!(q&&!q.classList.contains("block-header--no-title")),re=Q&&q.contains(O.target),we=$&&$.contains(O.target),Ne=W,Z=u.currentBlockId===r.id,pe=!1;(Ne&&re||!Ne&&Z&&we&&!z)&&(pe=!0),pe&&As(r.id),Wn(r.id)}),s.addEventListener("dblclick",O=>{if(u.mode!=="view"||u.isPublicView||u.isRagView)return;let z=O.target.closest('button, a, [contenteditable="true"]');z&&!z.matches('.block-text[contenteditable="true"]')||(O.stopPropagation(),Wn(r.id),Mc())});let E=r.collapsed&&r.id!==u.editingBlockId&&l;p.classList.contains("block-body--empty")||p.classList.toggle("collapsed",E);let L=null;r.children?.length>0&&!r.collapsed&&(L=document.createElement("div"),L.className="block-children",await ws(r.children,L,n+1)),t.appendChild(o),L&&(S?t.appendChild(L):o.appendChild(L))}}async function Xt(e){if(!u.article||!Array.isArray(u.article.blocks))return;let t=lt(e);if(!t)return;let n=(Array.isArray(t.ancestors)?t.ancestors.length:0)+1,r=document.querySelector(`.block[data-block-id="${e}"]`);if(!r)return;let o=r.parentElement;if(!o)return;let i=[],s=r.nextElementSibling;s&&s.classList.contains("block-children")&&i.push(s);let a=(i[i.length-1]||r).nextSibling;o.removeChild(r),i.forEach(d=>{d.parentNode===o&&o.removeChild(d)});let c=document.createElement("div");await ws([t.block],c,n),Array.from(c.childNodes).forEach(d=>{o.insertBefore(d,a)}),Wc(),Yc()}function _t(){let e=u.article;if(!e)return;if(!u.isPublicView&&!u.isRagView&&u.isOutlineEditing){Ht(),Yr();return}Array.isArray(e.blocks)&&Sf(e.blocks),Ht();let t=e.id==="inbox"?[...e.blocks||[]].reverse():e.blocks;Yr(),J.blocksContainer.innerHTML="",Mr(),Jc(),Vc();let n=()=>{if(u.mode!=="edit"||!u.editingBlockId||u.editingCaretPosition==="start")return;let r=J.blocksContainer?.querySelector(`.block[data-block-id="${u.editingBlockId}"] .block-text[contenteditable="true"]`);if(!r)return;let o=document.activeElement;r===o||r.contains(o)||(r.focus({preventScroll:!0}),r.scrollHeight>r.clientHeight&&(r.scrollTop=r.scrollHeight),Oo(r))};ws(t,J.blocksContainer).then(()=>{if(Yc(),Wc(),kc(),u.scrollTargetBlockId&&u.mode==="view"){let r=u.scrollTargetBlockId;requestAnimationFrame(()=>{let o=document.querySelector(`.block[data-block-id="${r}"]`);if(o){(o.querySelector(".block-content")||o).scrollIntoView({behavior:"smooth",block:"nearest"});let s=o.querySelector('.block-text[contenteditable="true"]');s&&u.mode==="edit"&&u.editingBlockId===r?(s.focus({preventScroll:!0}),u.editingCaretPosition==="start"?(s.scrollTop=0,Vi(s)):Oo(s)):(o.setAttribute("tabindex","-1"),o.focus({preventScroll:!0}))}u.currentBlockId=r,u.scrollTargetBlockId=null})}n(),u.mode==="edit"&&typeof u.editingScrollTop=="number"&&J.blocksContainer&&(J.blocksContainer.scrollTop=u.editingScrollTop)})}var bs,Ss=je(()=>{bt();ln();Wt();Ft();Jn();ms();In();En();En();Kn();cr();jn();Xr();so();bs=null});function xf(){try{let e=window?.localStorage?.getItem?.(Xc)||"";if(!e)return[];let t=JSON.parse(e);return Array.isArray(t)?t.filter(Boolean):[]}catch{return[]}}function Af(e){try{window?.localStorage?.setItem?.(Xc,JSON.stringify(Array.isArray(e)?e:[]))}catch{}}function Gc(e){let t=String(e||"").trim();if(!t)return!1;let n=xf(),r=n.filter(o=>String(o?.sectionId||o?.id||"")!==t);return r.length===n.length?!1:(Af(r),!0)}async function If(){let e=await fetch("/api/articles/inbox?include_history=0",{method:"GET",credentials:"include"});if(e.status===401||e.status===403){let t=new Error("auth");throw t.status=e.status,t}if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()}async function Qc(){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return{status:"offline"};let e=await If(),t=new Date().toISOString();try{e?.docJson&&typeof e.docJson=="object"&&await nn("inbox",e.docJson,t)}catch{}return{status:"refreshed",updatedAt:e?.updatedAt||null,docJson:e?.docJson||null}}var Xc,vs=je(()=>{jr();Jr();Xc="ttree_pending_quick_notes_v1"});async function kf(e){try{let n=(u.articlesIndex.length?u.articlesIndex:await dn()).filter(d=>d.id!=="inbox"),r=n.map(d=>({id:d.id,title:d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),o=await Vn({title:"\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0432 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0438\u043B\u0438 \u0432\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E",confirmText:"\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:r,returnMeta:!0,hideConfirm:!1}),s=(o?.selectedId||(typeof o=="object"?o?.value:o)||""||"").trim();if(!s)return;let a=s.toLowerCase(),c=n.find(d=>d.id&&d.id.toLowerCase()===a||(d.title||"").toLowerCase()===a),l=c?c.id:s;if(!l||l==="inbox"){Ee("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}await apiRequest(`/api/articles/${u.articleId}/blocks/${e}/move-to/${l}`,{method:"POST"}),await Ln("inbox",{resetUndoStacks:!0}),_t(),Ee("\u0411\u043B\u043E\u043A \u043F\u0435\u0440\u0435\u043D\u0435\u0441\u0451\u043D")}catch(t){Ee(t.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0431\u043B\u043E\u043A")}}async function Ho(e){try{String(e||"").startsWith("inbox-")&&(e="inbox")}catch{}u.isPublicView=!1,u.isRagView=!1,document.body.classList.remove("public-embedded"),u.isEditingTitle=!1,await no(),eo(!0),J.usersView&&J.usersView.classList.add("hidden"),J.blocksContainer.innerHTML="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...";try{if(e==="RAG"){u.isRagView=!0,u.mode="view",u.editingBlockId=null,u.pendingEditBlockId=null,u.scrollTargetBlockId=null,u.ragBlockMap={},Yo("RAG");let r=(u.ragQuery||"").trim(),o=Array.isArray(u.ragResults)?u.ragResults:[],i=o.length,s=Array.from(new Set(o.map(h=>h&&h.articleTitle?String(h.articleTitle):"").filter(Boolean))),a=s.slice(0,8),c=["<p><strong>\u0421\u0432\u043E\u0434\u043A\u0430</strong></p>"];u.ragSummaryLoading?c.push('<p class="meta">\u0413\u0435\u043D\u0435\u0440\u0438\u0440\u0443\u044E \u0441\u0432\u043E\u0434\u043A\u0443\u2026</p>'):u.ragSummaryError?c.push(`<p class="meta">\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0432\u043E\u0434\u043A\u0438: ${u.ragSummaryError}</p>`):u.ragSummaryHtml?c.push(u.ragSummaryHtml):c.push('<p class="meta">\u0421\u0432\u043E\u0434\u043A\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435 \u0433\u043E\u0442\u043E\u0432\u0430.</p>');let l=["<p><strong>AI-\u043F\u043E\u0438\u0441\u043A: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B</strong></p>",`<p><span class="meta">\u0417\u0430\u043F\u0440\u043E\u0441:</span> ${r||"\u2014"}</p>`,`<p><span class="meta">\u041D\u0430\u0439\u0434\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432:</span> ${i}</p>`];a.length&&l.push(`<p><span class="meta">\u0421\u0442\u0430\u0442\u044C\u0438:</span> ${a.join(" \xB7 ")}</p>`),s.length>a.length&&l.push(`<p><span class="meta">\u2026\u0438 \u0435\u0449\u0451:</span> ${s.length-a.length}</p>`);let d=[{id:"rag-ai-summary",text:c.join(""),children:[],collapsed:!1},{id:"rag-meta",text:l.join(""),children:[],collapsed:!1},...o.filter(h=>h&&h.type==="block").map((h,g)=>{let w=h.blockText||"",S=h.articleTitle?String(h.articleTitle):"",f=S?`<p><strong>${S}</strong></p>`:`<p><strong>\u0420\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442 ${g+1}</strong></p>`,p=`rag-${h.blockId||g}`;return h.articleId&&h.blockId&&(u.ragBlockMap[p]={articleId:h.articleId,blockId:h.blockId}),{id:p,text:`${f}${w}`,children:[],collapsed:!1}})];u.article={id:"RAG",title:r?`AI: ${r}`:"AI: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B \u043F\u043E\u0438\u0441\u043A\u0430",blocks:d,updated_at:new Date().toISOString()},u.articleId="RAG",u.currentBlockId=d[0]?.id||null,_t();return}let t=u.pendingEditBlockId||void 0,n=u.scrollTargetBlockId||void 0;if(await Ln(e,{resetUndoStacks:!0,desiredBlockId:n,editBlockId:t}),_t(),Yo(e),e==="inbox"&&navigator.onLine&&u.serverStatus==="ok")try{await Qc().catch(()=>{}),u.articleId==="inbox"&&!u.editingBlockId&&(await Ln("inbox",{resetUndoStacks:!1}),_t())}catch{}}catch(t){J.blocksContainer.innerHTML=`<p class="meta">\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u044C\u044E: ${t.message}</p>`}}async function Qi(){u.isPublicView=!1,u.isRagView=!1,document.body.classList.remove("public-embedded"),J.usersView&&J.usersView.classList.add("hidden"),u.article=null,u.articleId=null,u.currentBlockId=null,u.isEditingTitle=!1,u.mode="view",u.editingBlockId=null,u.undoStack=[],u.redoStack=[],u.pendingEditBlockId=null,Xo({restoreDom:!1}),eo(!1),Mr();try{if(u.isTrashView){let e=await Ko();vn(e)}else{let e=await no();vn(e)}}catch(e){J.articleList.innerHTML=`<li>\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u043F\u0438\u0441\u043E\u043A: ${e.message}</li>`}}async function Zi(e){u.isPublicView=!0,u.isRagView=!1,document.body.classList.add("public-embedded"),J.usersView&&J.usersView.classList.add("hidden"),eo(!0),u.isEditingTitle=!1,u.mode="view",u.editingBlockId=null,u.pendingEditBlockId=null,u.selectionAnchorBlockId=null,u.selectedBlockIds=[],u.undoStack=[],u.redoStack=[],Xo({restoreDom:!1}),J.blocksContainer&&(J.blocksContainer.innerHTML="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...");try{let t=await apiRequest(`/api/public/articles/${encodeURIComponent(e)}`,{method:"GET",credentials:"omit"});u.article=t,u.articleId=t?.id||null;let n=Pn(t?.blocks||[])[0];u.currentBlockId=n?n.id:null,_t()}catch(t){J.blocksContainer&&(J.blocksContainer.innerHTML=`<p class="meta">\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E: ${t.message}</p>`)}}var Zc=je(()=>{bt();ln();Wt();Ft();Jn();jn();Kn();Kn();Kn();cr();En();fs();Ss();so();vs();Kc(kf)});var ar=je(()=>{Xr();ds();fs();Ss();Zc();so();so();Mr()});function Pn(e=[],t=[]){return(e||[]).forEach(n=>{t.push(n),n.children&&n.children.length>0&&!n.collapsed&&Pn(n.children,t)}),t}function lt(e,t=u.article?.blocks||[],n=null,r=[]){for(let o=0;o<t.length;o+=1){let i=t[o];if(i.id===e)return{block:i,parent:n,index:o,siblings:t,ancestors:r};let s=lt(e,i.children||[],i,[...r,i]);if(s)return s}return null}function ao({scrollIntoView:e=!1,scrollBehavior:t="smooth"}={}){let n=new Set(Array.isArray(u.selectedBlockIds)?u.selectedBlockIds:[]);if(u.currentBlockId&&n.add(u.currentBlockId),document.querySelectorAll(".block[data-block-id]").forEach(o=>{let i=o.getAttribute("data-block-id"),s=i&&n.has(i);o.classList.toggle("selected",!!s),o.classList.remove("block--selected-root-ancestor");let a=o.querySelector(":scope > .block-surface");a&&a.classList.remove("block--selected-root-ancestor")}),u.currentBlockId&&u.article&&Array.isArray(u.article.blocks)){let o=lt(u.currentBlockId),i=o?.ancestors||[],s=i.length>0?i[0]?.id:o?.block?.id;if(s){let a=document.querySelector(`.block[data-block-id="${s}"]`);if(a){let c=a.querySelector(":scope > .block-surface");c&&c.classList.add("block--selected-root-ancestor")}}}if(e&&u.mode==="view"&&u.currentBlockId){let o=document.querySelector(`.block[data-block-id="${u.currentBlockId}"]`);o&&o.scrollIntoView({behavior:t||"smooth",block:"nearest"})}}function el(e,t={}){if(!e||u.currentBlockId===e)return;let{preserveSelection:n=!1,scrollIntoView:r,scrollBehavior:o}=t;u.currentBlockId=e,n||(u.selectionAnchorBlockId=null,u.selectedBlockIds=[]);let i=typeof r=="boolean"?r:u.mode==="view";ao({scrollIntoView:i,scrollBehavior:o||"smooth"})}function Wn(e,t={}){el(e,{preserveSelection:!1,...t})}function tl(e){if(!u.article)return;let t=Pn(u.article.blocks),n=t.findIndex(o=>o.id===u.currentBlockId);if(n===-1)return;let r=t[n+e];r&&(u.mode==="view"&&(u.scrollTargetBlockId=r.id),el(r.id,{preserveSelection:!1}))}function nl(e){if(!u.article)return;let t=Pn(u.article.blocks);if(!t.length)return;let n=u.selectionAnchorBlockId||u.currentBlockId||t[0].id;n||(n=t[0].id),u.selectionAnchorBlockId||(u.selectionAnchorBlockId=n);let r=t.findIndex(d=>d.id===n);if(r===-1)return;let o=u.currentBlockId||n,i=t.findIndex(d=>d.id===o);i===-1&&(i=r);let s=i+e;if(s<0||s>=t.length)return;let[a,c]=s>=r?[r,s]:[s,r],l=t.slice(a,c+1).map(d=>d.id);u.selectedBlockIds=l,u.currentBlockId=t[s].id,u.mode==="view"&&(u.scrollTargetBlockId=u.currentBlockId),ao({scrollIntoView:u.mode==="view"})}var rl=je(()=>{bt();ln()});function Yn(e){return e?e.nodeType===Node.TEXT_NODE?/\n\s*\n/.test(e.textContent||""):e.nodeType===Node.ELEMENT_NODE&&(e.tagName==="BR"||(e.tagName==="P"||e.tagName==="DIV")&&(!(e.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&(nbsp|#160);/gi,"").trim()||!(e.textContent||"").replace(/\u00a0/g,"").trim()&&!e.querySelector("img"))):!1}function ri(e=[]){let t=document.createElement("div");return e.forEach(n=>t.appendChild(n)),t.innerHTML.trim()}function Es(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=[],r=(i="")=>{let s=document.createElement("p");i?s.innerHTML=i:s.appendChild(document.createElement("br")),n.push(s)};Array.from(t.content.childNodes).forEach(i=>{if(i.nodeType===Node.TEXT_NODE){let s=(i.textContent||"").trim();s&&r(s);return}if(i.nodeType===Node.ELEMENT_NODE){if(i.tagName==="P"){n.push(i.cloneNode(!0));return}if(i.tagName==="BR"){r("");return}if(i.tagName==="DIV"){r(i.innerHTML);return}r(i.outerHTML)}}),n.length||r("");let o=document.createElement("div");return n.forEach(i=>o.appendChild(i)),o.innerHTML}function _n(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll(".block-header").forEach(h=>{let g=h.parentNode;if(g){for(;h.firstChild;)g.insertBefore(h.firstChild,h);g.removeChild(h)}});let n=Array.from(t.content.childNodes),r=h=>h?.nodeType===Node.TEXT_NODE&&!(h.textContent||"").trim(),o=0;for(;o<n.length&&r(n[o]);)o+=1;let i=n[o];if(!i||i.nodeType!==Node.ELEMENT_NODE||i.tagName!=="P"||Yn(i))return{titleHtml:"",bodyHtml:ri(n)};let s=o+1;for(;s<n.length&&r(n[s]);)s+=1;let a=n[s];if(!(!!a&&Yn(a)&&(a.nodeType===Node.ELEMENT_NODE?a.tagName==="P"||a.tagName==="DIV"||a.tagName==="BR":!1)))return{titleHtml:"",bodyHtml:ri(n)};let l=[i.cloneNode(!0)],d=[];for(let h=s+1;h<n.length;h+=1)d.push(n[h].cloneNode(!0));return{titleHtml:ri(l),bodyHtml:ri(d)}}function ol({event:e,element:t,range:n,selection:r,notifyEditingInput:o,logDebug:i}){if(!e||!t||!n||!r||!n.collapsed)return!1;let s=e.key==="Backspace"||e.code==="Backspace"||e.keyCode===8,a=e.key==="Delete"||e.key==="Del"||e.code==="Delete"||e.code==="Del"||e.keyCode===46;if(!s&&!a)return!1;let c=p=>{try{r.removeAllRanges(),r.addRange(p)}catch{}try{t.focus({preventScroll:!0})}catch{t.focus()}},l=p=>{let k=(n.commonAncestorContainer?.nodeType===Node.ELEMENT_NODE?n.commonAncestorContainer:n.commonAncestorContainer?.parentElement)?.closest?.("p");if(k)return k;let E=t,L=Array.from(E.childNodes),O=n.startContainer;for(;O&&O.parentNode!==E;)O=O.parentNode;let z=O?L.indexOf(O):-1,q=$=>{let Q=$==="prev"?-1:1,W=z;for(W===-1?W=$==="prev"?L.length-1:0:W=$==="prev"?W-1:W;W>=0&&W<L.length;){let re=L[W];if(re?.nodeType===Node.ELEMENT_NODE&&re.tagName==="P")return re;W+=Q}return null};return p==="Delete"?q("next")||q("prev"):p==="Backspace"?q("prev")||q("next"):null},d=()=>{if(n.startContainer!==t)return{prev:null,next:null};let p=Array.from(t.childNodes),y=n.startOffset,k=null,E=null;for(let L=y-1;L>=0;L-=1){let O=p[L];if(O?.nodeType===Node.ELEMENT_NODE&&O.tagName==="P"){k=O;break}}for(let L=y;L<p.length;L+=1){let O=p[L];if(O?.nodeType===Node.ELEMENT_NODE&&O.tagName==="P"){E=O;break}}return{prev:k,next:E}},h=p=>{let y=p?.previousElementSibling;for(;y&&y.tagName!=="P";)y=y.previousElementSibling;return y&&y.tagName==="P"?y:null},g=p=>{let y=p?.nextElementSibling;for(;y&&y.tagName!=="P";)y=y.nextElementSibling;return y&&y.tagName==="P"?y:null},w=p=>{if(!p)return!0;let y=new Set(["span","b","strong","i","em","u","s","mark","code"]),k=new Set(["img","video","audio","iframe"]),E=L=>{if(!L)return!1;if(L.nodeType===Node.TEXT_NODE)return(L.textContent||"").replace(/\u00a0/g,"").replace(/[\u200B-\u200D\uFEFF]/g,"").trim().length>0;if(L.nodeType!==Node.ELEMENT_NODE)return!1;let O=(L.tagName||"").toLowerCase();return O==="br"?!1:k.has(O)?!0:O==="span"&&(L.getAttribute("class")||"").includes("resizable-image__handle")?!1:y.has(O)?Array.from(L.childNodes||[]).some(E):!0};return!Array.from(p.childNodes||[]).some(E)},S=p=>{if(!p)return!1;let y=document.createRange();y.selectNodeContents(p);try{y.setEnd(n.startContainer,n.startOffset)}catch{return!1}if(w(y.cloneContents()))return!0;try{let k=document.createRange();return k.selectNodeContents(p),k.collapse(!0),n.compareBoundaryPoints(Range.START_TO_START,k)===0}catch{return!1}},f=p=>{if(!p)return!1;let y=document.createRange();y.selectNodeContents(p);try{y.setStart(n.startContainer,n.startOffset)}catch{return!1}if(w(y.cloneContents()))return!0;try{let k=document.createRange();return k.selectNodeContents(p),k.collapse(!1),n.compareBoundaryPoints(Range.END_TO_END,k)===0}catch{return!1}};if(window.__debugMergeP&&i("mergeP.keydown",{key:e.key,code:e.code,keyCode:e.keyCode,startContainer:n.startContainer?.nodeName,startOffset:n.startOffset,collapsed:n.collapsed}),s){if(n.startContainer===t){let E=d();if(E.prev&&E.next){e.preventDefault(),e.stopPropagation();let L=document.createRange();for(L.selectNodeContents(E.prev),L.collapse(!1);E.next.firstChild;)E.prev.appendChild(E.next.firstChild);return E.next.remove(),c(L),o(t),!0}return!1}let p=l("Backspace");if(!p||!t.contains(p)||!S(p))return!1;let y=h(p);if(!y||!t.contains(y))return!1;e.preventDefault(),e.stopPropagation();let k=document.createRange();for(k.selectNodeContents(y),k.collapse(!1);p.firstChild;)y.appendChild(p.firstChild);return p.remove(),c(k),o(t),!0}if(a){let p=l("Delete");if(!p||!t.contains(p)){let E=d();if(E.prev&&E.next){e.preventDefault(),e.stopPropagation();let L=document.createRange();for(L.selectNodeContents(E.prev),L.collapse(!1);E.next.firstChild;)E.prev.appendChild(E.next.firstChild);return E.next.remove(),c(L),o(t),!0}return!1}if(!f(p))return!1;let y=g(p);if(!y||!t.contains(y))return!1;e.preventDefault(),e.stopPropagation();let k=document.createRange();for(k.selectNodeContents(p),k.collapse(!1);y.firstChild;)p.appendChild(y.firstChild);return y.remove(),c(k),o(t),!0}return!1}var Cs=je(()=>{});function co(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=r=>{if(r&&!(r.nodeType===Node.ELEMENT_NODE&&r.tagName==="A")){if(r.nodeType===Node.TEXT_NODE){let o=r.textContent||"";if(oi.lastIndex=0,!oi.test(o))return;let s=document.createDocumentFragment(),a=0;oi.lastIndex=0;let c;for(;(c=oi.exec(o))!==null;){let[l]=c;c.index>a&&s.appendChild(document.createTextNode(o.slice(a,c.index)));let d=l.startsWith("http")?l:`https://${l}`,h=document.createElement("a");h.href=d,h.target="_blank",h.rel="noopener noreferrer",h.textContent=l,s.appendChild(h),a=c.index+l.length}a<o.length&&s.appendChild(document.createTextNode(o.slice(a))),r.parentNode&&r.parentNode.replaceChild(s,r);return}Array.from(r.childNodes||[]).forEach(n)}};return Array.from(t.content.childNodes).forEach(n),t.innerHTML}function il(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll("script, style").forEach(o=>o.remove());let n=(o="")=>/^javascript:/i.test(o.trim()),r=o=>{if(!o||o.nodeType!==Node.ELEMENT_NODE){Array.from(o?.childNodes||[]).forEach(r);return}Array.from(o.attributes||[]).forEach(i=>{let s=i.name.toLowerCase(),a=i.value||"";if(s.startsWith("on")||s==="style"){o.removeAttribute(i.name);return}(s==="href"||s==="src")&&n(a)&&o.removeAttribute(i.name)}),Array.from(o.childNodes||[]).forEach(r)};return Array.from(t.content.childNodes||[]).forEach(r),t.innerHTML}function ii(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=r=>{if(!r)return!0;if(r.nodeType===Node.TEXT_NODE)return!(r.textContent||"").replace(/\u00a0/g,"").trim();if(r.nodeType!==Node.ELEMENT_NODE)return!1;if(r.tagName==="BR")return!0;let o=(r.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&nbsp;/gi,"").trim(),i=(r.textContent||"").replace(/\u00a0/g,"").trim(),s=!!r.querySelector("img,video,audio,iframe");return!o&&!i&&!s};for(;t.content.firstChild&&n(t.content.firstChild);)t.content.removeChild(t.content.firstChild);for(;t.content.lastChild&&n(t.content.lastChild);)t.content.removeChild(t.content.lastChild);return t.innerHTML}function sl(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=(t.content.textContent||"").replace(/\u00a0/g," ").trim(),r=!!t.content.querySelector("a"),o=!1;{let S=Array.from(t.content.childNodes||[]);for(let f=0;f<S.length;f+=1){let p=S[f];if(p.nodeType===Node.TEXT_NODE){if(!(p.textContent||"").trim())continue;break}Yn(p)&&(o=!0);break}}let i=document.createElement("template");i.innerHTML=e||"",i.content.querySelectorAll("img").forEach(S=>{let f=String(S.getAttribute("src")||"").trim();if(!/^(blob:|filesystem:)/i.test(f))return;let p=String(S.getAttribute("alt")||"").trim()||"image",y=S.closest?.(".resizable-image")||S;try{y.replaceWith(document.createTextNode(`[${p} \u2014 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0431\u044B\u043B\u043E blob: \u0438 \u043D\u0435 \u0431\u044B\u043B\u043E \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E]`))}catch{}});let a=(()=>{if(!Array.from(i.content.childNodes||[]).length)return!1;let f=Array.from(i.content.querySelectorAll("p"));if(f.length<2)return!1;let p=Z=>{let pe=Z.trim();return pe.startsWith("|")&&pe.indexOf("|",1)!==-1},k=f.map(Z=>(Z.textContent||"").replace(/\u00a0/g," ").trim()).filter(Z=>Z);if(k.length<2||!k.every(p))return!1;let E=k.map(Z=>{let pe=Z.trim();return(pe.endsWith("|")?pe.slice(1,-1):pe.slice(1)).split("|").map(yt=>yt.trim())}),L=E[0],O=E.slice(1),z=O.reduce((Z,pe)=>Math.max(Z,pe.length),L.length),q=document.createElement("table");q.className="memus-table";let $=document.createElement("colgroup"),Q=100/Math.max(z,1);for(let Z=0;Z<z;Z+=1){let pe=document.createElement("col");pe.setAttribute("width",`${Q.toFixed(4)}%`),$.appendChild(pe)}q.appendChild($);let W=document.createElement("thead"),re=document.createElement("tr");for(let Z=0;Z<z;Z+=1){let pe=document.createElement("th");pe.textContent=L[Z]||"",re.appendChild(pe)}W.appendChild(re),q.appendChild(W);let we=document.createElement("tbody");return O.forEach(Z=>{let pe=document.createElement("tr"),We=[...Z];for(let yt=0;yt<z;yt+=1){let kt=document.createElement("td");kt.textContent=We[yt]||"",pe.appendChild(kt)}we.appendChild(pe)}),q.appendChild(we),i.content.innerHTML="",i.content.appendChild(q),co(i.innerHTML).replace(/<\/a>\s*<a/gi,"</a> <a")})();if(a)return a;i.content.querySelectorAll(".table-toolbar, .table-toolbar-btn").forEach(S=>{S.remove()}),i.content.querySelectorAll(".block-header").forEach(S=>{let f=S.parentNode;if(f){for(;S.firstChild;)f.insertBefore(S.firstChild,S);f.removeChild(S)}});let c=S=>{Array.from(S.childNodes).forEach(f=>{if(f.nodeType===Node.ELEMENT_NODE){if(f.tagName==="DIV"){let p=document.createElement("p");p.innerHTML=f.innerHTML,f.parentNode.replaceChild(p,f),c(p);return}c(f)}})};c(i.content),(S=>{Array.from(S.childNodes||[]).forEach(p=>{if(p.nodeType===Node.TEXT_NODE){let k=(p.textContent||"").replace(/\u00a0/g," ");if(!k.trim()){if(p.previousSibling&&p.nextSibling){p.textContent=" ";return}S.removeChild(p);return}let L=document.createElement("p");L.textContent=k,S.replaceChild(L,p)}})})(i.content),i.content.querySelectorAll("p").forEach(S=>{(S.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim()||(S.innerHTML="",S.appendChild(document.createElement("br")))});let d=i.content;if(!!d.querySelector("p")){if(o){let S=Array.from(d.childNodes||[]),f=null;for(let p=0;p<S.length;p+=1){let y=S[p];if(!(y.nodeType===Node.TEXT_NODE&&!(y.textContent||"").trim())){f=y;break}}if(f){if(!(f.tagName==="P"&&Yn(f))){let p=document.createElement("p");p.appendChild(document.createElement("br")),d.insertBefore(p,f)}}else{let p=document.createElement("p");p.appendChild(document.createElement("br")),d.appendChild(p)}}}else{let S=document.createElement("p");S.appendChild(document.createElement("br")),d.appendChild(S)}let w=co(i.innerHTML).replace(/<\/a>\s*<a/gi,"</a> <a");return!w.trim()&&(n||r)?e||"":w}var oi,al=je(()=>{Cs();oi=/((?:https?:\/\/|www\.)[^\s<>"']+)/gi});function Xn(e){if(!e)return;if(!(e.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&nbsp;/gi,"").trim()){e.innerHTML="";let n=document.createRange();n.selectNodeContents(e),n.collapse(!0);let r=window.getSelection();r&&(r.removeAllRanges(),r.addRange(n))}}var Ts=je(()=>{});function dr(e){if(!e)return!1;if(e.type&&e.type.startsWith("image/"))return!0;let t=(e.name||"").toLowerCase();return t?/\.(png|jpe?g|gif|webp|bmp|svg|heic|heif)$/i.test(t):!1}function Bs(e=[],t=[]){let n=[];return Array.from(e||[]).forEach(r=>{if(r.kind==="file"){let o=typeof r.getAsFile=="function"?r.getAsFile():null;o&&dr(o)&&n.push(o)}}),!n.length&&t?.length&&Array.from(t).forEach(r=>{dr(r)&&n.push(r)}),n}function Ns(e=[],t=[]){let n=[];return Array.from(e||[]).forEach(r=>{if(r.kind==="file"){let o=typeof r.getAsFile=="function"?r.getAsFile():null;o&&!dr(o)&&n.push(o)}}),!n.length&&t?.length&&Array.from(t).forEach(r=>{dr(r)||n.push(r)}),n}async function si(e,t,n){let r=`img-${Date.now()}-${Math.random().toString(16).slice(2)}`,o=t&&t.name?t.name:"image",i=Rt(o).replace(/"/g,"&quot;");try{Xn(e),Hn(e,`<span data-pending-image="true" data-image-token="${r}">${i} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F...)</span>`)}catch{}try{let{url:s}=await Wr(t),c=`
      <span class="resizable-image" style="width:320px;max-width:100%;">
        <span class="resizable-image__inner">${`<img src="${s}" alt="${i}" draggable="false" />`}</span>
        <span class="resizable-image__handle" data-direction="e" aria-hidden="true"></span>
      </span>
    `,l=e,d=l&&l.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`);if(n&&(!d||!l.isConnected)){let h=document.querySelector(`.block[data-block-id="${n}"]`);if(h){let w=h.querySelector('.block-text[contenteditable="true"]')||h.querySelector(".block-text.block-body");w&&(l=w,d=l.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`))}}d?(d.removeAttribute("data-pending-image"),d.removeAttribute("data-image-token"),d.outerHTML=c):l&&(Xn(l),Hn(l,c))}catch(s){try{let c=e;if(n&&!c.isConnected){let l=document.querySelector(`.block[data-block-id="${n}"]`);if(l){let h=l.querySelector('.block-text[contenteditable="true"]')||l.querySelector(".block-text.block-body");h&&(c=h)}}if(c){let l=c.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`);l&&(l.textContent=`${o} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F)`,l.removeAttribute("data-pending-image"))}}catch{}try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"insertImageFromFileError",data:{message:s&&s.message?String(s.message):String(s),name:t&&t.name,type:t&&t.type,size:t&&t.size}})}).catch(()=>{})}catch{}try{let c={where:"insertImageFromFile",message:s&&s.message?String(s.message):String(s),status:typeof s?.status=="number"?s.status:null,name:t&&t.name,type:t&&t.type,size:t&&t.size},l=c.status===null?"null":String(c.status);window.alert(`upload failed (status ${l}):\\n${JSON.stringify(c,null,2)}`)}catch{}let a=String(s?.message||"").toLowerCase();a.includes("status 0")||a.includes("network error")?Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 (\u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C). \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438, \u043F\u0440\u0438 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u043E\u0441\u0442\u0438, \u0432\u043E\u0439\u0434\u0438\u0442\u0435 \u0437\u0430\u043D\u043E\u0432\u043E."):Ee(s.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435")}}function vf(e){if(e.button!==0)return;let t=e.target?.closest(".resizable-image__handle");if(!t)return;let n=t.closest(".resizable-image"),o=n?.closest(".block")?.dataset?.blockId;if(!n||!o||u.mode!=="edit"||u.editingBlockId!==o)return;e.preventDefault(),e.stopPropagation();let i=n.getBoundingClientRect();Gn={wrapper:n,startWidth:i.width,startX:e.clientX},n.classList.add("resizable-image--resizing")}function Ef(e){if(!Gn)return;e.preventDefault();let t=e.clientX-Gn.startX,r=parseFloat(getComputedStyle(document.documentElement).fontSize)||16,o=Math.max(r,document.documentElement.clientWidth-32),i=Gn.startWidth+t;i=Math.max(r,Math.min(i,o)),Gn.wrapper.style.width=`${i}px`}function ll(){Gn&&(Gn.wrapper.classList.remove("resizable-image--resizing"),Gn=null)}function dl(){cl||(cl=!0,document.addEventListener("pointerdown",vf),document.addEventListener("pointermove",Ef),document.addEventListener("pointerup",ll),document.addEventListener("pointercancel",ll))}var Gn,cl,ul=je(()=>{bt();Wt();Ft();In();Ts();Gn=null,cl=!1});function fl({listTag:e,resolveTarget:t,restoreSelection:n,richContextRange:r,notifyEditingInput:o,setRichContextRange:i}){let s=t();if(!s||!document.contains(s))return;n();let a=window.getSelection(),c=null;if(r&&s.contains(r.commonAncestorContainer))c=r.cloneRange();else if(a&&a.rangeCount>0){let k=a.getRangeAt(0);s.contains(k.commonAncestorContainer)&&(c=k.cloneRange())}c||(c=document.createRange(),c.selectNodeContents(s),c.collapse(!1));let l=c.startContainer?.nodeType===Node.ELEMENT_NODE?c.startContainer:c.startContainer?.parentElement,d=l?.closest?.("li"),h=d?.closest?.("ol,ul"),g=k=>{if(!k)return;let E=document.createRange();E.selectNodeContents(k),E.collapse(!1),a&&(a.removeAllRanges(),a.addRange(E)),i(E);try{s.focus({preventScroll:!0})}catch{s.focus()}s.classList.remove("block-body--empty"),o(s)},w=k=>{let E=k.parentElement?.tagName==="P"&&k.parentElement.childNodes.length===1?k.parentElement:k,L=Array.from(k.children||[]).filter(q=>q.nodeType===Node.ELEMENT_NODE&&q.tagName==="LI"),O=document.createDocumentFragment(),z=[];L.forEach(q=>{let $=document.createElement("p");for(;q.firstChild;)$.appendChild(q.firstChild);z.push($),O.appendChild($)}),E.replaceWith(O),g(z[0]||null)};if(h){if(h.tagName.toLowerCase()===e){w(h);return}let E=document.createElement(e);for(;h.firstChild;)E.appendChild(h.firstChild);h.replaceWith(E),g(d||E.lastElementChild||E);return}let S=()=>{if(!c.collapsed)return null;let k=l?.closest?.("p")||null;if(k&&s.contains(k))return k;if(c.startContainer===s){let E=Array.from(s.childNodes),L=c.startOffset;for(let O=L-1;O>=0;O-=1){let z=E[O];if(z?.nodeType===Node.ELEMENT_NODE&&z.tagName==="P")return z}for(let O=L;O<E.length;O+=1){let z=E[O];if(z?.nodeType===Node.ELEMENT_NODE&&z.tagName==="P")return z}}return null},f=[];if(c.collapsed){let k=S();k&&(f=[k])}else if(f=Array.from(s.querySelectorAll(":scope > p")).filter(E=>{try{return c.intersectsNode(E)}catch{return!1}}),!f.length){let E=l?.closest?.("p");E&&s.contains(E)&&(f=[E])}if(!f.length)return;let p=document.createElement(e);f.forEach(k=>{let E=document.createElement("li");for(;k.firstChild;)E.appendChild(k.firstChild);p.appendChild(E)}),f[0].replaceWith(p),f.slice(1).forEach(k=>k.remove()),g(p.firstElementChild||p)}var pl=je(()=>{});var ys={};vo(ys,{applyEditingUndoStep:()=>Mf,attachRichContentHandlers:()=>ks,buildEditableBlockHtml:()=>xs,buildStoredBlockHtml:()=>Nc,cleanupEditableHtml:()=>sl,clearEditingUndoSession:()=>Nf,countBlocks:()=>gs,ensureBlockVisible:()=>us,expandCollapsedAncestors:()=>Pf,extendSelection:()=>nl,extractBlockSections:()=>_n,findBlock:()=>lt,findCollapsibleTarget:()=>Lf,findFallbackBlockId:()=>ei,flattenVisible:()=>Pn,initEditingUndoForElement:()=>Bf,insertFilesIntoEditable:()=>Is,isSeparatorNode:()=>Yn,moveSelection:()=>tl,setCollapseState:()=>ai,setCurrentBlock:()=>Wn,toggleCollapse:()=>As});function yl(e=""){return e?e.startsWith("app:/")?`/api/yandex/disk/file?path=${encodeURIComponent(e)}`:e.startsWith("disk:/")?`/api/yandex/disk/file?path=${encodeURIComponent(e)}`:e:""}function Tf(e,t){if(e===t)return!1;if(t.startsWith(e)){let n=t.slice(e.length);if(n.length>0&&n.length<=Cf&&/^[A-Za-z--0-9]+$/.test(n))return!1}return!0}function Bf(e,t){if(!e||!t)return;u.editingUndo={blockId:t,snapshots:[e.innerHTML],index:0,lastText:e.textContent||"",lastSnapshotAt:Date.now()};let n=()=>{let r=u.editingUndo;if(!r||r.blockId!==t)return;let o=e.innerHTML,i=e.textContent||"",{snapshots:s,index:a,lastText:c,lastSnapshotAt:l}=r,d=Date.now();if(!Tf(c||"",i)){r.lastText=i;return}if(s[a]===o){r.lastText=i,r.lastSnapshotAt=d;return}a<s.length-1&&s.splice(a+1),s.push(o),r.index=s.length-1,r.lastText=i,r.lastSnapshotAt=d};e.addEventListener("input",()=>{!u.editingUndo||u.editingUndo.blockId!==t||u.mode!=="edit"||u.editingBlockId!==t||n()})}function Nf(){u.editingUndo=null}function lo(e){if(e)try{let t=typeof InputEvent=="function"?new InputEvent("input",{bubbles:!0}):new Event("input",{bubbles:!0});e.dispatchEvent(t)}catch{try{let n=document.createEvent("Event");n.initEvent("input",!0,!1),e.dispatchEvent(n)}catch{}}}function Mf(e){let t=u.editingUndo;if(!t||!t.blockId||!e||u.mode!=="edit"||u.editingBlockId!==t.blockId)return!1;let n=document.querySelector(`.block[data-block-id="${t.blockId}"] .block-text[contenteditable="true"]`);if(!n)return!1;let r=t.index+e;if(r<0||r>=t.snapshots.length)return!1;t.index=r;let o=t.snapshots[r];n.innerHTML=o;try{n.focus({preventScroll:!0})}catch{n.focus()}try{let i=window.getSelection&&window.getSelection();if(i){let s=document.createRange();s.selectNodeContents(n),s.collapse(!1),i.removeAllRanges(),i.addRange(s)}}catch{}return!0}function xs(e=""){let t=_n(e);if(!t.titleHtml)return e||"";let n=Es(t.titleHtml),r=t.bodyHtml||"";if(r){let i=document.createElement("template");i.innerHTML=r;let s=i.content.firstChild;for(;s&&Yn(s);){let a=s;s=s.nextSibling,i.content.removeChild(a)}r=i.innerHTML}let o=Es(r||"");return`${n}<p><br /></p>${o}`}function Nc(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll(".block-header").forEach(i=>{let s=i.parentNode;if(s){for(;i.firstChild;)s.insertBefore(i.firstChild,i);s.removeChild(i)}});let n=t.innerHTML,r=_n(n);if(!r.titleHtml)return e||"";let o=`<div class="block-header">${r.titleHtml}</div>`;return r.bodyHtml?`${o}<div><br /></div>${r.bodyHtml}`:o}async function As(e){let t=lt(e);t&&ai(e,!t.block.collapsed)}async function ai(e,t){let n=lt(e);if(!n||n.block.collapsed===t)return;let r=()=>{let s=document.getElementById("blocksContainer");if(!s)return null;let a=u.currentBlockId;if(!a)return{container:s};let c=s.querySelector(`.block[data-block-id="${a}"]`);if(!c)return{container:s};let l=s.getBoundingClientRect(),d=c.getBoundingClientRect();return{container:s,currentId:a,topOffset:d.top-l.top}},o=s=>{if(!s?.container)return;let{container:a}=s;if(!s.currentId||typeof s.topOffset!="number")return;let c=a.querySelector(`.block[data-block-id="${s.currentId}"]`);if(!c)return;let l=a.getBoundingClientRect(),h=c.getBoundingClientRect().top-l.top;a.scrollTop+=h-s.topOffset},i=r();n.block.collapsed=t,await Xt(e),ao({scrollIntoView:!1}),o(i);try{let s=await gt(`/api/articles/${u.articleId}/collapse`,{method:"PATCH",body:JSON.stringify({blockId:e,collapsed:t})});s?.updatedAt&&(u.article.updatedAt=s.updatedAt)}catch(s){n.block.collapsed=!t,await Xt(e),ao({scrollIntoView:!1}),o(i),Ee(s.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430")}}function Lf(e,t){let n=lt(e);for(;n;){let o=!!_n(n.block.text||"").titleHtml,i=!!n.block.children?.length;if((o||i)&&n.block.collapsed!==t)return n.block.id;if(!n.parent)break;n=lt(n.parent.id)}return null}async function Pf(e){let t=lt(e);if(!t)return;let n=(t.ancestors||[]).filter(r=>r.collapsed);for(let r of n)await ai(r.id,!1)}function ei(e){let t=lt(e);if(!t)return null;let n=t.siblings?.[t.index+1];if(n)return n.id;let r=t.siblings?.[t.index-1];return r?r.id:t.parent?t.parent.id:null}function gs(e=[]){return(e||[]).reduce((t,n)=>t+1+gs(n.children||[]),0)}async function Ls(e,t,n){if(!u.articleId){Ee("\u041D\u0435 \u0432\u044B\u0431\u0440\u0430\u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044F \u0434\u043B\u044F \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0444\u0430\u0439\u043B\u0430");return}let r=`att-${Date.now()}-${Math.random().toString(16).slice(2)}`,o=Rt(t?.name||"\u0444\u0430\u0439\u043B"),i=t?.name||"\u0444\u0430\u0439\u043B",s="";Ut("attachment: uploading to Yandex Disk",{name:t?.name,type:t?.type,size:t?.size,articleId:u.articleId,token:r});try{Xn(e),Hn(e,`<a data-pending-attachment="true" data-attachment-token="${r}">${o} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430...)</a>`)}catch{}try{let a=await Do(u.articleId,t,{onProgress:g=>{let w=Math.max(0,Math.min(100,Math.round(g||0)));Ut("attachment upload progress",{percent:w,name:t?.name});try{let S=e,f=S.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);if(n&&(!f||!S.isConnected)){let p=document.querySelector(`.block[data-block-id="${n}"]`);if(p){let k=p.querySelector('.block-text[contenteditable="true"]')||p.querySelector(".block-text.block-body");k&&(S=k,f=S.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`))}}if(f){let p=w>=100?`${i} (\u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0430...)`:`${i} (${w}%)`;p!==s&&(s=p,f.textContent=p)}}catch{}}}),c=Rt(a.originalName||t.name||"\u0444\u0430\u0439\u043B"),l=a.storedPath||a.url||"",d=yl(l),h=Rt(d);if(h){let g=e,w=g.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);if(n&&(!w||!g.isConnected)){let S=document.querySelector(`.block[data-block-id="${n}"]`);if(S){let p=S.querySelector('.block-text[contenteditable="true"]')||S.querySelector(".block-text.block-body");p&&(g=p,w=g.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`))}}w?(w.removeAttribute("data-pending-attachment"),w.removeAttribute("data-attachment-token"),w.setAttribute("href",h),w.setAttribute("target","_blank"),w.setAttribute("rel","noopener noreferrer"),w.textContent=c):(Xn(g),Hn(g,`<a href="${h}" target="_blank" rel="noopener noreferrer">${c}</a>`))}}catch(a){try{let l=e;if(n&&!l.isConnected){let h=document.querySelector(`.block[data-block-id="${n}"]`);if(h){let w=h.querySelector('.block-text[contenteditable="true"]')||h.querySelector(".block-text.block-body");w&&(l=w)}}let d=l.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);d&&(d.textContent=`${o} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`)}catch{}let c=String(a?.message||"").toLowerCase();c.includes("status 0")||c.includes("network error")?Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B (\u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C). \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438, \u043F\u0440\u0438 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u043E\u0441\u0442\u0438, \u0432\u043E\u0439\u0434\u0438\u0442\u0435 \u0437\u0430\u043D\u043E\u0432\u043E."):Ee(a.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u043D\u0430 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A")}}function Is(e,t=[],n){if(!e||!t||!t.length)return;let r=Array.from(t),o=r.filter(s=>dr(s)),i=r.filter(s=>s&&!dr(s));o.forEach(s=>si(e,s,n)),i.forEach(s=>Ls(e,s,n))}function ks(e,t){gl(e,t);let n=e.closest(".block-content");n&&n!==e&&gl(n,t,e),e.addEventListener("paste",r=>{if(u.mode!=="edit"||u.editingBlockId!==t)return;let o=Bs(r.clipboardData?.items),i=Ns(r.clipboardData?.items);if(o.length>0)r.preventDefault(),o.forEach(s=>si(e,s,t));else if(i.length>0)r.preventDefault(),Ut("paste: non-image files detected",i.map(s=>({name:s.name,type:s.type,size:s.size}))),i.forEach(s=>Ls(e,s,t));else{r.preventDefault();let s=g=>{let w=String(g||"").trim();if(!w)return"";let S=document.createElement("template");S.innerHTML=w;let f=S.content.querySelector("body");return((f?f.innerHTML:S.innerHTML)||"").replace(/<!--\s*StartFragment\s*-->/gi,"").replace(/<!--\s*EndFragment\s*-->/gi,"").trim()},a=g=>{let w=String(g||"").trim();if(!w)return"";if(/<\s*(table|ul|ol)\b/i.test(w)||!/<\s*(p|div|h[1-6])\b/i.test(w))return w;let S=document.createElement("template");S.innerHTML=w,(E=>{S.content.querySelectorAll(E).forEach(L=>{let O=L.parentNode;if(O){for(;L.firstChild;)O.insertBefore(L.firstChild,L);O.removeChild(L)}})})("ms-cmark-node");let p=[],y=E=>{let L=String(E||"").replace(/^\s*(<br\s*\/?>\s*)+/gi,"").replace(/(\s*<br\s*\/?>\s*)+$/gi,"").trim();L&&p.push(L)},k=Array.from(S.content.childNodes||[]);for(let E of k){if(!E)continue;if(E.nodeType===Node.TEXT_NODE){let O=(E.textContent||"").replace(/\u00a0/g," ").trim();O&&y(Rt(O));continue}if(E.nodeType!==Node.ELEMENT_NODE)continue;let L=(E.tagName||"").toUpperCase();if(/^H[1-6]$/.test(L)){y(`<strong>${E.innerHTML||""}</strong>`);continue}if(L==="P"||L==="DIV"||L==="LI"||L==="BLOCKQUOTE"){y(E.innerHTML||"");continue}if(L==="BR"){y("<br />");continue}y(E.outerHTML||E.innerHTML||"")}return p.length?p.join("<br /><br />"):""},c=g=>{Xn(e);try{e.focus({preventScroll:!0})}catch{e.focus()}try{if(typeof document.execCommand=="function"&&document.execCommand("insertHTML",!1,g))return!0}catch{}return Hn(e,g),!0},l=g=>{let w=s(g);if(!w)return!1;let f=(L=>{let O=document.createElement("template");O.innerHTML=String(L||"");let z=!1;return O.content.querySelectorAll("img").forEach(q=>{let $=String(q.getAttribute("src")||"").trim();if(!/^(blob:|filesystem:)/i.test($))return;z=!0;let Q=String(q.getAttribute("alt")||"").trim()||"image",W=q.closest?.(".resizable-image")||q;try{W.replaceWith(document.createTextNode(`[${Q} \u2014 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0438\u0437 \u0431\u0443\u0444\u0435\u0440\u0430 \u043E\u0431\u043C\u0435\u043D\u0430 (blob:) \u043D\u0435 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E]`))}catch{}}),{html:O.innerHTML,hadUnstable:z}})(w);f.hadUnstable&&Ee("\u041A\u0430\u0440\u0442\u0438\u043D\u043A\u0430 \u0431\u044B\u043B\u0430 \u0432\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u0430 \u043A\u0430\u043A blob: URL \u0438 \u043D\u0435 \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u0441\u044F \u043F\u043E\u0441\u043B\u0435 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438. \u0412\u0441\u0442\u0430\u0432\u044C\u0442\u0435 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u043A\u0430\u043A \u0444\u0430\u0439\u043B (\u043F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435/\u0432\u0441\u0442\u0430\u0432\u044C\u0442\u0435 \u0444\u0430\u0439\u043B \u0438\u043B\u0438 \u0441\u043A\u0440\u0438\u043D\u0448\u043E\u0442).");let p=il(f.html),y=a(p);if(!y)return!1;let k=ii(p),E=ii(y)||k;return c(co(E)),lo(e),!0},d=g=>{let w=String(g||""),S=w.trim();if(/^https?:\/\/\S+$/i.test(S)){let E=Rt(S);return Xn(e),Hn(e,`<a href="${E}" target="_blank" rel="noopener noreferrer">${E}</a>`),lo(e),!0}let p=w.replace(/\r\n/g,`
`).replace(/\r/g,`
`),y=Rt(p).replace(/\n{2,}/g,"<br /><br />").replace(/\n/g,"<br />"),k=co(ii(y));return c(k),lo(e),!0},h=(r.clipboardData?.getData("text/html")||"").trim();if(h&&l(h))return;try{let w=Array.from(r.clipboardData?.items||[]).find(S=>S&&S.kind==="string"&&S.type==="text/html");if(w&&typeof w.getAsString=="function"){w.getAsString(S=>{try{if(l(S))return}catch{}try{let f=r.clipboardData?.getData("text/plain")||"";d(f)}catch{}});return}}catch{}{let g=r.clipboardData?.getData("text/plain")||"";d(g)}}}),e.addEventListener("drop",r=>{if(u.mode!=="edit"||u.editingBlockId!==t){Ut("drop ignored",{mode:u.mode,editingBlockId:u.editingBlockId,targetBlockId:t});return}let o=Array.from(r.dataTransfer?.files||[]);if(!o.length)return;let i=o.filter(a=>a.type?.startsWith("image/")),s=o.filter(a=>!a.type||!a.type.startsWith("image/"));!i.length&&!s.length||(r.preventDefault(),Ut("drop: files detected",o.map(a=>({name:a.name,type:a.type,size:a.size}))),i.forEach(a=>si(e,a,t)),s.forEach(a=>Ls(e,a,t)))}),e.addEventListener("click",r=>{let o=r.target?.closest("img");if(o){if(r.target?.closest(".resizable-image__handle")){r.preventDefault();return}r.preventDefault(),Gr(o.src,o.alt||"");return}let i=r.target?.closest("a[href]");if(!i)return;let s=i.getAttribute("href")||"";if(!s.startsWith("app:/")&&!s.startsWith("disk:/"))return;r.preventDefault();let a=yl(s);a&&window.open(a,"_blank","noopener,noreferrer")}),u.articleId==="inbox"&&e.addEventListener("click",async r=>{if(r.target?.closest(".move-block-btn")){r.preventDefault(),r.stopPropagation();try{let s=(u.articlesIndex.length?u.articlesIndex:await dn()).filter(d=>d.id!=="inbox").map(d=>({id:d.id,title:d.title||"\u0420\u2018\u0420\xB5\u0420\xB7 \u0420\u0405\u0420\xB0\u0420\xB7\u0420\u0406\u0420\xB0\u0420\u0405\u0420\u0451\u0421\u040F"})),a=await Vn({title:"\u0420\u045F\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451 \u0420\u0406 \u0421\u0403\u0421\u201A\u0420\xB0\u0421\u201A\u0421\u040A\u0421\u040B",message:"\u0420\u2019\u0420\u0406\u0420\xB5\u0420\u0491\u0420\u0451\u0421\u201A\u0420\xB5 ID \u0420\u0451\u0420\xBB\u0420\u0451 \u0420\u0406\u0421\u2039\u0420\xB1\u0420\xB5\u0421\u0402\u0420\u0451\u0421\u201A\u0420\xB5 \u0421\u0403\u0421\u201A\u0420\xB0\u0421\u201A\u0421\u040A\u0421\u040B",confirmText:"\u0420\u045F\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451",cancelText:"\u0420\u045B\u0421\u201A\u0420\u0458\u0420\xB5\u0420\u0405\u0420\xB0",suggestions:s,returnMeta:!0,hideConfirm:!1}),l=(a?.selectedId||(typeof a=="object"?a?.value:a)||""||"").trim();if(!l)return;await gt(`/api/articles/${u.articleId}/blocks/${t}/move-to/${l}`,{method:"POST"}),un(Yt.article("inbox"))}catch(i){Ee(i.message||"\u0420\u045C\u0420\xB5 \u0421\u0453\u0420\u0491\u0420\xB0\u0420\xBB\u0420\u0455\u0421\u0403\u0421\u040A \u0420\u0457\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451 \u0420\xB1\u0420\xBB\u0420\u0455\u0420\u0454")}}}),e.addEventListener("dragover",r=>{if(u.mode!=="edit"||u.editingBlockId!==t)return;(Bs(r.dataTransfer?.items).length>0||Ns(r.dataTransfer?.items).length>0)&&r.preventDefault()}),e.addEventListener("keydown",r=>{if(u.mode!=="edit"||u.editingBlockId!==t)return;let o=window.getSelection();if(!o||o.rangeCount===0)return;let i=o.getRangeAt(0);if(!i||!i.collapsed||ol({event:r,element:e,range:i,selection:o,notifyEditingInput:lo,logDebug:Ut})||r.key!=="Tab"||!(i.commonAncestorContainer?.nodeType===Node.ELEMENT_NODE?i.commonAncestorContainer:i.commonAncestorContainer?.parentElement)?.closest?.("li"))return;r.preventDefault(),r.stopPropagation();let c=r.shiftKey?"outdent":"indent";document.execCommand(c,!1,null)})}function bl(){let e=window.getSelection();if(!e||e.rangeCount===0)return;let t=e.getRangeAt(0),n=t.commonAncestorContainer,o=(n?.nodeType===Node.ELEMENT_NODE?n:n?.parentElement)?.closest('.block-text[contenteditable="true"]');if(!o){fo=null;return}let s=o.closest(".block")?.dataset?.blockId;if(u.mode!=="edit"||u.editingBlockId!==s){fo=null;return}fo=t.cloneRange()}function _f(){if(Ms)return Ms;ml||(document.addEventListener("selectionchange",bl),ml=!0);let e=document.createElement("div");e.className="rich-context-menu hidden",e.innerHTML=`
    <div class="rich-context-menu__col rich-context-menu__col--buffer">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="copy" aria-label="\u041A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C" title="\u041A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C">\u29C9</button>
        <button class="rich-context-menu__icon-btn" data-action="cut" aria-label="\u0412\u044B\u0440\u0435\u0437\u0430\u0442\u044C" title="\u0412\u044B\u0440\u0435\u0437\u0430\u0442\u044C">\u2702</button>
        <button class="rich-context-menu__icon-btn" data-action="paste" aria-label="\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C" title="\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C">\u25A3</button>
        <button class="rich-context-menu__icon-btn" data-action="select-all" aria-label="\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0432\u0441\u0451" title="\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0432\u0441\u0451">\u26F6</button>
      </div>
    </div>
    <div class="rich-context-menu__col">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="bold" aria-label="\u041F\u043E\u043B\u0443\u0436\u0438\u0440\u043D\u044B\u0439" title="\u041F\u043E\u043B\u0443\u0436\u0438\u0440\u043D\u044B\u0439"><strong>\u0416</strong></button>
        <button class="rich-context-menu__icon-btn" data-action="italic" aria-label="\u041A\u0443\u0440\u0441\u0438\u0432" title="\u041A\u0443\u0440\u0441\u0438\u0432"><em>/</em></button>
        <button class="rich-context-menu__icon-btn" data-action="underline" aria-label="\u041F\u043E\u0434\u0447\u0435\u0440\u043A\u043D\u0443\u0442\u044C" title="\u041F\u043E\u0434\u0447\u0435\u0440\u043A\u043D\u0443\u0442\u044C"><u>\u0427</u></button>
        <button class="rich-context-menu__icon-btn" data-action="remove-format" aria-label="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0444\u043E\u0440\u043C\u0430\u0442" title="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0444\u043E\u0440\u043C\u0430\u0442">\u2715</button>
      </div>
    </div>
    <div class="rich-context-menu__col">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="ul" aria-label="\u041C\u0430\u0440\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A" title="\u041C\u0430\u0440\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A">\u2022</button>
        <button class="rich-context-menu__icon-btn" data-action="ol" aria-label="\u041D\u0443\u043C\u0435\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A" title="\u041D\u0443\u043C\u0435\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A">1.</button>
        <button class="rich-context-menu__icon-btn" data-action="quote" aria-label="\u0426\u0438\u0442\u0430\u0442\u0430" title="\u0426\u0438\u0442\u0430\u0442\u0430">\u275D</button>
        <button class="rich-context-menu__icon-btn" data-action="code" aria-label="\u041A\u043E\u0434" title="\u041A\u043E\u0434">&lt;/&gt;</button>
      </div>
    </div>
    <div class="rich-context-menu__col">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="link" aria-label="\u0421\u0441\u044B\u043B\u043A\u0430" title="\u0421\u0441\u044B\u043B\u043A\u0430">\u{1F517}</button>
        <button class="rich-context-menu__icon-btn" data-action="unlink" aria-label="\u0423\u0431\u0440\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443" title="\u0423\u0431\u0440\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443">\u2298</button>
        <button class="rich-context-menu__icon-btn" data-action="insert-article-link" aria-label="\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E" title="\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E">\xA7</button>
      </div>
    </div>
    <div class="rich-context-menu__col">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="split-at-caret" aria-label="\u0420\u0430\u0437\u0434\u0435\u043B\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043F\u043E \u043A\u0443\u0440\u0441\u043E\u0440\u0443" title="\u0420\u0430\u0437\u0434\u0435\u043B\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043F\u043E \u043A\u0443\u0440\u0441\u043E\u0440\u0443">|\u21B5</button>
      </div>
    </div>
  `,document.body.appendChild(e);let t=()=>{e.classList.add("hidden"),e.style.visibility="",Et=null,Pr=null,uo=null},n=()=>{if(Et){let o=window.getSelection();o.removeAllRanges(),o.addRange(Et)}},r=async o=>{n();let i=()=>{if(Pr&&document.contains(Pr))return Pr;let g=window.getSelection()?.anchorNode?.parentElement?.closest(".block-text[contenteditable]");if(g)return g;if(Et){let S=Et.commonAncestorContainer;if(S?.parentElement){let f=S.parentElement.closest(".block-text[contenteditable]");if(f)return f}}if(uo&&document.contains(uo))return uo;if(u.editingBlockId){let S=document.querySelector(`.block[data-block-id="${u.editingBlockId}"] .block-text[contenteditable="true"]`);if(S)return S}let w=document.activeElement;if(w&&w.closest){let S=w.closest(".block-text[contenteditable]");if(S)return S}return null},s=d=>{fl({listTag:d,resolveTarget:i,restoreSelection:n,richContextRange:Et,notifyEditingInput:lo,setRichContextRange:h=>{Et=h?h.cloneRange():null}})},a=async()=>{let d=i();if(!d){Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0441\u0441\u044B\u043B\u043A\u0438");return}let h=u.articlesIndex.length?u.articlesIndex:await dn(),g=h.map(E=>({id:E.id,title:E.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),w="",S="";try{let E=await Vn({title:"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438. \u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0438 \u043F\u043E\u043C\u043E\u0433\u0443\u0442 \u043D\u0430\u0439\u0442\u0438 \u043D\u0443\u0436\u043D\u0443\u044E.",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:g,returnMeta:!0,hideConfirm:!0});E&&typeof E=="object"?(w=E.value||"",S=E.selectedId||""):w=E||""}catch{w=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438")||""}let f=(w||"").trim().toLowerCase();if(!f&&!S)return;let p=h.find(E=>{let L=(E.title||"").toLowerCase();return S&&E.id===S||E.id&&E.id.toLowerCase()===f||L===f||L.includes(f)});if(!p){Ee("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}if(!d||!document.contains(d)){Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0441\u0441\u044B\u043B\u043A\u0438");return}n(),d.focus();let y=`<a href="${Yt.article(p.id)}" class="article-link" data-article-id="${p.id}">${Rt(p.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F")}</a>`;Hn(d,y);let k=(d.innerHTML||"").trim();(!k||k==="<br>"||k==="<br/>"||k==="<br />")&&(d.innerHTML=y),d.classList.remove("block-body--empty")},c=()=>{n();let d=window.getSelection();if(!(!d||d.rangeCount===0)){document.execCommand("removeFormat");for(let h=0;h<4;h+=1)document.execCommand("outdent");document.execCommand("formatBlock",!1,"p")}},l=d=>{let h=i();if(!h||!document.contains(h))return Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u0442\u0435\u043A\u0441\u0442 \u0434\u043B\u044F \u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F"),null;let g=window.getSelection();if(!g||g.rangeCount===0)return null;let w=g.getRangeAt(0).cloneRange();if(!w||w.collapsed)return null;let S=w.cloneContents(),f=document.createElement("div");f.appendChild(S);let p=f.innerHTML||"",y=f.textContent||"",E=h.closest(".block")?.dataset.blockId||null;return Lr={html:p,text:y,sourceBlockId:E},Ut("clipboard.capture",{kind:d,hasHtml:!!p,length:y.length,blockId:E}),{range:w,target:h}};switch(o){case"cut":{if(!l("cut"))break;document.execCommand("cut");break}case"copy":l("copy"),document.execCommand("copy");break;case"select-all":{let d=i();if(!d||!document.contains(d))break;let h=document.createRange();h.selectNodeContents(d);let g=window.getSelection();g&&(g.removeAllRanges(),g.addRange(h)),Et=h.cloneRange();break}case"paste":{let d=i();if(!d||!document.contains(d)){Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438");break}if(!Lr||!Lr.html&&!Lr.text){Ee("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0441\u043A\u043E\u043F\u0438\u0440\u0443\u0439\u0442\u0435 \u0438\u043B\u0438 \u0432\u044B\u0440\u0435\u0436\u044C\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u0432 \u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440\u0435");break}n();let h=window.getSelection(),g=null;if(Et&&d.contains(Et.commonAncestorContainer))g=Et.cloneRange();else if(h&&h.rangeCount>0){let p=h.getRangeAt(0);d.contains(p.commonAncestorContainer)&&(g=p.cloneRange())}g||(g=document.createRange(),g.selectNodeContents(d),g.collapse(!1));let w=Lr.html||Rt(Lr.text).replace(/\n/g,"<br />"),S=document.createElement("div");S.innerHTML=w;let f=document.createDocumentFragment();for(;S.firstChild;)f.appendChild(S.firstChild);g.deleteContents(),g.insertNode(f),g.collapse(!1),h&&(h.removeAllRanges(),h.addRange(g)),d.focus({preventScroll:!0}),d.classList.remove("block-body--empty");break}case"bold":document.execCommand("bold");break;case"italic":document.execCommand("italic");break;case"underline":document.execCommand("underline");break;case"ul":s("ul");break;case"ol":s("ol");break;case"quote":document.execCommand("formatBlock",!1,"blockquote");break;case"code":document.execCommand("formatBlock",!1,"pre");break;case"link":{let d=window.getSelection(),h=d?d.toString():"",g=d?.anchorNode,w=g?g.parentElement?.closest("a"):null,S=w?.getAttribute("href")||"",f=await Ji({title:"\u0421\u0441\u044B\u043B\u043A\u0430",textLabel:"\u0422\u0435\u043A\u0441\u0442",urlLabel:"\u0421\u0441\u044B\u043B\u043A\u0430",defaultText:h||w?.textContent||"",defaultUrl:S,confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"});if(Ut("link action: prompt result",{hasResult:!!f,url:f?.url,text:f?.text}),!f||!f.url)break;let p=f.url.match(/^[a-z]+:/i)?f.url:`https://${f.url}`,y=f.text?.trim()||p;n();let k=i();if(Ut("link action: target",{targetExists:!!k,inDom:!!(k&&document.contains(k)),className:k?.className}),!k||!document.contains(k))break;let E=window.getSelection(),L=null;Et&&k.contains(Et.commonAncestorContainer)?L=Et.cloneRange():E&&E.rangeCount>0&&k.contains(E.getRangeAt(0).commonAncestorContainer)&&(L=E.getRangeAt(0).cloneRange()),L||(L=document.createRange(),L.selectNodeContents(k),L.collapse(!1)),Ut("link action: range chosen",{usedSelectionRange:!!(E&&E.rangeCount>0&&k.contains(E.getRangeAt(0).commonAncestorContainer)),usedStoredRange:!!(Et&&k.contains(Et.commonAncestorContainer)),selectionRangeCollapsed:!!(E&&E.rangeCount>0&&E.getRangeAt(0).collapsed),rangeStartNode:L?.startContainer?.nodeName,rangeOffset:L?.startOffset,labelLength:(y||"").length,url:p});let O=document.createElement("a");O.href=p,O.target="_blank",O.rel="noopener noreferrer",O.textContent=y,L.deleteContents(),L.insertNode(O),L.setStartAfter(O),L.setEndAfter(O),Ut("link action: inserted link",{outerHTML:O.outerHTML,parentClass:O.parentElement?.className,targetInner:k.innerHTML.slice(0,120)}),E&&(E.removeAllRanges(),E.addRange(L)),k.focus({preventScroll:!0}),k.classList.remove("block-body--empty");break}case"unlink":{let d=i();if(Ut("unlink action: target",{targetExists:!!d,inDom:!!(d&&document.contains(d)),className:d?.className}),!d||!document.contains(d))break;let h=window.getSelection(),g=null;if(h&&h.rangeCount>0){let w=h.getRangeAt(0).commonAncestorContainer;g=w?.parentElement?.closest("a")||w?.closest?.("a")}if(!g&&Et){let w=Et.commonAncestorContainer;g=w?.parentElement?.closest("a")||w?.closest?.("a")}if(g||(g=d.querySelector("a")),g){let w=document.createTextNode(g.textContent||"");g.replaceWith(w)}else document.execCommand("unlink");break}case"remove-format":c();break;case"insert-article-link":a().finally(()=>{t()});return;case"split-at-caret":await _c();break;default:break}t()};return e.addEventListener("click",o=>{let i=o.target.closest("button[data-action]");if(!i)return;let s=i.dataset.action;r(s)}),document.addEventListener("click",o=>{e.classList.contains("hidden")||e.contains(o.target)||t()}),document.addEventListener("touchstart",o=>{e.classList.contains("hidden")||e.contains(o.target)||t()},{passive:!0}),document.addEventListener("keydown",o=>{o.code==="Escape"&&t()}),window.addEventListener("scroll",t,!0),Ms=e,e}function hl(e){let t=_f();t.classList.remove("hidden"),t.style.visibility="hidden",bl();let n=window.getSelection();n&&n.rangeCount>0?Et=n.getRangeAt(0).cloneRange():fo?Et=fo.cloneRange():Et=null;let r=t.getBoundingClientRect(),o=22,i=12,s=e.clientX+14,a=e.clientY+o;a+r.height+i>window.innerHeight&&(a=Math.max(i,e.clientY-r.height-o));let c=Math.min(Math.max(s,i),window.innerWidth-r.width-i),l=Math.min(Math.max(a,i),window.innerHeight-r.height-i);t.style.left=`${c}px`,t.style.top=`${l}px`,t.style.visibility="visible"}function gl(e,t,n){let r=n||e;e.addEventListener("focusin",()=>{uo=r}),e.addEventListener("contextmenu",s=>{u.mode!=="edit"||u.editingBlockId!==t||(s.preventDefault(),Pr=r,hl(s))});let o=null;e.addEventListener("touchstart",s=>{if(u.mode!=="edit"||u.editingBlockId!==t||s.touches.length!==1)return;let a=s.touches[0];o=window.setTimeout(()=>{Pr=r,hl({clientX:a.clientX,clientY:a.clientY})},500)},{passive:!0});let i=()=>{o!==null&&(clearTimeout(o),o=null)};e.addEventListener("touchend",i,{passive:!0}),e.addEventListener("touchcancel",i,{passive:!0})}async function us(e){if(!e)return;let t=lt(e);if(!t)return;let n=(t.ancestors||[]).filter(r=>r.collapsed);for(let r of n)await ai(r.id,!1)}var Cf,Ms,Et,Pr,uo,Lr,fo,ml,En=je(()=>{bt();Wt();Ft();ar();In();Jn();Wt();jn();jn();ms();rl();Cs();al();Ts();ul();pl();Cf=16;Ms=null,Et=null,Pr=null,uo=null,Lr={html:"",text:"",sourceBlockId:null},fo=null,ml=!1;dl()});function Df(){let e=u?.currentUser||null;return e&&(e.id||e.username)||"anon"}async function ci(){return Co({userKey:Df()})}async function wl(e={}){let t=String(e?.token||"").trim(),n=String(e?.articleId||"").trim();if(!t||!n)return!1;let r=String(e?.kind||"image"),o=e?.blob||null,i=String(e?.mime||o&&o.type||"").trim(),s=String(e?.fileName||"").trim()||null,a=Date.now(),l=(await ci()).transaction(["pending_uploads"],"readwrite"),d=l.objectStore("pending_uploads"),h=await De(d.get(t)).catch(()=>null),g=Number(h?.createdAtMs||e?.createdAtMs||a)||a,w={token:t,articleId:n,kind:r,blob:o,mime:i,fileName:s,status:String(e?.status||h?.status||"pending"),errorMessage:String(e?.errorMessage||h?.errorMessage||""),createdAtMs:g,updatedAtMs:a};return await De(d.put(w)),await et(l),!0}async function Ps(e){let t=String(e||"").trim();if(!t)return!1;let r=(await ci()).transaction(["pending_uploads"],"readwrite"),o=r.objectStore("pending_uploads");return await De(o.delete(t)),await et(r),!0}async function _s(e,t){let n=String(e||"").trim();if(!n)return!1;let o=(await ci()).transaction(["pending_uploads"],"readwrite"),i=o.objectStore("pending_uploads"),s=await De(i.get(n)).catch(()=>null);return s?(s.status="error",s.errorMessage=String(t||"error"),s.updatedAtMs=Date.now(),await De(i.put(s)),await et(o),!0):(await et(o),!1)}async function Ds({articleId:e=null,limit:t=50}={}){let r=(await ci()).transaction(["pending_uploads"],"readonly"),o=r.objectStore("pending_uploads"),i=[];try{let s=Number(t||0)||0;if(e){let a=o.index("byArticleId");i=await De(a.getAll(String(e),s>0?s:void 0))}else i=await De(o.getAll(s>0?s:void 0))}catch{i=[]}return await et(r),Array.isArray(i)?(i.sort((s,a)=>Number(s?.createdAtMs||0)-Number(a?.createdAtMs||0)),i):[]}var Sl=je(()=>{bt();Mi();An()});var li,xl=je(()=>{li=["pending-attachment","app","disk"]});function Os(e){let n=String(e||"").replace(/\r\n/g,`
`).split(`
`),r=c=>{let l=String(c||"").match(/^(#{1,6})\s+(.*)$/);if(!l)return null;let d=String(l[2]||"").trim();return d?{level:l[1].length,title:d}:null},o=!1;try{let c=n.find(l=>String(l||"").trim().length>0)||"";o=!!r(c)}catch{o=!1}let i=[],s=null,a=()=>{if(s){try{for(;s.bodyLines.length&&!String(s.bodyLines[0]||"").trim();)s.bodyLines.shift()}catch{}s.bodyText=s.bodyLines.join(`
`).trimEnd(),delete s.bodyLines,i.push(s),s=null}};for(let c of n){let l=r(c);if(l){a(),s={level:l.level,title:l.title,bodyLines:[]};continue}s&&s.bodyLines.push(c)}return a(),{sections:i,startsWithHeading:o,headingCount:i.length}}function Al(e,t={}){let n=Array.isArray(e)?e.filter(Boolean):[],r=typeof t.makeId=="function"?t.makeId:()=>`${Date.now()}-${Math.random()}`;if(!n.length)return[];let o=Number.isFinite(t.baseLevel)?t.baseLevel:Number(n[0].level||1),i=[],s=[];for(let a of n){let c=Number(a.level||1),l=String(a.title||"").trim(),d=String(a.bodyText||"").trimEnd();if(!l)continue;let h=Math.max(0,c-o);for(;s.length>h;)s.pop();h>s.length&&(h=s.length);let g={id:r(),title:l,bodyText:d,children:[]},w=h>0?s[h-1]:null;w?w.children.push(g):i.push(g),s.push(g)}return i}var Il=je(()=>{});var zs={};vo(zs,{flushOutboxOnce:()=>_r,getBackgroundFullPullStatus:()=>jf,startBackgroundFullPull:()=>tp,startSyncLoop:()=>ep,tryPullBootstrap:()=>Wf});function Of(e,t=null){try{if(!e)return;let n=window.localStorage.getItem(di)||"";if(!n)return;let r=JSON.parse(n);if(!r||typeof r!="object")return;let o=String(e),i=r[o]||null;if(!i)return;let s=Number(i?.queuedAt||0)||0,a=typeof t=="number"&&Number.isFinite(t)?t:null;if(a!=null&&s>a)return;delete r[o],window.localStorage.setItem(di,JSON.stringify(r))}catch{}}function $f(e,t){try{let n=e&&typeof e=="object"?e:{type:"doc",content:[]},r=Array.isArray(n.content)?n.content:[],o=new Map,i=d=>{if(Array.isArray(d))for(let h of d){if(!h||typeof h!="object"||h.type!=="outlineSection")continue;let g=String(h?.attrs?.id||"").trim();g&&o.set(g,h);let S=(Array.isArray(h.content)?h.content:[]).find(f=>f&&typeof f=="object"&&f.type==="outlineChildren")||null;S&&Array.isArray(S.content)&&i(S.content)}};i(r);let s=(d,h)=>{let g=d&&typeof d=="object"?d:{type:"outlineSection",attrs:{id:h,collapsed:!1},content:[]};g.type="outlineSection";let w=g.attrs&&typeof g.attrs=="object"?g.attrs:{};w.id=h,g.attrs=w;let S=Array.isArray(g.content)?g.content:[],f=S.find(k=>k&&typeof k=="object"&&k.type==="outlineHeading")||{type:"outlineHeading",content:[]},p=S.find(k=>k&&typeof k=="object"&&k.type==="outlineBody")||{type:"outlineBody",content:[{type:"paragraph"}]},y=S.find(k=>k&&typeof k=="object"&&k.type==="outlineChildren")||{type:"outlineChildren",content:[]};return Array.isArray(y.content)||(y={...y,content:[]}),g.content=[f,p,y],g},a=new Set,c=new Map;for(let d of Array.isArray(t)?t:[]){let h=String(d?.sectionId||"").trim();if(!h)continue;let g=d?.parentId,w=g!=null&&String(g).trim()?String(g).trim():null,S=Number.isFinite(Number(d?.position))?Number(d.position):0,f=!!d?.collapsed,p=s(o.get(h),h);p.attrs={...p.attrs||{},id:h,collapsed:f},o.set(h,p),a.add(h),c.has(w)||c.set(w,[]),c.get(w).push({pos:S,sid:h,sec:p})}for(let[d,h]of c.entries())h.sort((g,w)=>g.pos-w.pos||String(g.sid).localeCompare(String(w.sid))),c.set(d,h);for(let[d,h]of o.entries()){let w=(c.get(d)||[]).map(S=>S.sec);try{Array.isArray(h.content)||(h.content=[]),(!h.content[2]||h.content[2].type!=="outlineChildren")&&(h.content[2]={type:"outlineChildren",content:[]}),h.content[2].content=w}catch{}}let l=(c.get(null)||[]).map(d=>d.sec);for(let[d,h]of o.entries())a.has(d)||l.push(h);return n.type="doc",n.content=l,n}catch{return e}}function Ff(e,t,n,r){try{let o=String(t||"").trim();if(!o)return e;let i=e&&typeof e=="object"?e:{type:"doc",content:[]},s=[i];for(;s.length;){let a=s.pop();if(!a||typeof a!="object")continue;if(a.type==="outlineSection"&&String(a?.attrs?.id||"").trim()===o){let d=(Array.isArray(a.content)?a.content:[]).find(h=>h&&typeof h=="object"&&h.type==="outlineChildren")||{type:"outlineChildren",content:[]};return a.content=[n,r,d],i}let c=a.content;if(Array.isArray(c))for(let l of c)s.push(l)}return i}catch{return e}}function Fs(e){let t=e?.type||"";return t==="section_upsert_content"||t==="delete_sections"||t==="structure_snapshot"}function zf(e,t,n){try{let r=String(e||"").trim(),o=String(t||"").trim(),i=Number(n);if(!r||!o||!Number.isFinite(i)||i<=0)return;let s="ttree_outline_section_seq_v1",a=window.localStorage.getItem(s)||"",c=a?JSON.parse(a):{},l=c&&typeof c=="object"?c:{},d=(l[r]&&typeof l[r]=="object"?l[r]:{})||{};if((Number(d[o]||0)||0)>=i)return;d[o]=i,l[r]=d,window.localStorage.setItem(s,JSON.stringify(l))}catch{}}function Uf(e){let t=[],n=(i,s)=>{if(!Array.isArray(i))return;let a=0;for(let c of i){if(!c||typeof c!="object"||c.type!=="outlineSection")continue;let l=String(c?.attrs?.id||"").trim();if(!l)continue;t.push({sectionId:l,parentId:s||null,position:a,collapsed:!!c?.attrs?.collapsed}),a+=1;let h=(Array.isArray(c.content)?c.content:[]).find(w=>w&&typeof w=="object"&&w.type==="outlineChildren")||null,g=h&&Array.isArray(h.content)?h.content:[];n(g,l)}},r=e&&typeof e=="object"?e:null,o=r&&Array.isArray(r.content)?r.content:[];return n(o,null),t}function qf(e,t){try{let n=e&&typeof e=="object"?{...e}:null;if(!n||n.type!=="outlineHeading")return e;let r=String(t||"");if(!r)return e;let o=Array.isArray(n.content)?[...n.content]:[];return o.unshift({type:"text",text:r}),n.content=o,n}catch{return e}}function Vf(e,t,n){let r=e&&typeof e=="object"?e:{type:"doc",content:[]};Array.isArray(r.content)||(r.content=[]);let o=String(t||"").trim(),i=a=>{for(let c=0;c<a.length;c+=1){let l=a[c];if(!l||typeof l!="object"||l.type!=="outlineSection")continue;let d=String(l?.attrs?.id||"").trim();if(o&&d===o)return a.splice(c+1,0,n),!0;let g=(Array.isArray(l.content)?l.content:[]).find(w=>w&&typeof w=="object"&&w.type==="outlineChildren")||null;if(g&&Array.isArray(g.content)&&i(g.content))return!0}return!1};return i(r.content)||r.content.push(n),r}function Jf(){try{return window?.localStorage?.getItem?.("ttree_debug_offline_v1")==="1"}catch{return!1}}function Tl(...e){try{if(!Jf())return;console.log("[offline][queue]",...e)}catch{}}function Nl(){try{let e=window.localStorage.getItem(di)||"";if(!e)return{changed:!1,removed:0};let t=JSON.parse(e);if(!t||typeof t!="object")return{changed:!1,removed:0};let n=Object.keys(t);if(!n.length)return{changed:!1,removed:0};let r=0;for(let o of n)o!=="inbox"&&(delete t[o],r+=1);return r?(window.localStorage.setItem(di,JSON.stringify(t)),Tl("prune.queue",{removed:r}),{changed:!0,removed:r}):{changed:!1,removed:0}}catch(e){return Tl("prune.queue.error",{message:e?.message||String(e||"error")}),{changed:!1,removed:0}}}function Qn(){try{window.dispatchEvent(new CustomEvent("offline-full-pull-status",{detail:{...It}}))}catch{}}function jf(){return{...It}}async function Qt(e,t={}){let n=await fetch(e,{headers:{"Content-Type":"application/json",...t.headers||{}},credentials:"include",...t});if(!n.ok){let r=await n.json().catch(()=>({})),o=new Error(r.detail||"Request failed");throw o.status=n.status,o.details=r,o.path=e,o}return n.status===204?null:n.json()}function Bl(e){let t=Number(e?.status||0);return!t||t>=500||t===408||t===429||t===401||t===403}function Kf(e,t){let n=Number(e?.status||0);return n===404||n===410?!0:n>=400&&n<500&&n!==401&&n!==403&&n!==408&&n!==429?t?.type==="save_doc_json"||String(t?.type||"").startsWith("section_")||t?.type==="structure_snapshot"||t?.type==="delete_sections":!1}async function Wf(){try{let e=await dn();return Mn(e).catch(()=>{}),Array.isArray(e)?e:[]}catch{return null}}function Yf(e,t){try{let n=new Set((Array.isArray(t)?t:[]).map(i=>String(i||"").trim()).filter(Boolean));if(!n.size)return e;let r=e&&typeof e=="object"?e:{type:"doc",content:[]},o=i=>{if(!Array.isArray(i))return[];let s=[];for(let a of i)if(!(!a||typeof a!="object")){if(a.type==="outlineSection"){let c=String(a?.attrs?.id||"").trim();if(c&&n.has(c))continue;let d=(Array.isArray(a.content)?a.content:[]).find(h=>h&&typeof h=="object"&&h.type==="outlineChildren")||null;d&&Array.isArray(d.content)&&(d.content=o(d.content))}s.push(a)}return s};return Array.isArray(r.content)?r.content=o(r.content):r.content=[],r.type=r.type||"doc",r}catch{return e}}async function Xf(e){if(e.type==="create_article"){let t=e.payload?.title||"\u041D\u043E\u0432\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F",n=e.payload?.id||e.articleId,r=await Qt("/api/articles",{method:"POST",body:JSON.stringify({title:t,id:n})});await vr(r);return}if(e.type==="save_doc_json"){let t=e.payload?.docJson||null;if(!t||typeof t!="object")return;let n=await Qt(`/api/articles/${encodeURIComponent(e.articleId)}/doc-json/save`,{method:"PUT",body:JSON.stringify({docJson:t,createVersionIfStaleHours:12})}),r=n?.updatedAt||null;await nn(e.articleId,t,r);try{ot("sync.flush.save_doc_json.ok",{articleId:e.articleId,opId:e.id,updatedAt:r,docHash:Bt(t)})}catch{}try{let o=Array.isArray(n?.changedBlockIds)?n.changedBlockIds:[],i=Array.isArray(n?.removedBlockIds)?n.removedBlockIds:[];if(i.length&&await Po(i),o.length){let s=await Qt(`/api/articles/${encodeURIComponent(e.articleId)}/embeddings?ids=${encodeURIComponent(o.join(","))}`);await Fi(e.articleId,s?.embeddings||[])}}catch{}return}if(e.type==="section_upsert_content"){let t=e.payload?.sectionId||null,n=e.payload?.headingJson||null,r=e.payload?.bodyJson||null,o=e.payload?.seq||null;if(!t||!n||!r||!o)return;let i=await Qt(`/api/articles/${encodeURIComponent(e.articleId)}/sections/upsert-content`,{method:"PUT",body:JSON.stringify({opId:e.payload?.opId||e.id,sectionId:t,headingJson:n,bodyJson:r,seq:o,createVersionIfStaleHours:12})});try{if(i?.updatedAt){let s=await Rn(e.articleId).catch(()=>null),a=s?.docJson&&typeof s.docJson=="object"?s.docJson:null;if(a){let c=Ff(a,t,n,r);await nn(e.articleId,c,i.updatedAt)}}try{ot("sync.flush.section_upsert_content.ok",{articleId:e.articleId,opId:e.id,sectionId:t,updatedAt:i?.updatedAt||null})}catch{}}catch{}return}if(e.type==="structure_snapshot"){let t=e.payload?.nodes||null;if(!Array.isArray(t)||!t.length)return;let n=await Qt(`/api/articles/${encodeURIComponent(e.articleId)}/structure/snapshot`,{method:"PUT",body:JSON.stringify({opId:e.payload?.opId||e.id,nodes:t})});try{if(n?.updatedAt){let r=await Rn(e.articleId).catch(()=>null),o=r?.docJson&&typeof r.docJson=="object"?r.docJson:null;if(o){let i=$f(o,t);await nn(e.articleId,i,n.updatedAt)}}try{ot("sync.flush.structure_snapshot.ok",{articleId:e.articleId,opId:e.id,updatedAt:n?.updatedAt||null,nodesCount:Array.isArray(t)?t.length:null})}catch{}}catch{}return}if(e.type==="delete_sections"){let t=Array.isArray(e.payload?.sectionIds)?e.payload.sectionIds:[];if(!t.length)return;let n=await Va(e.articleId,t,{opId:e.payload?.opId||e.id});try{let r=n?.updatedAt||null,o=await Rn(e.articleId).catch(()=>null),i=o?.docJson&&typeof o.docJson=="object"?o.docJson:null;if(i&&r){let a=Yf(i,t);await nn(e.articleId,a,r)}let s=Array.isArray(n?.removedBlockIds)?n.removedBlockIds:[];s.length&&await Po(s),ot("sync.flush.delete_sections.ok",{articleId:e.articleId,opId:e.id,updatedAt:r||null,sectionIdsCount:t.length,removedCount:s.length})}catch{}return}if(e.type==="move_article_position"){let t=e.payload?.direction||null;if(!t)return;await Qt(`/api/articles/${encodeURIComponent(e.articleId)}/move`,{method:"POST",body:JSON.stringify({direction:t})});return}if(e.type==="indent_article"){await Qt(`/api/articles/${encodeURIComponent(e.articleId)}/indent`,{method:"POST",body:JSON.stringify({})});return}if(e.type==="outdent_article"){await Qt(`/api/articles/${encodeURIComponent(e.articleId)}/outdent`,{method:"POST",body:JSON.stringify({})});return}if(e.type==="move_article_tree"){await Qt(`/api/articles/${encodeURIComponent(e.articleId)}/move-tree`,{method:"POST",body:JSON.stringify(e.payload||{})});return}}async function Gf(e){try{if(!e||!e.articleId||!(e.type==="save_doc_json"||e.type==="section_upsert_content"||e.type==="structure_snapshot"||e.type==="delete_sections"))return;let n=e.payload?.clientQueuedAt??null;if(typeof n!="number"||!Number.isFinite(n)||(await sr(500)||[]).some(i=>i&&i.articleId===e.articleId&&(i.type==="save_doc_json"||i.type==="section_upsert_content"||i.type==="structure_snapshot")&&(i.payload?.clientQueuedAt??null)===n))return;Of(e.articleId,n)}catch{}}async function Qf(e,t){let n=String(e||"").trim();if(n)for(let r of t||[])try{let o=String(r?.sectionId||"").trim(),i=r?.headingJson||null,s=r?.bodyJson||null;if(!o||!i||!s)continue;let a=globalThis.crypto?.randomUUID?.()||`conflict-${Date.now()}-${Math.random().toString(16).slice(2)}`,c=await Rn(n).catch(()=>null),l=c?.docJson&&typeof c.docJson=="object"?c.docJson:null,d=qf(i,"\u041A\u043E\u043D\u0444\u043B\u0438\u043A\u0442\u043D\u0430\u044F \u043A\u043E\u043F\u0438\u044F: "),g=Vf(l||{type:"doc",content:[]},o,{type:"outlineSection",attrs:{id:a,collapsed:!1,isConflictCopy:!0},content:[d||{type:"outlineHeading",content:[]},s||{type:"outlineBody",content:[{type:"paragraph"}]},{type:"outlineChildren",content:[]}]});await nn(n,g,c?.updatedAt||null).catch(()=>{}),zf(n,a,1);let w=Date.now();await zt("section_upsert_content",{articleId:n,payload:{sectionId:a,headingJson:d,bodyJson:s,seq:1,clientQueuedAt:w},coalesceKey:`content:${n}:${a}`}).catch(()=>{});let S=Uf(g);S.length&&await zt("structure_snapshot",{articleId:n,payload:{nodes:S,clientQueuedAt:w},coalesceKey:`structure:${n}`}).catch(()=>{});try{window.dispatchEvent(new CustomEvent("outline-sync-conflict",{detail:{articleId:n,sectionId:o,conflictCopySectionId:a}}))}catch{}}catch{}}async function Zf(e,t){let n=String(e||"").trim();if(!n)return;let r=Date.now(),o=Number(El.get(n)||0)||0;if(o&&r-o<Rf)return;El.set(n,r);let i=async()=>{let f=await sr(200),p=[],y=[],k=[];for(let E of f||[])!E||String(E.articleId||"")!==n||(E.type==="delete_sections"?p.push(E):E.type==="section_upsert_content"?y.push(E):E.type==="structure_snapshot"&&k.push(E));return{deleteOps:p,upsertOps:y,structureOps:k}},s=0,a=[],c=[],l=[];try{({deleteOps:a,upsertOps:c,structureOps:l}=await i())}catch{a=[],c=[],l=[];for(let f of t||[])!f||String(f.articleId||"")!==n||(f.type==="delete_sections"?a.push(f):f.type==="section_upsert_content"?c.push(f):f.type==="structure_snapshot"&&l.push(f))}let d=new Set;for(let f of a){let p=Array.isArray(f.payload?.sectionIds)?f.payload.sectionIds:[];for(let y of p){let k=String(y||"").trim();k&&d.add(k)}}if(d.size&&c.length)for(let f of c)try{let p=String(f.payload?.sectionId||"").trim();p&&d.has(p)&&await qn(f.id)}catch{}let h=a.map(f=>{let p=Array.isArray(f.payload?.sectionIds)?f.payload.sectionIds:[];return{opId:f.payload?.opId||f.id,sectionIds:p.filter(Boolean).map(y=>String(y)),_outboxId:f.id}}).filter(f=>f.sectionIds.length),g=c.map(f=>{let p=String(f.payload?.sectionId||"").trim();return!p||d.has(p)?null:{opId:f.payload?.opId||f.id,sectionId:p,headingJson:f.payload?.headingJson||null,bodyJson:f.payload?.bodyJson||null,seq:f.payload?.seq||null,clientQueuedAt:f.payload?.clientQueuedAt??null,_outboxId:f.id}}).filter(Boolean),w=async()=>{let f=a.map(q=>{let $=Array.isArray(q.payload?.sectionIds)?q.payload.sectionIds:[];return{opId:q.payload?.opId||q.id,sectionIds:$.filter(Boolean).map(Q=>String(Q)),_outboxId:q.id}}).filter(q=>q.sectionIds.length),p=c.map(q=>{let $=String(q.payload?.sectionId||"").trim();return!$||d.has($)?null:{opId:q.payload?.opId||q.id,sectionId:$,headingJson:q.payload?.headingJson||null,bodyJson:q.payload?.bodyJson||null,seq:q.payload?.seq||null,clientQueuedAt:q.payload?.clientQueuedAt??null,_outboxId:q.id}}).filter(Boolean),y=new Map;for(let q of f)y.set(String(q.opId),q._outboxId);for(let q of p)y.set(String(q.opId),q._outboxId);if(!f.length&&!p.length)return!1;try{ot("sync.flush.outline_compact.start",{articleId:n,deletesCount:f.length,upsertsCount:p.length})}catch{}let k=await Qt(`/api/articles/${encodeURIComponent(n)}/sync/compact`,{method:"PUT",body:JSON.stringify({deletes:f.map(({opId:q,sectionIds:$})=>({opId:q,sectionIds:$})),upserts:p.map(({opId:q,sectionId:$,headingJson:Q,bodyJson:W,seq:re})=>({opId:q,sectionId:$,headingJson:Q,bodyJson:W,seq:re}))})}),E=k?.updatedAt||null;E&&await Ri(n,E).catch(()=>{});try{ot("sync.flush.outline_compact.ok",{articleId:n,updatedAt:E||null,deleteAcks:Array.isArray(k?.deleteAcks)?k.deleteAcks.length:null,upsertAcks:Array.isArray(k?.upsertAcks)?k.upsertAcks.length:null})}catch{}let L=Array.isArray(k?.deleteAcks)?k.deleteAcks:[];for(let q of L){let $=String(q?.opId||"").trim();if(!$)continue;let Q=y.get($)||$;await qn(Q).catch(()=>{});try{let W=Array.isArray(q?.removedBlockIds)?q.removedBlockIds:[];W.length&&await Po(W)}catch{}}let O=[],z=Array.isArray(k?.upsertAcks)?k.upsertAcks:[];for(let q of z){let $=String(q?.opId||"").trim(),Q=String(q?.sectionId||"").trim();if(!$||!Q)continue;let W=y.get($)||$,re=String(q?.result||"").trim();if(re==="ok"||re==="duplicate")await qn(W).catch(()=>{});else if(re==="conflict"){await qn(W).catch(()=>{});let we=p.find(Ne=>String(Ne.opId)===$)||null;we&&O.push({sectionId:Q,headingJson:we.headingJson,bodyJson:we.bodyJson})}}return O.length&&await Qf(n,O),!0};for(;s<2&&(s+=1,!!await w());)try{({deleteOps:a,upsertOps:c,structureOps:l}=await i())}catch{break}let S=null;try{({deleteOps:a,upsertOps:c,structureOps:l}=await i())}catch{}if(!a.length&&!c.length&&(S=l.length?l[l.length-1]:null),S){try{let p=Number(Cl.get(n)||0)||0,y=Date.now();if(p&&y-p<Hf)return}catch{}let f=S.payload?.nodes||null;if(Array.isArray(f)&&f.length){try{ot("sync.flush.structure_snapshot.start",{articleId:n,opId:S.id,nodesCount:f.length})}catch{}let p=await Qt(`/api/articles/${encodeURIComponent(n)}/structure/snapshot`,{method:"PUT",body:JSON.stringify({opId:S.payload?.opId||S.id,nodes:f})}),y=p?.updatedAt||null;y&&await Ri(n,y).catch(()=>{}),Number.isFinite(Number(p?.newStructureRev))?await Hi(n,Number(p.newStructureRev)):Number.isFinite(Number(p?.currentStructureRev))&&await Hi(n,Number(p.currentStructureRev));try{ot("sync.flush.structure_snapshot.done",{articleId:n,opId:S.id,status:String(p?.status||""),updatedAt:y||null,newStructureRev:Number.isFinite(Number(p?.newStructureRev))?Number(p.newStructureRev):null,currentStructureRev:Number.isFinite(Number(p?.currentStructureRev))?Number(p.currentStructureRev):null})}catch{}let k=String(p?.status||"");if(k==="ok"||k==="duplicate"){await qn(S.id).catch(()=>{});try{Cl.set(n,Date.now())}catch{}}}}try{(await sr(200)||[]).some(y=>Fs(y)&&String(y.articleId||"")===n)||(await Ba(n).catch(()=>{}),ot("sync.flush.localDraft.cleared",{articleId:n}))}catch{}}async function _r(){if(Rs)return null;if(!navigator.onLine)return!1;Rs=!0;try{let e=await sr(200),t=new Set,n=[];for(let o of e||[]){if(!Fs(o))continue;let i=String(o.articleId||"").trim();!i||t.has(i)||(t.add(i),n.push(i))}for(let o of n)try{await Zf(o,e)}catch(i){if(Bl(i))break}let r=await sr(50);for(let o of r)if(!Fs(o))try{await Xf(o),await qn(o.id);try{if(o.type==="section_upsert_content"&&String(o.articleId||"")==="inbox"){let i=String(o.payload?.sectionId||"").trim();i&&Gc(i)}}catch{}await Gf(o)}catch(i){let s=Number(i?.status||0)||null,a=s?`${s}: ${i?.message||"error"}`:i?.message||String(i||"error");if(await La(o.id,a),Kf(i,o)){try{console.warn("[offline][outbox] drop op",{opId:o.id,type:o.type,articleId:o.articleId,status:s,message:i?.message||null})}catch{}try{await qn(o.id)}catch{}continue}if(Bl(i))break;break}}finally{Rs=!1}try{let e=await sr(1);return Array.isArray(e)&&e.length>0}catch{return!0}}function po(){ur||(ur=window.setInterval(async()=>{try{await _r()===!1&&(window.clearInterval(ur),ur=null,Nl())}catch{}},15e3))}function $s(){ur&&(window.clearInterval(ur),ur=null)}function ep(){if(!kl){kl=!0,Nl();try{va()}catch{}window.addEventListener("online",()=>{_r().then(e=>{e?po():$s()}).catch(()=>{})}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&_r().then(e=>{e?po():$s()}).catch(()=>{})}),window.addEventListener("offline-outbox-changed",()=>{_r().then(e=>{e?po():$s()}).catch(()=>{po()})}),_r().then(e=>{e&&po()}).catch(()=>{})}}function tp(e={}){let t=!!(e&&e.force);Hs||vl&&!t||(vl=!0,Hs=!0,It={running:!0,processed:0,total:0,errors:0,phase:"index",lastError:null,startedAt:new Date().toISOString(),finishedAt:null},Qn(),(async()=>{try{if(!navigator.onLine){It={...It,running:!1,phase:"error",lastError:"offline",finishedAt:new Date().toISOString()},Qn();return}let n=new Map;try{let o=await Ca();n=new Map((o||[]).map(i=>[i.id,i]))}catch{}let r=[];try{Array.isArray(e?.initialIndex)?r=e.initialIndex:r=await Qt("/api/articles")||[],Mn(r).catch(()=>{})}catch(o){It={...It,running:!1,phase:"error",lastError:o?.message||String(o||"error"),finishedAt:new Date().toISOString()},Qn();return}It={...It,phase:"articles",total:Array.isArray(r)?r.length:0},Qn();for(let o of r||[]){try{let i=o.updatedAt||null,s=n.get(o.id);if(i&&s?.updatedAt===i&&s?.hasDocJson){try{let c=await Rn(o.id),l=c?.docJson&&typeof c.docJson=="object"?c.docJson:null;l&&Ir(o.id,l).catch(()=>{})}catch{}continue}let a=await Qt(`/api/articles/${encodeURIComponent(o.id)}`);await vr(a);try{let c=await Qt(`/api/articles/${encodeURIComponent(o.id)}/embeddings`);await Fi(o.id,c?.embeddings||[])}catch{}}catch{It={...It,errors:Number(It.errors||0)+1}}It={...It,processed:Number(It.processed||0)+1},Qn(),await new Promise(i=>setTimeout(i,120))}try{It={...It,phase:"inbox"},Qn();let o=await Qt("/api/articles/inbox?include_history=0");await vr(o)}catch{It={...It,errors:Number(It.errors||0)+1},Qn()}Ea().catch(()=>{}),It={...It,running:!1,phase:"done",finishedAt:new Date().toISOString()},Qn()}finally{Hs=!1}})().catch(()=>{}))}var di,kl,Rs,vl,Hs,ur,Rf,El,Hf,Cl,It,Us=je(()=>{Jr();jr();zi();Oi();Wt();vs();Vr();di="ttree_outline_autosave_queue_docjson_v1";kl=!1,Rs=!1,vl=!1,Hs=!1,ur=null,Rf=2e3,El=new Map,Hf=3e3,Cl=new Map;It={running:!1,processed:0,total:0,errors:0,phase:"idle",lastError:null,startedAt:null,finishedAt:null}});var Go={};vo(Go,{closeOutlineEditor:()=>Ad,enterOutlineSectionEditMode:()=>lm,flushOutlineAutosave:()=>pm,getOutlineActiveSectionId:()=>nm,getOutlineActiveSectionSnapshot:()=>rm,insertNewOutlineSectionAtEnd:()=>cm,insertNewOutlineSectionAtStart:()=>dm,insertOutlineSectionFromPlainTextAtStart:()=>um,insertOutlineSectionFromSectionFragmentsAtEnd:()=>am,openOutlineEditor:()=>fm,openPublicOutlineViewer:()=>mm,restoreOutlineSectionFromBlockHtml:()=>im,restoreOutlineSectionFromSectionFragments:()=>sm,revealOutlineSection:()=>xd});function hi(e,t){let n=null,r=String(t||"").trim();return!e||!r?null:(e.descendants((o,i)=>{if(n!==null)return!1;o?.type?.name==="image"&&String(o.attrs?.uploadToken||"")===r&&(n=i)}),n)}function ip(e){let t=String(e||"").trim();if(!t)return;let n=br.get(t)||null;if(n){br.delete(t);try{URL.revokeObjectURL(n)}catch{}}}function Gl(e,t=3e4){let n=String(e||"").trim();if(n){try{let r=wo.get(n)||null;r&&clearTimeout(r)}catch{}try{let r=setTimeout(()=>{try{wo.delete(n)}catch{}ip(n)},Math.max(0,Number(t)||0));wo.set(n,r)}catch{}}}function sp(e){try{if(!e||typeof e!="object")return e;let t=typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e)),n=r=>{if(!r||typeof r!="object")return;if(r.type==="image"&&r.attrs&&typeof r.attrs=="object"){let i=String(r.attrs.uploadToken||"").trim(),s=String(r.attrs.src||"");i&&s.startsWith("blob:")&&(r.attrs={...r.attrs,src:`${bi}${i}`})}let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(t),t}catch{return e}}function Pl(e){try{if(!e||typeof e!="object")return e;let t=typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e)),n=r=>{if(!r||typeof r!="object")return;if(r.type==="image"&&r.attrs&&typeof r.attrs=="object"){let i=String(r.attrs.uploadToken||"").trim(),s=String(r.attrs.src||"");i&&s.startsWith("blob:")&&(r.attrs={...r.attrs,src:`${bi}${i}`})}let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(t),t}catch{return e}}async function ap(e){try{if(!se||se.isDestroyed)return;let t=String(e||"").trim();if(!t)return;let n=await Ds({articleId:t,limit:200}).catch(()=>[]);if(!n.length)return;let r=new Map;for(let c of n){let l=String(c?.token||"").trim();l&&(c?.kind&&String(c.kind)!=="image"||c?.blob&&r.set(l,c.blob))}if(!r.size)return;let{state:o,view:i}=se,s=o.tr,a=!1;o.doc.descendants((c,l)=>{if(c?.type?.name!=="image")return;let d=String(c.attrs?.uploadToken||"").trim(),h=String(c.attrs?.src||""),g=h.startsWith(bi)?h.slice(bi.length).trim():"",w=d||g;if(!w)return;let S=r.get(w);if(!S)return;let f=br.get(w)||null;if(!f)try{f=URL.createObjectURL(S),br.set(w,f)}catch{f=null}if(!f)return;let p={...c.attrs,src:f,uploadToken:w};s=s.setNodeMarkup(l,void 0,p),a=!0}),a&&(s=s.setMeta(de,!0),i.dispatch(s))}catch{}}async function Ql(e){try{if(!navigator.onLine||!se||se.isDestroyed)return!1;let t=String(e||"").trim();if(!t)return!1;let n=await Ds({articleId:t,limit:50}).catch(()=>[]);if(!n.length)return!1;let r=!1;for(let o of n){let i=String(o?.token||"").trim();if(!i||o?.kind&&String(o.kind)!=="image")continue;let s=o?.blob||null;if(s)try{let a=s instanceof File?s:new File([s],o?.fileName||"image",{type:o?.mime||s.type||"application/octet-stream"}),c=await Wr(a),l=String(c?.url||"").trim();if(!l)throw new Error("Upload failed");try{let{state:d,view:h}=se,g=hi(d.doc,i);if(typeof g=="number"){let w=d.doc.nodeAt(g);if(w?.type?.name==="image"){let S={...w.attrs,src:l,uploadToken:null,title:String(w.attrs?.title||"").replace(/\s*\( \)\s*$/i,"").trim()},f=d.tr.setNodeMarkup(g,void 0,S);f=f.setMeta(de,!0),h.dispatch(f)}}}catch{}Gl(i),await Ps(i).catch(()=>{}),r=!0}catch(a){let c=a?.message||String(a||"error");await _s(i,c).catch(()=>{})}}if(r)try{Vt({delayMs:350})}catch{}return r}catch{return!1}}function _l(){try{let e=window?.localStorage?.getItem?.(Gs)||"";if(!e)return null;let t=JSON.parse(e);return!t||typeof t!="object"||!Array.isArray(t.sections)?null:{mode:t.mode==="cut"?"cut":"copy",sourceArticleId:typeof t.sourceArticleId=="string"?t.sourceArticleId:null,createdAt:typeof t.createdAt=="string"?t.createdAt:null,sections:t.sections}}catch{return null}}function Js(e){try{if(!e){window?.localStorage?.removeItem?.(Gs);return}window?.localStorage?.setItem?.(Gs,JSON.stringify(e))}catch{}}function yo(e){Fn=!!e,Fn||(nr=new Set);try{J?.outlineEditor&&J.outlineEditor.classList.toggle("outline-select-mode",Fn)}catch{}try{Zl()}catch{}}function cp(e){let t=String(e||"").trim();if(t){nr.has(t)?nr.delete(t):nr.add(t);try{Zl()}catch{}}}function Zl(){if(!J?.outlineEditor)return;J.outlineEditor.querySelectorAll(".outline-heading[data-section-id] .outline-heading__select").forEach(t=>{let r=t.closest(".outline-heading")?.getAttribute?.("data-section-id")||"",o=r&&nr.has(r);t.setAttribute("aria-checked",o?"true":"false"),t.style.display=Fn?"inline-flex":"none"})}function lp(e,t){let n=t instanceof Set?t:new Set,r=[];if(!e||!n.size)return r;let o=(i,s)=>{let a=String(i?.attrs?.id||"").trim(),c=a&&n.has(a);if(c&&!s){r.push({id:a,node:i});return}let l=i?.childCount>=3?i.child(2):null;if(l)try{l.forEach(d=>{d?.type?.name==="outlineSection"&&o(d,s||c)})}catch{}};try{e.forEach(i=>{i?.type?.name==="outlineSection"&&o(i,!1)})}catch{}return r}function ed(e){return JSON.parse(JSON.stringify(e))}function dp(e,t){let n=ed(e),r=o=>{if(!o||typeof o!="object")return;if(o.type==="outlineSection"){let s=t();o.attrs&&typeof o.attrs=="object"?o.attrs.id=s:o.attrs={id:s,collapsed:!!o.attrs?.collapsed}}let i=Array.isArray(o.content)?o.content:[];for(let s of i)r(s)};return r(n),n}async function up(e){let t=String(e||"");if(t){try{if(navigator?.clipboard?.writeText){await navigator.clipboard.writeText(t);return}}catch{}try{let n=document.createElement("textarea");n.value=t,n.setAttribute("readonly","true"),n.style.position="fixed",n.style.left="-9999px",n.style.top="0",document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n)}catch{}}}function td(e,{baseLevel:t=2,depth:n=0}={}){let r=e;if(!r||r.type?.name!=="outlineSection")return"";let o="",i="";try{let c=r.child(0);o=String(c?.textContent||"").trim()}catch{o=""}try{let c=r.child(1);i=c?String(c.textBetween(0,c.content.size,`
`)).trimEnd():""}catch{i=""}let s=Math.min(6,Math.max(1,Number(t)+Number(n||0))),a=[];o&&a.push(`${"#".repeat(s)} ${o}`),i&&a.push(i);try{let c=r.child(2);if(c){let l=[];c.forEach(d=>{if(d?.type?.name!=="outlineSection")return;let h=td(d,{baseLevel:t,depth:n+1});h&&l.push(h)}),l.length&&a.push(l.join(`

`))}}catch{}return a.filter(Boolean).join(`

`).trim()}function nd(e,t){try{let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return 1;let o=window.localStorage.getItem(Dl)||"",i=o?JSON.parse(o):{},s=i&&typeof i=="object"?i:{},a=(s[n]&&typeof s[n]=="object"?s[n]:{})||{},l=(Number(a[r]||0)||0)+1;return a[r]=l,s[n]=a,window.localStorage.setItem(Dl,JSON.stringify(s)),l}catch{return Date.now()}}function rd(e,t){try{let n=JSON.stringify({headingJson:e,bodyJson:t});return globalThis.TextEncoder?new TextEncoder().encode(n).length:n.length*2}catch{return 0}}function Or(e){try{let t=String(e||"").trim();if(!t)return;fn.add(t);let n=St||u.articleId||null;if(!n||u.article?.encrypted||js)return;js=setTimeout(()=>{js=null;try{if(!fn.size)return;let r=Array.from(fn);fn.clear();let o=Date.now();zt("delete_sections",{articleId:n,payload:{sectionIds:r,clientQueuedAt:o},coalesceKey:`delete:${n}`})}catch{}},0)}catch{}}function Io(e){let t=[],n=o=>{try{if(!o||o.type?.name!=="outlineSection")return null;for(let i=0;i<o.childCount;i+=1){let s=o.child(i);if(s?.type?.name==="outlineChildren")return s}return null}catch{return null}},r=(o,i)=>{try{if(!o)return;let s=0;o.forEach(a=>{if(!a||a.type?.name!=="outlineSection")return;let c=String(a.attrs?.id||"").trim();if(!c)return;t.push({sectionId:c,parentId:i||null,position:s,collapsed:!!a.attrs?.collapsed}),s+=1;let l=n(a);l&&r(l,c)})}catch{}};try{if(!e)return[];r(e,null)}catch{return[]}return t}function Ol(e){try{return Io(e).map(n=>`${n.parentId||""}|${n.position}|${n.sectionId}|${n.collapsed?1:0}`).join(`
`)}catch{return""}}function Rr(e){let t=[];try{if(!e)return t;e.descendants((n,r)=>{n?.type?.name==="outlineSection"&&t.push(r)})}catch{}return t}function Qs(e,t){try{if(!e||e.isDestroyed)return!1;let n=!!t;return e.commands.command(({state:r,dispatch:o})=>{let i=Rr(r.doc);if(!i.length)return!1;let s=r.tr;for(let a of i){let c=s.doc.nodeAt(a);!c||c.type?.name!=="outlineSection"||!!c.attrs?.collapsed!==n&&(s=s.setNodeMarkup(a,void 0,{...c.attrs,collapsed:n}))}s=s.setMeta(de,!0);try{n&&Ae&&(Ae.getState(r)||{}).editingSectionId&&(s=s.setMeta(Ae,{type:"exit"}))}catch{}try{if(n&&TextSelection){let a=wt(r.doc,r.selection.$from),c=typeof a=="number"?a:i[0],l=s.doc.nodeAt(c);if(l?.type?.name==="outlineSection"){let d=l.child(0),g=c+1+d.nodeSize-1;s=s.setSelection(TextSelection.near(s.doc.resolve(g),-1))}}}catch{}return o(s.scrollIntoView()),!0})}catch{return!1}}function fp({articleId:e,editor:t}={}){try{let n=String(e||"").trim();if(!n||!t)return;Cn=!0;try{if((Ae?.getState?.(t.state)||null)?.editingSectionId){Nt&&(clearTimeout(Nt),Nt=null);return}}catch{}Nt&&clearTimeout(Nt),Nt=setTimeout(()=>{Nt=null;try{if(!Cn)return;let r=t.state?.doc,o=Io(r);if(!o.length)return;try{let i=null;try{i=o.filter(s=>s&&(s.parentId==null||s.parentId==="")&&Number(s.position)>=0).sort((s,a)=>Number(s.position)-Number(a.position)).slice(0,3).map(s=>String(s.sectionId||""))}catch{i=null}ot("outline.enqueue.structure_snapshot",{articleId:n,nodesCount:o.length,rootFirst:i})}catch{}zt("structure_snapshot",{articleId:n,payload:{nodes:o},coalesceKey:`structure:${n}`}),Cn=!1}catch{}},rp)}catch{}}async function ra({articleId:e,doc:t,sectionId:n,reason:r}){let o=String(e||"").trim(),i=String(n||"").trim();if(!o||!i||!t)return!1;let s=it(t,i),a=typeof s=="number"?t.nodeAt(s):null;if(!a||a.type?.name!=="outlineSection")return!1;try{if(!hr(t,i))return!1}catch{return!1}let c=a.child(0),l=a.child(1),d=c?.toJSON?c.toJSON():null,h=l?.toJSON?l.toJSON():null;if(!d||!h)return!1;try{d=Pl(d),h=Pl(h)}catch{}let g=rd(d,h);if(g>wi){let f=Date.now();return(!qs||f-qs>5e3)&&(qs=f,Ee(`\u0411\u043B\u043E\u043A \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 (${Math.ceil(g/1024)} KB). \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C: ${Math.ceil(wi/1024)} KB. \u0420\u0430\u0437\u0431\u0435\u0439\u0442\u0435 \u0431\u043B\u043E\u043A \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E.`)),!1}let w=Date.now(),S=nd(o,i);try{ot("outline.enqueue.section_upsert_content",{articleId:o,sectionId:i,seq:S,bytes:g,reason:String(r||"")})}catch{}await zt("section_upsert_content",{articleId:o,payload:{sectionId:i,headingJson:d,bodyJson:h,seq:S,clientQueuedAt:w},coalesceKey:`content:${o}:${i}`}).catch(()=>{});try{if(Cn){let f=Io(t);if(f.length){let p=null;try{p=f.filter(y=>y&&(y.parentId==null||y.parentId==="")&&Number(y.position)>=0).sort((y,k)=>Number(y.position)-Number(k.position)).slice(0,3).map(y=>String(y.sectionId||""))}catch{p=null}try{ot("outline.enqueue.structure_snapshot",{articleId:o,nodesCount:f.length,reason:"after_section_upsert",rootFirst:p})}catch{}zt("structure_snapshot",{articleId:o,payload:{nodes:f},coalesceKey:`structure:${o}`})}Cn=!1,Nt&&(clearTimeout(Nt),Nt=null)}}catch{}try{wr.set(i,vi(a)),Sr.delete(i)}catch{}try{Promise.resolve().then(()=>(Us(),zs)).then(f=>f.flushOutboxOnce?.()).catch(()=>{})}catch{}return!0}function pp(e){try{if(!e||e.isDestroyed)return;let t=Ae?.getState?.(e.state)||null,n=String(t?.editingSectionId||"").trim();if(!n)return;let r=St||u.articleId||null;if(!r)return;Ws=n,mr&&clearTimeout(mr),mr=setTimeout(()=>{mr=null;try{if(!se||se.isDestroyed)return;let o=Ae?.getState?.(se.state)||null,i=String(o?.editingSectionId||"").trim();if(!i||i!==Ws)return;ra({articleId:r,doc:se.state.doc,sectionId:i,reason:"edit_heartbeat"})}catch{}},op)}catch{}}function Zs(){try{return window?.localStorage?.getItem?.(mp)==="1"}catch{return!1}}function sn(...e){Zs()}function pr(){try{return window?.localStorage?.getItem?.(hp)==="1"}catch{return!1}}function Hr(e,t={}){pr()}function yp(){try{return window?.localStorage?.getItem?.(gp)==="1"}catch{return!1}}function Dt(e,t={}){yp()}function od(e){let t=String(e||"").replace(/\s+/g," ").trim();return t?t.length>60?t.slice(0,60):t:null}function id(e){return String(e||"").replace(/\s+/g," ").trim().toUpperCase()}function bp(e,t="tag"){let n=new Map,r=new Map,o=new Map,i=new Map;return e?(e.descendants((s,a)=>{if(s?.type?.name!=="outlineSection")return;let c=String(s.attrs?.id||"");c&&i.set(c,a);let l=new Set,d=h=>{h?.descendants?.(g=>{if(g?.type?.name!==t)return;let w=od(g.attrs?.label||g.textContent||"");if(!w)return;let S=id(g.attrs?.key||w);S&&(n.set(S,(n.get(S)||0)+1),r.set(S,S),l.add(S))})};try{d(s.child(0)),d(s.child(1))}catch{}if(c)for(let h of l)o.has(h)||o.set(h,new Set),o.get(h).add(c);return!1}),{counts:n,labelByKey:r,sectionIdsByKey:o,sectionPosById:i}):{counts:n,labelByKey:r,sectionIdsByKey:o,sectionPosById:i}}function sd(){let e=J?.outlineTagsBar;if(!e)return;let t=Array.from(xr.counts.entries()).map(([n,r])=>({key:n,label:xr.labelByKey.get(n)||n,count:r})).filter(n=>n.key&&n.count>0).sort((n,r)=>r.count!==n.count?r.count-n.count:n.label.localeCompare(r.label));if(!t.length){e.innerHTML="",e.classList.add("hidden");return}e.classList.remove("hidden"),e.innerHTML=t.map(n=>{let r=tr&&tr===n.key?"true":"false",o=xo(n.label);return`<button type="button" class="outline-tag-pill" data-tag-key="${xo(n.key)}" aria-pressed="${r}">${o} <span class="outline-tag-pill__count">(${n.count})</span></button>`}).join("")}function ad(){if(se){if(xr=bp(se.state.doc,"tag"),tr&&!xr.counts.has(tr)){tr=null;try{xi?.(null)}catch{}}sd()}}function wp(e){let t=String(e||"");if(!t||!se)return;let n=xr.sectionIdsByKey.get(t);if(!n||!n.size)return;let r=new Set;for(let s of n){let a=xr.sectionPosById.get(s);if(typeof a=="number"){r.add(a);try{let c=se.state.doc.resolve(Math.min(se.state.doc.content.size,a+1));for(let l=c.depth;l>0;l-=1)c.node(l)?.type?.name==="outlineSection"&&r.add(c.before(l))}catch{}}}let o=se.state.tr,i=!1;for(let s of r){let a=o.doc.nodeAt(s);!a||a.type?.name!=="outlineSection"||a.attrs?.collapsed&&(o=o.setNodeMarkup(s,void 0,{...a.attrs,collapsed:!1}),i=!0)}i&&(o=o.setMeta(de,!0),se.view.dispatch(o))}function Sp({setActiveTagKey:e}){let t=J?.outlineTagsBar;if(!t)return()=>{};let n=r=>{let o=r.target?.closest?.("[data-tag-key]");if(!o)return;let i=String(o.getAttribute("data-tag-key")||"");if(!i)return;let s=tr===i?null:i;tr=s;try{e(s)}catch{}s&&wp(s),sd()};return t.addEventListener("click",n),()=>t.removeEventListener("click",n)}function an(e){let t=String(e||"").trim();if(!t.includes("|"))return null;let n=t;n.startsWith("|")&&(n=n.slice(1)),n.endsWith("|")&&(n=n.slice(0,-1));let r=n.split("|").map(o=>o.trim());return r.length<2||r.every(o=>!o)?null:r}function Ai(e){let t=String(e||"").trim();return t?/^:?-{3,}:?$/.test(t):!1}function gr(e){let t=(Array.isArray(e)?e:[]).map(i=>String(i||"").replace(/\r/g,"").trimEnd()).filter(i=>i.length>0);if(t.length<2)return null;let n=an(t[0]),r=an(t[1]);if(!n||!r||n.length!==r.length||!r.every(Ai))return null;let o=[];for(let i=2;i<t.length;i+=1){let s=an(t[i]);if(!s||s.length!==n.length)return null;o.push(s)}return{header:n,rows:o}}function yr(e){let t=(Array.isArray(e)?e:[]).map(s=>String(s||"").replace(/\r/g,"").trimEnd()).filter(s=>s.length>0);if(t.length<1)return null;let n=an(t[0]);if(!n)return null;let r=n.length;if(r<2)return null;let o=[n];for(let s=1;s<t.length;s+=1){let a=an(t[s]);if(!a||a.length!==r)break;if(s===1&&a.every(Ai))return null;o.push(a)}return o.flat().filter(s=>String(s||"").trim().length>0).length<2?null:{rows:o}}function oa(e){let t=String(e||"").replace(/\r/g,"").split(`
`).map(n=>String(n||"").trimEnd());for(;t.length&&!t[0].trim();)t.shift();for(;t.length&&!t[t.length-1].trim();)t.pop();return t}function Zn(e,t){if(!e||!t)return null;let{header:n,rows:r,withHeader:o}=t,i=e.nodes.table,s=e.nodes.tableRow,a=e.nodes.tableCell,c=e.nodes.tableHeader,l=e.nodes.paragraph;if(!i||!s||!a||!c||!l||typeof e.text!="function")return null;let d=S=>l.create({},S?[e.text(String(S))]:[]),h=(S,f)=>S.map(p=>(f?c:a).create({},[d(p)])),g=(S,f)=>s.create({},h(S,f)),w=[];return o&&Array.isArray(n)&&n.length&&w.push(g(n,!0)),(Array.isArray(r)?r:[]).forEach(S=>w.push(g(S,!1))),w.length?i.create({},w):null}function xp(e,t){try{let n=e?.selection,r=n?.$from;if(!n?.empty||!r)return Ke("table.merge.skip",{reason:"no-cursor"}),!1;if(r.parent?.type?.name!=="paragraph")return!1;if(r.parentOffset!==0)return Ke("table.merge.skip",{reason:"not-at-paragraph-start"}),!1;let o=null,i=null,s=null;for(let Z=r.depth;Z>0;Z-=1){let pe=r.node(Z)?.type?.name;if(!s&&(pe==="tableCell"||pe==="tableHeader")?s=Z:!i&&pe==="tableRow"?i=Z:!o&&pe==="table"&&(o=Z),o&&i&&s)break}if(o==null||i==null||s==null)return Ke("table.merge.skip",{reason:"not-in-table"}),!1;let a=r.depth===s+1,c=r.index(o),l=r.index(i),d=r.index(s);if(Ke("table.merge.check",{parent:r.parent?.type?.name||null,parentOffset:r.parentOffset,tableDepth:o,rowDepth:i,cellDepth:s,isDirectParagraphInCell:a,rowIndex:c,colIndex:l,childIndexInCell:d}),!a)return Ke("table.merge.skip",{reason:"paragraph-not-direct-child-of-cell"}),!1;if(c!==0||l!==0||d!==0)return Ke("table.merge.skip",{reason:"not-in-first-cell",rowIndex:c,colIndex:l,childIndexInCell:d}),!1;let h=r.before(o),g=e.doc.nodeAt(h);if(!g||g.type?.name!=="table")return Ke("table.merge.skip",{reason:"no-current-table",tablePos:h}),!1;let w=e.doc.resolve(h),S=w.index(),f=w.parent;if(!f||S<=0)return Ke("table.merge.skip",{reason:"no-prev-sibling",idx:S,parent:f?.type?.name||null}),!1;let p=null,y=S-1;for(;y>=0;){let Z=f.child(y);if(Z?.type?.name==="paragraph"&&!String(Z.textContent||"").trim()){y-=1;continue}p=Z;break}if(!p||p.type?.name!=="table")return Ke("table.merge.skip",{reason:"no-prev-table"}),!1;let k=p.childCount?p.child(0):null,E=g.childCount?g.child(0):null;if(!k||!E)return Ke("table.merge.skip",{reason:"missing-rows"}),!1;if(k.childCount!==E.childCount)return Ke("table.merge.skip",{reason:"different-columns",prevCols:k.childCount,curCols:E.childCount}),!1;let L=k.childCount,O=(Z,pe)=>{try{return Z?.type?.name==="tableRow"&&Z.childCount===pe}catch{return!1}};for(let Z=0;Z<p.childCount;Z+=1){let pe=p.child(Z);if(!O(pe,L))return Ke("table.merge.skip",{reason:"prev-row-mismatch",rowIndex:Z,colsExpected:L,colsGot:pe?.childCount??null}),!1}for(let Z=0;Z<g.childCount;Z+=1){let pe=g.child(Z);if(!O(pe,L))return Ke("table.merge.skip",{reason:"cur-row-mismatch",rowIndex:Z,colsExpected:L,colsGot:pe?.childCount??null}),!1}let z=h;for(let Z=S-1;Z>=y;Z-=1)z-=f.child(Z).nodeSize;let q=p.childCount,$=e.doc.type.schema,Q=z+p.nodeSize,W=e.tr;h>Q&&(W=W.delete(Q,h));let re=Q;W=W.delete(re,re+g.nodeSize);let we=W.doc.nodeAt(z);if(!we||we.type?.name!=="table")return Ke("table.merge.skip",{reason:"prev-after-missing",prevStart:z,prevAfterType:we?.type?.name||null}),!1;Ke("table.merge.plan",{idx:S,prevIdx:y,prevStart:z,prevEnd:Q,tablePos:h,tablePos2:re,cols:L,prevRowCount:q,curRowCount:g.childCount});try{let Z=we.content.append(g.content),pe=$.nodes.table.create(we.attrs,Z,we.marks);W=W.replaceWith(z,z+we.nodeSize,pe)}catch(Z){return Ke("table.merge.error",{message:String(Z?.message||Z||""),stack:String(Z?.stack||"")}),!1}let Ne=W.doc.nodeAt(z);Ke("table.merge.afterReplace",{mergedType:Ne?.type?.name||null,mergedRows:Ne?.type?.name==="table"?Ne.childCount:null});try{let Z=ze?.pmStateMod?.TextSelection||ze?.pm?.state?.TextSelection||null;if(Ne&&Ne.type?.name==="table"){let pe=Math.min(q,Math.max(0,Ne.childCount-1));if(Ne.child(pe)?.childCount){let yt=(()=>{let jt=z+1;for(let en=0;en<pe;en+=1)jt+=Ne.child(en).nodeSize;return jt+=1,jt})(),kt=Math.min(W.doc.content.size,yt+2);Z&&(W=W.setSelection(Z.near(W.doc.resolve(kt),1)))}}}catch(Z){Ke("table.merge.selection.error",{message:String(Z?.message||Z||""),stack:String(Z?.stack||"")})}W=W.setMeta(de,!0);try{t(W.scrollIntoView())}catch(Z){return Ke("table.merge.dispatch.error",{message:String(Z?.message||Z||""),stack:String(Z?.stack||"")}),!1}return!0}catch(n){try{Ke("table.merge.exception",{message:String(n?.message||n||""),stack:String(n?.stack||"")})}catch{}return!1}}function Ap(e,t,n,r){try{let o=(pe,We={})=>{},i=(pe={})=>{};if(!n)return!1;if(!r)return o("no-TextSelection"),!1;let s=e?.selection;if(!s?.empty)return o("selection-not-empty"),!1;let a=s.$from||null;if(!a)return o("no-$from"),!1;i({from:s.from,parent:a.parent?.type?.name||null,parentOffset:a.parentOffset??null});let c=it(e.doc,n);if(typeof c!="number")return o("section-not-found"),!1;let l=e.doc.nodeAt(c);if(!l||l.type?.name!=="outlineSection")return o("not-outlineSection",{found:l?.type?.name||null}),!1;let d=l.child(0),h=l.child(1);if(!d||d.type?.name!=="outlineHeading")return o("missing-heading",{found:d?.type?.name||null}),!1;if(!h||h.type?.name!=="outlineBody")return o("missing-body",{found:h?.type?.name||null}),!1;let g=String(d.textContent||"").replace(/\u00a0/g," "),w=!!g.trim(),S=/\s$/.test(g),f=null;for(let pe=a.depth;pe>=0;pe-=1)if(a.node(pe)?.type?.name==="outlineBody"){f=pe;break}if(f==null)return o("not-in-outlineBody",{parent:a.parent?.type?.name||null}),!1;if(a.index(f)!==0)return o("not-first-body-child",{index:a.index(f)}),!1;if(a.parent?.type?.name!=="paragraph")return o("parent-not-paragraph",{parent:a.parent?.type?.name||null}),!1;if((a.parentOffset??null)!==0)return o("not-at-paragraph-start",{parentOffset:a.parentOffset??null}),!1;let p=c+1,y=s.from,k=a.parent,E=0,L=null;for(let pe=0;pe<k.childCount;pe+=1){let We=k.child(pe);if(We.type?.name==="hardBreak"){L=E;break}E+=We.nodeSize}let O=y+(L??k.content.size);if(O<=y)return o("empty-first-line"),!1;let z=e.doc.slice(y,O);if(!z?.content||z.content.size<=0)return o("empty-slice"),!1;let q=L==null?O:O+1,$=p+1,Q=p+d.nodeSize-1,W=e.tr;w&&!S&&(W=W.insertText(" ",Q),W=W.setMeta(de,!0));let re=W.mapping.map(Q,1),we=re;W=W.insert(re,z.content);let Ne=W.mapping.map(y,1),Z=W.mapping.map(q,-1);W=W.delete(Ne,Z);try{W=W.setSelection(r.create(W.doc,we))}catch{}return W=W.setMeta(de,!0),t(W.scrollIntoView()),!0}catch(o){return!1}}function Ip(e,t){try{if(!e?.doc||!t)return null;let n=it(e.doc,t);if(typeof n!="number")return null;let r=e.doc.nodeAt(n);if(!r)return null;let o=r.child(0),i=r.child(1);if(!i||i.type?.name!=="outlineBody")return null;let a=n+1+o.nodeSize+1,c=[],l=0,d=0;for(;d<i.childCount;){let g=i.child(d),w=a+l;if(g.type?.name!=="paragraph"){l+=g.nodeSize,d+=1;continue}let S=er(g).trim();if(S.includes(`
`)&&S.includes("|")){let W=oa(S),re=gr(W),we=re?null:yr(W),Ne=re?{header:re.header,rows:re.rows,withHeader:!0}:we?{header:null,rows:we.rows,withHeader:!1}:null,Z=null;if(Ne)try{Z=Zn(e.schema,Ne)}catch(pe){sn("convert: buildTableNode error (single)",{message:String(pe?.message||pe||""),stack:String(pe?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),Z=null}if(Z){let pe=w,We=w+g.nodeSize;c.push({from:pe,to:We,tableNode:Z}),sn("convert: single-paragraph table",{sectionId:t,from:pe,to:We,lines:W}),l+=g.nodeSize,d+=1;continue}}let f=an(S);if(!f||d+1>=i.childCount){if(f){let W=[S],re=l+g.nodeSize,we=d+1;for(;we<i.childCount;){let We=i.child(we);if(We.type?.name!=="paragraph")break;let yt=er(We).trim();if(!yt)break;let kt=an(yt);if(!kt||kt.length!==f.length)break;W.push(yt),re+=We.nodeSize,we+=1}let Ne=yr(W),Z=Ne?{header:null,rows:Ne.rows,withHeader:!1}:null,pe=null;if(Z)try{pe=Zn(e.schema,Z)}catch(We){sn("convert: buildTableNode error (rows-only)",{message:String(We?.message||We||""),stack:String(We?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),pe=null}if(pe){c.push({from:w,to:a+re,tableNode:pe}),sn("convert: rows-only table",{sectionId:t,from:w,to:a+re,lines:W}),l=re,d=we;continue}}l+=g.nodeSize,d+=1;continue}let p=i.child(d+1);if(p.type?.name!=="paragraph"){l+=g.nodeSize,d+=1;continue}let y=er(p).trim(),k=an(y);if(!k||k.length!==f.length||!k.every(Ai)){l+=g.nodeSize,d+=1;continue}let E=[S,y],L=l+g.nodeSize+p.nodeSize,O=d+2;for(;O<i.childCount;){let W=i.child(O);if(W.type?.name!=="paragraph")break;let re=er(W).trim();if(!re)break;let we=an(re);if(!we||we.length!==f.length)break;E.push(re),L+=W.nodeSize,O+=1}let z=gr(E),q=z?null:yr(E),$=z?{header:z.header,rows:z.rows,withHeader:!0}:q?{header:null,rows:q.rows,withHeader:!1}:null,Q=null;if($)try{Q=Zn(e.schema,$)}catch(W){sn("convert: buildTableNode error (multi)",{message:String(W?.message||W||""),stack:String(W?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),Q=null}if(!Q){l+=g.nodeSize,d+=1;continue}c.push({from:w,to:a+L,tableNode:Q}),sn("convert: multi-paragraph table",{sectionId:t,from:w,to:a+L,lines:E}),l=L,d=O}if(!c.length)return null;c.sort((g,w)=>w.from-g.from);let h=e.tr;for(let g of c)h=h.replaceRangeWith(g.from,g.to,g.tableNode);return h=h.setMeta(de,!0),h}catch{return null}}function er(e){if(!e)return"";let t="";return e.descendants(n=>{n.isText?t+=n.text||"":n.type?.name==="hardBreak"&&(t+=`
`)}),t}function Hl(e){try{if(!e||e.type!=="paragraph")return"";let t=[],n=r=>{if(!r)return;if(r.type==="text"){t.push(String(r.text||""));return}if(r.type==="hardBreak"){t.push(`
`);return}let o=Array.isArray(r.content)?r.content:[];for(let i of o)n(i)};return n(e),t.join("")}catch{return""}}function kp(e){if(!e)return null;let{header:t,rows:n}=e;if(!Array.isArray(t)||t.length===0)return null;let r=s=>({type:"paragraph",content:String(s||"").length?[{type:"text",text:String(s||"")}]:[]}),o={type:"tableRow",content:t.map(s=>({type:"tableHeader",content:[r(s)]}))},i=(Array.isArray(n)?n:[]).map(s=>({type:"tableRow",content:s.map(a=>({type:"tableCell",content:[r(a)]}))}));return{type:"table",content:[o,...i]}}function vp(e){if(!e)return!1;try{let{doc:t,schema:n}=e.state,r=[];if(t.descendants((i,s)=>{if(i.type?.name!=="outlineBody")return;let a=s+1,c=0,l=0;for(;l<i.childCount;){let d=i.child(l),h=a+c;if(d.type?.name!=="paragraph"){c+=d.nodeSize,l+=1;continue}let g=er(d).trim();if(g.includes(`
`)&&g.includes("|")){let q=oa(g),$=gr(q),Q=$?null:yr(q),W=$?{header:$.header,rows:$.rows,withHeader:!0}:Q?{header:null,rows:Q.rows,withHeader:!1}:null,re=W?Zn(n,W):null;if(re){r.push({from:h,to:h+d.nodeSize,tableNode:re}),c+=d.nodeSize,l+=1;continue}}let w=an(g);if(!w){c+=d.nodeSize,l+=1;continue}if(l+1>=i.childCount){let q=yr([g]),$=q?{header:null,rows:q.rows,withHeader:!1}:null,Q=$?Zn(n,$):null;Q&&r.push({from:h,to:h+d.nodeSize,tableNode:Q}),c+=d.nodeSize,l+=1;continue}let S=i.child(l+1);if(S.type?.name!=="paragraph"){c+=d.nodeSize,l+=1;continue}let f=er(S).trim(),p=an(f);if(!p||p.length!==w.length||!p.every(Ai)){let q=[g],$=c+d.nodeSize,Q=l+1;for(;Q<i.childCount;){let Ne=i.child(Q);if(Ne.type?.name!=="paragraph")break;let Z=er(Ne).trim();if(!Z)break;let pe=an(Z);if(!pe||pe.length!==w.length)break;q.push(Z),$+=Ne.nodeSize,Q+=1}let W=yr(q),re=W?{header:null,rows:W.rows,withHeader:!1}:null,we=re?Zn(n,re):null;if(we){r.push({from:h,to:a+$,tableNode:we}),c=$,l=Q;continue}c+=d.nodeSize,l+=1;continue}let y=[g,f],k=c+d.nodeSize+S.nodeSize,E=l+2;for(;E<i.childCount;){let q=i.child(E);if(q.type?.name!=="paragraph")break;let $=er(q).trim();if(!$)break;let Q=an($);if(!Q||Q.length!==w.length)break;y.push($),k+=q.nodeSize,E+=1}let L=gr(y),O=L?{header:L.header,rows:L.rows,withHeader:!0}:null,z=O?Zn(n,O):null;if(!z){c+=d.nodeSize,l+=1;continue}r.push({from:h,to:a+k,tableNode:z}),c=k,l=E}}),!r.length)return!1;r.sort((i,s)=>s.from-i.from);let o=e.state.tr;for(let i of r)o=o.replaceRangeWith(i.from,i.to,i.tableNode);return o=o.setMeta(de,!0),e.view.dispatch(o),!0}catch{return!1}}function $r(){let e=Date.now();if(!(e-Rl<900)){Rl=e;try{Ee("\u0414\u043B\u044F \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Enter \u0438\u043B\u0438 \u0434\u0432\u043E\u0439\u043D\u043E\u0439 \u043A\u043B\u0438\u043A \u043C\u044B\u0448\u043A\u043E\u0439. Esc \u0434\u043B\u044F \u0432\u044B\u0445\u043E\u0434\u0430.")}catch{}}}function ea(e=""){let t=document.createElement("div");return t.innerHTML=e||"",(t.textContent||"").replace(/\u00a0/g," ").trim()}function $n(e=""){return String(e||"").replace(/\u00a0/g," ").replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}function ta(e=""){let t=String(e||""),n=0;for(let r=0;r<t.length;r+=1)n=n*31+t.charCodeAt(r)>>>0;return String(n)}function Dr(e=""){return ta(String(e||"").slice(0,12e3))}function $t(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`sec-${Date.now()}-${Math.random().toString(16).slice(2)}`}function cd({loading:e=!1}={}){J.outlineEditor&&(J.outlineEditor.innerHTML=`
    <div class="outline-editor__body">
      <div class="outline-editor__content" id="outlineEditorContent"></div>
      <div class="outline-editor__loading ${e?"":"hidden"}">\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440\u2026</div>
    </div>
  `,Ml||(Ml=!0))}function ld(e){let t=String(e||"").trim();if(!t)return null;let n=t.match(/(-?\d+(?:\.\d+)?)%/);if(!n)return null;let r=Number.parseFloat(n[1]);return Number.isFinite(r)?r:null}function Tn(e){let t=Number(e);return Number.isFinite(t)?Math.max(0,Math.min(100,t)):0}function dd(e){try{let t=e?.dataset?.ttPct||"",n=Number.parseFloat(String(t||""));if(Number.isFinite(n)&&n>0)return n;let r=ld(e?.style?.width||"");return r!=null&&r>0?r:null}catch{return null}}function Ii(e,t){try{let n=Tn(t);return e.dataset.ttPct=n.toFixed(4),e.style.width=`${n.toFixed(4)}%`,e.style.minWidth="",!0}catch{return!1}}function Si(e,{insertIndex:t,newColPct:n=10}={}){try{let r=e?.view;if(!r)return!1;let o=Number(t);if(!Number.isFinite(o)||o<0)return!1;let i=r.domAtPos(r.state.selection.from),a=((i?.node&&i.node.nodeType===1?i.node:i?.node?.parentElement)||null)?.closest?.("table")||null;if(!a)return!1;let c=a.querySelector("colgroup");if(!c)return!1;let l=Array.from(c.querySelectorAll("col"));if(!l.length||o>=l.length)return!1;let d=100/l.length,h=l.map(L=>dd(L)??d),g=Tn(n);h[o]=g;let w=o-1,S=w>=0?h.slice(0,w+1).reduce((L,O)=>L+O,0):0,f=o+1,p=Math.max(0,l.length-f),y=p>0?h.slice(f).reduce((L,O)=>L+O,0):0,k=100-S-g;if(k<0){let L=Math.max(0,o-1),O=Math.max(0,h[L]-1),z=Math.abs(k),q=Math.min(O,z);h[L]=Math.max(1,h[L]-q),k=100-h.slice(0,w+1).reduce(($,Q)=>$+Q,0)-g,k=Math.max(0,k)}if(p>0)if(y>0){let L=k/y;for(let O=f;O<l.length;O+=1)h[O]*=L}else{let L=k/p;for(let O=f;O<l.length;O+=1)h[O]=L}let E=h.reduce((L,O)=>L+O,0);if(E>0&&Math.abs(E-100)>.01){let L=100-E,O=l.length-1;h[O]=Tn(h[O]+L),E=h.reduce((z,q)=>z+q,0)}for(let L=0;L<l.length;L+=1)Ii(l[L],h[L]);try{a.style.width="100%",a.style.maxWidth="100%",a.style.tableLayout="fixed"}catch{}return!0}catch{return!1}}function yi(e){try{if(!e)return!1;let t=e.querySelector("colgroup");if(!t)return!1;let n=Array.from(t.querySelectorAll("col"));if(!n.length)return!1;let r=e.getBoundingClientRect();if(!Number.isFinite(r.width)||r.width<=0)return!1;let o=e.querySelector("tbody tr");if(!o)return!1;let i=Array.from(o.children||[]).filter(c=>c&&c.nodeType===1);if(!i.length)return!1;let s=[];for(let c=0;c<n.length;c+=1){let l=i[c]||null;if(!l){s.push(0);continue}let d=l.getBoundingClientRect();s.push(Number.isFinite(d.width)?d.width:0)}let a=s.reduce((c,l)=>c+(Number.isFinite(l)?l:0),0);if(!(a>0))return!1;for(let c=0;c<n.length;c+=1){let l=Tn(s[c]/a*100);Ii(n[c],l)}return!0}catch{return!1}}function qt(e){try{if(!e?.state?.selection)return null;let t=e.state.selection;try{let o=t?.$anchorCell?.pos,i=t?.$headCell?.pos,s=Number.isFinite(o)?o:Number.isFinite(i)?i:null;if(s!=null){let a=e.nodeDOM?.(s)||null;if(a&&a.nodeType===1)return a.closest?.("table")||null}}catch{}let n=e.domAtPos(t.from);return((n?.node&&n.node.nodeType===1?n.node:n?.node?.parentElement)||null)?.closest?.("table")||null}catch{return null}}function Ep(e){try{let t=e?.state?.selection||null,n=t?.$from||null;if(!n)return null;try{let s=t?.$anchorCell?.pos,a=t?.$headCell?.pos,c=Number.isFinite(s)?s:Number.isFinite(a)?a:null;if(c!=null){let l=e.nodeDOM?.(c)||null;if(l&&l.nodeType===1)return l}}catch{}let r=null;for(let s=n.depth;s>=0;s-=1){let a=n.node(s)?.type?.name;if(a==="tableCell"||a==="tableHeader"){r=s;break}}if(r!=null){let s=n.before(r),a=e.nodeDOM?.(s)||null;if(a&&a.nodeType===1)return a}let o=e.domAtPos(t.from);return((o?.node&&o.node.nodeType===1?o.node:o?.node?.parentElement)||null)?.closest?.("td,th")||null}catch{return null}}function zr(e){try{if(!e)return null;let t=e.querySelector("colgroup");if(!t)return null;let n=Array.from(t.querySelectorAll("col"));if(!n.length)return null;let r=n.map(l=>dd(l));if(r.some(l=>typeof l=="number"&&Number.isFinite(l)&&l>0)){let l=100/n.length;return r.map(d=>typeof d=="number"&&Number.isFinite(d)&&d>0?d:l)}let i=e.querySelector("tbody tr");if(!i)return null;let s=Array.from(i.children||[]).filter(l=>l&&l.nodeType===1);if(s.length<n.length)return null;let a=[];for(let l=0;l<n.length;l+=1){let d=s[l].getBoundingClientRect();a.push(Number.isFinite(d.width)?d.width:0)}let c=a.reduce((l,d)=>l+(Number.isFinite(d)?d:0),0);return c>0?a.map(l=>Tn(l/c*100)):null}catch{return null}}function Ur(e,t){try{if(!e)return!1;let n=e.querySelector("colgroup");if(!n)return!1;let r=Array.from(n.querySelectorAll("col"));if(!r.length||!Array.isArray(t)||t.length!==r.length)return!1;for(let o=0;o<r.length;o+=1)Ii(r[o],t[o]);try{e.style.width="100%",e.style.maxWidth="100%",e.style.tableLayout="fixed"}catch{}return!0}catch{return!1}}function ud(e,t){try{let n=Array.isArray(e)?e.map(h=>Number(h)||0):null,r=Number(t);if(!n||!Number.isFinite(r)||r<0||r>=n.length||n.length<=1)return null;let o=Math.max(0,n[r]||0),i=n.slice(0,r),s=n.slice(r+1),a=s.reduce((h,g)=>h+(Number.isFinite(g)?g:0),0),c=s;if(s.length)if(a>0){let h=(a+o)/a;c=s.map(g=>Number.isFinite(g)?g*h:0)}else{let h=(o||0)/s.length;c=s.map(()=>h)}else i.length&&(i[i.length-1]=Math.max(1,(i[i.length-1]||0)+o));let l=[...i,...c].map(h=>Tn(h)),d=l.reduce((h,g)=>h+(Number.isFinite(g)?g:0),0);return d>0&&Math.abs(d-100)>.01&&(l[l.length-1]=Tn(l[l.length-1]+(100-d))),l}catch{return null}}function Mt(e){try{let t=mt?.TableMap||null,n=e?.selection||null,r=n?.$from||null,i=n?.$anchorCell||null||r||null;if(!i)return null;let s=null;for(let p=i.depth;p>=0;p-=1)if(i.node(p)?.type?.name==="table"){s=p;break}if(s==null)return null;let a=i.before(s),c=e.doc.nodeAt(a);if(!c||c.type?.name!=="table")return null;let l=null;for(let p=s+1;p<=i.depth;p+=1){let y=i.node(p)?.type?.name;if(y==="tableCell"||y==="tableHeader"){l=p;break}}if(l==null)return null;let d=i.before(l),h=t?.get?t.get(c):null;if(!h)return null;let g=d-a-1,w=h.findCell(g),S=Number(w?.left??0),f=Number(w?.top??0);return{tablePos:a,tableNode:c,map:h,colIndex:S,rowIndex:f}}catch{return null}}function Ks(e){try{let t=[],n=e?.selection,r=e?.doc;if(!n||!r)return t;try{r.nodesBetween(n.from,n.to,(i,s)=>{let a=i?.type?.name;(a==="tableCell"||a==="tableHeader")&&t.push({node:i,pos:s})})}catch{}if(!t.length)try{let i=n.$from||null;if(i)for(let s=i.depth;s>=0;s-=1){let a=i.node(s)?.type?.name;if(a==="tableCell"||a==="tableHeader"){let c=i.before(s),l=r.nodeAt(c);l&&t.push({node:l,pos:c});break}}}catch{}let o=new Map;for(let i of t){let s=Number(i?.pos);Number.isFinite(s)&&(o.has(s)||o.set(s,i))}return Array.from(o.values()).sort((i,s)=>Number(i.pos)-Number(s.pos))}catch{return[]}}function Cp(e,t){try{let n=mt?.CellSelection||null,r=mt?.TableMap||null;return!n||!r?!1:e.commands.command(({state:o,dispatch:i})=>{let s=Mt(o);if(!s)return!1;let{tablePos:a,tableNode:c,map:l}=s,d=Number(t);if(!Number.isFinite(d)||d<0||d>=l.height)return!1;let h=l.positionAt(d,0,c),g=l.positionAt(d,l.width-1,c),w=a+1+h,S=a+1+g,f=null;try{typeof n.create=="function"&&(f=n.create(o.doc,w,S))}catch{f=null}if(!f)return!1;let p=o.tr.setSelection(f);return p=p.setMeta(de,!0),i(p.scrollIntoView()),!0})}catch{return!1}}function Tp(e,t,n){try{let r=mt?.CellSelection||null,o=mt?.TableMap||null;if(!r||!o)return!1;let i=Number(t),s=Number(n);return!Number.isFinite(i)||i<0||!Number.isFinite(s)||s<0?!1:e.commands.command(({state:a,dispatch:c})=>{let l=a?.doc?.nodeAt?.(i)||null;if(!l||l.type?.name!=="table")return!1;let d=o?.get?o.get(l):null;if(!d||s>=d.height)return!1;let h=d.positionAt(s,0,l),g=d.positionAt(s,d.width-1,l),w=i+1+h,S=i+1+g,f=null;try{typeof r.create=="function"&&(f=r.create(a.doc,w,S))}catch{f=null}if(!f)return!1;let p=a.tr.setSelection(f);return p=p.setMeta(de,!0),c(p.scrollIntoView()),!0})}catch{return!1}}function Bp(e,t){try{let n=mt?.CellSelection||null,r=mt?.TableMap||null;return!n||!r?!1:e.commands.command(({state:o,dispatch:i})=>{let s=Mt(o);if(!s)return!1;let{tablePos:a,tableNode:c,map:l}=s,d=Number(t);if(!Number.isFinite(d)||d<0||d>=l.width)return!1;let h=l.positionAt(0,d,c),g=l.positionAt(l.height-1,d,c),w=a+1+h,S=a+1+g,f=null;try{typeof n.create=="function"&&(f=n.create(o.doc,w,S))}catch{f=null}if(!f)return!1;let p=o.tr.setSelection(f);return p=p.setMeta(de,!0),i(p.scrollIntoView()),!0})}catch{return!1}}function Np(e,t,n){try{let r=mt?.CellSelection||null,o=mt?.TableMap||null;if(!r||!o)return!1;let i=Number(t),s=Number(n);return!Number.isFinite(i)||i<0||!Number.isFinite(s)||s<0?!1:e.commands.command(({state:a,dispatch:c})=>{let l=a?.doc?.nodeAt?.(i)||null;if(!l||l.type?.name!=="table")return!1;let d=o?.get?o.get(l):null;if(!d||s>=d.width)return!1;let h=d.positionAt(0,s,l),g=d.positionAt(d.height-1,s,l),w=i+1+h,S=i+1+g,f=null;try{typeof r.create=="function"&&(f=r.create(a.doc,w,S))}catch{f=null}if(!f)return!1;let p=a.tr.setSelection(f);return p=p.setMeta(de,!0),c(p.scrollIntoView()),!0})}catch{return!1}}function Mp({pmState:e,dispatch:t},{tablePos:n,rowIndex:r,attr:o,value:i}){try{let s=mt?.CellSelection||null,a=mt?.TableMap||null;if(!a)return!1;let c=Number(n),l=Number(r);if(!Number.isFinite(c)||c<0||!Number.isFinite(l)||l<0)return!1;let d=e?.doc?.nodeAt?.(c)||null;if(!d||d.type?.name!=="table")return!1;let h=a?.get?a.get(d):null;if(!h||l>=h.height)return!1;let g=e.tr;try{if(s?.create){let f=h.positionAt(l,0,d),p=h.positionAt(l,h.width-1,d),y=c+1+f,k=c+1+p;g=g.setSelection(s.create(g.doc,y,k))}}catch{}let w=new Set;for(let f=0;f<h.width;f+=1){let p=h.map[l*h.width+f];Number.isFinite(p)&&w.add(c+1+p)}if(!w.size)return!1;let S=!1;for(let f of w){let p=g.doc.nodeAt(f),y=p?.type?.name;if(y!=="tableCell"&&y!=="tableHeader")continue;let k={...p.attrs||{}};i==null||i===""?delete k[o]:k[o]=i,g=g.setNodeMarkup(f,void 0,k),S=!0}return S?(g=g.setMeta(de,!0),t(g),!0):!1}catch{return!1}}function Lp({pmState:e,dispatch:t},{tablePos:n,colIndex:r,attr:o,value:i}){try{let s=mt?.CellSelection||null,a=mt?.TableMap||null;if(!a)return!1;let c=Number(n),l=Number(r);if(!Number.isFinite(c)||c<0||!Number.isFinite(l)||l<0)return!1;let d=e?.doc?.nodeAt?.(c)||null;if(!d||d.type?.name!=="table")return!1;let h=a?.get?a.get(d):null;if(!h||l>=h.width)return!1;let g=e.tr;try{if(s?.create){let f=h.positionAt(0,l,d),p=h.positionAt(h.height-1,l,d),y=c+1+f,k=c+1+p;g=g.setSelection(s.create(g.doc,y,k))}}catch{}let w=new Set;for(let f=0;f<h.height;f+=1){let p=h.map[f*h.width+l];Number.isFinite(p)&&w.add(c+1+p)}if(!w.size)return!1;let S=!1;for(let f of w){let p=g.doc.nodeAt(f),y=p?.type?.name;if(y!=="tableCell"&&y!=="tableHeader")continue;let k={...p.attrs||{}};i==null||i===""?delete k[o]:k[o]=i,g=g.setNodeMarkup(f,void 0,k),S=!0}return S?(g=g.setMeta(de,!0),t(g),!0):!1}catch{return!1}}function ki(e,t="\u0442\u0430\u0431\u043B\u0438\u0446\u044B"){try{let n=!1;return e.descendants(r=>{if(n)return!1;let o=r?.type?.name;if(o==="tableCell"||o==="tableHeader"){let i=Number(r.attrs?.colspan||1),s=Number(r.attrs?.rowspan||1);if(i!==1||s!==1)return n=!0,!1}return!0}),n?(Ee(`\u041F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 ${t} \u043F\u043E\u043A\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u0445 \u044F\u0447\u0435\u0435\u043A`),!1):!0}catch{return!1}}function fd(e,{kind:t,fromIndex:n,toIndex:r}){try{if(!e||!(mt?.TableMap||null))return!0;let i=e.map||null,s=e.tableNode||null;if(!i||!s)return!0;let a=Number(n),c=Number(r);if(!Number.isFinite(a)||!Number.isFinite(c))return!0;let l=t==="row"?Math.max(0,Math.min(i.height-1,a)):Math.max(0,Math.min(i.width-1,a)),d=t==="row"?Math.max(0,Math.min(i.height-1,c)):Math.max(0,Math.min(i.width-1,c)),h=new Set;for(let g of i.map){let w=Number(g);if(!Number.isFinite(w)||w<0||h.has(w))continue;h.add(w);let S=null;try{S=i.findCell(w)}catch{S=null}if(!S)continue;let f=Number(S.right)-Number(S.left),p=Number(S.bottom)-Number(S.top);if(f>1||p>1)if(t==="col"){let y=Number(S.left),k=Number(S.right);if(y<=l&&l<k||y<=d&&d<k)return!0}else{let y=Number(S.top),k=Number(S.bottom);if(y<=l&&l<k||y<=d&&d<k)return!0}}return!1}catch{return!0}}function $l(e,t){try{if(!e?.view)return!1;let n=Mt(e.state);if(!n)return!1;let{colIndex:r}=n,o=n.map?.width||0;if(!(o>0))return!1;let i=t<0?-1:1,s=r+i;return s>=0&&s<o?pd(e,r,s):!1}catch{return!1}}function Fl(e,t){try{if(!e?.view)return!1;let n=Mt(e.state);if(!n)return!1;let{rowIndex:r}=n,o=n.map?.height||0;if(!(o>0))return!1;let i=t<0?-1:1,s=r+i;return s>=0&&s<o?md(e,r,s):!1}catch{return!1}}function pd(e,t,n){try{if(!e?.view)return!1;let r=e.state,o=Mt(r);if(!o)return!1;let{tableNode:i}=o,s=o.map?.width||0;if(!(s>0))return!1;let a=Number(t),c=Number(n);if(!Number.isFinite(a)||!Number.isFinite(c)||a<0||a>=s||c<0||c>=s)return!1;if(a===c)return!0;if(fd(o,{kind:"col",fromIndex:a,toIndex:c}))return Ee("\u041D\u0435\u043B\u044C\u0437\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u043E\u043B\u0431\u0435\u0446: \u0438\u0441\u0445\u043E\u0434\u043D\u0430\u044F \u0438\u043B\u0438 \u0446\u0435\u043B\u0435\u0432\u0430\u044F \u043A\u043E\u043B\u043E\u043D\u043A\u0430 \u043F\u0435\u0440\u0435\u0441\u0435\u043A\u0430\u0435\u0442\u0441\u044F \u0441 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u043C\u0438 \u044F\u0447\u0435\u0439\u043A\u0430\u043C\u0438"),!1;let l=qt(e.view),d=zr(l),h=Array.isArray(d)&&d.length===s?(()=>{let f=d.slice(),p=f.splice(a,1)[0];return f.splice(c,0,p),f})():null,g=mt?.moveTableColumn||null;if(typeof g!="function")return!1;let w=g({from:a,to:c,select:!0});return e.commands.command(({state:f,dispatch:p})=>w(f,typeof p=="function"?k=>{try{k=k.setMeta(de,!0)}catch{}p(k)}:void 0))?(h&&window.requestAnimationFrame(()=>{let f=qt(e.view);Ur(f,h);try{(f?.closest?.(".tableWrapper")||null)?.dispatchEvent?.(new Event("scroll"))}catch{}}),!0):!1}catch{return!1}}function md(e,t,n){try{if(!e?.view)return!1;let r=e.state,o=Mt(r);if(!o)return!1;let i=o.map?.height||0,s=o.map?.width||0;if(!(s>0&&i>0))return!1;let a=Number(t),c=Number(n);if(!Number.isFinite(a)||!Number.isFinite(c)||a<0||a>=i||c<0||c>=i)return!1;if(a===c)return!0;if(fd(o,{kind:"row",fromIndex:a,toIndex:c}))return Ee("\u041D\u0435\u043B\u044C\u0437\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u043E\u043A\u0443: \u0438\u0441\u0445\u043E\u0434\u043D\u0430\u044F \u0438\u043B\u0438 \u0446\u0435\u043B\u0435\u0432\u0430\u044F \u0441\u0442\u0440\u043E\u043A\u0430 \u043F\u0435\u0440\u0435\u0441\u0435\u043A\u0430\u0435\u0442\u0441\u044F \u0441 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u043C\u0438 \u044F\u0447\u0435\u0439\u043A\u0430\u043C\u0438"),!1;let l=qt(e.view),d=zr(l),h=mt?.moveTableRow||null;if(typeof h!="function")return!1;let g=h({from:a,to:c,select:!0});return e.commands.command(({state:S,dispatch:f})=>g(S,typeof f=="function"?y=>{try{y=y.setMeta(de,!0)}catch{}f(y)}:void 0))?(Array.isArray(d)&&d.length===s&&window.requestAnimationFrame(()=>{let S=qt(e.view);Ur(S,d)}),!0):!1}catch{return!1}}function hd(e){try{if(!e)return"";let t=e.textContent||"";return String(t).replace(/\s+/g," ").trim()}catch{return""}}function Pp(e){try{if(!e)return!1;for(let t=0;t<e.childCount;t+=1)if(e.child(t)?.type?.name==="tableHeader")return!0;return!1}catch{return!1}}function zl(e,{direction:t="asc"}={}){try{if(!e?.view)return!1;let n=e.state,r=Mt(n);if(!r)return!1;let{tablePos:o,tableNode:i,colIndex:s}=r,a=i.child(0)?.childCount||0,c=i.childCount||0;if(!(a>0&&c>1)||!(s>=0&&s<a)||!ki(i,"\u0442\u0430\u0431\u043B\u0438\u0446\u044B"))return!1;let l=Pp(i.child(0))?i.child(0):null,d=l?1:0,h=[];for(let p=d;p<c;p+=1){let y=i.child(p),k=y.child(s);h.push({rowIndex:p,rowNode:y,key:hd(k)})}let g=t==="desc"?-1:1;h.sort((p,y)=>g*p.key.localeCompare(y.key,void 0,{sensitivity:"base",numeric:!0}));let w=[];l&&w.push(l);for(let p of h)w.push(p.rowNode);let S=i.type.create(i.attrs,w),f=n.tr.replaceWith(o,o+i.nodeSize,S);return f=f.setMeta(de,!0),e.view.dispatch(f.scrollIntoView()),!0}catch{return!1}}function Ul(e,{direction:t="asc"}={}){try{if(!e?.view)return!1;let n=e.state,r=Mt(n);if(!r)return!1;let{tablePos:o,tableNode:i,rowIndex:s}=r,a=i.child(0)?.childCount||0,c=i.childCount||0;if(!(a>1&&c>0)||!(s>=0&&s<c)||!ki(i,"\u0442\u0430\u0431\u043B\u0438\u0446\u044B"))return!1;let l=i.child(s),d=[];for(let E=0;E<a;E+=1)d.push({colIndex:E,key:hd(l.child(E))});let h=t==="desc"?-1:1;d.sort((E,L)=>h*E.key.localeCompare(L.key,void 0,{sensitivity:"base",numeric:!0}));let g=d.map(E=>E.colIndex),w=qt(e.view),S=zr(w),f=Array.isArray(S)&&S.length===a?g.map(E=>S[E]):null,p=[];for(let E=0;E<c;E+=1){let L=i.child(E),O=g.map(z=>L.child(z));p.push(L.type.create(L.attrs,O))}let y=i.type.create(i.attrs,p),k=n.tr.replaceWith(o,o+i.nodeSize,y);return k=k.setMeta(de,!0),e.view.dispatch(k.scrollIntoView()),f&&window.requestAnimationFrame(()=>{let E=qt(e.view);Ur(E,f)}),!0}catch{return!1}}function _p(e){try{if(!e?.view)return!1;let t=e.state,n=Mt(t);if(!n)return!1;let{tablePos:r,tableNode:o,rowIndex:i,colIndex:s}=n,a=o.child(0)?.childCount||0,c=o.childCount||0;if(!(a>0&&c>0)||!(i>=0&&i<c)||!ki(o,"\u0441\u0442\u0440\u043E\u043A"))return!1;let l=o.child(i),d=[];for(let w=0;w<c;w+=1)d.push(o.child(w)),w===i&&d.push(l.type.create(l.attrs,l.content,l.marks));let h=o.type.create(o.attrs,d),g=t.tr.replaceWith(r,r+o.nodeSize,h);g=g.setMeta(de,!0);try{let w=ze?.pmStateMod?.TextSelection;if(w){let S=Math.min(h.childCount-1,i+1),f=Math.min(a-1,Math.max(0,s)),p=h.child(S),y=p.child(f),k=r+1;for(let z=0;z<S;z+=1)k+=h.child(z).nodeSize;k+=1;for(let z=0;z<f;z+=1)k+=p.child(z).nodeSize;let E=k,L=E+1,O=E+y.nodeSize-1;g=g.setSelection(w.near(g.doc.resolve(Math.min(O,L+1)),1))}}catch{}return e.view.dispatch(g.scrollIntoView()),!0}catch{return!1}}function Dp(e){try{if(!e?.view)return!1;let t=e.state,n=Mt(t);if(!n)return!1;let{tablePos:r,tableNode:o,rowIndex:i,colIndex:s}=n,a=o.child(0)?.childCount||0,c=o.childCount||0;if(!(a>0&&c>0)||!(s>=0&&s<a)||!ki(o,"\u0441\u0442\u043E\u043B\u0431\u0446\u043E\u0432"))return!1;let l=qt(e.view),d=zr(l),h=null;if(Array.isArray(d)&&d.length===a){let f=[...d],p=Math.max(0,Number(f[s]||0)),y=Tn(p/2);f[s]=y,f.splice(s+1,0,y);let k=f.reduce((E,L)=>E+(Number.isFinite(L)?L:0),0);k>0&&Math.abs(k-100)>.01&&(f[f.length-1]=Tn(f[f.length-1]+(100-k))),h=f}let g=[];for(let f=0;f<c;f+=1){let p=o.child(f),y=[];for(let k=0;k<a;k+=1){let E=p.child(k);y.push(E),k===s&&y.push(E.type.create(E.attrs,E.content,E.marks))}g.push(p.type.create(p.attrs,y))}let w=o.type.create(o.attrs,g),S=t.tr.replaceWith(r,r+o.nodeSize,w);S=S.setMeta(de,!0);try{let f=ze?.pmStateMod?.TextSelection;if(f){let p=Math.min(w.childCount-1,Math.max(0,i)),y=Math.min(a,Math.max(0,s+1)),k=w.child(p),E=k.child(y),L=r+1;for(let $=0;$<p;$+=1)L+=w.child($).nodeSize;L+=1;for(let $=0;$<y;$+=1)L+=k.child($).nodeSize;let O=L,z=O+1,q=O+E.nodeSize-1;S=S.setSelection(f.near(S.doc.resolve(Math.min(q,z+1)),1))}}catch{}return e.view.dispatch(S.scrollIntoView()),Array.isArray(h)&&h.length===a+1?window.requestAnimationFrame(()=>{let f=qt(e.view);Ur(f,h)}):window.requestAnimationFrame(()=>{let f=qt(e.view);yi(f)}),!0}catch{return!1}}function Op(e,t,n){try{if(!e?.view)return!1;let{state:r,view:o}=e,{selection:i}=r,s=i?.$from||null;if(!s)return!1;let a=n instanceof Set?n:new Set(Array.from(n||[])),c=null;for(let z=s.depth;z>0;z-=1)if(s.node(z)?.type?.name==="paragraph"){let q=s.node(z-1)?.type?.name||"";a.has(q)&&(c=z);break}if(c==null)return!1;let l=c-1,d=s.node(l),h=s.index(l);if(!d)return!1;let g=t<0?-1:1,w=h+g;if(!(w>=0&&w<d.childCount))return!1;let S=d.child(h),f=d.child(w);if(S?.type?.name!=="paragraph"||f?.type?.name!=="paragraph")return!1;let p=s.before(c),y=S.nodeSize,k=g<0?p-f.nodeSize:p+y,E=f.nodeSize,L=Math.max(0,i.from-s.start(c)),O=r.tr;if(g<0){O=O.delete(p,p+y),O=O.insert(k,S);let z=k,q=z+1,$=z+S.nodeSize-1,Q=q+L,W=Math.min(Math.max(Q,q),$);try{let re=ze?.pmStateMod?.TextSelection;re&&(O=O.setSelection(re.near(O.doc.resolve(W),1)))}catch{}}else{O=O.delete(p,p+y);let z=p+E;O=O.insert(z,S);let q=z,$=q+1,Q=q+S.nodeSize-1,W=$+L,re=Math.min(Math.max(W,$),Q);try{let we=ze?.pmStateMod?.TextSelection;we&&(O=O.setSelection(we.near(O.doc.resolve(re),1)))}catch{}}return O=O.setMeta(de,!0),o.dispatch(O.scrollIntoView()),!0}catch{return!1}}function ql(e,t){return Op(e,t,new Set(["outlineBody","tableCell","tableHeader"]))}function Vl(e,t){try{if(!e?.view)return!1;let{state:n,view:r}=e,{selection:o}=n,i=o?.$from||null;if(!i)return!1;let s=null;for(let L=i.depth;L>0;L-=1)if(i.node(L)?.type?.name==="listItem"){s=L;break}if(s==null)return!1;let a=s-1,c=i.node(a),l=c?.type?.name||"";if(l!=="bulletList"&&l!=="orderedList")return!1;let d=i.index(a),h=t<0?-1:1,g=d+h;if(!(g>=0&&g<c.childCount))return!1;let w=c.child(d),S=c.child(g);if(w?.type?.name!=="listItem"||S?.type?.name!=="listItem")return!1;let f=i.before(s),p=w.nodeSize,y=S.nodeSize,k=Math.max(0,o.from-i.start(s)),E=n.tr;if(h<0){let L=f-y;E=E.delete(f,f+p),E=E.insert(L,w);let O=L,z=O+1,q=O+w.nodeSize-1,$=z+k,Q=Math.min(Math.max($,z),q);try{let W=ze?.pmStateMod?.TextSelection;W&&(E=E.setSelection(W.near(E.doc.resolve(Q),1)))}catch{}}else{E=E.delete(f,f+p);let L=f+y;E=E.insert(L,w);let O=L,z=O+1,q=O+w.nodeSize-1,$=z+k,Q=Math.min(Math.max($,z),q);try{let W=ze?.pmStateMod?.TextSelection;W&&(E=E.setSelection(W.near(E.doc.resolve(Q),1)))}catch{}}return E=E.setMeta(de,!0),r.dispatch(E.scrollIntoView()),!0}catch{return!1}}function Rp(e){if(!J.outlineToolbar||!e)return;let t=J.outlineToolbar,n=null,r={undo:J.outlineUndoBtn,redo:J.outlineRedoBtn,deleteBtn:J.outlineDeleteBtn,moveUpBtn:J.outlineMoveUpBtn,moveDownBtn:J.outlineMoveDownBtn,outdentBtn:J.outlineOutdentBtn,indentBtn:J.outlineIndentBtn,newBelowBtn:J.outlineNewBelowBtn,blocksMenuBtn:t.querySelector("#outlineBlocksMenuBtn"),textMenuBtn:t.querySelector("#outlineTextMenuBtn"),listsMenuBtn:t.querySelector("#outlineListsMenuBtn"),tableMenuBtn:t.querySelector("#outlineTableMenuBtn")},o=new Set(Array.from(t.querySelectorAll(".outline-toolbar__dropdown-btn")));r.blocksMenuBtn&&o.add(r.blocksMenuBtn),r.textMenuBtn&&o.add(r.textMenuBtn),r.listsMenuBtn&&o.add(r.listsMenuBtn),r.tableMenuBtn&&o.add(r.tableMenuBtn);let i=Array.from(o),s=Array.from(t.querySelectorAll(".outline-toolbar__menu")),a=Array.from(t.querySelectorAll("[data-outline-action]")),c=Array.from(t.querySelectorAll("[data-outline-clipboard-action]")),l=(G,ce)=>{if(!G)return()=>{};let me=le=>{le.preventDefault(),le.stopPropagation(),ce()};return G.addEventListener("click",me),()=>G.removeEventListener("click",me)},d=(G,ce)=>{G&&(G.classList.toggle("is-active",!!ce),G.setAttribute("aria-pressed",ce?"true":"false"))},h=()=>{for(let G of s)G.classList.add("hidden");for(let G of i)G.setAttribute("aria-expanded","false")},g=()=>{let G=_l(),ce=!!(G&&Array.isArray(G.sections)&&G.sections.length);for(let me of c)me?.getAttribute?.("data-outline-clipboard-action")==="paste"&&me.toggleAttribute("disabled",!ce)},w=G=>{if(!G)return;let ce=G.getAttribute("aria-controls"),me=ce?t.querySelector(`#${ce}`)||document.getElementById(ce):null;if(!me)return!1;let le=!me.classList.contains("hidden");return h(),le||(ce==="outlineBlocksMenu"&&g(),me.classList.remove("hidden"),G.setAttribute("aria-expanded","true")),!0},S="ttree_outline_debug_dropdown_v1",f=()=>{try{return window?.localStorage?.getItem?.(S)==="1"}catch{return!1}},p=(G,ce={})=>{try{if(!f())return;console.log("[outline][dropdown]",G,ce)}catch{}},y=G=>{try{let ce=e.can().chain();return E()&&ce.command(({tr:me})=>(me.setMeta(de,!0),!0)),G(ce),ce.run()}catch{return!1}},k=G=>{if(!G)return!1;try{let ce=e.chain().focus();if(E()&&ce.command(({tr:me})=>(me.setMeta(de,!0),!0)),G==="collapseAllBlocks")return Qs(e,!0);if(G==="expandAllBlocks")return Qs(e,!1);if(G==="toggleBold")return ce.toggleBold().run();if(G==="toggleItalic")return ce.toggleItalic().run();if(G==="toggleStrike")return ce.toggleStrike().run();if(G==="toggleCodeBlock")return e.commands.command(({state:me,dispatch:le})=>{let fe=me.schema.nodes?.codeBlock||null;if(!fe)return!1;let xe=me.selection,{from:Ie,to:ae}=xe;if(Ie===ae){let Ze=me.tr.setMeta(de,!0);return le(Ze),e.commands.toggleCodeBlock()}let ve=xe.$from?.blockRange?.(xe.$to)||null;if(!ve){let Ze=me.tr.setMeta(de,!0);return le(Ze),e.commands.toggleCodeBlock()}if(!ve.parent?.canReplaceWith?.(ve.startIndex,ve.endIndex,fe)){let Ze=me.tr.setMeta(de,!0);return le(Ze),e.commands.toggleCodeBlock()}let He=me.doc.textBetween(ve.start,ve.end,`
`,`
`),Ve=String(He||"").replace(/\n+$/g,"").trimEnd();if(!Ve)return!1;let Ge=fe.create(null,me.schema.text(Ve)),Qe=me.tr.replaceRangeWith(ve.start,ve.end,Ge);return Qe=Qe.setMeta(de,!0),Z&&(Qe=Qe.setSelection(Z.near(Qe.doc.resolve(ve.start+2),1))),le(Qe.scrollIntoView()),!0});if(G==="toggleBlockquote")return ce.toggleBlockquote().run();if(G==="unsetLink")return ce.unsetLink().run();if(G==="toggleBulletList")return e.isActive("orderedList")?ce.toggleOrderedList().toggleBulletList().run():ce.toggleBulletList().run();if(G==="toggleOrderedList")return e.isActive("bulletList")?ce.toggleBulletList().toggleOrderedList().run():ce.toggleOrderedList().run();if(G==="unsetList")return e.isActive("bulletList")?ce.toggleBulletList().run():e.isActive("orderedList")?ce.toggleOrderedList().run():ce.liftListItem("listItem").run();if(G==="insertTable")return ce.insertTable({rows:2,cols:2,withHeaderRow:!1}).run();if(G==="toggleHeaderRow")return ce.toggleHeaderRow().run();if(G==="toggleHeaderColumn")return ce.toggleHeaderColumn().run();if(G==="addRowBefore")return ce.addRowBefore().run();if(G==="addRowAfter")return ce.addRowAfter().run();if(G==="deleteRow")return ce.deleteRow().run();if(G==="addColumnBefore"){let me=Mt(e.state),le=me?Math.max(0,Number(me.colIndex||0)):0,fe=ce.addColumnBefore().run();return fe&&Si(e,{insertIndex:le,newColPct:10}),fe}if(G==="addColumnAfter"){let me=Mt(e.state),le=me?Math.max(0,Number(me.colIndex||0)+1):1,fe=ce.addColumnAfter().run();return fe&&Si(e,{insertIndex:le,newColPct:10}),fe}if(G==="deleteColumn"){let me=qt(e.view),le=zr(me),fe=Mt(e.state),xe=fe?Number(fe.colIndex||0):null,Ie=le&&xe!=null?ud(le,xe):null,ae=ce.deleteColumn().run();return ae&&Array.isArray(Ie)&&window.requestAnimationFrame(()=>{let ve=qt(e.view);Ur(ve,Ie)}),ae}return G==="mergeCells"?ce.mergeCells().run():G==="splitCell"?ce.splitCell().run():G==="copyColumn"||G==="pasteColumnAfter"||G==="moveColumnRight"?!1:G==="cancelTable"?O():G==="deleteTable"?ce.deleteTable().run():!1}catch{return!1}},E=()=>{try{return!!(Ae?.getState?.(e.state)||null)?.editingSectionId}catch{return!1}},L=()=>E()?!0:($r(),!1),O=()=>{if(!L())return!1;try{let{state:G,view:ce}=e,{schema:me,selection:le}=G,fe=le?.$from;if(!fe)return!1;let xe=null;for(let m=fe.depth;m>=0;m-=1)fe.node(m)?.type?.name==="table"&&(xe=m);if(xe==null)return!1;let Ie=null,ae=null;for(let m=xe+1;m<=fe.depth;m+=1){let C=fe.node(m)?.type?.name;if(Ie==null&&C==="tableRow"&&(Ie=m),ae==null&&(C==="tableCell"||C==="tableHeader")&&(ae=m),Ie!=null&&ae!=null)break}let ve=fe.before(xe),He=G.doc.nodeAt(ve);if(!He||He.type?.name!=="table")return!1;let Ve=Ie!=null?fe.index(xe):null,Ge=Ie!=null&&ae!=null?fe.index(Ie):null,Qe=null;if(typeof Ve=="number"&&typeof Ge=="number"){let m=He.childCount&&He.child(0)?.childCount||0;m>0&&(Qe=Ve*m+Ge)}let Ze=[],qe=0,nt=0;for(let m=0;m<He.childCount;m+=1){let v=He.child(m);for(let C=0;C<v.childCount;C+=1){let D=v.child(C),M=[];try{for(let N=0;N<(D?.content?.childCount||0);N+=1){let P=D.content.child(N);P&&M.push(P)}}catch{}M.length||M.push(me.nodes.paragraph.create(null,[])),Qe!=null&&qe===Qe&&(nt=Ze.length),Ze.push(...M),qe+=1}}if(!Ze.length)return!1;let tt=me.nodes.outlineBody?me.nodes.outlineBody.create({},Ze).content:me.nodes.doc.create({},Ze).content,A=G.tr.replaceWith(ve,ve+He.nodeSize,tt);A=A.setMeta(de,!0);try{let m=ze?.pmStateMod?.TextSelection;if(m){let v=ve;for(let P=0;P<nt;P+=1)v+=Ze[P].nodeSize;let C=null,D=Math.min(A.doc.content.size,v),M=Math.min(A.doc.content.size,v+2e4);A.doc.nodesBetween(D,M,(P,T)=>C!=null?!1:P?.isTextblock?(C=T+1,!1):!0);let N=C??Math.min(A.doc.content.size,v+1);A=A.setSelection(m.near(A.doc.resolve(N),1))}}catch{}return ce.dispatch(A.scrollIntoView()),ce.focus?.(),!0}catch{return!1}},z=()=>{if(!L())return!1;try{let{state:G,view:ce}=e,{selection:me}=G,le=me?.$from;if(!le)return!1;let fe=null,xe=null,Ie=null;for(let A=le.depth;A>=0;A-=1){let v=le.node(A)?.type?.name;if(Ie==null&&(v==="tableCell"||v==="tableHeader")&&(Ie=A),xe==null&&v==="tableRow"&&(xe=A),v==="table"){fe=A;break}}if(fe==null||xe==null||Ie==null)return!1;let ae=le.before(fe),ve=G.doc.nodeAt(ae);if(!ve||ve.type?.name!=="table")return!1;let He=le.index(fe),Ve=le.index(xe),Ge=ve.child(0)?.childCount||0;if(!(Ge>0)||!(Ve>=0&&Ve<Ge-1))return!1;let Qe=!1;if(ve.descendants(A=>{if(Qe)return!1;let m=A?.type?.name;if(m==="tableCell"||m==="tableHeader"){let v=Number(A.attrs?.colspan||1),C=Number(A.attrs?.rowspan||1);if(v!==1||C!==1)return Qe=!0,!1}return!0}),Qe)return Ee("\u041F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 \u0441\u0442\u043E\u043B\u0431\u0446\u043E\u0432 \u043F\u043E\u043A\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u0445 \u044F\u0447\u0435\u0435\u043A"),!1;let Ze=me.from-le.start(Ie),qe=[];for(let A=0;A<ve.childCount;A+=1){let m=ve.child(A);if(m.type?.name!=="tableRow"||m.childCount!==Ge)return!1;let v=[];for(let C=0;C<Ge;C+=1)C===Ve?v.push(m.child(C+1)):C===Ve+1?v.push(m.child(C-1)):v.push(m.child(C));qe.push(m.type.create(m.attrs,v))}let nt=ve.type.create(ve.attrs,qe),tt=G.tr.replaceWith(ae,ae+ve.nodeSize,nt);tt=tt.setMeta(de,!0);try{let A=ze?.pmStateMod?.TextSelection;if(A){let m=Math.min(nt.childCount-1,Math.max(0,He)),v=Ve+1,C=nt.child(m),D=C.child(v),M=ae+1;for(let b=0;b<m;b+=1)M+=nt.child(b).nodeSize;M+=1;for(let b=0;b<v;b+=1)M+=C.child(b).nodeSize;let N=M,P=N+1,T=N+D.nodeSize-1,x=P+Math.max(0,Ze),I=Math.min(Math.max(x,P),T);tt=tt.setSelection(A.near(tt.doc.resolve(I),1))}}catch{}return ce.dispatch(tt.scrollIntoView()),ce.focus?.(),!0}catch{return!1}},q=(G,ce,me={})=>{let le=String(G||"").trim();if(!le)return!1;let fe=String(ce||"").trim()||le,{from:xe,to:Ie,empty:ae}=e.state.selection,ve={href:le,...me},He=e.chain().focus();return E()&&He.command(({tr:Ve})=>(Ve.setMeta(de,!0),!0)),!ae&&xe!==Ie?He.setLink(ve).run():He.insertContent({type:"text",text:fe,marks:[{type:"link",attrs:ve}]}).run()},$=async()=>{if(!L())return;let{from:G,to:ce,empty:me}=e.state.selection,le=me?"":e.state.doc.textBetween(G,ce," ").trim(),fe="",xe=le;try{let ae=await(await Promise.resolve().then(()=>(Jn(),ji))).showLinkPrompt({title:"\u0421\u0441\u044B\u043B\u043A\u0430 (URL)",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0441\u0441\u044B\u043B\u043A\u0443 (\u043B\u044E\u0431\u043E\u0439 \u0444\u043E\u0440\u043C\u0430\u0442) \u0438 \u0442\u0435\u043A\u0441\u0442 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E).",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",textLabel:"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)",urlLabel:"\u0421\u0441\u044B\u043B\u043A\u0430",defaultText:le,defaultUrl:"",urlPlaceholder:""});if(!ae||typeof ae!="object")return;fe=String(ae.url||""),xe=String(ae.text??le)}catch{fe=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0441\u0441\u044B\u043B\u043A\u0443")||"",xe=le||window.prompt("\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)")||""}fe=(fe||"").trim(),fe&&q(fe,xe,{target:"_blank",rel:"noopener noreferrer"})},Q=async()=>{if(!L())return;let G=Array.isArray(u.articlesIndex)?u.articlesIndex:[];G.length||(G=await dn().catch(()=>[])||[],Array.isArray(G)&&(u.articlesIndex=G));let ce=(Array.isArray(G)?G:[]).map(Ze=>({id:Ze.id,title:Ze.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),{from:me,to:le,empty:fe}=e.state.selection,xe=fe?"":e.state.doc.textBetween(me,le," ").trim(),Ie=!!xe,ae="",ve="",He=xe;try{let qe=await(await Promise.resolve().then(()=>(Jn(),ji))).showArticleLinkPrompt({title:"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E \u0438 \u0437\u0430\u0434\u0430\u0439\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438.",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:ce,defaultTextValue:xe,lockTextValue:Ie});if(qe&&typeof qe=="object")ae=qe.articleValue||"",ve=qe.selectedId||"",He=qe.textValue||"";else return}catch{ae=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438")||"",He=xe||window.prompt("\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)")||""}let Ve=(ae||"").trim().toLowerCase();if(!Ve&&!ve)return;let Ge=(Array.isArray(G)?G:[]).find(Ze=>{let qe=(Ze.title||"").toLowerCase();return ve&&Ze.id===ve||Ze.id&&Ze.id.toLowerCase()===Ve||qe===Ve||qe.includes(Ve)});if(!Ge){Ee("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}let Qe=(He||"").trim()||Ge.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";q(Yt.article(Ge.id),Qe,{class:"article-link"})},W=()=>{if(!u.isOutlineEditing||!e||e.isDestroyed)return;let G=E();if(t.dataset.editing=G?"true":"false",n===null?n=G:n!==G&&(h(),n=G),r.deleteBtn&&(r.deleteBtn.hidden=G),r.moveUpBtn&&(r.moveUpBtn.hidden=G),r.moveDownBtn&&(r.moveDownBtn.hidden=G),r.outdentBtn&&(r.outdentBtn.hidden=G),r.indentBtn&&(r.indentBtn.hidden=G),r.newBelowBtn&&(r.newBelowBtn.hidden=G),r.blocksMenuBtn&&(r.blocksMenuBtn.hidden=G),G&&Fn&&yo(!1),r.undo&&(r.undo.disabled=!y(le=>le.undo())),r.redo&&(r.redo.disabled=!y(le=>le.redo())),r.textMenuBtn){let le=e.isActive("bold")||e.isActive("italic")||e.isActive("strike")||e.isActive("codeBlock")||e.isActive("blockquote");d(r.textMenuBtn,le),r.textMenuBtn.hidden=!G}if(r.listsMenuBtn){let le=e.isActive("bulletList")||e.isActive("orderedList");d(r.listsMenuBtn,le),r.listsMenuBtn.hidden=!G}if(r.tableMenuBtn){let le=e.isActive("table");d(r.tableMenuBtn,le),r.tableMenuBtn.hidden=!G}let ce=null,me=()=>{if(ce)return ce;let le={total:0,collapsed:0};try{e.state.doc.descendants(fe=>{fe?.type?.name==="outlineSection"&&(le.total+=1,fe.attrs?.collapsed&&(le.collapsed+=1))})}catch{}return ce=le,le};for(let le of a){let fe=le.dataset.outlineAction||"";if(!fe)continue;let xe=!1,Ie=!1;if(fe==="collapseAllBlocks"){let ae=me();xe=!1,Ie=ae.total===0||ae.collapsed>=ae.total}else if(fe==="expandAllBlocks"){let ae=me();xe=!1,Ie=ae.total===0||ae.collapsed<=0}else fe==="toggleBold"?(xe=e.isActive("bold"),Ie=!y(ae=>ae.toggleBold())):fe==="toggleItalic"?(xe=e.isActive("italic"),Ie=!y(ae=>ae.toggleItalic())):fe==="toggleStrike"?(xe=e.isActive("strike"),Ie=!y(ae=>ae.toggleStrike())):fe==="toggleCodeBlock"?(xe=e.isActive("codeBlock"),Ie=!E()):fe==="toggleBlockquote"?(xe=e.isActive("blockquote"),Ie=!y(ae=>ae.toggleBlockquote())):fe==="insertHttpLink"||fe==="insertArticleLink"?(xe=!1,Ie=!E()):fe==="unsetLink"?(xe=e.isActive("link"),Ie=!y(ae=>ae.unsetLink())):fe==="toggleBulletList"?(xe=e.isActive("bulletList"),e.isActive("orderedList")?Ie=!(y(ae=>ae.toggleOrderedList())&&y(ae=>ae.toggleBulletList())):Ie=!y(ae=>ae.toggleBulletList())):fe==="toggleOrderedList"?(xe=e.isActive("orderedList"),e.isActive("bulletList")?Ie=!(y(ae=>ae.toggleBulletList())&&y(ae=>ae.toggleOrderedList())):Ie=!y(ae=>ae.toggleOrderedList())):fe==="unsetList"?(xe=!1,e.isActive("bulletList")?Ie=!y(ae=>ae.toggleBulletList()):e.isActive("orderedList")?Ie=!y(ae=>ae.toggleOrderedList()):Ie=!y(ae=>ae.liftListItem("listItem"))):fe==="insertTable"?(xe=!1,Ie=!y(ae=>ae.insertTable({rows:2,cols:2,withHeaderRow:!1}))):fe==="toggleHeaderRow"?(xe=e.isActive("tableHeader"),Ie=!y(ae=>ae.toggleHeaderRow())):fe==="toggleHeaderColumn"?(xe=e.isActive("tableHeader"),Ie=!y(ae=>ae.toggleHeaderColumn())):fe==="addRowBefore"?(xe=!1,Ie=!y(ae=>ae.addRowBefore())):fe==="addRowAfter"?(xe=!1,Ie=!y(ae=>ae.addRowAfter())):fe==="deleteRow"?(xe=!1,Ie=!y(ae=>ae.deleteRow())):fe==="addColumnBefore"?(xe=!1,Ie=!y(ae=>ae.addColumnBefore())):fe==="addColumnAfter"?(xe=!1,Ie=!y(ae=>ae.addColumnAfter())):fe==="deleteColumn"?(xe=!1,Ie=!y(ae=>ae.deleteColumn())):fe==="copyColumn"||fe==="pasteColumnAfter"||fe==="moveColumnRight"?(xe=!1,Ie=!0):fe==="mergeCells"?(xe=!1,Ie=!y(ae=>ae.mergeCells())):fe==="splitCell"?(xe=!1,Ie=!y(ae=>ae.splitCell())):fe==="cancelTable"?(xe=!1,Ie=!E()||!e.isActive("table")):fe==="deleteTable"&&(xe=!1,Ie=!y(ae=>ae.deleteTable()));le.disabled=!!Ie,le.classList.toggle("is-active",!!xe)}},re=null,we=()=>{re||(re=window.requestAnimationFrame(()=>{re=null,W()}))},Ne=[l(r.undo,()=>e.chain().focus().undo().run()),l(r.redo,()=>e.chain().focus().redo().run())],Z=ze?.pmStateMod?.TextSelection||null,pe=(G,ce)=>{try{let me=G.resolve(Math.min(G.content.size,ce+1)),le=null;for(let fe=me.depth;fe>0;fe-=1){if(me.node(fe)?.type?.name!=="outlineSection")continue;if(me.before(fe)===ce){le=fe;break}}if(le===null)return null;for(let fe=le-1;fe>0;fe-=1)if(me.node(fe)?.type?.name==="outlineSection")return me.before(fe);return null}catch{return null}},We=G=>{try{if(!Z)return;e.commands.command(({state:ce,dispatch:me})=>{let le=wt(ce.doc,ce.selection.$from);if(typeof le!="number")return!1;let fe=ce.doc.resolve(le),xe=fe.index(),Ie=fe.parent;if(!Ie)return!1;let ae=ce.doc.nodeAt(le);if(!ae)return!1;if(G==="up"){if(xe>0){let P=Ie.child(xe-1),T=le-P.nodeSize,x=ce.tr.delete(le,le+ae.nodeSize).insert(T,ae);return x=x.setMeta(de,!0),x=x.setSelection(Z.near(x.doc.resolve(T+2),1)),me(x.scrollIntoView()),!0}let ve=pe(ce.doc,le);if(typeof ve!="number")return!1;let He=ce.doc.resolve(ve),Ve=He.index(),Ge=He.parent;if(!Ge||Ve<=0)return!1;let Qe=Ge.child(Ve-1),Ze=ve-Qe.nodeSize,qe=ce.doc.nodeAt(Ze);if(!qe||qe.type?.name!=="outlineSection")return!1;let nt=qe.child(0),tt=qe.child(1),A=qe.child(2),v=Ze+1+nt.nodeSize+tt.nodeSize+A.nodeSize-1,C=ce.tr.delete(le,le+ae.nodeSize).setMeta(de,!0),D=C.mapping.map(Ze,-1),M=C.mapping.map(v,-1);C=C.insert(M,ae);let N=C.doc.nodeAt(D);return N?.type?.name==="outlineSection"&&N.attrs?.collapsed&&(C=C.setNodeMarkup(D,void 0,{...N.attrs,collapsed:!1})),C=C.setSelection(Z.near(C.doc.resolve(M+2),1)),me(C.scrollIntoView()),!0}if(G==="down"){if(xe<Ie.childCount-1){let P=le+ae.nodeSize,T=ce.doc.nodeAt(P);if(!T)return!1;let x=ce.tr.delete(le,le+ae.nodeSize),I=le+T.nodeSize;return x=x.insert(I,ae),x=x.setMeta(de,!0),x=x.setSelection(Z.near(x.doc.resolve(I+2),1)),me(x.scrollIntoView()),!0}let ve=pe(ce.doc,le);if(typeof ve!="number")return!1;let He=ce.doc.nodeAt(ve);if(!He||He.type?.name!=="outlineSection")return!1;let Ve=ce.doc.resolve(ve),Ge=Ve.index(),Qe=Ve.parent;if(!Qe||Ge>=Qe.childCount-1)return!1;let Ze=ve+He.nodeSize,qe=ce.doc.nodeAt(Ze);if(!qe||qe.type?.name!=="outlineSection")return!1;let nt=qe.child(0),tt=qe.child(1),A=qe.child(2),v=Ze+1+nt.nodeSize+tt.nodeSize+1,C=ce.tr.delete(le,le+ae.nodeSize).setMeta(de,!0),D=C.mapping.map(Ze,-1),M=C.mapping.map(v,-1);C=C.insert(M,ae);let N=C.doc.nodeAt(D);return N?.type?.name==="outlineSection"&&N.attrs?.collapsed&&(C=C.setNodeMarkup(D,void 0,{...N.attrs,collapsed:!1})),C=C.setSelection(Z.near(C.doc.resolve(M+2),1)),me(C.scrollIntoView()),!0}return!1})}catch{}},yt=()=>{try{if(!Z)return;e.commands.command(({state:G,dispatch:ce})=>{let me=wt(G.doc,G.selection.$from);if(typeof me!="number")return!1;let le=G.doc.resolve(me),fe=0;for(let m=le.depth;m>=0;m-=1)le.node(m)?.type?.name==="outlineSection"&&(fe+=1);if(fe>=6)return!1;let xe=le.index(),Ie=le.parent;if(!Ie||xe<=0)return!1;let ae=G.doc.nodeAt(me);if(!ae)return!1;let ve=Ie.child(xe-1),He=me-ve.nodeSize,Ve=G.doc.nodeAt(He);if(!Ve)return!1;let Ge=Ve.child(0),Qe=Ve.child(1),Ze=Ve.child(2),nt=He+1+Ge.nodeSize+Qe.nodeSize+Ze.nodeSize-1,tt=G.tr.delete(me,me+ae.nodeSize).insert(nt,ae),A=tt.doc.nodeAt(He);return A?.type?.name==="outlineSection"&&A.attrs?.collapsed&&(tt=tt.setNodeMarkup(He,void 0,{...A.attrs,collapsed:!1})),tt=tt.setMeta(de,!0),tt=tt.setSelection(Z.near(tt.doc.resolve(nt+2),1)),ce(tt.scrollIntoView()),!0})}catch{}},kt=()=>{try{if(!Z)return;e.commands.command(({state:G,dispatch:ce})=>{let me=G.selection.$from,le=null,fe=null;for(let Ge=me.depth;Ge>0;Ge-=1)if(me.node(Ge)?.type?.name==="outlineSection")if(le===null)le=Ge;else{fe=Ge;break}if(le===null||fe===null)return!1;let xe=me.before(le),Ie=me.before(fe),ae=G.doc.nodeAt(xe);if(!ae)return!1;let ve=G.tr.delete(xe,xe+ae.nodeSize),He=ve.doc.nodeAt(Ie);if(!He)return!1;let Ve=Ie+He.nodeSize;return ve=ve.insert(Ve,ae),ve=ve.setMeta(de,!0),ve=ve.setSelection(Z.near(ve.doc.resolve(Ve+2),1)),ce(ve.scrollIntoView()),!0})}catch{}},jt=()=>{try{if(!Z)return;e.commands.command(({state:G,dispatch:ce})=>{let me=wt(G.doc,G.selection.$from);if(typeof me!="number")return!1;let le=G.doc.nodeAt(me);if(!le)return!1;let fe=String(le.attrs?.id||"").trim(),xe=G.doc.resolve(me),Ie=xe.index(),ae=xe.parent;if(!ae)return!1;let ve=G.doc.type.schema;if(ae.childCount<=1){let nt=ve.nodes.outlineSection.create({...le.attrs,collapsed:!1},[ve.nodes.outlineHeading.create({},[]),ve.nodes.outlineBody.create({},[ve.nodes.paragraph.create({},[])]),ve.nodes.outlineChildren.create({},[])]),tt=G.tr.replaceWith(me,me+le.nodeSize,nt);tt=tt.setMeta(de,!0);let A=nt.child(0),m=me+1+A.nodeSize;return tt=tt.setSelection(Z.near(tt.doc.resolve(m+2),1)),ce(tt.scrollIntoView()),!0}fe&&Or(fe);let He=Ie>0,Ve=He?ae.child(Ie-1):null,Ge=He?me-Ve.nodeSize:null,Qe=G.tr.delete(me,me+le.nodeSize);Qe=Qe.setMeta(de,!0);let Ze=He&&typeof Ge=="number"?Ge:Math.min(Qe.doc.content.size,me),qe=Qe.doc.nodeAt(Ze);if(qe?.type?.name==="outlineSection"){let nt=qe.child(0),tt=qe.child(1),A=Ze+1+nt.nodeSize;tt.childCount||(Qe=Qe.insert(A+1,ve.nodes.paragraph.create({},[]))),Qe=Qe.setSelection(Z.near(Qe.doc.resolve(A+2),1))}return ce(Qe.scrollIntoView()),!0})}catch{}},en=()=>{try{if(!Z)return;e.commands.command(({state:G,dispatch:ce})=>{let me=wt(G.doc,G.selection.$from);if(typeof me!="number")return!1;let le=G.doc.nodeAt(me);if(!le)return!1;let fe=G.doc.type.schema,xe=me+le.nodeSize,Ie=$t(),ae=fe.nodes.outlineSection.create({id:Ie,collapsed:!1},[fe.nodes.outlineHeading.create({},[]),fe.nodes.outlineBody.create({},[fe.nodes.paragraph.create({},[])]),fe.nodes.outlineChildren.create({},[])]),ve=G.tr.insert(xe,ae);return ve=ve.setSelection(Z.create(ve.doc,xe+2)),ve=ve.setMeta(de,!0),Ae&&(ve=ve.setMeta(Ae,{type:"enter",sectionId:Ie})),ce(ve.scrollIntoView()),!0})}catch{}};Ne.push(l(r.deleteBtn,()=>jt())),Ne.push(l(r.moveUpBtn,()=>We("up"))),Ne.push(l(r.moveDownBtn,()=>We("down"))),Ne.push(l(r.outdentBtn,()=>kt())),Ne.push(l(r.indentBtn,()=>yt())),Ne.push(l(r.newBelowBtn,()=>en()));let cn=0,yn=G=>{try{return G?.target&&G.target.nodeType===1?G.target:G?.target?.parentElement||null}catch{return null}},Bn=G=>{let ce=yn(G);if(!ce)return null;let me=ce.closest?.(".outline-toolbar__dropdown-btn")||null;return!me||!t.contains(me)?null:me},Nn=(G,{source:ce})=>{try{let me=Date.now();if(cn&&me-cn<700){p("toggle.skip.dedupe",{source:ce,dtMs:me-cn});return}let le=Bn(G);if(!le){p("toggle.skip.no-btn",{source:ce,targetClass:String(yn(G)?.className||"")});return}if(le.disabled){p("toggle.skip.disabled",{source:ce,btnId:le.id||null});return}G?.cancelable&&G.preventDefault(),G.stopPropagation();let fe=w(le);p("toggle",{source:ce,ok:fe,btnId:le.id||null,menuId:le.getAttribute("aria-controls")||null,expanded:le.getAttribute("aria-expanded")||null}),fe&&(cn=me)}catch(me){p("toggle.error",{source:ce,message:String(me?.message||me||"")})}},bn=G=>{try{let ce=String(G?.pointerType||"");if(ce!=="touch"&&ce!=="pen")return}catch{return}Nn(G,{source:"pointerdown"})},wn=G=>{Nn(G,{source:"click"})};try{t.addEventListener("pointerdown",bn,!0),Ne.push(()=>t.removeEventListener("pointerdown",bn,!0))}catch{}t.addEventListener("click",wn,!0),Ne.push(()=>t.removeEventListener("click",wn,!0));let vt=G=>{try{if(!u.isOutlineEditing)return;t.contains(G.target)||h()}catch{}},Lt=G=>{try{if(!u.isOutlineEditing)return;t.contains(G.target)||h()}catch{}};try{document.addEventListener("touchstart",vt,{passive:!0}),Ne.push(()=>document.removeEventListener("touchstart",vt))}catch{}document.addEventListener("click",Lt),Ne.push(()=>document.removeEventListener("click",Lt));for(let G of a)Ne.push(l(G,()=>{let ce=G.dataset.outlineAction||"";if(ce==="insertHttpLink"){h(),$().finally(()=>we());return}if(ce==="insertArticleLink"){h(),Q().finally(()=>we());return}let me=k(ce);h(),me&&we()}));for(let G of c)Ne.push(l(G,()=>{let ce=G.getAttribute("data-outline-clipboard-action")||"";if(!ce)return;h();let me=Zt||null,le=nr instanceof Set?nr:new Set,fe=le.size?new Set(le):me?new Set([me]):new Set;if(ce==="toggleSelectMode"){yo(!Fn);return}if(ce==="clear"){Js(null),Ee("\u0411\u0443\u0444\u0435\u0440 \u043E\u0447\u0438\u0449\u0435\u043D");return}if(se){if(ce==="copy"||ce==="cut"){if(!fe.size){Ee("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A");return}let xe=lp(se.state.doc,fe);if(!xe.length){Ee("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A");return}let Ie=xe.map(He=>He.node.toJSON());try{let He=xe.map(Ve=>td(Ve.node)).filter(Boolean).join(`

`);up(He)}catch{}if(Js({mode:ce==="cut"?"cut":"copy",sourceArticleId:St||u.articleId||null,createdAt:new Date().toISOString(),sections:Ie}),ce==="copy"){Ee(`\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${Ie.length}`);return}let ae=[];for(let He of xe){let Ve=it(se.state.doc,He.id),Ge=typeof Ve=="number"?se.state.doc.nodeAt(Ve):null;typeof Ve=="number"&&Ge&&ae.push({pos:Ve,size:Ge.nodeSize})}ae.sort((He,Ve)=>Ve.pos-He.pos);let ve=se.state.tr;for(let{pos:He,size:Ve}of ae)ve=ve.delete(He,He+Ve);ve=ve.setMeta(de,!0),se.view.dispatch(ve.scrollIntoView()),se.view.focus(),Jt=!0,Vt({delayMs:200}),yo(!1),Ee(`\u0412\u044B\u0440\u0435\u0437\u0430\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${Ie.length}`);return}if(ce==="paste"){let xe=_l();if(!xe||!Array.isArray(xe.sections)||!xe.sections.length){Ee("\u0411\u0443\u0444\u0435\u0440 \u043F\u0443\u0441\u0442");return}let Ie=se.state,ae=Ie.doc.content.size;if(me){let qe=it(Ie.doc,me),nt=typeof qe=="number"?Ie.doc.nodeAt(qe):null;typeof qe=="number"&&nt&&(ae=qe+nt.nodeSize)}let ve=new Set;try{Ie.doc.descendants(qe=>{if(qe?.type?.name!=="outlineSection")return;let nt=String(qe.attrs?.id||"").trim();nt&&ve.add(nt)})}catch{}let He=[];if(xe.mode==="copy")for(let qe of xe.sections)He.push(dp(qe,()=>$t()));else for(let qe of xe.sections){let nt=String(qe?.attrs?.id||"").trim();if(nt&&ve.has(nt)){Ee("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C: \u0431\u043B\u043E\u043A \u0441 \u0442\u0430\u043A\u0438\u043C id \u0443\u0436\u0435 \u0435\u0441\u0442\u044C");return}He.push(ed(qe))}let Ve=Ie.doc.type.schema,Ge=[];for(let qe of He)try{let nt=Ve.nodeFromJSON(qe);nt?.type?.name==="outlineSection"&&Ge.push(nt)}catch{}if(!Ge.length){Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438");return}let Qe=Ie.tr,Ze=ae;for(let qe of Ge)Qe=Qe.insert(Ze,qe),Ze+=qe.nodeSize;Qe=Qe.setMeta(de,!0),se.view.dispatch(Qe.scrollIntoView()),se.view.focus(),Jt=!0,Vt({delayMs:200}),xe.mode==="cut"&&Js(null),yo(!1),Ee(`\u0412\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${Ge.length}`)}}}));let dt=G=>{u.isOutlineEditing&&(t.contains(G.target)||h())},rt=G=>{u.isOutlineEditing&&G.key==="Escape"&&h()};document.addEventListener("pointerdown",dt),document.addEventListener("keydown",rt),Ne.push(()=>document.removeEventListener("pointerdown",dt)),Ne.push(()=>document.removeEventListener("keydown",rt));let ht=e.on("transaction",we),Kt=e.on("selectionUpdate",we);Ne.push(()=>ht?.()),Ne.push(()=>Kt?.());try{let G=Sp({setActiveTagKey:ce=>{try{xi?.(ce)}catch{}}});Ne.push(()=>G?.())}catch{}we(),mi=()=>{re&&(window.cancelAnimationFrame(re),re=null);for(let G of Ne)try{G()}catch{}}}function Hp(){if(mi)try{mi()}catch{}mi=null}function zn(e=""){let t=String(e||"");u.outlineStatusText=t,J.updatedAt&&u.isOutlineEditing&&(J.updatedAt.textContent=t)}function $p(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=r.child(1),s=t+1+o.nodeSize,a=n.tr;if(!i.childCount){let l=n.doc.type.schema;a=a.insert(s+1,l.nodes.paragraph.create({},[]))}let{TextSelection:c}=ze?.pmStateMod||{};return c?(a=a.setSelection(c.near(a.doc.resolve(s+2),1)),e.view.dispatch(a.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0):!1}catch{return!1}}function Fp(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=t+1,{TextSelection:s}=ze?.pmStateMod||{};if(!s)return!1;let a=i+1,c=i+o.nodeSize-1,l=Math.min(Math.max(a,a),Math.max(a,c)),d=n.tr.setSelection(s.near(n.doc.resolve(l),1));return d=d.setMeta(de,!0),e.view.dispatch(d.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0}catch{return!1}}function zp(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=t+1,{TextSelection:s}=ze?.pmStateMod||{};if(!s)return!1;let a=i+1,c=i+o.nodeSize-1,l=Math.max(a,c),d=n.tr.setSelection(s.near(n.doc.resolve(l),-1));return d=d.setMeta(de,!0),e.view.dispatch(d.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0}catch{return!1}}function Up(e,t){try{if(!e)return!1;let n=String(t||"").trim();if(!n)return!1;let r=e.state,o=it(r.doc,n);if(typeof o!="number")return!1;let i=r.doc.nodeAt(o);if(!i||i.type?.name!=="outlineSection")return!1;if(i.attrs?.collapsed)return Fp(e,o);try{if(!i.child(1)?.childCount)return zp(e,o)}catch{}return $p(e,o)}catch{return!1}}function qp(e,t,{block:n="center"}={}){try{let r=String(t||"").trim();if(!e||!r)return!1;let o=e.view;if(!o?.dom?.querySelector)return!1;let i=typeof CSS<"u"&&CSS.escape?CSS.escape(r):r.replace(/"/g,'\\"'),s=()=>{try{let a=o.dom?.querySelector?.(`[data-outline-section][data-section-id="${i}"]`)||o.dom?.querySelector?.(`[data-section-id="${i}"]`);a&&typeof a.scrollIntoView=="function"&&a.scrollIntoView({block:n||"center",inline:"nearest"})}catch{}};try{window.requestAnimationFrame(s)}catch{}try{setTimeout(s,80)}catch{}return!0}catch{return!1}}async function Vp(){if(ze)return ze;if(typeof window>"u")throw new Error("Outline editor is browser-only");let e=pr()?performance.now():0,t=await import("/outline/tiptap.bundle.js");return e&&Hr("import tiptap.bundle.js",{ms:Math.round(performance.now()-e)}),ze={core:t.core,starterKitMod:t.starterKitMod,htmlMod:t.htmlMod,pmStateMod:t.pmStateMod,pmViewMod:t.pmViewMod,pmTablesMod:t.pmTablesMod,linkMod:t.linkMod,imageMod:t.imageMod,tableMod:t.tableMod,tableRowMod:t.tableRowMod,tableCellMod:t.tableCellMod,tableHeaderMod:t.tableHeaderMod,uniqueIdMod:t.uniqueIdMod,markdownMod:t.markdownMod},ze}function Jp({blocks:e,parseHtmlToNodes:t}){let n=i=>Array.isArray(i)&&i.length>0?i:[{type:"paragraph",content:[]}],r=i=>{let s=String(i?.id||$t()),a=!!i?.collapsed,c=_n(String(i?.text||"")),l=ea(c.titleHtml)||"",d=n(t(c.bodyHtml||"")),h=Array.isArray(i?.children)?i.children:[];return{type:"outlineSection",attrs:{id:s,collapsed:a},content:[{type:"outlineHeading",content:l?[{type:"text",text:l}]:[]},{type:"outlineBody",content:d},{type:"outlineChildren",content:h.map(r)}]}},o=(Array.isArray(e)?e:[]).map(r);return{type:"doc",content:o.length?o:[r({id:$t(),text:"",collapsed:!1,children:[]})]}}function jp(e){try{let t=String(e||"").trim();if(!t)return null;let n=window?.localStorage?.getItem?.("ttree_outline_last_active_v1")||"{}",r=JSON.parse(n||"{}"),o=r&&typeof r=="object"?r[t]:null;if(!o||typeof o!="object")return null;let i=String(o.sectionId||"").trim();return i?{sectionId:i,collapsed:!!o.collapsed}:null}catch{return null}}function gd(e,t,n){try{let r=String(e||"").trim(),o=String(t||"").trim();if(!r||!o)return!1;let i=window?.localStorage?.getItem?.("ttree_outline_last_active_v1")||"{}",s=JSON.parse(i||"{}"),a=s&&typeof s=="object"?s:{};return a[r]={sectionId:o,collapsed:!!n,savedAt:new Date().toISOString()},window?.localStorage?.setItem?.("ttree_outline_last_active_v1",JSON.stringify(a)),!0}catch{return!1}}function Jl(e){try{let t=St||u.articleId||null;if(!t||!e||e.isDestroyed)return!1;let n=e.state,r=wt(n.doc,n.selection.$from);if(typeof r!="number")return!1;let o=n.doc.nodeAt(r);if(!o||o.type?.name!=="outlineSection")return!1;let i=String(o.attrs?.id||"").trim();if(!i)return!1;let s=!!o.attrs?.collapsed;return ui.articleId===t&&ui.sectionId===i&&ui.collapsed===s?!1:(ui={articleId:t,sectionId:i,collapsed:s},gd(t,i,s))}catch{return!1}}function Kp(e,{lines:t=4}={}){try{if(!e||e.isDestroyed)return!1;let n=e.view;if(!n||!n.state||!n.dom)return!1;let r=n.state.selection;return!r||typeof r.from!="number"?!1:(fi&&cancelAnimationFrame(fi),fi=requestAnimationFrame(()=>{fi=null;try{let o=n.coordsAtPos(r.from);if(!o||typeof o.bottom!="number")return;let s=(y=>{try{let k=y;for(;k&&k!==document.body&&k!==document.documentElement;){let E=window.getComputedStyle(k),L=String(E.overflowY||"");if((L==="auto"||L==="scroll"||L==="overlay")&&k.scrollHeight>k.clientHeight+2)return k;k=k.parentElement}}catch{}return document.scrollingElement||document.documentElement})(n.dom),a=window.getComputedStyle(n.dom),c=String(a.lineHeight||"").trim(),l=c==="normal"?20:Number.parseFloat(c)||20,d=Math.max(24,l*Math.max(1,Number(t)||4)+12),h=window.innerHeight||0,g=0;if(s&&s!==document.scrollingElement&&s!==document.documentElement&&s!==document.body){let y=s.getBoundingClientRect();g=y.top,h=y.height}if(!h)return;let w=o.bottom-g,S=h-d;if(w<=S)return;let f=w-S,p=Math.max(0,(s.scrollTop||0)+f);s.scrollTop=p}catch{}}),!0)}catch{return!1}}function wt(e,t){try{if(t?.nodeAfter?.type?.name==="outlineSection")return t.pos}catch{}for(let n=t.depth;n>0;n-=1)if(t.node(n)?.type?.name==="outlineSection")return t.before(n);return null}function vi(e){if(!e)return"";let t=e.child(0),n=e.child(1),r=$n(t?.textContent||""),o="";try{o=$n(n?.textBetween?.(0,n.content.size,`
`,`
`)||"")}catch{o=$n(n?.textContent||"")}return $n(`${r}
${o}`)}function jl(e){if(!e)return"";let t=e.child(1),n="";try{n=$n(t?.textBetween?.(0,t.content.size,`
`,`
`)||"")}catch{n=$n(t?.textContent||"")}return n}function Kl(e){if(!Ys||!Xs)return"";let t=[];return e?.content?.forEach?.(o=>{t.push(o.toJSON())}),(Ys({type:"doc",content:t},Xs)||""||"").trim()}function Wl(e){try{return $n(String(e?.textContent||"").replace(/\u00a0/g," ")).trim()}catch{return""}}function Wp(e){try{let t=document.createElement("template");return t.innerHTML=String(e||""),$n(String(t.content.textContent||"").replace(/\u00a0/g," ")).trim()}catch{return""}}function yd(e){try{if(!e)return null;let t=e.state?.selection||null;if(!t)return null;let n=Number.isFinite(t.anchor)?t.anchor:t.from,r=Number.isFinite(t.head)?t.head:t.to,o=t.$from||null,i=null;try{let s=o?wt(e.state.doc,o):null;if(typeof s=="number"){let a=e.state.doc.nodeAt(s);i=String(a?.attrs?.id||"")||null}}catch{i=null}return!Number.isFinite(n)||!Number.isFinite(r)?null:{anchor:n,head:r,sectionId:i}}catch{return null}}function bd(e,t,n){try{if(!e?.view||!t)return!1;let{TextSelection:r}=ze?.pmStateMod||{};if(!r||!n)return e.view.dispatch(t),!0;let o=t.doc?.content?.size??null;if(!Number.isFinite(o))return e.view.dispatch(t),!0;let i=t.mapping.map(Math.max(0,Math.min(n.anchor,o)),1),s=t.mapping.map(Math.max(0,Math.min(n.head,o)),1);try{t=t.setSelection(r.create(t.doc,i,s))}catch{}return e.view.dispatch(t),!0}catch{try{return e?.view?.dispatch?.(t),!0}catch{return!1}}}function Yp(e,t,n,r={}){if(!e||!t)return!1;let o=it(e.state.doc,t);if(typeof o!="number")return!1;let i=e.state.doc.nodeAt(o);if(!i)return!1;let s=e.state.schema,a=i.child(0),c=o+1,l=String(n||"").replace(/\u00a0/g," ").trim(),d=s.nodes.outlineHeading.create({},l?[s.text(l)]:[]),h=e.state.tr.replaceWith(c,c+a.nodeSize,d).setMeta(de,!0),g=r?.preserveSelection?yd(e):null;return bd(e,h,g),!0}function Xp(e,t,n,r={}){if(!e||!t||!Ao)return!1;let o=it(e.state.doc,t);if(typeof o!="number")return!1;let i=e.state.doc.nodeAt(o);if(!i)return!1;let s=i.child(0),a=i.child(1),c=o+1+s.nodeSize,l=e.state.schema,d=[];try{d=Ao(n||"")}catch{d=[]}let h=[];try{h=(Array.isArray(d)?d:[]).map(f=>l.nodeFromJSON(f))}catch{h=[l.nodes.paragraph.create({},[])]}h.length||(h=[l.nodes.paragraph.create({},[])]);let g=l.nodes.outlineBody.create({},h),w=e.state.tr.replaceWith(c,c+a.nodeSize,g).setMeta(de,!0),S=r?.preserveSelection?yd(e):null;return bd(e,w,S),!0}function na(e){if(!e)return!0;let t=e.child(0);return!$n(t?.textContent||"")}function Gp(e,t,n){if(!e||!t)return!1;let r=it(e.state.doc,t);if(typeof r!="number")return!1;let o=e.state.doc.nodeAt(r);if(!o||!na(o))return!1;let i=o.child(0),s=r+1,a=s+1,c=s+i.nodeSize-1,l=String(n||"").trim();if(!l)return!1;let d=l.length>200?l.slice(0,200):l,h=e.state.tr.insertText(d,a,c).setMeta(de,!0);return e.view.dispatch(h),!0}function Qp(e){wr.clear(),e.descendants(t=>{if(t?.type?.name!=="outlineSection")return;let n=String(t.attrs?.id||"");n&&wr.set(n,vi(t))})}function it(e,t){let n=null;return e.descendants((r,o)=>{if(n!==null)return!1;r?.type?.name==="outlineSection"&&String(r.attrs?.id||"")===String(t||"")&&(n=o)}),n}function Zp(e,t){try{let n=e.doc,r=it(n,t),o=typeof r=="number"?n.nodeAt(r):null;if(!o)return null;let i=e.schema,s=i.marks?.code||null,a=i.nodes?.codeBlock||null;if(!s||!a)return null;let c=o.child(0),l=o.child(1);if(!c||!l)return null;let h=r+1+c.nodeSize+1,g=[];if(l.descendants((S,f)=>{if(!S||S.type?.name!=="paragraph")return;let p=!1,y=!1,k=!0;for(let O=0;O<S.childCount;O+=1){let z=S.child(O);if(z){if(z.type?.name==="hardBreak"){y=!0;continue}if(z.isText){if(!String(z.text||""))continue;if(!(Array.isArray(z.marks)?z.marks:[]).some(W=>W?.type===s)){k=!1;break}p=!0;continue}k=!1;break}}if(!k||!p||!y)return;let E="";for(let O=0;O<S.childCount;O+=1){let z=S.child(O);if(z){if(z.type?.name==="hardBreak"){E+=`
`;continue}z.isText&&(E+=String(z.text||""))}}if(!E.trim())return;let L=h+f;g.push({from:L,to:L+S.nodeSize,text:E})}),!g.length)return null;let w=e.tr;for(let S=g.length-1;S>=0;S-=1){let{from:f,to:p,text:y}=g[S],k=w.doc.resolve(f),E=k.parent,L=k.index();if(!E?.canReplaceWith?.(L,L+1,a))continue;let O=i.text(y),z=a.create(null,O);w=w.replaceWith(f,p,z)}return w.docChanged?w.setMeta(de,!0):null}catch{return null}}function wd(e,t,n){if(!e||!t||!n||u.article?.encrypted)return;let r=it(t,n),o=typeof r=="number"?t.nodeAt(r):null;if(!o||!na(o))return;let i=jl(o);if(!i)return;let s=ta(i),a=Vs.get(n)||null;a?.inFlight||a?.bodyHash!==s&&(Vs.set(n,{bodyHash:s,inFlight:!0}),za(i).then(c=>{let l=String(c?.title||"").trim();if(!l||l.length>200)return;let d=e.state.doc,h=it(d,n),g=typeof h=="number"?d.nodeAt(h):null;if(!g||!na(g))return;let w=jl(g);if(!(ta(w)!==s||!Gp(e,n,l))){Jt=!0;try{let f=St||u.articleId||null;f&&(ra({articleId:f,doc:e.state.doc,sectionId:n,reason:"generate_title"}),zn("\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438 \u043D\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044E"))}catch{}Vt({delayMs:900})}}).catch(()=>{}).finally(()=>{Vs.set(n,{bodyHash:s,inFlight:!1})}))}function em(e,t,n){if(!(!e||!t)&&!(!Array.isArray(n)||!n.length)&&!u.article?.encrypted&&!(typeof navigator<"u"&&navigator&&navigator.onLine===!1)){try{if((Ae?.getState?.(e.state)||null)?.editingSectionId)return}catch{}for(let r of n)try{wd(e,t,r)}catch{}}}function Yl(e,t,n){let r=String(n||"").trim(),o=(z,q={})=>Dt("skip",{reason:z,sectionId:r,...q});if(!e||!t||!r){o("missing_args",{hasEditor:!!e,hasDoc:!!t,hasSectionId:!!r});return}if(u.article?.encrypted){o("encrypted_article");return}try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1){o("offline");return}}catch{}let i=it(t,r),s=typeof i=="number"?t.nodeAt(i):null;if(!s){o("section_not_found",{pos:typeof i=="number"?i:null});return}let a=s.child(0),c=s.child(1),l=Wl(a),d=l?`<p>${xo(l)}</p>`:"",h=Kl(c);if(!d&&!h){o("empty_heading_and_body");return}let g=d?Dr(d):"",w=h?Dr(h):"",S=(z,q)=>{if(!q||z?.inFlight||z?.status==="ok"&&z?.htmlHash===q)return!0;if(z?.status==="error"&&z?.htmlHash===q){let $=Number(z?.lastAttemptAtMs||0)||0;if(Date.now()-$<np)return!0}return!1},f=go.get(r)||null,p=ho.get(r)||null,y=S(f,g),k=S(p,w);if(y&&k){o("already_ok_or_in_flight",{headingHash:g||null,bodyHash:w||null});try{Fr.delete(r)}catch{}return}let E=y,L=k,O=()=>{try{E&&L&&Fr.delete(r)}catch{}};y||(Dt("start_heading",{sectionId:r,htmlHash:g}),go.set(r,{htmlHash:g,inFlight:!0,status:f?.status||"ok",lastAttemptAtMs:Date.now()}),qi(d).then(z=>{let q=String(z?.html||"").trim();if(!q){Dt("skip_apply_heading",{sectionId:r,reason:"empty_corrected_html"});return}let $=Wp(q);if(!$){Dt("skip_apply_heading",{sectionId:r,reason:"empty_corrected_plain"});return}let Q=e.state.doc,W=it(Q,r),re=typeof W=="number"?Q.nodeAt(W):null;if(!re){Dt("skip_apply_heading",{sectionId:r,reason:"section_not_found_current_doc"});return}let we=Wl(re.child(0)),Ne=we?`<p>${xo(we)}</p>`:"";if(Dr(Ne)!==g){Dt("skip_apply_heading",{sectionId:r,reason:"heading_changed_since_request"});return}if(Dr(`<p>${xo($)}</p>`)===g){Dt("skip_apply_heading",{sectionId:r,reason:"no_changes_from_server"});return}if(!Yp(e,r,$,{preserveSelection:!0})){Dt("skip_apply_heading",{sectionId:r,reason:"apply_failed"});return}Jt=!0,Vt({delayMs:900})}).catch(()=>{Dt("error_heading",{sectionId:r,htmlHash:g}),go.set(r,{htmlHash:g,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()})}).finally(()=>{(go.get(r)||null)?.status!=="error"&&go.set(r,{htmlHash:g,inFlight:!1,status:"ok",lastAttemptAtMs:Date.now()}),Dt("done_heading",{sectionId:r,htmlHash:g}),E=!0,O()})),k||(Dt("start",{sectionId:r,htmlHash:w}),ho.set(r,{htmlHash:w,inFlight:!0,status:p?.status||"ok",lastAttemptAtMs:Date.now()}),qi(h).then(z=>{let q=String(z?.html||"").trim();if(!q){Dt("skip_apply",{sectionId:r,reason:"empty_corrected_html"});return}let $=e.state.doc,Q=it($,r),W=typeof Q=="number"?$.nodeAt(Q):null;if(!W){Dt("skip_apply",{sectionId:r,reason:"section_not_found_current_doc"});return}let re=Kl(W.child(1));if(Dr(re)!==w){Dt("skip_apply",{sectionId:r,reason:"body_changed_since_request"});return}if(Dr(q)===w){Dt("skip_apply",{sectionId:r,reason:"no_changes_from_server"});return}if(!Xp(e,r,q,{preserveSelection:!0})){Dt("skip_apply",{sectionId:r,reason:"apply_failed"});return}Jt=!0,Vt({delayMs:900})}).catch(()=>{Dt("error",{sectionId:r,htmlHash:w}),ho.set(r,{htmlHash:w,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()})}).finally(()=>{(ho.get(r)||null)?.status!=="error"&&ho.set(r,{htmlHash:w,inFlight:!1,status:"ok",lastAttemptAtMs:Date.now()}),Dt("done",{sectionId:r,htmlHash:w}),L=!0,O()}))}function hr(e,t){if(!t)return!1;let n=it(e,t);if(typeof n!="number")return!1;let r=e.nodeAt(n);if(!r)return!1;let o=vi(r),i=wr.get(t)||"";if(o===i)return!1;Sr.add(t);try{Fr.add(t)}catch{}return!0}function Vt({delayMs:e=1200}={}){u.isOutlineEditing&&se&&(u.isPublicView||St&&u.articleId&&St!==u.articleId||(Dn&&clearTimeout(Dn),Dn=setTimeout(()=>{Dn=null,So()},Math.max(200,e))))}async function So({force:e=!1}={}){if(u.isOutlineEditing&&se&&!u.isPublicView&&!(St&&u.articleId&&St!==u.articleId)&&!pi&&!(!e&&!Jt&&!Sr.size)){pi=!0,zn("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C\u2026");try{try{let t=se.state,n=wt(t.doc,t.selection.$from);if(typeof n=="number"){let r=t.doc.nodeAt(n),o=String(r?.attrs?.id||"");o&&hr(t.doc,o)}}catch{}await tm({silent:!0,mode:"queue"})}finally{pi=!1}}}async function Sd(){if(!J.outlineEditor)return;let e=J.outlineEditor.querySelector("#outlineEditorContent");if(!e){Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043C\u043E\u043D\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440");return}if(mo)return mo;mo=(async()=>{let t=pr()?performance.now():0,n=pr()?performance.now():0,{core:r,starterKitMod:o,htmlMod:i,pmStateMod:s,pmViewMod:a}=await Vp();n&&Hr("loadTiptap()",{ms:Math.round(performance.now()-n)});let{Editor:c,Node:l,Extension:d,InputRule:h,mergeAttributes:g}=r,w=o.default||o.StarterKit||o,{generateJSON:S,generateHTML:f}=i,{TextSelection:p}=s,{Plugin:y,PluginKey:k}=s,{Decoration:E,DecorationSet:L}=a,O=ze.linkMod.default||ze.linkMod.Link||ze.linkMod,z=ze.imageMod.default||ze.imageMod.Image||ze.imageMod,q=ze.tableMod.TableKit||ze.tableMod.tableKit;mt={TableMap:ze.pmTablesMod?.TableMap||null,CellSelection:ze.pmTablesMod?.CellSelection||null,moveTableColumn:ze.pmTablesMod?.moveTableColumn||null,moveTableRow:ze.pmTablesMod?.moveTableRow||null,addRowBefore:ze.pmTablesMod?.addRowBefore||null,addRowAfter:ze.pmTablesMod?.addRowAfter||null,deleteRow:ze.pmTablesMod?.deleteRow||null,addColumnBefore:ze.pmTablesMod?.addColumnBefore||null,addColumnAfter:ze.pmTablesMod?.addColumnAfter||null,deleteColumn:ze.pmTablesMod?.deleteColumn||null,toggleHeaderRow:ze.pmTablesMod?.toggleHeaderRow||null,toggleHeaderColumn:ze.pmTablesMod?.toggleHeaderColumn||null};let $=ze.uniqueIdMod.default||ze.uniqueIdMod.UniqueID||ze.uniqueIdMod,Q=ze.markdownMod?.Markdown||ze.markdownMod?.default?.Markdown||ze.markdownMod?.default||null,W=A=>{let m=String(A||"").trim();if(!m)return null;let v=m.match(/(\d+(?:\.\d+)?)px/i);if(!v)return null;let C=Number.parseFloat(v[1]);return Number.isFinite(C)?C:null},re=new k("outlineTagHighlighter"),we=l.create({name:"tag",group:"inline",inline:!0,atom:!0,selectable:!1,renderText({node:A}){try{return String(A?.attrs?.label||"").trim()}catch{return""}},addAttributes(){return{label:{default:""},key:{default:""}}},parseHTML(){return[{tag:'span[data-tt-tag="1"]'}]},renderHTML({node:A,HTMLAttributes:m}){let v=String(A?.attrs?.label||"").trim(),C=String(A?.attrs?.key||"").trim();return["span",g(m,{"data-tt-tag":"1","data-tag-key":C,class:"tt-tag"}),v||C||""]},addInputRules(){let A=/(^|[\s([{"'-])\\([^\\\n]{1,60}?)\\$/;return[new h({find:A,handler:({state:m,range:v,match:C})=>{let D=String(C?.[1]||""),M=String(C?.[2]||""),N=od(M);if(!N)return null;let P=id(N);if(!P)return null;let T=m.schema.nodes?.tag;if(!T)return null;let x=T.create({label:P,key:P}),I=m.tr.delete(v.from,v.to),b=v.from;D&&(I=I.insertText(D,b),b+=D.length),I=I.insert(b,x);let B=p.near(I.doc.resolve(Math.min(I.doc.content.size,b+x.nodeSize)),1);return I=I.setSelection(B),I=I.setMeta(de,!0),I}})]}}),Ne=d.create({name:"outlineTagHighlighter",addProseMirrorPlugins(){return[new y({key:re,state:{init:()=>({activeKey:null}),apply:(A,m)=>{let v=A.getMeta(re);return v&&Object.prototype.hasOwnProperty.call(v,"activeKey")?{activeKey:v.activeKey?String(v.activeKey):null}:m}},props:{decorations(A){let m=re.getState(A)?.activeKey||null,v=[];return A.doc.descendants((C,D)=>{if(C?.type?.name!=="tag")return;let M=String(C.attrs?.key||"").trim();if(!M)return;let N=m&&M===m?"tt-tag tt-tag--active":"tt-tag";v.push(E.node(D,D+C.nodeSize,{class:N}))}),v.length?L.create(A.doc,v):null}}})]}}),Z=z.extend({inline:!0,group:"inline",addAttributes(){return{...typeof this.parent=="function"?this.parent():{},width:{default:320,parseHTML:m=>{try{let v=m,C=v&&v.classList&&v.classList.contains("resizable-image")?v:v?.closest?.(".resizable-image"),D=W(C?.style?.width||"");if(D!==null)return Math.round(D);let M=W(C?.getAttribute?.("style")||"")||W(v?.getAttribute?.("style")||"");if(M!==null)return Math.round(M);let N=C?.getAttribute?.("data-width")||v?.getAttribute?.("data-width")||"",P=Number.parseFloat(String(N||""));return Number.isFinite(P)&&P>0?Math.round(P):320}catch{return 320}},renderHTML:()=>({})},aspectRatio:{default:null,parseHTML:m=>{try{let v=m,C=v&&v.classList&&v.classList.contains("resizable-image")?v:v?.closest?.(".resizable-image"),D=C?.style?.aspectRatio||C?.getAttribute?.("data-aspect-ratio")||v?.getAttribute?.("data-aspect-ratio")||"",M=Number.parseFloat(String(D||"").replace(",","."));return Number.isFinite(M)&&M>0?M:null}catch{return null}},renderHTML:()=>({})},uploadToken:{default:null,parseHTML:()=>null,renderHTML:()=>({})}}},parseHTML(){return[{tag:"span.resizable-image",getAttrs:A=>{let m=A,v=m?.querySelector?.("img"),C=v?.getAttribute?.("src")||"";if(!C)return!1;let D=v?.getAttribute?.("alt")||"",M=v?.getAttribute?.("title")||"",N=W(m?.style?.width||"")??320;return{src:C,alt:D,title:M,width:Math.round(N)}}},{tag:"img[src]",getAttrs:A=>{let m=A,v=m?.getAttribute?.("src")||"";if(!v)return!1;let C=m?.getAttribute?.("alt")||"",D=m?.getAttribute?.("title")||"";return{src:v,alt:C,title:D,width:320}}}]},renderHTML({node:A,HTMLAttributes:m}){let v=A?.attrs?.width,C=Number.isFinite(Number(v))?Math.round(Number(v)):320,D=A?.attrs?.aspectRatio,M=Number.isFinite(Number(D))&&Number(D)>0?Number(D):null,N={...m};return delete N.width,delete N.aspectRatio,delete N.uploadToken,N.style=`${String(N.style||"").trim()};width:100%;height:auto;display:block;`.replace(/^;\s*/,""),["span",g({class:"resizable-image",style:`width:${C}px;max-width:100%;${M?`aspect-ratio:${M.toFixed(6)};`:""}`,...M?{"data-aspect-ratio":String(M)}:{}},{}),["span",{class:"resizable-image__inner"},["img",g(N,{draggable:"false"})]],["span",{class:"resizable-image__handle","data-direction":"e","aria-hidden":"true"}]]}});Ys=f,Xs=[w.configure({heading:!1,link:!1}),O.configure({openOnClick:!1,protocols:li}),Z,q.configure({table:{resizable:!0}})];let pe=d.create({name:"outlineImageUpload",addProseMirrorPlugins(){let A=D=>{if(!D)return!1;if(D.type&&String(D.type).startsWith("image/"))return!0;let M=String(D.name||"").toLowerCase();return!!(M&&/\.(png|jpe?g|gif|webp|bmp|svg|heic|heif)$/i.test(M))},m=(D,M)=>{let N=[];return Array.from(D||[]).forEach(P=>{if(P.kind!=="file")return;let T=typeof P.getAsFile=="function"?P.getAsFile():null;T&&A(T)&&N.push(T)}),!N.length&&M?.length&&Array.from(M).forEach(P=>{A(P)&&N.push(P)}),N},v=(D,M)=>{let N=`upl-${Date.now()}-${Math.random().toString(16).slice(2)}`,P=URL.createObjectURL(M);try{br.set(N,P)}catch{}try{let V=St||u.articleId||null;wl({token:N,articleId:V,kind:"image",blob:M,fileName:M?.name||"image",mime:M?.type||""})}catch{}let T=D.state.schema.nodes.image.create({src:P,alt:M?.name||"image",width:320,uploadToken:N}),x=D.state.tr,I=x.selection.from,b=x.selection.to,B="\xA0\xA0";b>I&&(x=x.delete(I,b));let _=Math.max(0,Math.min(x.doc.content.size,I));x=x.insertText(B,_,_);let H=Math.max(0,Math.min(x.doc.content.size,_+B.length));x=x.replaceRangeWith(H,H,T);let R=Math.max(0,Math.min(x.doc.content.size,H+T.nodeSize));x=x.insertText(B,R,R);let F=Math.max(0,Math.min(x.doc.content.size,R+B.length));x=x.setSelection(p.create(x.doc,F)),x=x.setMeta(de,!0),D.dispatch(x.scrollIntoView());try{let V=new z;V.decoding="async",V.onload=()=>{try{let j=Number(V.naturalWidth||0),X=Number(V.naturalHeight||0);if(!(j>0&&X>0))return;let te=j/X,he=hi(D.state.doc,N);if(typeof he!="number")return;let oe=D.state.doc.nodeAt(he);if(!oe||oe.type?.name!=="image"||Number.isFinite(Number(oe.attrs?.aspectRatio))&&Number(oe.attrs.aspectRatio)>0)return;let ge={...oe.attrs,aspectRatio:te},Me=D.state.tr.setNodeMarkup(he,void 0,ge);Me=Me.setMeta(de,!0),D.dispatch(Me)}catch{}},V.onerror=()=>{},V.src=P}catch{}try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1){Ee("\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E \u0438 \u0431\u0443\u0434\u0435\u0442 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E \u043F\u0440\u0438 \u043F\u043E\u044F\u0432\u043B\u0435\u043D\u0438\u0438 \u0441\u0435\u0442\u0438");return}}catch{}Wr(M).then(V=>{let j=String(V?.url||"").trim();if(!j)throw new Error("Upload failed");let X=hi(D.state.doc,N);if(typeof X!="number")return;let te=D.state.doc.nodeAt(X);if(!te||te.type?.name!=="image")return;let he={...te.attrs,src:j,uploadToken:null},oe=D.state.tr.setNodeMarkup(X,void 0,he);oe=oe.setMeta(de,!0),D.dispatch(oe),Gl(N),Ps(N).catch(()=>{})}).catch(V=>{Ee(V?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435");try{let j=hi(D.state.doc,N);if(typeof j!="number")return;let X=D.state.doc.nodeAt(j);if(!X||X.type?.name!=="image")return;let te=String(X.attrs?.title||"").trim(),he=te?`${te} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",oe=String(X.attrs?.alt||M?.name||"image"),ge={...X.attrs,src:P,alt:oe,title:he,uploadToken:N},Me=D.state.tr.setNodeMarkup(j,void 0,ge);Me=Me.setMeta(de,!0),D.dispatch(Me)}catch{}try{_s(N,String(V?.message||V||"error"))}catch{}})},C=(D,M,N,P)=>{try{if(!(Ae?.getState?.(D.state)||null)?.editingSectionId)return!1}catch{return!1}let T=m(N,P);if(!T.length)return!1;M.preventDefault(),M.stopPropagation();for(let x of T)v(D,x);return!0};return[new y({props:{handleDOMEvents:{paste(D,M){let N=M?.clipboardData?.items||null,P=M?.clipboardData?.files||null;return C(D,M,N,P)},drop(D,M){let N=M?.dataTransfer?.items||null,P=M?.dataTransfer?.files||null;return C(D,M,N,P)}}},view(D){return{update(M,N){try{let P=Ae?.getState?.(N)||{},T=Ae?.getState?.(M.state)||{},x=P.editingSectionId||null,I=T.editingSectionId||null;if(x&&!I){let b=String(x||"").trim(),B=St||u.articleId||null;if(!b||!B)return;let _=!1;try{let H=it(M.state.doc,b),R=typeof H=="number"?M.state.doc.nodeAt(H):null;R?.type?.name==="outlineSection"&&(_=!!R.attrs?.collapsed)}catch{}gd(B,b,_);try{let H=it(M.state.doc,b),R=typeof H=="number"?M.state.doc.nodeAt(H):null;if(!R||R.type?.name!=="outlineSection")return;let F=!wr.has(b),V=F||hr(M.state.doc,b),j=!1;if(V){let te=R.child(0),he=R.child(1),oe=te?.toJSON?te.toJSON():null,ge=he?.toJSON?he.toJSON():null;if(oe&&ge){let Me=rd(oe,ge);if(Me>wi){Ee(`\u0411\u043B\u043E\u043A \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 (${Math.ceil(Me/1024)} KB). \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C: ${Math.ceil(wi/1024)} KB. \u0420\u0430\u0437\u0431\u0435\u0439\u0442\u0435 \u0431\u043B\u043E\u043A \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E.`);try{let Oe=M.state.tr.setMeta(de,!0);Oe=Oe.setMeta(Ae,{type:"enter",sectionId:b}),M.dispatch(Oe)}catch{}return}let $e=Date.now(),Je=nd(B,b);try{ot("outline.enqueue.section_upsert_content",{articleId:B,sectionId:b,seq:Je,bytes:Me,reason:F?"exit_edit_mode_new_section":"exit_edit_mode"})}catch{}j=!0,zt("section_upsert_content",{articleId:B,payload:{sectionId:b,headingJson:oe,bodyJson:ge,seq:Je,clientQueuedAt:$e},coalesceKey:`content:${B}:${b}`})}}let X=!1;if(F||Cn||Nt){let te=Io(M.state.doc);if(te.length){let he=null;try{he=te.filter(oe=>oe&&(oe.parentId==null||oe.parentId==="")&&Number(oe.position)>=0).sort((oe,ge)=>Number(oe.position)-Number(ge.position)).slice(0,3).map(oe=>String(oe.sectionId||""))}catch{he=null}try{ot("outline.enqueue.structure_snapshot",{articleId:B,nodesCount:te.length,reason:F?"exit_edit_mode_new_section":"exit_edit_mode",rootFirst:he})}catch{}zt("structure_snapshot",{articleId:B,payload:{nodes:te},coalesceKey:`structure:${B}`}),X=!0}Cn=!1,Nt&&(clearTimeout(Nt),Nt=null)}try{(j||F)&&(wr.set(b,vi(R)),Sr.delete(b))}catch{}try{j&&se&&!se.isDestroyed&&se.view===M&&wd(se,M.state.doc,b)}catch{}(j||X)&&zn("\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438 \u043D\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044E")}catch{}}}catch{}}}}})]}}),We=d.create({name:"outlineImageResize",addProseMirrorPlugins(){return[new y({view(A){let m=null,v=(N,P)=>{try{if((A.state.selection?.node||null)?.type?.name==="image"&&typeof A.state.selection.from=="number")return A.state.selection.from;let x=F=>{if(typeof F!="number")return null;let V=[F,F-1,F+1,F-2,F+2];for(let j of V){if(j<0)continue;if(A.state.doc.nodeAt(j)?.type?.name==="image")return j}return null},I=N?.querySelector?.("img")||null,b=x(A.posAtDOM(N,0));if(typeof b=="number")return b;let B=I?x(A.posAtDOM(I,0)):null;if(typeof B=="number")return B;let _=P&&typeof P.clientX=="number"&&typeof P.clientY=="number"?{left:P.clientX,top:P.clientY}:null,H=_?A.posAtCoords(_):null,R=H&&typeof H.pos=="number"?x(H.pos):null;return typeof R=="number"?R:null}catch{return null}},C=N=>{if(N.button!==0)return;let P=N.target?.closest?.(".resizable-image__handle");if(!P)return;let T=P.closest(".resizable-image");if(!T||!A.dom.contains(T)||!(Ae?.getState?.(A.state)||null)?.editingSectionId)return;let I=v(T,N);if(typeof I!="number")return;let b=A.state.doc.nodeAt(I);if(!b||b.type?.name!=="image")return;N.preventDefault(),N.stopPropagation();let B=T.getBoundingClientRect();m={pos:I,startWidth:B.width,startX:N.clientX,wrapper:T,lastWidth:B.width},T.classList.add("resizable-image--resizing")},D=N=>{if(!m)return;N.preventDefault();let P=N.clientX-m.startX,x=parseFloat(getComputedStyle(document.documentElement).fontSize)||16,I=Math.max(x,document.documentElement.clientWidth-32),b=10,B=m.startWidth+P;B=Math.max(x,Math.min(B,I)),B=Math.round(B/b)*b,B=Math.max(x,Math.min(B,I)),m.lastWidth=B,m.wrapper.style.width=`${Math.round(B)}px`},M=()=>{if(!m)return;let{pos:N,wrapper:P}=m;P.classList.remove("resizable-image--resizing");let T=A.state.doc.nodeAt(N)?.type?.name==="image"?N:v(P,null),x=typeof T=="number"?A.state.doc.nodeAt(T):null;if(x&&x.type?.name==="image"){let b=Number(m.lastWidth||0)||P.getBoundingClientRect().width,B=Math.max(1,Math.round(b/10)*10),_={...x.attrs,width:B},H=A.state.tr.setNodeMarkup(T,void 0,_);H=H.setMeta(de,!0),A.dispatch(H)}m=null};return A.dom.addEventListener("pointerdown",C),document.addEventListener("pointermove",D),document.addEventListener("pointerup",M),document.addEventListener("pointercancel",M),{destroy(){A.dom.removeEventListener("pointerdown",C),document.removeEventListener("pointermove",D),document.removeEventListener("pointerup",M),document.removeEventListener("pointercancel",M)}}}})]}}),yt=d.create({name:"outlineImagePreview",addProseMirrorPlugins(){return[new y({props:{handleDOMEvents:{click(A,m){try{if((Ae?.getState?.(A.state)||null)?.editingSectionId)return!1;let C=m?.target?.closest?.("img");return C?m.target?.closest?.(".resizable-image__handle")?(m.preventDefault(),!0):(m.preventDefault(),Gr(C.src,C.alt||""),!0):!1}catch{return!1}}}}})]}}),kt=d.create({name:"outlineMarkdownTablePaste",addProseMirrorPlugins(){let A=(m,v)=>{try{if(!(Ae?.getState?.(m.state)||null)?.editingSectionId)return!1;let D=v?.clipboardData?.getData?.("text/plain")||"";if(sn("paste: text/plain",{len:D.length,sample:D.slice(0,200)}),!D)return!1;let M=oa(D),N=gr(M);sn("paste: parsed",{ok:!!N,lines:M});let P=N?null:yr(M);if(!N&&!P)return!1;let T=N?{header:N.header,rows:N.rows,withHeader:!0}:{header:null,rows:P.rows,withHeader:!1},x=null;try{x=Zn(m.state.schema,T)}catch(b){return sn("paste: buildTableNode error",{message:String(b?.message||b||""),stack:String(b?.stack||""),schemaNodes:Object.keys(m.state.schema?.nodes||{})}),!1}if(sn("paste: tableNode",{ok:!!x,schemaNodes:Zs()?Object.keys(m.state.schema?.nodes||{}):void 0}),!x)return!1;v.preventDefault(),v.stopPropagation();let I=m.state.tr;m.state.selection.empty||(I=I.deleteSelection());try{I=I.replaceSelectionWith(x,!1)}catch(b){return sn("paste: replaceSelectionWith error",{message:String(b?.message||b||""),stack:String(b?.stack||""),selection:{from:m.state.selection?.from,to:m.state.selection?.to,empty:m.state.selection?.empty,$fromParent:m.state.selection?.$from?.parent?.type?.name}}),!1}return I=I.setMeta(de,!0),m.dispatch(I.scrollIntoView()),!0}catch(C){return sn("paste: unexpected error",{message:String(C?.message||C||""),stack:String(C?.stack||"")}),!1}};return[new y({appendTransaction(m,v,C){try{let D=m?.some?.(I=>I?.docChanged),M=null;if(Ae)for(let I of m||[]){let b=I?.getMeta?.(Ae)||null;if(b?.type==="enter"&&b?.sectionId){M=String(b.sectionId);break}}let N=!!M;if(!D&&!N||m.some(I=>I.getMeta?.(de)))return null;let P=Ae?.getState?.(C)||null,T=M||P?.editingSectionId||null;if(!T)return null;sn("appendTransaction: try convert",{didDocChange:D,didEnterEditMode:N,sectionId:T});let x=Ip(C,T);if(x)return x;if(Zs()){let I=it(C.doc,T),b=typeof I=="number"?C.doc.nodeAt(I):null,B=b?b.child(1):null,_=B?B.textContent:"";String(_||"").includes("|")&&sn("appendTransaction: saw pipes but no conversion",{sectionId:T})}return Zp(C,T)}catch{return null}},props:{handlePaste(m,v){return A(m,v)},handleDOMEvents:{paste(m,v){return A(m,v)}}}})]}}),jt=d.create({name:"outlineStructuredSectionPaste",addProseMirrorPlugins(){let A=M=>{let N=String(M||"").trim();if(!N)return{sections:[],startsWithHeading:!1,headingCount:0};if(!/<h[1-6][\s>]/i.test(N))return{sections:[],startsWithHeading:!1,headingCount:0};let P=null;try{P=new DOMParser().parseFromString(N,"text/html")}catch{return{sections:[],startsWithHeading:!1,headingCount:0}}let T=P?.body;if(!T)return{sections:[],startsWithHeading:!1,headingCount:0};let x=!1;try{let _=Array.from(T.childNodes||[]).find(H=>H?.nodeType===1&&String(H?.textContent||"").trim());x=!!(_&&/^H[1-6]$/.test(String(_.nodeName||"")))}catch{x=!1}let I=[],b=null,B=()=>{if(!b)return;let _=document.createElement("div");for(let R of b.nodes)try{_.appendChild(R.cloneNode(!0))}catch{}let H=String(_.innerText||_.textContent||"").trimEnd();I.push({level:b.level,title:b.title,bodyText:H}),b=null};for(let _ of Array.from(T.childNodes||[])){let F=(_?.nodeType===1?String(_.nodeName||"").toUpperCase():"").match(/^H([1-6])$/);if(F){B();let V=Number(F[1]),j=String(_.textContent||"").trim();if(!j)continue;b={level:V,title:j,nodes:[]};continue}b&&b.nodes.push(_)}return B(),{sections:I,startsWithHeading:x,headingCount:I.length}},m=M=>{let N=M?.selection?.$from;if(!N)return null;for(let P=N.depth;P>0;P-=1)if(N.node(P)?.type?.name==="outlineSection")return N.before(P);return null},v=(M,N)=>{let P=String(N||"").replace(/\r\n/g,`
`).trimEnd(),T=M.nodes.paragraph;if(!T)return[];let x=M.nodes.hardBreak||M.nodes.hard_break||null,I=_=>{let H=String(_||"").split(`
`),R=[];for(let F=0;F<H.length;F+=1){let V=H[F];F>0&&x&&R.push(x.create()),V&&R.push(M.text(V))}return T.create({},R)};if(!P.trim())return[T.create({},[])];let b=P.split(/\n{2,}/),B=[];for(let _ of b){let H=String(_||"").trimEnd();B.push(I(H))}return B.length?B:[T.create({},[])]},C=(M,N)=>{let P=M.nodes.outlineHeading.create({},N.title?[M.text(N.title)]:[]),T=v(M,N.bodyText),x=M.nodes.outlineBody.create({},T),I=(N.children||[]).map(B=>C(M,B)),b=M.nodes.outlineChildren.create({},I);return M.nodes.outlineSection.create({id:N.id,collapsed:!1},[P,x,b])},D=(M,N)=>{try{if(!(Ae?.getState?.(M.state)||null)?.editingSectionId)return!1;let T=N?.clipboardData?.getData?.("text/html")||"",x=N?.clipboardData?.getData?.("text/plain")||"",I=T?A(T):{sections:[],startsWithHeading:!1,headingCount:0},b=!I.sections.length&&x?Os(x):{sections:[],startsWithHeading:!1,headingCount:0},B=I.sections.length?I:b;if(!B.sections.length||!(B.startsWithHeading||B.sections.length>=2))return!1;N.preventDefault(),N.stopPropagation();let H=m(M.state);if(typeof H!="number")return!1;let R=M.state.doc.nodeAt(H);if(!R||R.type?.name!=="outlineSection")return!1;let F=Al(B.sections,{makeId:()=>$t()});if(!F.length)return!1;let V=M.state.schema,j=F.map(he=>C(V,he)),X=M.state.tr,te=H+R.nodeSize;for(let he of j)X=X.insert(te,he),te+=he.nodeSize;return X=X.setMeta(de,!0),M.dispatch(X.scrollIntoView()),!0}catch{return!1}};return[new y({props:{handlePaste(M,N){return D(M,N)},handleDOMEvents:{paste(M,N){return D(M,N)}}}})]}}),en=(A="")=>{let m=String(A||"").trim();return m?m.startsWith("app:/")||m.startsWith("disk:/")?`/api/yandex/disk/file?path=${encodeURIComponent(m)}`:m:""},cn=d.create({name:"outlineAttachmentUpload",addProseMirrorPlugins(){let A=N=>{let P=String(N?.type||"");return!(P&&P.startsWith("image/"))},m=(N,P)=>{let T=[];try{let x=[];if(P&&typeof P.length=="number")x.push(...Array.from(P||[]));else if(N&&typeof N.length=="number")for(let I of Array.from(N||[])){if(!I||I.kind!=="file")continue;let b=I.getAsFile?.();b&&x.push(b)}for(let I of x)I&&A(I)&&T.push(I)}catch{}return T},v=N=>`pending-attachment:${String(N||"")}`,C=(N,P)=>{let T=v(P),x=N?.type?.schema?.marks?.link||null;if(!x)return null;let I=null;return N.descendants((b,B)=>{if(I)return!1;!b||!b.isText||!(Array.isArray(b.marks)?b.marks:[]).find(R=>R?.type===x&&String(R?.attrs?.href||"")===T)||(I={from:B,to:B+b.nodeSize})}),I},D=(N,P)=>{let T=N?.state?.schema,x=T?.marks?.link||null;if(!T||!x){Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u0438\u0435: \u043D\u0435\u0442 \u0441\u0445\u0435\u043C\u044B \u0441\u0441\u044B\u043B\u043E\u043A");return}if(!u.articleId){Ee("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}let I=$t(),b=v(I),B=String(P?.name||"\u0444\u0430\u0439\u043B"),_=`${B} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430...)`,{from:H,to:R}=N.state.selection,F=N.state.tr.insertText(_,H,R);F=F.addMark(H,H+_.length,x.create({href:b})),F=F.setMeta(de,!0),N.dispatch(F.scrollIntoView());let V=null;try{V=(Ae?.getState?.(N.state)||null)?.editingSectionId||null}catch{V=null}Do(u.articleId,P,{sectionId:V}).then(j=>{let X=String(j?.storedPath||j?.url||j?.path||"").trim();if(!X)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443 \u043D\u0430 \u0444\u0430\u0439\u043B");let te=String(j?.originalName||P?.name||"\u0444\u0430\u0439\u043B"),he=C(N.state.doc,I);if(!he)return;let oe=N.state.tr.insertText(te,he.from,he.to);oe=oe.addMark(he.from,he.from+te.length,x.create({href:X})),oe=oe.setMeta(de,!0),N.dispatch(oe)}).catch(j=>{let X=C(N.state.doc,I);if(X){let te=`${B} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`,he=N.state.tr.insertText(te,X.from,X.to);he=he.setMeta(de,!0),N.dispatch(he)}Ee(j?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u043D\u0430 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A")})},M=(N,P,T,x)=>{let I=m(T,x);if(!I.length)return!1;P.preventDefault(),P.stopPropagation();try{if(!(Ae?.getState?.(N.state)||null)?.editingSectionId)return $r(),!0}catch{return $r(),!0}for(let b of I)D(N,b);return!0};return[new y({props:{handleDOMEvents:{drop(N,P){let T=P?.dataTransfer?.items||null,x=P?.dataTransfer?.files||null;return M(N,P,T,x)},paste(N,P){let T=P?.clipboardData?.items||null,x=P?.clipboardData?.files||null;return M(N,P,T,x)}}}})]}}),yn=l.create({name:"doc",topNode:!0,content:"outlineSection+"}),Bn=l.create({name:"outlineChildren",content:"outlineSection*",defining:!0,renderHTML(){return["div",{class:"outline-children","data-outline-children":"true"},0]},parseHTML(){return[{tag:"div[data-outline-children]"}]},addNodeView(){return({node:A})=>{let m=document.createElement("div");m.className="outline-children",m.setAttribute("data-outline-children","true");let v=C=>{let D=!C||C.childCount===0;m.setAttribute("data-empty",D?"true":"false")};return v(A),{dom:m,contentDOM:m,update(C){return!C||C.type?.name!=="outlineChildren"?!1:(v(C),!0)}}}}}),Nn=A=>{try{if(!A||A.childCount===0)return!0;let m=!1;return A.descendants(v=>{if(m)return!1;let C=v?.type?.name;return C==="image"||C==="table"||v.isText&&String(v.text||"").replace(/\u00a0/g," ").trim()?(m=!0,!1):!0}),!m}catch{return!1}},bn=l.create({name:"outlineBody",content:"block*",defining:!0,renderHTML(){return["div",{class:"outline-body","data-outline-body":"true"},0]},parseHTML(){return[{tag:"div[data-outline-body]"}]},addNodeView(){return({node:A})=>{let m=document.createElement("div");m.className="outline-body",m.setAttribute("data-outline-body","true");let v=C=>{let D=Nn(C);m.setAttribute("data-empty",D?"true":"false")};return v(A),{dom:m,contentDOM:m,update(C){return!C||C.type?.name!=="outlineBody"?!1:(v(C),!0)}}}}}),wn=l.create({name:"outlineHeading",content:"inline*",defining:!0,renderHTML(){return["div",{class:"outline-heading","data-outline-heading":"true"},0]},parseHTML(){return[{tag:"div[data-outline-heading]"}]},addNodeView(){return({editor:A,getPos:m,node:v})=>{let C=document.createElement("div");C.className="outline-heading",C.setAttribute("data-outline-heading","true");let D=document.createElement("button");D.type="button",D.className="outline-heading__toggle",D.title="\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C/\u0440\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C (Ctrl+\u2190/\u2192), \u0441 \u0434\u0435\u0442\u044C\u043C\u0438 (Ctrl+\u2191/\u2193)",D.setAttribute("aria-label","\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C/\u0440\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C");let M=document.createElement("div");M.className="outline-heading__content";let N=document.createElement("button");N.type="button",N.className="outline-heading__select",N.setAttribute("role","checkbox"),N.setAttribute("aria-checked","false"),N.setAttribute("aria-label","\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0431\u043B\u043E\u043A"),N.textContent="\u2713",N.addEventListener("pointerdown",T=>{T.preventDefault()}),N.addEventListener("click",T=>{if(T.preventDefault(),T.stopPropagation(),!Fn)return;let x=typeof m=="function"?m():null;if(typeof x!="number")return;let I=x-1,b=A.state.doc.nodeAt(I),B=String(b?.attrs?.id||"").trim();B&&cp(B)});let P=()=>{let T=typeof m=="function"?m():null;if(typeof T!="number")return;let x=T-1,I=A.state.doc.nodeAt(x),b=String(I?.attrs?.id||"");b&&C.setAttribute("data-section-id",b),C.dataset.empty=v.content.size===0?"true":"false";let B=A.state.doc.resolve(Math.max(0,x+1)),_=0;for(let R=B.depth;R>=0;R-=1)B.node(R)?.type?.name==="outlineSection"&&(_+=1);C.dataset.depth=String(Math.min(6,Math.max(1,_||1)));let H=Fn&&b&&nr.has(b);N.setAttribute("aria-checked",H?"true":"false"),N.style.display=Fn?"inline-flex":"none"};return D.addEventListener("click",T=>{T.preventDefault(),T.stopPropagation();let x=typeof m=="function"?m():null;if(typeof x!="number")return;let I=x-1,b=A.state.doc.nodeAt(I);if(!b)return;let B=!b.attrs?.collapsed,_=A.state.tr.setNodeMarkup(I,void 0,{...b.attrs,collapsed:B});try{B&&Ae&&(Ae.getState(A.state)||{}).editingSectionId&&(_=_.setMeta(Ae,{type:"exit"}))}catch{}_.setMeta(de,!0),A.view.dispatch(_),A.view.focus()}),C.appendChild(D),C.appendChild(M),C.appendChild(N),P(),{dom:C,contentDOM:M,update:T=>T.type.name!=="outlineHeading"?!1:(v=T,P(),!0)}}}}),vt=l.create({name:"outlineSection",group:"block",content:"outlineHeading outlineBody outlineChildren",defining:!0,isolating:!0,draggable:!0,addAttributes(){return{collapsed:{default:!1}}},renderHTML({node:A,HTMLAttributes:m}){let v={...m,class:`outline-section${m?.class?` ${m.class}`:""}`,"data-outline-section":"true","data-section-id":A.attrs.id||"","data-collapsed":A.attrs.collapsed?"true":"false"};return["div",g(v),0]},parseHTML(){return[{tag:"div[data-outline-section]"}]}}),Lt=A=>{if(!A)return!0;if((A.textContent||"").replace(/\u00a0/g," ").trim())return!1;if(A.childCount)for(let v=0;v<A.childCount;v+=1){let C=A.child(v);if(C.type?.name!=="paragraph"||(C.textContent||"").replace(/\u00a0/g," ").trim())return!1}return!0},dt=A=>{if(!A)return!0;try{let m=A.child(0),v=A.child(1),C=A.child(2);return Lt(m)&&Lt(v)&&(!C||C.childCount===0)}catch{return!0}},rt=(A,m,v)=>{let C=A.doc.nodeAt(v);if(!C)return!1;let D=String(C.attrs?.id||"").trim(),M=A.doc.resolve(v),N=M.index(),P=M.parent;if(!P)return!1;if(P.childCount<=1){if(P.type?.name==="doc"){let V=A.doc.type.schema,j=V.nodes.outlineSection.create({...C.attrs,collapsed:!1},[V.nodes.outlineHeading.create({},[]),V.nodes.outlineBody.create({},[V.nodes.paragraph.create({},[])]),V.nodes.outlineChildren.create({},[])]),X=A.tr.replaceWith(v,v+C.nodeSize,j);X=X.setMeta(de,!0);let te=j.child(0),he=v+1+te.nodeSize;return m(X.setSelection(p.near(X.doc.resolve(he+2),1)).scrollIntoView()),!0}D&&Or(D);let R=null;try{for(let V=M.depth;V>0;V-=1)if(M.node(V)?.type?.name==="outlineSection"){R=M.before(V);break}}catch{R=null}let F=A.tr.delete(v,v+C.nodeSize);F=F.setMeta(de,!0);try{if(typeof R=="number"){let V=F.mapping.map(R,-1),j=F.doc.nodeAt(V);if(j&&j.type?.name==="outlineSection"){let X=j.child(0),te=j.child(1),he=V+1+X.nodeSize;if(!te.childCount){let oe=F.doc.type.schema;F=F.insert(he+1,oe.nodes.paragraph.create({},[]))}F=F.setSelection(p.near(F.doc.resolve(he+2),1))}}}catch{}return m(F.scrollIntoView()),!0}let T=N>0,x=N<P.childCount-1,I=T?P.child(N-1):null,b=T?v-I.nodeSize:null,B=v+C.nodeSize;D&&Or(D);let _=A.tr.delete(v,v+C.nodeSize),H=(R,F)=>{try{let V=R.doc.nodeAt(F);if(!V||V.type?.name!=="outlineSection")return R;let j=V.child(0),te=F+1+j.nodeSize-1;return R.setSelection(p.near(R.doc.resolve(te),-1))}catch{return R}};if(x){let R=v<_.doc.content.size?v:B;_.doc.nodeAt(R)&&(_=H(_,R))}else T&&typeof b=="number"&&_.doc.nodeAt(b)&&(_=H(_,b));return _=_.setMeta(de,!0),m(_.scrollIntoView()),!0},ht=(A,m,v)=>{let C=A.doc.nodeAt(v);if(!C)return!1;let D=A.doc.resolve(v),M=D.index(),N=D.parent;if(!N||M<=0)return!1;let P=N.child(M-1),T=v-P.nodeSize,x=C.child(0),I=C.child(1),b=C.child(2),B=A.tr.delete(v,v+C.nodeSize),_=B.doc.nodeAt(T);if(!_)return B=B.setMeta(de,!0),m(B.scrollIntoView()),!0;let H=B.doc.type.schema,R=_.child(0),F=_.child(1),V=_.child(2),j=[],X=(x?.textContent||"").replace(/\u00a0/g," ").trim();X&&j.push(H.nodes.paragraph.create({},[H.text(X)])),I?.content?.forEach?.($e=>{j.push($e)});let te=j.length?H.nodes.outlineBody.create({},j).content:null,he=te?F.content.append(te):F.content,oe=V.content.append(b.content),ge=H.nodes.outlineSection.create(_.attrs,[R,H.nodes.outlineBody.create({},he),H.nodes.outlineChildren.create({},oe)]);B=B.replaceWith(T,T+_.nodeSize,ge);let Me=B.doc.nodeAt(T);if(Me){let $e=Me.child(0),Je=Me.child(1),Fe=T+1+$e.nodeSize+Je.nodeSize-1;B=B.setSelection(p.near(B.doc.resolve(Fe),-1))}return B=B.setMeta(de,!0),m(B.scrollIntoView()),!0},Kt=(A,m,v)=>{let C=A.doc.nodeAt(v);if(!C)return!1;let D=A.selection.$from,M=null,N=null;for(let $e=D.depth;$e>0;$e-=1)if(D.node($e)?.type?.name==="outlineSection")if(M===null)M=$e;else{N=$e;break}if(M===null||N===null)return!1;let P=D.before(N);if(!A.doc.nodeAt(P))return!1;let x=A.doc.type.schema,I=C.child(0),b=C.child(1),B=C.child(2),_=A.tr.delete(v,v+C.nodeSize),H=_.doc.nodeAt(P);if(!H)return _=_.setMeta(de,!0),m(_.scrollIntoView()),!0;let R=H.child(0),F=H.child(1),V=H.child(2),j=[],X=(I?.textContent||"").replace(/\u00a0/g," ").trim();X&&j.push(x.nodes.paragraph.create({},[x.text(X)])),b?.content?.forEach?.($e=>{j.push($e)});let te=j.length?x.nodes.outlineBody.create({},j).content:null,he=te?F.content.append(te):F.content,oe=B.content.append(V.content),ge=x.nodes.outlineSection.create({...H.attrs,collapsed:!1},[R,x.nodes.outlineBody.create({},he),x.nodes.outlineChildren.create({},oe)]);_=_.replaceWith(P,P+H.nodeSize,ge);let Me=_.doc.nodeAt(P);if(Me){let $e=Me.child(0),Je=Me.child(1),Fe=P+1+$e.nodeSize+Je.nodeSize-1;_=_.setSelection(p.near(_.doc.resolve(Fe),-1))}return _=_.setMeta(de,!0),m(_.scrollIntoView()),!0},G=d.create({name:"outlineCommands",addKeyboardShortcuts(){let A=(U,ne)=>{for(let K=ne.depth;K>0;K-=1)if(ne.node(K)?.type?.name==="outlineSection")return ne.before(K);return null},m=(U,ne)=>{for(let K=U.depth;K>0;K-=1)if(U.node(K)?.type?.name===ne)return K;return null},v=U=>{if(!U)return!0;if((U.textContent||"").replace(/\u00a0/g," ").trim())return!1;if(U.childCount)for(let K=0;K<U.childCount;K+=1){let Y=U.child(K);if(Y.type?.name!=="paragraph"||(Y.textContent||"").replace(/\u00a0/g," ").trim())return!1}return!0},C=(U,ne)=>{let{selection:K}=U;if(!K||K.empty)return!1;let Y=A(U.doc,K.$from),ie=A(U.doc,K.$to);if(typeof Y!="number"||typeof ie!="number"||Y===ie||m(K.$from,"outlineBody")===null||K.$to.parent?.type?.name!=="outlineHeading"||K.$to.parentOffset!==0)return!1;let ue=U.doc.nodeAt(Y);if(!ue)return!1;let ye=ue.child(0),ke=ue.child(1),Le=Y+1+ye.nodeSize,be=Le+1,_e=Le+ke.nodeSize-1,Pe=Math.max(K.from,be),Be=Math.min(K.to,_e);if(Be<Pe)return!0;let Se=U.tr.delete(Pe,Be),Te=Se.doc.nodeAt(Le);if(Te&&Te.content.size===0){let Ce=Se.doc.type.schema;Se=Se.insert(be,Ce.nodes.paragraph.create({},[]))}return Se=Se.setSelection(p.near(Se.doc.resolve(be+1),1)),ne(Se.scrollIntoView()),!0},D=(U,ne,K={})=>{let{selection:Y}=U;if(!Y||Y.empty)return!1;let ie=A(U.doc,Y.$from),ee=A(U.doc,Y.$to);if(typeof ie!="number"||typeof ee!="number"||ie!==ee)return!1;let ue=m(Y.$from,"outlineHeading"),ye=m(Y.$to,"outlineHeading");if(ue===null||ye===null)return!1;let ke=U.doc.nodeAt(ie);if(!ke)return!1;let Le=ke.child(0),be=ie+1,_e=be+1,Pe=be+Le.nodeSize-1;if(Y.from<_e||Y.to>Pe)return!1;let Be=Math.max(Y.from,_e),Se=Math.min(Y.to,Pe);if(Se<Be)return!0;if(typeof K.onClipboard=="function")try{let Ce=U.doc.textBetween(Be,Se,`
`,`
`);K.onClipboard(Ce)}catch{}let Te=U.tr.delete(Be,Se);return Te=Te.setSelection(p.near(Te.doc.resolve(_e),1)),ne(Te.scrollIntoView()),!0},M=U=>{if(!U)return!0;let ne=U.child(0),K=U.child(1),Y=U.child(2);return v(ne)&&v(K)&&(!Y||Y.childCount===0)},N=(U,ne,K)=>{let Y=U.doc.nodeAt(K);if(!Y)return!1;let ie=Y.child(0),ee=Y.child(1),ye=K+1+ie.nodeSize+ee.nodeSize-1,ke=U.tr.setSelection(p.near(U.doc.resolve(ye),-1));return ne(ke.scrollIntoView()),!0},P=(U,ne,K)=>{let Y=U.doc.nodeAt(K);if(!Y)return!1;let ie=Y.child(0),ee=K+1,ue=U.tr.setSelection(p.near(U.doc.resolve(ee+1),1));return ne(ue.scrollIntoView()),!0},T=(U,ne,K)=>{let Y=U.doc.nodeAt(K);if(!Y)return!1;let ie=Y.child(0),ee=Y.child(1),ue=K+1+ie.nodeSize,ye=U.tr;if(!ee.childCount){let ke=U.doc.type.schema;ye=ye.insert(ue+1,ke.nodes.paragraph.create({},[]))}return ye=ye.setSelection(p.near(ye.doc.resolve(ue+2),1)),ne(ye.scrollIntoView()),!0},x=(U,ne,K)=>{let Y=U.doc.nodeAt(K);if(!Y)return!1;let ie=Y.child(0),ee=Y.child(1);if(!!Y.attrs?.collapsed){let _e=K+1+ie.nodeSize-1,Pe=U.tr.setSelection(p.near(U.doc.resolve(_e),-1));return ne(Pe),!0}let ke=K+1+ie.nodeSize+ee.nodeSize-1,Le=U.tr.setSelection(p.near(U.doc.resolve(ke),-1));return ne(Le),!0},I=(U,ne)=>{try{let K=U.resolve(Math.min(U.content.size,Math.max(0,ne+1)));for(let Y=K.depth;Y>0;Y-=1){let ie=K.node(Y);if(!(ie?.type?.name!=="outlineSection"||K.before(Y)===ne)&&ie.attrs?.collapsed)return!1}return!0}catch{return!0}},b=(U,ne)=>{let K=null;return U.nodesBetween(0,ne,(Y,ie)=>{if(ie>=ne)return!1;Y?.type?.name==="outlineSection"&&I(U,ie)&&(K=ie)}),K},B=(U,ne,K)=>{let Y=U.doc.nodeAt(K);if(!Y)return!1;let ie=String(Y.attrs?.id||"").trim(),ee=U.doc.resolve(K),ue=ee.index(),ye=ee.parent;if(!ye)return!1;if(ye.childCount<=1){if(ye.type?.name==="doc"){let Te=U.doc.type.schema,Ce=Te.nodes.outlineSection.create({...Y.attrs,collapsed:!1},[Te.nodes.outlineHeading.create({},[]),Te.nodes.outlineBody.create({},[Te.nodes.paragraph.create({},[])]),Te.nodes.outlineChildren.create({},[])]),Ue=U.tr.replaceWith(K,K+Y.nodeSize,Ce);Ue=Ue.setMeta(de,!0);let Re=Ce.child(0),Ye=K+1+Re.nodeSize;return ne(Ue.setSelection(p.near(Ue.doc.resolve(Ye+2),1)).scrollIntoView()),!0}let Be=null;try{for(let Te=ee.depth;Te>0;Te-=1)if(ee.node(Te)?.type?.name==="outlineSection"){Be=ee.before(Te);break}}catch{Be=null}let Se=U.tr.delete(K,K+Y.nodeSize);Se=Se.setMeta(de,!0);try{if(typeof Be=="number"){let Te=Se.mapping.map(Be,-1),Ce=Se.doc.nodeAt(Te);if(Ce&&Ce.type?.name==="outlineSection"){let Ue=Ce.child(0),Re=Ce.child(1),Ye=Te+1+Ue.nodeSize;if(!Re.childCount){let at=Se.doc.type.schema;Se=Se.insert(Ye+1,at.nodes.paragraph.create({},[]))}Se=Se.setSelection(p.near(Se.doc.resolve(Ye+2),1))}}}catch{}return ne(Se.scrollIntoView()),!0}ie&&Or(ie);let ke=ue>0,Le=ke?ye.child(ue-1):null,be=ke?K-Le.nodeSize:null,_e=K+Y.nodeSize,Pe=U.tr.delete(K,K+Y.nodeSize);if(ke&&typeof be=="number"){let Be=Pe.doc.nodeAt(be);if(Be){let Se=Be.child(0),Te=Be.child(1),Ce=be+1+Se.nodeSize;if(!Te.childCount){let Ue=Pe.doc.type.schema;Pe=Pe.insert(Ce+1,Ue.nodes.paragraph.create({},[]))}Pe=Pe.setSelection(p.near(Pe.doc.resolve(Ce+2),1))}}else{let Be=K<Pe.doc.content.size?K:_e,Se=Pe.doc.nodeAt(Be);if(Se){let Te=Se.child(0),Ce=Se.child(1),Ue=Be+1+Te.nodeSize;if(!Ce.childCount){let Re=Pe.doc.type.schema;Pe=Pe.insert(Ue+1,Re.nodes.paragraph.create({},[]))}Pe=Pe.setSelection(p.near(Pe.doc.resolve(Ue+2),1))}}return Pe=Pe.setMeta(de,!0),ne(Pe.scrollIntoView()),!0},_=(U,ne,K)=>{let Y=U.doc.nodeAt(K);if(!Y)return!1;let ie=String(Y.attrs?.id||"").trim(),ee=U.doc.resolve(K),ue=ee.index(),ye=ee.parent;if(!ye||ue<=0)return!1;ie&&Or(ie);let ke=ye.child(ue-1),Le=K-ke.nodeSize,be=Y.child(0),_e=Y.child(1),Pe=Y.child(2),Be=U.tr.delete(K,K+Y.nodeSize),Se=Be.doc.nodeAt(Le);if(!Se)return Be=Be.setMeta(de,!0),ne(Be.scrollIntoView()),!0;let Te=Be.doc.type.schema,Ce=Se.child(0),Ue=Se.child(1),Re=Se.child(2),Ye=[],at=(be?.textContent||"").replace(/\u00a0/g," ").trim();at&&Ye.push(Te.nodes.paragraph.create({},[Te.text(at)])),_e?.content?.forEach?.(xt=>{Ye.push(xt)});let ut=Ye.length?Te.nodes.outlineBody.create({},Ye).content:null,tn=ut?Ue.content.append(ut):Ue.content,Pt=Re.content.append(Pe.content),pn=Te.nodes.outlineSection.create(Se.attrs,[Ce,Te.nodes.outlineBody.create({},tn),Te.nodes.outlineChildren.create({},Pt)]);Be=Be.replaceWith(Le,Le+Se.nodeSize,pn);let ct=Be.doc.nodeAt(Le);if(ct){let xt=ct.child(0),Sn=ct.child(1),Ct=Le+1+xt.nodeSize+Sn.nodeSize-1;Be=Be.setSelection(p.near(Be.doc.resolve(Ct),-1))}return Be=Be.setMeta(de,!0),ne(Be.scrollIntoView()),!0},H=(U,ne,K)=>{let Y=U.doc.nodeAt(K);if(!Y)return!1;let ie=String(Y.attrs?.id||"").trim(),ee=U.selection.$from,ue=null,ye=null;for(let xt=ee.depth;xt>0;xt-=1)if(ee.node(xt)?.type?.name==="outlineSection")if(ue===null)ue=xt;else{ye=xt;break}if(ue===null||ye===null)return!1;let ke=ee.before(ye);if(!U.doc.nodeAt(ke))return!1;let be=U.doc.type.schema,_e=Y.child(0),Pe=Y.child(1),Be=Y.child(2);ie&&Or(ie);let Se=U.tr.delete(K,K+Y.nodeSize),Te=Se.doc.nodeAt(ke);if(!Te)return Se=Se.setMeta(de,!0),ne(Se.scrollIntoView()),!0;let Ce=Te.child(0),Ue=Te.child(1),Re=Te.child(2),Ye=[],at=(_e?.textContent||"").replace(/\u00a0/g," ").trim();at&&Ye.push(be.nodes.paragraph.create({},[be.text(at)])),Pe?.content?.forEach?.(xt=>{Ye.push(xt)});let ut=Ye.length?be.nodes.outlineBody.create({},Ye).content:null,tn=ut?Ue.content.append(ut):Ue.content,Pt=Be.content.append(Re.content),pn=be.nodes.outlineSection.create({...Te.attrs,collapsed:!1},[Ce,be.nodes.outlineBody.create({},tn),be.nodes.outlineChildren.create({},Pt)]);Se=Se.replaceWith(ke,ke+Te.nodeSize,pn);let ct=Se.doc.nodeAt(ke);if(ct){let xt=ct.child(0),Sn=ct.child(1),Ct=ke+1+xt.nodeSize+Sn.nodeSize-1;Se=Se.setSelection(p.near(Se.doc.resolve(Ct),-1))}return Se=Se.setMeta(de,!0),ne(Se.scrollIntoView()),!0},R=(U,ne,K)=>{let Y=U.doc.nodeAt(K);if(!Y)return!1;let ie=U.doc.resolve(K),ee=ie.index(),ue=ie.parent;if(!ue||ee>=ue.childCount-1)return!1;let ye=K+Y.nodeSize,ke=U.doc.nodeAt(ye);if(!ke||ke.type?.name!=="outlineSection")return!1;let Le=U.doc.type.schema,be=Y.child(0),_e=Y.child(1),Pe=Y.child(2),Be=ke.child(1),Se=ke.child(2),Te=_e.content.append(Be.content),Ce=Pe.content.append(Se.content),Ue=Le.nodes.outlineSection.create({...Y.attrs,collapsed:!1},[be,Le.nodes.outlineBody.create({},Te),Le.nodes.outlineChildren.create({},Ce)]),Re=U.tr;Re=Re.delete(ye,ye+ke.nodeSize),Re=Re.replaceWith(K,K+Y.nodeSize,Ue);let Ye=Re.doc.nodeAt(K);if(Ye){let at=Ye.child(0),ut=Ye.child(1),Pt=K+1+at.nodeSize+ut.nodeSize-1;Re=Re.setSelection(p.near(Re.doc.resolve(Pt),-1))}return Re=Re.setMeta(de,!0),ne(Re.scrollIntoView()),!0},F=U=>this.editor.commands.command(({state:ne,dispatch:K})=>{let Y=Be=>{try{if(typeof CSS<"u"&&CSS&&typeof CSS.escape=="function")return CSS.escape(String(Be||""))}catch{}return String(Be||"").replace(/["\\]/g,"\\$&")},ie=Be=>{try{let Se=Be;for(;Se&&Se!==document.body;){let Te=Se.parentElement;if(!Te)break;let Ce=window.getComputedStyle(Te),Ue=String(Ce?.overflowY||"");if((Ue==="auto"||Ue==="scroll")&&Te.scrollHeight>Te.clientHeight+1)return Te;Se=Te}}catch{}return document.scrollingElement||document.documentElement},ee=Be=>{try{let Se=String(Be||"").trim();if(!Se)return null;let Te=document.querySelector(`.outline-heading[data-section-id="${Y(Se)}"]`);if(!Te)return null;let Ce=ie(Te);return{sid:Se,scrollEl:Ce,top:Te.getBoundingClientRect().top}}catch{return null}},ue=Be=>{if(!Be)return;let{sid:Se,scrollEl:Te,top:Ce}=Be,Ue=()=>{try{let Re=document.querySelector(`.outline-heading[data-section-id="${Y(Se)}"]`);if(!Re)return;let at=Re.getBoundingClientRect().top-Ce;if(!Number.isFinite(at)||Math.abs(at)<1)return;Te.scrollTop+=at}catch{}};try{requestAnimationFrame(()=>requestAnimationFrame(Ue))}catch{setTimeout(Ue,0)}},ye=A(ne.doc,ne.selection.$from);if(typeof ye!="number")return!1;let ke=ne.doc.resolve(ye),Le=ke.index(),be=ke.parent;if(!be)return!1;let _e=ne.doc.nodeAt(ye);if(!_e)return!1;let Pe=ee(String(_e.attrs?.id||"").trim());if(U==="up"){if(Le>0){let Un=be.child(Le-1),On=ye-Un.nodeSize,Tt=ne.tr.delete(ye,ye+_e.nodeSize).insert(On,_e).setMeta(de,!0),rr=p.near(Tt.doc.resolve(On+2),1);return Tt.setSelection(rr),K(Tt.scrollIntoView()),ue(Pe),!0}let Be=oe(ne.doc,ye);if(typeof Be!="number")return!1;let Se=ne.doc.resolve(Be),Te=Se.index(),Ce=Se.parent;if(!Ce||Te<=0)return!1;let Ue=Ce.child(Te-1),Re=Be-Ue.nodeSize,Ye=ne.doc.nodeAt(Re);if(!Ye||Ye.type?.name!=="outlineSection")return!1;let at=Ye.child(0),ut=Ye.child(1),tn=Ye.child(2),pn=Re+1+at.nodeSize+ut.nodeSize+tn.nodeSize-1,ct=ne.tr.delete(ye,ye+_e.nodeSize).setMeta(de,!0),xt=ct.mapping.map(Re,-1),Sn=ct.mapping.map(pn,-1);ct=ct.insert(Sn,_e);let mn=ct.doc.nodeAt(xt);mn?.type?.name==="outlineSection"&&mn.attrs?.collapsed&&(ct=ct.setNodeMarkup(xt,void 0,{...mn.attrs,collapsed:!1}));let Ct=p.near(ct.doc.resolve(Sn+2),1);return ct.setSelection(Ct),K(ct.scrollIntoView()),ue(Pe),!0}if(U==="down"){if(Le<be.childCount-1){let Un=ye+_e.nodeSize,On=ne.doc.nodeAt(Un);if(!On)return!1;let Tt=ne.tr.delete(ye,ye+_e.nodeSize).setMeta(de,!0),rr=ye+On.nodeSize;Tt.insert(rr,_e);let ko=p.near(Tt.doc.resolve(rr+2),1);return Tt.setSelection(ko),K(Tt.scrollIntoView()),ue(Pe),!0}let Be=oe(ne.doc,ye);if(typeof Be!="number")return!1;let Se=ne.doc.nodeAt(Be);if(!Se||Se.type?.name!=="outlineSection")return!1;let Te=ne.doc.resolve(Be),Ce=Te.index(),Ue=Te.parent;if(!Ue||Ce>=Ue.childCount-1)return!1;let Re=Be+Se.nodeSize,Ye=ne.doc.nodeAt(Re);if(!Ye||Ye.type?.name!=="outlineSection")return!1;let at=Ye.child(0),ut=Ye.child(1),tn=Ye.child(2),pn=Re+1+at.nodeSize+ut.nodeSize+1,ct=ne.tr.delete(ye,ye+_e.nodeSize).setMeta(de,!0),xt=ct.mapping.map(Re,-1),Sn=ct.mapping.map(pn,-1);ct=ct.insert(Sn,_e);let mn=ct.doc.nodeAt(xt);mn?.type?.name==="outlineSection"&&mn.attrs?.collapsed&&(ct=ct.setNodeMarkup(xt,void 0,{...mn.attrs,collapsed:!1}));let Ct=p.near(ct.doc.resolve(Sn+2),1);return ct.setSelection(Ct),K(ct.scrollIntoView()),ue(Pe),!0}return!1}),V=()=>this.editor.commands.command(({state:U,dispatch:ne})=>{let{selection:K}=U;if(!K?.empty)return!1;let{$from:Y}=K,ie=A(U.doc,Y);if(typeof ie!="number")return!1;let ee=U.doc.nodeAt(ie);if(!ee)return!1;let ue=U.doc.type.schema;if(ee.attrs?.collapsed){let Ct=ie+ee.nodeSize,Un=$t(),On=ue.nodes.outlineSection.create({id:Un,collapsed:!1},[ue.nodes.outlineHeading.create({},[]),ue.nodes.outlineBody.create({},[ue.nodes.paragraph.create({},[])]),ue.nodes.outlineChildren.create({},[])]),Tt=U.tr.insert(Ct,On);return Tt=Tt.setSelection(p.create(Tt.doc,Ct+2)),Tt=Tt.setMeta(de,!0),Ae&&(Tt=Tt.setMeta(Ae,{type:"enter",sectionId:Un})),ne(Tt.scrollIntoView()),!0}let ye=ue.nodes.outlineChildren.create({},[]),ke=Ct=>Ct&&Ct.childCount?Ct:ue.nodes.outlineBody.create({},[ue.nodes.paragraph.create({},[])]);if(Y.parent?.type?.name==="outlineHeading"){let Ct=ee.child(0),Un=ee.child(1),On=ee.child(2),Tt=Y.parentOffset||0,rr=Ct.textBetween(0,Math.max(0,Math.min(Tt,Ct.content.size)),"",""),ko=Ct.textBetween(Math.max(0,Math.min(Tt,Ct.content.size)),Ct.content.size,"",""),Id=ue.nodes.outlineHeading.create({},rr?[ue.text(rr)]:[]),kd=ue.nodes.outlineHeading.create({},ko?[ue.text(ko)]:[]),ia=$t(),sa=ue.nodes.outlineSection.create({...ee.attrs,collapsed:!1},[Id,ke(ue.nodes.outlineBody.create({},[])),ye]),vd=ue.nodes.outlineSection.create({id:ia,collapsed:!1},[kd,ke(Un),On]),xn=U.tr.replaceWith(ie,ie+ee.nodeSize,sa),aa=xn.doc.nodeAt(ie),ca=ie+(aa?aa.nodeSize:sa.nodeSize);return xn=xn.insert(ca,vd),xn=xn.setSelection(p.create(xn.doc,ca+2)),xn=xn.setMeta(de,!0),Ae&&(xn=xn.setMeta(Ae,{type:"enter",sectionId:ia})),ne(xn.scrollIntoView()),!0}if(m(Y,"outlineBody")===null||!Y.parent?.isTextblock)return!1;let be=U.tr,_e=K.from;try{be=be.split(_e)}catch{return!1}let Pe=be.mapping.map(_e);try{be=be.setSelection(p.near(be.doc.resolve(Math.min(be.doc.content.size,Pe+1)),1))}catch{}let Be=be.selection.$from,Se=m(Be,"outlineBody"),Te=m(Be,"paragraph");if(Se===null||Te===null)return!1;let Ce=Be.before(Te),Ue=Be.end(Se);if(typeof Ce!="number"||typeof Ue!="number"||Ue<Ce)return!1;let Re=be.doc.slice(Ce,Ue).content;be=be.delete(Ce,Ue);let Ye=be.mapping.map(ie,-1),at=be.doc.nodeAt(Ye);if(!at)return ne(be.scrollIntoView()),!0;let ut=at.child(0),tn=ke(at.child(1)),Pt=at.child(2),pn=ue.nodes.outlineSection.create({...at.attrs,collapsed:!1},[ut,tn,ye]),ct=Re&&Re.childCount?ue.nodes.outlineBody.create({},Re):ue.nodes.outlineBody.create({},[ue.nodes.paragraph.create({},[])]),xt=$t(),Sn=ue.nodes.outlineSection.create({id:xt,collapsed:!1},[ue.nodes.outlineHeading.create({},[]),ct,Pt]);be=be.replaceWith(Ye,Ye+at.nodeSize,pn);let mn=Ye+pn.nodeSize;return be=be.insert(mn,Sn),be=be.setSelection(p.create(be.doc,mn+2)),be=be.setMeta(de,!0),Ae&&(be=be.setMeta(Ae,{type:"enter",sectionId:xt})),ne(be.scrollIntoView()),!0}),j=()=>this.editor.commands.command(({state:U,dispatch:ne})=>{let K=A(U.doc,U.selection.$from);if(typeof K!="number")return!1;let Y=U.doc.resolve(K),ie=0;for(let Ye=Y.depth;Ye>=0;Ye-=1)Y.node(Ye)?.type?.name==="outlineSection"&&(ie+=1);if(ie>=6)return!1;let ee=Y.index(),ue=Y.parent;if(!ue||ee<=0)return!1;let ye=U.doc.nodeAt(K);if(!ye)return!1;let ke=ue.child(ee-1),Le=K-ke.nodeSize,be=U.doc.nodeAt(Le);if(!be)return!1;let _e=be.child(0),Pe=be.child(1),Be=be.child(2),Te=Le+1+_e.nodeSize+Pe.nodeSize+Be.nodeSize-1,Ce=U.tr.delete(K,K+ye.nodeSize).insert(Te,ye).setMeta(de,!0),Ue=Ce.doc.nodeAt(Le);Ue?.type?.name==="outlineSection"&&Ue.attrs?.collapsed&&(Ce=Ce.setNodeMarkup(Le,void 0,{...Ue.attrs,collapsed:!1}));let Re=p.near(Ce.doc.resolve(Te+2),1);return Ce.setSelection(Re),ne(Ce.scrollIntoView()),!0}),X=()=>this.editor.commands.command(({state:U,dispatch:ne})=>{let K=U.selection.$from,Y=null,ie=null;for(let Pe=K.depth;Pe>0;Pe-=1)if(K.node(Pe)?.type?.name==="outlineSection")if(Y===null)Y=Pe;else{ie=Pe;break}if(Y===null||ie===null)return!1;let ee=K.before(Y),ue=K.before(ie),ye=U.doc.nodeAt(ee);if(!ye)return!1;let ke=U.tr.delete(ee,ee+ye.nodeSize).setMeta(de,!0),Le=ke.doc.nodeAt(ue);if(!Le)return!1;let be=ue+Le.nodeSize;ke.insert(be,ye);let _e=p.near(ke.doc.resolve(be+2),1);return ke.setSelection(_e),ne(ke.scrollIntoView()),!0}),te=U=>this.editor.commands.command(({state:ne,dispatch:K})=>{let Y=A(ne.doc,ne.selection.$from);if(typeof Y!="number")return!1;let ie=ne.doc.nodeAt(Y);if(!ie)return!1;let ee=typeof U=="boolean"?U:!ie.attrs?.collapsed,ue=ne.tr.setNodeMarkup(Y,void 0,{...ie.attrs,collapsed:ee}).setMeta(de,!0);try{ee&&Ae&&(Ae.getState(ne)||{}).editingSectionId&&(ue=ue.setMeta(Ae,{type:"exit"}))}catch{}return K(ue),!0}),he=(U,ne)=>{let K=U.nodeAt(ne);if(!K||K.type?.name!=="outlineSection")return[];let Y=[ne];return K.descendants((ie,ee)=>{ie?.type?.name==="outlineSection"&&Y.push(ne+1+ee)}),Y},oe=(U,ne)=>{try{let K=U.resolve(Math.min(U.content.size,ne+1)),Y=null;for(let ie=K.depth;ie>0;ie-=1){if(K.node(ie)?.type?.name!=="outlineSection")continue;if(K.before(ie)===ne){Y=ie;break}}if(Y===null)return null;for(let ie=Y-1;ie>0;ie-=1)if(K.node(ie)?.type?.name==="outlineSection")return K.before(ie);return null}catch{return null}},ge=(U,ne,K,Y)=>{let ie=!!Y,ee=U.tr;for(let ue of K){let ye=ee.doc.nodeAt(ue);!ye||ye.type?.name!=="outlineSection"||!!ye.attrs?.collapsed!==ie&&(ee=ee.setNodeMarkup(ue,void 0,{...ye.attrs,collapsed:ie}))}ee=ee.setMeta(de,!0);try{ie&&Ae&&(Ae.getState(U)||{}).editingSectionId&&(ee=ee.setMeta(Ae,{type:"exit"}))}catch{}ne(ee)},Me=()=>this.editor.commands.command(({state:U,dispatch:ne})=>{let K=A(U.doc,U.selection.$from);if(typeof K!="number")return!1;let Y=oe(U.doc,K),ie=typeof Y=="number"?Y:K,ee=he(U.doc,ie);if(!ee.length)return!1;let ue=U.tr;for(let ke of ee){let Le=ue.doc.nodeAt(ke);!Le||Le.type?.name!=="outlineSection"||Le.attrs?.collapsed||(ue=ue.setNodeMarkup(ke,void 0,{...Le.attrs,collapsed:!0}))}ue=ue.setMeta(de,!0);let ye=ue.doc.nodeAt(ie);if(ye){let ke=ye.child(0),be=ie+1+ke.nodeSize-1;ue=ue.setSelection(p.near(ue.doc.resolve(be),-1))}return ne(ue.scrollIntoView()),!0}),$e=()=>this.editor.commands.command(({state:U,dispatch:ne})=>{let K=A(U.doc,U.selection.$from);if(typeof K!="number")return!1;let Y=he(U.doc,K);return Y.length?(ge(U,ne,Y,!1),!0):!1}),Je=(U,ne)=>{try{let K=U.nodeAt(ne);if(!K||K.type?.name!=="outlineSection")return[];if(K.childCount<3)return[];let Y=K.child(0),ie=K.child(1),ee=K.child(2);if(!ee||ee.type?.name!=="outlineChildren")return[];let ue=ne+1+Y.nodeSize+ie.nodeSize,ye=[];return ee.descendants((ke,Le)=>{ke?.type?.name==="outlineSection"&&ye.push(ue+1+Le)}),ye}catch{return[]}},Oe=(U,ne)=>{try{let K=oe(U,ne);if(typeof K!="number")return Rr(U);let Y=U.nodeAt(K);if(!Y||Y.type?.name!=="outlineSection"||Y.childCount<3)return Rr(U);let ie=Y.child(0),ee=Y.child(1),ue=Y.child(2);if(!ue||ue.type?.name!=="outlineChildren")return Rr(U);let ye=K+1+ie.nodeSize+ee.nodeSize,ke=[];return ue.descendants((Le,be)=>{Le?.type?.name==="outlineSection"&&ke.push(ye+1+be)}),ke}catch{return Rr(U)}},Fe=(U,ne)=>{try{for(let K of ne||[]){let Y=U.nodeAt(K);if(!(!Y||Y.type?.name!=="outlineSection")&&Y.attrs?.collapsed)return!0}}catch{}return!1},Xe=()=>this.editor.commands.command(({state:U,dispatch:ne})=>{let K=A(U.doc,U.selection.$from);if(typeof K!="number")return!1;let Y=U.doc.nodeAt(K);if(!Y||Y.type?.name!=="outlineSection")return!1;if(Y.attrs?.collapsed)return ge(U,ne,[K],!1),!0;let ie=Je(U.doc,K);if(ie.length&&Fe(U.doc,ie))return ge(U,ne,ie,!1),!0;let ee=K;for(let ye=0;ye<64;ye+=1){let ke=Oe(U.doc,ee);if(ke.length&&Fe(U.doc,ke))return ge(U,ne,ke,!1),!0;let Le=oe(U.doc,ee);if(typeof Le!="number")break;ee=Le}let ue=Rr(U.doc);return ue.length&&Fe(U.doc,ue)?(ge(U,ne,ue,!1),!0):!1}),st=U=>this.editor.commands.command(({state:ne,dispatch:K})=>{let{selection:Y}=ne,ee=(Y?.node||null)?.type?.name==="outlineSection"?Y.from:A(ne.doc,ne.selection.$from);if(typeof ee!="number"||!ne.doc.nodeAt(ee))return!1;let ye=!!U,ke=he(ne.doc,ee);return ke.length?(ge(ne,K,ke,ye),!0):!1});return{"Alt-ArrowUp":()=>this.editor.isActive("table")?!1:F("up"),"Alt-ArrowDown":()=>this.editor.isActive("table")?!1:F("down"),"Alt-ArrowRight":()=>this.editor.isActive("table")?!1:j(),"Alt-ArrowLeft":()=>this.editor.isActive("table")?!1:X(),"Ctrl-Alt-ArrowUp":()=>this.editor.isActive("table")?!1:F("up"),"Alt-Ctrl-ArrowUp":()=>this.editor.isActive("table")?!1:F("up"),"Ctrl-Alt-ArrowDown":()=>this.editor.isActive("table")?!1:F("down"),"Alt-Ctrl-ArrowDown":()=>this.editor.isActive("table")?!1:F("down"),"Ctrl-Alt-ArrowRight":()=>this.editor.isActive("table")?!1:j(),"Alt-Ctrl-ArrowRight":()=>this.editor.isActive("table")?!1:j(),"Ctrl-Alt-ArrowLeft":()=>this.editor.isActive("table")?!1:X(),"Alt-Ctrl-ArrowLeft":()=>this.editor.isActive("table")?!1:X(),"Mod-ArrowRight":()=>te(!1),"Mod-ArrowLeft":()=>te(!0),"Mod-ArrowUp":()=>{try{let U=this.editor.state,ne=A(U.doc,U.selection.$from);if(typeof ne=="number"){let K=U.doc.nodeAt(ne);if(K?.type?.name==="outlineSection"&&typeof oe(U.doc,ne)!="number"&&K.attrs?.collapsed)return Qs(this.editor,!0)}}catch{}return Me()},"Mod-ArrowDown":()=>Xe(),"Mod-Enter":()=>{try{if(Ae&&!(Ae.getState(this.editor.state)||{}).editingSectionId)return!1}catch{}return V()},Backspace:()=>this.editor.commands.command(({state:U,dispatch:ne})=>{let{selection:K}=U;if(D(U,ne)||C(U,ne))return!0;if(!K?.empty)return!1;let{$from:Y}=K;if(Y.parent?.type?.name!=="outlineHeading"||Y.parentOffset!==0)return!1;let ie=A(U.doc,Y);if(typeof ie!="number")return!1;let ee=U.doc.nodeAt(ie);if(!ee)return!1;if(M(ee))return B(U,ne,ie);try{if(U.doc.resolve(ie).index()<=0)return H(U,ne,ie)}catch{}return _(U,ne,ie)}),Delete:()=>this.editor.commands.command(({state:U,dispatch:ne})=>{let{selection:K}=U;if(D(U,ne)||C(U,ne))return!0;if(!K?.empty)return!1;let{$from:Y}=K;if(m(Y,"outlineBody")!==null){let ke=A(U.doc,Y);if(typeof ke!="number")return!1;let Le=U.doc.nodeAt(ke);if(!Le)return!1;let be=Le.child(0),_e=Le.child(1),Be=ke+1+be.nodeSize+_e.nodeSize-1;return Y.pos===Be?R(U,ne,ke):!1}if(Y.parent?.type?.name!=="outlineHeading")return!1;let ee=A(U.doc,Y);if(typeof ee!="number")return!1;let ue=U.doc.nodeAt(ee);if(!ue)return!1;let ye=ue.child(0);if(Y.parentOffset===ye.content.size){if(M(ue))return B(U,ne,ee);let ke=ue.child(1),Le=ee+1+ye.nodeSize,be=U.tr;if(!ke.childCount){let _e=U.doc.type.schema;be=be.insert(Le+1,_e.nodes.paragraph.create({},[]))}return be=be.setSelection(p.near(be.doc.resolve(Le+2),1)),ne(be.scrollIntoView()),!0}return!1}),Enter:()=>this.editor.commands.command(({state:U,dispatch:ne})=>{let{selection:K}=U;if(!K?.empty)return!1;let{$from:Y}=K;if(Y.parent?.type?.name!=="outlineHeading")return!1;try{if(Ae&&!(Ae.getState(U)||{}).editingSectionId)return!1}catch{}let ie=A(U.doc,Y);if(typeof ie!="number")return!1;let ee=U.doc.nodeAt(ie);if(!ee)return!1;let ue=ee.child(0),ye=ee.child(1),ke=ie+1+ue.nodeSize,Le=ue.content?.size??0;if(ee.attrs?.collapsed&&Y.parentOffset===Le){let _e=ie+ee.nodeSize,Pe=U.doc.type.schema,Be=$t(),Se=Pe.nodes.outlineSection.create({id:Be,collapsed:!1},[Pe.nodes.outlineHeading.create({},[]),Pe.nodes.outlineBody.create({},[Pe.nodes.paragraph.create({},[])]),Pe.nodes.outlineChildren.create({},[])]),Te=U.tr.insert(_e,Se);return Te=Te.setSelection(p.create(Te.doc,_e+2)),Te=Te.setMeta(de,!0),Ae&&(Te=Te.setMeta(Ae,{type:"enter",sectionId:Be})),ne(Te.scrollIntoView()),!0}if(Y.parentOffset===0){let _e=U.doc.type.schema,Pe=$t(),Be=_e.nodes.outlineSection.create({id:Pe,collapsed:!1},[_e.nodes.outlineHeading.create({},[]),_e.nodes.outlineBody.create({},[_e.nodes.paragraph.create({},[])]),_e.nodes.outlineChildren.create({},[])]),Se=U.tr.insert(ie,Be);return Se=Se.setSelection(p.create(Se.doc,ie+2)),Se=Se.setMeta(de,!0),Ae&&(Se=Se.setMeta(Ae,{type:"enter",sectionId:Pe})),ne(Se.scrollIntoView()),!0}if(Y.parentOffset>0&&Y.parentOffset<Le){let _e=U.doc.type.schema,Pe=ue.textBetween(0,Math.max(0,Math.min(Y.parentOffset,Le)),"",""),Be=ue.textBetween(Math.max(0,Math.min(Y.parentOffset,Le)),Le,"",""),Se=_e.nodes.outlineHeading.create({},Pe?[_e.text(Pe)]:[]),Te=ee.child(2),Ce=[];try{for(let Pt=0;Pt<ye.childCount;Pt+=1)Ce.push(ye.child(Pt))}catch{}let Ue=_e.nodes.paragraph.create({},Be?[_e.text(Be)]:[]),Re=[];if(Be){let Pt=Ce[0]||null;Pt&&Pt.type?.name==="paragraph"&&v(Pt)?Re=[Ue,...Ce.slice(1)]:Re=[Ue,...Ce]}else Re=Ce;Re.length||(Re=[_e.nodes.paragraph.create({},[])]);let Ye=_e.nodes.outlineBody.create({},Re),at=_e.nodes.outlineSection.create({...ee.attrs,collapsed:!1},[Se,Ye,Te]),ut=U.tr.replaceWith(ie,ie+ee.nodeSize,at),tn=ut.doc.nodeAt(ie);if(tn){let Pt=tn.child(0),pn=ie+1+Pt.nodeSize;ut=ut.setSelection(p.near(ut.doc.resolve(pn+2),1))}else ut=ut.setSelection(p.near(ut.doc.resolve(ke+2),1));return ut=ut.setMeta(de,!0),ne(ut.scrollIntoView()),!0}let be=U.tr;if(!ye.childCount){let _e=U.doc.type.schema;be=be.insert(ke+1,_e.nodes.paragraph.create({},[]))}return be=be.setSelection(p.near(be.doc.resolve(ke+2),1)),ne(be.scrollIntoView()),!0}),ArrowUp:()=>this.editor.commands.command(({state:U,dispatch:ne})=>{let{selection:K}=U;if(!K?.empty)return!1;let{$from:Y}=K;if(Y.parent?.type?.name!=="outlineHeading"||Y.parentOffset!==0)return!1;let ie=A(U.doc,Y);if(typeof ie!="number")return!1;let ee=b(U.doc,ie);if(typeof ee=="number")return P(U,ne,ee);let ue=U.doc.resolve(ie),ye=ue.index(),ke=ue.parent;if(!ke)return!1;if(ye>0){let Pe=ke.child(ye-1),Be=ie-Pe.nodeSize;return P(U,ne,Be)}let Le=null,be=null;for(let Pe=Y.depth;Pe>0;Pe-=1)if(Y.node(Pe)?.type?.name==="outlineSection")if(Le===null)Le=Pe;else{be=Pe;break}if(be===null)return!1;let _e=Y.before(be);return P(U,ne,_e)})}},addProseMirrorPlugins(){let A=(m,v)=>{for(let C=m.depth;C>0;C-=1)if(m.node(C)?.type?.name===v)return C;return null};return[new y({key:new k("outlineAltMoveRepeatGuard"),props:{handleKeyDown:(m,v)=>{let C=M=>{try{return!!M?.getModifierState?.("AltGraph")}catch{return!1}},D=M=>{try{return(!!M?.altKey||C(M))&&!M?.metaKey&&(!M?.ctrlKey||C(M))}catch{return!1}};try{if(!v||!D(v))return!1;let M=String(v.key||"");if(M!=="ArrowUp"&&M!=="ArrowDown"||!v.repeat)return!1;let N=m?.state,P=N?.selection?.$from;if(!P)return!1;for(let B=P.depth;B>0;B-=1){let _=P.node(B)?.type?.name;if(_&&String(_).startsWith("table"))return!1}let T=null;for(let B=P.depth;B>0;B-=1)if(P.node(B)?.type?.name==="outlineSection"){T=P.before(B);break}if(typeof T!="number")return!1;let x=N.doc.resolve(T),I=x.parent;if(!I)return!1;let b=x.index();return M==="ArrowUp"&&b<=0||M==="ArrowDown"&&b>=I.childCount-1}catch{return!1}}}}),new y({props:{handleDOMEvents:{cut:(m,v)=>{try{let{state:C}=m,{selection:D}=C;if(!D||D.empty)return!1;let M=(he,oe)=>{for(let ge=oe.depth;ge>0;ge-=1)if(oe.node(ge)?.type?.name==="outlineSection")return oe.before(ge);return null},N=M(C.doc,D.$from),P=M(C.doc,D.$to);if(typeof N!="number"||typeof P!="number")return!1;let T=(he="")=>String(he||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");if(N===P){let he=A(D.$from,"outlineHeading"),oe=A(D.$to,"outlineHeading");if(he!==null&&oe!==null){let ge=C.doc.nodeAt(N);if(!ge)return!1;let Me=ge.child(0),$e=N+1,Je=$e+1,Oe=$e+Me.nodeSize-1;if(D.from>=Je&&D.to<=Oe){let Fe=Math.max(D.from,Je),Xe=Math.min(D.to,Oe),st=C.doc.textBetween(Fe,Xe,`
`,`
`);if(v?.clipboardData)try{v.clipboardData.setData("text/plain",st),v.clipboardData.setData("text/html",`<pre>${T(st)}</pre>`)}catch{}v.preventDefault(),v.stopPropagation();let U=C.tr.delete(Fe,Xe);return U=U.setSelection(p.near(U.doc.resolve(Je),1)),m.dispatch(U.scrollIntoView()),!0}}return!1}if(A(D.$from,"outlineBody")===null||D.$to.parent?.type?.name!=="outlineHeading"||D.$to.parentOffset!==0)return!1;let I=C.doc.nodeAt(N);if(!I)return!1;let b=I.child(0),B=I.child(1),_=N+1+b.nodeSize,H=_+1,R=_+B.nodeSize-1,F=Math.max(D.from,H),V=Math.min(D.to,R);if(V<F)return!0;let j=C.doc.textBetween(F,V,`
`,`
`);if(v?.clipboardData)try{v.clipboardData.setData("text/plain",j),v.clipboardData.setData("text/html",`<pre>${T(j)}</pre>`)}catch{}v.preventDefault(),v.stopPropagation();let X=C.tr.delete(F,V),te=X.doc.nodeAt(_);if(te&&te.content.size===0){let he=X.doc.type.schema;X=X.insert(H,he.nodes.paragraph.create({},[]))}return X=X.setSelection(p.near(X.doc.resolve(H+1),1)),m.dispatch(X.scrollIntoView()),!0}catch{return!1}}}}}),new y({props:{handleKeyDown:(m,v)=>{if(v.key!=="Backspace")return!1;let{state:C}=m,{selection:D}=C;if(!D?.empty)return!1;let{$from:M}=D;if(M.parent?.type?.name!=="paragraph"||M.parentOffset!==0)return!1;let N=null;for(let X=M.depth;X>0;X-=1)if(M.node(X)?.type?.name==="listItem"){N=X;break}if(N===null||M.index(N)!==0)return!1;let P=N-1,T=M.node(P);if(!T)return!1;let x=M.index(P);if(x<=0)return!1;let I=M.before(N),b=T.child(x-1),B=I-b.nodeSize,_=C.doc.nodeAt(I);if(!_||_.type?.name!=="listItem")return!1;v.preventDefault(),v.stopPropagation();let H=b.type.create(b.attrs,b.content.append(_.content),b.marks),R=C.tr.replaceWith(B,B+b.nodeSize,H),F=B+1+b.content.size,V=R.mapping.map(F,1),j=R.mapping.map(I);R=R.delete(j,j+_.nodeSize);try{R=R.setSelection(p.near(R.doc.resolve(V+1),1))}catch{}return m.dispatch(R.scrollIntoView()),!0}}}),new y({props:{handleKeyDown:(m,v)=>(v.key!=="Tab"||v.preventDefault(),!1)}}),new y({props:{handleKeyDown:(m,v)=>{if(!v.ctrlKey||v.shiftKey||v.altKey||v.metaKey||v.key!=="ArrowUp"&&v.key!=="ArrowDown")return!1;let{state:C}=m,{selection:D}=C;if(!D)return!1;let N=(()=>{if((D?.node||null)?.type?.name==="outlineSection")return D.from;let B=D.$from;for(let _=B.depth;_>0;_-=1)if(B.node(_)?.type?.name==="outlineSection")return B.before(_);return null})();if(typeof N!="number")return!1;let P=(b,B)=>{try{let _=b.resolve(Math.min(b.content.size,B+1)),H=null;for(let R=_.depth;R>0;R-=1)if(_.node(R)?.type?.name==="outlineSection"&&_.before(R)===B){H=R;break}if(H===null)return null;for(let R=H-1;R>0;R-=1)if(_.node(R)?.type?.name==="outlineSection")return _.before(R);return null}catch{return null}},T=(b,B)=>{let _=b.nodeAt(B);if(!_||_.type?.name!=="outlineSection")return[];let H=[B];return _.descendants((R,F)=>{R?.type?.name==="outlineSection"&&H.push(B+1+F)}),H};if(v.preventDefault(),v.stopPropagation(),v.key==="ArrowUp"){let b=P(C.doc,N),B=typeof b=="number"?b:N,_=T(C.doc,B);if(!_.length)return!0;let H=C.tr;for(let F of _){let V=H.doc.nodeAt(F);!V||V.type?.name!=="outlineSection"||V.attrs?.collapsed||(H=H.setNodeMarkup(F,void 0,{...V.attrs,collapsed:!0}))}let R=H.doc.nodeAt(B);if(R){let F=R.child(0),j=B+1+F.nodeSize-1;H=H.setSelection(p.near(H.doc.resolve(j),-1))}return m.dispatch(H.scrollIntoView()),!0}let x=T(C.doc,N);if(!x.length)return!0;let I=C.tr;for(let b of x){let B=I.doc.nodeAt(b);!B||B.type?.name!=="outlineSection"||B.attrs?.collapsed&&(I=I.setNodeMarkup(b,void 0,{...B.attrs,collapsed:!1}))}return m.dispatch(I),!0}}}),new y({props:{handleKeyDown:(m,v)=>{if(v.key!=="Enter")return!1;let{state:C}=m,{$from:D}=C.selection;if(!C.selection.empty)return!1;let M=A(D,"outlineBody");if(M===null)return!1;let N=A(D,"paragraph");if(N===null||D.node(N-1)?.type?.name!=="outlineBody")return!1;let P=D.node(N);if(!P||P.content.size!==0||D.parentOffset!==0&&D.parentOffset!==P.content.size)return!1;let T=D.node(M),x=D.index(M);if(x!==T.childCount-1||x<1)return!1;let I=T.child(x-1);if(!I||I.type?.name!=="paragraph"||I.content.size!==0)return!1;let b=A(D,"outlineSection");if(b===null)return!1;let B=D.before(b);v.preventDefault(),v.stopPropagation();let _=C.tr,H=D.start(M),R=H;for(let Me=0;Me<x;Me+=1)R+=T.child(Me).nodeSize;let F=x;for(let Me=x;Me>=0;Me-=1){let $e=T.child(Me);if(!$e||$e.type?.name!=="paragraph"||$e.content.size!==0)break;F=Me}let V=H;for(let Me=0;Me<F;Me+=1)V+=T.child(Me).nodeSize;let j=R+T.child(x).nodeSize;_=_.delete(V,j);let X=_.doc.nodeAt(B);if(!X)return!0;let te=B+X.nodeSize,he=_.doc.type.schema,oe=$t(),ge=he.nodes.outlineSection.create({id:oe,collapsed:!1},[he.nodes.outlineHeading.create({},[]),he.nodes.outlineBody.create({},[he.nodes.paragraph.create({},[])]),he.nodes.outlineChildren.create({},[])]);return _=_.insert(te,ge),_=_.setSelection(p.create(_.doc,te+2)),_=_.setMeta(de,!0),Ae&&(_=_.setMeta(Ae,{type:"enter",sectionId:oe})),m.dispatch(_.scrollIntoView()),!0}}})]}}),ce=d.create({name:"outlineActiveSection",addProseMirrorPlugins(){return[new y({props:{decorations(A){try{let m=wt(A.doc,A.selection.$from);if(typeof m!="number")return null;let v=A.doc.nodeAt(m);return v?L.create(A.doc,[E.node(m,m+v.nodeSize,{"data-active":"true"})]):null}catch{return null}}}})]}}),me=d.create({name:"outlineEditMode",addProseMirrorPlugins(){let A=new k("outlineEditMode");Ae=A;let m=null,v=T=>{let x=wt(T.doc,T.selection.$from);if(typeof x!="number")return null;let I=T.doc.nodeAt(x);return String(I?.attrs?.id||"")||null},C=(T,x,I)=>{if(!x.docChanged)return!0;if(!I)return!1;let b=it(T.doc,I);if(typeof b!="number")return!1;let B=T.doc.nodeAt(b);if(!B)return!1;let _=B.child(0),H=B.child(1),R=b+1,F=R+1,V=R+_.nodeSize-1,j=b+1+_.nodeSize,X=j+1,te=j+H.nodeSize-1,he=(oe,ge)=>{let Me=oe>=F&&ge<=V,$e=oe>=X&&ge<=te;return Me||$e};for(let oe of x.steps){let ge=oe.getMap(),Me=!0;if(ge.forEach(($e,Je)=>{he($e,Je)||(Me=!1)}),!Me)return!1}return!0},D=()=>{try{Ee("\u0414\u043B\u044F \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Enter \u0438\u043B\u0438 \u0434\u0432\u043E\u0439\u043D\u043E\u0439 \u043A\u043B\u0438\u043A \u043C\u044B\u0448\u043A\u043E\u0439. Esc \u0434\u043B\u044F \u0432\u044B\u0445\u043E\u0434\u0430.")}catch{}},M=()=>{try{Ee("\u041D\u0430\u0436\u043C\u0438\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437, \u0447\u0442\u043E\u0431\u044B \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438")}catch{}},N=T=>{try{let{selection:x}=T;if(!x?.empty)return!1;let{$from:I}=x,b=null;for(let V=I.depth;V>0;V-=1)if(I.node(V)?.type?.name==="outlineHeading"){b=V;break}if(b===null||!(I.pos===I.start(b)))return!1;let _=wt(T.doc,I);if(typeof _!="number")return!1;if(T.doc.resolve(_).index()>0)return!0;let F=!1;for(let V=I.depth;V>0;V-=1)if(I.node(V)?.type?.name==="outlineSection"){if(!F){F=!0;continue}return!0}return!1}catch{return!1}},P=(T,x)=>{try{if(!x)return!1;let{selection:I}=T;if(!I?.empty)return!1;let{$from:b}=I,B=wt(T.doc,b);if(typeof B!="number")return!1;let _=T.doc.nodeAt(B);if(!_||String(_.attrs?.id||"")!==String(x))return!1;let H=_.child(0),R=_.child(1),V=B+1+H.nodeSize+R.nodeSize-1;if(b.pos!==V)return!1;let j=T.doc.resolve(B),X=j.index(),te=j.parent;return te?X<te.childCount-1:!1}catch{return!1}};return[new y({key:A,state:{init(){return{editingSectionId:null}},apply(T,x){let I=T.getMeta(A);return I?I.type==="enter"?{editingSectionId:I.sectionId||null}:I.type==="exit"?{editingSectionId:null}:x:x}},filterTransaction(T,x){let b=(A.getState(x)||{}).editingSectionId||null;return T.getMeta(de)||T.getMeta("history$")!=null||T.getMeta("closeHistory$")!=null||!T.docChanged?!0:C(x,T,b)},props:{decorations(T){try{let I=(A.getState(T)||{}).editingSectionId||null;if(!I)return null;let b=it(T.doc,I);if(typeof b!="number")return null;let B=T.doc.nodeAt(b);return B?L.create(T.doc,[E.node(b,b+B.nodeSize,{"data-editing":"true"})]):null}catch{return null}},handleKeyDown(T,x){let I=T.state,B=(A.getState(I)||{}).editingSectionId||null;Ke("keydown",{key:x?.key||null,repeat:!!x?.repeat,editingSectionId:B||null,selection:{empty:!!I?.selection?.empty,parent:I?.selection?.$from?.parent?.type?.name||null,parentOffset:I?.selection?.$from?.parentOffset??null}});let _=v(I);if(!B&&(x.key==="Delete"||x.key==="Del"||x.key==="Backspace")&&(x.ctrlKey||x.metaKey)&&!x.shiftKey&&!x.altKey){try{deleteActiveSection()}catch{}return x.preventDefault(),x.stopPropagation(),!0}if(B&&x.key==="Backspace"&&!x.ctrlKey&&!x.metaKey&&!x.altKey){let R=Ap(I,T.dispatch,B,p);if(Ke("editorProps.backspace.bodyToHeading",{promoted:R,editingSectionId:B}),R)return x.preventDefault(),x.stopPropagation(),!0;let F=xp(I,T.dispatch);if(Ke("editorProps.backspace.tableMerge",{merged:F,editingSectionId:B||null}),F)return x.preventDefault(),x.stopPropagation(),!0}try{let R=(x.key==="Enter"||x.code==="Enter"||x.code==="NumpadEnter")&&(x.ctrlKey||x.metaKey)&&!x.shiftKey&&!x.altKey;if(!u.isPublicView&&!B&&R){let F=I.selection,V=F?.$from||null;if(V){let j=wt(I.doc,V),X=typeof j=="number"?I.doc.nodeAt(j):null;if(typeof j=="number"&&X&&X.type?.name==="outlineSection"){let te=!!(F&&F.empty),he=V.parent?.type?.name==="outlineHeading",ge=te&&he&&V.parentOffset===0?j:j+X.nodeSize;x.preventDefault(),x.stopPropagation();let Me=I.schema,$e=$t(),Je=Me.nodes.outlineSection.create({id:$e,collapsed:!1},[Me.nodes.outlineHeading.create({},[]),Me.nodes.outlineBody.create({},[Me.nodes.paragraph.create({},[])]),Me.nodes.outlineChildren.create({},[])]),Oe=I.tr.insert(ge,Je);try{let Xe=Oe.doc.nodeAt(ge)?.child?.(0)||Je.child(0),st=ge+1+Xe.nodeSize;Oe=Oe.setSelection(p.near(Oe.doc.resolve(st+2),1))}catch{Oe=Oe.setSelection(p.create(Oe.doc,ge+2))}Oe=Oe.setMeta(de,!0),Oe=Oe.setMeta(A,{type:"enter",sectionId:$e}),T.dispatch(Oe.scrollIntoView());try{T.focus()}catch{}return!0}}}}catch{}if((!m||m.sectionId!==_||m.key!==x.key)&&(m=null),u.isPublicView&&!B&&(x.key==="Enter"&&!x.shiftKey&&!x.ctrlKey&&!x.metaKey&&!x.altKey||x.key==="F2"&&!x.shiftKey&&!x.ctrlKey&&!x.metaKey&&!x.altKey))return x.preventDefault(),x.stopPropagation(),!0;if(!B&&(x.key==="Enter"&&!x.shiftKey&&!x.ctrlKey&&!x.metaKey&&!x.altKey||x.key==="F2"&&!x.shiftKey&&!x.ctrlKey&&!x.metaKey&&!x.altKey)){let R=v(I);return R?(x.preventDefault(),x.stopPropagation(),T.dispatch(I.tr.setMeta(A,{type:"enter",sectionId:R})),!0):!1}if(B&&x.key==="Escape")return x.preventDefault(),x.stopPropagation(),T.dispatch(I.tr.setMeta(A,{type:"exit"})),!0;if(!B){let R=x.key&&x.key.length===1&&!x.metaKey&&!x.ctrlKey&&!x.altKey;if(x.key==="Backspace"||x.key==="Delete"){if(x.key==="Backspace"&&N(I))try{let{selection:V}=I,{$from:j}=V,X=findSectionPos(I.doc,j);if(typeof X!="number")return!1;let te=I.doc.nodeAt(X);if(!te)return!1;let he=String(te.attrs?.id||""),oe=null;try{let Me=I.doc.resolve(X),$e=Me.index(),Je=Me.parent;if(Je&&$e>0){let Oe=Je.child($e-1),Fe=X-Oe.nodeSize,Xe=I.doc.nodeAt(Fe);oe=String(Xe?.attrs?.id||"")||null}else for(let Oe=j.depth-1;Oe>0;Oe-=1){let Fe=j.node(Oe);if(Fe?.type?.name==="outlineSection"){let Xe=String(Fe.attrs?.id||"");if(Xe&&Xe!==he){oe=Xe;break}}}}catch{oe=null}let ge=!1;if(dt(te))ge=rt(I,T.dispatch,X);else try{I.doc.resolve(X).index()<=0?ge=Kt(I,T.dispatch,X):ge=ht(I,T.dispatch,X)}catch{ge=ht(I,T.dispatch,X)}return ge&&oe&&window.setTimeout(()=>{try{if((A.getState(T.state)||{}).editingSectionId)return;let $e=it(T.state.doc,oe),Je=typeof $e=="number"?T.state.doc.nodeAt($e):null;if(!Je)return;let Oe=T.state.tr;Je?.attrs?.collapsed&&(Oe=Oe.setNodeMarkup($e,void 0,{...Je.attrs,collapsed:!1}),Oe=Oe.setMeta(de,!0)),Oe=Oe.setMeta(A,{type:"enter",sectionId:oe});try{let Fe=Oe.doc.nodeAt($e);if(Fe&&Fe.type?.name==="outlineSection"){let Xe=Fe.child(0),st=Fe.child(1),ne=$e+1+Xe.nodeSize+st.nodeSize-1;Oe=Oe.setSelection(p.near(Oe.doc.resolve(ne),-1))}}catch{}T.dispatch(Oe.scrollIntoView());try{T.focus()}catch{}}catch{}},0),x.preventDefault(),x.stopPropagation(),!0}catch{}return x.preventDefault(),x.stopPropagation(),!0}if(R)return x.preventDefault(),x.stopPropagation(),D(),!0}let H=x.key==="Backspace"&&N(I)||x.key==="Delete"&&P(I,B);if(B&&(x.key==="Backspace"||x.key==="Delete")&&H){if(x.repeat)return x.preventDefault(),x.stopPropagation(),!0;let R=Date.now();return m&&m.sectionId===B&&m.key===x.key&&R-m.ts<1200?(m=null,!1):(m={sectionId:B,key:x.key,ts:R},x.preventDefault(),x.stopPropagation(),M(),!0)}return!1},handleTextInput(){let T=arguments[0],x=T?.state?A.getState(T.state):null;return x&&x.editingSectionId?!1:(D(),!0)},handleDOMEvents:{paste(T,x){let I=T.state;return(A.getState(I)||{}).editingSectionId?!1:(x.preventDefault(),x.stopPropagation(),D(),!0)},drop(T,x){let I=T.state;return(A.getState(I)||{}).editingSectionId?!1:(x.preventDefault(),x.stopPropagation(),D(),!0)}}}})]}}),le=A=>{let m=(A||"").trim();if(!m)return[];let v=S(m,[w.configure({heading:!1,link:!1}),O.configure({openOnClick:!1,protocols:li}),Z,q.configure({table:{resizable:!0}})]),C=Array.isArray(v?.content)?v.content:[],D=[];for(let M=0;M<C.length;M+=1){let N=C[M];if(N?.type!=="paragraph"){D.push(N);continue}let T=Hl(N).trim();if(!an(T)){D.push(N);continue}let I=[],b=M,B=M;for(;B<C.length;B+=1){let R=C[B];if(R?.type!=="paragraph")break;let F=Hl(R).trim();if(!F)break;I.push(F)}let _=gr(I);if(!_){D.push(N);continue}let H=kp(_);if(!H){D.push(N);continue}D.push(H),M=B-1,M<b&&(M=b)}return D};Ao=le;let fe=d.create({name:"outlineMarkdown",addCommands(){return{insertMarkdown:A=>({editor:m})=>{if(!Ae)return!1;if(!(Ae.getState(m.state)||{}).editingSectionId)return $r(),!1;if(!m?.storage?.markdown?.parser)return Ee("Markdown \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F"),!1;let C=m.storage.markdown.parser.parse(String(A||""),{inline:!0}),D=le(C);return D.length?m.chain().focus().insertContent(D).run():!1}}}}),xe=d.create({name:"outlineFormattedPaste",addProseMirrorPlugins(){let A=this.editor,m=P=>{let T=String(P||"").trim();if(!T)return"";let x=null;try{x=new DOMParser().parseFromString(T,"text/html")}catch{return T}let I=x?.body;if(!I)return T;try{for(let b of Array.from(I.querySelectorAll("ms-cmark-node"))){let B=b.parentNode;if(B){for(;b.firstChild;)B.insertBefore(b.firstChild,b);B.removeChild(b)}}}catch{}try{for(let b of Array.from(I.querySelectorAll("h1,h2,h3,h4,h5,h6"))){let B=x.createElement("p"),_=x.createElement("strong");try{for(;b.firstChild;)_.appendChild(b.firstChild)}catch{_.textContent=String(b.textContent||"")}B.appendChild(_),b.replaceWith(B)}}catch{}return String(I.innerHTML||"").replace(/<!--\s*StartFragment\s*-->/gi,"").replace(/<!--\s*EndFragment\s*-->/gi,"").trim()},v=P=>{let T=String(P||"").trim();if(!T||!T.includes("<")||!T.includes(">")||!/<\s*\/?\s*[a-z][^>]*>/i.test(T))return!1;try{let I=new DOMParser().parseFromString(T,"text/html")?.body;if(!I)return!1;let b=new Set(["p","br","strong","b","em","i","u","s","a","ul","ol","li","blockquote","pre","code","table","thead","tbody","tr","td","th","img","span","div","h1","h2","h3","h4","h5","h6"]);return!!Array.from(I.querySelectorAll("*")).find(_=>b.has(String(_.tagName||"").toLowerCase()))}catch{return!1}},C=P=>{let T=String(P||"").replace(/\r\n/g,`
`).trim();return T?[/```[\s\S]*```/m,/^\s{0,3}([-*+]|\d+\.)\s+\S/m,/^\s{0,3}>\s+\S/m,/\[[^\]]+\]\([^)]+\)/,/!\[[^\]]*\]\([^)]+\)/,/\*\*[^*\n]+\*\*/,/__[^_\n]+__/,/`[^`\n]+`/].some(I=>I.test(T)):!1},D=P=>{try{let T=String(P||"").replace(/\r\n/g,`
`).split(`
`).map(x=>String(x||"").trim()).filter(Boolean);return T.length<2?!1:!!gr(T)}catch{return!1}},M=(P,T)=>{if(!T||!Array.isArray(T)||!T.length)return!1;let x=P?.state?.selection?.from,I=P?.state?.selection?.to;if(!Number.isFinite(x)||!Number.isFinite(I))return!1;try{return A.chain().focus().command(({tr:b})=>(b.setMeta(de,!0),!0)).insertContentAt({from:x,to:I},T).run()}catch{return!1}},N=(P,T)=>{try{if(!(Ae?.getState?.(P.state)||null)?.editingSectionId)return!1;let I=T?.clipboardData?.items||null,b=T?.clipboardData?.files||null;if(b&&b.length||I&&Array.from(I).some(H=>H?.kind==="file"))return!1;let B=String(T?.clipboardData?.getData?.("text/html")||"").trim(),_=String(T?.clipboardData?.getData?.("text/plain")||"").trim();if(B)try{let H=String(B).match(/<h[1-6][\s>]/gi);if((Array.isArray(H)?H.length:0)>=2)return!1}catch{}if(B){let H=m(B),R=le(H);return R.length?(T.preventDefault(),T.stopPropagation(),M(P,R)):!1}if(_&&v(_)){let H=m(_),R=le(H);return R.length?(T.preventDefault(),T.stopPropagation(),M(P,R)):!1}if(_&&C(_)){if(D(_))return!1;try{let X=Os(_);if(X?.startsWithHeading||(X?.sections?.length||0)>=2)return!1}catch{}let H=A?.storage?.markdown?.parser||null;if(!H?.parse)return!1;let R=!_.includes(`
`)&&!/^\s{0,3}([-*+]|\d+\.)\s+\S/m.test(_)&&!/```[\s\S]*```/m.test(_)&&!/^\s{0,3}>\s+\S/m.test(_),F=String(H.parse(_,{inline:R})).trim();if(!F)return!1;let V=m(F),j=le(V);return j.length?(T.preventDefault(),T.stopPropagation(),M(P,j)):!1}return!1}catch{return!1}};return[new y({props:{handlePaste(P,T){return N(P,T)},handleDOMEvents:{paste(P,T){return N(P,T)}}}})]}}),Ie=!1,ae=null,ve=pr()?performance.now():0,He=u.article?.docJson||null;if(He&&typeof He=="object"&&He.type==="doc"&&Array.isArray(He.content)&&(ae=He),ae||(ae=Jp({blocks:u.article?.blocks||[],parseHtmlToNodes:le}),Ie=!!(u.article&&!u.article?.docJson&&!u.article?.encrypted)),ve&&Hr("build initial content",{ms:Math.round(performance.now()-ve)}),se){try{se.destroy()}catch{}se=null}let Ve=Q?Q.configure({html:!0,tightLists:!0,transformPastedText:!1,transformCopiedText:!1}):null,Ge=d.create({name:"outlineTableCellStyling",addOptions(){return{types:["tableCell","tableHeader"],textAlignValues:["left","center","right","justify"],verticalAlignValues:["top","middle","bottom"]}},addGlobalAttributes(){let A=(v,C)=>{try{let D=v?.style?.[C];return D?String(D).trim():""}catch{return""}},m=v=>{let C=[],D=v?.nodeTextAlign?String(v.nodeTextAlign):"",M=v?.nodeVerticalAlign?String(v.nodeVerticalAlign):"",N=v?.nodeTextColor?String(v.nodeTextColor):"",P=v?.nodeBackground?String(v.nodeBackground):"";return D&&this.options.textAlignValues.includes(D)&&C.push(`text-align: ${D}`),M&&this.options.verticalAlignValues.includes(M)&&C.push(`vertical-align: ${M}`),N&&C.push(`color: ${N}`),P&&C.push(`background-color: ${P}`),C.length?{style:C.join("; ")}:{}};return[{types:this.options.types,attributes:{nodeTextAlign:{default:null,parseHTML:v=>{let C=A(v,"textAlign");return C&&this.options.textAlignValues.includes(C)?C:null},renderHTML:v=>m(v)},nodeVerticalAlign:{default:null,parseHTML:v=>{let C=A(v,"verticalAlign");return C&&this.options.verticalAlignValues.includes(C)?C:null},renderHTML:v=>m(v)},nodeTextColor:{default:null,parseHTML:v=>{let C=A(v,"color");return C?String(C).replace(/['"]+/g,""):null},renderHTML:v=>m(v)},nodeBackground:{default:null,parseHTML:v=>{let C=A(v,"backgroundColor");return C?String(C).replace(/['"]+/g,""):null},renderHTML:v=>m(v)}}}]},addCommands(){let A=(v,C)=>({state:D,dispatch:M})=>{try{let N=Ks(D);if(!N.length)return!1;let P=D.tr,T=!1;for(let{node:x,pos:I}of N){if(!x||typeof I!="number")continue;let b={...x.attrs||{}};C==null||C===""?delete b[v]:b[v]=C,P=P.setNodeMarkup(I,void 0,b),T=!0}return T?(P=P.setMeta(de,!0),M(P),!0):!1}catch{return!1}},m=()=>({state:v,dispatch:C})=>{try{let D=Ks(v);if(!D.length)return!1;let M=v.schema.nodes?.paragraph||null;if(!M)return!1;let N=v.tr,P=[...D].sort((x,I)=>Number(I.pos)-Number(x.pos)),T=!1;for(let{node:x,pos:I}of P){if(!x||typeof I!="number")continue;let b=I+1,B=I+x.nodeSize-1;if(!(B>=b))continue;let _=M.createAndFill();_&&(N=N.replaceWith(b,B,_),T=!0)}return T?(N=N.setMeta(de,!0),C(N.scrollIntoView()),!0):!1}catch{return!1}};return{setNodeTextAlign:v=>A("nodeTextAlign",v),setNodeVAlign:v=>A("nodeVerticalAlign",v),setNodeTextColor:v=>A("nodeTextColor",v),setNodeBackground:v=>A("nodeBackground",v),unsetNodeAlignment:()=>({state:v,dispatch:C})=>{try{let D=Ks(v);if(!D.length)return!1;let M=v.tr,N=!1;for(let{node:P,pos:T}of D){if(!P||typeof T!="number")continue;let x=P.attrs?.nodeTextAlign||null,I=P.attrs?.nodeVerticalAlign||null;if(!x&&!I)continue;let b={...P.attrs||{}};delete b.nodeTextAlign,delete b.nodeVerticalAlign,M=M.setNodeMarkup(T,void 0,b),N=!0}return N?(M=M.setMeta(de,!0),C(M),!0):!1}catch{return!1}},clearNodeContents:()=>m()}}}),Qe=d.create({name:"outlineTablePercentWidths",addProseMirrorPlugins(){return[new y({view(A){let m=null,v=M=>{let N=String(M||"").trim();if(!N)return 0;let P=N.match(/(-?\\d+(?:\\.\\d+)?)px/i);return P&&Number(P[1])||0},C=()=>{m=null;try{let M=A?.dom;if(!M)return;let N=M.querySelectorAll(".tableWrapper > table");for(let P of N){let T=P.querySelector("colgroup");if(!T)continue;let x=Array.from(T.querySelectorAll("col"));if(!x.length||fr)continue;try{P.style.width="100%",P.style.maxWidth="100%",P.style.tableLayout="fixed"}catch{}let I=!1;for(let b of x){let B=b?.dataset?.ttPct||"",_=Number.parseFloat(String(B||""));if(Number.isFinite(_)&&_>0)I=!0,b.style.width=`${_.toFixed(4)}%`,b.style.minWidth="";else{let H=ld(b.style.width);H!=null&&H>0&&(I=!0,b.dataset.ttPct=H.toFixed(4),b.style.width=`${H.toFixed(4)}%`,b.style.minWidth="")}}if(!I)try{let b=P.querySelector("tbody tr");if(!b)continue;let B=Array.from(b.children||[]).filter(V=>V&&V.nodeType===1);if(B.length<x.length)continue;let _=[];for(let V=0;V<x.length;V+=1){let j=B[V].getBoundingClientRect();_.push(Number.isFinite(j.width)?j.width:0)}let H=_.reduce((V,j)=>V+(Number.isFinite(j)?j:0),0);if(!(H>0))continue;let R=_.map(V=>Tn(V/H*100)),F=R.reduce((V,j)=>V+j,0);Math.abs(F-100)>.01&&(R[R.length-1]=Tn(R[R.length-1]+(100-F)));for(let V=0;V<x.length;V+=1)Ii(x[V],R[V])}catch{}}}catch{}},D=()=>{m==null&&(m=window.requestAnimationFrame(C))};return D(),{update(){D()},destroy(){m!=null&&(window.cancelAnimationFrame(m),m=null)}}}})]}}),Ze=d.create({name:"outlineTableSmartMouseSelection",addProseMirrorPlugins(){let A=mt?.CellSelection||null;return A?[new y({view(m){let v=D=>{try{for(let M=D.depth;M>=0;M-=1){let N=D.node(M)?.type?.name;if(N==="tableCell"||N==="tableHeader")return D.before(M)}}catch{}return null},C=()=>{try{if(!(Ae?.getState?.(m.state)||null)?.editingSectionId)return;let M=m.state.selection;if(!M||M.empty)return;let N=v(M.$anchor),P=v(M.$head);if(N==null||P==null||N===P)return;let T=typeof A.create=="function"?A.create(m.state.doc,N,P):null;if(!T)return;let x=m.state.tr.setSelection(T);x=x.setMeta(de,!0),m.dispatch(x)}catch{}};return m.dom.addEventListener("mouseup",C,!0),{destroy(){m.dom.removeEventListener("mouseup",C,!0)}}}})]:[]}}),qe=d.create({name:"outlineTableResizeCapture",addProseMirrorPlugins(){return[new y({view(A){let m=C=>{try{if(!C?.target?.closest?.(".column-resize-handle")||!(Ae?.getState?.(A.state)||null)?.editingSectionId)return;fr=!0}catch{}},v=()=>{if(fr){fr=!1;try{let C=A.domAtPos(A.state.selection.from),M=((C?.node&&C.node.nodeType===1?C.node:C?.node?.parentElement)||null)?.closest?.("table")||null;M&&yi(M)}catch{}}};return A.dom.addEventListener("pointerdown",m,!0),document.addEventListener("pointerup",v,!0),document.addEventListener("pointercancel",v,!0),{destroy(){A.dom.removeEventListener("pointerdown",m,!0),document.removeEventListener("pointerup",v,!0),document.removeEventListener("pointercancel",v,!0)}}}})]}}),nt=d.create({name:"outlineTableNodeUi",addProseMirrorPlugins(){let A=this.editor,m=[{label:"Default text",value:null},{label:"Gray text",value:"var(--tt-color-text-gray)"},{label:"Brown text",value:"var(--tt-color-text-brown)"},{label:"Orange text",value:"var(--tt-color-text-orange)"},{label:"Yellow text",value:"var(--tt-color-text-yellow)"},{label:"Green text",value:"var(--tt-color-text-green)"},{label:"Blue text",value:"var(--tt-color-text-blue)"},{label:"Purple text",value:"var(--tt-color-text-purple)"},{label:"Pink text",value:"var(--tt-color-text-pink)"},{label:"Red text",value:"var(--tt-color-text-red)"}],v=[{label:"Default background",value:null},{label:"Gray background",value:"var(--tt-color-highlight-gray)"},{label:"Brown background",value:"var(--tt-color-highlight-brown)"},{label:"Orange background",value:"var(--tt-color-highlight-orange)"},{label:"Yellow background",value:"var(--tt-color-highlight-yellow)"},{label:"Green background",value:"var(--tt-color-highlight-green)"},{label:"Blue background",value:"var(--tt-color-highlight-blue)"},{label:"Purple background",value:"var(--tt-color-highlight-purple)"},{label:"Pink background",value:"var(--tt-color-highlight-pink)"},{label:"Red background",value:"var(--tt-color-highlight-red)"}],C=[{label:"Align left",value:"left"},{label:"Align center",value:"center"},{label:"Align right",value:"right"},{label:"Justify",value:"justify"}],D=[{label:"Align top",value:"top"},{label:"Align middle",value:"middle"},{label:"Align bottom",value:"bottom"}],M=x=>{try{if(!x)return null;let I={left:Number(x.left),top:Number(x.top),right:Number(x.right),bottom:Number(x.bottom),width:Number(x.width),height:Number(x.height)};return!Number.isFinite(I.left)||!Number.isFinite(I.top)?null:I}catch{return null}},N=(x,I,b,B,_=8)=>{try{let H=window.innerWidth||0,R=window.innerHeight||0,F=Math.max(_,Math.min(x,Math.max(_,H-b-_))),V=Math.max(_,Math.min(I,Math.max(_,R-B-_)));return{left:F,top:V}}catch{return{left:x,top:I}}};class P{constructor(){this.panels=[],this.onDocPointerDown=I=>{try{let b=I?.target||null,B=typeof I?.composedPath=="function"?I.composedPath():null,_=Array.isArray(B)&&B.length?B:b?[b]:[];if(!_.length)return;for(let H of _)for(let R of this.panels)if(R&&(H===R||R.contains(H)))return;this.closeAll()}catch{this.closeAll()}},this.onKeyDown=I=>{I?.key==="Escape"&&this.closeAll()}}isOpen(){return this.panels.length>0}closeAll(){try{for(let I of this.panels)I?.remove?.()}catch{}this.panels=[];try{document.removeEventListener("pointerdown",this.onDocPointerDown,!1),window.removeEventListener("keydown",this.onKeyDown,!1)}catch{}}openPanel({anchorRect:I,items:b,level:B=0}){let _=M(I);if(!_)return;for(;this.panels.length>B;){let X=this.panels.pop();try{X?.remove?.()}catch{}}let H=document.createElement("div");H.className="tt-table-menu",H.setAttribute("role","menu"),H.setAttribute("data-level",String(B)),H.addEventListener("pointerdown",X=>{X.stopPropagation()}),H.addEventListener("mousedown",X=>{X.stopPropagation()});for(let X of b){if(X.type==="separator"){let he=document.createElement("div");he.className="tt-table-menu-sep",H.appendChild(he);continue}let te=document.createElement("button");if(te.type="button",te.className="tt-table-menu-item",te.textContent=X.label,te.disabled=!!X.disabled,X.swatch){te.classList.add("has-swatch");try{let he=X.swatchValue==null?"transparent":String(X.swatchValue);te.style.setProperty("--tt-swatch",he)}catch{}}X.submenu&&te.classList.add("has-submenu"),te.addEventListener("click",he=>{if(he.preventDefault(),he.stopPropagation(),!X.disabled){if(X.submenu){let oe=te.getBoundingClientRect();this.openPanel({anchorRect:oe,items:X.submenu(),level:B+1});return}try{X.onClick?.()}finally{this.closeAll()}}}),H.appendChild(te)}document.body.appendChild(H);let R=H.getBoundingClientRect(),F=_.right+8,V=_.top,j=N(F,V,R.width,R.height);H.style.left=`${j.left}px`,H.style.top=`${j.top}px`,this.panels.push(H);try{this.panels.length===1&&(document.addEventListener("pointerdown",this.onDocPointerDown,!1),window.addEventListener("keydown",this.onKeyDown,!1))}catch{}}}class T{constructor(I){this.view=I,this.menu=new P,this.wrapper=null,this.table=null,this.observedTable=null,this.resizeObserver=null,this.layoutRaf=null,this.resizeRaf=null,this.destroyed=!1,this.root=document.createElement("div"),this.root.className="tt-table-ui",this.root.style.display="none",this.cellOutline=document.createElement("div"),this.cellOutline.className="tt-table-active-cell-outline",this.cellOutline.style.display="none",this.root.appendChild(this.cellOutline),this.scheduleLayout=()=>{this.layoutRaf==null&&(this.layoutRaf=window.requestAnimationFrame(()=>{this.layoutRaf=null,!this.destroyed&&this.update(this.view)}))},this.scheduleResizeLoop=()=>{this.resizeRaf==null&&(this.resizeRaf=window.requestAnimationFrame(()=>{this.resizeRaf=null,!this.destroyed&&fr&&this.update(this.view)}))},this.onWrapperScroll=()=>this.scheduleLayout(),this.onWindowResize=()=>this.scheduleLayout();try{window.addEventListener("resize",this.onWindowResize,{passive:!0})}catch{}this.rowHandles=[],this.colHandles=[],this.dragState=null,this.suppressClickUntil=0,this.colDropIndicator=document.createElement("div"),this.colDropIndicator.className="tt-table-drop-indicator tt-table-drop-indicator-col",this.colDropIndicator.style.display="none",this.root.appendChild(this.colDropIndicator),this.rowDropIndicator=document.createElement("div"),this.rowDropIndicator.className="tt-table-drop-indicator tt-table-drop-indicator-row",this.rowDropIndicator.style.display="none",this.root.appendChild(this.rowDropIndicator),this.cellHandle=document.createElement("button"),this.cellHandle.type="button",this.cellHandle.className="tt-table-handle tt-table-cell-handle",this.cellHandle.setAttribute("aria-label","Cell actions"),this.cellHandle.addEventListener("click",b=>{b.preventDefault(),b.stopPropagation();let B=this.cellHandle.getBoundingClientRect();this.openCellMenu(B)}),this.root.appendChild(this.cellHandle)}hideDropIndicators(){try{this.colDropIndicator&&(this.colDropIndicator.style.display="none")}catch{}try{this.rowDropIndicator&&(this.rowDropIndicator.style.display="none")}catch{}}cancelDrag(){let I=this.dragState;if(I){this.dragState=null,this.hideDropIndicators();try{window.removeEventListener("pointermove",I.onMove),window.removeEventListener("pointerup",I.onUp),window.removeEventListener("pointercancel",I.onUp)}catch{}try{document.body.classList.remove("tt-table-dragging")}catch{}}}destroy(){this.destroyed=!0,this.cancelDrag();try{this.cellOutline.style.display="none"}catch{}this.menu.closeAll();try{this.layoutRaf!=null&&window.cancelAnimationFrame(this.layoutRaf)}catch{}this.layoutRaf=null;try{this.resizeRaf!=null&&window.cancelAnimationFrame(this.resizeRaf)}catch{}this.resizeRaf=null;try{window.removeEventListener("resize",this.onWindowResize)}catch{}try{this.wrapper?.removeEventListener?.("scroll",this.onWrapperScroll)}catch{}try{this.resizeObserver?.disconnect?.()}catch{}this.resizeObserver=null,this.observedTable=null;try{this.root.remove()}catch{}this.wrapper=null,this.table=null}ensureAttached(I){if(I&&this.wrapper!==I){try{this.wrapper?.removeEventListener?.("scroll",this.onWrapperScroll)}catch{}try{this.root.remove()}catch{}this.wrapper=I;try{this.wrapper.addEventListener("scroll",this.onWrapperScroll,{passive:!0})}catch{}this.wrapper.appendChild(this.root)}}buildRowHandles(I){for(;this.rowHandles.length>I;){let b=this.rowHandles.pop();try{b?.remove?.()}catch{}}for(;this.rowHandles.length<I;){let b=document.createElement("button");b.type="button",b.className="tt-table-handle tt-table-row-handle",b.setAttribute("aria-label","Row actions"),b.dataset.idx=String(this.rowHandles.length),b.addEventListener("pointerdown",B=>this.onHandlePointerDown(B,b,"row")),b.addEventListener("click",B=>{if(Date.now()<this.suppressClickUntil){B.preventDefault(),B.stopPropagation();return}B.preventDefault(),B.stopPropagation();let _=Mt(this.view?.state)?.tablePos,H=b.getBoundingClientRect();A?.chain?.().focus?.().run?.();let R=Number(b.dataset.idx||0);Cp(A,R),this.openRowMenu(H,R,_)}),this.rowHandles.push(b),this.root.appendChild(b)}}buildColHandles(I){for(;this.colHandles.length>I;){let b=this.colHandles.pop();try{b?.remove?.()}catch{}}for(;this.colHandles.length<I;){let b=document.createElement("button");b.type="button",b.className="tt-table-handle tt-table-col-handle",b.setAttribute("aria-label","Column actions"),b.dataset.idx=String(this.colHandles.length),b.addEventListener("pointerdown",B=>this.onHandlePointerDown(B,b,"col")),b.addEventListener("click",B=>{if(Date.now()<this.suppressClickUntil){B.preventDefault(),B.stopPropagation();return}B.preventDefault(),B.stopPropagation();let _=Mt(this.view?.state)?.tablePos,H=b.getBoundingClientRect();A?.chain?.().focus?.().run?.();let R=Number(b.dataset.idx||0);Bp(A,R),this.openColumnMenu(H,R,_)}),this.colHandles.push(b),this.root.appendChild(b)}}onHandlePointerDown(I,b,B){try{if(!I||I.button!==0)return;I.preventDefault(),I.stopPropagation(),A?.chain?.().focus?.().run?.();let _=Number(b?.dataset?.idx||0);try{typeof b.setPointerCapture=="function"&&b.setPointerCapture(I.pointerId)}catch{}let H={kind:B,btn:b,pointerId:I.pointerId,fromIndex:_,startX:I.clientX,startY:I.clientY,moved:!1};this.dragState=H;let R=V=>this.onHandlePointerMove(V),F=V=>this.onHandlePointerUp(V);H.onMove=R,H.onUp=F,window.addEventListener("pointermove",R,{passive:!1}),window.addEventListener("pointerup",F,{passive:!1}),window.addEventListener("pointercancel",F,{passive:!1})}catch{}}onHandlePointerMove(I){let b=this.dragState;if(!b||!I||I.pointerId!==b.pointerId)return;try{I.preventDefault()}catch{}let B=I.clientX-b.startX,_=I.clientY-b.startY;if(!b.moved&&Math.hypot(B,_)>=4){b.moved=!0;try{document.body.classList.add("tt-table-dragging")}catch{}}if(b.moved){let H=this.getDropIndexFromPointer(b.kind,I.clientX,I.clientY);b.dropIndex=H,H==null?this.hideDropIndicators():this.updateDropIndicator(b.kind,H,I.clientX,I.clientY)}}getDropIndexFromPointer(I,b,B){try{let _=this.table;if(!_)return null;let H=Array.from(_.querySelectorAll("tbody tr"));if(!H.length)return null;if(I==="col"){let F=Array.from(H[0].children||[]).filter(j=>j&&j.nodeType===1);if(!F.length)return null;let V=F.map(j=>{let X=j.getBoundingClientRect();return X.left+X.width/2});if(!V.length)return null;if(b<V[0])return 0;for(let j=0;j<V.length-1;j+=1)if(b>=V[j]&&b<V[j+1])return j+1;return V.length-1}let R=H.map(F=>{let V=F.children&&F.children[0];if(!V)return null;let j=V.getBoundingClientRect();return j.top+j.height/2}).filter(F=>typeof F=="number");if(!R.length)return null;if(B<R[0])return 0;for(let F=0;F<R.length-1;F+=1)if(B>=R[F]&&B<R[F+1])return F+1;return R.length-1}catch{return null}}updateDropIndicator(I,b,B,_){try{let H=this.table,R=this.wrapper;if(!H||!R)return;let F=R.getBoundingClientRect(),V=H.getBoundingClientRect(),j=V.top-F.top,X=V.left-F.left,te=V.width,he=V.height,oe=Array.from(H.querySelectorAll("tbody tr"));if(!oe.length)return;if(I==="col"){let st=Array.from(oe[0].children||[]).filter(ee=>ee&&ee.nodeType===1);if(!st.length)return;let U=Math.max(0,Math.min(st.length-1,Number(b))),ne=st[U].getBoundingClientRect(),K=st[st.length-1].getBoundingClientRect(),Y=K.left+K.width/2,ie=U===st.length-1&&B>Y?K.right-F.left:ne.left-F.left;this.colDropIndicator.style.display="",this.rowDropIndicator.style.display="none",this.colDropIndicator.style.left=`${Math.round(ie)}px`,this.colDropIndicator.style.top=`${Math.round(j)}px`,this.colDropIndicator.style.height=`${Math.max(0,Math.round(he))}px`;return}let ge=Math.max(0,Math.min(oe.length-1,Number(b))),Me=oe[ge]?.children?.[0];if(!Me)return;let $e=Me.getBoundingClientRect(),Oe=(oe[oe.length-1]?.children?.[0]||null)?.getBoundingClientRect?.()||null,Fe=Oe?Oe.top+Oe.height/2:null,Xe=ge===oe.length-1&&Oe&&typeof Fe=="number"&&_>Fe?Oe.bottom-F.top:$e.top-F.top;this.rowDropIndicator.style.display="",this.colDropIndicator.style.display="none",this.rowDropIndicator.style.left=`${Math.round(X)}px`,this.rowDropIndicator.style.top=`${Math.round(Xe)}px`,this.rowDropIndicator.style.width=`${Math.max(0,Math.round(te))}px`}catch{}}onHandlePointerUp(I){let b=this.dragState;if(!b||!I||I.pointerId!==b.pointerId)return;try{I.preventDefault(),I.stopPropagation()}catch{}this.dragState=null;try{window.removeEventListener("pointermove",b.onMove),window.removeEventListener("pointerup",b.onUp),window.removeEventListener("pointercancel",b.onUp)}catch{}try{document.body.classList.remove("tt-table-dragging")}catch{}if(this.hideDropIndicators(),!b.moved)return;this.suppressClickUntil=Date.now()+250;let B=b.dropIndex??this.getDropIndexFromPointer(b.kind,I.clientX,I.clientY);if(B!=null){try{A?.chain?.().focus?.().run?.()}catch{}b.kind==="col"?pd(A,b.fromIndex,B):md(A,b.fromIndex,B),this.scheduleLayout()}}isEnabled(){try{return!!(Ae?.getState?.(this.view.state)||null)?.editingSectionId&&!u.isPublicView}catch{return!1}}update(I){if(this.view=I,!fr&&this.resizeRaf!=null){try{window.cancelAnimationFrame(this.resizeRaf)}catch{}this.resizeRaf=null}if(!this.isEnabled()){this.root.style.display="none",this.menu.closeAll();try{this.cellOutline.style.display="none"}catch{}return}let b=Mt(I.state),B=Ep(I),_=B?.closest?.("table")||qt(I),H=_?.closest?.(".tableWrapper")||null;if(!b||!_||!H||!B){this.root.style.display="none",this.menu.isOpen()||this.menu.closeAll();try{this.cellOutline.style.display="none"}catch{}return}this.ensureAttached(H),this.table=_;try{typeof ResizeObserver=="function"&&(this.resizeObserver||(this.resizeObserver=new ResizeObserver(()=>this.scheduleLayout())),this.observedTable!==_&&(this.resizeObserver.disconnect(),this.resizeObserver.observe(_),this.observedTable=_))}catch{}this.root.style.display="";let R=Array.from(_.querySelectorAll("tbody tr")),F=Number(b.map?.height||R.length||0),V=Number(b.map?.width||0);this.buildRowHandles(Math.max(0,F)),this.buildColHandles(Math.max(0,V));let j=H.getBoundingClientRect(),X=_.getBoundingClientRect(),te=X.top-j.top,he=X.left-j.left,oe=14,ge=4,Me=oe/2,$e=Math.max(0,Math.min(Math.max(0,F-1),Number(b.rowIndex||0))),Je=Math.max(0,Math.min(Math.max(0,V-1),Number(b.colIndex||0))),Oe=Math.max(Me,te-(oe/2+ge)),Fe=Math.max(Me,he-(oe/2+ge)),Xe=B.getBoundingClientRect(),st=Xe.left-j.left+Xe.width/2,U=Xe.top-j.top+Xe.height/2,ne=Xe.left-j.left,K=Xe.top-j.top,Y="cell";try{let ie=I.state.selection,ee=ie?.$anchorCell?.pos,ue=ie?.$headCell?.pos;if(typeof ee=="number"&&typeof ue=="number"&&ee!==ue){let ye=ee-(b.tablePos+1),ke=ue-(b.tablePos+1),Le=b.map?.rectBetween?.(ye,ke)||null;if(Le){let be=Number(Le.right)-Number(Le.left),_e=Number(Le.bottom)-Number(Le.top);be===1&&_e>1?Y="col":_e===1&&be>1?Y="row":Y="range"}else Y="range"}}catch{Y="cell"}try{Y==="cell"?(this.cellOutline.style.display="",this.cellOutline.style.left=`${Math.round(ne)}px`,this.cellOutline.style.top=`${Math.round(K)}px`,this.cellOutline.style.width=`${Math.max(0,Math.round(Xe.width))}px`,this.cellOutline.style.height=`${Math.max(0,Math.round(Xe.height))}px`):this.cellOutline.style.display="none"}catch{try{this.cellOutline.style.display="none"}catch{}}for(let ie=0;ie<this.colHandles.length;ie+=1){let ee=this.colHandles[ie];if(ee){if(ee.dataset.idx=String(ie),ie!==Je){ee.style.display="none";continue}ee.style.display="",ee.style.width=`${Math.max(18,Math.round(Xe.width))}px`,ee.style.height=`${oe}px`,ee.style.left=`${Math.round(st)}px`,ee.style.top=`${Math.round(Oe)}px`}}for(let ie=0;ie<this.rowHandles.length;ie+=1){let ee=this.rowHandles[ie];if(ee){if(ee.dataset.idx=String(ie),ie!==$e){ee.style.display="none";continue}ee.style.display="",ee.style.width=`${oe}px`,ee.style.height=`${Math.max(18,Math.round(Xe.height))}px`,ee.style.left=`${Math.round(Fe)}px`,ee.style.top=`${Math.round(U)}px`}}try{if(Y!=="cell")this.cellHandle.style.display="none";else{let ie=Xe.right-j.left;this.cellHandle.style.display="",this.cellHandle.style.left=`${Math.round(ie)}px`,this.cellHandle.style.top=`${Math.round(U)}px`}}catch{this.cellHandle.style.display="none"}fr&&this.scheduleResizeLoop()}openCellMenu(I){let b=()=>{try{A?.chain?.().focus?.().run?.()}catch{}},B=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>m.map(_=>({label:_.label,swatch:!0,swatchValue:_.value,onClick:()=>{b(),A.commands.setNodeTextColor(_.value)}}))},{label:"Background color",submenu:()=>v.map(_=>({label:_.label,swatch:!0,swatchValue:_.value,onClick:()=>{b(),A.commands.setNodeBackground(_.value)}}))}]},{label:"Alignment",submenu:()=>[...C.map(_=>({label:_.label,onClick:()=>{b(),A.commands.setNodeTextAlign(_.value)}})),{type:"separator"},...D.map(_=>({label:_.label,onClick:()=>{b(),A.commands.setNodeVAlign(_.value)}}))]},{type:"separator"},{label:"Clear contents",onClick:()=>{b(),A.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:I,items:B,level:0})}openRowMenu(I,b,B){let _=()=>{try{A?.chain?.().focus?.().run?.()}catch{}Number.isFinite(Number(B))&&Tp(A,B,b)},H=(j,X)=>{try{A?.chain?.().focus?.().run?.()}catch{}return A.commands.command(({state:te,dispatch:he})=>{let oe=Number.isFinite(Number(B))?Number(B):Mt(te)?.tablePos,ge=Number.isFinite(Number(b))?Number(b):Mt(te)?.rowIndex;return!Number.isFinite(Number(oe))||!Number.isFinite(Number(ge))?!1:Mp({pmState:te,dispatch:he},{tablePos:oe,rowIndex:ge,attr:j,value:X})})},R=j=>()=>(_(),j?.()),F=j=>{try{return typeof j!="function"?!1:(_(),A.commands.command(({state:X,dispatch:te})=>j(X,typeof te=="function"?oe=>{try{oe=oe.setMeta(de,!0)}catch{}te(oe)}:void 0)))}catch{return!1}},V=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>m.map(j=>({label:j.label,swatch:!0,swatchValue:j.value,onClick:()=>H("nodeTextColor",j.value)}))},{label:"Background color",submenu:()=>v.map(j=>({label:j.label,swatch:!0,swatchValue:j.value,onClick:()=>H("nodeBackground",j.value)}))}]},{label:"Alignment",submenu:()=>[...C.map(j=>({label:j.label,onClick:()=>H("nodeTextAlign",j.value)})),{type:"separator"},...D.map(j=>({label:j.label,onClick:()=>H("nodeVerticalAlign",j.value)}))]},{type:"separator"},{label:"Insert row above",onClick:()=>F(mt?.addRowBefore)},{label:"Insert row below",onClick:()=>F(mt?.addRowAfter)},{label:"Sort ",submenu:()=>[{label:"Sort column A-Z",onClick:R(()=>Ul(A,{direction:"asc"}))},{label:"Sort column Z-A",onClick:R(()=>Ul(A,{direction:"desc"}))}]},{label:"Header row",onClick:()=>F(mt?.toggleHeaderRow)},{label:"Move ",submenu:()=>[{label:"Move row up",onClick:R(()=>Fl(A,-1))},{label:"Move row down",onClick:R(()=>Fl(A,1))},{label:"Move row left",disabled:!0,onClick:()=>{}},{label:"Move row right",disabled:!0,onClick:()=>{}}]},{label:"Duplicate row",onClick:R(()=>_p(A))},{label:"Delete row",onClick:()=>F(mt?.deleteRow)},{type:"separator"},{label:"Clear row contents",onClick:()=>{_(),A.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:I,items:V,level:0})}openColumnMenu(I,b,B){let _=()=>{try{A?.chain?.().focus?.().run?.()}catch{}Number.isFinite(Number(B))&&Np(A,B,b)},H=(j,X)=>{try{A?.chain?.().focus?.().run?.()}catch{}return A.commands.command(({state:te,dispatch:he})=>{let oe=Number.isFinite(Number(B))?Number(B):Mt(te)?.tablePos,ge=Number.isFinite(Number(b))?Number(b):Mt(te)?.colIndex;return!Number.isFinite(Number(oe))||!Number.isFinite(Number(ge))?!1:Lp({pmState:te,dispatch:he},{tablePos:oe,colIndex:ge,attr:j,value:X})})},R=j=>()=>(_(),j?.()),F=j=>{try{return typeof j!="function"?!1:(_(),A.commands.command(({state:X,dispatch:te})=>j(X,typeof te=="function"?oe=>{try{oe=oe.setMeta(de,!0)}catch{}te(oe)}:void 0)))}catch{return!1}},V=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>m.map(j=>({label:j.label,swatch:!0,swatchValue:j.value,onClick:()=>H("nodeTextColor",j.value)}))},{label:"Background color",submenu:()=>v.map(j=>({label:j.label,swatch:!0,swatchValue:j.value,onClick:()=>H("nodeBackground",j.value)}))}]},{label:"Alignment",submenu:()=>[...C.map(j=>({label:j.label,onClick:()=>H("nodeTextAlign",j.value)})),{type:"separator"},...D.map(j=>({label:j.label,onClick:()=>H("nodeVerticalAlign",j.value)}))]},{type:"separator"},{label:"Insert column left",onClick:()=>{_();let j=Math.max(0,Number(b||0));F(mt?.addColumnBefore)&&window.requestAnimationFrame(()=>{try{Si(A,{insertIndex:j,newColPct:10})}catch{let te=qt(A.view);yi(te)}})}},{label:"Insert column right",onClick:()=>{_();let j=Math.max(0,Number(b||0)+1);F(mt?.addColumnAfter)&&window.requestAnimationFrame(()=>{try{Si(A,{insertIndex:j,newColPct:10})}catch{let te=qt(A.view);yi(te)}})}},{label:"Sort ",submenu:()=>[{label:"Sort row A-Z",onClick:R(()=>zl(A,{direction:"asc"}))},{label:"Sort row Z-A",onClick:R(()=>zl(A,{direction:"desc"}))}]},{label:"Header column",onClick:()=>F(mt?.toggleHeaderColumn)},{label:"Move ",submenu:()=>[{label:"Move column up",disabled:!0,onClick:()=>{}},{label:"Move column down",disabled:!0,onClick:()=>{}},{label:"Move column left",onClick:R(()=>$l(A,-1))},{label:"Move column right",onClick:R(()=>$l(A,1))}]},{label:"Duplicate column",onClick:R(()=>Dp(A))},{label:"Delete column",onClick:()=>{_();let j=qt(A.view),X=zr(j),te=Number.isFinite(Number(b))?Number(b):null,he=X&&te!=null?ud(X,te):null;F(mt?.deleteColumn)&&Array.isArray(he)&&window.requestAnimationFrame(()=>{let ge=qt(A.view);Ur(ge,he)})}},{type:"separator"},{label:"Clear column contents",onClick:()=>{_(),A.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:I,items:V,level:0})}}return[new y({view(x){let I=new T(x);return I.update(x),{update(b){I.update(b)},destroy(){I.destroy()}}}})]}}),tt=pr()?performance.now():0;se=new c({element:e,extensions:[yn,vt,wn,bn,Bn,we,Ne,ce,me,pe,cn,We,yt,jt,kt,xe,$.configure({types:["outlineSection"],attributeName:"id",generateID:()=>$t()}),w.configure({document:!1,heading:!1,link:!1}),O.configure({openOnClick:!1,protocols:li}),Ve,Z,G,Ge,q.configure({table:{resizable:!0}}),nt,Ze,qe,Qe,fe].filter(Boolean),content:ae,editorProps:{attributes:{class:"outline-prosemirror"},handleKeyDown(A,m){if(m&&m.__memusSyntheticAltProxy)return!1;let v="ttree_outline_debug_alt_v1",C=()=>{try{return window?.localStorage?.getItem?.(v)==="1"}catch{return!1}},D=T=>{try{return!!T?.getModifierState?.("AltGraph")}catch{return!1}};((T,x)=>{try{if(!C())return;let I=String(T?.key||""),b=String(T?.code||"");if(!I.startsWith("Arrow")&&b!=="Enter"&&b!=="NumpadEnter")return;let B={altKey:!!T?.altKey,ctrlKey:!!T?.ctrlKey,metaKey:!!T?.metaKey,shiftKey:!!T?.shiftKey,altGraph:D(T),repeat:!!T?.repeat,location:T?.location??null},_=[];B.metaKey&&_.push("Meta"),B.ctrlKey&&_.push("Ctrl"),B.altKey&&_.push(B.altGraph?"AltGraph":"Alt"),B.shiftKey&&_.push("Shift"),_.push(b||I||"?"),console.log("[outline][alt-debug]",x,{key:I,code:b,name:_.join("-"),...B})}catch{}})(m,"keydown");let N=T=>{try{return!!T?.getModifierState?.("AltGraph")}catch{return!1}},P=T=>{try{return(!!T?.altKey||N(T))&&!T?.metaKey&&(!T?.ctrlKey||N(T))}catch{return!1}};try{let x=(Ae?.getState?.(A.state)||null)?.editingSectionId||null,I=!!D(m)&&!m?.altKey&&!m?.ctrlKey&&!m?.metaKey&&!m?.shiftKey,b=String(m?.key||""),B=String(m?.code||"");if(!x&&I&&(b==="ArrowUp"||b==="ArrowDown"||b==="ArrowLeft"||b==="ArrowRight")){let H=null;try{H=new KeyboardEvent("keydown",{key:b,code:B||b,altKey:!0,ctrlKey:!1,metaKey:!1,shiftKey:!1,bubbles:!0,cancelable:!0});try{Object.defineProperty(H,"__memusSyntheticAltProxy",{value:!0})}catch{}}catch{H=null}if(H||(H={key:b,code:B||b,altKey:!0,ctrlKey:!1,metaKey:!1,shiftKey:!1,bubbles:!0,cancelable:!0,__memusSyntheticAltProxy:!0,preventDefault(){},stopPropagation(){},getModifierState(F){return!1}}),!!A?.someProp?.("handleKeyDown",F=>F(A,H)))return m.preventDefault(),m.stopPropagation(),!0}}catch{}try{if(P(m)){let T=String(m.key||"");if((T==="ArrowUp"||T==="ArrowDown")&&m.repeat){let x=A?.state?.selection?.$from;if(x){let I=!1;for(let b=x.depth;b>0;b-=1){let B=x.node(b)?.type?.name;if(B&&String(B).startsWith("table")){I=!0;break}}if(!I){let b=null;for(let B=x.depth;B>0;B-=1)if(x.node(B)?.type?.name==="outlineSection"){b=x.before(B);break}if(typeof b=="number"){let B=A.state.doc.resolve(b),_=B.parent;if(_){let H=B.index();if(T==="ArrowUp"&&H<=0||T==="ArrowDown"&&H>=_.childCount-1)return!0}}}}}}}catch{}Ke("editorProps.keydown",{key:m?.key||null,repeat:!!m?.repeat,selection:{empty:!!A.state?.selection?.empty,parent:A.state?.selection?.$from?.parent?.type?.name||null,parentOffset:A.state?.selection?.$from?.parentOffset??null,pos:A.state?.selection?.$from?.pos??null}});try{let T=ze?.pmStateMod?.TextSelection;if(T){let I=(Ae?.getState?.(A.state)||null)?.editingSectionId||null,b=(m.key==="Enter"||m.code==="Enter"||m.code==="NumpadEnter")&&(m.ctrlKey||m.metaKey)&&!m.shiftKey&&!m.altKey;if(!u.isPublicView&&!I&&b){let B=A.state.selection,_=B?.$from||null;if(_){let H=wt(A.state.doc,_),R=typeof H=="number"?A.state.doc.nodeAt(H):null;if(typeof H=="number"&&R?.type?.name==="outlineSection"){let F=!!(B&&B.empty),V=_.parent?.type?.name==="outlineHeading",X=F&&V&&_.parentOffset===0?H:H+R.nodeSize,te=A.state.schema,he=$t(),oe=te.nodes.outlineSection.create({id:he,collapsed:!1},[te.nodes.outlineHeading.create({},[]),te.nodes.outlineBody.create({},[te.nodes.paragraph.create({},[])]),te.nodes.outlineChildren.create({},[])]),ge=A.state.tr.insert(X,oe);try{let $e=ge.doc.nodeAt(X)?.child?.(0)||oe.child(0),Je=X+1+$e.nodeSize;ge=ge.setSelection(T.near(ge.doc.resolve(Je+2),1))}catch{ge=ge.setSelection(T.create(ge.doc,X+2))}ge=ge.setMeta(de,!0),Ae&&(ge=ge.setMeta(Ae,{type:"enter",sectionId:he})),A.dispatch(ge.scrollIntoView());try{A.focus()}catch{}return m.preventDefault(),m.stopPropagation(),!0}}}}}catch{}try{let T=P(m)&&!m.shiftKey,x=String(m.key||"");if(T&&(x==="ArrowLeft"||x==="ArrowRight"||x==="ArrowUp"||x==="ArrowDown")&&(Ae?.getState?.(A.state)||null)?.editingSectionId&&se){let b=()=>{try{let B=A?.state?.selection?.$from||null;if(!B)return!1;for(let _=B.depth;_>0;_-=1){let H=B.node(_)?.type?.name;if(H==="table"||H==="tableRow"||H==="tableCell"||H==="tableHeader")return!0}return!1}catch{return!1}};if(x==="ArrowLeft"||x==="ArrowRight"){let B=se.chain().focus();B.command(({tr:H})=>(H.setMeta(de,!0),!0));let _=!1;if(se.isActive("bulletList")||se.isActive("orderedList")?x==="ArrowRight"?_=B.sinkListItem("listItem").run():(_=B.liftListItem("listItem").run(),!_&&se.isActive("bulletList")&&(_=B.toggleBulletList().run()),!_&&se.isActive("orderedList")&&(_=B.toggleOrderedList().run())):x==="ArrowRight"&&(_=B.toggleBulletList().run()),_)return m.preventDefault(),m.stopPropagation(),!0}else if((x==="ArrowUp"||x==="ArrowDown")&&(x==="ArrowUp"?Vl(se,-1)||ql(se,-1):Vl(se,1)||ql(se,1)))return m.preventDefault(),m.stopPropagation(),!0}}catch{}try{if((m.ctrlKey||m.metaKey)&&!m.altKey&&!m.shiftKey&&(m.code==="KeyA"||String(m.key||"").toLowerCase()==="a")){let x=ze?.pmStateMod?.TextSelection;if(!x)return Ke("editorProps.modA",{handled:!1,reason:"no-TextSelection"}),!1;let I=A.state,b=I.selection,B=b?.$from||null;if(!B)return Ke("editorProps.modA",{handled:!1,reason:"no-$from"}),!1;let _=wt(I.doc,B);if(typeof _!="number")return Ke("editorProps.modA",{handled:!1,reason:"no-sectionPos"}),!1;let H=I.doc.nodeAt(_);if(!H||H.type?.name!=="outlineSection")return Ke("editorProps.modA",{handled:!1,reason:"not-outlineSection"}),!1;let R=H.child(0),F=H.child(1);if(!R||!F)return Ke("editorProps.modA",{handled:!1,reason:"missing-heading/body"}),!1;let V=_+1,j=V+1,X=V+R.nodeSize-1,te=_+1+R.nodeSize,he=te+1,oe=te+F.nodeSize-1,ge=oe;try{let Fe=null;I.doc.nodesBetween(he,Math.min(I.doc.content.size,oe),(Xe,st)=>{Xe?.isTextblock&&(Fe=st+Xe.nodeSize-1)}),typeof Fe=="number"&&(ge=Fe)}catch{}ge<he&&(ge=X);let Me=j,$e=(()=>{try{for(let Fe=B.depth;Fe>0;Fe-=1)if(B.node(Fe)?.type?.name==="outlineHeading")return!0}catch{}return!1})(),Je=!!b&&typeof b.from=="number"&&typeof b.to=="number"&&Math.min(b.from,b.to)===Me&&Math.max(b.from,b.to)===ge;if($e&&Je)return Ke("editorProps.modA",{handled:!1,reason:"pass-through-doc-select"}),!1;m.preventDefault(),m.stopPropagation();let Oe=x.create(I.doc,Me,ge);return A.dispatch(I.tr.setSelection(Oe)),Ke("editorProps.modA",{handled:!0,blockFrom:Me,blockTo:ge,isInHeading:$e,alreadySelectedBlock:Je}),!0}}catch{}try{if(!Ae)return!1;let x=(Ae.getState(A.state)||{}).editingSectionId||null;if(!x){let I=(m.ctrlKey||m.metaKey)&&!m.altKey&&!m.shiftKey&&(m.key==="Delete"||m.key==="Del"||m.key==="Backspace"),b=m.key==="Backspace"||m.key==="Delete",B=m.key&&m.key.length===1&&!m.metaKey&&!m.ctrlKey&&!m.altKey,_=!m.metaKey&&!m.ctrlKey&&!m.altKey&&!m.shiftKey&&(m.key===" "||m.key==="Spacebar");if(I){let H=wt(A.state.doc,A.state.selection.$from),R=!1;try{typeof H=="number"&&(R=rt(A.state,A.dispatch,H))}catch{R=!1}return Ke("editorProps.modDelete",{ok:R,sectionPos:H}),m.preventDefault(),m.stopPropagation(),!0}if(_){let H=document.activeElement;if(!(!!(H&&H.closest&&H.closest(".outline-editor"))||!!(m?.target&&m.target.closest&&m.target.closest(".outline-editor"))))return!1;if(m.repeat)return m.preventDefault(),m.stopPropagation(),!0;let F=m?.target||null,V=String(F?.tagName||"").toLowerCase();if(V==="button"||V==="input"||V==="textarea"||V==="select"||F?.closest?.("button, a[href], input, textarea, select")||!!!F?.closest?.(".outline-prosemirror")&&F?.closest?.('[contenteditable="true"]'))return!1;let X=wt(A.state.doc,A.state.selection.$from);if(typeof X!="number")return m.preventDefault(),m.stopPropagation(),!0;let te=A.state.doc.nodeAt(X);if(!te)return m.preventDefault(),m.stopPropagation(),!0;let he=!te.attrs?.collapsed,oe=A.state.tr.setNodeMarkup(X,void 0,{...te.attrs,collapsed:he});oe=oe.setMeta(de,!0);try{let ge=te.child(0),$e=X+1+ge.nodeSize-1,{TextSelection:Je}=ze?.pmStateMod||{};Je&&(oe=oe.setSelection(Je.near(oe.doc.resolve($e),-1)))}catch{}return m.preventDefault(),m.stopPropagation(),A.dispatch(oe.scrollIntoView()),!0}if(b){if(m.key==="Backspace")try{let H=A.state,R=H.selection,F=R?.$from||null,V=null;try{for(let te=F?.depth||0;te>0;te-=1)if(F.node(te)?.type?.name==="outlineHeading"){V=te;break}}catch{V=null}let j=V!==null&&F?F.start(V):null,X=!!(R&&R.empty)&&!!F&&V!==null&&typeof j=="number"&&F.pos===j;if(Ke("editorProps.backspace.check",{empty:!!R?.empty,headingDepth:V,headingStart:j,pos:F?.pos??null,parent:F?.parent?.type?.name||null,parentOffset:F?.parentOffset??null,atHeadingStart:X}),X){let te=wt(H.doc,F),he=typeof te=="number"?H.doc.nodeAt(te):null;if(Ke("editorProps.backspace.sectionPos",{sectionPos:te,hasNode:!!he}),typeof te=="number"&&he){let oe=String(he.attrs?.id||""),ge=null;try{let $e=H.doc.resolve(te),Je=$e.index(),Oe=$e.parent;if(Oe&&Je>0){let Fe=Oe.child(Je-1),Xe=te-Fe.nodeSize,st=H.doc.nodeAt(Xe);ge=String(st?.attrs?.id||"")||null}else for(let Fe=F.depth-1;Fe>0;Fe-=1){let Xe=F.node(Fe);if(Xe?.type?.name==="outlineSection"){let st=String(Xe.attrs?.id||"");if(st&&st!==oe){ge=st;break}}}}catch{ge=null}Ke("editorProps.backspace.mergeCandidate",{sectionPos:te,currentSectionId:oe,targetSectionId:ge});let Me=!1;if(dt(he))Me=rt(H,A.dispatch,te);else try{H.doc.resolve(te).index()<=0?Me=Kt(H,A.dispatch,te):Me=ht(H,A.dispatch,te)}catch{Me=ht(H,A.dispatch,te)}return Ke("editorProps.backspace.mergeDone",{ok:Me,targetSectionId:ge}),Me&&ge&&Ae&&window.setTimeout(()=>{try{if((Ae.getState(A.state)||{}).editingSectionId)return;let Je=it(A.state.doc,ge),Oe=typeof Je=="number"?A.state.doc.nodeAt(Je):null;if(!Oe)return;let Fe=A.state.tr;Oe?.attrs?.collapsed&&(Fe=Fe.setNodeMarkup(Je,void 0,{...Oe.attrs,collapsed:!1}),Fe=Fe.setMeta(de,!0)),Fe=Fe.setMeta(Ae,{type:"enter",sectionId:ge});try{let Xe=Fe.doc.nodeAt(Je);if(Xe&&Xe.type?.name==="outlineSection"){let st=Xe.child(0),U=Xe.child(1),K=Je+1+st.nodeSize+U.nodeSize-1;Fe=Fe.setSelection(p.near(Fe.doc.resolve(K),-1))}}catch{}A.dispatch(Fe.scrollIntoView());try{A.focus()}catch{}Ke("editorProps.backspace.enterEdit.done",{targetSectionId:ge})}catch{}},0),m.preventDefault(),m.stopPropagation(),!0}}}catch{}return m.preventDefault(),m.stopPropagation(),!0}if(B)return m.preventDefault(),m.stopPropagation(),$r(),!0}if(u.isPublicView&&!x&&(m.key==="Enter"&&!m.shiftKey&&!m.ctrlKey&&!m.metaKey&&!m.altKey||m.key==="F2"&&!m.shiftKey&&!m.ctrlKey&&!m.metaKey&&!m.altKey))return m.preventDefault(),m.stopPropagation(),!0;if(!x&&(m.key==="Enter"&&!m.shiftKey&&!m.ctrlKey&&!m.metaKey&&!m.altKey||m.key==="F2"&&!m.shiftKey&&!m.ctrlKey&&!m.metaKey&&!m.altKey)){let I=wt(A.state.doc,A.state.selection.$from);if(typeof I!="number")return!1;let b=A.state.doc.nodeAt(I),B=String(b?.attrs?.id||"");if(!B)return!1;if(m.preventDefault(),m.stopPropagation(),b?.attrs?.collapsed){let _=A.state.tr.setNodeMarkup(I,void 0,{...b.attrs,collapsed:!1});return _.setMeta(de,!0),A.dispatch(_.scrollIntoView()),!0}return A.dispatch(A.state.tr.setMeta(Ae,{type:"enter",sectionId:B})),!0}if(x&&m.key==="Escape"){m.preventDefault(),m.stopPropagation();let I=x;A.dispatch(A.state.tr.setMeta(Ae,{type:"exit"}));try{let b=se;if(b&&!b.isDestroyed){let B=hr(A.state.doc,I);Yl(b,A.state.doc,I),B&&Vt({delayMs:350})}}catch{}return!0}}catch{}return!1},handleDOMEvents:{click(A,m){try{let v=m.target?.closest?.("a[href]");if(!v||!Ae)return!1;let C=String(v.getAttribute("href")||"").trim();if(!C)return!1;if(u.isPublicView){let I=String(v.getAttribute("rel")||"").split(/\s+/).filter(Boolean);if(v.getAttribute("data-unpublished")==="1"||I.includes("unpublished")||C==="#")return alert("\u042D\u0442\u0430 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435 \u043E\u043F\u0443\u0431\u043B\u0438\u043A\u043E\u0432\u0430\u043D\u0430"),m.preventDefault(),m.stopPropagation(),!0}if(C.startsWith("app:/")||C.startsWith("disk:/")){m.preventDefault(),m.stopPropagation();let x=en(C);if(x)return window.open(x,"_blank","noopener,noreferrer"),!0}if((Ae.getState(A.state)||{}).editingSectionId||null)return!1;let N=x=>{let I=String(x||"").trim();if(!I||I.startsWith("/")||I.startsWith("#")||/\s/.test(I)||I.includes("://")||/^[a-z][a-z0-9+.-]*:/i.test(I))return!1;let b=I.split(/[/?#]/,1)[0];return!(!b||!b.includes(".")||b.startsWith(".")||b.endsWith(".")||b.includes(".."))},P=x=>{let I=String(x||"").trim();return I&&(I.startsWith("//")?`https:${I}`:N(I)?`https://${I}`:I)};if(m.preventDefault(),m.stopPropagation(),C.startsWith("/"))return u.isPublicView?(window.location.href=C,!0):(un(C),!0);let T=P(C);return/^https?:\/\//i.test(T)||/^mailto:/i.test(T)||/^tel:/i.test(T),window.open(T,"_blank","noopener,noreferrer"),!0}catch{return!1}},beforeinput(A,m){try{if(!Ae)return!1;let C=(Ae.getState(A.state)||{}).editingSectionId||null;if(C)return!1;let D=String(m?.inputType||"");if(D.startsWith("history"))return!1;if(Ke("beforeinput",{inputType:D,key:m?.data??null,editingSectionId:C||null,selection:{empty:!!A.state?.selection?.empty,parent:A.state?.selection?.$from?.parent?.type?.name||null,parentOffset:A.state?.selection?.$from?.parentOffset??null}}),D==="deleteContentBackward"){try{let M=A.state,N=M.selection,P=N?.$from||null,T=null;try{for(let b=P?.depth||0;b>0;b-=1)if(P.node(b)?.type?.name==="outlineHeading"){T=b;break}}catch{T=null}let x=T!==null&&P?P.start(T):null,I=!!(N&&N.empty)&&!!P&&T!==null&&typeof x=="number"&&P.pos===x;if(Ke("beforeinput.deleteContentBackward.check",{empty:!!N?.empty,headingDepth:T,headingStart:x,pos:P?.pos??null,parent:P?.parent?.type?.name||null,parentOffset:P?.parentOffset??null,atHeadingStart:I}),I){let b=wt(M.doc,P),B=typeof b=="number"?M.doc.nodeAt(b):null;if(typeof b=="number"&&B){let _=String(B.attrs?.id||"");Ke("beforeinput.deleteContentBackward.candidate",{sectionPos:b,currentSectionId:_});let H=null;try{let F=M.doc.resolve(b),V=F.index(),j=F.parent;if(j&&V>0){let X=j.child(V-1),te=b-X.nodeSize,he=M.doc.nodeAt(te);H=String(he?.attrs?.id||"")||null}else for(let X=P.depth-1;X>0;X-=1){let te=P.node(X);if(te?.type?.name==="outlineSection"){let he=String(te.attrs?.id||"");if(he&&he!==_){H=he;break}}}}catch{H=null}let R=!1;if(dt(B))Ke("beforeinput.merge",{kind:"deleteEmpty",sectionPos:b}),R=rt(M,A.dispatch,b);else try{M.doc.resolve(b).index()<=0?(Ke("beforeinput.merge",{kind:"intoParent",sectionPos:b,targetSectionId:H}),R=Kt(M,A.dispatch,b)):(Ke("beforeinput.merge",{kind:"intoPrev",sectionPos:b,targetSectionId:H}),R=ht(M,A.dispatch,b))}catch{Ke("beforeinput.merge",{kind:"intoPrev.catch",sectionPos:b,targetSectionId:H}),R=ht(M,A.dispatch,b)}return Ke("beforeinput.merge.done",{ok:R,targetSectionId:H}),R&&H&&window.setTimeout(()=>{try{if((Ae.getState(A.state)||{}).editingSectionId)return;let V=it(A.state.doc,H),j=typeof V=="number"?A.state.doc.nodeAt(V):null;if(!j)return;let X=A.state.tr;j?.attrs?.collapsed&&(X=X.setNodeMarkup(V,void 0,{...j.attrs,collapsed:!1}),X=X.setMeta(de,!0)),X=X.setMeta(Ae,{type:"enter",sectionId:H});try{let te=A.state.doc.nodeAt(V);if(te&&te.type?.name==="outlineSection"){let he=te.child(0),oe=V+1+he.nodeSize,ge=Math.min(X.doc.content.size,oe+2);X=X.setSelection(p.create(X.doc,ge))}}catch{}A.dispatch(X.scrollIntoView());try{A.focus()}catch{}Ke("beforeinput.enterEdit.done",{targetSectionId:H})}catch{}},0),m.preventDefault(),m.stopPropagation(),!0}}}catch{}return Ke("beforeinput.deleteContentBackward.block",{inputType:D}),m.preventDefault(),m.stopPropagation(),!0}return D.startsWith("delete")?(Ke("beforeinput.delete.block",{inputType:D}),m.preventDefault(),m.stopPropagation(),!0):(m.preventDefault(),m.stopPropagation(),$r(),!0)}catch{return!1}},dblclick(A,m){try{if(u.isPublicView||!Ae||(Ae.getState(A.state)||{}).editingSectionId||null)return!1;let D=m?.target&&m.target.closest&&m.target.closest('[data-outline-heading="true"]')||m?.target&&m.target.closest&&m.target.closest(".outline-heading"),M=m?.target&&m.target.closest&&m.target.closest('[data-outline-body="true"]')||m?.target&&m.target.closest&&m.target.closest(".outline-body");if(!D&&!M)return!1;let N={left:m.clientX,top:m.clientY},P=A.posAtCoords(N),T=P&&typeof P.pos=="number"?P.pos:null;if(typeof T!="number")return!1;let x=A.state.doc.resolve(Math.max(0,Math.min(A.state.doc.content.size,T))),I=wt(A.state.doc,x);if(typeof I!="number")return!1;let b=A.state.doc.nodeAt(I),B=String(b?.attrs?.id||"");if(!B)return!1;window.setTimeout(()=>{try{if((Ae.getState(A.state)||{}).editingSectionId)return;let H=it(A.state.doc,B),R=typeof H=="number"?A.state.doc.nodeAt(H):null,F=!!R?.attrs?.collapsed,V=A.state.tr;if(F&&typeof H=="number"&&R&&(V=V.setNodeMarkup(H,void 0,{...R.attrs,collapsed:!1}),V=V.setMeta(de,!0)),F){A.dispatch(V.scrollIntoView());try{A.focus()}catch{}return}V=V.setMeta(Ae,{type:"enter",sectionId:B});try{let{TextSelection:j}=ze?.pmStateMod||{},X=typeof H=="number"?V.doc.nodeAt(H):null;if(X&&X.type?.name==="outlineSection"){let te=X.child(0),he=H+1+te.nodeSize,oe=Math.min(V.doc.content.size,he+2);j&&(V=V.setSelection(j.near(V.doc.resolve(oe),1)))}}catch{}A.dispatch(V.scrollIntoView());try{A.focus()}catch{}}catch{}},0)}catch{}return!1}}},onCreate:({editor:A})=>{if(Ie&&u.articleId&&u.article&&!u.article.encrypted)try{let m=A.getJSON();u.article.docJson=m,Fa(u.articleId,m).catch(()=>{})}catch{}try{Qp(A.state.doc)}catch{}Sr.clear();try{Fr.clear()}catch{}Jt=!1,Xl=null,Zt=null;try{gi=Ol(A.state.doc),Cn=!1;try{fn.clear()}catch{fn.clear()}Nt&&(clearTimeout(Nt),Nt=null)}catch{}zn("")},onUpdate:()=>{Jt=!0;try{let A=Ae?.getState?.(se?.state)||null,m=String(A?.editingSectionId||"").trim();if(m){let v=se?.state?.doc||null;v&&hr(v,m)&&pp(se)}}catch{}try{let A=se?.state?.doc||null;if(A){let m=Ol(A);m&&m!==gi&&(gi=m,fp({articleId:St||u.articleId,editor:se}))}}catch{}try{Jl(se)}catch{}Vt({delayMs:1500})},onSelectionUpdate:({editor:A})=>{let{state:m}=A,{selection:v}=m;if(!v)return;let C=wt(m.doc,v.$from);if(typeof C!="number")return;let D=m.doc.nodeAt(C),M=String(D?.attrs?.id||"");if(!M)return;try{let T=(Ae?.getState?.(m)||null)?.editingSectionId||null;T&&T!==M&&A.view.dispatch(m.tr.setMeta(Ae,{type:"exit"}))}catch{}if(Zt&&Zt!==M){let P=hr(m.doc,Zt);try{Dt("leave_section",{from:Zt,to:M,changed:P})}catch{}try{Fr.has(Zt)&&Yl(A,m.doc,Zt)}catch{}P&&Vt({delayMs:350})}let N=Zt;Zt=M;try{Jl(A)}catch{}try{!(Ae?.getState?.(m)||null)?.editingSectionId&&N&&N!==M&&Kp(A,{lines:4})}catch{}}}),tt&&Hr("new Editor()",{ms:Math.round(performance.now()-tt)});try{(St||u.articleId)&&(ap(St||u.articleId),navigator.onLine&&Ql(St||u.articleId))}catch{}e.focus?.({preventScroll:!0}),xi=A=>{try{if(!se)return;let m=se.state.tr.setMeta(re,{activeKey:A||null});se.view.dispatch(m)}catch{}};try{ad()}catch{}try{let A=pr()?performance.now():0;vp(se),A&&Hr("convertMarkdownTablesInOutlineDoc()",{ms:Math.round(performance.now()-A)})}catch{}t&&Hr("mountOutlineEditor() total",{ms:Math.round(performance.now()-t)})})();try{await mo}finally{mo=null}}function xo(e=""){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}async function tm(e={}){if(u.isPublicView||!u.articleId||!u.article||!se)return;let t=St||u.articleId;if(!t)return;let n=!!e.silent,r=e&&typeof e.mode=="string"?e.mode:"network",o=Array.from(new Set([...Sr||[],Zt].filter(Boolean))),i=(s,a)=>{let c=s?String(s):"",l=a?String(a):"";return c?l?c>=l?c:l:c||null:l||null};try{if(n||Ni("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C outline\u2026"),u.article.encrypted){n||(or(),Ee("Outline-\u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u0435 docJson \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0434\u043B\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0445 \u0441\u0442\u0430\u0442\u0435\u0439"));return}let s=se.getJSON(),a=sp(s);if(u.articleId&&t!==u.articleId){await nn(t,a,u.article?.updatedAt||null).catch(()=>{}),n||or(),zn("\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0447\u0435\u0440\u043D\u043E\u0432\u0438\u043A \u0441\u043E\u0445\u0440\u0430\u043D\u0451\u043D \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E");return}let c=Date.now();await nn(t,a,u.article?.updatedAt||null).catch(()=>{});try{Zt&&hr(se.state.doc,Zt)}catch{}if(!0){let d=fn.size?Array.from(fn):[];try{d.length&&(fn.clear(),await zt("delete_sections",{articleId:t,payload:{sectionIds:d,clientQueuedAt:c},coalesceKey:`delete:${t}`}))}catch{}n||or(),u.article&&(u.article.docJson=a),Jt=!1,Xl=new Date,zn("\u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E");try{ad()}catch{}try{em(se,se.state.doc,o)}catch{}return}}catch(s){n?zn("\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F"):(or(),Ee(s?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C outline"));try{let a=se.getJSON();a&&typeof a=="object"&&await nn(t,a,u.article?.updatedAt||null).catch(()=>{})}catch{}Vt({delayMs:5e3})}}function nm(){return Zt||null}function rm(){try{if(!se||se.isDestroyed)return null;let e=se.state,t=wt(e.doc,e.selection.$from);if(typeof t!="number")return null;let n=e.doc.nodeAt(t);if(!n||n.type?.name!=="outlineSection")return null;let r=String(n.attrs?.id||"").trim();return r?{sectionId:r,collapsed:!!n.attrs?.collapsed}:null}catch{return null}}function om(e,t){try{let n=String(t||"");if(!e||!n)return null;let r=(i,s,a)=>{if(!i||i.type?.name!=="outlineSection")return null;let c=String(i.attrs?.id||""),l=[...a,s];if(c===n)return l;let d=i.child(0),h=i.child(1),g=i.child(2);if(!g||g.type?.name!=="outlineChildren")return null;let S=s+1+d.nodeSize+h.nodeSize+1;for(let f=0;f<g.childCount;f+=1){let p=g.child(f),y=S;S+=p.nodeSize;let k=r(p,y,l);if(k)return k}return null},o=0;for(let i=0;i<e.childCount;i+=1){let s=e.child(i),a=o;o+=s.nodeSize;let c=r(s,a,[]);if(c)return c}return null}catch{return null}}function xd(e,t={}){try{if(!se||se.isDestroyed)return!1;let n=String(e||"");if(!n)return!1;let{state:r,view:o}=se,i=ze?.pmStateMod?.TextSelection,s=om(r.doc,n);if(!Array.isArray(s)||!s.length)return!1;let a=r.tr;for(let c of s){let l=a.doc.nodeAt(c);!l||l.type?.name!=="outlineSection"||l.attrs?.collapsed&&(a=a.setNodeMarkup(c,void 0,{...l.attrs,collapsed:!1}))}a=a.setMeta(de,!0);try{let c=it(a.doc,n),l=typeof c=="number"?a.doc.nodeAt(c):null;if(typeof c=="number"&&l?.type?.name==="outlineSection"){let d=l.child(0),h=c+1+d.nodeSize,g=Math.min(a.doc.content.size,h+2);i&&(a=a.setSelection(i.create(a.doc,g)))}}catch{}o.dispatch(a.scrollIntoView());try{let c=typeof CSS<"u"&&CSS.escape?CSS.escape(n):n.replace(/"/g,'\\"');window.requestAnimationFrame(()=>{try{let l=o.dom?.querySelector?.(`[data-outline-section][data-section-id="${c}"]`)||o.dom?.querySelector?.(`[data-section-id="${c}"]`);l&&typeof l.scrollIntoView=="function"&&l.scrollIntoView({block:"center",inline:"nearest"})}catch{}})}catch{}if(t&&t.focus)try{o.focus()}catch{}return!0}catch{return!1}}function im(e,t){if(!se)return!1;let n=String(e||"");if(!n)return!1;let r=it(se.state.doc,n);if(typeof r!="number")return!1;let o=se.state.doc.nodeAt(r);if(!o)return!1;let i=se.state.doc.type.schema,s=_n(String(t||"")),a=ea(s.titleHtml||"")||ea(s.bodyHtml||"").slice(0,80)||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",c=Ao?Ao(s.bodyHtml||""):[],l=[];for(let f of c||[])try{l.push(i.nodeFromJSON(f))}catch{}l.length||l.push(i.nodes.paragraph.create({},[]));let d=i.nodes.outlineHeading.create({},a?[i.text(a)]:[]),h=i.nodes.outlineBody.create({},l),g=o.child(2),w=i.nodes.outlineSection.create(o.attrs,[d,h,g]),S=se.state.tr.replaceWith(r,r+o.nodeSize,w);try{let f=ze?.pmStateMod?.TextSelection;f&&(S=S.setSelection(f.create(S.doc,r+2)))}catch{}return se.view.dispatch(S),se.view.focus(),Jt=!0,Vt({delayMs:200}),!0}function sm(e,t){if(!se)return!1;let n=String(e||"");if(!n)return!1;let r=it(se.state.doc,n);if(typeof r!="number")return!1;let o=se.state.doc.nodeAt(r);if(!o)return!1;let i=t&&typeof t=="object"?t:{},s=se.state.doc.type.schema,a=null,c=null;try{i.heading&&typeof i.heading=="object"&&(a=s.nodeFromJSON(i.heading))}catch{a=null}try{i.body&&typeof i.body=="object"&&(c=s.nodeFromJSON(i.body))}catch{c=null}(!a||a.type?.name!=="outlineHeading")&&(a=s.nodes.outlineHeading.create({},[])),(!c||c.type?.name!=="outlineBody")&&(c=s.nodes.outlineBody.create({},[s.nodes.paragraph.create({},[])])),c.childCount||(c=s.nodes.outlineBody.create({},[s.nodes.paragraph.create({},[])]));let l=o.child(2),d=s.nodes.outlineSection.create(o.attrs,[a,c,l]),h=se.state.tr.replaceWith(r,r+o.nodeSize,d);try{let g=ze?.pmStateMod?.TextSelection;g&&(h=h.setSelection(g.create(h.doc,r+2)))}catch{}return se.view.dispatch(h),se.view.focus(),Jt=!0,Vt({delayMs:200}),!0}function am(e,t){if(!se)return!1;let n=String(e||"").trim();if(!n||typeof it(se.state.doc,n)=="number")return!1;let o=t&&typeof t=="object"?t:{},i=se.state.doc.type.schema,s=null,a=null;try{o.heading&&typeof o.heading=="object"&&(s=i.nodeFromJSON(o.heading))}catch{s=null}try{o.body&&typeof o.body=="object"&&(a=i.nodeFromJSON(o.body))}catch{a=null}(!s||s.type?.name!=="outlineHeading")&&(s=i.nodes.outlineHeading.create({},[])),(!a||a.type?.name!=="outlineBody")&&(a=i.nodes.outlineBody.create({},[i.nodes.paragraph.create({},[])])),a.childCount||(a=i.nodes.outlineBody.create({},[i.nodes.paragraph.create({},[])]));let c=i.nodes.outlineChildren.create({},[]),l=i.nodes.outlineSection.create({id:n,collapsed:!1},[s,a,c]),d=se.state.doc.content.size,h=se.state.tr.insert(d,l);try{let g=ze?.pmStateMod?.TextSelection;if(g){let w=Math.min(h.doc.content.size,d+2);h=h.setSelection(g.near(h.doc.resolve(Math.max(0,w)),1))}}catch{}return h=h.setMeta(de,!0),se.view.dispatch(h.scrollIntoView()),se.view.focus(),Jt=!0,Vt({delayMs:200}),!0}function cm({enterEditMode:e=!0}={}){if(!se)return null;let t=se.state.doc.type.schema,n=se.state.doc.content.size,r=$t(),o=t.nodes.outlineSection.create({id:r,collapsed:!1},[t.nodes.outlineHeading.create({},[]),t.nodes.outlineBody.create({},[t.nodes.paragraph.create({},[])]),t.nodes.outlineChildren.create({},[])]),i=se.state.tr.insert(n,o);try{let s=ze?.pmStateMod?.TextSelection;if(s){let a=it(i.doc,r),c=typeof a=="number"?Ei(i.doc,a):null;typeof c=="number"?i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,c+2)),1)):i=i.setSelection(s.create(i.doc,n+2))}}catch{}return i=i.setMeta(de,!0),e&&Ae&&(i=i.setMeta(Ae,{type:"enter",sectionId:r})),se.view.dispatch(i.scrollIntoView()),se.view.focus(),Jt=!0,Vt({delayMs:200}),r}function Ei(e,t){try{let n=e.nodeAt(t);if(!n||n.type?.name!=="outlineSection")return null;let r=n.child(0);return t+1+r.nodeSize}catch{return null}}function lm(e,{focusBody:t=!0}={}){if(!se||!Ae)return!1;let n=String(e||"").trim();if(!n)return!1;let r=it(se.state.doc,n);if(typeof r!="number"||se.state.doc.nodeAt(r)?.attrs?.collapsed)return!1;let i=se.state.tr;if(t)try{let s=ze?.pmStateMod?.TextSelection,a=Ei(i.doc,r);s&&typeof a=="number"&&(i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,a+2)),1)))}catch{}return i=i.setMeta(de,!0),i=i.setMeta(Ae,{type:"enter",sectionId:n}),se.view.dispatch(i.scrollIntoView()),se.view.focus(),!0}function dm({enterEditMode:e=!0}={}){if(!se)return null;let t=se.state.doc.type.schema,n=0,r=$t(),o=t.nodes.outlineSection.create({id:r,collapsed:!1},[t.nodes.outlineHeading.create({},[]),t.nodes.outlineBody.create({},[t.nodes.paragraph.create({},[])]),t.nodes.outlineChildren.create({},[])]),i=se.state.tr.insert(n,o);try{let s=ze?.pmStateMod?.TextSelection;if(s){let a=it(i.doc,r),c=typeof a=="number"?Ei(i.doc,a):null;typeof c=="number"?i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,c+2)),1)):i=i.setSelection(s.create(i.doc,n+2))}}catch{}return i=i.setMeta(de,!0),e&&Ae&&(i=i.setMeta(Ae,{type:"enter",sectionId:r})),se.view.dispatch(i.scrollIntoView()),se.view.focus(),Jt=!0,Vt({delayMs:200}),r}function um(e,t,{enterEditMode:n=!1}={}){if(!se)return!1;let r=String(e||"").trim();if(!r||typeof it(se.state.doc,r)=="number")return!1;let i=se.state.doc.type.schema,s=i.nodes.paragraph,a=i.nodes.hardBreak||i.nodes.hard_break||null,c=String(t||"").replace(/\r\n/g,`
`).trimEnd(),l=()=>{if(!s)return[];if(!c.trim())return[s.create({},[])];let p=c.split(/\n{2,}/),y=[];for(let k of p){let E=String(k||"").split(`
`),L=[];for(let O=0;O<E.length;O+=1){let z=E[O];O>0&&a&&L.push(a.create()),z&&L.push(i.text(z))}y.push(s.create({},L))}return y.length?y:[s.create({},[])]},d=i.nodes.outlineHeading.create({},[]),h=i.nodes.outlineBody.create({},l()),g=i.nodes.outlineChildren.create({},[]),w=i.nodes.outlineSection.create({id:r,collapsed:!1},[d,h,g]),S=0,f=se.state.tr.insert(S,w);try{let p=ze?.pmStateMod?.TextSelection;if(p){let y=it(f.doc,r),k=typeof y=="number"?Ei(f.doc,y):null;typeof k=="number"?f=f.setSelection(p.near(f.doc.resolve(Math.min(f.doc.content.size,k+2)),1)):f=f.setSelection(p.create(f.doc,S+2))}}catch{}return f=f.setMeta(de,!0),n&&Ae&&(f=f.setMeta(Ae,{type:"enter",sectionId:r})),se.view.dispatch(f.scrollIntoView()),se.view.focus(),Jt=!0,Vt({delayMs:200}),!0}async function fm(){if(u.isPublicView||u.isRagView){Ee("Outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0432 \u044D\u0442\u043E\u043C \u0440\u0435\u0436\u0438\u043C\u0435");return}if(!u.articleId||!u.article){Ee("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}if(St=u.articleId,!J.outlineEditor||!J.blocksContainer){Ee("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440");return}u.isOutlineEditing=!0,J.articleToolbar&&J.articleToolbar.classList.add("hidden"),J.outlineToolbar&&J.outlineToolbar.classList.remove("hidden"),J.outlineTagsBar&&J.outlineTagsBar.classList.remove("hidden"),J.outlineEditor.classList.remove("hidden"),J.blocksContainer.classList.add("hidden"),cd({loading:!0});try{ot("outline.open",{articleId:St,updatedAt:u.article?.updatedAt||null,docHash:Bt(u.article?.docJson||null)})}catch{}try{if(!u.scrollTargetBlockId&&St){let e=jp(St);e?.sectionId&&(u.currentBlockId=e.sectionId)}}catch{}try{await Sd();try{Rp(se)}catch{}try{let t=u.scrollTargetBlockId||null;t&&(xd(t,{focus:!1}),u.scrollTargetBlockId=null,u.currentBlockId=t)}catch{}try{let t=u.currentBlockId||null;t&&(Up(se,t),qp(se,t,{block:"center"}))}catch{}let e=J.outlineEditor.querySelector(".outline-editor__loading");if(e&&e.classList.add("hidden"),zn("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u0442\u0441\u044F \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438"),Ll||(Ll=!0,window.addEventListener("online",()=>{if(u.isOutlineEditing){try{Ql(St||u.articleId)}catch{}So({force:!0})}}),window.addEventListener("blur",()=>{u.isOutlineEditing&&So({force:!0})}),document.addEventListener("visibilitychange",()=>{u.isOutlineEditing&&document.visibilityState!=="visible"&&So({force:!0})})),!bo){let t=r=>{if(!u.isOutlineEditing)return;let o=r?.dataTransfer;if(!(o&&(o.files&&o.files.length||o.items&&o.items.length)))return;let s=r?.target;J.outlineEditor&&s&&J.outlineEditor.contains(s)||r.preventDefault()},n=r=>{if(!u.isOutlineEditing)return;let o=r?.dataTransfer;if(!(o&&o.files&&o.files.length))return;let s=r?.target;J.outlineEditor&&s&&J.outlineEditor.contains(s)||(r.preventDefault(),r.stopPropagation())};window.addEventListener("dragover",t,{passive:!1}),window.addEventListener("drop",n,{passive:!1}),bo=()=>{window.removeEventListener("dragover",t),window.removeEventListener("drop",n),bo=null}}}catch(e){Ee(e?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440"),Ad()}}function Ad(){u.isOutlineEditing=!1,Hp(),Ae=null,St=null,tr=null,xi=null,xr={counts:new Map,labelByKey:new Map,sectionIdsByKey:new Map,sectionPosById:new Map};try{J.outlineTagsBar&&(J.outlineTagsBar.innerHTML="",J.outlineTagsBar.classList.add("hidden"))}catch{}yo(!1),bo&&bo(),J.outlineToolbar&&J.outlineToolbar.classList.add("hidden"),J.articleToolbar&&J.articleToolbar.classList.remove("hidden"),Dn&&(clearTimeout(Dn),Dn=null),Nt&&(clearTimeout(Nt),Nt=null),mr&&(clearTimeout(mr),mr=null),Ws=null,Cn=!1,gi="";try{fn.clear()}catch{}pi=!1,Sr.clear();try{Fr.clear()}catch{}wr.clear(),Zt=null,Jt=!1;try{for(let[,e]of wo)try{clearTimeout(e)}catch{}wo.clear()}catch{}try{for(let[,e]of br)try{URL.revokeObjectURL(e)}catch{}br.clear()}catch{}if(se){try{se.destroy()}catch{}se=null}ze=null,J.outlineEditor&&J.outlineEditor.classList.add("hidden"),J.blocksContainer&&J.blocksContainer.classList.remove("hidden")}async function pm(e={}){let t=e&&typeof e.mode=="string"?e.mode:"network",n=e&&typeof e.timeoutMs=="number"?Math.max(0,Math.floor(e.timeoutMs)):0;if(!se)return;Dn&&(clearTimeout(Dn),Dn=null);try{let o=St||u.articleId;if(o&&!u.article?.encrypted){let i=se.getJSON();if(i&&typeof i=="object")try{await nn(o,i,u.article?.updatedAt||null)}catch{}try{try{let s=Ae?.getState?.(se?.state)||null,a=String(s?.editingSectionId||"").trim();a&&await ra({articleId:o,doc:se.state.doc,sectionId:a,reason:"pagehide"})}catch{}if(Cn){let s=Io(se.state.doc);s.length&&(zt("structure_snapshot",{articleId:o,payload:{nodes:s},coalesceKey:`structure:${o}`}),Cn=!1)}}catch{}try{if(fn.size){let s=Array.from(fn);fn.clear();let a=Date.now();await zt("delete_sections",{articleId:o,payload:{sectionIds:s,clientQueuedAt:a},coalesceKey:`delete:${o}:${a}`})}}catch{}}}catch{}if(t==="queue")return;let r=So({force:!0,silent:!0});if(n>0){await Promise.race([r,new Promise(o=>setTimeout(o,n))]);return}await r}async function mm({docJson:e}={}){if(J.outlineEditor){if(!e||typeof e!="object"){Ee("\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F: \u043D\u0435\u0442 \u0434\u043E\u043A\u0443\u043C\u0435\u043D\u0442\u0430");return}u.isPublicView=!0,u.isRagView=!1,u.isOutlineEditing=!1,u.articleId=null,u.article={docJson:e,encrypted:!1};try{J.outlineEditor.classList.add("outline-editor")}catch{}J.outlineEditor.classList.remove("hidden"),J.outlineEditor.querySelector("#outlineEditorContent")||cd({loading:!0});try{await Sd();let t=J.outlineEditor.querySelector(".outline-editor__loading");t&&t.classList.add("hidden"),zn("\u0422\u043E\u043B\u044C\u043A\u043E \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440")}catch(t){Ee(t?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E")}}}var Ml,ze,se,mo,Dn,pi,mr,Ws,qs,Xl,Zt,br,wr,Sr,Fr,Jt,Ll,Ao,Ys,Xs,mt,fr,Vs,np,ho,go,mi,Ae,bo,St,tr,xi,xr,Fn,nr,rp,ui,Gs,bi,op,wo,Dl,wi,Cn,gi,Nt,fn,js,de,Rl,mp,hp,gp,fi,hm,gm,Ke,Qo=je(()=>{bt();ln();Ft();En();Jn();Wt();Qr();cr();Jr();jr();Sl();jn();xl();Il();Vr();Ml=!1,ze=null,se=null,mo=null,Dn=null,pi=!1,mr=null,Ws=null,qs=0,Xl=null,Zt=null,br=new Map,wr=new Map,Sr=new Set,Fr=new Set,Jt=!1,Ll=!1,Ao=null,Ys=null,Xs=null,mt={TableMap:null,CellSelection:null,moveTableColumn:null,moveTableRow:null,addRowBefore:null,addRowAfter:null,deleteRow:null,addColumnBefore:null,addColumnAfter:null,deleteColumn:null,toggleHeaderRow:null,toggleHeaderColumn:null},fr=!1,Vs=new Map,np=30*1e3,ho=new Map,go=new Map,mi=null,Ae=null,bo=null,St=null,tr=null,xi=null,xr={counts:new Map,labelByKey:new Map,sectionIdsByKey:new Map,sectionPosById:new Map},Fn=!1,nr=new Set,rp=650,ui={articleId:null,sectionId:null,collapsed:null},Gs="ttree_outline_section_clipboard_v1",bi="pending-attachment:",op=2e3,wo=new Map;Dl="ttree_outline_section_seq_v1",wi=262144;Cn=!1,gi="",Nt=null,fn=new Set,js=null;de="outlineAllowMutation",Rl=0,mp="ttree_outline_debug_md_table";hp="ttree_profile_v1";gp="ttree_outline_debug_proofread_v1";fi=null;hm="ttree_debug_outline_keys_v1",gm=()=>{try{return window?.localStorage?.getItem?.(hm)==="1"}catch{return!1}},Ke=(e,t={})=>{gm()}});(()=>{let e=window.__memusAppModule||"/app.js",t="ttree_boot_session_v1",n="ttree_last_user_v1",r="ttree_last_active_at_v1",o=200,i=900*1e3,s=2500,a="ttree_debug_quick_notes_v1",c="ttree_offline_known_user_keys_v1",l="memus_offline_v1_",d="ttree_offline_recovery_force_index_v1",h="ttree_boot_open_offline_requested_v1",g=!1;try{g=window.sessionStorage?.getItem?.(h)==="1",g&&window.sessionStorage?.removeItem?.(h)}catch{}function w(){try{return window?.localStorage?.getItem?.(a)==="1"}catch{return!1}}function S(...m){try{if(!w())return;console.log("[quick-notes][boot]",...m)}catch{}}function f(...m){try{console.log("[quick-notes][recovery]",...m)}catch{}}function p(...m){try{console.error("[quick-notes][recovery]",...m)}catch{}}function y(){if("serviceWorker"in navigator)try{navigator.serviceWorker.register("/uploads-sw.js",{scope:"/",updateViaCache:"none"}).then(m=>{try{m&&m.waiting&&m.waiting.postMessage({type:"memus:skipWaiting"}),m?.addEventListener?.("updatefound",()=>{try{let v=m.installing;if(!v)return;v.addEventListener("statechange",()=>{if(v.state==="installed"&&navigator.serviceWorker.controller)try{m.waiting?.postMessage?.({type:"memus:skipWaiting"})}catch{}})}catch{}})}catch{}try{let v=m?.update?.();v&&typeof v.catch=="function"&&v.catch(()=>{})}catch{}}).catch(()=>{});try{let m=!!navigator.serviceWorker.controller,v=L(),C=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{if(!C&&(C=!0,!g&&m&&!v))try{window.location.reload()}catch{}})}catch{}}catch{}}function k(){try{return String(window.location.pathname||"").startsWith("/p/")}catch{return!1}}function E(){try{return!!(typeof navigator<"u"&&navigator&&navigator.onLine===!1)}catch{return!1}}function L(){try{let m=performance.getEntriesByType?.("navigation")||[],v=m&&m[0];return String(v?.type||"")==="reload"}catch{return!1}}function O(){try{let m=window.localStorage.getItem(r)||"",v=Number(m);return Number.isFinite(v)?v:0}catch{return 0}}function z(){try{window.localStorage.setItem(r,String(Date.now()))}catch{}}function q(){let m=O();return m?Date.now()-m>i:!0}function $(){try{return window.sessionStorage.getItem(t)?!1:(window.sessionStorage.setItem(t,"1"),!0)}catch{return!0}}function Q(){try{let m=window.localStorage.getItem(n);if(!m)return!1;let v=JSON.parse(m);return!!(v&&(v.id||v.username))}catch{return!1}}function W(){try{if(globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function")return globalThis.crypto.randomUUID()}catch{}return`id-${Date.now()}-${Math.random().toString(16).slice(2)}`}function re(){return new Date().toISOString()}function we(){try{let m=window.localStorage.getItem(c)||"[]",v=JSON.parse(m);return Array.isArray(v)?v.filter(Boolean).map(String):[]}catch{return[]}}async function Ne(){try{if(!("indexedDB"in window))return[];if(typeof indexedDB.databases=="function"){let C=(await indexedDB.databases()||[]).map(M=>M&&M.name).filter(Boolean).filter(M=>String(M).startsWith(l)).map(M=>String(M).slice(l.length)).filter(Boolean);return Array.from(new Set(C))}}catch{}return Array.from(new Set(we()))}function Z(m,v){return new Promise((C,D)=>{try{let M=v?indexedDB.open(m,v):indexedDB.open(m);v&&(M.onupgradeneeded=()=>{try{let N=M.result;if(N.objectStoreNames.contains("meta")||N.createObjectStore("meta",{keyPath:"key"}),!N.objectStoreNames.contains("articles")){let P=N.createObjectStore("articles",{keyPath:"id"});P.createIndex("byUpdatedAt","updatedAt",{unique:!1}),P.createIndex("byDeletedAt","deletedAt",{unique:!1})}if(!N.objectStoreNames.contains("outline_sections")){let P=N.createObjectStore("outline_sections",{keyPath:"sectionId"});P.createIndex("byArticleId","articleId",{unique:!1}),P.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!N.objectStoreNames.contains("section_embeddings")){let P=N.createObjectStore("section_embeddings",{keyPath:"sectionId"});P.createIndex("byArticleId","articleId",{unique:!1}),P.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!N.objectStoreNames.contains("media_assets")){let P=N.createObjectStore("media_assets",{keyPath:"url"});P.createIndex("byStatus","status",{unique:!1}),P.createIndex("byFetchedAtMs","fetchedAtMs",{unique:!1}),P.createIndex("byStatusFetchedAtMs",["status","fetchedAtMs"],{unique:!1})}if(!N.objectStoreNames.contains("media_refs")){let P=N.createObjectStore("media_refs",{keyPath:"key"});P.createIndex("byArticleId","articleId",{unique:!1}),P.createIndex("byUrl","url",{unique:!1})}if(N.objectStoreNames.contains("outbox"))try{let T=M.transaction.objectStore("outbox");T.indexNames.contains("byTypeCoalesceKey")||T.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}catch{}else{let P=N.createObjectStore("outbox",{keyPath:"id"});P.createIndex("byCreatedAtMs","createdAtMs",{unique:!1}),P.createIndex("byTypeArticleId",["type","articleId"],{unique:!1}),P.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}if(!N.objectStoreNames.contains("pending_uploads")){let P=N.createObjectStore("pending_uploads",{keyPath:"token"});P.createIndex("byArticleId","articleId",{unique:!1}),P.createIndex("byCreatedAtMs","createdAtMs",{unique:!1})}}catch{}}),M.onsuccess=()=>C(M.result),M.onerror=()=>{let N=M.error||new Error("IndexedDB open failed");p("idb.open.error",{name:m,version:v||null,message:String(N?.message||N)}),D(N)}}catch(M){p("idb.open.throw",{name:m,version:v||null,message:String(M?.message||M)}),D(M)}})}function pe(m,v){return new Promise((C,D)=>{try{let P=m.transaction([v],"readonly").objectStore(v).getAll();P.onsuccess=()=>C(Array.isArray(P.result)?P.result:[]),P.onerror=()=>{let T=P.error||new Error("IndexedDB getAll failed");p("idb.getAll.error",{storeName:v,message:String(T?.message||T)}),D(T)}}catch(M){p("idb.getAll.throw",{storeName:v,message:String(M?.message||M)}),D(M)}})}function We(m,v){return new Promise((C,D)=>{try{let P=m.transaction([v],"readonly").objectStore(v).count();P.onsuccess=()=>C(Number(P.result||0)),P.onerror=()=>{let T=P.error||new Error("IndexedDB count failed");p("idb.count.error",{storeName:v,message:String(T?.message||T)}),D(T)}}catch(M){p("idb.count.throw",{storeName:v,message:String(M?.message||M)}),D(M)}})}function yt(m,v){try{let C=JSON.stringify(v),D=new Blob([C],{type:"application/json;charset=utf-8"}),M=URL.createObjectURL(D),N=document.createElement("a");return N.href=M,N.download=m,N.rel="noopener",document.body.appendChild(N),N.click(),setTimeout(()=>{try{N.remove(),URL.revokeObjectURL(M)}catch{}},0),!0}catch{return!1}}function kt(m,v){try{let C=URL.createObjectURL(v),D=document.createElement("a");return D.href=C,D.download=m,D.rel="noopener",document.body.appendChild(D),D.click(),setTimeout(()=>{try{D.remove(),URL.revokeObjectURL(C)}catch{}},0),!0}catch{return!1}}async function jt(m,{method:v="GET",body:C=null,timeoutMs:D=2e4}={}){let M=typeof AbortController<"u"?new AbortController:null,N={method:v,credentials:"include",headers:{},signal:M?.signal};C!==null&&(N.headers["Content-Type"]="application/json",N.body=JSON.stringify(C));let P=null,T=!1;M&&typeof D=="number"&&D>0&&(P=setTimeout(()=>{try{T=!0;try{M.abort(new Error(`timeout after ${D}ms`))}catch{M.abort()}}catch{}},D));let x;try{x=await fetch(m,N)}finally{P&&clearTimeout(P)}let I=await x.text().catch(()=>""),b=null;try{b=I?JSON.parse(I):null}catch{b=null}if(!x.ok){let B=b&&(b.detail||b.error)||I||`${x.status} ${x.statusText}`,_=new Error(B);throw _.status=x.status,_.payload=b,_}return b}async function en(m,v){try{return await jt(m,v)}catch(C){if(String(C?.name||"")==="AbortError"||String(C?.message||"").toLowerCase().includes("aborted")){let M=typeof v?.timeoutMs=="number"?v.timeoutMs:null,N=new Error(M?`timeout after ${M}ms`:"request aborted");throw N.name="TimeoutError",N}throw C}}function cn(m){try{return m?JSON.parse(m):null}catch{return null}}function yn(m){let v=String(m||"");return!!(!v||v==="inbox"||v.startsWith("inbox-"))}async function Bn({userKey:m,onProgress:v}){let C=String(m||"").trim();if(!C)throw new Error("No userKey");let D=await Z(`${l}${C}`).catch(R=>{throw p("restore.server.idb.open.error",{userKey:C,message:String(R?.message||R)}),R}),M=await pe(D,"articles").catch(R=>{throw p("restore.server.idb.read.error",{userKey:C,message:String(R?.message||R)}),R});try{D.close()}catch{}let N=(Array.isArray(M)?M:[]).filter(R=>R&&!R.deletedAt&&!yn(R.id)).map(R=>{let F=cn(R.articleJsonStr)||{},V=cn(R.docJsonStr)||F.docJson||null;return{id:String(R.id),title:(R.title||F.title||"").toString(),parentId:R.parentId??F.parentId??null,position:typeof R.position=="number"?R.position:typeof F.position=="number"?F.position:0,docJson:V&&typeof V=="object"?V:null}}).filter(R=>R.id&&R.docJson),P=N.length,T={n:0},x={n:0},I={n:0},b=(R,F={})=>{try{v?.({phase:R,total:P,created:T.n,saved:x.n,moved:I.n,...F})}catch{}};b("start");for(let R=0;R<N.length;R+=1){let F=N[R];b("content",{idx:R+1,articleId:F.id,title:F.title});try{f("restore.server.create.start",{idx:R+1,id:F.id}),await en("/api/articles",{method:"POST",body:{id:F.id,title:F.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"},timeoutMs:15e3}),T.n+=1,f("restore.server.create.done",{idx:R+1,id:F.id})}catch(V){f("restore.server.create.skip",{idx:R+1,id:F.id,status:V?.status||null,message:String(V?.message||V)})}try{f("restore.server.save.start",{idx:R+1,id:F.id}),await en(`/api/articles/${encodeURIComponent(F.id)}/doc-json`,{method:"PUT",body:{docJson:F.docJson},timeoutMs:3e4}),x.n+=1,f("restore.server.save.done",{idx:R+1,id:F.id})}catch(V){p("restore.server.save.error",{idx:R+1,id:F.id,status:V?.status||null,message:String(V?.message||V),stack:String(V?.stack||"")})}}let B=new Map;for(let R of N){let F=R.parentId||null;B.has(F)||B.set(F,[]),B.get(F).push(R)}for(let[R,F]of B.entries())F.sort((V,j)=>Number(V.position||0)-Number(j.position||0)),B.set(R,F);let _=[null],H=new Set;for(b("structure");_.length;){let R=_.shift(),F=R||"__root__";if(H.has(F))continue;H.add(F);let V=B.get(R||null)||[];for(let j of V){b("structure",{articleId:j.id,title:j.title});try{await jt(`/api/articles/${encodeURIComponent(j.id)}/move-tree`,{method:"POST",body:{parentId:R||null,anchorId:null,placement:"inside"}}),I.n+=1}catch(X){f("restore.server.move.skip",{id:j.id,status:X?.status||null,message:String(X?.message||X)})}B.has(j.id)&&_.push(j.id)}}return b("done"),{total:P,created:T.n,saved:x.n,moved:I.n}}function Nn(m){let v=new TextEncoder,C=Object.entries(m?.stores||{}),D={type:"meta",exportedAt:m?.exportedAt||re(),sourceUserKey:m?.sourceUserKey||null,dbName:m?.dbName||null,format:"ndjson.v1"},M=!1,N=0,P=-1;return new ReadableStream({pull(T){try{if(!M){M=!0,T.enqueue(v.encode(`${JSON.stringify(D)}
`));return}for(;N<C.length;){let[x,I]=C[N],b=Array.isArray(I)?I:[];if(P===-1){P=0,T.enqueue(v.encode(`${JSON.stringify({type:"store",store:x,count:b.length})}
`));return}if(P>=b.length){N+=1,P=-1;continue}let B={type:"item",store:x,value:b[P]};P+=1,T.enqueue(v.encode(`${JSON.stringify(B)}
`));return}T.close()}catch(x){p("ndjson.stream.error",{message:String(x?.message||x),stack:String(x?.stack||"")}),T.error(x)}}})}async function bn(m,v){let C=Nn(v),D=typeof CompressionStream<"u",M=D?C.pipeThrough(new CompressionStream("gzip")):C,N=await new Response(M).blob(),P=D?`${m}.ndjson.gz`:`${m}.ndjson`;if(kt(P,N))return{ok:!0,method:"download",filename:P};try{let T=URL.createObjectURL(N);try{window.open(T,"_blank","noopener")}catch{window.location.href=T}return{ok:!0,method:"open",filename:P}}catch(T){p("export.open.error",{filename:P,message:String(T?.message||T),stack:String(T?.stack||"")})}return{ok:!1,method:"none",filename:P}}function wn(){try{let m=window.localStorage.getItem(n)||"",v=m?JSON.parse(m):null;return v?.id||v?.username||""}catch{return""}}async function vt(m){let v=String(m||"").trim();if(!v)throw new Error("No userKey");let C=`${l}${v}`,D=await Z(C,3),M=["articles","outline_sections","media_assets","media_refs","outbox","pending_uploads","section_embeddings","meta"].filter(P=>{try{return D.objectStoreNames.contains(P)}catch{return!1}}),N={exportedAt:re(),sourceUserKey:v,dbName:C,stores:{}};for(let P of M)N.stores[P]=await pe(D,P).catch(T=>(p("export.store.read.error",{userKey:v,store:P,message:String(T?.message||T)}),[]));try{D.close()}catch{}return N}async function Lt(m,v){let C=String(v||"").trim();if(!C)throw new Error("No target userKey");if(!m||typeof m!="object"||!m.stores||typeof m.stores!="object")throw new Error("Invalid dump");let D=`${l}${C}`,M=await Z(D,3),N=async(T,x)=>{if(!M.objectStoreNames.contains(T))return 0;let I=Array.isArray(x)?x:[];if(!I.length)return 0;let b=M.transaction([T],"readwrite"),B=b.objectStore(T),_=0;return await new Promise((H,R)=>{b.oncomplete=()=>H(),b.onerror=()=>{let F=b.error||new Error("tx failed");p("import.tx.error",{storeName:T,message:String(F?.message||F)}),R(F)},b.onabort=()=>{let F=b.error||new Error("tx aborted");p("import.tx.abort",{storeName:T,message:String(F?.message||F)}),R(F)};for(let F of I)try{B.put(F),_+=1}catch{}}),_},P=0;P+=await N("articles",m.stores.articles),P+=await N("outline_sections",m.stores.outline_sections),P+=await N("media_assets",m.stores.media_assets),P+=await N("media_refs",m.stores.media_refs),P+=await N("pending_uploads",m.stores.pending_uploads),P+=await N("section_embeddings",m.stores.section_embeddings);try{M.close()}catch{}return P}let dt="ttree_pending_quick_notes_v1";function rt(){try{let m=window.localStorage.getItem(dt)||"";if(!m)return[];let v=JSON.parse(m);return Array.isArray(v)?v.filter(Boolean):[]}catch{return[]}}function ht(m){try{window.localStorage.setItem(dt,JSON.stringify(Array.isArray(m)?m:[]))}catch{}}function Kt(m){let v=String(m||"").trim();if(!v)return null;let C=W(),D={id:C,sectionId:C,createdAt:re(),text:v},M=rt(),N=[D,...M].slice(0,o);return ht(N),S("saved.pending",{id:D.id,len:N.length}),D}function G(){if(document.getElementById("quickNoteBootStyles"))return;let m=document.createElement("style");m.id="quickNoteBootStyles",m.textContent=`
      .boot-modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:99999;display:flex;align-items:center;justify-content:center;padding:16px}
      .boot-modal{width:min(720px,100%);background:#0b1220;border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 24px 80px rgba(0,0,0,.5);color:#e5e7eb}
      .boot-modal__hdr{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between;gap:12px}
      .boot-modal__title{font-size:14px;font-weight:600;letter-spacing:.2px}
      .boot-modal__meta{font-size:12px;color:#9ca3af}
      .boot-modal__body{padding:12px 16px}
      .boot-note{width:100%;min-height:34vh;max-height:52vh;resize:vertical;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px 12px;font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;outline:none}
      .boot-note:focus{border-color:rgba(59,130,246,.6);box-shadow:0 0 0 3px rgba(59,130,246,.25)}
      .boot-modal__ftr{padding:12px 16px;border-top:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
      .boot-actions{display:flex;gap:10px;flex-wrap:wrap}
      .boot-btn{appearance:none;border:1px solid rgba(255,255,255,.14);background:#111827;color:#e5e7eb;border-radius:999px;padding:10px 14px;font:600 13px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;cursor:pointer}
      .boot-btn:hover{background:#0f172a}
      .boot-btn--primary{background:#2563eb;border-color:#2563eb}
      .boot-btn--primary:hover{background:#1d4ed8}
      .boot-btn--ghost{background:transparent}
      .boot-hint{font-size:12px;color:#9ca3af}
      .boot-toast{margin-left:auto;font-size:12px;color:#a7f3d0}
    `,document.head.appendChild(m)}function ce(m,{timeout:v=5e3,fallbackDelay:C=1200}={}){try{if(typeof requestIdleCallback=="function"){requestIdleCallback(()=>m(),{timeout:v});return}}catch{}setTimeout(()=>m(),C)}function me(){ce(()=>{try{import(e).catch(()=>{})}catch{}})}function le({reason:m=""}={}){G();let v=document.createElement("div");v.className="boot-modal-backdrop";let C=document.createElement("div");C.className="boot-modal";let D=document.createElement("div");D.className="boot-modal__hdr";let M=document.createElement("div"),N=document.createElement("div");N.className="boot-modal__title",N.textContent="\u0411\u044B\u0441\u0442\u0440\u0430\u044F \u0437\u0430\u043C\u0435\u0442\u043A\u0430 (\u043E\u0444\u0444\u043B\u0430\u0439\u043D-\u0431\u0443\u0444\u0435\u0440)";let P=document.createElement("div");P.className="boot-modal__meta";let T=rt().length;P.textContent=T?`\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438: ${T}`:m?`\u041F\u0440\u0438\u0447\u0438\u043D\u0430: ${m}`:"\u041C\u043E\u0436\u043D\u043E \u0431\u0435\u0437 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430 \u0438 \u0431\u0435\u0437 \u0432\u0445\u043E\u0434\u0430",M.appendChild(N),M.appendChild(P);let x=document.createElement("button");x.type="button",x.className="boot-btn boot-btn--ghost",x.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",D.appendChild(M),D.appendChild(x);let I=document.createElement("div");I.className="boot-modal__body";let b=document.createElement("textarea");b.className="boot-note",b.placeholder=`\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0443\u2026

Ctrl+Enter \u2014 \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C
Esc \u2014 \u0437\u0430\u043A\u0440\u044B\u0442\u044C`,I.appendChild(b);let B=document.createElement("div");B.className="boot-modal__ftr";let _=document.createElement("div");_.className="boot-hint",_.textContent="\u0417\u0430\u043C\u0435\u0442\u043A\u0438 \u0441\u043E\u0445\u0440\u0430\u043D\u044F\u044E\u0442\u0441\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E \u0438 \u0431\u0443\u0434\u0443\u0442 \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u044B \u0432 \u201C\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438\u201D \u043F\u0440\u0438 \u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0435\u043C \u0432\u0445\u043E\u0434\u0435.";let H=document.createElement("div");H.className="boot-actions";let R=document.createElement("button");R.type="button",R.className="boot-btn boot-btn--primary",R.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C";let F=document.createElement("button");F.type="button",F.className="boot-btn",F.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0438 \u0435\u0449\u0451",H.appendChild(R),H.appendChild(F);let V=document.createElement("div");V.className="boot-toast",B.appendChild(_),B.appendChild(H),B.appendChild(V),C.appendChild(D),C.appendChild(I),C.appendChild(B),v.appendChild(C);let j=()=>{let oe=rt().length;P.textContent=oe?`\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438: ${oe}`:m?`\u041F\u0440\u0438\u0447\u0438\u043D\u0430: ${m}`:"\u041C\u043E\u0436\u043D\u043E \u0431\u0435\u0437 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430 \u0438 \u0431\u0435\u0437 \u0432\u0445\u043E\u0434\u0430"},X=()=>{try{v.remove()}catch{}},te=oe=>{let ge=Kt(b.value);if(ge){b.value="",V.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E",j(),z();try{window.dispatchEvent(new CustomEvent("memus:queued-inbox-changed",{detail:{note:ge}})),S("event.dispatched",{type:"memus:queued-inbox-changed"})}catch{}oe||X(),setTimeout(()=>{try{V.textContent=""}catch{}},1200)}};x.addEventListener("click",X),v.addEventListener("click",oe=>{oe.target===v&&X()}),R.addEventListener("click",()=>te(!1)),F.addEventListener("click",()=>te(!0)),b.addEventListener("keydown",oe=>{if(oe.key==="Escape"){oe.preventDefault(),X();return}oe.key==="Enter"&&(oe.ctrlKey||oe.metaKey)&&(oe.preventDefault(),te(!0))});let he=async()=>{G();let oe=document.createElement("div");oe.className="boot-modal-backdrop";let ge=document.createElement("div");ge.className="boot-modal";let Me=document.createElement("div");Me.className="boot-modal__hdr";let $e=document.createElement("div"),Je=document.createElement("div");Je.className="boot-modal__title",Je.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0445 \u0434\u0430\u043D\u043D\u044B\u0445";let Oe=document.createElement("div");Oe.className="boot-modal__meta",Oe.textContent="\u0418\u0449\u0435\u043C \u0441\u0442\u0430\u0440\u044B\u0435 \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0435 \u0431\u0430\u0437\u044B\u2026",$e.appendChild(Je),$e.appendChild(Oe);let Fe=document.createElement("button");Fe.type="button",Fe.className="boot-btn boot-btn--ghost",Fe.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",Me.appendChild($e),Me.appendChild(Fe);let Xe=document.createElement("div");Xe.className="boot-modal__body";let st=document.createElement("div");st.style.display="flex",st.style.flexDirection="column",st.style.gap="10px",Xe.appendChild(st);let U=document.createElement("div");U.className="boot-modal__ftr";let ne=document.createElement("div");ne.className="boot-hint",ne.textContent="\u0415\u0441\u043B\u0438 \u043F\u043E\u0441\u043B\u0435 \u0432\u0445\u043E\u0434\u0430 \u0432\u0441\u0435 \u0441\u0442\u0430\u0442\u044C\u0438 \u043F\u0440\u043E\u043F\u0430\u043B\u0438, \u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E \u0438\u0437\u043C\u0435\u043D\u0438\u043B\u0441\u044F userKey. \u0417\u0434\u0435\u0441\u044C \u043C\u043E\u0436\u043D\u043E \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0430\u0440\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 \u0438\u043B\u0438 \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0438\u0445 \u0432 \u0442\u0435\u043A\u0443\u0449\u0435\u0433\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F.";let K=document.createElement("div");K.className="boot-toast",U.appendChild(ne),U.appendChild(K),ge.appendChild(Me),ge.appendChild(Xe),ge.appendChild(U),oe.appendChild(ge);let Y=()=>{try{oe.remove()}catch{}};Fe.addEventListener("click",Y),oe.addEventListener("click",ee=>{ee.target===oe&&Y()}),document.body.appendChild(oe);let ie=(ee,{articleCount:ue}={})=>{let ye=document.createElement("div");ye.style.border="1px solid rgba(255,255,255,.12)",ye.style.borderRadius="12px",ye.style.padding="12px",ye.style.display="flex",ye.style.flexDirection="column",ye.style.gap="10px";let ke=document.createElement("div");ke.style.display="flex",ke.style.alignItems="baseline",ke.style.justifyContent="space-between",ke.style.gap="12px";let Le=document.createElement("div");Le.style.fontWeight="600",Le.style.fontSize="13px",Le.textContent=ee;let be=document.createElement("div");be.dataset.recoveryMeta="1",be.style.fontSize="12px",be.style.color="#9ca3af",be.textContent=typeof ue=="number"?`\u0421\u0442\u0430\u0442\u0435\u0439: ${ue}`:"",ke.appendChild(Le),ke.appendChild(be);let _e=document.createElement("div");_e.className="boot-actions";let Pe=document.createElement("button");Pe.type="button",Pe.className="boot-btn",Pe.textContent="\u042D\u043A\u0441\u043F\u043E\u0440\u0442 JSON";let Be=document.createElement("button");Be.type="button",Be.className="boot-btn boot-btn--primary",Be.textContent="\u0418\u043C\u043F\u043E\u0440\u0442 \u0432 \u0442\u0435\u043A\u0443\u0449\u0435\u0433\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F";let Se=document.createElement("button");return Se.type="button",Se.className="boot-btn",Se.textContent="\u041D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440",_e.appendChild(Pe),_e.appendChild(Be),_e.appendChild(Se),ye.appendChild(ke),ye.appendChild(_e),Pe.addEventListener("click",async()=>{let Te=performance.now();try{K.textContent="\u042D\u043A\u0441\u043F\u043E\u0440\u0442\u2026",f("export.start",{userKey:ee});let Ce=await vt(ee),Ue=`memus-offline-recovery-${ee}-${new Date().toISOString().replace(/[:.]/g,"-")}`,Re=await bn(Ue,Ce);f("export.done",{userKey:ee,ok:Re.ok,method:Re.method,filename:Re.filename,ms:Math.round(performance.now()-Te)}),K.textContent=Re.ok?Re.method==="download"?`\u0421\u043A\u0430\u0447\u0438\u0432\u0430\u043D\u0438\u0435 \u043D\u0430\u0447\u0430\u043B\u043E\u0441\u044C: ${Re.filename}`:Re.method==="open"?`\u041E\u0442\u043A\u0440\u044B\u043B \u0444\u0430\u0439\u043B \u0432 \u043D\u043E\u0432\u043E\u0439 \u0432\u043A\u043B\u0430\u0434\u043A\u0435: ${Re.filename}`:`\u042D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043E: ${Re.filename}`:"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C (\u043E\u0433\u0440\u0430\u043D\u0438\u0447\u0435\u043D\u0438\u044F \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0430)"}catch(Ce){p("export.button.error",{userKey:ee,message:String(Ce?.message||Ce),stack:String(Ce?.stack||"")}),K.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430 \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0430: ${String(Ce&&Ce.message?Ce.message:Ce)}`}finally{setTimeout(()=>{try{K.textContent=""}catch{}},8e3)}}),Be.addEventListener("click",async()=>{let Te=performance.now();try{let Ce=wn();if(!Ce){K.textContent="\u041D\u0435\u0442 \u201C\u0442\u0435\u043A\u0443\u0449\u0435\u0433\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\u201D \u0432 localStorage. \u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0434\u0438\u043D \u0440\u0430\u0437 \u0432\u043E\u0439\u0434\u0438\u0442\u0435.";return}K.textContent="\u0418\u043C\u043F\u043E\u0440\u0442\u2026",f("import.start",{from:ee,to:Ce});let Ue=await vt(ee),Re=await Lt(Ue,Ce);try{window.localStorage.setItem(d,"1")}catch{}let Ye=await Z(`${l}${Ce}`).catch(()=>null),at=null,ut=null;if(Ye){at=await We(Ye,"articles").catch(()=>null),ut=await We(Ye,"outline_sections").catch(()=>null);try{Ye.close()}catch{}}f("import.done",{from:ee,to:Ce,imported:Re,targetArticles:at,targetSections:ut,ms:Math.round(performance.now()-Te)});let tn=typeof at=="number"?` (\u0432 \u0431\u0430\u0437\u0435 \u0441\u0442\u0430\u0442\u0435\u0439: ${at})`:"";K.textContent=`\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0437\u0430\u043F\u0438\u0441\u0435\u0439: ${Re}${tn}`;try{window.dispatchEvent(new CustomEvent("memus:offline-recovery-imported",{detail:{from:ee,to:Ce}}))}catch{}}catch(Ce){p("import.button.error",{userKey:ee,message:String(Ce?.message||Ce),stack:String(Ce?.stack||"")}),K.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430 \u0438\u043C\u043F\u043E\u0440\u0442\u0430: ${String(Ce&&Ce.message?Ce.message:Ce)}`}finally{setTimeout(()=>{try{K.textContent=""}catch{}},8e3)}}),Se.addEventListener("click",async()=>{let Te=performance.now();try{K.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u043D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u2026",f("restore.server.start",{userKey:ee});let Ce=await Bn({userKey:ee,onProgress:Ue=>{let Re=Ue.phase;Re==="content"?K.textContent=`\u041D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440: ${Ue.idx}/${Ue.total} \xB7 ${Ue.title||Ue.articleId}`:Re==="structure"?K.textContent=`\u0421\u0442\u0440\u0443\u043A\u0442\u0443\u0440\u0430\u2026 (${Ue.moved}/${Ue.total})`:Re==="done"&&(K.textContent=`\u0413\u043E\u0442\u043E\u0432\u043E: \u0441\u0442\u0430\u0442\u0435\u0439=${Ue.total}, \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E=${Ue.saved}`),f("restore.server.progress",Ue)}});f("restore.server.done",{...Ce,ms:Math.round(performance.now()-Te)}),K.textContent=`\u041D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440: \u0441\u0442\u0430\u0442\u0435\u0439=${Ce.total}, \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E=${Ce.saved}`}catch(Ce){p("restore.server.error",{userKey:ee,message:String(Ce?.message||Ce),stack:String(Ce?.stack||"")}),K.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430: ${String(Ce?.message||Ce)}`}finally{setTimeout(()=>{try{K.textContent=""}catch{}},12e3)}}),ye};try{let ee=await Ne();if(!ee.length){Oe.textContent="\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0435 \u0431\u0430\u0437\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B. \u0415\u0441\u043B\u0438 \u0432\u044B \u0442\u043E\u0447\u043D\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043B\u0438\u0441\u044C Memus \u043D\u0430 \u044D\u0442\u043E\u043C \u0443\u0441\u0442\u0440\u043E\u0439\u0441\u0442\u0432\u0435, \u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E \u0431\u0440\u0430\u0443\u0437\u0435\u0440 \u043D\u0435 \u0434\u0430\u0451\u0442 \u043F\u0435\u0440\u0435\u0447\u0438\u0441\u043B\u044F\u0442\u044C IndexedDB.";return}Oe.textContent=`\u041D\u0430\u0439\u0434\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0445 \u0431\u0430\u0437: ${ee.length}`;for(let ue of ee){let ye=ie(ue);st.appendChild(ye);let ke=await Z(`${l}${ue}`).catch(()=>null);if(ke){let Le=await We(ke,"articles").catch(()=>null);try{ke.close()}catch{}if(typeof Le=="number")try{let be=ye.querySelector('[data-recovery-meta="1"]');be&&(be.textContent=`\u0421\u0442\u0430\u0442\u0435\u0439: ${Le}`)}catch{}}}}catch(ee){Oe.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430: ${String(ee&&ee.message?ee.message:ee)}`}};document.body.appendChild(v),setTimeout(()=>b.focus({preventScroll:!0}),0)}function fe(){let m=()=>z();try{window.addEventListener("pointerdown",m,{passive:!0}),window.addEventListener("keydown",m,{passive:!0}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&m()})}catch{}}function xe(){let m=()=>{try{Promise.resolve().then(()=>(Qo(),Go)).then(v=>v.flushOutlineAutosave?.({mode:"queue"})).catch(()=>{})}catch{}try{Promise.resolve().then(()=>(Us(),zs)).then(v=>v.flushOutboxOnce?.()).catch(()=>{})}catch{}};try{window.addEventListener("pagehide",m),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&m()})}catch{}}let Ie=!1,ae=m=>{if(!Ie){Ie=!0;try{document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>le({reason:m}),{once:!0}):le({reason:m})}catch{}}};function ve({subtitle:m=null,error:v=null,showRetry:C=!1,showOffline:D=!1}={}){try{let M=document.getElementById("authOverlay");if(!M)return;let N=document.getElementById("authSubtitle"),P=document.getElementById("authError");if(N&&m!=null&&(N.textContent=String(m)),P){let b=v!=null?String(v):"";P.textContent=b,P.classList.toggle("hidden",!b)}let T=M.querySelector(".auth-card")||M,x=document.getElementById("bootLoadActions");x||(x=document.createElement("div"),x.id="bootLoadActions",x.style.display="flex",x.style.gap="10px",x.style.flexWrap="wrap",x.style.marginTop="12px",T.appendChild(x)),x.innerHTML="";let I=(b,B)=>{let _=document.createElement("button");return _.type="button",_.className="auth-submit",_.style.padding="10px 14px",_.style.borderRadius="999px",_.style.fontSize="13px",_.textContent=b,_.addEventListener("click",B),_};if(C&&x.appendChild(I("\u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C",()=>{try{window.location.reload()}catch{}})),D){let b=()=>{let B=!1;try{B=!!("serviceWorker"in navigator&&navigator.serviceWorker?.controller)}catch{B=!1}if(E()&&!B){ve({subtitle:"\u041D\u0435\u0442 \u0441\u0435\u0442\u0438",error:`\u041E\u0444\u0444\u043B\u0430\u0439\u043D-\u0440\u0435\u0436\u0438\u043C \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u043F\u043E\u0441\u043B\u0435 \u0442\u043E\u0433\u043E, \u043A\u0430\u043A \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435 \u0445\u043E\u0442\u044F \u0431\u044B \u043E\u0434\u0438\u043D \u0440\u0430\u0437 \u043E\u0442\u043A\u0440\u044B\u043B\u043E\u0441\u044C \u0441 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u043E\u043C \u0438 \u0437\u0430\u043A\u0435\u0448\u0438\u0440\u043E\u0432\u0430\u043B\u043E \u0444\u0430\u0439\u043B\u044B.

\u0415\u0441\u043B\u0438 \u0432\u044B \u0442\u043E\u043B\u044C\u043A\u043E \u0447\u0442\u043E \u0443\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u043B\u0438 PWA \u2014 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0435\u0433\u043E \u043E\u043D\u043B\u0430\u0439\u043D, \u0434\u043E\u0436\u0434\u0438\u0442\u0435\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438, \u0437\u0430\u0442\u0435\u043C \u043C\u043E\u0436\u043D\u043E \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u0431\u0435\u0437 \u0441\u0435\u0442\u0438.`,showRetry:!0,showOffline:!0});return}try{window.sessionStorage?.setItem?.(h,"1")}catch{}try{let H=document.getElementById("authSubtitle");H&&(H.textContent="\u041E\u0442\u043A\u0440\u044B\u0432\u0430\u0435\u043C \u0430\u0432\u0442\u043E\u043D\u043E\u043C\u043D\u044B\u0439 \u0440\u0435\u0436\u0438\u043C\u2026");let R=document.getElementById("authError");R&&(R.textContent="",R.classList.add("hidden"))}catch{}try{if(B){window.location.reload();return}}catch{}try{window.location.reload();return}catch{}try{Ge({reason:"offline_button",background:!1})}catch{}};x.appendChild(I("\u041E\u0442\u043A\u0440\u044B\u0442\u044C \u043E\u0444\u0444\u043B\u0430\u0439\u043D-\u0431\u0443\u0444\u0435\u0440",()=>{try{b()}catch{}}))}}catch{}}let He=!1,Ve=!1;function Ge({reason:m="",background:v=!1}={}){if(!Ve&&!(He&&!v)){He=!0;try{let C=import(e);C&&typeof C.catch=="function"&&C.catch(D=>{Ve=!0;let N="\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435. "+(E()?"\u041F\u043E\u0445\u043E\u0436\u0435, \u0441\u0435\u0439\u0447\u0430\u0441 \u043D\u0435\u0442 \u0441\u0435\u0442\u0438.":"\u041F\u043E\u0445\u043E\u0436\u0435, \u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u0435\u0442\u044C\u044E/\u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C.")+" \u041C\u043E\u0436\u043D\u043E \u043F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C \u0432 \u0430\u0432\u0442\u043E\u043D\u043E\u043C\u043D\u043E\u043C \u0440\u0435\u0436\u0438\u043C\u0435 \u0438\u043B\u0438 \u043F\u043E\u043F\u0440\u043E\u0431\u043E\u0432\u0430\u0442\u044C \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443.";if(ve({subtitle:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",error:N,showRetry:!0,showOffline:!0}),!g)try{Ie||ae("\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438")}catch{}S("app.import.failed",{reason:m,message:String(D?.message||D||"")})})}catch(C){Ve=!0,ve({subtitle:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",error:"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435. \u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443.",showRetry:!0,showOffline:!0}),S("app.import.throw",{reason:m,message:String(C?.message||C||"")})}}}if(k()){y(),Ge({reason:"public",background:!1});return}y();let Qe=$(),Ze=Q(),qe=E(),nt=L(),tt=q();fe(),xe(),z(),(qe&&!g||nt||tt||Qe&&Ze)&&ae(qe?"\u043D\u0435\u0442 \u0441\u0435\u0442\u0438":nt?"\u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430":tt?"\u043F\u0440\u043E\u0441\u0442\u043E\u0439 > 15 \u043C\u0438\u043D":"\u0445\u043E\u043B\u043E\u0434\u043D\u044B\u0439 \u0441\u0442\u0430\u0440\u0442"),window.setTimeout(()=>{try{if(Ie||window.__memusAppStarted||g)return;ve({subtitle:"\u041C\u0435\u0434\u043B\u0435\u043D\u043D\u0430\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430\u2026",error:"\u0415\u0441\u043B\u0438 \u0441\u0435\u0442\u044C \u043D\u0435\u0441\u0442\u0430\u0431\u0438\u043B\u044C\u043D\u0430, \u043C\u043E\u0436\u043D\u043E \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u043E\u0444\u0444\u043B\u0430\u0439\u043D-\u0431\u0443\u0444\u0435\u0440. \u041F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435 \u043F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442 \u043F\u044B\u0442\u0430\u0442\u044C\u0441\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C\u0441\u044F \u0432 \u0444\u043E\u043D\u0435.",showRetry:!0,showOffline:!0}),ae("\u043C\u0435\u0434\u043B\u0435\u043D\u043D\u0430\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430")}catch{}},s),Ie||qe?ce(()=>Ge({reason:"idle",background:!0}),{timeout:5e3,fallbackDelay:1200}):Ge({reason:"foreground",background:!1})})();
