var Wd=Object.defineProperty;var Je=(e,t)=>()=>(e&&(t=e(e=0)),t);var Po=(e,t)=>{for(var n in t)Wd(e,n,{get:t[n],enumerable:!0})};function Ca(e){Fi=e}var u,Fi,St=Je(()=>{u={mode:"view",serverStatus:"unknown",serverStatusText:"",offlineReady:!1,offlineInitStatus:"idle",offlineInitError:"",offlineInitStartedAt:null,mediaStatusText:"",mediaPrefetchPaused:!1,isOutlineEditing:!1,outlineStatusText:"",isPublicView:!1,isRagView:!1,currentUser:null,articleId:null,article:null,currentBlockId:null,editingBlockId:null,selectionAnchorBlockId:null,selectedBlockIds:[],undoStack:[],redoStack:[],pendingTextPreview:null,editingUndo:null,editingInitialText:"",searchQuery:"",searchResults:[],searchError:"",searchLoading:!1,searchRequestId:0,searchMode:"classic",sidebarSearchView:"list",ragQuery:"",ragResults:[],ragBlockMap:{},ragSummaryHtml:"",ragSummaryLoading:!1,ragSummaryError:"",scrollTargetBlockId:null,pendingEditBlockId:null,isEditingTitle:!1,isSidebarCollapsed:!1,isSidebarMobileOpen:!1,articlesIndex:[],deletedArticlesIndex:[],articleFilterQuery:"",isMarkdownInserting:!1,isTrashView:!1,favoriteArticles:[],sidebarArticlesMode:"tree",recentArticleIds:[],sidebarSelectedArticleId:null,listSelectedArticleId:null,sidebarCollapsedArticleIds:[],listCollapsedArticleIds:[],isDragModeEnabled:!1,articleEncryptionKeys:{},isMergingBlocks:!1,isMovingBlock:!1,isDeletingBlock:!1,moveQueue:[],isMoveQueueProcessing:!1,editingScrollTop:null,editingCaretPosition:"start",outboxCount:null,offlineArticlesWithDoc:null,offlineArticlesTotal:null},Fi=!1});var J,mn=Je(()=>{J={authOverlay:document.getElementById("authOverlay"),authLoginTab:document.getElementById("authLoginTab"),authRegisterTab:document.getElementById("authRegisterTab"),authLoginForm:document.getElementById("authLoginForm"),authRegisterForm:document.getElementById("authRegisterForm"),authLoginUsername:document.getElementById("authLoginUsername"),authLoginPassword:document.getElementById("authLoginPassword"),authRegisterUsername:document.getElementById("authRegisterUsername"),authRegisterPassword:document.getElementById("authRegisterPassword"),authRegisterDisplayName:document.getElementById("authRegisterDisplayName"),authError:document.getElementById("authError"),authSubtitle:document.getElementById("authSubtitle"),authGoogleLoginBtn:document.getElementById("authGoogleLoginBtn"),authYandexLoginBtn:document.getElementById("authYandexLoginBtn"),authStorageInfo:document.getElementById("authStorageInfo"),currentUserLabel:document.getElementById("currentUserLabel"),logoutBtn:document.getElementById("logoutBtn"),userMenuBtn:document.getElementById("userMenuBtn"),userMenu:document.getElementById("userMenu"),sidebarSyncStatusPill:document.getElementById("sidebarSyncStatusPill"),syncMenu:document.getElementById("syncMenu"),syncMenuStatusLabel:document.getElementById("syncMenuStatusLabel"),syncMenuArticlesLabel:document.getElementById("syncMenuArticlesLabel"),syncMenuOutboxLabel:document.getElementById("syncMenuOutboxLabel"),offlineStatusItem:document.getElementById("offlineStatusItem"),offlineStatusLabel:document.getElementById("offlineStatusLabel"),offlineFetchBtn:document.getElementById("offlineFetchBtn"),offlineRepairBtn:document.getElementById("offlineRepairBtn"),telegramLinkBtn:document.getElementById("telegramLinkBtn"),telegramBotOpenBtn:document.getElementById("telegramBotOpenBtn"),telegramFeedbackBotOpenBtn:document.getElementById("telegramFeedbackBotOpenBtn"),openUsersViewBtn:document.getElementById("openUsersViewBtn"),usersView:document.getElementById("usersView"),usersList:document.getElementById("usersList"),usersBackBtn:document.getElementById("usersBackBtn"),graphView:document.getElementById("graphView"),graphCanvas:document.getElementById("graphCanvas"),graphBackBtn:document.getElementById("graphBackBtn"),articleListView:document.getElementById("articleListView"),articleView:document.getElementById("articleView"),articleHeader:document.getElementById("articleHeader"),articleTitle:document.getElementById("articleTitle"),updatedAt:document.getElementById("updatedAt"),articleStatusText:document.getElementById("articleStatusText"),mediaStatusText:document.getElementById("mediaStatusText"),mediaPrefetchToggleBtn:document.getElementById("mediaPrefetchToggleBtn"),blocksContainer:document.getElementById("blocksContainer"),articleList:document.getElementById("articleList"),createArticleBtn:document.getElementById("createArticleBtn"),backToList:document.getElementById("backToList"),toast:document.getElementById("toast"),searchInput:document.getElementById("searchInput"),searchClearBtn:document.getElementById("searchClearBtn"),searchResults:document.getElementById("searchResults"),searchPanel:document.querySelector(".search-panel"),searchModeToggle:document.getElementById("searchModeToggle"),sidebarSearchViewToggle:document.getElementById("sidebarSearchViewToggle"),ragOpenBtn:document.getElementById("ragOpenBtn"),articleTitleInput:document.getElementById("articleTitleInput"),editTitleBtn:document.getElementById("editTitleBtn"),hintToggleBtn:document.getElementById("hintToggleBtn"),hintPopover:document.getElementById("hintPopover"),sidebar:document.getElementById("sidebar"),sidebarToggle:document.getElementById("sidebarToggle"),sidebarArticleList:document.getElementById("sidebarArticleList"),sidebarNewArticleBtn:document.getElementById("sidebarNewArticleBtn"),sidebarRecentBtn:document.getElementById("sidebarRecentBtn"),openInboxBtn:document.getElementById("openInboxBtn"),quickNoteAddBtn:document.getElementById("quickNoteAddBtn"),articleFilterInput:document.getElementById("articleFilterInput"),trashTabBtn:document.getElementById("trashTabBtn"),articlesTabBtn:document.getElementById("articlesTabBtn"),semanticReindexBtn:document.getElementById("semanticReindexBtn"),graphToggleBtn:document.getElementById("graphToggleBtn"),listMenuBtn:document.getElementById("listMenuBtn"),listMenu:document.getElementById("listMenu"),articleMenuBtn:document.getElementById("articleMenuBtn"),articleMenu:document.getElementById("articleMenu"),articleFavoriteBtn:document.getElementById("articleFavoriteBtn"),articlePublicLinkBtn:document.getElementById("articlePublicLinkBtn"),articlePublicToggleBtn:document.getElementById("articlePublicToggleBtn"),articleEncryptionBtn:document.getElementById("articleEncryptionBtn"),articleEncryptionRemoveBtn:document.getElementById("articleEncryptionRemoveBtn"),deleteArticleBtn:document.getElementById("deleteArticleBtn"),exportArticleBtn:document.getElementById("exportArticleBtn"),outlineEditBtn:document.getElementById("outlineEditBtn"),saveVersionBtn:document.getElementById("saveVersionBtn"),versionsBtn:document.getElementById("versionsBtn"),blockHistoryBtn:document.getElementById("blockHistoryBtn"),articleHistoryBtn:document.getElementById("articleHistoryBtn"),exportAllHtmlZipBtn:document.getElementById("exportAllHtmlZipBtn"),importArticleBtn:document.getElementById("importArticleBtn"),importMarkdownBtn:document.getElementById("importMarkdownBtn"),importLogseqBtn:document.getElementById("importLogseqBtn"),importBackupFolderBtn:document.getElementById("importBackupFolderBtn"),articleUndoBtn:document.getElementById("articleUndoBtn"),articleRedoBtn:document.getElementById("articleRedoBtn"),mergeBlocksBtn:document.getElementById("mergeBlocksBtn"),splitBlockBtn:document.getElementById("splitBlockBtn"),insertTableBtn:document.getElementById("insertTableBtn"),deleteCurrentBlockBtn:document.getElementById("deleteCurrentBlockBtn"),exportCurrentBlockBtn:document.getElementById("exportCurrentBlockBtn"),articleBlockTrashBtn:document.getElementById("articleBlockTrashBtn"),articleNewBlockBtn:document.getElementById("articleNewBlockBtn"),articleToolbar:document.getElementById("articleToolbar"),outlineToolbar:document.getElementById("outlineToolbar"),outlineTagsBar:document.getElementById("outlineTagsBar"),outlineUndoBtn:document.getElementById("outlineUndoBtn"),outlineRedoBtn:document.getElementById("outlineRedoBtn"),outlineDeleteBtn:document.getElementById("outlineDeleteBtn"),outlineMoveUpBtn:document.getElementById("outlineMoveUpBtn"),outlineMoveDownBtn:document.getElementById("outlineMoveDownBtn"),outlineOutdentBtn:document.getElementById("outlineOutdentBtn"),outlineIndentBtn:document.getElementById("outlineIndentBtn"),outlineNewBelowBtn:document.getElementById("outlineNewBelowBtn"),outlineBoldBtn:document.getElementById("outlineBoldBtn"),outlineBulletListBtn:document.getElementById("outlineBulletListBtn"),outlineOrderedListBtn:document.getElementById("outlineOrderedListBtn"),outlineBlockquoteBtn:document.getElementById("outlineBlockquoteBtn"),outlineCodeBtn:document.getElementById("outlineCodeBtn"),outlineInsertTableBtn:document.getElementById("outlineInsertTableBtn"),outlineDeleteTableBtn:document.getElementById("outlineDeleteTableBtn"),outlineAddRowBtn:document.getElementById("outlineAddRowBtn"),outlineAddColBtn:document.getElementById("outlineAddColBtn"),pasteProgress:document.getElementById("pasteProgress"),mobileSidebarBtn:document.getElementById("mobileSidebarBtn"),sidebarBackdrop:document.getElementById("sidebarBackdrop"),dragModeToggleBtn:document.getElementById("dragModeToggleBtn"),listSidebarBtn:document.getElementById("listSidebarBtn"),outlineEditor:document.getElementById("outlineEditor")}});function Ta(){Zr!==null&&(clearTimeout(Zr),Zr=null)}function Ui(e){zi=!!e,J.toast&&(zi?J.toast.dataset.protected="true":J.toast.removeAttribute("data-protected"))}function Ce(e,t={}){if(!J.toast)return;let n=typeof t.duration=="number"?t.duration:2500;t.protect?Ui(!0):Ui(!1),Ta(),J.toast.textContent=e,J.toast.classList.remove("hidden"),requestAnimationFrame(()=>{J.toast.classList.add("show")}),n>0&&(Zr=setTimeout(()=>{J.toast.classList.remove("show"),setTimeout(()=>J.toast.classList.add("hidden"),200),Zr=null},n))}function qi(e,t={}){Ce(e,{...t,duration:0})}function ur(e={}){J.toast&&(zi&&!e.force||(Ta(),Ui(!1),J.toast.classList.remove("show"),J.toast.classList.add("hidden")))}var Zr,zi,Vt=Je(()=>{mn();Zr=null,zi=!1;J.toast&&J.toast.addEventListener("click",()=>{ur()})});function Pe(e){return new Promise((t,n)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error||new Error("IndexedDB request failed"))})}function Cr(e,t,n={}){let r=t instanceof Error?t:new Error(String(t?.message||t||"IndexedDB error"));try{r.idbKind=String(e||"unknown"),r.cause=t,r.extra=n}catch{}return r}function We(e){return new Promise((t,n)=>{e.oncomplete=()=>t(),e.onabort=()=>n(e.error||new Error("IndexedDB transaction aborted")),e.onerror=()=>n(e.error||new Error("IndexedDB transaction failed"))})}function Yd(e){return String(e||"anon").replace(/[^a-zA-Z0-9_-]/g,"_")}function Gd(e){return`memus_offline_v1_${Yd(e)}`}function Qd(e){try{let t=String(e||"").trim();if(!t)return;let n=window?.localStorage?.getItem?.(Ba)||"[]",r=JSON.parse(n),o=Array.isArray(r)?r:[];o.includes(t)||o.push(t),window.localStorage.setItem(Ba,JSON.stringify(o.slice(-200)))}catch{}}async function Na({userKey:e}={}){let t=e||"anon";Qd(t);let n=Gd(t);if(typeof indexedDB>"u"){let a=new Error("IndexedDB is not available in this browser");throw a.name="IDBNotSupportedError",Cr("no_idb",a,{name:n})}let r=indexedDB.open(n,Xd),o=3e3,i=!1;r.onblocked=()=>{i=!0},r.onupgradeneeded=()=>{let a=r.result;if(a.objectStoreNames.contains("meta")||a.createObjectStore("meta",{keyPath:"key"}),!a.objectStoreNames.contains("articles")){let c=a.createObjectStore("articles",{keyPath:"id"});c.createIndex("byUpdatedAt","updatedAt",{unique:!1}),c.createIndex("byDeletedAt","deletedAt",{unique:!1})}if(!a.objectStoreNames.contains("outline_sections")){let c=a.createObjectStore("outline_sections",{keyPath:"sectionId"});c.createIndex("byArticleId","articleId",{unique:!1}),c.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!a.objectStoreNames.contains("section_embeddings")){let c=a.createObjectStore("section_embeddings",{keyPath:"sectionId"});c.createIndex("byArticleId","articleId",{unique:!1}),c.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!a.objectStoreNames.contains("media_assets")){let c=a.createObjectStore("media_assets",{keyPath:"url"});c.createIndex("byStatus","status",{unique:!1}),c.createIndex("byFetchedAtMs","fetchedAtMs",{unique:!1}),c.createIndex("byStatusFetchedAtMs",["status","fetchedAtMs"],{unique:!1})}if(!a.objectStoreNames.contains("media_refs")){let c=a.createObjectStore("media_refs",{keyPath:"key"});c.createIndex("byArticleId","articleId",{unique:!1}),c.createIndex("byUrl","url",{unique:!1})}if(a.objectStoreNames.contains("outbox")){let c=r.transaction;try{let l=c.objectStore("outbox");l.indexNames.contains("byTypeCoalesceKey")||l.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}catch{}}else{let c=a.createObjectStore("outbox",{keyPath:"id"});c.createIndex("byCreatedAtMs","createdAtMs",{unique:!1}),c.createIndex("byTypeArticleId",["type","articleId"],{unique:!1}),c.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}if(!a.objectStoreNames.contains("pending_uploads")){let c=a.createObjectStore("pending_uploads",{keyPath:"token"});c.createIndex("byArticleId","articleId",{unique:!1}),c.createIndex("byCreatedAtMs","createdAtMs",{unique:!1})}if(!a.objectStoreNames.contains("tags_global")){let c=a.createObjectStore("tags_global",{keyPath:"key"});c.createIndex("byCount","count",{unique:!1}),c.createIndex("byLastSeenAtMs","lastSeenAtMs",{unique:!1})}a.objectStoreNames.contains("tags_by_article")||a.createObjectStore("tags_by_article",{keyPath:"articleId"}).createIndex("byUpdatedAt","updatedAt",{unique:!1})};let s=await Promise.race([Pe(r),new Promise((a,c)=>{setTimeout(()=>{let l=new Error(i?"IndexedDB upgrade is blocked by another tab":"IndexedDB open timeout");l.name=i?"IDBBlockedError":"IDBTimeoutError",c(Cr(i?"blocked":"timeout",l,{name:n}))},o)})]).catch(a=>{let c=String(a?.name||"");throw c==="IDBBlockedError"||c==="IDBTimeoutError"?a:c==="SecurityError"?Cr("security",a,{name:n}):c==="InvalidStateError"?Cr("invalid_state",a,{name:n}):c==="QuotaExceededError"?Cr("quota",a,{name:n}):Cr("unknown",a,{name:n})});try{s.onversionchange=()=>{try{s.close()}catch{}}}catch{}return s}async function Ma(e){let t=e.transaction(["meta"],"readonly"),n=t.objectStore("meta");await Pe(n.get("ping")),await We(t)}var Xd,Ba,Sn=Je(()=>{Xd=4,Ba="ttree_offline_known_user_keys_v1"});async function Do({userKey:e}={}){let t=String(e||"").trim();if(!t||t==="anon")try{let n=window?.localStorage?.getItem?.("ttree_offline_user_key_v1")||"",r=String(n||"").trim();r&&(t=r)}catch{}if(!t||t==="anon")try{let n=window?.localStorage?.getItem?.("ttree_last_user_v1")||"",r=n?JSON.parse(n):null,o=String(r?.id||r?.username||"").trim();o&&(t=o)}catch{}return t||(t="anon"),_o&&La===t||(La=t,_o=(async()=>await Na({userKey:t}))()),_o}var _o,La,Ki=Je(()=>{Sn();_o=null,La=null});function Ro(){try{return window?.localStorage?.getItem?.(Zd)==="1"}catch{return!1}}function Oa(){try{return window?.localStorage?.getItem?.(eu)==="1"}catch{return!1}}function Vi(e,t={}){try{if(!Ro())return;console.log("[perf][offline]",e,t)}catch{}}function tu(){try{let e=window.__BUILD_ID__;return e?String(e):""}catch{return""}}function ji(e,t){try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:e,data:t})}).catch(()=>{})}catch{}}async function Ji(){let e={};try{e.ua=navigator?.userAgent||""}catch{e.ua=""}try{e.buildId=tu()}catch{e.buildId=""}try{e.onLine=navigator?.onLine!==!1}catch{e.onLine=null}try{e.indexedDB=typeof indexedDB<"u"}catch{e.indexedDB=null}try{e.storagePersist=typeof navigator?.storage?.persist=="function"}catch{e.storagePersist=null}try{e.storageEstimate=typeof navigator?.storage?.estimate=="function"}catch{e.storageEstimate=null}try{if(navigator?.storage?.estimate){let t=await navigator.storage.estimate().catch(()=>null);t&&typeof t=="object"&&(e.quota=Number(t.quota||0)||null,e.usage=Number(t.usage||0)||null)}}catch{}return e}function nu(e){try{let t=window?.localStorage?.getItem?.("ttree_offline_user_key_v1")||"",n=String(t||"").trim();if(n)return n}catch{}return e&&(e.id||e.username)||"anon"}function ru(e){let t=String(e?.idbKind||"").trim(),n=String(e?.name||"").trim(),r=String(e?.message||"").trim();return t==="no_idb"||n==="IDBNotSupportedError"?{status:"unavailable",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0432 \u044D\u0442\u043E\u043C \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435 (\u043D\u0435\u0442 IndexedDB). \u041E\u0444\u0444\u043B\u0430\u0439\u043D \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u0435\u0442."}:t==="security"||n==="SecurityError"?{status:"unavailable",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u0430 \u043D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0430\u043C\u0438 \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0430/\u043F\u0440\u0438\u0432\u0430\u0442\u043D\u044B\u043C \u0440\u0435\u0436\u0438\u043C\u043E\u043C. \u041E\u0444\u0444\u043B\u0430\u0439\u043D \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u0435\u0442."}:t==="blocked"||n==="IDBBlockedError"?{status:"blocked",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u0437\u0430\u043D\u044F\u0442\u0430 \u0434\u0440\u0443\u0433\u043E\u0439 \u0432\u043A\u043B\u0430\u0434\u043A\u043E\u0439 Memus. \u0417\u0430\u043A\u0440\u043E\u0439\u0442\u0435 \u0434\u0440\u0443\u0433\u0438\u0435 \u0432\u043A\u043B\u0430\u0434\u043A\u0438 \u0438 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443."}:t==="timeout"||n==="IDBTimeoutError"?{status:"timeout",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435 \u043E\u0442\u0432\u0435\u0447\u0430\u0435\u0442 (\u0432\u043A\u043B\u0430\u0434\u043A\u0430 \u043C\u043E\u0433\u043B\u0430 \u201C\u0443\u0441\u043D\u0443\u0442\u044C\u201D). \u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443."}:t==="quota"||n==="QuotaExceededError"?{status:"quota",message:"\u041D\u0435\u0434\u043E\u0441\u0442\u0430\u0442\u043E\u0447\u043D\u043E \u043C\u0435\u0441\u0442\u0430 \u0434\u043B\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u043A\u044D\u0448\u0430. \u041E\u0447\u0438\u0441\u0442\u0438\u0442\u0435 \u043A\u044D\u0448 \u043A\u0430\u0440\u0442\u0438\u043D\u043E\u043A \u0438\u043B\u0438 \u043E\u0441\u0432\u043E\u0431\u043E\u0434\u0438\u0442\u0435 \u043C\u0435\u0441\u0442\u043E \u0432 \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435."}:t==="invalid_state"||n==="InvalidStateError"?{status:"error",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043F\u043E\u0432\u0440\u0435\u0436\u0434\u0435\u043D\u0430 \u0438\u043B\u0438 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430. \u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438\u043B\u0438 \u0441\u0431\u0440\u043E\u0441\u0438\u0442\u044C \u043E\u0444\u0444\u043B\u0430\u0439\u043D\u2011\u043A\u044D\u0448."}:r?{status:"error",message:`\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430: ${r}`}:{status:"error",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430."}}async function ou(e){let t=nu(e);if(Tr&&Pa===t)return Tr;Pa=t,_a+=1;let n=_a;return Tr=(async()=>{let r=Ro()?performance.now():0;u.offlineReady=!1,u.offlineInitStatus="initializing",u.offlineInitError="",u.offlineInitStartedAt=Date.now();try{if(Da!==n){Da=n;let o=await Ji().catch(()=>({}));ji("offline.init.start",{t:new Date().toISOString(),attempt:n,userKey:t,env:o})}}catch{}try{Oa()&&console.log("[offline] init start",{userKey:t})}catch{}try{let o=Ro()?performance.now():0,i=await Do({userKey:t});o&&Vi("getOfflineDb()",{ms:Math.round(performance.now()-o)});let s=Ro()?performance.now():0;await Ma(i),s&&Vi("idb.ping",{ms:Math.round(performance.now()-s)});try{navigator?.storage?.persist&&navigator.storage.persist().catch(()=>{})}catch{}u.offlineReady=!0,u.offlineInitStatus="ready",u.offlineInitError="",u.offlineInitStartedAt=null;try{if(Oo!==n){Oo=n;let a=await Ji().catch(()=>({}));ji("offline.init.ready",{t:new Date().toISOString(),attempt:n,userKey:t,env:a})}}catch{}try{Oa()&&console.log("[offline] init ready")}catch{}return r&&Vi("initOfflineForUser.total",{userKey:t,ms:Math.round(performance.now()-r)}),i}catch(o){u.offlineReady=!1;let i=ru(o);u.offlineInitStatus=i.status||"error",u.offlineInitStartedAt=null;try{console.error("[offline] init failed",o)}catch{}let s=i.message;u.offlineInitError=s,Ce(s);try{if(Oo!==n){Oo=n;let a=await Ji().catch(()=>({}));ji("offline.init.failed",{t:new Date().toISOString(),attempt:n,userKey:t,msg:s,err:{name:String(o?.name||""),message:String(o?.message||""),stack:String(o?.stack||"").slice(0,1500)},env:a})}}catch{}throw o}})(),Tr}async function dt(){return Tr||ou(u.currentUser)}var Tr,Pa,_a,Da,Oo,Zd,eu,Yn=Je(()=>{St();Vt();Ki();Sn();Tr=null,Pa=null,_a=0,Da=null,Oo=null,Zd="ttree_profile_v1",eu="ttree_debug_offline_v1"});function Wi(e){if(!e)return"";if(e.type==="text")return String(e.text||"");let t=Array.isArray(e.content)?e.content:[];if(!t.length)return"";let n=[];for(let r of t){let o=Wi(r);o&&n.push(o),r&&(r.type==="paragraph"||r.type==="hardBreak"||r.type==="heading")&&n.push(`
`)}return n.join("")}function Ra(e){return String(e||"").replace(/\r\n/g,`
`).replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}function Ha(e,t=[]){for(let n of e||[]){if(!n||n.type!=="outlineSection")continue;let r=String(n.attrs?.id||""),o=n.content?.[0],i=n.content?.[1],s=n.content?.[2],a=Ra(Wi(o))||"",c=Ra(Wi(i))||"",l=`${a}
${c}`.trim();r&&t.push({sectionId:r,title:a,text:l});let d=s?.content||[];Ha(d,t)}return t}function iu(e){let t=Array.isArray(e?.content)?e.content:[];return Ha(t,[])}function su(e){return String(e||"").trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9а-яё_-]/gi,"")}function $a(e,t){for(let n of e||[]){if(!n)continue;if(n.type==="tag"){let o=n.attrs?.key||n.attrs?.label||"",i=su(o);i&&t.add(i)}let r=Array.isArray(n.content)?n.content:[];r.length&&$a(r,t)}}function au(e){let t=new Set,n=Array.isArray(e?.content)?e.content:[];return $a(n,t),Array.from(t)}async function Ho(e,{articleId:t,docJson:n,updatedAt:r}){if(!e||!t||!n||typeof n!="object")return;let o=String(t),i=au(n),s=Date.now(),a=e.transaction(["tags_by_article","tags_global"],"readwrite"),c=a.objectStore("tags_by_article"),l=a.objectStore("tags_global"),d=await Pe(c.get(o)).catch(()=>null),m=new Set(Array.isArray(d?.tags)?d.tags.map(p=>String(p||"").trim()).filter(Boolean):[]),h=new Set(i),b=[],w=[];for(let p of m)h.has(p)||b.push(p);for(let p of h)m.has(p)||w.push(p);for(let p of b){let f=await Pe(l.get(p)).catch(()=>null),S=Math.max(0,(Number(f?.count||0)||0)-1);S<=0?await Pe(l.delete(p)).catch(()=>{}):await Pe(l.put({...f||{},key:p,label:String(f?.label||p),count:S,lastSeenAtMs:Number(f?.lastSeenAtMs||0)||0})).catch(()=>{})}for(let p of h){let f=await Pe(l.get(p)).catch(()=>null),S=(Number(f?.count||0)||0)+(w.includes(p)?1:0);await Pe(l.put({...f||{},key:p,label:String(f?.label||p),count:Math.max(1,S),lastSeenAtMs:s})).catch(()=>{})}await Pe(c.put({articleId:o,tags:i,updatedAt:r||null,indexedAtMs:s})),await We(a)}async function $o(e,{articleId:t,docJson:n,updatedAt:r}){if(!e||!t||!n||typeof n!="object")return;let o=iu(n),i=e.transaction(["outline_sections"],"readwrite"),s=i.objectStore("outline_sections"),a=s.index("byArticleId"),c=IDBKeyRange.only(String(t)),l=await Pe(a.openCursor(c));for(;l;)l.delete(),l=await Pe(l.continue());for(let d of o)await Pe(s.put({sectionId:d.sectionId,articleId:String(t),title:d.title||"",text:d.text||"",updatedAt:r||null}));await We(i)}var Fa=Je(()=>{Sn()});function lu(){try{return localStorage.getItem(cu)==="1"}catch{return!1}}function du(e){let t=String(e||"").trim();if(!t)return null;try{let n=new URL(t,window.location.origin);return n.origin!==window.location.origin?/^https?:\/\/memus\.pro\b/i.test(t)&&n.pathname.startsWith("/uploads/")?n.pathname+(n.search||""):null:n.pathname.startsWith("/uploads/")?n.pathname+(n.search||""):null}catch{return t.startsWith("/uploads/")?t:null}}function uu(e){let t=new Set,n=r=>{if(!r)return;if(Array.isArray(r)){r.forEach(n);return}if(r.type==="image"){let i=du(r.attrs?.src);i&&t.add(i)}(Array.isArray(r.content)?r.content:[]).forEach(n)};return n(e?.content||[]),Array.from(t)}async function Br(e,t){let n=await dt(),r=uu(t),o=n.transaction(["media_refs","media_assets"],"readwrite"),i=o.objectStore("media_refs"),s=o.objectStore("media_assets"),a=i.index("byArticleId"),c=IDBKeyRange.only(String(e)),l=await Pe(a.openCursor(c)).catch(()=>null);for(;l;)l.delete(),l=await Pe(l.continue()).catch(()=>null);for(let d of r){let m=`${String(e)}|${String(d)}`;await Pe(i.put({key:m,articleId:String(e),url:String(d)})),await Pe(s.get(d)).catch(()=>null)||await Pe(s.put({url:String(d),status:"needed",fetchedAtMs:0,failCount:0,lastError:null}))}await We(o)}async function za(e,t){let n=e.transaction(["media_assets"],"readwrite"),r=n.objectStore("media_assets"),o=await Pe(r.get(t)).catch(()=>null);await Pe(r.put({...o||{},url:String(t),status:"ok",fetchedAtMs:Date.now(),failCount:0,lastError:null})),await We(n)}async function fu(e,t,n){let r=String(n?.message||n||"error"),o=e.transaction(["media_assets"],"readwrite"),i=o.objectStore("media_assets"),s=await Pe(i.get(t)).catch(()=>null),a=Number(s?.failCount||0)+1;await Pe(i.put({...s||{},url:String(t),status:"error",fetchedAtMs:Date.now(),failCount:a,lastError:r})),await We(o)}async function pu(e,t){let n=e.transaction(["media_assets"],"readonly"),o=n.objectStore("media_assets").index("byFetchedAtMs"),i=[],s=await Pe(o.openCursor()).catch(()=>null);for(;s;){let a=s.value,c=String(a?.status||""),l=Number(a?.failCount||0);if(c!=="ok"&&l<5){let d=String(a?.url||"");if(d&&i.push(d),i.length>=t)break}s=await Pe(s.continue()).catch(()=>null)}return await We(n),i}async function mu(e,t){try{return!!await e.match(t,{ignoreSearch:!1})}catch{return!1}}async function hu(e,t){let n=await fetch(t,{credentials:"include"});if(!n||!n.ok)throw new Error(`HTTP ${n?.status||0}`);await e.put(t,n.clone())}function gu(){try{let e=navigator.connection||navigator.mozConnection||navigator.webkitConnection,t=String(e?.effectiveType||"");if(!!e?.saveData||t.includes("2g"))return 1;if(t.includes("3g"))return 2}catch{}return 3}function Ka(){if(Ua)return;Ua=!0;let e=async()=>{if(!navigator.onLine||lu())return;let t=gu();if(Fo>=t)return;let n=await dt(),r=await caches.open(qa),o=await pu(n,Math.max(5,t*3));if(o.length)for(let i of o){if(Fo>=t)break;Fo+=1,(async()=>{try{if(await mu(r,i)){await za(n,i);return}await hu(r,i),await za(n,i)}catch(s){await fu(n,i,s)}finally{Fo-=1}})()}};setInterval(()=>{e().catch(()=>{})},1200),window.addEventListener("online",()=>{e().catch(()=>{})})}async function Va(){let e=await dt(),t=await caches.open(qa),n=e.transaction(["media_assets","media_refs"],"readwrite"),r=n.objectStore("media_assets"),i=n.objectStore("media_refs").index("byUrl"),s=[],a=await Pe(r.openCursor()).catch(()=>null);for(;a&&s.length<500;){let c=String(a.value?.url||"");c&&(await Pe(i.count(IDBKeyRange.only(c))).catch(()=>0)||(s.push(c),a.delete())),a=await Pe(a.continue()).catch(()=>null)}if(await We(n),!s.length)return 0;for(let c of s)try{await t.delete(c)}catch{}return s.length}var qa,cu,Ua,Fo,Yi=Je(()=>{Yn();Sn();qa="memus-uploads-v1",cu="ttree_media_prefetch_paused_v1";Ua=!1,Fo=0});function Gi(){try{window.dispatchEvent(new CustomEvent("offline-outbox-changed"))}catch{}}function yu(){return globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?globalThis.crypto.randomUUID():`id-${Date.now()}-${Math.random().toString(16).slice(2)}`}function ja(){return new Date().toISOString()}async function jt(e,{articleId:t,payload:n,coalesceKey:r}={}){let o=await dt(),i=yu(),s=ja(),a=n?JSON.stringify(n):"{}",c=o.transaction(["outbox"],"readwrite"),l=c.objectStore("outbox"),d=l.index("byTypeArticleId"),m=l.index("byTypeCoalesceKey");if(r){let h=[String(e||""),String(r||"")],b=await Pe(m.openCursor(IDBKeyRange.only(h))).catch(()=>null);for(;b;)b.delete(),b=await Pe(b.continue()).catch(()=>null)}else if(t){let h=[String(e||""),t||null],b=await Pe(d.openCursor(IDBKeyRange.only(h))).catch(()=>null);for(;b;)b.delete(),b=await Pe(b.continue()).catch(()=>null)}return await Pe(l.put({id:i,createdAt:s,createdAtMs:Date.now(),type:String(e||""),articleId:t||null,coalesceKey:r?String(r):null,payloadJson:a,attempts:0,lastError:null,lastAttemptAt:null})),await We(c),Gi(),i}async function fr(e=50){let n=(await dt()).transaction(["outbox"],"readonly"),o=n.objectStore("outbox").index("byCreatedAtMs"),i=[],s=await Pe(o.openCursor()).catch(()=>null);for(;s&&(i.push(s.value),!(i.length>=e));)s=await Pe(s.continue()).catch(()=>null);return await We(n),i.map(a=>{let c={};try{c=JSON.parse(a?.payloadJson||"{}")}catch{c={}}return{id:a.id,createdAt:a.createdAt,type:a.type,articleId:a.articleId,payload:c,attempts:a.attempts||0}})}async function bu(e=[],t=null){let n=String(t||"").trim(),r=Array.isArray(e)?e.map(c=>String(c||"").trim()).filter(Boolean):[];if(!n||!r.length)return!1;let i=(await dt()).transaction(["outbox"],"readonly"),a=i.objectStore("outbox").index("byTypeArticleId");for(let c of r)try{let l=[String(c),n];if(await Pe(a.openCursor(IDBKeyRange.only(l))).catch(()=>null))return await We(i),!0}catch{}return await We(i),!1}async function Ja(e){return bu(["delete_sections","section_upsert_content","structure_snapshot","save_doc_json"],e)}async function Wa(e,t){let r=(await dt()).transaction(["outbox"],"readwrite"),o=r.objectStore("outbox"),i=await Pe(o.get(e)).catch(()=>null);i&&await Pe(o.put({...i,attempts:Number(i.attempts||0)+1,lastError:String(t||"error"),lastAttemptAt:ja()})),await We(r),Gi()}async function Gn(e){let n=(await dt()).transaction(["outbox"],"readwrite"),r=n.objectStore("outbox");await Pe(r.delete(e)),await We(n),Gi()}var Nr=Je(()=>{Yn();Sn()});function Ga(e){eo.counts=new Map,eo.labelByKey=new Map;for(let t of e||[]){let n=String(t?.key||"").trim();if(!n)continue;let r=Number(t?.count||0)||0,o=String(t?.label||n);eo.counts.set(n,r),eo.labelByKey.set(n,o)}Ya=!0}async function Xa(e){let t=e.transaction(["tags_global"],"readonly"),n=t.objectStore("tags_global"),r=await Pe(n.getAll()).catch(()=>[]);return await We(t),Array.isArray(r)?r:[]}function Qa(){return eo}function Za(){Ya||Xi||(Xi=(async()=>{try{let e=await dt(),t=await Xa(e);Ga(t)}catch{}finally{Xi=null}})())}function zo(){Qi||(Qi=setTimeout(()=>{Qi=null,wu().catch(()=>{})},800))}async function wu(){try{let e=await dt(),t=await Xa(e);Ga(t)}catch{}}var Ya,Xi,Qi,eo,Zi=Je(()=>{Yn();Sn();Ya=!1,Xi=null,Qi=null,eo={counts:new Map,labelByKey:new Map}});function Iu(e=null){try{if(window?.localStorage?.getItem?.(Su)!=="1")return!1;let t=String(window?.localStorage?.getItem?.(xu)||"").trim();if(!t)return!0;let n=String(e||"").trim();return n?n===t:!0}catch{return!1}}function ku(){try{return window?.localStorage?.getItem?.(Au)==="1"}catch{return!1}}function Eu(e){try{return JSON.stringify(e)}catch{return'"[unserializable]"'}}function vu(e){try{let t=String(e||""),n=2166136261;for(let r=0;r<t.length;r+=1)n^=t.charCodeAt(r),n=Math.imul(n,16777619);return(n>>>0).toString(16)}catch{return"0"}}function Dt(e){try{return!e||typeof e!="object"?null:vu(Eu(e))}catch{return null}}function at(e,t={}){try{let n=t?.articleId?String(t.articleId):null;if(!Iu(n))return!1;let r={t:new Date().toISOString(),kind:String(e||"event"),data:t&&typeof t=="object"?t:{value:t}},o=[];try{let i=window?.localStorage?.getItem?.(Uo)||"";o=i?JSON.parse(i):[],Array.isArray(o)||(o=[])}catch{o=[]}o.push(r),o.length>250&&(o=o.slice(o.length-250));try{window?.localStorage?.setItem?.(Uo,JSON.stringify(o))}catch{}if(ku()&&navigator.onLine!==!1)try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:`revert:${r.kind}`,data:r})}).catch(()=>{})}catch{}return!0}catch{return!1}}function Cu(){try{let e=window?.localStorage?.getItem?.(Uo)||"",t=e?JSON.parse(e):[];return Array.isArray(t)?t:[]}catch{return[]}}function Tu(){try{window?.localStorage?.removeItem?.(Uo)}catch{}}var Su,xu,Au,Uo,to=Je(()=>{Su="ttree_debug_revert_v1",xu="ttree_debug_revert_article_v1",Au="ttree_client_log_v1",Uo="ttree_revert_log_v1";try{window.memusRevertLogDump=()=>Cu(),window.memusRevertLogClear=()=>Tu()}catch{}});function Bu(e){return{id:e.id,title:e.title,updatedAt:e.updatedAt,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:!!e.encrypted}}async function On(e){let t=await dt(),n=Array.isArray(e)?e:[],r=50;for(let o=0;o<n.length;o+=r){let i=n.slice(o,o+r),s=t.transaction(["articles"],"readwrite"),a=s.objectStore("articles");for(let c of i){let l=Bu(c),m={...await Pe(a.get(l.id)).catch(()=>null)||{},id:l.id,title:l.title||"",updatedAt:l.updatedAt||null,parentId:l.parentId??null,position:typeof l.position=="number"?l.position:0,publicSlug:l.publicSlug??null,encrypted:l.encrypted?1:0,deletedAt:null};await Pe(a.put(m))}await We(s),await new Promise(c=>setTimeout(c,0))}}async function Mr(){let t=(await dt()).transaction(["articles"],"readonly"),n=t.objectStore("articles"),r=1200,o=null,i=await Promise.race([Pe(n.getAll()),new Promise((s,a)=>{o=setTimeout(()=>{try{t.abort()}catch{}let c=new Error("IndexedDB read timeout (articles index)");c.name="IDBTimeoutError";try{c.idbKind="timeout"}catch{}a(c)},r)})]).catch(s=>{try{String(s?.name||"")==="QuotaExceededError"&&(s.idbKind="quota")}catch{}throw s});return o&&clearTimeout(o),await We(t),i.filter(s=>s&&!s.deletedAt).sort((s,a)=>Number(s.position||0)-Number(a.position||0)).map(s=>({id:s.id,title:s.title||"",updatedAt:s.updatedAt||null,parentId:s.parentId??null,position:typeof s.position=="number"?s.position:0,publicSlug:s.publicSlug??null,encrypted:!!s.encrypted}))}async function ec(){let t=(await dt()).transaction(["articles"],"readonly"),n=t.objectStore("articles"),r=await Pe(n.getAll()).catch(()=>[])||[];return await We(t),r.filter(o=>o&&!o.deletedAt).map(o=>({id:o.id,updatedAt:o.updatedAt||null,hasDocJson:!!o.docJsonStr}))}async function Lr(e){if(!e||!e.id)return;let t=await dt(),n=e.docJson&&typeof e.docJson=="object"?e.docJson:null,r=e.updatedAt||null,o=t.transaction(["articles"],"readwrite"),i=o.objectStore("articles"),s=await Pe(i.get(e.id)).catch(()=>null),a=null;try{a=s?.articleJsonStr?JSON.parse(s.articleJsonStr):null}catch{a=null}let c=!!(a&&a.localDraft),l=e&&Object.prototype.hasOwnProperty.call(e,"outlineStructureRev")?Number(e.outlineStructureRev):null;try{let m=String(s?.updatedAt||"").trim(),h=String(r||"").trim();if(m&&h&&h<m){at("cache.article.put.skip_older",{articleId:e.id,existingUpdatedAt:m,incomingUpdatedAt:h,incomingDocHash:Dt(n)}),await We(o);return}if(c&&m&&h&&m===h){let b=!1;try{b=await Ja(e.id)}catch{b=!1}if(b){let w=Dt(s?.docJsonStr?JSON.parse(s.docJsonStr):null),p=Dt(n);if(w&&p&&w!==p){let f=a&&typeof a=="object"?{...a}:{};f.id=e.id,f.title=e.title||f.title||"",f.updatedAt=m,f.parentId=e.parentId??f.parentId??null,f.position=typeof e.position=="number"?e.position:f.position??0,f.publicSlug=e.publicSlug??f.publicSlug??null,f.encrypted=!!e.encrypted,Object.prototype.hasOwnProperty.call(e,"outlineStructureRev")&&(f.outlineStructureRev=Number(e.outlineStructureRev)||0),f.localDraft=!0;let S={...s||{},id:e.id,title:e.title||"",updatedAt:m,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:e.encrypted?1:0,deletedAt:null,outlineStructureRev:Number.isFinite(l)?l:Number(s?.outlineStructureRev),docJsonStr:s?.docJsonStr??null,articleJsonStr:JSON.stringify(f)};await Pe(i.put(S)),await We(o);try{at("cache.article.put.skip_localDraft",{articleId:e.id,updatedAt:m,existingDocHash:w,incomingDocHash:p})}catch{}return}}else try{at("cache.article.put.clear_stale_localDraft",{articleId:e.id,updatedAt:m})}catch{}}}catch{}let d={...s||{},id:e.id,title:e.title||"",updatedAt:r,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:e.encrypted?1:0,deletedAt:null,outlineStructureRev:Number.isFinite(l)?l:Number(s?.outlineStructureRev),docJsonStr:n?JSON.stringify(n):null,articleJsonStr:JSON.stringify(e)};await Pe(i.put(d)),await We(o);try{at("cache.article.put",{articleId:e.id,updatedAt:r,hasDocJson:!!n,docHash:Dt(n)})}catch{}n&&($o(t,{articleId:e.id,docJson:n,updatedAt:r}).catch(()=>{}),Ho(t,{articleId:e.id,docJson:n,updatedAt:r}).then(zo).catch(()=>{}),Br(e.id,n).catch(()=>{}))}async function tc(e,t){if(!e||!t)return;let n=await dt(),r=String(t),o=e.docJson&&typeof e.docJson=="object"?e.docJson:null,i=e.updatedAt||null,s=n.transaction(["articles"],"readwrite"),a=s.objectStore("articles"),c=await Pe(a.get(r)).catch(()=>null);try{let d=String(c?.updatedAt||"").trim(),m=String(i||"").trim();if(d&&m&&m<d){at("cache.articleUnderId.put.skip_older",{articleId:r,existingUpdatedAt:d,incomingUpdatedAt:m,incomingDocHash:Dt(o)}),await We(s);return}}catch{}let l={...c||{},id:r,title:e.title||c?.title||"",updatedAt:i||c?.updatedAt||null,parentId:e.parentId??c?.parentId??null,position:typeof e.position=="number"?e.position:c?.position||0,publicSlug:e.publicSlug??c?.publicSlug??null,encrypted:e.encrypted||c?.encrypted?1:0,deletedAt:null,docJsonStr:o?JSON.stringify(o):c?.docJsonStr??null,articleJsonStr:JSON.stringify(e)};await Pe(a.put(l)),await We(s),o&&($o(n,{articleId:r,docJson:o,updatedAt:i}).catch(()=>{}),Ho(n,{articleId:r,docJson:o,updatedAt:i}).then(zo).catch(()=>{}),Br(r,o).catch(()=>{}))}async function Un(e){if(!e)return null;let n=(await dt()).transaction(["articles"],"readonly"),r=n.objectStore("articles"),o=await Pe(r.get(e)).catch(()=>null);if(await We(n),!o)return null;try{let i=JSON.parse(o.articleJsonStr||"null");return i&&!i.docJson&&o.docJsonStr&&(i.docJson=JSON.parse(o.docJsonStr)),i}catch{try{let i=o.docJsonStr?JSON.parse(o.docJsonStr):null,s={id:e,title:o.title||"",createdAt:o.createdAt||o.updatedAt||null,updatedAt:o.updatedAt||null,deletedAt:o.deletedAt||null,parentId:o.parentId??null,position:typeof o.position=="number"?o.position:0,authorId:null,publicSlug:o.publicSlug??null,encrypted:!!o.encrypted,outlineStructureRev:Number.isFinite(Number(o.outlineStructureRev))?Number(o.outlineStructureRev):void 0,docJson:i&&typeof i=="object"?i:null,history:[],redoHistory:[],blockTrash:[]};try{at("cache.article.get.fallback_docJsonStr",{articleId:e,updatedAt:s.updatedAt||null,docHash:Dt(s.docJson)})}catch{}return s}catch{return null}}}async function an(e,t,n){if(!e)return;let r=await dt(),o=r.transaction(["articles"],"readwrite"),i=o.objectStore("articles"),s=await Pe(i.get(e)).catch(()=>null),a=n||s&&s.updatedAt||null,c=()=>{let m=String(e)==="inbox"?"\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438":"",h=(s&&typeof s.title=="string"?s.title:"")||m,b=a,w={id:e,title:h,createdAt:s&&s.createdAt||b||null,updatedAt:b,deletedAt:s&&s.deletedAt||null,parentId:(s&&s.parentId)??null,position:typeof(s&&s.position)=="number"?s.position:0,authorId:null,publicSlug:(s&&s.publicSlug)??null,encrypted:!!(s&&s.encrypted),docJson:null,history:[],blocks:[]};return JSON.stringify(w)},l=()=>{let m=s&&s.articleJsonStr||"",h=null;try{h=m?JSON.parse(m):null}catch{h=null}if(!h||typeof h!="object")try{h=JSON.parse(c())}catch{h={id:e}}return h.id=e,h.updatedAt=a||h.updatedAt||null,h.docJson=t&&typeof t=="object"?t:null,t&&typeof t=="object"&&(h.localDraft=!0),!h.title&&s?.title&&(h.title=s.title),h.deletedAt===void 0&&(h.deletedAt=null),h.parentId===void 0&&(h.parentId=s?.parentId??null),h.position===void 0&&(h.position=typeof s?.position=="number"?s.position:0),h.publicSlug===void 0&&(h.publicSlug=s?.publicSlug??null),h.encrypted===void 0&&(h.encrypted=!!s?.encrypted),h.history===void 0&&(h.history=[]),h.blocks===void 0&&(h.blocks=[]),JSON.stringify(h)},d={...s||{id:e},id:e,outlineStructureRev:s?.outlineStructureRev,docJsonStr:t?JSON.stringify(t):null,updatedAt:a,articleJsonStr:l()};await Pe(i.put(d)),await We(o);try{at("cache.docJson.put",{articleId:e,updatedAt:a,docHash:Dt(t)})}catch{}t&&typeof t=="object"&&($o(r,{articleId:e,docJson:t,updatedAt:n}).catch(()=>{}),Ho(r,{articleId:e,docJson:t,updatedAt:n}).then(zo).catch(()=>{}),Br(e,t).catch(()=>{}))}async function qo(e,t){let n=String(e||"").trim();if(!n)return;let r=String(t||new Date().toISOString()).trim(),i=(await dt()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),a=await Pe(s.get(n)).catch(()=>null);if(!a){await We(i);return}let c=null;try{c=a.articleJsonStr?JSON.parse(a.articleJsonStr):null}catch{c=null}(!c||typeof c!="object")&&(c={id:n}),c.id=n,c.deletedAt=r;let l={...a,deletedAt:r,articleJsonStr:JSON.stringify(c)};await Pe(s.put(l)),await We(i)}async function nc(e){let t=String(e||"").trim();if(!t)return;let r=(await dt()).transaction(["articles"],"readwrite"),o=r.objectStore("articles"),i=await Pe(o.get(t)).catch(()=>null);if(!i){await We(r);return}let s=null;try{s=i.articleJsonStr?JSON.parse(i.articleJsonStr):null}catch{s=null}(!s||typeof s!="object")&&(s={id:t}),s.id=t,delete s.localDraft;let a={...i,articleJsonStr:JSON.stringify(s)};await Pe(o.put(a)),await We(r)}async function rc(e){let t=await dt(),n=Array.isArray(e)?e:[];if(!n.length)return;let r=t.transaction(["articles"],"readwrite"),o=r.objectStore("articles");for(let i of n){if(!i||!i.id)continue;let s=await Pe(o.get(i.id)).catch(()=>null);if(!s)continue;let a={...s,parentId:i.parentId??null,position:typeof i.position=="number"?i.position:0};await Pe(o.put(a))}await We(r)}async function es(e,t){let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return;let i=(await dt()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),a=await Pe(s.get(n)).catch(()=>null);if(!a){await We(i);return}let c=null;try{c=a.articleJsonStr?JSON.parse(a.articleJsonStr):null}catch{c=null}(!c||typeof c!="object")&&(c={id:n}),c.id=n,c.updatedAt=r;let l={...a,updatedAt:r,articleJsonStr:JSON.stringify(c)};await Pe(s.put(l)),await We(i)}async function ts(e,t){let n=String(e||"").trim();if(!n)return;let r=Number(t);if(!Number.isFinite(r)||r<0)return;let i=(await dt()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),a=await Pe(s.get(n)).catch(()=>null);if(!a){await We(i);return}let c=null;try{c=a.articleJsonStr?JSON.parse(a.articleJsonStr):null}catch{c=null}(!c||typeof c!="object")&&(c={id:n}),c.id=n,c.outlineStructureRev=r;let l={...a,outlineStructureRev:r,articleJsonStr:JSON.stringify(c)};await Pe(s.put(l)),await We(i)}var Pr=Je(()=>{Yn();Sn();Fa();Yi();Nr();Zi();to()});function Lu(e){let t=Array.isArray(e)?e:[],n=new Float32Array(t.length),r=0;for(let o=0;o<t.length;o+=1){let i=Number(t[o]||0);n[o]=i,r+=i*i}if(r>0){let o=1/Math.sqrt(r);for(let i=0;i<n.length;i+=1)n[i]*=o}return n}function oc(){Nu=null,Mu=0}async function ns(e,t){if(!e)return;let n=await dt(),r=Array.isArray(t)?t:[],o=n.transaction(["section_embeddings"],"readwrite"),i=o.objectStore("section_embeddings");for(let s of r){let a=String(s?.blockId||s?.sectionId||""),c=String(s?.updatedAt||"")||null,l=s?.embedding;if(!a||!Array.isArray(l)||!l.length)continue;let d=Lu(l);await Pe(i.put({sectionId:a,articleId:String(e),updatedAt:c,vec:d}))}await We(o),oc()}async function Ko(e){let t=(e||[]).map(i=>String(i||"")).filter(Boolean);if(!t.length)return;let r=(await dt()).transaction(["section_embeddings"],"readwrite"),o=r.objectStore("section_embeddings");for(let i of t)await Pe(o.delete(i));await We(r),oc()}var Nu,Mu,rs=Je(()=>{Yn();Sn();Nu=null,Mu=0});var ic=Je(()=>{Yn();rs();Sn()});function Vo(){try{return window?.localStorage?.getItem?.(Pu)==="1"}catch{return!1}}function Ut(...e){try{if(!Vo())return;console.log(...e)}catch{}}async function bt(e,t={}){let n=Vo()?performance.now():0,r=n?performance.now():0,o=await fetch(e,{headers:{"Content-Type":"application/json",...t.headers||{}},credentials:"include",...t}),i=r?performance.now():0;if(!o.ok){if(o.status===401||o.status===403){try{u.serverStatus="auth",u.serverStatusText="auth"}catch{}try{window.dispatchEvent(new CustomEvent("memus:auth-required",{detail:{path:e,status:o.status}}))}catch{}}let l=await o.json().catch(()=>({}));n&&console.log("[perf][api]",e,{status:o.status,ms:Math.round(performance.now()-n),fetchMs:i?Math.round(i-r):null});let d=new Error(l.detail||"Request failed");try{d.status=o.status,d.path=e}catch{}throw d}try{u.serverStatus==="down"&&(u.serverStatus="ok",u.serverStatusText="")}catch{}if(o.status===204)return n&&console.log("[perf][api]",e,{status:204,ms:Math.round(performance.now()-n),fetchMs:i?Math.round(i-r):null}),null;let s=n?performance.now():0,a=await o.json(),c=n?performance.now():0;try{if(window?.localStorage?.getItem?.("ttree_debug_article_load_v1")==="1"){let l=o.headers.get("X-Memus-Article-ms"),d=o.headers.get("X-Memus-DocJson-bytes");(l||d)&&console.log("[api]",e,{ms:l,docJsonBytes:d})}}catch{}if(n){let l=o.headers.get("X-Memus-Article-ms")||o.headers.get("X-Memus-Articles-ms")||o.headers.get("X-Memus-Server-ms"),d=o.headers.get("X-Memus-DocJson-bytes"),m=o.headers.get("X-Memus-Articles-count"),h=o.headers.get("Content-Length");console.log("[perf][api]",e,{status:o.status,ms:Math.round(c-n),fetchMs:i?Math.round(i-r):null,jsonMs:s?Math.round(c-s):null,serverMs:l?Number(l):null,docJsonBytes:d?Number(d):null,articlesCount:m?Number(m):null,contentLength:h?Number(h):null})}return a}function Du(){try{return window?.localStorage?.getItem?.(_u)==="1"}catch{return!1}}async function sc({timeoutMs:e}){let t=typeof e=="number"?Math.max(0,Math.floor(e)):0,n=null,r=null;try{return t>0&&typeof AbortController<"u"&&(r=new AbortController,n=setTimeout(()=>{try{r.abort()}catch{}},t)),await bt("/api/articles",r?{signal:r.signal}:{})}catch(o){if((o?.message||String(o||"")).toLowerCase().includes("abort"))try{u.serverStatus="down",u.serverStatusText="timeout"}catch{}throw o}finally{n&&clearTimeout(n)}}function hn(){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return Mr().catch(()=>[]);if(no)return no;let e=u?.offlineReady?600:250,t=2200;return no=(async()=>{let n=Vo()?performance.now():0,r=null,o=!1,i=new Promise(l=>{r=setTimeout(()=>{!o&&n&&Ut("[offline-first][articles] cache.lookup.timeout",{preferCacheMs:e}),l(null)},e)}),s=Mr().then(l=>(o=!0,r&&clearTimeout(r),r=null,n&&Ut("[offline-first][articles] cache.lookup.done",{ms:Math.round(performance.now()-n),hit:!!(l&&l.length)}),l)).catch(l=>{o=!0,r&&clearTimeout(r),r=null;try{if(u.offlineReady){let d=String(l?.idbKind||l?.name||"").toLowerCase();d.includes("timeout")?(u.offlineInitStatus="timeout",u.offlineInitError="\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435 \u043E\u0442\u0432\u0435\u0447\u0430\u0435\u0442 (\u0442\u0430\u0439\u043C\u0430\u0443\u0442 \u0447\u0442\u0435\u043D\u0438\u044F \u0441\u043F\u0438\u0441\u043A\u0430 \u0441\u0442\u0430\u0442\u0435\u0439). \u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443."):d.includes("quota")?(u.offlineInitStatus="quota",u.offlineInitError="\u041D\u0435\u0434\u043E\u0441\u0442\u0430\u0442\u043E\u0447\u043D\u043E \u043C\u0435\u0441\u0442\u0430 \u0434\u043B\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u043A\u044D\u0448\u0430. \u041E\u0447\u0438\u0441\u0442\u0438\u0442\u0435 \u043A\u044D\u0448 \u043A\u0430\u0440\u0442\u0438\u043D\u043E\u043A \u0438\u043B\u0438 \u043E\u0441\u0432\u043E\u0431\u043E\u0434\u0438\u0442\u0435 \u043C\u0435\u0441\u0442\u043E."):(u.offlineInitStatus="error",u.offlineInitError="\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0440\u043E\u0447\u0438\u0442\u0430\u0442\u044C \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A \u0441\u0442\u0430\u0442\u0435\u0439. \u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438\u043B\u0438 \u0441\u0431\u0440\u043E\u0441\u044C\u0442\u0435 \u043E\u0444\u0444\u043B\u0430\u0439\u043D\u2011\u043A\u044D\u0448.")}}catch{}return null}),a=await Promise.race([s,i]);if(a&&a.length)return os||(os=sc({timeoutMs:t}).then(async l=>{try{typeof requestIdleCallback=="function"?requestIdleCallback(()=>On(l).catch(()=>{}),{timeout:2500}):setTimeout(()=>On(l).catch(()=>{}),250)}catch{On(l).catch(()=>{})}}).catch(()=>{}).finally(()=>{os=null})),a;let c=await sc({timeoutMs:t});try{typeof requestIdleCallback=="function"?requestIdleCallback(()=>On(c).catch(()=>{}),{timeout:2500}):setTimeout(()=>On(c).catch(()=>{}),250)}catch{On(c).catch(()=>{})}try{let l=await Mr().catch(()=>null),d=Array.isArray(c)?c.length:0,m=l&&Array.isArray(l)?l.length:0;if(m>=20&&d<=3||Du()&&m&&m>d)return l}catch{}return c})().catch(async n=>{let r=await Mr().catch(()=>null);if(r&&r.length)return r;throw n}).finally(()=>{no=null}),no}function lc(){return typeof navigator<"u"&&navigator&&navigator.onLine===!1?Promise.resolve([]):bt("/api/articles/deleted").catch(async e=>[])}function dc(e,t={}){let n=String(e||"").trim();e=n.startsWith("inbox-")?"inbox":n;let{cacheTimeoutMs:o,metaTimeoutMs:i,...s}=t||{},a=u?.offlineReady?400:150,c=typeof o=="number"?Math.max(0,Math.floor(o)):a,l=typeof i=="number"?Math.max(0,Math.floor(i)):350,d=Vo()?performance.now():0,m=null,h=!1,b=new Promise(R=>{m=setTimeout(()=>{!h&&d&&Ut("[offline-first][article] cache.lookup.timeout",{id:e,cacheTimeoutMs:c}),R(null)},c)}),w=Un(e).then(R=>(h=!0,m&&clearTimeout(m),m=null,d&&Ut("[offline-first][article] cache.lookup.done",{id:e,ms:Math.round(performance.now()-d),hit:!!R}),R)).catch(R=>(h=!0,m&&clearTimeout(m),m=null,d&&Ut("[offline-first][article] cache.lookup.failed",{id:e,ms:Math.round(performance.now()-d),message:R?.message||String(R||"")}),null)),p=Promise.race([w,b]),f=()=>bt(`/api/articles/${e}?include_history=0`,{...s,cache:"no-store"}).then(async R=>{try{at("article.fetch.network.ok",{articleId:e,updatedAt:R?.updatedAt||null,docHash:Dt(R?.docJson||null)})}catch{}return Lr(R).catch(()=>{}),R&&R.id&&String(R.id)!==String(e)&&tc(R,e).catch(()=>{}),R}).catch(async R=>{let Q=await Un(e).catch(()=>null);try{at("article.fetch.network.err",{articleId:e,message:R?.message||String(R||""),cachedHit:!!Q,cachedUpdatedAt:Q?.updatedAt||null,cachedDocHash:Dt(Q?.docJson||null)})}catch{}if(Q)return Q;throw R}),S=()=>{let R=new Date().toISOString(),Y={type:"doc",content:[{type:"outlineSection",attrs:{id:(globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?()=>globalThis.crypto.randomUUID():()=>`id-${Date.now()}-${Math.random().toString(16).slice(2)}`)(),collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}]};return{id:"inbox",title:"\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438",createdAt:R,updatedAt:R,deletedAt:null,parentId:null,position:0,authorId:null,publicSlug:null,encrypted:!1,docJson:Y,history:[]}},A="ttree_pending_quick_notes_v1",C=()=>{try{let R=window?.localStorage?.getItem?.(A)||"";if(!R)return[];let Q=JSON.parse(R);return Array.isArray(Q)?Q.filter(Boolean):[]}catch{return[]}},T=(R,Q)=>{let Y=String(R||"").trim();if(!Y)return null;let Ae=String(Q||"").trim().split(/\r?\n/),Ee=[];for(let te=0;te<Ae.length;te+=1){let ye=Ae[te];ye&&Ee.push({type:"text",text:ye}),te!==Ae.length-1&&Ee.push({type:"hardBreak"})}return{type:"outlineSection",attrs:{id:Y,collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[Ee.length?{type:"paragraph",content:Ee}:{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}},O=R=>{try{if(!R||String(R.id||"")!=="inbox")return R;let Q=C();if(!Q.length)return R;let Y=R?.docJson&&typeof R.docJson=="object"?R.docJson:{type:"doc",content:[]},re=Array.isArray(Y.content)?Y.content:[],Ae=new Set(re.filter(te=>te&&te.type==="outlineSection"&&te.attrs&&te.attrs.id).map(te=>String(te.attrs.id))),Ee=[];for(let te of Q){let ye=String(te?.sectionId||te?.id||"").trim();if(!ye||Ae.has(ye))continue;let je=T(ye,te?.text||"");je&&Ee.push(je)}return Ee.length?{...R,docJson:{...Y,type:Y.type||"doc",content:[...Ee,...re]}}:R}catch{return R}},$=()=>bt(`/api/articles/${encodeURIComponent(e)}/meta`,{method:"GET",headers:{...s.headers||{}},cache:"no-store"}),q=()=>l?Promise.race([$(),new Promise((R,Q)=>setTimeout(()=>{let Y=new Error("meta_timeout");Y.name="TimeoutError",Q(Y)},l))]):$();return p.then(async R=>{if(!R){if(!navigator.onLine&&String(e)==="inbox"){try{let Ee=await Promise.race([w,new Promise(te=>setTimeout(()=>te(null),Math.max(500,l*5)))]);if(Ee){Ut("[offline-first][article] choose.cache.late.offline.inbox",{id:e});try{at("article.choose",{articleId:e,choose:"cache.late.offline.inbox"})}catch{}return O(Ee)}}catch{}return Ut("[offline-first][article] choose.local.inbox.offline",{id:e}),O(S())}let Y=w.then(Ee=>Ee?{src:"cache",article:O(Ee)}:new Promise(()=>{})).catch(()=>new Promise(()=>{})),re=(async()=>({src:"network",article:await O(f())}))(),Ae=await Promise.race([Y,re]);if(Ae?.src==="cache"){Ut("[offline-first][article] choose.cache.late",{id:e});try{at("article.choose",{articleId:e,choose:"cache.late"})}catch{}return re.catch(()=>{}),Ae.article}Ut("[offline-first][article] choose.network.no-cache",{id:e});try{at("article.choose",{articleId:e,choose:"network.no_cache"})}catch{}return Ae.article}if(!navigator.onLine){Ut("[offline-first][article] choose.cache.offline",{id:e,updatedAt:R?.updatedAt||null});try{at("article.choose",{articleId:e,choose:"cache.offline",cachedUpdatedAt:R?.updatedAt||null,cachedDocHash:Dt(R?.docJson||null)})}catch{}return O(R)}let Q=String(R.updatedAt||R.updated_at||"").trim();if(!Q){Ut("[offline-first][article] choose.network.no-cached-updatedAt",{id:e});try{at("article.choose",{articleId:e,choose:"network.no_cached_updatedAt",cachedDocHash:Dt(R?.docJson||null)})}catch{}return O(await f())}try{Ut("[offline-first][article] meta.check.start",{id:e,cachedUpdatedAt:Q});let Y=await q(),re=String(Y?.updatedAt||"").trim();if(re&&re===Q){Ut("[offline-first][article] choose.cache.meta.same",{id:e,cachedUpdatedAt:Q});try{at("article.choose",{articleId:e,choose:"cache.meta.same",cachedUpdatedAt:Q,serverUpdatedAt:re,cachedDocHash:Dt(R?.docJson||null)})}catch{}return O(R)}Ut("[offline-first][article] choose.network.meta.diff",{id:e,cachedUpdatedAt:Q,serverUpdatedAt:re||null});try{at("article.choose",{articleId:e,choose:"network.meta.diff",cachedUpdatedAt:Q,serverUpdatedAt:re||null,cachedDocHash:Dt(cached?.docJson||null)})}catch{}return O(await f())}catch(Y){String(Y?.name||"")==="TimeoutError"||String(Y?.message||"")==="meta_timeout"?Ut("[offline-first][article] meta.check.timeout",{id:e,metaTimeoutMs:l}):Ut("[offline-first][article] meta.check.failed",{id:e,message:Y?.message||String(Y||"")}),f().catch(()=>{}),String(Y?.name||"")==="TimeoutError"||String(Y?.message||"")==="meta_timeout"?Ut("[offline-first][article] choose.cache.meta.timeout",{id:e,cachedUpdatedAt:Q,metaTimeoutMs:l}):Ut("[offline-first][article] choose.cache.meta.failed",{id:e,cachedUpdatedAt:Q});try{at("article.choose",{articleId:e,choose:String(Y?.name||"")==="TimeoutError"||String(Y?.message||"")==="meta_timeout"?"cache.meta.timeout":"cache.meta.failed",cachedUpdatedAt:Q,cachedDocHash:Dt(R?.docJson||null),error:Y?.message||String(Y||"")})}catch{}return O(R)}})}function uc(e,t){return e?!t||typeof t!="object"?Promise.reject(new Error("docJson must be object")):bt(`/api/articles/${encodeURIComponent(e)}/doc-json`,{method:"PUT",body:JSON.stringify({docJson:t})}):Promise.reject(new Error("articleId is required"))}function fc(e){return typeof e!="string"?Promise.reject(new Error("text must be string")):bt("/api/outline/generate-title",{method:"POST",body:JSON.stringify({text:e})})}function is(e){return typeof e!="string"?Promise.reject(new Error("html must be string")):bt("/api/outline/proofread-html",{method:"POST",body:JSON.stringify({html:e})})}function pc(e,t={}){let n=t.force?"?force=true":"";return bt(`/api/articles/${e}${n}`,{method:"DELETE"}).then(r=>{let o=n?new Date().toISOString():new Date().toISOString();return qo(e,o).catch(()=>{}),r})}function mc(e){return bt(`/api/articles/${e}/restore`,{method:"POST"})}function hc(e,t,n={}){let r=Array.isArray(t)?t.filter(Boolean).map(o=>String(o)):[];return e?r.length?bt(`/api/articles/${encodeURIComponent(e)}/sections/delete`,{method:"PUT",cache:"no-store",body:JSON.stringify({opId:n?.opId||null,sectionIds:r})}):Promise.resolve({status:"ok",removedBlockIds:[]}):Promise.reject(new Error("articleId is required"))}function ro(e){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return Promise.reject(new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D"));let t=new FormData;t.append("file",e);let n=i=>{if(!(typeof navigator<"u"&&navigator&&navigator.onLine===!1))try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"uploadImageFile",data:i})}).catch(()=>{})}catch{}},r=()=>fetch("/api/uploads",{method:"POST",credentials:"include",body:t}).then(async i=>{let s=await i.json().catch(()=>null);if(n({transport:"fetch",status:i.status,ok:i.ok,details:s,name:e&&e.name,type:e&&e.type,size:e&&e.size}),!i.ok){let a=s?.detail||`Upload failed (status ${i.status})`,c=new Error(a);throw c.status=i.status,c.details=s,c}return s}),o=()=>new Promise((i,s)=>{let a=new XMLHttpRequest;a.open("POST","/api/uploads"),a.withCredentials=!0,a.onreadystatechange=()=>{if(a.readyState===XMLHttpRequest.DONE)try{let c=a.status,l=null;try{l=JSON.parse(a.responseText||"null")}catch{l=null}if(n({transport:"xhr",status:c,ok:c>=200&&c<300,details:l,name:e&&e.name,type:e&&e.type,size:e&&e.size}),c>=200&&c<300)i(l);else{let d=l&&l.detail||`Upload failed (status ${c})`,m=new Error(d);m.status=c,m.details=l,s(m)}}catch(c){s(c)}},a.onerror=()=>{n({transport:"xhr",status:0,ok:!1,details:{detail:"Network error during image upload"},name:e&&e.name,type:e&&e.type,size:e&&e.size});let c=new Error("Upload failed (network error)");c.status=0,c.details={detail:"Network error during image upload"},s(c)},a.send(t)});return r().catch(i=>{let s=String(i&&i.message?i.message:"").toLowerCase();if(s.includes("status ")||s.includes("upload failed"))throw i;return o()})}function Ou(e,t,n=()=>{},{sectionId:r}={}){return typeof navigator<"u"&&navigator&&navigator.onLine===!1?Promise.reject(new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D")):new Promise((o,i)=>{let s=new XMLHttpRequest;s.open("POST",`/api/articles/${e}/attachments`),s.withCredentials=!0,s.upload.onprogress=c=>{if(c.lengthComputable){let l=Math.round(c.loaded/c.total*100);n(l)}},s.onreadystatechange=()=>{if(s.readyState===XMLHttpRequest.DONE)if(s.status>=200&&s.status<300)try{let c=JSON.parse(s.responseText||"{}");o(c)}catch(c){i(c)}else{let c=`Attachment upload failed (status ${s.status})`;try{let l=JSON.parse(s.responseText||"{}");l?.detail&&(c=l.detail)}catch{}i(new Error(c))}},s.onerror=()=>i(new Error("Network error during upload"));let a=new FormData;a.append("file",t),r&&a.append("sectionId",String(r)),s.send(a)})}function Ru(e){let t=new Map;for(let n of e||[]){let r=n.parentId??null;t.has(r)||t.set(r,[]),t.get(r).push(n)}for(let n of t.values())n.sort((r,o)=>(r.position||0)-(o.position||0));return t}function ac(e){let t=[];for(let n=0;n<e.length;n+=1){let r=e[n];if(!r)continue;let o=n;(r.position||0)!==o&&(r.position=o,t.push({id:r.id,parentId:r.parentId??null,position:o}))}return t}function ss(e,t){return e?bt(`/api/articles/${encodeURIComponent(e)}/move-tree`,{method:"POST",body:JSON.stringify(t||{})}).catch(async()=>{let r=await Mr().catch(()=>[]),o=Ru(r),i=(r||[]).find(f=>f.id===e);if(!i)return null;let s=t&&t.placement||null,a=t&&t.anchorId||null,c=t?t.parentId??null:null;s==="inside"&&a&&(c=a);let l=i.parentId??null,m=(o.get(l)||[]).filter(f=>f.id!==e),b=(o.get(c)||[]).filter(f=>f.id!==e),w=b.length;if(a){let f=b.findIndex(S=>S.id===a);f!==-1&&(s==="before"?w=f:s==="after"?w=f+1:s==="inside"&&(w=b.length))}i.parentId=c,b.splice(w,0,i);let p=[];return p.push(...ac(m)),p.push(...ac(b)),rc(p).catch(()=>{}),jt("move_article_tree",{articleId:e,payload:t||{},coalesceKey:`${e}:move-tree`}).catch(()=>{}),{id:e}}):Promise.resolve(null)}async function Hu({articleId:e,filename:t,overwrite:n=!1,sha256:r="",size:o=0}){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D");let s=await fetch("/api/yandex/disk/upload-url",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({filename:t||"",articleId:e||"",overwrite:!!n,sha256:r||"",size:typeof o=="number"?o:0})}),a=await s.json().catch(()=>null);if(!s.ok){let c=a&&a.detail||`Yandex upload URL failed (status ${s.status})`;throw new Error(c)}return a}async function cc(e,{path:t,originalName:n,contentType:r,size:o,sectionId:i}){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D");let s={path:t||"",originalName:n||"",contentType:r||"",size:typeof o=="number"?o:0};i&&(s.sectionId=String(i));let a=await fetch(`/api/articles/${e}/attachments/yandex`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),c=await a.json().catch(()=>null);if(!a.ok){let l=c&&c.detail||`Register Yandex attachment failed (status ${a.status})`;throw new Error(l)}return c}async function jo(e,t,{onProgress:n,sectionId:r}={}){if(!t)throw new Error("\u0424\u0430\u0439\u043B \u043D\u0435 \u0443\u043A\u0430\u0437\u0430\u043D");let o="";try{if(window.crypto&&window.crypto.subtle&&typeof t.arrayBuffer=="function"){let h=await t.arrayBuffer(),b=await window.crypto.subtle.digest("SHA-256",h),w=new Uint8Array(b);o=Array.from(w).map(p=>p.toString(16).padStart(2,"0")).join("")}}catch{o=""}let{href:i,method:s,path:a,exists:c,same:l}=await Hu({articleId:e,filename:t.name||"attachment",overwrite:!1,sha256:o,size:t.size||0});if(c&&l&&!i)return await cc(e,{path:a,originalName:t.name||"attachment",contentType:t.type||"",size:t.size||0,sectionId:r});let d=!1;if(i)try{await new Promise((h,b)=>{let w=new XMLHttpRequest;w.open(s||"PUT",i),w.upload.onprogress=p=>{if(n&&p.lengthComputable){let f=Math.round(p.loaded/p.total*100);try{n(f)}catch{}}},w.onreadystatechange=()=>{w.readyState===XMLHttpRequest.DONE&&(w.status>=200&&w.status<300?h():b(new Error(`Yandex upload failed (status ${w.status})`)))},w.onerror=()=>b(new Error("Network error during Yandex upload")),w.send(t)}),d=!0}catch(h){console.warn("[attachments] Direct Yandex upload failed, falling back to server upload",h),d=!1}return d?await cc(e,{path:a,originalName:t.name||"attachment",contentType:t.type||"",size:t.size||0,sectionId:r}):await Ou(e,t,n,{sectionId:r})}var Pu,no,os,_u,en=Je(()=>{Pr();Nr();ic();St();to();Pu="ttree_profile_v1";no=null,os=null,_u="ttree_offline_recovery_force_index_v1"});function gc(){if(!J.articlePublicToggleBtn)return;let e=u.article?.publicSlug||null;J.articlePublicToggleBtn.textContent=e?"\u041E\u0442\u043C\u0435\u043D\u0438\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435":"\u0414\u0430\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435"}function oo(){let e=u.article;if(!e)return;let t=e.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";if(J.articleTitle&&(J.articleTitle.textContent=t,J.articleTitle.classList.toggle("article-title--encrypted",!!e.encrypted),J.articleTitle.classList.toggle("hidden",u.isEditingTitle)),J.articleTitleInput&&(u.isEditingTitle||(J.articleTitleInput.value=t),J.articleTitleInput.classList.toggle("hidden",!u.isEditingTitle)),J.editTitleBtn&&J.editTitleBtn.classList.toggle("hidden",u.isEditingTitle),J.articleFavoriteBtn){let r=new Set(u.favoriteArticles||[]).has(e.id);J.articleFavoriteBtn.textContent=r?"\uE735":"\uE734",J.articleFavoriteBtn.title=r?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}if(J.articlePublicLinkBtn){let n=!!e.publicSlug;J.articlePublicLinkBtn.classList.toggle("hidden",!n),n&&(J.articlePublicLinkBtn.title="\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0441\u044B\u043B\u043A\u0443")}if(J.deleteArticleBtn&&J.deleteArticleBtn.classList.toggle("hidden",e.id==="inbox"),J.articleEncryptionBtn&&(J.articleEncryptionBtn.textContent=e.encrypted?"\u0421\u043C\u0435\u043D\u0438\u0442\u044C \u043F\u0430\u0440\u043E\u043B\u044C":"\u0417\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C"),J.articleEncryptionRemoveBtn&&J.articleEncryptionRemoveBtn.classList.toggle("hidden",!e.encrypted),J.updatedAt&&(u.isOutlineEditing?J.updatedAt.textContent=u.outlineStatusText||"":e.updatedAt?J.updatedAt.textContent=`\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${new Date(e.updatedAt).toLocaleString()}`:J.updatedAt.textContent=""),J.articleStatusText&&(u.isOutlineEditing?J.articleStatusText.textContent=u.outlineStatusText||"":e.updatedAt?J.articleStatusText.textContent=`\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${new Date(e.updatedAt).toLocaleString()}`:J.articleStatusText.textContent=""),J.mediaStatusText&&(J.mediaStatusText.textContent=u.mediaStatusText||""),J.mediaPrefetchToggleBtn){let n=!!u.mediaPrefetchPaused;J.mediaPrefetchToggleBtn.textContent=n?"\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C":"\u041F\u0430\u0443\u0437\u0430",J.mediaPrefetchToggleBtn.classList.toggle("is-active",n)}}var io=Je(()=>{St();mn()});function Jt(...e){console.log("[debug]",...e)}function qt(e=""){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function yc(e=""){let t=(e||"").replace(/<br\s*\/?>/gi,`
`).replace(/<\/(?:div|p|li|h[1-6])>/gi,`
`),n=document.createElement("template");return n.innerHTML=t,(n.content.textContent||"").split(`
`).map(r=>r.replace(/\s+/g," ").trim()).filter(r=>r.length)}function Jo(e){if(!e||!e.isConnected)return;let t=window.getSelection();if(!t)return;let n=document.createRange();n.selectNodeContents(e),n.collapse(!1),t.removeAllRanges(),t.addRange(n)}function as(e){if(!e||!e.isConnected)return;let t=window.getSelection();if(!t)return;let n=document.createRange();n.selectNodeContents(e),n.collapse(!0),t.removeAllRanges(),t.addRange(n)}function qn(e,t){if(!e||!document.contains(e))return;e.focus();let n=window.getSelection();if(!n)return;let r=n.rangeCount>0?n.getRangeAt(0):document.createRange();e.contains(r.commonAncestorContainer)||(r=document.createRange(),r.selectNodeContents(e),r.collapse(!1)),n.removeAllRanges(),n.addRange(r);let o=r.createContextualFragment(t);r.deleteContents(),r.insertNode(o),r.collapse(!1),n.removeAllRanges(),n.addRange(r)}var Bn=Je(()=>{});var ls={};Po(ls,{showArticleHistoryModal:()=>Ju,showArticleLinkPrompt:()=>Fu,showBlockHistoryModal:()=>Vu,showBlockTrashPicker:()=>Wu,showConfirm:()=>Sc,showImagePreview:()=>so,showImportConflictDialog:()=>Yu,showLinkPrompt:()=>cs,showPasswordWithHintPrompt:()=>xc,showPrompt:()=>Xn,showPublicLinkModal:()=>zu,showVersionCompareTargetPicker:()=>qu,showVersionDiffModal:()=>Ku,showVersionsPicker:()=>Uu});function cn(){let e=document.getElementById(bc);return e||(e=document.createElement("div"),e.id=bc,document.body.appendChild(e)),e}function xn({title:e,message:t,confirmText:n,cancelText:r,renderBody:o}){let i=document.createElement("div");i.className="modal-overlay";let s=document.createElement("form");s.className="modal-form",s.addEventListener("submit",w=>{w.preventDefault()});let a=document.createElement("div");a.className="modal-card",a.setAttribute("role","dialog"),a.setAttribute("aria-modal","true"),a.tabIndex=-1;let c=document.createElement("div");c.className="modal-header";let l=document.createElement("h3");l.textContent=e||"\u041F\u043E\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043D\u0438\u0435",c.appendChild(l);let d=document.createElement("div");if(d.className="modal-body",typeof o=="function"){let w=o();Array.isArray(w)?w.forEach(p=>{p&&d.appendChild(p)}):w&&d.appendChild(w)}else d.textContent=t||"";let m=document.createElement("div");m.className="modal-footer modal-footer--stacked";let h=document.createElement("button");h.type="button",h.className="ghost",h.textContent=r||"\u041E\u0442\u043C\u0435\u043D\u0430";let b=document.createElement("button");return b.type="button",b.className="primary danger-btn",b.textContent=n||"\u0423\u0434\u0430\u043B\u0438\u0442\u044C",m.appendChild(b),m.appendChild(h),a.appendChild(c),a.appendChild(d),a.appendChild(m),s.appendChild(a),i.appendChild(s),{overlay:i,card:a,confirmBtn:b,cancelBtn:h,form:s}}function $u(e="",t=""){let n=String(e||"").length,r=String(t||"").length;if(n*r>2e6||n+r>2e4)return null;let s=Array.from(e),a=Array.from(t),c=s.length,l=a.length,d=Array.from({length:c+1},()=>new Array(l+1).fill(0));for(let p=c-1;p>=0;p-=1)for(let f=l-1;f>=0;f-=1)s[p]===a[f]?d[p][f]=d[p+1][f+1]+1:d[p][f]=Math.max(d[p+1][f],d[p][f+1]);let m=[],h=0,b=0;for(;h<c&&b<l;)s[h]===a[b]?(m.push({type:"same",value:s[h]}),h+=1,b+=1):d[h+1][b]>=d[h][b+1]?(m.push({type:"removed",value:s[h]}),h+=1):(m.push({type:"added",value:a[b]}),b+=1);for(;h<c;)m.push({type:"removed",value:s[h]}),h+=1;for(;b<l;)m.push({type:"added",value:a[b]}),b+=1;let w=[];return m.forEach(p=>{if(!p.value)return;let f=w[w.length-1];f&&f.type===p.type?f.value+=p.value:w.push({type:p.type,value:p.value})}),w}function _r({baseText:e="",nextText:t="",mode:n="before"}={}){let r=document.createDocumentFragment(),o=$u(e,t);if(!o){let s=String(n==="before"?e||"":t||""),a=s.length>2e5?`${s.slice(0,2e5)}

\u2026(\u043E\u0431\u0440\u0435\u0437\u0430\u043D\u043E)`:s,c=document.createElement("div");c.className="meta",c.style.marginBottom="6px",c.textContent="Diff \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 \u2014 \u043F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0435\u043C \u0442\u0435\u043A\u0441\u0442 \u0431\u0435\u0437 \u043F\u043E\u0434\u0441\u0432\u0435\u0442\u043A\u0438.";let l=document.createElement("pre");return l.className="diff-plain",l.style.whiteSpace="pre-wrap",l.style.wordBreak="break-word",l.textContent=a,r.appendChild(c),r.appendChild(l),r}return o.forEach(i=>{if(n==="before"&&i.type==="added"||n==="after"&&i.type==="removed")return;let s=document.createElement("span");s.className="diff-seg",i.type==="added"&&s.classList.add("diff-seg--added"),i.type==="removed"&&s.classList.add("diff-seg--removed"),s.textContent=i.value,r.appendChild(s)}),r}function Sc(e={}){let t=cn(),{overlay:n,card:r,confirmBtn:o,cancelBtn:i,form:s}=xn(e),a=!1,c=()=>{},l=()=>{n.classList.add("modal-overlay--hide"),setTimeout(()=>n.remove(),150),document.removeEventListener("keydown",m)},d=h=>{a||(a=!0,l(),c(h))},m=h=>{h.code==="Escape"&&(h.preventDefault(),d(!1)),h.code==="Enter"&&(h.preventDefault(),d(!0))};return new Promise(h=>{c=h,s.addEventListener("submit",b=>{b.preventDefault(),d(!0)}),o.addEventListener("click",()=>d(!0)),i.addEventListener("click",()=>d(!1)),n.addEventListener("click",b=>{b.target===n&&d(!1)}),document.addEventListener("keydown",m),t.appendChild(n),requestAnimationFrame(()=>{r.focus({preventScroll:!0})})})}function Xn(e={}){let t=cn(),n=null,r=null,o=Array.isArray(e.suggestions)?e.suggestions:[],i=null,{overlay:s,card:a,confirmBtn:c,cancelBtn:l,form:d}=xn({...e,renderBody:()=>{let A=document.createDocumentFragment();if(e.message){let T=document.createElement("p");T.className="modal-body__text",T.textContent=e.message,A.appendChild(T)}let C=document.createElement("input");if(C.type=e.inputType==="password"?"password":"text",C.className="modal-input",C.placeholder=e.placeholder||"",C.value=e.defaultValue||"",C.autocomplete="off",A.appendChild(C),e.checkbox&&typeof e.checkbox=="object"){let T=document.createElement("label");T.className="modal-checkbox";let O=document.createElement("input");O.type="checkbox",O.checked=!!e.checkbox.checked,O.disabled=!!e.checkbox.disabled;let $=document.createElement("span");$.className="modal-checkbox__label",$.textContent=String(e.checkbox.label||"").trim(),T.appendChild(O),T.appendChild($),A.appendChild(T),r=O}return o.length&&(i=document.createElement("div"),i.className="modal-suggestions",A.appendChild(i)),n=C,A}}),m=!1,h=()=>{},b=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",p)},w=A=>{if(!m)if(m=!0,b(),e.returnMeta){let C={value:A??null,selectedId:n?.dataset?.selectedId||null,checkboxChecked:r?!!r.checked:null};h(C)}else h(A)},p=A=>{if(A.code==="Escape"){A.preventDefault(),w(null);return}if(A.code==="Enter"&&n&&!e.hideConfirm){let C=n.value.trim();if(!C&&!e.allowEmpty)return;A.preventDefault(),w(C)}},f=()=>{if(!c||!n)return;let A=!!n.value.trim();c.disabled=!A&&!e.allowEmpty},S=()=>{if(!i||!n)return;let A=n.value.trim().toLowerCase();n.dataset.selectedId="";let C=o.filter(T=>(T.title||"").toLowerCase().includes(A)||(T.id||"").toLowerCase().includes(A)).slice(0,8);if(i.innerHTML="",!A||!C.length){i.classList.add("hidden");return}i.classList.remove("hidden"),C.forEach(T=>{let O=document.createElement("button");O.type="button",O.className="modal-suggestion",O.textContent=T.title||T.id||"",O.addEventListener("click",()=>{n.value=T.title||T.id||"",n.dataset.selectedId=T.id||"",f(),S(),w(n.value)}),i.appendChild(O)})};return new Promise(A=>{h=A,c.classList.remove("danger-btn"),e.hideConfirm?c.style.display="none":c.textContent=e.confirmText||"OK",l.textContent=e.cancelText||"Cancel";let C=()=>{if(!n){w(null);return}let T=n.value.trim();if(!T){n.focus();return}w(T)};d.addEventListener("submit",T=>{T.preventDefault(),C()}),c.addEventListener("click",C),l.addEventListener("click",()=>w(null)),s.addEventListener("click",T=>{T.target===s&&w(null)}),document.addEventListener("keydown",p),n?(n.dataset.selectedId="",n.addEventListener("input",()=>{n.dataset.selectedId="",f(),o.length&&S()}),e.hideConfirm&&n.addEventListener("keydown",T=>{T.code==="Enter"&&(T.preventDefault(),w(n.value.trim()))}),f(),o.length&&S()):f(),t.appendChild(s),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):a.focus({preventScroll:!0})})})}function Fu(e={}){let t=cn(),n=null,r=null,o=Array.isArray(e.suggestions)?e.suggestions:[],i=null,{overlay:s,card:a,confirmBtn:c,cancelBtn:l,form:d}=xn({title:e.title||"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",renderBody:()=>{let A=document.createDocumentFragment();if(e.message){let q=document.createElement("p");q.className="modal-body__text",q.textContent=e.message,A.appendChild(q)}let C=document.createElement("label");C.className="modal-label",C.textContent=e.articleLabel||"\u0421\u0442\u0430\u0442\u044C\u044F";let T=document.createElement("input");T.type="text",T.className="modal-input",T.placeholder=e.articlePlaceholder||"ID \u0438\u043B\u0438 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435\u2026",T.value=e.defaultArticleValue||"",T.autocomplete="off",C.appendChild(T),A.appendChild(C),n=T,o.length&&(i=document.createElement("div"),i.className="modal-suggestions",A.appendChild(i));let O=document.createElement("label");O.className="modal-label",O.textContent=e.textLabel||"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)";let $=document.createElement("input");return $.type="text",$.className="modal-input",$.placeholder=e.textPlaceholder||"",$.value=e.defaultTextValue||"",$.autocomplete="off",O.appendChild($),A.appendChild(O),r=$,A}}),m=!1,h=()=>{},b=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",S)},w=A=>{m||(m=!0,b(),h(A))},p=()=>{if(!c||!n)return;let A=!!n.value.trim()||!!n.dataset.selectedId;c.disabled=!A},f=()=>{if(!i||!n)return;let A=n.value.trim().toLowerCase();n.dataset.selectedId="";let C=o.filter(T=>(T.title||"").toLowerCase().includes(A)||(T.id||"").toLowerCase().includes(A)).slice(0,8);if(i.innerHTML="",!A||!C.length){i.classList.add("hidden");return}i.classList.remove("hidden"),C.forEach(T=>{let O=document.createElement("button");O.type="button",O.className="modal-suggestion",O.textContent=T.title||T.id||"",O.addEventListener("click",()=>{n.value=T.title||T.id||"",n.dataset.selectedId=T.id||"",p(),f(),r&&!r.value.trim()&&!e.lockTextValue&&(r.value=T.title||""),r?.focus?.({preventScroll:!0}),r?.select?.()}),i.appendChild(O)})},S=A=>{if(A.code==="Escape"){A.preventDefault(),w(null);return}A.code};return new Promise(A=>{h=A,c.classList.remove("danger-btn"),c.textContent=e.confirmText||"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",l.textContent=e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430";let C=()=>{if(!n||!r){w(null);return}let T=n.value.trim(),O=n.dataset.selectedId||"";if(!T&&!O){n.focus();return}w({articleValue:T,selectedId:O||null,textValue:r.value??""})};d.addEventListener("submit",T=>{T.preventDefault(),C()}),c.addEventListener("click",C),l.addEventListener("click",()=>w(null)),s.addEventListener("click",T=>{T.target===s&&w(null)}),document.addEventListener("keydown",S),n?(n.dataset.selectedId="",n.addEventListener("input",()=>{n.dataset.selectedId="",p(),o.length&&f()}),p(),o.length&&f()):p(),t.appendChild(s),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):a.focus({preventScroll:!0})})})}function zu(e={}){let t=cn(),n=null,r=e.url||"",{overlay:o,card:i,confirmBtn:s,cancelBtn:a}=xn({title:e.title||"\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u0430\u044F \u0441\u0441\u044B\u043B\u043A\u0430",renderBody:()=>{let p=document.createDocumentFragment(),f=document.createElement("label");f.className="modal-label",f.textContent=e.label||"\u041F\u0440\u043E\u0441\u043C\u043E\u0442\u0440 \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435";let S=document.createElement("input");return S.type="text",S.className="modal-input",S.value=r,S.readOnly=!0,S.autocomplete="off",f.appendChild(S),n=S,p.appendChild(f),p}}),c=!1,l=()=>{},d=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",h)},m=()=>{c||(c=!0,d(),l())},h=p=>{p.code==="Escape"&&(p.preventDefault(),m())},b=p=>{if(!p)return!1;let f=document.createElement("textarea");f.value=p,f.setAttribute("readonly",""),f.style.position="absolute",f.style.left="-9999px",document.body.appendChild(f),f.focus(),f.select();let S=!1;try{S=document.execCommand("copy")}catch{S=!1}return document.body.removeChild(f),S},w=()=>{let p=n&&n.value||r;if(p){Ce("\u0421\u0441\u044B\u043B\u043A\u0430 \u0441\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u0430");try{if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function"){let f=navigator.clipboard.writeText(p);f&&typeof f.catch=="function"&&f.catch(()=>{b(p)})}else b(p)}catch{b(p)}}};return new Promise(p=>{l=p,s.classList.remove("danger-btn"),s.textContent="\u29C9 \u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443",s.setAttribute("aria-label",e.copyLabel||"\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443"),a.classList.add("hidden"),s.addEventListener("click",()=>{w(),m()}),o.addEventListener("click",f=>{f.target===o&&m()}),document.addEventListener("keydown",h),t.appendChild(o),requestAnimationFrame(()=>{n?n.focus({preventScroll:!0}):i.focus({preventScroll:!0})})})}function Uu(e={}){let t=cn(),n=Array.isArray(e.versions)?e.versions:[],r=n[0]?.id||"",o=S=>{try{let A=new Date(S);return Number.isNaN(A.getTime())?String(S||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(A)}catch{return String(S||"")}},{overlay:i,card:s,confirmBtn:a,cancelBtn:c,form:l}=xn({title:e.title||"\u0412\u0435\u0440\u0441\u0438\u0438",confirmText:e.confirmText||"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",cancelText:e.cancelText||"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",renderBody:()=>{let S=document.createDocumentFragment(),A=document.createElement("p");if(A.className="modal-body__text",A.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0435\u0440\u0441\u0438\u044E \u0441\u0442\u0430\u0442\u044C\u0438 \u0434\u043B\u044F \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F.",S.appendChild(A),!n.length){let T=document.createElement("div");return T.className="modal-empty",T.textContent="\u0412\u0435\u0440\u0441\u0438\u0439 \u043F\u043E\u043A\u0430 \u043D\u0435\u0442.",S.appendChild(T),S}let C=document.createElement("div");return C.className="modal-list",n.forEach((T,O)=>{let $=document.createElement("label");$.className="modal-list__item";let q=document.createElement("input");q.type="radio",q.name="version",q.value=T.id||"",q.checked=O===0,q.addEventListener("change",()=>{r=q.value,a.disabled=!r,d.disabled=!r});let R=document.createElement("div");R.className="modal-list__meta";let Q=document.createElement("div");Q.className="modal-list__title",Q.textContent=T.label||o(T.created_at||T.createdAt);let Y=document.createElement("div");Y.className="modal-list__subtitle";let re=T.reason||"",Ae=o(T.created_at||T.createdAt);Y.textContent=[Ae,re].filter(Boolean).join(" \xB7 "),R.appendChild(Q),R.appendChild(Y),$.appendChild(q),$.appendChild(R),C.appendChild($)}),S.appendChild(C),S}});s.classList.add("modal-card--diff-light"),a.classList.remove("danger-btn"),a.disabled=!r;let d=document.createElement("button");d.type="button",d.className="ghost",d.textContent=e.compareText||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C",d.disabled=!r;let m=s.querySelector(".modal-footer");m&&m.insertBefore(d,a);let h=!1,b=()=>{},w=()=>{i.classList.add("modal-overlay--hide"),setTimeout(()=>i.remove(),150),document.removeEventListener("keydown",f)},p=S=>{h||(h=!0,w(),b(S))},f=S=>{S.code==="Escape"&&(S.preventDefault(),p(null))};return new Promise(S=>{b=S;let A=()=>{r&&p({action:"restore",versionId:r})};l.addEventListener("submit",C=>{C.preventDefault(),A()}),a.addEventListener("click",A),d.addEventListener("click",()=>{r&&p({action:"compare",versionId:r})}),c.addEventListener("click",()=>p(null)),i.addEventListener("click",C=>{C.target===i&&p(null)}),document.addEventListener("keydown",f),t.appendChild(i),requestAnimationFrame(()=>{s.focus({preventScroll:!0})})})}function qu(e={}){let t=cn(),n=Array.isArray(e.versions)?e.versions:[],r=String(e.excludeId||""),o=[{kind:"current",id:"__current__",title:"\u0422\u0435\u043A\u0443\u0449\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F"},...n.filter(f=>String(f.id||"")&&String(f.id||"")!==r).map(f=>({kind:"version",id:String(f.id),title:f.label||f.created_at||f.createdAt||f.id}))],i=o[0]?.id||"",{overlay:s,card:a,confirmBtn:c,cancelBtn:l,form:d}=xn({title:e.title||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C \u0441\u2026",confirmText:e.confirmText||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C",cancelText:e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430",renderBody:()=>{let f=document.createDocumentFragment(),S=document.createElement("p");S.className="modal-body__text",S.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0442\u043E\u0440\u0443\u044E \u0441\u0442\u043E\u0440\u043E\u043D\u0443 \u0441\u0440\u0430\u0432\u043D\u0435\u043D\u0438\u044F.",f.appendChild(S);let A=document.createElement("div");return A.className="modal-list",o.forEach((C,T)=>{let O=document.createElement("label");O.className="modal-list__item";let $=document.createElement("input");$.type="radio",$.name="compareTarget",$.value=C.id,$.checked=T===0,$.addEventListener("change",()=>{i=$.value,c.disabled=!i});let q=document.createElement("div");q.className="modal-list__meta";let R=document.createElement("div");R.className="modal-list__title",R.textContent=C.title,q.appendChild(R),O.appendChild($),O.appendChild(q),A.appendChild(O)}),f.appendChild(A),f}});a.classList.add("modal-card--diff-light"),c.classList.remove("danger-btn"),c.disabled=!i;let m=!1,h=()=>{},b=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",p)},w=f=>{m||(m=!0,b(),h(f))},p=f=>{f.code==="Escape"&&(f.preventDefault(),w(null))};return new Promise(f=>{h=f;let S=()=>{if(!i)return;let A=o.find(C=>C.id===i)||null;if(!A){w(null);return}if(A.kind==="current"){w({target:"current"});return}w({target:"version",versionId:A.id})};d.addEventListener("submit",A=>{A.preventDefault(),S()}),c.addEventListener("click",S),l.addEventListener("click",()=>w(null)),s.addEventListener("click",A=>{A.target===s&&w(null)}),document.addEventListener("keydown",p),t.appendChild(s),requestAnimationFrame(()=>{a.focus({preventScroll:!0})})})}function Ku(e={}){let t=cn(),n=Array.isArray(e.changes)?e.changes:[],r=n.find(b=>b.type==="changed")||n[0]||null,{overlay:o,card:i,confirmBtn:s,cancelBtn:a}=xn({title:e.title||"\u041E\u0442\u043B\u0438\u0447\u0438\u044F \u0432\u0435\u0440\u0441\u0438\u0439",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:"",renderBody:()=>{let b=document.createDocumentFragment(),w=document.createElement("div");w.className="diff-summary";let p=n.reduce((Q,Y)=>(Q[Y.type]=(Q[Y.type]||0)+1,Q),{added:0,removed:0,changed:0});if(w.textContent=`\u0418\u0437\u043C\u0435\u043D\u0435\u043D\u043E: ${p.changed||0} \xB7 \u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E: ${p.added||0} \xB7 \u0423\u0434\u0430\u043B\u0435\u043D\u043E: ${p.removed||0}`,b.appendChild(w),!n.length){let Q=document.createElement("div");return Q.className="modal-empty",Q.textContent="\u041D\u0435\u0442 \u043E\u0442\u043B\u0438\u0447\u0438\u0439.",b.appendChild(Q),b}let f=document.createElement("div");f.className="modal-list",n.forEach(Q=>{let Y=document.createElement("button");Y.type="button",Y.className=`diff-item diff-item--${Q.type}${r&&r.id===Q.id?" diff-item--active":""}`;let re=Q.label||Q.id;Y.textContent=`${Q.type==="changed"?"\u2260":Q.type==="added"?"+":"\u2212"} ${re}`,Y.addEventListener("click",()=>{r=Q,f.querySelectorAll(".diff-item").forEach(Ae=>Ae.classList.remove("diff-item--active")),Y.classList.add("diff-item--active"),R()}),f.appendChild(Y)}),b.appendChild(f);let S=document.createElement("div");S.className="diff-panes";let A=document.createElement("div");A.className="diff-pane-wrap";let C=document.createElement("div");C.className="diff-pane-wrap";let T=document.createElement("div");T.className="diff-pane-title",T.textContent=e.beforeTitle||"\u0412\u0435\u0440\u0441\u0438\u044F";let O=document.createElement("div");O.className="diff-pane-title",O.textContent=e.afterTitle||"\u0422\u0435\u043A\u0443\u0449\u0430\u044F";let $=document.createElement("div");$.className="diff-pane diff-pane--before";let q=document.createElement("div");q.className="diff-pane diff-pane--after",A.appendChild(T),A.appendChild($),C.appendChild(O),C.appendChild(q),S.appendChild(A),S.appendChild(C),b.appendChild(S);let R=()=>{let Q=r?.before||"",Y=r?.after||"";$.innerHTML="",q.innerHTML="",$.appendChild(_r({baseText:Q,nextText:Y,mode:"before"})),q.appendChild(_r({baseText:Q,nextText:Y,mode:"after"}))};return R(),b}});i.classList.add("modal-card--fullscreen"),i.classList.add("modal-card--diff-light"),s.classList.remove("danger-btn"),a&&(a.style.display="none");let c=!1,l=()=>{},d=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",h)},m=()=>{c||(c=!0,d(),l())},h=b=>{b.code==="Escape"&&(b.preventDefault(),m())};return new Promise(b=>{l=b,s.addEventListener("click",m),o.addEventListener("click",w=>{w.target===o&&m()}),document.addEventListener("keydown",h),t.appendChild(o),requestAnimationFrame(()=>{i.focus({preventScroll:!0})})})}function Vu(e={}){let t=cn(),n=Array.isArray(e.entries)?e.entries:[],r=n[0]||null,o=r,i=[],s=null,a=S=>{try{let A=new Date(S);return Number.isNaN(A.getTime())?String(S||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(A)}catch{return String(S||"")}},{overlay:c,card:l,confirmBtn:d,cancelBtn:m}=xn({title:e.title||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0431\u043B\u043E\u043A\u0430",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:e.canRestore?"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C (\u043F\u043E\u0441\u043B\u0435 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F)":"",renderBody:()=>{let S=document.createDocumentFragment(),A=document.createElement("p");if(A.className="modal-body__text",A.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0435. \u041C\u043E\u0436\u043D\u043E \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430 \u0434\u043E \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F.",S.appendChild(A),!n.length){let te=document.createElement("div");return te.className="modal-empty",te.textContent="\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430.",S.appendChild(te),S}let C=document.createElement("div");C.className="diff-layout";let T=document.createElement("div");T.className="modal-list diff-sidebar",i=[],n.forEach(te=>{let ye=document.createElement("button");ye.type="button";let je=!!(r&&r.id===te.id);ye.className=`diff-item${je?" diff-item--active":""}`,ye.setAttribute("aria-selected",je?"true":"false");let pt=a(te.timestamp);ye.textContent=pt?`\u2260 ${pt}`:`\u2260 ${te.id||""}`.trim(),ye.addEventListener("click",()=>{r=te,T.querySelectorAll(".diff-item").forEach(vt=>{vt.classList.remove("diff-item--active"),vt.setAttribute("aria-selected","false")}),ye.classList.add("diff-item--active"),ye.setAttribute("aria-selected","true"),Ee()}),T.appendChild(ye),i.push(ye)});let O=document.createElement("div");O.className="diff-main";let $=document.createElement("div");$.className="diff-panes diff-panes--side";let q=document.createElement("div");q.className="diff-pane-wrap";let R=document.createElement("div");R.className="diff-pane-wrap";let Q=document.createElement("div");Q.className="diff-pane-title",Q.textContent=e.beforeTitle||"\u0414\u043E";let Y=document.createElement("div");Y.className="diff-pane-title",Y.textContent=e.afterTitle||"\u041F\u043E\u0441\u043B\u0435";let re=document.createElement("div");re.className="diff-pane diff-pane--before";let Ae=document.createElement("div");Ae.className="diff-pane diff-pane--after",q.appendChild(Q),q.appendChild(re),R.appendChild(Y),R.appendChild(Ae),$.appendChild(q),$.appendChild(R),O.appendChild($),C.appendChild(T),C.appendChild(O),S.appendChild(C);let Ee=()=>{o=r;let te=r?.beforePlain||r?.before||"",ye=r?.afterPlain||r?.after||"";re.innerHTML="",Ae.innerHTML="",re.appendChild(_r({baseText:te,nextText:ye,mode:"before"})),Ae.appendChild(_r({baseText:te,nextText:ye,mode:"after"}))};return s=Ee,Ee(),S}});l.classList.add("modal-card--fullscreen"),l.classList.add("modal-card--diff-light"),d.classList.remove("danger-btn"),!e.canRestore&&m&&(m.style.display="none"),m&&m.classList.add("danger-btn");let h=!1,b=()=>{},w=()=>{c.classList.add("modal-overlay--hide"),setTimeout(()=>c.remove(),150),document.removeEventListener("keydown",f)},p=S=>{h||(h=!0,w(),b(S))},f=S=>{if(S.code==="Escape"&&(S.preventDefault(),p(null)),S.code==="ArrowUp"||S.code==="ArrowDown"){if(!n.length)return;S.preventDefault();let A=String(r?.id||""),C=n.findIndex($=>String($?.id||"")===A);C<0&&(C=0),C=S.code==="ArrowUp"?Math.max(0,C-1):Math.min(n.length-1,C+1);let T=n[C]||null;if(!T)return;r=T;let O=i[C];if(i.forEach($=>{$.classList.remove("diff-item--active"),$.setAttribute("aria-selected","false")}),O){O.classList.add("diff-item--active"),O.setAttribute("aria-selected","true"),O.focus({preventScroll:!0});try{O.scrollIntoView({block:"nearest"})}catch{}}typeof s=="function"&&s()}};return new Promise(S=>{b=S,d.addEventListener("click",()=>p(null)),m&&e.canRestore&&m.addEventListener("click",()=>p({action:"restore",entry:o||r||null})),c.addEventListener("click",A=>{A.target===c&&p(null)}),document.addEventListener("keydown",f),t.appendChild(c),requestAnimationFrame(()=>{l.focus({preventScroll:!0})})})}function wc(e){let t=[],n=r=>{if(!r)return;if(typeof r=="string"){t.push(r);return}if(Array.isArray(r)){r.forEach(n);return}if(typeof r!="object")return;typeof r.text=="string"&&t.push(r.text);let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(e),t.join("").replace(/\u00a0/g," ").trim()}function ju(e){return!e||typeof e!="object"?!1:!!(e.beforeHeadingJson||e.beforeBodyJson||e.afterHeadingJson||e.afterBodyJson)}function Ju(e={}){let t=cn(),r=(Array.isArray(e.entries)?e.entries:[]).filter(ju),o=typeof e.onRestore=="function"?e.onRestore:null,i=R=>String(R??"").replace(/\u00a0/g," ").trim(),s=r.map(R=>({...R,beforePlain:i(R.beforePlain??R.before??""),afterPlain:i(R.afterPlain??R.after??"")})),a=new Map;for(let R of s){let Q=String(R?.blockId||"").trim();if(!Q)continue;let Y=a.get(Q)||{blockId:Q,entries:[],latestAt:0,label:""};Y.entries.push(R);let re=Date.parse(R.timestamp||"")||0;if(re>Y.latestAt&&(Y.latestAt=re),!Y.label){let Ae=wc(R.afterHeadingJson)||wc(R.beforeHeadingJson)||"",Ee=(R.afterPlain||R.beforePlain||"").split(`
`).map(te=>te.trim()).find(Boolean)||"";Y.label=Ae||Ee||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"}a.set(Q,Y)}let c=Array.from(a.values()).sort((R,Q)=>(Q.latestAt||0)-(R.latestAt||0)),l=c[0]?.blockId||null,d=null,m=!1,h=R=>{try{let Q=new Date(R);return Number.isNaN(Q.getTime())?String(R||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(Q)}catch{return String(R||"")}},{overlay:b,card:w,confirmBtn:p,cancelBtn:f}=xn({title:e.title||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0441\u0442\u0430\u0442\u044C\u0438",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:e.canRestore?"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C":"",renderBody:()=>{let R=document.createDocumentFragment(),Q=document.createElement("p");if(Q.className="modal-body__text",Q.textContent=e.message||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439 outline-\u0440\u0435\u0436\u0438\u043C\u0430. \u041C\u043E\u0436\u043D\u043E \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0435 \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0441\u0435\u043A\u0446\u0438\u0438 (\u0435\u0441\u043B\u0438 \u0441\u0435\u043A\u0446\u0438\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u2014 \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u043D\u0435\u0446 \u0441\u0442\u0430\u0442\u044C\u0438).",R.appendChild(Q),!c.length){let Ct=document.createElement("div");return Ct.className="modal-empty",Ct.textContent="\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430.",R.appendChild(Ct),R}let Y=document.createElement("div");Y.className="diff-layout diff-layout--article-history";let re=document.createElement("div");re.className="modal-list diff-sidebar",re.classList.add("diff-sections");let Ae=document.createElement("input");Ae.type="text",Ae.className="modal-input",Ae.placeholder="\u041F\u043E\u0438\u0441\u043A \u043F\u043E \u0438\u0441\u0442\u043E\u0440\u0438\u0438\u2026",re.appendChild(Ae);let Ee=document.createElement("div");Ee.style.marginTop="8px",re.appendChild(Ee);let te=document.createElement("div");te.className="diff-main";let ye=document.createElement("div");ye.className="diff-layout diff-layout--article-history-inner";let je=document.createElement("div");je.className="modal-list diff-sidebar",je.classList.add("diff-revisions");let pt=document.createElement("div");pt.className="diff-panes diff-panes--side";let vt=document.createElement("div");vt.className="diff-pane-wrap";let Qt=document.createElement("div");Qt.className="diff-pane-wrap";let sn=document.createElement("div");sn.className="diff-pane-title",sn.textContent=e.beforeTitle||"\u0414\u043E";let pn=document.createElement("div");pn.className="diff-pane-title",pn.textContent=e.afterTitle||"\u041F\u043E\u0441\u043B\u0435";let kn=document.createElement("div");kn.className="diff-pane diff-pane--before";let _n=document.createElement("div");_n.className="diff-pane diff-pane--after",vt.appendChild(sn),vt.appendChild(kn),Qt.appendChild(pn),Qt.appendChild(_n),pt.appendChild(vt),pt.appendChild(Qt),ye.appendChild(je),ye.appendChild(pt),te.appendChild(ye),Y.appendChild(re),Y.appendChild(te),R.appendChild(Y);let Dn=()=>{let Ct=Ae.value.trim().toLowerCase(),zt=Ct?c.filter(yt=>(yt.label||"").toLowerCase().includes(Ct)?!0:(yt.entries||[]).some(ut=>`${ut.beforePlain||""}
${ut.afterPlain||""}`.toLowerCase().includes(Ct))):c;Ee.innerHTML="",zt.forEach(yt=>{let ut=document.createElement("button");ut.type="button";let Tt=yt.blockId===l;ut.className=`diff-item${Tt?" diff-item--active":""}`,ut.setAttribute("aria-selected",Tt?"true":"false");let Zt=yt.latestAt?h(new Date(yt.latestAt).toISOString()):"",G=Array.isArray(yt.entries)?yt.entries.length:0;ut.textContent=`${yt.label||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"}${Zt?` \xB7 ${Zt}`:""}${G?` \xB7 ${G}`:""}`,ut.addEventListener("click",()=>{l=yt.blockId,d=null,m=!1,Dn(),En(),vn()}),Ee.appendChild(ut)}),l&&!zt.some(yt=>yt.blockId===l)&&(l=zt[0]?.blockId||null,d=null,m=!1,En(),vn())},En=()=>{let Ct=l?a.get(l):null,zt=Array.isArray(Ct?.entries)?Ct.entries.slice():[];zt.sort((ut,Tt)=>(Date.parse(Tt.timestamp||"")||0)-(Date.parse(ut.timestamp||"")||0));let yt=d&&zt.some(ut=>String(ut?.id||"")===String(d||""));(!m||!yt)&&(d=zt[0]?.id||null),je.innerHTML="",zt.forEach(ut=>{let Tt=document.createElement("button");Tt.type="button";let Zt=String(ut.id||"")===String(d||"");Tt.className=`diff-item${Zt?" diff-item--active":""}`,Tt.setAttribute("aria-selected",Zt?"true":"false");let G=h(ut.timestamp),ie=(ut.afterPlain||ut.beforePlain||"").slice(0,64).trim();Tt.textContent=`${G?`\u2260 ${G}`:`\u2260 ${ut.id||""}`}${ie?` \xB7 ${ie}`:""}`,Tt.addEventListener("click",()=>{d=ut.id||null,m=!0,En(),vn()}),je.appendChild(Tt)})},vn=()=>{let Ct=l?a.get(l):null,zt=Array.isArray(Ct?.entries)?Ct.entries:[],yt=zt.find(Zt=>String(Zt?.id||"")===String(d||""))||zt[0]||null,ut=yt?.beforePlain||"",Tt=yt?.afterPlain||"";kn.innerHTML="",_n.innerHTML="",kn.appendChild(_r({baseText:ut,nextText:Tt,mode:"before"})),_n.appendChild(_r({baseText:ut,nextText:Tt,mode:"after"}))};return Ae.addEventListener("input",()=>{Dn()}),Dn(),En(),vn(),R}});w.classList.add("modal-card--fullscreen"),w.classList.add("modal-card--diff-light"),p.classList.remove("danger-btn"),!e.canRestore&&f&&(f.style.display="none"),f&&f.classList.add("danger-btn");let S=!1,A=()=>{},C=!1,T=()=>{b.classList.add("modal-overlay--hide"),setTimeout(()=>b.remove(),150),document.removeEventListener("keydown",$)},O=R=>{S||(S=!0,T(),A(R))},$=R=>{R.code==="Escape"&&(R.preventDefault(),O(null))},q=()=>{let R=l?a.get(l):null,Q=Array.isArray(R?.entries)?R.entries:[];return Q.find(Y=>String(Y?.id||"")===String(d||""))||Q[0]||null};return new Promise(R=>{A=R,p.addEventListener("click",()=>O(null)),f&&e.canRestore&&f.addEventListener("click",async()=>{let Q=q();if(!Q){Ce("\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430");return}if(!o){O({action:"restore",entry:Q});return}if(C)return;C=!0;let Y=f.textContent;try{f.disabled=!0,p.disabled=!0,f.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C\u2026",await o(Q)}catch(re){Ce(re?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C")}finally{C=!1,f.textContent=Y,f.disabled=!1,p.disabled=!1}}),b.addEventListener("click",Q=>{Q.target===b&&O(null)}),document.addEventListener("keydown",$),t.appendChild(b),requestAnimationFrame(()=>{w.focus({preventScroll:!0})})})}function cs(e={}){let t=cn(),n=null,r=null,{overlay:o,card:i,confirmBtn:s,cancelBtn:a,form:c}=xn({...e,renderBody:()=>{let p=document.createDocumentFragment();if(e.message){let T=document.createElement("p");T.className="modal-body__text",T.textContent=e.message,p.appendChild(T)}let f=document.createElement("label");f.className="modal-label",f.textContent=e.textLabel||"\u0422\u0435\u043A\u0441\u0442";let S=document.createElement("input");S.type="text",S.className="modal-input",S.placeholder=e.textPlaceholder||"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438",S.value=e.defaultText||"",S.autocomplete="off",f.appendChild(S);let A=document.createElement("label");A.className="modal-label",A.textContent=e.urlLabel||"\u0421\u0441\u044B\u043B\u043A\u0430";let C=document.createElement("input");return C.type="text",C.className="modal-input",C.placeholder=e.urlPlaceholder||"https://example.com",C.value=e.defaultUrl||"",C.autocomplete="off",A.appendChild(C),n=S,r=C,p.appendChild(f),p.appendChild(A),p}}),l=!1,d=()=>{},m=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",b)},h=p=>{l||(l=!0,m(),d(p))},b=p=>{if(p.code==="Escape"){p.preventDefault(),h(null);return}p.code==="Enter"&&!s.disabled&&(p.preventDefault(),h({text:(n?.value||"").trim(),url:(r?.value||"").trim()}))},w=()=>{let p=!!(r?.value||"").trim();s.disabled=!p};return new Promise(p=>{d=p,s.classList.remove("danger-btn"),s.textContent=e.confirmText||"OK",a.textContent=e.cancelText||"Cancel";let f=()=>{h({text:(n?.value||"").trim(),url:(r?.value||"").trim()})};c.addEventListener("submit",A=>{A.preventDefault(),s.disabled||f()}),s.addEventListener("click",f),a.addEventListener("click",()=>h(null)),o.addEventListener("click",A=>{A.target===o&&h(null)}),document.addEventListener("keydown",b);let S=A=>{A&&A.addEventListener("input",w)};S(n),S(r),w(),t.appendChild(o),requestAnimationFrame(()=>{r?(r.focus({preventScroll:!0}),r.value&&r.setSelectionRange(r.value.length,r.value.length)):i.focus({preventScroll:!0})})})}function xc(e={}){let t=cn(),n=null,r=null,{overlay:o,card:i,confirmBtn:s,cancelBtn:a,form:c}=xn({...e,renderBody:()=>{let p=document.createDocumentFragment();if(e.message){let T=document.createElement("p");T.className="modal-body__text",T.textContent=e.message,p.appendChild(T)}let f=document.createElement("label");f.className="modal-label",f.textContent="\u041F\u0430\u0440\u043E\u043B\u044C";let S=document.createElement("input");S.type="password",S.className="modal-input",S.placeholder="\u041F\u0430\u0440\u043E\u043B\u044C \u0434\u043B\u044F \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B",S.autocomplete="off",f.appendChild(S);let A=document.createElement("label");A.className="modal-label",A.textContent="\u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0430 (\u043D\u0435\u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u044C\u043D\u043E)";let C=document.createElement("input");return C.type="text",C.className="modal-input",C.placeholder="\u041D\u0430\u043F\u043E\u043C\u0438\u043D\u0430\u043D\u0438\u0435 \u043E \u043F\u0430\u0440\u043E\u043B\u0435",C.autocomplete="off",A.appendChild(C),n=S,r=C,p.appendChild(f),p.appendChild(A),p}}),l=!1,d=()=>{},m=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",b)},h=p=>{l||(l=!0,m(),d(p))},b=p=>{if(p.code==="Escape"){p.preventDefault(),h(null);return}p.code==="Enter"&&!s.disabled&&(p.preventDefault(),h({password:(n?.value||"").trim(),hint:(r?.value||"").trim()}))},w=()=>{let p=!!(n?.value||"").trim();s.disabled=!p};return new Promise(p=>{d=p,s.classList.remove("danger-btn"),s.textContent=e.confirmText||"\u0417\u0430\u0449\u0438\u0442\u0438\u0442\u044C",a.textContent=e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430";let f=()=>{s.disabled||h({password:(n?.value||"").trim(),hint:(r?.value||"").trim()})};s.addEventListener("click",f),c.addEventListener("submit",S=>{S.preventDefault(),f()}),a.addEventListener("click",()=>h(null)),o.addEventListener("click",S=>{S.target===o&&h(null)}),document.addEventListener("keydown",b),n&&n.addEventListener("input",w),w(),t.appendChild(o),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):i.focus({preventScroll:!0})})})}function Wu(e={}){let t=cn(),n=Array.isArray(e.items)?e.items:[],{overlay:r,card:o,confirmBtn:i,cancelBtn:s}=xn({title:e.title||"\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432",renderBody:()=>{let h=document.createElement("div");if(!n.length){let w=document.createElement("p");return w.className="modal-body__text",w.textContent="\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432 \u043F\u0443\u0441\u0442\u0430",h.appendChild(w),h}let b=document.createElement("div");return b.className="block-trash-list",n.forEach(w=>{let p=document.createElement("div");p.className="block-trash-item";let f=w.block&&w.block.text||"",S=yc(f),A=document.createElement("div");A.className="block-trash-item__title",A.textContent=S[0]||"(\u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A)";let C=document.createElement("div");C.className="block-trash-item__meta";let T=w.deletedAt?new Date(w.deletedAt).toLocaleString():"";C.textContent=T||"";let O=document.createElement("div");O.className="block-trash-item__info",O.appendChild(A),T&&O.appendChild(C);let $=document.createElement("button");$.type="button",$.className="primary",$.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",$.addEventListener("click",()=>{d(w)}),p.appendChild(O),p.appendChild($),b.appendChild(p)}),h.appendChild(b),h}}),a=!1,c=()=>{},l=()=>{r.classList.add("modal-overlay--hide"),setTimeout(()=>r.remove(),150),document.removeEventListener("keydown",m)},d=h=>{a||(a=!0,l(),c(h||null))},m=h=>{h.code==="Escape"&&(h.preventDefault(),d(null))};return new Promise(h=>{c=h,i.classList.remove("hidden"),i.textContent="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u043A\u043E\u0440\u0437\u0438\u043D\u0443",i.classList.add("danger-btn"),s.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",i.addEventListener("click",()=>d({action:"clear"})),s.addEventListener("click",()=>d(null)),r.addEventListener("click",b=>{b.target===r&&d(null)}),document.addEventListener("keydown",m),t.appendChild(r),requestAnimationFrame(()=>{o.focus({preventScroll:!0})})})}function Yu(e={}){let t=cn(),{title:n,message:r,existingTitle:o,importedTitle:i,existingCreatedAt:s,existingUpdatedAt:a,importedCreatedAt:c,importedUpdatedAt:l,allowApplyToAll:d=!0}=e||{},m=document.createElement("div");m.className="modal-overlay";let h=document.createElement("div");h.className="modal-card",h.setAttribute("role","dialog"),h.setAttribute("aria-modal","true"),h.tabIndex=-1;let b=document.createElement("div");b.className="modal-header";let w=document.createElement("h3");w.textContent=n||"\u041A\u043E\u043D\u0444\u043B\u0438\u043A\u0442 \u043F\u0440\u0438 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0438",b.appendChild(w);let p=document.createElement("div");if(p.className="modal-body",r){let re=document.createElement("p");re.className="modal-body__text",re.textContent=r,p.appendChild(re)}if(o||i){let re=document.createElement("p");re.className="modal-body__text",re.innerHTML=[o?`<strong>\u0412 \u0431\u0430\u0437\u0435:</strong> ${o}`:"",i?`<strong>\u0418\u0437 \u0444\u0430\u0439\u043B\u0430:</strong> ${i}`:""].filter(Boolean).join("<br />"),p.appendChild(re)}if(s||a||c||l){let re=te=>{if(!te)return"";let ye=new Date(te);return Number.isNaN(ye.getTime())?te:ye.toLocaleString()},Ae=document.createElement("p");Ae.className="modal-body__text";let Ee=[];if(s||a){let te=s?re(s):"\u2014",ye=a?re(a):"\u2014";Ee.push(`<strong>\u0412 \u0431\u0430\u0437\u0435:</strong> \u0441\u043E\u0437\u0434\u0430\u043D\u0430 ${te}, \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430 ${ye}`)}if(c||l){let te=c?re(c):"\u2014",ye=l?re(l):"\u2014";Ee.push(`<strong>\u0418\u0437 \u0444\u0430\u0439\u043B\u0430:</strong> \u0441\u043E\u0437\u0434\u0430\u043D\u0430 ${te}, \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430 ${ye}`)}Ae.innerHTML=Ee.join("<br />"),p.appendChild(Ae)}let f=null;if(d){let re=document.createElement("label");re.className="modal-label";let Ae=document.createElement("input");Ae.type="checkbox",Ae.style.marginRight="0.5rem",re.appendChild(Ae),re.appendChild(document.createTextNode("\u041F\u0440\u0438\u043C\u0435\u043D\u044F\u0442\u044C \u044D\u0442\u043E \u0440\u0435\u0448\u0435\u043D\u0438\u0435 \u043A\u043E \u0432\u0441\u0435\u043C \u043A\u043E\u043D\u0444\u043B\u0438\u043A\u0442\u0430\u043C")),f=Ae,p.appendChild(re)}let S=document.createElement("div");S.className="modal-footer modal-footer--stacked";let A=document.createElement("button");A.type="button",A.className="ghost",A.textContent="\u041E\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0443\u044E";let C=document.createElement("button");C.type="button",C.className="primary danger-btn",C.textContent="\u041F\u0435\u0440\u0435\u0437\u0430\u043F\u0438\u0441\u0430\u0442\u044C";let T=document.createElement("button");T.type="button",T.className="ghost",T.textContent="\u0421\u043E\u0437\u0434\u0430\u0442\u044C \u043A\u043E\u043F\u0438\u044E";let O=document.createElement("button");O.type="button",O.className="ghost",O.textContent="\u041E\u0442\u043C\u0435\u043D\u0430",S.appendChild(A),S.appendChild(C),S.appendChild(T),S.appendChild(O),h.appendChild(b),h.appendChild(p),h.appendChild(S),m.appendChild(h);let $=!1,q=()=>{},R=()=>{m.classList.add("modal-overlay--hide"),setTimeout(()=>m.remove(),150),document.removeEventListener("keydown",Y)},Q=re=>{if($)return;$=!0;let Ae=!!(f&&f.checked);R(),q({action:re,applyToAll:Ae})},Y=re=>{re.code==="Escape"&&(re.preventDefault(),Q(null))};return new Promise(re=>{q=re,A.addEventListener("click",()=>Q("keep")),C.addEventListener("click",()=>Q("overwrite")),T.addEventListener("click",()=>Q("copy")),O.addEventListener("click",()=>Q(null)),m.addEventListener("click",Ae=>{Ae.target===m&&Q(null)}),document.addEventListener("keydown",Y),t.appendChild(m),requestAnimationFrame(()=>{h.focus({preventScroll:!0})})})}function so(e,t=""){let n=cn(),r=document.createElement("div");r.className="modal-overlay image-modal";let o=document.createElement("div");o.className="image-modal__card",o.setAttribute("role","dialog"),o.setAttribute("aria-modal","true"),o.tabIndex=-1;let i=document.createElement("img");i.className="image-modal__img",i.src=e,t&&(i.alt=t),o.appendChild(i),r.appendChild(o);let s,a=()=>{s&&s()},c=l=>{l.code==="Escape"&&(l.preventDefault(),a())};s=()=>{document.removeEventListener("keydown",c),r.classList.add("modal-overlay--hide"),setTimeout(()=>r.remove(),150)},r.addEventListener("click",l=>{l.target===r&&a()}),document.addEventListener("keydown",c),n.appendChild(r),requestAnimationFrame(()=>{o.focus({preventScroll:!0})})}var bc,Qn=Je(()=>{Bn();Vt();bc="modal-root"});function Ac(e){if(typeof btoa=="function"){let t="";for(let n=0;n<e.length;n+=1)t+=String.fromCharCode(e[n]);return btoa(t)}if(typeof Buffer<"u")return Buffer.from(e).toString("base64");throw new Error("No base64 encoder available")}function Ic(e){if(!e)return new Uint8Array(0);if(typeof atob=="function"){let t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r+=1)n[r]=t.charCodeAt(r);return n}if(typeof Buffer<"u"){let t=Buffer.from(e,"base64"),n=new Uint8Array(t.length);for(let r=0;r<t.length;r+=1)n[r]=t[r];return n}throw new Error("No base64 decoder available")}function us(e){return typeof e=="string"&&e.startsWith(ds)}async function kc(e,t){if(!e)throw new Error("Password is required");let n=t&&t.length?Ic(t):Ec(16),r=Wo(e||""),o=new Uint8Array(r.length+n.length);return o.set(r,0),o.set(n,r.length),{key:{raw:Wo(String.fromCharCode(...o))},salt:Ac(n)}}function Wo(e=""){let t=2166136261,n=16777619;for(let o=0;o<e.length;o+=1){let i=e.charCodeAt(o);t^=i,t=t*16777619>>>0,n^=i<<o%8,n=n*16777619>>>0}let r=new Uint8Array(32);for(let o=0;o<32;o+=1){let i=o<16?t:n;r[o]=i>>>o%4*8&255}return r}function Ec(e){let t=new Uint8Array(e);for(let n=0;n<e;n+=1)t[n]=Math.floor(Math.random()*256);return t}async function Xu(e,t=""){if(!e)throw new Error("Missing encryption key");let n=e&&e.raw?e.raw:Wo("fallback-key"),r=Ec(12),i=new TextEncoder().encode(t||""),s=new Uint8Array(r.length+i.length);s.set(r,0);for(let a=0;a<i.length;a+=1){let c=n[a%n.length],l=r[a%r.length];s[r.length+a]=i[a]^c^l}return`${ds}${Ac(s)}`}async function fs(e,t){if(!e)throw new Error("Missing encryption key");if(!us(t))throw new Error("Data is not in encrypted format");let n=t.slice(ds.length),r=Ic(n);if(r.length<13)throw new Error("Encrypted payload is too short");let o=r.slice(0,12),i=r.slice(12),s=e&&e.raw?e.raw:Wo("fallback-key"),a=new Uint8Array(i.length);for(let l=0;l<i.length;l+=1){let d=s[l%s.length],m=o[l%o.length];a[l]=i[l]^d^m}return new TextDecoder().decode(a)}async function vc(e,t){if(!t)return!1;try{return await fs(e,t)===Gu}catch{return!1}}async function Cc(e,t){if(!e)return;if(typeof e.text=="string"&&us(e.text))try{e.text=await fs(t,e.text)}catch{e.text=""}let n=Array.isArray(e.children)?e.children:[];for(let r of n)await Cc(r,t)}async function ps(e,t){if(!(!e||!Array.isArray(e.blocks)))for(let n of e.blocks)await Cc(n,t)}async function ms(e,t){return Xu(e,t||"")}var ds,Gu,ao=Je(()=>{ds="enc-v1:",Gu="memus-article-encryption-ok"});function ln(e){if(window.location.pathname===e){Tc(e);return}window.history.pushState({},"",e),Tc(e)}function Tc(e){let t=e.match(/^\/p\/([^/?#]+)/);if(t){gs(decodeURIComponent(t[1]));return}let n=e.match(/^\/article\/([0-9a-zA-Z-]+)/);if(n){let r=String(n[1]||"");if(r.startsWith("inbox-")){try{window.history.replaceState({},"",Wt.article("inbox"))}catch{}Yo("inbox");return}Yo(r);return}hs()}var Wt,Zn=Je(()=>{pr();Wt={list:"/",article:e=>`/article/${e}`,public:e=>`/p/${e}`}});var Bc=Je(()=>{Yn();Sn()});function Nc(){J.searchResults&&J.searchResults.classList.add("hidden")}var Mc=Je(()=>{St();mn();Bn();en();Zn();er();Vt();Bc()});function Go(){try{localStorage.setItem(Zu,JSON.stringify(u.sidebarCollapsedArticleIds||[]))}catch{}}function Xo(){try{localStorage.setItem(ef,JSON.stringify(u.listCollapsedArticleIds||[]))}catch{}}var Zu,ef,Dr=Je(()=>{St();Zu="ttree_collapsed_articles",ef="ttree_list_collapsed_articles"});function ys(){J.articlesTabBtn&&(J.articlesTabBtn.classList.toggle("active",!u.isTrashView),J.articlesTabBtn.setAttribute("aria-pressed",u.isTrashView?"false":"true")),J.trashTabBtn&&(J.trashTabBtn.classList.toggle("active",u.isTrashView),J.trashTabBtn.setAttribute("aria-pressed",u.isTrashView?"true":"false")),J.createArticleBtn&&(J.createArticleBtn.disabled=u.isTrashView),J.sidebarNewArticleBtn&&(J.sidebarNewArticleBtn.disabled=u.isTrashView)}function Qo(){Fi&&(Ca(!1),J.hintPopover&&J.hintPopover.classList.add("hidden"),J.hintToggleBtn&&J.hintToggleBtn.setAttribute("aria-expanded","false"))}function co(e){u.isSidebarMobileOpen=e,J.sidebar&&J.sidebar.classList.toggle("mobile-open",e),J.sidebarBackdrop&&J.sidebarBackdrop.classList.toggle("hidden",!e),e&&(Qo(),Nc())}function lo(e){J.articleView.classList.toggle("hidden",!e),J.articleListView.classList.toggle("hidden",e),J.articleHeader&&J.articleHeader.classList.toggle("hidden",!e),e||Qo(),e&&u.isTrashView&&(u.isTrashView=!1,ys())}var Zo=Je(()=>{St();mn();Mc();Dr()});function Oc({renderSidebarArticleList:e,renderMainArticleList:t,setArticlesIndex:n}={}){_c=typeof e=="function"?e:null,bs=typeof t=="function"?t:null,Dc=typeof n=="function"?n:null}function ti(){Nn&&(Nn.classList.remove("drop-before","drop-after","drop-inside"),Nn=null)}function Rc(e,t){e&&(Nn&&Nn!==e&&Nn.classList.remove("drop-before","drop-after","drop-inside"),Nn=e,Nn.classList.remove("drop-before","drop-after","drop-inside"),t==="before"?Nn.classList.add("drop-before"):t==="after"?Nn.classList.add("drop-after"):t==="inside"&&Nn.classList.add("drop-inside"))}function rf(){ht&&(ht.sourceEl instanceof Element&&ht.sourceEl.classList.remove("article-dnd-source"),typeof document<"u"&&document.body&&document.body.classList.remove("article-dnd-active"),window.removeEventListener("pointermove",xs),window.removeEventListener("pointerup",uo),window.removeEventListener("pointercancel",uo),window.removeEventListener("touchmove",Hc),window.removeEventListener("touchend",ei),window.removeEventListener("touchcancel",ei),ht=null,ti(),window.__ttreeDraggingArticleId=null)}function Lc(e){return e instanceof Element?!!(e.closest(".star-btn")||e.closest(".row-actions")):!1}function of(e,t){if(!t||ht||!e.touches||e.touches.length!==1)return;let n=e.touches[0],r=e.currentTarget instanceof Element?e.currentTarget:null;ht={pointerId:"legacy-touch",articleId:t,startX:n.clientX,startY:n.clientY,dragging:!1,lastTargetId:null,lastDropMode:null,sourceEl:r},window.__ttreeDraggingArticleId=t,typeof document<"u"&&document.body&&document.body.classList.add("article-dnd-active");try{let o=window.getSelection?window.getSelection():null;o&&!o.isCollapsed&&o.removeAllRanges()}catch{}window.addEventListener("touchmove",Hc,{passive:!1}),window.addEventListener("touchend",ei),window.addEventListener("touchcancel",ei)}function Hc(e){if(!ht||!e.touches||e.touches.length===0)return;let t=e.touches[0];xs({pointerId:"legacy-touch",clientX:t.clientX,clientY:t.clientY,preventDefault:()=>{e.preventDefault()}})}function ei(){ht&&uo({pointerId:"legacy-touch"})}function sf(e,t){let n=document.elementFromPoint(e,t);if(!n)return null;let r=n.closest(".sidebar-article-item, #articleList li");return!r||!r.dataset||!r.dataset.articleId?null:r}function af(e,t){if(!t||ht)return;let n=e.currentTarget instanceof Element?e.currentTarget:null;ht={pointerId:e.pointerId,articleId:t,startX:e.clientX,startY:e.clientY,dragging:!1,lastTargetId:null,lastDropMode:null,sourceEl:n},window.__ttreeDraggingArticleId=t,typeof document<"u"&&document.body&&document.body.classList.add("article-dnd-active");try{let r=window.getSelection?window.getSelection():null;r&&!r.isCollapsed&&r.removeAllRanges()}catch{}try{e.currentTarget?.setPointerCapture?.(e.pointerId)}catch{}window.addEventListener("pointermove",xs),window.addEventListener("pointerup",uo),window.addEventListener("pointercancel",uo)}function xs(e){if(!ht||e.pointerId!==ht.pointerId)return;let t=e.clientX-ht.startX,n=e.clientY-ht.startY;if(!ht.dragging){if(Math.hypot(t,n)<tf)return;ht.dragging=!0,ht.sourceEl instanceof Element&&ht.sourceEl.classList.add("article-dnd-source")}e.preventDefault();let r=sf(e.clientX,e.clientY);if(!r||!r.dataset||!r.dataset.articleId||r.dataset.articleId===ht.articleId){ti(),ht.lastTargetId=null,ht.lastDropMode=null;return}let o=r.getBoundingClientRect(),i=e.clientY-o.top,s=o.height/3,a;i<s?a="before":i>o.height-s?a="after":a="inside",ht.lastTargetId=r.dataset.articleId,ht.lastDropMode=a,Rc(r,a)}function uo(e){if(!ht||e.pointerId!==ht.pointerId)return;let t=ht;rf(),!(!t.dragging||!t.lastTargetId||!t.lastDropMode)&&t.lastTargetId!==t.articleId&&$c(t.articleId,t.lastTargetId,t.lastDropMode)}function As(e,t){e&&(nf?e.addEventListener("pointerdown",n=>{if(n.pointerType!=="touch"||typeof n.button=="number"&&n.button!==0||Lc(n.target))return;let r=n.pointerId,o=350,i=!1,s=window.setTimeout(()=>{i=!0,af(n,t)},o),a=c=>{c.pointerId===r&&(i||window.clearTimeout(s),window.removeEventListener("pointerup",a,!0),window.removeEventListener("pointercancel",a,!0))};window.addEventListener("pointerup",a,!0),window.addEventListener("pointercancel",a,!0)}):e.addEventListener("touchstart",n=>{if(!n.touches||n.touches.length!==1)return;let r=n.target;if(Lc(r))return;let o=350,i=!1,s=window.setTimeout(()=>{i=!0,of(n,t)},o),a=()=>{i||window.clearTimeout(s),window.removeEventListener("touchend",a,!0),window.removeEventListener("touchcancel",a,!0)};window.addEventListener("touchend",a,!0),window.addEventListener("touchcancel",a,!0)},{passive:!1}))}function Ss(e){return e&&(u.articlesIndex||[]).find(t=>t.id===e)||null}function Pc(e){let t=e||null;return(u.articlesIndex||[]).filter(n=>(n.parentId||null)===t).sort((n,r)=>n.position!==r.position?n.position-r.position:new Date(n.updatedAt||0)-new Date(r.updatedAt||0))}function cf(e,t,n,r){if(!e)return;let o=Ss(e);if(!o)return;let i=t||null,s=o.parentId||null,c=Pc(s).filter(b=>b.id!==e),l;i===s?l=c:l=Pc(i);let d=l.filter(b=>b.id!==e),m=d.length;if(n&&r&&r!=="inside"){let b=d.findIndex(w=>w.id===n);b!==-1&&(m=r==="before"?b:b+1)}r==="inside"&&(m=d.length),m<0&&(m=0),m>d.length&&(m=d.length);let h=d.slice();h.splice(m,0,o),o.parentId=i,c.forEach((b,w)=>{b.position=w}),h.forEach((b,w)=>{b.parentId=i,b.position=w})}function $c(e,t,n){if(!e||!t||!n)return;let r=Ss(e),o=Ss(t);if(!r||!o)return;let i=n==="inside"?o.id:o.parentId||null,s=n==="inside"?null:o.id;cf(e,i,s,n),_c?.(),bs?.(),(async()=>{try{await ss(e,{parentId:i,anchorId:s,placement:n})}catch(a){try{let c=await hn();Dc?.(c),bs?.()}catch{}Ce(a.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443")}})()}function lf(e){window.__ttreeDraggingArticleId?dn=window.__ttreeDraggingArticleId:dn=e.currentTarget?.dataset?.articleId||null,e.dataTransfer&&(e.dataTransfer.effectAllowed="move",dn&&e.dataTransfer.setData("text/plain",dn))}function df(e){if(!dn){let s=window.__ttreeDraggingArticleId,a=null;if(!s&&e?.dataTransfer)try{a=e.dataTransfer.getData("text/plain")||null}catch{a=null}dn=s||a||null}if(!dn||!e.currentTarget||!e.currentTarget.dataset.articleId)return;e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="move");let t=e.currentTarget,n=t.getBoundingClientRect(),r=e.clientY-n.top,o=n.height/3,i;r<o?i="before":r>n.height-o?i="after":i="inside",Rc(t,i)}function uf(e){if(!dn){let a=window.__ttreeDraggingArticleId,c=null;if(!a&&e?.dataTransfer)try{c=e.dataTransfer.getData("text/plain")||null}catch{c=null}dn=a||c||null}if(!dn)return;let t=e.currentTarget,n=t?.dataset?.articleId||null;if(!n||n===dn)return;e.preventDefault(),ti();let r=t.getBoundingClientRect(),o=e.clientY-r.top,i=r.height/3,s;o<i?s="before":o>r.height-i?s="after":s="inside",$c(dn,n,s),dn=null}function ff(){dn=null,window.__ttreeDraggingArticleId=null,ti()}function Is(e){e&&(e.draggable=!0,e.addEventListener("dragstart",lf),e.addEventListener("dragover",df),e.addEventListener("drop",uf),e.addEventListener("dragend",ff))}var _c,bs,Dc,ws,dn,Nn,tf,ht,nf,ks=Je(()=>{St();en();Vt();_c=null,bs=null,Dc=null;ws=!1;typeof window<"u"&&(window.matchMedia&&window.matchMedia("(pointer: coarse)").matches||"ontouchstart"in window)&&(ws=!0);dn=null,Nn=null,tf=6,ht=null,nf=typeof window<"u"&&"PointerEvent"in window&&!ws});function pf(){try{let e=localStorage.getItem(zc),t=e?JSON.parse(e):[];u.favoriteArticles=Array.isArray(t)?t:[]}catch{u.favoriteArticles=[]}}function mf(){try{localStorage.setItem(zc,JSON.stringify(u.favoriteArticles||[]))}catch{}}function Uc(e=[]){let t=new Set(u.favoriteArticles||[]);return[...e].sort((n,r)=>{let o=t.has(n.id),i=t.has(r.id);return o!==i?o?-1:1:new Date(r.updatedAt||r.deletedAt||0)-new Date(n.updatedAt||n.deletedAt||0)})}function ni(e){if(!e)return;u.favoriteArticles||(u.favoriteArticles=[]);let t=new Set(u.favoriteArticles);t.has(e)?t.delete(e):t.add(e),u.favoriteArticles=Array.from(t),mf(),$t(),An()}function ri(e=[]){(!u.favoriteArticles||!u.favoriteArticles.length)&&pf();let t=Array.isArray(e)?e:[];u.articlesIndex=t.map(r=>({id:r.id,title:r.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",updatedAt:r.updatedAt||new Date().toISOString(),deletedAt:r.deletedAt||null,publicSlug:r.publicSlug||null,parentId:r.parentId||null,position:typeof r.position=="number"?r.position:0}));let n=new Set(u.articlesIndex.map(r=>r.id));Array.isArray(u.sidebarCollapsedArticleIds)&&u.sidebarCollapsedArticleIds.length&&(u.sidebarCollapsedArticleIds=u.sidebarCollapsedArticleIds.filter(r=>n.has(r)),Go()),Array.isArray(u.listCollapsedArticleIds)&&u.listCollapsedArticleIds.length&&(u.listCollapsedArticleIds=u.listCollapsedArticleIds.filter(r=>n.has(r)),Xo()),$t()}function qc(e=[]){let t=Uc(Array.isArray(e)?e:[]);u.deletedArticlesIndex=t,$t()}function Or(e){if(!e||!e.id||e.deletedAt)return;let t={id:e.id,title:e.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",updatedAt:e.updatedAt||new Date().toISOString(),publicSlug:e.publicSlug||null,parentId:e.parentId||null,position:typeof e.position=="number"?e.position:0},n=u.articlesIndex.findIndex(r=>r.id===t.id);n>=0?u.articlesIndex[n]={...u.articlesIndex[n],...t}:u.articlesIndex.unshift(t),$t()}function Es(e){if(!e)return;let t=u.articlesIndex.length;u.articlesIndex=u.articlesIndex.filter(n=>n.id!==e),t!==u.articlesIndex.length&&($t(),An())}function vs(e){if(!e)return;let t=u.deletedArticlesIndex.length;u.deletedArticlesIndex=u.deletedArticlesIndex.filter(n=>n.id!==e),t!==u.deletedArticlesIndex.length&&($t(),An())}function Kc(e=[]){let t=new Map;e.forEach(o=>{t.set(o.id,{...o,children:[]})});let n=[];t.forEach(o=>{let i=o.parentId||null;i&&t.has(i)?t.get(i).children.push(o):n.push(o)});let r=o=>{o.sort((i,s)=>{let a=(u.favoriteArticles||[]).includes(i.id),c=(u.favoriteArticles||[]).includes(s.id);return a!==c?a?-1:1:i.position!==s.position?i.position-s.position:new Date(s.updatedAt||0)-new Date(i.updatedAt||0)}),o.forEach(i=>r(i.children||[]))};return r(n),n}function $t(){if(!J.sidebarArticleList)return;J.sidebarArticleList.innerHTML="",J.backToList&&J.backToList.classList.toggle("active",u.sidebarArticlesMode!=="recent"),J.sidebarRecentBtn&&J.sidebarRecentBtn.classList.toggle("active",u.sidebarArticlesMode==="recent");let e=(u.articleFilterQuery||"").trim().toLowerCase(),t=u.sidebarArticlesMode==="recent"?"recent":"tree",n=u.isTrashView?u.deletedArticlesIndex:u.articlesIndex,r=new Set(u.favoriteArticles||[]),o=new Set(u.sidebarCollapsedArticleIds||[]),i=u.sidebarSelectedArticleId||u.articleId,s=Array.isArray(u.recentArticleIds)?u.recentArticleIds:[],a=[];if(!u.isTrashView&&(r.has("RAG")||t==="recent"&&s.includes("RAG"))){let p=(u.ragQuery||"").trim();a.push({id:"RAG",title:p?`AI: ${p}`:"AI: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B \u043F\u043E\u0438\u0441\u043A\u0430",updatedAt:new Date().toISOString(),deletedAt:null,publicSlug:null,parentId:null,position:0})}let l=new Set(a.map(p=>p.id)),d=a.length&&!u.isTrashView?[...(n||[]).filter(p=>!l.has(p.id)),...a]:n,m=new Set;(d||[]).forEach(p=>{let f=p.parentId||null;f&&m.add(f)});let h=(d||[]).filter(p=>(e?(p.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(e):!0)&&(u.isTrashView?!0:p.id!=="inbox"));if(!h.length){let p=document.createElement("li");p.className="sidebar-article-empty",p.textContent=u.isTrashView?e?"No deleted pages match the filter":"Trash is empty":e?"\u041D\u0435\u0442 \u0441\u043E\u0432\u043F\u0430\u0434\u0435\u043D\u0438\u0439":"\u041D\u0435\u0442 \u0441\u0442\u0430\u0442\u0435\u0439",J.sidebarArticleList.appendChild(p);return}if(t==="recent"){let p=new Map(h.map(T=>[T.id,T])),f=new Set(s),S=s.map(T=>p.get(T)).filter(Boolean),A=Uc(h.filter(T=>!f.has(T.id)));[...S,...A].forEach(T=>{let O=document.createElement("li");O.className="sidebar-article-item",O.dataset.articleId=T.id;let $=document.createElement("div");$.className="sidebar-article-row";let q=document.createElement("button");q.type="button",!u.isTrashView&&T.id===i&&q.classList.add("active");let R=r.has(T.id),Q=qt(T.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),Y=T.publicSlug?"\uE774 ":"";q.innerHTML=`<span class="sidebar-article-title">${Y}${Q}</span><span class="star-btn ${R?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${R?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}">${R?"\uE735":"\uE734"}</span>`,q.addEventListener("click",()=>{window.__ttreeDraggingArticleId||(u.sidebarSelectedArticleId=T.id,ln(Wt.article(T.id)),u.isSidebarMobileOpen&&co(!1))});let re=q.querySelector(".star-btn");re&&re.addEventListener("click",Ae=>{Ae.stopPropagation(),ni(T.id)}),$.appendChild(q),O.appendChild($),J.sidebarArticleList.appendChild(O)});return}let b=Kc(h),w=(p,f)=>{let S=document.createElement("li");S.className="sidebar-article-item",m.has(p.id)&&(S.classList.add("has-children"),o.has(p.id)&&S.classList.add("is-collapsed")),S.dataset.articleId=p.id,S.style.paddingLeft=`${f*1.25}rem`;let A=document.createElement("div");A.className="sidebar-article-row";let C=document.createElement("button");C.type="button",!u.isTrashView&&p.id===i&&C.classList.add("active");let T=r.has(p.id),O=qt(p.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),$=p.publicSlug?"\uE774 ":"";C.innerHTML=`<span class="sidebar-article-title">${$}${O}</span><span class="star-btn ${T?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${T?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}">${T?"\uE735":"\uE734"}</span>`,C.addEventListener("click",()=>{if(window.__ttreeDraggingArticleId)return;u.sidebarSelectedArticleId=p.id,u.sidebarCollapsedArticleIds||(u.sidebarCollapsedArticleIds=[]);let R=new Set(u.sidebarCollapsedArticleIds);R.has(p.id)?R.delete(p.id):R.add(p.id),u.sidebarCollapsedArticleIds=Array.from(R),Go(),$t()}),C.addEventListener("dblclick",R=>{R.preventDefault(),R.stopPropagation(),u.sidebarSelectedArticleId=p.id,ln(Wt.article(p.id)),u.isSidebarMobileOpen&&co(!1)});let q=C.querySelector(".star-btn");q&&q.addEventListener("click",R=>{R.stopPropagation(),ni(p.id)}),A.appendChild(C),S.appendChild(A),u.isTrashView||(Is(S),As(S,p.id)),J.sidebarArticleList.appendChild(S),o.has(p.id)||(p.children||[]).forEach(R=>w(R,f+1))};b.forEach(p=>w(p,0))}function An(e=null){if(!J.articleList)return;J.articleList.innerHTML="";let t="",n=Array.isArray(e)&&e.length?e:u.isTrashView?u.deletedArticlesIndex:u.articlesIndex,r=new Set(u.favoriteArticles||[]),o=new Set(u.listCollapsedArticleIds||[]),i=u.listSelectedArticleId||u.articleId,s=new Set;if(n.forEach(d=>{let m=d.parentId||null;m&&s.add(m)}),!n.length){let d=document.createElement("li");d.textContent=u.isTrashView?t?"No deleted pages match the filter":"Trash is empty":t?"\u041D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E":"\u0421\u043F\u0438\u0441\u043E\u043A \u043F\u0443\u0441\u0442.",J.articleList.appendChild(d);return}if(u.isTrashView){n.slice().filter(d=>(t?(d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(t):!0)&&(u.isTrashView?!0:d.id!=="inbox")).forEach(d=>{let m=document.createElement("li");m.dataset.articleId=d.id,m.innerHTML=`
      <span>
        <strong>${qt(d.title)}</strong>
      </span>
      <div class="row-actions">
        <button class="ghost restore-btn" data-id="${d.id}">\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C</button>
        <button class="ghost danger delete-btn" data-id="${d.id}">\u0423\u0434\u0430\u043B\u0438\u0442\u044C</button>
      </div>
    `;let h=m.querySelector(".restore-btn"),b=m.querySelector(".delete-btn");h&&h.addEventListener("click",async w=>{w.preventDefault(),w.stopPropagation(),await hf(d.id)}),b&&b.addEventListener("click",async w=>{w.preventDefault(),w.stopPropagation(),await gf(d.id)}),J.articleList.appendChild(m)});return}let a=n.slice().filter(d=>(t?(d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(t):!0)&&d.id!=="inbox"),c=Kc(a),l=(d,m)=>{let h=document.createElement("li");s.has(d.id)&&(h.classList.add("has-children"),o.has(d.id)&&h.classList.add("is-collapsed")),h.dataset.articleId=d.id;let b=r.has(d.id),w=qt(d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),p=d.publicSlug?'<span class="article-public-icon">&#xE774;</span>':"";h.style.paddingLeft=`${m*1.25}rem`,h.innerHTML=`
      <span>
        <strong>${p}${w}</strong>
      </span>
      <button class="ghost star-btn ${b?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${b?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}">${b?"\uE735":"\uE734"}</button>
    `;let f=h.querySelector(".star-btn");f&&f.addEventListener("click",S=>{S.preventDefault(),S.stopPropagation(),ni(d.id)}),d.id===i&&h.classList.add("active-article"),h.addEventListener("click",()=>{if(window.__ttreeDraggingArticleId)return;u.listSelectedArticleId=d.id,u.listCollapsedArticleIds||(u.listCollapsedArticleIds=[]);let S=new Set(u.listCollapsedArticleIds);S.has(d.id)?S.delete(d.id):S.add(d.id),u.listCollapsedArticleIds=Array.from(S),Xo(),An()}),h.addEventListener("dblclick",S=>{S.preventDefault(),S.stopPropagation(),u.listSelectedArticleId=d.id,ln(Wt.article(d.id))}),J.articleList.appendChild(h),u.isTrashView||(Is(h),As(h,d.id)),o.has(d.id)||(d.children||[]).forEach(S=>l(S,m+1))};c.forEach(d=>l(d,0))}async function hf(e){if(e)try{let t=await mc(e);vs(e),Or(t),await Vc(!1),ln(Wt.article(t.id)),Ce("Page restored")}catch(t){Ce(t.message)}}async function gf(e){if(e)try{await pc(e,{force:!0}),vs(e),Ce("\u0421\u0442\u0430\u0442\u044C\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u0431\u0435\u0437\u0432\u043E\u0437\u0432\u0440\u0430\u0442\u043D\u043E"),An(),$t()}catch(t){Ce(t.message)}}async function Vc(e){u.isTrashView=e,ys(),e?await oi():await fo(),$t(),An()}async function fo(){if(u.articlesIndex.length)return u.isTrashView||$t(),u.articlesIndex;let e=await hn();return ri(e),e}async function oi(){if(u.deletedArticlesIndex.length)return u.isTrashView&&$t(),u.deletedArticlesIndex;let e=await lc();return qc(e),e}var zc,ii=Je(()=>{St();mn();Bn();Zn();en();Vt();Zo();Dr();ks();zc="ttree_favorites"});function wf(){try{let e=Array.isArray(u.recentArticleIds)?u.recentArticleIds:[];window.localStorage.setItem(bf,JSON.stringify(e.slice(0,jc)))}catch{}}function si(e){if(!e||e==="inbox"||u.isPublicView)return;let t=Array.isArray(u.recentArticleIds)?u.recentArticleIds:[],n=[e,...t.filter(r=>r!==e)];u.recentArticleIds=n.slice(0,jc),wf(),u.sidebarArticlesMode==="recent"&&$t()}var bf,jc,Cs=Je(()=>{St();ii();Dr();bf="ttree_recent_articles",jc=300});var er=Je(()=>{mn();St();Cs();Dr();Zo();ks();ii();Dr();Cs();Zo();ii();Oc({renderSidebarArticleList:$t,renderMainArticleList:An,setArticlesIndex:ri})});function xf(e){u.articleId&&(u.articleEncryptionKeys||(u.articleEncryptionKeys={}),e?u.articleEncryptionKeys[u.articleId]=e:delete u.articleEncryptionKeys[u.articleId])}async function Jc(e){if(!e||!e.encrypted)return e;let t=u.articleEncryptionKeys?.[e.id]||null;if(t)return await ps(e,t),e;let n=0;for(;;){n+=1;let r=null;try{let o=e.encryptionHint||"",i="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C \u0434\u043B\u044F \u044D\u0442\u043E\u0439 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B.",s=o?`${i}
\u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0430: ${o}`:i;r=await Xn({title:"\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430",message:s,confirmText:"\u041E\u0442\u043A\u0440\u044B\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"\u041F\u0430\u0440\u043E\u043B\u044C",inputType:"password"})}catch{r=window.prompt("\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430. \u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C:")||""}if(!r)throw new Error("\u041F\u0430\u0440\u043E\u043B\u044C \u043D\u0435 \u0432\u0432\u0435\u0434\u0451\u043D");try{let{key:o}=await kc(r,e.encryptionSalt||"");if(!await vc(o,e.encryptionVerifier||"")){if(n>=3)throw new Error("\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C");window.alert("\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C, \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437.");continue}return await ps(e,o),xf(o),e}catch(o){if(n>=3)throw new Error(o.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");window.alert("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443, \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437.")}}}var Ts=Je(()=>{St();en();Vt();Qn();Bn();ao();er();io()});function If(e,t){if(!t.length)return;let n=document.createElement("div");n.className="diff-images",t.forEach(r=>{let o=document.createElement("div");o.className=`diff-image-card diff-image-card--${r.type}`;let i=document.createElement("div");i.className="diff-image-card__label",i.textContent=r.type==="added"?"\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E":"\u0423\u0434\u0430\u043B\u0435\u043D\u043E";let s=document.createElement("img");s.src=r.src,s.alt=r.alt||"",o.append(i,s),n.appendChild(o)}),e.appendChild(n)}function kf(e,t,n,r=[]){let o=document.createElement("div");o.className="diff-inline";let i=document.createElement("div");i.className="diff-inline__content",n.forEach(a=>{let c=document.createElement("span");a.type==="added"?c.className="diff-inline__segment diff-inline__segment--added":a.type==="removed"&&(c.className="diff-inline__segment diff-inline__segment--removed"),c.textContent=a.value,i.appendChild(c)}),If(i,r);let s=document.createElement("div");s.className="diff-inline__hint",s.textContent=t==="undo"?"\u041F\u043E\u0432\u0442\u043E\u0440\u043D\u043E \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Ctrl+Z, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C \u043E\u0442\u043C\u0435\u043D\u0443":"\u041F\u043E\u0432\u0442\u043E\u0440\u043D\u043E \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Ctrl+Y, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C \u043F\u043E\u0432\u0442\u043E\u0440",o.append(i,s),e.innerHTML="",e.appendChild(o)}function Wc(){let e=u.pendingTextPreview;if(!e)return;let t=document.querySelector(`.block[data-block-id="${e.blockId}"] .block-text`);t&&kf(t,e.mode,e.chunks,e.imageDiff||[])}function Yc(e){ai({restoreDom:!1});let t=n=>({type:"text",blockId:n.blockId,historyEntryId:n.id});u.undoStack=(e.history||[]).map(t),u.redoStack=(e.redoHistory||[]).map(t)}function Rr(e){e&&(Jt("pushUndoEntry",e),u.undoStack.push(e),u.redoStack=[])}function po(e){try{return JSON.parse(JSON.stringify(e||{}))}catch{return null}}function Ef(e){if(!e||!u.article||!Array.isArray(u.article.blocks))return;let t=!1,n=r=>{if(Array.isArray(r))for(let o=0;o<r.length;o+=1){let i=r[o];if(i){if(i===e)if(!t)t=!0;else{r.splice(o,1),o-=1;continue}Array.isArray(i.children)&&i.children.length&&n(i.children)}}};n(u.article.blocks)}async function vf(e){e&&(await Bs(e),tr(e))}function ai({restoreDom:e=!0}={}){let t=u.pendingTextPreview;if(t){if(e){let n=document.querySelector(`.block[data-block-id="${t.blockId}"] .block-text`);n&&(n.innerHTML=t.originalHTML)}u.pendingTextPreview=null}}async function Gc(e,t=null,n=null,r={}){if(!e)return{success:!1};let{skipRecord:o=!1,anchorId:i=null,placement:s=null,suppressRerender:a=!1}=r,c=ft(e);if(!c)return Ce("\u0411\u043B\u043E\u043A \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D"),{success:!1};let l=c.parent?.id||null,d=c.index??0,m=t?ft(t)?.block:null,h=m?m.children?.length||0:(u.article?.blocks||[]).length,b=typeof n=="number"&&n>=0?Math.min(n,h):h;if(l===t&&d===b)return{success:!0,noOp:!0,from:{parentId:l,index:d},to:{parentId:t,index:b}};let w=b;t===l&&d<w&&(w=Math.max(w-1,0));try{let p=await bt(`/api/articles/${u.articleId}/blocks/${e}/relocate`,{method:"POST",body:JSON.stringify({parentId:t||null,index:w,anchorId:i||null,placement:s||null})});if(u.article&&Array.isArray(u.article.blocks)){let S=c.siblings||u.article.blocks,A=c.index??S.findIndex($=>$.id===e),C=null;A>=0&&([C]=S.splice(A,1)),C||(C=c.block);let T;if(t){let $=ft(t);$&&$.block?(Array.isArray($.block.children)||($.block.children=[]),T=$.block.children):T=u.article.blocks}else T=u.article.blocks;let O=typeof w=="number"&&w>=0?Math.min(w,T.length):T.length;if(T.splice(O,0,C),Ef(C),u.article.updatedAt)try{u.article.updatedAt=new Date().toISOString()}catch{}}u.currentBlockId=e;let f=p?.parentId??t??null;return a||(l&&f?(await tn(l),f!==l&&await tn(f)):l&&!f?Ft():!l&&f?Ft():Ft()),o||Rr({type:"structure",action:{kind:"reorder",blockId:e,fromParentId:l,fromIndex:d,toParentId:p?.parentId??t??null,toIndex:p?.index??w}}),await vf(e),{success:!0,from:{parentId:l,index:d},to:{parentId:p?.parentId??t??null,index:p?.index??w}}}catch(p){return Ce(p.message),{success:!1}}}var mr=Je(()=>{St();en();Vt();pr();pr();Mn();Bn();ao()});function Nf(){try{return window?.localStorage?.getItem?.(Tf)==="1"}catch{return!1}}function Qc(){try{return window?.localStorage?.getItem?.(Bf)==="1"}catch{return!1}}function Hr(...e){try{if(!Nf())return;console.log("[article-load]",...e)}catch{}}function Mf(e){try{let t=e?.content;if(!Array.isArray(t))return null;for(let n of t)if(n?.type==="outlineSection"){let r=String(n?.attrs?.id||"");if(r)return r}return null}catch{return null}}async function Rn(e,t={}){let{desiredBlockId:n,resetUndoStacks:r,editBlockId:o}=t,i=u.articleId!==e;if(Hr("load.start",{id:e,switchingArticle:i,mode:u.mode,isOutlineEditing:u.isOutlineEditing}),i)try{let h=u.articleId,b=await Promise.resolve().then(()=>(li(),ci));try{let w=b?.getOutlineActiveSectionSnapshot?.()||null;if(h&&w?.sectionId){let p=window?.localStorage?.getItem?.(Xc)||"{}",f=JSON.parse(p||"{}"),S=f&&typeof f=="object"?f:{};S[String(h)]={sectionId:w.sectionId,collapsed:!!w.collapsed,savedAt:new Date().toISOString()},window?.localStorage?.setItem?.(Xc,JSON.stringify(S))}}catch{}b?.flushOutlineAutosave&&await b.flushOutlineAutosave({mode:"queue"}),b?.closeOutlineEditor&&b.closeOutlineEditor()}catch{}u.articleId=e,u.isEditingTitle=!1,u.pendingTextPreview=null,u.article=null,u.currentBlockId=null;let s=performance.now(),a=await dc(e);Qc()&&console.log("[perf][article-load] fetchArticle",{id:e,ms:Math.round(performance.now()-s)}),Hr("load.fetched",{id:e,ms:Math.round(performance.now()-s),hasDocJson:!!a?.docJson,docContent:Array.isArray(a?.docJson?.content)?a.docJson.content.length:null,blocksCount:Array.isArray(a?.blocks)?a.blocks.length:null,updatedAt:a?.updatedAt});let c=a;try{c=await Jc(a)}catch(h){throw Ce(h.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u0443\u044E \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443"),h}u.article=c,(typeof r=="boolean"?r:i)&&Yc(c);let d=n||o||u.pendingEditBlockId||null;u.pendingEditBlockId=null;let m=Mf(c.docJson)||c.blocks?.[0]?.id||null;if(u.currentBlockId=d||m,u.mode="view",u.editingBlockId=null,Or(c),gc(),!u.isPublicView&&!u.isRagView&&!c.encrypted)try{let h=await Promise.resolve().then(()=>(li(),ci));if(h?.openOutlineEditor){Hr("outline.open.start",{id:e});let b=Qc()?performance.now():0;h.openOutlineEditor(),b&&console.log("[perf][article-load] outline.open scheduled",{id:e,ms:Math.round(performance.now()-b)}),Hr("outline.open.scheduled",{id:e,isOutlineEditing:u.isOutlineEditing})}}catch(h){u.isOutlineEditing=!1,Hr("outline.open.failed",{id:e,message:h?.message||String(h||"error")}),Ce("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C outline-\u0440\u0435\u0436\u0438\u043C (\u0441\u043C. \u043A\u043E\u043D\u0441\u043E\u043B\u044C)")}return Hr("load.done",{id:e,currentBlockId:u.currentBlockId}),c}var Tf,Bf,Xc,Ns=Je(()=>{St();en();mr();Vt();er();Ts();io();Tf="ttree_debug_article_load_v1",Bf="ttree_profile_v1",Xc="ttree_outline_last_active_v1"});var Zc=Je(()=>{Bn();Mn()});function Lf(e){if(!e)return;e.focus({preventScroll:!0});let t=window.getSelection&&window.getSelection();if(!t)return;t.removeAllRanges();let n=document.createRange();n.selectNodeContents(e),n.collapse(!1),t.addRange(n)}async function Ms(e){return!u.article||!u.article.encrypted||!u.articleEncryptionKey?e:ms(u.articleEncryptionKey,e)}async function tl(){if(!u.currentBlockId||u.isRagView)return;let e=u.currentBlockId;u.editingScrollTop=J.blocksContainer?J.blocksContainer.scrollTop:null,u.mode="edit",u.scrollTargetBlockId=null,u.editingBlockId=u.currentBlockId,u.editingInitialText=ft(u.currentBlockId)?.block.text||"",u.editingUndo=null,await tn(e);let t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`);if(t||(Ft(),await tn(e),t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`)),!t){u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.editingUndo=null,u.currentBlockId=e,Ce("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430");return}Lf(t)}async function nl(){if(u.mode!=="edit"||!u.editingBlockId)return;let e=u.editingBlockId,t=ft(e),n=t?.block.text||"",o=document.querySelector(`.block[data-block-id="${u.editingBlockId}"] .block-text`)?.innerHTML||"",{cleanupEditableHtml:i}=await Promise.resolve().then(()=>(Mn(),Ds)),s=i(o);if(!(s||"").trim()){let c=ui(e),l=ft(e),d=!!(l?.block&&l.block.__isNew);if(l&&u.article&&Array.isArray(u.article.blocks)){let m=l.siblings||u.article.blocks,h=l.index??m.findIndex(b=>b&&b.id===e);if(h>=0&&m.splice(h,1),u.article.updatedAt)try{u.article.updatedAt=new Date().toISOString()}catch{}if(!d){let b=po(l.block);Ps(b,l.parent?.id||null,l.index??null)}}u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.currentBlockId=c,u.scrollTargetBlockId=c,di(e),Ft(),(async()=>{try{let m=d?`/api/articles/${u.articleId}/blocks/${e}/permanent`:`/api/articles/${u.articleId}/blocks/${e}`,h=await bt(m,{method:"DELETE"});if(!d&&h?.block){let b=po(h.block);Rr({type:"structure",action:{kind:"delete",parentId:h.parentId||null,index:h.index??null,block:b,blockId:b?.id,fallbackId:c}})}Ce("\u041F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A \u0443\u0434\u0430\u043B\u0451\u043D")}catch(m){Ce(m.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Rn(u.articleId,{desiredBlockId:c||null}),Ft()}catch{}}})();return}if(s===n){u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.editingUndo=null,u.pendingEditBlockId=null,u.currentBlockId=e,u.scrollTargetBlockId=e,await tn(e);return}if(t&&u.article&&Array.isArray(u.article.blocks)&&(t.block.text=s,u.article.updatedAt))try{u.article.updatedAt=new Date().toISOString()}catch{}u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.editingUndo=null,u.pendingEditBlockId=null,u.currentBlockId=e,u.scrollTargetBlockId=e,await tn(e),(async()=>{try{let c=await Ms(s),l=await bt(`/api/articles/${u.articleId}/blocks/${e}`,{method:"PATCH",body:JSON.stringify({text:c})});n!==s&&(!!(t?.block&&t.block.__isNew)?delete t.block.__isNew:Rr({type:"text",blockId:e,historyEntryId:l?.historyEntryId||null})),Ce("\u0411\u043B\u043E\u043A \u043E\u0431\u043D\u043E\u0432\u043B\u0451\u043D")}catch(c){Ce(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Rn(u.articleId,{desiredBlockId:e}),Ft()}catch{}}})()}async function rl(){if(u.mode!=="edit"||!u.editingBlockId)return;let e=u.editingBlockId,r=!(document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`)?.textContent||"").replace(/\u00a0/g," ").trim();if(u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.editingUndo=null,r){let o=ui(e),i=ft(e),s=!!(i?.block&&i.block.__isNew);if(i&&u.article&&Array.isArray(u.article.blocks)){let c=i.siblings||u.article.blocks,l=i.index??c.findIndex(d=>d&&d.id===e);if(l>=0&&c.splice(l,1),u.article.updatedAt)try{u.article.updatedAt=new Date().toISOString()}catch{}}u.currentBlockId=o,u.scrollTargetBlockId=o,di(e);let a=i?.parent?.id||null;a?await tn(a):Ft(),(async()=>{try{let c=s?`/api/articles/${u.articleId}/blocks/${e}/permanent`:`/api/articles/${u.articleId}/blocks/${e}`,l=await bt(c,{method:"DELETE"});if(!s&&l?.block){let d=po(l.block);Rr({type:"structure",action:{kind:"delete",parentId:l.parentId||null,index:l.index??null,block:d,blockId:d?.id,fallbackId:o}})}}catch(c){Ce(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Rn(u.articleId,{desiredBlockId:o||null}),Ft()}catch{}}})();return}u.currentBlockId=e,await tn(e)}async function ol(){if(u.mode!=="edit"||!u.editingBlockId)return;let e=u.editingBlockId,t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`);if(!t)return;let n=window.getSelection();if(!n||n.rangeCount===0||!t.contains(n.anchorNode))return;let r=n.getRangeAt(0).cloneRange(),o=document.createElement("span"),i=`split-marker-${Date.now()}-${Math.random().toString(16).slice(2)}`;o.setAttribute("data-split-marker",i),o.textContent="",r.insertNode(o);let s=t.innerHTML;o.parentNode.removeChild(o);let a=`<span data-split-marker="${i}"></span>`,c=s.split(a);if(c.length!==2)return;let[l,d]=c,{cleanupEditableHtml:m}=await Promise.resolve().then(()=>(Mn(),Ds)),h=m(l||""),b=m(d||"");if(!(!b||b===h))try{let w=ft(e),p=w?.block,f=p?po(p):null,S=await Ms(h);await bt(`/api/articles/${u.articleId}/blocks/${e}`,{method:"PATCH",body:JSON.stringify({text:S})});let C=(await bt(`/api/articles/${u.articleId}/blocks/${e}/siblings`,{method:"POST",body:JSON.stringify({direction:"after"})}))?.block?.id;if(!C){Ce("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043D\u043E\u0432\u044B\u0439 \u0431\u043B\u043E\u043A");return}let T=await Ms(b);if(await bt(`/api/articles/${u.articleId}/blocks/${C}`,{method:"PATCH",body:JSON.stringify({text:T})}),w&&u.article&&Array.isArray(u.article.blocks)){w.block.text=h;let $=w.parent,q=w.siblings||u.article.blocks||[],R=(w.index??0)+1,Q={id:C,text:b,children:[],collapsed:!1};if(q.splice(R,0,Q),u.article.updatedAt)try{u.article.updatedAt=new Date().toISOString()}catch{}}u.mode="edit",u.editingBlockId=C,u.pendingEditBlockId=null,u.currentBlockId=C,u.scrollTargetBlockId=C,u.editingCaretPosition="start";let O=w?.parent?.id||null;O?await tn(O):Ft(),f&&Rr({type:"text",blockId:e,block:f})}catch(w){Ce(w.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0437\u0431\u0438\u0442\u044C \u0431\u043B\u043E\u043A")}}var Ls=Je(()=>{St();en();mn();Vt();pr();pr();mr();Mn();Zc();Bn();ao()});function ll(){if(!kt||!ho()||kt.pointerType==="mouse")return;let e=window.getSelection?window.getSelection():null;if(!(!e||e.isCollapsed))try{e.removeAllRanges()}catch{}}function Rf(){fi||(document.addEventListener("selectionchange",ll),fi=!0)}function Hf(){fi&&(document.removeEventListener("selectionchange",ll),fi=!1)}function ho(){return!!(u.isDragModeEnabled&&u.mode==="view"&&u.articleId!=="inbox")}function dl(e){return e instanceof Element?!!e.closest(Of):!1}function ul(){if(kt){window.removeEventListener("pointermove",gl),window.removeEventListener("pointerup",pi),window.removeEventListener("pointercancel",pi);try{kt.sourceEl?.releasePointerCapture?.(kt.pointerId)}catch{}kt=null,Hf(),zf()}}function $f(e,t,n,{bypassInteractiveCheck:r=!1}={}){if(!u.article||!u.isDragModeEnabled||!ho()||e.pointerType==="mouse"&&e.button!==0||!r&&dl(e.target))return;let o=ft(t);if(o){kt={pointerType:e.pointerType||"mouse",blockId:t,pointerId:e.pointerId,originParentId:o.parent?.id||null,originIndex:o.index??0,startX:e.clientX,startY:e.clientY,dragging:!1,forbidden:pl(o.block),lastDrop:null,sourceEl:n};try{n?.setPointerCapture?.(e.pointerId)}catch{}window.addEventListener("pointermove",gl),window.addEventListener("pointerup",pi),window.addEventListener("pointercancel",pi),Rf()}}function fl(e,t,{allowInteractive:n=!1}={}){e&&e.addEventListener("pointerdown",r=>{if(!n&&dl(r.target))return;(r.pointerType==="touch"||r.pointerType==="pen")&&ho()&&r.preventDefault(),$f(r,t,e,{bypassInteractiveCheck:n})})}function $r(){let e=!!u.article,t=J.dragModeToggleBtn;if(t){t.disabled=!e,t.classList.toggle("active",!!u.isDragModeEnabled),t.setAttribute("aria-pressed",u.isDragModeEnabled?"true":"false");let o=u.isDragModeEnabled?"\u041F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435 \u0431\u043B\u043E\u043A \u0437\u0430 \u0435\u0433\u043E \u043F\u043E\u0432\u0435\u0440\u0445\u043D\u043E\u0441\u0442\u044C":"\u0412\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0440\u0435\u0436\u0438\u043C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u044F \u0431\u043B\u043E\u043A\u043E\u0432";e?u.articleId==="inbox"?o="\u041F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0432 \u0431\u044B\u0441\u0442\u0440\u044B\u0445 \u0437\u0430\u043C\u0435\u0442\u043A\u0430\u0445":u.mode!=="view"&&(o="\u041F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043C\u043E\u0436\u043D\u043E \u0442\u043E\u043B\u044C\u043A\u043E \u0432 \u0440\u0435\u0436\u0438\u043C\u0435 \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440\u0430"):o="\u041E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E, \u0447\u0442\u043E\u0431\u044B \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0442\u044C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435\u043C",t.title=o}let n=ho();[J.articleView,J.blocksContainer].forEach(o=>{o&&o.classList.toggle("drag-mode-enabled",n)}),document.body.classList.toggle("drag-mode-enabled",n)}function pl(e,t=new Set){return e&&(t.add(e.id),(e.children||[]).forEach(n=>pl(n,t))),t}function Ff(){if(mo)return mo;let e=document.createElement("div");return e.className="block-drop-line hidden",document.body.appendChild(e),mo=e,e}function zf(){mo&&mo.classList.add("hidden"),nn&&(nn.classList.remove("drop-inside-target"),nn=null),hr&&(hr.remove(),hr=null),document.body.classList.remove("block-dnd-active")}function Uf(e){hr&&(hr.style.left=`${e.clientX+12}px`,hr.style.top=`${e.clientY+12}px`)}function qf(e){let t=document.createElement("div");t.className="block-drag-preview";let n=J.blocksContainer?.querySelector(`.block[data-block-id="${e}"]`),r=n?.querySelector(".block-title")?.textContent?.trim(),o=n?.querySelector(".block-text")?.textContent?.trim();t.textContent=r||o||"\u0411\u043B\u043E\u043A",document.body.appendChild(t),hr=t}function ml(){return In&&In.isConnected?(J.blocksContainer&&In.parentNode!==J.blocksContainer&&J.blocksContainer.appendChild(In),In):(In=document.createElement("div"),In.className="drag-layer",J.blocksContainer&&(J.blocksContainer.appendChild(In),il||(J.blocksContainer.addEventListener("scroll",sl,{passive:!0}),window.addEventListener("resize",sl,{passive:!0}),il=!0)),In)}function hl(){cl.clear(),In&&(In.innerHTML="")}function sl(){let e=J.blocksContainer;if(!e||!In)return;let t=e.getBoundingClientRect(),n=e.scrollTop;cl.forEach(({handle:r,blockEl:o})=>{let i=o.getBoundingClientRect(),s=o.querySelector(".block-header__left"),a=o.querySelector(".block-header"),c=o.querySelector(".collapse-btn"),l=s?.getBoundingClientRect(),d=a?.getBoundingClientRect(),m=c?.getBoundingClientRect(),h=(l&&l.height>0?l:null)||(d&&d.height>0?d:null)||(m&&m.height>0?m:null)||i,b=h.top-t.top+n+h.height/2;r.style.top=`${b}px`,r.style.right="8px"})}function Kf(e){let t=Ff();if(!e){t.classList.add("hidden"),nn&&(nn.classList.remove("drop-inside-target"),nn=null);return}if(e.placement==="inside"){t.classList.add("hidden"),nn&&nn.dataset.blockId!==e.targetId&&nn.classList.remove("drop-inside-target"),nn=J.blocksContainer?.querySelector(`.block[data-block-id="${e.targetId}"]`)||null,nn&&nn.classList.add("drop-inside-target");return}nn&&(nn.classList.remove("drop-inside-target"),nn=null),t.classList.remove("hidden");let n=e.placement==="before"?e.rect.top:e.rect.top+e.rect.height,r=Math.min(e.depth*al,e.rect.width-32),o=e.rect.left+r,i=Math.max(e.rect.width-r,48);t.style.top=`${n}px`,t.style.left=`${o}px`,t.style.width=`${i}px`}function Vf(e,t){if(!J.blocksContainer||!kt)return null;let r=Array.from(J.blocksContainer.querySelectorAll(".block")).filter(C=>{let T=C.dataset.blockId;return T&&!kt.forbidden.has(T)});if(!r.length)return null;let o=null,i=1/0;if(r.forEach(C=>{let T=C.getBoundingClientRect(),O=T.top+T.height/2,$=Math.abs(t-O);$<i&&(i=$,o=C)}),!o)return null;let s=o.getBoundingClientRect(),a=s.height>0?(t-s.top)/s.height:.5,c=a<_f?"before":a>Df?"after":"inside",l=o.dataset.blockId,d=ft(l);if(!d)return null;let m=(d.ancestors||[]).length,h=c==="inside"?l:d.parent?.id||null;if(kt.forbidden.has(h||""))return null;let b=l,w=h,p=c,f=s,S=c==="inside"?m+1:m,A=p==="after"?d.index+1:d.index;if(p!=="inside"&&d.parent){let C=d,T=s,O=s.left+al;for(;C.parent;){let $=e<=O,q=t<=T.top||t>=T.bottom;if(!$&&!q)break;let R=ft(C.parent.id);if(!R)break;let Y=J.blocksContainer?.querySelector(`.block[data-block-id="${R.block.id}"]`)?.getBoundingClientRect();C=R,T=Y||T,b=C.block.id,f=T,S=(C.ancestors||[]).length,w=C.parent?.id||null,A=p==="after"?C.index+1:C.index}}return{targetId:b,placement:p,parentId:w,index:A,depth:S,rect:f}}function jf(e){if(!J.blocksContainer)return;let t=J.blocksContainer.getBoundingClientRect(),n=60;e.clientY<t.top+n?J.blocksContainer.scrollTop-=12:e.clientY>t.bottom-n&&(J.blocksContainer.scrollTop+=12)}function gl(e){if(!kt||e.pointerId!==kt.pointerId)return;if(!ho()){ul();return}let t=e.clientX-kt.startX,n=e.clientY-kt.startY;if(!kt.dragging){if(Math.hypot(t,n)<Pf)return;kt.dragging=!0;let o=kt.pointerType||e.pointerType||"mouse";(o==="touch"||o==="pen")&&document.body.classList.add("block-dnd-active"),qf(kt.blockId)}e.preventDefault(),Uf(e);let r=Vf(e.clientX,e.clientY);kt.lastDrop=r,Kf(r),jf(e)}async function pi(e){if(!kt||e.pointerId!==kt.pointerId)return;let t=kt;ul();let n=t.dragging&&t.lastDrop,r=t.lastDrop,o=t.blockId;!n||!r||await Gc(o,r.parentId||null,r.index,{anchorId:r.targetId,placement:r.placement})}var Pf,al,_f,Df,Of,kt,mo,nn,hr,In,cl,il,fi,go=Je(()=>{St();mn();Mn();mr();Vt();Pf=6,al=20,_f=.35,Df=.65,Of='button, a, input, textarea, select, [contenteditable="true"], .block-edit-actions, .move-block-btn, .collapse-btn',kt=null,mo=null,nn=null,hr=null,In=null,cl=new Map,il=!1,fi=!1});function yl(e){Os=typeof e=="function"?e:null}function Jf(e){let t=new Set,n=r=>{if(Array.isArray(r))for(let o=0;o<r.length;o+=1){let i=r[o];if(!i||!i.id){r.splice(o,1),o-=1;continue}if(t.has(i.id)){r.splice(o,1),o-=1;continue}t.add(i.id),Array.isArray(i.children)&&i.children.length&&n(i.children)}};n(e)}function bl(){if(!J.blocksContainer)return;let e=new Set;J.blocksContainer.querySelectorAll(".block[data-block-id]").forEach(n=>{let r=n.getAttribute("data-block-id");if(r)if(e.has(r)){let o=n.parentNode;o&&o.removeChild(n)}else e.add(r)})}function wl(){if(!J.blocksContainer||!u.article||!Array.isArray(u.article.blocks))return;let e=Hn(u.article.blocks),t=new Set(e.map(r=>r.id));J.blocksContainer.querySelectorAll(".block[data-block-id]").forEach(r=>{let o=r.getAttribute("data-block-id");if(o&&!t.has(o)){let i=r.parentNode;i&&i.removeChild(r)}})}function Ps(e,t,n,r){if(!u.article||!e||!e.id)return;let o=Array.isArray(u.article.blockTrash)?u.article.blockTrash:[],i=r||new Date().toISOString();o.push({id:e.id,block:e,parentId:t||null,index:typeof n=="number"?n:null,deletedAt:i}),u.article.blockTrash=o}function di(e){if(!e||!J.blocksContainer)return;J.blocksContainer.querySelectorAll(`.block[data-block-id="${e}"]`).forEach(n=>{let r=n.parentElement;if(!r)return;let o=n.nextElementSibling;if(o&&o.classList.contains("block-children")){let i=o;o=o.nextElementSibling,i.parentNode===r&&r.removeChild(i)}n.parentNode===r&&r.removeChild(n)})}async function Rs(e,t,n=1){for(let r of e){let o=document.createElement("div");o.className="block",o.dataset.blockId=r.id,typeof r.collapsed=="boolean"&&(o.dataset.collapsed=r.collapsed?"true":"false"),(r.id===u.currentBlockId||Array.isArray(u.selectedBlockIds)&&u.selectedBlockIds.includes(r.id))&&o.classList.add("selected"),r.id===u.editingBlockId&&o.classList.add("editing");let s=document.createElement("div");s.className="block-surface";let a=document.createElement("div");a.className="block-content";let c=$n(r.text||""),l=!!c.titleHtml,d=!!(c.bodyHtml&&c.bodyHtml.trim()),m=!!r.children?.length;if(!l&&m){let O=document.createElement("div");O.innerHTML=c.bodyHtml||r.text||"";let $=Array.from(O.childNodes||[]).filter(q=>q.nodeType===Node.TEXT_NODE?(q.textContent||"").trim().length>0:q.nodeType===Node.ELEMENT_NODE?q.tagName==="BR"?!1:q.tagName==="P"?(q.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim().length>0:!0:!1);if($.length===1){let q=$[0];q.nodeType===Node.ELEMENT_NODE&&q.tagName==="P"&&(c={titleHtml:q.outerHTML,bodyHtml:""},l=!0,d=!1)}}let h=l||m,b=!l&&!m;o.classList.toggle("block--no-title",!l);let w=u.mode==="edit"&&u.editingBlockId===r.id,p=null;if(h||b){let O=document.createElement("button");O.className="collapse-btn",b?(O.classList.add("collapse-btn--placeholder"),O.setAttribute("aria-hidden","true"),O.removeAttribute("aria-expanded"),O.removeAttribute("title")):(O.setAttribute("aria-expanded",r.collapsed?"false":"true"),O.title=r.collapsed?"\u0420\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C":"\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C"),p=document.createElement("div"),p.className="block-header",l||p.classList.add("block-header--no-title");let $=document.createElement("div");if($.className="block-header__left",$.appendChild(O),l){let q=Math.min(Math.max(n,1),6),R=document.createElement(`h${q}`);R.className="block-title",R.innerHTML=c.titleHtml||"",$.appendChild(R)}else{let q=document.createElement("div");q.className="block-title-spacer",q.style.flex="1",q.style.minWidth="0",$.appendChild(q)}p.appendChild($)}let f=document.createElement("div");f.className="block-text block-body";let S=w?$s(r.text||""):c.bodyHtml||"";if(f.innerHTML=S,(!S||!S.trim())&&(f.classList.add("block-body--empty"),w&&(f.innerHTML="<p><br /></p>")),f.classList.toggle("block-body--no-title",!l),w?(f.setAttribute("contenteditable","true"),f.setAttribute("spellcheck","false"),f.dataset.placeholder="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0442\u0435\u043A\u0441\u0442"):f.removeAttribute("contenteditable"),p&&a.appendChild(p),(w||!l||S)&&a.appendChild(f),u.articleId==="inbox"&&!w){let O=document.createElement("div");O.className="block-footer";let $=document.createElement("button");$.type="button",$.className="ghost small move-block-btn",$.innerHTML="&#10140;",$.title="\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0431\u043B\u043E\u043A \u0432 \u0434\u0440\u0443\u0433\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E",$.addEventListener("click",q=>{q.stopPropagation(),Os?Os(r.id):Ce("\u041F\u0435\u0440\u0435\u043D\u043E\u0441 \u0431\u043B\u043E\u043A\u0430 \u0432\u0440\u0435\u043C\u0435\u043D\u043D\u043E \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D")}),O.appendChild($),a.appendChild(O)}if(s.appendChild(a),w&&("ontouchstart"in window||navigator.maxTouchPoints>0)&&a.addEventListener("click",$=>{let q=a.querySelector('.block-text[contenteditable="true"]');q&&(q.contains($.target)||($.stopPropagation(),q.focus(),u.editingCaretPosition==="start"?(q.scrollTop=0,as(q)):Jo(q)))}),fl(s,r.id),w){let O=document.createElement("div");O.className="block-edit-actions";let $=document.createElement("button");$.type="button",$.className="ghost small block-attach-btn",$.innerHTML='<span class="block-attach-btn__icon">&#xE723;</span><span class="block-attach-btn__label">\u0424\u0430\u0439\u043B</span>',$.title="\u041F\u0440\u0438\u043A\u0440\u0435\u043F\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u0438\u043B\u0438 \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0443",$.addEventListener("click",Q=>{Q.preventDefault(),Q.stopPropagation();let Y=o.querySelector('.block-text[contenteditable="true"]');if(!Y)return;let re=document.createElement("input");re.type="file",re.multiple=!0,re.style.display="none",re.addEventListener("change",()=>{let Ae=Array.from(re.files||[]);Ae.length&&zs(Y,Ae,r.id),re.remove()}),document.body.appendChild(re),re.click()});let q=document.createElement("button");q.type="button",q.className="ghost small",q.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C",q.addEventListener("click",async Q=>{Q.preventDefault(),Q.stopPropagation(),await nl()});let R=document.createElement("button");R.type="button",R.className="ghost small",R.textContent="\u041E\u0442\u043C\u0435\u043D\u0430",R.addEventListener("click",Q=>{Q.preventDefault(),Q.stopPropagation(),rl()}),O.appendChild($),O.appendChild(q),O.appendChild(R),a.appendChild(O)}Us(f,r.id),o.appendChild(s),o.addEventListener("click",O=>{if(O.stopPropagation(),u.isRagView&&u.ragBlockMap&&u.ragBlockMap[r.id]){let je=u.ragBlockMap[r.id];if(je&&je.articleId&&je.blockId){u.scrollTargetBlockId=je.blockId,u.currentBlockId=je.blockId,ln(Wt.article(je.articleId));return}}let $=O.target.closest('button, a, [contenteditable="true"], .block-edit-actions'),q=o.querySelector(".block-header"),R=o.querySelector(".block-text.block-body"),Q=!!q,Y=!!(q&&!q.classList.contains("block-header--no-title")),re=Q&&q.contains(O.target),Ae=R&&R.contains(O.target),Ee=Y,te=u.currentBlockId===r.id,ye=!1;(Ee&&re||!Ee&&te&&Ae&&!$)&&(ye=!0),ye&&Fs(r.id),tr(r.id)}),s.addEventListener("dblclick",O=>{if(u.mode!=="view"||u.isPublicView||u.isRagView)return;let $=O.target.closest('button, a, [contenteditable="true"]');$&&!$.matches('.block-text[contenteditable="true"]')||(O.stopPropagation(),tr(r.id),tl())});let C=r.collapsed&&r.id!==u.editingBlockId&&l;f.classList.contains("block-body--empty")||f.classList.toggle("collapsed",C);let T=null;r.children?.length>0&&!r.collapsed&&(T=document.createElement("div"),T.className="block-children",await Rs(r.children,T,n+1)),t.appendChild(o),T&&(w?t.appendChild(T):o.appendChild(T))}}async function tn(e){if(!u.article||!Array.isArray(u.article.blocks))return;let t=ft(e);if(!t)return;let n=(Array.isArray(t.ancestors)?t.ancestors.length:0)+1,r=document.querySelector(`.block[data-block-id="${e}"]`);if(!r)return;let o=r.parentElement;if(!o)return;let i=[],s=r.nextElementSibling;s&&s.classList.contains("block-children")&&i.push(s);let a=(i[i.length-1]||r).nextSibling;o.removeChild(r),i.forEach(d=>{d.parentNode===o&&o.removeChild(d)});let c=document.createElement("div");await Rs([t.block],c,n),Array.from(c.childNodes).forEach(d=>{o.insertBefore(d,a)}),bl(),wl()}function Ft(){let e=u.article;if(!e)return;if(!u.isPublicView&&!u.isRagView&&u.isOutlineEditing){$t(),oo();return}Array.isArray(e.blocks)&&Jf(e.blocks),$t();let t=e.id==="inbox"?[...e.blocks||[]].reverse():e.blocks;oo(),J.blocksContainer.innerHTML="",$r(),hl(),ml();let n=()=>{if(u.mode!=="edit"||!u.editingBlockId||u.editingCaretPosition==="start")return;let r=J.blocksContainer?.querySelector(`.block[data-block-id="${u.editingBlockId}"] .block-text[contenteditable="true"]`);if(!r)return;let o=document.activeElement;r===o||r.contains(o)||(r.focus({preventScroll:!0}),r.scrollHeight>r.clientHeight&&(r.scrollTop=r.scrollHeight),Jo(r))};Rs(t,J.blocksContainer).then(()=>{if(wl(),bl(),Wc(),u.scrollTargetBlockId&&u.mode==="view"){let r=u.scrollTargetBlockId;requestAnimationFrame(()=>{let o=document.querySelector(`.block[data-block-id="${r}"]`);if(o){(o.querySelector(".block-content")||o).scrollIntoView({behavior:"smooth",block:"nearest"});let s=o.querySelector('.block-text[contenteditable="true"]');s&&u.mode==="edit"&&u.editingBlockId===r?(s.focus({preventScroll:!0}),u.editingCaretPosition==="start"?(s.scrollTop=0,as(s)):Jo(s)):(o.setAttribute("tabindex","-1"),o.focus({preventScroll:!0}))}u.currentBlockId=r,u.scrollTargetBlockId=null})}n(),u.mode==="edit"&&typeof u.editingScrollTop=="number"&&J.blocksContainer&&(J.blocksContainer.scrollTop=u.editingScrollTop)})}var Os,Hs=Je(()=>{St();mn();en();Vt();Qn();Ls();Bn();Mn();Mn();er();mr();Zn();io();go();Os=null});function Wf(){try{let e=window?.localStorage?.getItem?.(Sl)||"";if(!e)return[];let t=JSON.parse(e);return Array.isArray(t)?t.filter(Boolean):[]}catch{return[]}}function Yf(e){try{window?.localStorage?.setItem?.(Sl,JSON.stringify(Array.isArray(e)?e:[]))}catch{}}function xl(e){let t=String(e||"").trim();if(!t)return!1;let n=Wf(),r=n.filter(o=>String(o?.sectionId||o?.id||"")!==t);return r.length===n.length?!1:(Yf(r),!0)}async function Gf(){let e=await fetch("/api/articles/inbox?include_history=0",{method:"GET",credentials:"include"});if(e.status===401||e.status===403){let t=new Error("auth");throw t.status=e.status,t}if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()}async function Al(){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return{status:"offline"};let e=await Gf(),t=new Date().toISOString();try{e?.docJson&&typeof e.docJson=="object"&&await an("inbox",e.docJson,t)}catch{}return{status:"refreshed",updatedAt:e?.updatedAt||null,docJson:e?.docJson||null}}var Sl,qs=Je(()=>{Nr();Pr();Sl="ttree_pending_quick_notes_v1"});async function Xf(e){try{let n=(u.articlesIndex.length?u.articlesIndex:await hn()).filter(d=>d.id!=="inbox"),r=n.map(d=>({id:d.id,title:d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),o=await Xn({title:"\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0432 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0438\u043B\u0438 \u0432\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E",confirmText:"\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:r,returnMeta:!0,hideConfirm:!1}),s=(o?.selectedId||(typeof o=="object"?o?.value:o)||""||"").trim();if(!s)return;let a=s.toLowerCase(),c=n.find(d=>d.id&&d.id.toLowerCase()===a||(d.title||"").toLowerCase()===a),l=c?c.id:s;if(!l||l==="inbox"){Ce("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}await apiRequest(`/api/articles/${u.articleId}/blocks/${e}/move-to/${l}`,{method:"POST"}),await Rn("inbox",{resetUndoStacks:!0}),Ft(),Ce("\u0411\u043B\u043E\u043A \u043F\u0435\u0440\u0435\u043D\u0435\u0441\u0451\u043D")}catch(t){Ce(t.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0431\u043B\u043E\u043A")}}async function Yo(e){try{String(e||"").startsWith("inbox-")&&(e="inbox")}catch{}u.isPublicView=!1,u.isRagView=!1,document.body.classList.remove("public-embedded"),u.isEditingTitle=!1,await fo(),lo(!0),J.usersView&&J.usersView.classList.add("hidden"),J.blocksContainer.innerHTML="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...";try{if(e==="RAG"){u.isRagView=!0,u.mode="view",u.editingBlockId=null,u.pendingEditBlockId=null,u.scrollTargetBlockId=null,u.ragBlockMap={},si("RAG");let r=(u.ragQuery||"").trim(),o=Array.isArray(u.ragResults)?u.ragResults:[],i=o.length,s=Array.from(new Set(o.map(m=>m&&m.articleTitle?String(m.articleTitle):"").filter(Boolean))),a=s.slice(0,8),c=["<p><strong>\u0421\u0432\u043E\u0434\u043A\u0430</strong></p>"];u.ragSummaryLoading?c.push('<p class="meta">\u0413\u0435\u043D\u0435\u0440\u0438\u0440\u0443\u044E \u0441\u0432\u043E\u0434\u043A\u0443\u2026</p>'):u.ragSummaryError?c.push(`<p class="meta">\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0432\u043E\u0434\u043A\u0438: ${u.ragSummaryError}</p>`):u.ragSummaryHtml?c.push(u.ragSummaryHtml):c.push('<p class="meta">\u0421\u0432\u043E\u0434\u043A\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435 \u0433\u043E\u0442\u043E\u0432\u0430.</p>');let l=["<p><strong>AI-\u043F\u043E\u0438\u0441\u043A: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B</strong></p>",`<p><span class="meta">\u0417\u0430\u043F\u0440\u043E\u0441:</span> ${r||"\u2014"}</p>`,`<p><span class="meta">\u041D\u0430\u0439\u0434\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432:</span> ${i}</p>`];a.length&&l.push(`<p><span class="meta">\u0421\u0442\u0430\u0442\u044C\u0438:</span> ${a.join(" \xB7 ")}</p>`),s.length>a.length&&l.push(`<p><span class="meta">\u2026\u0438 \u0435\u0449\u0451:</span> ${s.length-a.length}</p>`);let d=[{id:"rag-ai-summary",text:c.join(""),children:[],collapsed:!1},{id:"rag-meta",text:l.join(""),children:[],collapsed:!1},...o.filter(m=>m&&m.type==="block").map((m,h)=>{let b=m.blockText||"",w=m.articleTitle?String(m.articleTitle):"",p=w?`<p><strong>${w}</strong></p>`:`<p><strong>\u0420\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442 ${h+1}</strong></p>`,f=`rag-${m.blockId||h}`;return m.articleId&&m.blockId&&(u.ragBlockMap[f]={articleId:m.articleId,blockId:m.blockId}),{id:f,text:`${p}${b}`,children:[],collapsed:!1}})];u.article={id:"RAG",title:r?`AI: ${r}`:"AI: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B \u043F\u043E\u0438\u0441\u043A\u0430",blocks:d,updated_at:new Date().toISOString()},u.articleId="RAG",u.currentBlockId=d[0]?.id||null,Ft();return}let t=u.pendingEditBlockId||void 0,n=u.scrollTargetBlockId||void 0;if(await Rn(e,{resetUndoStacks:!0,desiredBlockId:n,editBlockId:t}),Ft(),si(e),e==="inbox"&&navigator.onLine&&u.serverStatus==="ok")try{await Al().catch(()=>{}),u.articleId==="inbox"&&!u.editingBlockId&&(await Rn("inbox",{resetUndoStacks:!1}),Ft())}catch{}}catch(t){try{if((Number(t?.status||0)||null)===404&&e&&e!=="inbox"){qo(e,new Date().toISOString()).catch(()=>{}),Es(e),Ce("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430 (\u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E, \u0443\u0434\u0430\u043B\u0435\u043D\u0430)."),ln(Wt.list);return}}catch{}J.blocksContainer.innerHTML=`<p class="meta">\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u044C\u044E: ${t.message}</p>`}}async function hs(){u.isPublicView=!1,u.isRagView=!1,document.body.classList.remove("public-embedded"),J.usersView&&J.usersView.classList.add("hidden"),u.article=null,u.articleId=null,u.currentBlockId=null,u.isEditingTitle=!1,u.mode="view",u.editingBlockId=null,u.undoStack=[],u.redoStack=[],u.pendingEditBlockId=null,ai({restoreDom:!1}),lo(!1),$r();try{if(u.isTrashView){let e=await oi();An(e)}else{let e=await fo();An(e)}}catch(e){J.articleList.innerHTML=`<li>\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u043F\u0438\u0441\u043E\u043A: ${e.message}</li>`}}async function gs(e){u.isPublicView=!0,u.isRagView=!1,document.body.classList.add("public-embedded"),J.usersView&&J.usersView.classList.add("hidden"),lo(!0),u.isEditingTitle=!1,u.mode="view",u.editingBlockId=null,u.pendingEditBlockId=null,u.selectionAnchorBlockId=null,u.selectedBlockIds=[],u.undoStack=[],u.redoStack=[],ai({restoreDom:!1}),J.blocksContainer&&(J.blocksContainer.innerHTML="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...");try{let t=await apiRequest(`/api/public/articles/${encodeURIComponent(e)}`,{method:"GET",credentials:"omit"});u.article=t,u.articleId=t?.id||null;let n=Hn(t?.blocks||[])[0];u.currentBlockId=n?n.id:null,Ft()}catch(t){J.blocksContainer&&(J.blocksContainer.innerHTML=`<p class="meta">\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E: ${t.message}</p>`)}}var Il=Je(()=>{St();mn();en();Vt();Qn();Zn();Pr();er();er();er();mr();Mn();Ns();Hs();go();qs();yl(Xf)});var pr=Je(()=>{io();Ts();Ns();Hs();Il();go();go();$r()});function Hn(e=[],t=[]){return(e||[]).forEach(n=>{t.push(n),n.children&&n.children.length>0&&!n.collapsed&&Hn(n.children,t)}),t}function ft(e,t=u.article?.blocks||[],n=null,r=[]){for(let o=0;o<t.length;o+=1){let i=t[o];if(i.id===e)return{block:i,parent:n,index:o,siblings:t,ancestors:r};let s=ft(e,i.children||[],i,[...r,i]);if(s)return s}return null}function yo({scrollIntoView:e=!1,scrollBehavior:t="smooth"}={}){let n=new Set(Array.isArray(u.selectedBlockIds)?u.selectedBlockIds:[]);if(u.currentBlockId&&n.add(u.currentBlockId),document.querySelectorAll(".block[data-block-id]").forEach(o=>{let i=o.getAttribute("data-block-id"),s=i&&n.has(i);o.classList.toggle("selected",!!s),o.classList.remove("block--selected-root-ancestor");let a=o.querySelector(":scope > .block-surface");a&&a.classList.remove("block--selected-root-ancestor")}),u.currentBlockId&&u.article&&Array.isArray(u.article.blocks)){let o=ft(u.currentBlockId),i=o?.ancestors||[],s=i.length>0?i[0]?.id:o?.block?.id;if(s){let a=document.querySelector(`.block[data-block-id="${s}"]`);if(a){let c=a.querySelector(":scope > .block-surface");c&&c.classList.add("block--selected-root-ancestor")}}}if(e&&u.mode==="view"&&u.currentBlockId){let o=document.querySelector(`.block[data-block-id="${u.currentBlockId}"]`);o&&o.scrollIntoView({behavior:t||"smooth",block:"nearest"})}}function kl(e,t={}){if(!e||u.currentBlockId===e)return;let{preserveSelection:n=!1,scrollIntoView:r,scrollBehavior:o}=t;u.currentBlockId=e,n||(u.selectionAnchorBlockId=null,u.selectedBlockIds=[]);let i=typeof r=="boolean"?r:u.mode==="view";yo({scrollIntoView:i,scrollBehavior:o||"smooth"})}function tr(e,t={}){kl(e,{preserveSelection:!1,...t})}function El(e){if(!u.article)return;let t=Hn(u.article.blocks),n=t.findIndex(o=>o.id===u.currentBlockId);if(n===-1)return;let r=t[n+e];r&&(u.mode==="view"&&(u.scrollTargetBlockId=r.id),kl(r.id,{preserveSelection:!1}))}function vl(e){if(!u.article)return;let t=Hn(u.article.blocks);if(!t.length)return;let n=u.selectionAnchorBlockId||u.currentBlockId||t[0].id;n||(n=t[0].id),u.selectionAnchorBlockId||(u.selectionAnchorBlockId=n);let r=t.findIndex(d=>d.id===n);if(r===-1)return;let o=u.currentBlockId||n,i=t.findIndex(d=>d.id===o);i===-1&&(i=r);let s=i+e;if(s<0||s>=t.length)return;let[a,c]=s>=r?[r,s]:[s,r],l=t.slice(a,c+1).map(d=>d.id);u.selectedBlockIds=l,u.currentBlockId=t[s].id,u.mode==="view"&&(u.scrollTargetBlockId=u.currentBlockId),yo({scrollIntoView:u.mode==="view"})}var Cl=Je(()=>{St();mn()});function nr(e){return e?e.nodeType===Node.TEXT_NODE?/\n\s*\n/.test(e.textContent||""):e.nodeType===Node.ELEMENT_NODE&&(e.tagName==="BR"||(e.tagName==="P"||e.tagName==="DIV")&&(!(e.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&(nbsp|#160);/gi,"").trim()||!(e.textContent||"").replace(/\u00a0/g,"").trim()&&!e.querySelector("img"))):!1}function mi(e=[]){let t=document.createElement("div");return e.forEach(n=>t.appendChild(n)),t.innerHTML.trim()}function Ks(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=[],r=(i="")=>{let s=document.createElement("p");i?s.innerHTML=i:s.appendChild(document.createElement("br")),n.push(s)};Array.from(t.content.childNodes).forEach(i=>{if(i.nodeType===Node.TEXT_NODE){let s=(i.textContent||"").trim();s&&r(s);return}if(i.nodeType===Node.ELEMENT_NODE){if(i.tagName==="P"){n.push(i.cloneNode(!0));return}if(i.tagName==="BR"){r("");return}if(i.tagName==="DIV"){r(i.innerHTML);return}r(i.outerHTML)}}),n.length||r("");let o=document.createElement("div");return n.forEach(i=>o.appendChild(i)),o.innerHTML}function $n(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll(".block-header").forEach(m=>{let h=m.parentNode;if(h){for(;m.firstChild;)h.insertBefore(m.firstChild,m);h.removeChild(m)}});let n=Array.from(t.content.childNodes),r=m=>m?.nodeType===Node.TEXT_NODE&&!(m.textContent||"").trim(),o=0;for(;o<n.length&&r(n[o]);)o+=1;let i=n[o];if(!i||i.nodeType!==Node.ELEMENT_NODE||i.tagName!=="P"||nr(i))return{titleHtml:"",bodyHtml:mi(n)};let s=o+1;for(;s<n.length&&r(n[s]);)s+=1;let a=n[s];if(!(!!a&&nr(a)&&(a.nodeType===Node.ELEMENT_NODE?a.tagName==="P"||a.tagName==="DIV"||a.tagName==="BR":!1)))return{titleHtml:"",bodyHtml:mi(n)};let l=[i.cloneNode(!0)],d=[];for(let m=s+1;m<n.length;m+=1)d.push(n[m].cloneNode(!0));return{titleHtml:mi(l),bodyHtml:mi(d)}}function Tl({event:e,element:t,range:n,selection:r,notifyEditingInput:o,logDebug:i}){if(!e||!t||!n||!r||!n.collapsed)return!1;let s=e.key==="Backspace"||e.code==="Backspace"||e.keyCode===8,a=e.key==="Delete"||e.key==="Del"||e.code==="Delete"||e.code==="Del"||e.keyCode===46;if(!s&&!a)return!1;let c=f=>{try{r.removeAllRanges(),r.addRange(f)}catch{}try{t.focus({preventScroll:!0})}catch{t.focus()}},l=f=>{let A=(n.commonAncestorContainer?.nodeType===Node.ELEMENT_NODE?n.commonAncestorContainer:n.commonAncestorContainer?.parentElement)?.closest?.("p");if(A)return A;let C=t,T=Array.from(C.childNodes),O=n.startContainer;for(;O&&O.parentNode!==C;)O=O.parentNode;let $=O?T.indexOf(O):-1,q=R=>{let Q=R==="prev"?-1:1,Y=$;for(Y===-1?Y=R==="prev"?T.length-1:0:Y=R==="prev"?Y-1:Y;Y>=0&&Y<T.length;){let re=T[Y];if(re?.nodeType===Node.ELEMENT_NODE&&re.tagName==="P")return re;Y+=Q}return null};return f==="Delete"?q("next")||q("prev"):f==="Backspace"?q("prev")||q("next"):null},d=()=>{if(n.startContainer!==t)return{prev:null,next:null};let f=Array.from(t.childNodes),S=n.startOffset,A=null,C=null;for(let T=S-1;T>=0;T-=1){let O=f[T];if(O?.nodeType===Node.ELEMENT_NODE&&O.tagName==="P"){A=O;break}}for(let T=S;T<f.length;T+=1){let O=f[T];if(O?.nodeType===Node.ELEMENT_NODE&&O.tagName==="P"){C=O;break}}return{prev:A,next:C}},m=f=>{let S=f?.previousElementSibling;for(;S&&S.tagName!=="P";)S=S.previousElementSibling;return S&&S.tagName==="P"?S:null},h=f=>{let S=f?.nextElementSibling;for(;S&&S.tagName!=="P";)S=S.nextElementSibling;return S&&S.tagName==="P"?S:null},b=f=>{if(!f)return!0;let S=new Set(["span","b","strong","i","em","u","s","mark","code"]),A=new Set(["img","video","audio","iframe"]),C=T=>{if(!T)return!1;if(T.nodeType===Node.TEXT_NODE)return(T.textContent||"").replace(/\u00a0/g,"").replace(/[\u200B-\u200D\uFEFF]/g,"").trim().length>0;if(T.nodeType!==Node.ELEMENT_NODE)return!1;let O=(T.tagName||"").toLowerCase();return O==="br"?!1:A.has(O)?!0:O==="span"&&(T.getAttribute("class")||"").includes("resizable-image__handle")?!1:S.has(O)?Array.from(T.childNodes||[]).some(C):!0};return!Array.from(f.childNodes||[]).some(C)},w=f=>{if(!f)return!1;let S=document.createRange();S.selectNodeContents(f);try{S.setEnd(n.startContainer,n.startOffset)}catch{return!1}if(b(S.cloneContents()))return!0;try{let A=document.createRange();return A.selectNodeContents(f),A.collapse(!0),n.compareBoundaryPoints(Range.START_TO_START,A)===0}catch{return!1}},p=f=>{if(!f)return!1;let S=document.createRange();S.selectNodeContents(f);try{S.setStart(n.startContainer,n.startOffset)}catch{return!1}if(b(S.cloneContents()))return!0;try{let A=document.createRange();return A.selectNodeContents(f),A.collapse(!1),n.compareBoundaryPoints(Range.END_TO_END,A)===0}catch{return!1}};if(window.__debugMergeP&&i("mergeP.keydown",{key:e.key,code:e.code,keyCode:e.keyCode,startContainer:n.startContainer?.nodeName,startOffset:n.startOffset,collapsed:n.collapsed}),s){if(n.startContainer===t){let C=d();if(C.prev&&C.next){e.preventDefault(),e.stopPropagation();let T=document.createRange();for(T.selectNodeContents(C.prev),T.collapse(!1);C.next.firstChild;)C.prev.appendChild(C.next.firstChild);return C.next.remove(),c(T),o(t),!0}return!1}let f=l("Backspace");if(!f||!t.contains(f)||!w(f))return!1;let S=m(f);if(!S||!t.contains(S))return!1;e.preventDefault(),e.stopPropagation();let A=document.createRange();for(A.selectNodeContents(S),A.collapse(!1);f.firstChild;)S.appendChild(f.firstChild);return f.remove(),c(A),o(t),!0}if(a){let f=l("Delete");if(!f||!t.contains(f)){let C=d();if(C.prev&&C.next){e.preventDefault(),e.stopPropagation();let T=document.createRange();for(T.selectNodeContents(C.prev),T.collapse(!1);C.next.firstChild;)C.prev.appendChild(C.next.firstChild);return C.next.remove(),c(T),o(t),!0}return!1}if(!p(f))return!1;let S=h(f);if(!S||!t.contains(S))return!1;e.preventDefault(),e.stopPropagation();let A=document.createRange();for(A.selectNodeContents(f),A.collapse(!1);S.firstChild;)f.appendChild(S.firstChild);return S.remove(),c(A),o(t),!0}return!1}var Vs=Je(()=>{});function bo(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=r=>{if(r&&!(r.nodeType===Node.ELEMENT_NODE&&r.tagName==="A")){if(r.nodeType===Node.TEXT_NODE){let o=r.textContent||"";if(hi.lastIndex=0,!hi.test(o))return;let s=document.createDocumentFragment(),a=0;hi.lastIndex=0;let c;for(;(c=hi.exec(o))!==null;){let[l]=c;c.index>a&&s.appendChild(document.createTextNode(o.slice(a,c.index)));let d=l.startsWith("http")?l:`https://${l}`,m=document.createElement("a");m.href=d,m.target="_blank",m.rel="noopener noreferrer",m.textContent=l,s.appendChild(m),a=c.index+l.length}a<o.length&&s.appendChild(document.createTextNode(o.slice(a))),r.parentNode&&r.parentNode.replaceChild(s,r);return}Array.from(r.childNodes||[]).forEach(n)}};return Array.from(t.content.childNodes).forEach(n),t.innerHTML}function Bl(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll("script, style").forEach(o=>o.remove());let n=(o="")=>/^javascript:/i.test(o.trim()),r=o=>{if(!o||o.nodeType!==Node.ELEMENT_NODE){Array.from(o?.childNodes||[]).forEach(r);return}Array.from(o.attributes||[]).forEach(i=>{let s=i.name.toLowerCase(),a=i.value||"";if(s.startsWith("on")||s==="style"){o.removeAttribute(i.name);return}(s==="href"||s==="src")&&n(a)&&o.removeAttribute(i.name)}),Array.from(o.childNodes||[]).forEach(r)};return Array.from(t.content.childNodes||[]).forEach(r),t.innerHTML}function gi(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=r=>{if(!r)return!0;if(r.nodeType===Node.TEXT_NODE)return!(r.textContent||"").replace(/\u00a0/g,"").trim();if(r.nodeType!==Node.ELEMENT_NODE)return!1;if(r.tagName==="BR")return!0;let o=(r.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&nbsp;/gi,"").trim(),i=(r.textContent||"").replace(/\u00a0/g,"").trim(),s=!!r.querySelector("img,video,audio,iframe");return!o&&!i&&!s};for(;t.content.firstChild&&n(t.content.firstChild);)t.content.removeChild(t.content.firstChild);for(;t.content.lastChild&&n(t.content.lastChild);)t.content.removeChild(t.content.lastChild);return t.innerHTML}function Nl(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=(t.content.textContent||"").replace(/\u00a0/g," ").trim(),r=!!t.content.querySelector("a"),o=!1;{let w=Array.from(t.content.childNodes||[]);for(let p=0;p<w.length;p+=1){let f=w[p];if(f.nodeType===Node.TEXT_NODE){if(!(f.textContent||"").trim())continue;break}nr(f)&&(o=!0);break}}let i=document.createElement("template");i.innerHTML=e||"",i.content.querySelectorAll("img").forEach(w=>{let p=String(w.getAttribute("src")||"").trim();if(!/^(blob:|filesystem:)/i.test(p))return;let f=String(w.getAttribute("alt")||"").trim()||"image",S=w.closest?.(".resizable-image")||w;try{S.replaceWith(document.createTextNode(`[${f} \u2014 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0431\u044B\u043B\u043E blob: \u0438 \u043D\u0435 \u0431\u044B\u043B\u043E \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E]`))}catch{}});let a=(()=>{if(!Array.from(i.content.childNodes||[]).length)return!1;let p=Array.from(i.content.querySelectorAll("p"));if(p.length<2)return!1;let f=te=>{let ye=te.trim();return ye.startsWith("|")&&ye.indexOf("|",1)!==-1},A=p.map(te=>(te.textContent||"").replace(/\u00a0/g," ").trim()).filter(te=>te);if(A.length<2||!A.every(f))return!1;let C=A.map(te=>{let ye=te.trim();return(ye.endsWith("|")?ye.slice(1,-1):ye.slice(1)).split("|").map(pt=>pt.trim())}),T=C[0],O=C.slice(1),$=O.reduce((te,ye)=>Math.max(te,ye.length),T.length),q=document.createElement("table");q.className="memus-table";let R=document.createElement("colgroup"),Q=100/Math.max($,1);for(let te=0;te<$;te+=1){let ye=document.createElement("col");ye.setAttribute("width",`${Q.toFixed(4)}%`),R.appendChild(ye)}q.appendChild(R);let Y=document.createElement("thead"),re=document.createElement("tr");for(let te=0;te<$;te+=1){let ye=document.createElement("th");ye.textContent=T[te]||"",re.appendChild(ye)}Y.appendChild(re),q.appendChild(Y);let Ae=document.createElement("tbody");return O.forEach(te=>{let ye=document.createElement("tr"),je=[...te];for(let pt=0;pt<$;pt+=1){let vt=document.createElement("td");vt.textContent=je[pt]||"",ye.appendChild(vt)}Ae.appendChild(ye)}),q.appendChild(Ae),i.content.innerHTML="",i.content.appendChild(q),bo(i.innerHTML).replace(/<\/a>\s*<a/gi,"</a> <a")})();if(a)return a;i.content.querySelectorAll(".table-toolbar, .table-toolbar-btn").forEach(w=>{w.remove()}),i.content.querySelectorAll(".block-header").forEach(w=>{let p=w.parentNode;if(p){for(;w.firstChild;)p.insertBefore(w.firstChild,w);p.removeChild(w)}});let c=w=>{Array.from(w.childNodes).forEach(p=>{if(p.nodeType===Node.ELEMENT_NODE){if(p.tagName==="DIV"){let f=document.createElement("p");f.innerHTML=p.innerHTML,p.parentNode.replaceChild(f,p),c(f);return}c(p)}})};c(i.content),(w=>{Array.from(w.childNodes||[]).forEach(f=>{if(f.nodeType===Node.TEXT_NODE){let A=(f.textContent||"").replace(/\u00a0/g," ");if(!A.trim()){if(f.previousSibling&&f.nextSibling){f.textContent=" ";return}w.removeChild(f);return}let T=document.createElement("p");T.textContent=A,w.replaceChild(T,f)}})})(i.content),i.content.querySelectorAll("p").forEach(w=>{(w.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim()||(w.innerHTML="",w.appendChild(document.createElement("br")))});let d=i.content;if(!!d.querySelector("p")){if(o){let w=Array.from(d.childNodes||[]),p=null;for(let f=0;f<w.length;f+=1){let S=w[f];if(!(S.nodeType===Node.TEXT_NODE&&!(S.textContent||"").trim())){p=S;break}}if(p){if(!(p.tagName==="P"&&nr(p))){let f=document.createElement("p");f.appendChild(document.createElement("br")),d.insertBefore(f,p)}}else{let f=document.createElement("p");f.appendChild(document.createElement("br")),d.appendChild(f)}}}else{let w=document.createElement("p");w.appendChild(document.createElement("br")),d.appendChild(w)}let b=bo(i.innerHTML).replace(/<\/a>\s*<a/gi,"</a> <a");return!b.trim()&&(n||r)?e||"":b}var hi,Ml=Je(()=>{Vs();hi=/((?:https?:\/\/|www\.)[^\s<>"']+)/gi});function rr(e){if(!e)return;if(!(e.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&nbsp;/gi,"").trim()){e.innerHTML="";let n=document.createRange();n.selectNodeContents(e),n.collapse(!0);let r=window.getSelection();r&&(r.removeAllRanges(),r.addRange(n))}}var js=Je(()=>{});function gr(e){if(!e)return!1;if(e.type&&e.type.startsWith("image/"))return!0;let t=(e.name||"").toLowerCase();return t?/\.(png|jpe?g|gif|webp|bmp|svg|heic|heif)$/i.test(t):!1}function Js(e=[],t=[]){let n=[];return Array.from(e||[]).forEach(r=>{if(r.kind==="file"){let o=typeof r.getAsFile=="function"?r.getAsFile():null;o&&gr(o)&&n.push(o)}}),!n.length&&t?.length&&Array.from(t).forEach(r=>{gr(r)&&n.push(r)}),n}function Ws(e=[],t=[]){let n=[];return Array.from(e||[]).forEach(r=>{if(r.kind==="file"){let o=typeof r.getAsFile=="function"?r.getAsFile():null;o&&!gr(o)&&n.push(o)}}),!n.length&&t?.length&&Array.from(t).forEach(r=>{gr(r)||n.push(r)}),n}async function yi(e,t,n){let r=`img-${Date.now()}-${Math.random().toString(16).slice(2)}`,o=t&&t.name?t.name:"image",i=qt(o).replace(/"/g,"&quot;");try{rr(e),qn(e,`<span data-pending-image="true" data-image-token="${r}">${i} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F...)</span>`)}catch{}try{let{url:s}=await ro(t),c=`
      <span class="resizable-image" style="width:320px;max-width:100%;">
        <span class="resizable-image__inner">${`<img src="${s}" alt="${i}" draggable="false" />`}</span>
        <span class="resizable-image__handle" data-direction="e" aria-hidden="true"></span>
      </span>
    `,l=e,d=l&&l.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`);if(n&&(!d||!l.isConnected)){let m=document.querySelector(`.block[data-block-id="${n}"]`);if(m){let b=m.querySelector('.block-text[contenteditable="true"]')||m.querySelector(".block-text.block-body");b&&(l=b,d=l.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`))}}d?(d.removeAttribute("data-pending-image"),d.removeAttribute("data-image-token"),d.outerHTML=c):l&&(rr(l),qn(l,c))}catch(s){try{let c=e;if(n&&!c.isConnected){let l=document.querySelector(`.block[data-block-id="${n}"]`);if(l){let m=l.querySelector('.block-text[contenteditable="true"]')||l.querySelector(".block-text.block-body");m&&(c=m)}}if(c){let l=c.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`);l&&(l.textContent=`${o} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F)`,l.removeAttribute("data-pending-image"))}}catch{}try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"insertImageFromFileError",data:{message:s&&s.message?String(s.message):String(s),name:t&&t.name,type:t&&t.type,size:t&&t.size}})}).catch(()=>{})}catch{}try{let c={where:"insertImageFromFile",message:s&&s.message?String(s.message):String(s),status:typeof s?.status=="number"?s.status:null,name:t&&t.name,type:t&&t.type,size:t&&t.size},l=c.status===null?"null":String(c.status);window.alert(`upload failed (status ${l}):\\n${JSON.stringify(c,null,2)}`)}catch{}let a=String(s?.message||"").toLowerCase();a.includes("status 0")||a.includes("network error")?Ce("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 (\u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C). \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438, \u043F\u0440\u0438 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u043E\u0441\u0442\u0438, \u0432\u043E\u0439\u0434\u0438\u0442\u0435 \u0437\u0430\u043D\u043E\u0432\u043E."):Ce(s.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435")}}function Qf(e){if(e.button!==0)return;let t=e.target?.closest(".resizable-image__handle");if(!t)return;let n=t.closest(".resizable-image"),o=n?.closest(".block")?.dataset?.blockId;if(!n||!o||u.mode!=="edit"||u.editingBlockId!==o)return;e.preventDefault(),e.stopPropagation();let i=n.getBoundingClientRect();or={wrapper:n,startWidth:i.width,startX:e.clientX},n.classList.add("resizable-image--resizing")}function Zf(e){if(!or)return;e.preventDefault();let t=e.clientX-or.startX,r=parseFloat(getComputedStyle(document.documentElement).fontSize)||16,o=Math.max(r,document.documentElement.clientWidth-32),i=or.startWidth+t;i=Math.max(r,Math.min(i,o)),or.wrapper.style.width=`${i}px`}function Pl(){or&&(or.wrapper.classList.remove("resizable-image--resizing"),or=null)}function _l(){Ll||(Ll=!0,document.addEventListener("pointerdown",Qf),document.addEventListener("pointermove",Zf),document.addEventListener("pointerup",Pl),document.addEventListener("pointercancel",Pl))}var or,Ll,Dl=Je(()=>{St();en();Vt();Bn();js();or=null,Ll=!1});function Ol({listTag:e,resolveTarget:t,restoreSelection:n,richContextRange:r,notifyEditingInput:o,setRichContextRange:i}){let s=t();if(!s||!document.contains(s))return;n();let a=window.getSelection(),c=null;if(r&&s.contains(r.commonAncestorContainer))c=r.cloneRange();else if(a&&a.rangeCount>0){let A=a.getRangeAt(0);s.contains(A.commonAncestorContainer)&&(c=A.cloneRange())}c||(c=document.createRange(),c.selectNodeContents(s),c.collapse(!1));let l=c.startContainer?.nodeType===Node.ELEMENT_NODE?c.startContainer:c.startContainer?.parentElement,d=l?.closest?.("li"),m=d?.closest?.("ol,ul"),h=A=>{if(!A)return;let C=document.createRange();C.selectNodeContents(A),C.collapse(!1),a&&(a.removeAllRanges(),a.addRange(C)),i(C);try{s.focus({preventScroll:!0})}catch{s.focus()}s.classList.remove("block-body--empty"),o(s)},b=A=>{let C=A.parentElement?.tagName==="P"&&A.parentElement.childNodes.length===1?A.parentElement:A,T=Array.from(A.children||[]).filter(q=>q.nodeType===Node.ELEMENT_NODE&&q.tagName==="LI"),O=document.createDocumentFragment(),$=[];T.forEach(q=>{let R=document.createElement("p");for(;q.firstChild;)R.appendChild(q.firstChild);$.push(R),O.appendChild(R)}),C.replaceWith(O),h($[0]||null)};if(m){if(m.tagName.toLowerCase()===e){b(m);return}let C=document.createElement(e);for(;m.firstChild;)C.appendChild(m.firstChild);m.replaceWith(C),h(d||C.lastElementChild||C);return}let w=()=>{if(!c.collapsed)return null;let A=l?.closest?.("p")||null;if(A&&s.contains(A))return A;if(c.startContainer===s){let C=Array.from(s.childNodes),T=c.startOffset;for(let O=T-1;O>=0;O-=1){let $=C[O];if($?.nodeType===Node.ELEMENT_NODE&&$.tagName==="P")return $}for(let O=T;O<C.length;O+=1){let $=C[O];if($?.nodeType===Node.ELEMENT_NODE&&$.tagName==="P")return $}}return null},p=[];if(c.collapsed){let A=w();A&&(p=[A])}else if(p=Array.from(s.querySelectorAll(":scope > p")).filter(C=>{try{return c.intersectsNode(C)}catch{return!1}}),!p.length){let C=l?.closest?.("p");C&&s.contains(C)&&(p=[C])}if(!p.length)return;let f=document.createElement(e);p.forEach(A=>{let C=document.createElement("li");for(;A.firstChild;)C.appendChild(A.firstChild);f.appendChild(C)}),p[0].replaceWith(f),p.slice(1).forEach(A=>A.remove()),h(f.firstElementChild||f)}var Rl=Je(()=>{});var Ds={};Po(Ds,{applyEditingUndoStep:()=>op,attachRichContentHandlers:()=>Us,buildEditableBlockHtml:()=>$s,buildStoredBlockHtml:()=>el,cleanupEditableHtml:()=>Nl,clearEditingUndoSession:()=>rp,countBlocks:()=>_s,ensureBlockVisible:()=>Bs,expandCollapsedAncestors:()=>sp,extendSelection:()=>vl,extractBlockSections:()=>$n,findBlock:()=>ft,findCollapsibleTarget:()=>ip,findFallbackBlockId:()=>ui,flattenVisible:()=>Hn,initEditingUndoForElement:()=>np,insertFilesIntoEditable:()=>zs,isSeparatorNode:()=>nr,moveSelection:()=>El,setCollapseState:()=>bi,setCurrentBlock:()=>tr,toggleCollapse:()=>Fs});function zl(e=""){return e?e.startsWith("app:/")?`/api/yandex/disk/file?path=${encodeURIComponent(e)}`:e.startsWith("disk:/")?`/api/yandex/disk/file?path=${encodeURIComponent(e)}`:e:""}function tp(e,t){if(e===t)return!1;if(t.startsWith(e)){let n=t.slice(e.length);if(n.length>0&&n.length<=ep&&/^[A-Za-zА-Яа-я0-9]+$/.test(n))return!1}return!0}function np(e,t){if(!e||!t)return;u.editingUndo={blockId:t,snapshots:[e.innerHTML],index:0,lastText:e.textContent||"",lastSnapshotAt:Date.now()};let n=()=>{let r=u.editingUndo;if(!r||r.blockId!==t)return;let o=e.innerHTML,i=e.textContent||"",{snapshots:s,index:a,lastText:c,lastSnapshotAt:l}=r,d=Date.now();if(!tp(c||"",i)){r.lastText=i;return}if(s[a]===o){r.lastText=i,r.lastSnapshotAt=d;return}a<s.length-1&&s.splice(a+1),s.push(o),r.index=s.length-1,r.lastText=i,r.lastSnapshotAt=d};e.addEventListener("input",()=>{!u.editingUndo||u.editingUndo.blockId!==t||u.mode!=="edit"||u.editingBlockId!==t||n()})}function rp(){u.editingUndo=null}function wo(e){if(e)try{let t=typeof InputEvent=="function"?new InputEvent("input",{bubbles:!0}):new Event("input",{bubbles:!0});e.dispatchEvent(t)}catch{try{let n=document.createEvent("Event");n.initEvent("input",!0,!1),e.dispatchEvent(n)}catch{}}}function op(e){let t=u.editingUndo;if(!t||!t.blockId||!e||u.mode!=="edit"||u.editingBlockId!==t.blockId)return!1;let n=document.querySelector(`.block[data-block-id="${t.blockId}"] .block-text[contenteditable="true"]`);if(!n)return!1;let r=t.index+e;if(r<0||r>=t.snapshots.length)return!1;t.index=r;let o=t.snapshots[r];n.innerHTML=o;try{n.focus({preventScroll:!0})}catch{n.focus()}try{let i=window.getSelection&&window.getSelection();if(i){let s=document.createRange();s.selectNodeContents(n),s.collapse(!1),i.removeAllRanges(),i.addRange(s)}}catch{}return!0}function $s(e=""){let t=$n(e);if(!t.titleHtml)return e||"";let n=Ks(t.titleHtml),r=t.bodyHtml||"";if(r){let i=document.createElement("template");i.innerHTML=r;let s=i.content.firstChild;for(;s&&nr(s);){let a=s;s=s.nextSibling,i.content.removeChild(a)}r=i.innerHTML}let o=Ks(r||"");return`${n}<p><br /></p>${o}`}function el(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll(".block-header").forEach(i=>{let s=i.parentNode;if(s){for(;i.firstChild;)s.insertBefore(i.firstChild,i);s.removeChild(i)}});let n=t.innerHTML,r=$n(n);if(!r.titleHtml)return e||"";let o=`<div class="block-header">${r.titleHtml}</div>`;return r.bodyHtml?`${o}<div><br /></div>${r.bodyHtml}`:o}async function Fs(e){let t=ft(e);t&&bi(e,!t.block.collapsed)}async function bi(e,t){let n=ft(e);if(!n||n.block.collapsed===t)return;let r=()=>{let s=document.getElementById("blocksContainer");if(!s)return null;let a=u.currentBlockId;if(!a)return{container:s};let c=s.querySelector(`.block[data-block-id="${a}"]`);if(!c)return{container:s};let l=s.getBoundingClientRect(),d=c.getBoundingClientRect();return{container:s,currentId:a,topOffset:d.top-l.top}},o=s=>{if(!s?.container)return;let{container:a}=s;if(!s.currentId||typeof s.topOffset!="number")return;let c=a.querySelector(`.block[data-block-id="${s.currentId}"]`);if(!c)return;let l=a.getBoundingClientRect(),m=c.getBoundingClientRect().top-l.top;a.scrollTop+=m-s.topOffset},i=r();n.block.collapsed=t,await tn(e),yo({scrollIntoView:!1}),o(i);try{let s=await bt(`/api/articles/${u.articleId}/collapse`,{method:"PATCH",body:JSON.stringify({blockId:e,collapsed:t})});s?.updatedAt&&(u.article.updatedAt=s.updatedAt)}catch(s){n.block.collapsed=!t,await tn(e),yo({scrollIntoView:!1}),o(i),Ce(s.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430")}}function ip(e,t){let n=ft(e);for(;n;){let o=!!$n(n.block.text||"").titleHtml,i=!!n.block.children?.length;if((o||i)&&n.block.collapsed!==t)return n.block.id;if(!n.parent)break;n=ft(n.parent.id)}return null}async function sp(e){let t=ft(e);if(!t)return;let n=(t.ancestors||[]).filter(r=>r.collapsed);for(let r of n)await bi(r.id,!1)}function ui(e){let t=ft(e);if(!t)return null;let n=t.siblings?.[t.index+1];if(n)return n.id;let r=t.siblings?.[t.index-1];return r?r.id:t.parent?t.parent.id:null}function _s(e=[]){return(e||[]).reduce((t,n)=>t+1+_s(n.children||[]),0)}async function Gs(e,t,n){if(!u.articleId){Ce("\u041D\u0435 \u0432\u044B\u0431\u0440\u0430\u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044F \u0434\u043B\u044F \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0444\u0430\u0439\u043B\u0430");return}let r=`att-${Date.now()}-${Math.random().toString(16).slice(2)}`,o=qt(t?.name||"\u0444\u0430\u0439\u043B"),i=t?.name||"\u0444\u0430\u0439\u043B",s="";Jt("attachment: uploading to Yandex Disk",{name:t?.name,type:t?.type,size:t?.size,articleId:u.articleId,token:r});try{rr(e),qn(e,`<a data-pending-attachment="true" data-attachment-token="${r}">${o} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430...)</a>`)}catch{}try{let a=await jo(u.articleId,t,{onProgress:h=>{let b=Math.max(0,Math.min(100,Math.round(h||0)));Jt("attachment upload progress",{percent:b,name:t?.name});try{let w=e,p=w.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);if(n&&(!p||!w.isConnected)){let f=document.querySelector(`.block[data-block-id="${n}"]`);if(f){let A=f.querySelector('.block-text[contenteditable="true"]')||f.querySelector(".block-text.block-body");A&&(w=A,p=w.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`))}}if(p){let f=b>=100?`${i} (\u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0430...)`:`${i} (${b}%)`;f!==s&&(s=f,p.textContent=f)}}catch{}}}),c=qt(a.originalName||t.name||"\u0444\u0430\u0439\u043B"),l=a.storedPath||a.url||"",d=zl(l),m=qt(d);if(m){let h=e,b=h.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);if(n&&(!b||!h.isConnected)){let w=document.querySelector(`.block[data-block-id="${n}"]`);if(w){let f=w.querySelector('.block-text[contenteditable="true"]')||w.querySelector(".block-text.block-body");f&&(h=f,b=h.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`))}}b?(b.removeAttribute("data-pending-attachment"),b.removeAttribute("data-attachment-token"),b.setAttribute("href",m),b.setAttribute("target","_blank"),b.setAttribute("rel","noopener noreferrer"),b.textContent=c):(rr(h),qn(h,`<a href="${m}" target="_blank" rel="noopener noreferrer">${c}</a>`))}}catch(a){try{let l=e;if(n&&!l.isConnected){let m=document.querySelector(`.block[data-block-id="${n}"]`);if(m){let b=m.querySelector('.block-text[contenteditable="true"]')||m.querySelector(".block-text.block-body");b&&(l=b)}}let d=l.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);d&&(d.textContent=`${o} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`)}catch{}let c=String(a?.message||"").toLowerCase();c.includes("status 0")||c.includes("network error")?Ce("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B (\u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C). \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438, \u043F\u0440\u0438 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u043E\u0441\u0442\u0438, \u0432\u043E\u0439\u0434\u0438\u0442\u0435 \u0437\u0430\u043D\u043E\u0432\u043E."):Ce(a.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u043D\u0430 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A")}}function zs(e,t=[],n){if(!e||!t||!t.length)return;let r=Array.from(t),o=r.filter(s=>gr(s)),i=r.filter(s=>s&&!gr(s));o.forEach(s=>yi(e,s,n)),i.forEach(s=>Gs(e,s,n))}function Us(e,t){Fl(e,t);let n=e.closest(".block-content");n&&n!==e&&Fl(n,t,e),e.addEventListener("paste",r=>{if(u.mode!=="edit"||u.editingBlockId!==t)return;let o=Js(r.clipboardData?.items),i=Ws(r.clipboardData?.items);if(o.length>0)r.preventDefault(),o.forEach(s=>yi(e,s,t));else if(i.length>0)r.preventDefault(),Jt("paste: non-image files detected",i.map(s=>({name:s.name,type:s.type,size:s.size}))),i.forEach(s=>Gs(e,s,t));else{r.preventDefault();let s=h=>{let b=String(h||"").trim();if(!b)return"";let w=document.createElement("template");w.innerHTML=b;let p=w.content.querySelector("body");return((p?p.innerHTML:w.innerHTML)||"").replace(/<!--\s*StartFragment\s*-->/gi,"").replace(/<!--\s*EndFragment\s*-->/gi,"").trim()},a=h=>{let b=String(h||"").trim();if(!b)return"";if(/<\s*(table|ul|ol)\b/i.test(b)||!/<\s*(p|div|h[1-6])\b/i.test(b))return b;let w=document.createElement("template");w.innerHTML=b,(C=>{w.content.querySelectorAll(C).forEach(T=>{let O=T.parentNode;if(O){for(;T.firstChild;)O.insertBefore(T.firstChild,T);O.removeChild(T)}})})("ms-cmark-node");let f=[],S=C=>{let T=String(C||"").replace(/^\s*(<br\s*\/?>\s*)+/gi,"").replace(/(\s*<br\s*\/?>\s*)+$/gi,"").trim();T&&f.push(T)},A=Array.from(w.content.childNodes||[]);for(let C of A){if(!C)continue;if(C.nodeType===Node.TEXT_NODE){let O=(C.textContent||"").replace(/\u00a0/g," ").trim();O&&S(qt(O));continue}if(C.nodeType!==Node.ELEMENT_NODE)continue;let T=(C.tagName||"").toUpperCase();if(/^H[1-6]$/.test(T)){S(`<strong>${C.innerHTML||""}</strong>`);continue}if(T==="P"||T==="DIV"||T==="LI"||T==="BLOCKQUOTE"){S(C.innerHTML||"");continue}if(T==="BR"){S("<br />");continue}S(C.outerHTML||C.innerHTML||"")}return f.length?f.join("<br /><br />"):""},c=h=>{rr(e);try{e.focus({preventScroll:!0})}catch{e.focus()}try{if(typeof document.execCommand=="function"&&document.execCommand("insertHTML",!1,h))return!0}catch{}return qn(e,h),!0},l=h=>{let b=s(h);if(!b)return!1;let p=(T=>{let O=document.createElement("template");O.innerHTML=String(T||"");let $=!1;return O.content.querySelectorAll("img").forEach(q=>{let R=String(q.getAttribute("src")||"").trim();if(!/^(blob:|filesystem:)/i.test(R))return;$=!0;let Q=String(q.getAttribute("alt")||"").trim()||"image",Y=q.closest?.(".resizable-image")||q;try{Y.replaceWith(document.createTextNode(`[${Q} \u2014 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0438\u0437 \u0431\u0443\u0444\u0435\u0440\u0430 \u043E\u0431\u043C\u0435\u043D\u0430 (blob:) \u043D\u0435 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E]`))}catch{}}),{html:O.innerHTML,hadUnstable:$}})(b);p.hadUnstable&&Ce("\u041A\u0430\u0440\u0442\u0438\u043D\u043A\u0430 \u0431\u044B\u043B\u0430 \u0432\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u0430 \u043A\u0430\u043A blob: URL \u0438 \u043D\u0435 \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u0441\u044F \u043F\u043E\u0441\u043B\u0435 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438. \u0412\u0441\u0442\u0430\u0432\u044C\u0442\u0435 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u043A\u0430\u043A \u0444\u0430\u0439\u043B (\u043F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435/\u0432\u0441\u0442\u0430\u0432\u044C\u0442\u0435 \u0444\u0430\u0439\u043B \u0438\u043B\u0438 \u0441\u043A\u0440\u0438\u043D\u0448\u043E\u0442).");let f=Bl(p.html),S=a(f);if(!S)return!1;let A=gi(f),C=gi(S)||A;return c(bo(C)),wo(e),!0},d=h=>{let b=String(h||""),w=b.trim();if(/^https?:\/\/\S+$/i.test(w)){let C=qt(w);return rr(e),qn(e,`<a href="${C}" target="_blank" rel="noopener noreferrer">${C}</a>`),wo(e),!0}let f=b.replace(/\r\n/g,`
`).replace(/\r/g,`
`),S=qt(f).replace(/\n{2,}/g,"<br /><br />").replace(/\n/g,"<br />"),A=bo(gi(S));return c(A),wo(e),!0},m=(r.clipboardData?.getData("text/html")||"").trim();if(m&&l(m))return;try{let b=Array.from(r.clipboardData?.items||[]).find(w=>w&&w.kind==="string"&&w.type==="text/html");if(b&&typeof b.getAsString=="function"){b.getAsString(w=>{try{if(l(w))return}catch{}try{let p=r.clipboardData?.getData("text/plain")||"";d(p)}catch{}});return}}catch{}{let h=r.clipboardData?.getData("text/plain")||"";d(h)}}}),e.addEventListener("drop",r=>{if(u.mode!=="edit"||u.editingBlockId!==t){Jt("drop ignored",{mode:u.mode,editingBlockId:u.editingBlockId,targetBlockId:t});return}let o=Array.from(r.dataTransfer?.files||[]);if(!o.length)return;let i=o.filter(a=>a.type?.startsWith("image/")),s=o.filter(a=>!a.type||!a.type.startsWith("image/"));!i.length&&!s.length||(r.preventDefault(),Jt("drop: files detected",o.map(a=>({name:a.name,type:a.type,size:a.size}))),i.forEach(a=>yi(e,a,t)),s.forEach(a=>Gs(e,a,t)))}),e.addEventListener("click",r=>{let o=r.target?.closest("img");if(o){if(r.target?.closest(".resizable-image__handle")){r.preventDefault();return}r.preventDefault(),so(o.src,o.alt||"");return}let i=r.target?.closest("a[href]");if(!i)return;let s=i.getAttribute("href")||"";if(!s.startsWith("app:/")&&!s.startsWith("disk:/"))return;r.preventDefault();let a=zl(s);a&&window.open(a,"_blank","noopener,noreferrer")}),u.articleId==="inbox"&&e.addEventListener("click",async r=>{if(r.target?.closest(".move-block-btn")){r.preventDefault(),r.stopPropagation();try{let s=(u.articlesIndex.length?u.articlesIndex:await hn()).filter(d=>d.id!=="inbox").map(d=>({id:d.id,title:d.title||"\u0420\u2018\u0420\xB5\u0420\xB7 \u0420\u0405\u0420\xB0\u0420\xB7\u0420\u0406\u0420\xB0\u0420\u0405\u0420\u0451\u0421\u040F"})),a=await Xn({title:"\u0420\u045F\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451 \u0420\u0406 \u0421\u0403\u0421\u201A\u0420\xB0\u0421\u201A\u0421\u040A\u0421\u040B",message:"\u0420\u2019\u0420\u0406\u0420\xB5\u0420\u0491\u0420\u0451\u0421\u201A\u0420\xB5 ID \u0420\u0451\u0420\xBB\u0420\u0451 \u0420\u0406\u0421\u2039\u0420\xB1\u0420\xB5\u0421\u0402\u0420\u0451\u0421\u201A\u0420\xB5 \u0421\u0403\u0421\u201A\u0420\xB0\u0421\u201A\u0421\u040A\u0421\u040B",confirmText:"\u0420\u045F\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451",cancelText:"\u0420\u045B\u0421\u201A\u0420\u0458\u0420\xB5\u0420\u0405\u0420\xB0",suggestions:s,returnMeta:!0,hideConfirm:!1}),l=(a?.selectedId||(typeof a=="object"?a?.value:a)||""||"").trim();if(!l)return;await bt(`/api/articles/${u.articleId}/blocks/${t}/move-to/${l}`,{method:"POST"}),ln(Wt.article("inbox"))}catch(i){Ce(i.message||"\u0420\u045C\u0420\xB5 \u0421\u0453\u0420\u0491\u0420\xB0\u0420\xBB\u0420\u0455\u0421\u0403\u0421\u040A \u0420\u0457\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451 \u0420\xB1\u0420\xBB\u0420\u0455\u0420\u0454")}}}),e.addEventListener("dragover",r=>{if(u.mode!=="edit"||u.editingBlockId!==t)return;(Js(r.dataTransfer?.items).length>0||Ws(r.dataTransfer?.items).length>0)&&r.preventDefault()}),e.addEventListener("keydown",r=>{if(u.mode!=="edit"||u.editingBlockId!==t)return;let o=window.getSelection();if(!o||o.rangeCount===0)return;let i=o.getRangeAt(0);if(!i||!i.collapsed||Tl({event:r,element:e,range:i,selection:o,notifyEditingInput:wo,logDebug:Jt})||r.key!=="Tab"||!(i.commonAncestorContainer?.nodeType===Node.ELEMENT_NODE?i.commonAncestorContainer:i.commonAncestorContainer?.parentElement)?.closest?.("li"))return;r.preventDefault(),r.stopPropagation();let c=r.shiftKey?"outdent":"indent";document.execCommand(c,!1,null)})}function Ul(){let e=window.getSelection();if(!e||e.rangeCount===0)return;let t=e.getRangeAt(0),n=t.commonAncestorContainer,o=(n?.nodeType===Node.ELEMENT_NODE?n:n?.parentElement)?.closest('.block-text[contenteditable="true"]');if(!o){xo=null;return}let s=o.closest(".block")?.dataset?.blockId;if(u.mode!=="edit"||u.editingBlockId!==s){xo=null;return}xo=t.cloneRange()}function ap(){if(Ys)return Ys;Hl||(document.addEventListener("selectionchange",Ul),Hl=!0);let e=document.createElement("div");e.className="rich-context-menu hidden",e.innerHTML=`
    <div class="rich-context-menu__col rich-context-menu__col--buffer">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="copy" aria-label="\u041A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C" title="\u041A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C">\u29C9</button>
        <button class="rich-context-menu__icon-btn" data-action="cut" aria-label="\u0412\u044B\u0440\u0435\u0437\u0430\u0442\u044C" title="\u0412\u044B\u0440\u0435\u0437\u0430\u0442\u044C">\u2702</button>
        <button class="rich-context-menu__icon-btn" data-action="paste" aria-label="\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C" title="\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C">\u25A3</button>
        <button class="rich-context-menu__icon-btn" data-action="select-all" aria-label="\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0432\u0441\u0451" title="\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0432\u0441\u0451">\u26F6</button>
      </div>
    </div>
    <div class="rich-context-menu__col">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="bold" aria-label="\u041F\u043E\u043B\u0443\u0436\u0438\u0440\u043D\u044B\u0439" title="\u041F\u043E\u043B\u0443\u0436\u0438\u0440\u043D\u044B\u0439"><strong>\u0416</strong></button>
        <button class="rich-context-menu__icon-btn" data-action="italic" aria-label="\u041A\u0443\u0440\u0441\u0438\u0432" title="\u041A\u0443\u0440\u0441\u0438\u0432"><em>/</em></button>
        <button class="rich-context-menu__icon-btn" data-action="underline" aria-label="\u041F\u043E\u0434\u0447\u0435\u0440\u043A\u043D\u0443\u0442\u044C" title="\u041F\u043E\u0434\u0447\u0435\u0440\u043A\u043D\u0443\u0442\u044C"><u>\u0427</u></button>
        <button class="rich-context-menu__icon-btn" data-action="remove-format" aria-label="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0444\u043E\u0440\u043C\u0430\u0442" title="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0444\u043E\u0440\u043C\u0430\u0442">\u2715</button>
      </div>
    </div>
    <div class="rich-context-menu__col">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="ul" aria-label="\u041C\u0430\u0440\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A" title="\u041C\u0430\u0440\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A">\u2022</button>
        <button class="rich-context-menu__icon-btn" data-action="ol" aria-label="\u041D\u0443\u043C\u0435\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A" title="\u041D\u0443\u043C\u0435\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A">1.</button>
        <button class="rich-context-menu__icon-btn" data-action="quote" aria-label="\u0426\u0438\u0442\u0430\u0442\u0430" title="\u0426\u0438\u0442\u0430\u0442\u0430">\u275D</button>
        <button class="rich-context-menu__icon-btn" data-action="code" aria-label="\u041A\u043E\u0434" title="\u041A\u043E\u0434">&lt;/&gt;</button>
      </div>
    </div>
    <div class="rich-context-menu__col">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="link" aria-label="\u0421\u0441\u044B\u043B\u043A\u0430" title="\u0421\u0441\u044B\u043B\u043A\u0430">\u{1F517}</button>
        <button class="rich-context-menu__icon-btn" data-action="unlink" aria-label="\u0423\u0431\u0440\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443" title="\u0423\u0431\u0440\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443">\u2298</button>
        <button class="rich-context-menu__icon-btn" data-action="insert-article-link" aria-label="\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E" title="\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E">\xA7</button>
      </div>
    </div>
    <div class="rich-context-menu__col">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="split-at-caret" aria-label="\u0420\u0430\u0437\u0434\u0435\u043B\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043F\u043E \u043A\u0443\u0440\u0441\u043E\u0440\u0443" title="\u0420\u0430\u0437\u0434\u0435\u043B\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043F\u043E \u043A\u0443\u0440\u0441\u043E\u0440\u0443">|\u21B5</button>
      </div>
    </div>
  `,document.body.appendChild(e);let t=()=>{e.classList.add("hidden"),e.style.visibility="",Nt=null,zr=null,So=null},n=()=>{if(Nt){let o=window.getSelection();o.removeAllRanges(),o.addRange(Nt)}},r=async o=>{n();let i=()=>{if(zr&&document.contains(zr))return zr;let h=window.getSelection()?.anchorNode?.parentElement?.closest(".block-text[contenteditable]");if(h)return h;if(Nt){let w=Nt.commonAncestorContainer;if(w?.parentElement){let p=w.parentElement.closest(".block-text[contenteditable]");if(p)return p}}if(So&&document.contains(So))return So;if(u.editingBlockId){let w=document.querySelector(`.block[data-block-id="${u.editingBlockId}"] .block-text[contenteditable="true"]`);if(w)return w}let b=document.activeElement;if(b&&b.closest){let w=b.closest(".block-text[contenteditable]");if(w)return w}return null},s=d=>{Ol({listTag:d,resolveTarget:i,restoreSelection:n,richContextRange:Nt,notifyEditingInput:wo,setRichContextRange:m=>{Nt=m?m.cloneRange():null}})},a=async()=>{let d=i();if(!d){Ce("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0441\u0441\u044B\u043B\u043A\u0438");return}let m=u.articlesIndex.length?u.articlesIndex:await hn(),h=m.map(C=>({id:C.id,title:C.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),b="",w="";try{let C=await Xn({title:"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438. \u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0438 \u043F\u043E\u043C\u043E\u0433\u0443\u0442 \u043D\u0430\u0439\u0442\u0438 \u043D\u0443\u0436\u043D\u0443\u044E.",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:h,returnMeta:!0,hideConfirm:!0});C&&typeof C=="object"?(b=C.value||"",w=C.selectedId||""):b=C||""}catch{b=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438")||""}let p=(b||"").trim().toLowerCase();if(!p&&!w)return;let f=m.find(C=>{let T=(C.title||"").toLowerCase();return w&&C.id===w||C.id&&C.id.toLowerCase()===p||T===p||T.includes(p)});if(!f){Ce("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}if(!d||!document.contains(d)){Ce("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0441\u0441\u044B\u043B\u043A\u0438");return}n(),d.focus();let S=`<a href="${Wt.article(f.id)}" class="article-link" data-article-id="${f.id}">${qt(f.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F")}</a>`;qn(d,S);let A=(d.innerHTML||"").trim();(!A||A==="<br>"||A==="<br/>"||A==="<br />")&&(d.innerHTML=S),d.classList.remove("block-body--empty")},c=()=>{n();let d=window.getSelection();if(!(!d||d.rangeCount===0)){document.execCommand("removeFormat");for(let m=0;m<4;m+=1)document.execCommand("outdent");document.execCommand("formatBlock",!1,"p")}},l=d=>{let m=i();if(!m||!document.contains(m))return Ce("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u0442\u0435\u043A\u0441\u0442 \u0434\u043B\u044F \u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F"),null;let h=window.getSelection();if(!h||h.rangeCount===0)return null;let b=h.getRangeAt(0).cloneRange();if(!b||b.collapsed)return null;let w=b.cloneContents(),p=document.createElement("div");p.appendChild(w);let f=p.innerHTML||"",S=p.textContent||"",C=m.closest(".block")?.dataset.blockId||null;return Fr={html:f,text:S,sourceBlockId:C},Jt("clipboard.capture",{kind:d,hasHtml:!!f,length:S.length,blockId:C}),{range:b,target:m}};switch(o){case"cut":{if(!l("cut"))break;document.execCommand("cut");break}case"copy":l("copy"),document.execCommand("copy");break;case"select-all":{let d=i();if(!d||!document.contains(d))break;let m=document.createRange();m.selectNodeContents(d);let h=window.getSelection();h&&(h.removeAllRanges(),h.addRange(m)),Nt=m.cloneRange();break}case"paste":{let d=i();if(!d||!document.contains(d)){Ce("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438");break}if(!Fr||!Fr.html&&!Fr.text){Ce("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0441\u043A\u043E\u043F\u0438\u0440\u0443\u0439\u0442\u0435 \u0438\u043B\u0438 \u0432\u044B\u0440\u0435\u0436\u044C\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u0432 \u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440\u0435");break}n();let m=window.getSelection(),h=null;if(Nt&&d.contains(Nt.commonAncestorContainer))h=Nt.cloneRange();else if(m&&m.rangeCount>0){let f=m.getRangeAt(0);d.contains(f.commonAncestorContainer)&&(h=f.cloneRange())}h||(h=document.createRange(),h.selectNodeContents(d),h.collapse(!1));let b=Fr.html||qt(Fr.text).replace(/\n/g,"<br />"),w=document.createElement("div");w.innerHTML=b;let p=document.createDocumentFragment();for(;w.firstChild;)p.appendChild(w.firstChild);h.deleteContents(),h.insertNode(p),h.collapse(!1),m&&(m.removeAllRanges(),m.addRange(h)),d.focus({preventScroll:!0}),d.classList.remove("block-body--empty");break}case"bold":document.execCommand("bold");break;case"italic":document.execCommand("italic");break;case"underline":document.execCommand("underline");break;case"ul":s("ul");break;case"ol":s("ol");break;case"quote":document.execCommand("formatBlock",!1,"blockquote");break;case"code":document.execCommand("formatBlock",!1,"pre");break;case"link":{let d=window.getSelection(),m=d?d.toString():"",h=d?.anchorNode,b=h?h.parentElement?.closest("a"):null,w=b?.getAttribute("href")||"",p=await cs({title:"\u0421\u0441\u044B\u043B\u043A\u0430",textLabel:"\u0422\u0435\u043A\u0441\u0442",urlLabel:"\u0421\u0441\u044B\u043B\u043A\u0430",defaultText:m||b?.textContent||"",defaultUrl:w,confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"});if(Jt("link action: prompt result",{hasResult:!!p,url:p?.url,text:p?.text}),!p||!p.url)break;let f=p.url.match(/^[a-z]+:/i)?p.url:`https://${p.url}`,S=p.text?.trim()||f;n();let A=i();if(Jt("link action: target",{targetExists:!!A,inDom:!!(A&&document.contains(A)),className:A?.className}),!A||!document.contains(A))break;let C=window.getSelection(),T=null;Nt&&A.contains(Nt.commonAncestorContainer)?T=Nt.cloneRange():C&&C.rangeCount>0&&A.contains(C.getRangeAt(0).commonAncestorContainer)&&(T=C.getRangeAt(0).cloneRange()),T||(T=document.createRange(),T.selectNodeContents(A),T.collapse(!1)),Jt("link action: range chosen",{usedSelectionRange:!!(C&&C.rangeCount>0&&A.contains(C.getRangeAt(0).commonAncestorContainer)),usedStoredRange:!!(Nt&&A.contains(Nt.commonAncestorContainer)),selectionRangeCollapsed:!!(C&&C.rangeCount>0&&C.getRangeAt(0).collapsed),rangeStartNode:T?.startContainer?.nodeName,rangeOffset:T?.startOffset,labelLength:(S||"").length,url:f});let O=document.createElement("a");O.href=f,O.target="_blank",O.rel="noopener noreferrer",O.textContent=S,T.deleteContents(),T.insertNode(O),T.setStartAfter(O),T.setEndAfter(O),Jt("link action: inserted link",{outerHTML:O.outerHTML,parentClass:O.parentElement?.className,targetInner:A.innerHTML.slice(0,120)}),C&&(C.removeAllRanges(),C.addRange(T)),A.focus({preventScroll:!0}),A.classList.remove("block-body--empty");break}case"unlink":{let d=i();if(Jt("unlink action: target",{targetExists:!!d,inDom:!!(d&&document.contains(d)),className:d?.className}),!d||!document.contains(d))break;let m=window.getSelection(),h=null;if(m&&m.rangeCount>0){let b=m.getRangeAt(0).commonAncestorContainer;h=b?.parentElement?.closest("a")||b?.closest?.("a")}if(!h&&Nt){let b=Nt.commonAncestorContainer;h=b?.parentElement?.closest("a")||b?.closest?.("a")}if(h||(h=d.querySelector("a")),h){let b=document.createTextNode(h.textContent||"");h.replaceWith(b)}else document.execCommand("unlink");break}case"remove-format":c();break;case"insert-article-link":a().finally(()=>{t()});return;case"split-at-caret":await ol();break;default:break}t()};return e.addEventListener("click",o=>{let i=o.target.closest("button[data-action]");if(!i)return;let s=i.dataset.action;r(s)}),document.addEventListener("click",o=>{e.classList.contains("hidden")||e.contains(o.target)||t()}),document.addEventListener("touchstart",o=>{e.classList.contains("hidden")||e.contains(o.target)||t()},{passive:!0}),document.addEventListener("keydown",o=>{o.code==="Escape"&&t()}),window.addEventListener("scroll",t,!0),Ys=e,e}function $l(e){let t=ap();t.classList.remove("hidden"),t.style.visibility="hidden",Ul();let n=window.getSelection();n&&n.rangeCount>0?Nt=n.getRangeAt(0).cloneRange():xo?Nt=xo.cloneRange():Nt=null;let r=t.getBoundingClientRect(),o=22,i=12,s=e.clientX+14,a=e.clientY+o;a+r.height+i>window.innerHeight&&(a=Math.max(i,e.clientY-r.height-o));let c=Math.min(Math.max(s,i),window.innerWidth-r.width-i),l=Math.min(Math.max(a,i),window.innerHeight-r.height-i);t.style.left=`${c}px`,t.style.top=`${l}px`,t.style.visibility="visible"}function Fl(e,t,n){let r=n||e;e.addEventListener("focusin",()=>{So=r}),e.addEventListener("contextmenu",s=>{u.mode!=="edit"||u.editingBlockId!==t||(s.preventDefault(),zr=r,$l(s))});let o=null;e.addEventListener("touchstart",s=>{if(u.mode!=="edit"||u.editingBlockId!==t||s.touches.length!==1)return;let a=s.touches[0];o=window.setTimeout(()=>{zr=r,$l({clientX:a.clientX,clientY:a.clientY})},500)},{passive:!0});let i=()=>{o!==null&&(clearTimeout(o),o=null)};e.addEventListener("touchend",i,{passive:!0}),e.addEventListener("touchcancel",i,{passive:!0})}async function Bs(e){if(!e)return;let t=ft(e);if(!t)return;let n=(t.ancestors||[]).filter(r=>r.collapsed);for(let r of n)await bi(r.id,!1)}var ep,Ys,Nt,zr,So,Fr,xo,Hl,Mn=Je(()=>{St();en();Vt();pr();Bn();Qn();en();Zn();Zn();Ls();Cl();Vs();Ml();js();Dl();Rl();ep=16;Ys=null,Nt=null,zr=null,So=null,Fr={html:"",text:"",sourceBlockId:null},xo=null,Hl=!1;_l()});function cp(){let e=u?.currentUser||null;return e&&(e.id||e.username)||"anon"}async function wi(){return Do({userKey:cp()})}async function ql(e={}){let t=String(e?.token||"").trim(),n=String(e?.articleId||"").trim();if(!t||!n)return!1;let r=String(e?.kind||"image"),o=e?.blob||null,i=String(e?.mime||o&&o.type||"").trim(),s=String(e?.fileName||"").trim()||null,a=Date.now(),l=(await wi()).transaction(["pending_uploads"],"readwrite"),d=l.objectStore("pending_uploads"),m=await Pe(d.get(t)).catch(()=>null),h=Number(m?.createdAtMs||e?.createdAtMs||a)||a,b={token:t,articleId:n,kind:r,blob:o,mime:i,fileName:s,status:String(e?.status||m?.status||"pending"),errorMessage:String(e?.errorMessage||m?.errorMessage||""),createdAtMs:h,updatedAtMs:a};return await Pe(d.put(b)),await We(l),!0}async function Xs(e){let t=String(e||"").trim();if(!t)return!1;let r=(await wi()).transaction(["pending_uploads"],"readwrite"),o=r.objectStore("pending_uploads");return await Pe(o.delete(t)),await We(r),!0}async function Qs(e,t){let n=String(e||"").trim();if(!n)return!1;let o=(await wi()).transaction(["pending_uploads"],"readwrite"),i=o.objectStore("pending_uploads"),s=await Pe(i.get(n)).catch(()=>null);return s?(s.status="error",s.errorMessage=String(t||"error"),s.updatedAtMs=Date.now(),await Pe(i.put(s)),await We(o),!0):(await We(o),!1)}async function Zs({articleId:e=null,limit:t=50}={}){let r=(await wi()).transaction(["pending_uploads"],"readonly"),o=r.objectStore("pending_uploads"),i=[];try{let s=Number(t||0)||0;if(e){let a=o.index("byArticleId");i=await Pe(a.getAll(String(e),s>0?s:void 0))}else i=await Pe(o.getAll(s>0?s:void 0))}catch{i=[]}return await We(r),Array.isArray(i)?(i.sort((s,a)=>Number(s?.createdAtMs||0)-Number(a?.createdAtMs||0)),i):[]}var Kl=Je(()=>{St();Ki();Sn()});var Si,Vl=Je(()=>{Si=["pending-attachment","app","disk"]});function ea(e){let n=String(e||"").replace(/\r\n/g,`
`).split(`
`),r=c=>{let l=String(c||"").match(/^(#{1,6})\s+(.*)$/);if(!l)return null;let d=String(l[2]||"").trim();return d?{level:l[1].length,title:d}:null},o=!1;try{let c=n.find(l=>String(l||"").trim().length>0)||"";o=!!r(c)}catch{o=!1}let i=[],s=null,a=()=>{if(s){try{for(;s.bodyLines.length&&!String(s.bodyLines[0]||"").trim();)s.bodyLines.shift()}catch{}s.bodyText=s.bodyLines.join(`
`).trimEnd(),delete s.bodyLines,i.push(s),s=null}};for(let c of n){let l=r(c);if(l){a(),s={level:l.level,title:l.title,bodyLines:[]};continue}s&&s.bodyLines.push(c)}return a(),{sections:i,startsWithHeading:o,headingCount:i.length}}function jl(e,t={}){let n=Array.isArray(e)?e.filter(Boolean):[],r=typeof t.makeId=="function"?t.makeId:()=>`${Date.now()}-${Math.random()}`;if(!n.length)return[];let o=Number.isFinite(t.baseLevel)?t.baseLevel:Number(n[0].level||1),i=[],s=[];for(let a of n){let c=Number(a.level||1),l=String(a.title||"").trim(),d=String(a.bodyText||"").trimEnd();if(!l)continue;let m=Math.max(0,c-o);for(;s.length>m;)s.pop();m>s.length&&(m=s.length);let h={id:r(),title:l,bodyText:d,children:[]},b=m>0?s[m-1]:null;b?b.children.push(h):i.push(h),s.push(h)}return i}var Jl=Je(()=>{});var ia={};Po(ia,{flushOutboxOnce:()=>Ur,getBackgroundFullPullStatus:()=>wp,startBackgroundFullPull:()=>Tp,startSyncLoop:()=>Cp,tryPullBootstrap:()=>xp});function lp(e,t=null){try{if(!e)return;let n=window.localStorage.getItem(xi)||"";if(!n)return;let r=JSON.parse(n);if(!r||typeof r!="object")return;let o=String(e),i=r[o]||null;if(!i)return;let s=Number(i?.queuedAt||0)||0,a=typeof t=="number"&&Number.isFinite(t)?t:null;if(a!=null&&s>a)return;delete r[o],window.localStorage.setItem(xi,JSON.stringify(r))}catch{}}function fp(e,t){try{let n=e&&typeof e=="object"?e:{type:"doc",content:[]},r=Array.isArray(n.content)?n.content:[],o=new Map,i=d=>{if(Array.isArray(d))for(let m of d){if(!m||typeof m!="object"||m.type!=="outlineSection")continue;let h=String(m?.attrs?.id||"").trim();h&&o.set(h,m);let w=(Array.isArray(m.content)?m.content:[]).find(p=>p&&typeof p=="object"&&p.type==="outlineChildren")||null;w&&Array.isArray(w.content)&&i(w.content)}};i(r);let s=(d,m)=>{let h=d&&typeof d=="object"?d:{type:"outlineSection",attrs:{id:m,collapsed:!1},content:[]};h.type="outlineSection";let b=h.attrs&&typeof h.attrs=="object"?h.attrs:{};b.id=m,h.attrs=b;let w=Array.isArray(h.content)?h.content:[],p=w.find(A=>A&&typeof A=="object"&&A.type==="outlineHeading")||{type:"outlineHeading",content:[]},f=w.find(A=>A&&typeof A=="object"&&A.type==="outlineBody")||{type:"outlineBody",content:[{type:"paragraph"}]},S=w.find(A=>A&&typeof A=="object"&&A.type==="outlineChildren")||{type:"outlineChildren",content:[]};return Array.isArray(S.content)||(S={...S,content:[]}),h.content=[p,f,S],h},a=new Set,c=new Map;for(let d of Array.isArray(t)?t:[]){let m=String(d?.sectionId||"").trim();if(!m)continue;let h=d?.parentId,b=h!=null&&String(h).trim()?String(h).trim():null,w=Number.isFinite(Number(d?.position))?Number(d.position):0,p=!!d?.collapsed,f=s(o.get(m),m);f.attrs={...f.attrs||{},id:m,collapsed:p},o.set(m,f),a.add(m),c.has(b)||c.set(b,[]),c.get(b).push({pos:w,sid:m,sec:f})}for(let[d,m]of c.entries())m.sort((h,b)=>h.pos-b.pos||String(h.sid).localeCompare(String(b.sid))),c.set(d,m);for(let[d,m]of o.entries()){let b=(c.get(d)||[]).map(w=>w.sec);try{Array.isArray(m.content)||(m.content=[]),(!m.content[2]||m.content[2].type!=="outlineChildren")&&(m.content[2]={type:"outlineChildren",content:[]}),m.content[2].content=b}catch{}}let l=(c.get(null)||[]).map(d=>d.sec);for(let[d,m]of o.entries())a.has(d)||l.push(m);return n.type="doc",n.content=l,n}catch{return e}}function pp(e,t,n,r){try{let o=String(t||"").trim();if(!o)return e;let i=e&&typeof e=="object"?e:{type:"doc",content:[]},s=[i];for(;s.length;){let a=s.pop();if(!a||typeof a!="object")continue;if(a.type==="outlineSection"&&String(a?.attrs?.id||"").trim()===o){let d=(Array.isArray(a.content)?a.content:[]).find(m=>m&&typeof m=="object"&&m.type==="outlineChildren")||{type:"outlineChildren",content:[]};return a.content=[n,r,d],i}let c=a.content;if(Array.isArray(c))for(let l of c)s.push(l)}return i}catch{return e}}function oa(e){let t=e?.type||"";return t==="section_upsert_content"||t==="delete_sections"||t==="structure_snapshot"}function mp(e,t,n){try{let r=String(e||"").trim(),o=String(t||"").trim(),i=Number(n);if(!r||!o||!Number.isFinite(i)||i<=0)return;let s="ttree_outline_section_seq_v1",a=window.localStorage.getItem(s)||"",c=a?JSON.parse(a):{},l=c&&typeof c=="object"?c:{},d=(l[r]&&typeof l[r]=="object"?l[r]:{})||{};if((Number(d[o]||0)||0)>=i)return;d[o]=i,l[r]=d,window.localStorage.setItem(s,JSON.stringify(l))}catch{}}function hp(e){let t=[],n=(i,s)=>{if(!Array.isArray(i))return;let a=0;for(let c of i){if(!c||typeof c!="object"||c.type!=="outlineSection")continue;let l=String(c?.attrs?.id||"").trim();if(!l)continue;t.push({sectionId:l,parentId:s||null,position:a,collapsed:!!c?.attrs?.collapsed}),a+=1;let m=(Array.isArray(c.content)?c.content:[]).find(b=>b&&typeof b=="object"&&b.type==="outlineChildren")||null,h=m&&Array.isArray(m.content)?m.content:[];n(h,l)}},r=e&&typeof e=="object"?e:null,o=r&&Array.isArray(r.content)?r.content:[];return n(o,null),t}function gp(e,t){try{let n=e&&typeof e=="object"?{...e}:null;if(!n||n.type!=="outlineHeading")return e;let r=String(t||"");if(!r)return e;let o=Array.isArray(n.content)?[...n.content]:[];return o.unshift({type:"text",text:r}),n.content=o,n}catch{return e}}function yp(e,t,n){let r=e&&typeof e=="object"?e:{type:"doc",content:[]};Array.isArray(r.content)||(r.content=[]);let o=String(t||"").trim(),i=a=>{for(let c=0;c<a.length;c+=1){let l=a[c];if(!l||typeof l!="object"||l.type!=="outlineSection")continue;let d=String(l?.attrs?.id||"").trim();if(o&&d===o)return a.splice(c+1,0,n),!0;let h=(Array.isArray(l.content)?l.content:[]).find(b=>b&&typeof b=="object"&&b.type==="outlineChildren")||null;if(h&&Array.isArray(h.content)&&i(h.content))return!0}return!1};return i(r.content)||r.content.push(n),r}function bp(){try{return window?.localStorage?.getItem?.("ttree_debug_offline_v1")==="1"}catch{return!1}}function Ql(...e){try{if(!bp())return;console.log("[offline][queue]",...e)}catch{}}function ed(){try{let e=window.localStorage.getItem(xi)||"";if(!e)return{changed:!1,removed:0};let t=JSON.parse(e);if(!t||typeof t!="object")return{changed:!1,removed:0};let n=Object.keys(t);if(!n.length)return{changed:!1,removed:0};let r=0;for(let o of n)o!=="inbox"&&(delete t[o],r+=1);return r?(window.localStorage.setItem(xi,JSON.stringify(t)),Ql("prune.queue",{removed:r}),{changed:!0,removed:r}):{changed:!1,removed:0}}catch(e){return Ql("prune.queue.error",{message:e?.message||String(e||"error")}),{changed:!1,removed:0}}}function ir(){try{window.dispatchEvent(new CustomEvent("offline-full-pull-status",{detail:{...Et}}))}catch{}}function wp(){return{...Et}}async function rn(e,t={}){let n=await fetch(e,{headers:{"Content-Type":"application/json",...t.headers||{}},credentials:"include",...t});if(!n.ok){let r=await n.json().catch(()=>({})),o=new Error(r.detail||"Request failed");throw o.status=n.status,o.details=r,o.path=e,o}return n.status===204?null:n.json()}function Zl(e){let t=Number(e?.status||0);return!t||t>=500||t===408||t===429||t===401||t===403}function Sp(e,t){let n=Number(e?.status||0);return n===404||n===410?!0:n>=400&&n<500&&n!==401&&n!==403&&n!==408&&n!==429?t?.type==="save_doc_json"||String(t?.type||"").startsWith("section_")||t?.type==="structure_snapshot"||t?.type==="delete_sections":!1}async function xp(){try{let e=await hn();return On(e).catch(()=>{}),Array.isArray(e)?e:[]}catch{return null}}function Ap(e,t){try{let n=new Set((Array.isArray(t)?t:[]).map(i=>String(i||"").trim()).filter(Boolean));if(!n.size)return e;let r=e&&typeof e=="object"?e:{type:"doc",content:[]},o=i=>{if(!Array.isArray(i))return[];let s=[];for(let a of i)if(!(!a||typeof a!="object")){if(a.type==="outlineSection"){let c=String(a?.attrs?.id||"").trim();if(c&&n.has(c))continue;let d=(Array.isArray(a.content)?a.content:[]).find(m=>m&&typeof m=="object"&&m.type==="outlineChildren")||null;d&&Array.isArray(d.content)&&(d.content=o(d.content))}s.push(a)}return s};return Array.isArray(r.content)?r.content=o(r.content):r.content=[],r.type=r.type||"doc",r}catch{return e}}async function Ip(e){if(e.type==="create_article"){let t=e.payload?.title||"\u041D\u043E\u0432\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F",n=e.payload?.id||e.articleId,r=e.payload?.parentId??null,o=await rn("/api/articles",{method:"POST",body:JSON.stringify({title:t,id:n,parentId:r})});await Lr(o);return}if(e.type==="save_doc_json"){let t=e.payload?.docJson||null;if(!t||typeof t!="object")return;let n=await rn(`/api/articles/${encodeURIComponent(e.articleId)}/doc-json/save`,{method:"PUT",body:JSON.stringify({docJson:t,createVersionIfStaleHours:12})}),r=n?.updatedAt||null;await an(e.articleId,t,r);try{at("sync.flush.save_doc_json.ok",{articleId:e.articleId,opId:e.id,updatedAt:r,docHash:Dt(t)})}catch{}try{let o=Array.isArray(n?.changedBlockIds)?n.changedBlockIds:[],i=Array.isArray(n?.removedBlockIds)?n.removedBlockIds:[];if(i.length&&await Ko(i),o.length){let s=await rn(`/api/articles/${encodeURIComponent(e.articleId)}/embeddings?ids=${encodeURIComponent(o.join(","))}`);await ns(e.articleId,s?.embeddings||[])}}catch{}return}if(e.type==="section_upsert_content"){let t=e.payload?.sectionId||null,n=e.payload?.headingJson||null,r=e.payload?.bodyJson||null,o=e.payload?.seq||null;if(!t||!n||!r||!o)return;let i=await rn(`/api/articles/${encodeURIComponent(e.articleId)}/sections/upsert-content`,{method:"PUT",body:JSON.stringify({opId:e.payload?.opId||e.id,sectionId:t,headingJson:n,bodyJson:r,seq:o,createVersionIfStaleHours:12})});try{if(i?.updatedAt){let s=await Un(e.articleId).catch(()=>null),a=s?.docJson&&typeof s.docJson=="object"?s.docJson:null;if(a){let c=pp(a,t,n,r);await an(e.articleId,c,i.updatedAt)}}try{at("sync.flush.section_upsert_content.ok",{articleId:e.articleId,opId:e.id,sectionId:t,updatedAt:i?.updatedAt||null})}catch{}}catch{}return}if(e.type==="structure_snapshot"){let t=e.payload?.nodes||null;if(!Array.isArray(t)||!t.length)return;let n=await rn(`/api/articles/${encodeURIComponent(e.articleId)}/structure/snapshot`,{method:"PUT",body:JSON.stringify({opId:e.payload?.opId||e.id,nodes:t})});try{if(n?.updatedAt){let r=await Un(e.articleId).catch(()=>null),o=r?.docJson&&typeof r.docJson=="object"?r.docJson:null;if(o){let i=fp(o,t);await an(e.articleId,i,n.updatedAt)}}try{at("sync.flush.structure_snapshot.ok",{articleId:e.articleId,opId:e.id,updatedAt:n?.updatedAt||null,nodesCount:Array.isArray(t)?t.length:null})}catch{}}catch{}return}if(e.type==="delete_sections"){let t=Array.isArray(e.payload?.sectionIds)?e.payload.sectionIds:[];if(!t.length)return;let n=await hc(e.articleId,t,{opId:e.payload?.opId||e.id});try{let r=n?.updatedAt||null,o=await Un(e.articleId).catch(()=>null),i=o?.docJson&&typeof o.docJson=="object"?o.docJson:null;if(i&&r){let a=Ap(i,t);await an(e.articleId,a,r)}let s=Array.isArray(n?.removedBlockIds)?n.removedBlockIds:[];s.length&&await Ko(s),at("sync.flush.delete_sections.ok",{articleId:e.articleId,opId:e.id,updatedAt:r||null,sectionIdsCount:t.length,removedCount:s.length})}catch{}return}if(e.type==="move_article_position"){let t=e.payload?.direction||null;if(!t)return;await rn(`/api/articles/${encodeURIComponent(e.articleId)}/move`,{method:"POST",body:JSON.stringify({direction:t})});return}if(e.type==="indent_article"){await rn(`/api/articles/${encodeURIComponent(e.articleId)}/indent`,{method:"POST",body:JSON.stringify({})});return}if(e.type==="outdent_article"){await rn(`/api/articles/${encodeURIComponent(e.articleId)}/outdent`,{method:"POST",body:JSON.stringify({})});return}if(e.type==="move_article_tree"){await rn(`/api/articles/${encodeURIComponent(e.articleId)}/move-tree`,{method:"POST",body:JSON.stringify(e.payload||{})});return}}async function kp(e){try{if(!e||!e.articleId||!(e.type==="save_doc_json"||e.type==="section_upsert_content"||e.type==="structure_snapshot"||e.type==="delete_sections"))return;let n=e.payload?.clientQueuedAt??null;if(typeof n!="number"||!Number.isFinite(n)||(await fr(500)||[]).some(i=>i&&i.articleId===e.articleId&&(i.type==="save_doc_json"||i.type==="section_upsert_content"||i.type==="structure_snapshot")&&(i.payload?.clientQueuedAt??null)===n))return;lp(e.articleId,n)}catch{}}async function Ep(e,t){let n=String(e||"").trim();if(n)for(let r of t||[])try{let o=String(r?.sectionId||"").trim(),i=r?.headingJson||null,s=r?.bodyJson||null;if(!o||!i||!s)continue;let a=globalThis.crypto?.randomUUID?.()||`conflict-${Date.now()}-${Math.random().toString(16).slice(2)}`,c=await Un(n).catch(()=>null),l=c?.docJson&&typeof c.docJson=="object"?c.docJson:null,d=gp(i,"\u041A\u043E\u043D\u0444\u043B\u0438\u043A\u0442\u043D\u0430\u044F \u043A\u043E\u043F\u0438\u044F: "),h=yp(l||{type:"doc",content:[]},o,{type:"outlineSection",attrs:{id:a,collapsed:!1,isConflictCopy:!0},content:[d||{type:"outlineHeading",content:[]},s||{type:"outlineBody",content:[{type:"paragraph"}]},{type:"outlineChildren",content:[]}]});await an(n,h,c?.updatedAt||null).catch(()=>{}),mp(n,a,1);let b=Date.now();await jt("section_upsert_content",{articleId:n,payload:{sectionId:a,headingJson:d,bodyJson:s,seq:1,clientQueuedAt:b},coalesceKey:`content:${n}:${a}`}).catch(()=>{});let w=hp(h);w.length&&await jt("structure_snapshot",{articleId:n,payload:{nodes:w,clientQueuedAt:b},coalesceKey:`structure:${n}`}).catch(()=>{});try{window.dispatchEvent(new CustomEvent("outline-sync-conflict",{detail:{articleId:n,sectionId:o,conflictCopySectionId:a}}))}catch{}}catch{}}async function vp(e,t){let n=String(e||"").trim();if(!n)return;let r=Date.now(),o=Number(Gl.get(n)||0)||0;if(o&&r-o<dp)return;Gl.set(n,r);let i=async()=>{let p=await fr(200),f=[],S=[],A=[];for(let C of p||[])!C||String(C.articleId||"")!==n||(C.type==="delete_sections"?f.push(C):C.type==="section_upsert_content"?S.push(C):C.type==="structure_snapshot"&&A.push(C));return{deleteOps:f,upsertOps:S,structureOps:A}},s=0,a=[],c=[],l=[];try{({deleteOps:a,upsertOps:c,structureOps:l}=await i())}catch{a=[],c=[],l=[];for(let p of t||[])!p||String(p.articleId||"")!==n||(p.type==="delete_sections"?a.push(p):p.type==="section_upsert_content"?c.push(p):p.type==="structure_snapshot"&&l.push(p))}let d=new Set;for(let p of a){let f=Array.isArray(p.payload?.sectionIds)?p.payload.sectionIds:[];for(let S of f){let A=String(S||"").trim();A&&d.add(A)}}if(d.size&&c.length)for(let p of c)try{let f=String(p.payload?.sectionId||"").trim();f&&d.has(f)&&await Gn(p.id)}catch{}let m=a.map(p=>{let f=Array.isArray(p.payload?.sectionIds)?p.payload.sectionIds:[];return{opId:p.payload?.opId||p.id,sectionIds:f.filter(Boolean).map(S=>String(S)),_outboxId:p.id}}).filter(p=>p.sectionIds.length),h=c.map(p=>{let f=String(p.payload?.sectionId||"").trim();return!f||d.has(f)?null:{opId:p.payload?.opId||p.id,sectionId:f,headingJson:p.payload?.headingJson||null,bodyJson:p.payload?.bodyJson||null,seq:p.payload?.seq||null,clientQueuedAt:p.payload?.clientQueuedAt??null,_outboxId:p.id}}).filter(Boolean),b=async()=>{let p=a.map(q=>{let R=Array.isArray(q.payload?.sectionIds)?q.payload.sectionIds:[];return{opId:q.payload?.opId||q.id,sectionIds:R.filter(Boolean).map(Q=>String(Q)),_outboxId:q.id}}).filter(q=>q.sectionIds.length),f=c.map(q=>{let R=String(q.payload?.sectionId||"").trim();return!R||d.has(R)?null:{opId:q.payload?.opId||q.id,sectionId:R,headingJson:q.payload?.headingJson||null,bodyJson:q.payload?.bodyJson||null,seq:q.payload?.seq||null,clientQueuedAt:q.payload?.clientQueuedAt??null,_outboxId:q.id}}).filter(Boolean),S=new Map;for(let q of p)S.set(String(q.opId),q._outboxId);for(let q of f)S.set(String(q.opId),q._outboxId);if(!p.length&&!f.length)return!1;try{at("sync.flush.outline_compact.start",{articleId:n,deletesCount:p.length,upsertsCount:f.length})}catch{}let A=await rn(`/api/articles/${encodeURIComponent(n)}/sync/compact`,{method:"PUT",body:JSON.stringify({deletes:p.map(({opId:q,sectionIds:R})=>({opId:q,sectionIds:R})),upserts:f.map(({opId:q,sectionId:R,headingJson:Q,bodyJson:Y,seq:re})=>({opId:q,sectionId:R,headingJson:Q,bodyJson:Y,seq:re}))})}),C=A?.updatedAt||null;C&&await es(n,C).catch(()=>{});try{at("sync.flush.outline_compact.ok",{articleId:n,updatedAt:C||null,deleteAcks:Array.isArray(A?.deleteAcks)?A.deleteAcks.length:null,upsertAcks:Array.isArray(A?.upsertAcks)?A.upsertAcks.length:null})}catch{}let T=Array.isArray(A?.deleteAcks)?A.deleteAcks:[];for(let q of T){let R=String(q?.opId||"").trim();if(!R)continue;let Q=S.get(R)||R;await Gn(Q).catch(()=>{});try{let Y=Array.isArray(q?.removedBlockIds)?q.removedBlockIds:[];Y.length&&await Ko(Y)}catch{}}let O=[],$=Array.isArray(A?.upsertAcks)?A.upsertAcks:[];for(let q of $){let R=String(q?.opId||"").trim(),Q=String(q?.sectionId||"").trim();if(!R||!Q)continue;let Y=S.get(R)||R,re=String(q?.result||"").trim();if(re==="ok"||re==="duplicate")await Gn(Y).catch(()=>{});else if(re==="conflict"){await Gn(Y).catch(()=>{});let Ae=f.find(Ee=>String(Ee.opId)===R)||null;Ae&&O.push({sectionId:Q,headingJson:Ae.headingJson,bodyJson:Ae.bodyJson})}}return O.length&&await Ep(n,O),!0};for(;s<2&&(s+=1,!!await b());)try{({deleteOps:a,upsertOps:c,structureOps:l}=await i())}catch{break}let w=null;try{({deleteOps:a,upsertOps:c,structureOps:l}=await i())}catch{}if(!a.length&&!c.length&&(w=l.length?l[l.length-1]:null),w){try{let f=Number(Xl.get(n)||0)||0,S=Date.now();if(f&&S-f<up)return}catch{}let p=w.payload?.nodes||null;if(Array.isArray(p)&&p.length){try{at("sync.flush.structure_snapshot.start",{articleId:n,opId:w.id,nodesCount:p.length})}catch{}let f=await rn(`/api/articles/${encodeURIComponent(n)}/structure/snapshot`,{method:"PUT",body:JSON.stringify({opId:w.payload?.opId||w.id,nodes:p})}),S=f?.updatedAt||null;S&&await es(n,S).catch(()=>{}),Number.isFinite(Number(f?.newStructureRev))?await ts(n,Number(f.newStructureRev)):Number.isFinite(Number(f?.currentStructureRev))&&await ts(n,Number(f.currentStructureRev));try{at("sync.flush.structure_snapshot.done",{articleId:n,opId:w.id,status:String(f?.status||""),updatedAt:S||null,newStructureRev:Number.isFinite(Number(f?.newStructureRev))?Number(f.newStructureRev):null,currentStructureRev:Number.isFinite(Number(f?.currentStructureRev))?Number(f.currentStructureRev):null})}catch{}let A=String(f?.status||"");if(A==="ok"||A==="duplicate"){await Gn(w.id).catch(()=>{});try{Xl.set(n,Date.now())}catch{}}}}try{(await fr(200)||[]).some(S=>oa(S)&&String(S.articleId||"")===n)||(await nc(n).catch(()=>{}),at("sync.flush.localDraft.cleared",{articleId:n}))}catch{}}async function Ur(){if(ta)return null;if(!navigator.onLine)return!1;ta=!0;try{let e=await fr(200),t=new Set,n=[];for(let o of e||[]){if(!oa(o))continue;let i=String(o.articleId||"").trim();!i||t.has(i)||(t.add(i),n.push(i))}for(let o of n)try{await vp(o,e)}catch(i){if(Zl(i))break}let r=await fr(50);for(let o of r)if(!oa(o))try{await Ip(o),await Gn(o.id);try{if(o.type==="section_upsert_content"&&String(o.articleId||"")==="inbox"){let i=String(o.payload?.sectionId||"").trim();i&&xl(i)}}catch{}await kp(o)}catch(i){let s=Number(i?.status||0)||null,a=s?`${s}: ${i?.message||"error"}`:i?.message||String(i||"error");if(await Wa(o.id,a),Sp(i,o)){try{console.warn("[offline][outbox] drop op",{opId:o.id,type:o.type,articleId:o.articleId,status:s,message:i?.message||null})}catch{}try{await Gn(o.id)}catch{}continue}if(Zl(i))break;break}}finally{ta=!1}try{let e=await fr(1);return Array.isArray(e)&&e.length>0}catch{return!0}}function Ao(){yr||(yr=window.setInterval(async()=>{try{await Ur()===!1&&(window.clearInterval(yr),yr=null,ed())}catch{}},15e3))}function ra(){yr&&(window.clearInterval(yr),yr=null)}function Cp(){if(!Wl){Wl=!0,ed();try{Ka()}catch{}window.addEventListener("online",()=>{Ur().then(e=>{e?Ao():ra()}).catch(()=>{})}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&Ur().then(e=>{e?Ao():ra()}).catch(()=>{})}),window.addEventListener("offline-outbox-changed",()=>{Ur().then(e=>{e?Ao():ra()}).catch(()=>{Ao()})}),Ur().then(e=>{e&&Ao()}).catch(()=>{})}}function Tp(e={}){let t=!!(e&&e.force);na||Yl&&!t||(Yl=!0,na=!0,Et={running:!0,processed:0,total:0,errors:0,phase:"index",lastError:null,startedAt:new Date().toISOString(),finishedAt:null},ir(),(async()=>{try{if(!navigator.onLine){Et={...Et,running:!1,phase:"error",lastError:"offline",finishedAt:new Date().toISOString()},ir();return}let n=new Map;try{let o=await ec();n=new Map((o||[]).map(i=>[i.id,i]))}catch{}let r=[];try{Array.isArray(e?.initialIndex)?r=e.initialIndex:r=await rn("/api/articles")||[],On(r).catch(()=>{})}catch(o){Et={...Et,running:!1,phase:"error",lastError:o?.message||String(o||"error"),finishedAt:new Date().toISOString()},ir();return}Et={...Et,phase:"articles",total:Array.isArray(r)?r.length:0},ir();for(let o of r||[]){try{let i=o.updatedAt||null,s=n.get(o.id);if(i&&s?.updatedAt===i&&s?.hasDocJson){try{let c=await Un(o.id),l=c?.docJson&&typeof c.docJson=="object"?c.docJson:null;l&&Br(o.id,l).catch(()=>{})}catch{}continue}let a=await rn(`/api/articles/${encodeURIComponent(o.id)}`);await Lr(a);try{let c=await rn(`/api/articles/${encodeURIComponent(o.id)}/embeddings`);await ns(o.id,c?.embeddings||[])}catch{}}catch{Et={...Et,errors:Number(Et.errors||0)+1}}Et={...Et,processed:Number(Et.processed||0)+1},ir(),await new Promise(i=>setTimeout(i,120))}try{Et={...Et,phase:"inbox"},ir();let o=await rn("/api/articles/inbox?include_history=0");await Lr(o)}catch{Et={...Et,errors:Number(Et.errors||0)+1},ir()}Va().catch(()=>{}),Et={...Et,running:!1,phase:"done",finishedAt:new Date().toISOString()},ir()}finally{na=!1}})().catch(()=>{}))}var xi,Wl,ta,Yl,na,yr,dp,Gl,up,Xl,Et,sa=Je(()=>{Pr();Nr();rs();Yi();en();qs();to();xi="ttree_outline_autosave_queue_docjson_v1";Wl=!1,ta=!1,Yl=!1,na=!1,yr=null,dp=2e3,Gl=new Map,up=3e3,Xl=new Map;Et={running:!1,processed:0,total:0,errors:0,phase:"idle",lastError:null,startedAt:null,finishedAt:null}});var ci={};Po(ci,{closeOutlineEditor:()=>Kd,enterOutlineSectionEditMode:()=>Om,flushOutlineAutosave:()=>Fm,getOutlineActiveSectionId:()=>Bm,getOutlineActiveSectionSnapshot:()=>Nm,insertNewOutlineSectionAtEnd:()=>Dm,insertNewOutlineSectionAtStart:()=>Rm,insertOutlineSectionFromPlainTextAtStart:()=>Hm,insertOutlineSectionFromSectionFragmentsAtEnd:()=>_m,openOutlineEditor:()=>$m,openPublicOutlineViewer:()=>zm,restoreOutlineSectionFromBlockHtml:()=>Lm,restoreOutlineSectionFromSectionFragments:()=>Pm,revealOutlineSection:()=>qd});function Ci(e,t){let n=null,r=String(t||"").trim();return!e||!r?null:(e.descendants((o,i)=>{if(n!==null)return!1;o?.type?.name==="image"&&String(o.attrs?.uploadToken||"")===r&&(n=i)}),n)}function Lp(e){let t=String(e||"").trim();if(!t)return;let n=kr.get(t)||null;if(n){kr.delete(t);try{URL.revokeObjectURL(n)}catch{}}}function xd(e,t=3e4){let n=String(e||"").trim();if(n){try{let r=Co.get(n)||null;r&&clearTimeout(r)}catch{}try{let r=setTimeout(()=>{try{Co.delete(n)}catch{}Lp(n)},Math.max(0,Number(t)||0));Co.set(n,r)}catch{}}}function Pp(e){try{if(!e||typeof e!="object")return e;let t=typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e)),n=r=>{if(!r||typeof r!="object")return;if(r.type==="image"&&r.attrs&&typeof r.attrs=="object"){let i=String(r.attrs.uploadToken||"").trim(),s=String(r.attrs.src||"");i&&s.startsWith("blob:")&&(r.attrs={...r.attrs,src:`${Mi}${i}`})}let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(t),t}catch{return e}}function rd(e){try{if(!e||typeof e!="object")return e;let t=typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e)),n=r=>{if(!r||typeof r!="object")return;if(r.type==="image"&&r.attrs&&typeof r.attrs=="object"){let i=String(r.attrs.uploadToken||"").trim(),s=String(r.attrs.src||"");i&&s.startsWith("blob:")&&(r.attrs={...r.attrs,src:`${Mi}${i}`})}let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(t),t}catch{return e}}async function _p(e){try{if(!ae||ae.isDestroyed)return;let t=String(e||"").trim();if(!t)return;let n=await Zs({articleId:t,limit:200}).catch(()=>[]);if(!n.length)return;let r=new Map;for(let c of n){let l=String(c?.token||"").trim();l&&(c?.kind&&String(c.kind)!=="image"||c?.blob&&r.set(l,c.blob))}if(!r.size)return;let{state:o,view:i}=ae,s=o.tr,a=!1;o.doc.descendants((c,l)=>{if(c?.type?.name!=="image")return;let d=String(c.attrs?.uploadToken||"").trim(),m=String(c.attrs?.src||""),h=m.startsWith(Mi)?m.slice(Mi.length).trim():"",b=d||h;if(!b)return;let w=r.get(b);if(!w)return;let p=kr.get(b)||null;if(!p)try{p=URL.createObjectURL(w),kr.set(b,p)}catch{p=null}if(!p)return;let f={...c.attrs,src:p,uploadToken:b};s=s.setNodeMarkup(l,void 0,f),a=!0}),a&&(s=s.setMeta(ue,!0),i.dispatch(s))}catch{}}async function Ad(e){try{if(!navigator.onLine||!ae||ae.isDestroyed)return!1;let t=String(e||"").trim();if(!t)return!1;let n=await Zs({articleId:t,limit:50}).catch(()=>[]);if(!n.length)return!1;let r=!1;for(let o of n){let i=String(o?.token||"").trim();if(!i||o?.kind&&String(o.kind)!=="image")continue;let s=o?.blob||null;if(s)try{let a=s instanceof File?s:new File([s],o?.fileName||"image",{type:o?.mime||s.type||"application/octet-stream"}),c=await ro(a),l=String(c?.url||"").trim();if(!l)throw new Error("Upload failed");try{let{state:d,view:m}=ae,h=Ci(d.doc,i);if(typeof h=="number"){let b=d.doc.nodeAt(h);if(b?.type?.name==="image"){let w={...b.attrs,src:l,uploadToken:null,title:String(b.attrs?.title||"").replace(/\s*\(ошибка загрузки\)\s*$/i,"").trim()},p=d.tr.setNodeMarkup(h,void 0,w);p=p.setMeta(ue,!0),m.dispatch(p)}}}catch{}xd(i),await Xs(i).catch(()=>{}),r=!0}catch(a){let c=a?.message||String(a||"error");await Qs(i,c).catch(()=>{})}}if(r)try{Gt({delayMs:350})}catch{}return r}catch{return!1}}function od(){try{let e=window?.localStorage?.getItem?.(ha)||"";if(!e)return null;let t=JSON.parse(e);return!t||typeof t!="object"||!Array.isArray(t.sections)?null:{mode:t.mode==="cut"?"cut":"copy",sourceArticleId:typeof t.sourceArticleId=="string"?t.sourceArticleId:null,createdAt:typeof t.createdAt=="string"?t.createdAt:null,sections:t.sections}}catch{return null}}function la(e){try{if(!e){window?.localStorage?.removeItem?.(ha);return}window?.localStorage?.setItem?.(ha,JSON.stringify(e))}catch{}}function ko(e){Vn=!!e,Vn||(lr=new Set);try{J?.outlineEditor&&J.outlineEditor.classList.toggle("outline-select-mode",Vn)}catch{}try{Id()}catch{}}function Dp(e){let t=String(e||"").trim();if(t){lr.has(t)?lr.delete(t):lr.add(t);try{Id()}catch{}}}function Id(){if(!J?.outlineEditor)return;J.outlineEditor.querySelectorAll(".outline-heading[data-section-id] .outline-heading__select").forEach(t=>{let r=t.closest(".outline-heading")?.getAttribute?.("data-section-id")||"",o=r&&lr.has(r);t.setAttribute("aria-checked",o?"true":"false"),t.style.display=Vn?"inline-flex":"none"})}function Op(e,t){let n=t instanceof Set?t:new Set,r=[];if(!e||!n.size)return r;let o=(i,s)=>{let a=String(i?.attrs?.id||"").trim(),c=a&&n.has(a);if(c&&!s){r.push({id:a,node:i});return}let l=i?.childCount>=3?i.child(2):null;if(l)try{l.forEach(d=>{d?.type?.name==="outlineSection"&&o(d,s||c)})}catch{}};try{e.forEach(i=>{i?.type?.name==="outlineSection"&&o(i,!1)})}catch{}return r}function kd(e){return JSON.parse(JSON.stringify(e))}function Rp(e,t){let n=kd(e),r=o=>{if(!o||typeof o!="object")return;if(o.type==="outlineSection"){let s=t();o.attrs&&typeof o.attrs=="object"?o.attrs.id=s:o.attrs={id:s,collapsed:!!o.attrs?.collapsed}}let i=Array.isArray(o.content)?o.content:[];for(let s of i)r(s)};return r(n),n}async function Hp(e){let t=String(e||"");if(t){try{if(navigator?.clipboard?.writeText){await navigator.clipboard.writeText(t);return}}catch{}try{let n=document.createElement("textarea");n.value=t,n.setAttribute("readonly","true"),n.style.position="fixed",n.style.left="-9999px",n.style.top="0",document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n)}catch{}}}function Ed(e,{baseLevel:t=2,depth:n=0}={}){let r=e;if(!r||r.type?.name!=="outlineSection")return"";let o="",i="";try{let c=r.child(0);o=String(c?.textContent||"").trim()}catch{o=""}try{let c=r.child(1);i=c?String(c.textBetween(0,c.content.size,`
`)).trimEnd():""}catch{i=""}let s=Math.min(6,Math.max(1,Number(t)+Number(n||0))),a=[];o&&a.push(`${"#".repeat(s)} ${o}`),i&&a.push(i);try{let c=r.child(2);if(c){let l=[];c.forEach(d=>{if(d?.type?.name!=="outlineSection")return;let m=Ed(d,{baseLevel:t,depth:n+1});m&&l.push(m)}),l.length&&a.push(l.join(`

`))}}catch{}return a.filter(Boolean).join(`

`).trim()}function vd(e,t){try{let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return 1;let o=window.localStorage.getItem(id)||"",i=o?JSON.parse(o):{},s=i&&typeof i=="object"?i:{},a=(s[n]&&typeof s[n]=="object"?s[n]:{})||{},l=(Number(a[r]||0)||0)+1;return a[r]=l,s[n]=a,window.localStorage.setItem(id,JSON.stringify(s)),l}catch{return Date.now()}}function Cd(e,t){try{let n=JSON.stringify({headingJson:e,bodyJson:t});return globalThis.TextEncoder?new TextEncoder().encode(n).length:n.length*2}catch{return 0}}function jr(e){try{let t=String(e||"").trim();if(!t)return;gn.add(t);let n=At||u.articleId||null;if(!n||u.article?.encrypted||da)return;da=setTimeout(()=>{da=null;try{if(!gn.size)return;let r=Array.from(gn);gn.clear();let o=Date.now();jt("delete_sections",{articleId:n,payload:{sectionIds:r,clientQueuedAt:o},coalesceKey:`delete:${n}`})}catch{}},0)}catch{}}function Mo(e){let t=[],n=o=>{try{if(!o||o.type?.name!=="outlineSection")return null;for(let i=0;i<o.childCount;i+=1){let s=o.child(i);if(s?.type?.name==="outlineChildren")return s}return null}catch{return null}},r=(o,i)=>{try{if(!o)return;let s=0;o.forEach(a=>{if(!a||a.type?.name!=="outlineSection")return;let c=String(a.attrs?.id||"").trim();if(!c)return;t.push({sectionId:c,parentId:i||null,position:s,collapsed:!!a.attrs?.collapsed}),s+=1;let l=n(a);l&&r(l,c)})}catch{}};try{if(!e)return[];r(e,null)}catch{return[]}return t}function sd(e){try{return Mo(e).map(n=>`${n.parentId||""}|${n.position}|${n.sectionId}|${n.collapsed?1:0}`).join(`
`)}catch{return""}}function Jr(e){let t=[];try{if(!e)return t;e.descendants((n,r)=>{n?.type?.name==="outlineSection"&&t.push(r)})}catch{}return t}function ga(e,t){try{if(!e||e.isDestroyed)return!1;let n=!!t;return e.commands.command(({state:r,dispatch:o})=>{let i=Jr(r.doc);if(!i.length)return!1;let s=r.tr;for(let a of i){let c=s.doc.nodeAt(a);!c||c.type?.name!=="outlineSection"||!!c.attrs?.collapsed!==n&&(s=s.setNodeMarkup(a,void 0,{...c.attrs,collapsed:n}))}s=s.setMeta(ue,!0);try{n&&Te&&(Te.getState(r)||{}).editingSectionId&&(s=s.setMeta(Te,{type:"exit"}))}catch{}try{if(n&&TextSelection){let a=xt(r.doc,r.selection.$from),c=typeof a=="number"?a:i[0],l=s.doc.nodeAt(c);if(l?.type?.name==="outlineSection"){let d=l.child(0),h=c+1+d.nodeSize-1;s=s.setSelection(TextSelection.near(s.doc.resolve(h),-1))}}}catch{}return o(s.scrollIntoView()),!0})}catch{return!1}}function $p({articleId:e,editor:t}={}){try{let n=String(e||"").trim();if(!n||!t)return;Ln=!0;try{if((Te?.getState?.(t.state)||null)?.editingSectionId){Ot&&(clearTimeout(Ot),Ot=null);return}}catch{}Ot&&clearTimeout(Ot),Ot=setTimeout(()=>{Ot=null;try{if(!Ln)return;let r=t.state?.doc,o=Mo(r);if(!o.length)return;try{let i=null;try{i=o.filter(s=>s&&(s.parentId==null||s.parentId==="")&&Number(s.position)>=0).sort((s,a)=>Number(s.position)-Number(a.position)).slice(0,3).map(s=>String(s.sectionId||""))}catch{i=null}at("outline.enqueue.structure_snapshot",{articleId:n,nodesCount:o.length,rootFirst:i})}catch{}jt("structure_snapshot",{articleId:n,payload:{nodes:o},coalesceKey:`structure:${n}`}),Ln=!1}catch{}},Np)}catch{}}async function xa({articleId:e,doc:t,sectionId:n,reason:r}){let o=String(e||"").trim(),i=String(n||"").trim();if(!o||!i||!t)return!1;let s=ct(t,i),a=typeof s=="number"?t.nodeAt(s):null;if(!a||a.type?.name!=="outlineSection")return!1;try{if(!xr(t,i))return!1}catch{return!1}let c=a.child(0),l=a.child(1),d=c?.toJSON?c.toJSON():null,m=l?.toJSON?l.toJSON():null;if(!d||!m)return!1;try{d=rd(d),m=rd(m)}catch{}let h=Cd(d,m);if(h>Li){let p=Date.now();return(!aa||p-aa>5e3)&&(aa=p,Ce(`\u0411\u043B\u043E\u043A \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 (${Math.ceil(h/1024)} KB). \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C: ${Math.ceil(Li/1024)} KB. \u0420\u0430\u0437\u0431\u0435\u0439\u0442\u0435 \u0431\u043B\u043E\u043A \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E.`)),!1}let b=Date.now(),w=vd(o,i);try{at("outline.enqueue.section_upsert_content",{articleId:o,sectionId:i,seq:w,bytes:h,reason:String(r||"")})}catch{}await jt("section_upsert_content",{articleId:o,payload:{sectionId:i,headingJson:d,bodyJson:m,seq:w,clientQueuedAt:b},coalesceKey:`content:${o}:${i}`}).catch(()=>{});try{if(Ln){let p=Mo(t);if(p.length){let f=null;try{f=p.filter(S=>S&&(S.parentId==null||S.parentId==="")&&Number(S.position)>=0).sort((S,A)=>Number(S.position)-Number(A.position)).slice(0,3).map(S=>String(S.sectionId||""))}catch{f=null}try{at("outline.enqueue.structure_snapshot",{articleId:o,nodesCount:p.length,reason:"after_section_upsert",rootFirst:f})}catch{}jt("structure_snapshot",{articleId:o,payload:{nodes:p},coalesceKey:`structure:${o}`})}Ln=!1,Ot&&(clearTimeout(Ot),Ot=null)}}catch{}try{Er.set(i,Hi(a)),vr.delete(i)}catch{}try{Promise.resolve().then(()=>(sa(),ia)).then(p=>p.flushOutboxOnce?.()).catch(()=>{})}catch{}return!0}function Fp(e){try{if(!e||e.isDestroyed)return;let t=Te?.getState?.(e.state)||null,n=String(t?.editingSectionId||"").trim();if(!n)return;let r=At||u.articleId||null;if(!r)return;fa=n,Sr&&clearTimeout(Sr),Sr=setTimeout(()=>{Sr=null;try{if(!ae||ae.isDestroyed)return;let o=Te?.getState?.(ae.state)||null,i=String(o?.editingSectionId||"").trim();if(!i||i!==fa)return;xa({articleId:r,doc:ae.state.doc,sectionId:i,reason:"edit_heartbeat"})}catch{}},Mp)}catch{}}function ya(){try{return window?.localStorage?.getItem?.(zp)==="1"}catch{return!1}}function un(...e){ya()}function wr(){try{return window?.localStorage?.getItem?.(Up)==="1"}catch{return!1}}function Wr(e,t={}){wr()}function Kp(){try{return window?.localStorage?.getItem?.(qp)==="1"}catch{return!1}}function Mt(e,t={}){Kp()}function Bi(e){let t=String(e||"").replace(/\s+/g," ").trim().toLowerCase();return t?t.length>60?t.slice(0,60):t:null}function Eo(e){return String(e||"").replace(/\s+/g," ").trim().toLowerCase()}function Vp(e,t="tag"){let n=new Map,r=new Map,o=new Map,i=new Map;return e?(e.descendants((s,a)=>{if(s?.type?.name!=="outlineSection")return;let c=String(s.attrs?.id||"");c&&i.set(c,a);let l=new Set,d=m=>{m?.descendants?.(h=>{if(h?.type?.name!==t)return;let b=Bi(h.attrs?.label||h.textContent||"");if(!b)return;let w=Eo(h.attrs?.key||b);w&&(n.set(w,(n.get(w)||0)+1),r.set(w,w),l.add(w))})};try{d(s.child(0)),d(s.child(1))}catch{}if(c)for(let m of l)o.has(m)||o.set(m,new Set),o.get(m).add(c);return!1}),{counts:n,labelByKey:r,sectionIdsByKey:o,sectionPosById:i}):{counts:n,labelByKey:r,sectionIdsByKey:o,sectionPosById:i}}function Td(){let e=J?.outlineTagsBar;if(!e)return;let t=Array.from(Jn.counts.entries()).map(([n,r])=>({key:n,label:Jn.labelByKey.get(n)||n,count:r})).filter(n=>n.key&&n.count>0).sort((n,r)=>r.count!==n.count?r.count-n.count:n.label.localeCompare(r.label));if(!t.length){e.innerHTML="",e.classList.add("hidden");return}e.classList.remove("hidden"),e.innerHTML=t.map(n=>{let r=cr&&cr===n.key?"true":"false",o=Bo(n.label);return`<button type="button" class="outline-tag-pill" data-tag-key="${Bo(n.key)}" aria-pressed="${r}">${o} <span class="outline-tag-pill__count">(${n.count})</span></button>`}).join("")}function Bd(){if(ae){if(Jn=Vp(ae.state.doc,"tag"),cr&&!Jn.counts.has(cr)){cr=null;try{_i?.(null)}catch{}}Td()}}function jp(e){let t=String(e||"");if(!t||!ae)return;let n=Jn.sectionIdsByKey.get(t);if(!n||!n.size)return;let r=new Set;for(let s of n){let a=Jn.sectionPosById.get(s);if(typeof a=="number"){r.add(a);try{let c=ae.state.doc.resolve(Math.min(ae.state.doc.content.size,a+1));for(let l=c.depth;l>0;l-=1)c.node(l)?.type?.name==="outlineSection"&&r.add(c.before(l))}catch{}}}let o=ae.state.tr,i=!1;for(let s of r){let a=o.doc.nodeAt(s);!a||a.type?.name!=="outlineSection"||a.attrs?.collapsed&&(o=o.setNodeMarkup(s,void 0,{...a.attrs,collapsed:!1}),i=!0)}i&&(o=o.setMeta(ue,!0),ae.view.dispatch(o))}function Jp({setActiveTagKey:e}){let t=J?.outlineTagsBar;if(!t)return()=>{};let n=r=>{let o=r.target?.closest?.("[data-tag-key]");if(!o)return;let i=String(o.getAttribute("data-tag-key")||"");if(!i)return;let s=cr===i?null:i;cr=s;try{e(s)}catch{}s&&jp(s),Td()};return t.addEventListener("click",n),()=>t.removeEventListener("click",n)}function fn(e){let t=String(e||"").trim();if(!t.includes("|"))return null;let n=t;n.startsWith("|")&&(n=n.slice(1)),n.endsWith("|")&&(n=n.slice(0,-1));let r=n.split("|").map(o=>o.trim());return r.length<2||r.every(o=>!o)?null:r}function Di(e){let t=String(e||"").trim();return t?/^:?-{3,}:?$/.test(t):!1}function Ar(e){let t=(Array.isArray(e)?e:[]).map(i=>String(i||"").replace(/\r/g,"").trimEnd()).filter(i=>i.length>0);if(t.length<2)return null;let n=fn(t[0]),r=fn(t[1]);if(!n||!r||n.length!==r.length||!r.every(Di))return null;let o=[];for(let i=2;i<t.length;i+=1){let s=fn(t[i]);if(!s||s.length!==n.length)return null;o.push(s)}return{header:n,rows:o}}function Ir(e){let t=(Array.isArray(e)?e:[]).map(s=>String(s||"").replace(/\r/g,"").trimEnd()).filter(s=>s.length>0);if(t.length<1)return null;let n=fn(t[0]);if(!n)return null;let r=n.length;if(r<2)return null;let o=[n];for(let s=1;s<t.length;s+=1){let a=fn(t[s]);if(!a||a.length!==r)break;if(s===1&&a.every(Di))return null;o.push(a)}return o.flat().filter(s=>String(s||"").trim().length>0).length<2?null:{rows:o}}function Aa(e){let t=String(e||"").replace(/\r/g,"").split(`
`).map(n=>String(n||"").trimEnd());for(;t.length&&!t[0].trim();)t.shift();for(;t.length&&!t[t.length-1].trim();)t.pop();return t}function sr(e,t){if(!e||!t)return null;let{header:n,rows:r,withHeader:o}=t,i=e.nodes.table,s=e.nodes.tableRow,a=e.nodes.tableCell,c=e.nodes.tableHeader,l=e.nodes.paragraph;if(!i||!s||!a||!c||!l||typeof e.text!="function")return null;let d=w=>l.create({},w?[e.text(String(w))]:[]),m=(w,p)=>w.map(f=>(p?c:a).create({},[d(f)])),h=(w,p)=>s.create({},m(w,p)),b=[];return o&&Array.isArray(n)&&n.length&&b.push(h(n,!0)),(Array.isArray(r)?r:[]).forEach(w=>b.push(h(w,!1))),b.length?i.create({},b):null}function Wp(e,t){try{let n=e?.selection,r=n?.$from;if(!n?.empty||!r)return Xe("table.merge.skip",{reason:"no-cursor"}),!1;if(r.parent?.type?.name!=="paragraph")return!1;if(r.parentOffset!==0)return Xe("table.merge.skip",{reason:"not-at-paragraph-start"}),!1;let o=null,i=null,s=null;for(let te=r.depth;te>0;te-=1){let ye=r.node(te)?.type?.name;if(!s&&(ye==="tableCell"||ye==="tableHeader")?s=te:!i&&ye==="tableRow"?i=te:!o&&ye==="table"&&(o=te),o&&i&&s)break}if(o==null||i==null||s==null)return Xe("table.merge.skip",{reason:"not-in-table"}),!1;let a=r.depth===s+1,c=r.index(o),l=r.index(i),d=r.index(s);if(Xe("table.merge.check",{parent:r.parent?.type?.name||null,parentOffset:r.parentOffset,tableDepth:o,rowDepth:i,cellDepth:s,isDirectParagraphInCell:a,rowIndex:c,colIndex:l,childIndexInCell:d}),!a)return Xe("table.merge.skip",{reason:"paragraph-not-direct-child-of-cell"}),!1;if(c!==0||l!==0||d!==0)return Xe("table.merge.skip",{reason:"not-in-first-cell",rowIndex:c,colIndex:l,childIndexInCell:d}),!1;let m=r.before(o),h=e.doc.nodeAt(m);if(!h||h.type?.name!=="table")return Xe("table.merge.skip",{reason:"no-current-table",tablePos:m}),!1;let b=e.doc.resolve(m),w=b.index(),p=b.parent;if(!p||w<=0)return Xe("table.merge.skip",{reason:"no-prev-sibling",idx:w,parent:p?.type?.name||null}),!1;let f=null,S=w-1;for(;S>=0;){let te=p.child(S);if(te?.type?.name==="paragraph"&&!String(te.textContent||"").trim()){S-=1;continue}f=te;break}if(!f||f.type?.name!=="table")return Xe("table.merge.skip",{reason:"no-prev-table"}),!1;let A=f.childCount?f.child(0):null,C=h.childCount?h.child(0):null;if(!A||!C)return Xe("table.merge.skip",{reason:"missing-rows"}),!1;if(A.childCount!==C.childCount)return Xe("table.merge.skip",{reason:"different-columns",prevCols:A.childCount,curCols:C.childCount}),!1;let T=A.childCount,O=(te,ye)=>{try{return te?.type?.name==="tableRow"&&te.childCount===ye}catch{return!1}};for(let te=0;te<f.childCount;te+=1){let ye=f.child(te);if(!O(ye,T))return Xe("table.merge.skip",{reason:"prev-row-mismatch",rowIndex:te,colsExpected:T,colsGot:ye?.childCount??null}),!1}for(let te=0;te<h.childCount;te+=1){let ye=h.child(te);if(!O(ye,T))return Xe("table.merge.skip",{reason:"cur-row-mismatch",rowIndex:te,colsExpected:T,colsGot:ye?.childCount??null}),!1}let $=m;for(let te=w-1;te>=S;te-=1)$-=p.child(te).nodeSize;let q=f.childCount,R=e.doc.type.schema,Q=$+f.nodeSize,Y=e.tr;m>Q&&(Y=Y.delete(Q,m));let re=Q;Y=Y.delete(re,re+h.nodeSize);let Ae=Y.doc.nodeAt($);if(!Ae||Ae.type?.name!=="table")return Xe("table.merge.skip",{reason:"prev-after-missing",prevStart:$,prevAfterType:Ae?.type?.name||null}),!1;Xe("table.merge.plan",{idx:w,prevIdx:S,prevStart:$,prevEnd:Q,tablePos:m,tablePos2:re,cols:T,prevRowCount:q,curRowCount:h.childCount});try{let te=Ae.content.append(h.content),ye=R.nodes.table.create(Ae.attrs,te,Ae.marks);Y=Y.replaceWith($,$+Ae.nodeSize,ye)}catch(te){return Xe("table.merge.error",{message:String(te?.message||te||""),stack:String(te?.stack||"")}),!1}let Ee=Y.doc.nodeAt($);Xe("table.merge.afterReplace",{mergedType:Ee?.type?.name||null,mergedRows:Ee?.type?.name==="table"?Ee.childCount:null});try{let te=$e?.pmStateMod?.TextSelection||$e?.pm?.state?.TextSelection||null;if(Ee&&Ee.type?.name==="table"){let ye=Math.min(q,Math.max(0,Ee.childCount-1));if(Ee.child(ye)?.childCount){let pt=(()=>{let Qt=$+1;for(let sn=0;sn<ye;sn+=1)Qt+=Ee.child(sn).nodeSize;return Qt+=1,Qt})(),vt=Math.min(Y.doc.content.size,pt+2);te&&(Y=Y.setSelection(te.near(Y.doc.resolve(vt),1)))}}}catch(te){Xe("table.merge.selection.error",{message:String(te?.message||te||""),stack:String(te?.stack||"")})}Y=Y.setMeta(ue,!0);try{t(Y.scrollIntoView())}catch(te){return Xe("table.merge.dispatch.error",{message:String(te?.message||te||""),stack:String(te?.stack||"")}),!1}return!0}catch(n){try{Xe("table.merge.exception",{message:String(n?.message||n||""),stack:String(n?.stack||"")})}catch{}return!1}}function Yp(e,t,n,r){try{let o=(ye,je={})=>{},i=(ye={})=>{};if(!n)return!1;if(!r)return o("no-TextSelection"),!1;let s=e?.selection;if(!s?.empty)return o("selection-not-empty"),!1;let a=s.$from||null;if(!a)return o("no-$from"),!1;i({from:s.from,parent:a.parent?.type?.name||null,parentOffset:a.parentOffset??null});let c=ct(e.doc,n);if(typeof c!="number")return o("section-not-found"),!1;let l=e.doc.nodeAt(c);if(!l||l.type?.name!=="outlineSection")return o("not-outlineSection",{found:l?.type?.name||null}),!1;let d=l.child(0),m=l.child(1);if(!d||d.type?.name!=="outlineHeading")return o("missing-heading",{found:d?.type?.name||null}),!1;if(!m||m.type?.name!=="outlineBody")return o("missing-body",{found:m?.type?.name||null}),!1;let h=String(d.textContent||"").replace(/\u00a0/g," "),b=!!h.trim(),w=/\s$/.test(h),p=null;for(let ye=a.depth;ye>=0;ye-=1)if(a.node(ye)?.type?.name==="outlineBody"){p=ye;break}if(p==null)return o("not-in-outlineBody",{parent:a.parent?.type?.name||null}),!1;if(a.index(p)!==0)return o("not-first-body-child",{index:a.index(p)}),!1;if(a.parent?.type?.name!=="paragraph")return o("parent-not-paragraph",{parent:a.parent?.type?.name||null}),!1;if((a.parentOffset??null)!==0)return o("not-at-paragraph-start",{parentOffset:a.parentOffset??null}),!1;let f=c+1,S=s.from,A=a.parent,C=0,T=null;for(let ye=0;ye<A.childCount;ye+=1){let je=A.child(ye);if(je.type?.name==="hardBreak"){T=C;break}C+=je.nodeSize}let O=S+(T??A.content.size);if(O<=S)return o("empty-first-line"),!1;let $=e.doc.slice(S,O);if(!$?.content||$.content.size<=0)return o("empty-slice"),!1;let q=T==null?O:O+1,R=f+1,Q=f+d.nodeSize-1,Y=e.tr;b&&!w&&(Y=Y.insertText(" ",Q),Y=Y.setMeta(ue,!0));let re=Y.mapping.map(Q,1),Ae=re;Y=Y.insert(re,$.content);let Ee=Y.mapping.map(S,1),te=Y.mapping.map(q,-1);Y=Y.delete(Ee,te);try{Y=Y.setSelection(r.create(Y.doc,Ae))}catch{}return Y=Y.setMeta(ue,!0),t(Y.scrollIntoView()),!0}catch(o){return!1}}function Gp(e,t){try{if(!e?.doc||!t)return null;let n=ct(e.doc,t);if(typeof n!="number")return null;let r=e.doc.nodeAt(n);if(!r)return null;let o=r.child(0),i=r.child(1);if(!i||i.type?.name!=="outlineBody")return null;let a=n+1+o.nodeSize+1,c=[],l=0,d=0;for(;d<i.childCount;){let h=i.child(d),b=a+l;if(h.type?.name!=="paragraph"){l+=h.nodeSize,d+=1;continue}let w=ar(h).trim();if(w.includes(`
`)&&w.includes("|")){let Y=Aa(w),re=Ar(Y),Ae=re?null:Ir(Y),Ee=re?{header:re.header,rows:re.rows,withHeader:!0}:Ae?{header:null,rows:Ae.rows,withHeader:!1}:null,te=null;if(Ee)try{te=sr(e.schema,Ee)}catch(ye){un("convert: buildTableNode error (single)",{message:String(ye?.message||ye||""),stack:String(ye?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),te=null}if(te){let ye=b,je=b+h.nodeSize;c.push({from:ye,to:je,tableNode:te}),un("convert: single-paragraph table",{sectionId:t,from:ye,to:je,lines:Y}),l+=h.nodeSize,d+=1;continue}}let p=fn(w);if(!p||d+1>=i.childCount){if(p){let Y=[w],re=l+h.nodeSize,Ae=d+1;for(;Ae<i.childCount;){let je=i.child(Ae);if(je.type?.name!=="paragraph")break;let pt=ar(je).trim();if(!pt)break;let vt=fn(pt);if(!vt||vt.length!==p.length)break;Y.push(pt),re+=je.nodeSize,Ae+=1}let Ee=Ir(Y),te=Ee?{header:null,rows:Ee.rows,withHeader:!1}:null,ye=null;if(te)try{ye=sr(e.schema,te)}catch(je){un("convert: buildTableNode error (rows-only)",{message:String(je?.message||je||""),stack:String(je?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),ye=null}if(ye){c.push({from:b,to:a+re,tableNode:ye}),un("convert: rows-only table",{sectionId:t,from:b,to:a+re,lines:Y}),l=re,d=Ae;continue}}l+=h.nodeSize,d+=1;continue}let f=i.child(d+1);if(f.type?.name!=="paragraph"){l+=h.nodeSize,d+=1;continue}let S=ar(f).trim(),A=fn(S);if(!A||A.length!==p.length||!A.every(Di)){l+=h.nodeSize,d+=1;continue}let C=[w,S],T=l+h.nodeSize+f.nodeSize,O=d+2;for(;O<i.childCount;){let Y=i.child(O);if(Y.type?.name!=="paragraph")break;let re=ar(Y).trim();if(!re)break;let Ae=fn(re);if(!Ae||Ae.length!==p.length)break;C.push(re),T+=Y.nodeSize,O+=1}let $=Ar(C),q=$?null:Ir(C),R=$?{header:$.header,rows:$.rows,withHeader:!0}:q?{header:null,rows:q.rows,withHeader:!1}:null,Q=null;if(R)try{Q=sr(e.schema,R)}catch(Y){un("convert: buildTableNode error (multi)",{message:String(Y?.message||Y||""),stack:String(Y?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),Q=null}if(!Q){l+=h.nodeSize,d+=1;continue}c.push({from:b,to:a+T,tableNode:Q}),un("convert: multi-paragraph table",{sectionId:t,from:b,to:a+T,lines:C}),l=T,d=O}if(!c.length)return null;c.sort((h,b)=>b.from-h.from);let m=e.tr;for(let h of c)m=m.replaceRangeWith(h.from,h.to,h.tableNode);return m=m.setMeta(ue,!0),m}catch{return null}}function ar(e){if(!e)return"";let t="";return e.descendants(n=>{n.isText?t+=n.text||"":n.type?.name==="hardBreak"&&(t+=`
`)}),t}function cd(e){try{if(!e||e.type!=="paragraph")return"";let t=[],n=r=>{if(!r)return;if(r.type==="text"){t.push(String(r.text||""));return}if(r.type==="hardBreak"){t.push(`
`);return}let o=Array.isArray(r.content)?r.content:[];for(let i of o)n(i)};return n(e),t.join("")}catch{return""}}function Xp(e){if(!e)return null;let{header:t,rows:n}=e;if(!Array.isArray(t)||t.length===0)return null;let r=s=>({type:"paragraph",content:String(s||"").length?[{type:"text",text:String(s||"")}]:[]}),o={type:"tableRow",content:t.map(s=>({type:"tableHeader",content:[r(s)]}))},i=(Array.isArray(n)?n:[]).map(s=>({type:"tableRow",content:s.map(a=>({type:"tableCell",content:[r(a)]}))}));return{type:"table",content:[o,...i]}}function Qp(e){if(!e)return!1;try{let{doc:t,schema:n}=e.state,r=[];if(t.descendants((i,s)=>{if(i.type?.name!=="outlineBody")return;let a=s+1,c=0,l=0;for(;l<i.childCount;){let d=i.child(l),m=a+c;if(d.type?.name!=="paragraph"){c+=d.nodeSize,l+=1;continue}let h=ar(d).trim();if(h.includes(`
`)&&h.includes("|")){let q=Aa(h),R=Ar(q),Q=R?null:Ir(q),Y=R?{header:R.header,rows:R.rows,withHeader:!0}:Q?{header:null,rows:Q.rows,withHeader:!1}:null,re=Y?sr(n,Y):null;if(re){r.push({from:m,to:m+d.nodeSize,tableNode:re}),c+=d.nodeSize,l+=1;continue}}let b=fn(h);if(!b){c+=d.nodeSize,l+=1;continue}if(l+1>=i.childCount){let q=Ir([h]),R=q?{header:null,rows:q.rows,withHeader:!1}:null,Q=R?sr(n,R):null;Q&&r.push({from:m,to:m+d.nodeSize,tableNode:Q}),c+=d.nodeSize,l+=1;continue}let w=i.child(l+1);if(w.type?.name!=="paragraph"){c+=d.nodeSize,l+=1;continue}let p=ar(w).trim(),f=fn(p);if(!f||f.length!==b.length||!f.every(Di)){let q=[h],R=c+d.nodeSize,Q=l+1;for(;Q<i.childCount;){let Ee=i.child(Q);if(Ee.type?.name!=="paragraph")break;let te=ar(Ee).trim();if(!te)break;let ye=fn(te);if(!ye||ye.length!==b.length)break;q.push(te),R+=Ee.nodeSize,Q+=1}let Y=Ir(q),re=Y?{header:null,rows:Y.rows,withHeader:!1}:null,Ae=re?sr(n,re):null;if(Ae){r.push({from:m,to:a+R,tableNode:Ae}),c=R,l=Q;continue}c+=d.nodeSize,l+=1;continue}let S=[h,p],A=c+d.nodeSize+w.nodeSize,C=l+2;for(;C<i.childCount;){let q=i.child(C);if(q.type?.name!=="paragraph")break;let R=ar(q).trim();if(!R)break;let Q=fn(R);if(!Q||Q.length!==b.length)break;S.push(R),A+=q.nodeSize,C+=1}let T=Ar(S),O=T?{header:T.header,rows:T.rows,withHeader:!0}:null,$=O?sr(n,O):null;if(!$){c+=d.nodeSize,l+=1;continue}r.push({from:m,to:a+A,tableNode:$}),c=A,l=C}}),!r.length)return!1;r.sort((i,s)=>s.from-i.from);let o=e.state.tr;for(let i of r)o=o.replaceRangeWith(i.from,i.to,i.tableNode);return o=o.setMeta(ue,!0),e.view.dispatch(o),!0}catch{return!1}}function Yr(){let e=Date.now();if(!(e-ad<900)){ad=e;try{Ce("\u0414\u043B\u044F \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Enter \u0438\u043B\u0438 \u0434\u0432\u043E\u0439\u043D\u043E\u0439 \u043A\u043B\u0438\u043A \u043C\u044B\u0448\u043A\u043E\u0439. Esc \u0434\u043B\u044F \u0432\u044B\u0445\u043E\u0434\u0430.")}catch{}}}function ba(e=""){let t=document.createElement("div");return t.innerHTML=e||"",(t.textContent||"").replace(/\u00a0/g," ").trim()}function Kn(e=""){return String(e||"").replace(/\u00a0/g," ").replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}function wa(e=""){let t=String(e||""),n=0;for(let r=0;r<t.length;r+=1)n=n*31+t.charCodeAt(r)>>>0;return String(n)}function Vr(e=""){return wa(String(e||"").slice(0,12e3))}function Kt(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`sec-${Date.now()}-${Math.random().toString(16).slice(2)}`}function Nd({loading:e=!1}={}){J.outlineEditor&&(J.outlineEditor.innerHTML=`
    <div class="outline-editor__body">
      <div class="outline-editor__content" id="outlineEditorContent"></div>
      <div class="outline-editor__loading ${e?"":"hidden"}">\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440\u2026</div>
    </div>
  `,td||(td=!0))}function Md(e){let t=String(e||"").trim();if(!t)return null;let n=t.match(/(-?\d+(?:\.\d+)?)%/);if(!n)return null;let r=Number.parseFloat(n[1]);return Number.isFinite(r)?r:null}function Pn(e){let t=Number(e);return Number.isFinite(t)?Math.max(0,Math.min(100,t)):0}function Ld(e){try{let t=e?.dataset?.ttPct||"",n=Number.parseFloat(String(t||""));if(Number.isFinite(n)&&n>0)return n;let r=Md(e?.style?.width||"");return r!=null&&r>0?r:null}catch{return null}}function Oi(e,t){try{let n=Pn(t);return e.dataset.ttPct=n.toFixed(4),e.style.width=`${n.toFixed(4)}%`,e.style.minWidth="",!0}catch{return!1}}function Pi(e,{insertIndex:t,newColPct:n=10}={}){try{let r=e?.view;if(!r)return!1;let o=Number(t);if(!Number.isFinite(o)||o<0)return!1;let i=r.domAtPos(r.state.selection.from),a=((i?.node&&i.node.nodeType===1?i.node:i?.node?.parentElement)||null)?.closest?.("table")||null;if(!a)return!1;let c=a.querySelector("colgroup");if(!c)return!1;let l=Array.from(c.querySelectorAll("col"));if(!l.length||o>=l.length)return!1;let d=100/l.length,m=l.map(T=>Ld(T)??d),h=Pn(n);m[o]=h;let b=o-1,w=b>=0?m.slice(0,b+1).reduce((T,O)=>T+O,0):0,p=o+1,f=Math.max(0,l.length-p),S=f>0?m.slice(p).reduce((T,O)=>T+O,0):0,A=100-w-h;if(A<0){let T=Math.max(0,o-1),O=Math.max(0,m[T]-1),$=Math.abs(A),q=Math.min(O,$);m[T]=Math.max(1,m[T]-q),A=100-m.slice(0,b+1).reduce((R,Q)=>R+Q,0)-h,A=Math.max(0,A)}if(f>0)if(S>0){let T=A/S;for(let O=p;O<l.length;O+=1)m[O]*=T}else{let T=A/f;for(let O=p;O<l.length;O+=1)m[O]=T}let C=m.reduce((T,O)=>T+O,0);if(C>0&&Math.abs(C-100)>.01){let T=100-C,O=l.length-1;m[O]=Pn(m[O]+T),C=m.reduce(($,q)=>$+q,0)}for(let T=0;T<l.length;T+=1)Oi(l[T],m[T]);try{a.style.width="100%",a.style.maxWidth="100%",a.style.tableLayout="fixed"}catch{}return!0}catch{return!1}}function Ni(e){try{if(!e)return!1;let t=e.querySelector("colgroup");if(!t)return!1;let n=Array.from(t.querySelectorAll("col"));if(!n.length)return!1;let r=e.getBoundingClientRect();if(!Number.isFinite(r.width)||r.width<=0)return!1;let o=e.querySelector("tbody tr");if(!o)return!1;let i=Array.from(o.children||[]).filter(c=>c&&c.nodeType===1);if(!i.length)return!1;let s=[];for(let c=0;c<n.length;c+=1){let l=i[c]||null;if(!l){s.push(0);continue}let d=l.getBoundingClientRect();s.push(Number.isFinite(d.width)?d.width:0)}let a=s.reduce((c,l)=>c+(Number.isFinite(l)?l:0),0);if(!(a>0))return!1;for(let c=0;c<n.length;c+=1){let l=Pn(s[c]/a*100);Oi(n[c],l)}return!0}catch{return!1}}function Yt(e){try{if(!e?.state?.selection)return null;let t=e.state.selection;try{let o=t?.$anchorCell?.pos,i=t?.$headCell?.pos,s=Number.isFinite(o)?o:Number.isFinite(i)?i:null;if(s!=null){let a=e.nodeDOM?.(s)||null;if(a&&a.nodeType===1)return a.closest?.("table")||null}}catch{}let n=e.domAtPos(t.from);return((n?.node&&n.node.nodeType===1?n.node:n?.node?.parentElement)||null)?.closest?.("table")||null}catch{return null}}function Zp(e){try{let t=e?.state?.selection||null,n=t?.$from||null;if(!n)return null;try{let s=t?.$anchorCell?.pos,a=t?.$headCell?.pos,c=Number.isFinite(s)?s:Number.isFinite(a)?a:null;if(c!=null){let l=e.nodeDOM?.(c)||null;if(l&&l.nodeType===1)return l}}catch{}let r=null;for(let s=n.depth;s>=0;s-=1){let a=n.node(s)?.type?.name;if(a==="tableCell"||a==="tableHeader"){r=s;break}}if(r!=null){let s=n.before(r),a=e.nodeDOM?.(s)||null;if(a&&a.nodeType===1)return a}let o=e.domAtPos(t.from);return((o?.node&&o.node.nodeType===1?o.node:o?.node?.parentElement)||null)?.closest?.("td,th")||null}catch{return null}}function Xr(e){try{if(!e)return null;let t=e.querySelector("colgroup");if(!t)return null;let n=Array.from(t.querySelectorAll("col"));if(!n.length)return null;let r=n.map(l=>Ld(l));if(r.some(l=>typeof l=="number"&&Number.isFinite(l)&&l>0)){let l=100/n.length;return r.map(d=>typeof d=="number"&&Number.isFinite(d)&&d>0?d:l)}let i=e.querySelector("tbody tr");if(!i)return null;let s=Array.from(i.children||[]).filter(l=>l&&l.nodeType===1);if(s.length<n.length)return null;let a=[];for(let l=0;l<n.length;l+=1){let d=s[l].getBoundingClientRect();a.push(Number.isFinite(d.width)?d.width:0)}let c=a.reduce((l,d)=>l+(Number.isFinite(d)?d:0),0);return c>0?a.map(l=>Pn(l/c*100)):null}catch{return null}}function Qr(e,t){try{if(!e)return!1;let n=e.querySelector("colgroup");if(!n)return!1;let r=Array.from(n.querySelectorAll("col"));if(!r.length||!Array.isArray(t)||t.length!==r.length)return!1;for(let o=0;o<r.length;o+=1)Oi(r[o],t[o]);try{e.style.width="100%",e.style.maxWidth="100%",e.style.tableLayout="fixed"}catch{}return!0}catch{return!1}}function Pd(e,t){try{let n=Array.isArray(e)?e.map(m=>Number(m)||0):null,r=Number(t);if(!n||!Number.isFinite(r)||r<0||r>=n.length||n.length<=1)return null;let o=Math.max(0,n[r]||0),i=n.slice(0,r),s=n.slice(r+1),a=s.reduce((m,h)=>m+(Number.isFinite(h)?h:0),0),c=s;if(s.length)if(a>0){let m=(a+o)/a;c=s.map(h=>Number.isFinite(h)?h*m:0)}else{let m=(o||0)/s.length;c=s.map(()=>m)}else i.length&&(i[i.length-1]=Math.max(1,(i[i.length-1]||0)+o));let l=[...i,...c].map(m=>Pn(m)),d=l.reduce((m,h)=>m+(Number.isFinite(h)?h:0),0);return d>0&&Math.abs(d-100)>.01&&(l[l.length-1]=Pn(l[l.length-1]+(100-d))),l}catch{return null}}function Rt(e){try{let t=gt?.TableMap||null,n=e?.selection||null,r=n?.$from||null,i=n?.$anchorCell||null||r||null;if(!i)return null;let s=null;for(let f=i.depth;f>=0;f-=1)if(i.node(f)?.type?.name==="table"){s=f;break}if(s==null)return null;let a=i.before(s),c=e.doc.nodeAt(a);if(!c||c.type?.name!=="table")return null;let l=null;for(let f=s+1;f<=i.depth;f+=1){let S=i.node(f)?.type?.name;if(S==="tableCell"||S==="tableHeader"){l=f;break}}if(l==null)return null;let d=i.before(l),m=t?.get?t.get(c):null;if(!m)return null;let h=d-a-1,b=m.findCell(h),w=Number(b?.left??0),p=Number(b?.top??0);return{tablePos:a,tableNode:c,map:m,colIndex:w,rowIndex:p}}catch{return null}}function ua(e){try{let t=[],n=e?.selection,r=e?.doc;if(!n||!r)return t;try{r.nodesBetween(n.from,n.to,(i,s)=>{let a=i?.type?.name;(a==="tableCell"||a==="tableHeader")&&t.push({node:i,pos:s})})}catch{}if(!t.length)try{let i=n.$from||null;if(i)for(let s=i.depth;s>=0;s-=1){let a=i.node(s)?.type?.name;if(a==="tableCell"||a==="tableHeader"){let c=i.before(s),l=r.nodeAt(c);l&&t.push({node:l,pos:c});break}}}catch{}let o=new Map;for(let i of t){let s=Number(i?.pos);Number.isFinite(s)&&(o.has(s)||o.set(s,i))}return Array.from(o.values()).sort((i,s)=>Number(i.pos)-Number(s.pos))}catch{return[]}}function em(e,t){try{let n=gt?.CellSelection||null,r=gt?.TableMap||null;return!n||!r?!1:e.commands.command(({state:o,dispatch:i})=>{let s=Rt(o);if(!s)return!1;let{tablePos:a,tableNode:c,map:l}=s,d=Number(t);if(!Number.isFinite(d)||d<0||d>=l.height)return!1;let m=l.positionAt(d,0,c),h=l.positionAt(d,l.width-1,c),b=a+1+m,w=a+1+h,p=null;try{typeof n.create=="function"&&(p=n.create(o.doc,b,w))}catch{p=null}if(!p)return!1;let f=o.tr.setSelection(p);return f=f.setMeta(ue,!0),i(f.scrollIntoView()),!0})}catch{return!1}}function tm(e,t,n){try{let r=gt?.CellSelection||null,o=gt?.TableMap||null;if(!r||!o)return!1;let i=Number(t),s=Number(n);return!Number.isFinite(i)||i<0||!Number.isFinite(s)||s<0?!1:e.commands.command(({state:a,dispatch:c})=>{let l=a?.doc?.nodeAt?.(i)||null;if(!l||l.type?.name!=="table")return!1;let d=o?.get?o.get(l):null;if(!d||s>=d.height)return!1;let m=d.positionAt(s,0,l),h=d.positionAt(s,d.width-1,l),b=i+1+m,w=i+1+h,p=null;try{typeof r.create=="function"&&(p=r.create(a.doc,b,w))}catch{p=null}if(!p)return!1;let f=a.tr.setSelection(p);return f=f.setMeta(ue,!0),c(f.scrollIntoView()),!0})}catch{return!1}}function nm(e,t){try{let n=gt?.CellSelection||null,r=gt?.TableMap||null;return!n||!r?!1:e.commands.command(({state:o,dispatch:i})=>{let s=Rt(o);if(!s)return!1;let{tablePos:a,tableNode:c,map:l}=s,d=Number(t);if(!Number.isFinite(d)||d<0||d>=l.width)return!1;let m=l.positionAt(0,d,c),h=l.positionAt(l.height-1,d,c),b=a+1+m,w=a+1+h,p=null;try{typeof n.create=="function"&&(p=n.create(o.doc,b,w))}catch{p=null}if(!p)return!1;let f=o.tr.setSelection(p);return f=f.setMeta(ue,!0),i(f.scrollIntoView()),!0})}catch{return!1}}function rm(e,t,n){try{let r=gt?.CellSelection||null,o=gt?.TableMap||null;if(!r||!o)return!1;let i=Number(t),s=Number(n);return!Number.isFinite(i)||i<0||!Number.isFinite(s)||s<0?!1:e.commands.command(({state:a,dispatch:c})=>{let l=a?.doc?.nodeAt?.(i)||null;if(!l||l.type?.name!=="table")return!1;let d=o?.get?o.get(l):null;if(!d||s>=d.width)return!1;let m=d.positionAt(0,s,l),h=d.positionAt(d.height-1,s,l),b=i+1+m,w=i+1+h,p=null;try{typeof r.create=="function"&&(p=r.create(a.doc,b,w))}catch{p=null}if(!p)return!1;let f=a.tr.setSelection(p);return f=f.setMeta(ue,!0),c(f.scrollIntoView()),!0})}catch{return!1}}function om({pmState:e,dispatch:t},{tablePos:n,rowIndex:r,attr:o,value:i}){try{let s=gt?.CellSelection||null,a=gt?.TableMap||null;if(!a)return!1;let c=Number(n),l=Number(r);if(!Number.isFinite(c)||c<0||!Number.isFinite(l)||l<0)return!1;let d=e?.doc?.nodeAt?.(c)||null;if(!d||d.type?.name!=="table")return!1;let m=a?.get?a.get(d):null;if(!m||l>=m.height)return!1;let h=e.tr;try{if(s?.create){let p=m.positionAt(l,0,d),f=m.positionAt(l,m.width-1,d),S=c+1+p,A=c+1+f;h=h.setSelection(s.create(h.doc,S,A))}}catch{}let b=new Set;for(let p=0;p<m.width;p+=1){let f=m.map[l*m.width+p];Number.isFinite(f)&&b.add(c+1+f)}if(!b.size)return!1;let w=!1;for(let p of b){let f=h.doc.nodeAt(p),S=f?.type?.name;if(S!=="tableCell"&&S!=="tableHeader")continue;let A={...f.attrs||{}};i==null||i===""?delete A[o]:A[o]=i,h=h.setNodeMarkup(p,void 0,A),w=!0}return w?(h=h.setMeta(ue,!0),t(h),!0):!1}catch{return!1}}function im({pmState:e,dispatch:t},{tablePos:n,colIndex:r,attr:o,value:i}){try{let s=gt?.CellSelection||null,a=gt?.TableMap||null;if(!a)return!1;let c=Number(n),l=Number(r);if(!Number.isFinite(c)||c<0||!Number.isFinite(l)||l<0)return!1;let d=e?.doc?.nodeAt?.(c)||null;if(!d||d.type?.name!=="table")return!1;let m=a?.get?a.get(d):null;if(!m||l>=m.width)return!1;let h=e.tr;try{if(s?.create){let p=m.positionAt(0,l,d),f=m.positionAt(m.height-1,l,d),S=c+1+p,A=c+1+f;h=h.setSelection(s.create(h.doc,S,A))}}catch{}let b=new Set;for(let p=0;p<m.height;p+=1){let f=m.map[p*m.width+l];Number.isFinite(f)&&b.add(c+1+f)}if(!b.size)return!1;let w=!1;for(let p of b){let f=h.doc.nodeAt(p),S=f?.type?.name;if(S!=="tableCell"&&S!=="tableHeader")continue;let A={...f.attrs||{}};i==null||i===""?delete A[o]:A[o]=i,h=h.setNodeMarkup(p,void 0,A),w=!0}return w?(h=h.setMeta(ue,!0),t(h),!0):!1}catch{return!1}}function Ri(e,t="\u0442\u0430\u0431\u043B\u0438\u0446\u044B"){try{let n=!1;return e.descendants(r=>{if(n)return!1;let o=r?.type?.name;if(o==="tableCell"||o==="tableHeader"){let i=Number(r.attrs?.colspan||1),s=Number(r.attrs?.rowspan||1);if(i!==1||s!==1)return n=!0,!1}return!0}),n?(Ce(`\u041F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 ${t} \u043F\u043E\u043A\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u0445 \u044F\u0447\u0435\u0435\u043A`),!1):!0}catch{return!1}}function _d(e,{kind:t,fromIndex:n,toIndex:r}){try{if(!e||!(gt?.TableMap||null))return!0;let i=e.map||null,s=e.tableNode||null;if(!i||!s)return!0;let a=Number(n),c=Number(r);if(!Number.isFinite(a)||!Number.isFinite(c))return!0;let l=t==="row"?Math.max(0,Math.min(i.height-1,a)):Math.max(0,Math.min(i.width-1,a)),d=t==="row"?Math.max(0,Math.min(i.height-1,c)):Math.max(0,Math.min(i.width-1,c)),m=new Set;for(let h of i.map){let b=Number(h);if(!Number.isFinite(b)||b<0||m.has(b))continue;m.add(b);let w=null;try{w=i.findCell(b)}catch{w=null}if(!w)continue;let p=Number(w.right)-Number(w.left),f=Number(w.bottom)-Number(w.top);if(p>1||f>1)if(t==="col"){let S=Number(w.left),A=Number(w.right);if(S<=l&&l<A||S<=d&&d<A)return!0}else{let S=Number(w.top),A=Number(w.bottom);if(S<=l&&l<A||S<=d&&d<A)return!0}}return!1}catch{return!0}}function ld(e,t){try{if(!e?.view)return!1;let n=Rt(e.state);if(!n)return!1;let{colIndex:r}=n,o=n.map?.width||0;if(!(o>0))return!1;let i=t<0?-1:1,s=r+i;return s>=0&&s<o?Dd(e,r,s):!1}catch{return!1}}function dd(e,t){try{if(!e?.view)return!1;let n=Rt(e.state);if(!n)return!1;let{rowIndex:r}=n,o=n.map?.height||0;if(!(o>0))return!1;let i=t<0?-1:1,s=r+i;return s>=0&&s<o?Od(e,r,s):!1}catch{return!1}}function Dd(e,t,n){try{if(!e?.view)return!1;let r=e.state,o=Rt(r);if(!o)return!1;let{tableNode:i}=o,s=o.map?.width||0;if(!(s>0))return!1;let a=Number(t),c=Number(n);if(!Number.isFinite(a)||!Number.isFinite(c)||a<0||a>=s||c<0||c>=s)return!1;if(a===c)return!0;if(_d(o,{kind:"col",fromIndex:a,toIndex:c}))return Ce("\u041D\u0435\u043B\u044C\u0437\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u043E\u043B\u0431\u0435\u0446: \u0438\u0441\u0445\u043E\u0434\u043D\u0430\u044F \u0438\u043B\u0438 \u0446\u0435\u043B\u0435\u0432\u0430\u044F \u043A\u043E\u043B\u043E\u043D\u043A\u0430 \u043F\u0435\u0440\u0435\u0441\u0435\u043A\u0430\u0435\u0442\u0441\u044F \u0441 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u043C\u0438 \u044F\u0447\u0435\u0439\u043A\u0430\u043C\u0438"),!1;let l=Yt(e.view),d=Xr(l),m=Array.isArray(d)&&d.length===s?(()=>{let p=d.slice(),f=p.splice(a,1)[0];return p.splice(c,0,f),p})():null,h=gt?.moveTableColumn||null;if(typeof h!="function")return!1;let b=h({from:a,to:c,select:!0});return e.commands.command(({state:p,dispatch:f})=>b(p,typeof f=="function"?A=>{try{A=A.setMeta(ue,!0)}catch{}f(A)}:void 0))?(m&&window.requestAnimationFrame(()=>{let p=Yt(e.view);Qr(p,m);try{(p?.closest?.(".tableWrapper")||null)?.dispatchEvent?.(new Event("scroll"))}catch{}}),!0):!1}catch{return!1}}function Od(e,t,n){try{if(!e?.view)return!1;let r=e.state,o=Rt(r);if(!o)return!1;let i=o.map?.height||0,s=o.map?.width||0;if(!(s>0&&i>0))return!1;let a=Number(t),c=Number(n);if(!Number.isFinite(a)||!Number.isFinite(c)||a<0||a>=i||c<0||c>=i)return!1;if(a===c)return!0;if(_d(o,{kind:"row",fromIndex:a,toIndex:c}))return Ce("\u041D\u0435\u043B\u044C\u0437\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u043E\u043A\u0443: \u0438\u0441\u0445\u043E\u0434\u043D\u0430\u044F \u0438\u043B\u0438 \u0446\u0435\u043B\u0435\u0432\u0430\u044F \u0441\u0442\u0440\u043E\u043A\u0430 \u043F\u0435\u0440\u0435\u0441\u0435\u043A\u0430\u0435\u0442\u0441\u044F \u0441 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u043C\u0438 \u044F\u0447\u0435\u0439\u043A\u0430\u043C\u0438"),!1;let l=Yt(e.view),d=Xr(l),m=gt?.moveTableRow||null;if(typeof m!="function")return!1;let h=m({from:a,to:c,select:!0});return e.commands.command(({state:w,dispatch:p})=>h(w,typeof p=="function"?S=>{try{S=S.setMeta(ue,!0)}catch{}p(S)}:void 0))?(Array.isArray(d)&&d.length===s&&window.requestAnimationFrame(()=>{let w=Yt(e.view);Qr(w,d)}),!0):!1}catch{return!1}}function Rd(e){try{if(!e)return"";let t=e.textContent||"";return String(t).replace(/\s+/g," ").trim()}catch{return""}}function sm(e){try{if(!e)return!1;for(let t=0;t<e.childCount;t+=1)if(e.child(t)?.type?.name==="tableHeader")return!0;return!1}catch{return!1}}function ud(e,{direction:t="asc"}={}){try{if(!e?.view)return!1;let n=e.state,r=Rt(n);if(!r)return!1;let{tablePos:o,tableNode:i,colIndex:s}=r,a=i.child(0)?.childCount||0,c=i.childCount||0;if(!(a>0&&c>1)||!(s>=0&&s<a)||!Ri(i,"\u0442\u0430\u0431\u043B\u0438\u0446\u044B"))return!1;let l=sm(i.child(0))?i.child(0):null,d=l?1:0,m=[];for(let f=d;f<c;f+=1){let S=i.child(f),A=S.child(s);m.push({rowIndex:f,rowNode:S,key:Rd(A)})}let h=t==="desc"?-1:1;m.sort((f,S)=>h*f.key.localeCompare(S.key,void 0,{sensitivity:"base",numeric:!0}));let b=[];l&&b.push(l);for(let f of m)b.push(f.rowNode);let w=i.type.create(i.attrs,b),p=n.tr.replaceWith(o,o+i.nodeSize,w);return p=p.setMeta(ue,!0),e.view.dispatch(p.scrollIntoView()),!0}catch{return!1}}function fd(e,{direction:t="asc"}={}){try{if(!e?.view)return!1;let n=e.state,r=Rt(n);if(!r)return!1;let{tablePos:o,tableNode:i,rowIndex:s}=r,a=i.child(0)?.childCount||0,c=i.childCount||0;if(!(a>1&&c>0)||!(s>=0&&s<c)||!Ri(i,"\u0442\u0430\u0431\u043B\u0438\u0446\u044B"))return!1;let l=i.child(s),d=[];for(let C=0;C<a;C+=1)d.push({colIndex:C,key:Rd(l.child(C))});let m=t==="desc"?-1:1;d.sort((C,T)=>m*C.key.localeCompare(T.key,void 0,{sensitivity:"base",numeric:!0}));let h=d.map(C=>C.colIndex),b=Yt(e.view),w=Xr(b),p=Array.isArray(w)&&w.length===a?h.map(C=>w[C]):null,f=[];for(let C=0;C<c;C+=1){let T=i.child(C),O=h.map($=>T.child($));f.push(T.type.create(T.attrs,O))}let S=i.type.create(i.attrs,f),A=n.tr.replaceWith(o,o+i.nodeSize,S);return A=A.setMeta(ue,!0),e.view.dispatch(A.scrollIntoView()),p&&window.requestAnimationFrame(()=>{let C=Yt(e.view);Qr(C,p)}),!0}catch{return!1}}function am(e){try{if(!e?.view)return!1;let t=e.state,n=Rt(t);if(!n)return!1;let{tablePos:r,tableNode:o,rowIndex:i,colIndex:s}=n,a=o.child(0)?.childCount||0,c=o.childCount||0;if(!(a>0&&c>0)||!(i>=0&&i<c)||!Ri(o,"\u0441\u0442\u0440\u043E\u043A"))return!1;let l=o.child(i),d=[];for(let b=0;b<c;b+=1)d.push(o.child(b)),b===i&&d.push(l.type.create(l.attrs,l.content,l.marks));let m=o.type.create(o.attrs,d),h=t.tr.replaceWith(r,r+o.nodeSize,m);h=h.setMeta(ue,!0);try{let b=$e?.pmStateMod?.TextSelection;if(b){let w=Math.min(m.childCount-1,i+1),p=Math.min(a-1,Math.max(0,s)),f=m.child(w),S=f.child(p),A=r+1;for(let $=0;$<w;$+=1)A+=m.child($).nodeSize;A+=1;for(let $=0;$<p;$+=1)A+=f.child($).nodeSize;let C=A,T=C+1,O=C+S.nodeSize-1;h=h.setSelection(b.near(h.doc.resolve(Math.min(O,T+1)),1))}}catch{}return e.view.dispatch(h.scrollIntoView()),!0}catch{return!1}}function cm(e){try{if(!e?.view)return!1;let t=e.state,n=Rt(t);if(!n)return!1;let{tablePos:r,tableNode:o,rowIndex:i,colIndex:s}=n,a=o.child(0)?.childCount||0,c=o.childCount||0;if(!(a>0&&c>0)||!(s>=0&&s<a)||!Ri(o,"\u0441\u0442\u043E\u043B\u0431\u0446\u043E\u0432"))return!1;let l=Yt(e.view),d=Xr(l),m=null;if(Array.isArray(d)&&d.length===a){let p=[...d],f=Math.max(0,Number(p[s]||0)),S=Pn(f/2);p[s]=S,p.splice(s+1,0,S);let A=p.reduce((C,T)=>C+(Number.isFinite(T)?T:0),0);A>0&&Math.abs(A-100)>.01&&(p[p.length-1]=Pn(p[p.length-1]+(100-A))),m=p}let h=[];for(let p=0;p<c;p+=1){let f=o.child(p),S=[];for(let A=0;A<a;A+=1){let C=f.child(A);S.push(C),A===s&&S.push(C.type.create(C.attrs,C.content,C.marks))}h.push(f.type.create(f.attrs,S))}let b=o.type.create(o.attrs,h),w=t.tr.replaceWith(r,r+o.nodeSize,b);w=w.setMeta(ue,!0);try{let p=$e?.pmStateMod?.TextSelection;if(p){let f=Math.min(b.childCount-1,Math.max(0,i)),S=Math.min(a,Math.max(0,s+1)),A=b.child(f),C=A.child(S),T=r+1;for(let R=0;R<f;R+=1)T+=b.child(R).nodeSize;T+=1;for(let R=0;R<S;R+=1)T+=A.child(R).nodeSize;let O=T,$=O+1,q=O+C.nodeSize-1;w=w.setSelection(p.near(w.doc.resolve(Math.min(q,$+1)),1))}}catch{}return e.view.dispatch(w.scrollIntoView()),Array.isArray(m)&&m.length===a+1?window.requestAnimationFrame(()=>{let p=Yt(e.view);Qr(p,m)}):window.requestAnimationFrame(()=>{let p=Yt(e.view);Ni(p)}),!0}catch{return!1}}function lm(e,t,n){try{if(!e?.view)return!1;let{state:r,view:o}=e,{selection:i}=r,s=i?.$from||null;if(!s)return!1;let a=n instanceof Set?n:new Set(Array.from(n||[])),c=null;for(let $=s.depth;$>0;$-=1)if(s.node($)?.type?.name==="paragraph"){let q=s.node($-1)?.type?.name||"";a.has(q)&&(c=$);break}if(c==null)return!1;let l=c-1,d=s.node(l),m=s.index(l);if(!d)return!1;let h=t<0?-1:1,b=m+h;if(!(b>=0&&b<d.childCount))return!1;let w=d.child(m),p=d.child(b);if(w?.type?.name!=="paragraph"||p?.type?.name!=="paragraph")return!1;let f=s.before(c),S=w.nodeSize,A=h<0?f-p.nodeSize:f+S,C=p.nodeSize,T=Math.max(0,i.from-s.start(c)),O=r.tr;if(h<0){O=O.delete(f,f+S),O=O.insert(A,w);let $=A,q=$+1,R=$+w.nodeSize-1,Q=q+T,Y=Math.min(Math.max(Q,q),R);try{let re=$e?.pmStateMod?.TextSelection;re&&(O=O.setSelection(re.near(O.doc.resolve(Y),1)))}catch{}}else{O=O.delete(f,f+S);let $=f+C;O=O.insert($,w);let q=$,R=q+1,Q=q+w.nodeSize-1,Y=R+T,re=Math.min(Math.max(Y,R),Q);try{let Ae=$e?.pmStateMod?.TextSelection;Ae&&(O=O.setSelection(Ae.near(O.doc.resolve(re),1)))}catch{}}return O=O.setMeta(ue,!0),o.dispatch(O.scrollIntoView()),!0}catch{return!1}}function pd(e,t){return lm(e,t,new Set(["outlineBody","tableCell","tableHeader"]))}function md(e,t){try{if(!e?.view)return!1;let{state:n,view:r}=e,{selection:o}=n,i=o?.$from||null;if(!i)return!1;let s=null;for(let T=i.depth;T>0;T-=1)if(i.node(T)?.type?.name==="listItem"){s=T;break}if(s==null)return!1;let a=s-1,c=i.node(a),l=c?.type?.name||"";if(l!=="bulletList"&&l!=="orderedList")return!1;let d=i.index(a),m=t<0?-1:1,h=d+m;if(!(h>=0&&h<c.childCount))return!1;let b=c.child(d),w=c.child(h);if(b?.type?.name!=="listItem"||w?.type?.name!=="listItem")return!1;let p=i.before(s),f=b.nodeSize,S=w.nodeSize,A=Math.max(0,o.from-i.start(s)),C=n.tr;if(m<0){let T=p-S;C=C.delete(p,p+f),C=C.insert(T,b);let O=T,$=O+1,q=O+b.nodeSize-1,R=$+A,Q=Math.min(Math.max(R,$),q);try{let Y=$e?.pmStateMod?.TextSelection;Y&&(C=C.setSelection(Y.near(C.doc.resolve(Q),1)))}catch{}}else{C=C.delete(p,p+f);let T=p+S;C=C.insert(T,b);let O=T,$=O+1,q=O+b.nodeSize-1,R=$+A,Q=Math.min(Math.max(R,$),q);try{let Y=$e?.pmStateMod?.TextSelection;Y&&(C=C.setSelection(Y.near(C.doc.resolve(Q),1)))}catch{}}return C=C.setMeta(ue,!0),r.dispatch(C.scrollIntoView()),!0}catch{return!1}}function dm(e){if(!J.outlineToolbar||!e)return;let t=J.outlineToolbar,n=null,r={undo:J.outlineUndoBtn,redo:J.outlineRedoBtn,deleteBtn:J.outlineDeleteBtn,moveUpBtn:J.outlineMoveUpBtn,moveDownBtn:J.outlineMoveDownBtn,outdentBtn:J.outlineOutdentBtn,indentBtn:J.outlineIndentBtn,newBelowBtn:J.outlineNewBelowBtn,blocksMenuBtn:t.querySelector("#outlineBlocksMenuBtn"),textMenuBtn:t.querySelector("#outlineTextMenuBtn"),listsMenuBtn:t.querySelector("#outlineListsMenuBtn"),tableMenuBtn:t.querySelector("#outlineTableMenuBtn")},o=new Set(Array.from(t.querySelectorAll(".outline-toolbar__dropdown-btn")));r.blocksMenuBtn&&o.add(r.blocksMenuBtn),r.textMenuBtn&&o.add(r.textMenuBtn),r.listsMenuBtn&&o.add(r.listsMenuBtn),r.tableMenuBtn&&o.add(r.tableMenuBtn);let i=Array.from(o),s=Array.from(t.querySelectorAll(".outline-toolbar__menu")),a=Array.from(t.querySelectorAll("[data-outline-action]")),c=Array.from(t.querySelectorAll("[data-outline-clipboard-action]")),l=(G,ie)=>{if(!G)return()=>{};let be=pe=>{pe.preventDefault(),pe.stopPropagation(),ie()};return G.addEventListener("click",be),()=>G.removeEventListener("click",be)},d=(G,ie)=>{G&&(G.classList.toggle("is-active",!!ie),G.setAttribute("aria-pressed",ie?"true":"false"))},m=()=>{for(let G of s)G.classList.add("hidden");for(let G of i)G.setAttribute("aria-expanded","false")},h=()=>{let G=od(),ie=!!(G&&Array.isArray(G.sections)&&G.sections.length);for(let be of c)be?.getAttribute?.("data-outline-clipboard-action")==="paste"&&be.toggleAttribute("disabled",!ie)},b=G=>{if(!G)return;let ie=G.getAttribute("aria-controls"),be=ie?t.querySelector(`#${ie}`)||document.getElementById(ie):null;if(!be)return!1;let pe=!be.classList.contains("hidden");return m(),pe||(ie==="outlineBlocksMenu"&&h(),be.classList.remove("hidden"),G.setAttribute("aria-expanded","true")),!0},w="ttree_outline_debug_dropdown_v1",p=()=>{try{return window?.localStorage?.getItem?.(w)==="1"}catch{return!1}},f=(G,ie={})=>{try{if(!p())return;console.log("[outline][dropdown]",G,ie)}catch{}},S=G=>{try{let ie=e.can().chain();return C()&&ie.command(({tr:be})=>(be.setMeta(ue,!0),!0)),G(ie),ie.run()}catch{return!1}},A=G=>{if(!G)return!1;try{let ie=e.chain().focus();if(C()&&ie.command(({tr:be})=>(be.setMeta(ue,!0),!0)),G==="collapseAllBlocks")return ga(e,!0);if(G==="expandAllBlocks")return ga(e,!1);if(G==="toggleBold")return ie.toggleBold().run();if(G==="toggleItalic")return ie.toggleItalic().run();if(G==="toggleStrike")return ie.toggleStrike().run();if(G==="toggleCodeBlock")return e.commands.command(({state:be,dispatch:pe})=>{let me=be.schema.nodes?.codeBlock||null;if(!me)return!1;let ve=be.selection,{from:ke,to:le}=ve;if(ke===le){let et=be.tr.setMeta(ue,!0);return pe(et),e.commands.toggleCodeBlock()}let Ne=ve.$from?.blockRange?.(ve.$to)||null;if(!Ne){let et=be.tr.setMeta(ue,!0);return pe(et),e.commands.toggleCodeBlock()}if(!Ne.parent?.canReplaceWith?.(Ne.startIndex,Ne.endIndex,me)){let et=be.tr.setMeta(ue,!0);return pe(et),e.commands.toggleCodeBlock()}let Fe=be.doc.textBetween(Ne.start,Ne.end,`
`,`
`),ze=String(Fe||"").replace(/\n+$/g,"").trimEnd();if(!ze)return!1;let Ze=me.create(null,be.schema.text(ze)),Ge=be.tr.replaceRangeWith(Ne.start,Ne.end,Ze);return Ge=Ge.setMeta(ue,!0),te&&(Ge=Ge.setSelection(te.near(Ge.doc.resolve(Ne.start+2),1))),pe(Ge.scrollIntoView()),!0});if(G==="toggleBlockquote")return ie.toggleBlockquote().run();if(G==="unsetLink")return ie.unsetLink().run();if(G==="toggleBulletList")return e.isActive("orderedList")?ie.toggleOrderedList().toggleBulletList().run():ie.toggleBulletList().run();if(G==="toggleOrderedList")return e.isActive("bulletList")?ie.toggleBulletList().toggleOrderedList().run():ie.toggleOrderedList().run();if(G==="unsetList")return e.isActive("bulletList")?ie.toggleBulletList().run():e.isActive("orderedList")?ie.toggleOrderedList().run():ie.liftListItem("listItem").run();if(G==="insertTable")return ie.insertTable({rows:2,cols:2,withHeaderRow:!1}).run();if(G==="toggleHeaderRow")return ie.toggleHeaderRow().run();if(G==="toggleHeaderColumn")return ie.toggleHeaderColumn().run();if(G==="addRowBefore")return ie.addRowBefore().run();if(G==="addRowAfter")return ie.addRowAfter().run();if(G==="deleteRow")return ie.deleteRow().run();if(G==="addColumnBefore"){let be=Rt(e.state),pe=be?Math.max(0,Number(be.colIndex||0)):0,me=ie.addColumnBefore().run();return me&&Pi(e,{insertIndex:pe,newColPct:10}),me}if(G==="addColumnAfter"){let be=Rt(e.state),pe=be?Math.max(0,Number(be.colIndex||0)+1):1,me=ie.addColumnAfter().run();return me&&Pi(e,{insertIndex:pe,newColPct:10}),me}if(G==="deleteColumn"){let be=Yt(e.view),pe=Xr(be),me=Rt(e.state),ve=me?Number(me.colIndex||0):null,ke=pe&&ve!=null?Pd(pe,ve):null,le=ie.deleteColumn().run();return le&&Array.isArray(ke)&&window.requestAnimationFrame(()=>{let Ne=Yt(e.view);Qr(Ne,ke)}),le}return G==="mergeCells"?ie.mergeCells().run():G==="splitCell"?ie.splitCell().run():G==="copyColumn"||G==="pasteColumnAfter"||G==="moveColumnRight"?!1:G==="cancelTable"?O():G==="deleteTable"?ie.deleteTable().run():!1}catch{return!1}},C=()=>{try{return!!(Te?.getState?.(e.state)||null)?.editingSectionId}catch{return!1}},T=()=>C()?!0:(Yr(),!1),O=()=>{if(!T())return!1;try{let{state:G,view:ie}=e,{schema:be,selection:pe}=G,me=pe?.$from;if(!me)return!1;let ve=null;for(let Z=me.depth;Z>=0;Z-=1)me.node(Z)?.type?.name==="table"&&(ve=Z);if(ve==null)return!1;let ke=null,le=null;for(let Z=ve+1;Z<=me.depth;Z+=1){let y=me.node(Z)?.type?.name;if(ke==null&&y==="tableRow"&&(ke=Z),le==null&&(y==="tableCell"||y==="tableHeader")&&(le=Z),ke!=null&&le!=null)break}let Ne=me.before(ve),Fe=G.doc.nodeAt(Ne);if(!Fe||Fe.type?.name!=="table")return!1;let ze=ke!=null?me.index(ve):null,Ze=ke!=null&&le!=null?me.index(ke):null,Ge=null;if(typeof ze=="number"&&typeof Ze=="number"){let Z=Fe.childCount&&Fe.child(0)?.childCount||0;Z>0&&(Ge=ze*Z+Ze)}let et=[],Ue=0,it=0;for(let Z=0;Z<Fe.childCount;Z+=1){let se=Fe.child(Z);for(let y=0;y<se.childCount;y+=1){let g=se.child(y),B=[];try{for(let M=0;M<(g?.content?.childCount||0);M+=1){let L=g.content.child(M);L&&B.push(L)}}catch{}B.length||B.push(be.nodes.paragraph.create(null,[])),Ge!=null&&Ue===Ge&&(it=et.length),et.push(...B),Ue+=1}}if(!et.length)return!1;let st=be.nodes.outlineBody?be.nodes.outlineBody.create({},et).content:be.nodes.doc.create({},et).content,tt=G.tr.replaceWith(Ne,Ne+Fe.nodeSize,st);tt=tt.setMeta(ue,!0);try{let Z=$e?.pmStateMod?.TextSelection;if(Z){let se=Ne;for(let L=0;L<it;L+=1)se+=et[L].nodeSize;let y=null,g=Math.min(tt.doc.content.size,se),B=Math.min(tt.doc.content.size,se+2e4);tt.doc.nodesBetween(g,B,(L,_)=>y!=null?!1:L?.isTextblock?(y=_+1,!1):!0);let M=y??Math.min(tt.doc.content.size,se+1);tt=tt.setSelection(Z.near(tt.doc.resolve(M),1))}}catch{}return ie.dispatch(tt.scrollIntoView()),ie.focus?.(),!0}catch{return!1}},$=()=>{if(!T())return!1;try{let{state:G,view:ie}=e,{selection:be}=G,pe=be?.$from;if(!pe)return!1;let me=null,ve=null,ke=null;for(let tt=pe.depth;tt>=0;tt-=1){let se=pe.node(tt)?.type?.name;if(ke==null&&(se==="tableCell"||se==="tableHeader")&&(ke=tt),ve==null&&se==="tableRow"&&(ve=tt),se==="table"){me=tt;break}}if(me==null||ve==null||ke==null)return!1;let le=pe.before(me),Ne=G.doc.nodeAt(le);if(!Ne||Ne.type?.name!=="table")return!1;let Fe=pe.index(me),ze=pe.index(ve),Ze=Ne.child(0)?.childCount||0;if(!(Ze>0)||!(ze>=0&&ze<Ze-1))return!1;let Ge=!1;if(Ne.descendants(tt=>{if(Ge)return!1;let Z=tt?.type?.name;if(Z==="tableCell"||Z==="tableHeader"){let se=Number(tt.attrs?.colspan||1),y=Number(tt.attrs?.rowspan||1);if(se!==1||y!==1)return Ge=!0,!1}return!0}),Ge)return Ce("\u041F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 \u0441\u0442\u043E\u043B\u0431\u0446\u043E\u0432 \u043F\u043E\u043A\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u0445 \u044F\u0447\u0435\u0435\u043A"),!1;let et=be.from-pe.start(ke),Ue=[];for(let tt=0;tt<Ne.childCount;tt+=1){let Z=Ne.child(tt);if(Z.type?.name!=="tableRow"||Z.childCount!==Ze)return!1;let se=[];for(let y=0;y<Ze;y+=1)y===ze?se.push(Z.child(y+1)):y===ze+1?se.push(Z.child(y-1)):se.push(Z.child(y));Ue.push(Z.type.create(Z.attrs,se))}let it=Ne.type.create(Ne.attrs,Ue),st=G.tr.replaceWith(le,le+Ne.nodeSize,it);st=st.setMeta(ue,!0);try{let tt=$e?.pmStateMod?.TextSelection;if(tt){let Z=Math.min(it.childCount-1,Math.max(0,Fe)),se=ze+1,y=it.child(Z),g=y.child(se),B=le+1;for(let N=0;N<Z;N+=1)B+=it.child(N).nodeSize;B+=1;for(let N=0;N<se;N+=1)B+=y.child(N).nodeSize;let M=B,L=M+1,_=M+g.nodeSize-1,P=L+Math.max(0,et),H=Math.min(Math.max(P,L),_);st=st.setSelection(tt.near(st.doc.resolve(H),1))}}catch{}return ie.dispatch(st.scrollIntoView()),ie.focus?.(),!0}catch{return!1}},q=(G,ie,be={})=>{let pe=String(G||"").trim();if(!pe)return!1;let me=String(ie||"").trim()||pe,{from:ve,to:ke,empty:le}=e.state.selection,Ne={href:pe,...be},Fe=e.chain().focus();return C()&&Fe.command(({tr:ze})=>(ze.setMeta(ue,!0),!0)),!le&&ve!==ke?Fe.setLink(Ne).run():Fe.insertContent({type:"text",text:me,marks:[{type:"link",attrs:Ne}]}).run()},R=async()=>{if(!T())return;let{from:G,to:ie,empty:be}=e.state.selection,pe=be?"":e.state.doc.textBetween(G,ie," ").trim(),me="",ve=pe;try{let le=await(await Promise.resolve().then(()=>(Qn(),ls))).showLinkPrompt({title:"\u0421\u0441\u044B\u043B\u043A\u0430 (URL)",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0441\u0441\u044B\u043B\u043A\u0443 (\u043B\u044E\u0431\u043E\u0439 \u0444\u043E\u0440\u043C\u0430\u0442) \u0438 \u0442\u0435\u043A\u0441\u0442 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E).",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",textLabel:"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)",urlLabel:"\u0421\u0441\u044B\u043B\u043A\u0430",defaultText:pe,defaultUrl:"",urlPlaceholder:""});if(!le||typeof le!="object")return;me=String(le.url||""),ve=String(le.text??pe)}catch{me=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0441\u0441\u044B\u043B\u043A\u0443")||"",ve=pe||window.prompt("\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)")||""}me=(me||"").trim(),me&&q(me,ve,{target:"_blank",rel:"noopener noreferrer"})},Q=async()=>{if(!T())return;let G=Array.isArray(u.articlesIndex)?u.articlesIndex:[];G.length||(G=await hn().catch(()=>[])||[],Array.isArray(G)&&(u.articlesIndex=G));let ie=(Array.isArray(G)?G:[]).map(et=>({id:et.id,title:et.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),{from:be,to:pe,empty:me}=e.state.selection,ve=me?"":e.state.doc.textBetween(be,pe," ").trim(),ke=!!ve,le="",Ne="",Fe=ve;try{let Ue=await(await Promise.resolve().then(()=>(Qn(),ls))).showArticleLinkPrompt({title:"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E \u0438 \u0437\u0430\u0434\u0430\u0439\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438.",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:ie,defaultTextValue:ve,lockTextValue:ke});if(Ue&&typeof Ue=="object")le=Ue.articleValue||"",Ne=Ue.selectedId||"",Fe=Ue.textValue||"";else return}catch{le=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438")||"",Fe=ve||window.prompt("\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)")||""}let ze=(le||"").trim().toLowerCase();if(!ze&&!Ne)return;let Ze=(Array.isArray(G)?G:[]).find(et=>{let Ue=(et.title||"").toLowerCase();return Ne&&et.id===Ne||et.id&&et.id.toLowerCase()===ze||Ue===ze||Ue.includes(ze)});if(!Ze){Ce("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}let Ge=(Fe||"").trim()||Ze.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";q(Wt.article(Ze.id),Ge,{class:"article-link"})},Y=()=>{if(!u.isOutlineEditing||!e||e.isDestroyed)return;let G=C();if(t.dataset.editing=G?"true":"false",n===null?n=G:n!==G&&(m(),n=G),r.deleteBtn&&(r.deleteBtn.hidden=G),r.moveUpBtn&&(r.moveUpBtn.hidden=G),r.moveDownBtn&&(r.moveDownBtn.hidden=G),r.outdentBtn&&(r.outdentBtn.hidden=G),r.indentBtn&&(r.indentBtn.hidden=G),r.newBelowBtn&&(r.newBelowBtn.hidden=G),r.blocksMenuBtn&&(r.blocksMenuBtn.hidden=G),G&&Vn&&ko(!1),r.undo&&(r.undo.disabled=!S(pe=>pe.undo())),r.redo&&(r.redo.disabled=!S(pe=>pe.redo())),r.textMenuBtn){let pe=e.isActive("bold")||e.isActive("italic")||e.isActive("strike")||e.isActive("codeBlock")||e.isActive("blockquote");d(r.textMenuBtn,pe),r.textMenuBtn.hidden=!G}if(r.listsMenuBtn){let pe=e.isActive("bulletList")||e.isActive("orderedList");d(r.listsMenuBtn,pe),r.listsMenuBtn.hidden=!G}if(r.tableMenuBtn){let pe=e.isActive("table");d(r.tableMenuBtn,pe),r.tableMenuBtn.hidden=!G}let ie=null,be=()=>{if(ie)return ie;let pe={total:0,collapsed:0};try{e.state.doc.descendants(me=>{me?.type?.name==="outlineSection"&&(pe.total+=1,me.attrs?.collapsed&&(pe.collapsed+=1))})}catch{}return ie=pe,pe};for(let pe of a){let me=pe.dataset.outlineAction||"";if(!me)continue;let ve=!1,ke=!1;if(me==="collapseAllBlocks"){let le=be();ve=!1,ke=le.total===0||le.collapsed>=le.total}else if(me==="expandAllBlocks"){let le=be();ve=!1,ke=le.total===0||le.collapsed<=0}else me==="toggleBold"?(ve=e.isActive("bold"),ke=!S(le=>le.toggleBold())):me==="toggleItalic"?(ve=e.isActive("italic"),ke=!S(le=>le.toggleItalic())):me==="toggleStrike"?(ve=e.isActive("strike"),ke=!S(le=>le.toggleStrike())):me==="toggleCodeBlock"?(ve=e.isActive("codeBlock"),ke=!C()):me==="toggleBlockquote"?(ve=e.isActive("blockquote"),ke=!S(le=>le.toggleBlockquote())):me==="insertHttpLink"||me==="insertArticleLink"?(ve=!1,ke=!C()):me==="unsetLink"?(ve=e.isActive("link"),ke=!S(le=>le.unsetLink())):me==="toggleBulletList"?(ve=e.isActive("bulletList"),e.isActive("orderedList")?ke=!(S(le=>le.toggleOrderedList())&&S(le=>le.toggleBulletList())):ke=!S(le=>le.toggleBulletList())):me==="toggleOrderedList"?(ve=e.isActive("orderedList"),e.isActive("bulletList")?ke=!(S(le=>le.toggleBulletList())&&S(le=>le.toggleOrderedList())):ke=!S(le=>le.toggleOrderedList())):me==="unsetList"?(ve=!1,e.isActive("bulletList")?ke=!S(le=>le.toggleBulletList()):e.isActive("orderedList")?ke=!S(le=>le.toggleOrderedList()):ke=!S(le=>le.liftListItem("listItem"))):me==="insertTable"?(ve=!1,ke=!S(le=>le.insertTable({rows:2,cols:2,withHeaderRow:!1}))):me==="toggleHeaderRow"?(ve=e.isActive("tableHeader"),ke=!S(le=>le.toggleHeaderRow())):me==="toggleHeaderColumn"?(ve=e.isActive("tableHeader"),ke=!S(le=>le.toggleHeaderColumn())):me==="addRowBefore"?(ve=!1,ke=!S(le=>le.addRowBefore())):me==="addRowAfter"?(ve=!1,ke=!S(le=>le.addRowAfter())):me==="deleteRow"?(ve=!1,ke=!S(le=>le.deleteRow())):me==="addColumnBefore"?(ve=!1,ke=!S(le=>le.addColumnBefore())):me==="addColumnAfter"?(ve=!1,ke=!S(le=>le.addColumnAfter())):me==="deleteColumn"?(ve=!1,ke=!S(le=>le.deleteColumn())):me==="copyColumn"||me==="pasteColumnAfter"||me==="moveColumnRight"?(ve=!1,ke=!0):me==="mergeCells"?(ve=!1,ke=!S(le=>le.mergeCells())):me==="splitCell"?(ve=!1,ke=!S(le=>le.splitCell())):me==="cancelTable"?(ve=!1,ke=!C()||!e.isActive("table")):me==="deleteTable"&&(ve=!1,ke=!S(le=>le.deleteTable()));pe.disabled=!!ke,pe.classList.toggle("is-active",!!ve)}},re=null,Ae=()=>{re||(re=window.requestAnimationFrame(()=>{re=null,Y()}))},Ee=[l(r.undo,()=>e.chain().focus().undo().run()),l(r.redo,()=>e.chain().focus().redo().run())],te=$e?.pmStateMod?.TextSelection||null,ye=(G,ie)=>{try{let be=G.resolve(Math.min(G.content.size,ie+1)),pe=null;for(let me=be.depth;me>0;me-=1){if(be.node(me)?.type?.name!=="outlineSection")continue;if(be.before(me)===ie){pe=me;break}}if(pe===null)return null;for(let me=pe-1;me>0;me-=1)if(be.node(me)?.type?.name==="outlineSection")return be.before(me);return null}catch{return null}},je=G=>{try{if(!te)return;e.commands.command(({state:ie,dispatch:be})=>{let pe=xt(ie.doc,ie.selection.$from);if(typeof pe!="number")return!1;let me=ie.doc.resolve(pe),ve=me.index(),ke=me.parent;if(!ke)return!1;let le=ie.doc.nodeAt(pe);if(!le)return!1;if(G==="up"){if(ve>0){let L=ke.child(ve-1),_=pe-L.nodeSize,P=ie.tr.delete(pe,pe+le.nodeSize).insert(_,le);return P=P.setMeta(ue,!0),P=P.setSelection(te.near(P.doc.resolve(_+2),1)),be(P.scrollIntoView()),!0}let Ne=ye(ie.doc,pe);if(typeof Ne!="number")return!1;let Fe=ie.doc.resolve(Ne),ze=Fe.index(),Ze=Fe.parent;if(!Ze||ze<=0)return!1;let Ge=Ze.child(ze-1),et=Ne-Ge.nodeSize,Ue=ie.doc.nodeAt(et);if(!Ue||Ue.type?.name!=="outlineSection")return!1;let it=Ue.child(0),st=Ue.child(1),tt=Ue.child(2),se=et+1+it.nodeSize+st.nodeSize+tt.nodeSize-1,y=ie.tr.delete(pe,pe+le.nodeSize).setMeta(ue,!0),g=y.mapping.map(et,-1),B=y.mapping.map(se,-1);y=y.insert(B,le);let M=y.doc.nodeAt(g);return M?.type?.name==="outlineSection"&&M.attrs?.collapsed&&(y=y.setNodeMarkup(g,void 0,{...M.attrs,collapsed:!1})),y=y.setSelection(te.near(y.doc.resolve(B+2),1)),be(y.scrollIntoView()),!0}if(G==="down"){if(ve<ke.childCount-1){let L=pe+le.nodeSize,_=ie.doc.nodeAt(L);if(!_)return!1;let P=ie.tr.delete(pe,pe+le.nodeSize),H=pe+_.nodeSize;return P=P.insert(H,le),P=P.setMeta(ue,!0),P=P.setSelection(te.near(P.doc.resolve(H+2),1)),be(P.scrollIntoView()),!0}let Ne=ye(ie.doc,pe);if(typeof Ne!="number")return!1;let Fe=ie.doc.nodeAt(Ne);if(!Fe||Fe.type?.name!=="outlineSection")return!1;let ze=ie.doc.resolve(Ne),Ze=ze.index(),Ge=ze.parent;if(!Ge||Ze>=Ge.childCount-1)return!1;let et=Ne+Fe.nodeSize,Ue=ie.doc.nodeAt(et);if(!Ue||Ue.type?.name!=="outlineSection")return!1;let it=Ue.child(0),st=Ue.child(1),tt=Ue.child(2),se=et+1+it.nodeSize+st.nodeSize+1,y=ie.tr.delete(pe,pe+le.nodeSize).setMeta(ue,!0),g=y.mapping.map(et,-1),B=y.mapping.map(se,-1);y=y.insert(B,le);let M=y.doc.nodeAt(g);return M?.type?.name==="outlineSection"&&M.attrs?.collapsed&&(y=y.setNodeMarkup(g,void 0,{...M.attrs,collapsed:!1})),y=y.setSelection(te.near(y.doc.resolve(B+2),1)),be(y.scrollIntoView()),!0}return!1})}catch{}},pt=()=>{try{if(!te)return;e.commands.command(({state:G,dispatch:ie})=>{let be=xt(G.doc,G.selection.$from);if(typeof be!="number")return!1;let pe=G.doc.resolve(be),me=0;for(let Z=pe.depth;Z>=0;Z-=1)pe.node(Z)?.type?.name==="outlineSection"&&(me+=1);if(me>=6)return!1;let ve=pe.index(),ke=pe.parent;if(!ke||ve<=0)return!1;let le=G.doc.nodeAt(be);if(!le)return!1;let Ne=ke.child(ve-1),Fe=be-Ne.nodeSize,ze=G.doc.nodeAt(Fe);if(!ze)return!1;let Ze=ze.child(0),Ge=ze.child(1),et=ze.child(2),it=Fe+1+Ze.nodeSize+Ge.nodeSize+et.nodeSize-1,st=G.tr.delete(be,be+le.nodeSize).insert(it,le),tt=st.doc.nodeAt(Fe);return tt?.type?.name==="outlineSection"&&tt.attrs?.collapsed&&(st=st.setNodeMarkup(Fe,void 0,{...tt.attrs,collapsed:!1})),st=st.setMeta(ue,!0),st=st.setSelection(te.near(st.doc.resolve(it+2),1)),ie(st.scrollIntoView()),!0})}catch{}},vt=()=>{try{if(!te)return;e.commands.command(({state:G,dispatch:ie})=>{let be=G.selection.$from,pe=null,me=null;for(let Ze=be.depth;Ze>0;Ze-=1)if(be.node(Ze)?.type?.name==="outlineSection")if(pe===null)pe=Ze;else{me=Ze;break}if(pe===null||me===null)return!1;let ve=be.before(pe),ke=be.before(me),le=G.doc.nodeAt(ve);if(!le)return!1;let Ne=G.tr.delete(ve,ve+le.nodeSize),Fe=Ne.doc.nodeAt(ke);if(!Fe)return!1;let ze=ke+Fe.nodeSize;return Ne=Ne.insert(ze,le),Ne=Ne.setMeta(ue,!0),Ne=Ne.setSelection(te.near(Ne.doc.resolve(ze+2),1)),ie(Ne.scrollIntoView()),!0})}catch{}},Qt=()=>{try{if(!te)return;e.commands.command(({state:G,dispatch:ie})=>{let be=xt(G.doc,G.selection.$from);if(typeof be!="number")return!1;let pe=G.doc.nodeAt(be);if(!pe)return!1;let me=String(pe.attrs?.id||"").trim(),ve=G.doc.resolve(be),ke=ve.index(),le=ve.parent;if(!le)return!1;let Ne=G.doc.type.schema;if(le.childCount<=1){let it=Ne.nodes.outlineSection.create({...pe.attrs,collapsed:!1},[Ne.nodes.outlineHeading.create({},[]),Ne.nodes.outlineBody.create({},[Ne.nodes.paragraph.create({},[])]),Ne.nodes.outlineChildren.create({},[])]),st=G.tr.replaceWith(be,be+pe.nodeSize,it);st=st.setMeta(ue,!0);let tt=it.child(0),Z=be+1+tt.nodeSize;return st=st.setSelection(te.near(st.doc.resolve(Z+2),1)),ie(st.scrollIntoView()),!0}me&&jr(me);let Fe=ke>0,ze=Fe?le.child(ke-1):null,Ze=Fe?be-ze.nodeSize:null,Ge=G.tr.delete(be,be+pe.nodeSize);Ge=Ge.setMeta(ue,!0);let et=Fe&&typeof Ze=="number"?Ze:Math.min(Ge.doc.content.size,be),Ue=Ge.doc.nodeAt(et);if(Ue?.type?.name==="outlineSection"){let it=Ue.child(0),st=Ue.child(1),tt=et+1+it.nodeSize;st.childCount||(Ge=Ge.insert(tt+1,Ne.nodes.paragraph.create({},[]))),Ge=Ge.setSelection(te.near(Ge.doc.resolve(tt+2),1))}return ie(Ge.scrollIntoView()),!0})}catch{}},sn=()=>{try{if(!te)return;e.commands.command(({state:G,dispatch:ie})=>{let be=xt(G.doc,G.selection.$from);if(typeof be!="number")return!1;let pe=G.doc.nodeAt(be);if(!pe)return!1;let me=G.doc.type.schema,ve=be+pe.nodeSize,ke=Kt(),le=me.nodes.outlineSection.create({id:ke,collapsed:!1},[me.nodes.outlineHeading.create({},[]),me.nodes.outlineBody.create({},[me.nodes.paragraph.create({},[])]),me.nodes.outlineChildren.create({},[])]),Ne=G.tr.insert(ve,le);return Ne=Ne.setSelection(te.create(Ne.doc,ve+2)),Ne=Ne.setMeta(ue,!0),Te&&(Ne=Ne.setMeta(Te,{type:"enter",sectionId:ke})),ie(Ne.scrollIntoView()),!0})}catch{}};Ee.push(l(r.deleteBtn,()=>Qt())),Ee.push(l(r.moveUpBtn,()=>je("up"))),Ee.push(l(r.moveDownBtn,()=>je("down"))),Ee.push(l(r.outdentBtn,()=>vt())),Ee.push(l(r.indentBtn,()=>pt())),Ee.push(l(r.newBelowBtn,()=>sn()));let pn=0,kn=G=>{try{return G?.target&&G.target.nodeType===1?G.target:G?.target?.parentElement||null}catch{return null}},_n=G=>{let ie=kn(G);if(!ie)return null;let be=ie.closest?.(".outline-toolbar__dropdown-btn")||null;return!be||!t.contains(be)?null:be},Dn=(G,{source:ie})=>{try{let be=Date.now();if(pn&&be-pn<700){f("toggle.skip.dedupe",{source:ie,dtMs:be-pn});return}let pe=_n(G);if(!pe){f("toggle.skip.no-btn",{source:ie,targetClass:String(kn(G)?.className||"")});return}if(pe.disabled){f("toggle.skip.disabled",{source:ie,btnId:pe.id||null});return}G?.cancelable&&G.preventDefault(),G.stopPropagation();let me=b(pe);f("toggle",{source:ie,ok:me,btnId:pe.id||null,menuId:pe.getAttribute("aria-controls")||null,expanded:pe.getAttribute("aria-expanded")||null}),me&&(pn=be)}catch(be){f("toggle.error",{source:ie,message:String(be?.message||be||"")})}},En=G=>{try{let ie=String(G?.pointerType||"");if(ie!=="touch"&&ie!=="pen")return}catch{return}Dn(G,{source:"pointerdown"})},vn=G=>{Dn(G,{source:"click"})};try{t.addEventListener("pointerdown",En,!0),Ee.push(()=>t.removeEventListener("pointerdown",En,!0))}catch{}t.addEventListener("click",vn,!0),Ee.push(()=>t.removeEventListener("click",vn,!0));let Ct=G=>{try{if(!u.isOutlineEditing)return;t.contains(G.target)||m()}catch{}},zt=G=>{try{if(!u.isOutlineEditing)return;t.contains(G.target)||m()}catch{}};try{document.addEventListener("touchstart",Ct,{passive:!0}),Ee.push(()=>document.removeEventListener("touchstart",Ct))}catch{}document.addEventListener("click",zt),Ee.push(()=>document.removeEventListener("click",zt));for(let G of a)Ee.push(l(G,()=>{let ie=G.dataset.outlineAction||"";if(ie==="insertHttpLink"){m(),R().finally(()=>Ae());return}if(ie==="insertArticleLink"){m(),Q().finally(()=>Ae());return}let be=A(ie);m(),be&&Ae()}));for(let G of c)Ee.push(l(G,()=>{let ie=G.getAttribute("data-outline-clipboard-action")||"";if(!ie)return;m();let be=on||null,pe=lr instanceof Set?lr:new Set,me=pe.size?new Set(pe):be?new Set([be]):new Set;if(ie==="toggleSelectMode"){ko(!Vn);return}if(ie==="clear"){la(null),Ce("\u0411\u0443\u0444\u0435\u0440 \u043E\u0447\u0438\u0449\u0435\u043D");return}if(ae){if(ie==="copy"||ie==="cut"){if(!me.size){Ce("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A");return}let ve=Op(ae.state.doc,me);if(!ve.length){Ce("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A");return}let ke=ve.map(Fe=>Fe.node.toJSON());try{let Fe=ve.map(ze=>Ed(ze.node)).filter(Boolean).join(`

`);Hp(Fe)}catch{}if(la({mode:ie==="cut"?"cut":"copy",sourceArticleId:At||u.articleId||null,createdAt:new Date().toISOString(),sections:ke}),ie==="copy"){Ce(`\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${ke.length}`);return}let le=[];for(let Fe of ve){let ze=ct(ae.state.doc,Fe.id),Ze=typeof ze=="number"?ae.state.doc.nodeAt(ze):null;typeof ze=="number"&&Ze&&le.push({pos:ze,size:Ze.nodeSize})}le.sort((Fe,ze)=>ze.pos-Fe.pos);let Ne=ae.state.tr;for(let{pos:Fe,size:ze}of le)Ne=Ne.delete(Fe,Fe+ze);Ne=Ne.setMeta(ue,!0),ae.view.dispatch(Ne.scrollIntoView()),ae.view.focus(),Xt=!0,Gt({delayMs:200}),ko(!1),Ce(`\u0412\u044B\u0440\u0435\u0437\u0430\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${ke.length}`);return}if(ie==="paste"){let ve=od();if(!ve||!Array.isArray(ve.sections)||!ve.sections.length){Ce("\u0411\u0443\u0444\u0435\u0440 \u043F\u0443\u0441\u0442");return}let ke=ae.state,le=ke.doc.content.size;if(be){let Ue=ct(ke.doc,be),it=typeof Ue=="number"?ke.doc.nodeAt(Ue):null;typeof Ue=="number"&&it&&(le=Ue+it.nodeSize)}let Ne=new Set;try{ke.doc.descendants(Ue=>{if(Ue?.type?.name!=="outlineSection")return;let it=String(Ue.attrs?.id||"").trim();it&&Ne.add(it)})}catch{}let Fe=[];if(ve.mode==="copy")for(let Ue of ve.sections)Fe.push(Rp(Ue,()=>Kt()));else for(let Ue of ve.sections){let it=String(Ue?.attrs?.id||"").trim();if(it&&Ne.has(it)){Ce("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C: \u0431\u043B\u043E\u043A \u0441 \u0442\u0430\u043A\u0438\u043C id \u0443\u0436\u0435 \u0435\u0441\u0442\u044C");return}Fe.push(kd(Ue))}let ze=ke.doc.type.schema,Ze=[];for(let Ue of Fe)try{let it=ze.nodeFromJSON(Ue);it?.type?.name==="outlineSection"&&Ze.push(it)}catch{}if(!Ze.length){Ce("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438");return}let Ge=ke.tr,et=le;for(let Ue of Ze)Ge=Ge.insert(et,Ue),et+=Ue.nodeSize;Ge=Ge.setMeta(ue,!0),ae.view.dispatch(Ge.scrollIntoView()),ae.view.focus(),Xt=!0,Gt({delayMs:200}),ve.mode==="cut"&&la(null),ko(!1),Ce(`\u0412\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${Ze.length}`)}}}));let yt=G=>{u.isOutlineEditing&&(t.contains(G.target)||m())},ut=G=>{u.isOutlineEditing&&G.key==="Escape"&&m()};document.addEventListener("pointerdown",yt),document.addEventListener("keydown",ut),Ee.push(()=>document.removeEventListener("pointerdown",yt)),Ee.push(()=>document.removeEventListener("keydown",ut));let Tt=e.on("transaction",Ae),Zt=e.on("selectionUpdate",Ae);Ee.push(()=>Tt?.()),Ee.push(()=>Zt?.());try{let G=Jp({setActiveTagKey:ie=>{try{_i?.(ie)}catch{}}});Ee.push(()=>G?.())}catch{}Ae(),vi=()=>{re&&(window.cancelAnimationFrame(re),re=null);for(let G of Ee)try{G()}catch{}}}function um(){if(vi)try{vi()}catch{}vi=null}function jn(e=""){let t=String(e||"");u.outlineStatusText=t,J.updatedAt&&u.isOutlineEditing&&(J.updatedAt.textContent=t)}function fm(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=r.child(1),s=t+1+o.nodeSize,a=n.tr;if(!i.childCount){let l=n.doc.type.schema;a=a.insert(s+1,l.nodes.paragraph.create({},[]))}let{TextSelection:c}=$e?.pmStateMod||{};return c?(a=a.setSelection(c.near(a.doc.resolve(s+2),1)),e.view.dispatch(a.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0):!1}catch{return!1}}function pm(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=t+1,{TextSelection:s}=$e?.pmStateMod||{};if(!s)return!1;let a=i+1,c=i+o.nodeSize-1,l=Math.min(Math.max(a,a),Math.max(a,c)),d=n.tr.setSelection(s.near(n.doc.resolve(l),1));return d=d.setMeta(ue,!0),e.view.dispatch(d.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0}catch{return!1}}function mm(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=t+1,{TextSelection:s}=$e?.pmStateMod||{};if(!s)return!1;let a=i+1,c=i+o.nodeSize-1,l=Math.max(a,c),d=n.tr.setSelection(s.near(n.doc.resolve(l),-1));return d=d.setMeta(ue,!0),e.view.dispatch(d.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0}catch{return!1}}function hm(e,t){try{if(!e)return!1;let n=String(t||"").trim();if(!n)return!1;let r=e.state,o=ct(r.doc,n);if(typeof o!="number")return!1;let i=r.doc.nodeAt(o);if(!i||i.type?.name!=="outlineSection")return!1;if(i.attrs?.collapsed)return pm(e,o);try{if(!i.child(1)?.childCount)return mm(e,o)}catch{}return fm(e,o)}catch{return!1}}function gm(e,t,{block:n="center"}={}){try{let r=String(t||"").trim();if(!e||!r)return!1;let o=e.view;if(!o?.dom?.querySelector)return!1;let i=typeof CSS<"u"&&CSS.escape?CSS.escape(r):r.replace(/"/g,'\\"'),s=()=>{try{let a=o.dom?.querySelector?.(`[data-outline-section][data-section-id="${i}"]`)||o.dom?.querySelector?.(`[data-section-id="${i}"]`);a&&typeof a.scrollIntoView=="function"&&a.scrollIntoView({block:n||"center",inline:"nearest"})}catch{}};try{window.requestAnimationFrame(s)}catch{}try{setTimeout(s,80)}catch{}return!0}catch{return!1}}async function ym(){if($e)return $e;if(typeof window>"u")throw new Error("Outline editor is browser-only");let e=wr()?performance.now():0,t=await import("/outline/tiptap.bundle.js");return e&&Wr("import tiptap.bundle.js",{ms:Math.round(performance.now()-e)}),$e={core:t.core,starterKitMod:t.starterKitMod,htmlMod:t.htmlMod,pmStateMod:t.pmStateMod,pmViewMod:t.pmViewMod,pmTablesMod:t.pmTablesMod,linkMod:t.linkMod,imageMod:t.imageMod,mentionMod:t.mentionMod,tableMod:t.tableMod,tableRowMod:t.tableRowMod,tableCellMod:t.tableCellMod,tableHeaderMod:t.tableHeaderMod,uniqueIdMod:t.uniqueIdMod,markdownMod:t.markdownMod},$e}function bm({blocks:e,parseHtmlToNodes:t}){let n=i=>Array.isArray(i)&&i.length>0?i:[{type:"paragraph",content:[]}],r=i=>{let s=String(i?.id||Kt()),a=!!i?.collapsed,c=$n(String(i?.text||"")),l=ba(c.titleHtml)||"",d=n(t(c.bodyHtml||"")),m=Array.isArray(i?.children)?i.children:[];return{type:"outlineSection",attrs:{id:s,collapsed:a},content:[{type:"outlineHeading",content:l?[{type:"text",text:l}]:[]},{type:"outlineBody",content:d},{type:"outlineChildren",content:m.map(r)}]}},o=(Array.isArray(e)?e:[]).map(r);return{type:"doc",content:o.length?o:[r({id:Kt(),text:"",collapsed:!1,children:[]})]}}function wm(e){try{let t=String(e||"").trim();if(!t)return null;let n=window?.localStorage?.getItem?.("ttree_outline_last_active_v1")||"{}",r=JSON.parse(n||"{}"),o=r&&typeof r=="object"?r[t]:null;if(!o||typeof o!="object")return null;let i=String(o.sectionId||"").trim();return i?{sectionId:i,collapsed:!!o.collapsed}:null}catch{return null}}function Hd(e,t,n){try{let r=String(e||"").trim(),o=String(t||"").trim();if(!r||!o)return!1;let i=window?.localStorage?.getItem?.("ttree_outline_last_active_v1")||"{}",s=JSON.parse(i||"{}"),a=s&&typeof s=="object"?s:{};return a[r]={sectionId:o,collapsed:!!n,savedAt:new Date().toISOString()},window?.localStorage?.setItem?.("ttree_outline_last_active_v1",JSON.stringify(a)),!0}catch{return!1}}function hd(e){try{let t=At||u.articleId||null;if(!t||!e||e.isDestroyed)return!1;let n=e.state,r=xt(n.doc,n.selection.$from);if(typeof r!="number")return!1;let o=n.doc.nodeAt(r);if(!o||o.type?.name!=="outlineSection")return!1;let i=String(o.attrs?.id||"").trim();if(!i)return!1;let s=!!o.attrs?.collapsed;return Ii.articleId===t&&Ii.sectionId===i&&Ii.collapsed===s?!1:(Ii={articleId:t,sectionId:i,collapsed:s},Hd(t,i,s))}catch{return!1}}function Sm(e,{lines:t=4}={}){try{if(!e||e.isDestroyed)return!1;let n=e.view;if(!n||!n.state||!n.dom)return!1;let r=n.state.selection;return!r||typeof r.from!="number"?!1:(ki&&cancelAnimationFrame(ki),ki=requestAnimationFrame(()=>{ki=null;try{let o=n.coordsAtPos(r.from);if(!o||typeof o.bottom!="number")return;let s=(S=>{try{let A=S;for(;A&&A!==document.body&&A!==document.documentElement;){let C=window.getComputedStyle(A),T=String(C.overflowY||"");if((T==="auto"||T==="scroll"||T==="overlay")&&A.scrollHeight>A.clientHeight+2)return A;A=A.parentElement}}catch{}return document.scrollingElement||document.documentElement})(n.dom),a=window.getComputedStyle(n.dom),c=String(a.lineHeight||"").trim(),l=c==="normal"?20:Number.parseFloat(c)||20,d=Math.max(24,l*Math.max(1,Number(t)||4)+12),m=window.innerHeight||0,h=0;if(s&&s!==document.scrollingElement&&s!==document.documentElement&&s!==document.body){let S=s.getBoundingClientRect();h=S.top,m=S.height}if(!m)return;let b=o.bottom-h,w=m-d;if(b<=w)return;let p=b-w,f=Math.max(0,(s.scrollTop||0)+p);s.scrollTop=f}catch{}}),!0)}catch{return!1}}function xt(e,t){try{if(t?.nodeAfter?.type?.name==="outlineSection")return t.pos}catch{}for(let n=t.depth;n>0;n-=1)if(t.node(n)?.type?.name==="outlineSection")return t.before(n);return null}function Hi(e){if(!e)return"";let t=e.child(0),n=e.child(1),r=Kn(t?.textContent||""),o="";try{o=Kn(n?.textBetween?.(0,n.content.size,`
`,`
`)||"")}catch{o=Kn(n?.textContent||"")}return Kn(`${r}
${o}`)}function gd(e){if(!e)return"";let t=e.child(1),n="";try{n=Kn(t?.textBetween?.(0,t.content.size,`
`,`
`)||"")}catch{n=Kn(t?.textContent||"")}return n}function yd(e){if(!pa||!ma)return"";let t=[];return e?.content?.forEach?.(o=>{t.push(o.toJSON())}),(pa({type:"doc",content:t},ma)||""||"").trim()}function bd(e){try{return Kn(String(e?.textContent||"").replace(/\u00a0/g," ")).trim()}catch{return""}}function xm(e){try{let t=document.createElement("template");return t.innerHTML=String(e||""),Kn(String(t.content.textContent||"").replace(/\u00a0/g," ")).trim()}catch{return""}}function $d(e){try{if(!e)return null;let t=e.state?.selection||null;if(!t)return null;let n=Number.isFinite(t.anchor)?t.anchor:t.from,r=Number.isFinite(t.head)?t.head:t.to,o=t.$from||null,i=null;try{let s=o?xt(e.state.doc,o):null;if(typeof s=="number"){let a=e.state.doc.nodeAt(s);i=String(a?.attrs?.id||"")||null}}catch{i=null}return!Number.isFinite(n)||!Number.isFinite(r)?null:{anchor:n,head:r,sectionId:i}}catch{return null}}function Fd(e,t,n){try{if(!e?.view||!t)return!1;let{TextSelection:r}=$e?.pmStateMod||{};if(!r||!n)return e.view.dispatch(t),!0;let o=t.doc?.content?.size??null;if(!Number.isFinite(o))return e.view.dispatch(t),!0;let i=t.mapping.map(Math.max(0,Math.min(n.anchor,o)),1),s=t.mapping.map(Math.max(0,Math.min(n.head,o)),1);try{t=t.setSelection(r.create(t.doc,i,s))}catch{}return e.view.dispatch(t),!0}catch{try{return e?.view?.dispatch?.(t),!0}catch{return!1}}}function Am(e,t,n,r={}){if(!e||!t)return!1;let o=ct(e.state.doc,t);if(typeof o!="number")return!1;let i=e.state.doc.nodeAt(o);if(!i)return!1;let s=e.state.schema,a=i.child(0),c=o+1,l=String(n||"").replace(/\u00a0/g," ").trim(),d=s.nodes.outlineHeading.create({},l?[s.text(l)]:[]),m=e.state.tr.replaceWith(c,c+a.nodeSize,d).setMeta(ue,!0),h=r?.preserveSelection?$d(e):null;return Fd(e,m,h),!0}function Im(e,t,n,r={}){if(!e||!t||!No)return!1;let o=ct(e.state.doc,t);if(typeof o!="number")return!1;let i=e.state.doc.nodeAt(o);if(!i)return!1;let s=i.child(0),a=i.child(1),c=o+1+s.nodeSize,l=e.state.schema,d=[];try{d=No(n||"")}catch{d=[]}let m=[];try{m=(Array.isArray(d)?d:[]).map(p=>l.nodeFromJSON(p))}catch{m=[l.nodes.paragraph.create({},[])]}m.length||(m=[l.nodes.paragraph.create({},[])]);let h=l.nodes.outlineBody.create({},m),b=e.state.tr.replaceWith(c,c+a.nodeSize,h).setMeta(ue,!0),w=r?.preserveSelection?$d(e):null;return Fd(e,b,w),!0}function Sa(e){if(!e)return!0;let t=e.child(0);return!Kn(t?.textContent||"")}function km(e,t,n){if(!e||!t)return!1;let r=ct(e.state.doc,t);if(typeof r!="number")return!1;let o=e.state.doc.nodeAt(r);if(!o||!Sa(o))return!1;let i=o.child(0),s=r+1,a=s+1,c=s+i.nodeSize-1,l=String(n||"").trim();if(!l)return!1;let d=l.length>200?l.slice(0,200):l,m=e.state.tr.insertText(d,a,c).setMeta(ue,!0);return e.view.dispatch(m),!0}function Em(e){Er.clear(),e.descendants(t=>{if(t?.type?.name!=="outlineSection")return;let n=String(t.attrs?.id||"");n&&Er.set(n,Hi(t))})}function ct(e,t){let n=null;return e.descendants((r,o)=>{if(n!==null)return!1;r?.type?.name==="outlineSection"&&String(r.attrs?.id||"")===String(t||"")&&(n=o)}),n}function vm(e,t){try{let n=e.doc,r=ct(n,t),o=typeof r=="number"?n.nodeAt(r):null;if(!o)return null;let i=e.schema,s=i.marks?.code||null,a=i.nodes?.codeBlock||null;if(!s||!a)return null;let c=o.child(0),l=o.child(1);if(!c||!l)return null;let m=r+1+c.nodeSize+1,h=[];if(l.descendants((w,p)=>{if(!w||w.type?.name!=="paragraph")return;let f=!1,S=!1,A=!0;for(let O=0;O<w.childCount;O+=1){let $=w.child(O);if($){if($.type?.name==="hardBreak"){S=!0;continue}if($.isText){if(!String($.text||""))continue;if(!(Array.isArray($.marks)?$.marks:[]).some(Y=>Y?.type===s)){A=!1;break}f=!0;continue}A=!1;break}}if(!A||!f||!S)return;let C="";for(let O=0;O<w.childCount;O+=1){let $=w.child(O);if($){if($.type?.name==="hardBreak"){C+=`
`;continue}$.isText&&(C+=String($.text||""))}}if(!C.trim())return;let T=m+p;h.push({from:T,to:T+w.nodeSize,text:C})}),!h.length)return null;let b=e.tr;for(let w=h.length-1;w>=0;w-=1){let{from:p,to:f,text:S}=h[w],A=b.doc.resolve(p),C=A.parent,T=A.index();if(!C?.canReplaceWith?.(T,T+1,a))continue;let O=i.text(S),$=a.create(null,O);b=b.replaceWith(p,f,$)}return b.docChanged?b.setMeta(ue,!0):null}catch{return null}}function zd(e,t,n){if(!e||!t||!n||u.article?.encrypted)return;let r=ct(t,n),o=typeof r=="number"?t.nodeAt(r):null;if(!o||!Sa(o))return;let i=gd(o);if(!i)return;let s=wa(i),a=ca.get(n)||null;a?.inFlight||a?.bodyHash!==s&&(ca.set(n,{bodyHash:s,inFlight:!0}),fc(i).then(c=>{let l=String(c?.title||"").trim();if(!l||l.length>200)return;let d=e.state.doc,m=ct(d,n),h=typeof m=="number"?d.nodeAt(m):null;if(!h||!Sa(h))return;let b=gd(h);if(!(wa(b)!==s||!km(e,n,l))){Xt=!0;try{let p=At||u.articleId||null;p&&(xa({articleId:p,doc:e.state.doc,sectionId:n,reason:"generate_title"}),jn("\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438 \u043D\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044E"))}catch{}Gt({delayMs:900})}}).catch(()=>{}).finally(()=>{ca.set(n,{bodyHash:s,inFlight:!1})}))}function Cm(e,t,n){if(!(!e||!t)&&!(!Array.isArray(n)||!n.length)&&!u.article?.encrypted&&!(typeof navigator<"u"&&navigator&&navigator.onLine===!1)){try{if((Te?.getState?.(e.state)||null)?.editingSectionId)return}catch{}for(let r of n)try{zd(e,t,r)}catch{}}}function wd(e,t,n){let r=String(n||"").trim(),o=($,q={})=>Mt("skip",{reason:$,sectionId:r,...q});if(!e||!t||!r){o("missing_args",{hasEditor:!!e,hasDoc:!!t,hasSectionId:!!r});return}if(u.article?.encrypted){o("encrypted_article");return}try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1){o("offline");return}}catch{}let i=ct(t,r),s=typeof i=="number"?t.nodeAt(i):null;if(!s){o("section_not_found",{pos:typeof i=="number"?i:null});return}let a=s.child(0),c=s.child(1),l=bd(a),d=l?`<p>${Bo(l)}</p>`:"",m=yd(c);if(!d&&!m){o("empty_heading_and_body");return}let h=d?Vr(d):"",b=m?Vr(m):"",w=($,q)=>{if(!q||$?.inFlight||$?.status==="ok"&&$?.htmlHash===q)return!0;if($?.status==="error"&&$?.htmlHash===q){let R=Number($?.lastAttemptAtMs||0)||0;if(Date.now()-R<Bp)return!0}return!1},p=Kr.get(r)||null,f=qr.get(r)||null,S=w(p,h),A=w(f,b);if(S&&A){o("already_ok_or_in_flight",{headingHash:h||null,bodyHash:b||null});try{Gr.delete(r)}catch{}return}let C=S,T=A,O=()=>{try{C&&T&&Gr.delete(r)}catch{}};S||(Mt("start_heading",{sectionId:r,htmlHash:h}),Kr.set(r,{htmlHash:h,inFlight:!0,status:p?.status||"ok",lastAttemptAtMs:Date.now()}),is(d).then($=>{if($&&$.ok===!1){Mt("unavailable_heading",{sectionId:r,reason:String($.reason||"")}),Kr.set(r,{htmlHash:h,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()});let je=Date.now();je-Ai>6e4&&(Ai=je,Ce("\u041A\u043E\u0440\u0440\u0435\u043A\u0442\u0443\u0440\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 (\u043D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0430 \u043A OpenAI)."));return}let q=String($?.html||"").trim();if(!q){Mt("skip_apply_heading",{sectionId:r,reason:"empty_corrected_html"});return}let R=xm(q);if(!R){Mt("skip_apply_heading",{sectionId:r,reason:"empty_corrected_plain"});return}let Q=e.state.doc,Y=ct(Q,r),re=typeof Y=="number"?Q.nodeAt(Y):null;if(!re){Mt("skip_apply_heading",{sectionId:r,reason:"section_not_found_current_doc"});return}let Ae=bd(re.child(0)),Ee=Ae?`<p>${Bo(Ae)}</p>`:"";if(Vr(Ee)!==h){Mt("skip_apply_heading",{sectionId:r,reason:"heading_changed_since_request"});return}if(Vr(`<p>${Bo(R)}</p>`)===h){Mt("skip_apply_heading",{sectionId:r,reason:"no_changes_from_server"});return}if(!Am(e,r,R,{preserveSelection:!0})){Mt("skip_apply_heading",{sectionId:r,reason:"apply_failed"});return}Xt=!0,Gt({delayMs:900})}).catch(()=>{Mt("error_heading",{sectionId:r,htmlHash:h}),Kr.set(r,{htmlHash:h,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()})}).finally(()=>{(Kr.get(r)||null)?.status!=="error"&&Kr.set(r,{htmlHash:h,inFlight:!1,status:"ok",lastAttemptAtMs:Date.now()}),Mt("done_heading",{sectionId:r,htmlHash:h}),C=!0,O()})),A||(Mt("start",{sectionId:r,htmlHash:b}),qr.set(r,{htmlHash:b,inFlight:!0,status:f?.status||"ok",lastAttemptAtMs:Date.now()}),is(m).then($=>{if($&&$.ok===!1){Mt("unavailable",{sectionId:r,reason:String($.reason||"")}),qr.set(r,{htmlHash:b,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()});let Ee=Date.now();Ee-Ai>6e4&&(Ai=Ee,Ce("\u041A\u043E\u0440\u0440\u0435\u043A\u0442\u0443\u0440\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 (\u043D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0430 \u043A OpenAI)."));return}let q=String($?.html||"").trim();if(!q){Mt("skip_apply",{sectionId:r,reason:"empty_corrected_html"});return}let R=e.state.doc,Q=ct(R,r),Y=typeof Q=="number"?R.nodeAt(Q):null;if(!Y){Mt("skip_apply",{sectionId:r,reason:"section_not_found_current_doc"});return}let re=yd(Y.child(1));if(Vr(re)!==b){Mt("skip_apply",{sectionId:r,reason:"body_changed_since_request"});return}if(Vr(q)===b){Mt("skip_apply",{sectionId:r,reason:"no_changes_from_server"});return}if(!Im(e,r,q,{preserveSelection:!0})){Mt("skip_apply",{sectionId:r,reason:"apply_failed"});return}Xt=!0,Gt({delayMs:900})}).catch(()=>{Mt("error",{sectionId:r,htmlHash:b}),qr.set(r,{htmlHash:b,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()})}).finally(()=>{(qr.get(r)||null)?.status!=="error"&&qr.set(r,{htmlHash:b,inFlight:!1,status:"ok",lastAttemptAtMs:Date.now()}),Mt("done",{sectionId:r,htmlHash:b}),T=!0,O()}))}function xr(e,t){if(!t)return!1;let n=ct(e,t);if(typeof n!="number")return!1;let r=e.nodeAt(n);if(!r)return!1;let o=Hi(r),i=Er.get(t)||"";if(o===i)return!1;vr.add(t);try{Gr.add(t)}catch{}return!0}function Gt({delayMs:e=1200}={}){u.isOutlineEditing&&ae&&(u.isPublicView||At&&u.articleId&&At!==u.articleId||(Fn&&clearTimeout(Fn),Fn=setTimeout(()=>{Fn=null,To()},Math.max(200,e))))}async function To({force:e=!1}={}){if(u.isOutlineEditing&&ae&&!u.isPublicView&&!(At&&u.articleId&&At!==u.articleId)&&!Ei&&!(!e&&!Xt&&!vr.size)){Ei=!0,jn("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C\u2026");try{try{let t=ae.state,n=xt(t.doc,t.selection.$from);if(typeof n=="number"){let r=t.doc.nodeAt(n),o=String(r?.attrs?.id||"");o&&xr(t.doc,o)}}catch{}await Tm({silent:!0,mode:"queue"})}finally{Ei=!1}}}async function Ud(){if(!J.outlineEditor)return;let e=J.outlineEditor.querySelector("#outlineEditorContent");if(!e){Ce("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043C\u043E\u043D\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440");return}if(Za(),Io)return Io;Io=(async()=>{let t=wr()?performance.now():0,n=wr()?performance.now():0,{core:r,starterKitMod:o,htmlMod:i,pmStateMod:s,pmViewMod:a}=await ym();n&&Wr("loadTiptap()",{ms:Math.round(performance.now()-n)});let{Editor:c,Node:l,Extension:d,InputRule:m,mergeAttributes:h}=r,b=o.default||o.StarterKit||o,{generateJSON:w,generateHTML:p}=i,{TextSelection:f}=s,{Plugin:S,PluginKey:A}=s,{Decoration:C,DecorationSet:T}=a,O=$e.linkMod.default||$e.linkMod.Link||$e.linkMod,$=$e.imageMod.default||$e.imageMod.Image||$e.imageMod,q=$e.mentionMod?.default||$e.mentionMod?.Mention||$e.mentionMod,R=$e.tableMod.TableKit||$e.tableMod.tableKit;gt={TableMap:$e.pmTablesMod?.TableMap||null,CellSelection:$e.pmTablesMod?.CellSelection||null,moveTableColumn:$e.pmTablesMod?.moveTableColumn||null,moveTableRow:$e.pmTablesMod?.moveTableRow||null,addRowBefore:$e.pmTablesMod?.addRowBefore||null,addRowAfter:$e.pmTablesMod?.addRowAfter||null,deleteRow:$e.pmTablesMod?.deleteRow||null,addColumnBefore:$e.pmTablesMod?.addColumnBefore||null,addColumnAfter:$e.pmTablesMod?.addColumnAfter||null,deleteColumn:$e.pmTablesMod?.deleteColumn||null,toggleHeaderRow:$e.pmTablesMod?.toggleHeaderRow||null,toggleHeaderColumn:$e.pmTablesMod?.toggleHeaderColumn||null};let Q=$e.uniqueIdMod.default||$e.uniqueIdMod.UniqueID||$e.uniqueIdMod,Y=$e.markdownMod?.Markdown||$e.markdownMod?.default?.Markdown||$e.markdownMod?.default||null,re=y=>{let g=String(y||"").trim();if(!g)return null;let B=g.match(/(\d+(?:\.\d+)?)px/i);if(!B)return null;let M=Number.parseFloat(B[1]);return Number.isFinite(M)?M:null},Ae=new A("outlineTagHighlighter"),Ee=null,te=d.create({name:"outlineTagSuggestKeys",addProseMirrorPlugins(){return[new S({key:new A("outlineTagSuggestKeys"),props:{handleKeyDown(y,g){try{return Ee?.isOpen?.()?!!Ee.handleKeyDown?.(g):!1}catch{return!1}}}})]}}),ye=(()=>{if(!q||typeof q.extend!="function")return null;let y=()=>{let g=null,B=null,M=[],L=0,_=null,P=null,H=()=>{g||(g=document.createElement("div"),g.className="tt-tag-suggest",B=document.createElement("div"),B.className="tt-tag-suggest__list",g.appendChild(B),document.body.appendChild(g))},N=()=>{try{g?.remove()}catch{}g=null,B=null,M=[],L=0,_=null,Ee===P&&(Ee=null)},E=I=>{if(!g||!I)return;let D=I();D&&(g.style.left=`${Math.max(8,D.left)}px`,g.style.top=`${Math.max(8,D.bottom+6)}px`)},k=I=>{if(!(!g||!B)&&(_=I||null,M=Array.isArray(I?.items)?I.items:[],B.innerHTML="",M.forEach((D,z)=>{let U=document.createElement("button");U.type="button",U.className=z===L?"tt-tag-suggest__item active":"tt-tag-suggest__item",U.textContent=String(D?.label||D?.key||""),U.addEventListener("pointerdown",V=>{V.preventDefault(),V.stopPropagation(),I.command(D)}),B.appendChild(U)}),!M.length)){let D=document.createElement("div");D.className="tt-tag-suggest__empty",D.textContent="\u041D\u0435\u0442 \u0441\u043E\u0432\u043F\u0430\u0434\u0435\u043D\u0438\u0439",B.appendChild(D)}},x=I=>{let D=M.length;D&&(L=(L+I+D)%D)},v=I=>{if(!I||!g)return!1;if(I.key==="Escape")return I.preventDefault(),I.stopPropagation(),N(),!0;if(I.key===" "||I.code==="Space"){if(!_)return!1;if(!M.length){let z=Eo(_?.query||"");return z?(I.preventDefault(),I.stopPropagation(),_.command({key:z,label:z}),!0):!1}I.preventDefault(),I.stopPropagation();let D=M[L];return D&&_.command(D),!0}if(I.key==="ArrowDown")return I.preventDefault(),I.stopPropagation(),x(1),k(_),!0;if(I.key==="ArrowUp")return I.preventDefault(),I.stopPropagation(),x(-1),k(_),!0;if(I.key==="Enter"){if(!_)return!1;I.preventDefault(),I.stopPropagation();let D=M[L];return D&&_.command(D),!0}return!1};return P={isOpen:()=>!!g,handleKeyDown:v},Ee=P,{char:"\\",allowedPrefixes:null,allowSpaces:!1,startOfLine:!1,items:({query:I})=>{let D=String(I||""),z=Eo(D),U=Qa(),V=new Map,K=new Map;try{for(let[oe,Se]of U?.counts?.entries?.()||[]){let Ie=String(oe||"").trim();Ie&&(V.set(Ie,Number(Se||0)||0),K.set(Ie,String(U?.labelByKey?.get?.(Ie)||Ie)))}}catch{}for(let[oe,Se]of Jn.counts.entries()){let Ie=String(oe||"").trim();Ie&&(V.has(Ie)||V.set(Ie,Number(Se||0)||0),K.has(Ie)||K.set(Ie,String(Jn.labelByKey.get(Ie)||Ie)))}let X=Array.from(V.entries()).map(([oe,Se])=>({key:oe,label:K.get(oe)||oe,count:Se})).sort((oe,Se)=>(Se.count||0)-(oe.count||0));return(z?X.filter(oe=>String(oe.key||"").includes(z)||String(oe.label||"").toLowerCase().includes(z.toLowerCase())):X).slice(0,8)},command:({editor:I,range:D,props:z})=>{try{let U=String(z?.key||z?.label||""),V=Bi(U),K=Eo(V);if(!K)return;I.chain().focus().insertContentAt(D,[{type:"tag",attrs:{label:K,key:K}}]).insertContent(" ").run()}catch{}},render:()=>({onStart:I=>{L=0,H(),k(I),E(I.clientRect)},onUpdate:I=>{L=0,H(),k(I),E(I.clientRect)},onKeyDown:I=>v(I?.event),onExit:()=>N()})}};return q.extend({name:"tag",group:"inline",inline:!0,atom:!0,selectable:!1,addAttributes(){return{label:{default:""},key:{default:""}}},parseHTML(){return[{tag:'span[data-tt-tag="1"]'}]},renderText({node:g}){try{return Bi(g?.attrs?.label||g?.attrs?.key||"")||""}catch{return""}},renderHTML({node:g,HTMLAttributes:B}){let M=Bi(g?.attrs?.label||g?.attrs?.key||"")||"",L=Eo(g?.attrs?.key||M)||"";return["span",h(B,{"data-tt-tag":"1","data-tag-key":L,class:"tt-tag"}),M||L||""]}}).configure({suggestion:y()})})(),je=d.create({name:"outlineTagHighlighter",addProseMirrorPlugins(){return[new S({key:Ae,state:{init:()=>({activeKey:null}),apply:(y,g)=>{let B=y.getMeta(Ae);return B&&Object.prototype.hasOwnProperty.call(B,"activeKey")?{activeKey:B.activeKey?String(B.activeKey):null}:g}},props:{decorations(y){let g=Ae.getState(y)?.activeKey||null,B=[];return y.doc.descendants((M,L)=>{if(M?.type?.name!=="tag")return;let _=String(M.attrs?.key||"").trim();if(!_)return;let P=g&&_===g?"tt-tag tt-tag--active":"tt-tag";B.push(C.node(L,L+M.nodeSize,{class:P}))}),B.length?T.create(y.doc,B):null}}})]}}),pt=$.extend({inline:!0,group:"inline",addAttributes(){return{...typeof this.parent=="function"?this.parent():{},width:{default:320,parseHTML:g=>{try{let B=g,M=B&&B.classList&&B.classList.contains("resizable-image")?B:B?.closest?.(".resizable-image"),L=re(M?.style?.width||"");if(L!==null)return Math.round(L);let _=re(M?.getAttribute?.("style")||"")||re(B?.getAttribute?.("style")||"");if(_!==null)return Math.round(_);let P=M?.getAttribute?.("data-width")||B?.getAttribute?.("data-width")||"",H=Number.parseFloat(String(P||""));return Number.isFinite(H)&&H>0?Math.round(H):320}catch{return 320}},renderHTML:()=>({})},aspectRatio:{default:null,parseHTML:g=>{try{let B=g,M=B&&B.classList&&B.classList.contains("resizable-image")?B:B?.closest?.(".resizable-image"),L=M?.style?.aspectRatio||M?.getAttribute?.("data-aspect-ratio")||B?.getAttribute?.("data-aspect-ratio")||"",_=Number.parseFloat(String(L||"").replace(",","."));return Number.isFinite(_)&&_>0?_:null}catch{return null}},renderHTML:()=>({})},uploadToken:{default:null,parseHTML:()=>null,renderHTML:()=>({})}}},parseHTML(){return[{tag:"span.resizable-image",getAttrs:y=>{let g=y,B=g?.querySelector?.("img"),M=B?.getAttribute?.("src")||"";if(!M)return!1;let L=B?.getAttribute?.("alt")||"",_=B?.getAttribute?.("title")||"",P=re(g?.style?.width||"")??320;return{src:M,alt:L,title:_,width:Math.round(P)}}},{tag:"img[src]",getAttrs:y=>{let g=y,B=g?.getAttribute?.("src")||"";if(!B)return!1;let M=g?.getAttribute?.("alt")||"",L=g?.getAttribute?.("title")||"";return{src:B,alt:M,title:L,width:320}}}]},renderHTML({node:y,HTMLAttributes:g}){let B=y?.attrs?.width,M=Number.isFinite(Number(B))?Math.round(Number(B)):320,L=y?.attrs?.aspectRatio,_=Number.isFinite(Number(L))&&Number(L)>0?Number(L):null,P={...g};return delete P.width,delete P.aspectRatio,delete P.uploadToken,P.style=`${String(P.style||"").trim()};width:100%;height:auto;display:block;`.replace(/^;\s*/,""),["span",h({class:"resizable-image",style:`width:${M}px;max-width:100%;${_?`aspect-ratio:${_.toFixed(6)};`:""}`,..._?{"data-aspect-ratio":String(_)}:{}},{}),["span",{class:"resizable-image__inner"},["img",h(P,{draggable:"false"})]],["span",{class:"resizable-image__handle","data-direction":"e","aria-hidden":"true"}]]}});pa=p,ma=[b.configure({heading:!1,link:!1}),O.configure({openOnClick:!1,protocols:Si}),pt,R.configure({table:{resizable:!0}})];let vt=d.create({name:"outlineImageUpload",addProseMirrorPlugins(){let y=L=>{if(!L)return!1;if(L.type&&String(L.type).startsWith("image/"))return!0;let _=String(L.name||"").toLowerCase();return!!(_&&/\.(png|jpe?g|gif|webp|bmp|svg|heic|heif)$/i.test(_))},g=(L,_)=>{let P=[];return Array.from(L||[]).forEach(H=>{if(H.kind!=="file")return;let N=typeof H.getAsFile=="function"?H.getAsFile():null;N&&y(N)&&P.push(N)}),!P.length&&_?.length&&Array.from(_).forEach(H=>{y(H)&&P.push(H)}),P},B=(L,_)=>{let P=`upl-${Date.now()}-${Math.random().toString(16).slice(2)}`,H=URL.createObjectURL(_);try{kr.set(P,H)}catch{}try{let V=At||u.articleId||null;ql({token:P,articleId:V,kind:"image",blob:_,fileName:_?.name||"image",mime:_?.type||""})}catch{}let N=L.state.schema.nodes.image.create({src:H,alt:_?.name||"image",width:320,uploadToken:P}),E=L.state.tr,k=E.selection.from,x=E.selection.to,v="\xA0\xA0";x>k&&(E=E.delete(k,x));let I=Math.max(0,Math.min(E.doc.content.size,k));E=E.insertText(v,I,I);let D=Math.max(0,Math.min(E.doc.content.size,I+v.length));E=E.replaceRangeWith(D,D,N);let z=Math.max(0,Math.min(E.doc.content.size,D+N.nodeSize));E=E.insertText(v,z,z);let U=Math.max(0,Math.min(E.doc.content.size,z+v.length));E=E.setSelection(f.create(E.doc,U)),E=E.setMeta(ue,!0),L.dispatch(E.scrollIntoView());try{let V=new $;V.decoding="async",V.onload=()=>{try{let K=Number(V.naturalWidth||0),X=Number(V.naturalHeight||0);if(!(K>0&&X>0))return;let ne=K/X,fe=Ci(L.state.doc,P);if(typeof fe!="number")return;let oe=L.state.doc.nodeAt(fe);if(!oe||oe.type?.name!=="image"||Number.isFinite(Number(oe.attrs?.aspectRatio))&&Number(oe.attrs.aspectRatio)>0)return;let Se={...oe.attrs,aspectRatio:ne},Ie=L.state.tr.setNodeMarkup(fe,void 0,Se);Ie=Ie.setMeta(ue,!0),L.dispatch(Ie)}catch{}},V.onerror=()=>{},V.src=H}catch{}try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1){Ce("\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E \u0438 \u0431\u0443\u0434\u0435\u0442 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E \u043F\u0440\u0438 \u043F\u043E\u044F\u0432\u043B\u0435\u043D\u0438\u0438 \u0441\u0435\u0442\u0438");return}}catch{}ro(_).then(V=>{let K=String(V?.url||"").trim();if(!K)throw new Error("Upload failed");let X=Ci(L.state.doc,P);if(typeof X!="number")return;let ne=L.state.doc.nodeAt(X);if(!ne||ne.type?.name!=="image")return;let fe={...ne.attrs,src:K,uploadToken:null},oe=L.state.tr.setNodeMarkup(X,void 0,fe);oe=oe.setMeta(ue,!0),L.dispatch(oe),xd(P),Xs(P).catch(()=>{})}).catch(V=>{Ce(V?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435");try{let K=Ci(L.state.doc,P);if(typeof K!="number")return;let X=L.state.doc.nodeAt(K);if(!X||X.type?.name!=="image")return;let ne=String(X.attrs?.title||"").trim(),fe=ne?`${ne} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",oe=String(X.attrs?.alt||_?.name||"image"),Se={...X.attrs,src:H,alt:oe,title:fe,uploadToken:P},Ie=L.state.tr.setNodeMarkup(K,void 0,Se);Ie=Ie.setMeta(ue,!0),L.dispatch(Ie)}catch{}try{Qs(P,String(V?.message||V||"error"))}catch{}})},M=(L,_,P,H)=>{try{if(!(Te?.getState?.(L.state)||null)?.editingSectionId)return!1}catch{return!1}let N=g(P,H);if(!N.length)return!1;_.preventDefault(),_.stopPropagation();for(let E of N)B(L,E);return!0};return[new S({props:{handleDOMEvents:{paste(L,_){let P=_?.clipboardData?.items||null,H=_?.clipboardData?.files||null;return M(L,_,P,H)},drop(L,_){let P=_?.dataTransfer?.items||null,H=_?.dataTransfer?.files||null;return M(L,_,P,H)}}},view(L){return{update(_,P){try{let H=Te?.getState?.(P)||{},N=Te?.getState?.(_.state)||{},E=H.editingSectionId||null,k=N.editingSectionId||null;if(E&&!k){let x=String(E||"").trim(),v=At||u.articleId||null;if(!x||!v)return;let I=!1;try{let D=ct(_.state.doc,x),z=typeof D=="number"?_.state.doc.nodeAt(D):null;z?.type?.name==="outlineSection"&&(I=!!z.attrs?.collapsed)}catch{}Hd(v,x,I);try{let D=ct(_.state.doc,x),z=typeof D=="number"?_.state.doc.nodeAt(D):null;if(!z||z.type?.name!=="outlineSection")return;let U=!Er.has(x),V=U||xr(_.state.doc,x),K=!1;if(V){let ne=z.child(0),fe=z.child(1),oe=ne?.toJSON?ne.toJSON():null,Se=fe?.toJSON?fe.toJSON():null;if(oe&&Se){let Ie=Cd(oe,Se);if(Ie>Li){Ce(`\u0411\u043B\u043E\u043A \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 (${Math.ceil(Ie/1024)} KB). \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C: ${Math.ceil(Li/1024)} KB. \u0420\u0430\u0437\u0431\u0435\u0439\u0442\u0435 \u0431\u043B\u043E\u043A \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E.`);try{let De=_.state.tr.setMeta(ue,!0);De=De.setMeta(Te,{type:"enter",sectionId:x}),_.dispatch(De)}catch{}return}let Re=Date.now(),Ye=vd(v,x);try{at("outline.enqueue.section_upsert_content",{articleId:v,sectionId:x,seq:Ye,bytes:Ie,reason:U?"exit_edit_mode_new_section":"exit_edit_mode"})}catch{}K=!0,jt("section_upsert_content",{articleId:v,payload:{sectionId:x,headingJson:oe,bodyJson:Se,seq:Ye,clientQueuedAt:Re},coalesceKey:`content:${v}:${x}`})}}let X=!1;if(U||Ln||Ot){let ne=Mo(_.state.doc);if(ne.length){let fe=null;try{fe=ne.filter(oe=>oe&&(oe.parentId==null||oe.parentId==="")&&Number(oe.position)>=0).sort((oe,Se)=>Number(oe.position)-Number(Se.position)).slice(0,3).map(oe=>String(oe.sectionId||""))}catch{fe=null}try{at("outline.enqueue.structure_snapshot",{articleId:v,nodesCount:ne.length,reason:U?"exit_edit_mode_new_section":"exit_edit_mode",rootFirst:fe})}catch{}jt("structure_snapshot",{articleId:v,payload:{nodes:ne},coalesceKey:`structure:${v}`}),X=!0}Ln=!1,Ot&&(clearTimeout(Ot),Ot=null)}try{(K||U)&&(Er.set(x,Hi(z)),vr.delete(x))}catch{}try{K&&ae&&!ae.isDestroyed&&ae.view===_&&zd(ae,_.state.doc,x)}catch{}(K||X)&&jn("\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438 \u043D\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044E")}catch{}}}catch{}}}}})]}}),Qt=d.create({name:"outlineImageResize",addProseMirrorPlugins(){return[new S({view(y){let g=null,B=(P,H)=>{try{if((y.state.selection?.node||null)?.type?.name==="image"&&typeof y.state.selection.from=="number")return y.state.selection.from;let E=U=>{if(typeof U!="number")return null;let V=[U,U-1,U+1,U-2,U+2];for(let K of V){if(K<0)continue;if(y.state.doc.nodeAt(K)?.type?.name==="image")return K}return null},k=P?.querySelector?.("img")||null,x=E(y.posAtDOM(P,0));if(typeof x=="number")return x;let v=k?E(y.posAtDOM(k,0)):null;if(typeof v=="number")return v;let I=H&&typeof H.clientX=="number"&&typeof H.clientY=="number"?{left:H.clientX,top:H.clientY}:null,D=I?y.posAtCoords(I):null,z=D&&typeof D.pos=="number"?E(D.pos):null;return typeof z=="number"?z:null}catch{return null}},M=P=>{if(P.button!==0)return;let H=P.target?.closest?.(".resizable-image__handle");if(!H)return;let N=H.closest(".resizable-image");if(!N||!y.dom.contains(N)||!(Te?.getState?.(y.state)||null)?.editingSectionId)return;let k=B(N,P);if(typeof k!="number")return;let x=y.state.doc.nodeAt(k);if(!x||x.type?.name!=="image")return;P.preventDefault(),P.stopPropagation();let v=N.getBoundingClientRect();g={pos:k,startWidth:v.width,startX:P.clientX,wrapper:N,lastWidth:v.width},N.classList.add("resizable-image--resizing")},L=P=>{if(!g)return;P.preventDefault();let H=P.clientX-g.startX,E=parseFloat(getComputedStyle(document.documentElement).fontSize)||16,k=Math.max(E,document.documentElement.clientWidth-32),x=10,v=g.startWidth+H;v=Math.max(E,Math.min(v,k)),v=Math.round(v/x)*x,v=Math.max(E,Math.min(v,k)),g.lastWidth=v,g.wrapper.style.width=`${Math.round(v)}px`},_=()=>{if(!g)return;let{pos:P,wrapper:H}=g;H.classList.remove("resizable-image--resizing");let N=y.state.doc.nodeAt(P)?.type?.name==="image"?P:B(H,null),E=typeof N=="number"?y.state.doc.nodeAt(N):null;if(E&&E.type?.name==="image"){let x=Number(g.lastWidth||0)||H.getBoundingClientRect().width,v=Math.max(1,Math.round(x/10)*10),I={...E.attrs,width:v},D=y.state.tr.setNodeMarkup(N,void 0,I);D=D.setMeta(ue,!0),y.dispatch(D)}g=null};return y.dom.addEventListener("pointerdown",M),document.addEventListener("pointermove",L),document.addEventListener("pointerup",_),document.addEventListener("pointercancel",_),{destroy(){y.dom.removeEventListener("pointerdown",M),document.removeEventListener("pointermove",L),document.removeEventListener("pointerup",_),document.removeEventListener("pointercancel",_)}}}})]}}),sn=d.create({name:"outlineImagePreview",addProseMirrorPlugins(){return[new S({props:{handleDOMEvents:{click(y,g){try{if((Te?.getState?.(y.state)||null)?.editingSectionId)return!1;let M=g?.target?.closest?.("img");return M?g.target?.closest?.(".resizable-image__handle")?(g.preventDefault(),!0):(g.preventDefault(),so(M.src,M.alt||""),!0):!1}catch{return!1}}}}})]}}),pn=d.create({name:"outlineMarkdownTablePaste",addProseMirrorPlugins(){let y=(g,B)=>{try{if(!(Te?.getState?.(g.state)||null)?.editingSectionId)return!1;let L=B?.clipboardData?.getData?.("text/plain")||"";if(un("paste: text/plain",{len:L.length,sample:L.slice(0,200)}),!L)return!1;let _=Aa(L),P=Ar(_);un("paste: parsed",{ok:!!P,lines:_});let H=P?null:Ir(_);if(!P&&!H)return!1;let N=P?{header:P.header,rows:P.rows,withHeader:!0}:{header:null,rows:H.rows,withHeader:!1},E=null;try{E=sr(g.state.schema,N)}catch(x){return un("paste: buildTableNode error",{message:String(x?.message||x||""),stack:String(x?.stack||""),schemaNodes:Object.keys(g.state.schema?.nodes||{})}),!1}if(un("paste: tableNode",{ok:!!E,schemaNodes:ya()?Object.keys(g.state.schema?.nodes||{}):void 0}),!E)return!1;B.preventDefault(),B.stopPropagation();let k=g.state.tr;g.state.selection.empty||(k=k.deleteSelection());try{k=k.replaceSelectionWith(E,!1)}catch(x){return un("paste: replaceSelectionWith error",{message:String(x?.message||x||""),stack:String(x?.stack||""),selection:{from:g.state.selection?.from,to:g.state.selection?.to,empty:g.state.selection?.empty,$fromParent:g.state.selection?.$from?.parent?.type?.name}}),!1}return k=k.setMeta(ue,!0),g.dispatch(k.scrollIntoView()),!0}catch(M){return un("paste: unexpected error",{message:String(M?.message||M||""),stack:String(M?.stack||"")}),!1}};return[new S({appendTransaction(g,B,M){try{let L=g?.some?.(k=>k?.docChanged),_=null;if(Te)for(let k of g||[]){let x=k?.getMeta?.(Te)||null;if(x?.type==="enter"&&x?.sectionId){_=String(x.sectionId);break}}let P=!!_;if(!L&&!P||g.some(k=>k.getMeta?.(ue)))return null;let H=Te?.getState?.(M)||null,N=_||H?.editingSectionId||null;if(!N)return null;un("appendTransaction: try convert",{didDocChange:L,didEnterEditMode:P,sectionId:N});let E=Gp(M,N);if(E)return E;if(ya()){let k=ct(M.doc,N),x=typeof k=="number"?M.doc.nodeAt(k):null,v=x?x.child(1):null,I=v?v.textContent:"";String(I||"").includes("|")&&un("appendTransaction: saw pipes but no conversion",{sectionId:N})}return vm(M,N)}catch{return null}},props:{handlePaste(g,B){return y(g,B)},handleDOMEvents:{paste(g,B){return y(g,B)}}}})]}}),kn=d.create({name:"outlineStructuredSectionPaste",addProseMirrorPlugins(){let y=_=>{let P=String(_||"").trim();if(!P)return{sections:[],startsWithHeading:!1,headingCount:0};if(!/<h[1-6][\s>]/i.test(P))return{sections:[],startsWithHeading:!1,headingCount:0};let H=null;try{H=new DOMParser().parseFromString(P,"text/html")}catch{return{sections:[],startsWithHeading:!1,headingCount:0}}let N=H?.body;if(!N)return{sections:[],startsWithHeading:!1,headingCount:0};let E=!1;try{let I=Array.from(N.childNodes||[]).find(D=>D?.nodeType===1&&String(D?.textContent||"").trim());E=!!(I&&/^H[1-6]$/.test(String(I.nodeName||"")))}catch{E=!1}let k=[],x=null,v=()=>{if(!x)return;let I=document.createElement("div");for(let z of x.nodes)try{I.appendChild(z.cloneNode(!0))}catch{}let D=String(I.innerText||I.textContent||"").trimEnd();k.push({level:x.level,title:x.title,bodyText:D}),x=null};for(let I of Array.from(N.childNodes||[])){let U=(I?.nodeType===1?String(I.nodeName||"").toUpperCase():"").match(/^H([1-6])$/);if(U){v();let V=Number(U[1]),K=String(I.textContent||"").trim();if(!K)continue;x={level:V,title:K,nodes:[]};continue}x&&x.nodes.push(I)}return v(),{sections:k,startsWithHeading:E,headingCount:k.length}},g=_=>{let P=_?.selection?.$from;if(!P)return null;for(let H=P.depth;H>0;H-=1)if(P.node(H)?.type?.name==="outlineSection")return P.before(H);return null},B=(_,P)=>{let H=String(P||"").replace(/\r\n/g,`
`).trimEnd(),N=_.nodes.paragraph;if(!N)return[];let E=_.nodes.hardBreak||_.nodes.hard_break||null,k=I=>{let D=String(I||"").split(`
`),z=[];for(let U=0;U<D.length;U+=1){let V=D[U];U>0&&E&&z.push(E.create()),V&&z.push(_.text(V))}return N.create({},z)};if(!H.trim())return[N.create({},[])];let x=H.split(/\n{2,}/),v=[];for(let I of x){let D=String(I||"").trimEnd();v.push(k(D))}return v.length?v:[N.create({},[])]},M=(_,P)=>{let H=_.nodes.outlineHeading.create({},P.title?[_.text(P.title)]:[]),N=B(_,P.bodyText),E=_.nodes.outlineBody.create({},N),k=(P.children||[]).map(v=>M(_,v)),x=_.nodes.outlineChildren.create({},k);return _.nodes.outlineSection.create({id:P.id,collapsed:!1},[H,E,x])},L=(_,P)=>{try{if(!(Te?.getState?.(_.state)||null)?.editingSectionId)return!1;let N=P?.clipboardData?.getData?.("text/html")||"",E=P?.clipboardData?.getData?.("text/plain")||"",k=N?y(N):{sections:[],startsWithHeading:!1,headingCount:0},x=!k.sections.length&&E?ea(E):{sections:[],startsWithHeading:!1,headingCount:0},v=k.sections.length?k:x;if(!v.sections.length||!(v.startsWithHeading||v.sections.length>=2))return!1;P.preventDefault(),P.stopPropagation();let D=g(_.state);if(typeof D!="number")return!1;let z=_.state.doc.nodeAt(D);if(!z||z.type?.name!=="outlineSection")return!1;let U=jl(v.sections,{makeId:()=>Kt()});if(!U.length)return!1;let V=_.state.schema,K=U.map(fe=>M(V,fe)),X=_.state.tr,ne=D+z.nodeSize;for(let fe of K)X=X.insert(ne,fe),ne+=fe.nodeSize;return X=X.setMeta(ue,!0),_.dispatch(X.scrollIntoView()),!0}catch{return!1}};return[new S({props:{handlePaste(_,P){return L(_,P)},handleDOMEvents:{paste(_,P){return L(_,P)}}}})]}}),_n=(y="")=>{let g=String(y||"").trim();return g?g.startsWith("app:/")||g.startsWith("disk:/")?`/api/yandex/disk/file?path=${encodeURIComponent(g)}`:g:""},Dn=d.create({name:"outlineAttachmentUpload",addProseMirrorPlugins(){let y=P=>{let H=String(P?.type||"");return!(H&&H.startsWith("image/"))},g=(P,H)=>{let N=[];try{let E=[];if(H&&typeof H.length=="number")E.push(...Array.from(H||[]));else if(P&&typeof P.length=="number")for(let k of Array.from(P||[])){if(!k||k.kind!=="file")continue;let x=k.getAsFile?.();x&&E.push(x)}for(let k of E)k&&y(k)&&N.push(k)}catch{}return N},B=P=>`pending-attachment:${String(P||"")}`,M=(P,H)=>{let N=B(H),E=P?.type?.schema?.marks?.link||null;if(!E)return null;let k=null;return P.descendants((x,v)=>{if(k)return!1;!x||!x.isText||!(Array.isArray(x.marks)?x.marks:[]).find(z=>z?.type===E&&String(z?.attrs?.href||"")===N)||(k={from:v,to:v+x.nodeSize})}),k},L=(P,H)=>{let N=P?.state?.schema,E=N?.marks?.link||null;if(!N||!E){Ce("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u0438\u0435: \u043D\u0435\u0442 \u0441\u0445\u0435\u043C\u044B \u0441\u0441\u044B\u043B\u043E\u043A");return}if(!u.articleId){Ce("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}let k=Kt(),x=B(k),v=String(H?.name||"\u0444\u0430\u0439\u043B"),I=`${v} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430...)`,{from:D,to:z}=P.state.selection,U=P.state.tr.insertText(I,D,z);U=U.addMark(D,D+I.length,E.create({href:x})),U=U.setMeta(ue,!0),P.dispatch(U.scrollIntoView());let V=null;try{V=(Te?.getState?.(P.state)||null)?.editingSectionId||null}catch{V=null}jo(u.articleId,H,{sectionId:V}).then(K=>{let X=String(K?.storedPath||K?.url||K?.path||"").trim();if(!X)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443 \u043D\u0430 \u0444\u0430\u0439\u043B");let ne=String(K?.originalName||H?.name||"\u0444\u0430\u0439\u043B"),fe=M(P.state.doc,k);if(!fe)return;let oe=P.state.tr.insertText(ne,fe.from,fe.to);oe=oe.addMark(fe.from,fe.from+ne.length,E.create({href:X})),oe=oe.setMeta(ue,!0),P.dispatch(oe)}).catch(K=>{let X=M(P.state.doc,k);if(X){let ne=`${v} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`,fe=P.state.tr.insertText(ne,X.from,X.to);fe=fe.setMeta(ue,!0),P.dispatch(fe)}Ce(K?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u043D\u0430 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A")})},_=(P,H,N,E)=>{let k=g(N,E);if(!k.length)return!1;H.preventDefault(),H.stopPropagation();try{if(!(Te?.getState?.(P.state)||null)?.editingSectionId)return Yr(),!0}catch{return Yr(),!0}for(let x of k)L(P,x);return!0};return[new S({props:{handleDOMEvents:{drop(P,H){let N=H?.dataTransfer?.items||null,E=H?.dataTransfer?.files||null;return _(P,H,N,E)},paste(P,H){let N=H?.clipboardData?.items||null,E=H?.clipboardData?.files||null;return _(P,H,N,E)}}}})]}}),En=l.create({name:"doc",topNode:!0,content:"outlineSection+"}),vn=l.create({name:"outlineChildren",content:"outlineSection*",defining:!0,renderHTML(){return["div",{class:"outline-children","data-outline-children":"true"},0]},parseHTML(){return[{tag:"div[data-outline-children]"}]},addNodeView(){return({node:y})=>{let g=document.createElement("div");g.className="outline-children",g.setAttribute("data-outline-children","true");let B=M=>{let L=!M||M.childCount===0;g.setAttribute("data-empty",L?"true":"false")};return B(y),{dom:g,contentDOM:g,update(M){return!M||M.type?.name!=="outlineChildren"?!1:(B(M),!0)}}}}}),Ct=y=>{try{if(!y||y.childCount===0)return!0;let g=!1;return y.descendants(B=>{if(g)return!1;let M=B?.type?.name;return M==="image"||M==="table"||B.isText&&String(B.text||"").replace(/\u00a0/g," ").trim()?(g=!0,!1):!0}),!g}catch{return!1}},zt=l.create({name:"outlineBody",content:"block*",defining:!0,renderHTML(){return["div",{class:"outline-body","data-outline-body":"true"},0]},parseHTML(){return[{tag:"div[data-outline-body]"}]},addNodeView(){return({node:y})=>{let g=document.createElement("div");g.className="outline-body",g.setAttribute("data-outline-body","true");let B=M=>{let L=Ct(M);g.setAttribute("data-empty",L?"true":"false")};return B(y),{dom:g,contentDOM:g,update(M){return!M||M.type?.name!=="outlineBody"?!1:(B(M),!0)}}}}}),yt=l.create({name:"outlineHeading",content:"inline*",defining:!0,renderHTML(){return["div",{class:"outline-heading","data-outline-heading":"true"},0]},parseHTML(){return[{tag:"div[data-outline-heading]"}]},addNodeView(){return({editor:y,getPos:g,node:B})=>{let M=document.createElement("div");M.className="outline-heading",M.setAttribute("data-outline-heading","true");let L=document.createElement("button");L.type="button",L.className="outline-heading__toggle",L.title="\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C/\u0440\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C (Ctrl+\u2190/\u2192), \u0441 \u0434\u0435\u0442\u044C\u043C\u0438 (Ctrl+\u2191/\u2193)",L.setAttribute("aria-label","\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C/\u0440\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C");let _=document.createElement("div");_.className="outline-heading__content";let P=document.createElement("button");P.type="button",P.className="outline-heading__select",P.setAttribute("role","checkbox"),P.setAttribute("aria-checked","false"),P.setAttribute("aria-label","\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0431\u043B\u043E\u043A"),P.textContent="\u2713",P.addEventListener("pointerdown",N=>{N.preventDefault()}),P.addEventListener("click",N=>{if(N.preventDefault(),N.stopPropagation(),!Vn)return;let E=typeof g=="function"?g():null;if(typeof E!="number")return;let k=E-1,x=y.state.doc.nodeAt(k),v=String(x?.attrs?.id||"").trim();v&&Dp(v)});let H=()=>{let N=typeof g=="function"?g():null;if(typeof N!="number")return;let E=N-1,k=y.state.doc.nodeAt(E),x=String(k?.attrs?.id||"");x&&M.setAttribute("data-section-id",x),M.dataset.empty=B.content.size===0?"true":"false";let v=y.state.doc.resolve(Math.max(0,E+1)),I=0;for(let z=v.depth;z>=0;z-=1)v.node(z)?.type?.name==="outlineSection"&&(I+=1);M.dataset.depth=String(Math.min(6,Math.max(1,I||1)));let D=Vn&&x&&lr.has(x);P.setAttribute("aria-checked",D?"true":"false"),P.style.display=Vn?"inline-flex":"none"};return L.addEventListener("click",N=>{N.preventDefault(),N.stopPropagation();let E=typeof g=="function"?g():null;if(typeof E!="number")return;let k=E-1,x=y.state.doc.nodeAt(k);if(!x)return;let v=!x.attrs?.collapsed,I=y.state.tr.setNodeMarkup(k,void 0,{...x.attrs,collapsed:v});try{v&&Te&&(Te.getState(y.state)||{}).editingSectionId&&(I=I.setMeta(Te,{type:"exit"}))}catch{}I.setMeta(ue,!0),y.view.dispatch(I),y.view.focus()}),M.appendChild(L),M.appendChild(_),M.appendChild(P),H(),{dom:M,contentDOM:_,update:N=>N.type.name!=="outlineHeading"?!1:(B=N,H(),!0)}}}}),ut=l.create({name:"outlineSection",group:"block",content:"outlineHeading outlineBody outlineChildren",defining:!0,isolating:!0,draggable:!0,addAttributes(){return{collapsed:{default:!1}}},renderHTML({node:y,HTMLAttributes:g}){let B={...g,class:`outline-section${g?.class?` ${g.class}`:""}`,"data-outline-section":"true","data-section-id":y.attrs.id||"","data-collapsed":y.attrs.collapsed?"true":"false"};return["div",h(B),0]},parseHTML(){return[{tag:"div[data-outline-section]"}]}}),Tt=y=>{if(!y)return!0;if((y.textContent||"").replace(/\u00a0/g," ").trim())return!1;if(y.childCount)for(let B=0;B<y.childCount;B+=1){let M=y.child(B);if(M.type?.name!=="paragraph"||(M.textContent||"").replace(/\u00a0/g," ").trim())return!1}return!0},Zt=y=>{if(!y)return!0;try{let g=y.child(0),B=y.child(1),M=y.child(2);return Tt(g)&&Tt(B)&&(!M||M.childCount===0)}catch{return!0}},G=(y,g,B)=>{let M=y.doc.nodeAt(B);if(!M)return!1;let L=String(M.attrs?.id||"").trim(),_=y.doc.resolve(B),P=_.index(),H=_.parent;if(!H)return!1;if(H.childCount<=1){if(H.type?.name==="doc"){let V=y.doc.type.schema,K=V.nodes.outlineSection.create({...M.attrs,collapsed:!1},[V.nodes.outlineHeading.create({},[]),V.nodes.outlineBody.create({},[V.nodes.paragraph.create({},[])]),V.nodes.outlineChildren.create({},[])]),X=y.tr.replaceWith(B,B+M.nodeSize,K);X=X.setMeta(ue,!0);let ne=K.child(0),fe=B+1+ne.nodeSize;return g(X.setSelection(f.near(X.doc.resolve(fe+2),1)).scrollIntoView()),!0}L&&jr(L);let z=null;try{for(let V=_.depth;V>0;V-=1)if(_.node(V)?.type?.name==="outlineSection"){z=_.before(V);break}}catch{z=null}let U=y.tr.delete(B,B+M.nodeSize);U=U.setMeta(ue,!0);try{if(typeof z=="number"){let V=U.mapping.map(z,-1),K=U.doc.nodeAt(V);if(K&&K.type?.name==="outlineSection"){let X=K.child(0),ne=K.child(1),fe=V+1+X.nodeSize;if(!ne.childCount){let oe=U.doc.type.schema;U=U.insert(fe+1,oe.nodes.paragraph.create({},[]))}U=U.setSelection(f.near(U.doc.resolve(fe+2),1))}}}catch{}return g(U.scrollIntoView()),!0}let N=P>0,E=P<H.childCount-1,k=N?H.child(P-1):null,x=N?B-k.nodeSize:null,v=B+M.nodeSize;L&&jr(L);let I=y.tr.delete(B,B+M.nodeSize),D=(z,U)=>{try{let V=z.doc.nodeAt(U);if(!V||V.type?.name!=="outlineSection")return z;let K=V.child(0),ne=U+1+K.nodeSize-1;return z.setSelection(f.near(z.doc.resolve(ne),-1))}catch{return z}};if(E){let z=B<I.doc.content.size?B:v;I.doc.nodeAt(z)&&(I=D(I,z))}else N&&typeof x=="number"&&I.doc.nodeAt(x)&&(I=D(I,x));return I=I.setMeta(ue,!0),g(I.scrollIntoView()),!0},ie=(y,g,B)=>{let M=y.doc.nodeAt(B);if(!M)return!1;let L=y.doc.resolve(B),_=L.index(),P=L.parent;if(!P||_<=0)return!1;let H=P.child(_-1),N=B-H.nodeSize,E=M.child(0),k=M.child(1),x=M.child(2),v=y.tr.delete(B,B+M.nodeSize),I=v.doc.nodeAt(N);if(!I)return v=v.setMeta(ue,!0),g(v.scrollIntoView()),!0;let D=v.doc.type.schema,z=I.child(0),U=I.child(1),V=I.child(2),K=[],X=(E?.textContent||"").replace(/\u00a0/g," ").trim();X&&K.push(D.nodes.paragraph.create({},[D.text(X)])),k?.content?.forEach?.(Re=>{K.push(Re)});let ne=K.length?D.nodes.outlineBody.create({},K).content:null,fe=ne?U.content.append(ne):U.content,oe=V.content.append(x.content),Se=D.nodes.outlineSection.create(I.attrs,[z,D.nodes.outlineBody.create({},fe),D.nodes.outlineChildren.create({},oe)]);v=v.replaceWith(N,N+I.nodeSize,Se);let Ie=v.doc.nodeAt(N);if(Ie){let Re=Ie.child(0),Ye=Ie.child(1),Ke=N+1+Re.nodeSize+Ye.nodeSize-1;v=v.setSelection(f.near(v.doc.resolve(Ke),-1))}return v=v.setMeta(ue,!0),g(v.scrollIntoView()),!0},be=(y,g,B)=>{let M=y.doc.nodeAt(B);if(!M)return!1;let L=y.selection.$from,_=null,P=null;for(let Re=L.depth;Re>0;Re-=1)if(L.node(Re)?.type?.name==="outlineSection")if(_===null)_=Re;else{P=Re;break}if(_===null||P===null)return!1;let H=L.before(P);if(!y.doc.nodeAt(H))return!1;let E=y.doc.type.schema,k=M.child(0),x=M.child(1),v=M.child(2),I=y.tr.delete(B,B+M.nodeSize),D=I.doc.nodeAt(H);if(!D)return I=I.setMeta(ue,!0),g(I.scrollIntoView()),!0;let z=D.child(0),U=D.child(1),V=D.child(2),K=[],X=(k?.textContent||"").replace(/\u00a0/g," ").trim();X&&K.push(E.nodes.paragraph.create({},[E.text(X)])),x?.content?.forEach?.(Re=>{K.push(Re)});let ne=K.length?E.nodes.outlineBody.create({},K).content:null,fe=ne?U.content.append(ne):U.content,oe=v.content.append(V.content),Se=E.nodes.outlineSection.create({...D.attrs,collapsed:!1},[z,E.nodes.outlineBody.create({},fe),E.nodes.outlineChildren.create({},oe)]);I=I.replaceWith(H,H+D.nodeSize,Se);let Ie=I.doc.nodeAt(H);if(Ie){let Re=Ie.child(0),Ye=Ie.child(1),Ke=H+1+Re.nodeSize+Ye.nodeSize-1;I=I.setSelection(f.near(I.doc.resolve(Ke),-1))}return I=I.setMeta(ue,!0),g(I.scrollIntoView()),!0},pe=d.create({name:"outlineCommands",addKeyboardShortcuts(){let y=(F,ee)=>{for(let W=ee.depth;W>0;W-=1)if(ee.node(W)?.type?.name==="outlineSection")return ee.before(W);return null},g=(F,ee)=>{for(let W=F.depth;W>0;W-=1)if(F.node(W)?.type?.name===ee)return W;return null},B=F=>{if(!F)return!0;if((F.textContent||"").replace(/\u00a0/g," ").trim())return!1;if(F.childCount)for(let W=0;W<F.childCount;W+=1){let j=F.child(W);if(j.type?.name!=="paragraph"||(j.textContent||"").replace(/\u00a0/g," ").trim())return!1}return!0},M=(F,ee)=>{let{selection:W}=F;if(!W||W.empty)return!1;let j=y(F.doc,W.$from),ce=y(F.doc,W.$to);if(typeof j!="number"||typeof ce!="number"||j===ce||g(W.$from,"outlineBody")===null||W.$to.parent?.type?.name!=="outlineHeading"||W.$to.parentOffset!==0)return!1;let he=F.doc.nodeAt(j);if(!he)return!1;let xe=he.child(0),de=he.child(1),Me=j+1+xe.nodeSize,we=Me+1,He=Me+de.nodeSize-1,Oe=Math.max(W.from,we),Le=Math.min(W.to,He);if(Le<Oe)return!0;let Be=F.tr.delete(Oe,Le),_e=Be.doc.nodeAt(Me);if(_e&&_e.content.size===0){let Ve=Be.doc.type.schema;Be=Be.insert(we,Ve.nodes.paragraph.create({},[]))}return Be=Be.setSelection(f.near(Be.doc.resolve(we+1),1)),ee(Be.scrollIntoView()),!0},L=(F,ee,W={})=>{let{selection:j}=F;if(!j||j.empty)return!1;let ce=y(F.doc,j.$from),ge=y(F.doc,j.$to);if(typeof ce!="number"||typeof ge!="number"||ce!==ge)return!1;let he=g(j.$from,"outlineHeading"),xe=g(j.$to,"outlineHeading");if(he===null||xe===null)return!1;let de=F.doc.nodeAt(ce);if(!de)return!1;let Me=de.child(0),we=ce+1,He=we+1,Oe=we+Me.nodeSize-1;if(j.from<He||j.to>Oe)return!1;let Le=Math.max(j.from,He),Be=Math.min(j.to,Oe);if(Be<Le)return!0;if(typeof W.onClipboard=="function")try{let Ve=F.doc.textBetween(Le,Be,`
`,`
`);W.onClipboard(Ve)}catch{}let _e=F.tr.delete(Le,Be);return _e=_e.setSelection(f.near(_e.doc.resolve(He),1)),ee(_e.scrollIntoView()),!0},_=F=>{if(!F)return!0;let ee=F.child(0),W=F.child(1),j=F.child(2);return B(ee)&&B(W)&&(!j||j.childCount===0)},P=(F,ee,W)=>{let j=F.doc.nodeAt(W);if(!j)return!1;let ce=j.child(0),ge=j.child(1),xe=W+1+ce.nodeSize+ge.nodeSize-1,de=F.tr.setSelection(f.near(F.doc.resolve(xe),-1));return ee(de.scrollIntoView()),!0},H=(F,ee,W)=>{let j=F.doc.nodeAt(W);if(!j)return!1;let ce=j.child(0),ge=W+1,he=F.tr.setSelection(f.near(F.doc.resolve(ge+1),1));return ee(he.scrollIntoView()),!0},N=(F,ee,W)=>{let j=F.doc.nodeAt(W);if(!j)return!1;let ce=j.child(0),ge=j.child(1);if(!ge||ge.childCount<=0)return k(F,ee,W);let xe=W+1+ce.nodeSize+1,de=null;try{ge.descendants((He,Oe)=>{He?.isTextblock&&(de=Oe)})}catch{de=null}if(typeof de!="number")return P(F,ee,W);let Me=xe+de+1,we=F.tr.setSelection(f.near(F.doc.resolve(Me),1));return ee(we.scrollIntoView()),!0},E=(F,ee,W)=>{let j=F.doc.nodeAt(W);return j?j.attrs?.collapsed?H(F,ee,W):N(F,ee,W):!1},k=(F,ee,W)=>{let j=F.doc.nodeAt(W);if(!j)return!1;let ce=j.child(0),ge=j.child(1),he=W+1+ce.nodeSize,xe=F.tr;if(!ge.childCount){let de=F.doc.type.schema;xe=xe.insert(he+1,de.nodes.paragraph.create({},[]))}return xe=xe.setSelection(f.near(xe.doc.resolve(he+2),1)),ee(xe.scrollIntoView()),!0},x=(F,ee,W)=>{let j=F.doc.nodeAt(W);if(!j)return!1;let ce=j.child(0),ge=j.child(1);if(!!j.attrs?.collapsed){let He=W+1+ce.nodeSize-1,Oe=F.tr.setSelection(f.near(F.doc.resolve(He),-1));return ee(Oe),!0}let de=W+1+ce.nodeSize+ge.nodeSize-1,Me=F.tr.setSelection(f.near(F.doc.resolve(de),-1));return ee(Me),!0},v=(F,ee)=>{try{let W=F.resolve(Math.min(F.content.size,Math.max(0,ee+1)));for(let j=W.depth;j>0;j-=1){let ce=W.node(j);if(!(ce?.type?.name!=="outlineSection"||W.before(j)===ee)&&ce.attrs?.collapsed)return!1}return!0}catch{return!0}},I=(F,ee)=>{let W=null;return F.nodesBetween(0,ee,(j,ce)=>{if(ce>=ee)return!1;j?.type?.name==="outlineSection"&&v(F,ce)&&(W=ce)}),W},D=(F,ee,W)=>{let j=F.doc.nodeAt(W);if(!j)return!1;let ce=String(j.attrs?.id||"").trim(),ge=F.doc.resolve(W),he=ge.index(),xe=ge.parent;if(!xe)return!1;if(xe.childCount<=1){if(xe.type?.name==="doc"){let _e=F.doc.type.schema,Ve=_e.nodes.outlineSection.create({...j.attrs,collapsed:!1},[_e.nodes.outlineHeading.create({},[]),_e.nodes.outlineBody.create({},[_e.nodes.paragraph.create({},[])]),_e.nodes.outlineChildren.create({},[])]),rt=F.tr.replaceWith(W,W+j.nodeSize,Ve);rt=rt.setMeta(ue,!0);let Qe=Ve.child(0),ot=W+1+Qe.nodeSize;return ee(rt.setSelection(f.near(rt.doc.resolve(ot+2),1)).scrollIntoView()),!0}let Le=null;try{for(let _e=ge.depth;_e>0;_e-=1)if(ge.node(_e)?.type?.name==="outlineSection"){Le=ge.before(_e);break}}catch{Le=null}let Be=F.tr.delete(W,W+j.nodeSize);Be=Be.setMeta(ue,!0);try{if(typeof Le=="number"){let _e=Be.mapping.map(Le,-1),Ve=Be.doc.nodeAt(_e);if(Ve&&Ve.type?.name==="outlineSection"){let rt=Ve.child(0),Qe=Ve.child(1),ot=_e+1+rt.nodeSize;if(!Qe.childCount){let mt=Be.doc.type.schema;Be=Be.insert(ot+1,mt.nodes.paragraph.create({},[]))}Be=Be.setSelection(f.near(Be.doc.resolve(ot+2),1))}}}catch{}return ee(Be.scrollIntoView()),!0}ce&&jr(ce);let de=he>0,Me=de?xe.child(he-1):null,we=de?W-Me.nodeSize:null,He=W+j.nodeSize,Oe=F.tr.delete(W,W+j.nodeSize);if(de&&typeof we=="number"){let Le=Oe.doc.nodeAt(we);if(Le){let Be=Le.child(0),_e=Le.child(1),Ve=we+1+Be.nodeSize;if(!_e.childCount){let rt=Oe.doc.type.schema;Oe=Oe.insert(Ve+1,rt.nodes.paragraph.create({},[]))}Oe=Oe.setSelection(f.near(Oe.doc.resolve(Ve+2),1))}}else{let Le=W<Oe.doc.content.size?W:He,Be=Oe.doc.nodeAt(Le);if(Be){let _e=Be.child(0),Ve=Be.child(1),rt=Le+1+_e.nodeSize;if(!Ve.childCount){let Qe=Oe.doc.type.schema;Oe=Oe.insert(rt+1,Qe.nodes.paragraph.create({},[]))}Oe=Oe.setSelection(f.near(Oe.doc.resolve(rt+2),1))}}return Oe=Oe.setMeta(ue,!0),ee(Oe.scrollIntoView()),!0},z=(F,ee,W)=>{let j=F.doc.nodeAt(W);if(!j)return!1;let ce=String(j.attrs?.id||"").trim(),ge=F.doc.resolve(W),he=ge.index(),xe=ge.parent;if(!xe||he<=0)return!1;ce&&jr(ce);let de=xe.child(he-1),Me=W-de.nodeSize,we=j.child(0),He=j.child(1),Oe=j.child(2),Le=F.tr.delete(W,W+j.nodeSize),Be=Le.doc.nodeAt(Me);if(!Be)return Le=Le.setMeta(ue,!0),ee(Le.scrollIntoView()),!0;let _e=Le.doc.type.schema,Ve=Be.child(0),rt=Be.child(1),Qe=Be.child(2),ot=[],mt=(we?.textContent||"").replace(/\u00a0/g," ").trim();mt&&ot.push(_e.nodes.paragraph.create({},[_e.text(mt)])),He?.content?.forEach?.(It=>{ot.push(It)});let wt=ot.length?_e.nodes.outlineBody.create({},ot).content:null,yn=wt?rt.content.append(wt):rt.content,Ht=Qe.content.append(Oe.content),bn=_e.nodes.outlineSection.create(Be.attrs,[Ve,_e.nodes.outlineBody.create({},yn),_e.nodes.outlineChildren.create({},Ht)]);Le=Le.replaceWith(Me,Me+Be.nodeSize,bn);let lt=Le.doc.nodeAt(Me);if(lt){let It=lt.child(0),Cn=lt.child(1),Pt=Me+1+It.nodeSize+Cn.nodeSize-1;Le=Le.setSelection(f.near(Le.doc.resolve(Pt),-1))}return Le=Le.setMeta(ue,!0),ee(Le.scrollIntoView()),!0},U=(F,ee,W)=>{let j=F.doc.nodeAt(W);if(!j)return!1;let ce=String(j.attrs?.id||"").trim(),ge=F.selection.$from,he=null,xe=null;for(let It=ge.depth;It>0;It-=1)if(ge.node(It)?.type?.name==="outlineSection")if(he===null)he=It;else{xe=It;break}if(he===null||xe===null)return!1;let de=ge.before(xe);if(!F.doc.nodeAt(de))return!1;let we=F.doc.type.schema,He=j.child(0),Oe=j.child(1),Le=j.child(2);ce&&jr(ce);let Be=F.tr.delete(W,W+j.nodeSize),_e=Be.doc.nodeAt(de);if(!_e)return Be=Be.setMeta(ue,!0),ee(Be.scrollIntoView()),!0;let Ve=_e.child(0),rt=_e.child(1),Qe=_e.child(2),ot=[],mt=(He?.textContent||"").replace(/\u00a0/g," ").trim();mt&&ot.push(we.nodes.paragraph.create({},[we.text(mt)])),Oe?.content?.forEach?.(It=>{ot.push(It)});let wt=ot.length?we.nodes.outlineBody.create({},ot).content:null,yn=wt?rt.content.append(wt):rt.content,Ht=Le.content.append(Qe.content),bn=we.nodes.outlineSection.create({..._e.attrs,collapsed:!1},[Ve,we.nodes.outlineBody.create({},yn),we.nodes.outlineChildren.create({},Ht)]);Be=Be.replaceWith(de,de+_e.nodeSize,bn);let lt=Be.doc.nodeAt(de);if(lt){let It=lt.child(0),Cn=lt.child(1),Pt=de+1+It.nodeSize+Cn.nodeSize-1;Be=Be.setSelection(f.near(Be.doc.resolve(Pt),-1))}return Be=Be.setMeta(ue,!0),ee(Be.scrollIntoView()),!0},V=(F,ee,W)=>{let j=F.doc.nodeAt(W);if(!j)return!1;let ce=F.doc.resolve(W),ge=ce.index(),he=ce.parent;if(!he||ge>=he.childCount-1)return!1;let xe=W+j.nodeSize,de=F.doc.nodeAt(xe);if(!de||de.type?.name!=="outlineSection")return!1;let Me=F.doc.type.schema,we=j.child(0),He=j.child(1),Oe=j.child(2),Le=de.child(1),Be=de.child(2),_e=He.content.append(Le.content),Ve=Oe.content.append(Be.content),rt=Me.nodes.outlineSection.create({...j.attrs,collapsed:!1},[we,Me.nodes.outlineBody.create({},_e),Me.nodes.outlineChildren.create({},Ve)]),Qe=F.tr;Qe=Qe.delete(xe,xe+de.nodeSize),Qe=Qe.replaceWith(W,W+j.nodeSize,rt);let ot=Qe.doc.nodeAt(W);if(ot){let mt=ot.child(0),wt=ot.child(1),Ht=W+1+mt.nodeSize+wt.nodeSize-1;Qe=Qe.setSelection(f.near(Qe.doc.resolve(Ht),-1))}return Qe=Qe.setMeta(ue,!0),ee(Qe.scrollIntoView()),!0},K=F=>this.editor.commands.command(({state:ee,dispatch:W})=>{let j=Le=>{try{if(typeof CSS<"u"&&CSS&&typeof CSS.escape=="function")return CSS.escape(String(Le||""))}catch{}return String(Le||"").replace(/["\\]/g,"\\$&")},ce=Le=>{try{let Be=Le;for(;Be&&Be!==document.body;){let _e=Be.parentElement;if(!_e)break;let Ve=window.getComputedStyle(_e),rt=String(Ve?.overflowY||"");if((rt==="auto"||rt==="scroll")&&_e.scrollHeight>_e.clientHeight+1)return _e;Be=_e}}catch{}return document.scrollingElement||document.documentElement},ge=Le=>{try{let Be=String(Le||"").trim();if(!Be)return null;let _e=document.querySelector(`.outline-heading[data-section-id="${j(Be)}"]`);if(!_e)return null;let Ve=ce(_e);return{sid:Be,scrollEl:Ve,top:_e.getBoundingClientRect().top}}catch{return null}},he=Le=>{if(!Le)return;let{sid:Be,scrollEl:_e,top:Ve}=Le,rt=()=>{try{let Qe=document.querySelector(`.outline-heading[data-section-id="${j(Be)}"]`);if(!Qe)return;let mt=Qe.getBoundingClientRect().top-Ve;if(!Number.isFinite(mt)||Math.abs(mt)<1)return;_e.scrollTop+=mt}catch{}};try{requestAnimationFrame(()=>requestAnimationFrame(rt))}catch{setTimeout(rt,0)}},xe=y(ee.doc,ee.selection.$from);if(typeof xe!="number")return!1;let de=ee.doc.resolve(xe),Me=de.index(),we=de.parent;if(!we)return!1;let He=ee.doc.nodeAt(xe);if(!He)return!1;let Oe=ge(String(He.attrs?.id||"").trim());if(F==="up"){if(Me>0){let Wn=we.child(Me-1),zn=xe-Wn.nodeSize,_t=ee.tr.delete(xe,xe+He.nodeSize).insert(zn,He).setMeta(ue,!0),dr=f.near(_t.doc.resolve(zn+2),1);return _t.setSelection(dr),W(_t.scrollIntoView()),he(Oe),!0}let Le=Ie(ee.doc,xe);if(typeof Le!="number")return!1;let Be=ee.doc.resolve(Le),_e=Be.index(),Ve=Be.parent;if(!Ve||_e<=0)return!1;let rt=Ve.child(_e-1),Qe=Le-rt.nodeSize,ot=ee.doc.nodeAt(Qe);if(!ot||ot.type?.name!=="outlineSection")return!1;let mt=ot.child(0),wt=ot.child(1),yn=ot.child(2),bn=Qe+1+mt.nodeSize+wt.nodeSize+yn.nodeSize-1,lt=ee.tr.delete(xe,xe+He.nodeSize).setMeta(ue,!0),It=lt.mapping.map(Qe,-1),Cn=lt.mapping.map(bn,-1);lt=lt.insert(Cn,He);let wn=lt.doc.nodeAt(It);wn?.type?.name==="outlineSection"&&wn.attrs?.collapsed&&(lt=lt.setNodeMarkup(It,void 0,{...wn.attrs,collapsed:!1}));let Pt=f.near(lt.doc.resolve(Cn+2),1);return lt.setSelection(Pt),W(lt.scrollIntoView()),he(Oe),!0}if(F==="down"){if(Me<we.childCount-1){let Wn=xe+He.nodeSize,zn=ee.doc.nodeAt(Wn);if(!zn)return!1;let _t=ee.tr.delete(xe,xe+He.nodeSize).setMeta(ue,!0),dr=xe+zn.nodeSize;_t.insert(dr,He);let Lo=f.near(_t.doc.resolve(dr+2),1);return _t.setSelection(Lo),W(_t.scrollIntoView()),he(Oe),!0}let Le=Ie(ee.doc,xe);if(typeof Le!="number")return!1;let Be=ee.doc.nodeAt(Le);if(!Be||Be.type?.name!=="outlineSection")return!1;let _e=ee.doc.resolve(Le),Ve=_e.index(),rt=_e.parent;if(!rt||Ve>=rt.childCount-1)return!1;let Qe=Le+Be.nodeSize,ot=ee.doc.nodeAt(Qe);if(!ot||ot.type?.name!=="outlineSection")return!1;let mt=ot.child(0),wt=ot.child(1),yn=ot.child(2),bn=Qe+1+mt.nodeSize+wt.nodeSize+1,lt=ee.tr.delete(xe,xe+He.nodeSize).setMeta(ue,!0),It=lt.mapping.map(Qe,-1),Cn=lt.mapping.map(bn,-1);lt=lt.insert(Cn,He);let wn=lt.doc.nodeAt(It);wn?.type?.name==="outlineSection"&&wn.attrs?.collapsed&&(lt=lt.setNodeMarkup(It,void 0,{...wn.attrs,collapsed:!1}));let Pt=f.near(lt.doc.resolve(Cn+2),1);return lt.setSelection(Pt),W(lt.scrollIntoView()),he(Oe),!0}return!1}),X=()=>this.editor.commands.command(({state:F,dispatch:ee})=>{let{selection:W}=F;if(!W?.empty)return!1;let{$from:j}=W,ce=y(F.doc,j);if(typeof ce!="number")return!1;let ge=F.doc.nodeAt(ce);if(!ge)return!1;let he=F.doc.type.schema;if(ge.attrs?.collapsed){let Pt=ce+ge.nodeSize,Wn=Kt(),zn=he.nodes.outlineSection.create({id:Wn,collapsed:!1},[he.nodes.outlineHeading.create({},[]),he.nodes.outlineBody.create({},[he.nodes.paragraph.create({},[])]),he.nodes.outlineChildren.create({},[])]),_t=F.tr.insert(Pt,zn);return _t=_t.setSelection(f.create(_t.doc,Pt+2)),_t=_t.setMeta(ue,!0),Te&&(_t=_t.setMeta(Te,{type:"enter",sectionId:Wn})),ee(_t.scrollIntoView()),!0}let xe=he.nodes.outlineChildren.create({},[]),de=Pt=>Pt&&Pt.childCount?Pt:he.nodes.outlineBody.create({},[he.nodes.paragraph.create({},[])]);if(j.parent?.type?.name==="outlineHeading"){let Pt=ge.child(0),Wn=ge.child(1),zn=ge.child(2),_t=j.parentOffset||0,dr=Pt.textBetween(0,Math.max(0,Math.min(_t,Pt.content.size)),"",""),Lo=Pt.textBetween(Math.max(0,Math.min(_t,Pt.content.size)),Pt.content.size,"",""),Vd=he.nodes.outlineHeading.create({},dr?[he.text(dr)]:[]),jd=he.nodes.outlineHeading.create({},Lo?[he.text(Lo)]:[]),Ia=Kt(),ka=he.nodes.outlineSection.create({...ge.attrs,collapsed:!1},[Vd,de(he.nodes.outlineBody.create({},[])),xe]),Jd=he.nodes.outlineSection.create({id:Ia,collapsed:!1},[jd,de(Wn),zn]),Tn=F.tr.replaceWith(ce,ce+ge.nodeSize,ka),Ea=Tn.doc.nodeAt(ce),va=ce+(Ea?Ea.nodeSize:ka.nodeSize);return Tn=Tn.insert(va,Jd),Tn=Tn.setSelection(f.create(Tn.doc,va+2)),Tn=Tn.setMeta(ue,!0),Te&&(Tn=Tn.setMeta(Te,{type:"enter",sectionId:Ia})),ee(Tn.scrollIntoView()),!0}if(g(j,"outlineBody")===null||!j.parent?.isTextblock)return!1;let we=F.tr,He=W.from;try{we=we.split(He)}catch{return!1}let Oe=we.mapping.map(He);try{we=we.setSelection(f.near(we.doc.resolve(Math.min(we.doc.content.size,Oe+1)),1))}catch{}let Le=we.selection.$from,Be=g(Le,"outlineBody"),_e=g(Le,"paragraph");if(Be===null||_e===null)return!1;let Ve=Le.before(_e),rt=Le.end(Be);if(typeof Ve!="number"||typeof rt!="number"||rt<Ve)return!1;let Qe=we.doc.slice(Ve,rt).content;we=we.delete(Ve,rt);let ot=we.mapping.map(ce,-1),mt=we.doc.nodeAt(ot);if(!mt)return ee(we.scrollIntoView()),!0;let wt=mt.child(0),yn=de(mt.child(1)),Ht=mt.child(2),bn=he.nodes.outlineSection.create({...mt.attrs,collapsed:!1},[wt,yn,xe]),lt=Qe&&Qe.childCount?he.nodes.outlineBody.create({},Qe):he.nodes.outlineBody.create({},[he.nodes.paragraph.create({},[])]),It=Kt(),Cn=he.nodes.outlineSection.create({id:It,collapsed:!1},[he.nodes.outlineHeading.create({},[]),lt,Ht]);we=we.replaceWith(ot,ot+mt.nodeSize,bn);let wn=ot+bn.nodeSize;return we=we.insert(wn,Cn),we=we.setSelection(f.create(we.doc,wn+2)),we=we.setMeta(ue,!0),Te&&(we=we.setMeta(Te,{type:"enter",sectionId:It})),ee(we.scrollIntoView()),!0}),ne=()=>this.editor.commands.command(({state:F,dispatch:ee})=>{let W=y(F.doc,F.selection.$from);if(typeof W!="number")return!1;let j=F.doc.resolve(W),ce=0;for(let ot=j.depth;ot>=0;ot-=1)j.node(ot)?.type?.name==="outlineSection"&&(ce+=1);if(ce>=6)return!1;let ge=j.index(),he=j.parent;if(!he||ge<=0)return!1;let xe=F.doc.nodeAt(W);if(!xe)return!1;let de=he.child(ge-1),Me=W-de.nodeSize,we=F.doc.nodeAt(Me);if(!we)return!1;let He=we.child(0),Oe=we.child(1),Le=we.child(2),_e=Me+1+He.nodeSize+Oe.nodeSize+Le.nodeSize-1,Ve=F.tr.delete(W,W+xe.nodeSize).insert(_e,xe).setMeta(ue,!0),rt=Ve.doc.nodeAt(Me);rt?.type?.name==="outlineSection"&&rt.attrs?.collapsed&&(Ve=Ve.setNodeMarkup(Me,void 0,{...rt.attrs,collapsed:!1}));let Qe=f.near(Ve.doc.resolve(_e+2),1);return Ve.setSelection(Qe),ee(Ve.scrollIntoView()),!0}),fe=()=>this.editor.commands.command(({state:F,dispatch:ee})=>{let W=F.selection.$from,j=null,ce=null;for(let Oe=W.depth;Oe>0;Oe-=1)if(W.node(Oe)?.type?.name==="outlineSection")if(j===null)j=Oe;else{ce=Oe;break}if(j===null||ce===null)return!1;let ge=W.before(j),he=W.before(ce),xe=F.doc.nodeAt(ge);if(!xe)return!1;let de=F.tr.delete(ge,ge+xe.nodeSize).setMeta(ue,!0),Me=de.doc.nodeAt(he);if(!Me)return!1;let we=he+Me.nodeSize;de.insert(we,xe);let He=f.near(de.doc.resolve(we+2),1);return de.setSelection(He),ee(de.scrollIntoView()),!0}),oe=F=>this.editor.commands.command(({state:ee,dispatch:W})=>{let j=y(ee.doc,ee.selection.$from);if(typeof j!="number")return!1;let ce=ee.doc.nodeAt(j);if(!ce)return!1;let ge=typeof F=="boolean"?F:!ce.attrs?.collapsed,he=ee.tr.setNodeMarkup(j,void 0,{...ce.attrs,collapsed:ge}).setMeta(ue,!0);try{ge&&Te&&(Te.getState(ee)||{}).editingSectionId&&(he=he.setMeta(Te,{type:"exit"}))}catch{}return W(he),!0}),Se=(F,ee)=>{let W=F.nodeAt(ee);if(!W||W.type?.name!=="outlineSection")return[];let j=[ee];return W.descendants((ce,ge)=>{ce?.type?.name==="outlineSection"&&j.push(ee+1+ge)}),j},Ie=(F,ee)=>{try{let W=F.resolve(Math.min(F.content.size,ee+1)),j=null;for(let ce=W.depth;ce>0;ce-=1){if(W.node(ce)?.type?.name!=="outlineSection")continue;if(W.before(ce)===ee){j=ce;break}}if(j===null)return null;for(let ce=j-1;ce>0;ce-=1)if(W.node(ce)?.type?.name==="outlineSection")return W.before(ce);return null}catch{return null}},Re=(F,ee,W,j)=>{let ce=!!j,ge=F.tr;for(let he of W){let xe=ge.doc.nodeAt(he);!xe||xe.type?.name!=="outlineSection"||!!xe.attrs?.collapsed!==ce&&(ge=ge.setNodeMarkup(he,void 0,{...xe.attrs,collapsed:ce}))}ge=ge.setMeta(ue,!0);try{ce&&Te&&(Te.getState(F)||{}).editingSectionId&&(ge=ge.setMeta(Te,{type:"exit"}))}catch{}ee(ge)},Ye=()=>this.editor.commands.command(({state:F,dispatch:ee})=>{let W=y(F.doc,F.selection.$from);if(typeof W!="number")return!1;let j=Ie(F.doc,W),ce=typeof j=="number"?j:W,ge=Se(F.doc,ce);if(!ge.length)return!1;let he=F.tr;for(let de of ge){let Me=he.doc.nodeAt(de);!Me||Me.type?.name!=="outlineSection"||Me.attrs?.collapsed||(he=he.setNodeMarkup(de,void 0,{...Me.attrs,collapsed:!0}))}he=he.setMeta(ue,!0);let xe=he.doc.nodeAt(ce);if(xe){let de=xe.child(0),we=ce+1+de.nodeSize-1;he=he.setSelection(f.near(he.doc.resolve(we),-1))}return ee(he.scrollIntoView()),!0}),De=()=>this.editor.commands.command(({state:F,dispatch:ee})=>{let W=y(F.doc,F.selection.$from);if(typeof W!="number")return!1;let j=Se(F.doc,W);return j.length?(Re(F,ee,j,!1),!0):!1}),Ke=(F,ee)=>{try{let W=F.nodeAt(ee);if(!W||W.type?.name!=="outlineSection")return[];if(W.childCount<3)return[];let j=W.child(0),ce=W.child(1),ge=W.child(2);if(!ge||ge.type?.name!=="outlineChildren")return[];let he=ee+1+j.nodeSize+ce.nodeSize,xe=[];return ge.descendants((de,Me)=>{de?.type?.name==="outlineSection"&&xe.push(he+1+Me)}),xe}catch{return[]}},nt=(F,ee)=>{try{let W=Ie(F,ee);if(typeof W!="number")return Jr(F);let j=F.nodeAt(W);if(!j||j.type?.name!=="outlineSection"||j.childCount<3)return Jr(F);let ce=j.child(0),ge=j.child(1),he=j.child(2);if(!he||he.type?.name!=="outlineChildren")return Jr(F);let xe=W+1+ce.nodeSize+ge.nodeSize,de=[];return he.descendants((Me,we)=>{Me?.type?.name==="outlineSection"&&de.push(xe+1+we)}),de}catch{return Jr(F)}},qe=(F,ee)=>{try{for(let W of ee||[]){let j=F.nodeAt(W);if(!(!j||j.type?.name!=="outlineSection")&&j.attrs?.collapsed)return!0}}catch{}return!1},Bt=()=>this.editor.commands.command(({state:F,dispatch:ee})=>{let W=y(F.doc,F.selection.$from);if(typeof W!="number")return!1;let j=F.doc.nodeAt(W);if(!j||j.type?.name!=="outlineSection")return!1;if(j.attrs?.collapsed)return Re(F,ee,[W],!1),!0;let ce=Ke(F.doc,W);if(ce.length&&qe(F.doc,ce))return Re(F,ee,ce,!1),!0;let ge=W;for(let xe=0;xe<64;xe+=1){let de=nt(F.doc,ge);if(de.length&&qe(F.doc,de))return Re(F,ee,de,!1),!0;let Me=Ie(F.doc,ge);if(typeof Me!="number")break;ge=Me}let he=Jr(F.doc);return he.length&&qe(F.doc,he)?(Re(F,ee,he,!1),!0):!1}),Lt=F=>this.editor.commands.command(({state:ee,dispatch:W})=>{let{selection:j}=ee,ge=(j?.node||null)?.type?.name==="outlineSection"?j.from:y(ee.doc,ee.selection.$from);if(typeof ge!="number"||!ee.doc.nodeAt(ge))return!1;let xe=!!F,de=Se(ee.doc,ge);return de.length?(Re(ee,W,de,xe),!0):!1});return{"Alt-ArrowUp":()=>this.editor.isActive("table")?!1:K("up"),"Alt-ArrowDown":()=>this.editor.isActive("table")?!1:K("down"),"Alt-ArrowRight":()=>this.editor.isActive("table")?!1:ne(),"Alt-ArrowLeft":()=>this.editor.isActive("table")?!1:fe(),"Ctrl-Alt-ArrowUp":()=>this.editor.isActive("table")?!1:K("up"),"Alt-Ctrl-ArrowUp":()=>this.editor.isActive("table")?!1:K("up"),"Ctrl-Alt-ArrowDown":()=>this.editor.isActive("table")?!1:K("down"),"Alt-Ctrl-ArrowDown":()=>this.editor.isActive("table")?!1:K("down"),"Ctrl-Alt-ArrowRight":()=>this.editor.isActive("table")?!1:ne(),"Alt-Ctrl-ArrowRight":()=>this.editor.isActive("table")?!1:ne(),"Ctrl-Alt-ArrowLeft":()=>this.editor.isActive("table")?!1:fe(),"Alt-Ctrl-ArrowLeft":()=>this.editor.isActive("table")?!1:fe(),"Mod-ArrowRight":()=>oe(!1),"Mod-ArrowLeft":()=>oe(!0),"Mod-ArrowUp":()=>{try{let F=this.editor.state,ee=y(F.doc,F.selection.$from);if(typeof ee=="number"){let W=F.doc.nodeAt(ee);if(W?.type?.name==="outlineSection"&&typeof Ie(F.doc,ee)!="number"&&W.attrs?.collapsed)return ga(this.editor,!0)}}catch{}return Ye()},"Mod-ArrowDown":()=>Bt(),"Mod-Enter":()=>{try{if(Te&&!(Te.getState(this.editor.state)||{}).editingSectionId)return!1}catch{}return X()},Backspace:()=>this.editor.commands.command(({state:F,dispatch:ee})=>{let{selection:W}=F;if(L(F,ee)||M(F,ee))return!0;if(!W?.empty)return!1;let{$from:j}=W;if(j.parent?.type?.name!=="outlineHeading"||j.parentOffset!==0)return!1;let ce=y(F.doc,j);if(typeof ce!="number")return!1;let ge=F.doc.nodeAt(ce);if(!ge)return!1;if(_(ge))return D(F,ee,ce);try{if(F.doc.resolve(ce).index()<=0)return U(F,ee,ce)}catch{}return z(F,ee,ce)}),Delete:()=>this.editor.commands.command(({state:F,dispatch:ee})=>{let{selection:W}=F;if(L(F,ee)||M(F,ee))return!0;if(!W?.empty)return!1;let{$from:j}=W;if(g(j,"outlineBody")!==null){let de=y(F.doc,j);if(typeof de!="number")return!1;let Me=F.doc.nodeAt(de);if(!Me)return!1;let we=Me.child(0),He=Me.child(1),Le=de+1+we.nodeSize+He.nodeSize-1;return j.pos===Le?V(F,ee,de):!1}if(j.parent?.type?.name!=="outlineHeading")return!1;let ge=y(F.doc,j);if(typeof ge!="number")return!1;let he=F.doc.nodeAt(ge);if(!he)return!1;let xe=he.child(0);if(j.parentOffset===xe.content.size){if(_(he))return D(F,ee,ge);let de=he.child(1),Me=ge+1+xe.nodeSize,we=F.tr;if(!de.childCount){let He=F.doc.type.schema;we=we.insert(Me+1,He.nodes.paragraph.create({},[]))}return we=we.setSelection(f.near(we.doc.resolve(Me+2),1)),ee(we.scrollIntoView()),!0}return!1}),Enter:()=>this.editor.commands.command(({state:F,dispatch:ee})=>{let{selection:W}=F;if(!W?.empty)return!1;let{$from:j}=W;if(j.parent?.type?.name!=="outlineHeading")return!1;try{if(Te&&!(Te.getState(F)||{}).editingSectionId)return!1}catch{}let ce=y(F.doc,j);if(typeof ce!="number")return!1;let ge=F.doc.nodeAt(ce);if(!ge)return!1;let he=ge.child(0),xe=ge.child(1),de=ce+1+he.nodeSize,Me=he.content?.size??0;if(ge.attrs?.collapsed&&j.parentOffset===Me){let He=ce+ge.nodeSize,Oe=F.doc.type.schema,Le=Kt(),Be=Oe.nodes.outlineSection.create({id:Le,collapsed:!1},[Oe.nodes.outlineHeading.create({},[]),Oe.nodes.outlineBody.create({},[Oe.nodes.paragraph.create({},[])]),Oe.nodes.outlineChildren.create({},[])]),_e=F.tr.insert(He,Be);return _e=_e.setSelection(f.create(_e.doc,He+2)),_e=_e.setMeta(ue,!0),Te&&(_e=_e.setMeta(Te,{type:"enter",sectionId:Le})),ee(_e.scrollIntoView()),!0}if(j.parentOffset===0){let He=F.doc.type.schema,Oe=Kt(),Le=He.nodes.outlineSection.create({id:Oe,collapsed:!1},[He.nodes.outlineHeading.create({},[]),He.nodes.outlineBody.create({},[He.nodes.paragraph.create({},[])]),He.nodes.outlineChildren.create({},[])]),Be=F.tr.insert(ce,Le);return Be=Be.setSelection(f.create(Be.doc,ce+2)),Be=Be.setMeta(ue,!0),Te&&(Be=Be.setMeta(Te,{type:"enter",sectionId:Oe})),ee(Be.scrollIntoView()),!0}if(j.parentOffset>0&&j.parentOffset<Me){let He=F.doc.type.schema,Oe=he.textBetween(0,Math.max(0,Math.min(j.parentOffset,Me)),"",""),Le=he.textBetween(Math.max(0,Math.min(j.parentOffset,Me)),Me,"",""),Be=He.nodes.outlineHeading.create({},Oe?[He.text(Oe)]:[]),_e=ge.child(2),Ve=[];try{for(let Ht=0;Ht<xe.childCount;Ht+=1)Ve.push(xe.child(Ht))}catch{}let rt=He.nodes.paragraph.create({},Le?[He.text(Le)]:[]),Qe=[];if(Le){let Ht=Ve[0]||null;Ht&&Ht.type?.name==="paragraph"&&B(Ht)?Qe=[rt,...Ve.slice(1)]:Qe=[rt,...Ve]}else Qe=Ve;Qe.length||(Qe=[He.nodes.paragraph.create({},[])]);let ot=He.nodes.outlineBody.create({},Qe),mt=He.nodes.outlineSection.create({...ge.attrs,collapsed:!1},[Be,ot,_e]),wt=F.tr.replaceWith(ce,ce+ge.nodeSize,mt),yn=wt.doc.nodeAt(ce);if(yn){let Ht=yn.child(0),bn=ce+1+Ht.nodeSize;wt=wt.setSelection(f.near(wt.doc.resolve(bn+2),1))}else wt=wt.setSelection(f.near(wt.doc.resolve(de+2),1));return wt=wt.setMeta(ue,!0),ee(wt.scrollIntoView()),!0}let we=F.tr;if(!xe.childCount){let He=F.doc.type.schema;we=we.insert(de+1,He.nodes.paragraph.create({},[]))}return we=we.setSelection(f.near(we.doc.resolve(de+2),1)),ee(we.scrollIntoView()),!0}),ArrowUp:()=>this.editor.commands.command(({state:F,dispatch:ee})=>{let{selection:W}=F;if(!W?.empty)return!1;let{$from:j}=W;if(j.parent?.type?.name!=="outlineHeading"||j.parentOffset!==0)return!1;let ce=y(F.doc,j);if(typeof ce!="number")return!1;let ge=I(F.doc,ce);if(typeof ge=="number")return E(F,ee,ge);let he=F.doc.resolve(ce),xe=he.index(),de=he.parent;if(!de)return!1;if(xe>0){let Oe=de.child(xe-1),Le=ce-Oe.nodeSize;return H(F,ee,Le)}let Me=null,we=null;for(let Oe=j.depth;Oe>0;Oe-=1)if(j.node(Oe)?.type?.name==="outlineSection")if(Me===null)Me=Oe;else{we=Oe;break}if(we===null)return!1;let He=j.before(we);return H(F,ee,He)})}},addProseMirrorPlugins(){let y=(g,B)=>{for(let M=g.depth;M>0;M-=1)if(g.node(M)?.type?.name===B)return M;return null};return[new S({key:new A("outlineAltMoveRepeatGuard"),props:{handleKeyDown:(g,B)=>{let M=_=>{try{return!!_?.getModifierState?.("AltGraph")}catch{return!1}},L=_=>{try{return(!!_?.altKey||M(_))&&!_?.metaKey&&(!_?.ctrlKey||M(_))}catch{return!1}};try{if(!B||!L(B))return!1;let _=String(B.key||"");if(_!=="ArrowUp"&&_!=="ArrowDown"||!B.repeat)return!1;let P=g?.state,H=P?.selection?.$from;if(!H)return!1;for(let v=H.depth;v>0;v-=1){let I=H.node(v)?.type?.name;if(I&&String(I).startsWith("table"))return!1}let N=null;for(let v=H.depth;v>0;v-=1)if(H.node(v)?.type?.name==="outlineSection"){N=H.before(v);break}if(typeof N!="number")return!1;let E=P.doc.resolve(N),k=E.parent;if(!k)return!1;let x=E.index();return _==="ArrowUp"&&x<=0||_==="ArrowDown"&&x>=k.childCount-1}catch{return!1}}}}),new S({props:{handleDOMEvents:{cut:(g,B)=>{try{let{state:M}=g,{selection:L}=M;if(!L||L.empty)return!1;let _=(fe,oe)=>{for(let Se=oe.depth;Se>0;Se-=1)if(oe.node(Se)?.type?.name==="outlineSection")return oe.before(Se);return null},P=_(M.doc,L.$from),H=_(M.doc,L.$to);if(typeof P!="number"||typeof H!="number")return!1;let N=(fe="")=>String(fe||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");if(P===H){let fe=y(L.$from,"outlineHeading"),oe=y(L.$to,"outlineHeading");if(fe!==null&&oe!==null){let Se=M.doc.nodeAt(P);if(!Se)return!1;let Ie=Se.child(0),Re=P+1,Ye=Re+1,De=Re+Ie.nodeSize-1;if(L.from>=Ye&&L.to<=De){let Ke=Math.max(L.from,Ye),nt=Math.min(L.to,De),qe=M.doc.textBetween(Ke,nt,`
`,`
`);if(B?.clipboardData)try{B.clipboardData.setData("text/plain",qe),B.clipboardData.setData("text/html",`<pre>${N(qe)}</pre>`)}catch{}B.preventDefault(),B.stopPropagation();let Bt=M.tr.delete(Ke,nt);return Bt=Bt.setSelection(f.near(Bt.doc.resolve(Ye),1)),g.dispatch(Bt.scrollIntoView()),!0}}return!1}if(y(L.$from,"outlineBody")===null||L.$to.parent?.type?.name!=="outlineHeading"||L.$to.parentOffset!==0)return!1;let k=M.doc.nodeAt(P);if(!k)return!1;let x=k.child(0),v=k.child(1),I=P+1+x.nodeSize,D=I+1,z=I+v.nodeSize-1,U=Math.max(L.from,D),V=Math.min(L.to,z);if(V<U)return!0;let K=M.doc.textBetween(U,V,`
`,`
`);if(B?.clipboardData)try{B.clipboardData.setData("text/plain",K),B.clipboardData.setData("text/html",`<pre>${N(K)}</pre>`)}catch{}B.preventDefault(),B.stopPropagation();let X=M.tr.delete(U,V),ne=X.doc.nodeAt(I);if(ne&&ne.content.size===0){let fe=X.doc.type.schema;X=X.insert(D,fe.nodes.paragraph.create({},[]))}return X=X.setSelection(f.near(X.doc.resolve(D+1),1)),g.dispatch(X.scrollIntoView()),!0}catch{return!1}}}}}),new S({props:{handleKeyDown:(g,B)=>{if(B.key!=="Backspace")return!1;let{state:M}=g,{selection:L}=M;if(!L?.empty)return!1;let{$from:_}=L;if(_.parent?.type?.name!=="paragraph"||_.parentOffset!==0)return!1;let P=null;for(let X=_.depth;X>0;X-=1)if(_.node(X)?.type?.name==="listItem"){P=X;break}if(P===null||_.index(P)!==0)return!1;let H=P-1,N=_.node(H);if(!N)return!1;let E=_.index(H);if(E<=0)return!1;let k=_.before(P),x=N.child(E-1),v=k-x.nodeSize,I=M.doc.nodeAt(k);if(!I||I.type?.name!=="listItem")return!1;B.preventDefault(),B.stopPropagation();let D=x.type.create(x.attrs,x.content.append(I.content),x.marks),z=M.tr.replaceWith(v,v+x.nodeSize,D),U=v+1+x.content.size,V=z.mapping.map(U,1),K=z.mapping.map(k);z=z.delete(K,K+I.nodeSize);try{z=z.setSelection(f.near(z.doc.resolve(V+1),1))}catch{}return g.dispatch(z.scrollIntoView()),!0}}}),new S({props:{handleKeyDown:(g,B)=>(B.key!=="Tab"||B.preventDefault(),!1)}}),new S({props:{handleKeyDown:(g,B)=>{if(!B.ctrlKey||B.shiftKey||B.altKey||B.metaKey||B.key!=="ArrowUp"&&B.key!=="ArrowDown")return!1;let{state:M}=g,{selection:L}=M;if(!L)return!1;let P=(()=>{if((L?.node||null)?.type?.name==="outlineSection")return L.from;let v=L.$from;for(let I=v.depth;I>0;I-=1)if(v.node(I)?.type?.name==="outlineSection")return v.before(I);return null})();if(typeof P!="number")return!1;let H=(x,v)=>{try{let I=x.resolve(Math.min(x.content.size,v+1)),D=null;for(let z=I.depth;z>0;z-=1)if(I.node(z)?.type?.name==="outlineSection"&&I.before(z)===v){D=z;break}if(D===null)return null;for(let z=D-1;z>0;z-=1)if(I.node(z)?.type?.name==="outlineSection")return I.before(z);return null}catch{return null}},N=(x,v)=>{let I=x.nodeAt(v);if(!I||I.type?.name!=="outlineSection")return[];let D=[v];return I.descendants((z,U)=>{z?.type?.name==="outlineSection"&&D.push(v+1+U)}),D};if(B.preventDefault(),B.stopPropagation(),B.key==="ArrowUp"){let x=H(M.doc,P),v=typeof x=="number"?x:P,I=N(M.doc,v);if(!I.length)return!0;let D=M.tr;for(let U of I){let V=D.doc.nodeAt(U);!V||V.type?.name!=="outlineSection"||V.attrs?.collapsed||(D=D.setNodeMarkup(U,void 0,{...V.attrs,collapsed:!0}))}let z=D.doc.nodeAt(v);if(z){let U=z.child(0),K=v+1+U.nodeSize-1;D=D.setSelection(f.near(D.doc.resolve(K),-1))}return g.dispatch(D.scrollIntoView()),!0}let E=N(M.doc,P);if(!E.length)return!0;let k=M.tr;for(let x of E){let v=k.doc.nodeAt(x);!v||v.type?.name!=="outlineSection"||v.attrs?.collapsed&&(k=k.setNodeMarkup(x,void 0,{...v.attrs,collapsed:!1}))}return g.dispatch(k),!0}}}),new S({props:{handleKeyDown:(g,B)=>{if(B.key!=="Enter")return!1;let{state:M}=g,{$from:L}=M.selection;if(!M.selection.empty)return!1;let _=y(L,"outlineBody");if(_===null)return!1;let P=y(L,"paragraph");if(P===null||L.node(P-1)?.type?.name!=="outlineBody")return!1;let H=L.node(P);if(!H||H.content.size!==0||L.parentOffset!==0&&L.parentOffset!==H.content.size)return!1;let N=L.node(_),E=L.index(_);if(E!==N.childCount-1||E<1)return!1;let k=N.child(E-1);if(!k||k.type?.name!=="paragraph"||k.content.size!==0)return!1;let x=y(L,"outlineSection");if(x===null)return!1;let v=L.before(x);B.preventDefault(),B.stopPropagation();let I=M.tr,D=L.start(_),z=D;for(let Ie=0;Ie<E;Ie+=1)z+=N.child(Ie).nodeSize;let U=E;for(let Ie=E;Ie>=0;Ie-=1){let Re=N.child(Ie);if(!Re||Re.type?.name!=="paragraph"||Re.content.size!==0)break;U=Ie}let V=D;for(let Ie=0;Ie<U;Ie+=1)V+=N.child(Ie).nodeSize;let K=z+N.child(E).nodeSize;I=I.delete(V,K);let X=I.doc.nodeAt(v);if(!X)return!0;let ne=v+X.nodeSize,fe=I.doc.type.schema,oe=Kt(),Se=fe.nodes.outlineSection.create({id:oe,collapsed:!1},[fe.nodes.outlineHeading.create({},[]),fe.nodes.outlineBody.create({},[fe.nodes.paragraph.create({},[])]),fe.nodes.outlineChildren.create({},[])]);return I=I.insert(ne,Se),I=I.setSelection(f.create(I.doc,ne+2)),I=I.setMeta(ue,!0),Te&&(I=I.setMeta(Te,{type:"enter",sectionId:oe})),g.dispatch(I.scrollIntoView()),!0}}})]}}),me=d.create({name:"outlineActiveSection",addProseMirrorPlugins(){return[new S({props:{decorations(y){try{let g=xt(y.doc,y.selection.$from);if(typeof g!="number")return null;let B=y.doc.nodeAt(g);return B?T.create(y.doc,[C.node(g,g+B.nodeSize,{"data-active":"true"})]):null}catch{return null}}}})]}}),ve=d.create({name:"outlineEditMode",addProseMirrorPlugins(){let y=new A("outlineEditMode");Te=y;let g=null,B=N=>{let E=xt(N.doc,N.selection.$from);if(typeof E!="number")return null;let k=N.doc.nodeAt(E);return String(k?.attrs?.id||"")||null},M=(N,E,k)=>{if(!E.docChanged)return!0;if(!k)return!1;let x=ct(N.doc,k);if(typeof x!="number")return!1;let v=N.doc.nodeAt(x);if(!v)return!1;let I=v.child(0),D=v.child(1),z=x+1,U=z+1,V=z+I.nodeSize-1,K=x+1+I.nodeSize,X=K+1,ne=K+D.nodeSize-1,fe=(oe,Se)=>{let Ie=oe>=U&&Se<=V,Re=oe>=X&&Se<=ne;return Ie||Re};for(let oe of E.steps){let Se=oe.getMap(),Ie=!0;if(Se.forEach((Re,Ye)=>{fe(Re,Ye)||(Ie=!1)}),!Ie)return!1}return!0},L=()=>{try{Ce("\u0414\u043B\u044F \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Enter \u0438\u043B\u0438 \u0434\u0432\u043E\u0439\u043D\u043E\u0439 \u043A\u043B\u0438\u043A \u043C\u044B\u0448\u043A\u043E\u0439. Esc \u0434\u043B\u044F \u0432\u044B\u0445\u043E\u0434\u0430.")}catch{}},_=()=>{try{Ce("\u041D\u0430\u0436\u043C\u0438\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437, \u0447\u0442\u043E\u0431\u044B \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438")}catch{}},P=N=>{try{let{selection:E}=N;if(!E?.empty)return!1;let{$from:k}=E,x=null;for(let V=k.depth;V>0;V-=1)if(k.node(V)?.type?.name==="outlineHeading"){x=V;break}if(x===null||!(k.pos===k.start(x)))return!1;let I=xt(N.doc,k);if(typeof I!="number")return!1;if(N.doc.resolve(I).index()>0)return!0;let U=!1;for(let V=k.depth;V>0;V-=1)if(k.node(V)?.type?.name==="outlineSection"){if(!U){U=!0;continue}return!0}return!1}catch{return!1}},H=(N,E)=>{try{if(!E)return!1;let{selection:k}=N;if(!k?.empty)return!1;let{$from:x}=k,v=xt(N.doc,x);if(typeof v!="number")return!1;let I=N.doc.nodeAt(v);if(!I||String(I.attrs?.id||"")!==String(E))return!1;let D=I.child(0),z=I.child(1),V=v+1+D.nodeSize+z.nodeSize-1;if(x.pos!==V)return!1;let K=N.doc.resolve(v),X=K.index(),ne=K.parent;return ne?X<ne.childCount-1:!1}catch{return!1}};return[new S({key:y,state:{init(){return{editingSectionId:null}},apply(N,E){let k=N.getMeta(y);return k?k.type==="enter"?{editingSectionId:k.sectionId||null}:k.type==="exit"?{editingSectionId:null}:E:E}},filterTransaction(N,E){let x=(y.getState(E)||{}).editingSectionId||null;return N.getMeta(ue)||N.getMeta("history$")!=null||N.getMeta("closeHistory$")!=null||!N.docChanged?!0:M(E,N,x)},props:{decorations(N){try{let k=(y.getState(N)||{}).editingSectionId||null;if(!k)return null;let x=ct(N.doc,k);if(typeof x!="number")return null;let v=N.doc.nodeAt(x);return v?T.create(N.doc,[C.node(x,x+v.nodeSize,{"data-editing":"true"})]):null}catch{return null}},handleKeyDown(N,E){let k=N.state,v=(y.getState(k)||{}).editingSectionId||null;Xe("keydown",{key:E?.key||null,repeat:!!E?.repeat,editingSectionId:v||null,selection:{empty:!!k?.selection?.empty,parent:k?.selection?.$from?.parent?.type?.name||null,parentOffset:k?.selection?.$from?.parentOffset??null}});let I=B(k);if(!v&&(E.key==="Delete"||E.key==="Del"||E.key==="Backspace")&&(E.ctrlKey||E.metaKey)&&!E.shiftKey&&!E.altKey){try{deleteActiveSection()}catch{}return E.preventDefault(),E.stopPropagation(),!0}if(v&&E.key==="Backspace"&&!E.ctrlKey&&!E.metaKey&&!E.altKey){let z=Yp(k,N.dispatch,v,f);if(Xe("editorProps.backspace.bodyToHeading",{promoted:z,editingSectionId:v}),z)return E.preventDefault(),E.stopPropagation(),!0;let U=Wp(k,N.dispatch);if(Xe("editorProps.backspace.tableMerge",{merged:U,editingSectionId:v||null}),U)return E.preventDefault(),E.stopPropagation(),!0}try{let z=(E.key==="Enter"||E.code==="Enter"||E.code==="NumpadEnter")&&(E.ctrlKey||E.metaKey)&&!E.shiftKey&&!E.altKey;if(!u.isPublicView&&!v&&z){let U=k.selection,V=U?.$from||null;if(V){let K=xt(k.doc,V),X=typeof K=="number"?k.doc.nodeAt(K):null;if(typeof K=="number"&&X&&X.type?.name==="outlineSection"){let ne=!!(U&&U.empty),fe=V.parent?.type?.name==="outlineHeading",Se=ne&&fe&&V.parentOffset===0?K:K+X.nodeSize;E.preventDefault(),E.stopPropagation();let Ie=k.schema,Re=Kt(),Ye=Ie.nodes.outlineSection.create({id:Re,collapsed:!1},[Ie.nodes.outlineHeading.create({},[]),Ie.nodes.outlineBody.create({},[Ie.nodes.paragraph.create({},[])]),Ie.nodes.outlineChildren.create({},[])]),De=k.tr.insert(Se,Ye);try{let nt=De.doc.nodeAt(Se)?.child?.(0)||Ye.child(0),qe=Se+1+nt.nodeSize;De=De.setSelection(f.near(De.doc.resolve(qe+2),1))}catch{De=De.setSelection(f.create(De.doc,Se+2))}De=De.setMeta(ue,!0),De=De.setMeta(y,{type:"enter",sectionId:Re}),N.dispatch(De.scrollIntoView());try{N.focus()}catch{}return!0}}}}catch{}if((!g||g.sectionId!==I||g.key!==E.key)&&(g=null),u.isPublicView&&!v&&(E.key==="Enter"&&!E.shiftKey&&!E.ctrlKey&&!E.metaKey&&!E.altKey||E.key==="F2"&&!E.shiftKey&&!E.ctrlKey&&!E.metaKey&&!E.altKey))return E.preventDefault(),E.stopPropagation(),!0;if(!v&&(E.key==="Enter"&&!E.shiftKey&&!E.ctrlKey&&!E.metaKey&&!E.altKey||E.key==="F2"&&!E.shiftKey&&!E.ctrlKey&&!E.metaKey&&!E.altKey)){let z=B(k);return z?(E.preventDefault(),E.stopPropagation(),N.dispatch(k.tr.setMeta(y,{type:"enter",sectionId:z})),!0):!1}if(v&&E.key==="Escape")return E.preventDefault(),E.stopPropagation(),N.dispatch(k.tr.setMeta(y,{type:"exit"})),!0;if(!v){let z=E.key&&E.key.length===1&&!E.metaKey&&!E.ctrlKey&&!E.altKey;if(E.key==="Backspace"||E.key==="Delete"){if(E.key==="Backspace"&&P(k))try{let{selection:V}=k,{$from:K}=V,X=findSectionPos(k.doc,K);if(typeof X!="number")return!1;let ne=k.doc.nodeAt(X);if(!ne)return!1;let fe=String(ne.attrs?.id||""),oe=null;try{let Ie=k.doc.resolve(X),Re=Ie.index(),Ye=Ie.parent;if(Ye&&Re>0){let De=Ye.child(Re-1),Ke=X-De.nodeSize,nt=k.doc.nodeAt(Ke);oe=String(nt?.attrs?.id||"")||null}else for(let De=K.depth-1;De>0;De-=1){let Ke=K.node(De);if(Ke?.type?.name==="outlineSection"){let nt=String(Ke.attrs?.id||"");if(nt&&nt!==fe){oe=nt;break}}}}catch{oe=null}let Se=!1;if(Zt(ne))Se=G(k,N.dispatch,X);else try{k.doc.resolve(X).index()<=0?Se=be(k,N.dispatch,X):Se=ie(k,N.dispatch,X)}catch{Se=ie(k,N.dispatch,X)}return Se&&oe&&window.setTimeout(()=>{try{if((y.getState(N.state)||{}).editingSectionId)return;let Re=ct(N.state.doc,oe),Ye=typeof Re=="number"?N.state.doc.nodeAt(Re):null;if(!Ye)return;let De=N.state.tr;Ye?.attrs?.collapsed&&(De=De.setNodeMarkup(Re,void 0,{...Ye.attrs,collapsed:!1}),De=De.setMeta(ue,!0)),De=De.setMeta(y,{type:"enter",sectionId:oe});try{let Ke=De.doc.nodeAt(Re);if(Ke&&Ke.type?.name==="outlineSection"){let nt=Ke.child(0),qe=Ke.child(1),Lt=Re+1+nt.nodeSize+qe.nodeSize-1;De=De.setSelection(f.near(De.doc.resolve(Lt),-1))}}catch{}N.dispatch(De.scrollIntoView());try{N.focus()}catch{}}catch{}},0),E.preventDefault(),E.stopPropagation(),!0}catch{}return E.preventDefault(),E.stopPropagation(),!0}if(z)return E.preventDefault(),E.stopPropagation(),L(),!0}let D=E.key==="Backspace"&&P(k)||E.key==="Delete"&&H(k,v);if(v&&(E.key==="Backspace"||E.key==="Delete")&&D){if(E.repeat)return E.preventDefault(),E.stopPropagation(),!0;let z=Date.now();return g&&g.sectionId===v&&g.key===E.key&&z-g.ts<1200?(g=null,!1):(g={sectionId:v,key:E.key,ts:z},E.preventDefault(),E.stopPropagation(),_(),!0)}return!1},handleTextInput(){let N=arguments[0],E=N?.state?y.getState(N.state):null;return E&&E.editingSectionId?!1:(L(),!0)},handleDOMEvents:{paste(N,E){let k=N.state;return(y.getState(k)||{}).editingSectionId?!1:(E.preventDefault(),E.stopPropagation(),L(),!0)},drop(N,E){let k=N.state;return(y.getState(k)||{}).editingSectionId?!1:(E.preventDefault(),E.stopPropagation(),L(),!0)}}}})]}}),ke=y=>{let g=(y||"").trim();if(!g)return[];let B=w(g,[b.configure({heading:!1,link:!1}),O.configure({openOnClick:!1,protocols:Si}),pt,R.configure({table:{resizable:!0}})]),M=Array.isArray(B?.content)?B.content:[],L=[];for(let _=0;_<M.length;_+=1){let P=M[_];if(P?.type!=="paragraph"){L.push(P);continue}let N=cd(P).trim();if(!fn(N)){L.push(P);continue}let k=[],x=_,v=_;for(;v<M.length;v+=1){let z=M[v];if(z?.type!=="paragraph")break;let U=cd(z).trim();if(!U)break;k.push(U)}let I=Ar(k);if(!I){L.push(P);continue}let D=Xp(I);if(!D){L.push(P);continue}L.push(D),_=v-1,_<x&&(_=x)}return L};No=ke;let le=d.create({name:"outlineMarkdown",addCommands(){return{insertMarkdown:y=>({editor:g})=>{if(!Te)return!1;if(!(Te.getState(g.state)||{}).editingSectionId)return Yr(),!1;if(!g?.storage?.markdown?.parser)return Ce("Markdown \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F"),!1;let M=g.storage.markdown.parser.parse(String(y||""),{inline:!0}),L=ke(M);return L.length?g.chain().focus().insertContent(L).run():!1}}}}),Ne=d.create({name:"outlineFormattedPaste",addProseMirrorPlugins(){let y=this.editor,g=H=>{let N=String(H||"").trim();if(!N)return"";let E=null;try{E=new DOMParser().parseFromString(N,"text/html")}catch{return N}let k=E?.body;if(!k)return N;try{for(let x of Array.from(k.querySelectorAll("ms-cmark-node"))){let v=x.parentNode;if(v){for(;x.firstChild;)v.insertBefore(x.firstChild,x);v.removeChild(x)}}}catch{}try{for(let x of Array.from(k.querySelectorAll("h1,h2,h3,h4,h5,h6"))){let v=E.createElement("p"),I=E.createElement("strong");try{for(;x.firstChild;)I.appendChild(x.firstChild)}catch{I.textContent=String(x.textContent||"")}v.appendChild(I),x.replaceWith(v)}}catch{}return String(k.innerHTML||"").replace(/<!--\s*StartFragment\s*-->/gi,"").replace(/<!--\s*EndFragment\s*-->/gi,"").trim()},B=H=>{let N=String(H||"").trim();if(!N||!N.includes("<")||!N.includes(">")||!/<\s*\/?\s*[a-z][^>]*>/i.test(N))return!1;try{let k=new DOMParser().parseFromString(N,"text/html")?.body;if(!k)return!1;let x=new Set(["p","br","strong","b","em","i","u","s","a","ul","ol","li","blockquote","pre","code","table","thead","tbody","tr","td","th","img","span","div","h1","h2","h3","h4","h5","h6"]);return!!Array.from(k.querySelectorAll("*")).find(I=>x.has(String(I.tagName||"").toLowerCase()))}catch{return!1}},M=H=>{let N=String(H||"").replace(/\r\n/g,`
`).trim();return N?[/```[\s\S]*```/m,/^\s{0,3}([-*+]|\d+\.)\s+\S/m,/^\s{0,3}>\s+\S/m,/\[[^\]]+\]\([^)]+\)/,/!\[[^\]]*\]\([^)]+\)/,/\*\*[^*\n]+\*\*/,/__[^_\n]+__/,/`[^`\n]+`/].some(k=>k.test(N)):!1},L=H=>{try{let N=String(H||"").replace(/\r\n/g,`
`).split(`
`).map(E=>String(E||"").trim()).filter(Boolean);return N.length<2?!1:!!Ar(N)}catch{return!1}},_=(H,N)=>{if(!N||!Array.isArray(N)||!N.length)return!1;let E=H?.state?.selection?.from,k=H?.state?.selection?.to;if(!Number.isFinite(E)||!Number.isFinite(k))return!1;try{return y.chain().focus().command(({tr:x})=>(x.setMeta(ue,!0),!0)).insertContentAt({from:E,to:k},N).run()}catch{return!1}},P=(H,N)=>{try{if(!(Te?.getState?.(H.state)||null)?.editingSectionId)return!1;let k=N?.clipboardData?.items||null,x=N?.clipboardData?.files||null;if(x&&x.length||k&&Array.from(k).some(D=>D?.kind==="file"))return!1;let v=String(N?.clipboardData?.getData?.("text/html")||"").trim(),I=String(N?.clipboardData?.getData?.("text/plain")||"").trim();if(v)try{let D=String(v).match(/<h[1-6][\s>]/gi);if((Array.isArray(D)?D.length:0)>=2)return!1}catch{}if(v){let D=g(v),z=ke(D);return z.length?(N.preventDefault(),N.stopPropagation(),_(H,z)):!1}if(I&&B(I)){let D=g(I),z=ke(D);return z.length?(N.preventDefault(),N.stopPropagation(),_(H,z)):!1}if(I&&M(I)){if(L(I))return!1;try{let X=ea(I);if(X?.startsWithHeading||(X?.sections?.length||0)>=2)return!1}catch{}let D=y?.storage?.markdown?.parser||null;if(!D?.parse)return!1;let z=!I.includes(`
`)&&!/^\s{0,3}([-*+]|\d+\.)\s+\S/m.test(I)&&!/```[\s\S]*```/m.test(I)&&!/^\s{0,3}>\s+\S/m.test(I),U=String(D.parse(I,{inline:z})).trim();if(!U)return!1;let V=g(U),K=ke(V);return K.length?(N.preventDefault(),N.stopPropagation(),_(H,K)):!1}return!1}catch{return!1}};return[new S({props:{handlePaste(H,N){return P(H,N)},handleDOMEvents:{paste(H,N){return P(H,N)}}}})]}}),Fe=!1,ze=null,Ze=wr()?performance.now():0,Ge=u.article?.docJson||null;if(Ge&&typeof Ge=="object"&&Ge.type==="doc"&&Array.isArray(Ge.content)&&(ze=Ge),ze||(ze=bm({blocks:u.article?.blocks||[],parseHtmlToNodes:ke}),Fe=!!(u.article&&!u.article?.docJson&&!u.article?.encrypted)),Ze&&Wr("build initial content",{ms:Math.round(performance.now()-Ze)}),ae){try{ae.destroy()}catch{}ae=null}let et=Y?Y.configure({html:!0,tightLists:!0,transformPastedText:!1,transformCopiedText:!1}):null,Ue=d.create({name:"outlineTableCellStyling",addOptions(){return{types:["tableCell","tableHeader"],textAlignValues:["left","center","right","justify"],verticalAlignValues:["top","middle","bottom"]}},addGlobalAttributes(){let y=(B,M)=>{try{let L=B?.style?.[M];return L?String(L).trim():""}catch{return""}},g=B=>{let M=[],L=B?.nodeTextAlign?String(B.nodeTextAlign):"",_=B?.nodeVerticalAlign?String(B.nodeVerticalAlign):"",P=B?.nodeTextColor?String(B.nodeTextColor):"",H=B?.nodeBackground?String(B.nodeBackground):"";return L&&this.options.textAlignValues.includes(L)&&M.push(`text-align: ${L}`),_&&this.options.verticalAlignValues.includes(_)&&M.push(`vertical-align: ${_}`),P&&M.push(`color: ${P}`),H&&M.push(`background-color: ${H}`),M.length?{style:M.join("; ")}:{}};return[{types:this.options.types,attributes:{nodeTextAlign:{default:null,parseHTML:B=>{let M=y(B,"textAlign");return M&&this.options.textAlignValues.includes(M)?M:null},renderHTML:B=>g(B)},nodeVerticalAlign:{default:null,parseHTML:B=>{let M=y(B,"verticalAlign");return M&&this.options.verticalAlignValues.includes(M)?M:null},renderHTML:B=>g(B)},nodeTextColor:{default:null,parseHTML:B=>{let M=y(B,"color");return M?String(M).replace(/['"]+/g,""):null},renderHTML:B=>g(B)},nodeBackground:{default:null,parseHTML:B=>{let M=y(B,"backgroundColor");return M?String(M).replace(/['"]+/g,""):null},renderHTML:B=>g(B)}}}]},addCommands(){let y=(B,M)=>({state:L,dispatch:_})=>{try{let P=ua(L);if(!P.length)return!1;let H=L.tr,N=!1;for(let{node:E,pos:k}of P){if(!E||typeof k!="number")continue;let x={...E.attrs||{}};M==null||M===""?delete x[B]:x[B]=M,H=H.setNodeMarkup(k,void 0,x),N=!0}return N?(H=H.setMeta(ue,!0),_(H),!0):!1}catch{return!1}},g=()=>({state:B,dispatch:M})=>{try{let L=ua(B);if(!L.length)return!1;let _=B.schema.nodes?.paragraph||null;if(!_)return!1;let P=B.tr,H=[...L].sort((E,k)=>Number(k.pos)-Number(E.pos)),N=!1;for(let{node:E,pos:k}of H){if(!E||typeof k!="number")continue;let x=k+1,v=k+E.nodeSize-1;if(!(v>=x))continue;let I=_.createAndFill();I&&(P=P.replaceWith(x,v,I),N=!0)}return N?(P=P.setMeta(ue,!0),M(P.scrollIntoView()),!0):!1}catch{return!1}};return{setNodeTextAlign:B=>y("nodeTextAlign",B),setNodeVAlign:B=>y("nodeVerticalAlign",B),setNodeTextColor:B=>y("nodeTextColor",B),setNodeBackground:B=>y("nodeBackground",B),unsetNodeAlignment:()=>({state:B,dispatch:M})=>{try{let L=ua(B);if(!L.length)return!1;let _=B.tr,P=!1;for(let{node:H,pos:N}of L){if(!H||typeof N!="number")continue;let E=H.attrs?.nodeTextAlign||null,k=H.attrs?.nodeVerticalAlign||null;if(!E&&!k)continue;let x={...H.attrs||{}};delete x.nodeTextAlign,delete x.nodeVerticalAlign,_=_.setNodeMarkup(N,void 0,x),P=!0}return P?(_=_.setMeta(ue,!0),M(_),!0):!1}catch{return!1}},clearNodeContents:()=>g()}}}),it=d.create({name:"outlineTablePercentWidths",addProseMirrorPlugins(){return[new S({view(y){let g=null,B=_=>{let P=String(_||"").trim();if(!P)return 0;let H=P.match(/(-?\\d+(?:\\.\\d+)?)px/i);return H&&Number(H[1])||0},M=()=>{g=null;try{let _=y?.dom;if(!_)return;let P=_.querySelectorAll(".tableWrapper > table");for(let H of P){let N=H.querySelector("colgroup");if(!N)continue;let E=Array.from(N.querySelectorAll("col"));if(!E.length||br)continue;try{H.style.width="100%",H.style.maxWidth="100%",H.style.tableLayout="fixed"}catch{}let k=!1;for(let x of E){let v=x?.dataset?.ttPct||"",I=Number.parseFloat(String(v||""));if(Number.isFinite(I)&&I>0)k=!0,x.style.width=`${I.toFixed(4)}%`,x.style.minWidth="";else{let D=Md(x.style.width);D!=null&&D>0&&(k=!0,x.dataset.ttPct=D.toFixed(4),x.style.width=`${D.toFixed(4)}%`,x.style.minWidth="")}}if(!k)try{let x=H.querySelector("tbody tr");if(!x)continue;let v=Array.from(x.children||[]).filter(V=>V&&V.nodeType===1);if(v.length<E.length)continue;let I=[];for(let V=0;V<E.length;V+=1){let K=v[V].getBoundingClientRect();I.push(Number.isFinite(K.width)?K.width:0)}let D=I.reduce((V,K)=>V+(Number.isFinite(K)?K:0),0);if(!(D>0))continue;let z=I.map(V=>Pn(V/D*100)),U=z.reduce((V,K)=>V+K,0);Math.abs(U-100)>.01&&(z[z.length-1]=Pn(z[z.length-1]+(100-U)));for(let V=0;V<E.length;V+=1)Oi(E[V],z[V])}catch{}}}catch{}},L=()=>{g==null&&(g=window.requestAnimationFrame(M))};return L(),{update(){L()},destroy(){g!=null&&(window.cancelAnimationFrame(g),g=null)}}}})]}}),st=d.create({name:"outlineTableSmartMouseSelection",addProseMirrorPlugins(){let y=gt?.CellSelection||null;return y?[new S({view(g){let B=L=>{try{for(let _=L.depth;_>=0;_-=1){let P=L.node(_)?.type?.name;if(P==="tableCell"||P==="tableHeader")return L.before(_)}}catch{}return null},M=()=>{try{if(!(Te?.getState?.(g.state)||null)?.editingSectionId)return;let _=g.state.selection;if(!_||_.empty)return;let P=B(_.$anchor),H=B(_.$head);if(P==null||H==null||P===H)return;let N=typeof y.create=="function"?y.create(g.state.doc,P,H):null;if(!N)return;let E=g.state.tr.setSelection(N);E=E.setMeta(ue,!0),g.dispatch(E)}catch{}};return g.dom.addEventListener("mouseup",M,!0),{destroy(){g.dom.removeEventListener("mouseup",M,!0)}}}})]:[]}}),tt=d.create({name:"outlineTableResizeCapture",addProseMirrorPlugins(){return[new S({view(y){let g=M=>{try{if(!M?.target?.closest?.(".column-resize-handle")||!(Te?.getState?.(y.state)||null)?.editingSectionId)return;br=!0}catch{}},B=()=>{if(br){br=!1;try{let M=y.domAtPos(y.state.selection.from),_=((M?.node&&M.node.nodeType===1?M.node:M?.node?.parentElement)||null)?.closest?.("table")||null;_&&Ni(_)}catch{}}};return y.dom.addEventListener("pointerdown",g,!0),document.addEventListener("pointerup",B,!0),document.addEventListener("pointercancel",B,!0),{destroy(){y.dom.removeEventListener("pointerdown",g,!0),document.removeEventListener("pointerup",B,!0),document.removeEventListener("pointercancel",B,!0)}}}})]}}),Z=d.create({name:"outlineTableNodeUi",addProseMirrorPlugins(){let y=this.editor,g=[{label:"Default text",value:null},{label:"Gray text",value:"var(--tt-color-text-gray)"},{label:"Brown text",value:"var(--tt-color-text-brown)"},{label:"Orange text",value:"var(--tt-color-text-orange)"},{label:"Yellow text",value:"var(--tt-color-text-yellow)"},{label:"Green text",value:"var(--tt-color-text-green)"},{label:"Blue text",value:"var(--tt-color-text-blue)"},{label:"Purple text",value:"var(--tt-color-text-purple)"},{label:"Pink text",value:"var(--tt-color-text-pink)"},{label:"Red text",value:"var(--tt-color-text-red)"}],B=[{label:"Default background",value:null},{label:"Gray background",value:"var(--tt-color-highlight-gray)"},{label:"Brown background",value:"var(--tt-color-highlight-brown)"},{label:"Orange background",value:"var(--tt-color-highlight-orange)"},{label:"Yellow background",value:"var(--tt-color-highlight-yellow)"},{label:"Green background",value:"var(--tt-color-highlight-green)"},{label:"Blue background",value:"var(--tt-color-highlight-blue)"},{label:"Purple background",value:"var(--tt-color-highlight-purple)"},{label:"Pink background",value:"var(--tt-color-highlight-pink)"},{label:"Red background",value:"var(--tt-color-highlight-red)"}],M=[{label:"Align left",value:"left"},{label:"Align center",value:"center"},{label:"Align right",value:"right"},{label:"Justify",value:"justify"}],L=[{label:"Align top",value:"top"},{label:"Align middle",value:"middle"},{label:"Align bottom",value:"bottom"}],_=E=>{try{if(!E)return null;let k={left:Number(E.left),top:Number(E.top),right:Number(E.right),bottom:Number(E.bottom),width:Number(E.width),height:Number(E.height)};return!Number.isFinite(k.left)||!Number.isFinite(k.top)?null:k}catch{return null}},P=(E,k,x,v,I=8)=>{try{let D=window.innerWidth||0,z=window.innerHeight||0,U=Math.max(I,Math.min(E,Math.max(I,D-x-I))),V=Math.max(I,Math.min(k,Math.max(I,z-v-I)));return{left:U,top:V}}catch{return{left:E,top:k}}};class H{constructor(){this.panels=[],this.onDocPointerDown=k=>{try{let x=k?.target||null,v=typeof k?.composedPath=="function"?k.composedPath():null,I=Array.isArray(v)&&v.length?v:x?[x]:[];if(!I.length)return;for(let D of I)for(let z of this.panels)if(z&&(D===z||z.contains(D)))return;this.closeAll()}catch{this.closeAll()}},this.onKeyDown=k=>{k?.key==="Escape"&&this.closeAll()}}isOpen(){return this.panels.length>0}closeAll(){try{for(let k of this.panels)k?.remove?.()}catch{}this.panels=[];try{document.removeEventListener("pointerdown",this.onDocPointerDown,!1),window.removeEventListener("keydown",this.onKeyDown,!1)}catch{}}openPanel({anchorRect:k,items:x,level:v=0}){let I=_(k);if(!I)return;for(;this.panels.length>v;){let X=this.panels.pop();try{X?.remove?.()}catch{}}let D=document.createElement("div");D.className="tt-table-menu",D.setAttribute("role","menu"),D.setAttribute("data-level",String(v)),D.addEventListener("pointerdown",X=>{X.stopPropagation()}),D.addEventListener("mousedown",X=>{X.stopPropagation()});for(let X of x){if(X.type==="separator"){let fe=document.createElement("div");fe.className="tt-table-menu-sep",D.appendChild(fe);continue}let ne=document.createElement("button");if(ne.type="button",ne.className="tt-table-menu-item",ne.textContent=X.label,ne.disabled=!!X.disabled,X.swatch){ne.classList.add("has-swatch");try{let fe=X.swatchValue==null?"transparent":String(X.swatchValue);ne.style.setProperty("--tt-swatch",fe)}catch{}}X.submenu&&ne.classList.add("has-submenu"),ne.addEventListener("click",fe=>{if(fe.preventDefault(),fe.stopPropagation(),!X.disabled){if(X.submenu){let oe=ne.getBoundingClientRect();this.openPanel({anchorRect:oe,items:X.submenu(),level:v+1});return}try{X.onClick?.()}finally{this.closeAll()}}}),D.appendChild(ne)}document.body.appendChild(D);let z=D.getBoundingClientRect(),U=I.right+8,V=I.top,K=P(U,V,z.width,z.height);D.style.left=`${K.left}px`,D.style.top=`${K.top}px`,this.panels.push(D);try{this.panels.length===1&&(document.addEventListener("pointerdown",this.onDocPointerDown,!1),window.addEventListener("keydown",this.onKeyDown,!1))}catch{}}}class N{constructor(k){this.view=k,this.menu=new H,this.wrapper=null,this.table=null,this.observedTable=null,this.resizeObserver=null,this.layoutRaf=null,this.resizeRaf=null,this.destroyed=!1,this.root=document.createElement("div"),this.root.className="tt-table-ui",this.root.style.display="none",this.cellOutline=document.createElement("div"),this.cellOutline.className="tt-table-active-cell-outline",this.cellOutline.style.display="none",this.root.appendChild(this.cellOutline),this.scheduleLayout=()=>{this.layoutRaf==null&&(this.layoutRaf=window.requestAnimationFrame(()=>{this.layoutRaf=null,!this.destroyed&&this.update(this.view)}))},this.scheduleResizeLoop=()=>{this.resizeRaf==null&&(this.resizeRaf=window.requestAnimationFrame(()=>{this.resizeRaf=null,!this.destroyed&&br&&this.update(this.view)}))},this.onWrapperScroll=()=>this.scheduleLayout(),this.onWindowResize=()=>this.scheduleLayout();try{window.addEventListener("resize",this.onWindowResize,{passive:!0})}catch{}this.rowHandles=[],this.colHandles=[],this.dragState=null,this.suppressClickUntil=0,this.colDropIndicator=document.createElement("div"),this.colDropIndicator.className="tt-table-drop-indicator tt-table-drop-indicator-col",this.colDropIndicator.style.display="none",this.root.appendChild(this.colDropIndicator),this.rowDropIndicator=document.createElement("div"),this.rowDropIndicator.className="tt-table-drop-indicator tt-table-drop-indicator-row",this.rowDropIndicator.style.display="none",this.root.appendChild(this.rowDropIndicator),this.cellHandle=document.createElement("button"),this.cellHandle.type="button",this.cellHandle.className="tt-table-handle tt-table-cell-handle",this.cellHandle.setAttribute("aria-label","Cell actions"),this.cellHandle.addEventListener("click",x=>{x.preventDefault(),x.stopPropagation();let v=this.cellHandle.getBoundingClientRect();this.openCellMenu(v)}),this.root.appendChild(this.cellHandle)}hideDropIndicators(){try{this.colDropIndicator&&(this.colDropIndicator.style.display="none")}catch{}try{this.rowDropIndicator&&(this.rowDropIndicator.style.display="none")}catch{}}cancelDrag(){let k=this.dragState;if(k){this.dragState=null,this.hideDropIndicators();try{window.removeEventListener("pointermove",k.onMove),window.removeEventListener("pointerup",k.onUp),window.removeEventListener("pointercancel",k.onUp)}catch{}try{document.body.classList.remove("tt-table-dragging")}catch{}}}destroy(){this.destroyed=!0,this.cancelDrag();try{this.cellOutline.style.display="none"}catch{}this.menu.closeAll();try{this.layoutRaf!=null&&window.cancelAnimationFrame(this.layoutRaf)}catch{}this.layoutRaf=null;try{this.resizeRaf!=null&&window.cancelAnimationFrame(this.resizeRaf)}catch{}this.resizeRaf=null;try{window.removeEventListener("resize",this.onWindowResize)}catch{}try{this.wrapper?.removeEventListener?.("scroll",this.onWrapperScroll)}catch{}try{this.resizeObserver?.disconnect?.()}catch{}this.resizeObserver=null,this.observedTable=null;try{this.root.remove()}catch{}this.wrapper=null,this.table=null}ensureAttached(k){if(k&&this.wrapper!==k){try{this.wrapper?.removeEventListener?.("scroll",this.onWrapperScroll)}catch{}try{this.root.remove()}catch{}this.wrapper=k;try{this.wrapper.addEventListener("scroll",this.onWrapperScroll,{passive:!0})}catch{}this.wrapper.appendChild(this.root)}}buildRowHandles(k){for(;this.rowHandles.length>k;){let x=this.rowHandles.pop();try{x?.remove?.()}catch{}}for(;this.rowHandles.length<k;){let x=document.createElement("button");x.type="button",x.className="tt-table-handle tt-table-row-handle",x.setAttribute("aria-label","Row actions"),x.dataset.idx=String(this.rowHandles.length),x.addEventListener("pointerdown",v=>this.onHandlePointerDown(v,x,"row")),x.addEventListener("click",v=>{if(Date.now()<this.suppressClickUntil){v.preventDefault(),v.stopPropagation();return}v.preventDefault(),v.stopPropagation();let I=Rt(this.view?.state)?.tablePos,D=x.getBoundingClientRect();y?.chain?.().focus?.().run?.();let z=Number(x.dataset.idx||0);em(y,z),this.openRowMenu(D,z,I)}),this.rowHandles.push(x),this.root.appendChild(x)}}buildColHandles(k){for(;this.colHandles.length>k;){let x=this.colHandles.pop();try{x?.remove?.()}catch{}}for(;this.colHandles.length<k;){let x=document.createElement("button");x.type="button",x.className="tt-table-handle tt-table-col-handle",x.setAttribute("aria-label","Column actions"),x.dataset.idx=String(this.colHandles.length),x.addEventListener("pointerdown",v=>this.onHandlePointerDown(v,x,"col")),x.addEventListener("click",v=>{if(Date.now()<this.suppressClickUntil){v.preventDefault(),v.stopPropagation();return}v.preventDefault(),v.stopPropagation();let I=Rt(this.view?.state)?.tablePos,D=x.getBoundingClientRect();y?.chain?.().focus?.().run?.();let z=Number(x.dataset.idx||0);nm(y,z),this.openColumnMenu(D,z,I)}),this.colHandles.push(x),this.root.appendChild(x)}}onHandlePointerDown(k,x,v){try{if(!k||k.button!==0)return;k.preventDefault(),k.stopPropagation(),y?.chain?.().focus?.().run?.();let I=Number(x?.dataset?.idx||0);try{typeof x.setPointerCapture=="function"&&x.setPointerCapture(k.pointerId)}catch{}let D={kind:v,btn:x,pointerId:k.pointerId,fromIndex:I,startX:k.clientX,startY:k.clientY,moved:!1};this.dragState=D;let z=V=>this.onHandlePointerMove(V),U=V=>this.onHandlePointerUp(V);D.onMove=z,D.onUp=U,window.addEventListener("pointermove",z,{passive:!1}),window.addEventListener("pointerup",U,{passive:!1}),window.addEventListener("pointercancel",U,{passive:!1})}catch{}}onHandlePointerMove(k){let x=this.dragState;if(!x||!k||k.pointerId!==x.pointerId)return;try{k.preventDefault()}catch{}let v=k.clientX-x.startX,I=k.clientY-x.startY;if(!x.moved&&Math.hypot(v,I)>=4){x.moved=!0;try{document.body.classList.add("tt-table-dragging")}catch{}}if(x.moved){let D=this.getDropIndexFromPointer(x.kind,k.clientX,k.clientY);x.dropIndex=D,D==null?this.hideDropIndicators():this.updateDropIndicator(x.kind,D,k.clientX,k.clientY)}}getDropIndexFromPointer(k,x,v){try{let I=this.table;if(!I)return null;let D=Array.from(I.querySelectorAll("tbody tr"));if(!D.length)return null;if(k==="col"){let U=Array.from(D[0].children||[]).filter(K=>K&&K.nodeType===1);if(!U.length)return null;let V=U.map(K=>{let X=K.getBoundingClientRect();return X.left+X.width/2});if(!V.length)return null;if(x<V[0])return 0;for(let K=0;K<V.length-1;K+=1)if(x>=V[K]&&x<V[K+1])return K+1;return V.length-1}let z=D.map(U=>{let V=U.children&&U.children[0];if(!V)return null;let K=V.getBoundingClientRect();return K.top+K.height/2}).filter(U=>typeof U=="number");if(!z.length)return null;if(v<z[0])return 0;for(let U=0;U<z.length-1;U+=1)if(v>=z[U]&&v<z[U+1])return U+1;return z.length-1}catch{return null}}updateDropIndicator(k,x,v,I){try{let D=this.table,z=this.wrapper;if(!D||!z)return;let U=z.getBoundingClientRect(),V=D.getBoundingClientRect(),K=V.top-U.top,X=V.left-U.left,ne=V.width,fe=V.height,oe=Array.from(D.querySelectorAll("tbody tr"));if(!oe.length)return;if(k==="col"){let qe=Array.from(oe[0].children||[]).filter(j=>j&&j.nodeType===1);if(!qe.length)return;let Bt=Math.max(0,Math.min(qe.length-1,Number(x))),Lt=qe[Bt].getBoundingClientRect(),F=qe[qe.length-1].getBoundingClientRect(),ee=F.left+F.width/2,W=Bt===qe.length-1&&v>ee?F.right-U.left:Lt.left-U.left;this.colDropIndicator.style.display="",this.rowDropIndicator.style.display="none",this.colDropIndicator.style.left=`${Math.round(W)}px`,this.colDropIndicator.style.top=`${Math.round(K)}px`,this.colDropIndicator.style.height=`${Math.max(0,Math.round(fe))}px`;return}let Se=Math.max(0,Math.min(oe.length-1,Number(x))),Ie=oe[Se]?.children?.[0];if(!Ie)return;let Re=Ie.getBoundingClientRect(),De=(oe[oe.length-1]?.children?.[0]||null)?.getBoundingClientRect?.()||null,Ke=De?De.top+De.height/2:null,nt=Se===oe.length-1&&De&&typeof Ke=="number"&&I>Ke?De.bottom-U.top:Re.top-U.top;this.rowDropIndicator.style.display="",this.colDropIndicator.style.display="none",this.rowDropIndicator.style.left=`${Math.round(X)}px`,this.rowDropIndicator.style.top=`${Math.round(nt)}px`,this.rowDropIndicator.style.width=`${Math.max(0,Math.round(ne))}px`}catch{}}onHandlePointerUp(k){let x=this.dragState;if(!x||!k||k.pointerId!==x.pointerId)return;try{k.preventDefault(),k.stopPropagation()}catch{}this.dragState=null;try{window.removeEventListener("pointermove",x.onMove),window.removeEventListener("pointerup",x.onUp),window.removeEventListener("pointercancel",x.onUp)}catch{}try{document.body.classList.remove("tt-table-dragging")}catch{}if(this.hideDropIndicators(),!x.moved)return;this.suppressClickUntil=Date.now()+250;let v=x.dropIndex??this.getDropIndexFromPointer(x.kind,k.clientX,k.clientY);if(v!=null){try{y?.chain?.().focus?.().run?.()}catch{}x.kind==="col"?Dd(y,x.fromIndex,v):Od(y,x.fromIndex,v),this.scheduleLayout()}}isEnabled(){try{return!!(Te?.getState?.(this.view.state)||null)?.editingSectionId&&!u.isPublicView}catch{return!1}}update(k){if(this.view=k,!br&&this.resizeRaf!=null){try{window.cancelAnimationFrame(this.resizeRaf)}catch{}this.resizeRaf=null}if(!this.isEnabled()){this.root.style.display="none",this.menu.closeAll();try{this.cellOutline.style.display="none"}catch{}return}let x=Rt(k.state),v=Zp(k),I=v?.closest?.("table")||Yt(k),D=I?.closest?.(".tableWrapper")||null;if(!x||!I||!D||!v){this.root.style.display="none",this.menu.isOpen()||this.menu.closeAll();try{this.cellOutline.style.display="none"}catch{}return}this.ensureAttached(D),this.table=I;try{typeof ResizeObserver=="function"&&(this.resizeObserver||(this.resizeObserver=new ResizeObserver(()=>this.scheduleLayout())),this.observedTable!==I&&(this.resizeObserver.disconnect(),this.resizeObserver.observe(I),this.observedTable=I))}catch{}this.root.style.display="";let z=Array.from(I.querySelectorAll("tbody tr")),U=Number(x.map?.height||z.length||0),V=Number(x.map?.width||0);this.buildRowHandles(Math.max(0,U)),this.buildColHandles(Math.max(0,V));let K=D.getBoundingClientRect(),X=I.getBoundingClientRect(),ne=X.top-K.top,fe=X.left-K.left,oe=14,Se=4,Ie=oe/2,Re=Math.max(0,Math.min(Math.max(0,U-1),Number(x.rowIndex||0))),Ye=Math.max(0,Math.min(Math.max(0,V-1),Number(x.colIndex||0))),De=Math.max(Ie,ne-(oe/2+Se)),Ke=Math.max(Ie,fe-(oe/2+Se)),nt=v.getBoundingClientRect(),qe=nt.left-K.left+nt.width/2,Bt=nt.top-K.top+nt.height/2,Lt=nt.left-K.left,F=nt.top-K.top,ee="cell";try{let W=k.state.selection,j=W?.$anchorCell?.pos,ce=W?.$headCell?.pos;if(typeof j=="number"&&typeof ce=="number"&&j!==ce){let ge=j-(x.tablePos+1),he=ce-(x.tablePos+1),xe=x.map?.rectBetween?.(ge,he)||null;if(xe){let de=Number(xe.right)-Number(xe.left),Me=Number(xe.bottom)-Number(xe.top);de===1&&Me>1?ee="col":Me===1&&de>1?ee="row":ee="range"}else ee="range"}}catch{ee="cell"}try{ee==="cell"?(this.cellOutline.style.display="",this.cellOutline.style.left=`${Math.round(Lt)}px`,this.cellOutline.style.top=`${Math.round(F)}px`,this.cellOutline.style.width=`${Math.max(0,Math.round(nt.width))}px`,this.cellOutline.style.height=`${Math.max(0,Math.round(nt.height))}px`):this.cellOutline.style.display="none"}catch{try{this.cellOutline.style.display="none"}catch{}}for(let W=0;W<this.colHandles.length;W+=1){let j=this.colHandles[W];if(j){if(j.dataset.idx=String(W),W!==Ye){j.style.display="none";continue}j.style.display="",j.style.width=`${Math.max(18,Math.round(nt.width))}px`,j.style.height=`${oe}px`,j.style.left=`${Math.round(qe)}px`,j.style.top=`${Math.round(De)}px`}}for(let W=0;W<this.rowHandles.length;W+=1){let j=this.rowHandles[W];if(j){if(j.dataset.idx=String(W),W!==Re){j.style.display="none";continue}j.style.display="",j.style.width=`${oe}px`,j.style.height=`${Math.max(18,Math.round(nt.height))}px`,j.style.left=`${Math.round(Ke)}px`,j.style.top=`${Math.round(Bt)}px`}}try{if(ee!=="cell")this.cellHandle.style.display="none";else{let W=nt.right-K.left;this.cellHandle.style.display="",this.cellHandle.style.left=`${Math.round(W)}px`,this.cellHandle.style.top=`${Math.round(Bt)}px`}}catch{this.cellHandle.style.display="none"}br&&this.scheduleResizeLoop()}openCellMenu(k){let x=()=>{try{y?.chain?.().focus?.().run?.()}catch{}},v=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>g.map(I=>({label:I.label,swatch:!0,swatchValue:I.value,onClick:()=>{x(),y.commands.setNodeTextColor(I.value)}}))},{label:"Background color",submenu:()=>B.map(I=>({label:I.label,swatch:!0,swatchValue:I.value,onClick:()=>{x(),y.commands.setNodeBackground(I.value)}}))}]},{label:"Alignment",submenu:()=>[...M.map(I=>({label:I.label,onClick:()=>{x(),y.commands.setNodeTextAlign(I.value)}})),{type:"separator"},...L.map(I=>({label:I.label,onClick:()=>{x(),y.commands.setNodeVAlign(I.value)}}))]},{type:"separator"},{label:"Clear contents",onClick:()=>{x(),y.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:k,items:v,level:0})}openRowMenu(k,x,v){let I=()=>{try{y?.chain?.().focus?.().run?.()}catch{}Number.isFinite(Number(v))&&tm(y,v,x)},D=(K,X)=>{try{y?.chain?.().focus?.().run?.()}catch{}return y.commands.command(({state:ne,dispatch:fe})=>{let oe=Number.isFinite(Number(v))?Number(v):Rt(ne)?.tablePos,Se=Number.isFinite(Number(x))?Number(x):Rt(ne)?.rowIndex;return!Number.isFinite(Number(oe))||!Number.isFinite(Number(Se))?!1:om({pmState:ne,dispatch:fe},{tablePos:oe,rowIndex:Se,attr:K,value:X})})},z=K=>()=>(I(),K?.()),U=K=>{try{return typeof K!="function"?!1:(I(),y.commands.command(({state:X,dispatch:ne})=>K(X,typeof ne=="function"?oe=>{try{oe=oe.setMeta(ue,!0)}catch{}ne(oe)}:void 0)))}catch{return!1}},V=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>g.map(K=>({label:K.label,swatch:!0,swatchValue:K.value,onClick:()=>D("nodeTextColor",K.value)}))},{label:"Background color",submenu:()=>B.map(K=>({label:K.label,swatch:!0,swatchValue:K.value,onClick:()=>D("nodeBackground",K.value)}))}]},{label:"Alignment",submenu:()=>[...M.map(K=>({label:K.label,onClick:()=>D("nodeTextAlign",K.value)})),{type:"separator"},...L.map(K=>({label:K.label,onClick:()=>D("nodeVerticalAlign",K.value)}))]},{type:"separator"},{label:"Insert row above",onClick:()=>U(gt?.addRowBefore)},{label:"Insert row below",onClick:()=>U(gt?.addRowAfter)},{label:"Sort ",submenu:()=>[{label:"Sort column A-Z",onClick:z(()=>fd(y,{direction:"asc"}))},{label:"Sort column Z-A",onClick:z(()=>fd(y,{direction:"desc"}))}]},{label:"Header row",onClick:()=>U(gt?.toggleHeaderRow)},{label:"Move ",submenu:()=>[{label:"Move row up",onClick:z(()=>dd(y,-1))},{label:"Move row down",onClick:z(()=>dd(y,1))},{label:"Move row left",disabled:!0,onClick:()=>{}},{label:"Move row right",disabled:!0,onClick:()=>{}}]},{label:"Duplicate row",onClick:z(()=>am(y))},{label:"Delete row",onClick:()=>U(gt?.deleteRow)},{type:"separator"},{label:"Clear row contents",onClick:()=>{I(),y.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:k,items:V,level:0})}openColumnMenu(k,x,v){let I=()=>{try{y?.chain?.().focus?.().run?.()}catch{}Number.isFinite(Number(v))&&rm(y,v,x)},D=(K,X)=>{try{y?.chain?.().focus?.().run?.()}catch{}return y.commands.command(({state:ne,dispatch:fe})=>{let oe=Number.isFinite(Number(v))?Number(v):Rt(ne)?.tablePos,Se=Number.isFinite(Number(x))?Number(x):Rt(ne)?.colIndex;return!Number.isFinite(Number(oe))||!Number.isFinite(Number(Se))?!1:im({pmState:ne,dispatch:fe},{tablePos:oe,colIndex:Se,attr:K,value:X})})},z=K=>()=>(I(),K?.()),U=K=>{try{return typeof K!="function"?!1:(I(),y.commands.command(({state:X,dispatch:ne})=>K(X,typeof ne=="function"?oe=>{try{oe=oe.setMeta(ue,!0)}catch{}ne(oe)}:void 0)))}catch{return!1}},V=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>g.map(K=>({label:K.label,swatch:!0,swatchValue:K.value,onClick:()=>D("nodeTextColor",K.value)}))},{label:"Background color",submenu:()=>B.map(K=>({label:K.label,swatch:!0,swatchValue:K.value,onClick:()=>D("nodeBackground",K.value)}))}]},{label:"Alignment",submenu:()=>[...M.map(K=>({label:K.label,onClick:()=>D("nodeTextAlign",K.value)})),{type:"separator"},...L.map(K=>({label:K.label,onClick:()=>D("nodeVerticalAlign",K.value)}))]},{type:"separator"},{label:"Insert column left",onClick:()=>{I();let K=Math.max(0,Number(x||0));U(gt?.addColumnBefore)&&window.requestAnimationFrame(()=>{try{Pi(y,{insertIndex:K,newColPct:10})}catch{let ne=Yt(y.view);Ni(ne)}})}},{label:"Insert column right",onClick:()=>{I();let K=Math.max(0,Number(x||0)+1);U(gt?.addColumnAfter)&&window.requestAnimationFrame(()=>{try{Pi(y,{insertIndex:K,newColPct:10})}catch{let ne=Yt(y.view);Ni(ne)}})}},{label:"Sort ",submenu:()=>[{label:"Sort row A-Z",onClick:z(()=>ud(y,{direction:"asc"}))},{label:"Sort row Z-A",onClick:z(()=>ud(y,{direction:"desc"}))}]},{label:"Header column",onClick:()=>U(gt?.toggleHeaderColumn)},{label:"Move ",submenu:()=>[{label:"Move column up",disabled:!0,onClick:()=>{}},{label:"Move column down",disabled:!0,onClick:()=>{}},{label:"Move column left",onClick:z(()=>ld(y,-1))},{label:"Move column right",onClick:z(()=>ld(y,1))}]},{label:"Duplicate column",onClick:z(()=>cm(y))},{label:"Delete column",onClick:()=>{I();let K=Yt(y.view),X=Xr(K),ne=Number.isFinite(Number(x))?Number(x):null,fe=X&&ne!=null?Pd(X,ne):null;U(gt?.deleteColumn)&&Array.isArray(fe)&&window.requestAnimationFrame(()=>{let Se=Yt(y.view);Qr(Se,fe)})}},{type:"separator"},{label:"Clear column contents",onClick:()=>{I(),y.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:k,items:V,level:0})}}return[new S({view(E){let k=new N(E);return k.update(E),{update(x){k.update(x)},destroy(){k.destroy()}}}})]}}),se=wr()?performance.now():0;ae=new c({element:e,extensions:[En,ut,yt,zt,vn,ye,je,te,me,ve,vt,Dn,Qt,sn,kn,pn,Ne,Q.configure({types:["outlineSection"],attributeName:"id",generateID:()=>Kt()}),b.configure({document:!1,heading:!1,link:!1}),O.configure({openOnClick:!1,protocols:Si}),et,pt,pe,Ue,R.configure({table:{resizable:!0}}),Z,st,tt,it,le].filter(Boolean),content:ze,editorProps:{attributes:{class:"outline-prosemirror"},handleKeyDown(y,g){try{if(Ee?.isOpen?.()&&Ee.isOpen()&&!!Ee.handleKeyDown?.(g))return!0}catch{}try{let N=g&&!g.defaultPrevented&&!g.isComposing&&!g.metaKey&&!g.ctrlKey&&!g.altKey,E=N&&String(g?.key||"")==="\\",k=N&&(String(g?.code||"")==="Backslash"||String(g?.code||"")==="IntlBackslash");if(E){g.preventDefault();let{from:x,to:v}=y.state.selection,I=y.state.tr.insertText("\\",x,v).setMeta(ue,!0);return y.dispatch(I),!0}if(k)try{window?.localStorage?.getItem?.("ttree_outline_debug_tag_v1")==="1"&&console.log("[outline][tag-debug] backslash-code",{key:String(g?.key||""),code:String(g?.code||""),shiftKey:!!g?.shiftKey,altKey:!!g?.altKey,ctrlKey:!!g?.ctrlKey,metaKey:!!g?.metaKey})}catch{}}catch{}if(g&&g.__memusSyntheticAltProxy)return!1;let B="ttree_outline_debug_alt_v1",M=()=>{try{return window?.localStorage?.getItem?.(B)==="1"}catch{return!1}},L=N=>{try{return!!N?.getModifierState?.("AltGraph")}catch{return!1}};((N,E)=>{try{if(!M())return;let k=String(N?.key||""),x=String(N?.code||"");if(!k.startsWith("Arrow")&&x!=="Enter"&&x!=="NumpadEnter")return;let v={altKey:!!N?.altKey,ctrlKey:!!N?.ctrlKey,metaKey:!!N?.metaKey,shiftKey:!!N?.shiftKey,altGraph:L(N),repeat:!!N?.repeat,location:N?.location??null},I=[];v.metaKey&&I.push("Meta"),v.ctrlKey&&I.push("Ctrl"),v.altKey&&I.push(v.altGraph?"AltGraph":"Alt"),v.shiftKey&&I.push("Shift"),I.push(x||k||"?"),console.log("[outline][alt-debug]",E,{key:k,code:x,name:I.join("-"),...v})}catch{}})(g,"keydown");let P=N=>{try{return!!N?.getModifierState?.("AltGraph")}catch{return!1}},H=N=>{try{return(!!N?.altKey||P(N))&&!N?.metaKey&&(!N?.ctrlKey||P(N))}catch{return!1}};try{let E=(Te?.getState?.(y.state)||null)?.editingSectionId||null,k=!!L(g)&&!g?.altKey&&!g?.ctrlKey&&!g?.metaKey&&!g?.shiftKey,x=String(g?.key||""),v=String(g?.code||"");if(!E&&k&&(x==="ArrowUp"||x==="ArrowDown"||x==="ArrowLeft"||x==="ArrowRight")){let D=null;try{D=new KeyboardEvent("keydown",{key:x,code:v||x,altKey:!0,ctrlKey:!1,metaKey:!1,shiftKey:!1,bubbles:!0,cancelable:!0});try{Object.defineProperty(D,"__memusSyntheticAltProxy",{value:!0})}catch{}}catch{D=null}if(D||(D={key:x,code:v||x,altKey:!0,ctrlKey:!1,metaKey:!1,shiftKey:!1,bubbles:!0,cancelable:!0,__memusSyntheticAltProxy:!0,preventDefault(){},stopPropagation(){},getModifierState(U){return!1}}),!!y?.someProp?.("handleKeyDown",U=>U(y,D)))return g.preventDefault(),g.stopPropagation(),!0}}catch{}try{if(H(g)){let N=String(g.key||"");if((N==="ArrowUp"||N==="ArrowDown")&&g.repeat){let E=y?.state?.selection?.$from;if(E){let k=!1;for(let x=E.depth;x>0;x-=1){let v=E.node(x)?.type?.name;if(v&&String(v).startsWith("table")){k=!0;break}}if(!k){let x=null;for(let v=E.depth;v>0;v-=1)if(E.node(v)?.type?.name==="outlineSection"){x=E.before(v);break}if(typeof x=="number"){let v=y.state.doc.resolve(x),I=v.parent;if(I){let D=v.index();if(N==="ArrowUp"&&D<=0||N==="ArrowDown"&&D>=I.childCount-1)return!0}}}}}}}catch{}Xe("editorProps.keydown",{key:g?.key||null,repeat:!!g?.repeat,selection:{empty:!!y.state?.selection?.empty,parent:y.state?.selection?.$from?.parent?.type?.name||null,parentOffset:y.state?.selection?.$from?.parentOffset??null,pos:y.state?.selection?.$from?.pos??null}});try{let N=$e?.pmStateMod?.TextSelection;if(N){let k=(Te?.getState?.(y.state)||null)?.editingSectionId||null,x=(g.key==="Enter"||g.code==="Enter"||g.code==="NumpadEnter")&&(g.ctrlKey||g.metaKey)&&!g.shiftKey&&!g.altKey;if(!u.isPublicView&&!k&&x){let v=y.state.selection,I=v?.$from||null;if(I){let D=xt(y.state.doc,I),z=typeof D=="number"?y.state.doc.nodeAt(D):null;if(typeof D=="number"&&z?.type?.name==="outlineSection"){let U=!!(v&&v.empty),V=I.parent?.type?.name==="outlineHeading",X=U&&V&&I.parentOffset===0?D:D+z.nodeSize,ne=y.state.schema,fe=Kt(),oe=ne.nodes.outlineSection.create({id:fe,collapsed:!1},[ne.nodes.outlineHeading.create({},[]),ne.nodes.outlineBody.create({},[ne.nodes.paragraph.create({},[])]),ne.nodes.outlineChildren.create({},[])]),Se=y.state.tr.insert(X,oe);try{let Re=Se.doc.nodeAt(X)?.child?.(0)||oe.child(0),Ye=X+1+Re.nodeSize;Se=Se.setSelection(N.near(Se.doc.resolve(Ye+2),1))}catch{Se=Se.setSelection(N.create(Se.doc,X+2))}Se=Se.setMeta(ue,!0),Te&&(Se=Se.setMeta(Te,{type:"enter",sectionId:fe})),y.dispatch(Se.scrollIntoView());try{y.focus()}catch{}return g.preventDefault(),g.stopPropagation(),!0}}}}}catch{}try{let N=H(g)&&!g.shiftKey,E=String(g.key||"");if(N&&(E==="ArrowLeft"||E==="ArrowRight"||E==="ArrowUp"||E==="ArrowDown")&&(Te?.getState?.(y.state)||null)?.editingSectionId&&ae){let x=()=>{try{let v=y?.state?.selection?.$from||null;if(!v)return!1;for(let I=v.depth;I>0;I-=1){let D=v.node(I)?.type?.name;if(D==="table"||D==="tableRow"||D==="tableCell"||D==="tableHeader")return!0}return!1}catch{return!1}};if(E==="ArrowLeft"||E==="ArrowRight"){let v=ae.chain().focus();v.command(({tr:D})=>(D.setMeta(ue,!0),!0));let I=!1;if(ae.isActive("bulletList")||ae.isActive("orderedList")?E==="ArrowRight"?I=v.sinkListItem("listItem").run():(I=v.liftListItem("listItem").run(),!I&&ae.isActive("bulletList")&&(I=v.toggleBulletList().run()),!I&&ae.isActive("orderedList")&&(I=v.toggleOrderedList().run())):E==="ArrowRight"&&(I=v.toggleBulletList().run()),I)return g.preventDefault(),g.stopPropagation(),!0}else if((E==="ArrowUp"||E==="ArrowDown")&&(E==="ArrowUp"?md(ae,-1)||pd(ae,-1):md(ae,1)||pd(ae,1)))return g.preventDefault(),g.stopPropagation(),!0}}catch{}try{if((g.ctrlKey||g.metaKey)&&!g.altKey&&!g.shiftKey&&(g.code==="KeyA"||String(g.key||"").toLowerCase()==="a")){let E=$e?.pmStateMod?.TextSelection;if(!E)return Xe("editorProps.modA",{handled:!1,reason:"no-TextSelection"}),!1;let k=y.state,x=k.selection,v=x?.$from||null;if(!v)return Xe("editorProps.modA",{handled:!1,reason:"no-$from"}),!1;let I=xt(k.doc,v);if(typeof I!="number")return Xe("editorProps.modA",{handled:!1,reason:"no-sectionPos"}),!1;let D=k.doc.nodeAt(I);if(!D||D.type?.name!=="outlineSection")return Xe("editorProps.modA",{handled:!1,reason:"not-outlineSection"}),!1;let z=D.child(0),U=D.child(1);if(!z||!U)return Xe("editorProps.modA",{handled:!1,reason:"missing-heading/body"}),!1;let V=I+1,K=V+1,X=V+z.nodeSize-1,ne=I+1+z.nodeSize,fe=ne+1,oe=ne+U.nodeSize-1,Se=oe;try{let Ke=null;k.doc.nodesBetween(fe,Math.min(k.doc.content.size,oe),(nt,qe)=>{nt?.isTextblock&&(Ke=qe+nt.nodeSize-1)}),typeof Ke=="number"&&(Se=Ke)}catch{}Se<fe&&(Se=X);let Ie=K,Re=(()=>{try{for(let Ke=v.depth;Ke>0;Ke-=1)if(v.node(Ke)?.type?.name==="outlineHeading")return!0}catch{}return!1})(),Ye=!!x&&typeof x.from=="number"&&typeof x.to=="number"&&Math.min(x.from,x.to)===Ie&&Math.max(x.from,x.to)===Se;if(Re&&Ye)return Xe("editorProps.modA",{handled:!1,reason:"pass-through-doc-select"}),!1;g.preventDefault(),g.stopPropagation();let De=E.create(k.doc,Ie,Se);return y.dispatch(k.tr.setSelection(De)),Xe("editorProps.modA",{handled:!0,blockFrom:Ie,blockTo:Se,isInHeading:Re,alreadySelectedBlock:Ye}),!0}}catch{}try{if(!Te)return!1;let E=(Te.getState(y.state)||{}).editingSectionId||null;if(!E){let k=(g.ctrlKey||g.metaKey)&&!g.altKey&&!g.shiftKey&&(g.key==="Delete"||g.key==="Del"||g.key==="Backspace"),x=g.key==="Backspace"||g.key==="Delete",v=g.key&&g.key.length===1&&!g.metaKey&&!g.ctrlKey&&!g.altKey,I=!g.metaKey&&!g.ctrlKey&&!g.altKey&&!g.shiftKey&&(g.key===" "||g.key==="Spacebar");if(k){let D=xt(y.state.doc,y.state.selection.$from),z=!1;try{typeof D=="number"&&(z=G(y.state,y.dispatch,D))}catch{z=!1}return Xe("editorProps.modDelete",{ok:z,sectionPos:D}),g.preventDefault(),g.stopPropagation(),!0}if(I){let D=document.activeElement;if(!(!!(D&&D.closest&&D.closest(".outline-editor"))||!!(g?.target&&g.target.closest&&g.target.closest(".outline-editor"))))return!1;if(g.repeat)return g.preventDefault(),g.stopPropagation(),!0;let U=g?.target||null,V=String(U?.tagName||"").toLowerCase();if(V==="button"||V==="input"||V==="textarea"||V==="select"||U?.closest?.("button, a[href], input, textarea, select")||!!!U?.closest?.(".outline-prosemirror")&&U?.closest?.('[contenteditable="true"]'))return!1;let X=xt(y.state.doc,y.state.selection.$from);if(typeof X!="number")return g.preventDefault(),g.stopPropagation(),!0;let ne=y.state.doc.nodeAt(X);if(!ne)return g.preventDefault(),g.stopPropagation(),!0;let fe=!ne.attrs?.collapsed,oe=y.state.tr.setNodeMarkup(X,void 0,{...ne.attrs,collapsed:fe});oe=oe.setMeta(ue,!0);try{let Se=ne.child(0),Re=X+1+Se.nodeSize-1,{TextSelection:Ye}=$e?.pmStateMod||{};Ye&&(oe=oe.setSelection(Ye.near(oe.doc.resolve(Re),-1)))}catch{}return g.preventDefault(),g.stopPropagation(),y.dispatch(oe.scrollIntoView()),!0}if(x){if(g.key==="Backspace")try{let D=y.state,z=D.selection,U=z?.$from||null,V=null;try{for(let ne=U?.depth||0;ne>0;ne-=1)if(U.node(ne)?.type?.name==="outlineHeading"){V=ne;break}}catch{V=null}let K=V!==null&&U?U.start(V):null,X=!!(z&&z.empty)&&!!U&&V!==null&&typeof K=="number"&&U.pos===K;if(Xe("editorProps.backspace.check",{empty:!!z?.empty,headingDepth:V,headingStart:K,pos:U?.pos??null,parent:U?.parent?.type?.name||null,parentOffset:U?.parentOffset??null,atHeadingStart:X}),X){let ne=xt(D.doc,U),fe=typeof ne=="number"?D.doc.nodeAt(ne):null;if(Xe("editorProps.backspace.sectionPos",{sectionPos:ne,hasNode:!!fe}),typeof ne=="number"&&fe){let oe=String(fe.attrs?.id||""),Se=null;try{let Re=D.doc.resolve(ne),Ye=Re.index(),De=Re.parent;if(De&&Ye>0){let Ke=De.child(Ye-1),nt=ne-Ke.nodeSize,qe=D.doc.nodeAt(nt);Se=String(qe?.attrs?.id||"")||null}else for(let Ke=U.depth-1;Ke>0;Ke-=1){let nt=U.node(Ke);if(nt?.type?.name==="outlineSection"){let qe=String(nt.attrs?.id||"");if(qe&&qe!==oe){Se=qe;break}}}}catch{Se=null}Xe("editorProps.backspace.mergeCandidate",{sectionPos:ne,currentSectionId:oe,targetSectionId:Se});let Ie=!1;if(Zt(fe))Ie=G(D,y.dispatch,ne);else try{D.doc.resolve(ne).index()<=0?Ie=be(D,y.dispatch,ne):Ie=ie(D,y.dispatch,ne)}catch{Ie=ie(D,y.dispatch,ne)}return Xe("editorProps.backspace.mergeDone",{ok:Ie,targetSectionId:Se}),Ie&&Se&&Te&&window.setTimeout(()=>{try{if((Te.getState(y.state)||{}).editingSectionId)return;let Ye=ct(y.state.doc,Se),De=typeof Ye=="number"?y.state.doc.nodeAt(Ye):null;if(!De)return;let Ke=y.state.tr;De?.attrs?.collapsed&&(Ke=Ke.setNodeMarkup(Ye,void 0,{...De.attrs,collapsed:!1}),Ke=Ke.setMeta(ue,!0)),Ke=Ke.setMeta(Te,{type:"enter",sectionId:Se});try{let nt=Ke.doc.nodeAt(Ye);if(nt&&nt.type?.name==="outlineSection"){let qe=nt.child(0),Bt=nt.child(1),F=Ye+1+qe.nodeSize+Bt.nodeSize-1;Ke=Ke.setSelection(f.near(Ke.doc.resolve(F),-1))}}catch{}y.dispatch(Ke.scrollIntoView());try{y.focus()}catch{}Xe("editorProps.backspace.enterEdit.done",{targetSectionId:Se})}catch{}},0),g.preventDefault(),g.stopPropagation(),!0}}}catch{}return g.preventDefault(),g.stopPropagation(),!0}if(v)return g.preventDefault(),g.stopPropagation(),Yr(),!0}if(u.isPublicView&&!E&&(g.key==="Enter"&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey&&!g.altKey||g.key==="F2"&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey&&!g.altKey))return g.preventDefault(),g.stopPropagation(),!0;if(!E&&(g.key==="Enter"&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey&&!g.altKey||g.key==="F2"&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey&&!g.altKey)){let k=xt(y.state.doc,y.state.selection.$from);if(typeof k!="number")return!1;let x=y.state.doc.nodeAt(k),v=String(x?.attrs?.id||"");if(!v)return!1;if(g.preventDefault(),g.stopPropagation(),x?.attrs?.collapsed){let I=y.state.tr.setNodeMarkup(k,void 0,{...x.attrs,collapsed:!1});return I.setMeta(ue,!0),y.dispatch(I.scrollIntoView()),!0}return y.dispatch(y.state.tr.setMeta(Te,{type:"enter",sectionId:v})),!0}if(E&&g.key==="Escape"){g.preventDefault(),g.stopPropagation();let k=E;y.dispatch(y.state.tr.setMeta(Te,{type:"exit"}));try{let x=ae;if(x&&!x.isDestroyed){let v=xr(y.state.doc,k);wd(x,y.state.doc,k),v&&Gt({delayMs:350})}}catch{}return!0}}catch{}return!1},handleDOMEvents:{click(y,g){try{let B=g.target?.closest?.("a[href]");if(!B||!Te)return!1;let M=String(B.getAttribute("href")||"").trim();if(!M)return!1;if(u.isPublicView){let k=String(B.getAttribute("rel")||"").split(/\s+/).filter(Boolean);if(B.getAttribute("data-unpublished")==="1"||k.includes("unpublished")||M==="#")return alert("\u042D\u0442\u0430 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435 \u043E\u043F\u0443\u0431\u043B\u0438\u043A\u043E\u0432\u0430\u043D\u0430"),g.preventDefault(),g.stopPropagation(),!0}if(M.startsWith("app:/")||M.startsWith("disk:/")){g.preventDefault(),g.stopPropagation();let E=_n(M);if(E)return window.open(E,"_blank","noopener,noreferrer"),!0}if((Te.getState(y.state)||{}).editingSectionId||null)return!1;let P=E=>{let k=String(E||"").trim();if(!k||k.startsWith("/")||k.startsWith("#")||/\s/.test(k)||k.includes("://")||/^[a-z][a-z0-9+.-]*:/i.test(k))return!1;let x=k.split(/[/?#]/,1)[0];return!(!x||!x.includes(".")||x.startsWith(".")||x.endsWith(".")||x.includes(".."))},H=E=>{let k=String(E||"").trim();return k&&(k.startsWith("//")?`https:${k}`:P(k)?`https://${k}`:k)};if(g.preventDefault(),g.stopPropagation(),M.startsWith("/"))return u.isPublicView?(window.location.href=M,!0):(ln(M),!0);let N=H(M);return/^https?:\/\//i.test(N)||/^mailto:/i.test(N)||/^tel:/i.test(N),window.open(N,"_blank","noopener,noreferrer"),!0}catch{return!1}},beforeinput(y,g){try{if(!Te)return!1;let M=(Te.getState(y.state)||{}).editingSectionId||null;if(M)return!1;let L=String(g?.inputType||"");if(L.startsWith("history"))return!1;if(Xe("beforeinput",{inputType:L,key:g?.data??null,editingSectionId:M||null,selection:{empty:!!y.state?.selection?.empty,parent:y.state?.selection?.$from?.parent?.type?.name||null,parentOffset:y.state?.selection?.$from?.parentOffset??null}}),L==="deleteContentBackward"){try{let _=y.state,P=_.selection,H=P?.$from||null,N=null;try{for(let x=H?.depth||0;x>0;x-=1)if(H.node(x)?.type?.name==="outlineHeading"){N=x;break}}catch{N=null}let E=N!==null&&H?H.start(N):null,k=!!(P&&P.empty)&&!!H&&N!==null&&typeof E=="number"&&H.pos===E;if(Xe("beforeinput.deleteContentBackward.check",{empty:!!P?.empty,headingDepth:N,headingStart:E,pos:H?.pos??null,parent:H?.parent?.type?.name||null,parentOffset:H?.parentOffset??null,atHeadingStart:k}),k){let x=xt(_.doc,H),v=typeof x=="number"?_.doc.nodeAt(x):null;if(typeof x=="number"&&v){let I=String(v.attrs?.id||"");Xe("beforeinput.deleteContentBackward.candidate",{sectionPos:x,currentSectionId:I});let D=null;try{let U=_.doc.resolve(x),V=U.index(),K=U.parent;if(K&&V>0){let X=K.child(V-1),ne=x-X.nodeSize,fe=_.doc.nodeAt(ne);D=String(fe?.attrs?.id||"")||null}else for(let X=H.depth-1;X>0;X-=1){let ne=H.node(X);if(ne?.type?.name==="outlineSection"){let fe=String(ne.attrs?.id||"");if(fe&&fe!==I){D=fe;break}}}}catch{D=null}let z=!1;if(Zt(v))Xe("beforeinput.merge",{kind:"deleteEmpty",sectionPos:x}),z=G(_,y.dispatch,x);else try{_.doc.resolve(x).index()<=0?(Xe("beforeinput.merge",{kind:"intoParent",sectionPos:x,targetSectionId:D}),z=be(_,y.dispatch,x)):(Xe("beforeinput.merge",{kind:"intoPrev",sectionPos:x,targetSectionId:D}),z=ie(_,y.dispatch,x))}catch{Xe("beforeinput.merge",{kind:"intoPrev.catch",sectionPos:x,targetSectionId:D}),z=ie(_,y.dispatch,x)}return Xe("beforeinput.merge.done",{ok:z,targetSectionId:D}),z&&D&&window.setTimeout(()=>{try{if((Te.getState(y.state)||{}).editingSectionId)return;let V=ct(y.state.doc,D),K=typeof V=="number"?y.state.doc.nodeAt(V):null;if(!K)return;let X=y.state.tr;K?.attrs?.collapsed&&(X=X.setNodeMarkup(V,void 0,{...K.attrs,collapsed:!1}),X=X.setMeta(ue,!0)),X=X.setMeta(Te,{type:"enter",sectionId:D});try{let ne=y.state.doc.nodeAt(V);if(ne&&ne.type?.name==="outlineSection"){let fe=ne.child(0),oe=V+1+fe.nodeSize,Se=Math.min(X.doc.content.size,oe+2);X=X.setSelection(f.create(X.doc,Se))}}catch{}y.dispatch(X.scrollIntoView());try{y.focus()}catch{}Xe("beforeinput.enterEdit.done",{targetSectionId:D})}catch{}},0),g.preventDefault(),g.stopPropagation(),!0}}}catch{}return Xe("beforeinput.deleteContentBackward.block",{inputType:L}),g.preventDefault(),g.stopPropagation(),!0}return L.startsWith("delete")?(Xe("beforeinput.delete.block",{inputType:L}),g.preventDefault(),g.stopPropagation(),!0):(g.preventDefault(),g.stopPropagation(),Yr(),!0)}catch{return!1}},dblclick(y,g){try{if(u.isPublicView||!Te||(Te.getState(y.state)||{}).editingSectionId||null)return!1;let L=g?.target&&g.target.closest&&g.target.closest('[data-outline-heading="true"]')||g?.target&&g.target.closest&&g.target.closest(".outline-heading"),_=g?.target&&g.target.closest&&g.target.closest('[data-outline-body="true"]')||g?.target&&g.target.closest&&g.target.closest(".outline-body");if(!L&&!_)return!1;let P={left:g.clientX,top:g.clientY},H=y.posAtCoords(P),N=H&&typeof H.pos=="number"?H.pos:null;if(typeof N!="number")return!1;let E=y.state.doc.resolve(Math.max(0,Math.min(y.state.doc.content.size,N))),k=xt(y.state.doc,E);if(typeof k!="number")return!1;let x=y.state.doc.nodeAt(k),v=String(x?.attrs?.id||"");if(!v)return!1;window.setTimeout(()=>{try{if((Te.getState(y.state)||{}).editingSectionId)return;let D=ct(y.state.doc,v),z=typeof D=="number"?y.state.doc.nodeAt(D):null,U=!!z?.attrs?.collapsed,V=y.state.tr;if(U&&typeof D=="number"&&z&&(V=V.setNodeMarkup(D,void 0,{...z.attrs,collapsed:!1}),V=V.setMeta(ue,!0)),U){y.dispatch(V.scrollIntoView());try{y.focus()}catch{}return}V=V.setMeta(Te,{type:"enter",sectionId:v});try{let{TextSelection:K}=$e?.pmStateMod||{},X=typeof D=="number"?V.doc.nodeAt(D):null;if(X&&X.type?.name==="outlineSection"){let ne=X.child(0),fe=D+1+ne.nodeSize,oe=Math.min(V.doc.content.size,fe+2);K&&(V=V.setSelection(K.near(V.doc.resolve(oe),1)))}}catch{}y.dispatch(V.scrollIntoView());try{y.focus()}catch{}}catch{}},0)}catch{}return!1}}},onCreate:({editor:y})=>{if(Fe&&u.articleId&&u.article&&!u.article.encrypted)try{let g=y.getJSON();u.article.docJson=g,uc(u.articleId,g).catch(()=>{})}catch{}try{Em(y.state.doc)}catch{}vr.clear();try{Gr.clear()}catch{}Xt=!1,Sd=null,on=null;try{Ti=sd(y.state.doc),Ln=!1;try{gn.clear()}catch{gn.clear()}Ot&&(clearTimeout(Ot),Ot=null)}catch{}jn("")},onUpdate:()=>{Xt=!0;try{let y=Te?.getState?.(ae?.state)||null,g=String(y?.editingSectionId||"").trim();if(g){let B=ae?.state?.doc||null;B&&xr(B,g)&&Fp(ae)}}catch{}try{let y=ae?.state?.doc||null;if(y){let g=sd(y);g&&g!==Ti&&(Ti=g,$p({articleId:At||u.articleId,editor:ae}))}}catch{}try{hd(ae)}catch{}Gt({delayMs:1500})},onSelectionUpdate:({editor:y})=>{let{state:g}=y,{selection:B}=g;if(!B)return;let M=xt(g.doc,B.$from);if(typeof M!="number")return;let L=g.doc.nodeAt(M),_=String(L?.attrs?.id||"");if(!_)return;try{let N=(Te?.getState?.(g)||null)?.editingSectionId||null;N&&N!==_&&y.view.dispatch(g.tr.setMeta(Te,{type:"exit"}))}catch{}if(on&&on!==_){let H=xr(g.doc,on);try{Mt("leave_section",{from:on,to:_,changed:H})}catch{}try{Gr.has(on)&&wd(y,g.doc,on)}catch{}H&&Gt({delayMs:350})}let P=on;on=_;try{hd(y)}catch{}try{!(Te?.getState?.(g)||null)?.editingSectionId&&P&&P!==_&&Sm(y,{lines:4})}catch{}}}),se&&Wr("new Editor()",{ms:Math.round(performance.now()-se)});try{(At||u.articleId)&&(_p(At||u.articleId),navigator.onLine&&Ad(At||u.articleId))}catch{}e.focus?.({preventScroll:!0}),_i=y=>{try{if(!ae)return;let g=ae.state.tr.setMeta(Ae,{activeKey:y||null});ae.view.dispatch(g)}catch{}};try{Bd()}catch{}try{let y=wr()?performance.now():0;Qp(ae),y&&Wr("convertMarkdownTablesInOutlineDoc()",{ms:Math.round(performance.now()-y)})}catch{}t&&Wr("mountOutlineEditor() total",{ms:Math.round(performance.now()-t)})})();try{await Io}finally{Io=null}}function Bo(e=""){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}async function Tm(e={}){if(u.isPublicView||!u.articleId||!u.article||!ae)return;let t=At||u.articleId;if(!t)return;let n=!!e.silent,r=e&&typeof e.mode=="string"?e.mode:"network",o=Array.from(new Set([...vr||[],on].filter(Boolean))),i=(s,a)=>{let c=s?String(s):"",l=a?String(a):"";return c?l?c>=l?c:l:c||null:l||null};try{if(n||qi("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C outline\u2026"),u.article.encrypted){n||(ur(),Ce("Outline-\u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u0435 docJson \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0434\u043B\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0445 \u0441\u0442\u0430\u0442\u0435\u0439"));return}let s=ae.getJSON(),a=Pp(s);if(u.articleId&&t!==u.articleId){await an(t,a,u.article?.updatedAt||null).catch(()=>{}),n||ur(),jn("\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0447\u0435\u0440\u043D\u043E\u0432\u0438\u043A \u0441\u043E\u0445\u0440\u0430\u043D\u0451\u043D \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E");return}let c=Date.now();await an(t,a,u.article?.updatedAt||null).catch(()=>{});try{on&&xr(ae.state.doc,on)}catch{}if(!0){let d=gn.size?Array.from(gn):[];try{d.length&&(gn.clear(),await jt("delete_sections",{articleId:t,payload:{sectionIds:d,clientQueuedAt:c},coalesceKey:`delete:${t}`}))}catch{}n||ur(),u.article&&(u.article.docJson=a),Xt=!1,Sd=new Date,jn("\u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E");try{Bd()}catch{}try{Cm(ae,ae.state.doc,o)}catch{}return}}catch(s){n?jn("\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F"):(ur(),Ce(s?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C outline"));try{let a=ae.getJSON();a&&typeof a=="object"&&await an(t,a,u.article?.updatedAt||null).catch(()=>{})}catch{}Gt({delayMs:5e3})}}function Bm(){return on||null}function Nm(){try{if(!ae||ae.isDestroyed)return null;let e=ae.state,t=xt(e.doc,e.selection.$from);if(typeof t!="number")return null;let n=e.doc.nodeAt(t);if(!n||n.type?.name!=="outlineSection")return null;let r=String(n.attrs?.id||"").trim();return r?{sectionId:r,collapsed:!!n.attrs?.collapsed}:null}catch{return null}}function Mm(e,t){try{let n=String(t||"");if(!e||!n)return null;let r=(i,s,a)=>{if(!i||i.type?.name!=="outlineSection")return null;let c=String(i.attrs?.id||""),l=[...a,s];if(c===n)return l;let d=i.child(0),m=i.child(1),h=i.child(2);if(!h||h.type?.name!=="outlineChildren")return null;let w=s+1+d.nodeSize+m.nodeSize+1;for(let p=0;p<h.childCount;p+=1){let f=h.child(p),S=w;w+=f.nodeSize;let A=r(f,S,l);if(A)return A}return null},o=0;for(let i=0;i<e.childCount;i+=1){let s=e.child(i),a=o;o+=s.nodeSize;let c=r(s,a,[]);if(c)return c}return null}catch{return null}}function qd(e,t={}){try{if(!ae||ae.isDestroyed)return!1;let n=String(e||"");if(!n)return!1;let{state:r,view:o}=ae,i=$e?.pmStateMod?.TextSelection,s=Mm(r.doc,n);if(!Array.isArray(s)||!s.length)return!1;let a=r.tr;for(let c of s){let l=a.doc.nodeAt(c);!l||l.type?.name!=="outlineSection"||l.attrs?.collapsed&&(a=a.setNodeMarkup(c,void 0,{...l.attrs,collapsed:!1}))}a=a.setMeta(ue,!0);try{let c=ct(a.doc,n),l=typeof c=="number"?a.doc.nodeAt(c):null;if(typeof c=="number"&&l?.type?.name==="outlineSection"){let d=l.child(0),m=c+1+d.nodeSize,h=Math.min(a.doc.content.size,m+2);i&&(a=a.setSelection(i.create(a.doc,h)))}}catch{}o.dispatch(a.scrollIntoView());try{let c=typeof CSS<"u"&&CSS.escape?CSS.escape(n):n.replace(/"/g,'\\"');window.requestAnimationFrame(()=>{try{let l=o.dom?.querySelector?.(`[data-outline-section][data-section-id="${c}"]`)||o.dom?.querySelector?.(`[data-section-id="${c}"]`);l&&typeof l.scrollIntoView=="function"&&l.scrollIntoView({block:"center",inline:"nearest"})}catch{}})}catch{}if(t&&t.focus)try{o.focus()}catch{}return!0}catch{return!1}}function Lm(e,t){if(!ae)return!1;let n=String(e||"");if(!n)return!1;let r=ct(ae.state.doc,n);if(typeof r!="number")return!1;let o=ae.state.doc.nodeAt(r);if(!o)return!1;let i=ae.state.doc.type.schema,s=$n(String(t||"")),a=ba(s.titleHtml||"")||ba(s.bodyHtml||"").slice(0,80)||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",c=No?No(s.bodyHtml||""):[],l=[];for(let p of c||[])try{l.push(i.nodeFromJSON(p))}catch{}l.length||l.push(i.nodes.paragraph.create({},[]));let d=i.nodes.outlineHeading.create({},a?[i.text(a)]:[]),m=i.nodes.outlineBody.create({},l),h=o.child(2),b=i.nodes.outlineSection.create(o.attrs,[d,m,h]),w=ae.state.tr.replaceWith(r,r+o.nodeSize,b);try{let p=$e?.pmStateMod?.TextSelection;p&&(w=w.setSelection(p.create(w.doc,r+2)))}catch{}return ae.view.dispatch(w),ae.view.focus(),Xt=!0,Gt({delayMs:200}),!0}function Pm(e,t){if(!ae)return!1;let n=String(e||"");if(!n)return!1;let r=ct(ae.state.doc,n);if(typeof r!="number")return!1;let o=ae.state.doc.nodeAt(r);if(!o)return!1;let i=t&&typeof t=="object"?t:{},s=ae.state.doc.type.schema,a=null,c=null;try{i.heading&&typeof i.heading=="object"&&(a=s.nodeFromJSON(i.heading))}catch{a=null}try{i.body&&typeof i.body=="object"&&(c=s.nodeFromJSON(i.body))}catch{c=null}(!a||a.type?.name!=="outlineHeading")&&(a=s.nodes.outlineHeading.create({},[])),(!c||c.type?.name!=="outlineBody")&&(c=s.nodes.outlineBody.create({},[s.nodes.paragraph.create({},[])])),c.childCount||(c=s.nodes.outlineBody.create({},[s.nodes.paragraph.create({},[])]));let l=o.child(2),d=s.nodes.outlineSection.create(o.attrs,[a,c,l]),m=ae.state.tr.replaceWith(r,r+o.nodeSize,d);try{let h=$e?.pmStateMod?.TextSelection;h&&(m=m.setSelection(h.create(m.doc,r+2)))}catch{}return ae.view.dispatch(m),ae.view.focus(),Xt=!0,Gt({delayMs:200}),!0}function _m(e,t){if(!ae)return!1;let n=String(e||"").trim();if(!n||typeof ct(ae.state.doc,n)=="number")return!1;let o=t&&typeof t=="object"?t:{},i=ae.state.doc.type.schema,s=null,a=null;try{o.heading&&typeof o.heading=="object"&&(s=i.nodeFromJSON(o.heading))}catch{s=null}try{o.body&&typeof o.body=="object"&&(a=i.nodeFromJSON(o.body))}catch{a=null}(!s||s.type?.name!=="outlineHeading")&&(s=i.nodes.outlineHeading.create({},[])),(!a||a.type?.name!=="outlineBody")&&(a=i.nodes.outlineBody.create({},[i.nodes.paragraph.create({},[])])),a.childCount||(a=i.nodes.outlineBody.create({},[i.nodes.paragraph.create({},[])]));let c=i.nodes.outlineChildren.create({},[]),l=i.nodes.outlineSection.create({id:n,collapsed:!1},[s,a,c]),d=ae.state.doc.content.size,m=ae.state.tr.insert(d,l);try{let h=$e?.pmStateMod?.TextSelection;if(h){let b=Math.min(m.doc.content.size,d+2);m=m.setSelection(h.near(m.doc.resolve(Math.max(0,b)),1))}}catch{}return m=m.setMeta(ue,!0),ae.view.dispatch(m.scrollIntoView()),ae.view.focus(),Xt=!0,Gt({delayMs:200}),!0}function Dm({enterEditMode:e=!0}={}){if(!ae)return null;let t=ae.state.doc.type.schema,n=ae.state.doc.content.size,r=Kt(),o=t.nodes.outlineSection.create({id:r,collapsed:!1},[t.nodes.outlineHeading.create({},[]),t.nodes.outlineBody.create({},[t.nodes.paragraph.create({},[])]),t.nodes.outlineChildren.create({},[])]),i=ae.state.tr.insert(n,o);try{let s=$e?.pmStateMod?.TextSelection;if(s){let a=ct(i.doc,r),c=typeof a=="number"?$i(i.doc,a):null;typeof c=="number"?i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,c+2)),1)):i=i.setSelection(s.create(i.doc,n+2))}}catch{}return i=i.setMeta(ue,!0),e&&Te&&(i=i.setMeta(Te,{type:"enter",sectionId:r})),ae.view.dispatch(i.scrollIntoView()),ae.view.focus(),Xt=!0,Gt({delayMs:200}),r}function $i(e,t){try{let n=e.nodeAt(t);if(!n||n.type?.name!=="outlineSection")return null;let r=n.child(0);return t+1+r.nodeSize}catch{return null}}function Om(e,{focusBody:t=!0}={}){if(!ae||!Te)return!1;let n=String(e||"").trim();if(!n)return!1;let r=ct(ae.state.doc,n);if(typeof r!="number"||ae.state.doc.nodeAt(r)?.attrs?.collapsed)return!1;let i=ae.state.tr;if(t)try{let s=$e?.pmStateMod?.TextSelection,a=$i(i.doc,r);s&&typeof a=="number"&&(i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,a+2)),1)))}catch{}return i=i.setMeta(ue,!0),i=i.setMeta(Te,{type:"enter",sectionId:n}),ae.view.dispatch(i.scrollIntoView()),ae.view.focus(),!0}function Rm({enterEditMode:e=!0}={}){if(!ae)return null;let t=ae.state.doc.type.schema,n=0,r=Kt(),o=t.nodes.outlineSection.create({id:r,collapsed:!1},[t.nodes.outlineHeading.create({},[]),t.nodes.outlineBody.create({},[t.nodes.paragraph.create({},[])]),t.nodes.outlineChildren.create({},[])]),i=ae.state.tr.insert(n,o);try{let s=$e?.pmStateMod?.TextSelection;if(s){let a=ct(i.doc,r),c=typeof a=="number"?$i(i.doc,a):null;typeof c=="number"?i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,c+2)),1)):i=i.setSelection(s.create(i.doc,n+2))}}catch{}return i=i.setMeta(ue,!0),e&&Te&&(i=i.setMeta(Te,{type:"enter",sectionId:r})),ae.view.dispatch(i.scrollIntoView()),ae.view.focus(),Xt=!0,Gt({delayMs:200}),r}function Hm(e,t,{enterEditMode:n=!1}={}){if(!ae)return!1;let r=String(e||"").trim();if(!r||typeof ct(ae.state.doc,r)=="number")return!1;let i=ae.state.doc.type.schema,s=i.nodes.paragraph,a=i.nodes.hardBreak||i.nodes.hard_break||null,c=String(t||"").replace(/\r\n/g,`
`).trimEnd(),l=()=>{if(!s)return[];if(!c.trim())return[s.create({},[])];let f=c.split(/\n{2,}/),S=[];for(let A of f){let C=String(A||"").split(`
`),T=[];for(let O=0;O<C.length;O+=1){let $=C[O];O>0&&a&&T.push(a.create()),$&&T.push(i.text($))}S.push(s.create({},T))}return S.length?S:[s.create({},[])]},d=i.nodes.outlineHeading.create({},[]),m=i.nodes.outlineBody.create({},l()),h=i.nodes.outlineChildren.create({},[]),b=i.nodes.outlineSection.create({id:r,collapsed:!1},[d,m,h]),w=0,p=ae.state.tr.insert(w,b);try{let f=$e?.pmStateMod?.TextSelection;if(f){let S=ct(p.doc,r),A=typeof S=="number"?$i(p.doc,S):null;typeof A=="number"?p=p.setSelection(f.near(p.doc.resolve(Math.min(p.doc.content.size,A+2)),1)):p=p.setSelection(f.create(p.doc,w+2))}}catch{}return p=p.setMeta(ue,!0),n&&Te&&(p=p.setMeta(Te,{type:"enter",sectionId:r})),ae.view.dispatch(p.scrollIntoView()),ae.view.focus(),Xt=!0,Gt({delayMs:200}),!0}async function $m(){if(u.isPublicView||u.isRagView){Ce("Outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0432 \u044D\u0442\u043E\u043C \u0440\u0435\u0436\u0438\u043C\u0435");return}if(!u.articleId||!u.article){Ce("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}if(At=u.articleId,!J.outlineEditor||!J.blocksContainer){Ce("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440");return}u.isOutlineEditing=!0,J.articleToolbar&&J.articleToolbar.classList.add("hidden"),J.outlineToolbar&&J.outlineToolbar.classList.remove("hidden"),J.outlineTagsBar&&J.outlineTagsBar.classList.remove("hidden"),J.outlineEditor.classList.remove("hidden"),J.blocksContainer.classList.add("hidden"),Nd({loading:!0});try{at("outline.open",{articleId:At,updatedAt:u.article?.updatedAt||null,docHash:Dt(u.article?.docJson||null)})}catch{}try{if(!u.scrollTargetBlockId&&At){let e=wm(At);e?.sectionId&&(u.currentBlockId=e.sectionId)}}catch{}try{await Ud();try{dm(ae)}catch{}try{let t=u.scrollTargetBlockId||null;t&&(qd(t,{focus:!1}),u.scrollTargetBlockId=null,u.currentBlockId=t)}catch{}try{let t=u.currentBlockId||null;t&&(hm(ae,t),gm(ae,t,{block:"center"}))}catch{}let e=J.outlineEditor.querySelector(".outline-editor__loading");if(e&&e.classList.add("hidden"),jn("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u0442\u0441\u044F \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438"),nd||(nd=!0,window.addEventListener("online",()=>{if(u.isOutlineEditing){try{Ad(At||u.articleId)}catch{}To({force:!0})}}),window.addEventListener("blur",()=>{u.isOutlineEditing&&To({force:!0})}),document.addEventListener("visibilitychange",()=>{u.isOutlineEditing&&document.visibilityState!=="visible"&&To({force:!0})})),!vo){let t=r=>{if(!u.isOutlineEditing)return;let o=r?.dataTransfer;if(!(o&&(o.files&&o.files.length||o.items&&o.items.length)))return;let s=r?.target;J.outlineEditor&&s&&J.outlineEditor.contains(s)||r.preventDefault()},n=r=>{if(!u.isOutlineEditing)return;let o=r?.dataTransfer;if(!(o&&o.files&&o.files.length))return;let s=r?.target;J.outlineEditor&&s&&J.outlineEditor.contains(s)||(r.preventDefault(),r.stopPropagation())};window.addEventListener("dragover",t,{passive:!1}),window.addEventListener("drop",n,{passive:!1}),vo=()=>{window.removeEventListener("dragover",t),window.removeEventListener("drop",n),vo=null}}}catch(e){Ce(e?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440"),Kd()}}function Kd(){u.isOutlineEditing=!1,um(),Te=null,At=null,cr=null,_i=null,Jn={counts:new Map,labelByKey:new Map,sectionIdsByKey:new Map,sectionPosById:new Map};try{J.outlineTagsBar&&(J.outlineTagsBar.innerHTML="",J.outlineTagsBar.classList.add("hidden"))}catch{}ko(!1),vo&&vo(),J.outlineToolbar&&J.outlineToolbar.classList.add("hidden"),J.articleToolbar&&J.articleToolbar.classList.remove("hidden"),Fn&&(clearTimeout(Fn),Fn=null),Ot&&(clearTimeout(Ot),Ot=null),Sr&&(clearTimeout(Sr),Sr=null),fa=null,Ln=!1,Ti="";try{gn.clear()}catch{}Ei=!1,vr.clear();try{Gr.clear()}catch{}Er.clear(),on=null,Xt=!1;try{for(let[,e]of Co)try{clearTimeout(e)}catch{}Co.clear()}catch{}try{for(let[,e]of kr)try{URL.revokeObjectURL(e)}catch{}kr.clear()}catch{}if(ae){try{ae.destroy()}catch{}ae=null}$e=null,J.outlineEditor&&J.outlineEditor.classList.add("hidden"),J.blocksContainer&&J.blocksContainer.classList.remove("hidden")}async function Fm(e={}){let t=e&&typeof e.mode=="string"?e.mode:"network",n=e&&typeof e.timeoutMs=="number"?Math.max(0,Math.floor(e.timeoutMs)):0;if(!ae)return;Fn&&(clearTimeout(Fn),Fn=null);try{let o=At||u.articleId;if(o&&!u.article?.encrypted){let i=ae.getJSON();if(i&&typeof i=="object")try{await an(o,i,u.article?.updatedAt||null)}catch{}try{try{let s=Te?.getState?.(ae?.state)||null,a=String(s?.editingSectionId||"").trim();a&&await xa({articleId:o,doc:ae.state.doc,sectionId:a,reason:"pagehide"})}catch{}if(Ln){let s=Mo(ae.state.doc);s.length&&(jt("structure_snapshot",{articleId:o,payload:{nodes:s},coalesceKey:`structure:${o}`}),Ln=!1)}}catch{}try{if(gn.size){let s=Array.from(gn);gn.clear();let a=Date.now();await jt("delete_sections",{articleId:o,payload:{sectionIds:s,clientQueuedAt:a},coalesceKey:`delete:${o}:${a}`})}}catch{}}}catch{}if(t==="queue")return;let r=To({force:!0,silent:!0});if(n>0){await Promise.race([r,new Promise(o=>setTimeout(o,n))]);return}await r}async function zm({docJson:e}={}){if(J.outlineEditor){if(!e||typeof e!="object"){Ce("\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F: \u043D\u0435\u0442 \u0434\u043E\u043A\u0443\u043C\u0435\u043D\u0442\u0430");return}u.isPublicView=!0,u.isRagView=!1,u.isOutlineEditing=!1,u.articleId=null,u.article={docJson:e,encrypted:!1};try{J.outlineEditor.classList.add("outline-editor")}catch{}J.outlineEditor.classList.remove("hidden"),J.outlineEditor.querySelector("#outlineEditorContent")||Nd({loading:!0});try{await Ud();let t=J.outlineEditor.querySelector(".outline-editor__loading");t&&t.classList.add("hidden"),jn("\u0422\u043E\u043B\u044C\u043A\u043E \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440")}catch(t){Ce(t?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E")}}}var td,$e,ae,Io,Fn,Ei,Sr,fa,aa,Sd,on,kr,Er,vr,Gr,Xt,nd,No,pa,ma,gt,br,ca,Bp,qr,Kr,Ai,vi,Te,vo,At,cr,_i,Jn,Vn,lr,Np,Ii,ha,Mi,Mp,Co,id,Li,Ln,Ti,Ot,gn,da,ue,ad,zp,Up,qp,ki,Um,qm,Xe,li=Je(()=>{St();mn();Vt();Mn();Qn();en();ao();mr();Pr();Nr();Zi();Kl();Zn();Vl();Jl();to();td=!1,$e=null,ae=null,Io=null,Fn=null,Ei=!1,Sr=null,fa=null,aa=0,Sd=null,on=null,kr=new Map,Er=new Map,vr=new Set,Gr=new Set,Xt=!1,nd=!1,No=null,pa=null,ma=null,gt={TableMap:null,CellSelection:null,moveTableColumn:null,moveTableRow:null,addRowBefore:null,addRowAfter:null,deleteRow:null,addColumnBefore:null,addColumnAfter:null,deleteColumn:null,toggleHeaderRow:null,toggleHeaderColumn:null},br=!1,ca=new Map,Bp=30*1e3,qr=new Map,Kr=new Map,Ai=0,vi=null,Te=null,vo=null,At=null,cr=null,_i=null,Jn={counts:new Map,labelByKey:new Map,sectionIdsByKey:new Map,sectionPosById:new Map},Vn=!1,lr=new Set,Np=650,Ii={articleId:null,sectionId:null,collapsed:null},ha="ttree_outline_section_clipboard_v1",Mi="pending-attachment:",Mp=2e3,Co=new Map;id="ttree_outline_section_seq_v1",Li=262144;Ln=!1,Ti="",Ot=null,gn=new Set,da=null;ue="outlineAllowMutation",ad=0,zp="ttree_outline_debug_md_table";Up="ttree_profile_v1";qp="ttree_outline_debug_proofread_v1";ki=null;Um="ttree_debug_outline_keys_v1",qm=()=>{try{return window?.localStorage?.getItem?.(Um)==="1"}catch{return!1}},Xe=(e,t={})=>{qm()}});(()=>{let e=window.__memusAppModule||"/app.js",t="ttree_boot_session_v1",n="ttree_last_user_v1",r="ttree_last_active_at_v1",o=200,i=900*1e3,s=2500,a="ttree_debug_quick_notes_v1",c="ttree_offline_known_user_keys_v1",l="memus_offline_v1_",d="ttree_offline_recovery_force_index_v1",m="ttree_boot_open_offline_requested_v1",h=!1;try{h=window.sessionStorage?.getItem?.(m)==="1",h&&window.sessionStorage?.removeItem?.(m)}catch{}function b(){try{return window?.localStorage?.getItem?.(a)==="1"}catch{return!1}}function w(...Z){try{if(!b())return;console.log("[quick-notes][boot]",...Z)}catch{}}function p(...Z){try{console.log("[quick-notes][recovery]",...Z)}catch{}}function f(...Z){try{console.error("[quick-notes][recovery]",...Z)}catch{}}function S(){if("serviceWorker"in navigator)try{navigator.serviceWorker.register("/uploads-sw.js",{scope:"/",updateViaCache:"none"}).then(Z=>{try{Z&&Z.waiting&&Z.waiting.postMessage({type:"memus:skipWaiting"}),Z?.addEventListener?.("updatefound",()=>{try{let se=Z.installing;if(!se)return;se.addEventListener("statechange",()=>{if(se.state==="installed"&&navigator.serviceWorker.controller)try{Z.waiting?.postMessage?.({type:"memus:skipWaiting"})}catch{}})}catch{}})}catch{}try{let se=Z?.update?.();se&&typeof se.catch=="function"&&se.catch(()=>{})}catch{}}).catch(()=>{});try{let Z=!!navigator.serviceWorker.controller,se=T(),y=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{if(!y&&(y=!0,!h&&Z&&!se))try{window.location.reload()}catch{}})}catch{}}catch{}}function A(){try{return String(window.location.pathname||"").startsWith("/p/")}catch{return!1}}function C(){try{return!!(typeof navigator<"u"&&navigator&&navigator.onLine===!1)}catch{return!1}}function T(){try{let Z=performance.getEntriesByType?.("navigation")||[],se=Z&&Z[0];return String(se?.type||"")==="reload"}catch{return!1}}function O(){try{let Z=window.localStorage.getItem(r)||"",se=Number(Z);return Number.isFinite(se)?se:0}catch{return 0}}function $(){try{window.localStorage.setItem(r,String(Date.now()))}catch{}}function q(){let Z=O();return Z?Date.now()-Z>i:!0}function R(){try{return window.sessionStorage.getItem(t)?!1:(window.sessionStorage.setItem(t,"1"),!0)}catch{return!0}}function Q(){try{let Z=window.localStorage.getItem(n);if(!Z)return!1;let se=JSON.parse(Z);return!!(se&&(se.id||se.username))}catch{return!1}}function Y(){try{if(globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function")return globalThis.crypto.randomUUID()}catch{}return`id-${Date.now()}-${Math.random().toString(16).slice(2)}`}function re(){return new Date().toISOString()}function Ae(){try{let Z=window.localStorage.getItem(c)||"[]",se=JSON.parse(Z);return Array.isArray(se)?se.filter(Boolean).map(String):[]}catch{return[]}}async function Ee(){try{if(!("indexedDB"in window))return[];if(typeof indexedDB.databases=="function"){let y=(await indexedDB.databases()||[]).map(B=>B&&B.name).filter(Boolean).filter(B=>String(B).startsWith(l)).map(B=>String(B).slice(l.length)).filter(Boolean);return Array.from(new Set(y))}}catch{}return Array.from(new Set(Ae()))}function te(Z,se){return new Promise((y,g)=>{try{let B=se?indexedDB.open(Z,se):indexedDB.open(Z);se&&(B.onupgradeneeded=()=>{try{let M=B.result;if(M.objectStoreNames.contains("meta")||M.createObjectStore("meta",{keyPath:"key"}),!M.objectStoreNames.contains("articles")){let L=M.createObjectStore("articles",{keyPath:"id"});L.createIndex("byUpdatedAt","updatedAt",{unique:!1}),L.createIndex("byDeletedAt","deletedAt",{unique:!1})}if(!M.objectStoreNames.contains("outline_sections")){let L=M.createObjectStore("outline_sections",{keyPath:"sectionId"});L.createIndex("byArticleId","articleId",{unique:!1}),L.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!M.objectStoreNames.contains("section_embeddings")){let L=M.createObjectStore("section_embeddings",{keyPath:"sectionId"});L.createIndex("byArticleId","articleId",{unique:!1}),L.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!M.objectStoreNames.contains("media_assets")){let L=M.createObjectStore("media_assets",{keyPath:"url"});L.createIndex("byStatus","status",{unique:!1}),L.createIndex("byFetchedAtMs","fetchedAtMs",{unique:!1}),L.createIndex("byStatusFetchedAtMs",["status","fetchedAtMs"],{unique:!1})}if(!M.objectStoreNames.contains("media_refs")){let L=M.createObjectStore("media_refs",{keyPath:"key"});L.createIndex("byArticleId","articleId",{unique:!1}),L.createIndex("byUrl","url",{unique:!1})}if(M.objectStoreNames.contains("outbox"))try{let _=B.transaction.objectStore("outbox");_.indexNames.contains("byTypeCoalesceKey")||_.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}catch{}else{let L=M.createObjectStore("outbox",{keyPath:"id"});L.createIndex("byCreatedAtMs","createdAtMs",{unique:!1}),L.createIndex("byTypeArticleId",["type","articleId"],{unique:!1}),L.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}if(!M.objectStoreNames.contains("pending_uploads")){let L=M.createObjectStore("pending_uploads",{keyPath:"token"});L.createIndex("byArticleId","articleId",{unique:!1}),L.createIndex("byCreatedAtMs","createdAtMs",{unique:!1})}}catch{}}),B.onsuccess=()=>y(B.result),B.onerror=()=>{let M=B.error||new Error("IndexedDB open failed");f("idb.open.error",{name:Z,version:se||null,message:String(M?.message||M)}),g(M)}}catch(B){f("idb.open.throw",{name:Z,version:se||null,message:String(B?.message||B)}),g(B)}})}function ye(Z,se){return new Promise((y,g)=>{try{let L=Z.transaction([se],"readonly").objectStore(se).getAll();L.onsuccess=()=>y(Array.isArray(L.result)?L.result:[]),L.onerror=()=>{let _=L.error||new Error("IndexedDB getAll failed");f("idb.getAll.error",{storeName:se,message:String(_?.message||_)}),g(_)}}catch(B){f("idb.getAll.throw",{storeName:se,message:String(B?.message||B)}),g(B)}})}function je(Z,se){return new Promise((y,g)=>{try{let L=Z.transaction([se],"readonly").objectStore(se).count();L.onsuccess=()=>y(Number(L.result||0)),L.onerror=()=>{let _=L.error||new Error("IndexedDB count failed");f("idb.count.error",{storeName:se,message:String(_?.message||_)}),g(_)}}catch(B){f("idb.count.throw",{storeName:se,message:String(B?.message||B)}),g(B)}})}function pt(Z,se){try{let y=JSON.stringify(se),g=new Blob([y],{type:"application/json;charset=utf-8"}),B=URL.createObjectURL(g),M=document.createElement("a");return M.href=B,M.download=Z,M.rel="noopener",document.body.appendChild(M),M.click(),setTimeout(()=>{try{M.remove(),URL.revokeObjectURL(B)}catch{}},0),!0}catch{return!1}}function vt(Z,se){try{let y=URL.createObjectURL(se),g=document.createElement("a");return g.href=y,g.download=Z,g.rel="noopener",document.body.appendChild(g),g.click(),setTimeout(()=>{try{g.remove(),URL.revokeObjectURL(y)}catch{}},0),!0}catch{return!1}}async function Qt(Z,{method:se="GET",body:y=null,timeoutMs:g=2e4}={}){let B=typeof AbortController<"u"?new AbortController:null,M={method:se,credentials:"include",headers:{},signal:B?.signal};y!==null&&(M.headers["Content-Type"]="application/json",M.body=JSON.stringify(y));let L=null,_=!1;B&&typeof g=="number"&&g>0&&(L=setTimeout(()=>{try{_=!0;try{B.abort(new Error(`timeout after ${g}ms`))}catch{B.abort()}}catch{}},g));let P;try{P=await fetch(Z,M)}finally{L&&clearTimeout(L)}let H=await P.text().catch(()=>""),N=null;try{N=H?JSON.parse(H):null}catch{N=null}if(!P.ok){let E=N&&(N.detail||N.error)||H||`${P.status} ${P.statusText}`,k=new Error(E);throw k.status=P.status,k.payload=N,k}return N}async function sn(Z,se){try{return await Qt(Z,se)}catch(y){if(String(y?.name||"")==="AbortError"||String(y?.message||"").toLowerCase().includes("aborted")){let B=typeof se?.timeoutMs=="number"?se.timeoutMs:null,M=new Error(B?`timeout after ${B}ms`:"request aborted");throw M.name="TimeoutError",M}throw y}}function pn(Z){try{return Z?JSON.parse(Z):null}catch{return null}}function kn(Z){let se=String(Z||"");return!!(!se||se==="inbox"||se.startsWith("inbox-"))}async function _n({userKey:Z,onProgress:se}){let y=String(Z||"").trim();if(!y)throw new Error("No userKey");let g=await te(`${l}${y}`).catch(v=>{throw f("restore.server.idb.open.error",{userKey:y,message:String(v?.message||v)}),v}),B=await ye(g,"articles").catch(v=>{throw f("restore.server.idb.read.error",{userKey:y,message:String(v?.message||v)}),v});try{g.close()}catch{}let M=(Array.isArray(B)?B:[]).filter(v=>v&&!v.deletedAt&&!kn(v.id)).map(v=>{let I=pn(v.articleJsonStr)||{},D=pn(v.docJsonStr)||I.docJson||null;return{id:String(v.id),title:(v.title||I.title||"").toString(),parentId:v.parentId??I.parentId??null,position:typeof v.position=="number"?v.position:typeof I.position=="number"?I.position:0,docJson:D&&typeof D=="object"?D:null}}).filter(v=>v.id&&v.docJson),L=M.length,_={n:0},P={n:0},H={n:0},N=(v,I={})=>{try{se?.({phase:v,total:L,created:_.n,saved:P.n,moved:H.n,...I})}catch{}};N("start");for(let v=0;v<M.length;v+=1){let I=M[v];N("content",{idx:v+1,articleId:I.id,title:I.title});try{p("restore.server.create.start",{idx:v+1,id:I.id}),await sn("/api/articles",{method:"POST",body:{id:I.id,title:I.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"},timeoutMs:15e3}),_.n+=1,p("restore.server.create.done",{idx:v+1,id:I.id})}catch(D){p("restore.server.create.skip",{idx:v+1,id:I.id,status:D?.status||null,message:String(D?.message||D)})}try{p("restore.server.save.start",{idx:v+1,id:I.id}),await sn(`/api/articles/${encodeURIComponent(I.id)}/doc-json`,{method:"PUT",body:{docJson:I.docJson},timeoutMs:3e4}),P.n+=1,p("restore.server.save.done",{idx:v+1,id:I.id})}catch(D){f("restore.server.save.error",{idx:v+1,id:I.id,status:D?.status||null,message:String(D?.message||D),stack:String(D?.stack||"")})}}let E=new Map;for(let v of M){let I=v.parentId||null;E.has(I)||E.set(I,[]),E.get(I).push(v)}for(let[v,I]of E.entries())I.sort((D,z)=>Number(D.position||0)-Number(z.position||0)),E.set(v,I);let k=[null],x=new Set;for(N("structure");k.length;){let v=k.shift(),I=v||"__root__";if(x.has(I))continue;x.add(I);let D=E.get(v||null)||[];for(let z of D){N("structure",{articleId:z.id,title:z.title});try{await Qt(`/api/articles/${encodeURIComponent(z.id)}/move-tree`,{method:"POST",body:{parentId:v||null,anchorId:null,placement:"inside"}}),H.n+=1}catch(U){p("restore.server.move.skip",{id:z.id,status:U?.status||null,message:String(U?.message||U)})}E.has(z.id)&&k.push(z.id)}}return N("done"),{total:L,created:_.n,saved:P.n,moved:H.n}}function Dn(Z){let se=new TextEncoder,y=Object.entries(Z?.stores||{}),g={type:"meta",exportedAt:Z?.exportedAt||re(),sourceUserKey:Z?.sourceUserKey||null,dbName:Z?.dbName||null,format:"ndjson.v1"},B=!1,M=0,L=-1;return new ReadableStream({pull(_){try{if(!B){B=!0,_.enqueue(se.encode(`${JSON.stringify(g)}
`));return}for(;M<y.length;){let[P,H]=y[M],N=Array.isArray(H)?H:[];if(L===-1){L=0,_.enqueue(se.encode(`${JSON.stringify({type:"store",store:P,count:N.length})}
`));return}if(L>=N.length){M+=1,L=-1;continue}let E={type:"item",store:P,value:N[L]};L+=1,_.enqueue(se.encode(`${JSON.stringify(E)}
`));return}_.close()}catch(P){f("ndjson.stream.error",{message:String(P?.message||P),stack:String(P?.stack||"")}),_.error(P)}}})}async function En(Z,se){let y=Dn(se),g=typeof CompressionStream<"u",B=g?y.pipeThrough(new CompressionStream("gzip")):y,M=await new Response(B).blob(),L=g?`${Z}.ndjson.gz`:`${Z}.ndjson`;if(vt(L,M))return{ok:!0,method:"download",filename:L};try{let _=URL.createObjectURL(M);try{window.open(_,"_blank","noopener")}catch{window.location.href=_}return{ok:!0,method:"open",filename:L}}catch(_){f("export.open.error",{filename:L,message:String(_?.message||_),stack:String(_?.stack||"")})}return{ok:!1,method:"none",filename:L}}function vn(){try{let Z=window.localStorage.getItem(n)||"",se=Z?JSON.parse(Z):null;return se?.id||se?.username||""}catch{return""}}async function Ct(Z){let se=String(Z||"").trim();if(!se)throw new Error("No userKey");let y=`${l}${se}`,g=await te(y,3),B=["articles","outline_sections","media_assets","media_refs","outbox","pending_uploads","section_embeddings","meta"].filter(L=>{try{return g.objectStoreNames.contains(L)}catch{return!1}}),M={exportedAt:re(),sourceUserKey:se,dbName:y,stores:{}};for(let L of B)M.stores[L]=await ye(g,L).catch(_=>(f("export.store.read.error",{userKey:se,store:L,message:String(_?.message||_)}),[]));try{g.close()}catch{}return M}async function zt(Z,se){let y=String(se||"").trim();if(!y)throw new Error("No target userKey");if(!Z||typeof Z!="object"||!Z.stores||typeof Z.stores!="object")throw new Error("Invalid dump");let g=`${l}${y}`,B=await te(g,3),M=async(_,P)=>{if(!B.objectStoreNames.contains(_))return 0;let H=Array.isArray(P)?P:[];if(!H.length)return 0;let N=B.transaction([_],"readwrite"),E=N.objectStore(_),k=0;return await new Promise((x,v)=>{N.oncomplete=()=>x(),N.onerror=()=>{let I=N.error||new Error("tx failed");f("import.tx.error",{storeName:_,message:String(I?.message||I)}),v(I)},N.onabort=()=>{let I=N.error||new Error("tx aborted");f("import.tx.abort",{storeName:_,message:String(I?.message||I)}),v(I)};for(let I of H)try{E.put(I),k+=1}catch{}}),k},L=0;L+=await M("articles",Z.stores.articles),L+=await M("outline_sections",Z.stores.outline_sections),L+=await M("media_assets",Z.stores.media_assets),L+=await M("media_refs",Z.stores.media_refs),L+=await M("pending_uploads",Z.stores.pending_uploads),L+=await M("section_embeddings",Z.stores.section_embeddings);try{B.close()}catch{}return L}let yt="ttree_pending_quick_notes_v1";function ut(){try{let Z=window.localStorage.getItem(yt)||"";if(!Z)return[];let se=JSON.parse(Z);return Array.isArray(se)?se.filter(Boolean):[]}catch{return[]}}function Tt(Z){try{window.localStorage.setItem(yt,JSON.stringify(Array.isArray(Z)?Z:[]))}catch{}}function Zt(Z){let se=String(Z||"").trim();if(!se)return null;let y=Y(),g={id:y,sectionId:y,createdAt:re(),text:se},B=ut(),M=[g,...B].slice(0,o);return Tt(M),w("saved.pending",{id:g.id,len:M.length}),g}function G(){if(document.getElementById("quickNoteBootStyles"))return;let Z=document.createElement("style");Z.id="quickNoteBootStyles",Z.textContent=`
      .boot-modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.22);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);z-index:99999;display:flex;align-items:center;justify-content:center;padding:16px}
      .boot-modal{width:min(720px,100%);background:rgba(255,255,255,.92);border:1px solid rgba(203,213,225,.9);border-radius:16px;box-shadow:0 24px 80px rgba(15,23,42,.18);color:#0f172a}
      .boot-modal__hdr{padding:14px 16px;border-bottom:1px solid rgba(203,213,225,.7);display:flex;align-items:center;justify-content:space-between;gap:12px}
      .boot-modal__title{font-size:14px;font-weight:600;letter-spacing:.2px}
      .boot-modal__meta{font-size:12px;color:#64748b}
      .boot-modal__body{padding:12px 16px}
      .boot-note{width:100%;min-height:34vh;max-height:52vh;resize:vertical;background:rgba(255,255,255,.95);color:#0f172a;border:1px solid rgba(203,213,225,.9);border-radius:12px;padding:12px 12px;font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;outline:none}
      .boot-note:focus{border-color:rgba(37,99,235,.65);box-shadow:0 0 0 4px rgba(37,99,235,.14)}
      .boot-modal__ftr{padding:12px 16px;border-top:1px solid rgba(203,213,225,.7);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
      .boot-actions{display:flex;gap:10px;flex-wrap:wrap}
      .boot-btn{appearance:none;border:1px solid rgba(203,213,225,.9);background:rgba(255,255,255,.7);color:#0f172a;border-radius:999px;padding:10px 14px;font:600 13px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;cursor:pointer}
      .boot-btn:hover{background:rgba(241,245,249,.9)}
      .boot-btn--primary{background:#007ACC;border-color:#007ACC;color:#ffffff}
      .boot-btn--primary:hover{background:#1d4ed8}
      .boot-btn--ghost{background:transparent}
      .boot-hint{font-size:12px;color:#64748b}
      .boot-toast{margin-left:auto;font-size:12px;color:#16a34a}
    `,document.head.appendChild(Z)}function ie(Z,{timeout:se=5e3,fallbackDelay:y=1200}={}){try{if(typeof requestIdleCallback=="function"){requestIdleCallback(()=>Z(),{timeout:se});return}}catch{}setTimeout(()=>Z(),y)}function be(){ie(()=>{try{import(e).catch(()=>{})}catch{}})}function pe({reason:Z=""}={}){G();let se=document.createElement("div");se.className="boot-modal-backdrop";let y=document.createElement("div");y.className="boot-modal";let g=document.createElement("div");g.className="boot-modal__hdr";let B=document.createElement("div"),M=document.createElement("div");M.className="boot-modal__title",M.textContent="\u0411\u044B\u0441\u0442\u0440\u0430\u044F \u0437\u0430\u043C\u0435\u0442\u043A\u0430",B.appendChild(M);let L=document.createElement("button");L.type="button",L.className="boot-btn boot-btn--ghost",L.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",g.appendChild(B),g.appendChild(L);let _=document.createElement("div");_.className="boot-modal__body";let P=document.createElement("textarea");P.className="boot-note",P.placeholder=`\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0443\u2026

Ctrl+Enter \u2014 \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C
Esc \u2014 \u0437\u0430\u043A\u0440\u044B\u0442\u044C`,_.appendChild(P);let H=document.createElement("div");H.className="boot-modal__ftr";let N=document.createElement("div");N.className="boot-hint",N.textContent="\u0417\u0430\u043C\u0435\u0442\u043A\u0438 \u0441\u043E\u0445\u0440\u0430\u043D\u044F\u044E\u0442\u0441\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E \u0438 \u0431\u0443\u0434\u0443\u0442 \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u044B \u0432 \u201C\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438\u201D \u043F\u0440\u0438 \u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0435\u043C \u0432\u0445\u043E\u0434\u0435.";let E=document.createElement("div");E.className="boot-actions";let k=document.createElement("button");k.type="button",k.className="boot-btn boot-btn--primary",k.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C";let x=document.createElement("button");x.type="button",x.className="boot-btn",x.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0438 \u0435\u0449\u0451",E.appendChild(k),E.appendChild(x);let v=document.createElement("div");v.className="boot-toast",H.appendChild(N),H.appendChild(E),H.appendChild(v),y.appendChild(g),y.appendChild(_),y.appendChild(H),se.appendChild(y);let I=()=>{try{se.remove()}catch{}},D=U=>{let V=Zt(P.value);if(V){P.value="",v.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E",$();try{window.dispatchEvent(new CustomEvent("memus:queued-inbox-changed",{detail:{note:V}})),w("event.dispatched",{type:"memus:queued-inbox-changed"})}catch{}U||I(),setTimeout(()=>{try{v.textContent=""}catch{}},1200)}};L.addEventListener("click",I),se.addEventListener("click",U=>{U.target===se&&I()}),k.addEventListener("click",()=>D(!1)),x.addEventListener("click",()=>D(!0)),P.addEventListener("keydown",U=>{if(U.key==="Escape"){U.preventDefault(),I();return}U.key==="Enter"&&(U.ctrlKey||U.metaKey)&&(U.preventDefault(),D(!0))});let z=async()=>{G();let U=document.createElement("div");U.className="boot-modal-backdrop";let V=document.createElement("div");V.className="boot-modal";let K=document.createElement("div");K.className="boot-modal__hdr";let X=document.createElement("div"),ne=document.createElement("div");ne.className="boot-modal__title",ne.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0445 \u0434\u0430\u043D\u043D\u044B\u0445";let fe=document.createElement("div");fe.className="boot-modal__meta",fe.textContent="\u0418\u0449\u0435\u043C \u0441\u0442\u0430\u0440\u044B\u0435 \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0435 \u0431\u0430\u0437\u044B\u2026",X.appendChild(ne),X.appendChild(fe);let oe=document.createElement("button");oe.type="button",oe.className="boot-btn boot-btn--ghost",oe.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",K.appendChild(X),K.appendChild(oe);let Se=document.createElement("div");Se.className="boot-modal__body";let Ie=document.createElement("div");Ie.style.display="flex",Ie.style.flexDirection="column",Ie.style.gap="10px",Se.appendChild(Ie);let Re=document.createElement("div");Re.className="boot-modal__ftr";let Ye=document.createElement("div");Ye.className="boot-hint",Ye.textContent="\u0415\u0441\u043B\u0438 \u043F\u043E\u0441\u043B\u0435 \u0432\u0445\u043E\u0434\u0430 \u0432\u0441\u0435 \u0441\u0442\u0430\u0442\u044C\u0438 \u043F\u0440\u043E\u043F\u0430\u043B\u0438, \u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E \u0438\u0437\u043C\u0435\u043D\u0438\u043B\u0441\u044F userKey. \u0417\u0434\u0435\u0441\u044C \u043C\u043E\u0436\u043D\u043E \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0430\u0440\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 \u0438\u043B\u0438 \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0438\u0445 \u0432 \u0442\u0435\u043A\u0443\u0449\u0435\u0433\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F.";let De=document.createElement("div");De.className="boot-toast",Re.appendChild(Ye),Re.appendChild(De),V.appendChild(K),V.appendChild(Se),V.appendChild(Re),U.appendChild(V);let Ke=()=>{try{U.remove()}catch{}};oe.addEventListener("click",Ke),U.addEventListener("click",qe=>{qe.target===U&&Ke()}),document.body.appendChild(U);let nt=(qe,{articleCount:Bt}={})=>{let Lt=document.createElement("div");Lt.style.border="1px solid rgba(255,255,255,.12)",Lt.style.borderRadius="12px",Lt.style.padding="12px",Lt.style.display="flex",Lt.style.flexDirection="column",Lt.style.gap="10px";let F=document.createElement("div");F.style.display="flex",F.style.alignItems="baseline",F.style.justifyContent="space-between",F.style.gap="12px";let ee=document.createElement("div");ee.style.fontWeight="600",ee.style.fontSize="13px",ee.textContent=qe;let W=document.createElement("div");W.dataset.recoveryMeta="1",W.style.fontSize="12px",W.style.color="#9ca3af",W.textContent=typeof Bt=="number"?`\u0421\u0442\u0430\u0442\u0435\u0439: ${Bt}`:"",F.appendChild(ee),F.appendChild(W);let j=document.createElement("div");j.className="boot-actions";let ce=document.createElement("button");ce.type="button",ce.className="boot-btn",ce.textContent="\u042D\u043A\u0441\u043F\u043E\u0440\u0442 JSON";let ge=document.createElement("button");ge.type="button",ge.className="boot-btn boot-btn--primary",ge.textContent="\u0418\u043C\u043F\u043E\u0440\u0442 \u0432 \u0442\u0435\u043A\u0443\u0449\u0435\u0433\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F";let he=document.createElement("button");return he.type="button",he.className="boot-btn",he.textContent="\u041D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440",j.appendChild(ce),j.appendChild(ge),j.appendChild(he),Lt.appendChild(F),Lt.appendChild(j),ce.addEventListener("click",async()=>{let xe=performance.now();try{De.textContent="\u042D\u043A\u0441\u043F\u043E\u0440\u0442\u2026",p("export.start",{userKey:qe});let de=await Ct(qe),Me=`memus-offline-recovery-${qe}-${new Date().toISOString().replace(/[:.]/g,"-")}`,we=await En(Me,de);p("export.done",{userKey:qe,ok:we.ok,method:we.method,filename:we.filename,ms:Math.round(performance.now()-xe)}),De.textContent=we.ok?we.method==="download"?`\u0421\u043A\u0430\u0447\u0438\u0432\u0430\u043D\u0438\u0435 \u043D\u0430\u0447\u0430\u043B\u043E\u0441\u044C: ${we.filename}`:we.method==="open"?`\u041E\u0442\u043A\u0440\u044B\u043B \u0444\u0430\u0439\u043B \u0432 \u043D\u043E\u0432\u043E\u0439 \u0432\u043A\u043B\u0430\u0434\u043A\u0435: ${we.filename}`:`\u042D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043E: ${we.filename}`:"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C (\u043E\u0433\u0440\u0430\u043D\u0438\u0447\u0435\u043D\u0438\u044F \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0430)"}catch(de){f("export.button.error",{userKey:qe,message:String(de?.message||de),stack:String(de?.stack||"")}),De.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430 \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0430: ${String(de&&de.message?de.message:de)}`}finally{setTimeout(()=>{try{De.textContent=""}catch{}},8e3)}}),ge.addEventListener("click",async()=>{let xe=performance.now();try{let de=vn();if(!de){De.textContent="\u041D\u0435\u0442 \u201C\u0442\u0435\u043A\u0443\u0449\u0435\u0433\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\u201D \u0432 localStorage. \u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0434\u0438\u043D \u0440\u0430\u0437 \u0432\u043E\u0439\u0434\u0438\u0442\u0435.";return}De.textContent="\u0418\u043C\u043F\u043E\u0440\u0442\u2026",p("import.start",{from:qe,to:de});let Me=await Ct(qe),we=await zt(Me,de);try{window.localStorage.setItem(d,"1")}catch{}let He=await te(`${l}${de}`).catch(()=>null),Oe=null,Le=null;if(He){Oe=await je(He,"articles").catch(()=>null),Le=await je(He,"outline_sections").catch(()=>null);try{He.close()}catch{}}p("import.done",{from:qe,to:de,imported:we,targetArticles:Oe,targetSections:Le,ms:Math.round(performance.now()-xe)});let Be=typeof Oe=="number"?` (\u0432 \u0431\u0430\u0437\u0435 \u0441\u0442\u0430\u0442\u0435\u0439: ${Oe})`:"";De.textContent=`\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0437\u0430\u043F\u0438\u0441\u0435\u0439: ${we}${Be}`;try{window.dispatchEvent(new CustomEvent("memus:offline-recovery-imported",{detail:{from:qe,to:de}}))}catch{}}catch(de){f("import.button.error",{userKey:qe,message:String(de?.message||de),stack:String(de?.stack||"")}),De.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430 \u0438\u043C\u043F\u043E\u0440\u0442\u0430: ${String(de&&de.message?de.message:de)}`}finally{setTimeout(()=>{try{De.textContent=""}catch{}},8e3)}}),he.addEventListener("click",async()=>{let xe=performance.now();try{De.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u043D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u2026",p("restore.server.start",{userKey:qe});let de=await _n({userKey:qe,onProgress:Me=>{let we=Me.phase;we==="content"?De.textContent=`\u041D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440: ${Me.idx}/${Me.total} \xB7 ${Me.title||Me.articleId}`:we==="structure"?De.textContent=`\u0421\u0442\u0440\u0443\u043A\u0442\u0443\u0440\u0430\u2026 (${Me.moved}/${Me.total})`:we==="done"&&(De.textContent=`\u0413\u043E\u0442\u043E\u0432\u043E: \u0441\u0442\u0430\u0442\u0435\u0439=${Me.total}, \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E=${Me.saved}`),p("restore.server.progress",Me)}});p("restore.server.done",{...de,ms:Math.round(performance.now()-xe)}),De.textContent=`\u041D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440: \u0441\u0442\u0430\u0442\u0435\u0439=${de.total}, \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E=${de.saved}`}catch(de){f("restore.server.error",{userKey:qe,message:String(de?.message||de),stack:String(de?.stack||"")}),De.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430: ${String(de?.message||de)}`}finally{setTimeout(()=>{try{De.textContent=""}catch{}},12e3)}}),Lt};try{let qe=await Ee();if(!qe.length){fe.textContent="\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0435 \u0431\u0430\u0437\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B. \u0415\u0441\u043B\u0438 \u0432\u044B \u0442\u043E\u0447\u043D\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043B\u0438\u0441\u044C Memus \u043D\u0430 \u044D\u0442\u043E\u043C \u0443\u0441\u0442\u0440\u043E\u0439\u0441\u0442\u0432\u0435, \u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E \u0431\u0440\u0430\u0443\u0437\u0435\u0440 \u043D\u0435 \u0434\u0430\u0451\u0442 \u043F\u0435\u0440\u0435\u0447\u0438\u0441\u043B\u044F\u0442\u044C IndexedDB.";return}fe.textContent=`\u041D\u0430\u0439\u0434\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0445 \u0431\u0430\u0437: ${qe.length}`;for(let Bt of qe){let Lt=nt(Bt);Ie.appendChild(Lt);let F=await te(`${l}${Bt}`).catch(()=>null);if(F){let ee=await je(F,"articles").catch(()=>null);try{F.close()}catch{}if(typeof ee=="number")try{let W=Lt.querySelector('[data-recovery-meta="1"]');W&&(W.textContent=`\u0421\u0442\u0430\u0442\u0435\u0439: ${ee}`)}catch{}}}}catch(qe){fe.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430: ${String(qe&&qe.message?qe.message:qe)}`}};document.body.appendChild(se),setTimeout(()=>P.focus({preventScroll:!0}),0)}function me(){let Z=()=>$();try{window.addEventListener("pointerdown",Z,{passive:!0}),window.addEventListener("keydown",Z,{passive:!0}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&Z()})}catch{}}function ve(){let Z=()=>{try{Promise.resolve().then(()=>(li(),ci)).then(se=>se.flushOutlineAutosave?.({mode:"queue"})).catch(()=>{})}catch{}try{Promise.resolve().then(()=>(sa(),ia)).then(se=>se.flushOutboxOnce?.()).catch(()=>{})}catch{}};try{window.addEventListener("pagehide",Z),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&Z()})}catch{}}let ke=!1,le=Z=>{if(!ke){ke=!0;try{document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>pe({reason:Z}),{once:!0}):pe({reason:Z})}catch{}}};function Ne({subtitle:Z=null,error:se=null,showRetry:y=!1,showOffline:g=!1}={}){try{let B=document.getElementById("authOverlay");if(!B)return;let M=document.getElementById("authSubtitle"),L=document.getElementById("authError");if(M&&Z!=null&&(M.textContent=String(Z)),L){let N=se!=null?String(se):"";L.textContent=N,L.classList.toggle("hidden",!N)}let _=B.querySelector(".auth-card")||B,P=document.getElementById("bootLoadActions");P||(P=document.createElement("div"),P.id="bootLoadActions",P.style.display="flex",P.style.gap="10px",P.style.flexWrap="wrap",P.style.marginTop="12px",_.appendChild(P)),P.innerHTML="";let H=(N,E)=>{let k=document.createElement("button");return k.type="button",k.className="auth-submit",k.style.padding="10px 14px",k.style.borderRadius="999px",k.style.fontSize="13px",k.textContent=N,k.addEventListener("click",E),k};if(y&&P.appendChild(H("\u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C",()=>{try{window.location.reload()}catch{}})),g){let N=()=>{let E=!1;try{E=!!("serviceWorker"in navigator&&navigator.serviceWorker?.controller)}catch{E=!1}if(C()&&!E){Ne({subtitle:"\u041D\u0435\u0442 \u0441\u0435\u0442\u0438",error:`\u041E\u0444\u0444\u043B\u0430\u0439\u043D-\u0440\u0435\u0436\u0438\u043C \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u043F\u043E\u0441\u043B\u0435 \u0442\u043E\u0433\u043E, \u043A\u0430\u043A \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435 \u0445\u043E\u0442\u044F \u0431\u044B \u043E\u0434\u0438\u043D \u0440\u0430\u0437 \u043E\u0442\u043A\u0440\u044B\u043B\u043E\u0441\u044C \u0441 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u043E\u043C \u0438 \u0437\u0430\u043A\u0435\u0448\u0438\u0440\u043E\u0432\u0430\u043B\u043E \u0444\u0430\u0439\u043B\u044B.

\u0415\u0441\u043B\u0438 \u0432\u044B \u0442\u043E\u043B\u044C\u043A\u043E \u0447\u0442\u043E \u0443\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u043B\u0438 PWA \u2014 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0435\u0433\u043E \u043E\u043D\u043B\u0430\u0439\u043D, \u0434\u043E\u0436\u0434\u0438\u0442\u0435\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438, \u0437\u0430\u0442\u0435\u043C \u043C\u043E\u0436\u043D\u043E \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u0431\u0435\u0437 \u0441\u0435\u0442\u0438.`,showRetry:!0,showOffline:!0});return}try{window.sessionStorage?.setItem?.(m,"1")}catch{}try{let x=document.getElementById("authSubtitle");x&&(x.textContent="\u041E\u0442\u043A\u0440\u044B\u0432\u0430\u0435\u043C \u0430\u0432\u0442\u043E\u043D\u043E\u043C\u043D\u044B\u0439 \u0440\u0435\u0436\u0438\u043C\u2026");let v=document.getElementById("authError");v&&(v.textContent="",v.classList.add("hidden"))}catch{}try{if(E){window.location.reload();return}}catch{}try{window.location.reload();return}catch{}try{Ze({reason:"offline_button",background:!1})}catch{}};P.appendChild(H("\u041E\u0442\u043A\u0440\u044B\u0442\u044C \u043E\u0444\u0444\u043B\u0430\u0439\u043D-\u0431\u0443\u0444\u0435\u0440",()=>{try{N()}catch{}}))}}catch{}}let Fe=!1,ze=!1;function Ze({reason:Z="",background:se=!1}={}){if(!ze&&!(Fe&&!se)){Fe=!0;try{let y=import(e);y&&typeof y.catch=="function"&&y.catch(g=>{ze=!0;let M="\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435. "+(C()?"\u041F\u043E\u0445\u043E\u0436\u0435, \u0441\u0435\u0439\u0447\u0430\u0441 \u043D\u0435\u0442 \u0441\u0435\u0442\u0438.":"\u041F\u043E\u0445\u043E\u0436\u0435, \u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u0435\u0442\u044C\u044E/\u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C.")+" \u041C\u043E\u0436\u043D\u043E \u043F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C \u0432 \u0430\u0432\u0442\u043E\u043D\u043E\u043C\u043D\u043E\u043C \u0440\u0435\u0436\u0438\u043C\u0435 \u0438\u043B\u0438 \u043F\u043E\u043F\u0440\u043E\u0431\u043E\u0432\u0430\u0442\u044C \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443.";if(Ne({subtitle:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",error:M,showRetry:!0,showOffline:!0}),!h)try{ke||le("\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438")}catch{}w("app.import.failed",{reason:Z,message:String(g?.message||g||"")})})}catch(y){ze=!0,Ne({subtitle:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",error:"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435. \u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443.",showRetry:!0,showOffline:!0}),w("app.import.throw",{reason:Z,message:String(y?.message||y||"")})}}}if(A()){S(),Ze({reason:"public",background:!1});return}S();let Ge=R(),et=Q(),Ue=C(),it=T(),st=q();me(),ve(),$(),(Ue&&!h||it||st||Ge&&et)&&le(Ue?"\u043D\u0435\u0442 \u0441\u0435\u0442\u0438":it?"\u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430":st?"\u043F\u0440\u043E\u0441\u0442\u043E\u0439 > 15 \u043C\u0438\u043D":"\u0445\u043E\u043B\u043E\u0434\u043D\u044B\u0439 \u0441\u0442\u0430\u0440\u0442"),window.setTimeout(()=>{try{if(ke||window.__memusAppStarted||h)return;Ne({subtitle:"\u041C\u0435\u0434\u043B\u0435\u043D\u043D\u0430\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430\u2026",error:"\u0415\u0441\u043B\u0438 \u0441\u0435\u0442\u044C \u043D\u0435\u0441\u0442\u0430\u0431\u0438\u043B\u044C\u043D\u0430, \u043C\u043E\u0436\u043D\u043E \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u043E\u0444\u0444\u043B\u0430\u0439\u043D-\u0431\u0443\u0444\u0435\u0440. \u041F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435 \u043F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442 \u043F\u044B\u0442\u0430\u0442\u044C\u0441\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C\u0441\u044F \u0432 \u0444\u043E\u043D\u0435.",showRetry:!0,showOffline:!0}),le("\u043C\u0435\u0434\u043B\u0435\u043D\u043D\u0430\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430")}catch{}},s),ke||Ue?ie(()=>Ze({reason:"idle",background:!0}),{timeout:5e3,fallbackDelay:1200}):Ze({reason:"foreground",background:!1})})();
