var Sd=Object.defineProperty;var We=(e,t)=>()=>(e&&(t=e(e=0)),t);var So=(e,t)=>{for(var n in t)Sd(e,n,{get:t[n],enumerable:!0})};function oc(e){wi=e}var u,wi,wt=We(()=>{u={mode:"view",serverStatus:"unknown",serverStatusText:"",offlineReady:!1,offlineInitStatus:"idle",offlineInitError:"",offlineInitStartedAt:null,mediaStatusText:"",mediaPrefetchPaused:!1,isOutlineEditing:!1,outlineStatusText:"",isPublicView:!1,isRagView:!1,currentUser:null,articleId:null,article:null,currentBlockId:null,editingBlockId:null,selectionAnchorBlockId:null,selectedBlockIds:[],undoStack:[],redoStack:[],pendingTextPreview:null,editingUndo:null,editingInitialText:"",searchQuery:"",searchResults:[],searchError:"",searchLoading:!1,searchRequestId:0,searchMode:"classic",sidebarSearchView:"list",ragQuery:"",ragResults:[],ragBlockMap:{},ragSummaryHtml:"",ragSummaryLoading:!1,ragSummaryError:"",scrollTargetBlockId:null,pendingEditBlockId:null,isEditingTitle:!1,isSidebarCollapsed:!1,isSidebarMobileOpen:!1,articlesIndex:[],deletedArticlesIndex:[],articleFilterQuery:"",isMarkdownInserting:!1,isTrashView:!1,favoriteArticles:[],sidebarArticlesMode:"tree",recentArticleIds:[],sidebarSelectedArticleId:null,listSelectedArticleId:null,sidebarCollapsedArticleIds:[],listCollapsedArticleIds:[],isDragModeEnabled:!1,articleEncryptionKeys:{},isMergingBlocks:!1,isMovingBlock:!1,isDeletingBlock:!1,moveQueue:[],isMoveQueueProcessing:!1,editingScrollTop:null,editingCaretPosition:"start"},wi=!1});var V,un=We(()=>{V={authOverlay:document.getElementById("authOverlay"),authLoginTab:document.getElementById("authLoginTab"),authRegisterTab:document.getElementById("authRegisterTab"),authLoginForm:document.getElementById("authLoginForm"),authRegisterForm:document.getElementById("authRegisterForm"),authLoginUsername:document.getElementById("authLoginUsername"),authLoginPassword:document.getElementById("authLoginPassword"),authRegisterUsername:document.getElementById("authRegisterUsername"),authRegisterPassword:document.getElementById("authRegisterPassword"),authRegisterDisplayName:document.getElementById("authRegisterDisplayName"),authError:document.getElementById("authError"),authSubtitle:document.getElementById("authSubtitle"),authGoogleLoginBtn:document.getElementById("authGoogleLoginBtn"),authYandexLoginBtn:document.getElementById("authYandexLoginBtn"),authStorageInfo:document.getElementById("authStorageInfo"),currentUserLabel:document.getElementById("currentUserLabel"),logoutBtn:document.getElementById("logoutBtn"),userMenuBtn:document.getElementById("userMenuBtn"),userMenu:document.getElementById("userMenu"),sidebarSyncStatusPill:document.getElementById("sidebarSyncStatusPill"),syncMenu:document.getElementById("syncMenu"),syncMenuStatusLabel:document.getElementById("syncMenuStatusLabel"),syncMenuOutboxLabel:document.getElementById("syncMenuOutboxLabel"),offlineStatusItem:document.getElementById("offlineStatusItem"),offlineStatusLabel:document.getElementById("offlineStatusLabel"),offlineFetchBtn:document.getElementById("offlineFetchBtn"),telegramLinkBtn:document.getElementById("telegramLinkBtn"),telegramBotOpenBtn:document.getElementById("telegramBotOpenBtn"),telegramFeedbackBotOpenBtn:document.getElementById("telegramFeedbackBotOpenBtn"),openUsersViewBtn:document.getElementById("openUsersViewBtn"),usersView:document.getElementById("usersView"),usersList:document.getElementById("usersList"),usersBackBtn:document.getElementById("usersBackBtn"),graphView:document.getElementById("graphView"),graphCanvas:document.getElementById("graphCanvas"),graphBackBtn:document.getElementById("graphBackBtn"),articleListView:document.getElementById("articleListView"),articleView:document.getElementById("articleView"),articleHeader:document.getElementById("articleHeader"),articleTitle:document.getElementById("articleTitle"),updatedAt:document.getElementById("updatedAt"),articleStatusText:document.getElementById("articleStatusText"),mediaStatusText:document.getElementById("mediaStatusText"),mediaPrefetchToggleBtn:document.getElementById("mediaPrefetchToggleBtn"),blocksContainer:document.getElementById("blocksContainer"),articleList:document.getElementById("articleList"),createArticleBtn:document.getElementById("createArticleBtn"),backToList:document.getElementById("backToList"),toast:document.getElementById("toast"),searchInput:document.getElementById("searchInput"),searchClearBtn:document.getElementById("searchClearBtn"),searchResults:document.getElementById("searchResults"),searchPanel:document.querySelector(".search-panel"),searchModeToggle:document.getElementById("searchModeToggle"),sidebarSearchViewToggle:document.getElementById("sidebarSearchViewToggle"),ragOpenBtn:document.getElementById("ragOpenBtn"),articleTitleInput:document.getElementById("articleTitleInput"),editTitleBtn:document.getElementById("editTitleBtn"),hintToggleBtn:document.getElementById("hintToggleBtn"),hintPopover:document.getElementById("hintPopover"),sidebar:document.getElementById("sidebar"),sidebarToggle:document.getElementById("sidebarToggle"),sidebarArticleList:document.getElementById("sidebarArticleList"),sidebarNewArticleBtn:document.getElementById("sidebarNewArticleBtn"),sidebarRecentBtn:document.getElementById("sidebarRecentBtn"),openInboxBtn:document.getElementById("openInboxBtn"),quickNoteAddBtn:document.getElementById("quickNoteAddBtn"),articleFilterInput:document.getElementById("articleFilterInput"),trashTabBtn:document.getElementById("trashTabBtn"),articlesTabBtn:document.getElementById("articlesTabBtn"),semanticReindexBtn:document.getElementById("semanticReindexBtn"),graphToggleBtn:document.getElementById("graphToggleBtn"),listMenuBtn:document.getElementById("listMenuBtn"),listMenu:document.getElementById("listMenu"),articleMenuBtn:document.getElementById("articleMenuBtn"),articleMenu:document.getElementById("articleMenu"),articleFavoriteBtn:document.getElementById("articleFavoriteBtn"),articlePublicLinkBtn:document.getElementById("articlePublicLinkBtn"),articlePublicToggleBtn:document.getElementById("articlePublicToggleBtn"),articleEncryptionBtn:document.getElementById("articleEncryptionBtn"),articleEncryptionRemoveBtn:document.getElementById("articleEncryptionRemoveBtn"),deleteArticleBtn:document.getElementById("deleteArticleBtn"),exportArticleBtn:document.getElementById("exportArticleBtn"),outlineEditBtn:document.getElementById("outlineEditBtn"),saveVersionBtn:document.getElementById("saveVersionBtn"),versionsBtn:document.getElementById("versionsBtn"),blockHistoryBtn:document.getElementById("blockHistoryBtn"),articleHistoryBtn:document.getElementById("articleHistoryBtn"),exportAllHtmlZipBtn:document.getElementById("exportAllHtmlZipBtn"),importArticleBtn:document.getElementById("importArticleBtn"),importMarkdownBtn:document.getElementById("importMarkdownBtn"),importLogseqBtn:document.getElementById("importLogseqBtn"),importBackupFolderBtn:document.getElementById("importBackupFolderBtn"),articleUndoBtn:document.getElementById("articleUndoBtn"),articleRedoBtn:document.getElementById("articleRedoBtn"),mergeBlocksBtn:document.getElementById("mergeBlocksBtn"),splitBlockBtn:document.getElementById("splitBlockBtn"),insertTableBtn:document.getElementById("insertTableBtn"),deleteCurrentBlockBtn:document.getElementById("deleteCurrentBlockBtn"),exportCurrentBlockBtn:document.getElementById("exportCurrentBlockBtn"),articleBlockTrashBtn:document.getElementById("articleBlockTrashBtn"),articleNewBlockBtn:document.getElementById("articleNewBlockBtn"),articleToolbar:document.getElementById("articleToolbar"),outlineToolbar:document.getElementById("outlineToolbar"),outlineTagsBar:document.getElementById("outlineTagsBar"),outlineUndoBtn:document.getElementById("outlineUndoBtn"),outlineRedoBtn:document.getElementById("outlineRedoBtn"),outlineDeleteBtn:document.getElementById("outlineDeleteBtn"),outlineMoveUpBtn:document.getElementById("outlineMoveUpBtn"),outlineMoveDownBtn:document.getElementById("outlineMoveDownBtn"),outlineOutdentBtn:document.getElementById("outlineOutdentBtn"),outlineIndentBtn:document.getElementById("outlineIndentBtn"),outlineNewBelowBtn:document.getElementById("outlineNewBelowBtn"),outlineBoldBtn:document.getElementById("outlineBoldBtn"),outlineBulletListBtn:document.getElementById("outlineBulletListBtn"),outlineOrderedListBtn:document.getElementById("outlineOrderedListBtn"),outlineBlockquoteBtn:document.getElementById("outlineBlockquoteBtn"),outlineCodeBtn:document.getElementById("outlineCodeBtn"),outlineInsertTableBtn:document.getElementById("outlineInsertTableBtn"),outlineDeleteTableBtn:document.getElementById("outlineDeleteTableBtn"),outlineAddRowBtn:document.getElementById("outlineAddRowBtn"),outlineAddColBtn:document.getElementById("outlineAddColBtn"),pasteProgress:document.getElementById("pasteProgress"),mobileSidebarBtn:document.getElementById("mobileSidebarBtn"),sidebarBackdrop:document.getElementById("sidebarBackdrop"),dragModeToggleBtn:document.getElementById("dragModeToggleBtn"),listSidebarBtn:document.getElementById("listSidebarBtn"),outlineEditor:document.getElementById("outlineEditor")}});function ic(){Fr!==null&&(clearTimeout(Fr),Fr=null)}function xi(e){Si=!!e,V.toast&&(Si?V.toast.dataset.protected="true":V.toast.removeAttribute("data-protected"))}function ve(e,t={}){if(!V.toast)return;let n=typeof t.duration=="number"?t.duration:2500;t.protect?xi(!0):xi(!1),ic(),V.toast.textContent=e,V.toast.classList.remove("hidden"),requestAnimationFrame(()=>{V.toast.classList.add("show")}),n>0&&(Fr=setTimeout(()=>{V.toast.classList.remove("show"),setTimeout(()=>V.toast.classList.add("hidden"),200),Fr=null},n))}function Ai(e,t={}){ve(e,{...t,duration:0})}function or(e={}){V.toast&&(Si&&!e.force||(ic(),xi(!1),V.toast.classList.remove("show"),V.toast.classList.add("hidden")))}var Fr,Si,Vt=We(()=>{un();Fr=null,Si=!1;V.toast&&V.toast.addEventListener("click",()=>{or()})});function _e(e){return new Promise((t,n)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error||new Error("IndexedDB request failed"))})}function et(e){return new Promise((t,n)=>{e.oncomplete=()=>t(),e.onabort=()=>n(e.error||new Error("IndexedDB transaction aborted")),e.onerror=()=>n(e.error||new Error("IndexedDB transaction failed"))})}function xd(e){return String(e||"anon").replace(/[^a-zA-Z0-9_-]/g,"_")}function Ad(e){return`memus_offline_v1_${xd(e)}`}function kd(e){try{let t=String(e||"").trim();if(!t)return;let n=window?.localStorage?.getItem?.(sc)||"[]",r=JSON.parse(n),o=Array.isArray(r)?r:[];o.includes(t)||o.push(t),window.localStorage.setItem(sc,JSON.stringify(o.slice(-200)))}catch{}}async function cc({userKey:e}={}){let t=e||"anon";kd(t);let n=Ad(t),r=indexedDB.open(n,Id);r.onupgradeneeded=()=>{let i=r.result;if(i.objectStoreNames.contains("meta")||i.createObjectStore("meta",{keyPath:"key"}),!i.objectStoreNames.contains("articles")){let s=i.createObjectStore("articles",{keyPath:"id"});s.createIndex("byUpdatedAt","updatedAt",{unique:!1}),s.createIndex("byDeletedAt","deletedAt",{unique:!1})}if(!i.objectStoreNames.contains("outline_sections")){let s=i.createObjectStore("outline_sections",{keyPath:"sectionId"});s.createIndex("byArticleId","articleId",{unique:!1}),s.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!i.objectStoreNames.contains("section_embeddings")){let s=i.createObjectStore("section_embeddings",{keyPath:"sectionId"});s.createIndex("byArticleId","articleId",{unique:!1}),s.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!i.objectStoreNames.contains("media_assets")){let s=i.createObjectStore("media_assets",{keyPath:"url"});s.createIndex("byStatus","status",{unique:!1}),s.createIndex("byFetchedAtMs","fetchedAtMs",{unique:!1}),s.createIndex("byStatusFetchedAtMs",["status","fetchedAtMs"],{unique:!1})}if(!i.objectStoreNames.contains("media_refs")){let s=i.createObjectStore("media_refs",{keyPath:"key"});s.createIndex("byArticleId","articleId",{unique:!1}),s.createIndex("byUrl","url",{unique:!1})}if(i.objectStoreNames.contains("outbox")){let s=r.transaction;try{let c=s.objectStore("outbox");c.indexNames.contains("byTypeCoalesceKey")||c.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}catch{}}else{let s=i.createObjectStore("outbox",{keyPath:"id"});s.createIndex("byCreatedAtMs","createdAtMs",{unique:!1}),s.createIndex("byTypeArticleId",["type","articleId"],{unique:!1}),s.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}if(!i.objectStoreNames.contains("pending_uploads")){let s=i.createObjectStore("pending_uploads",{keyPath:"token"});s.createIndex("byArticleId","articleId",{unique:!1}),s.createIndex("byCreatedAtMs","createdAtMs",{unique:!1})}};let o=await _e(r);try{o.onversionchange=()=>{try{o.close()}catch{}}}catch{}return o}async function ac(e){let t=e.transaction(["meta"],"readonly"),n=t.objectStore("meta");await _e(n.get("ping")),await et(t)}var Id,sc,xn=We(()=>{Id=3,sc="ttree_offline_known_user_keys_v1"});async function Ao({userKey:e}={}){let t=String(e||"").trim();if(!t||t==="anon")try{let n=window?.localStorage?.getItem?.("ttree_offline_user_key_v1")||"",r=String(n||"").trim();r&&(t=r)}catch{}if(!t||t==="anon")try{let n=window?.localStorage?.getItem?.("ttree_last_user_v1")||"",r=n?JSON.parse(n):null,o=String(r?.id||r?.username||"").trim();o&&(t=o)}catch{}return t||(t="anon"),xo&&lc===t||(lc=t,xo=(async()=>await cc({userKey:t}))()),xo}var xo,lc,Ii=We(()=>{xn();xo=null,lc=null});function ko(){try{return window?.localStorage?.getItem?.(vd)==="1"}catch{return!1}}function pc(){try{return window?.localStorage?.getItem?.(Ed)==="1"}catch{return!1}}function ki(e,t={}){try{if(!ko())return;console.log("[perf][offline]",e,t)}catch{}}function Cd(){try{let e=window.__BUILD_ID__;return e?String(e):""}catch{return""}}function vi(e,t){try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:e,data:t})}).catch(()=>{})}catch{}}async function Ei(){let e={};try{e.ua=navigator?.userAgent||""}catch{e.ua=""}try{e.buildId=Cd()}catch{e.buildId=""}try{e.onLine=navigator?.onLine!==!1}catch{e.onLine=null}try{e.indexedDB=typeof indexedDB<"u"}catch{e.indexedDB=null}try{e.storagePersist=typeof navigator?.storage?.persist=="function"}catch{e.storagePersist=null}try{e.storageEstimate=typeof navigator?.storage?.estimate=="function"}catch{e.storageEstimate=null}try{if(navigator?.storage?.estimate){let t=await navigator.storage.estimate().catch(()=>null);t&&typeof t=="object"&&(e.quota=Number(t.quota||0)||null,e.usage=Number(t.usage||0)||null)}}catch{}return e}function Td(e){try{let t=window?.localStorage?.getItem?.("ttree_offline_user_key_v1")||"",n=String(t||"").trim();if(n)return n}catch{}return e&&(e.id||e.username)||"anon"}async function Bd(e){let t=Td(e);if(xr&&dc===t)return xr;dc=t,uc+=1;let n=uc;return xr=(async()=>{let r=ko()?performance.now():0;u.offlineReady=!1,u.offlineInitStatus="initializing",u.offlineInitError="",u.offlineInitStartedAt=Date.now();try{if(fc!==n){fc=n;let o=await Ei().catch(()=>({}));vi("offline.init.start",{t:new Date().toISOString(),attempt:n,userKey:t,env:o})}}catch{}try{pc()&&console.log("[offline] init start",{userKey:t})}catch{}try{let o=ko()?performance.now():0,i=await Ao({userKey:t});o&&ki("getOfflineDb()",{ms:Math.round(performance.now()-o)});let s=ko()?performance.now():0;await ac(i),s&&ki("idb.ping",{ms:Math.round(performance.now()-s)});try{navigator?.storage?.persist&&navigator.storage.persist().catch(()=>{})}catch{}u.offlineReady=!0,u.offlineInitStatus="ready",u.offlineInitError="",u.offlineInitStartedAt=null;try{if(Io!==n){Io=n;let c=await Ei().catch(()=>({}));vi("offline.init.ready",{t:new Date().toISOString(),attempt:n,userKey:t,env:c})}}catch{}try{pc()&&console.log("[offline] init ready")}catch{}return r&&ki("initOfflineForUser.total",{userKey:t,ms:Math.round(performance.now()-r)}),i}catch(o){u.offlineReady=!1,u.offlineInitStatus="error",u.offlineInitStartedAt=null;try{console.error("[offline] init failed",o)}catch{}let i=o?.message?`Offline \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430: ${o.message}`:"Offline \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0432 \u044D\u0442\u043E\u043C \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435";u.offlineInitError=i,ve(i);try{if(Io!==n){Io=n;let s=await Ei().catch(()=>({}));vi("offline.init.failed",{t:new Date().toISOString(),attempt:n,userKey:t,msg:i,err:{name:String(o?.name||""),message:String(o?.message||""),stack:String(o?.stack||"").slice(0,1500)},env:s})}}catch{}throw o}})(),xr}async function pt(){return xr||Bd(u.currentUser)}var xr,dc,uc,fc,Io,vd,Ed,ir=We(()=>{wt();Vt();Ii();xn();xr=null,dc=null,uc=0,fc=null,Io=null,vd="ttree_profile_v1",Ed="ttree_debug_offline_v1"});function Ci(e){if(!e)return"";if(e.type==="text")return String(e.text||"");let t=Array.isArray(e.content)?e.content:[];if(!t.length)return"";let n=[];for(let r of t){let o=Ci(r);o&&n.push(o),r&&(r.type==="paragraph"||r.type==="hardBreak"||r.type==="heading")&&n.push(`
`)}return n.join("")}function mc(e){return String(e||"").replace(/\r\n/g,`
`).replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}function hc(e,t=[]){for(let n of e||[]){if(!n||n.type!=="outlineSection")continue;let r=String(n.attrs?.id||""),o=n.content?.[0],i=n.content?.[1],s=n.content?.[2],c=mc(Ci(o))||"",a=mc(Ci(i))||"",l=`${c}
${a}`.trim();r&&t.push({sectionId:r,title:c,text:l});let d=s?.content||[];hc(d,t)}return t}function Nd(e){let t=Array.isArray(e?.content)?e.content:[];return hc(t,[])}async function vo(e,{articleId:t,docJson:n,updatedAt:r}){if(!e||!t||!n||typeof n!="object")return;let o=Nd(n),i=e.transaction(["outline_sections"],"readwrite"),s=i.objectStore("outline_sections"),c=s.index("byArticleId"),a=IDBKeyRange.only(String(t)),l=await _e(c.openCursor(a));for(;l;)l.delete(),l=await _e(l.continue());for(let d of o)await _e(s.put({sectionId:d.sectionId,articleId:String(t),title:d.title||"",text:d.text||"",updatedAt:r||null}));await et(i)}var gc=We(()=>{xn()});function Ld(){try{return localStorage.getItem(Md)==="1"}catch{return!1}}function Pd(e){let t=String(e||"").trim();if(!t)return null;try{let n=new URL(t,window.location.origin);return n.origin!==window.location.origin?/^https?:\/\/memus\.pro\b/i.test(t)&&n.pathname.startsWith("/uploads/")?n.pathname+(n.search||""):null:n.pathname.startsWith("/uploads/")?n.pathname+(n.search||""):null}catch{return t.startsWith("/uploads/")?t:null}}function _d(e){let t=new Set,n=r=>{if(!r)return;if(Array.isArray(r)){r.forEach(n);return}if(r.type==="image"){let i=Pd(r.attrs?.src);i&&t.add(i)}(Array.isArray(r.content)?r.content:[]).forEach(n)};return n(e?.content||[]),Array.from(t)}async function Ar(e,t){let n=await pt(),r=_d(t),o=n.transaction(["media_refs","media_assets"],"readwrite"),i=o.objectStore("media_refs"),s=o.objectStore("media_assets"),c=i.index("byArticleId"),a=IDBKeyRange.only(String(e)),l=await _e(c.openCursor(a)).catch(()=>null);for(;l;)l.delete(),l=await _e(l.continue()).catch(()=>null);for(let d of r){let p=`${String(e)}|${String(d)}`;await _e(i.put({key:p,articleId:String(e),url:String(d)})),await _e(s.get(d)).catch(()=>null)||await _e(s.put({url:String(d),status:"needed",fetchedAtMs:0,failCount:0,lastError:null}))}await et(o)}async function yc(e,t){let n=e.transaction(["media_assets"],"readwrite"),r=n.objectStore("media_assets"),o=await _e(r.get(t)).catch(()=>null);await _e(r.put({...o||{},url:String(t),status:"ok",fetchedAtMs:Date.now(),failCount:0,lastError:null})),await et(n)}async function Dd(e,t,n){let r=String(n?.message||n||"error"),o=e.transaction(["media_assets"],"readwrite"),i=o.objectStore("media_assets"),s=await _e(i.get(t)).catch(()=>null),c=Number(s?.failCount||0)+1;await _e(i.put({...s||{},url:String(t),status:"error",fetchedAtMs:Date.now(),failCount:c,lastError:r})),await et(o)}async function Od(e,t){let n=e.transaction(["media_assets"],"readonly"),o=n.objectStore("media_assets").index("byFetchedAtMs"),i=[],s=await _e(o.openCursor()).catch(()=>null);for(;s;){let c=s.value,a=String(c?.status||""),l=Number(c?.failCount||0);if(a!=="ok"&&l<5){let d=String(c?.url||"");if(d&&i.push(d),i.length>=t)break}s=await _e(s.continue()).catch(()=>null)}return await et(n),i}async function Rd(e,t){try{return!!await e.match(t,{ignoreSearch:!1})}catch{return!1}}async function Hd(e,t){let n=await fetch(t,{credentials:"include"});if(!n||!n.ok)throw new Error(`HTTP ${n?.status||0}`);await e.put(t,n.clone())}function $d(){try{let e=navigator.connection||navigator.mozConnection||navigator.webkitConnection,t=String(e?.effectiveType||"");if(!!e?.saveData||t.includes("2g"))return 1;if(t.includes("3g"))return 2}catch{}return 3}function Sc(){if(bc)return;bc=!0;let e=async()=>{if(!navigator.onLine||Ld())return;let t=$d();if(Eo>=t)return;let n=await pt(),r=await caches.open(wc),o=await Od(n,Math.max(5,t*3));if(o.length)for(let i of o){if(Eo>=t)break;Eo+=1,(async()=>{try{if(await Rd(r,i)){await yc(n,i);return}await Hd(r,i),await yc(n,i)}catch(s){await Dd(n,i,s)}finally{Eo-=1}})()}};setInterval(()=>{e().catch(()=>{})},1200),window.addEventListener("online",()=>{e().catch(()=>{})})}async function xc(){let e=await pt(),t=await caches.open(wc),n=e.transaction(["media_assets","media_refs"],"readwrite"),r=n.objectStore("media_assets"),i=n.objectStore("media_refs").index("byUrl"),s=[],c=await _e(r.openCursor()).catch(()=>null);for(;c&&s.length<500;){let a=String(c.value?.url||"");a&&(await _e(i.count(IDBKeyRange.only(a))).catch(()=>0)||(s.push(a),c.delete())),c=await _e(c.continue()).catch(()=>null)}if(await et(n),!s.length)return 0;for(let a of s)try{await t.delete(a)}catch{}return s.length}var wc,Md,bc,Eo,Ti=We(()=>{ir();xn();wc="memus-uploads-v1",Md="ttree_media_prefetch_paused_v1";bc=!1,Eo=0});function qd(e=null){try{if(window?.localStorage?.getItem?.(Fd)!=="1")return!1;let t=String(window?.localStorage?.getItem?.(zd)||"").trim();if(!t)return!0;let n=String(e||"").trim();return n?n===t:!0}catch{return!1}}function Vd(){try{return window?.localStorage?.getItem?.(Ud)==="1"}catch{return!1}}function Jd(e){try{return JSON.stringify(e)}catch{return'"[unserializable]"'}}function jd(e){try{let t=String(e||""),n=2166136261;for(let r=0;r<t.length;r+=1)n^=t.charCodeAt(r),n=Math.imul(n,16777619);return(n>>>0).toString(16)}catch{return"0"}}function Pt(e){try{return!e||typeof e!="object"?null:jd(Jd(e))}catch{return null}}function ot(e,t={}){try{let n=t?.articleId?String(t.articleId):null;if(!qd(n))return!1;let r={t:new Date().toISOString(),kind:String(e||"event"),data:t&&typeof t=="object"?t:{value:t}},o=[];try{let i=window?.localStorage?.getItem?.(Co)||"";o=i?JSON.parse(i):[],Array.isArray(o)||(o=[])}catch{o=[]}o.push(r),o.length>250&&(o=o.slice(o.length-250));try{window?.localStorage?.setItem?.(Co,JSON.stringify(o))}catch{}if(Vd()&&navigator.onLine!==!1)try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:`revert:${r.kind}`,data:r})}).catch(()=>{})}catch{}return!0}catch{return!1}}function Kd(){try{let e=window?.localStorage?.getItem?.(Co)||"",t=e?JSON.parse(e):[];return Array.isArray(t)?t:[]}catch{return[]}}function Wd(){try{window?.localStorage?.removeItem?.(Co)}catch{}}var Fd,zd,Ud,Co,zr=We(()=>{Fd="ttree_debug_revert_v1",zd="ttree_debug_revert_article_v1",Ud="ttree_client_log_v1",Co="ttree_revert_log_v1";try{window.memusRevertLogDump=()=>Kd(),window.memusRevertLogClear=()=>Wd()}catch{}});function Yd(e){return{id:e.id,title:e.title,updatedAt:e.updatedAt,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:!!e.encrypted}}async function Nn(e){let t=await pt(),n=Array.isArray(e)?e:[],r=50;for(let o=0;o<n.length;o+=r){let i=n.slice(o,o+r),s=t.transaction(["articles"],"readwrite"),c=s.objectStore("articles");for(let a of i){let l=Yd(a),p={...await _e(c.get(l.id)).catch(()=>null)||{},id:l.id,title:l.title||"",updatedAt:l.updatedAt||null,parentId:l.parentId??null,position:typeof l.position=="number"?l.position:0,publicSlug:l.publicSlug??null,encrypted:l.encrypted?1:0,deletedAt:null};await _e(c.put(p))}await et(s),await new Promise(a=>setTimeout(a,0))}}async function Ir(){let t=(await pt()).transaction(["articles"],"readonly"),n=t.objectStore("articles"),r=await _e(n.getAll()).catch(()=>[])||[];return await et(t),r.filter(o=>o&&!o.deletedAt).sort((o,i)=>Number(o.position||0)-Number(i.position||0)).map(o=>({id:o.id,title:o.title||"",updatedAt:o.updatedAt||null,parentId:o.parentId??null,position:typeof o.position=="number"?o.position:0,publicSlug:o.publicSlug??null,encrypted:!!o.encrypted}))}async function Ac(){let t=(await pt()).transaction(["articles"],"readonly"),n=t.objectStore("articles"),r=await _e(n.getAll()).catch(()=>[])||[];return await et(t),r.filter(o=>o&&!o.deletedAt).map(o=>({id:o.id,updatedAt:o.updatedAt||null,hasDocJson:!!o.docJsonStr}))}async function kr(e){if(!e||!e.id)return;let t=await pt(),n=e.docJson&&typeof e.docJson=="object"?e.docJson:null,r=e.updatedAt||null,o=t.transaction(["articles"],"readwrite"),i=o.objectStore("articles"),s=await _e(i.get(e.id)).catch(()=>null),c=null;try{c=s?.articleJsonStr?JSON.parse(s.articleJsonStr):null}catch{c=null}let a=!!(c&&c.localDraft),l=e&&Object.prototype.hasOwnProperty.call(e,"outlineStructureRev")?Number(e.outlineStructureRev):null;try{let p=String(s?.updatedAt||"").trim(),h=String(r||"").trim();if(p&&h&&h<p){ot("cache.article.put.skip_older",{articleId:e.id,existingUpdatedAt:p,incomingUpdatedAt:h,incomingDocHash:Pt(n)}),await et(o);return}if(a&&p&&h&&p===h){let y=Pt(s?.docJsonStr?JSON.parse(s.docJsonStr):null),S=Pt(n);if(y&&S&&y!==S){let f=c&&typeof c=="object"?{...c}:{};f.id=e.id,f.title=e.title||f.title||"",f.updatedAt=p,f.parentId=e.parentId??f.parentId??null,f.position=typeof e.position=="number"?e.position:f.position??0,f.publicSlug=e.publicSlug??f.publicSlug??null,f.encrypted=!!e.encrypted,Object.prototype.hasOwnProperty.call(e,"outlineStructureRev")&&(f.outlineStructureRev=Number(e.outlineStructureRev)||0),f.localDraft=!0;let m={...s||{},id:e.id,title:e.title||"",updatedAt:p,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:e.encrypted?1:0,deletedAt:null,outlineStructureRev:Number.isFinite(l)?l:Number(s?.outlineStructureRev),docJsonStr:s?.docJsonStr??null,articleJsonStr:JSON.stringify(f)};await _e(i.put(m)),await et(o);try{ot("cache.article.put.skip_localDraft",{articleId:e.id,updatedAt:p,existingDocHash:y,incomingDocHash:S})}catch{}return}}}catch{}let d={...s||{},id:e.id,title:e.title||"",updatedAt:r,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:e.encrypted?1:0,deletedAt:null,outlineStructureRev:Number.isFinite(l)?l:Number(s?.outlineStructureRev),docJsonStr:n?JSON.stringify(n):null,articleJsonStr:JSON.stringify(e)};await _e(i.put(d)),await et(o);try{ot("cache.article.put",{articleId:e.id,updatedAt:r,hasDocJson:!!n,docHash:Pt(n)})}catch{}n&&(vo(t,{articleId:e.id,docJson:n,updatedAt:r}).catch(()=>{}),Ar(e.id,n).catch(()=>{}))}async function Ic(e,t){if(!e||!t)return;let n=await pt(),r=String(t),o=e.docJson&&typeof e.docJson=="object"?e.docJson:null,i=e.updatedAt||null,s=n.transaction(["articles"],"readwrite"),c=s.objectStore("articles"),a=await _e(c.get(r)).catch(()=>null);try{let d=String(a?.updatedAt||"").trim(),p=String(i||"").trim();if(d&&p&&p<d){ot("cache.articleUnderId.put.skip_older",{articleId:r,existingUpdatedAt:d,incomingUpdatedAt:p,incomingDocHash:Pt(o)}),await et(s);return}}catch{}let l={...a||{},id:r,title:e.title||a?.title||"",updatedAt:i||a?.updatedAt||null,parentId:e.parentId??a?.parentId??null,position:typeof e.position=="number"?e.position:a?.position||0,publicSlug:e.publicSlug??a?.publicSlug??null,encrypted:e.encrypted||a?.encrypted?1:0,deletedAt:null,docJsonStr:o?JSON.stringify(o):a?.docJsonStr??null,articleJsonStr:JSON.stringify(e)};await _e(c.put(l)),await et(s),o&&(vo(n,{articleId:r,docJson:o,updatedAt:i}).catch(()=>{}),Ar(r,o).catch(()=>{}))}async function Mn(e){if(!e)return null;let n=(await pt()).transaction(["articles"],"readonly"),r=n.objectStore("articles"),o=await _e(r.get(e)).catch(()=>null);if(await et(n),!o)return null;try{let i=JSON.parse(o.articleJsonStr||"null");return i&&!i.docJson&&o.docJsonStr&&(i.docJson=JSON.parse(o.docJsonStr)),i}catch{try{let i=o.docJsonStr?JSON.parse(o.docJsonStr):null,s={id:e,title:o.title||"",createdAt:o.createdAt||o.updatedAt||null,updatedAt:o.updatedAt||null,deletedAt:o.deletedAt||null,parentId:o.parentId??null,position:typeof o.position=="number"?o.position:0,authorId:null,publicSlug:o.publicSlug??null,encrypted:!!o.encrypted,outlineStructureRev:Number.isFinite(Number(o.outlineStructureRev))?Number(o.outlineStructureRev):void 0,docJson:i&&typeof i=="object"?i:null,history:[],redoHistory:[],blockTrash:[]};try{ot("cache.article.get.fallback_docJsonStr",{articleId:e,updatedAt:s.updatedAt||null,docHash:Pt(s.docJson)})}catch{}return s}catch{return null}}}async function sn(e,t,n){if(!e)return;let r=await pt(),o=r.transaction(["articles"],"readwrite"),i=o.objectStore("articles"),s=await _e(i.get(e)).catch(()=>null),c=n||s&&s.updatedAt||null,a=()=>{let p=String(e)==="inbox"?"\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438":"",h=(s&&typeof s.title=="string"?s.title:"")||p,y=c,S={id:e,title:h,createdAt:s&&s.createdAt||y||null,updatedAt:y,deletedAt:s&&s.deletedAt||null,parentId:(s&&s.parentId)??null,position:typeof(s&&s.position)=="number"?s.position:0,authorId:null,publicSlug:(s&&s.publicSlug)??null,encrypted:!!(s&&s.encrypted),docJson:null,history:[],blocks:[]};return JSON.stringify(S)},l=()=>{let p=s&&s.articleJsonStr||"",h=null;try{h=p?JSON.parse(p):null}catch{h=null}if(!h||typeof h!="object")try{h=JSON.parse(a())}catch{h={id:e}}return h.id=e,h.updatedAt=c||h.updatedAt||null,h.docJson=t&&typeof t=="object"?t:null,t&&typeof t=="object"&&(h.localDraft=!0),!h.title&&s?.title&&(h.title=s.title),h.deletedAt===void 0&&(h.deletedAt=null),h.parentId===void 0&&(h.parentId=s?.parentId??null),h.position===void 0&&(h.position=typeof s?.position=="number"?s.position:0),h.publicSlug===void 0&&(h.publicSlug=s?.publicSlug??null),h.encrypted===void 0&&(h.encrypted=!!s?.encrypted),h.history===void 0&&(h.history=[]),h.blocks===void 0&&(h.blocks=[]),JSON.stringify(h)},d={...s||{id:e},id:e,outlineStructureRev:s?.outlineStructureRev,docJsonStr:t?JSON.stringify(t):null,updatedAt:c,articleJsonStr:l()};await _e(i.put(d)),await et(o);try{ot("cache.docJson.put",{articleId:e,updatedAt:c,docHash:Pt(t)})}catch{}t&&typeof t=="object"&&(vo(r,{articleId:e,docJson:t,updatedAt:n}).catch(()=>{}),Ar(e,t).catch(()=>{}))}async function kc(e){let t=String(e||"").trim();if(!t)return;let r=(await pt()).transaction(["articles"],"readwrite"),o=r.objectStore("articles"),i=await _e(o.get(t)).catch(()=>null);if(!i){await et(r);return}let s=null;try{s=i.articleJsonStr?JSON.parse(i.articleJsonStr):null}catch{s=null}(!s||typeof s!="object")&&(s={id:t}),s.id=t,delete s.localDraft;let c={...i,articleJsonStr:JSON.stringify(s)};await _e(o.put(c)),await et(r)}async function vc(e){let t=await pt(),n=Array.isArray(e)?e:[];if(!n.length)return;let r=t.transaction(["articles"],"readwrite"),o=r.objectStore("articles");for(let i of n){if(!i||!i.id)continue;let s=await _e(o.get(i.id)).catch(()=>null);if(!s)continue;let c={...s,parentId:i.parentId??null,position:typeof i.position=="number"?i.position:0};await _e(o.put(c))}await et(r)}async function Bi(e,t){let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return;let i=(await pt()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),c=await _e(s.get(n)).catch(()=>null);if(!c){await et(i);return}let a=null;try{a=c.articleJsonStr?JSON.parse(c.articleJsonStr):null}catch{a=null}(!a||typeof a!="object")&&(a={id:n}),a.id=n,a.updatedAt=r;let l={...c,updatedAt:r,articleJsonStr:JSON.stringify(a)};await _e(s.put(l)),await et(i)}async function Ni(e,t){let n=String(e||"").trim();if(!n)return;let r=Number(t);if(!Number.isFinite(r)||r<0)return;let i=(await pt()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),c=await _e(s.get(n)).catch(()=>null);if(!c){await et(i);return}let a=null;try{a=c.articleJsonStr?JSON.parse(c.articleJsonStr):null}catch{a=null}(!a||typeof a!="object")&&(a={id:n}),a.id=n,a.outlineStructureRev=r;let l={...c,outlineStructureRev:r,articleJsonStr:JSON.stringify(a)};await _e(s.put(l)),await et(i)}var Ur=We(()=>{ir();xn();gc();Ti();zr()});function Mi(){try{window.dispatchEvent(new CustomEvent("offline-outbox-changed"))}catch{}}function Xd(){return globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?globalThis.crypto.randomUUID():`id-${Date.now()}-${Math.random().toString(16).slice(2)}`}function Ec(){return new Date().toISOString()}async function Jt(e,{articleId:t,payload:n,coalesceKey:r}={}){let o=await pt(),i=Xd(),s=Ec(),c=n?JSON.stringify(n):"{}",a=o.transaction(["outbox"],"readwrite"),l=a.objectStore("outbox"),d=l.index("byTypeArticleId"),p=l.index("byTypeCoalesceKey");if(r){let h=[String(e||""),String(r||"")],y=await _e(p.openCursor(IDBKeyRange.only(h))).catch(()=>null);for(;y;)y.delete(),y=await _e(y.continue()).catch(()=>null)}else if(t){let h=[String(e||""),t||null],y=await _e(d.openCursor(IDBKeyRange.only(h))).catch(()=>null);for(;y;)y.delete(),y=await _e(y.continue()).catch(()=>null)}return await _e(l.put({id:i,createdAt:s,createdAtMs:Date.now(),type:String(e||""),articleId:t||null,coalesceKey:r?String(r):null,payloadJson:c,attempts:0,lastError:null,lastAttemptAt:null})),await et(a),Mi(),i}async function sr(e=50){let n=(await pt()).transaction(["outbox"],"readonly"),o=n.objectStore("outbox").index("byCreatedAtMs"),i=[],s=await _e(o.openCursor()).catch(()=>null);for(;s&&(i.push(s.value),!(i.length>=e));)s=await _e(s.continue()).catch(()=>null);return await et(n),i.map(c=>{let a={};try{a=JSON.parse(c?.payloadJson||"{}")}catch{a={}}return{id:c.id,createdAt:c.createdAt,type:c.type,articleId:c.articleId,payload:a,attempts:c.attempts||0}})}async function Cc(e,t){let r=(await pt()).transaction(["outbox"],"readwrite"),o=r.objectStore("outbox"),i=await _e(o.get(e)).catch(()=>null);i&&await _e(o.put({...i,attempts:Number(i.attempts||0)+1,lastError:String(t||"error"),lastAttemptAt:Ec()})),await et(r),Mi()}async function qn(e){let n=(await pt()).transaction(["outbox"],"readwrite"),r=n.objectStore("outbox");await _e(r.delete(e)),await et(n),Mi()}var qr=We(()=>{ir();xn()});function Zd(e){let t=Array.isArray(e)?e:[],n=new Float32Array(t.length),r=0;for(let o=0;o<t.length;o+=1){let i=Number(t[o]||0);n[o]=i,r+=i*i}if(r>0){let o=1/Math.sqrt(r);for(let i=0;i<n.length;i+=1)n[i]*=o}return n}function Tc(){Qd=null,Gd=0}async function Li(e,t){if(!e)return;let n=await pt(),r=Array.isArray(t)?t:[],o=n.transaction(["section_embeddings"],"readwrite"),i=o.objectStore("section_embeddings");for(let s of r){let c=String(s?.blockId||s?.sectionId||""),a=String(s?.updatedAt||"")||null,l=s?.embedding;if(!c||!Array.isArray(l)||!l.length)continue;let d=Zd(l);await _e(i.put({sectionId:c,articleId:String(e),updatedAt:a,vec:d}))}await et(o),Tc()}async function To(e){let t=(e||[]).map(i=>String(i||"")).filter(Boolean);if(!t.length)return;let r=(await pt()).transaction(["section_embeddings"],"readwrite"),o=r.objectStore("section_embeddings");for(let i of t)await _e(o.delete(i));await et(r),Tc()}var Qd,Gd,Pi=We(()=>{ir();xn();Qd=null,Gd=0});var Bc=We(()=>{ir();Pi();xn()});function Bo(){try{return window?.localStorage?.getItem?.(eu)==="1"}catch{return!1}}function $t(...e){try{if(!Bo())return;console.log(...e)}catch{}}async function gt(e,t={}){let n=Bo()?performance.now():0,r=n?performance.now():0,o=await fetch(e,{headers:{"Content-Type":"application/json",...t.headers||{}},credentials:"include",...t}),i=r?performance.now():0;if(!o.ok){if(o.status===401||o.status===403){try{u.serverStatus="auth",u.serverStatusText="auth"}catch{}try{window.dispatchEvent(new CustomEvent("memus:auth-required",{detail:{path:e,status:o.status}}))}catch{}}let l=await o.json().catch(()=>({}));throw n&&console.log("[perf][api]",e,{status:o.status,ms:Math.round(performance.now()-n),fetchMs:i?Math.round(i-r):null}),new Error(l.detail||"Request failed")}try{u.serverStatus==="down"&&(u.serverStatus="ok",u.serverStatusText="")}catch{}if(o.status===204)return n&&console.log("[perf][api]",e,{status:204,ms:Math.round(performance.now()-n),fetchMs:i?Math.round(i-r):null}),null;let s=n?performance.now():0,c=await o.json(),a=n?performance.now():0;try{if(window?.localStorage?.getItem?.("ttree_debug_article_load_v1")==="1"){let l=o.headers.get("X-Memus-Article-ms"),d=o.headers.get("X-Memus-DocJson-bytes");(l||d)&&console.log("[api]",e,{ms:l,docJsonBytes:d})}}catch{}if(n){let l=o.headers.get("X-Memus-Article-ms")||o.headers.get("X-Memus-Articles-ms")||o.headers.get("X-Memus-Server-ms"),d=o.headers.get("X-Memus-DocJson-bytes"),p=o.headers.get("X-Memus-Articles-count"),h=o.headers.get("Content-Length");console.log("[perf][api]",e,{status:o.status,ms:Math.round(a-n),fetchMs:i?Math.round(i-r):null,jsonMs:s?Math.round(a-s):null,serverMs:l?Number(l):null,docJsonBytes:d?Number(d):null,articlesCount:p?Number(p):null,contentLength:h?Number(h):null})}return c}function nu(){try{return window?.localStorage?.getItem?.(tu)==="1"}catch{return!1}}async function Nc({timeoutMs:e}){let t=typeof e=="number"?Math.max(0,Math.floor(e)):0,n=null,r=null;try{return t>0&&typeof AbortController<"u"&&(r=new AbortController,n=setTimeout(()=>{try{r.abort()}catch{}},t)),await gt("/api/articles",r?{signal:r.signal}:{})}catch(o){if((o?.message||String(o||"")).toLowerCase().includes("abort"))try{u.serverStatus="down",u.serverStatusText="timeout"}catch{}throw o}finally{n&&clearTimeout(n)}}function fn(){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return Ir().catch(()=>[]);if(Vr)return Vr;let e=u?.offlineReady?600:250,t=2200;return Vr=(async()=>{let n=Bo()?performance.now():0,r=null,o=!1,i=new Promise(l=>{r=setTimeout(()=>{!o&&n&&$t("[offline-first][articles] cache.lookup.timeout",{preferCacheMs:e}),l(null)},e)}),s=Ir().then(l=>(o=!0,r&&clearTimeout(r),r=null,n&&$t("[offline-first][articles] cache.lookup.done",{ms:Math.round(performance.now()-n),hit:!!(l&&l.length)}),l)).catch(()=>(o=!0,r&&clearTimeout(r),r=null,null)),c=await Promise.race([s,i]);if(c&&c.length)return _i||(_i=Nc({timeoutMs:t}).then(async l=>{try{typeof requestIdleCallback=="function"?requestIdleCallback(()=>Nn(l).catch(()=>{}),{timeout:2500}):setTimeout(()=>Nn(l).catch(()=>{}),250)}catch{Nn(l).catch(()=>{})}}).catch(()=>{}).finally(()=>{_i=null})),c;let a=await Nc({timeoutMs:t});try{typeof requestIdleCallback=="function"?requestIdleCallback(()=>Nn(a).catch(()=>{}),{timeout:2500}):setTimeout(()=>Nn(a).catch(()=>{}),250)}catch{Nn(a).catch(()=>{})}try{let l=await Ir().catch(()=>null),d=Array.isArray(a)?a.length:0,p=l&&Array.isArray(l)?l.length:0;if(p>=20&&d<=3||nu()&&p&&p>d)return l}catch{}return a})().catch(async n=>{let r=await Ir().catch(()=>null);if(r&&r.length)return r;throw n}).finally(()=>{Vr=null}),Vr}function Pc(){return typeof navigator<"u"&&navigator&&navigator.onLine===!1?Promise.resolve([]):gt("/api/articles/deleted").catch(async e=>[])}function _c(e,t={}){let n=String(e||"").trim();e=n.startsWith("inbox-")?"inbox":n;let{cacheTimeoutMs:o,metaTimeoutMs:i,...s}=t||{},c=u?.offlineReady?400:150,a=typeof o=="number"?Math.max(0,Math.floor(o)):c,l=typeof i=="number"?Math.max(0,Math.floor(i)):350,d=Bo()?performance.now():0,p=null,h=!1,y=new Promise($=>{p=setTimeout(()=>{!h&&d&&$t("[offline-first][article] cache.lookup.timeout",{id:e,cacheTimeoutMs:a}),$(null)},a)}),S=Mn(e).then($=>(h=!0,p&&clearTimeout(p),p=null,d&&$t("[offline-first][article] cache.lookup.done",{id:e,ms:Math.round(performance.now()-d),hit:!!$}),$)).catch($=>(h=!0,p&&clearTimeout(p),p=null,d&&$t("[offline-first][article] cache.lookup.failed",{id:e,ms:Math.round(performance.now()-d),message:$?.message||String($||"")}),null)),f=Promise.race([S,y]),m=()=>gt(`/api/articles/${e}?include_history=0`,{...s,cache:"no-store"}).then(async $=>{try{ot("article.fetch.network.ok",{articleId:e,updatedAt:$?.updatedAt||null,docHash:Pt($?.docJson||null)})}catch{}return kr($).catch(()=>{}),$&&$.id&&String($.id)!==String(e)&&Ic($,e).catch(()=>{}),$}).catch(async $=>{let X=await Mn(e).catch(()=>null);try{ot("article.fetch.network.err",{articleId:e,message:$?.message||String($||""),cachedHit:!!X,cachedUpdatedAt:X?.updatedAt||null,cachedDocHash:Pt(X?.docJson||null)})}catch{}if(X)return X;throw $}),b=()=>{let $=new Date().toISOString(),W={type:"doc",content:[{type:"outlineSection",attrs:{id:(globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?()=>globalThis.crypto.randomUUID():()=>`id-${Date.now()}-${Math.random().toString(16).slice(2)}`)(),collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}]};return{id:"inbox",title:"\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438",createdAt:$,updatedAt:$,deletedAt:null,parentId:null,position:0,authorId:null,publicSlug:null,encrypted:!1,docJson:W,history:[]}},x="ttree_pending_quick_notes_v1",v=()=>{try{let $=window?.localStorage?.getItem?.(x)||"";if(!$)return[];let X=JSON.parse($);return Array.isArray(X)?X.filter(Boolean):[]}catch{return[]}},L=($,X)=>{let W=String($||"").trim();if(!W)return null;let be=String(X||"").trim().split(/\r?\n/),Oe=[];for(let re=0;re<be.length;re+=1){let he=be[re];he&&Oe.push({type:"text",text:he}),re!==be.length-1&&Oe.push({type:"hardBreak"})}return{type:"outlineSection",attrs:{id:W,collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[Oe.length?{type:"paragraph",content:Oe}:{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}},R=$=>{try{if(!$||String($.id||"")!=="inbox")return $;let X=v();if(!X.length)return $;let W=$?.docJson&&typeof $.docJson=="object"?$.docJson:{type:"doc",content:[]},te=Array.isArray(W.content)?W.content:[],be=new Set(te.filter(re=>re&&re.type==="outlineSection"&&re.attrs&&re.attrs.id).map(re=>String(re.attrs.id))),Oe=[];for(let re of X){let he=String(re?.sectionId||re?.id||"").trim();if(!he||be.has(he))continue;let Qe=L(he,re?.text||"");Qe&&Oe.push(Qe)}return Oe.length?{...$,docJson:{...W,type:W.type||"doc",content:[...Oe,...te]}}:$}catch{return $}},q=()=>gt(`/api/articles/${encodeURIComponent(e)}/meta`,{method:"GET",headers:{...s.headers||{}},cache:"no-store"}),j=()=>l?Promise.race([q(),new Promise(($,X)=>setTimeout(()=>{let W=new Error("meta_timeout");W.name="TimeoutError",X(W)},l))]):q();return f.then(async $=>{if(!$){if(!navigator.onLine&&String(e)==="inbox"){try{let Oe=await Promise.race([S,new Promise(re=>setTimeout(()=>re(null),Math.max(500,l*5)))]);if(Oe){$t("[offline-first][article] choose.cache.late.offline.inbox",{id:e});try{ot("article.choose",{articleId:e,choose:"cache.late.offline.inbox"})}catch{}return R(Oe)}}catch{}return $t("[offline-first][article] choose.local.inbox.offline",{id:e}),R(b())}let W=S.then(Oe=>Oe?{src:"cache",article:R(Oe)}:new Promise(()=>{})).catch(()=>new Promise(()=>{})),te=(async()=>({src:"network",article:await R(m())}))(),be=await Promise.race([W,te]);if(be?.src==="cache"){$t("[offline-first][article] choose.cache.late",{id:e});try{ot("article.choose",{articleId:e,choose:"cache.late"})}catch{}return te.catch(()=>{}),be.article}$t("[offline-first][article] choose.network.no-cache",{id:e});try{ot("article.choose",{articleId:e,choose:"network.no_cache"})}catch{}return be.article}if(!navigator.onLine){$t("[offline-first][article] choose.cache.offline",{id:e,updatedAt:$?.updatedAt||null});try{ot("article.choose",{articleId:e,choose:"cache.offline",cachedUpdatedAt:$?.updatedAt||null,cachedDocHash:Pt($?.docJson||null)})}catch{}return R($)}let X=String($.updatedAt||$.updated_at||"").trim();if(!X){$t("[offline-first][article] choose.network.no-cached-updatedAt",{id:e});try{ot("article.choose",{articleId:e,choose:"network.no_cached_updatedAt",cachedDocHash:Pt($?.docJson||null)})}catch{}return R(await m())}try{$t("[offline-first][article] meta.check.start",{id:e,cachedUpdatedAt:X});let W=await j(),te=String(W?.updatedAt||"").trim();if(te&&te===X){$t("[offline-first][article] choose.cache.meta.same",{id:e,cachedUpdatedAt:X});try{ot("article.choose",{articleId:e,choose:"cache.meta.same",cachedUpdatedAt:X,serverUpdatedAt:te,cachedDocHash:Pt($?.docJson||null)})}catch{}return R($)}$t("[offline-first][article] choose.network.meta.diff",{id:e,cachedUpdatedAt:X,serverUpdatedAt:te||null});try{ot("article.choose",{articleId:e,choose:"network.meta.diff",cachedUpdatedAt:X,serverUpdatedAt:te||null,cachedDocHash:Pt(cached?.docJson||null)})}catch{}return R(await m())}catch(W){String(W?.name||"")==="TimeoutError"||String(W?.message||"")==="meta_timeout"?$t("[offline-first][article] meta.check.timeout",{id:e,metaTimeoutMs:l}):$t("[offline-first][article] meta.check.failed",{id:e,message:W?.message||String(W||"")}),m().catch(()=>{}),String(W?.name||"")==="TimeoutError"||String(W?.message||"")==="meta_timeout"?$t("[offline-first][article] choose.cache.meta.timeout",{id:e,cachedUpdatedAt:X,metaTimeoutMs:l}):$t("[offline-first][article] choose.cache.meta.failed",{id:e,cachedUpdatedAt:X});try{ot("article.choose",{articleId:e,choose:String(W?.name||"")==="TimeoutError"||String(W?.message||"")==="meta_timeout"?"cache.meta.timeout":"cache.meta.failed",cachedUpdatedAt:X,cachedDocHash:Pt($?.docJson||null),error:W?.message||String(W||"")})}catch{}return R($)}})}function Dc(e,t){return e?!t||typeof t!="object"?Promise.reject(new Error("docJson must be object")):gt(`/api/articles/${encodeURIComponent(e)}/doc-json`,{method:"PUT",body:JSON.stringify({docJson:t})}):Promise.reject(new Error("articleId is required"))}function Oc(e){return typeof e!="string"?Promise.reject(new Error("text must be string")):gt("/api/outline/generate-title",{method:"POST",body:JSON.stringify({text:e})})}function Rc(e){return typeof e!="string"?Promise.reject(new Error("html must be string")):gt("/api/outline/proofread-html",{method:"POST",body:JSON.stringify({html:e})})}function Hc(e,t={}){let n=t.force?"?force=true":"";return gt(`/api/articles/${e}${n}`,{method:"DELETE"})}function $c(e){return gt(`/api/articles/${e}/restore`,{method:"POST"})}function Fc(e,t,n={}){let r=Array.isArray(t)?t.filter(Boolean).map(o=>String(o)):[];return e?r.length?gt(`/api/articles/${encodeURIComponent(e)}/sections/delete`,{method:"PUT",cache:"no-store",body:JSON.stringify({opId:n?.opId||null,sectionIds:r})}):Promise.resolve({status:"ok",removedBlockIds:[]}):Promise.reject(new Error("articleId is required"))}function Jr(e){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return Promise.reject(new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D"));let t=new FormData;t.append("file",e);let n=i=>{if(!(typeof navigator<"u"&&navigator&&navigator.onLine===!1))try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"uploadImageFile",data:i})}).catch(()=>{})}catch{}},r=()=>fetch("/api/uploads",{method:"POST",credentials:"include",body:t}).then(async i=>{let s=await i.json().catch(()=>null);if(n({transport:"fetch",status:i.status,ok:i.ok,details:s,name:e&&e.name,type:e&&e.type,size:e&&e.size}),!i.ok){let c=s?.detail||`Upload failed (status ${i.status})`,a=new Error(c);throw a.status=i.status,a.details=s,a}return s}),o=()=>new Promise((i,s)=>{let c=new XMLHttpRequest;c.open("POST","/api/uploads"),c.withCredentials=!0,c.onreadystatechange=()=>{if(c.readyState===XMLHttpRequest.DONE)try{let a=c.status,l=null;try{l=JSON.parse(c.responseText||"null")}catch{l=null}if(n({transport:"xhr",status:a,ok:a>=200&&a<300,details:l,name:e&&e.name,type:e&&e.type,size:e&&e.size}),a>=200&&a<300)i(l);else{let d=l&&l.detail||`Upload failed (status ${a})`,p=new Error(d);p.status=a,p.details=l,s(p)}}catch(a){s(a)}},c.onerror=()=>{n({transport:"xhr",status:0,ok:!1,details:{detail:"Network error during image upload"},name:e&&e.name,type:e&&e.type,size:e&&e.size});let a=new Error("Upload failed (network error)");a.status=0,a.details={detail:"Network error during image upload"},s(a)},c.send(t)});return r().catch(i=>{let s=String(i&&i.message?i.message:"").toLowerCase();if(s.includes("status ")||s.includes("upload failed"))throw i;return o()})}function ru(e,t,n=()=>{}){return typeof navigator<"u"&&navigator&&navigator.onLine===!1?Promise.reject(new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D")):new Promise((r,o)=>{let i=new XMLHttpRequest;i.open("POST",`/api/articles/${e}/attachments`),i.withCredentials=!0,i.upload.onprogress=c=>{if(c.lengthComputable){let a=Math.round(c.loaded/c.total*100);n(a)}},i.onreadystatechange=()=>{if(i.readyState===XMLHttpRequest.DONE)if(i.status>=200&&i.status<300)try{let c=JSON.parse(i.responseText||"{}");r(c)}catch(c){o(c)}else{let c=`Attachment upload failed (status ${i.status})`;try{let a=JSON.parse(i.responseText||"{}");a?.detail&&(c=a.detail)}catch{}o(new Error(c))}},i.onerror=()=>o(new Error("Network error during upload"));let s=new FormData;s.append("file",t),i.send(s)})}function ou(e){let t=new Map;for(let n of e||[]){let r=n.parentId??null;t.has(r)||t.set(r,[]),t.get(r).push(n)}for(let n of t.values())n.sort((r,o)=>(r.position||0)-(o.position||0));return t}function Mc(e){let t=[];for(let n=0;n<e.length;n+=1){let r=e[n];if(!r)continue;let o=n;(r.position||0)!==o&&(r.position=o,t.push({id:r.id,parentId:r.parentId??null,position:o}))}return t}function zc(e,t){return e?gt(`/api/articles/${encodeURIComponent(e)}/move-tree`,{method:"POST",body:JSON.stringify(t||{})}).catch(async()=>{let r=await Ir().catch(()=>[]),o=ou(r),i=(r||[]).find(m=>m.id===e);if(!i)return null;let s=t&&t.placement||null,c=t&&t.anchorId||null,a=t?t.parentId??null:null;s==="inside"&&c&&(a=c);let l=i.parentId??null,p=(o.get(l)||[]).filter(m=>m.id!==e),y=(o.get(a)||[]).filter(m=>m.id!==e),S=y.length;if(c){let m=y.findIndex(b=>b.id===c);m!==-1&&(s==="before"?S=m:s==="after"?S=m+1:s==="inside"&&(S=y.length))}i.parentId=a,y.splice(S,0,i);let f=[];return f.push(...Mc(p)),f.push(...Mc(y)),vc(f).catch(()=>{}),Jt("move_article_tree",{articleId:e,payload:t||{},coalesceKey:`${e}:move-tree`}).catch(()=>{}),{id:e}}):Promise.resolve(null)}async function iu({articleId:e,filename:t,overwrite:n=!1,sha256:r="",size:o=0}){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D");let s=await fetch("/api/yandex/disk/upload-url",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({filename:t||"",articleId:e||"",overwrite:!!n,sha256:r||"",size:typeof o=="number"?o:0})}),c=await s.json().catch(()=>null);if(!s.ok){let a=c&&c.detail||`Yandex upload URL failed (status ${s.status})`;throw new Error(a)}return c}async function Lc(e,{path:t,originalName:n,contentType:r,size:o}){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D");let i={path:t||"",originalName:n||"",contentType:r||"",size:typeof o=="number"?o:0},s=await fetch(`/api/articles/${e}/attachments/yandex`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),c=await s.json().catch(()=>null);if(!s.ok){let a=c&&c.detail||`Register Yandex attachment failed (status ${s.status})`;throw new Error(a)}return c}async function No(e,t,{onProgress:n}={}){if(!t)throw new Error("\u0424\u0430\u0439\u043B \u043D\u0435 \u0443\u043A\u0430\u0437\u0430\u043D");let r="";try{if(window.crypto&&window.crypto.subtle&&typeof t.arrayBuffer=="function"){let p=await t.arrayBuffer(),h=await window.crypto.subtle.digest("SHA-256",p),y=new Uint8Array(h);r=Array.from(y).map(S=>S.toString(16).padStart(2,"0")).join("")}}catch{r=""}let{href:o,method:i,path:s,exists:c,same:a}=await iu({articleId:e,filename:t.name||"attachment",overwrite:!1,sha256:r,size:t.size||0});if(c&&a&&!o)return await Lc(e,{path:s,originalName:t.name||"attachment",contentType:t.type||"",size:t.size||0});let l=!1;if(o)try{await new Promise((p,h)=>{let y=new XMLHttpRequest;y.open(i||"PUT",o),y.upload.onprogress=S=>{if(n&&S.lengthComputable){let f=Math.round(S.loaded/S.total*100);try{n(f)}catch{}}},y.onreadystatechange=()=>{y.readyState===XMLHttpRequest.DONE&&(y.status>=200&&y.status<300?p():h(new Error(`Yandex upload failed (status ${y.status})`)))},y.onerror=()=>h(new Error("Network error during Yandex upload")),y.send(t)}),l=!0}catch(p){console.warn("[attachments] Direct Yandex upload failed, falling back to server upload",p),l=!1}return l?await Lc(e,{path:s,originalName:t.name||"attachment",contentType:t.type||"",size:t.size||0}):await ru(e,t,n)}var eu,Vr,_i,tu,Yt=We(()=>{Ur();qr();Bc();wt();zr();eu="ttree_profile_v1";Vr=null,_i=null,tu="ttree_offline_recovery_force_index_v1"});function Uc(){if(!V.articlePublicToggleBtn)return;let e=u.article?.publicSlug||null;V.articlePublicToggleBtn.textContent=e?"\u041E\u0442\u043C\u0435\u043D\u0438\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435":"\u0414\u0430\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435"}function jr(){let e=u.article;if(!e)return;let t=e.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";if(V.articleTitle&&(V.articleTitle.textContent=t,V.articleTitle.classList.toggle("article-title--encrypted",!!e.encrypted),V.articleTitle.classList.toggle("hidden",u.isEditingTitle)),V.articleTitleInput&&(u.isEditingTitle||(V.articleTitleInput.value=t),V.articleTitleInput.classList.toggle("hidden",!u.isEditingTitle)),V.editTitleBtn&&V.editTitleBtn.classList.toggle("hidden",u.isEditingTitle),V.articleFavoriteBtn){let r=new Set(u.favoriteArticles||[]).has(e.id);V.articleFavoriteBtn.textContent=r?"\uE735":"\uE734",V.articleFavoriteBtn.title=r?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}if(V.articlePublicLinkBtn){let n=!!e.publicSlug;V.articlePublicLinkBtn.classList.toggle("hidden",!n),n&&(V.articlePublicLinkBtn.title="\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0441\u044B\u043B\u043A\u0443")}if(V.deleteArticleBtn&&V.deleteArticleBtn.classList.toggle("hidden",e.id==="inbox"),V.articleEncryptionBtn&&(V.articleEncryptionBtn.textContent=e.encrypted?"\u0421\u043C\u0435\u043D\u0438\u0442\u044C \u043F\u0430\u0440\u043E\u043B\u044C":"\u0417\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C"),V.articleEncryptionRemoveBtn&&V.articleEncryptionRemoveBtn.classList.toggle("hidden",!e.encrypted),V.updatedAt&&(u.isOutlineEditing?V.updatedAt.textContent=u.outlineStatusText||"":e.updatedAt?V.updatedAt.textContent=`\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${new Date(e.updatedAt).toLocaleString()}`:V.updatedAt.textContent=""),V.articleStatusText&&(u.isOutlineEditing?V.articleStatusText.textContent=u.outlineStatusText||"":e.updatedAt?V.articleStatusText.textContent=`\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${new Date(e.updatedAt).toLocaleString()}`:V.articleStatusText.textContent=""),V.mediaStatusText&&(V.mediaStatusText.textContent=u.mediaStatusText||""),V.mediaPrefetchToggleBtn){let n=!!u.mediaPrefetchPaused;V.mediaPrefetchToggleBtn.textContent=n?"\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C":"\u041F\u0430\u0443\u0437\u0430",V.mediaPrefetchToggleBtn.classList.toggle("is-active",n)}}var Kr=We(()=>{wt();un()});function jt(...e){console.log("[debug]",...e)}function zt(e=""){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function qc(e=""){let t=(e||"").replace(/<br\s*\/?>/gi,`
`).replace(/<\/(?:div|p|li|h[1-6])>/gi,`
`),n=document.createElement("template");return n.innerHTML=t,(n.content.textContent||"").split(`
`).map(r=>r.replace(/\s+/g," ").trim()).filter(r=>r.length)}function Mo(e){if(!e||!e.isConnected)return;let t=window.getSelection();if(!t)return;let n=document.createRange();n.selectNodeContents(e),n.collapse(!1),t.removeAllRanges(),t.addRange(n)}function Di(e){if(!e||!e.isConnected)return;let t=window.getSelection();if(!t)return;let n=document.createRange();n.selectNodeContents(e),n.collapse(!0),t.removeAllRanges(),t.addRange(n)}function Ln(e,t){if(!e||!document.contains(e))return;e.focus();let n=window.getSelection();if(!n)return;let r=n.rangeCount>0?n.getRangeAt(0):document.createRange();e.contains(r.commonAncestorContainer)||(r=document.createRange(),r.selectNodeContents(e),r.collapse(!1)),n.removeAllRanges(),n.addRange(r);let o=r.createContextualFragment(t);r.deleteContents(),r.insertNode(o),r.collapse(!1),n.removeAllRanges(),n.addRange(r)}var An=We(()=>{});var Ri={};So(Ri,{showArticleHistoryModal:()=>mu,showArticleLinkPrompt:()=>cu,showBlockHistoryModal:()=>fu,showBlockTrashPicker:()=>hu,showConfirm:()=>jc,showImagePreview:()=>Wr,showImportConflictDialog:()=>gu,showLinkPrompt:()=>Oi,showPasswordWithHintPrompt:()=>Kc,showPrompt:()=>Vn,showPublicLinkModal:()=>au,showVersionCompareTargetPicker:()=>du,showVersionDiffModal:()=>uu,showVersionsPicker:()=>lu});function cn(){let e=document.getElementById(Vc);return e||(e=document.createElement("div"),e.id=Vc,document.body.appendChild(e)),e}function yn({title:e,message:t,confirmText:n,cancelText:r,renderBody:o}){let i=document.createElement("div");i.className="modal-overlay";let s=document.createElement("form");s.className="modal-form",s.addEventListener("submit",S=>{S.preventDefault()});let c=document.createElement("div");c.className="modal-card",c.setAttribute("role","dialog"),c.setAttribute("aria-modal","true"),c.tabIndex=-1;let a=document.createElement("div");a.className="modal-header";let l=document.createElement("h3");l.textContent=e||"\u041F\u043E\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043D\u0438\u0435",a.appendChild(l);let d=document.createElement("div");if(d.className="modal-body",typeof o=="function"){let S=o();Array.isArray(S)?S.forEach(f=>{f&&d.appendChild(f)}):S&&d.appendChild(S)}else d.textContent=t||"";let p=document.createElement("div");p.className="modal-footer modal-footer--stacked";let h=document.createElement("button");h.type="button",h.className="ghost",h.textContent=r||"\u041E\u0442\u043C\u0435\u043D\u0430";let y=document.createElement("button");return y.type="button",y.className="primary danger-btn",y.textContent=n||"\u0423\u0434\u0430\u043B\u0438\u0442\u044C",p.appendChild(y),p.appendChild(h),c.appendChild(a),c.appendChild(d),c.appendChild(p),s.appendChild(c),i.appendChild(s),{overlay:i,card:c,confirmBtn:y,cancelBtn:h,form:s}}function su(e="",t=""){let n=String(e||"").length,r=String(t||"").length;if(n*r>2e6||n+r>2e4)return null;let s=Array.from(e),c=Array.from(t),a=s.length,l=c.length,d=Array.from({length:a+1},()=>new Array(l+1).fill(0));for(let f=a-1;f>=0;f-=1)for(let m=l-1;m>=0;m-=1)s[f]===c[m]?d[f][m]=d[f+1][m+1]+1:d[f][m]=Math.max(d[f+1][m],d[f][m+1]);let p=[],h=0,y=0;for(;h<a&&y<l;)s[h]===c[y]?(p.push({type:"same",value:s[h]}),h+=1,y+=1):d[h+1][y]>=d[h][y+1]?(p.push({type:"removed",value:s[h]}),h+=1):(p.push({type:"added",value:c[y]}),y+=1);for(;h<a;)p.push({type:"removed",value:s[h]}),h+=1;for(;y<l;)p.push({type:"added",value:c[y]}),y+=1;let S=[];return p.forEach(f=>{if(!f.value)return;let m=S[S.length-1];m&&m.type===f.type?m.value+=f.value:S.push({type:f.type,value:f.value})}),S}function vr({baseText:e="",nextText:t="",mode:n="before"}={}){let r=document.createDocumentFragment(),o=su(e,t);if(!o){let s=String(n==="before"?e||"":t||""),c=s.length>2e5?`${s.slice(0,2e5)}

\u2026(\u043E\u0431\u0440\u0435\u0437\u0430\u043D\u043E)`:s,a=document.createElement("div");a.className="meta",a.style.marginBottom="6px",a.textContent="Diff \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 \u2014 \u043F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0435\u043C \u0442\u0435\u043A\u0441\u0442 \u0431\u0435\u0437 \u043F\u043E\u0434\u0441\u0432\u0435\u0442\u043A\u0438.";let l=document.createElement("pre");return l.className="diff-plain",l.style.whiteSpace="pre-wrap",l.style.wordBreak="break-word",l.textContent=c,r.appendChild(a),r.appendChild(l),r}return o.forEach(i=>{if(n==="before"&&i.type==="added"||n==="after"&&i.type==="removed")return;let s=document.createElement("span");s.className="diff-seg",i.type==="added"&&s.classList.add("diff-seg--added"),i.type==="removed"&&s.classList.add("diff-seg--removed"),s.textContent=i.value,r.appendChild(s)}),r}function jc(e={}){let t=cn(),{overlay:n,card:r,confirmBtn:o,cancelBtn:i,form:s}=yn(e),c=!1,a=()=>{},l=()=>{n.classList.add("modal-overlay--hide"),setTimeout(()=>n.remove(),150),document.removeEventListener("keydown",p)},d=h=>{c||(c=!0,l(),a(h))},p=h=>{h.code==="Escape"&&(h.preventDefault(),d(!1)),h.code==="Enter"&&(h.preventDefault(),d(!0))};return new Promise(h=>{a=h,s.addEventListener("submit",y=>{y.preventDefault(),d(!0)}),o.addEventListener("click",()=>d(!0)),i.addEventListener("click",()=>d(!1)),n.addEventListener("click",y=>{y.target===n&&d(!1)}),document.addEventListener("keydown",p),t.appendChild(n),requestAnimationFrame(()=>{r.focus({preventScroll:!0})})})}function Vn(e={}){let t=cn(),n=null,r=Array.isArray(e.suggestions)?e.suggestions:[],o=null,{overlay:i,card:s,confirmBtn:c,cancelBtn:a,form:l}=yn({...e,renderBody:()=>{let b=document.createDocumentFragment();if(e.message){let v=document.createElement("p");v.className="modal-body__text",v.textContent=e.message,b.appendChild(v)}let x=document.createElement("input");return x.type=e.inputType==="password"?"password":"text",x.className="modal-input",x.placeholder=e.placeholder||"",x.value=e.defaultValue||"",x.autocomplete="off",b.appendChild(x),r.length&&(o=document.createElement("div"),o.className="modal-suggestions",b.appendChild(o)),n=x,b}}),d=!1,p=()=>{},h=()=>{i.classList.add("modal-overlay--hide"),setTimeout(()=>i.remove(),150),document.removeEventListener("keydown",S)},y=b=>{if(!d)if(d=!0,h(),e.returnMeta){let x={value:b??null,selectedId:n?.dataset?.selectedId||null};p(x)}else p(b)},S=b=>{if(b.code==="Escape"){b.preventDefault(),y(null);return}if(b.code==="Enter"&&n&&!e.hideConfirm){let x=n.value.trim();if(!x&&!e.allowEmpty)return;b.preventDefault(),y(x)}},f=()=>{if(!c||!n)return;let b=!!n.value.trim();c.disabled=!b&&!e.allowEmpty},m=()=>{if(!o||!n)return;let b=n.value.trim().toLowerCase();n.dataset.selectedId="";let x=r.filter(v=>(v.title||"").toLowerCase().includes(b)||(v.id||"").toLowerCase().includes(b)).slice(0,8);if(o.innerHTML="",!b||!x.length){o.classList.add("hidden");return}o.classList.remove("hidden"),x.forEach(v=>{let L=document.createElement("button");L.type="button",L.className="modal-suggestion",L.textContent=v.title||v.id||"",L.addEventListener("click",()=>{n.value=v.title||v.id||"",n.dataset.selectedId=v.id||"",f(),m(),y(n.value)}),o.appendChild(L)})};return new Promise(b=>{p=b,c.classList.remove("danger-btn"),e.hideConfirm?c.style.display="none":c.textContent=e.confirmText||"OK",a.textContent=e.cancelText||"Cancel";let x=()=>{if(!n){y(null);return}let v=n.value.trim();if(!v){n.focus();return}y(v)};l.addEventListener("submit",v=>{v.preventDefault(),x()}),c.addEventListener("click",x),a.addEventListener("click",()=>y(null)),i.addEventListener("click",v=>{v.target===i&&y(null)}),document.addEventListener("keydown",S),n?(n.dataset.selectedId="",n.addEventListener("input",()=>{n.dataset.selectedId="",f(),r.length&&m()}),e.hideConfirm&&n.addEventListener("keydown",v=>{v.code==="Enter"&&(v.preventDefault(),y(n.value.trim()))}),f(),r.length&&m()):f(),t.appendChild(i),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):s.focus({preventScroll:!0})})})}function cu(e={}){let t=cn(),n=null,r=null,o=Array.isArray(e.suggestions)?e.suggestions:[],i=null,{overlay:s,card:c,confirmBtn:a,cancelBtn:l,form:d}=yn({title:e.title||"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",renderBody:()=>{let x=document.createDocumentFragment();if(e.message){let j=document.createElement("p");j.className="modal-body__text",j.textContent=e.message,x.appendChild(j)}let v=document.createElement("label");v.className="modal-label",v.textContent=e.articleLabel||"\u0421\u0442\u0430\u0442\u044C\u044F";let L=document.createElement("input");L.type="text",L.className="modal-input",L.placeholder=e.articlePlaceholder||"ID \u0438\u043B\u0438 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435\u2026",L.value=e.defaultArticleValue||"",L.autocomplete="off",v.appendChild(L),x.appendChild(v),n=L,o.length&&(i=document.createElement("div"),i.className="modal-suggestions",x.appendChild(i));let R=document.createElement("label");R.className="modal-label",R.textContent=e.textLabel||"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)";let q=document.createElement("input");return q.type="text",q.className="modal-input",q.placeholder=e.textPlaceholder||"",q.value=e.defaultTextValue||"",q.autocomplete="off",R.appendChild(q),x.appendChild(R),r=q,x}}),p=!1,h=()=>{},y=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",b)},S=x=>{p||(p=!0,y(),h(x))},f=()=>{if(!a||!n)return;let x=!!n.value.trim()||!!n.dataset.selectedId;a.disabled=!x},m=()=>{if(!i||!n)return;let x=n.value.trim().toLowerCase();n.dataset.selectedId="";let v=o.filter(L=>(L.title||"").toLowerCase().includes(x)||(L.id||"").toLowerCase().includes(x)).slice(0,8);if(i.innerHTML="",!x||!v.length){i.classList.add("hidden");return}i.classList.remove("hidden"),v.forEach(L=>{let R=document.createElement("button");R.type="button",R.className="modal-suggestion",R.textContent=L.title||L.id||"",R.addEventListener("click",()=>{n.value=L.title||L.id||"",n.dataset.selectedId=L.id||"",f(),m(),r&&!r.value.trim()&&!e.lockTextValue&&(r.value=L.title||""),r?.focus?.({preventScroll:!0}),r?.select?.()}),i.appendChild(R)})},b=x=>{if(x.code==="Escape"){x.preventDefault(),S(null);return}x.code};return new Promise(x=>{h=x,a.classList.remove("danger-btn"),a.textContent=e.confirmText||"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",l.textContent=e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430";let v=()=>{if(!n||!r){S(null);return}let L=n.value.trim(),R=n.dataset.selectedId||"";if(!L&&!R){n.focus();return}S({articleValue:L,selectedId:R||null,textValue:r.value??""})};d.addEventListener("submit",L=>{L.preventDefault(),v()}),a.addEventListener("click",v),l.addEventListener("click",()=>S(null)),s.addEventListener("click",L=>{L.target===s&&S(null)}),document.addEventListener("keydown",b),n?(n.dataset.selectedId="",n.addEventListener("input",()=>{n.dataset.selectedId="",f(),o.length&&m()}),f(),o.length&&m()):f(),t.appendChild(s),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):c.focus({preventScroll:!0})})})}function au(e={}){let t=cn(),n=null,r=e.url||"",{overlay:o,card:i,confirmBtn:s,cancelBtn:c}=yn({title:e.title||"\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u0430\u044F \u0441\u0441\u044B\u043B\u043A\u0430",renderBody:()=>{let f=document.createDocumentFragment(),m=document.createElement("label");m.className="modal-label",m.textContent=e.label||"\u041F\u0440\u043E\u0441\u043C\u043E\u0442\u0440 \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435";let b=document.createElement("input");return b.type="text",b.className="modal-input",b.value=r,b.readOnly=!0,b.autocomplete="off",m.appendChild(b),n=b,f.appendChild(m),f}}),a=!1,l=()=>{},d=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",h)},p=()=>{a||(a=!0,d(),l())},h=f=>{f.code==="Escape"&&(f.preventDefault(),p())},y=f=>{if(!f)return!1;let m=document.createElement("textarea");m.value=f,m.setAttribute("readonly",""),m.style.position="absolute",m.style.left="-9999px",document.body.appendChild(m),m.focus(),m.select();let b=!1;try{b=document.execCommand("copy")}catch{b=!1}return document.body.removeChild(m),b},S=()=>{let f=n&&n.value||r;if(f){ve("\u0421\u0441\u044B\u043B\u043A\u0430 \u0441\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u0430");try{if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function"){let m=navigator.clipboard.writeText(f);m&&typeof m.catch=="function"&&m.catch(()=>{y(f)})}else y(f)}catch{y(f)}}};return new Promise(f=>{l=f,s.classList.remove("danger-btn"),s.textContent="\u29C9 \u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443",s.setAttribute("aria-label",e.copyLabel||"\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443"),c.classList.add("hidden"),s.addEventListener("click",()=>{S(),p()}),o.addEventListener("click",m=>{m.target===o&&p()}),document.addEventListener("keydown",h),t.appendChild(o),requestAnimationFrame(()=>{n?n.focus({preventScroll:!0}):i.focus({preventScroll:!0})})})}function lu(e={}){let t=cn(),n=Array.isArray(e.versions)?e.versions:[],r=n[0]?.id||"",o=b=>{try{let x=new Date(b);return Number.isNaN(x.getTime())?String(b||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(x)}catch{return String(b||"")}},{overlay:i,card:s,confirmBtn:c,cancelBtn:a,form:l}=yn({title:e.title||"\u0412\u0435\u0440\u0441\u0438\u0438",confirmText:e.confirmText||"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",cancelText:e.cancelText||"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",renderBody:()=>{let b=document.createDocumentFragment(),x=document.createElement("p");if(x.className="modal-body__text",x.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0435\u0440\u0441\u0438\u044E \u0441\u0442\u0430\u0442\u044C\u0438 \u0434\u043B\u044F \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F.",b.appendChild(x),!n.length){let L=document.createElement("div");return L.className="modal-empty",L.textContent="\u0412\u0435\u0440\u0441\u0438\u0439 \u043F\u043E\u043A\u0430 \u043D\u0435\u0442.",b.appendChild(L),b}let v=document.createElement("div");return v.className="modal-list",n.forEach((L,R)=>{let q=document.createElement("label");q.className="modal-list__item";let j=document.createElement("input");j.type="radio",j.name="version",j.value=L.id||"",j.checked=R===0,j.addEventListener("change",()=>{r=j.value,c.disabled=!r,d.disabled=!r});let $=document.createElement("div");$.className="modal-list__meta";let X=document.createElement("div");X.className="modal-list__title",X.textContent=L.label||o(L.created_at||L.createdAt);let W=document.createElement("div");W.className="modal-list__subtitle";let te=L.reason||"",be=o(L.created_at||L.createdAt);W.textContent=[be,te].filter(Boolean).join(" \xB7 "),$.appendChild(X),$.appendChild(W),q.appendChild(j),q.appendChild($),v.appendChild(q)}),b.appendChild(v),b}});s.classList.add("modal-card--diff-light"),c.classList.remove("danger-btn"),c.disabled=!r;let d=document.createElement("button");d.type="button",d.className="ghost",d.textContent=e.compareText||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C",d.disabled=!r;let p=s.querySelector(".modal-footer");p&&p.insertBefore(d,c);let h=!1,y=()=>{},S=()=>{i.classList.add("modal-overlay--hide"),setTimeout(()=>i.remove(),150),document.removeEventListener("keydown",m)},f=b=>{h||(h=!0,S(),y(b))},m=b=>{b.code==="Escape"&&(b.preventDefault(),f(null))};return new Promise(b=>{y=b;let x=()=>{r&&f({action:"restore",versionId:r})};l.addEventListener("submit",v=>{v.preventDefault(),x()}),c.addEventListener("click",x),d.addEventListener("click",()=>{r&&f({action:"compare",versionId:r})}),a.addEventListener("click",()=>f(null)),i.addEventListener("click",v=>{v.target===i&&f(null)}),document.addEventListener("keydown",m),t.appendChild(i),requestAnimationFrame(()=>{s.focus({preventScroll:!0})})})}function du(e={}){let t=cn(),n=Array.isArray(e.versions)?e.versions:[],r=String(e.excludeId||""),o=[{kind:"current",id:"__current__",title:"\u0422\u0435\u043A\u0443\u0449\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F"},...n.filter(m=>String(m.id||"")&&String(m.id||"")!==r).map(m=>({kind:"version",id:String(m.id),title:m.label||m.created_at||m.createdAt||m.id}))],i=o[0]?.id||"",{overlay:s,card:c,confirmBtn:a,cancelBtn:l,form:d}=yn({title:e.title||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C \u0441\u2026",confirmText:e.confirmText||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C",cancelText:e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430",renderBody:()=>{let m=document.createDocumentFragment(),b=document.createElement("p");b.className="modal-body__text",b.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0442\u043E\u0440\u0443\u044E \u0441\u0442\u043E\u0440\u043E\u043D\u0443 \u0441\u0440\u0430\u0432\u043D\u0435\u043D\u0438\u044F.",m.appendChild(b);let x=document.createElement("div");return x.className="modal-list",o.forEach((v,L)=>{let R=document.createElement("label");R.className="modal-list__item";let q=document.createElement("input");q.type="radio",q.name="compareTarget",q.value=v.id,q.checked=L===0,q.addEventListener("change",()=>{i=q.value,a.disabled=!i});let j=document.createElement("div");j.className="modal-list__meta";let $=document.createElement("div");$.className="modal-list__title",$.textContent=v.title,j.appendChild($),R.appendChild(q),R.appendChild(j),x.appendChild(R)}),m.appendChild(x),m}});c.classList.add("modal-card--diff-light"),a.classList.remove("danger-btn"),a.disabled=!i;let p=!1,h=()=>{},y=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",f)},S=m=>{p||(p=!0,y(),h(m))},f=m=>{m.code==="Escape"&&(m.preventDefault(),S(null))};return new Promise(m=>{h=m;let b=()=>{if(!i)return;let x=o.find(v=>v.id===i)||null;if(!x){S(null);return}if(x.kind==="current"){S({target:"current"});return}S({target:"version",versionId:x.id})};d.addEventListener("submit",x=>{x.preventDefault(),b()}),a.addEventListener("click",b),l.addEventListener("click",()=>S(null)),s.addEventListener("click",x=>{x.target===s&&S(null)}),document.addEventListener("keydown",f),t.appendChild(s),requestAnimationFrame(()=>{c.focus({preventScroll:!0})})})}function uu(e={}){let t=cn(),n=Array.isArray(e.changes)?e.changes:[],r=n.find(y=>y.type==="changed")||n[0]||null,{overlay:o,card:i,confirmBtn:s,cancelBtn:c}=yn({title:e.title||"\u041E\u0442\u043B\u0438\u0447\u0438\u044F \u0432\u0435\u0440\u0441\u0438\u0439",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:"",renderBody:()=>{let y=document.createDocumentFragment(),S=document.createElement("div");S.className="diff-summary";let f=n.reduce((X,W)=>(X[W.type]=(X[W.type]||0)+1,X),{added:0,removed:0,changed:0});if(S.textContent=`\u0418\u0437\u043C\u0435\u043D\u0435\u043D\u043E: ${f.changed||0} \xB7 \u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E: ${f.added||0} \xB7 \u0423\u0434\u0430\u043B\u0435\u043D\u043E: ${f.removed||0}`,y.appendChild(S),!n.length){let X=document.createElement("div");return X.className="modal-empty",X.textContent="\u041D\u0435\u0442 \u043E\u0442\u043B\u0438\u0447\u0438\u0439.",y.appendChild(X),y}let m=document.createElement("div");m.className="modal-list",n.forEach(X=>{let W=document.createElement("button");W.type="button",W.className=`diff-item diff-item--${X.type}${r&&r.id===X.id?" diff-item--active":""}`;let te=X.label||X.id;W.textContent=`${X.type==="changed"?"\u2260":X.type==="added"?"+":"\u2212"} ${te}`,W.addEventListener("click",()=>{r=X,m.querySelectorAll(".diff-item").forEach(be=>be.classList.remove("diff-item--active")),W.classList.add("diff-item--active"),$()}),m.appendChild(W)}),y.appendChild(m);let b=document.createElement("div");b.className="diff-panes";let x=document.createElement("div");x.className="diff-pane-wrap";let v=document.createElement("div");v.className="diff-pane-wrap";let L=document.createElement("div");L.className="diff-pane-title",L.textContent=e.beforeTitle||"\u0412\u0435\u0440\u0441\u0438\u044F";let R=document.createElement("div");R.className="diff-pane-title",R.textContent=e.afterTitle||"\u0422\u0435\u043A\u0443\u0449\u0430\u044F";let q=document.createElement("div");q.className="diff-pane diff-pane--before";let j=document.createElement("div");j.className="diff-pane diff-pane--after",x.appendChild(L),x.appendChild(q),v.appendChild(R),v.appendChild(j),b.appendChild(x),b.appendChild(v),y.appendChild(b);let $=()=>{let X=r?.before||"",W=r?.after||"";q.innerHTML="",j.innerHTML="",q.appendChild(vr({baseText:X,nextText:W,mode:"before"})),j.appendChild(vr({baseText:X,nextText:W,mode:"after"}))};return $(),y}});i.classList.add("modal-card--fullscreen"),i.classList.add("modal-card--diff-light"),s.classList.remove("danger-btn"),c&&(c.style.display="none");let a=!1,l=()=>{},d=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",h)},p=()=>{a||(a=!0,d(),l())},h=y=>{y.code==="Escape"&&(y.preventDefault(),p())};return new Promise(y=>{l=y,s.addEventListener("click",p),o.addEventListener("click",S=>{S.target===o&&p()}),document.addEventListener("keydown",h),t.appendChild(o),requestAnimationFrame(()=>{i.focus({preventScroll:!0})})})}function fu(e={}){let t=cn(),n=Array.isArray(e.entries)?e.entries:[],r=n[0]||null,o=r,i=[],s=null,c=b=>{try{let x=new Date(b);return Number.isNaN(x.getTime())?String(b||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(x)}catch{return String(b||"")}},{overlay:a,card:l,confirmBtn:d,cancelBtn:p}=yn({title:e.title||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0431\u043B\u043E\u043A\u0430",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:e.canRestore?"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C (\u043F\u043E\u0441\u043B\u0435 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F)":"",renderBody:()=>{let b=document.createDocumentFragment(),x=document.createElement("p");if(x.className="modal-body__text",x.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0435. \u041C\u043E\u0436\u043D\u043E \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430 \u0434\u043E \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F.",b.appendChild(x),!n.length){let re=document.createElement("div");return re.className="modal-empty",re.textContent="\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430.",b.appendChild(re),b}let v=document.createElement("div");v.className="diff-layout";let L=document.createElement("div");L.className="modal-list diff-sidebar",i=[],n.forEach(re=>{let he=document.createElement("button");he.type="button";let Qe=!!(r&&r.id===re.id);he.className=`diff-item${Qe?" diff-item--active":""}`,he.setAttribute("aria-selected",Qe?"true":"false");let yt=c(re.timestamp);he.textContent=yt?`\u2260 ${yt}`:`\u2260 ${re.id||""}`.trim(),he.addEventListener("click",()=>{r=re,L.querySelectorAll(".diff-item").forEach(Et=>{Et.classList.remove("diff-item--active"),Et.setAttribute("aria-selected","false")}),he.classList.add("diff-item--active"),he.setAttribute("aria-selected","true"),Oe()}),L.appendChild(he),i.push(he)});let R=document.createElement("div");R.className="diff-main";let q=document.createElement("div");q.className="diff-panes diff-panes--side";let j=document.createElement("div");j.className="diff-pane-wrap";let $=document.createElement("div");$.className="diff-pane-wrap";let X=document.createElement("div");X.className="diff-pane-title",X.textContent=e.beforeTitle||"\u0414\u043E";let W=document.createElement("div");W.className="diff-pane-title",W.textContent=e.afterTitle||"\u041F\u043E\u0441\u043B\u0435";let te=document.createElement("div");te.className="diff-pane diff-pane--before";let be=document.createElement("div");be.className="diff-pane diff-pane--after",j.appendChild(X),j.appendChild(te),$.appendChild(W),$.appendChild(be),q.appendChild(j),q.appendChild($),R.appendChild(q),v.appendChild(L),v.appendChild(R),b.appendChild(v);let Oe=()=>{o=r;let re=r?.beforePlain||r?.before||"",he=r?.afterPlain||r?.after||"";te.innerHTML="",be.innerHTML="",te.appendChild(vr({baseText:re,nextText:he,mode:"before"})),be.appendChild(vr({baseText:re,nextText:he,mode:"after"}))};return s=Oe,Oe(),b}});l.classList.add("modal-card--fullscreen"),l.classList.add("modal-card--diff-light"),d.classList.remove("danger-btn"),!e.canRestore&&p&&(p.style.display="none"),p&&p.classList.add("danger-btn");let h=!1,y=()=>{},S=()=>{a.classList.add("modal-overlay--hide"),setTimeout(()=>a.remove(),150),document.removeEventListener("keydown",m)},f=b=>{h||(h=!0,S(),y(b))},m=b=>{if(b.code==="Escape"&&(b.preventDefault(),f(null)),b.code==="ArrowUp"||b.code==="ArrowDown"){if(!n.length)return;b.preventDefault();let x=String(r?.id||""),v=n.findIndex(q=>String(q?.id||"")===x);v<0&&(v=0),v=b.code==="ArrowUp"?Math.max(0,v-1):Math.min(n.length-1,v+1);let L=n[v]||null;if(!L)return;r=L;let R=i[v];if(i.forEach(q=>{q.classList.remove("diff-item--active"),q.setAttribute("aria-selected","false")}),R){R.classList.add("diff-item--active"),R.setAttribute("aria-selected","true"),R.focus({preventScroll:!0});try{R.scrollIntoView({block:"nearest"})}catch{}}typeof s=="function"&&s()}};return new Promise(b=>{y=b,d.addEventListener("click",()=>f(null)),p&&e.canRestore&&p.addEventListener("click",()=>f({action:"restore",entry:o||r||null})),a.addEventListener("click",x=>{x.target===a&&f(null)}),document.addEventListener("keydown",m),t.appendChild(a),requestAnimationFrame(()=>{l.focus({preventScroll:!0})})})}function Jc(e){let t=[],n=r=>{if(!r)return;if(typeof r=="string"){t.push(r);return}if(Array.isArray(r)){r.forEach(n);return}if(typeof r!="object")return;typeof r.text=="string"&&t.push(r.text);let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(e),t.join("").replace(/\u00a0/g," ").trim()}function pu(e){return!e||typeof e!="object"?!1:!!(e.beforeHeadingJson||e.beforeBodyJson||e.afterHeadingJson||e.afterBodyJson)}function mu(e={}){let t=cn(),r=(Array.isArray(e.entries)?e.entries:[]).filter(pu),o=typeof e.onRestore=="function"?e.onRestore:null,i=$=>String($??"").replace(/\u00a0/g," ").trim(),s=r.map($=>({...$,beforePlain:i($.beforePlain??$.before??""),afterPlain:i($.afterPlain??$.after??"")})),c=new Map;for(let $ of s){let X=String($?.blockId||"").trim();if(!X)continue;let W=c.get(X)||{blockId:X,entries:[],latestAt:0,label:""};W.entries.push($);let te=Date.parse($.timestamp||"")||0;if(te>W.latestAt&&(W.latestAt=te),!W.label){let be=Jc($.afterHeadingJson)||Jc($.beforeHeadingJson)||"",Oe=($.afterPlain||$.beforePlain||"").split(`
`).map(re=>re.trim()).find(Boolean)||"";W.label=be||Oe||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"}c.set(X,W)}let a=Array.from(c.values()).sort(($,X)=>(X.latestAt||0)-($.latestAt||0)),l=a[0]?.blockId||null,d=null,p=!1,h=$=>{try{let X=new Date($);return Number.isNaN(X.getTime())?String($||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(X)}catch{return String($||"")}},{overlay:y,card:S,confirmBtn:f,cancelBtn:m}=yn({title:e.title||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0441\u0442\u0430\u0442\u044C\u0438",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:e.canRestore?"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C":"",renderBody:()=>{let $=document.createDocumentFragment(),X=document.createElement("p");if(X.className="modal-body__text",X.textContent=e.message||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439 outline-\u0440\u0435\u0436\u0438\u043C\u0430. \u041C\u043E\u0436\u043D\u043E \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0435 \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0441\u0435\u043A\u0446\u0438\u0438 (\u0435\u0441\u043B\u0438 \u0441\u0435\u043A\u0446\u0438\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u2014 \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u043D\u0435\u0446 \u0441\u0442\u0430\u0442\u044C\u0438).",$.appendChild(X),!a.length){let se=document.createElement("div");return se.className="modal-empty",se.textContent="\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430.",$.appendChild(se),$}let W=document.createElement("div");W.className="diff-layout diff-layout--article-history";let te=document.createElement("div");te.className="modal-list diff-sidebar",te.classList.add("diff-sections");let be=document.createElement("input");be.type="text",be.className="modal-input",be.placeholder="\u041F\u043E\u0438\u0441\u043A \u043F\u043E \u0438\u0441\u0442\u043E\u0440\u0438\u0438\u2026",te.appendChild(be);let Oe=document.createElement("div");Oe.style.marginTop="8px",te.appendChild(Oe);let re=document.createElement("div");re.className="diff-main";let he=document.createElement("div");he.className="diff-layout diff-layout--article-history-inner";let Qe=document.createElement("div");Qe.className="modal-list diff-sidebar",Qe.classList.add("diff-revisions");let yt=document.createElement("div");yt.className="diff-panes diff-panes--side";let Et=document.createElement("div");Et.className="diff-pane-wrap";let qt=document.createElement("div");qt.className="diff-pane-wrap";let Wt=document.createElement("div");Wt.className="diff-pane-title",Wt.textContent=e.beforeTitle||"\u0414\u043E";let Tn=document.createElement("div");Tn.className="diff-pane-title",Tn.textContent=e.afterTitle||"\u041F\u043E\u0441\u043B\u0435";let Bn=document.createElement("div");Bn.className="diff-pane diff-pane--before";let Z=document.createElement("div");Z.className="diff-pane diff-pane--after",Et.appendChild(Wt),Et.appendChild(Bn),qt.appendChild(Tn),qt.appendChild(Z),yt.appendChild(Et),yt.appendChild(qt),he.appendChild(Qe),he.appendChild(yt),re.appendChild(he),W.appendChild(te),W.appendChild(re),$.appendChild(W);let fe=()=>{let se=be.value.trim().toLowerCase(),pe=se?a.filter(me=>(me.label||"").toLowerCase().includes(se)?!0:(me.entries||[]).some(Q=>`${Q.beforePlain||""}
${Q.afterPlain||""}`.toLowerCase().includes(se))):a;Oe.innerHTML="",pe.forEach(me=>{let Q=document.createElement("button");Q.type="button";let ye=me.blockId===l;Q.className=`diff-item${ye?" diff-item--active":""}`,Q.setAttribute("aria-selected",ye?"true":"false");let Pe=me.latestAt?h(new Date(me.latestAt).toISOString()):"",He=Array.isArray(me.entries)?me.entries.length:0;Q.textContent=`${me.label||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"}${Pe?` \xB7 ${Pe}`:""}${He?` \xB7 ${He}`:""}`,Q.addEventListener("click",()=>{l=me.blockId,d=null,p=!1,fe(),ge(),de()}),Oe.appendChild(Q)}),l&&!pe.some(me=>me.blockId===l)&&(l=pe[0]?.blockId||null,d=null,p=!1,ge(),de())},ge=()=>{let se=l?c.get(l):null,pe=Array.isArray(se?.entries)?se.entries.slice():[];pe.sort((Q,ye)=>(Date.parse(ye.timestamp||"")||0)-(Date.parse(Q.timestamp||"")||0));let me=d&&pe.some(Q=>String(Q?.id||"")===String(d||""));(!p||!me)&&(d=pe[0]?.id||null),Qe.innerHTML="",pe.forEach(Q=>{let ye=document.createElement("button");ye.type="button";let Pe=String(Q.id||"")===String(d||"");ye.className=`diff-item${Pe?" diff-item--active":""}`,ye.setAttribute("aria-selected",Pe?"true":"false");let He=h(Q.timestamp),Ge=(Q.afterPlain||Q.beforePlain||"").slice(0,64).trim();ye.textContent=`${He?`\u2260 ${He}`:`\u2260 ${Q.id||""}`}${Ge?` \xB7 ${Ge}`:""}`,ye.addEventListener("click",()=>{d=Q.id||null,p=!0,ge(),de()}),Qe.appendChild(ye)})},de=()=>{let se=l?c.get(l):null,pe=Array.isArray(se?.entries)?se.entries:[],me=pe.find(Pe=>String(Pe?.id||"")===String(d||""))||pe[0]||null,Q=me?.beforePlain||"",ye=me?.afterPlain||"";Bn.innerHTML="",Z.innerHTML="",Bn.appendChild(vr({baseText:Q,nextText:ye,mode:"before"})),Z.appendChild(vr({baseText:Q,nextText:ye,mode:"after"}))};return be.addEventListener("input",()=>{fe()}),fe(),ge(),de(),$}});S.classList.add("modal-card--fullscreen"),S.classList.add("modal-card--diff-light"),f.classList.remove("danger-btn"),!e.canRestore&&m&&(m.style.display="none"),m&&m.classList.add("danger-btn");let b=!1,x=()=>{},v=!1,L=()=>{y.classList.add("modal-overlay--hide"),setTimeout(()=>y.remove(),150),document.removeEventListener("keydown",q)},R=$=>{b||(b=!0,L(),x($))},q=$=>{$.code==="Escape"&&($.preventDefault(),R(null))},j=()=>{let $=l?c.get(l):null,X=Array.isArray($?.entries)?$.entries:[];return X.find(W=>String(W?.id||"")===String(d||""))||X[0]||null};return new Promise($=>{x=$,f.addEventListener("click",()=>R(null)),m&&e.canRestore&&m.addEventListener("click",async()=>{let X=j();if(!X){ve("\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430");return}if(!o){R({action:"restore",entry:X});return}if(v)return;v=!0;let W=m.textContent;try{m.disabled=!0,f.disabled=!0,m.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C\u2026",await o(X)}catch(te){ve(te?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C")}finally{v=!1,m.textContent=W,m.disabled=!1,f.disabled=!1}}),y.addEventListener("click",X=>{X.target===y&&R(null)}),document.addEventListener("keydown",q),t.appendChild(y),requestAnimationFrame(()=>{S.focus({preventScroll:!0})})})}function Oi(e={}){let t=cn(),n=null,r=null,{overlay:o,card:i,confirmBtn:s,cancelBtn:c,form:a}=yn({...e,renderBody:()=>{let f=document.createDocumentFragment();if(e.message){let L=document.createElement("p");L.className="modal-body__text",L.textContent=e.message,f.appendChild(L)}let m=document.createElement("label");m.className="modal-label",m.textContent=e.textLabel||"\u0422\u0435\u043A\u0441\u0442";let b=document.createElement("input");b.type="text",b.className="modal-input",b.placeholder=e.textPlaceholder||"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438",b.value=e.defaultText||"",b.autocomplete="off",m.appendChild(b);let x=document.createElement("label");x.className="modal-label",x.textContent=e.urlLabel||"\u0421\u0441\u044B\u043B\u043A\u0430";let v=document.createElement("input");return v.type="text",v.className="modal-input",v.placeholder=e.urlPlaceholder||"https://example.com",v.value=e.defaultUrl||"",v.autocomplete="off",x.appendChild(v),n=b,r=v,f.appendChild(m),f.appendChild(x),f}}),l=!1,d=()=>{},p=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",y)},h=f=>{l||(l=!0,p(),d(f))},y=f=>{if(f.code==="Escape"){f.preventDefault(),h(null);return}f.code==="Enter"&&!s.disabled&&(f.preventDefault(),h({text:(n?.value||"").trim(),url:(r?.value||"").trim()}))},S=()=>{let f=!!(r?.value||"").trim();s.disabled=!f};return new Promise(f=>{d=f,s.classList.remove("danger-btn"),s.textContent=e.confirmText||"OK",c.textContent=e.cancelText||"Cancel";let m=()=>{h({text:(n?.value||"").trim(),url:(r?.value||"").trim()})};a.addEventListener("submit",x=>{x.preventDefault(),s.disabled||m()}),s.addEventListener("click",m),c.addEventListener("click",()=>h(null)),o.addEventListener("click",x=>{x.target===o&&h(null)}),document.addEventListener("keydown",y);let b=x=>{x&&x.addEventListener("input",S)};b(n),b(r),S(),t.appendChild(o),requestAnimationFrame(()=>{r?(r.focus({preventScroll:!0}),r.value&&r.setSelectionRange(r.value.length,r.value.length)):i.focus({preventScroll:!0})})})}function Kc(e={}){let t=cn(),n=null,r=null,{overlay:o,card:i,confirmBtn:s,cancelBtn:c,form:a}=yn({...e,renderBody:()=>{let f=document.createDocumentFragment();if(e.message){let L=document.createElement("p");L.className="modal-body__text",L.textContent=e.message,f.appendChild(L)}let m=document.createElement("label");m.className="modal-label",m.textContent="\u041F\u0430\u0440\u043E\u043B\u044C";let b=document.createElement("input");b.type="password",b.className="modal-input",b.placeholder="\u041F\u0430\u0440\u043E\u043B\u044C \u0434\u043B\u044F \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B",b.autocomplete="off",m.appendChild(b);let x=document.createElement("label");x.className="modal-label",x.textContent="\u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0430 (\u043D\u0435\u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u044C\u043D\u043E)";let v=document.createElement("input");return v.type="text",v.className="modal-input",v.placeholder="\u041D\u0430\u043F\u043E\u043C\u0438\u043D\u0430\u043D\u0438\u0435 \u043E \u043F\u0430\u0440\u043E\u043B\u0435",v.autocomplete="off",x.appendChild(v),n=b,r=v,f.appendChild(m),f.appendChild(x),f}}),l=!1,d=()=>{},p=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",y)},h=f=>{l||(l=!0,p(),d(f))},y=f=>{if(f.code==="Escape"){f.preventDefault(),h(null);return}f.code==="Enter"&&!s.disabled&&(f.preventDefault(),h({password:(n?.value||"").trim(),hint:(r?.value||"").trim()}))},S=()=>{let f=!!(n?.value||"").trim();s.disabled=!f};return new Promise(f=>{d=f,s.classList.remove("danger-btn"),s.textContent=e.confirmText||"\u0417\u0430\u0449\u0438\u0442\u0438\u0442\u044C",c.textContent=e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430";let m=()=>{s.disabled||h({password:(n?.value||"").trim(),hint:(r?.value||"").trim()})};s.addEventListener("click",m),a.addEventListener("submit",b=>{b.preventDefault(),m()}),c.addEventListener("click",()=>h(null)),o.addEventListener("click",b=>{b.target===o&&h(null)}),document.addEventListener("keydown",y),n&&n.addEventListener("input",S),S(),t.appendChild(o),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):i.focus({preventScroll:!0})})})}function hu(e={}){let t=cn(),n=Array.isArray(e.items)?e.items:[],{overlay:r,card:o,confirmBtn:i,cancelBtn:s}=yn({title:e.title||"\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432",renderBody:()=>{let h=document.createElement("div");if(!n.length){let S=document.createElement("p");return S.className="modal-body__text",S.textContent="\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432 \u043F\u0443\u0441\u0442\u0430",h.appendChild(S),h}let y=document.createElement("div");return y.className="block-trash-list",n.forEach(S=>{let f=document.createElement("div");f.className="block-trash-item";let m=S.block&&S.block.text||"",b=qc(m),x=document.createElement("div");x.className="block-trash-item__title",x.textContent=b[0]||"(\u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A)";let v=document.createElement("div");v.className="block-trash-item__meta";let L=S.deletedAt?new Date(S.deletedAt).toLocaleString():"";v.textContent=L||"";let R=document.createElement("div");R.className="block-trash-item__info",R.appendChild(x),L&&R.appendChild(v);let q=document.createElement("button");q.type="button",q.className="primary",q.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",q.addEventListener("click",()=>{d(S)}),f.appendChild(R),f.appendChild(q),y.appendChild(f)}),h.appendChild(y),h}}),c=!1,a=()=>{},l=()=>{r.classList.add("modal-overlay--hide"),setTimeout(()=>r.remove(),150),document.removeEventListener("keydown",p)},d=h=>{c||(c=!0,l(),a(h||null))},p=h=>{h.code==="Escape"&&(h.preventDefault(),d(null))};return new Promise(h=>{a=h,i.classList.remove("hidden"),i.textContent="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u043A\u043E\u0440\u0437\u0438\u043D\u0443",i.classList.add("danger-btn"),s.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",i.addEventListener("click",()=>d({action:"clear"})),s.addEventListener("click",()=>d(null)),r.addEventListener("click",y=>{y.target===r&&d(null)}),document.addEventListener("keydown",p),t.appendChild(r),requestAnimationFrame(()=>{o.focus({preventScroll:!0})})})}function gu(e={}){let t=cn(),{title:n,message:r,existingTitle:o,importedTitle:i,existingCreatedAt:s,existingUpdatedAt:c,importedCreatedAt:a,importedUpdatedAt:l,allowApplyToAll:d=!0}=e||{},p=document.createElement("div");p.className="modal-overlay";let h=document.createElement("div");h.className="modal-card",h.setAttribute("role","dialog"),h.setAttribute("aria-modal","true"),h.tabIndex=-1;let y=document.createElement("div");y.className="modal-header";let S=document.createElement("h3");S.textContent=n||"\u041A\u043E\u043D\u0444\u043B\u0438\u043A\u0442 \u043F\u0440\u0438 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0438",y.appendChild(S);let f=document.createElement("div");if(f.className="modal-body",r){let te=document.createElement("p");te.className="modal-body__text",te.textContent=r,f.appendChild(te)}if(o||i){let te=document.createElement("p");te.className="modal-body__text",te.innerHTML=[o?`<strong>\u0412 \u0431\u0430\u0437\u0435:</strong> ${o}`:"",i?`<strong>\u0418\u0437 \u0444\u0430\u0439\u043B\u0430:</strong> ${i}`:""].filter(Boolean).join("<br />"),f.appendChild(te)}if(s||c||a||l){let te=re=>{if(!re)return"";let he=new Date(re);return Number.isNaN(he.getTime())?re:he.toLocaleString()},be=document.createElement("p");be.className="modal-body__text";let Oe=[];if(s||c){let re=s?te(s):"\u2014",he=c?te(c):"\u2014";Oe.push(`<strong>\u0412 \u0431\u0430\u0437\u0435:</strong> \u0441\u043E\u0437\u0434\u0430\u043D\u0430 ${re}, \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430 ${he}`)}if(a||l){let re=a?te(a):"\u2014",he=l?te(l):"\u2014";Oe.push(`<strong>\u0418\u0437 \u0444\u0430\u0439\u043B\u0430:</strong> \u0441\u043E\u0437\u0434\u0430\u043D\u0430 ${re}, \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430 ${he}`)}be.innerHTML=Oe.join("<br />"),f.appendChild(be)}let m=null;if(d){let te=document.createElement("label");te.className="modal-label";let be=document.createElement("input");be.type="checkbox",be.style.marginRight="0.5rem",te.appendChild(be),te.appendChild(document.createTextNode("\u041F\u0440\u0438\u043C\u0435\u043D\u044F\u0442\u044C \u044D\u0442\u043E \u0440\u0435\u0448\u0435\u043D\u0438\u0435 \u043A\u043E \u0432\u0441\u0435\u043C \u043A\u043E\u043D\u0444\u043B\u0438\u043A\u0442\u0430\u043C")),m=be,f.appendChild(te)}let b=document.createElement("div");b.className="modal-footer modal-footer--stacked";let x=document.createElement("button");x.type="button",x.className="ghost",x.textContent="\u041E\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0443\u044E";let v=document.createElement("button");v.type="button",v.className="primary danger-btn",v.textContent="\u041F\u0435\u0440\u0435\u0437\u0430\u043F\u0438\u0441\u0430\u0442\u044C";let L=document.createElement("button");L.type="button",L.className="ghost",L.textContent="\u0421\u043E\u0437\u0434\u0430\u0442\u044C \u043A\u043E\u043F\u0438\u044E";let R=document.createElement("button");R.type="button",R.className="ghost",R.textContent="\u041E\u0442\u043C\u0435\u043D\u0430",b.appendChild(x),b.appendChild(v),b.appendChild(L),b.appendChild(R),h.appendChild(y),h.appendChild(f),h.appendChild(b),p.appendChild(h);let q=!1,j=()=>{},$=()=>{p.classList.add("modal-overlay--hide"),setTimeout(()=>p.remove(),150),document.removeEventListener("keydown",W)},X=te=>{if(q)return;q=!0;let be=!!(m&&m.checked);$(),j({action:te,applyToAll:be})},W=te=>{te.code==="Escape"&&(te.preventDefault(),X(null))};return new Promise(te=>{j=te,x.addEventListener("click",()=>X("keep")),v.addEventListener("click",()=>X("overwrite")),L.addEventListener("click",()=>X("copy")),R.addEventListener("click",()=>X(null)),p.addEventListener("click",be=>{be.target===p&&X(null)}),document.addEventListener("keydown",W),t.appendChild(p),requestAnimationFrame(()=>{h.focus({preventScroll:!0})})})}function Wr(e,t=""){let n=cn(),r=document.createElement("div");r.className="modal-overlay image-modal";let o=document.createElement("div");o.className="image-modal__card",o.setAttribute("role","dialog"),o.setAttribute("aria-modal","true"),o.tabIndex=-1;let i=document.createElement("img");i.className="image-modal__img",i.src=e,t&&(i.alt=t),o.appendChild(i),r.appendChild(o);let s,c=()=>{s&&s()},a=l=>{l.code==="Escape"&&(l.preventDefault(),c())};s=()=>{document.removeEventListener("keydown",a),r.classList.add("modal-overlay--hide"),setTimeout(()=>r.remove(),150)},r.addEventListener("click",l=>{l.target===r&&c()}),document.addEventListener("keydown",a),n.appendChild(r),requestAnimationFrame(()=>{o.focus({preventScroll:!0})})}var Vc,Jn=We(()=>{An();Vt();Vc="modal-root"});function Wc(e){if(typeof btoa=="function"){let t="";for(let n=0;n<e.length;n+=1)t+=String.fromCharCode(e[n]);return btoa(t)}if(typeof Buffer<"u")return Buffer.from(e).toString("base64");throw new Error("No base64 encoder available")}function Yc(e){if(!e)return new Uint8Array(0);if(typeof atob=="function"){let t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r+=1)n[r]=t.charCodeAt(r);return n}if(typeof Buffer<"u"){let t=Buffer.from(e,"base64"),n=new Uint8Array(t.length);for(let r=0;r<t.length;r+=1)n[r]=t[r];return n}throw new Error("No base64 decoder available")}function $i(e){return typeof e=="string"&&e.startsWith(Hi)}async function Xc(e,t){if(!e)throw new Error("Password is required");let n=t&&t.length?Yc(t):Qc(16),r=Lo(e||""),o=new Uint8Array(r.length+n.length);return o.set(r,0),o.set(n,r.length),{key:{raw:Lo(String.fromCharCode(...o))},salt:Wc(n)}}function Lo(e=""){let t=2166136261,n=16777619;for(let o=0;o<e.length;o+=1){let i=e.charCodeAt(o);t^=i,t=t*16777619>>>0,n^=i<<o%8,n=n*16777619>>>0}let r=new Uint8Array(32);for(let o=0;o<32;o+=1){let i=o<16?t:n;r[o]=i>>>o%4*8&255}return r}function Qc(e){let t=new Uint8Array(e);for(let n=0;n<e;n+=1)t[n]=Math.floor(Math.random()*256);return t}async function bu(e,t=""){if(!e)throw new Error("Missing encryption key");let n=e&&e.raw?e.raw:Lo("fallback-key"),r=Qc(12),i=new TextEncoder().encode(t||""),s=new Uint8Array(r.length+i.length);s.set(r,0);for(let c=0;c<i.length;c+=1){let a=n[c%n.length],l=r[c%r.length];s[r.length+c]=i[c]^a^l}return`${Hi}${Wc(s)}`}async function Fi(e,t){if(!e)throw new Error("Missing encryption key");if(!$i(t))throw new Error("Data is not in encrypted format");let n=t.slice(Hi.length),r=Yc(n);if(r.length<13)throw new Error("Encrypted payload is too short");let o=r.slice(0,12),i=r.slice(12),s=e&&e.raw?e.raw:Lo("fallback-key"),c=new Uint8Array(i.length);for(let l=0;l<i.length;l+=1){let d=s[l%s.length],p=o[l%o.length];c[l]=i[l]^d^p}return new TextDecoder().decode(c)}async function Gc(e,t){if(!t)return!1;try{return await Fi(e,t)===yu}catch{return!1}}async function Zc(e,t){if(!e)return;if(typeof e.text=="string"&&$i(e.text))try{e.text=await Fi(t,e.text)}catch{e.text=""}let n=Array.isArray(e.children)?e.children:[];for(let r of n)await Zc(r,t)}async function zi(e,t){if(!(!e||!Array.isArray(e.blocks)))for(let n of e.blocks)await Zc(n,t)}async function Ui(e,t){return bu(e,t||"")}var Hi,yu,Yr=We(()=>{Hi="enc-v1:",yu="memus-article-encryption-ok"});function pn(e){if(window.location.pathname===e){ea(e);return}window.history.pushState({},"",e),ea(e)}function ea(e){let t=e.match(/^\/p\/([^/?#]+)/);if(t){Vi(decodeURIComponent(t[1]));return}let n=e.match(/^\/article\/([0-9a-zA-Z-]+)/);if(n){let r=String(n[1]||"");if(r.startsWith("inbox-")){try{window.history.replaceState({},"",Xt.article("inbox"))}catch{}Po("inbox");return}Po(r);return}qi()}var Xt,jn=We(()=>{cr();Xt={list:"/",article:e=>`/article/${e}`,public:e=>`/p/${e}`}});var ta=We(()=>{ir();xn()});function na(){V.searchResults&&V.searchResults.classList.add("hidden")}var ra=We(()=>{wt();un();An();Yt();jn();Kn();Vt();ta()});function _o(){try{localStorage.setItem(Su,JSON.stringify(u.sidebarCollapsedArticleIds||[]))}catch{}}function Do(){try{localStorage.setItem(xu,JSON.stringify(u.listCollapsedArticleIds||[]))}catch{}}var Su,xu,Er=We(()=>{wt();Su="ttree_collapsed_articles",xu="ttree_list_collapsed_articles"});function Ji(){V.articlesTabBtn&&(V.articlesTabBtn.classList.toggle("active",!u.isTrashView),V.articlesTabBtn.setAttribute("aria-pressed",u.isTrashView?"false":"true")),V.trashTabBtn&&(V.trashTabBtn.classList.toggle("active",u.isTrashView),V.trashTabBtn.setAttribute("aria-pressed",u.isTrashView?"true":"false")),V.createArticleBtn&&(V.createArticleBtn.disabled=u.isTrashView),V.sidebarNewArticleBtn&&(V.sidebarNewArticleBtn.disabled=u.isTrashView)}function Oo(){wi&&(oc(!1),V.hintPopover&&V.hintPopover.classList.add("hidden"),V.hintToggleBtn&&V.hintToggleBtn.setAttribute("aria-expanded","false"))}function Xr(e){u.isSidebarMobileOpen=e,V.sidebar&&V.sidebar.classList.toggle("mobile-open",e),V.sidebarBackdrop&&V.sidebarBackdrop.classList.toggle("hidden",!e),e&&(Oo(),na())}function Qr(e){V.articleView.classList.toggle("hidden",!e),V.articleListView.classList.toggle("hidden",e),V.articleHeader&&V.articleHeader.classList.toggle("hidden",!e),e||Oo(),e&&u.isTrashView&&(u.isTrashView=!1,Ji())}var Ro=We(()=>{wt();un();ra();Er()});function aa({renderSidebarArticleList:e,renderMainArticleList:t,setArticlesIndex:n}={}){sa=typeof e=="function"?e:null,ji=typeof t=="function"?t:null,ca=typeof n=="function"?n:null}function $o(){In&&(In.classList.remove("drop-before","drop-after","drop-inside"),In=null)}function la(e,t){e&&(In&&In!==e&&In.classList.remove("drop-before","drop-after","drop-inside"),In=e,In.classList.remove("drop-before","drop-after","drop-inside"),t==="before"?In.classList.add("drop-before"):t==="after"?In.classList.add("drop-after"):t==="inside"&&In.classList.add("drop-inside"))}function ku(){mt&&(mt.sourceEl instanceof Element&&mt.sourceEl.classList.remove("article-dnd-source"),typeof document<"u"&&document.body&&document.body.classList.remove("article-dnd-active"),window.removeEventListener("pointermove",Yi),window.removeEventListener("pointerup",Gr),window.removeEventListener("pointercancel",Gr),window.removeEventListener("touchmove",da),window.removeEventListener("touchend",Ho),window.removeEventListener("touchcancel",Ho),mt=null,$o(),window.__ttreeDraggingArticleId=null)}function oa(e){return e instanceof Element?!!(e.closest(".star-btn")||e.closest(".row-actions")):!1}function vu(e,t){if(!t||mt||!e.touches||e.touches.length!==1)return;let n=e.touches[0],r=e.currentTarget instanceof Element?e.currentTarget:null;mt={pointerId:"legacy-touch",articleId:t,startX:n.clientX,startY:n.clientY,dragging:!1,lastTargetId:null,lastDropMode:null,sourceEl:r},window.__ttreeDraggingArticleId=t,typeof document<"u"&&document.body&&document.body.classList.add("article-dnd-active");try{let o=window.getSelection?window.getSelection():null;o&&!o.isCollapsed&&o.removeAllRanges()}catch{}window.addEventListener("touchmove",da,{passive:!1}),window.addEventListener("touchend",Ho),window.addEventListener("touchcancel",Ho)}function da(e){if(!mt||!e.touches||e.touches.length===0)return;let t=e.touches[0];Yi({pointerId:"legacy-touch",clientX:t.clientX,clientY:t.clientY,preventDefault:()=>{e.preventDefault()}})}function Ho(){mt&&Gr({pointerId:"legacy-touch"})}function Eu(e,t){let n=document.elementFromPoint(e,t);if(!n)return null;let r=n.closest(".sidebar-article-item, #articleList li");return!r||!r.dataset||!r.dataset.articleId?null:r}function Cu(e,t){if(!t||mt)return;let n=e.currentTarget instanceof Element?e.currentTarget:null;mt={pointerId:e.pointerId,articleId:t,startX:e.clientX,startY:e.clientY,dragging:!1,lastTargetId:null,lastDropMode:null,sourceEl:n},window.__ttreeDraggingArticleId=t,typeof document<"u"&&document.body&&document.body.classList.add("article-dnd-active");try{let r=window.getSelection?window.getSelection():null;r&&!r.isCollapsed&&r.removeAllRanges()}catch{}try{e.currentTarget?.setPointerCapture?.(e.pointerId)}catch{}window.addEventListener("pointermove",Yi),window.addEventListener("pointerup",Gr),window.addEventListener("pointercancel",Gr)}function Yi(e){if(!mt||e.pointerId!==mt.pointerId)return;let t=e.clientX-mt.startX,n=e.clientY-mt.startY;if(!mt.dragging){if(Math.hypot(t,n)<Au)return;mt.dragging=!0,mt.sourceEl instanceof Element&&mt.sourceEl.classList.add("article-dnd-source")}e.preventDefault();let r=Eu(e.clientX,e.clientY);if(!r||!r.dataset||!r.dataset.articleId||r.dataset.articleId===mt.articleId){$o(),mt.lastTargetId=null,mt.lastDropMode=null;return}let o=r.getBoundingClientRect(),i=e.clientY-o.top,s=o.height/3,c;i<s?c="before":i>o.height-s?c="after":c="inside",mt.lastTargetId=r.dataset.articleId,mt.lastDropMode=c,la(r,c)}function Gr(e){if(!mt||e.pointerId!==mt.pointerId)return;let t=mt;ku(),!(!t.dragging||!t.lastTargetId||!t.lastDropMode)&&t.lastTargetId!==t.articleId&&ua(t.articleId,t.lastTargetId,t.lastDropMode)}function Xi(e,t){e&&(Iu?e.addEventListener("pointerdown",n=>{if(n.pointerType!=="touch"||typeof n.button=="number"&&n.button!==0||oa(n.target))return;let r=n.pointerId,o=350,i=!1,s=window.setTimeout(()=>{i=!0,Cu(n,t)},o),c=a=>{a.pointerId===r&&(i||window.clearTimeout(s),window.removeEventListener("pointerup",c,!0),window.removeEventListener("pointercancel",c,!0))};window.addEventListener("pointerup",c,!0),window.addEventListener("pointercancel",c,!0)}):e.addEventListener("touchstart",n=>{if(!n.touches||n.touches.length!==1)return;let r=n.target;if(oa(r))return;let o=350,i=!1,s=window.setTimeout(()=>{i=!0,vu(n,t)},o),c=()=>{i||window.clearTimeout(s),window.removeEventListener("touchend",c,!0),window.removeEventListener("touchcancel",c,!0)};window.addEventListener("touchend",c,!0),window.addEventListener("touchcancel",c,!0)},{passive:!1}))}function Wi(e){return e&&(u.articlesIndex||[]).find(t=>t.id===e)||null}function ia(e){let t=e||null;return(u.articlesIndex||[]).filter(n=>(n.parentId||null)===t).sort((n,r)=>n.position!==r.position?n.position-r.position:new Date(n.updatedAt||0)-new Date(r.updatedAt||0))}function Tu(e,t,n,r){if(!e)return;let o=Wi(e);if(!o)return;let i=t||null,s=o.parentId||null,a=ia(s).filter(y=>y.id!==e),l;i===s?l=a:l=ia(i);let d=l.filter(y=>y.id!==e),p=d.length;if(n&&r&&r!=="inside"){let y=d.findIndex(S=>S.id===n);y!==-1&&(p=r==="before"?y:y+1)}r==="inside"&&(p=d.length),p<0&&(p=0),p>d.length&&(p=d.length);let h=d.slice();h.splice(p,0,o),o.parentId=i,a.forEach((y,S)=>{y.position=S}),h.forEach((y,S)=>{y.parentId=i,y.position=S})}function ua(e,t,n){if(!e||!t||!n)return;let r=Wi(e),o=Wi(t);if(!r||!o)return;let i=n==="inside"?o.id:o.parentId||null,s=n==="inside"?null:o.id;Tu(e,i,s,n),sa?.(),ji?.(),(async()=>{try{await zc(e,{parentId:i,anchorId:s,placement:n})}catch(c){try{let a=await fn();ca?.(a),ji?.()}catch{}ve(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443")}})()}function Bu(e){window.__ttreeDraggingArticleId?an=window.__ttreeDraggingArticleId:an=e.currentTarget?.dataset?.articleId||null,e.dataTransfer&&(e.dataTransfer.effectAllowed="move",an&&e.dataTransfer.setData("text/plain",an))}function Nu(e){if(!an){let s=window.__ttreeDraggingArticleId,c=null;if(!s&&e?.dataTransfer)try{c=e.dataTransfer.getData("text/plain")||null}catch{c=null}an=s||c||null}if(!an||!e.currentTarget||!e.currentTarget.dataset.articleId)return;e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="move");let t=e.currentTarget,n=t.getBoundingClientRect(),r=e.clientY-n.top,o=n.height/3,i;r<o?i="before":r>n.height-o?i="after":i="inside",la(t,i)}function Mu(e){if(!an){let c=window.__ttreeDraggingArticleId,a=null;if(!c&&e?.dataTransfer)try{a=e.dataTransfer.getData("text/plain")||null}catch{a=null}an=c||a||null}if(!an)return;let t=e.currentTarget,n=t?.dataset?.articleId||null;if(!n||n===an)return;e.preventDefault(),$o();let r=t.getBoundingClientRect(),o=e.clientY-r.top,i=r.height/3,s;o<i?s="before":o>r.height-i?s="after":s="inside",ua(an,n,s),an=null}function Lu(){an=null,window.__ttreeDraggingArticleId=null,$o()}function Qi(e){e&&(e.draggable=!0,e.addEventListener("dragstart",Bu),e.addEventListener("dragover",Nu),e.addEventListener("drop",Mu),e.addEventListener("dragend",Lu))}var sa,ji,ca,Ki,an,In,Au,mt,Iu,Gi=We(()=>{wt();Yt();Vt();sa=null,ji=null,ca=null;Ki=!1;typeof window<"u"&&(window.matchMedia&&window.matchMedia("(pointer: coarse)").matches||"ontouchstart"in window)&&(Ki=!0);an=null,In=null,Au=6,mt=null,Iu=typeof window<"u"&&"PointerEvent"in window&&!Ki});function Pu(){try{let e=localStorage.getItem(pa),t=e?JSON.parse(e):[];u.favoriteArticles=Array.isArray(t)?t:[]}catch{u.favoriteArticles=[]}}function _u(){try{localStorage.setItem(pa,JSON.stringify(u.favoriteArticles||[]))}catch{}}function ma(e=[]){let t=new Set(u.favoriteArticles||[]);return[...e].sort((n,r)=>{let o=t.has(n.id),i=t.has(r.id);return o!==i?o?-1:1:new Date(r.updatedAt||r.deletedAt||0)-new Date(n.updatedAt||n.deletedAt||0)})}function Fo(e){if(!e)return;u.favoriteArticles||(u.favoriteArticles=[]);let t=new Set(u.favoriteArticles);t.has(e)?t.delete(e):t.add(e),u.favoriteArticles=Array.from(t),_u(),Ft(),kn()}function zo(e=[]){(!u.favoriteArticles||!u.favoriteArticles.length)&&Pu();let t=Array.isArray(e)?e:[];u.articlesIndex=t.map(r=>({id:r.id,title:r.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",updatedAt:r.updatedAt||new Date().toISOString(),deletedAt:r.deletedAt||null,publicSlug:r.publicSlug||null,parentId:r.parentId||null,position:typeof r.position=="number"?r.position:0}));let n=new Set(u.articlesIndex.map(r=>r.id));Array.isArray(u.sidebarCollapsedArticleIds)&&u.sidebarCollapsedArticleIds.length&&(u.sidebarCollapsedArticleIds=u.sidebarCollapsedArticleIds.filter(r=>n.has(r)),_o()),Array.isArray(u.listCollapsedArticleIds)&&u.listCollapsedArticleIds.length&&(u.listCollapsedArticleIds=u.listCollapsedArticleIds.filter(r=>n.has(r)),Do()),Ft()}function ha(e=[]){let t=ma(Array.isArray(e)?e:[]);u.deletedArticlesIndex=t,Ft()}function Cr(e){if(!e||!e.id||e.deletedAt)return;let t={id:e.id,title:e.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",updatedAt:e.updatedAt||new Date().toISOString(),publicSlug:e.publicSlug||null,parentId:e.parentId||null,position:typeof e.position=="number"?e.position:0},n=u.articlesIndex.findIndex(r=>r.id===t.id);n>=0?u.articlesIndex[n]={...u.articlesIndex[n],...t}:u.articlesIndex.unshift(t),Ft()}function Zi(e){if(!e)return;let t=u.deletedArticlesIndex.length;u.deletedArticlesIndex=u.deletedArticlesIndex.filter(n=>n.id!==e),t!==u.deletedArticlesIndex.length&&(Ft(),kn())}function ga(e=[]){let t=new Map;e.forEach(o=>{t.set(o.id,{...o,children:[]})});let n=[];t.forEach(o=>{let i=o.parentId||null;i&&t.has(i)?t.get(i).children.push(o):n.push(o)});let r=o=>{o.sort((i,s)=>{let c=(u.favoriteArticles||[]).includes(i.id),a=(u.favoriteArticles||[]).includes(s.id);return c!==a?c?-1:1:i.position!==s.position?i.position-s.position:new Date(s.updatedAt||0)-new Date(i.updatedAt||0)}),o.forEach(i=>r(i.children||[]))};return r(n),n}function Ft(){if(!V.sidebarArticleList)return;V.sidebarArticleList.innerHTML="",V.backToList&&V.backToList.classList.toggle("active",u.sidebarArticlesMode!=="recent"),V.sidebarRecentBtn&&V.sidebarRecentBtn.classList.toggle("active",u.sidebarArticlesMode==="recent");let e=(u.articleFilterQuery||"").trim().toLowerCase(),t=u.sidebarArticlesMode==="recent"?"recent":"tree",n=u.isTrashView?u.deletedArticlesIndex:u.articlesIndex,r=new Set(u.favoriteArticles||[]),o=new Set(u.sidebarCollapsedArticleIds||[]),i=u.sidebarSelectedArticleId||u.articleId,s=Array.isArray(u.recentArticleIds)?u.recentArticleIds:[],c=[];if(!u.isTrashView&&(r.has("RAG")||t==="recent"&&s.includes("RAG"))){let f=(u.ragQuery||"").trim();c.push({id:"RAG",title:f?`AI: ${f}`:"AI: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B \u043F\u043E\u0438\u0441\u043A\u0430",updatedAt:new Date().toISOString(),deletedAt:null,publicSlug:null,parentId:null,position:0})}let l=new Set(c.map(f=>f.id)),d=c.length&&!u.isTrashView?[...(n||[]).filter(f=>!l.has(f.id)),...c]:n,p=new Set;(d||[]).forEach(f=>{let m=f.parentId||null;m&&p.add(m)});let h=(d||[]).filter(f=>(e?(f.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(e):!0)&&(u.isTrashView?!0:f.id!=="inbox"));if(!h.length){let f=document.createElement("li");f.className="sidebar-article-empty",f.textContent=u.isTrashView?e?"No deleted pages match the filter":"Trash is empty":e?"\u041D\u0435\u0442 \u0441\u043E\u0432\u043F\u0430\u0434\u0435\u043D\u0438\u0439":"\u041D\u0435\u0442 \u0441\u0442\u0430\u0442\u0435\u0439",V.sidebarArticleList.appendChild(f);return}if(t==="recent"){let f=new Map(h.map(L=>[L.id,L])),m=new Set(s),b=s.map(L=>f.get(L)).filter(Boolean),x=ma(h.filter(L=>!m.has(L.id)));[...b,...x].forEach(L=>{let R=document.createElement("li");R.className="sidebar-article-item",R.dataset.articleId=L.id;let q=document.createElement("div");q.className="sidebar-article-row";let j=document.createElement("button");j.type="button",!u.isTrashView&&L.id===i&&j.classList.add("active");let $=r.has(L.id),X=zt(L.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),W=L.publicSlug?"\uE774 ":"";j.innerHTML=`<span class="sidebar-article-title">${W}${X}</span><span class="star-btn ${$?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${$?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}">${$?"\uE735":"\uE734"}</span>`,j.addEventListener("click",()=>{window.__ttreeDraggingArticleId||(u.sidebarSelectedArticleId=L.id,pn(Xt.article(L.id)),u.isSidebarMobileOpen&&Xr(!1))});let te=j.querySelector(".star-btn");te&&te.addEventListener("click",be=>{be.stopPropagation(),Fo(L.id)}),q.appendChild(j),R.appendChild(q),V.sidebarArticleList.appendChild(R)});return}let y=ga(h),S=(f,m)=>{let b=document.createElement("li");b.className="sidebar-article-item",p.has(f.id)&&(b.classList.add("has-children"),o.has(f.id)&&b.classList.add("is-collapsed")),b.dataset.articleId=f.id,b.style.paddingLeft=`${m*1.25}rem`;let x=document.createElement("div");x.className="sidebar-article-row";let v=document.createElement("button");v.type="button",!u.isTrashView&&f.id===i&&v.classList.add("active");let L=r.has(f.id),R=zt(f.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),q=f.publicSlug?"\uE774 ":"";v.innerHTML=`<span class="sidebar-article-title">${q}${R}</span><span class="star-btn ${L?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${L?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}">${L?"\uE735":"\uE734"}</span>`,v.addEventListener("click",()=>{if(window.__ttreeDraggingArticleId)return;u.sidebarSelectedArticleId=f.id,u.sidebarCollapsedArticleIds||(u.sidebarCollapsedArticleIds=[]);let $=new Set(u.sidebarCollapsedArticleIds);$.has(f.id)?$.delete(f.id):$.add(f.id),u.sidebarCollapsedArticleIds=Array.from($),_o(),Ft()}),v.addEventListener("dblclick",$=>{$.preventDefault(),$.stopPropagation(),u.sidebarSelectedArticleId=f.id,pn(Xt.article(f.id)),u.isSidebarMobileOpen&&Xr(!1)});let j=v.querySelector(".star-btn");j&&j.addEventListener("click",$=>{$.stopPropagation(),Fo(f.id)}),x.appendChild(v),b.appendChild(x),u.isTrashView||(Qi(b),Xi(b,f.id)),V.sidebarArticleList.appendChild(b),o.has(f.id)||(f.children||[]).forEach($=>S($,m+1))};y.forEach(f=>S(f,0))}function kn(e=null){if(!V.articleList)return;V.articleList.innerHTML="";let t="",n=Array.isArray(e)&&e.length?e:u.isTrashView?u.deletedArticlesIndex:u.articlesIndex,r=new Set(u.favoriteArticles||[]),o=new Set(u.listCollapsedArticleIds||[]),i=u.listSelectedArticleId||u.articleId,s=new Set;if(n.forEach(d=>{let p=d.parentId||null;p&&s.add(p)}),!n.length){let d=document.createElement("li");d.textContent=u.isTrashView?t?"No deleted pages match the filter":"Trash is empty":t?"\u041D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E":"\u0421\u043F\u0438\u0441\u043E\u043A \u043F\u0443\u0441\u0442.",V.articleList.appendChild(d);return}if(u.isTrashView){n.slice().filter(d=>(t?(d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(t):!0)&&(u.isTrashView?!0:d.id!=="inbox")).forEach(d=>{let p=document.createElement("li");p.dataset.articleId=d.id,p.innerHTML=`
      <span>
        <strong>${zt(d.title)}</strong>
      </span>
      <div class="row-actions">
        <button class="ghost restore-btn" data-id="${d.id}">\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C</button>
        <button class="ghost danger delete-btn" data-id="${d.id}">\u0423\u0434\u0430\u043B\u0438\u0442\u044C</button>
      </div>
    `;let h=p.querySelector(".restore-btn"),y=p.querySelector(".delete-btn");h&&h.addEventListener("click",async S=>{S.preventDefault(),S.stopPropagation(),await Du(d.id)}),y&&y.addEventListener("click",async S=>{S.preventDefault(),S.stopPropagation(),await Ou(d.id)}),V.articleList.appendChild(p)});return}let c=n.slice().filter(d=>(t?(d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(t):!0)&&d.id!=="inbox"),a=ga(c),l=(d,p)=>{let h=document.createElement("li");s.has(d.id)&&(h.classList.add("has-children"),o.has(d.id)&&h.classList.add("is-collapsed")),h.dataset.articleId=d.id;let y=r.has(d.id),S=zt(d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),f=d.publicSlug?'<span class="article-public-icon">&#xE774;</span>':"";h.style.paddingLeft=`${p*1.25}rem`,h.innerHTML=`
      <span>
        <strong>${f}${S}</strong>
      </span>
      <button class="ghost star-btn ${y?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${y?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}">${y?"\uE735":"\uE734"}</button>
    `;let m=h.querySelector(".star-btn");m&&m.addEventListener("click",b=>{b.preventDefault(),b.stopPropagation(),Fo(d.id)}),d.id===i&&h.classList.add("active-article"),h.addEventListener("click",()=>{if(window.__ttreeDraggingArticleId)return;u.listSelectedArticleId=d.id,u.listCollapsedArticleIds||(u.listCollapsedArticleIds=[]);let b=new Set(u.listCollapsedArticleIds);b.has(d.id)?b.delete(d.id):b.add(d.id),u.listCollapsedArticleIds=Array.from(b),Do(),kn()}),h.addEventListener("dblclick",b=>{b.preventDefault(),b.stopPropagation(),u.listSelectedArticleId=d.id,pn(Xt.article(d.id))}),V.articleList.appendChild(h),u.isTrashView||(Qi(h),Xi(h,d.id)),o.has(d.id)||(d.children||[]).forEach(b=>l(b,p+1))};a.forEach(d=>l(d,0))}async function Du(e){if(e)try{let t=await $c(e);Zi(e),Cr(t),await ya(!1),pn(Xt.article(t.id)),ve("Page restored")}catch(t){ve(t.message)}}async function Ou(e){if(e)try{await Hc(e,{force:!0}),Zi(e),ve("\u0421\u0442\u0430\u0442\u044C\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u0431\u0435\u0437\u0432\u043E\u0437\u0432\u0440\u0430\u0442\u043D\u043E"),kn(),Ft()}catch(t){ve(t.message)}}async function ya(e){u.isTrashView=e,Ji(),e?await Uo():await Zr(),Ft(),kn()}async function Zr(){if(u.articlesIndex.length)return u.isTrashView||Ft(),u.articlesIndex;let e=await fn();return zo(e),e}async function Uo(){if(u.deletedArticlesIndex.length)return u.isTrashView&&Ft(),u.deletedArticlesIndex;let e=await Pc();return ha(e),e}var pa,qo=We(()=>{wt();un();An();jn();Yt();Vt();Ro();Er();Gi();pa="ttree_favorites"});function $u(){try{let e=Array.isArray(u.recentArticleIds)?u.recentArticleIds:[];window.localStorage.setItem(Hu,JSON.stringify(e.slice(0,ba)))}catch{}}function Vo(e){if(!e||e==="inbox"||u.isPublicView)return;let t=Array.isArray(u.recentArticleIds)?u.recentArticleIds:[],n=[e,...t.filter(r=>r!==e)];u.recentArticleIds=n.slice(0,ba),$u(),u.sidebarArticlesMode==="recent"&&Ft()}var Hu,ba,es=We(()=>{wt();qo();Er();Hu="ttree_recent_articles",ba=300});var Kn=We(()=>{un();wt();es();Er();Ro();Gi();qo();Er();es();Ro();qo();aa({renderSidebarArticleList:Ft,renderMainArticleList:kn,setArticlesIndex:zo})});function zu(e){u.articleId&&(u.articleEncryptionKeys||(u.articleEncryptionKeys={}),e?u.articleEncryptionKeys[u.articleId]=e:delete u.articleEncryptionKeys[u.articleId])}async function wa(e){if(!e||!e.encrypted)return e;let t=u.articleEncryptionKeys?.[e.id]||null;if(t)return await zi(e,t),e;let n=0;for(;;){n+=1;let r=null;try{let o=e.encryptionHint||"",i="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C \u0434\u043B\u044F \u044D\u0442\u043E\u0439 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B.",s=o?`${i}
\u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0430: ${o}`:i;r=await Vn({title:"\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430",message:s,confirmText:"\u041E\u0442\u043A\u0440\u044B\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"\u041F\u0430\u0440\u043E\u043B\u044C",inputType:"password"})}catch{r=window.prompt("\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430. \u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C:")||""}if(!r)throw new Error("\u041F\u0430\u0440\u043E\u043B\u044C \u043D\u0435 \u0432\u0432\u0435\u0434\u0451\u043D");try{let{key:o}=await Xc(r,e.encryptionSalt||"");if(!await Gc(o,e.encryptionVerifier||"")){if(n>=3)throw new Error("\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C");window.alert("\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C, \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437.");continue}return await zi(e,o),zu(o),e}catch(o){if(n>=3)throw new Error(o.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");window.alert("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443, \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437.")}}}var ts=We(()=>{wt();Yt();Vt();Jn();An();Yr();Kn();Kr()});function qu(e,t){if(!t.length)return;let n=document.createElement("div");n.className="diff-images",t.forEach(r=>{let o=document.createElement("div");o.className=`diff-image-card diff-image-card--${r.type}`;let i=document.createElement("div");i.className="diff-image-card__label",i.textContent=r.type==="added"?"\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E":"\u0423\u0434\u0430\u043B\u0435\u043D\u043E";let s=document.createElement("img");s.src=r.src,s.alt=r.alt||"",o.append(i,s),n.appendChild(o)}),e.appendChild(n)}function Vu(e,t,n,r=[]){let o=document.createElement("div");o.className="diff-inline";let i=document.createElement("div");i.className="diff-inline__content",n.forEach(c=>{let a=document.createElement("span");c.type==="added"?a.className="diff-inline__segment diff-inline__segment--added":c.type==="removed"&&(a.className="diff-inline__segment diff-inline__segment--removed"),a.textContent=c.value,i.appendChild(a)}),qu(i,r);let s=document.createElement("div");s.className="diff-inline__hint",s.textContent=t==="undo"?"\u041F\u043E\u0432\u0442\u043E\u0440\u043D\u043E \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Ctrl+Z, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C \u043E\u0442\u043C\u0435\u043D\u0443":"\u041F\u043E\u0432\u0442\u043E\u0440\u043D\u043E \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Ctrl+Y, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C \u043F\u043E\u0432\u0442\u043E\u0440",o.append(i,s),e.innerHTML="",e.appendChild(o)}function Sa(){let e=u.pendingTextPreview;if(!e)return;let t=document.querySelector(`.block[data-block-id="${e.blockId}"] .block-text`);t&&Vu(t,e.mode,e.chunks,e.imageDiff||[])}function xa(e){Jo({restoreDom:!1});let t=n=>({type:"text",blockId:n.blockId,historyEntryId:n.id});u.undoStack=(e.history||[]).map(t),u.redoStack=(e.redoHistory||[]).map(t)}function Tr(e){e&&(jt("pushUndoEntry",e),u.undoStack.push(e),u.redoStack=[])}function eo(e){try{return JSON.parse(JSON.stringify(e||{}))}catch{return null}}function Ju(e){if(!e||!u.article||!Array.isArray(u.article.blocks))return;let t=!1,n=r=>{if(Array.isArray(r))for(let o=0;o<r.length;o+=1){let i=r[o];if(i){if(i===e)if(!t)t=!0;else{r.splice(o,1),o-=1;continue}Array.isArray(i.children)&&i.children.length&&n(i.children)}}};n(u.article.blocks)}async function ju(e){e&&(await ns(e),Wn(e))}function Jo({restoreDom:e=!0}={}){let t=u.pendingTextPreview;if(t){if(e){let n=document.querySelector(`.block[data-block-id="${t.blockId}"] .block-text`);n&&(n.innerHTML=t.originalHTML)}u.pendingTextPreview=null}}async function Aa(e,t=null,n=null,r={}){if(!e)return{success:!1};let{skipRecord:o=!1,anchorId:i=null,placement:s=null,suppressRerender:c=!1}=r,a=ut(e);if(!a)return ve("\u0411\u043B\u043E\u043A \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D"),{success:!1};let l=a.parent?.id||null,d=a.index??0,p=t?ut(t)?.block:null,h=p?p.children?.length||0:(u.article?.blocks||[]).length,y=typeof n=="number"&&n>=0?Math.min(n,h):h;if(l===t&&d===y)return{success:!0,noOp:!0,from:{parentId:l,index:d},to:{parentId:t,index:y}};let S=y;t===l&&d<S&&(S=Math.max(S-1,0));try{let f=await gt(`/api/articles/${u.articleId}/blocks/${e}/relocate`,{method:"POST",body:JSON.stringify({parentId:t||null,index:S,anchorId:i||null,placement:s||null})});if(u.article&&Array.isArray(u.article.blocks)){let b=a.siblings||u.article.blocks,x=a.index??b.findIndex(q=>q.id===e),v=null;x>=0&&([v]=b.splice(x,1)),v||(v=a.block);let L;if(t){let q=ut(t);q&&q.block?(Array.isArray(q.block.children)||(q.block.children=[]),L=q.block.children):L=u.article.blocks}else L=u.article.blocks;let R=typeof S=="number"&&S>=0?Math.min(S,L.length):L.length;if(L.splice(R,0,v),Ju(v),u.article.updatedAt)try{u.article.updatedAt=new Date().toISOString()}catch{}}u.currentBlockId=e;let m=f?.parentId??t??null;return c||(l&&m?(await Qt(l),m!==l&&await Qt(m)):l&&!m?Ht():!l&&m?Ht():Ht()),o||Tr({type:"structure",action:{kind:"reorder",blockId:e,fromParentId:l,fromIndex:d,toParentId:f?.parentId??t??null,toIndex:f?.index??S}}),await ju(e),{success:!0,from:{parentId:l,index:d},to:{parentId:f?.parentId??t??null,index:f?.index??S}}}catch(f){return ve(f.message),{success:!1}}}var ar=We(()=>{wt();Yt();Vt();cr();cr();vn();An();Yr()});function Xu(){try{return window?.localStorage?.getItem?.(Wu)==="1"}catch{return!1}}function ka(){try{return window?.localStorage?.getItem?.(Yu)==="1"}catch{return!1}}function Br(...e){try{if(!Xu())return;console.log("[article-load]",...e)}catch{}}function Qu(e){try{let t=e?.content;if(!Array.isArray(t))return null;for(let n of t)if(n?.type==="outlineSection"){let r=String(n?.attrs?.id||"");if(r)return r}return null}catch{return null}}async function Pn(e,t={}){let{desiredBlockId:n,resetUndoStacks:r,editBlockId:o}=t,i=u.articleId!==e;if(Br("load.start",{id:e,switchingArticle:i,mode:u.mode,isOutlineEditing:u.isOutlineEditing}),i)try{let h=u.articleId,y=await Promise.resolve().then(()=>(Ko(),jo));try{let S=y?.getOutlineActiveSectionSnapshot?.()||null;if(h&&S?.sectionId){let f=window?.localStorage?.getItem?.(Ia)||"{}",m=JSON.parse(f||"{}"),b=m&&typeof m=="object"?m:{};b[String(h)]={sectionId:S.sectionId,collapsed:!!S.collapsed,savedAt:new Date().toISOString()},window?.localStorage?.setItem?.(Ia,JSON.stringify(b))}}catch{}y?.flushOutlineAutosave&&await y.flushOutlineAutosave({mode:"queue"}),y?.closeOutlineEditor&&y.closeOutlineEditor()}catch{}u.articleId=e,u.isEditingTitle=!1,u.pendingTextPreview=null,u.article=null,u.currentBlockId=null;let s=performance.now(),c=await _c(e);ka()&&console.log("[perf][article-load] fetchArticle",{id:e,ms:Math.round(performance.now()-s)}),Br("load.fetched",{id:e,ms:Math.round(performance.now()-s),hasDocJson:!!c?.docJson,docContent:Array.isArray(c?.docJson?.content)?c.docJson.content.length:null,blocksCount:Array.isArray(c?.blocks)?c.blocks.length:null,updatedAt:c?.updatedAt});let a=c;try{a=await wa(c)}catch(h){throw ve(h.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u0443\u044E \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443"),h}u.article=a,(typeof r=="boolean"?r:i)&&xa(a);let d=n||o||u.pendingEditBlockId||null;u.pendingEditBlockId=null;let p=Qu(a.docJson)||a.blocks?.[0]?.id||null;if(u.currentBlockId=d||p,u.mode="view",u.editingBlockId=null,Cr(a),Uc(),!u.isPublicView&&!u.isRagView&&!a.encrypted)try{let h=await Promise.resolve().then(()=>(Ko(),jo));if(h?.openOutlineEditor){Br("outline.open.start",{id:e});let y=ka()?performance.now():0;h.openOutlineEditor(),y&&console.log("[perf][article-load] outline.open scheduled",{id:e,ms:Math.round(performance.now()-y)}),Br("outline.open.scheduled",{id:e,isOutlineEditing:u.isOutlineEditing})}}catch(h){u.isOutlineEditing=!1,Br("outline.open.failed",{id:e,message:h?.message||String(h||"error")}),ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C outline-\u0440\u0435\u0436\u0438\u043C (\u0441\u043C. \u043A\u043E\u043D\u0441\u043E\u043B\u044C)")}return Br("load.done",{id:e,currentBlockId:u.currentBlockId}),a}var Wu,Yu,Ia,rs=We(()=>{wt();Yt();ar();Vt();Kn();ts();Kr();Wu="ttree_debug_article_load_v1",Yu="ttree_profile_v1",Ia="ttree_outline_last_active_v1"});var va=We(()=>{An();vn()});function Gu(e){if(!e)return;e.focus({preventScroll:!0});let t=window.getSelection&&window.getSelection();if(!t)return;t.removeAllRanges();let n=document.createRange();n.selectNodeContents(e),n.collapse(!1),t.addRange(n)}async function os(e){return!u.article||!u.article.encrypted||!u.articleEncryptionKey?e:Ui(u.articleEncryptionKey,e)}async function Ca(){if(!u.currentBlockId||u.isRagView)return;let e=u.currentBlockId;u.editingScrollTop=V.blocksContainer?V.blocksContainer.scrollTop:null,u.mode="edit",u.scrollTargetBlockId=null,u.editingBlockId=u.currentBlockId,u.editingInitialText=ut(u.currentBlockId)?.block.text||"",u.editingUndo=null,await Qt(e);let t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`);if(t||(Ht(),await Qt(e),t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`)),!t){u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.editingUndo=null,u.currentBlockId=e,ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430");return}Gu(t)}async function Ta(){if(u.mode!=="edit"||!u.editingBlockId)return;let e=u.editingBlockId,t=ut(e),n=t?.block.text||"",o=document.querySelector(`.block[data-block-id="${u.editingBlockId}"] .block-text`)?.innerHTML||"",{cleanupEditableHtml:i}=await Promise.resolve().then(()=>(vn(),as)),s=i(o);if(!(s||"").trim()){let a=Yo(e),l=ut(e),d=!!(l?.block&&l.block.__isNew);if(l&&u.article&&Array.isArray(u.article.blocks)){let p=l.siblings||u.article.blocks,h=l.index??p.findIndex(y=>y&&y.id===e);if(h>=0&&p.splice(h,1),u.article.updatedAt)try{u.article.updatedAt=new Date().toISOString()}catch{}if(!d){let y=eo(l.block);ss(y,l.parent?.id||null,l.index??null)}}u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.currentBlockId=a,u.scrollTargetBlockId=a,Wo(e),Ht(),(async()=>{try{let p=d?`/api/articles/${u.articleId}/blocks/${e}/permanent`:`/api/articles/${u.articleId}/blocks/${e}`,h=await gt(p,{method:"DELETE"});if(!d&&h?.block){let y=eo(h.block);Tr({type:"structure",action:{kind:"delete",parentId:h.parentId||null,index:h.index??null,block:y,blockId:y?.id,fallbackId:a}})}ve("\u041F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A \u0443\u0434\u0430\u043B\u0451\u043D")}catch(p){ve(p.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Pn(u.articleId,{desiredBlockId:a||null}),Ht()}catch{}}})();return}if(s===n){u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.editingUndo=null,u.pendingEditBlockId=null,u.currentBlockId=e,u.scrollTargetBlockId=e,await Qt(e);return}if(t&&u.article&&Array.isArray(u.article.blocks)&&(t.block.text=s,u.article.updatedAt))try{u.article.updatedAt=new Date().toISOString()}catch{}u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.editingUndo=null,u.pendingEditBlockId=null,u.currentBlockId=e,u.scrollTargetBlockId=e,await Qt(e),(async()=>{try{let a=await os(s),l=await gt(`/api/articles/${u.articleId}/blocks/${e}`,{method:"PATCH",body:JSON.stringify({text:a})});n!==s&&(!!(t?.block&&t.block.__isNew)?delete t.block.__isNew:Tr({type:"text",blockId:e,historyEntryId:l?.historyEntryId||null})),ve("\u0411\u043B\u043E\u043A \u043E\u0431\u043D\u043E\u0432\u043B\u0451\u043D")}catch(a){ve(a.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Pn(u.articleId,{desiredBlockId:e}),Ht()}catch{}}})()}async function Ba(){if(u.mode!=="edit"||!u.editingBlockId)return;let e=u.editingBlockId,r=!(document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`)?.textContent||"").replace(/\u00a0/g," ").trim();if(u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.editingUndo=null,r){let o=Yo(e),i=ut(e),s=!!(i?.block&&i.block.__isNew);if(i&&u.article&&Array.isArray(u.article.blocks)){let a=i.siblings||u.article.blocks,l=i.index??a.findIndex(d=>d&&d.id===e);if(l>=0&&a.splice(l,1),u.article.updatedAt)try{u.article.updatedAt=new Date().toISOString()}catch{}}u.currentBlockId=o,u.scrollTargetBlockId=o,Wo(e);let c=i?.parent?.id||null;c?await Qt(c):Ht(),(async()=>{try{let a=s?`/api/articles/${u.articleId}/blocks/${e}/permanent`:`/api/articles/${u.articleId}/blocks/${e}`,l=await gt(a,{method:"DELETE"});if(!s&&l?.block){let d=eo(l.block);Tr({type:"structure",action:{kind:"delete",parentId:l.parentId||null,index:l.index??null,block:d,blockId:d?.id,fallbackId:o}})}}catch(a){ve(a.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Pn(u.articleId,{desiredBlockId:o||null}),Ht()}catch{}}})();return}u.currentBlockId=e,await Qt(e)}async function Na(){if(u.mode!=="edit"||!u.editingBlockId)return;let e=u.editingBlockId,t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`);if(!t)return;let n=window.getSelection();if(!n||n.rangeCount===0||!t.contains(n.anchorNode))return;let r=n.getRangeAt(0).cloneRange(),o=document.createElement("span"),i=`split-marker-${Date.now()}-${Math.random().toString(16).slice(2)}`;o.setAttribute("data-split-marker",i),o.textContent="",r.insertNode(o);let s=t.innerHTML;o.parentNode.removeChild(o);let c=`<span data-split-marker="${i}"></span>`,a=s.split(c);if(a.length!==2)return;let[l,d]=a,{cleanupEditableHtml:p}=await Promise.resolve().then(()=>(vn(),as)),h=p(l||""),y=p(d||"");if(!(!y||y===h))try{let S=ut(e),f=S?.block,m=f?eo(f):null,b=await os(h);await gt(`/api/articles/${u.articleId}/blocks/${e}`,{method:"PATCH",body:JSON.stringify({text:b})});let v=(await gt(`/api/articles/${u.articleId}/blocks/${e}/siblings`,{method:"POST",body:JSON.stringify({direction:"after"})}))?.block?.id;if(!v){ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043D\u043E\u0432\u044B\u0439 \u0431\u043B\u043E\u043A");return}let L=await os(y);if(await gt(`/api/articles/${u.articleId}/blocks/${v}`,{method:"PATCH",body:JSON.stringify({text:L})}),S&&u.article&&Array.isArray(u.article.blocks)){S.block.text=h;let q=S.parent,j=S.siblings||u.article.blocks||[],$=(S.index??0)+1,X={id:v,text:y,children:[],collapsed:!1};if(j.splice($,0,X),u.article.updatedAt)try{u.article.updatedAt=new Date().toISOString()}catch{}}u.mode="edit",u.editingBlockId=v,u.pendingEditBlockId=null,u.currentBlockId=v,u.scrollTargetBlockId=v,u.editingCaretPosition="start";let R=S?.parent?.id||null;R?await Qt(R):Ht(),m&&Tr({type:"text",blockId:e,block:m})}catch(S){ve(S.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0437\u0431\u0438\u0442\u044C \u0431\u043B\u043E\u043A")}}var is=We(()=>{wt();Yt();un();Vt();cr();cr();ar();vn();va();An();Yr()});function Da(){if(!It||!no()||It.pointerType==="mouse")return;let e=window.getSelection?window.getSelection():null;if(!(!e||e.isCollapsed))try{e.removeAllRanges()}catch{}}function rf(){Xo||(document.addEventListener("selectionchange",Da),Xo=!0)}function of(){Xo&&(document.removeEventListener("selectionchange",Da),Xo=!1)}function no(){return!!(u.isDragModeEnabled&&u.mode==="view"&&u.articleId!=="inbox")}function Oa(e){return e instanceof Element?!!e.closest(nf):!1}function Ra(){if(It){window.removeEventListener("pointermove",Ua),window.removeEventListener("pointerup",Qo),window.removeEventListener("pointercancel",Qo);try{It.sourceEl?.releasePointerCapture?.(It.pointerId)}catch{}It=null,of(),af()}}function sf(e,t,n,{bypassInteractiveCheck:r=!1}={}){if(!u.article||!u.isDragModeEnabled||!no()||e.pointerType==="mouse"&&e.button!==0||!r&&Oa(e.target))return;let o=ut(t);if(o){It={pointerType:e.pointerType||"mouse",blockId:t,pointerId:e.pointerId,originParentId:o.parent?.id||null,originIndex:o.index??0,startX:e.clientX,startY:e.clientY,dragging:!1,forbidden:$a(o.block),lastDrop:null,sourceEl:n};try{n?.setPointerCapture?.(e.pointerId)}catch{}window.addEventListener("pointermove",Ua),window.addEventListener("pointerup",Qo),window.addEventListener("pointercancel",Qo),rf()}}function Ha(e,t,{allowInteractive:n=!1}={}){e&&e.addEventListener("pointerdown",r=>{if(!n&&Oa(r.target))return;(r.pointerType==="touch"||r.pointerType==="pen")&&no()&&r.preventDefault(),sf(r,t,e,{bypassInteractiveCheck:n})})}function Nr(){let e=!!u.article,t=V.dragModeToggleBtn;if(t){t.disabled=!e,t.classList.toggle("active",!!u.isDragModeEnabled),t.setAttribute("aria-pressed",u.isDragModeEnabled?"true":"false");let o=u.isDragModeEnabled?"\u041F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435 \u0431\u043B\u043E\u043A \u0437\u0430 \u0435\u0433\u043E \u043F\u043E\u0432\u0435\u0440\u0445\u043D\u043E\u0441\u0442\u044C":"\u0412\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0440\u0435\u0436\u0438\u043C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u044F \u0431\u043B\u043E\u043A\u043E\u0432";e?u.articleId==="inbox"?o="\u041F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0432 \u0431\u044B\u0441\u0442\u0440\u044B\u0445 \u0437\u0430\u043C\u0435\u0442\u043A\u0430\u0445":u.mode!=="view"&&(o="\u041F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043C\u043E\u0436\u043D\u043E \u0442\u043E\u043B\u044C\u043A\u043E \u0432 \u0440\u0435\u0436\u0438\u043C\u0435 \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440\u0430"):o="\u041E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E, \u0447\u0442\u043E\u0431\u044B \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0442\u044C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435\u043C",t.title=o}let n=no();[V.articleView,V.blocksContainer].forEach(o=>{o&&o.classList.toggle("drag-mode-enabled",n)}),document.body.classList.toggle("drag-mode-enabled",n)}function $a(e,t=new Set){return e&&(t.add(e.id),(e.children||[]).forEach(n=>$a(n,t))),t}function cf(){if(to)return to;let e=document.createElement("div");return e.className="block-drop-line hidden",document.body.appendChild(e),to=e,e}function af(){to&&to.classList.add("hidden"),Gt&&(Gt.classList.remove("drop-inside-target"),Gt=null),lr&&(lr.remove(),lr=null),document.body.classList.remove("block-dnd-active")}function lf(e){lr&&(lr.style.left=`${e.clientX+12}px`,lr.style.top=`${e.clientY+12}px`)}function df(e){let t=document.createElement("div");t.className="block-drag-preview";let n=V.blocksContainer?.querySelector(`.block[data-block-id="${e}"]`),r=n?.querySelector(".block-title")?.textContent?.trim(),o=n?.querySelector(".block-text")?.textContent?.trim();t.textContent=r||o||"\u0411\u043B\u043E\u043A",document.body.appendChild(t),lr=t}function Fa(){return bn&&bn.isConnected?(V.blocksContainer&&bn.parentNode!==V.blocksContainer&&V.blocksContainer.appendChild(bn),bn):(bn=document.createElement("div"),bn.className="drag-layer",V.blocksContainer&&(V.blocksContainer.appendChild(bn),Ma||(V.blocksContainer.addEventListener("scroll",La,{passive:!0}),window.addEventListener("resize",La,{passive:!0}),Ma=!0)),bn)}function za(){_a.clear(),bn&&(bn.innerHTML="")}function La(){let e=V.blocksContainer;if(!e||!bn)return;let t=e.getBoundingClientRect(),n=e.scrollTop;_a.forEach(({handle:r,blockEl:o})=>{let i=o.getBoundingClientRect(),s=o.querySelector(".block-header__left"),c=o.querySelector(".block-header"),a=o.querySelector(".collapse-btn"),l=s?.getBoundingClientRect(),d=c?.getBoundingClientRect(),p=a?.getBoundingClientRect(),h=(l&&l.height>0?l:null)||(d&&d.height>0?d:null)||(p&&p.height>0?p:null)||i,y=h.top-t.top+n+h.height/2;r.style.top=`${y}px`,r.style.right="8px"})}function uf(e){let t=cf();if(!e){t.classList.add("hidden"),Gt&&(Gt.classList.remove("drop-inside-target"),Gt=null);return}if(e.placement==="inside"){t.classList.add("hidden"),Gt&&Gt.dataset.blockId!==e.targetId&&Gt.classList.remove("drop-inside-target"),Gt=V.blocksContainer?.querySelector(`.block[data-block-id="${e.targetId}"]`)||null,Gt&&Gt.classList.add("drop-inside-target");return}Gt&&(Gt.classList.remove("drop-inside-target"),Gt=null),t.classList.remove("hidden");let n=e.placement==="before"?e.rect.top:e.rect.top+e.rect.height,r=Math.min(e.depth*Pa,e.rect.width-32),o=e.rect.left+r,i=Math.max(e.rect.width-r,48);t.style.top=`${n}px`,t.style.left=`${o}px`,t.style.width=`${i}px`}function ff(e,t){if(!V.blocksContainer||!It)return null;let r=Array.from(V.blocksContainer.querySelectorAll(".block")).filter(v=>{let L=v.dataset.blockId;return L&&!It.forbidden.has(L)});if(!r.length)return null;let o=null,i=1/0;if(r.forEach(v=>{let L=v.getBoundingClientRect(),R=L.top+L.height/2,q=Math.abs(t-R);q<i&&(i=q,o=v)}),!o)return null;let s=o.getBoundingClientRect(),c=s.height>0?(t-s.top)/s.height:.5,a=c<ef?"before":c>tf?"after":"inside",l=o.dataset.blockId,d=ut(l);if(!d)return null;let p=(d.ancestors||[]).length,h=a==="inside"?l:d.parent?.id||null;if(It.forbidden.has(h||""))return null;let y=l,S=h,f=a,m=s,b=a==="inside"?p+1:p,x=f==="after"?d.index+1:d.index;if(f!=="inside"&&d.parent){let v=d,L=s,R=s.left+Pa;for(;v.parent;){let q=e<=R,j=t<=L.top||t>=L.bottom;if(!q&&!j)break;let $=ut(v.parent.id);if(!$)break;let W=V.blocksContainer?.querySelector(`.block[data-block-id="${$.block.id}"]`)?.getBoundingClientRect();v=$,L=W||L,y=v.block.id,m=L,b=(v.ancestors||[]).length,S=v.parent?.id||null,x=f==="after"?v.index+1:v.index}}return{targetId:y,placement:f,parentId:S,index:x,depth:b,rect:m}}function pf(e){if(!V.blocksContainer)return;let t=V.blocksContainer.getBoundingClientRect(),n=60;e.clientY<t.top+n?V.blocksContainer.scrollTop-=12:e.clientY>t.bottom-n&&(V.blocksContainer.scrollTop+=12)}function Ua(e){if(!It||e.pointerId!==It.pointerId)return;if(!no()){Ra();return}let t=e.clientX-It.startX,n=e.clientY-It.startY;if(!It.dragging){if(Math.hypot(t,n)<Zu)return;It.dragging=!0;let o=It.pointerType||e.pointerType||"mouse";(o==="touch"||o==="pen")&&document.body.classList.add("block-dnd-active"),df(It.blockId)}e.preventDefault(),lf(e);let r=ff(e.clientX,e.clientY);It.lastDrop=r,uf(r),pf(e)}async function Qo(e){if(!It||e.pointerId!==It.pointerId)return;let t=It;Ra();let n=t.dragging&&t.lastDrop,r=t.lastDrop,o=t.blockId;!n||!r||await Aa(o,r.parentId||null,r.index,{anchorId:r.targetId,placement:r.placement})}var Zu,Pa,ef,tf,nf,It,to,Gt,lr,bn,_a,Ma,Xo,ro=We(()=>{wt();un();vn();ar();Vt();Zu=6,Pa=20,ef=.35,tf=.65,nf='button, a, input, textarea, select, [contenteditable="true"], .block-edit-actions, .move-block-btn, .collapse-btn',It=null,to=null,Gt=null,lr=null,bn=null,_a=new Map,Ma=!1,Xo=!1});function qa(e){ls=typeof e=="function"?e:null}function mf(e){let t=new Set,n=r=>{if(Array.isArray(r))for(let o=0;o<r.length;o+=1){let i=r[o];if(!i||!i.id){r.splice(o,1),o-=1;continue}if(t.has(i.id)){r.splice(o,1),o-=1;continue}t.add(i.id),Array.isArray(i.children)&&i.children.length&&n(i.children)}};n(e)}function Va(){if(!V.blocksContainer)return;let e=new Set;V.blocksContainer.querySelectorAll(".block[data-block-id]").forEach(n=>{let r=n.getAttribute("data-block-id");if(r)if(e.has(r)){let o=n.parentNode;o&&o.removeChild(n)}else e.add(r)})}function Ja(){if(!V.blocksContainer||!u.article||!Array.isArray(u.article.blocks))return;let e=_n(u.article.blocks),t=new Set(e.map(r=>r.id));V.blocksContainer.querySelectorAll(".block[data-block-id]").forEach(r=>{let o=r.getAttribute("data-block-id");if(o&&!t.has(o)){let i=r.parentNode;i&&i.removeChild(r)}})}function ss(e,t,n,r){if(!u.article||!e||!e.id)return;let o=Array.isArray(u.article.blockTrash)?u.article.blockTrash:[],i=r||new Date().toISOString();o.push({id:e.id,block:e,parentId:t||null,index:typeof n=="number"?n:null,deletedAt:i}),u.article.blockTrash=o}function Wo(e){if(!e||!V.blocksContainer)return;V.blocksContainer.querySelectorAll(`.block[data-block-id="${e}"]`).forEach(n=>{let r=n.parentElement;if(!r)return;let o=n.nextElementSibling;if(o&&o.classList.contains("block-children")){let i=o;o=o.nextElementSibling,i.parentNode===r&&r.removeChild(i)}n.parentNode===r&&r.removeChild(n)})}async function ds(e,t,n=1){for(let r of e){let o=document.createElement("div");o.className="block",o.dataset.blockId=r.id,typeof r.collapsed=="boolean"&&(o.dataset.collapsed=r.collapsed?"true":"false"),(r.id===u.currentBlockId||Array.isArray(u.selectedBlockIds)&&u.selectedBlockIds.includes(r.id))&&o.classList.add("selected"),r.id===u.editingBlockId&&o.classList.add("editing");let s=document.createElement("div");s.className="block-surface";let c=document.createElement("div");c.className="block-content";let a=Dn(r.text||""),l=!!a.titleHtml,d=!!(a.bodyHtml&&a.bodyHtml.trim()),p=!!r.children?.length;if(!l&&p){let R=document.createElement("div");R.innerHTML=a.bodyHtml||r.text||"";let q=Array.from(R.childNodes||[]).filter(j=>j.nodeType===Node.TEXT_NODE?(j.textContent||"").trim().length>0:j.nodeType===Node.ELEMENT_NODE?j.tagName==="BR"?!1:j.tagName==="P"?(j.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim().length>0:!0:!1);if(q.length===1){let j=q[0];j.nodeType===Node.ELEMENT_NODE&&j.tagName==="P"&&(a={titleHtml:j.outerHTML,bodyHtml:""},l=!0,d=!1)}}let h=l||p,y=!l&&!p;o.classList.toggle("block--no-title",!l);let S=u.mode==="edit"&&u.editingBlockId===r.id,f=null;if(h||y){let R=document.createElement("button");R.className="collapse-btn",y?(R.classList.add("collapse-btn--placeholder"),R.setAttribute("aria-hidden","true"),R.removeAttribute("aria-expanded"),R.removeAttribute("title")):(R.setAttribute("aria-expanded",r.collapsed?"false":"true"),R.title=r.collapsed?"\u0420\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C":"\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C"),f=document.createElement("div"),f.className="block-header",l||f.classList.add("block-header--no-title");let q=document.createElement("div");if(q.className="block-header__left",q.appendChild(R),l){let j=Math.min(Math.max(n,1),6),$=document.createElement(`h${j}`);$.className="block-title",$.innerHTML=a.titleHtml||"",q.appendChild($)}else{let j=document.createElement("div");j.className="block-title-spacer",j.style.flex="1",j.style.minWidth="0",q.appendChild(j)}f.appendChild(q)}let m=document.createElement("div");m.className="block-text block-body";let b=S?fs(r.text||""):a.bodyHtml||"";if(m.innerHTML=b,(!b||!b.trim())&&(m.classList.add("block-body--empty"),S&&(m.innerHTML="<p><br /></p>")),m.classList.toggle("block-body--no-title",!l),S?(m.setAttribute("contenteditable","true"),m.setAttribute("spellcheck","false"),m.dataset.placeholder="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0442\u0435\u043A\u0441\u0442"):m.removeAttribute("contenteditable"),f&&c.appendChild(f),(S||!l||b)&&c.appendChild(m),u.articleId==="inbox"&&!S){let R=document.createElement("div");R.className="block-footer";let q=document.createElement("button");q.type="button",q.className="ghost small move-block-btn",q.innerHTML="&#10140;",q.title="\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0431\u043B\u043E\u043A \u0432 \u0434\u0440\u0443\u0433\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E",q.addEventListener("click",j=>{j.stopPropagation(),ls?ls(r.id):ve("\u041F\u0435\u0440\u0435\u043D\u043E\u0441 \u0431\u043B\u043E\u043A\u0430 \u0432\u0440\u0435\u043C\u0435\u043D\u043D\u043E \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D")}),R.appendChild(q),c.appendChild(R)}if(s.appendChild(c),S&&("ontouchstart"in window||navigator.maxTouchPoints>0)&&c.addEventListener("click",q=>{let j=c.querySelector('.block-text[contenteditable="true"]');j&&(j.contains(q.target)||(q.stopPropagation(),j.focus(),u.editingCaretPosition==="start"?(j.scrollTop=0,Di(j)):Mo(j)))}),Ha(s,r.id),S){let R=document.createElement("div");R.className="block-edit-actions";let q=document.createElement("button");q.type="button",q.className="ghost small block-attach-btn",q.innerHTML='<span class="block-attach-btn__icon">&#xE723;</span><span class="block-attach-btn__label">\u0424\u0430\u0439\u043B</span>',q.title="\u041F\u0440\u0438\u043A\u0440\u0435\u043F\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u0438\u043B\u0438 \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0443",q.addEventListener("click",X=>{X.preventDefault(),X.stopPropagation();let W=o.querySelector('.block-text[contenteditable="true"]');if(!W)return;let te=document.createElement("input");te.type="file",te.multiple=!0,te.style.display="none",te.addEventListener("change",()=>{let be=Array.from(te.files||[]);be.length&&ms(W,be,r.id),te.remove()}),document.body.appendChild(te),te.click()});let j=document.createElement("button");j.type="button",j.className="ghost small",j.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C",j.addEventListener("click",async X=>{X.preventDefault(),X.stopPropagation(),await Ta()});let $=document.createElement("button");$.type="button",$.className="ghost small",$.textContent="\u041E\u0442\u043C\u0435\u043D\u0430",$.addEventListener("click",X=>{X.preventDefault(),X.stopPropagation(),Ba()}),R.appendChild(q),R.appendChild(j),R.appendChild($),c.appendChild(R)}hs(m,r.id),o.appendChild(s),o.addEventListener("click",R=>{if(R.stopPropagation(),u.isRagView&&u.ragBlockMap&&u.ragBlockMap[r.id]){let Qe=u.ragBlockMap[r.id];if(Qe&&Qe.articleId&&Qe.blockId){u.scrollTargetBlockId=Qe.blockId,u.currentBlockId=Qe.blockId,pn(Xt.article(Qe.articleId));return}}let q=R.target.closest('button, a, [contenteditable="true"], .block-edit-actions'),j=o.querySelector(".block-header"),$=o.querySelector(".block-text.block-body"),X=!!j,W=!!(j&&!j.classList.contains("block-header--no-title")),te=X&&j.contains(R.target),be=$&&$.contains(R.target),Oe=W,re=u.currentBlockId===r.id,he=!1;(Oe&&te||!Oe&&re&&be&&!q)&&(he=!0),he&&ps(r.id),Wn(r.id)}),s.addEventListener("dblclick",R=>{if(u.mode!=="view"||u.isPublicView||u.isRagView)return;let q=R.target.closest('button, a, [contenteditable="true"]');q&&!q.matches('.block-text[contenteditable="true"]')||(R.stopPropagation(),Wn(r.id),Ca())});let v=r.collapsed&&r.id!==u.editingBlockId&&l;m.classList.contains("block-body--empty")||m.classList.toggle("collapsed",v);let L=null;r.children?.length>0&&!r.collapsed&&(L=document.createElement("div"),L.className="block-children",await ds(r.children,L,n+1)),t.appendChild(o),L&&(S?t.appendChild(L):o.appendChild(L))}}async function Qt(e){if(!u.article||!Array.isArray(u.article.blocks))return;let t=ut(e);if(!t)return;let n=(Array.isArray(t.ancestors)?t.ancestors.length:0)+1,r=document.querySelector(`.block[data-block-id="${e}"]`);if(!r)return;let o=r.parentElement;if(!o)return;let i=[],s=r.nextElementSibling;s&&s.classList.contains("block-children")&&i.push(s);let c=(i[i.length-1]||r).nextSibling;o.removeChild(r),i.forEach(d=>{d.parentNode===o&&o.removeChild(d)});let a=document.createElement("div");await ds([t.block],a,n),Array.from(a.childNodes).forEach(d=>{o.insertBefore(d,c)}),Va(),Ja()}function Ht(){let e=u.article;if(!e)return;if(!u.isPublicView&&!u.isRagView&&u.isOutlineEditing){Ft(),jr();return}Array.isArray(e.blocks)&&mf(e.blocks),Ft();let t=e.id==="inbox"?[...e.blocks||[]].reverse():e.blocks;jr(),V.blocksContainer.innerHTML="",Nr(),za(),Fa();let n=()=>{if(u.mode!=="edit"||!u.editingBlockId||u.editingCaretPosition==="start")return;let r=V.blocksContainer?.querySelector(`.block[data-block-id="${u.editingBlockId}"] .block-text[contenteditable="true"]`);if(!r)return;let o=document.activeElement;r===o||r.contains(o)||(r.focus({preventScroll:!0}),r.scrollHeight>r.clientHeight&&(r.scrollTop=r.scrollHeight),Mo(r))};ds(t,V.blocksContainer).then(()=>{if(Ja(),Va(),Sa(),u.scrollTargetBlockId&&u.mode==="view"){let r=u.scrollTargetBlockId;requestAnimationFrame(()=>{let o=document.querySelector(`.block[data-block-id="${r}"]`);if(o){(o.querySelector(".block-content")||o).scrollIntoView({behavior:"smooth",block:"nearest"});let s=o.querySelector('.block-text[contenteditable="true"]');s&&u.mode==="edit"&&u.editingBlockId===r?(s.focus({preventScroll:!0}),u.editingCaretPosition==="start"?(s.scrollTop=0,Di(s)):Mo(s)):(o.setAttribute("tabindex","-1"),o.focus({preventScroll:!0}))}u.currentBlockId=r,u.scrollTargetBlockId=null})}n(),u.mode==="edit"&&typeof u.editingScrollTop=="number"&&V.blocksContainer&&(V.blocksContainer.scrollTop=u.editingScrollTop)})}var ls,us=We(()=>{wt();un();Yt();Vt();Jn();is();An();vn();vn();Kn();ar();jn();Kr();ro();ls=null});function hf(){try{let e=window?.localStorage?.getItem?.(ja)||"";if(!e)return[];let t=JSON.parse(e);return Array.isArray(t)?t.filter(Boolean):[]}catch{return[]}}function gf(e){try{window?.localStorage?.setItem?.(ja,JSON.stringify(Array.isArray(e)?e:[]))}catch{}}function Ka(e){let t=String(e||"").trim();if(!t)return!1;let n=hf(),r=n.filter(o=>String(o?.sectionId||o?.id||"")!==t);return r.length===n.length?!1:(gf(r),!0)}async function yf(){let e=await fetch("/api/articles/inbox?include_history=0",{method:"GET",credentials:"include"});if(e.status===401||e.status===403){let t=new Error("auth");throw t.status=e.status,t}if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()}async function Wa(){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return{status:"offline"};let e=await yf(),t=new Date().toISOString();try{e?.docJson&&typeof e.docJson=="object"&&await sn("inbox",e.docJson,t)}catch{}return{status:"refreshed",updatedAt:e?.updatedAt||null,docJson:e?.docJson||null}}var ja,gs=We(()=>{qr();Ur();ja="ttree_pending_quick_notes_v1"});async function bf(e){try{let n=(u.articlesIndex.length?u.articlesIndex:await fn()).filter(d=>d.id!=="inbox"),r=n.map(d=>({id:d.id,title:d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),o=await Vn({title:"\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0432 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0438\u043B\u0438 \u0432\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E",confirmText:"\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:r,returnMeta:!0,hideConfirm:!1}),s=(o?.selectedId||(typeof o=="object"?o?.value:o)||""||"").trim();if(!s)return;let c=s.toLowerCase(),a=n.find(d=>d.id&&d.id.toLowerCase()===c||(d.title||"").toLowerCase()===c),l=a?a.id:s;if(!l||l==="inbox"){ve("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}await apiRequest(`/api/articles/${u.articleId}/blocks/${e}/move-to/${l}`,{method:"POST"}),await Pn("inbox",{resetUndoStacks:!0}),Ht(),ve("\u0411\u043B\u043E\u043A \u043F\u0435\u0440\u0435\u043D\u0435\u0441\u0451\u043D")}catch(t){ve(t.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0431\u043B\u043E\u043A")}}async function Po(e){try{String(e||"").startsWith("inbox-")&&(e="inbox")}catch{}u.isPublicView=!1,u.isRagView=!1,document.body.classList.remove("public-embedded"),u.isEditingTitle=!1,await Zr(),Qr(!0),V.usersView&&V.usersView.classList.add("hidden"),V.blocksContainer.innerHTML="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...";try{if(e==="RAG"){u.isRagView=!0,u.mode="view",u.editingBlockId=null,u.pendingEditBlockId=null,u.scrollTargetBlockId=null,u.ragBlockMap={},Vo("RAG");let r=(u.ragQuery||"").trim(),o=Array.isArray(u.ragResults)?u.ragResults:[],i=o.length,s=Array.from(new Set(o.map(p=>p&&p.articleTitle?String(p.articleTitle):"").filter(Boolean))),c=s.slice(0,8),a=["<p><strong>\u0421\u0432\u043E\u0434\u043A\u0430</strong></p>"];u.ragSummaryLoading?a.push('<p class="meta">\u0413\u0435\u043D\u0435\u0440\u0438\u0440\u0443\u044E \u0441\u0432\u043E\u0434\u043A\u0443\u2026</p>'):u.ragSummaryError?a.push(`<p class="meta">\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0432\u043E\u0434\u043A\u0438: ${u.ragSummaryError}</p>`):u.ragSummaryHtml?a.push(u.ragSummaryHtml):a.push('<p class="meta">\u0421\u0432\u043E\u0434\u043A\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435 \u0433\u043E\u0442\u043E\u0432\u0430.</p>');let l=["<p><strong>AI-\u043F\u043E\u0438\u0441\u043A: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B</strong></p>",`<p><span class="meta">\u0417\u0430\u043F\u0440\u043E\u0441:</span> ${r||"\u2014"}</p>`,`<p><span class="meta">\u041D\u0430\u0439\u0434\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432:</span> ${i}</p>`];c.length&&l.push(`<p><span class="meta">\u0421\u0442\u0430\u0442\u044C\u0438:</span> ${c.join(" \xB7 ")}</p>`),s.length>c.length&&l.push(`<p><span class="meta">\u2026\u0438 \u0435\u0449\u0451:</span> ${s.length-c.length}</p>`);let d=[{id:"rag-ai-summary",text:a.join(""),children:[],collapsed:!1},{id:"rag-meta",text:l.join(""),children:[],collapsed:!1},...o.filter(p=>p&&p.type==="block").map((p,h)=>{let y=p.blockText||"",S=p.articleTitle?String(p.articleTitle):"",f=S?`<p><strong>${S}</strong></p>`:`<p><strong>\u0420\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442 ${h+1}</strong></p>`,m=`rag-${p.blockId||h}`;return p.articleId&&p.blockId&&(u.ragBlockMap[m]={articleId:p.articleId,blockId:p.blockId}),{id:m,text:`${f}${y}`,children:[],collapsed:!1}})];u.article={id:"RAG",title:r?`AI: ${r}`:"AI: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B \u043F\u043E\u0438\u0441\u043A\u0430",blocks:d,updated_at:new Date().toISOString()},u.articleId="RAG",u.currentBlockId=d[0]?.id||null,Ht();return}let t=u.pendingEditBlockId||void 0,n=u.scrollTargetBlockId||void 0;if(await Pn(e,{resetUndoStacks:!0,desiredBlockId:n,editBlockId:t}),Ht(),Vo(e),e==="inbox"&&navigator.onLine&&u.serverStatus==="ok")try{await Wa().catch(()=>{}),u.articleId==="inbox"&&!u.editingBlockId&&(await Pn("inbox",{resetUndoStacks:!1}),Ht())}catch{}}catch(t){V.blocksContainer.innerHTML=`<p class="meta">\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u044C\u044E: ${t.message}</p>`}}async function qi(){u.isPublicView=!1,u.isRagView=!1,document.body.classList.remove("public-embedded"),V.usersView&&V.usersView.classList.add("hidden"),u.article=null,u.articleId=null,u.currentBlockId=null,u.isEditingTitle=!1,u.mode="view",u.editingBlockId=null,u.undoStack=[],u.redoStack=[],u.pendingEditBlockId=null,Jo({restoreDom:!1}),Qr(!1),Nr();try{if(u.isTrashView){let e=await Uo();kn(e)}else{let e=await Zr();kn(e)}}catch(e){V.articleList.innerHTML=`<li>\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u043F\u0438\u0441\u043E\u043A: ${e.message}</li>`}}async function Vi(e){u.isPublicView=!0,u.isRagView=!1,document.body.classList.add("public-embedded"),V.usersView&&V.usersView.classList.add("hidden"),Qr(!0),u.isEditingTitle=!1,u.mode="view",u.editingBlockId=null,u.pendingEditBlockId=null,u.selectionAnchorBlockId=null,u.selectedBlockIds=[],u.undoStack=[],u.redoStack=[],Jo({restoreDom:!1}),V.blocksContainer&&(V.blocksContainer.innerHTML="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...");try{let t=await apiRequest(`/api/public/articles/${encodeURIComponent(e)}`,{method:"GET",credentials:"omit"});u.article=t,u.articleId=t?.id||null;let n=_n(t?.blocks||[])[0];u.currentBlockId=n?n.id:null,Ht()}catch(t){V.blocksContainer&&(V.blocksContainer.innerHTML=`<p class="meta">\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E: ${t.message}</p>`)}}var Ya=We(()=>{wt();un();Yt();Vt();Jn();jn();Kn();Kn();Kn();ar();vn();rs();us();ro();gs();qa(bf)});var cr=We(()=>{Kr();ts();rs();us();Ya();ro();ro();Nr()});function _n(e=[],t=[]){return(e||[]).forEach(n=>{t.push(n),n.children&&n.children.length>0&&!n.collapsed&&_n(n.children,t)}),t}function ut(e,t=u.article?.blocks||[],n=null,r=[]){for(let o=0;o<t.length;o+=1){let i=t[o];if(i.id===e)return{block:i,parent:n,index:o,siblings:t,ancestors:r};let s=ut(e,i.children||[],i,[...r,i]);if(s)return s}return null}function oo({scrollIntoView:e=!1,scrollBehavior:t="smooth"}={}){let n=new Set(Array.isArray(u.selectedBlockIds)?u.selectedBlockIds:[]);if(u.currentBlockId&&n.add(u.currentBlockId),document.querySelectorAll(".block[data-block-id]").forEach(o=>{let i=o.getAttribute("data-block-id"),s=i&&n.has(i);o.classList.toggle("selected",!!s),o.classList.remove("block--selected-root-ancestor");let c=o.querySelector(":scope > .block-surface");c&&c.classList.remove("block--selected-root-ancestor")}),u.currentBlockId&&u.article&&Array.isArray(u.article.blocks)){let o=ut(u.currentBlockId),i=o?.ancestors||[],s=i.length>0?i[0]?.id:o?.block?.id;if(s){let c=document.querySelector(`.block[data-block-id="${s}"]`);if(c){let a=c.querySelector(":scope > .block-surface");a&&a.classList.add("block--selected-root-ancestor")}}}if(e&&u.mode==="view"&&u.currentBlockId){let o=document.querySelector(`.block[data-block-id="${u.currentBlockId}"]`);o&&o.scrollIntoView({behavior:t||"smooth",block:"nearest"})}}function Xa(e,t={}){if(!e||u.currentBlockId===e)return;let{preserveSelection:n=!1,scrollIntoView:r,scrollBehavior:o}=t;u.currentBlockId=e,n||(u.selectionAnchorBlockId=null,u.selectedBlockIds=[]);let i=typeof r=="boolean"?r:u.mode==="view";oo({scrollIntoView:i,scrollBehavior:o||"smooth"})}function Wn(e,t={}){Xa(e,{preserveSelection:!1,...t})}function Qa(e){if(!u.article)return;let t=_n(u.article.blocks),n=t.findIndex(o=>o.id===u.currentBlockId);if(n===-1)return;let r=t[n+e];r&&(u.mode==="view"&&(u.scrollTargetBlockId=r.id),Xa(r.id,{preserveSelection:!1}))}function Ga(e){if(!u.article)return;let t=_n(u.article.blocks);if(!t.length)return;let n=u.selectionAnchorBlockId||u.currentBlockId||t[0].id;n||(n=t[0].id),u.selectionAnchorBlockId||(u.selectionAnchorBlockId=n);let r=t.findIndex(d=>d.id===n);if(r===-1)return;let o=u.currentBlockId||n,i=t.findIndex(d=>d.id===o);i===-1&&(i=r);let s=i+e;if(s<0||s>=t.length)return;let[c,a]=s>=r?[r,s]:[s,r],l=t.slice(c,a+1).map(d=>d.id);u.selectedBlockIds=l,u.currentBlockId=t[s].id,u.mode==="view"&&(u.scrollTargetBlockId=u.currentBlockId),oo({scrollIntoView:u.mode==="view"})}var Za=We(()=>{wt();un()});function Yn(e){return e?e.nodeType===Node.TEXT_NODE?/\n\s*\n/.test(e.textContent||""):e.nodeType===Node.ELEMENT_NODE&&(e.tagName==="BR"||(e.tagName==="P"||e.tagName==="DIV")&&(!(e.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&(nbsp|#160);/gi,"").trim()||!(e.textContent||"").replace(/\u00a0/g,"").trim()&&!e.querySelector("img"))):!1}function Go(e=[]){let t=document.createElement("div");return e.forEach(n=>t.appendChild(n)),t.innerHTML.trim()}function ys(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=[],r=(i="")=>{let s=document.createElement("p");i?s.innerHTML=i:s.appendChild(document.createElement("br")),n.push(s)};Array.from(t.content.childNodes).forEach(i=>{if(i.nodeType===Node.TEXT_NODE){let s=(i.textContent||"").trim();s&&r(s);return}if(i.nodeType===Node.ELEMENT_NODE){if(i.tagName==="P"){n.push(i.cloneNode(!0));return}if(i.tagName==="BR"){r("");return}if(i.tagName==="DIV"){r(i.innerHTML);return}r(i.outerHTML)}}),n.length||r("");let o=document.createElement("div");return n.forEach(i=>o.appendChild(i)),o.innerHTML}function Dn(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll(".block-header").forEach(p=>{let h=p.parentNode;if(h){for(;p.firstChild;)h.insertBefore(p.firstChild,p);h.removeChild(p)}});let n=Array.from(t.content.childNodes),r=p=>p?.nodeType===Node.TEXT_NODE&&!(p.textContent||"").trim(),o=0;for(;o<n.length&&r(n[o]);)o+=1;let i=n[o];if(!i||i.nodeType!==Node.ELEMENT_NODE||i.tagName!=="P"||Yn(i))return{titleHtml:"",bodyHtml:Go(n)};let s=o+1;for(;s<n.length&&r(n[s]);)s+=1;let c=n[s];if(!(!!c&&Yn(c)&&(c.nodeType===Node.ELEMENT_NODE?c.tagName==="P"||c.tagName==="DIV"||c.tagName==="BR":!1)))return{titleHtml:"",bodyHtml:Go(n)};let l=[i.cloneNode(!0)],d=[];for(let p=s+1;p<n.length;p+=1)d.push(n[p].cloneNode(!0));return{titleHtml:Go(l),bodyHtml:Go(d)}}function el({event:e,element:t,range:n,selection:r,notifyEditingInput:o,logDebug:i}){if(!e||!t||!n||!r||!n.collapsed)return!1;let s=e.key==="Backspace"||e.code==="Backspace"||e.keyCode===8,c=e.key==="Delete"||e.key==="Del"||e.code==="Delete"||e.code==="Del"||e.keyCode===46;if(!s&&!c)return!1;let a=m=>{try{r.removeAllRanges(),r.addRange(m)}catch{}try{t.focus({preventScroll:!0})}catch{t.focus()}},l=m=>{let x=(n.commonAncestorContainer?.nodeType===Node.ELEMENT_NODE?n.commonAncestorContainer:n.commonAncestorContainer?.parentElement)?.closest?.("p");if(x)return x;let v=t,L=Array.from(v.childNodes),R=n.startContainer;for(;R&&R.parentNode!==v;)R=R.parentNode;let q=R?L.indexOf(R):-1,j=$=>{let X=$==="prev"?-1:1,W=q;for(W===-1?W=$==="prev"?L.length-1:0:W=$==="prev"?W-1:W;W>=0&&W<L.length;){let te=L[W];if(te?.nodeType===Node.ELEMENT_NODE&&te.tagName==="P")return te;W+=X}return null};return m==="Delete"?j("next")||j("prev"):m==="Backspace"?j("prev")||j("next"):null},d=()=>{if(n.startContainer!==t)return{prev:null,next:null};let m=Array.from(t.childNodes),b=n.startOffset,x=null,v=null;for(let L=b-1;L>=0;L-=1){let R=m[L];if(R?.nodeType===Node.ELEMENT_NODE&&R.tagName==="P"){x=R;break}}for(let L=b;L<m.length;L+=1){let R=m[L];if(R?.nodeType===Node.ELEMENT_NODE&&R.tagName==="P"){v=R;break}}return{prev:x,next:v}},p=m=>{let b=m?.previousElementSibling;for(;b&&b.tagName!=="P";)b=b.previousElementSibling;return b&&b.tagName==="P"?b:null},h=m=>{let b=m?.nextElementSibling;for(;b&&b.tagName!=="P";)b=b.nextElementSibling;return b&&b.tagName==="P"?b:null},y=m=>{if(!m)return!0;let b=new Set(["span","b","strong","i","em","u","s","mark","code"]),x=new Set(["img","video","audio","iframe"]),v=L=>{if(!L)return!1;if(L.nodeType===Node.TEXT_NODE)return(L.textContent||"").replace(/\u00a0/g,"").replace(/[\u200B-\u200D\uFEFF]/g,"").trim().length>0;if(L.nodeType!==Node.ELEMENT_NODE)return!1;let R=(L.tagName||"").toLowerCase();return R==="br"?!1:x.has(R)?!0:R==="span"&&(L.getAttribute("class")||"").includes("resizable-image__handle")?!1:b.has(R)?Array.from(L.childNodes||[]).some(v):!0};return!Array.from(m.childNodes||[]).some(v)},S=m=>{if(!m)return!1;let b=document.createRange();b.selectNodeContents(m);try{b.setEnd(n.startContainer,n.startOffset)}catch{return!1}if(y(b.cloneContents()))return!0;try{let x=document.createRange();return x.selectNodeContents(m),x.collapse(!0),n.compareBoundaryPoints(Range.START_TO_START,x)===0}catch{return!1}},f=m=>{if(!m)return!1;let b=document.createRange();b.selectNodeContents(m);try{b.setStart(n.startContainer,n.startOffset)}catch{return!1}if(y(b.cloneContents()))return!0;try{let x=document.createRange();return x.selectNodeContents(m),x.collapse(!1),n.compareBoundaryPoints(Range.END_TO_END,x)===0}catch{return!1}};if(window.__debugMergeP&&i("mergeP.keydown",{key:e.key,code:e.code,keyCode:e.keyCode,startContainer:n.startContainer?.nodeName,startOffset:n.startOffset,collapsed:n.collapsed}),s){if(n.startContainer===t){let v=d();if(v.prev&&v.next){e.preventDefault(),e.stopPropagation();let L=document.createRange();for(L.selectNodeContents(v.prev),L.collapse(!1);v.next.firstChild;)v.prev.appendChild(v.next.firstChild);return v.next.remove(),a(L),o(t),!0}return!1}let m=l("Backspace");if(!m||!t.contains(m)||!S(m))return!1;let b=p(m);if(!b||!t.contains(b))return!1;e.preventDefault(),e.stopPropagation();let x=document.createRange();for(x.selectNodeContents(b),x.collapse(!1);m.firstChild;)b.appendChild(m.firstChild);return m.remove(),a(x),o(t),!0}if(c){let m=l("Delete");if(!m||!t.contains(m)){let v=d();if(v.prev&&v.next){e.preventDefault(),e.stopPropagation();let L=document.createRange();for(L.selectNodeContents(v.prev),L.collapse(!1);v.next.firstChild;)v.prev.appendChild(v.next.firstChild);return v.next.remove(),a(L),o(t),!0}return!1}if(!f(m))return!1;let b=h(m);if(!b||!t.contains(b))return!1;e.preventDefault(),e.stopPropagation();let x=document.createRange();for(x.selectNodeContents(m),x.collapse(!1);b.firstChild;)m.appendChild(b.firstChild);return b.remove(),a(x),o(t),!0}return!1}var bs=We(()=>{});function io(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=r=>{if(r&&!(r.nodeType===Node.ELEMENT_NODE&&r.tagName==="A")){if(r.nodeType===Node.TEXT_NODE){let o=r.textContent||"";if(Zo.lastIndex=0,!Zo.test(o))return;let s=document.createDocumentFragment(),c=0;Zo.lastIndex=0;let a;for(;(a=Zo.exec(o))!==null;){let[l]=a;a.index>c&&s.appendChild(document.createTextNode(o.slice(c,a.index)));let d=l.startsWith("http")?l:`https://${l}`,p=document.createElement("a");p.href=d,p.target="_blank",p.rel="noopener noreferrer",p.textContent=l,s.appendChild(p),c=a.index+l.length}c<o.length&&s.appendChild(document.createTextNode(o.slice(c))),r.parentNode&&r.parentNode.replaceChild(s,r);return}Array.from(r.childNodes||[]).forEach(n)}};return Array.from(t.content.childNodes).forEach(n),t.innerHTML}function tl(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll("script, style").forEach(o=>o.remove());let n=(o="")=>/^javascript:/i.test(o.trim()),r=o=>{if(!o||o.nodeType!==Node.ELEMENT_NODE){Array.from(o?.childNodes||[]).forEach(r);return}Array.from(o.attributes||[]).forEach(i=>{let s=i.name.toLowerCase(),c=i.value||"";if(s.startsWith("on")||s==="style"){o.removeAttribute(i.name);return}(s==="href"||s==="src")&&n(c)&&o.removeAttribute(i.name)}),Array.from(o.childNodes||[]).forEach(r)};return Array.from(t.content.childNodes||[]).forEach(r),t.innerHTML}function ws(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=r=>{if(!r)return!0;if(r.nodeType===Node.TEXT_NODE)return!(r.textContent||"").replace(/\u00a0/g,"").trim();if(r.nodeType!==Node.ELEMENT_NODE)return!1;if(r.tagName==="BR")return!0;let o=(r.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&nbsp;/gi,"").trim(),i=(r.textContent||"").replace(/\u00a0/g,"").trim(),s=!!r.querySelector("img,video,audio,iframe");return!o&&!i&&!s};for(;t.content.firstChild&&n(t.content.firstChild);)t.content.removeChild(t.content.firstChild);for(;t.content.lastChild&&n(t.content.lastChild);)t.content.removeChild(t.content.lastChild);return t.innerHTML}function nl(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=(t.content.textContent||"").replace(/\u00a0/g," ").trim(),r=!!t.content.querySelector("a"),o=!1;{let S=Array.from(t.content.childNodes||[]);for(let f=0;f<S.length;f+=1){let m=S[f];if(m.nodeType===Node.TEXT_NODE){if(!(m.textContent||"").trim())continue;break}Yn(m)&&(o=!0);break}}let i=document.createElement("template");i.innerHTML=e||"";let c=(()=>{if(!Array.from(i.content.childNodes||[]).length)return!1;let f=Array.from(i.content.querySelectorAll("p"));if(f.length<2)return!1;let m=re=>{let he=re.trim();return he.startsWith("|")&&he.indexOf("|",1)!==-1},x=f.map(re=>(re.textContent||"").replace(/\u00a0/g," ").trim()).filter(re=>re);if(x.length<2||!x.every(m))return!1;let v=x.map(re=>{let he=re.trim();return(he.endsWith("|")?he.slice(1,-1):he.slice(1)).split("|").map(yt=>yt.trim())}),L=v[0],R=v.slice(1),q=R.reduce((re,he)=>Math.max(re,he.length),L.length),j=document.createElement("table");j.className="memus-table";let $=document.createElement("colgroup"),X=100/Math.max(q,1);for(let re=0;re<q;re+=1){let he=document.createElement("col");he.setAttribute("width",`${X.toFixed(4)}%`),$.appendChild(he)}j.appendChild($);let W=document.createElement("thead"),te=document.createElement("tr");for(let re=0;re<q;re+=1){let he=document.createElement("th");he.textContent=L[re]||"",te.appendChild(he)}W.appendChild(te),j.appendChild(W);let be=document.createElement("tbody");return R.forEach(re=>{let he=document.createElement("tr"),Qe=[...re];for(let yt=0;yt<q;yt+=1){let Et=document.createElement("td");Et.textContent=Qe[yt]||"",he.appendChild(Et)}be.appendChild(he)}),j.appendChild(be),i.content.innerHTML="",i.content.appendChild(j),io(i.innerHTML).replace(/<\/a>\s*<a/gi,"</a> <a")})();if(c)return c;i.content.querySelectorAll(".table-toolbar, .table-toolbar-btn").forEach(S=>{S.remove()}),i.content.querySelectorAll(".block-header").forEach(S=>{let f=S.parentNode;if(f){for(;S.firstChild;)f.insertBefore(S.firstChild,S);f.removeChild(S)}});let a=S=>{Array.from(S.childNodes).forEach(f=>{if(f.nodeType===Node.ELEMENT_NODE){if(f.tagName==="DIV"){let m=document.createElement("p");m.innerHTML=f.innerHTML,f.parentNode.replaceChild(m,f),a(m);return}a(f)}})};a(i.content),(S=>{Array.from(S.childNodes||[]).forEach(m=>{if(m.nodeType===Node.TEXT_NODE){let x=(m.textContent||"").replace(/\u00a0/g," ");if(!x.trim()){if(m.previousSibling&&m.nextSibling){m.textContent=" ";return}S.removeChild(m);return}let L=document.createElement("p");L.textContent=x,S.replaceChild(L,m)}})})(i.content),i.content.querySelectorAll("p").forEach(S=>{(S.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim()||(S.innerHTML="",S.appendChild(document.createElement("br")))});let d=i.content;if(!!d.querySelector("p")){if(o){let S=Array.from(d.childNodes||[]),f=null;for(let m=0;m<S.length;m+=1){let b=S[m];if(!(b.nodeType===Node.TEXT_NODE&&!(b.textContent||"").trim())){f=b;break}}if(f){if(!(f.tagName==="P"&&Yn(f))){let m=document.createElement("p");m.appendChild(document.createElement("br")),d.insertBefore(m,f)}}else{let m=document.createElement("p");m.appendChild(document.createElement("br")),d.appendChild(m)}}}else{let S=document.createElement("p");S.appendChild(document.createElement("br")),d.appendChild(S)}let y=io(i.innerHTML).replace(/<\/a>\s*<a/gi,"</a> <a");return!y.trim()&&(n||r)?e||"":y}var Zo,rl=We(()=>{bs();Zo=/((?:https?:\/\/|www\.)[^\s<>"']+)/gi});function $n(e){if(!e)return;if(!(e.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&nbsp;/gi,"").trim()){e.innerHTML="";let n=document.createRange();n.selectNodeContents(e),n.collapse(!0);let r=window.getSelection();r&&(r.removeAllRanges(),r.addRange(n))}}var Ss=We(()=>{});function dr(e){if(!e)return!1;if(e.type&&e.type.startsWith("image/"))return!0;let t=(e.name||"").toLowerCase();return t?/\.(png|jpe?g|gif|webp|bmp|svg|heic|heif)$/i.test(t):!1}function xs(e=[],t=[]){let n=[];return Array.from(e||[]).forEach(r=>{if(r.kind==="file"){let o=typeof r.getAsFile=="function"?r.getAsFile():null;o&&dr(o)&&n.push(o)}}),!n.length&&t?.length&&Array.from(t).forEach(r=>{dr(r)&&n.push(r)}),n}function As(e=[],t=[]){let n=[];return Array.from(e||[]).forEach(r=>{if(r.kind==="file"){let o=typeof r.getAsFile=="function"?r.getAsFile():null;o&&!dr(o)&&n.push(o)}}),!n.length&&t?.length&&Array.from(t).forEach(r=>{dr(r)||n.push(r)}),n}async function ei(e,t,n){let r=`img-${Date.now()}-${Math.random().toString(16).slice(2)}`,o=t&&t.name?t.name:"image",i=zt(o).replace(/"/g,"&quot;");try{$n(e),Ln(e,`<span data-pending-image="true" data-image-token="${r}">${i} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F...)</span>`)}catch{}try{let{url:s}=await Jr(t),a=`
      <span class="resizable-image" style="width:320px;max-width:100%;">
        <span class="resizable-image__inner">${`<img src="${s}" alt="${i}" draggable="false" />`}</span>
        <span class="resizable-image__handle" data-direction="e" aria-hidden="true"></span>
      </span>
    `,l=e,d=l&&l.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`);if(n&&(!d||!l.isConnected)){let p=document.querySelector(`.block[data-block-id="${n}"]`);if(p){let y=p.querySelector('.block-text[contenteditable="true"]')||p.querySelector(".block-text.block-body");y&&(l=y,d=l.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`))}}d?(d.removeAttribute("data-pending-image"),d.removeAttribute("data-image-token"),d.outerHTML=a):l&&($n(l),Ln(l,a))}catch(s){try{let a=e;if(n&&!a.isConnected){let l=document.querySelector(`.block[data-block-id="${n}"]`);if(l){let p=l.querySelector('.block-text[contenteditable="true"]')||l.querySelector(".block-text.block-body");p&&(a=p)}}if(a){let l=a.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`);l&&(l.textContent=`${o} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F)`,l.removeAttribute("data-pending-image"))}}catch{}try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"insertImageFromFileError",data:{message:s&&s.message?String(s.message):String(s),name:t&&t.name,type:t&&t.type,size:t&&t.size}})}).catch(()=>{})}catch{}try{let a={where:"insertImageFromFile",message:s&&s.message?String(s.message):String(s),status:typeof s?.status=="number"?s.status:null,name:t&&t.name,type:t&&t.type,size:t&&t.size},l=a.status===null?"null":String(a.status);window.alert(`upload failed (status ${l}):\\n${JSON.stringify(a,null,2)}`)}catch{}let c=String(s?.message||"").toLowerCase();c.includes("status 0")||c.includes("network error")?ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 (\u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C). \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438, \u043F\u0440\u0438 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u043E\u0441\u0442\u0438, \u0432\u043E\u0439\u0434\u0438\u0442\u0435 \u0437\u0430\u043D\u043E\u0432\u043E."):ve(s.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435")}}function wf(e){if(e.button!==0)return;let t=e.target?.closest(".resizable-image__handle");if(!t)return;let n=t.closest(".resizable-image"),o=n?.closest(".block")?.dataset?.blockId;if(!n||!o||u.mode!=="edit"||u.editingBlockId!==o)return;e.preventDefault(),e.stopPropagation();let i=n.getBoundingClientRect();Xn={wrapper:n,startWidth:i.width,startX:e.clientX},n.classList.add("resizable-image--resizing")}function Sf(e){if(!Xn)return;e.preventDefault();let t=e.clientX-Xn.startX,r=parseFloat(getComputedStyle(document.documentElement).fontSize)||16,o=Math.max(r,document.documentElement.clientWidth-32),i=Xn.startWidth+t;i=Math.max(r,Math.min(i,o)),Xn.wrapper.style.width=`${i}px`}function il(){Xn&&(Xn.wrapper.classList.remove("resizable-image--resizing"),Xn=null)}function sl(){ol||(ol=!0,document.addEventListener("pointerdown",wf),document.addEventListener("pointermove",Sf),document.addEventListener("pointerup",il),document.addEventListener("pointercancel",il))}var Xn,ol,cl=We(()=>{wt();Yt();Vt();An();Ss();Xn=null,ol=!1});function al({listTag:e,resolveTarget:t,restoreSelection:n,richContextRange:r,notifyEditingInput:o,setRichContextRange:i}){let s=t();if(!s||!document.contains(s))return;n();let c=window.getSelection(),a=null;if(r&&s.contains(r.commonAncestorContainer))a=r.cloneRange();else if(c&&c.rangeCount>0){let x=c.getRangeAt(0);s.contains(x.commonAncestorContainer)&&(a=x.cloneRange())}a||(a=document.createRange(),a.selectNodeContents(s),a.collapse(!1));let l=a.startContainer?.nodeType===Node.ELEMENT_NODE?a.startContainer:a.startContainer?.parentElement,d=l?.closest?.("li"),p=d?.closest?.("ol,ul"),h=x=>{if(!x)return;let v=document.createRange();v.selectNodeContents(x),v.collapse(!1),c&&(c.removeAllRanges(),c.addRange(v)),i(v);try{s.focus({preventScroll:!0})}catch{s.focus()}s.classList.remove("block-body--empty"),o(s)},y=x=>{let v=x.parentElement?.tagName==="P"&&x.parentElement.childNodes.length===1?x.parentElement:x,L=Array.from(x.children||[]).filter(j=>j.nodeType===Node.ELEMENT_NODE&&j.tagName==="LI"),R=document.createDocumentFragment(),q=[];L.forEach(j=>{let $=document.createElement("p");for(;j.firstChild;)$.appendChild(j.firstChild);q.push($),R.appendChild($)}),v.replaceWith(R),h(q[0]||null)};if(p){if(p.tagName.toLowerCase()===e){y(p);return}let v=document.createElement(e);for(;p.firstChild;)v.appendChild(p.firstChild);p.replaceWith(v),h(d||v.lastElementChild||v);return}let S=()=>{if(!a.collapsed)return null;let x=l?.closest?.("p")||null;if(x&&s.contains(x))return x;if(a.startContainer===s){let v=Array.from(s.childNodes),L=a.startOffset;for(let R=L-1;R>=0;R-=1){let q=v[R];if(q?.nodeType===Node.ELEMENT_NODE&&q.tagName==="P")return q}for(let R=L;R<v.length;R+=1){let q=v[R];if(q?.nodeType===Node.ELEMENT_NODE&&q.tagName==="P")return q}}return null},f=[];if(a.collapsed){let x=S();x&&(f=[x])}else if(f=Array.from(s.querySelectorAll(":scope > p")).filter(v=>{try{return a.intersectsNode(v)}catch{return!1}}),!f.length){let v=l?.closest?.("p");v&&s.contains(v)&&(f=[v])}if(!f.length)return;let m=document.createElement(e);f.forEach(x=>{let v=document.createElement("li");for(;x.firstChild;)v.appendChild(x.firstChild);m.appendChild(v)}),f[0].replaceWith(m),f.slice(1).forEach(x=>x.remove()),h(m.firstElementChild||m)}var ll=We(()=>{});var as={};So(as,{applyEditingUndoStep:()=>vf,attachRichContentHandlers:()=>hs,buildEditableBlockHtml:()=>fs,buildStoredBlockHtml:()=>Ea,cleanupEditableHtml:()=>nl,clearEditingUndoSession:()=>kf,countBlocks:()=>cs,ensureBlockVisible:()=>ns,expandCollapsedAncestors:()=>Cf,extendSelection:()=>Ga,extractBlockSections:()=>Dn,findBlock:()=>ut,findCollapsibleTarget:()=>Ef,findFallbackBlockId:()=>Yo,flattenVisible:()=>_n,initEditingUndoForElement:()=>If,insertFilesIntoEditable:()=>ms,isSeparatorNode:()=>Yn,moveSelection:()=>Qa,setCollapseState:()=>ti,setCurrentBlock:()=>Wn,toggleCollapse:()=>ps});function pl(e=""){return e?e.startsWith("app:/")?`/api/yandex/disk/file?path=${encodeURIComponent(e)}`:e.startsWith("disk:/")?`/api/yandex/disk/file?path=${encodeURIComponent(e)}`:e:""}function Af(e,t){if(e===t)return!1;if(t.startsWith(e)){let n=t.slice(e.length);if(n.length>0&&n.length<=xf&&/^[A-Za-z--0-9]+$/.test(n))return!1}return!0}function If(e,t){if(!e||!t)return;u.editingUndo={blockId:t,snapshots:[e.innerHTML],index:0,lastText:e.textContent||"",lastSnapshotAt:Date.now()};let n=()=>{let r=u.editingUndo;if(!r||r.blockId!==t)return;let o=e.innerHTML,i=e.textContent||"",{snapshots:s,index:c,lastText:a,lastSnapshotAt:l}=r,d=Date.now();if(!Af(a||"",i)){r.lastText=i;return}if(s[c]===o){r.lastText=i,r.lastSnapshotAt=d;return}c<s.length-1&&s.splice(c+1),s.push(o),r.index=s.length-1,r.lastText=i,r.lastSnapshotAt=d};e.addEventListener("input",()=>{!u.editingUndo||u.editingUndo.blockId!==t||u.mode!=="edit"||u.editingBlockId!==t||n()})}function kf(){u.editingUndo=null}function so(e){if(e)try{let t=typeof InputEvent=="function"?new InputEvent("input",{bubbles:!0}):new Event("input",{bubbles:!0});e.dispatchEvent(t)}catch{try{let n=document.createEvent("Event");n.initEvent("input",!0,!1),e.dispatchEvent(n)}catch{}}}function vf(e){let t=u.editingUndo;if(!t||!t.blockId||!e||u.mode!=="edit"||u.editingBlockId!==t.blockId)return!1;let n=document.querySelector(`.block[data-block-id="${t.blockId}"] .block-text[contenteditable="true"]`);if(!n)return!1;let r=t.index+e;if(r<0||r>=t.snapshots.length)return!1;t.index=r;let o=t.snapshots[r];n.innerHTML=o;try{n.focus({preventScroll:!0})}catch{n.focus()}try{let i=window.getSelection&&window.getSelection();if(i){let s=document.createRange();s.selectNodeContents(n),s.collapse(!1),i.removeAllRanges(),i.addRange(s)}}catch{}return!0}function fs(e=""){let t=Dn(e);if(!t.titleHtml)return e||"";let n=ys(t.titleHtml),r=t.bodyHtml||"";if(r){let i=document.createElement("template");i.innerHTML=r;let s=i.content.firstChild;for(;s&&Yn(s);){let c=s;s=s.nextSibling,i.content.removeChild(c)}r=i.innerHTML}let o=ys(r||"");return`${n}<p><br /></p>${o}`}function Ea(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll(".block-header").forEach(i=>{let s=i.parentNode;if(s){for(;i.firstChild;)s.insertBefore(i.firstChild,i);s.removeChild(i)}});let n=t.innerHTML,r=Dn(n);if(!r.titleHtml)return e||"";let o=`<div class="block-header">${r.titleHtml}</div>`;return r.bodyHtml?`${o}<div><br /></div>${r.bodyHtml}`:o}async function ps(e){let t=ut(e);t&&ti(e,!t.block.collapsed)}async function ti(e,t){let n=ut(e);if(!n||n.block.collapsed===t)return;let r=()=>{let s=document.getElementById("blocksContainer");if(!s)return null;let c=u.currentBlockId;if(!c)return{container:s};let a=s.querySelector(`.block[data-block-id="${c}"]`);if(!a)return{container:s};let l=s.getBoundingClientRect(),d=a.getBoundingClientRect();return{container:s,currentId:c,topOffset:d.top-l.top}},o=s=>{if(!s?.container)return;let{container:c}=s;if(!s.currentId||typeof s.topOffset!="number")return;let a=c.querySelector(`.block[data-block-id="${s.currentId}"]`);if(!a)return;let l=c.getBoundingClientRect(),p=a.getBoundingClientRect().top-l.top;c.scrollTop+=p-s.topOffset},i=r();n.block.collapsed=t,await Qt(e),oo({scrollIntoView:!1}),o(i);try{let s=await gt(`/api/articles/${u.articleId}/collapse`,{method:"PATCH",body:JSON.stringify({blockId:e,collapsed:t})});s?.updatedAt&&(u.article.updatedAt=s.updatedAt)}catch(s){n.block.collapsed=!t,await Qt(e),oo({scrollIntoView:!1}),o(i),ve(s.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430")}}function Ef(e,t){let n=ut(e);for(;n;){let o=!!Dn(n.block.text||"").titleHtml,i=!!n.block.children?.length;if((o||i)&&n.block.collapsed!==t)return n.block.id;if(!n.parent)break;n=ut(n.parent.id)}return null}async function Cf(e){let t=ut(e);if(!t)return;let n=(t.ancestors||[]).filter(r=>r.collapsed);for(let r of n)await ti(r.id,!1)}function Yo(e){let t=ut(e);if(!t)return null;let n=t.siblings?.[t.index+1];if(n)return n.id;let r=t.siblings?.[t.index-1];return r?r.id:t.parent?t.parent.id:null}function cs(e=[]){return(e||[]).reduce((t,n)=>t+1+cs(n.children||[]),0)}async function ks(e,t,n){if(!u.articleId){ve("\u041D\u0435 \u0432\u044B\u0431\u0440\u0430\u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044F \u0434\u043B\u044F \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0444\u0430\u0439\u043B\u0430");return}let r=`att-${Date.now()}-${Math.random().toString(16).slice(2)}`,o=zt(t?.name||"\u0444\u0430\u0439\u043B"),i=t?.name||"\u0444\u0430\u0439\u043B",s="";jt("attachment: uploading to Yandex Disk",{name:t?.name,type:t?.type,size:t?.size,articleId:u.articleId,token:r});try{$n(e),Ln(e,`<a data-pending-attachment="true" data-attachment-token="${r}">${o} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430...)</a>`)}catch{}try{let c=await No(u.articleId,t,{onProgress:h=>{let y=Math.max(0,Math.min(100,Math.round(h||0)));jt("attachment upload progress",{percent:y,name:t?.name});try{let S=e,f=S.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);if(n&&(!f||!S.isConnected)){let m=document.querySelector(`.block[data-block-id="${n}"]`);if(m){let x=m.querySelector('.block-text[contenteditable="true"]')||m.querySelector(".block-text.block-body");x&&(S=x,f=S.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`))}}if(f){let m=y>=100?`${i} (\u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0430...)`:`${i} (${y}%)`;m!==s&&(s=m,f.textContent=m)}}catch{}}}),a=zt(c.originalName||t.name||"\u0444\u0430\u0439\u043B"),l=c.storedPath||c.url||"",d=pl(l),p=zt(d);if(p){let h=e,y=h.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);if(n&&(!y||!h.isConnected)){let S=document.querySelector(`.block[data-block-id="${n}"]`);if(S){let m=S.querySelector('.block-text[contenteditable="true"]')||S.querySelector(".block-text.block-body");m&&(h=m,y=h.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`))}}y?(y.removeAttribute("data-pending-attachment"),y.removeAttribute("data-attachment-token"),y.setAttribute("href",p),y.setAttribute("target","_blank"),y.setAttribute("rel","noopener noreferrer"),y.textContent=a):($n(h),Ln(h,`<a href="${p}" target="_blank" rel="noopener noreferrer">${a}</a>`))}}catch(c){try{let l=e;if(n&&!l.isConnected){let p=document.querySelector(`.block[data-block-id="${n}"]`);if(p){let y=p.querySelector('.block-text[contenteditable="true"]')||p.querySelector(".block-text.block-body");y&&(l=y)}}let d=l.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);d&&(d.textContent=`${o} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`)}catch{}let a=String(c?.message||"").toLowerCase();a.includes("status 0")||a.includes("network error")?ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B (\u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C). \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438, \u043F\u0440\u0438 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u043E\u0441\u0442\u0438, \u0432\u043E\u0439\u0434\u0438\u0442\u0435 \u0437\u0430\u043D\u043E\u0432\u043E."):ve(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u043D\u0430 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A")}}function ms(e,t=[],n){if(!e||!t||!t.length)return;let r=Array.from(t),o=r.filter(s=>dr(s)),i=r.filter(s=>s&&!dr(s));o.forEach(s=>ei(e,s,n)),i.forEach(s=>ks(e,s,n))}function hs(e,t){fl(e,t);let n=e.closest(".block-content");n&&n!==e&&fl(n,t,e),e.addEventListener("paste",r=>{if(u.mode!=="edit"||u.editingBlockId!==t)return;let o=xs(r.clipboardData?.items),i=As(r.clipboardData?.items);if(o.length>0)r.preventDefault(),o.forEach(s=>ei(e,s,t));else if(i.length>0)r.preventDefault(),jt("paste: non-image files detected",i.map(s=>({name:s.name,type:s.type,size:s.size}))),i.forEach(s=>ks(e,s,t));else{let s=(r.clipboardData?.getData("text/html")||"").trim();if(r.preventDefault(),s){let c=tl(s),a=ws(c);$n(e),Ln(e,io(a)),so(e)}else{let c=r.clipboardData?.getData("text/plain")||"",a=c.trim();if(/^https?:\/\/\S+$/i.test(a)){let d=zt(a);$n(e),Ln(e,`<a href="${d}" target="_blank" rel="noopener noreferrer">${d}</a>`),so(e)}else{let d=c.replace(/\r\n/g,`
`).replace(/\r/g,`
`),p=zt(d).replace(/\n{2,}/g,"<br /><br />").replace(/\n/g," "),h=io(ws(p));$n(e),Ln(e,h),so(e)}}}}),e.addEventListener("drop",r=>{if(u.mode!=="edit"||u.editingBlockId!==t){jt("drop ignored",{mode:u.mode,editingBlockId:u.editingBlockId,targetBlockId:t});return}let o=Array.from(r.dataTransfer?.files||[]);if(!o.length)return;let i=o.filter(c=>c.type?.startsWith("image/")),s=o.filter(c=>!c.type||!c.type.startsWith("image/"));!i.length&&!s.length||(r.preventDefault(),jt("drop: files detected",o.map(c=>({name:c.name,type:c.type,size:c.size}))),i.forEach(c=>ei(e,c,t)),s.forEach(c=>ks(e,c,t)))}),e.addEventListener("click",r=>{let o=r.target?.closest("img");if(o){if(r.target?.closest(".resizable-image__handle")){r.preventDefault();return}r.preventDefault(),Wr(o.src,o.alt||"");return}let i=r.target?.closest("a[href]");if(!i)return;let s=i.getAttribute("href")||"";if(!s.startsWith("app:/")&&!s.startsWith("disk:/"))return;r.preventDefault();let c=pl(s);c&&window.open(c,"_blank","noopener,noreferrer")}),u.articleId==="inbox"&&e.addEventListener("click",async r=>{if(r.target?.closest(".move-block-btn")){r.preventDefault(),r.stopPropagation();try{let s=(u.articlesIndex.length?u.articlesIndex:await fn()).filter(d=>d.id!=="inbox").map(d=>({id:d.id,title:d.title||"\u0420\u2018\u0420\xB5\u0420\xB7 \u0420\u0405\u0420\xB0\u0420\xB7\u0420\u0406\u0420\xB0\u0420\u0405\u0420\u0451\u0421\u040F"})),c=await Vn({title:"\u0420\u045F\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451 \u0420\u0406 \u0421\u0403\u0421\u201A\u0420\xB0\u0421\u201A\u0421\u040A\u0421\u040B",message:"\u0420\u2019\u0420\u0406\u0420\xB5\u0420\u0491\u0420\u0451\u0421\u201A\u0420\xB5 ID \u0420\u0451\u0420\xBB\u0420\u0451 \u0420\u0406\u0421\u2039\u0420\xB1\u0420\xB5\u0421\u0402\u0420\u0451\u0421\u201A\u0420\xB5 \u0421\u0403\u0421\u201A\u0420\xB0\u0421\u201A\u0421\u040A\u0421\u040B",confirmText:"\u0420\u045F\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451",cancelText:"\u0420\u045B\u0421\u201A\u0420\u0458\u0420\xB5\u0420\u0405\u0420\xB0",suggestions:s,returnMeta:!0,hideConfirm:!1}),l=(c?.selectedId||(typeof c=="object"?c?.value:c)||""||"").trim();if(!l)return;await gt(`/api/articles/${u.articleId}/blocks/${t}/move-to/${l}`,{method:"POST"}),pn(Xt.article("inbox"))}catch(i){ve(i.message||"\u0420\u045C\u0420\xB5 \u0421\u0453\u0420\u0491\u0420\xB0\u0420\xBB\u0420\u0455\u0421\u0403\u0421\u040A \u0420\u0457\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451 \u0420\xB1\u0420\xBB\u0420\u0455\u0420\u0454")}}}),e.addEventListener("dragover",r=>{if(u.mode!=="edit"||u.editingBlockId!==t)return;(xs(r.dataTransfer?.items).length>0||As(r.dataTransfer?.items).length>0)&&r.preventDefault()}),e.addEventListener("keydown",r=>{if(u.mode!=="edit"||u.editingBlockId!==t)return;let o=window.getSelection();if(!o||o.rangeCount===0)return;let i=o.getRangeAt(0);if(!i||!i.collapsed||el({event:r,element:e,range:i,selection:o,notifyEditingInput:so,logDebug:jt})||r.key!=="Tab"||!(i.commonAncestorContainer?.nodeType===Node.ELEMENT_NODE?i.commonAncestorContainer:i.commonAncestorContainer?.parentElement)?.closest?.("li"))return;r.preventDefault(),r.stopPropagation();let a=r.shiftKey?"outdent":"indent";document.execCommand(a,!1,null)})}function ml(){let e=window.getSelection();if(!e||e.rangeCount===0)return;let t=e.getRangeAt(0),n=t.commonAncestorContainer,o=(n?.nodeType===Node.ELEMENT_NODE?n:n?.parentElement)?.closest('.block-text[contenteditable="true"]');if(!o){ao=null;return}let s=o.closest(".block")?.dataset?.blockId;if(u.mode!=="edit"||u.editingBlockId!==s){ao=null;return}ao=t.cloneRange()}function Tf(){if(Is)return Is;dl||(document.addEventListener("selectionchange",ml),dl=!0);let e=document.createElement("div");e.className="rich-context-menu hidden",e.innerHTML=`
    <div class="rich-context-menu__col rich-context-menu__col--buffer">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="copy" aria-label="\u041A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C" title="\u041A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C">\u29C9</button>
        <button class="rich-context-menu__icon-btn" data-action="cut" aria-label="\u0412\u044B\u0440\u0435\u0437\u0430\u0442\u044C" title="\u0412\u044B\u0440\u0435\u0437\u0430\u0442\u044C">\u2702</button>
        <button class="rich-context-menu__icon-btn" data-action="paste" aria-label="\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C" title="\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C">\u25A3</button>
        <button class="rich-context-menu__icon-btn" data-action="select-all" aria-label="\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0432\u0441\u0451" title="\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0432\u0441\u0451">\u26F6</button>
      </div>
    </div>
    <div class="rich-context-menu__col">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="bold" aria-label="\u041F\u043E\u043B\u0443\u0436\u0438\u0440\u043D\u044B\u0439" title="\u041F\u043E\u043B\u0443\u0436\u0438\u0440\u043D\u044B\u0439"><strong>\u0416</strong></button>
        <button class="rich-context-menu__icon-btn" data-action="italic" aria-label="\u041A\u0443\u0440\u0441\u0438\u0432" title="\u041A\u0443\u0440\u0441\u0438\u0432"><em>/</em></button>
        <button class="rich-context-menu__icon-btn" data-action="underline" aria-label="\u041F\u043E\u0434\u0447\u0435\u0440\u043A\u043D\u0443\u0442\u044C" title="\u041F\u043E\u0434\u0447\u0435\u0440\u043A\u043D\u0443\u0442\u044C"><u>\u0427</u></button>
        <button class="rich-context-menu__icon-btn" data-action="remove-format" aria-label="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0444\u043E\u0440\u043C\u0430\u0442" title="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0444\u043E\u0440\u043C\u0430\u0442">\u2715</button>
      </div>
    </div>
    <div class="rich-context-menu__col">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="ul" aria-label="\u041C\u0430\u0440\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A" title="\u041C\u0430\u0440\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A">\u2022</button>
        <button class="rich-context-menu__icon-btn" data-action="ol" aria-label="\u041D\u0443\u043C\u0435\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A" title="\u041D\u0443\u043C\u0435\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A">1.</button>
        <button class="rich-context-menu__icon-btn" data-action="quote" aria-label="\u0426\u0438\u0442\u0430\u0442\u0430" title="\u0426\u0438\u0442\u0430\u0442\u0430">\u275D</button>
        <button class="rich-context-menu__icon-btn" data-action="code" aria-label="\u041A\u043E\u0434" title="\u041A\u043E\u0434">&lt;/&gt;</button>
      </div>
    </div>
    <div class="rich-context-menu__col">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="link" aria-label="\u0421\u0441\u044B\u043B\u043A\u0430" title="\u0421\u0441\u044B\u043B\u043A\u0430">\u{1F517}</button>
        <button class="rich-context-menu__icon-btn" data-action="unlink" aria-label="\u0423\u0431\u0440\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443" title="\u0423\u0431\u0440\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443">\u2298</button>
        <button class="rich-context-menu__icon-btn" data-action="insert-article-link" aria-label="\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E" title="\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E">\xA7</button>
      </div>
    </div>
    <div class="rich-context-menu__col">
      <div class="rich-context-menu__grid">
        <button class="rich-context-menu__icon-btn" data-action="split-at-caret" aria-label="\u0420\u0430\u0437\u0434\u0435\u043B\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043F\u043E \u043A\u0443\u0440\u0441\u043E\u0440\u0443" title="\u0420\u0430\u0437\u0434\u0435\u043B\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043F\u043E \u043A\u0443\u0440\u0441\u043E\u0440\u0443">|\u21B5</button>
      </div>
    </div>
  `,document.body.appendChild(e);let t=()=>{e.classList.add("hidden"),e.style.visibility="",Bt=null,Lr=null,co=null},n=()=>{if(Bt){let o=window.getSelection();o.removeAllRanges(),o.addRange(Bt)}},r=async o=>{n();let i=()=>{if(Lr&&document.contains(Lr))return Lr;let h=window.getSelection()?.anchorNode?.parentElement?.closest(".block-text[contenteditable]");if(h)return h;if(Bt){let S=Bt.commonAncestorContainer;if(S?.parentElement){let f=S.parentElement.closest(".block-text[contenteditable]");if(f)return f}}if(co&&document.contains(co))return co;if(u.editingBlockId){let S=document.querySelector(`.block[data-block-id="${u.editingBlockId}"] .block-text[contenteditable="true"]`);if(S)return S}let y=document.activeElement;if(y&&y.closest){let S=y.closest(".block-text[contenteditable]");if(S)return S}return null},s=d=>{al({listTag:d,resolveTarget:i,restoreSelection:n,richContextRange:Bt,notifyEditingInput:so,setRichContextRange:p=>{Bt=p?p.cloneRange():null}})},c=async()=>{let d=i();if(!d){ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0441\u0441\u044B\u043B\u043A\u0438");return}let p=u.articlesIndex.length?u.articlesIndex:await fn(),h=p.map(v=>({id:v.id,title:v.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),y="",S="";try{let v=await Vn({title:"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438. \u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0438 \u043F\u043E\u043C\u043E\u0433\u0443\u0442 \u043D\u0430\u0439\u0442\u0438 \u043D\u0443\u0436\u043D\u0443\u044E.",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:h,returnMeta:!0,hideConfirm:!0});v&&typeof v=="object"?(y=v.value||"",S=v.selectedId||""):y=v||""}catch{y=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438")||""}let f=(y||"").trim().toLowerCase();if(!f&&!S)return;let m=p.find(v=>{let L=(v.title||"").toLowerCase();return S&&v.id===S||v.id&&v.id.toLowerCase()===f||L===f||L.includes(f)});if(!m){ve("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}if(!d||!document.contains(d)){ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0441\u0441\u044B\u043B\u043A\u0438");return}n(),d.focus();let b=`<a href="${Xt.article(m.id)}" class="article-link" data-article-id="${m.id}">${zt(m.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F")}</a>`;Ln(d,b);let x=(d.innerHTML||"").trim();(!x||x==="<br>"||x==="<br/>"||x==="<br />")&&(d.innerHTML=b),d.classList.remove("block-body--empty")},a=()=>{n();let d=window.getSelection();if(!(!d||d.rangeCount===0)){document.execCommand("removeFormat");for(let p=0;p<4;p+=1)document.execCommand("outdent");document.execCommand("formatBlock",!1,"p")}},l=d=>{let p=i();if(!p||!document.contains(p))return ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u0442\u0435\u043A\u0441\u0442 \u0434\u043B\u044F \u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F"),null;let h=window.getSelection();if(!h||h.rangeCount===0)return null;let y=h.getRangeAt(0).cloneRange();if(!y||y.collapsed)return null;let S=y.cloneContents(),f=document.createElement("div");f.appendChild(S);let m=f.innerHTML||"",b=f.textContent||"",v=p.closest(".block")?.dataset.blockId||null;return Mr={html:m,text:b,sourceBlockId:v},jt("clipboard.capture",{kind:d,hasHtml:!!m,length:b.length,blockId:v}),{range:y,target:p}};switch(o){case"cut":{if(!l("cut"))break;document.execCommand("cut");break}case"copy":l("copy"),document.execCommand("copy");break;case"select-all":{let d=i();if(!d||!document.contains(d))break;let p=document.createRange();p.selectNodeContents(d);let h=window.getSelection();h&&(h.removeAllRanges(),h.addRange(p)),Bt=p.cloneRange();break}case"paste":{let d=i();if(!d||!document.contains(d)){ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438");break}if(!Mr||!Mr.html&&!Mr.text){ve("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0441\u043A\u043E\u043F\u0438\u0440\u0443\u0439\u0442\u0435 \u0438\u043B\u0438 \u0432\u044B\u0440\u0435\u0436\u044C\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u0432 \u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440\u0435");break}n();let p=window.getSelection(),h=null;if(Bt&&d.contains(Bt.commonAncestorContainer))h=Bt.cloneRange();else if(p&&p.rangeCount>0){let m=p.getRangeAt(0);d.contains(m.commonAncestorContainer)&&(h=m.cloneRange())}h||(h=document.createRange(),h.selectNodeContents(d),h.collapse(!1));let y=Mr.html||zt(Mr.text).replace(/\n/g,"<br />"),S=document.createElement("div");S.innerHTML=y;let f=document.createDocumentFragment();for(;S.firstChild;)f.appendChild(S.firstChild);h.deleteContents(),h.insertNode(f),h.collapse(!1),p&&(p.removeAllRanges(),p.addRange(h)),d.focus({preventScroll:!0}),d.classList.remove("block-body--empty");break}case"bold":document.execCommand("bold");break;case"italic":document.execCommand("italic");break;case"underline":document.execCommand("underline");break;case"ul":s("ul");break;case"ol":s("ol");break;case"quote":document.execCommand("formatBlock",!1,"blockquote");break;case"code":document.execCommand("formatBlock",!1,"pre");break;case"link":{let d=window.getSelection(),p=d?d.toString():"",h=d?.anchorNode,y=h?h.parentElement?.closest("a"):null,S=y?.getAttribute("href")||"",f=await Oi({title:"\u0421\u0441\u044B\u043B\u043A\u0430",textLabel:"\u0422\u0435\u043A\u0441\u0442",urlLabel:"\u0421\u0441\u044B\u043B\u043A\u0430",defaultText:p||y?.textContent||"",defaultUrl:S,confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"});if(jt("link action: prompt result",{hasResult:!!f,url:f?.url,text:f?.text}),!f||!f.url)break;let m=f.url.match(/^[a-z]+:/i)?f.url:`https://${f.url}`,b=f.text?.trim()||m;n();let x=i();if(jt("link action: target",{targetExists:!!x,inDom:!!(x&&document.contains(x)),className:x?.className}),!x||!document.contains(x))break;let v=window.getSelection(),L=null;Bt&&x.contains(Bt.commonAncestorContainer)?L=Bt.cloneRange():v&&v.rangeCount>0&&x.contains(v.getRangeAt(0).commonAncestorContainer)&&(L=v.getRangeAt(0).cloneRange()),L||(L=document.createRange(),L.selectNodeContents(x),L.collapse(!1)),jt("link action: range chosen",{usedSelectionRange:!!(v&&v.rangeCount>0&&x.contains(v.getRangeAt(0).commonAncestorContainer)),usedStoredRange:!!(Bt&&x.contains(Bt.commonAncestorContainer)),selectionRangeCollapsed:!!(v&&v.rangeCount>0&&v.getRangeAt(0).collapsed),rangeStartNode:L?.startContainer?.nodeName,rangeOffset:L?.startOffset,labelLength:(b||"").length,url:m});let R=document.createElement("a");R.href=m,R.target="_blank",R.rel="noopener noreferrer",R.textContent=b,L.deleteContents(),L.insertNode(R),L.setStartAfter(R),L.setEndAfter(R),jt("link action: inserted link",{outerHTML:R.outerHTML,parentClass:R.parentElement?.className,targetInner:x.innerHTML.slice(0,120)}),v&&(v.removeAllRanges(),v.addRange(L)),x.focus({preventScroll:!0}),x.classList.remove("block-body--empty");break}case"unlink":{let d=i();if(jt("unlink action: target",{targetExists:!!d,inDom:!!(d&&document.contains(d)),className:d?.className}),!d||!document.contains(d))break;let p=window.getSelection(),h=null;if(p&&p.rangeCount>0){let y=p.getRangeAt(0).commonAncestorContainer;h=y?.parentElement?.closest("a")||y?.closest?.("a")}if(!h&&Bt){let y=Bt.commonAncestorContainer;h=y?.parentElement?.closest("a")||y?.closest?.("a")}if(h||(h=d.querySelector("a")),h){let y=document.createTextNode(h.textContent||"");h.replaceWith(y)}else document.execCommand("unlink");break}case"remove-format":a();break;case"insert-article-link":c().finally(()=>{t()});return;case"split-at-caret":await Na();break;default:break}t()};return e.addEventListener("click",o=>{let i=o.target.closest("button[data-action]");if(!i)return;let s=i.dataset.action;r(s)}),document.addEventListener("click",o=>{e.classList.contains("hidden")||e.contains(o.target)||t()}),document.addEventListener("touchstart",o=>{e.classList.contains("hidden")||e.contains(o.target)||t()},{passive:!0}),document.addEventListener("keydown",o=>{o.code==="Escape"&&t()}),window.addEventListener("scroll",t,!0),Is=e,e}function ul(e){let t=Tf();t.classList.remove("hidden"),t.style.visibility="hidden",ml();let n=window.getSelection();n&&n.rangeCount>0?Bt=n.getRangeAt(0).cloneRange():ao?Bt=ao.cloneRange():Bt=null;let r=t.getBoundingClientRect(),o=22,i=12,s=e.clientX+14,c=e.clientY+o;c+r.height+i>window.innerHeight&&(c=Math.max(i,e.clientY-r.height-o));let a=Math.min(Math.max(s,i),window.innerWidth-r.width-i),l=Math.min(Math.max(c,i),window.innerHeight-r.height-i);t.style.left=`${a}px`,t.style.top=`${l}px`,t.style.visibility="visible"}function fl(e,t,n){let r=n||e;e.addEventListener("focusin",()=>{co=r}),e.addEventListener("contextmenu",s=>{u.mode!=="edit"||u.editingBlockId!==t||(s.preventDefault(),Lr=r,ul(s))});let o=null;e.addEventListener("touchstart",s=>{if(u.mode!=="edit"||u.editingBlockId!==t||s.touches.length!==1)return;let c=s.touches[0];o=window.setTimeout(()=>{Lr=r,ul({clientX:c.clientX,clientY:c.clientY})},500)},{passive:!0});let i=()=>{o!==null&&(clearTimeout(o),o=null)};e.addEventListener("touchend",i,{passive:!0}),e.addEventListener("touchcancel",i,{passive:!0})}async function ns(e){if(!e)return;let t=ut(e);if(!t)return;let n=(t.ancestors||[]).filter(r=>r.collapsed);for(let r of n)await ti(r.id,!1)}var xf,Is,Bt,Lr,co,Mr,ao,dl,vn=We(()=>{wt();Yt();Vt();cr();An();Jn();Yt();jn();jn();is();Za();bs();rl();Ss();cl();ll();xf=16;Is=null,Bt=null,Lr=null,co=null,Mr={html:"",text:"",sourceBlockId:null},ao=null,dl=!1;sl()});function Bf(){let e=u?.currentUser||null;return e&&(e.id||e.username)||"anon"}async function ni(){return Ao({userKey:Bf()})}async function hl(e={}){let t=String(e?.token||"").trim(),n=String(e?.articleId||"").trim();if(!t||!n)return!1;let r=String(e?.kind||"image"),o=e?.blob||null,i=String(e?.mime||o&&o.type||"").trim(),s=String(e?.fileName||"").trim()||null,c=Date.now(),l=(await ni()).transaction(["pending_uploads"],"readwrite"),d=l.objectStore("pending_uploads"),p=await _e(d.get(t)).catch(()=>null),h=Number(p?.createdAtMs||e?.createdAtMs||c)||c,y={token:t,articleId:n,kind:r,blob:o,mime:i,fileName:s,status:String(e?.status||p?.status||"pending"),errorMessage:String(e?.errorMessage||p?.errorMessage||""),createdAtMs:h,updatedAtMs:c};return await _e(d.put(y)),await et(l),!0}async function vs(e){let t=String(e||"").trim();if(!t)return!1;let r=(await ni()).transaction(["pending_uploads"],"readwrite"),o=r.objectStore("pending_uploads");return await _e(o.delete(t)),await et(r),!0}async function Es(e,t){let n=String(e||"").trim();if(!n)return!1;let o=(await ni()).transaction(["pending_uploads"],"readwrite"),i=o.objectStore("pending_uploads"),s=await _e(i.get(n)).catch(()=>null);return s?(s.status="error",s.errorMessage=String(t||"error"),s.updatedAtMs=Date.now(),await _e(i.put(s)),await et(o),!0):(await et(o),!1)}async function Cs({articleId:e=null,limit:t=50}={}){let r=(await ni()).transaction(["pending_uploads"],"readonly"),o=r.objectStore("pending_uploads"),i=[];try{let s=Number(t||0)||0;if(e){let c=o.index("byArticleId");i=await _e(c.getAll(String(e),s>0?s:void 0))}else i=await _e(o.getAll(s>0?s:void 0))}catch{i=[]}return await et(r),Array.isArray(i)?(i.sort((s,c)=>Number(s?.createdAtMs||0)-Number(c?.createdAtMs||0)),i):[]}var gl=We(()=>{wt();Ii();xn()});var ri,yl=We(()=>{ri=["pending-attachment","app","disk"]});function Ts(e){let n=String(e||"").replace(/\r\n/g,`
`).split(`
`),r=a=>{let l=String(a||"").match(/^(#{1,6})\s+(.*)$/);if(!l)return null;let d=String(l[2]||"").trim();return d?{level:l[1].length,title:d}:null},o=!1;try{let a=n.find(l=>String(l||"").trim().length>0)||"";o=!!r(a)}catch{o=!1}let i=[],s=null,c=()=>{if(s){try{for(;s.bodyLines.length&&!String(s.bodyLines[0]||"").trim();)s.bodyLines.shift()}catch{}s.bodyText=s.bodyLines.join(`
`).trimEnd(),delete s.bodyLines,i.push(s),s=null}};for(let a of n){let l=r(a);if(l){c(),s={level:l.level,title:l.title,bodyLines:[]};continue}s&&s.bodyLines.push(a)}return c(),{sections:i,startsWithHeading:o,headingCount:i.length}}function bl(e,t={}){let n=Array.isArray(e)?e.filter(Boolean):[],r=typeof t.makeId=="function"?t.makeId:()=>`${Date.now()}-${Math.random()}`;if(!n.length)return[];let o=Number.isFinite(t.baseLevel)?t.baseLevel:Number(n[0].level||1),i=[],s=[];for(let c of n){let a=Number(c.level||1),l=String(c.title||"").trim(),d=String(c.bodyText||"").trimEnd();if(!l)continue;let p=Math.max(0,a-o);for(;s.length>p;)s.pop();p>s.length&&(p=s.length);let h={id:r(),title:l,bodyText:d,children:[]},y=p>0?s[p-1]:null;y?y.children.push(h):i.push(h),s.push(h)}return i}var wl=We(()=>{});var Ps={};So(Ps,{flushOutboxOnce:()=>Pr,getBackgroundFullPullStatus:()=>Ff,startBackgroundFullPull:()=>Yf,startSyncLoop:()=>Wf,tryPullBootstrap:()=>Uf});function Nf(e,t=null){try{if(!e)return;let n=window.localStorage.getItem(oi)||"";if(!n)return;let r=JSON.parse(n);if(!r||typeof r!="object")return;let o=String(e),i=r[o]||null;if(!i)return;let s=Number(i?.queuedAt||0)||0,c=typeof t=="number"&&Number.isFinite(t)?t:null;if(c!=null&&s>c)return;delete r[o],window.localStorage.setItem(oi,JSON.stringify(r))}catch{}}function Pf(e,t){try{let n=e&&typeof e=="object"?e:{type:"doc",content:[]},r=Array.isArray(n.content)?n.content:[],o=new Map,i=d=>{if(Array.isArray(d))for(let p of d){if(!p||typeof p!="object"||p.type!=="outlineSection")continue;let h=String(p?.attrs?.id||"").trim();h&&o.set(h,p);let S=(Array.isArray(p.content)?p.content:[]).find(f=>f&&typeof f=="object"&&f.type==="outlineChildren")||null;S&&Array.isArray(S.content)&&i(S.content)}};i(r);let s=(d,p)=>{let h=d&&typeof d=="object"?d:{type:"outlineSection",attrs:{id:p,collapsed:!1},content:[]};h.type="outlineSection";let y=h.attrs&&typeof h.attrs=="object"?h.attrs:{};y.id=p,h.attrs=y;let S=Array.isArray(h.content)?h.content:[],f=S.find(x=>x&&typeof x=="object"&&x.type==="outlineHeading")||{type:"outlineHeading",content:[]},m=S.find(x=>x&&typeof x=="object"&&x.type==="outlineBody")||{type:"outlineBody",content:[{type:"paragraph"}]},b=S.find(x=>x&&typeof x=="object"&&x.type==="outlineChildren")||{type:"outlineChildren",content:[]};return Array.isArray(b.content)||(b={...b,content:[]}),h.content=[f,m,b],h},c=new Set,a=new Map;for(let d of Array.isArray(t)?t:[]){let p=String(d?.sectionId||"").trim();if(!p)continue;let h=d?.parentId,y=h!=null&&String(h).trim()?String(h).trim():null,S=Number.isFinite(Number(d?.position))?Number(d.position):0,f=!!d?.collapsed,m=s(o.get(p),p);m.attrs={...m.attrs||{},id:p,collapsed:f},o.set(p,m),c.add(p),a.has(y)||a.set(y,[]),a.get(y).push({pos:S,sid:p,sec:m})}for(let[d,p]of a.entries())p.sort((h,y)=>h.pos-y.pos||String(h.sid).localeCompare(String(y.sid))),a.set(d,p);for(let[d,p]of o.entries()){let y=(a.get(d)||[]).map(S=>S.sec);try{Array.isArray(p.content)||(p.content=[]),(!p.content[2]||p.content[2].type!=="outlineChildren")&&(p.content[2]={type:"outlineChildren",content:[]}),p.content[2].content=y}catch{}}let l=(a.get(null)||[]).map(d=>d.sec);for(let[d,p]of o.entries())c.has(d)||l.push(p);return n.type="doc",n.content=l,n}catch{return e}}function _f(e,t,n,r){try{let o=String(t||"").trim();if(!o)return e;let i=e&&typeof e=="object"?e:{type:"doc",content:[]},s=[i];for(;s.length;){let c=s.pop();if(!c||typeof c!="object")continue;if(c.type==="outlineSection"&&String(c?.attrs?.id||"").trim()===o){let d=(Array.isArray(c.content)?c.content:[]).find(p=>p&&typeof p=="object"&&p.type==="outlineChildren")||{type:"outlineChildren",content:[]};return c.content=[n,r,d],i}let a=c.content;if(Array.isArray(a))for(let l of a)s.push(l)}return i}catch{return e}}function Ls(e){let t=e?.type||"";return t==="section_upsert_content"||t==="delete_sections"||t==="structure_snapshot"}function Df(e,t,n){try{let r=String(e||"").trim(),o=String(t||"").trim(),i=Number(n);if(!r||!o||!Number.isFinite(i)||i<=0)return;let s="ttree_outline_section_seq_v1",c=window.localStorage.getItem(s)||"",a=c?JSON.parse(c):{},l=a&&typeof a=="object"?a:{},d=(l[r]&&typeof l[r]=="object"?l[r]:{})||{};if((Number(d[o]||0)||0)>=i)return;d[o]=i,l[r]=d,window.localStorage.setItem(s,JSON.stringify(l))}catch{}}function Of(e){let t=[],n=(i,s)=>{if(!Array.isArray(i))return;let c=0;for(let a of i){if(!a||typeof a!="object"||a.type!=="outlineSection")continue;let l=String(a?.attrs?.id||"").trim();if(!l)continue;t.push({sectionId:l,parentId:s||null,position:c,collapsed:!!a?.attrs?.collapsed}),c+=1;let p=(Array.isArray(a.content)?a.content:[]).find(y=>y&&typeof y=="object"&&y.type==="outlineChildren")||null,h=p&&Array.isArray(p.content)?p.content:[];n(h,l)}},r=e&&typeof e=="object"?e:null,o=r&&Array.isArray(r.content)?r.content:[];return n(o,null),t}function Rf(e,t){try{let n=e&&typeof e=="object"?{...e}:null;if(!n||n.type!=="outlineHeading")return e;let r=String(t||"");if(!r)return e;let o=Array.isArray(n.content)?[...n.content]:[];return o.unshift({type:"text",text:r}),n.content=o,n}catch{return e}}function Hf(e,t,n){let r=e&&typeof e=="object"?e:{type:"doc",content:[]};Array.isArray(r.content)||(r.content=[]);let o=String(t||"").trim(),i=c=>{for(let a=0;a<c.length;a+=1){let l=c[a];if(!l||typeof l!="object"||l.type!=="outlineSection")continue;let d=String(l?.attrs?.id||"").trim();if(o&&d===o)return c.splice(a+1,0,n),!0;let h=(Array.isArray(l.content)?l.content:[]).find(y=>y&&typeof y=="object"&&y.type==="outlineChildren")||null;if(h&&Array.isArray(h.content)&&i(h.content))return!0}return!1};return i(r.content)||r.content.push(n),r}function $f(){try{return window?.localStorage?.getItem?.("ttree_debug_offline_v1")==="1"}catch{return!1}}function kl(...e){try{if(!$f())return;console.log("[offline][queue]",...e)}catch{}}function El(){try{let e=window.localStorage.getItem(oi)||"";if(!e)return{changed:!1,removed:0};let t=JSON.parse(e);if(!t||typeof t!="object")return{changed:!1,removed:0};let n=Object.keys(t);if(!n.length)return{changed:!1,removed:0};let r=0;for(let o of n)o!=="inbox"&&(delete t[o],r+=1);return r?(window.localStorage.setItem(oi,JSON.stringify(t)),kl("prune.queue",{removed:r}),{changed:!0,removed:r}):{changed:!1,removed:0}}catch(e){return kl("prune.queue.error",{message:e?.message||String(e||"error")}),{changed:!1,removed:0}}}function Qn(){try{window.dispatchEvent(new CustomEvent("offline-full-pull-status",{detail:{...kt}}))}catch{}}function Ff(){return{...kt}}async function Zt(e,t={}){let n=await fetch(e,{headers:{"Content-Type":"application/json",...t.headers||{}},credentials:"include",...t});if(!n.ok){let r=await n.json().catch(()=>({})),o=new Error(r.detail||"Request failed");throw o.status=n.status,o.details=r,o.path=e,o}return n.status===204?null:n.json()}function vl(e){let t=Number(e?.status||0);return!t||t>=500||t===408||t===429||t===401||t===403}function zf(e,t){let n=Number(e?.status||0);return n===404||n===410?!0:n>=400&&n<500&&n!==401&&n!==403&&n!==408&&n!==429?t?.type==="save_doc_json"||String(t?.type||"").startsWith("section_")||t?.type==="structure_snapshot"||t?.type==="delete_sections":!1}async function Uf(){try{let e=await fn();return Nn(e).catch(()=>{}),Array.isArray(e)?e:[]}catch{return null}}function qf(e,t){try{let n=new Set((Array.isArray(t)?t:[]).map(i=>String(i||"").trim()).filter(Boolean));if(!n.size)return e;let r=e&&typeof e=="object"?e:{type:"doc",content:[]},o=i=>{if(!Array.isArray(i))return[];let s=[];for(let c of i)if(!(!c||typeof c!="object")){if(c.type==="outlineSection"){let a=String(c?.attrs?.id||"").trim();if(a&&n.has(a))continue;let d=(Array.isArray(c.content)?c.content:[]).find(p=>p&&typeof p=="object"&&p.type==="outlineChildren")||null;d&&Array.isArray(d.content)&&(d.content=o(d.content))}s.push(c)}return s};return Array.isArray(r.content)?r.content=o(r.content):r.content=[],r.type=r.type||"doc",r}catch{return e}}async function Vf(e){if(e.type==="create_article"){let t=e.payload?.title||"\u041D\u043E\u0432\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F",n=e.payload?.id||e.articleId,r=await Zt("/api/articles",{method:"POST",body:JSON.stringify({title:t,id:n})});await kr(r);return}if(e.type==="save_doc_json"){let t=e.payload?.docJson||null;if(!t||typeof t!="object")return;let n=await Zt(`/api/articles/${encodeURIComponent(e.articleId)}/doc-json/save`,{method:"PUT",body:JSON.stringify({docJson:t,createVersionIfStaleHours:12})}),r=n?.updatedAt||null;await sn(e.articleId,t,r);try{ot("sync.flush.save_doc_json.ok",{articleId:e.articleId,opId:e.id,updatedAt:r,docHash:Pt(t)})}catch{}try{let o=Array.isArray(n?.changedBlockIds)?n.changedBlockIds:[],i=Array.isArray(n?.removedBlockIds)?n.removedBlockIds:[];if(i.length&&await To(i),o.length){let s=await Zt(`/api/articles/${encodeURIComponent(e.articleId)}/embeddings?ids=${encodeURIComponent(o.join(","))}`);await Li(e.articleId,s?.embeddings||[])}}catch{}return}if(e.type==="section_upsert_content"){let t=e.payload?.sectionId||null,n=e.payload?.headingJson||null,r=e.payload?.bodyJson||null,o=e.payload?.seq||null;if(!t||!n||!r||!o)return;let i=await Zt(`/api/articles/${encodeURIComponent(e.articleId)}/sections/upsert-content`,{method:"PUT",body:JSON.stringify({opId:e.payload?.opId||e.id,sectionId:t,headingJson:n,bodyJson:r,seq:o,createVersionIfStaleHours:12})});try{if(i?.updatedAt){let s=await Mn(e.articleId).catch(()=>null),c=s?.docJson&&typeof s.docJson=="object"?s.docJson:null;if(c){let a=_f(c,t,n,r);await sn(e.articleId,a,i.updatedAt)}}try{ot("sync.flush.section_upsert_content.ok",{articleId:e.articleId,opId:e.id,sectionId:t,updatedAt:i?.updatedAt||null})}catch{}}catch{}return}if(e.type==="structure_snapshot"){let t=e.payload?.nodes||null;if(!Array.isArray(t)||!t.length)return;let n=await Zt(`/api/articles/${encodeURIComponent(e.articleId)}/structure/snapshot`,{method:"PUT",body:JSON.stringify({opId:e.payload?.opId||e.id,nodes:t})});try{if(n?.updatedAt){let r=await Mn(e.articleId).catch(()=>null),o=r?.docJson&&typeof r.docJson=="object"?r.docJson:null;if(o){let i=Pf(o,t);await sn(e.articleId,i,n.updatedAt)}}try{ot("sync.flush.structure_snapshot.ok",{articleId:e.articleId,opId:e.id,updatedAt:n?.updatedAt||null,nodesCount:Array.isArray(t)?t.length:null})}catch{}}catch{}return}if(e.type==="delete_sections"){let t=Array.isArray(e.payload?.sectionIds)?e.payload.sectionIds:[];if(!t.length)return;let n=await Fc(e.articleId,t,{opId:e.payload?.opId||e.id});try{let r=n?.updatedAt||null,o=await Mn(e.articleId).catch(()=>null),i=o?.docJson&&typeof o.docJson=="object"?o.docJson:null;if(i&&r){let c=qf(i,t);await sn(e.articleId,c,r)}let s=Array.isArray(n?.removedBlockIds)?n.removedBlockIds:[];s.length&&await To(s),ot("sync.flush.delete_sections.ok",{articleId:e.articleId,opId:e.id,updatedAt:r||null,sectionIdsCount:t.length,removedCount:s.length})}catch{}return}if(e.type==="move_article_position"){let t=e.payload?.direction||null;if(!t)return;await Zt(`/api/articles/${encodeURIComponent(e.articleId)}/move`,{method:"POST",body:JSON.stringify({direction:t})});return}if(e.type==="indent_article"){await Zt(`/api/articles/${encodeURIComponent(e.articleId)}/indent`,{method:"POST",body:JSON.stringify({})});return}if(e.type==="outdent_article"){await Zt(`/api/articles/${encodeURIComponent(e.articleId)}/outdent`,{method:"POST",body:JSON.stringify({})});return}if(e.type==="move_article_tree"){await Zt(`/api/articles/${encodeURIComponent(e.articleId)}/move-tree`,{method:"POST",body:JSON.stringify(e.payload||{})});return}}async function Jf(e){try{if(!e||!e.articleId||!(e.type==="save_doc_json"||e.type==="section_upsert_content"||e.type==="structure_snapshot"||e.type==="delete_sections"))return;let n=e.payload?.clientQueuedAt??null;if(typeof n!="number"||!Number.isFinite(n)||(await sr(500)||[]).some(i=>i&&i.articleId===e.articleId&&(i.type==="save_doc_json"||i.type==="section_upsert_content"||i.type==="structure_snapshot")&&(i.payload?.clientQueuedAt??null)===n))return;Nf(e.articleId,n)}catch{}}async function jf(e,t){let n=String(e||"").trim();if(n)for(let r of t||[])try{let o=String(r?.sectionId||"").trim(),i=r?.headingJson||null,s=r?.bodyJson||null;if(!o||!i||!s)continue;let c=globalThis.crypto?.randomUUID?.()||`conflict-${Date.now()}-${Math.random().toString(16).slice(2)}`,a=await Mn(n).catch(()=>null),l=a?.docJson&&typeof a.docJson=="object"?a.docJson:null,d=Rf(i,"\u041A\u043E\u043D\u0444\u043B\u0438\u043A\u0442\u043D\u0430\u044F \u043A\u043E\u043F\u0438\u044F: "),h=Hf(l||{type:"doc",content:[]},o,{type:"outlineSection",attrs:{id:c,collapsed:!1,isConflictCopy:!0},content:[d||{type:"outlineHeading",content:[]},s||{type:"outlineBody",content:[{type:"paragraph"}]},{type:"outlineChildren",content:[]}]});await sn(n,h,a?.updatedAt||null).catch(()=>{}),Df(n,c,1);let y=Date.now();await Jt("section_upsert_content",{articleId:n,payload:{sectionId:c,headingJson:d,bodyJson:s,seq:1,clientQueuedAt:y},coalesceKey:`content:${n}:${c}`}).catch(()=>{});let S=Of(h);S.length&&await Jt("structure_snapshot",{articleId:n,payload:{nodes:S,clientQueuedAt:y},coalesceKey:`structure:${n}`}).catch(()=>{});try{window.dispatchEvent(new CustomEvent("outline-sync-conflict",{detail:{articleId:n,sectionId:o,conflictCopySectionId:c}}))}catch{}}catch{}}async function Kf(e,t){let n=String(e||"").trim();if(!n)return;let r=Date.now(),o=Number(Al.get(n)||0)||0;if(o&&r-o<Mf)return;Al.set(n,r);let i=async()=>{let f=await sr(200),m=[],b=[],x=[];for(let v of f||[])!v||String(v.articleId||"")!==n||(v.type==="delete_sections"?m.push(v):v.type==="section_upsert_content"?b.push(v):v.type==="structure_snapshot"&&x.push(v));return{deleteOps:m,upsertOps:b,structureOps:x}},s=0,c=[],a=[],l=[];try{({deleteOps:c,upsertOps:a,structureOps:l}=await i())}catch{c=[],a=[],l=[];for(let f of t||[])!f||String(f.articleId||"")!==n||(f.type==="delete_sections"?c.push(f):f.type==="section_upsert_content"?a.push(f):f.type==="structure_snapshot"&&l.push(f))}let d=new Set;for(let f of c){let m=Array.isArray(f.payload?.sectionIds)?f.payload.sectionIds:[];for(let b of m){let x=String(b||"").trim();x&&d.add(x)}}if(d.size&&a.length)for(let f of a)try{let m=String(f.payload?.sectionId||"").trim();m&&d.has(m)&&await qn(f.id)}catch{}let p=c.map(f=>{let m=Array.isArray(f.payload?.sectionIds)?f.payload.sectionIds:[];return{opId:f.payload?.opId||f.id,sectionIds:m.filter(Boolean).map(b=>String(b)),_outboxId:f.id}}).filter(f=>f.sectionIds.length),h=a.map(f=>{let m=String(f.payload?.sectionId||"").trim();return!m||d.has(m)?null:{opId:f.payload?.opId||f.id,sectionId:m,headingJson:f.payload?.headingJson||null,bodyJson:f.payload?.bodyJson||null,seq:f.payload?.seq||null,clientQueuedAt:f.payload?.clientQueuedAt??null,_outboxId:f.id}}).filter(Boolean),y=async()=>{let f=c.map(j=>{let $=Array.isArray(j.payload?.sectionIds)?j.payload.sectionIds:[];return{opId:j.payload?.opId||j.id,sectionIds:$.filter(Boolean).map(X=>String(X)),_outboxId:j.id}}).filter(j=>j.sectionIds.length),m=a.map(j=>{let $=String(j.payload?.sectionId||"").trim();return!$||d.has($)?null:{opId:j.payload?.opId||j.id,sectionId:$,headingJson:j.payload?.headingJson||null,bodyJson:j.payload?.bodyJson||null,seq:j.payload?.seq||null,clientQueuedAt:j.payload?.clientQueuedAt??null,_outboxId:j.id}}).filter(Boolean),b=new Map;for(let j of f)b.set(String(j.opId),j._outboxId);for(let j of m)b.set(String(j.opId),j._outboxId);if(!f.length&&!m.length)return!1;try{ot("sync.flush.outline_compact.start",{articleId:n,deletesCount:f.length,upsertsCount:m.length})}catch{}let x=await Zt(`/api/articles/${encodeURIComponent(n)}/sync/compact`,{method:"PUT",body:JSON.stringify({deletes:f.map(({opId:j,sectionIds:$})=>({opId:j,sectionIds:$})),upserts:m.map(({opId:j,sectionId:$,headingJson:X,bodyJson:W,seq:te})=>({opId:j,sectionId:$,headingJson:X,bodyJson:W,seq:te}))})}),v=x?.updatedAt||null;v&&await Bi(n,v).catch(()=>{});try{ot("sync.flush.outline_compact.ok",{articleId:n,updatedAt:v||null,deleteAcks:Array.isArray(x?.deleteAcks)?x.deleteAcks.length:null,upsertAcks:Array.isArray(x?.upsertAcks)?x.upsertAcks.length:null})}catch{}let L=Array.isArray(x?.deleteAcks)?x.deleteAcks:[];for(let j of L){let $=String(j?.opId||"").trim();if(!$)continue;let X=b.get($)||$;await qn(X).catch(()=>{});try{let W=Array.isArray(j?.removedBlockIds)?j.removedBlockIds:[];W.length&&await To(W)}catch{}}let R=[],q=Array.isArray(x?.upsertAcks)?x.upsertAcks:[];for(let j of q){let $=String(j?.opId||"").trim(),X=String(j?.sectionId||"").trim();if(!$||!X)continue;let W=b.get($)||$,te=String(j?.result||"").trim();if(te==="ok"||te==="duplicate")await qn(W).catch(()=>{});else if(te==="conflict"){await qn(W).catch(()=>{});let be=m.find(Oe=>String(Oe.opId)===$)||null;be&&R.push({sectionId:X,headingJson:be.headingJson,bodyJson:be.bodyJson})}}return R.length&&await jf(n,R),!0};for(;s<2&&(s+=1,!!await y());)try{({deleteOps:c,upsertOps:a,structureOps:l}=await i())}catch{break}let S=null;try{({deleteOps:c,upsertOps:a,structureOps:l}=await i())}catch{}if(!c.length&&!a.length&&(S=l.length?l[l.length-1]:null),S){try{let m=Number(Il.get(n)||0)||0,b=Date.now();if(m&&b-m<Lf)return}catch{}let f=S.payload?.nodes||null;if(Array.isArray(f)&&f.length){let m=await Mn(n).catch(()=>null),b=null;try{if(m&&Object.prototype.hasOwnProperty.call(m,"outlineStructureRev")){let R=Number(m.outlineStructureRev);Number.isFinite(R)&&R>=0&&(b=R)}}catch{b=null}try{ot("sync.flush.structure_snapshot.start",{articleId:n,opId:S.id,baseStructureRev:b,nodesCount:f.length})}catch{}let x=await Zt(`/api/articles/${encodeURIComponent(n)}/structure/snapshot`,{method:"PUT",body:JSON.stringify({opId:S.payload?.opId||S.id,nodes:f,...b!=null?{baseStructureRev:b}:{}})}),v=x?.updatedAt||null;v&&await Bi(n,v).catch(()=>{}),Number.isFinite(Number(x?.newStructureRev))?await Ni(n,Number(x.newStructureRev)):Number.isFinite(Number(x?.currentStructureRev))&&await Ni(n,Number(x.currentStructureRev));try{ot("sync.flush.structure_snapshot.done",{articleId:n,opId:S.id,status:String(x?.status||""),updatedAt:v||null,newStructureRev:Number.isFinite(Number(x?.newStructureRev))?Number(x.newStructureRev):null,currentStructureRev:Number.isFinite(Number(x?.currentStructureRev))?Number(x.currentStructureRev):null})}catch{}let L=String(x?.status||"");if(L==="ok"||L==="duplicate"){await qn(S.id).catch(()=>{});try{Il.set(n,Date.now())}catch{}}}}try{(await sr(200)||[]).some(b=>Ls(b)&&String(b.articleId||"")===n)||(await kc(n).catch(()=>{}),ot("sync.flush.localDraft.cleared",{articleId:n}))}catch{}}async function Pr(){if(Bs)return null;if(!navigator.onLine)return!1;Bs=!0;try{let e=await sr(200),t=new Set,n=[];for(let o of e||[]){if(!Ls(o))continue;let i=String(o.articleId||"").trim();!i||t.has(i)||(t.add(i),n.push(i))}for(let o of n)try{await Kf(o,e)}catch(i){if(vl(i))break}let r=await sr(50);for(let o of r)if(!Ls(o))try{await Vf(o),await qn(o.id);try{if(o.type==="section_upsert_content"&&String(o.articleId||"")==="inbox"){let i=String(o.payload?.sectionId||"").trim();i&&Ka(i)}}catch{}await Jf(o)}catch(i){let s=Number(i?.status||0)||null,c=s?`${s}: ${i?.message||"error"}`:i?.message||String(i||"error");if(await Cc(o.id,c),zf(i,o)){try{console.warn("[offline][outbox] drop op",{opId:o.id,type:o.type,articleId:o.articleId,status:s,message:i?.message||null})}catch{}try{await qn(o.id)}catch{}continue}if(vl(i))break;break}}finally{Bs=!1}try{let e=await sr(1);return Array.isArray(e)&&e.length>0}catch{return!0}}function lo(){ur||(ur=window.setInterval(async()=>{try{await Pr()===!1&&(window.clearInterval(ur),ur=null,El())}catch{}},15e3))}function Ms(){ur&&(window.clearInterval(ur),ur=null)}function Wf(){if(!Sl){Sl=!0,El();try{Sc()}catch{}window.addEventListener("online",()=>{Pr().then(e=>{e?lo():Ms()}).catch(()=>{})}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&Pr().then(e=>{e?lo():Ms()}).catch(()=>{})}),window.addEventListener("offline-outbox-changed",()=>{Pr().then(e=>{e?lo():Ms()}).catch(()=>{lo()})}),Pr().then(e=>{e&&lo()}).catch(()=>{})}}function Yf(e={}){let t=!!(e&&e.force);Ns||xl&&!t||(xl=!0,Ns=!0,kt={running:!0,processed:0,total:0,errors:0,phase:"index",lastError:null,startedAt:new Date().toISOString(),finishedAt:null},Qn(),(async()=>{try{if(!navigator.onLine){kt={...kt,running:!1,phase:"error",lastError:"offline",finishedAt:new Date().toISOString()},Qn();return}let n=new Map;try{let o=await Ac();n=new Map((o||[]).map(i=>[i.id,i]))}catch{}let r=[];try{Array.isArray(e?.initialIndex)?r=e.initialIndex:r=await Zt("/api/articles")||[],Nn(r).catch(()=>{})}catch(o){kt={...kt,running:!1,phase:"error",lastError:o?.message||String(o||"error"),finishedAt:new Date().toISOString()},Qn();return}kt={...kt,phase:"articles",total:Array.isArray(r)?r.length:0},Qn();for(let o of r||[]){try{let i=o.updatedAt||null,s=n.get(o.id);if(i&&s?.updatedAt===i&&s?.hasDocJson){try{let a=await Mn(o.id),l=a?.docJson&&typeof a.docJson=="object"?a.docJson:null;l&&Ar(o.id,l).catch(()=>{})}catch{}continue}let c=await Zt(`/api/articles/${encodeURIComponent(o.id)}`);await kr(c);try{let a=await Zt(`/api/articles/${encodeURIComponent(o.id)}/embeddings`);await Li(o.id,a?.embeddings||[])}catch{}}catch{kt={...kt,errors:Number(kt.errors||0)+1}}kt={...kt,processed:Number(kt.processed||0)+1},Qn(),await new Promise(i=>setTimeout(i,120))}try{kt={...kt,phase:"inbox"},Qn();let o=await Zt("/api/articles/inbox?include_history=0");await kr(o)}catch{kt={...kt,errors:Number(kt.errors||0)+1},Qn()}xc().catch(()=>{}),kt={...kt,running:!1,phase:"done",finishedAt:new Date().toISOString()},Qn()}finally{Ns=!1}})().catch(()=>{}))}var oi,Sl,Bs,xl,Ns,ur,Mf,Al,Lf,Il,kt,_s=We(()=>{Ur();qr();Pi();Ti();Yt();gs();zr();oi="ttree_outline_autosave_queue_docjson_v1";Sl=!1,Bs=!1,xl=!1,Ns=!1,ur=null,Mf=2e3,Al=new Map,Lf=3e3,Il=new Map;kt={running:!1,processed:0,total:0,errors:0,phase:"idle",lastError:null,startedAt:null,finishedAt:null}});var jo={};So(jo,{closeOutlineEditor:()=>gd,enterOutlineSectionEditMode:()=>Gp,flushOutlineAutosave:()=>nm,getOutlineActiveSectionId:()=>Jp,getOutlineActiveSectionSnapshot:()=>jp,insertNewOutlineSectionAtEnd:()=>Qp,insertNewOutlineSectionAtStart:()=>Zp,insertOutlineSectionFromPlainTextAtStart:()=>em,insertOutlineSectionFromSectionFragmentsAtEnd:()=>Xp,openOutlineEditor:()=>tm,openPublicOutlineViewer:()=>rm,restoreOutlineSectionFromBlockHtml:()=>Wp,restoreOutlineSectionFromSectionFragments:()=>Yp,revealOutlineSection:()=>hd});function js(e,t){let n=null,r=String(t||"").trim();return!e||!r?null:(e.descendants((o,i)=>{if(n!==null)return!1;o?.type?.name==="image"&&String(o.attrs?.uploadToken||"")===r&&(n=i)}),n)}function Kl(e){let t=String(e||"").trim();if(!t)return;let n=go.get(t)||null;if(n){go.delete(t);try{URL.revokeObjectURL(n)}catch{}}}function Gf(e){try{if(!e||typeof e!="object")return e;let t=typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e)),n=r=>{if(!r||typeof r!="object")return;if(r.type==="image"&&r.attrs&&typeof r.attrs=="object"){let i=String(r.attrs.uploadToken||"").trim(),s=String(r.attrs.src||"");i&&s.startsWith("blob:")&&(r.attrs={...r.attrs,src:`${Js}${i}`})}let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(t),t}catch{return e}}async function Zf(e){try{if(!ce||ce.isDestroyed)return;let t=String(e||"").trim();if(!t)return;let n=await Cs({articleId:t,limit:200}).catch(()=>[]);if(!n.length)return;let r=new Map;for(let a of n){let l=String(a?.token||"").trim();l&&(a?.kind&&String(a.kind)!=="image"||a?.blob&&r.set(l,a.blob))}if(!r.size)return;let{state:o,view:i}=ce,s=o.tr,c=!1;o.doc.descendants((a,l)=>{if(a?.type?.name!=="image")return;let d=String(a.attrs?.uploadToken||"").trim(),p=String(a.attrs?.src||""),h=p.startsWith(Js)?p.slice(Js.length).trim():"",y=d||h;if(!y)return;let S=r.get(y);if(!S)return;let f=go.get(y)||null;if(!f)try{f=URL.createObjectURL(S),go.set(y,f)}catch{f=null}if(!f)return;let m={...a.attrs,src:f,uploadToken:y};s=s.setNodeMarkup(l,void 0,m),c=!0}),c&&(s=s.setMeta(le,!0),i.dispatch(s))}catch{}}async function Wl(e){try{if(!navigator.onLine||!ce||ce.isDestroyed)return!1;let t=String(e||"").trim();if(!t)return!1;let n=await Cs({articleId:t,limit:50}).catch(()=>[]);if(!n.length)return!1;let r=!1;for(let o of n){let i=String(o?.token||"").trim();if(!i||o?.kind&&String(o.kind)!=="image")continue;let s=o?.blob||null;if(s)try{let c=s instanceof File?s:new File([s],o?.fileName||"image",{type:o?.mime||s.type||"application/octet-stream"}),a=await Jr(c),l=String(a?.url||"").trim();if(!l)throw new Error("Upload failed");try{let{state:d,view:p}=ce,h=js(d.doc,i);if(typeof h=="number"){let y=d.doc.nodeAt(h);if(y?.type?.name==="image"){let S={...y.attrs,src:l,uploadToken:null,title:String(y.attrs?.title||"").replace(/\s*\( \)\s*$/i,"").trim()},f=d.tr.setNodeMarkup(h,void 0,S);f=f.setMeta(le,!0),p.dispatch(f)}}}catch{}Kl(i),await vs(i).catch(()=>{}),r=!0}catch(c){let a=c?.message||String(c||"error");await Es(i,a).catch(()=>{})}}if(r)try{tn({delayMs:350})}catch{}return r}catch{return!1}}function Nl(){try{let e=window?.localStorage?.getItem?.(Vs)||"";if(!e)return null;let t=JSON.parse(e);return!t||typeof t!="object"||!Array.isArray(t.sections)?null:{mode:t.mode==="cut"?"cut":"copy",sourceArticleId:typeof t.sourceArticleId=="string"?t.sourceArticleId:null,createdAt:typeof t.createdAt=="string"?t.createdAt:null,sections:t.sections}}catch{return null}}function Rs(e){try{if(!e){window?.localStorage?.removeItem?.(Vs);return}window?.localStorage?.setItem?.(Vs,JSON.stringify(e))}catch{}}function po(e){Fn=!!e,Fn||(nr=new Set);try{V?.outlineEditor&&V.outlineEditor.classList.toggle("outline-select-mode",Fn)}catch{}try{Yl()}catch{}}function ep(e){let t=String(e||"").trim();if(t){nr.has(t)?nr.delete(t):nr.add(t);try{Yl()}catch{}}}function Yl(){if(!V?.outlineEditor)return;V.outlineEditor.querySelectorAll(".outline-heading[data-section-id] .outline-heading__select").forEach(t=>{let r=t.closest(".outline-heading")?.getAttribute?.("data-section-id")||"",o=r&&nr.has(r);t.setAttribute("aria-checked",o?"true":"false"),t.style.display=Fn?"inline-flex":"none"})}function tp(e,t){let n=t instanceof Set?t:new Set,r=[];if(!e||!n.size)return r;let o=(i,s)=>{let c=String(i?.attrs?.id||"").trim(),a=c&&n.has(c);if(a&&!s){r.push({id:c,node:i});return}let l=i?.childCount>=3?i.child(2):null;if(l)try{l.forEach(d=>{d?.type?.name==="outlineSection"&&o(d,s||a)})}catch{}};try{e.forEach(i=>{i?.type?.name==="outlineSection"&&o(i,!1)})}catch{}return r}function Xl(e){return JSON.parse(JSON.stringify(e))}function np(e,t){let n=Xl(e),r=o=>{if(!o||typeof o!="object")return;if(o.type==="outlineSection"){let s=t();o.attrs&&typeof o.attrs=="object"?o.attrs.id=s:o.attrs={id:s,collapsed:!!o.attrs?.collapsed}}let i=Array.isArray(o.content)?o.content:[];for(let s of i)r(s)};return r(n),n}async function rp(e){let t=String(e||"");if(t){try{if(navigator?.clipboard?.writeText){await navigator.clipboard.writeText(t);return}}catch{}try{let n=document.createElement("textarea");n.value=t,n.setAttribute("readonly","true"),n.style.position="fixed",n.style.left="-9999px",n.style.top="0",document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n)}catch{}}}function Ql(e,{baseLevel:t=2,depth:n=0}={}){let r=e;if(!r||r.type?.name!=="outlineSection")return"";let o="",i="";try{let a=r.child(0);o=String(a?.textContent||"").trim()}catch{o=""}try{let a=r.child(1);i=a?String(a.textBetween(0,a.content.size,`
`)).trimEnd():""}catch{i=""}let s=Math.min(6,Math.max(1,Number(t)+Number(n||0))),c=[];o&&c.push(`${"#".repeat(s)} ${o}`),i&&c.push(i);try{let a=r.child(2);if(a){let l=[];a.forEach(d=>{if(d?.type?.name!=="outlineSection")return;let p=Ql(d,{baseLevel:t,depth:n+1});p&&l.push(p)}),l.length&&c.push(l.join(`

`))}}catch{}return c.filter(Boolean).join(`

`).trim()}function Gl(e,t){try{let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return 1;let o=window.localStorage.getItem(Ml)||"",i=o?JSON.parse(o):{},s=i&&typeof i=="object"?i:{},c=(s[n]&&typeof s[n]=="object"?s[n]:{})||{},l=(Number(c[r]||0)||0)+1;return c[r]=l,s[n]=c,window.localStorage.setItem(Ml,JSON.stringify(s)),l}catch{return Date.now()}}function Zl(e,t){try{let n=JSON.stringify({headingJson:e,bodyJson:t});return globalThis.TextEncoder?new TextEncoder().encode(n).length:n.length*2}catch{return 0}}function _r(e){try{let t=String(e||"").trim();if(!t)return;mn.add(t);let n=St||u.articleId||null;if(!n||u.article?.encrypted||Hs)return;Hs=setTimeout(()=>{Hs=null;try{if(!mn.size)return;let r=Array.from(mn);mn.clear();let o=Date.now();Jt("delete_sections",{articleId:n,payload:{sectionIds:r,clientQueuedAt:o},coalesceKey:`delete:${n}`})}catch{}},0)}catch{}}function bo(e){let t=[],n=o=>{try{if(!o||o.type?.name!=="outlineSection")return null;for(let i=0;i<o.childCount;i+=1){let s=o.child(i);if(s?.type?.name==="outlineChildren")return s}return null}catch{return null}},r=(o,i)=>{try{if(!o)return;let s=0;o.forEach(c=>{if(!c||c.type?.name!=="outlineSection")return;let a=String(c.attrs?.id||"").trim();if(!a)return;t.push({sectionId:a,parentId:i||null,position:s,collapsed:!!c.attrs?.collapsed}),s+=1;let l=n(c);l&&r(l,a)})}catch{}};try{if(!e)return[];r(e,null)}catch{return[]}return t}function Ll(e){try{return bo(e).map(n=>`${n.parentId||""}|${n.position}|${n.sectionId}|${n.collapsed?1:0}`).join(`
`)}catch{return""}}function Dr(e){let t=[];try{if(!e)return t;e.descendants((n,r)=>{n?.type?.name==="outlineSection"&&t.push(r)})}catch{}return t}function Ks(e,t){try{if(!e||e.isDestroyed)return!1;let n=!!t;return e.commands.command(({state:r,dispatch:o})=>{let i=Dr(r.doc);if(!i.length)return!1;let s=r.tr;for(let c of i){let a=s.doc.nodeAt(c);!a||a.type?.name!=="outlineSection"||!!a.attrs?.collapsed!==n&&(s=s.setNodeMarkup(c,void 0,{...a.attrs,collapsed:n}))}s=s.setMeta(le,!0);try{n&&ke&&(ke.getState(r)||{}).editingSectionId&&(s=s.setMeta(ke,{type:"exit"}))}catch{}try{if(n&&TextSelection){let c=vt(r.doc,r.selection.$from),a=typeof c=="number"?c:i[0],l=s.doc.nodeAt(a);if(l?.type?.name==="outlineSection"){let d=l.child(0),h=a+1+d.nodeSize-1;s=s.setSelection(TextSelection.near(s.doc.resolve(h),-1))}}}catch{}return o(s.scrollIntoView()),!0})}catch{return!1}}function op({articleId:e,editor:t}={}){try{let n=String(e||"").trim();if(!n||!t)return;En=!0;try{if((ke?.getState?.(t.state)||null)?.editingSectionId){_t&&(clearTimeout(_t),_t=null);return}}catch{}_t&&clearTimeout(_t),_t=setTimeout(()=>{_t=null;try{if(!En)return;let r=t.state?.doc,o=bo(r);if(!o.length)return;try{let i=null;try{i=o.filter(s=>s&&(s.parentId==null||s.parentId==="")&&Number(s.position)>=0).sort((s,c)=>Number(s.position)-Number(c.position)).slice(0,3).map(s=>String(s.sectionId||""))}catch{i=null}ot("outline.enqueue.structure_snapshot",{articleId:n,nodesCount:o.length,rootFirst:i})}catch{}Jt("structure_snapshot",{articleId:n,payload:{nodes:o},coalesceKey:`structure:${n}`}),En=!1}catch{}},Xf)}catch{}}async function Gs({articleId:e,doc:t,sectionId:n,reason:r}){let o=String(e||"").trim(),i=String(n||"").trim();if(!o||!i||!t)return!1;let s=at(t,i),c=typeof s=="number"?t.nodeAt(s):null;if(!c||c.type?.name!=="outlineSection")return!1;try{if(!gr(t,i))return!1}catch{return!1}let a=c.child(0),l=c.child(1),d=a?.toJSON?a.toJSON():null,p=l?.toJSON?l.toJSON():null;if(!d||!p)return!1;let h=Zl(d,p);if(h>ui){let f=Date.now();return(!Ds||f-Ds>5e3)&&(Ds=f,ve(`\u0411\u043B\u043E\u043A \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 (${Math.ceil(h/1024)} KB). \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C: ${Math.ceil(ui/1024)} KB. \u0420\u0430\u0437\u0431\u0435\u0439\u0442\u0435 \u0431\u043B\u043E\u043A \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E.`)),!1}let y=Date.now(),S=Gl(o,i);try{ot("outline.enqueue.section_upsert_content",{articleId:o,sectionId:i,seq:S,bytes:h,reason:String(r||"")})}catch{}await Jt("section_upsert_content",{articleId:o,payload:{sectionId:i,headingJson:d,bodyJson:p,seq:S,clientQueuedAt:y},coalesceKey:`content:${o}:${i}`}).catch(()=>{});try{if(En){let f=bo(t);if(f.length){let m=null;try{m=f.filter(b=>b&&(b.parentId==null||b.parentId==="")&&Number(b.position)>=0).sort((b,x)=>Number(b.position)-Number(x.position)).slice(0,3).map(b=>String(b.sectionId||""))}catch{m=null}try{ot("outline.enqueue.structure_snapshot",{articleId:o,nodesCount:f.length,reason:"after_section_upsert",rootFirst:m})}catch{}Jt("structure_snapshot",{articleId:o,payload:{nodes:f},coalesceKey:`structure:${o}`})}En=!1,_t&&(clearTimeout(_t),_t=null)}}catch{}try{wr.set(i,yi(c)),er.delete(i)}catch{}try{Promise.resolve().then(()=>(_s(),Ps)).then(f=>f.flushOutboxOnce?.()).catch(()=>{})}catch{}return!0}function ip(e){try{if(!e||e.isDestroyed)return;let t=ke?.getState?.(e.state)||null,n=String(t?.editingSectionId||"").trim();if(!n)return;let r=St||u.articleId||null;if(!r)return;zs=n,mr&&clearTimeout(mr),mr=setTimeout(()=>{mr=null;try{if(!ce||ce.isDestroyed)return;let o=ke?.getState?.(ce.state)||null,i=String(o?.editingSectionId||"").trim();if(!i||i!==zs)return;Gs({articleId:r,doc:ce.state.doc,sectionId:i,reason:"edit_heartbeat"})}catch{}},Qf)}catch{}}function Ws(){try{return window?.localStorage?.getItem?.(sp)==="1"}catch{return!1}}function ln(...e){try{if(!Ws())return;console.log("[outline][md-table]",...e)}catch{}}function pr(){try{return window?.localStorage?.getItem?.(cp)==="1"}catch{return!1}}function Or(e,t={}){try{if(!pr())return;console.log("[perf][outline]",e,t)}catch{}}function lp(){try{return window?.localStorage?.getItem?.(ap)==="1"}catch{return!1}}function On(e,t={}){try{if(!lp())return;console.log("[outline][proofread]",e,t)}catch{}}function ed(e){let t=String(e||"").replace(/\s+/g," ").trim();return t?t.length>60?t.slice(0,60):t:null}function td(e){return String(e||"").replace(/\s+/g," ").trim().toUpperCase()}function dp(e,t="tag"){let n=new Map,r=new Map,o=new Map,i=new Map;return e?(e.descendants((s,c)=>{if(s?.type?.name!=="outlineSection")return;let a=String(s.attrs?.id||"");a&&i.set(a,c);let l=new Set,d=p=>{p?.descendants?.(h=>{if(h?.type?.name!==t)return;let y=ed(h.attrs?.label||h.textContent||"");if(!y)return;let S=td(h.attrs?.key||y);S&&(n.set(S,(n.get(S)||0)+1),r.set(S,S),l.add(S))})};try{d(s.child(0)),d(s.child(1))}catch{}if(a)for(let p of l)o.has(p)||o.set(p,new Set),o.get(p).add(a);return!1}),{counts:n,labelByKey:r,sectionIdsByKey:o,sectionPosById:i}):{counts:n,labelByKey:r,sectionIdsByKey:o,sectionPosById:i}}function nd(){let e=V?.outlineTagsBar;if(!e)return;let t=Array.from(Sr.counts.entries()).map(([n,r])=>({key:n,label:Sr.labelByKey.get(n)||n,count:r})).filter(n=>n.key&&n.count>0).sort((n,r)=>r.count!==n.count?r.count-n.count:n.label.localeCompare(r.label));if(!t.length){e.innerHTML="",e.classList.add("hidden");return}e.classList.remove("hidden"),e.innerHTML=t.map(n=>{let r=tr&&tr===n.key?"true":"false",o=Jl(n.label);return`<button type="button" class="outline-tag-pill" data-tag-key="${Jl(n.key)}" aria-pressed="${r}">${o} <span class="outline-tag-pill__count">(${n.count})</span></button>`}).join("")}function rd(){if(ce){if(Sr=dp(ce.state.doc,"tag"),tr&&!Sr.counts.has(tr)){tr=null;try{pi?.(null)}catch{}}nd()}}function up(e){let t=String(e||"");if(!t||!ce)return;let n=Sr.sectionIdsByKey.get(t);if(!n||!n.size)return;let r=new Set;for(let s of n){let c=Sr.sectionPosById.get(s);if(typeof c=="number"){r.add(c);try{let a=ce.state.doc.resolve(Math.min(ce.state.doc.content.size,c+1));for(let l=a.depth;l>0;l-=1)a.node(l)?.type?.name==="outlineSection"&&r.add(a.before(l))}catch{}}}let o=ce.state.tr,i=!1;for(let s of r){let c=o.doc.nodeAt(s);!c||c.type?.name!=="outlineSection"||c.attrs?.collapsed&&(o=o.setNodeMarkup(s,void 0,{...c.attrs,collapsed:!1}),i=!0)}i&&(o=o.setMeta(le,!0),ce.view.dispatch(o))}function fp({setActiveTagKey:e}){let t=V?.outlineTagsBar;if(!t)return()=>{};let n=r=>{let o=r.target?.closest?.("[data-tag-key]");if(!o)return;let i=String(o.getAttribute("data-tag-key")||"");if(!i)return;let s=tr===i?null:i;tr=s;try{e(s)}catch{}s&&up(s),nd()};return t.addEventListener("click",n),()=>t.removeEventListener("click",n)}function dn(e){let t=String(e||"").trim();if(!t.includes("|"))return null;let n=t;n.startsWith("|")&&(n=n.slice(1)),n.endsWith("|")&&(n=n.slice(0,-1));let r=n.split("|").map(o=>o.trim());return r.length<2||r.every(o=>!o)?null:r}function mi(e){let t=String(e||"").trim();return t?/^:?-{3,}:?$/.test(t):!1}function yr(e){let t=(Array.isArray(e)?e:[]).map(i=>String(i||"").replace(/\r/g,"").trimEnd()).filter(i=>i.length>0);if(t.length<2)return null;let n=dn(t[0]),r=dn(t[1]);if(!n||!r||n.length!==r.length||!r.every(mi))return null;let o=[];for(let i=2;i<t.length;i+=1){let s=dn(t[i]);if(!s||s.length!==n.length)return null;o.push(s)}return{header:n,rows:o}}function br(e){let t=(Array.isArray(e)?e:[]).map(s=>String(s||"").replace(/\r/g,"").trimEnd()).filter(s=>s.length>0);if(t.length<1)return null;let n=dn(t[0]);if(!n)return null;let r=n.length;if(r<2)return null;let o=[n];for(let s=1;s<t.length;s+=1){let c=dn(t[s]);if(!c||c.length!==r)break;if(s===1&&c.every(mi))return null;o.push(c)}return o.flat().filter(s=>String(s||"").trim().length>0).length<2?null:{rows:o}}function Zs(e){let t=String(e||"").replace(/\r/g,"").split(`
`).map(n=>String(n||"").trimEnd());for(;t.length&&!t[0].trim();)t.shift();for(;t.length&&!t[t.length-1].trim();)t.pop();return t}function Gn(e,t){if(!e||!t)return null;let{header:n,rows:r,withHeader:o}=t,i=e.nodes.table,s=e.nodes.tableRow,c=e.nodes.tableCell,a=e.nodes.tableHeader,l=e.nodes.paragraph;if(!i||!s||!c||!a||!l||typeof e.text!="function")return null;let d=S=>l.create({},S?[e.text(String(S))]:[]),p=(S,f)=>S.map(m=>(f?a:c).create({},[d(m)])),h=(S,f)=>s.create({},p(S,f)),y=[];return o&&Array.isArray(n)&&n.length&&y.push(h(n,!0)),(Array.isArray(r)?r:[]).forEach(S=>y.push(h(S,!1))),y.length?i.create({},y):null}function pp(e,t){try{let n=e?.selection,r=n?.$from;if(!n?.empty||!r)return Ye("table.merge.skip",{reason:"no-cursor"}),!1;if(r.parent?.type?.name!=="paragraph")return!1;if(r.parentOffset!==0)return Ye("table.merge.skip",{reason:"not-at-paragraph-start"}),!1;let o=null,i=null,s=null;for(let re=r.depth;re>0;re-=1){let he=r.node(re)?.type?.name;if(!s&&(he==="tableCell"||he==="tableHeader")?s=re:!i&&he==="tableRow"?i=re:!o&&he==="table"&&(o=re),o&&i&&s)break}if(o==null||i==null||s==null)return Ye("table.merge.skip",{reason:"not-in-table"}),!1;let c=r.depth===s+1,a=r.index(o),l=r.index(i),d=r.index(s);if(Ye("table.merge.check",{parent:r.parent?.type?.name||null,parentOffset:r.parentOffset,tableDepth:o,rowDepth:i,cellDepth:s,isDirectParagraphInCell:c,rowIndex:a,colIndex:l,childIndexInCell:d}),!c)return Ye("table.merge.skip",{reason:"paragraph-not-direct-child-of-cell"}),!1;if(a!==0||l!==0||d!==0)return Ye("table.merge.skip",{reason:"not-in-first-cell",rowIndex:a,colIndex:l,childIndexInCell:d}),!1;let p=r.before(o),h=e.doc.nodeAt(p);if(!h||h.type?.name!=="table")return Ye("table.merge.skip",{reason:"no-current-table",tablePos:p}),!1;let y=e.doc.resolve(p),S=y.index(),f=y.parent;if(!f||S<=0)return Ye("table.merge.skip",{reason:"no-prev-sibling",idx:S,parent:f?.type?.name||null}),!1;let m=null,b=S-1;for(;b>=0;){let re=f.child(b);if(re?.type?.name==="paragraph"&&!String(re.textContent||"").trim()){b-=1;continue}m=re;break}if(!m||m.type?.name!=="table")return Ye("table.merge.skip",{reason:"no-prev-table"}),!1;let x=m.childCount?m.child(0):null,v=h.childCount?h.child(0):null;if(!x||!v)return Ye("table.merge.skip",{reason:"missing-rows"}),!1;if(x.childCount!==v.childCount)return Ye("table.merge.skip",{reason:"different-columns",prevCols:x.childCount,curCols:v.childCount}),!1;let L=x.childCount,R=(re,he)=>{try{return re?.type?.name==="tableRow"&&re.childCount===he}catch{return!1}};for(let re=0;re<m.childCount;re+=1){let he=m.child(re);if(!R(he,L))return Ye("table.merge.skip",{reason:"prev-row-mismatch",rowIndex:re,colsExpected:L,colsGot:he?.childCount??null}),!1}for(let re=0;re<h.childCount;re+=1){let he=h.child(re);if(!R(he,L))return Ye("table.merge.skip",{reason:"cur-row-mismatch",rowIndex:re,colsExpected:L,colsGot:he?.childCount??null}),!1}let q=p;for(let re=S-1;re>=b;re-=1)q-=f.child(re).nodeSize;let j=m.childCount,$=e.doc.type.schema,X=q+m.nodeSize,W=e.tr;p>X&&(W=W.delete(X,p));let te=X;W=W.delete(te,te+h.nodeSize);let be=W.doc.nodeAt(q);if(!be||be.type?.name!=="table")return Ye("table.merge.skip",{reason:"prev-after-missing",prevStart:q,prevAfterType:be?.type?.name||null}),!1;Ye("table.merge.plan",{idx:S,prevIdx:b,prevStart:q,prevEnd:X,tablePos:p,tablePos2:te,cols:L,prevRowCount:j,curRowCount:h.childCount});try{let re=be.content.append(h.content),he=$.nodes.table.create(be.attrs,re,be.marks);W=W.replaceWith(q,q+be.nodeSize,he)}catch(re){return Ye("table.merge.error",{message:String(re?.message||re||""),stack:String(re?.stack||"")}),!1}let Oe=W.doc.nodeAt(q);Ye("table.merge.afterReplace",{mergedType:Oe?.type?.name||null,mergedRows:Oe?.type?.name==="table"?Oe.childCount:null});try{let re=ze?.pmStateMod?.TextSelection||ze?.pm?.state?.TextSelection||null;if(Oe&&Oe.type?.name==="table"){let he=Math.min(j,Math.max(0,Oe.childCount-1));if(Oe.child(he)?.childCount){let yt=(()=>{let qt=q+1;for(let Wt=0;Wt<he;Wt+=1)qt+=Oe.child(Wt).nodeSize;return qt+=1,qt})(),Et=Math.min(W.doc.content.size,yt+2);re&&(W=W.setSelection(re.near(W.doc.resolve(Et),1)))}}}catch(re){Ye("table.merge.selection.error",{message:String(re?.message||re||""),stack:String(re?.stack||"")})}W=W.setMeta(le,!0);try{t(W.scrollIntoView())}catch(re){return Ye("table.merge.dispatch.error",{message:String(re?.message||re||""),stack:String(re?.stack||"")}),!1}return!0}catch(n){try{Ye("table.merge.exception",{message:String(n?.message||n||""),stack:String(n?.stack||"")})}catch{}return!1}}function mp(e,t,n,r){try{let o=(he,Qe={})=>{try{if(window?.localStorage?.getItem?.("ttree_debug_outline_keys_v1")!=="1")return;console.log("[outline][keys]","bodyToHeading.skip",{reason:he,sectionId:n||null,...Qe})}catch{}},i=(he={})=>{try{if(window?.localStorage?.getItem?.("ttree_debug_outline_keys_v1")!=="1")return;console.log("[outline][keys]","bodyToHeading.check",{sectionId:n||null,...he})}catch{}};if(!n)return!1;if(!r)return o("no-TextSelection"),!1;let s=e?.selection;if(!s?.empty)return o("selection-not-empty"),!1;let c=s.$from||null;if(!c)return o("no-$from"),!1;i({from:s.from,parent:c.parent?.type?.name||null,parentOffset:c.parentOffset??null});let a=at(e.doc,n);if(typeof a!="number")return o("section-not-found"),!1;let l=e.doc.nodeAt(a);if(!l||l.type?.name!=="outlineSection")return o("not-outlineSection",{found:l?.type?.name||null}),!1;let d=l.child(0),p=l.child(1);if(!d||d.type?.name!=="outlineHeading")return o("missing-heading",{found:d?.type?.name||null}),!1;if(!p||p.type?.name!=="outlineBody")return o("missing-body",{found:p?.type?.name||null}),!1;let h=String(d.textContent||"").replace(/\u00a0/g," "),y=!!h.trim(),S=/\s$/.test(h),f=null;for(let he=c.depth;he>=0;he-=1)if(c.node(he)?.type?.name==="outlineBody"){f=he;break}if(f==null)return o("not-in-outlineBody",{parent:c.parent?.type?.name||null}),!1;if(c.index(f)!==0)return o("not-first-body-child",{index:c.index(f)}),!1;if(c.parent?.type?.name!=="paragraph")return o("parent-not-paragraph",{parent:c.parent?.type?.name||null}),!1;if((c.parentOffset??null)!==0)return o("not-at-paragraph-start",{parentOffset:c.parentOffset??null}),!1;let m=a+1,b=s.from,x=c.parent,v=0,L=null;for(let he=0;he<x.childCount;he+=1){let Qe=x.child(he);if(Qe.type?.name==="hardBreak"){L=v;break}v+=Qe.nodeSize}let R=b+(L??x.content.size);if(R<=b)return o("empty-first-line"),!1;let q=e.doc.slice(b,R);if(!q?.content||q.content.size<=0)return o("empty-slice"),!1;let j=L==null?R:R+1,$=m+1,X=m+d.nodeSize-1,W=e.tr;y&&!S&&(W=W.insertText(" ",X),W=W.setMeta(le,!0));let te=W.mapping.map(X,1),be=te;W=W.insert(te,q.content);let Oe=W.mapping.map(b,1),re=W.mapping.map(j,-1);W=W.delete(Oe,re);try{W=W.setSelection(r.create(W.doc,be))}catch{}return W=W.setMeta(le,!0),t(W.scrollIntoView()),!0}catch(o){try{window?.localStorage?.getItem?.("ttree_debug_outline_keys_v1")==="1"&&console.log("[outline][keys]","bodyToHeading.error",{sectionId:n||null,message:String(o?.message||o||""),stack:String(o?.stack||"")})}catch{}return!1}}function hp(e,t){try{if(!e?.doc||!t)return null;let n=at(e.doc,t);if(typeof n!="number")return null;let r=e.doc.nodeAt(n);if(!r)return null;let o=r.child(0),i=r.child(1);if(!i||i.type?.name!=="outlineBody")return null;let c=n+1+o.nodeSize+1,a=[],l=0,d=0;for(;d<i.childCount;){let h=i.child(d),y=c+l;if(h.type?.name!=="paragraph"){l+=h.nodeSize,d+=1;continue}let S=Zn(h).trim();if(S.includes(`
`)&&S.includes("|")){let W=Zs(S),te=yr(W),be=te?null:br(W),Oe=te?{header:te.header,rows:te.rows,withHeader:!0}:be?{header:null,rows:be.rows,withHeader:!1}:null,re=null;if(Oe)try{re=Gn(e.schema,Oe)}catch(he){ln("convert: buildTableNode error (single)",{message:String(he?.message||he||""),stack:String(he?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),re=null}if(re){let he=y,Qe=y+h.nodeSize;a.push({from:he,to:Qe,tableNode:re}),ln("convert: single-paragraph table",{sectionId:t,from:he,to:Qe,lines:W}),l+=h.nodeSize,d+=1;continue}}let f=dn(S);if(!f||d+1>=i.childCount){if(f){let W=[S],te=l+h.nodeSize,be=d+1;for(;be<i.childCount;){let Qe=i.child(be);if(Qe.type?.name!=="paragraph")break;let yt=Zn(Qe).trim();if(!yt)break;let Et=dn(yt);if(!Et||Et.length!==f.length)break;W.push(yt),te+=Qe.nodeSize,be+=1}let Oe=br(W),re=Oe?{header:null,rows:Oe.rows,withHeader:!1}:null,he=null;if(re)try{he=Gn(e.schema,re)}catch(Qe){ln("convert: buildTableNode error (rows-only)",{message:String(Qe?.message||Qe||""),stack:String(Qe?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),he=null}if(he){a.push({from:y,to:c+te,tableNode:he}),ln("convert: rows-only table",{sectionId:t,from:y,to:c+te,lines:W}),l=te,d=be;continue}}l+=h.nodeSize,d+=1;continue}let m=i.child(d+1);if(m.type?.name!=="paragraph"){l+=h.nodeSize,d+=1;continue}let b=Zn(m).trim(),x=dn(b);if(!x||x.length!==f.length||!x.every(mi)){l+=h.nodeSize,d+=1;continue}let v=[S,b],L=l+h.nodeSize+m.nodeSize,R=d+2;for(;R<i.childCount;){let W=i.child(R);if(W.type?.name!=="paragraph")break;let te=Zn(W).trim();if(!te)break;let be=dn(te);if(!be||be.length!==f.length)break;v.push(te),L+=W.nodeSize,R+=1}let q=yr(v),j=q?null:br(v),$=q?{header:q.header,rows:q.rows,withHeader:!0}:j?{header:null,rows:j.rows,withHeader:!1}:null,X=null;if($)try{X=Gn(e.schema,$)}catch(W){ln("convert: buildTableNode error (multi)",{message:String(W?.message||W||""),stack:String(W?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),X=null}if(!X){l+=h.nodeSize,d+=1;continue}a.push({from:y,to:c+L,tableNode:X}),ln("convert: multi-paragraph table",{sectionId:t,from:y,to:c+L,lines:v}),l=L,d=R}if(!a.length)return null;a.sort((h,y)=>y.from-h.from);let p=e.tr;for(let h of a)p=p.replaceRangeWith(h.from,h.to,h.tableNode);return p=p.setMeta(le,!0),p}catch{return null}}function Zn(e){if(!e)return"";let t="";return e.descendants(n=>{n.isText?t+=n.text||"":n.type?.name==="hardBreak"&&(t+=`
`)}),t}function _l(e){try{if(!e||e.type!=="paragraph")return"";let t=[],n=r=>{if(!r)return;if(r.type==="text"){t.push(String(r.text||""));return}if(r.type==="hardBreak"){t.push(`
`);return}let o=Array.isArray(r.content)?r.content:[];for(let i of o)n(i)};return n(e),t.join("")}catch{return""}}function gp(e){if(!e)return null;let{header:t,rows:n}=e;if(!Array.isArray(t)||t.length===0)return null;let r=s=>({type:"paragraph",content:String(s||"").length?[{type:"text",text:String(s||"")}]:[]}),o={type:"tableRow",content:t.map(s=>({type:"tableHeader",content:[r(s)]}))},i=(Array.isArray(n)?n:[]).map(s=>({type:"tableRow",content:s.map(c=>({type:"tableCell",content:[r(c)]}))}));return{type:"table",content:[o,...i]}}function yp(e){if(!e)return!1;try{let{doc:t,schema:n}=e.state,r=[];if(t.descendants((i,s)=>{if(i.type?.name!=="outlineBody")return;let c=s+1,a=0,l=0;for(;l<i.childCount;){let d=i.child(l),p=c+a;if(d.type?.name!=="paragraph"){a+=d.nodeSize,l+=1;continue}let h=Zn(d).trim();if(h.includes(`
`)&&h.includes("|")){let j=Zs(h),$=yr(j),X=$?null:br(j),W=$?{header:$.header,rows:$.rows,withHeader:!0}:X?{header:null,rows:X.rows,withHeader:!1}:null,te=W?Gn(n,W):null;if(te){r.push({from:p,to:p+d.nodeSize,tableNode:te}),a+=d.nodeSize,l+=1;continue}}let y=dn(h);if(!y){a+=d.nodeSize,l+=1;continue}if(l+1>=i.childCount){let j=br([h]),$=j?{header:null,rows:j.rows,withHeader:!1}:null,X=$?Gn(n,$):null;X&&r.push({from:p,to:p+d.nodeSize,tableNode:X}),a+=d.nodeSize,l+=1;continue}let S=i.child(l+1);if(S.type?.name!=="paragraph"){a+=d.nodeSize,l+=1;continue}let f=Zn(S).trim(),m=dn(f);if(!m||m.length!==y.length||!m.every(mi)){let j=[h],$=a+d.nodeSize,X=l+1;for(;X<i.childCount;){let Oe=i.child(X);if(Oe.type?.name!=="paragraph")break;let re=Zn(Oe).trim();if(!re)break;let he=dn(re);if(!he||he.length!==y.length)break;j.push(re),$+=Oe.nodeSize,X+=1}let W=br(j),te=W?{header:null,rows:W.rows,withHeader:!1}:null,be=te?Gn(n,te):null;if(be){r.push({from:p,to:c+$,tableNode:be}),a=$,l=X;continue}a+=d.nodeSize,l+=1;continue}let b=[h,f],x=a+d.nodeSize+S.nodeSize,v=l+2;for(;v<i.childCount;){let j=i.child(v);if(j.type?.name!=="paragraph")break;let $=Zn(j).trim();if(!$)break;let X=dn($);if(!X||X.length!==y.length)break;b.push($),x+=j.nodeSize,v+=1}let L=yr(b),R=L?{header:L.header,rows:L.rows,withHeader:!0}:null,q=R?Gn(n,R):null;if(!q){a+=d.nodeSize,l+=1;continue}r.push({from:p,to:c+x,tableNode:q}),a=x,l=v}}),!r.length)return!1;r.sort((i,s)=>s.from-i.from);let o=e.state.tr;for(let i of r)o=o.replaceRangeWith(i.from,i.to,i.tableNode);return o=o.setMeta(le,!0),e.view.dispatch(o),!0}catch{return!1}}function Rr(){let e=Date.now();if(!(e-Pl<900)){Pl=e;try{ve("\u0414\u043B\u044F \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Enter \u0438\u043B\u0438 \u0434\u0432\u043E\u0439\u043D\u043E\u0439 \u043A\u043B\u0438\u043A \u043C\u044B\u0448\u043A\u043E\u0439. Esc \u0434\u043B\u044F \u0432\u044B\u0445\u043E\u0434\u0430.")}catch{}}}function Ys(e=""){let t=document.createElement("div");return t.innerHTML=e||"",(t.textContent||"").replace(/\u00a0/g," ").trim()}function hr(e=""){return String(e||"").replace(/\u00a0/g," ").replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}function Xs(e=""){let t=String(e||""),n=0;for(let r=0;r<t.length;r+=1)n=n*31+t.charCodeAt(r)>>>0;return String(n)}function $s(e=""){return Xs(String(e||"").slice(0,12e3))}function Ut(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`sec-${Date.now()}-${Math.random().toString(16).slice(2)}`}function od({loading:e=!1}={}){V.outlineEditor&&(V.outlineEditor.innerHTML=`
    <div class="outline-editor__body">
      <div class="outline-editor__content" id="outlineEditorContent"></div>
      <div class="outline-editor__loading ${e?"":"hidden"}">\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440\u2026</div>
    </div>
  `,Cl||(Cl=!0))}function id(e){let t=String(e||"").trim();if(!t)return null;let n=t.match(/(-?\d+(?:\.\d+)?)%/);if(!n)return null;let r=Number.parseFloat(n[1]);return Number.isFinite(r)?r:null}function Cn(e){let t=Number(e);return Number.isFinite(t)?Math.max(0,Math.min(100,t)):0}function sd(e){try{let t=e?.dataset?.ttPct||"",n=Number.parseFloat(String(t||""));if(Number.isFinite(n)&&n>0)return n;let r=id(e?.style?.width||"");return r!=null&&r>0?r:null}catch{return null}}function hi(e,t){try{let n=Cn(t);return e.dataset.ttPct=n.toFixed(4),e.style.width=`${n.toFixed(4)}%`,e.style.minWidth="",!0}catch{return!1}}function fi(e,{insertIndex:t,newColPct:n=10}={}){try{let r=e?.view;if(!r)return!1;let o=Number(t);if(!Number.isFinite(o)||o<0)return!1;let i=r.domAtPos(r.state.selection.from),c=((i?.node&&i.node.nodeType===1?i.node:i?.node?.parentElement)||null)?.closest?.("table")||null;if(!c)return!1;let a=c.querySelector("colgroup");if(!a)return!1;let l=Array.from(a.querySelectorAll("col"));if(!l.length||o>=l.length)return!1;let d=100/l.length,p=l.map(L=>sd(L)??d),h=Cn(n);p[o]=h;let y=o-1,S=y>=0?p.slice(0,y+1).reduce((L,R)=>L+R,0):0,f=o+1,m=Math.max(0,l.length-f),b=m>0?p.slice(f).reduce((L,R)=>L+R,0):0,x=100-S-h;if(x<0){let L=Math.max(0,o-1),R=Math.max(0,p[L]-1),q=Math.abs(x),j=Math.min(R,q);p[L]=Math.max(1,p[L]-j),x=100-p.slice(0,y+1).reduce(($,X)=>$+X,0)-h,x=Math.max(0,x)}if(m>0)if(b>0){let L=x/b;for(let R=f;R<l.length;R+=1)p[R]*=L}else{let L=x/m;for(let R=f;R<l.length;R+=1)p[R]=L}let v=p.reduce((L,R)=>L+R,0);if(v>0&&Math.abs(v-100)>.01){let L=100-v,R=l.length-1;p[R]=Cn(p[R]+L),v=p.reduce((q,j)=>q+j,0)}for(let L=0;L<l.length;L+=1)hi(l[L],p[L]);try{c.style.width="100%",c.style.maxWidth="100%",c.style.tableLayout="fixed"}catch{}return!0}catch{return!1}}function di(e){try{if(!e)return!1;let t=e.querySelector("colgroup");if(!t)return!1;let n=Array.from(t.querySelectorAll("col"));if(!n.length)return!1;let r=e.getBoundingClientRect();if(!Number.isFinite(r.width)||r.width<=0)return!1;let o=e.querySelector("tbody tr");if(!o)return!1;let i=Array.from(o.children||[]).filter(a=>a&&a.nodeType===1);if(!i.length)return!1;let s=[];for(let a=0;a<n.length;a+=1){let l=i[a]||null;if(!l){s.push(0);continue}let d=l.getBoundingClientRect();s.push(Number.isFinite(d.width)?d.width:0)}let c=s.reduce((a,l)=>a+(Number.isFinite(l)?l:0),0);if(!(c>0))return!1;for(let a=0;a<n.length;a+=1){let l=Cn(s[a]/c*100);hi(n[a],l)}return!0}catch{return!1}}function Kt(e){try{if(!e?.state?.selection)return null;let t=e.state.selection;try{let o=t?.$anchorCell?.pos,i=t?.$headCell?.pos,s=Number.isFinite(o)?o:Number.isFinite(i)?i:null;if(s!=null){let c=e.nodeDOM?.(s)||null;if(c&&c.nodeType===1)return c.closest?.("table")||null}}catch{}let n=e.domAtPos(t.from);return((n?.node&&n.node.nodeType===1?n.node:n?.node?.parentElement)||null)?.closest?.("table")||null}catch{return null}}function bp(e){try{let t=e?.state?.selection||null,n=t?.$from||null;if(!n)return null;try{let s=t?.$anchorCell?.pos,c=t?.$headCell?.pos,a=Number.isFinite(s)?s:Number.isFinite(c)?c:null;if(a!=null){let l=e.nodeDOM?.(a)||null;if(l&&l.nodeType===1)return l}}catch{}let r=null;for(let s=n.depth;s>=0;s-=1){let c=n.node(s)?.type?.name;if(c==="tableCell"||c==="tableHeader"){r=s;break}}if(r!=null){let s=n.before(r),c=e.nodeDOM?.(s)||null;if(c&&c.nodeType===1)return c}let o=e.domAtPos(t.from);return((o?.node&&o.node.nodeType===1?o.node:o?.node?.parentElement)||null)?.closest?.("td,th")||null}catch{return null}}function Hr(e){try{if(!e)return null;let t=e.querySelector("colgroup");if(!t)return null;let n=Array.from(t.querySelectorAll("col"));if(!n.length)return null;let r=n.map(l=>sd(l));if(r.some(l=>typeof l=="number"&&Number.isFinite(l)&&l>0)){let l=100/n.length;return r.map(d=>typeof d=="number"&&Number.isFinite(d)&&d>0?d:l)}let i=e.querySelector("tbody tr");if(!i)return null;let s=Array.from(i.children||[]).filter(l=>l&&l.nodeType===1);if(s.length<n.length)return null;let c=[];for(let l=0;l<n.length;l+=1){let d=s[l].getBoundingClientRect();c.push(Number.isFinite(d.width)?d.width:0)}let a=c.reduce((l,d)=>l+(Number.isFinite(d)?d:0),0);return a>0?c.map(l=>Cn(l/a*100)):null}catch{return null}}function $r(e,t){try{if(!e)return!1;let n=e.querySelector("colgroup");if(!n)return!1;let r=Array.from(n.querySelectorAll("col"));if(!r.length||!Array.isArray(t)||t.length!==r.length)return!1;for(let o=0;o<r.length;o+=1)hi(r[o],t[o]);try{e.style.width="100%",e.style.maxWidth="100%",e.style.tableLayout="fixed"}catch{}return!0}catch{return!1}}function cd(e,t){try{let n=Array.isArray(e)?e.map(p=>Number(p)||0):null,r=Number(t);if(!n||!Number.isFinite(r)||r<0||r>=n.length||n.length<=1)return null;let o=Math.max(0,n[r]||0),i=n.slice(0,r),s=n.slice(r+1),c=s.reduce((p,h)=>p+(Number.isFinite(h)?h:0),0),a=s;if(s.length)if(c>0){let p=(c+o)/c;a=s.map(h=>Number.isFinite(h)?h*p:0)}else{let p=(o||0)/s.length;a=s.map(()=>p)}else i.length&&(i[i.length-1]=Math.max(1,(i[i.length-1]||0)+o));let l=[...i,...a].map(p=>Cn(p)),d=l.reduce((p,h)=>p+(Number.isFinite(h)?h:0),0);return d>0&&Math.abs(d-100)>.01&&(l[l.length-1]=Cn(l[l.length-1]+(100-d))),l}catch{return null}}function Dt(e){try{let t=ht?.TableMap||null,n=e?.selection||null,r=n?.$from||null,i=n?.$anchorCell||null||r||null;if(!i)return null;let s=null;for(let m=i.depth;m>=0;m-=1)if(i.node(m)?.type?.name==="table"){s=m;break}if(s==null)return null;let c=i.before(s),a=e.doc.nodeAt(c);if(!a||a.type?.name!=="table")return null;let l=null;for(let m=s+1;m<=i.depth;m+=1){let b=i.node(m)?.type?.name;if(b==="tableCell"||b==="tableHeader"){l=m;break}}if(l==null)return null;let d=i.before(l),p=t?.get?t.get(a):null;if(!p)return null;let h=d-c-1,y=p.findCell(h),S=Number(y?.left??0),f=Number(y?.top??0);return{tablePos:c,tableNode:a,map:p,colIndex:S,rowIndex:f}}catch{return null}}function Fs(e){try{let t=[],n=e?.selection,r=e?.doc;if(!n||!r)return t;try{r.nodesBetween(n.from,n.to,(i,s)=>{let c=i?.type?.name;(c==="tableCell"||c==="tableHeader")&&t.push({node:i,pos:s})})}catch{}if(!t.length)try{let i=n.$from||null;if(i)for(let s=i.depth;s>=0;s-=1){let c=i.node(s)?.type?.name;if(c==="tableCell"||c==="tableHeader"){let a=i.before(s),l=r.nodeAt(a);l&&t.push({node:l,pos:a});break}}}catch{}let o=new Map;for(let i of t){let s=Number(i?.pos);Number.isFinite(s)&&(o.has(s)||o.set(s,i))}return Array.from(o.values()).sort((i,s)=>Number(i.pos)-Number(s.pos))}catch{return[]}}function wp(e,t){try{let n=ht?.CellSelection||null,r=ht?.TableMap||null;return!n||!r?!1:e.commands.command(({state:o,dispatch:i})=>{let s=Dt(o);if(!s)return!1;let{tablePos:c,tableNode:a,map:l}=s,d=Number(t);if(!Number.isFinite(d)||d<0||d>=l.height)return!1;let p=l.positionAt(d,0,a),h=l.positionAt(d,l.width-1,a),y=c+1+p,S=c+1+h,f=null;try{typeof n.create=="function"&&(f=n.create(o.doc,y,S))}catch{f=null}if(!f)return!1;let m=o.tr.setSelection(f);return m=m.setMeta(le,!0),i(m.scrollIntoView()),!0})}catch{return!1}}function Sp(e,t,n){try{let r=ht?.CellSelection||null,o=ht?.TableMap||null;if(!r||!o)return!1;let i=Number(t),s=Number(n);return!Number.isFinite(i)||i<0||!Number.isFinite(s)||s<0?!1:e.commands.command(({state:c,dispatch:a})=>{let l=c?.doc?.nodeAt?.(i)||null;if(!l||l.type?.name!=="table")return!1;let d=o?.get?o.get(l):null;if(!d||s>=d.height)return!1;let p=d.positionAt(s,0,l),h=d.positionAt(s,d.width-1,l),y=i+1+p,S=i+1+h,f=null;try{typeof r.create=="function"&&(f=r.create(c.doc,y,S))}catch{f=null}if(!f)return!1;let m=c.tr.setSelection(f);return m=m.setMeta(le,!0),a(m.scrollIntoView()),!0})}catch{return!1}}function xp(e,t){try{let n=ht?.CellSelection||null,r=ht?.TableMap||null;return!n||!r?!1:e.commands.command(({state:o,dispatch:i})=>{let s=Dt(o);if(!s)return!1;let{tablePos:c,tableNode:a,map:l}=s,d=Number(t);if(!Number.isFinite(d)||d<0||d>=l.width)return!1;let p=l.positionAt(0,d,a),h=l.positionAt(l.height-1,d,a),y=c+1+p,S=c+1+h,f=null;try{typeof n.create=="function"&&(f=n.create(o.doc,y,S))}catch{f=null}if(!f)return!1;let m=o.tr.setSelection(f);return m=m.setMeta(le,!0),i(m.scrollIntoView()),!0})}catch{return!1}}function Ap(e,t,n){try{let r=ht?.CellSelection||null,o=ht?.TableMap||null;if(!r||!o)return!1;let i=Number(t),s=Number(n);return!Number.isFinite(i)||i<0||!Number.isFinite(s)||s<0?!1:e.commands.command(({state:c,dispatch:a})=>{let l=c?.doc?.nodeAt?.(i)||null;if(!l||l.type?.name!=="table")return!1;let d=o?.get?o.get(l):null;if(!d||s>=d.width)return!1;let p=d.positionAt(0,s,l),h=d.positionAt(d.height-1,s,l),y=i+1+p,S=i+1+h,f=null;try{typeof r.create=="function"&&(f=r.create(c.doc,y,S))}catch{f=null}if(!f)return!1;let m=c.tr.setSelection(f);return m=m.setMeta(le,!0),a(m.scrollIntoView()),!0})}catch{return!1}}function Ip({pmState:e,dispatch:t},{tablePos:n,rowIndex:r,attr:o,value:i}){try{let s=ht?.CellSelection||null,c=ht?.TableMap||null;if(!c)return!1;let a=Number(n),l=Number(r);if(!Number.isFinite(a)||a<0||!Number.isFinite(l)||l<0)return!1;let d=e?.doc?.nodeAt?.(a)||null;if(!d||d.type?.name!=="table")return!1;let p=c?.get?c.get(d):null;if(!p||l>=p.height)return!1;let h=e.tr;try{if(s?.create){let f=p.positionAt(l,0,d),m=p.positionAt(l,p.width-1,d),b=a+1+f,x=a+1+m;h=h.setSelection(s.create(h.doc,b,x))}}catch{}let y=new Set;for(let f=0;f<p.width;f+=1){let m=p.map[l*p.width+f];Number.isFinite(m)&&y.add(a+1+m)}if(!y.size)return!1;let S=!1;for(let f of y){let m=h.doc.nodeAt(f),b=m?.type?.name;if(b!=="tableCell"&&b!=="tableHeader")continue;let x={...m.attrs||{}};i==null||i===""?delete x[o]:x[o]=i,h=h.setNodeMarkup(f,void 0,x),S=!0}return S?(h=h.setMeta(le,!0),t(h),!0):!1}catch{return!1}}function kp({pmState:e,dispatch:t},{tablePos:n,colIndex:r,attr:o,value:i}){try{let s=ht?.CellSelection||null,c=ht?.TableMap||null;if(!c)return!1;let a=Number(n),l=Number(r);if(!Number.isFinite(a)||a<0||!Number.isFinite(l)||l<0)return!1;let d=e?.doc?.nodeAt?.(a)||null;if(!d||d.type?.name!=="table")return!1;let p=c?.get?c.get(d):null;if(!p||l>=p.width)return!1;let h=e.tr;try{if(s?.create){let f=p.positionAt(0,l,d),m=p.positionAt(p.height-1,l,d),b=a+1+f,x=a+1+m;h=h.setSelection(s.create(h.doc,b,x))}}catch{}let y=new Set;for(let f=0;f<p.height;f+=1){let m=p.map[f*p.width+l];Number.isFinite(m)&&y.add(a+1+m)}if(!y.size)return!1;let S=!1;for(let f of y){let m=h.doc.nodeAt(f),b=m?.type?.name;if(b!=="tableCell"&&b!=="tableHeader")continue;let x={...m.attrs||{}};i==null||i===""?delete x[o]:x[o]=i,h=h.setNodeMarkup(f,void 0,x),S=!0}return S?(h=h.setMeta(le,!0),t(h),!0):!1}catch{return!1}}function gi(e,t="\u0442\u0430\u0431\u043B\u0438\u0446\u044B"){try{let n=!1;return e.descendants(r=>{if(n)return!1;let o=r?.type?.name;if(o==="tableCell"||o==="tableHeader"){let i=Number(r.attrs?.colspan||1),s=Number(r.attrs?.rowspan||1);if(i!==1||s!==1)return n=!0,!1}return!0}),n?(ve(`\u041F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 ${t} \u043F\u043E\u043A\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u0445 \u044F\u0447\u0435\u0435\u043A`),!1):!0}catch{return!1}}function ad(e,{kind:t,fromIndex:n,toIndex:r}){try{if(!e||!(ht?.TableMap||null))return!0;let i=e.map||null,s=e.tableNode||null;if(!i||!s)return!0;let c=Number(n),a=Number(r);if(!Number.isFinite(c)||!Number.isFinite(a))return!0;let l=t==="row"?Math.max(0,Math.min(i.height-1,c)):Math.max(0,Math.min(i.width-1,c)),d=t==="row"?Math.max(0,Math.min(i.height-1,a)):Math.max(0,Math.min(i.width-1,a)),p=new Set;for(let h of i.map){let y=Number(h);if(!Number.isFinite(y)||y<0||p.has(y))continue;p.add(y);let S=null;try{S=i.findCell(y)}catch{S=null}if(!S)continue;let f=Number(S.right)-Number(S.left),m=Number(S.bottom)-Number(S.top);if(f>1||m>1)if(t==="col"){let b=Number(S.left),x=Number(S.right);if(b<=l&&l<x||b<=d&&d<x)return!0}else{let b=Number(S.top),x=Number(S.bottom);if(b<=l&&l<x||b<=d&&d<x)return!0}}return!1}catch{return!0}}function Dl(e,t){try{if(!e?.view)return!1;let n=Dt(e.state);if(!n)return!1;let{colIndex:r}=n,o=n.map?.width||0;if(!(o>0))return!1;let i=t<0?-1:1,s=r+i;return s>=0&&s<o?ld(e,r,s):!1}catch{return!1}}function Ol(e,t){try{if(!e?.view)return!1;let n=Dt(e.state);if(!n)return!1;let{rowIndex:r}=n,o=n.map?.height||0;if(!(o>0))return!1;let i=t<0?-1:1,s=r+i;return s>=0&&s<o?dd(e,r,s):!1}catch{return!1}}function ld(e,t,n){try{if(!e?.view)return!1;let r=e.state,o=Dt(r);if(!o)return!1;let{tableNode:i}=o,s=o.map?.width||0;if(!(s>0))return!1;let c=Number(t),a=Number(n);if(!Number.isFinite(c)||!Number.isFinite(a)||c<0||c>=s||a<0||a>=s)return!1;if(c===a)return!0;if(ad(o,{kind:"col",fromIndex:c,toIndex:a}))return ve("\u041D\u0435\u043B\u044C\u0437\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u043E\u043B\u0431\u0435\u0446: \u0438\u0441\u0445\u043E\u0434\u043D\u0430\u044F \u0438\u043B\u0438 \u0446\u0435\u043B\u0435\u0432\u0430\u044F \u043A\u043E\u043B\u043E\u043D\u043A\u0430 \u043F\u0435\u0440\u0435\u0441\u0435\u043A\u0430\u0435\u0442\u0441\u044F \u0441 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u043C\u0438 \u044F\u0447\u0435\u0439\u043A\u0430\u043C\u0438"),!1;let l=Kt(e.view),d=Hr(l),p=Array.isArray(d)&&d.length===s?(()=>{let f=d.slice(),m=f.splice(c,1)[0];return f.splice(a,0,m),f})():null,h=ht?.moveTableColumn||null;if(typeof h!="function")return!1;let y=h({from:c,to:a,select:!0});return e.commands.command(({state:f,dispatch:m})=>y(f,typeof m=="function"?x=>{try{x=x.setMeta(le,!0)}catch{}m(x)}:void 0))?(p&&window.requestAnimationFrame(()=>{let f=Kt(e.view);$r(f,p);try{(f?.closest?.(".tableWrapper")||null)?.dispatchEvent?.(new Event("scroll"))}catch{}}),!0):!1}catch{return!1}}function dd(e,t,n){try{if(!e?.view)return!1;let r=e.state,o=Dt(r);if(!o)return!1;let i=o.map?.height||0,s=o.map?.width||0;if(!(s>0&&i>0))return!1;let c=Number(t),a=Number(n);if(!Number.isFinite(c)||!Number.isFinite(a)||c<0||c>=i||a<0||a>=i)return!1;if(c===a)return!0;if(ad(o,{kind:"row",fromIndex:c,toIndex:a}))return ve("\u041D\u0435\u043B\u044C\u0437\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u043E\u043A\u0443: \u0438\u0441\u0445\u043E\u0434\u043D\u0430\u044F \u0438\u043B\u0438 \u0446\u0435\u043B\u0435\u0432\u0430\u044F \u0441\u0442\u0440\u043E\u043A\u0430 \u043F\u0435\u0440\u0435\u0441\u0435\u043A\u0430\u0435\u0442\u0441\u044F \u0441 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u043C\u0438 \u044F\u0447\u0435\u0439\u043A\u0430\u043C\u0438"),!1;let l=Kt(e.view),d=Hr(l),p=ht?.moveTableRow||null;if(typeof p!="function")return!1;let h=p({from:c,to:a,select:!0});return e.commands.command(({state:S,dispatch:f})=>h(S,typeof f=="function"?b=>{try{b=b.setMeta(le,!0)}catch{}f(b)}:void 0))?(Array.isArray(d)&&d.length===s&&window.requestAnimationFrame(()=>{let S=Kt(e.view);$r(S,d)}),!0):!1}catch{return!1}}function ud(e){try{if(!e)return"";let t=e.textContent||"";return String(t).replace(/\s+/g," ").trim()}catch{return""}}function vp(e){try{if(!e)return!1;for(let t=0;t<e.childCount;t+=1)if(e.child(t)?.type?.name==="tableHeader")return!0;return!1}catch{return!1}}function Rl(e,{direction:t="asc"}={}){try{if(!e?.view)return!1;let n=e.state,r=Dt(n);if(!r)return!1;let{tablePos:o,tableNode:i,colIndex:s}=r,c=i.child(0)?.childCount||0,a=i.childCount||0;if(!(c>0&&a>1)||!(s>=0&&s<c)||!gi(i,"\u0442\u0430\u0431\u043B\u0438\u0446\u044B"))return!1;let l=vp(i.child(0))?i.child(0):null,d=l?1:0,p=[];for(let m=d;m<a;m+=1){let b=i.child(m),x=b.child(s);p.push({rowIndex:m,rowNode:b,key:ud(x)})}let h=t==="desc"?-1:1;p.sort((m,b)=>h*m.key.localeCompare(b.key,void 0,{sensitivity:"base",numeric:!0}));let y=[];l&&y.push(l);for(let m of p)y.push(m.rowNode);let S=i.type.create(i.attrs,y),f=n.tr.replaceWith(o,o+i.nodeSize,S);return f=f.setMeta(le,!0),e.view.dispatch(f.scrollIntoView()),!0}catch{return!1}}function Hl(e,{direction:t="asc"}={}){try{if(!e?.view)return!1;let n=e.state,r=Dt(n);if(!r)return!1;let{tablePos:o,tableNode:i,rowIndex:s}=r,c=i.child(0)?.childCount||0,a=i.childCount||0;if(!(c>1&&a>0)||!(s>=0&&s<a)||!gi(i,"\u0442\u0430\u0431\u043B\u0438\u0446\u044B"))return!1;let l=i.child(s),d=[];for(let v=0;v<c;v+=1)d.push({colIndex:v,key:ud(l.child(v))});let p=t==="desc"?-1:1;d.sort((v,L)=>p*v.key.localeCompare(L.key,void 0,{sensitivity:"base",numeric:!0}));let h=d.map(v=>v.colIndex),y=Kt(e.view),S=Hr(y),f=Array.isArray(S)&&S.length===c?h.map(v=>S[v]):null,m=[];for(let v=0;v<a;v+=1){let L=i.child(v),R=h.map(q=>L.child(q));m.push(L.type.create(L.attrs,R))}let b=i.type.create(i.attrs,m),x=n.tr.replaceWith(o,o+i.nodeSize,b);return x=x.setMeta(le,!0),e.view.dispatch(x.scrollIntoView()),f&&window.requestAnimationFrame(()=>{let v=Kt(e.view);$r(v,f)}),!0}catch{return!1}}function Ep(e){try{if(!e?.view)return!1;let t=e.state,n=Dt(t);if(!n)return!1;let{tablePos:r,tableNode:o,rowIndex:i,colIndex:s}=n,c=o.child(0)?.childCount||0,a=o.childCount||0;if(!(c>0&&a>0)||!(i>=0&&i<a)||!gi(o,"\u0441\u0442\u0440\u043E\u043A"))return!1;let l=o.child(i),d=[];for(let y=0;y<a;y+=1)d.push(o.child(y)),y===i&&d.push(l.type.create(l.attrs,l.content,l.marks));let p=o.type.create(o.attrs,d),h=t.tr.replaceWith(r,r+o.nodeSize,p);h=h.setMeta(le,!0);try{let y=ze?.pmStateMod?.TextSelection;if(y){let S=Math.min(p.childCount-1,i+1),f=Math.min(c-1,Math.max(0,s)),m=p.child(S),b=m.child(f),x=r+1;for(let q=0;q<S;q+=1)x+=p.child(q).nodeSize;x+=1;for(let q=0;q<f;q+=1)x+=m.child(q).nodeSize;let v=x,L=v+1,R=v+b.nodeSize-1;h=h.setSelection(y.near(h.doc.resolve(Math.min(R,L+1)),1))}}catch{}return e.view.dispatch(h.scrollIntoView()),!0}catch{return!1}}function Cp(e){try{if(!e?.view)return!1;let t=e.state,n=Dt(t);if(!n)return!1;let{tablePos:r,tableNode:o,rowIndex:i,colIndex:s}=n,c=o.child(0)?.childCount||0,a=o.childCount||0;if(!(c>0&&a>0)||!(s>=0&&s<c)||!gi(o,"\u0441\u0442\u043E\u043B\u0431\u0446\u043E\u0432"))return!1;let l=Kt(e.view),d=Hr(l),p=null;if(Array.isArray(d)&&d.length===c){let f=[...d],m=Math.max(0,Number(f[s]||0)),b=Cn(m/2);f[s]=b,f.splice(s+1,0,b);let x=f.reduce((v,L)=>v+(Number.isFinite(L)?L:0),0);x>0&&Math.abs(x-100)>.01&&(f[f.length-1]=Cn(f[f.length-1]+(100-x))),p=f}let h=[];for(let f=0;f<a;f+=1){let m=o.child(f),b=[];for(let x=0;x<c;x+=1){let v=m.child(x);b.push(v),x===s&&b.push(v.type.create(v.attrs,v.content,v.marks))}h.push(m.type.create(m.attrs,b))}let y=o.type.create(o.attrs,h),S=t.tr.replaceWith(r,r+o.nodeSize,y);S=S.setMeta(le,!0);try{let f=ze?.pmStateMod?.TextSelection;if(f){let m=Math.min(y.childCount-1,Math.max(0,i)),b=Math.min(c,Math.max(0,s+1)),x=y.child(m),v=x.child(b),L=r+1;for(let $=0;$<m;$+=1)L+=y.child($).nodeSize;L+=1;for(let $=0;$<b;$+=1)L+=x.child($).nodeSize;let R=L,q=R+1,j=R+v.nodeSize-1;S=S.setSelection(f.near(S.doc.resolve(Math.min(j,q+1)),1))}}catch{}return e.view.dispatch(S.scrollIntoView()),Array.isArray(p)&&p.length===c+1?window.requestAnimationFrame(()=>{let f=Kt(e.view);$r(f,p)}):window.requestAnimationFrame(()=>{let f=Kt(e.view);di(f)}),!0}catch{return!1}}function Tp(e,t,n){try{if(!e?.view)return!1;let{state:r,view:o}=e,{selection:i}=r,s=i?.$from||null;if(!s)return!1;let c=n instanceof Set?n:new Set(Array.from(n||[])),a=null;for(let q=s.depth;q>0;q-=1)if(s.node(q)?.type?.name==="paragraph"){let j=s.node(q-1)?.type?.name||"";c.has(j)&&(a=q);break}if(a==null)return!1;let l=a-1,d=s.node(l),p=s.index(l);if(!d)return!1;let h=t<0?-1:1,y=p+h;if(!(y>=0&&y<d.childCount))return!1;let S=d.child(p),f=d.child(y);if(S?.type?.name!=="paragraph"||f?.type?.name!=="paragraph")return!1;let m=s.before(a),b=S.nodeSize,x=h<0?m-f.nodeSize:m+b,v=f.nodeSize,L=Math.max(0,i.from-s.start(a)),R=r.tr;if(h<0){R=R.delete(m,m+b),R=R.insert(x,S);let q=x,j=q+1,$=q+S.nodeSize-1,X=j+L,W=Math.min(Math.max(X,j),$);try{let te=ze?.pmStateMod?.TextSelection;te&&(R=R.setSelection(te.near(R.doc.resolve(W),1)))}catch{}}else{R=R.delete(m,m+b);let q=m+v;R=R.insert(q,S);let j=q,$=j+1,X=j+S.nodeSize-1,W=$+L,te=Math.min(Math.max(W,$),X);try{let be=ze?.pmStateMod?.TextSelection;be&&(R=R.setSelection(be.near(R.doc.resolve(te),1)))}catch{}}return R=R.setMeta(le,!0),o.dispatch(R.scrollIntoView()),!0}catch{return!1}}function $l(e,t){return Tp(e,t,new Set(["outlineBody","tableCell","tableHeader"]))}function Fl(e,t){try{if(!e?.view)return!1;let{state:n,view:r}=e,{selection:o}=n,i=o?.$from||null;if(!i)return!1;let s=null;for(let L=i.depth;L>0;L-=1)if(i.node(L)?.type?.name==="listItem"){s=L;break}if(s==null)return!1;let c=s-1,a=i.node(c),l=a?.type?.name||"";if(l!=="bulletList"&&l!=="orderedList")return!1;let d=i.index(c),p=t<0?-1:1,h=d+p;if(!(h>=0&&h<a.childCount))return!1;let y=a.child(d),S=a.child(h);if(y?.type?.name!=="listItem"||S?.type?.name!=="listItem")return!1;let f=i.before(s),m=y.nodeSize,b=S.nodeSize,x=Math.max(0,o.from-i.start(s)),v=n.tr;if(p<0){let L=f-b;v=v.delete(f,f+m),v=v.insert(L,y);let R=L,q=R+1,j=R+y.nodeSize-1,$=q+x,X=Math.min(Math.max($,q),j);try{let W=ze?.pmStateMod?.TextSelection;W&&(v=v.setSelection(W.near(v.doc.resolve(X),1)))}catch{}}else{v=v.delete(f,f+m);let L=f+b;v=v.insert(L,y);let R=L,q=R+1,j=R+y.nodeSize-1,$=q+x,X=Math.min(Math.max($,q),j);try{let W=ze?.pmStateMod?.TextSelection;W&&(v=v.setSelection(W.near(v.doc.resolve(X),1)))}catch{}}return v=v.setMeta(le,!0),r.dispatch(v.scrollIntoView()),!0}catch{return!1}}function Bp(e){if(!V.outlineToolbar||!e)return;let t=V.outlineToolbar,n=null,r={undo:V.outlineUndoBtn,redo:V.outlineRedoBtn,deleteBtn:V.outlineDeleteBtn,moveUpBtn:V.outlineMoveUpBtn,moveDownBtn:V.outlineMoveDownBtn,outdentBtn:V.outlineOutdentBtn,indentBtn:V.outlineIndentBtn,newBelowBtn:V.outlineNewBelowBtn,blocksMenuBtn:t.querySelector("#outlineBlocksMenuBtn"),textMenuBtn:t.querySelector("#outlineTextMenuBtn"),listsMenuBtn:t.querySelector("#outlineListsMenuBtn"),tableMenuBtn:t.querySelector("#outlineTableMenuBtn")},o=new Set(Array.from(t.querySelectorAll(".outline-toolbar__dropdown-btn")));r.blocksMenuBtn&&o.add(r.blocksMenuBtn),r.textMenuBtn&&o.add(r.textMenuBtn),r.listsMenuBtn&&o.add(r.listsMenuBtn),r.tableMenuBtn&&o.add(r.tableMenuBtn);let i=Array.from(o),s=Array.from(t.querySelectorAll(".outline-toolbar__menu")),c=Array.from(t.querySelectorAll("[data-outline-action]")),a=Array.from(t.querySelectorAll("[data-outline-clipboard-action]")),l=(Z,fe)=>{if(!Z)return()=>{};let ge=de=>{de.preventDefault(),de.stopPropagation(),fe()};return Z.addEventListener("click",ge),()=>Z.removeEventListener("click",ge)},d=(Z,fe)=>{if(!Z)return()=>{};let ge=0,de=Q=>{ge=Date.now(),Q.preventDefault(),Q.stopPropagation(),fe()},se=Q=>de(Q),pe=Q=>de(Q),me=Q=>{if(Date.now()-ge<450){Q.preventDefault(),Q.stopPropagation();return}de(Q)};try{Z.addEventListener("pointerdown",se)}catch{}try{Z.addEventListener("touchstart",pe,{passive:!1})}catch{try{Z.addEventListener("touchstart",pe)}catch{}}return Z.addEventListener("click",me),()=>{try{Z.removeEventListener("pointerdown",se)}catch{}Z.removeEventListener("touchstart",pe),Z.removeEventListener("click",me)}},p=(Z,fe)=>{Z&&(Z.classList.toggle("is-active",!!fe),Z.setAttribute("aria-pressed",fe?"true":"false"))},h=()=>{for(let Z of s)Z.classList.add("hidden");for(let Z of i)Z.setAttribute("aria-expanded","false")},y=()=>{let Z=Nl(),fe=!!(Z&&Array.isArray(Z.sections)&&Z.sections.length);for(let ge of a)ge?.getAttribute?.("data-outline-clipboard-action")==="paste"&&ge.toggleAttribute("disabled",!fe)},S=Z=>{if(!Z)return;let fe=Z.getAttribute("aria-controls"),ge=fe?t.querySelector(`#${fe}`)||document.getElementById(fe):null;if(!ge)return;let de=!ge.classList.contains("hidden");h(),de||(fe==="outlineBlocksMenu"&&y(),ge.classList.remove("hidden"),Z.setAttribute("aria-expanded","true"))},f=Z=>{try{let fe=e.can().chain();return b()&&fe.command(({tr:ge})=>(ge.setMeta(le,!0),!0)),Z(fe),fe.run()}catch{return!1}},m=Z=>{if(!Z)return!1;try{let fe=e.chain().focus();if(b()&&fe.command(({tr:ge})=>(ge.setMeta(le,!0),!0)),Z==="collapseAllBlocks")return Ks(e,!0);if(Z==="expandAllBlocks")return Ks(e,!1);if(Z==="toggleBold")return fe.toggleBold().run();if(Z==="toggleItalic")return fe.toggleItalic().run();if(Z==="toggleStrike")return fe.toggleStrike().run();if(Z==="toggleCodeBlock")return e.commands.command(({state:ge,dispatch:de})=>{let se=ge.schema.nodes?.codeBlock||null;if(!se)return!1;let pe=ge.selection,{from:me,to:Q}=pe;if(me===Q){let je=ge.tr.setMeta(le,!0);return de(je),e.commands.toggleCodeBlock()}let ye=pe.$from?.blockRange?.(pe.$to)||null;if(!ye){let je=ge.tr.setMeta(le,!0);return de(je),e.commands.toggleCodeBlock()}if(!ye.parent?.canReplaceWith?.(ye.startIndex,ye.endIndex,se)){let je=ge.tr.setMeta(le,!0);return de(je),e.commands.toggleCodeBlock()}let Pe=ge.doc.textBetween(ye.start,ye.end,`
`,`
`),He=String(Pe||"").replace(/\n+$/g,"").trimEnd();if(!He)return!1;let Ge=se.create(null,ge.schema.text(He)),Ze=ge.tr.replaceRangeWith(ye.start,ye.end,Ge);return Ze=Ze.setMeta(le,!0),be&&(Ze=Ze.setSelection(be.near(Ze.doc.resolve(ye.start+2),1))),de(Ze.scrollIntoView()),!0});if(Z==="toggleBlockquote")return fe.toggleBlockquote().run();if(Z==="unsetLink")return fe.unsetLink().run();if(Z==="toggleBulletList")return e.isActive("orderedList")?fe.toggleOrderedList().toggleBulletList().run():fe.toggleBulletList().run();if(Z==="toggleOrderedList")return e.isActive("bulletList")?fe.toggleBulletList().toggleOrderedList().run():fe.toggleOrderedList().run();if(Z==="unsetList")return e.isActive("bulletList")?fe.toggleBulletList().run():e.isActive("orderedList")?fe.toggleOrderedList().run():fe.liftListItem("listItem").run();if(Z==="insertTable")return fe.insertTable({rows:2,cols:2,withHeaderRow:!1}).run();if(Z==="toggleHeaderRow")return fe.toggleHeaderRow().run();if(Z==="toggleHeaderColumn")return fe.toggleHeaderColumn().run();if(Z==="addRowBefore")return fe.addRowBefore().run();if(Z==="addRowAfter")return fe.addRowAfter().run();if(Z==="deleteRow")return fe.deleteRow().run();if(Z==="addColumnBefore"){let ge=Dt(e.state),de=ge?Math.max(0,Number(ge.colIndex||0)):0,se=fe.addColumnBefore().run();return se&&fi(e,{insertIndex:de,newColPct:10}),se}if(Z==="addColumnAfter"){let ge=Dt(e.state),de=ge?Math.max(0,Number(ge.colIndex||0)+1):1,se=fe.addColumnAfter().run();return se&&fi(e,{insertIndex:de,newColPct:10}),se}if(Z==="deleteColumn"){let ge=Kt(e.view),de=Hr(ge),se=Dt(e.state),pe=se?Number(se.colIndex||0):null,me=de&&pe!=null?cd(de,pe):null,Q=fe.deleteColumn().run();return Q&&Array.isArray(me)&&window.requestAnimationFrame(()=>{let ye=Kt(e.view);$r(ye,me)}),Q}return Z==="mergeCells"?fe.mergeCells().run():Z==="splitCell"?fe.splitCell().run():Z==="copyColumn"||Z==="pasteColumnAfter"||Z==="moveColumnRight"?!1:Z==="cancelTable"?v():Z==="deleteTable"?fe.deleteTable().run():!1}catch{return!1}},b=()=>{try{return!!(ke?.getState?.(e.state)||null)?.editingSectionId}catch{return!1}},x=()=>b()?!0:(Rr(),!1),v=()=>{if(!x())return!1;try{let{state:Z,view:fe}=e,{schema:ge,selection:de}=Z,se=de?.$from;if(!se)return!1;let pe=null;for(let Ve=se.depth;Ve>=0;Ve-=1)se.node(Ve)?.type?.name==="table"&&(pe=Ve);if(pe==null)return!1;let me=null,Q=null;for(let Ve=pe+1;Ve<=se.depth;Ve+=1){let Ue=se.node(Ve)?.type?.name;if(me==null&&Ue==="tableRow"&&(me=Ve),Q==null&&(Ue==="tableCell"||Ue==="tableHeader")&&(Q=Ve),me!=null&&Q!=null)break}let ye=se.before(pe),Pe=Z.doc.nodeAt(ye);if(!Pe||Pe.type?.name!=="table")return!1;let He=me!=null?se.index(pe):null,Ge=me!=null&&Q!=null?se.index(me):null,Ze=null;if(typeof He=="number"&&typeof Ge=="number"){let Ve=Pe.childCount&&Pe.child(0)?.childCount||0;Ve>0&&(Ze=He*Ve+Ge)}let je=[],qe=0,rt=0;for(let Ve=0;Ve<Pe.childCount;Ve+=1){let nt=Pe.child(Ve);for(let Ue=0;Ue<nt.childCount;Ue+=1){let Ot=nt.child(Ue),Ct=[];try{for(let Nt=0;Nt<(Ot?.content?.childCount||0);Nt+=1){let Tt=Ot.content.child(Nt);Tt&&Ct.push(Tt)}}catch{}Ct.length||Ct.push(ge.nodes.paragraph.create(null,[])),Ze!=null&&qe===Ze&&(rt=je.length),je.push(...Ct),qe+=1}}if(!je.length)return!1;let tt=ge.nodes.outlineBody?ge.nodes.outlineBody.create({},je).content:ge.nodes.doc.create({},je).content,Ke=Z.tr.replaceWith(ye,ye+Pe.nodeSize,tt);Ke=Ke.setMeta(le,!0);try{let Ve=ze?.pmStateMod?.TextSelection;if(Ve){let nt=ye;for(let Tt=0;Tt<rt;Tt+=1)nt+=je[Tt].nodeSize;let Ue=null,Ot=Math.min(Ke.doc.content.size,nt),Ct=Math.min(Ke.doc.content.size,nt+2e4);Ke.doc.nodesBetween(Ot,Ct,(Tt,rn)=>Ue!=null?!1:Tt?.isTextblock?(Ue=rn+1,!1):!0);let Nt=Ue??Math.min(Ke.doc.content.size,nt+1);Ke=Ke.setSelection(Ve.near(Ke.doc.resolve(Nt),1))}}catch{}return fe.dispatch(Ke.scrollIntoView()),fe.focus?.(),!0}catch{return!1}},L=()=>{if(!x())return!1;try{let{state:Z,view:fe}=e,{selection:ge}=Z,de=ge?.$from;if(!de)return!1;let se=null,pe=null,me=null;for(let Ke=de.depth;Ke>=0;Ke-=1){let nt=de.node(Ke)?.type?.name;if(me==null&&(nt==="tableCell"||nt==="tableHeader")&&(me=Ke),pe==null&&nt==="tableRow"&&(pe=Ke),nt==="table"){se=Ke;break}}if(se==null||pe==null||me==null)return!1;let Q=de.before(se),ye=Z.doc.nodeAt(Q);if(!ye||ye.type?.name!=="table")return!1;let Pe=de.index(se),He=de.index(pe),Ge=ye.child(0)?.childCount||0;if(!(Ge>0)||!(He>=0&&He<Ge-1))return!1;let Ze=!1;if(ye.descendants(Ke=>{if(Ze)return!1;let Ve=Ke?.type?.name;if(Ve==="tableCell"||Ve==="tableHeader"){let nt=Number(Ke.attrs?.colspan||1),Ue=Number(Ke.attrs?.rowspan||1);if(nt!==1||Ue!==1)return Ze=!0,!1}return!0}),Ze)return ve("\u041F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 \u0441\u0442\u043E\u043B\u0431\u0446\u043E\u0432 \u043F\u043E\u043A\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u0445 \u044F\u0447\u0435\u0435\u043A"),!1;let je=ge.from-de.start(me),qe=[];for(let Ke=0;Ke<ye.childCount;Ke+=1){let Ve=ye.child(Ke);if(Ve.type?.name!=="tableRow"||Ve.childCount!==Ge)return!1;let nt=[];for(let Ue=0;Ue<Ge;Ue+=1)Ue===He?nt.push(Ve.child(Ue+1)):Ue===He+1?nt.push(Ve.child(Ue-1)):nt.push(Ve.child(Ue));qe.push(Ve.type.create(Ve.attrs,nt))}let rt=ye.type.create(ye.attrs,qe),tt=Z.tr.replaceWith(Q,Q+ye.nodeSize,rt);tt=tt.setMeta(le,!0);try{let Ke=ze?.pmStateMod?.TextSelection;if(Ke){let Ve=Math.min(rt.childCount-1,Math.max(0,Pe)),nt=He+1,Ue=rt.child(Ve),Ot=Ue.child(nt),Ct=Q+1;for(let g=0;g<Ve;g+=1)Ct+=rt.child(g).nodeSize;Ct+=1;for(let g=0;g<nt;g+=1)Ct+=Ue.child(g).nodeSize;let Nt=Ct,Tt=Nt+1,rn=Nt+Ot.nodeSize-1,bt=Tt+Math.max(0,je),E=Math.min(Math.max(bt,Tt),rn);tt=tt.setSelection(Ke.near(tt.doc.resolve(E),1))}}catch{}return fe.dispatch(tt.scrollIntoView()),fe.focus?.(),!0}catch{return!1}},R=(Z,fe,ge={})=>{let de=String(Z||"").trim();if(!de)return!1;let se=String(fe||"").trim()||de,{from:pe,to:me,empty:Q}=e.state.selection,ye={href:de,...ge},Pe=e.chain().focus();return b()&&Pe.command(({tr:He})=>(He.setMeta(le,!0),!0)),!Q&&pe!==me?Pe.setLink(ye).run():Pe.insertContent({type:"text",text:se,marks:[{type:"link",attrs:ye}]}).run()},q=async()=>{if(!x())return;let{from:Z,to:fe,empty:ge}=e.state.selection,de=ge?"":e.state.doc.textBetween(Z,fe," ").trim(),se="",pe=de;try{let Q=await(await Promise.resolve().then(()=>(Jn(),Ri))).showLinkPrompt({title:"\u0421\u0441\u044B\u043B\u043A\u0430 (URL)",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0441\u0441\u044B\u043B\u043A\u0443 (\u043B\u044E\u0431\u043E\u0439 \u0444\u043E\u0440\u043C\u0430\u0442) \u0438 \u0442\u0435\u043A\u0441\u0442 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E).",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",textLabel:"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)",urlLabel:"\u0421\u0441\u044B\u043B\u043A\u0430",defaultText:de,defaultUrl:"",urlPlaceholder:""});if(!Q||typeof Q!="object")return;se=String(Q.url||""),pe=String(Q.text??de)}catch{se=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0441\u0441\u044B\u043B\u043A\u0443")||"",pe=de||window.prompt("\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)")||""}se=(se||"").trim(),se&&R(se,pe,{target:"_blank",rel:"noopener noreferrer"})},j=async()=>{if(!x())return;let Z=Array.isArray(u.articlesIndex)?u.articlesIndex:[];Z.length||(Z=await fn().catch(()=>[])||[],Array.isArray(Z)&&(u.articlesIndex=Z));let fe=(Array.isArray(Z)?Z:[]).map(je=>({id:je.id,title:je.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),{from:ge,to:de,empty:se}=e.state.selection,pe=se?"":e.state.doc.textBetween(ge,de," ").trim(),me=!!pe,Q="",ye="",Pe=pe;try{let qe=await(await Promise.resolve().then(()=>(Jn(),Ri))).showArticleLinkPrompt({title:"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E \u0438 \u0437\u0430\u0434\u0430\u0439\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438.",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:fe,defaultTextValue:pe,lockTextValue:me});if(qe&&typeof qe=="object")Q=qe.articleValue||"",ye=qe.selectedId||"",Pe=qe.textValue||"";else return}catch{Q=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438")||"",Pe=pe||window.prompt("\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)")||""}let He=(Q||"").trim().toLowerCase();if(!He&&!ye)return;let Ge=(Array.isArray(Z)?Z:[]).find(je=>{let qe=(je.title||"").toLowerCase();return ye&&je.id===ye||je.id&&je.id.toLowerCase()===He||qe===He||qe.includes(He)});if(!Ge){ve("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}let Ze=(Pe||"").trim()||Ge.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";R(Xt.article(Ge.id),Ze,{class:"article-link"})},$=()=>{if(!u.isOutlineEditing||!e||e.isDestroyed)return;let Z=b();if(t.dataset.editing=Z?"true":"false",n===null?n=Z:n!==Z&&(h(),n=Z),r.deleteBtn&&(r.deleteBtn.hidden=Z),r.moveUpBtn&&(r.moveUpBtn.hidden=Z),r.moveDownBtn&&(r.moveDownBtn.hidden=Z),r.outdentBtn&&(r.outdentBtn.hidden=Z),r.indentBtn&&(r.indentBtn.hidden=Z),r.newBelowBtn&&(r.newBelowBtn.hidden=Z),r.blocksMenuBtn&&(r.blocksMenuBtn.hidden=Z),Z&&Fn&&po(!1),r.undo&&(r.undo.disabled=!f(de=>de.undo())),r.redo&&(r.redo.disabled=!f(de=>de.redo())),r.textMenuBtn){let de=e.isActive("bold")||e.isActive("italic")||e.isActive("strike")||e.isActive("codeBlock")||e.isActive("blockquote");p(r.textMenuBtn,de),r.textMenuBtn.hidden=!Z}if(r.listsMenuBtn){let de=e.isActive("bulletList")||e.isActive("orderedList");p(r.listsMenuBtn,de),r.listsMenuBtn.hidden=!Z}if(r.tableMenuBtn){let de=e.isActive("table");p(r.tableMenuBtn,de),r.tableMenuBtn.hidden=!Z}let fe=null,ge=()=>{if(fe)return fe;let de={total:0,collapsed:0};try{e.state.doc.descendants(se=>{se?.type?.name==="outlineSection"&&(de.total+=1,se.attrs?.collapsed&&(de.collapsed+=1))})}catch{}return fe=de,de};for(let de of c){let se=de.dataset.outlineAction||"";if(!se)continue;let pe=!1,me=!1;if(se==="collapseAllBlocks"){let Q=ge();pe=!1,me=Q.total===0||Q.collapsed>=Q.total}else if(se==="expandAllBlocks"){let Q=ge();pe=!1,me=Q.total===0||Q.collapsed<=0}else se==="toggleBold"?(pe=e.isActive("bold"),me=!f(Q=>Q.toggleBold())):se==="toggleItalic"?(pe=e.isActive("italic"),me=!f(Q=>Q.toggleItalic())):se==="toggleStrike"?(pe=e.isActive("strike"),me=!f(Q=>Q.toggleStrike())):se==="toggleCodeBlock"?(pe=e.isActive("codeBlock"),me=!b()):se==="toggleBlockquote"?(pe=e.isActive("blockquote"),me=!f(Q=>Q.toggleBlockquote())):se==="insertHttpLink"||se==="insertArticleLink"?(pe=!1,me=!b()):se==="unsetLink"?(pe=e.isActive("link"),me=!f(Q=>Q.unsetLink())):se==="toggleBulletList"?(pe=e.isActive("bulletList"),e.isActive("orderedList")?me=!(f(Q=>Q.toggleOrderedList())&&f(Q=>Q.toggleBulletList())):me=!f(Q=>Q.toggleBulletList())):se==="toggleOrderedList"?(pe=e.isActive("orderedList"),e.isActive("bulletList")?me=!(f(Q=>Q.toggleBulletList())&&f(Q=>Q.toggleOrderedList())):me=!f(Q=>Q.toggleOrderedList())):se==="unsetList"?(pe=!1,e.isActive("bulletList")?me=!f(Q=>Q.toggleBulletList()):e.isActive("orderedList")?me=!f(Q=>Q.toggleOrderedList()):me=!f(Q=>Q.liftListItem("listItem"))):se==="insertTable"?(pe=!1,me=!f(Q=>Q.insertTable({rows:2,cols:2,withHeaderRow:!1}))):se==="toggleHeaderRow"?(pe=e.isActive("tableHeader"),me=!f(Q=>Q.toggleHeaderRow())):se==="toggleHeaderColumn"?(pe=e.isActive("tableHeader"),me=!f(Q=>Q.toggleHeaderColumn())):se==="addRowBefore"?(pe=!1,me=!f(Q=>Q.addRowBefore())):se==="addRowAfter"?(pe=!1,me=!f(Q=>Q.addRowAfter())):se==="deleteRow"?(pe=!1,me=!f(Q=>Q.deleteRow())):se==="addColumnBefore"?(pe=!1,me=!f(Q=>Q.addColumnBefore())):se==="addColumnAfter"?(pe=!1,me=!f(Q=>Q.addColumnAfter())):se==="deleteColumn"?(pe=!1,me=!f(Q=>Q.deleteColumn())):se==="copyColumn"||se==="pasteColumnAfter"||se==="moveColumnRight"?(pe=!1,me=!0):se==="mergeCells"?(pe=!1,me=!f(Q=>Q.mergeCells())):se==="splitCell"?(pe=!1,me=!f(Q=>Q.splitCell())):se==="cancelTable"?(pe=!1,me=!b()||!e.isActive("table")):se==="deleteTable"&&(pe=!1,me=!f(Q=>Q.deleteTable()));de.disabled=!!me,de.classList.toggle("is-active",!!pe)}},X=null,W=()=>{X||(X=window.requestAnimationFrame(()=>{X=null,$()}))},te=[l(r.undo,()=>e.chain().focus().undo().run()),l(r.redo,()=>e.chain().focus().redo().run())],be=ze?.pmStateMod?.TextSelection||null,Oe=(Z,fe)=>{try{let ge=Z.resolve(Math.min(Z.content.size,fe+1)),de=null;for(let se=ge.depth;se>0;se-=1){if(ge.node(se)?.type?.name!=="outlineSection")continue;if(ge.before(se)===fe){de=se;break}}if(de===null)return null;for(let se=de-1;se>0;se-=1)if(ge.node(se)?.type?.name==="outlineSection")return ge.before(se);return null}catch{return null}},re=Z=>{try{if(!be)return;e.commands.command(({state:fe,dispatch:ge})=>{let de=vt(fe.doc,fe.selection.$from);if(typeof de!="number")return!1;let se=fe.doc.resolve(de),pe=se.index(),me=se.parent;if(!me)return!1;let Q=fe.doc.nodeAt(de);if(!Q)return!1;if(Z==="up"){if(pe>0){let Tt=me.child(pe-1),rn=de-Tt.nodeSize,bt=fe.tr.delete(de,de+Q.nodeSize).insert(rn,Q);return bt=bt.setMeta(le,!0),bt=bt.setSelection(be.near(bt.doc.resolve(rn+2),1)),ge(bt.scrollIntoView()),!0}let ye=Oe(fe.doc,de);if(typeof ye!="number")return!1;let Pe=fe.doc.resolve(ye),He=Pe.index(),Ge=Pe.parent;if(!Ge||He<=0)return!1;let Ze=Ge.child(He-1),je=ye-Ze.nodeSize,qe=fe.doc.nodeAt(je);if(!qe||qe.type?.name!=="outlineSection")return!1;let rt=qe.child(0),tt=qe.child(1),Ke=qe.child(2),nt=je+1+rt.nodeSize+tt.nodeSize+Ke.nodeSize-1,Ue=fe.tr.delete(de,de+Q.nodeSize).setMeta(le,!0),Ot=Ue.mapping.map(je,-1),Ct=Ue.mapping.map(nt,-1);Ue=Ue.insert(Ct,Q);let Nt=Ue.doc.nodeAt(Ot);return Nt?.type?.name==="outlineSection"&&Nt.attrs?.collapsed&&(Ue=Ue.setNodeMarkup(Ot,void 0,{...Nt.attrs,collapsed:!1})),Ue=Ue.setSelection(be.near(Ue.doc.resolve(Ct+2),1)),ge(Ue.scrollIntoView()),!0}if(Z==="down"){if(pe<me.childCount-1){let Tt=de+Q.nodeSize,rn=fe.doc.nodeAt(Tt);if(!rn)return!1;let bt=fe.tr.delete(de,de+Q.nodeSize),E=de+rn.nodeSize;return bt=bt.insert(E,Q),bt=bt.setMeta(le,!0),bt=bt.setSelection(be.near(bt.doc.resolve(E+2),1)),ge(bt.scrollIntoView()),!0}let ye=Oe(fe.doc,de);if(typeof ye!="number")return!1;let Pe=fe.doc.nodeAt(ye);if(!Pe||Pe.type?.name!=="outlineSection")return!1;let He=fe.doc.resolve(ye),Ge=He.index(),Ze=He.parent;if(!Ze||Ge>=Ze.childCount-1)return!1;let je=ye+Pe.nodeSize,qe=fe.doc.nodeAt(je);if(!qe||qe.type?.name!=="outlineSection")return!1;let rt=qe.child(0),tt=qe.child(1),Ke=qe.child(2),nt=je+1+rt.nodeSize+tt.nodeSize+1,Ue=fe.tr.delete(de,de+Q.nodeSize).setMeta(le,!0),Ot=Ue.mapping.map(je,-1),Ct=Ue.mapping.map(nt,-1);Ue=Ue.insert(Ct,Q);let Nt=Ue.doc.nodeAt(Ot);return Nt?.type?.name==="outlineSection"&&Nt.attrs?.collapsed&&(Ue=Ue.setNodeMarkup(Ot,void 0,{...Nt.attrs,collapsed:!1})),Ue=Ue.setSelection(be.near(Ue.doc.resolve(Ct+2),1)),ge(Ue.scrollIntoView()),!0}return!1})}catch{}},he=()=>{try{if(!be)return;e.commands.command(({state:Z,dispatch:fe})=>{let ge=vt(Z.doc,Z.selection.$from);if(typeof ge!="number")return!1;let de=Z.doc.resolve(ge),se=0;for(let Ve=de.depth;Ve>=0;Ve-=1)de.node(Ve)?.type?.name==="outlineSection"&&(se+=1);if(se>=6)return!1;let pe=de.index(),me=de.parent;if(!me||pe<=0)return!1;let Q=Z.doc.nodeAt(ge);if(!Q)return!1;let ye=me.child(pe-1),Pe=ge-ye.nodeSize,He=Z.doc.nodeAt(Pe);if(!He)return!1;let Ge=He.child(0),Ze=He.child(1),je=He.child(2),rt=Pe+1+Ge.nodeSize+Ze.nodeSize+je.nodeSize-1,tt=Z.tr.delete(ge,ge+Q.nodeSize).insert(rt,Q),Ke=tt.doc.nodeAt(Pe);return Ke?.type?.name==="outlineSection"&&Ke.attrs?.collapsed&&(tt=tt.setNodeMarkup(Pe,void 0,{...Ke.attrs,collapsed:!1})),tt=tt.setMeta(le,!0),tt=tt.setSelection(be.near(tt.doc.resolve(rt+2),1)),fe(tt.scrollIntoView()),!0})}catch{}},Qe=()=>{try{if(!be)return;e.commands.command(({state:Z,dispatch:fe})=>{let ge=Z.selection.$from,de=null,se=null;for(let Ge=ge.depth;Ge>0;Ge-=1)if(ge.node(Ge)?.type?.name==="outlineSection")if(de===null)de=Ge;else{se=Ge;break}if(de===null||se===null)return!1;let pe=ge.before(de),me=ge.before(se),Q=Z.doc.nodeAt(pe);if(!Q)return!1;let ye=Z.tr.delete(pe,pe+Q.nodeSize),Pe=ye.doc.nodeAt(me);if(!Pe)return!1;let He=me+Pe.nodeSize;return ye=ye.insert(He,Q),ye=ye.setMeta(le,!0),ye=ye.setSelection(be.near(ye.doc.resolve(He+2),1)),fe(ye.scrollIntoView()),!0})}catch{}},yt=()=>{try{if(!be)return;e.commands.command(({state:Z,dispatch:fe})=>{let ge=vt(Z.doc,Z.selection.$from);if(typeof ge!="number")return!1;let de=Z.doc.nodeAt(ge);if(!de)return!1;let se=String(de.attrs?.id||"").trim(),pe=Z.doc.resolve(ge),me=pe.index(),Q=pe.parent;if(!Q)return!1;let ye=Z.doc.type.schema;if(Q.childCount<=1){let rt=ye.nodes.outlineSection.create({...de.attrs,collapsed:!1},[ye.nodes.outlineHeading.create({},[]),ye.nodes.outlineBody.create({},[ye.nodes.paragraph.create({},[])]),ye.nodes.outlineChildren.create({},[])]),tt=Z.tr.replaceWith(ge,ge+de.nodeSize,rt);tt=tt.setMeta(le,!0);let Ke=rt.child(0),Ve=ge+1+Ke.nodeSize;return tt=tt.setSelection(be.near(tt.doc.resolve(Ve+2),1)),fe(tt.scrollIntoView()),!0}se&&_r(se);let Pe=me>0,He=Pe?Q.child(me-1):null,Ge=Pe?ge-He.nodeSize:null,Ze=Z.tr.delete(ge,ge+de.nodeSize);Ze=Ze.setMeta(le,!0);let je=Pe&&typeof Ge=="number"?Ge:Math.min(Ze.doc.content.size,ge),qe=Ze.doc.nodeAt(je);if(qe?.type?.name==="outlineSection"){let rt=qe.child(0),tt=qe.child(1),Ke=je+1+rt.nodeSize;tt.childCount||(Ze=Ze.insert(Ke+1,ye.nodes.paragraph.create({},[]))),Ze=Ze.setSelection(be.near(Ze.doc.resolve(Ke+2),1))}return fe(Ze.scrollIntoView()),!0})}catch{}},Et=()=>{try{if(!be)return;e.commands.command(({state:Z,dispatch:fe})=>{let ge=vt(Z.doc,Z.selection.$from);if(typeof ge!="number")return!1;let de=Z.doc.nodeAt(ge);if(!de)return!1;let se=Z.doc.type.schema,pe=ge+de.nodeSize,me=Ut(),Q=se.nodes.outlineSection.create({id:me,collapsed:!1},[se.nodes.outlineHeading.create({},[]),se.nodes.outlineBody.create({},[se.nodes.paragraph.create({},[])]),se.nodes.outlineChildren.create({},[])]),ye=Z.tr.insert(pe,Q);return ye=ye.setSelection(be.create(ye.doc,pe+2)),ye=ye.setMeta(le,!0),ke&&(ye=ye.setMeta(ke,{type:"enter",sectionId:me})),fe(ye.scrollIntoView()),!0})}catch{}};te.push(l(r.deleteBtn,()=>yt())),te.push(l(r.moveUpBtn,()=>re("up"))),te.push(l(r.moveDownBtn,()=>re("down"))),te.push(l(r.outdentBtn,()=>Qe())),te.push(l(r.indentBtn,()=>he())),te.push(l(r.newBelowBtn,()=>Et()));for(let Z of i)te.push(d(Z,()=>S(Z)));for(let Z of c)te.push(l(Z,()=>{let fe=Z.dataset.outlineAction||"";if(fe==="insertHttpLink"){h(),q().finally(()=>W());return}if(fe==="insertArticleLink"){h(),j().finally(()=>W());return}let ge=m(fe);h(),ge&&W()}));for(let Z of a)te.push(l(Z,()=>{let fe=Z.getAttribute("data-outline-clipboard-action")||"";if(!fe)return;h();let ge=en||null,de=nr instanceof Set?nr:new Set,se=de.size?new Set(de):ge?new Set([ge]):new Set;if(fe==="toggleSelectMode"){po(!Fn);return}if(fe==="clear"){Rs(null),ve("\u0411\u0443\u0444\u0435\u0440 \u043E\u0447\u0438\u0449\u0435\u043D");return}if(ce){if(fe==="copy"||fe==="cut"){if(!se.size){ve("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A");return}let pe=tp(ce.state.doc,se);if(!pe.length){ve("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A");return}let me=pe.map(Pe=>Pe.node.toJSON());try{let Pe=pe.map(He=>Ql(He.node)).filter(Boolean).join(`

`);rp(Pe)}catch{}if(Rs({mode:fe==="cut"?"cut":"copy",sourceArticleId:St||u.articleId||null,createdAt:new Date().toISOString(),sections:me}),fe==="copy"){ve(`\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${me.length}`);return}let Q=[];for(let Pe of pe){let He=at(ce.state.doc,Pe.id),Ge=typeof He=="number"?ce.state.doc.nodeAt(He):null;typeof He=="number"&&Ge&&Q.push({pos:He,size:Ge.nodeSize})}Q.sort((Pe,He)=>He.pos-Pe.pos);let ye=ce.state.tr;for(let{pos:Pe,size:He}of Q)ye=ye.delete(Pe,Pe+He);ye=ye.setMeta(le,!0),ce.view.dispatch(ye.scrollIntoView()),ce.view.focus(),nn=!0,tn({delayMs:200}),po(!1),ve(`\u0412\u044B\u0440\u0435\u0437\u0430\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${me.length}`);return}if(fe==="paste"){let pe=Nl();if(!pe||!Array.isArray(pe.sections)||!pe.sections.length){ve("\u0411\u0443\u0444\u0435\u0440 \u043F\u0443\u0441\u0442");return}let me=ce.state,Q=me.doc.content.size;if(ge){let qe=at(me.doc,ge),rt=typeof qe=="number"?me.doc.nodeAt(qe):null;typeof qe=="number"&&rt&&(Q=qe+rt.nodeSize)}let ye=new Set;try{me.doc.descendants(qe=>{if(qe?.type?.name!=="outlineSection")return;let rt=String(qe.attrs?.id||"").trim();rt&&ye.add(rt)})}catch{}let Pe=[];if(pe.mode==="copy")for(let qe of pe.sections)Pe.push(np(qe,()=>Ut()));else for(let qe of pe.sections){let rt=String(qe?.attrs?.id||"").trim();if(rt&&ye.has(rt)){ve("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C: \u0431\u043B\u043E\u043A \u0441 \u0442\u0430\u043A\u0438\u043C id \u0443\u0436\u0435 \u0435\u0441\u0442\u044C");return}Pe.push(Xl(qe))}let He=me.doc.type.schema,Ge=[];for(let qe of Pe)try{let rt=He.nodeFromJSON(qe);rt?.type?.name==="outlineSection"&&Ge.push(rt)}catch{}if(!Ge.length){ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438");return}let Ze=me.tr,je=Q;for(let qe of Ge)Ze=Ze.insert(je,qe),je+=qe.nodeSize;Ze=Ze.setMeta(le,!0),ce.view.dispatch(Ze.scrollIntoView()),ce.view.focus(),nn=!0,tn({delayMs:200}),pe.mode==="cut"&&Rs(null),po(!1),ve(`\u0412\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${Ge.length}`)}}}));let qt=Z=>{u.isOutlineEditing&&(t.contains(Z.target)||h())},Wt=Z=>{u.isOutlineEditing&&Z.key==="Escape"&&h()};document.addEventListener("pointerdown",qt),document.addEventListener("keydown",Wt),te.push(()=>document.removeEventListener("pointerdown",qt)),te.push(()=>document.removeEventListener("keydown",Wt));let Tn=e.on("transaction",W),Bn=e.on("selectionUpdate",W);te.push(()=>Tn?.()),te.push(()=>Bn?.());try{let Z=fp({setActiveTagKey:fe=>{try{pi?.(fe)}catch{}}});te.push(()=>Z?.())}catch{}W(),ai=()=>{X&&(window.cancelAnimationFrame(X),X=null);for(let Z of te)try{Z()}catch{}}}function Np(){if(ai)try{ai()}catch{}ai=null}function zn(e=""){let t=String(e||"");u.outlineStatusText=t,V.updatedAt&&u.isOutlineEditing&&(V.updatedAt.textContent=t)}function Mp(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=r.child(1),s=t+1+o.nodeSize,c=n.tr;if(!i.childCount){let l=n.doc.type.schema;c=c.insert(s+1,l.nodes.paragraph.create({},[]))}let{TextSelection:a}=ze?.pmStateMod||{};return a?(c=c.setSelection(a.near(c.doc.resolve(s+2),1)),e.view.dispatch(c.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0):!1}catch{return!1}}function Lp(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=t+1,{TextSelection:s}=ze?.pmStateMod||{};if(!s)return!1;let c=i+1,a=i+o.nodeSize-1,l=Math.min(Math.max(c,c),Math.max(c,a)),d=n.tr.setSelection(s.near(n.doc.resolve(l),1));return d=d.setMeta(le,!0),e.view.dispatch(d.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0}catch{return!1}}function Pp(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=t+1,{TextSelection:s}=ze?.pmStateMod||{};if(!s)return!1;let c=i+1,a=i+o.nodeSize-1,l=Math.max(c,a),d=n.tr.setSelection(s.near(n.doc.resolve(l),-1));return d=d.setMeta(le,!0),e.view.dispatch(d.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0}catch{return!1}}function _p(e,t){try{if(!e)return!1;let n=String(t||"").trim();if(!n)return!1;let r=e.state,o=at(r.doc,n);if(typeof o!="number")return!1;let i=r.doc.nodeAt(o);if(!i||i.type?.name!=="outlineSection")return!1;if(i.attrs?.collapsed)return Lp(e,o);try{if(!i.child(1)?.childCount)return Pp(e,o)}catch{}return Mp(e,o)}catch{return!1}}async function Dp(){if(ze)return ze;if(typeof window>"u")throw new Error("Outline editor is browser-only");let e=pr()?performance.now():0,t=await import("/outline/tiptap.bundle.js");return e&&Or("import tiptap.bundle.js",{ms:Math.round(performance.now()-e)}),ze={core:t.core,starterKitMod:t.starterKitMod,htmlMod:t.htmlMod,pmStateMod:t.pmStateMod,pmViewMod:t.pmViewMod,pmTablesMod:t.pmTablesMod,linkMod:t.linkMod,imageMod:t.imageMod,tableMod:t.tableMod,tableRowMod:t.tableRowMod,tableCellMod:t.tableCellMod,tableHeaderMod:t.tableHeaderMod,uniqueIdMod:t.uniqueIdMod,markdownMod:t.markdownMod},ze}function Op({blocks:e,parseHtmlToNodes:t}){let n=i=>Array.isArray(i)&&i.length>0?i:[{type:"paragraph",content:[]}],r=i=>{let s=String(i?.id||Ut()),c=!!i?.collapsed,a=Dn(String(i?.text||"")),l=Ys(a.titleHtml)||"",d=n(t(a.bodyHtml||"")),p=Array.isArray(i?.children)?i.children:[];return{type:"outlineSection",attrs:{id:s,collapsed:c},content:[{type:"outlineHeading",content:l?[{type:"text",text:l}]:[]},{type:"outlineBody",content:d},{type:"outlineChildren",content:p.map(r)}]}},o=(Array.isArray(e)?e:[]).map(r);return{type:"doc",content:o.length?o:[r({id:Ut(),text:"",collapsed:!1,children:[]})]}}function Rp(e){try{let t=String(e||"").trim();if(!t)return null;let n=window?.localStorage?.getItem?.("ttree_outline_last_active_v1")||"{}",r=JSON.parse(n||"{}"),o=r&&typeof r=="object"?r[t]:null;if(!o||typeof o!="object")return null;let i=String(o.sectionId||"").trim();return i?{sectionId:i,collapsed:!!o.collapsed}:null}catch{return null}}function fd(e,t,n){try{let r=String(e||"").trim(),o=String(t||"").trim();if(!r||!o)return!1;let i=window?.localStorage?.getItem?.("ttree_outline_last_active_v1")||"{}",s=JSON.parse(i||"{}"),c=s&&typeof s=="object"?s:{};return c[r]={sectionId:o,collapsed:!!n,savedAt:new Date().toISOString()},window?.localStorage?.setItem?.("ttree_outline_last_active_v1",JSON.stringify(c)),!0}catch{return!1}}function zl(e){try{let t=St||u.articleId||null;if(!t||!e||e.isDestroyed)return!1;let n=e.state,r=vt(n.doc,n.selection.$from);if(typeof r!="number")return!1;let o=n.doc.nodeAt(r);if(!o||o.type?.name!=="outlineSection")return!1;let i=String(o.attrs?.id||"").trim();if(!i)return!1;let s=!!o.attrs?.collapsed;return ii.articleId===t&&ii.sectionId===i&&ii.collapsed===s?!1:(ii={articleId:t,sectionId:i,collapsed:s},fd(t,i,s))}catch{return!1}}function Hp(e,{lines:t=4}={}){try{if(!e||e.isDestroyed)return!1;let n=e.view;if(!n||!n.state||!n.dom)return!1;let r=n.state.selection;return!r||typeof r.from!="number"?!1:(si&&cancelAnimationFrame(si),si=requestAnimationFrame(()=>{si=null;try{let o=n.coordsAtPos(r.from);if(!o||typeof o.bottom!="number")return;let s=(b=>{try{let x=b;for(;x&&x!==document.body&&x!==document.documentElement;){let v=window.getComputedStyle(x),L=String(v.overflowY||"");if((L==="auto"||L==="scroll"||L==="overlay")&&x.scrollHeight>x.clientHeight+2)return x;x=x.parentElement}}catch{}return document.scrollingElement||document.documentElement})(n.dom),c=window.getComputedStyle(n.dom),a=String(c.lineHeight||"").trim(),l=a==="normal"?20:Number.parseFloat(a)||20,d=Math.max(24,l*Math.max(1,Number(t)||4)+12),p=window.innerHeight||0,h=0;if(s&&s!==document.scrollingElement&&s!==document.documentElement&&s!==document.body){let b=s.getBoundingClientRect();h=b.top,p=b.height}if(!p)return;let y=o.bottom-h,S=p-d;if(y<=S)return;let f=y-S,m=Math.max(0,(s.scrollTop||0)+f);s.scrollTop=m}catch{}}),!0)}catch{return!1}}function vt(e,t){try{if(t?.nodeAfter?.type?.name==="outlineSection")return t.pos}catch{}for(let n=t.depth;n>0;n-=1)if(t.node(n)?.type?.name==="outlineSection")return t.before(n);return null}function yi(e){if(!e)return"";let t=e.child(0),n=e.child(1),r=hr(t?.textContent||""),o="";try{o=hr(n?.textBetween?.(0,n.content.size,`
`,`
`)||"")}catch{o=hr(n?.textContent||"")}return hr(`${r}
${o}`)}function Ul(e){if(!e)return"";let t=e.child(1),n="";try{n=hr(t?.textBetween?.(0,t.content.size,`
`,`
`)||"")}catch{n=hr(t?.textContent||"")}return n}function ql(e){if(!Us||!qs)return"";let t=[];return e?.content?.forEach?.(o=>{t.push(o.toJSON())}),(Us({type:"doc",content:t},qs)||""||"").trim()}function $p(e,t,n){if(!e||!t||!yo)return!1;let r=at(e.state.doc,t);if(typeof r!="number")return!1;let o=e.state.doc.nodeAt(r);if(!o)return!1;let i=o.child(0),s=o.child(1),c=r+1+i.nodeSize,a=e.state.schema,l=[];try{l=yo(n||"")}catch{l=[]}let d=[];try{d=(Array.isArray(l)?l:[]).map(y=>a.nodeFromJSON(y))}catch{d=[a.nodes.paragraph.create({},[])]}d.length||(d=[a.nodes.paragraph.create({},[])]);let p=a.nodes.outlineBody.create({},d),h=e.state.tr.replaceWith(c,c+s.nodeSize,p).setMeta(le,!0);return e.view.dispatch(h),!0}function Qs(e){if(!e)return!0;let t=e.child(0);return!hr(t?.textContent||"")}function Fp(e,t,n){if(!e||!t)return!1;let r=at(e.state.doc,t);if(typeof r!="number")return!1;let o=e.state.doc.nodeAt(r);if(!o||!Qs(o))return!1;let i=o.child(0),s=r+1,c=s+1,a=s+i.nodeSize-1,l=String(n||"").trim();if(!l)return!1;let d=l.length>200?l.slice(0,200):l,p=e.state.tr.insertText(d,c,a).setMeta(le,!0);return e.view.dispatch(p),!0}function zp(e){wr.clear(),e.descendants(t=>{if(t?.type?.name!=="outlineSection")return;let n=String(t.attrs?.id||"");n&&wr.set(n,yi(t))})}function at(e,t){let n=null;return e.descendants((r,o)=>{if(n!==null)return!1;r?.type?.name==="outlineSection"&&String(r.attrs?.id||"")===String(t||"")&&(n=o)}),n}function Up(e,t){try{let n=e.doc,r=at(n,t),o=typeof r=="number"?n.nodeAt(r):null;if(!o)return null;let i=e.schema,s=i.marks?.code||null,c=i.nodes?.codeBlock||null;if(!s||!c)return null;let a=o.child(0),l=o.child(1);if(!a||!l)return null;let p=r+1+a.nodeSize+1,h=[];if(l.descendants((S,f)=>{if(!S||S.type?.name!=="paragraph")return;let m=!1,b=!1,x=!0;for(let R=0;R<S.childCount;R+=1){let q=S.child(R);if(q){if(q.type?.name==="hardBreak"){b=!0;continue}if(q.isText){if(!String(q.text||""))continue;if(!(Array.isArray(q.marks)?q.marks:[]).some(W=>W?.type===s)){x=!1;break}m=!0;continue}x=!1;break}}if(!x||!m||!b)return;let v="";for(let R=0;R<S.childCount;R+=1){let q=S.child(R);if(q){if(q.type?.name==="hardBreak"){v+=`
`;continue}q.isText&&(v+=String(q.text||""))}}if(!v.trim())return;let L=p+f;h.push({from:L,to:L+S.nodeSize,text:v})}),!h.length)return null;let y=e.tr;for(let S=h.length-1;S>=0;S-=1){let{from:f,to:m,text:b}=h[S],x=y.doc.resolve(f),v=x.parent,L=x.index();if(!v?.canReplaceWith?.(L,L+1,c))continue;let R=i.text(b),q=c.create(null,R);y=y.replaceWith(f,m,q)}return y.docChanged?y.setMeta(le,!0):null}catch{return null}}function pd(e,t,n){if(!e||!t||!n||u.article?.encrypted)return;let r=at(t,n),o=typeof r=="number"?t.nodeAt(r):null;if(!o||!Qs(o))return;let i=Ul(o);if(!i)return;let s=Xs(i),c=Os.get(n)||null;c?.inFlight||c?.bodyHash!==s&&(Os.set(n,{bodyHash:s,inFlight:!0}),Oc(i).then(a=>{let l=String(a?.title||"").trim();if(!l||l.length>200)return;let d=e.state.doc,p=at(d,n),h=typeof p=="number"?d.nodeAt(p):null;if(!h||!Qs(h))return;let y=Ul(h);if(!(Xs(y)!==s||!Fp(e,n,l))){nn=!0;try{let f=St||u.articleId||null;f&&(Gs({articleId:f,doc:e.state.doc,sectionId:n,reason:"generate_title"}),zn("\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438 \u043D\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044E"))}catch{}tn({delayMs:900})}}).catch(()=>{}).finally(()=>{Os.set(n,{bodyHash:s,inFlight:!1})}))}function qp(e,t,n){if(!(!e||!t)&&!(!Array.isArray(n)||!n.length)&&!u.article?.encrypted&&!(typeof navigator<"u"&&navigator&&navigator.onLine===!1)){try{if((ke?.getState?.(e.state)||null)?.editingSectionId)return}catch{}for(let r of n)try{pd(e,t,r)}catch{}}}function Vl(e,t,n){let r=String(n||"").trim(),o=(p,h={})=>On("skip",{reason:p,sectionId:r,...h});if(!e||!t||!r){o("missing_args",{hasEditor:!!e,hasDoc:!!t,hasSectionId:!!r});return}if(u.article?.encrypted){o("encrypted_article");return}try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1){o("offline");return}}catch{}let i=at(t,r),s=typeof i=="number"?t.nodeAt(i):null;if(!s){o("section_not_found",{pos:typeof i=="number"?i:null});return}let c=s.child(1),a=ql(c);if(!a){o("empty_body_html");return}let l=$s(a),d=fo.get(r)||null;if(d?.inFlight){o("already_in_flight",{htmlHash:l});return}if(d?.status==="ok"&&d?.htmlHash===l){o("already_ok_same_hash",{htmlHash:l});return}if(d?.status==="error"&&d?.htmlHash===l){let p=Number(d?.lastAttemptAtMs||0)||0;if(Date.now()-p<Bl){o("error_cooldown",{htmlHash:l,lastAttemptAtMs:p,cooldownMs:Bl});return}}On("start",{sectionId:r,htmlHash:l}),fo.set(r,{htmlHash:l,inFlight:!0,status:d?.status||"ok",lastAttemptAtMs:Date.now()}),Rc(a).then(p=>{let h=String(p?.html||"").trim();if(!h){On("skip_apply",{sectionId:r,reason:"empty_corrected_html"});return}let y=e.state.doc,S=at(y,r),f=typeof S=="number"?y.nodeAt(S):null;if(!f){On("skip_apply",{sectionId:r,reason:"section_not_found_current_doc"});return}let m=ql(f.child(1));if($s(m)!==l){On("skip_apply",{sectionId:r,reason:"body_changed_since_request"});return}if($s(h)===l){On("skip_apply",{sectionId:r,reason:"no_changes_from_server"});return}if(!$p(e,r,h)){On("skip_apply",{sectionId:r,reason:"apply_failed"});return}nn=!0,tn({delayMs:900})}).catch(()=>{On("error",{sectionId:r,htmlHash:l}),fo.set(r,{htmlHash:l,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()})}).finally(()=>{(fo.get(r)||null)?.status!=="error"&&(fo.set(r,{htmlHash:l,inFlight:!1,status:"ok",lastAttemptAtMs:Date.now()}),On("done",{sectionId:r,htmlHash:l}))})}function gr(e,t){if(!t)return!1;let n=at(e,t);if(typeof n!="number")return!1;let r=e.nodeAt(n);if(!r)return!1;let o=yi(r),i=wr.get(t)||"";return o===i?!1:(er.add(t),!0)}function tn({delayMs:e=1200}={}){u.isOutlineEditing&&ce&&(u.isPublicView||St&&u.articleId&&St!==u.articleId||(Rn&&clearTimeout(Rn),Rn=setTimeout(()=>{Rn=null,ho()},Math.max(200,e))))}async function ho({force:e=!1}={}){if(u.isOutlineEditing&&ce&&!u.isPublicView&&!(St&&u.articleId&&St!==u.articleId)&&!ci&&!(!e&&!nn&&!er.size)){ci=!0,zn("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C\u2026");try{try{let t=ce.state,n=vt(t.doc,t.selection.$from);if(typeof n=="number"){let r=t.doc.nodeAt(n),o=String(r?.attrs?.id||"");o&&gr(t.doc,o)}}catch{}await Vp({silent:!0,mode:"queue"})}finally{ci=!1}}}async function md(){if(!V.outlineEditor)return;let e=V.outlineEditor.querySelector("#outlineEditorContent");if(!e){ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043C\u043E\u043D\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440");return}if(uo)return uo;uo=(async()=>{let t=pr()?performance.now():0,n=pr()?performance.now():0,{core:r,starterKitMod:o,htmlMod:i,pmStateMod:s,pmViewMod:c}=await Dp();n&&Or("loadTiptap()",{ms:Math.round(performance.now()-n)});let{Editor:a,Node:l,Extension:d,InputRule:p,mergeAttributes:h}=r,y=o.default||o.StarterKit||o,{generateJSON:S,generateHTML:f}=i,{TextSelection:m}=s,{Plugin:b,PluginKey:x}=s,{Decoration:v,DecorationSet:L}=c,R=ze.linkMod.default||ze.linkMod.Link||ze.linkMod,q=ze.imageMod.default||ze.imageMod.Image||ze.imageMod,j=ze.tableMod.TableKit||ze.tableMod.tableKit;ht={TableMap:ze.pmTablesMod?.TableMap||null,CellSelection:ze.pmTablesMod?.CellSelection||null,moveTableColumn:ze.pmTablesMod?.moveTableColumn||null,moveTableRow:ze.pmTablesMod?.moveTableRow||null,addRowBefore:ze.pmTablesMod?.addRowBefore||null,addRowAfter:ze.pmTablesMod?.addRowAfter||null,deleteRow:ze.pmTablesMod?.deleteRow||null,addColumnBefore:ze.pmTablesMod?.addColumnBefore||null,addColumnAfter:ze.pmTablesMod?.addColumnAfter||null,deleteColumn:ze.pmTablesMod?.deleteColumn||null,toggleHeaderRow:ze.pmTablesMod?.toggleHeaderRow||null,toggleHeaderColumn:ze.pmTablesMod?.toggleHeaderColumn||null};let $=ze.uniqueIdMod.default||ze.uniqueIdMod.UniqueID||ze.uniqueIdMod,X=ze.markdownMod?.Markdown||ze.markdownMod?.default?.Markdown||ze.markdownMod?.default||null,W=E=>{let g=String(E||"").trim();if(!g)return null;let k=g.match(/(\d+(?:\.\d+)?)px/i);if(!k)return null;let M=Number.parseFloat(k[1]);return Number.isFinite(M)?M:null},te=new x("outlineTagHighlighter"),be=l.create({name:"tag",group:"inline",inline:!0,atom:!0,selectable:!1,renderText({node:E}){try{return String(E?.attrs?.label||"").trim()}catch{return""}},addAttributes(){return{label:{default:""},key:{default:""}}},parseHTML(){return[{tag:'span[data-tt-tag="1"]'}]},renderHTML({node:E,HTMLAttributes:g}){let k=String(E?.attrs?.label||"").trim(),M=String(E?.attrs?.key||"").trim();return["span",h(g,{"data-tt-tag":"1","data-tag-key":M,class:"tt-tag"}),k||M||""]},addInputRules(){let E=/(^|[\s([{"'-])\\([^\\\n]{1,60}?)\\$/;return[new p({find:E,handler:({state:g,range:k,match:M})=>{let _=String(M?.[1]||""),B=String(M?.[2]||""),C=ed(B);if(!C)return null;let N=td(C);if(!N)return null;let T=g.schema.nodes?.tag;if(!T)return null;let I=T.create({label:N,key:N}),A=g.tr.delete(k.from,k.to),w=k.from;_&&(A=A.insertText(_,w),w+=_.length),A=A.insert(w,I);let D=m.near(A.doc.resolve(Math.min(A.doc.content.size,w+I.nodeSize)),1);return A=A.setSelection(D),A=A.setMeta(le,!0),A}})]}}),Oe=d.create({name:"outlineTagHighlighter",addProseMirrorPlugins(){return[new b({key:te,state:{init:()=>({activeKey:null}),apply:(E,g)=>{let k=E.getMeta(te);return k&&Object.prototype.hasOwnProperty.call(k,"activeKey")?{activeKey:k.activeKey?String(k.activeKey):null}:g}},props:{decorations(E){let g=te.getState(E)?.activeKey||null,k=[];return E.doc.descendants((M,_)=>{if(M?.type?.name!=="tag")return;let B=String(M.attrs?.key||"").trim();if(!B)return;let C=g&&B===g?"tt-tag tt-tag--active":"tt-tag";k.push(v.node(_,_+M.nodeSize,{class:C}))}),k.length?L.create(E.doc,k):null}}})]}}),re=q.extend({inline:!0,group:"inline",addAttributes(){return{...typeof this.parent=="function"?this.parent():{},width:{default:320,parseHTML:g=>{try{let k=g,M=k&&k.classList&&k.classList.contains("resizable-image")?k:k?.closest?.(".resizable-image"),_=W(M?.style?.width||"");if(_!==null)return Math.round(_);let B=W(M?.getAttribute?.("style")||"")||W(k?.getAttribute?.("style")||"");if(B!==null)return Math.round(B);let C=M?.getAttribute?.("data-width")||k?.getAttribute?.("data-width")||"",N=Number.parseFloat(String(C||""));return Number.isFinite(N)&&N>0?Math.round(N):320}catch{return 320}},renderHTML:()=>({})},uploadToken:{default:null,parseHTML:()=>null,renderHTML:()=>({})}}},parseHTML(){return[{tag:"span.resizable-image",getAttrs:E=>{let g=E,k=g?.querySelector?.("img"),M=k?.getAttribute?.("src")||"";if(!M)return!1;let _=k?.getAttribute?.("alt")||"",B=k?.getAttribute?.("title")||"",C=W(g?.style?.width||"")??320;return{src:M,alt:_,title:B,width:Math.round(C)}}},{tag:"img[src]",getAttrs:E=>{let g=E,k=g?.getAttribute?.("src")||"";if(!k)return!1;let M=g?.getAttribute?.("alt")||"",_=g?.getAttribute?.("title")||"";return{src:k,alt:M,title:_,width:320}}}]},renderHTML({node:E,HTMLAttributes:g}){let k=E?.attrs?.width,M=Number.isFinite(Number(k))?Math.round(Number(k)):320,_={...g};return delete _.width,delete _.uploadToken,["span",h({class:"resizable-image",style:`width:${M}px;max-width:100%;`},{}),["span",{class:"resizable-image__inner"},["img",h(_,{draggable:"false"})]],["span",{class:"resizable-image__handle","data-direction":"e","aria-hidden":"true"}]]}});Us=f,qs=[y.configure({heading:!1,link:!1}),R.configure({openOnClick:!1,protocols:ri}),re,j.configure({table:{resizable:!0}})];let he=d.create({name:"outlineImageUpload",addProseMirrorPlugins(){let E=_=>{if(!_)return!1;if(_.type&&String(_.type).startsWith("image/"))return!0;let B=String(_.name||"").toLowerCase();return!!(B&&/\.(png|jpe?g|gif|webp|bmp|svg|heic|heif)$/i.test(B))},g=(_,B)=>{let C=[];return Array.from(_||[]).forEach(N=>{if(N.kind!=="file")return;let T=typeof N.getAsFile=="function"?N.getAsFile():null;T&&E(T)&&C.push(T)}),!C.length&&B?.length&&Array.from(B).forEach(N=>{E(N)&&C.push(N)}),C},k=(_,B)=>{let C=`upl-${Date.now()}-${Math.random().toString(16).slice(2)}`,N=URL.createObjectURL(B);try{go.set(C,N)}catch{}try{let H=St||u.articleId||null;hl({token:C,articleId:H,kind:"image",blob:B,fileName:B?.name||"image",mime:B?.type||""})}catch{}let T=_.state.schema.nodes.image.create({src:N,alt:B?.name||"image",width:320,uploadToken:C}),I=_.state.tr,A=I.selection.from,w=I.selection.to;w>A&&(I=I.delete(A,w)),I=I.insertText("  ",A,A);let D=I.mapping.map(A,1);I=I.replaceRangeWith(D,D,T);let P=I.mapping.map(D+T.nodeSize,1);I=I.insertText("  ",P,P),I=I.setSelection(m.near(I.doc.resolve(Math.min(I.doc.content.size,P+1)),1)),I=I.setMeta(le,!0),_.dispatch(I.scrollIntoView());try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1){ve("\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E \u0438 \u0431\u0443\u0434\u0435\u0442 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E \u043F\u0440\u0438 \u043F\u043E\u044F\u0432\u043B\u0435\u043D\u0438\u0438 \u0441\u0435\u0442\u0438");return}}catch{}Jr(B).then(H=>{let O=String(H?.url||"").trim();if(!O)throw new Error("Upload failed");let F=js(_.state.doc,C);if(typeof F!="number")return;let U=_.state.doc.nodeAt(F);if(!U||U.type?.name!=="image")return;let J={...U.attrs,src:O,uploadToken:null},G=_.state.tr.setNodeMarkup(F,void 0,J);G=G.setMeta(le,!0),_.dispatch(G),Kl(C),vs(C).catch(()=>{})}).catch(H=>{ve(H?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435");try{window?.localStorage?.getItem?.("ttree_debug_outline_keys_v1")==="1"&&console.log("[outline][image]","upload.failed",{token:C,message:String(H?.message||H||"")})}catch{}try{let O=js(_.state.doc,C);if(typeof O!="number")return;let F=_.state.doc.nodeAt(O);if(!F||F.type?.name!=="image")return;let U=String(F.attrs?.title||"").trim(),J=U?`${U} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",G=String(F.attrs?.alt||B?.name||"image"),ae={...F.attrs,src:N,alt:G,title:J,uploadToken:C},xe=_.state.tr.setNodeMarkup(O,void 0,ae);xe=xe.setMeta(le,!0),_.dispatch(xe)}catch{}try{Es(C,String(H?.message||H||"error"))}catch{}})},M=(_,B,C,N)=>{try{if(!(ke?.getState?.(_.state)||null)?.editingSectionId)return!1}catch{return!1}let T=g(C,N);if(!T.length)return!1;B.preventDefault(),B.stopPropagation();for(let I of T)k(_,I);return!0};return[new b({props:{handleDOMEvents:{paste(_,B){let C=B?.clipboardData?.items||null,N=B?.clipboardData?.files||null;return M(_,B,C,N)},drop(_,B){let C=B?.dataTransfer?.items||null,N=B?.dataTransfer?.files||null;return M(_,B,C,N)}}},view(_){return{update(B,C){try{let N=ke?.getState?.(C)||{},T=ke?.getState?.(B.state)||{},I=N.editingSectionId||null,A=T.editingSectionId||null;if(I&&!A){let w=String(I||"").trim(),D=St||u.articleId||null;if(!w||!D)return;let P=!1;try{let H=at(B.state.doc,w),O=typeof H=="number"?B.state.doc.nodeAt(H):null;O?.type?.name==="outlineSection"&&(P=!!O.attrs?.collapsed)}catch{}fd(D,w,P);try{let H=at(B.state.doc,w),O=typeof H=="number"?B.state.doc.nodeAt(H):null;if(!O||O.type?.name!=="outlineSection")return;let F=!wr.has(w),U=F||gr(B.state.doc,w),J=!1;if(U){let ae=O.child(0),xe=O.child(1),ie=ae?.toJSON?ae.toJSON():null,Be=xe?.toJSON?xe.toJSON():null;if(ie&&Be){let De=Zl(ie,Be);if(De>ui){ve(`\u0411\u043B\u043E\u043A \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 (${Math.ceil(De/1024)} KB). \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C: ${Math.ceil(ui/1024)} KB. \u0420\u0430\u0437\u0431\u0435\u0439\u0442\u0435 \u0431\u043B\u043E\u043A \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E.`);try{let $e=B.state.tr.setMeta(le,!0);$e=$e.setMeta(ke,{type:"enter",sectionId:w}),B.dispatch($e)}catch{}return}let Je=Date.now(),it=Gl(D,w);try{ot("outline.enqueue.section_upsert_content",{articleId:D,sectionId:w,seq:it,bytes:De,reason:F?"exit_edit_mode_new_section":"exit_edit_mode"})}catch{}J=!0,Jt("section_upsert_content",{articleId:D,payload:{sectionId:w,headingJson:ie,bodyJson:Be,seq:it,clientQueuedAt:Je},coalesceKey:`content:${D}:${w}`})}}let G=!1;if(F||En||_t){let ae=bo(B.state.doc);if(ae.length){let xe=null;try{xe=ae.filter(ie=>ie&&(ie.parentId==null||ie.parentId==="")&&Number(ie.position)>=0).sort((ie,Be)=>Number(ie.position)-Number(Be.position)).slice(0,3).map(ie=>String(ie.sectionId||""))}catch{xe=null}try{ot("outline.enqueue.structure_snapshot",{articleId:D,nodesCount:ae.length,reason:F?"exit_edit_mode_new_section":"exit_edit_mode",rootFirst:xe})}catch{}Jt("structure_snapshot",{articleId:D,payload:{nodes:ae},coalesceKey:`structure:${D}`}),G=!0}En=!1,_t&&(clearTimeout(_t),_t=null)}try{(J||F)&&(wr.set(w,yi(O)),er.delete(w))}catch{}try{J&&ce&&!ce.isDestroyed&&ce.view===B&&pd(ce,B.state.doc,w)}catch{}(J||G)&&zn("\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438 \u043D\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044E")}catch{}}}catch{}}}}})]}}),Qe=d.create({name:"outlineImageResize",addProseMirrorPlugins(){return[new b({view(E){let g=null,k=(C,N)=>{try{if((E.state.selection?.node||null)?.type?.name==="image"&&typeof E.state.selection.from=="number")return E.state.selection.from;let I=F=>{if(typeof F!="number")return null;let U=[F,F-1,F+1,F-2,F+2];for(let J of U){if(J<0)continue;if(E.state.doc.nodeAt(J)?.type?.name==="image")return J}return null},A=C?.querySelector?.("img")||null,w=I(E.posAtDOM(C,0));if(typeof w=="number")return w;let D=A?I(E.posAtDOM(A,0)):null;if(typeof D=="number")return D;let P=N&&typeof N.clientX=="number"&&typeof N.clientY=="number"?{left:N.clientX,top:N.clientY}:null,H=P?E.posAtCoords(P):null,O=H&&typeof H.pos=="number"?I(H.pos):null;return typeof O=="number"?O:null}catch{return null}},M=C=>{if(C.button!==0)return;let N=C.target?.closest?.(".resizable-image__handle");if(!N)return;let T=N.closest(".resizable-image");if(!T||!E.dom.contains(T)||!(ke?.getState?.(E.state)||null)?.editingSectionId)return;let A=k(T,C);if(typeof A!="number")return;let w=E.state.doc.nodeAt(A);if(!w||w.type?.name!=="image")return;C.preventDefault(),C.stopPropagation();let D=T.getBoundingClientRect();g={pos:A,startWidth:D.width,startX:C.clientX,wrapper:T,lastWidth:D.width},T.classList.add("resizable-image--resizing")},_=C=>{if(!g)return;C.preventDefault();let N=C.clientX-g.startX,I=parseFloat(getComputedStyle(document.documentElement).fontSize)||16,A=Math.max(I,document.documentElement.clientWidth-32),w=g.startWidth+N;w=Math.max(I,Math.min(w,A)),g.lastWidth=w,g.wrapper.style.width=`${Math.round(w)}px`},B=()=>{if(!g)return;let{pos:C,wrapper:N}=g;N.classList.remove("resizable-image--resizing");let T=E.state.doc.nodeAt(C)?.type?.name==="image"?C:k(N,null),I=typeof T=="number"?E.state.doc.nodeAt(T):null;if(I&&I.type?.name==="image"){let A=Math.max(1,Math.round(Number(g.lastWidth||0)||N.getBoundingClientRect().width)),w={...I.attrs,width:A},D=E.state.tr.setNodeMarkup(T,void 0,w);D=D.setMeta(le,!0),E.dispatch(D)}g=null};return E.dom.addEventListener("pointerdown",M),document.addEventListener("pointermove",_),document.addEventListener("pointerup",B),document.addEventListener("pointercancel",B),{destroy(){E.dom.removeEventListener("pointerdown",M),document.removeEventListener("pointermove",_),document.removeEventListener("pointerup",B),document.removeEventListener("pointercancel",B)}}}})]}}),yt=d.create({name:"outlineImagePreview",addProseMirrorPlugins(){return[new b({props:{handleDOMEvents:{click(E,g){try{if((ke?.getState?.(E.state)||null)?.editingSectionId)return!1;let M=g?.target?.closest?.("img");return M?g.target?.closest?.(".resizable-image__handle")?(g.preventDefault(),!0):(g.preventDefault(),Wr(M.src,M.alt||""),!0):!1}catch{return!1}}}}})]}}),Et=d.create({name:"outlineMarkdownTablePaste",addProseMirrorPlugins(){let E=(g,k)=>{try{if(!(ke?.getState?.(g.state)||null)?.editingSectionId)return!1;let _=k?.clipboardData?.getData?.("text/plain")||"";if(ln("paste: text/plain",{len:_.length,sample:_.slice(0,200)}),!_)return!1;let B=Zs(_),C=yr(B);ln("paste: parsed",{ok:!!C,lines:B});let N=C?null:br(B);if(!C&&!N)return!1;let T=C?{header:C.header,rows:C.rows,withHeader:!0}:{header:null,rows:N.rows,withHeader:!1},I=null;try{I=Gn(g.state.schema,T)}catch(w){return ln("paste: buildTableNode error",{message:String(w?.message||w||""),stack:String(w?.stack||""),schemaNodes:Object.keys(g.state.schema?.nodes||{})}),!1}if(ln("paste: tableNode",{ok:!!I,schemaNodes:Ws()?Object.keys(g.state.schema?.nodes||{}):void 0}),!I)return!1;k.preventDefault(),k.stopPropagation();let A=g.state.tr;g.state.selection.empty||(A=A.deleteSelection());try{A=A.replaceSelectionWith(I,!1)}catch(w){return ln("paste: replaceSelectionWith error",{message:String(w?.message||w||""),stack:String(w?.stack||""),selection:{from:g.state.selection?.from,to:g.state.selection?.to,empty:g.state.selection?.empty,$fromParent:g.state.selection?.$from?.parent?.type?.name}}),!1}return A=A.setMeta(le,!0),g.dispatch(A.scrollIntoView()),!0}catch(M){return ln("paste: unexpected error",{message:String(M?.message||M||""),stack:String(M?.stack||"")}),!1}};return[new b({appendTransaction(g,k,M){try{let _=g?.some?.(A=>A?.docChanged),B=null;if(ke)for(let A of g||[]){let w=A?.getMeta?.(ke)||null;if(w?.type==="enter"&&w?.sectionId){B=String(w.sectionId);break}}let C=!!B;if(!_&&!C||g.some(A=>A.getMeta?.(le)))return null;let N=ke?.getState?.(M)||null,T=B||N?.editingSectionId||null;if(!T)return null;ln("appendTransaction: try convert",{didDocChange:_,didEnterEditMode:C,sectionId:T});let I=hp(M,T);if(I)return I;if(Ws()){let A=at(M.doc,T),w=typeof A=="number"?M.doc.nodeAt(A):null,D=w?w.child(1):null,P=D?D.textContent:"";String(P||"").includes("|")&&ln("appendTransaction: saw pipes but no conversion",{sectionId:T})}return Up(M,T)}catch{return null}},props:{handlePaste(g,k){return E(g,k)},handleDOMEvents:{paste(g,k){return E(g,k)}}}})]}}),qt=d.create({name:"outlineStructuredSectionPaste",addProseMirrorPlugins(){let E=B=>{let C=String(B||"").trim();if(!C)return{sections:[],startsWithHeading:!1,headingCount:0};if(!/<h[1-6][\s>]/i.test(C))return{sections:[],startsWithHeading:!1,headingCount:0};let N=null;try{N=new DOMParser().parseFromString(C,"text/html")}catch{return{sections:[],startsWithHeading:!1,headingCount:0}}let T=N?.body;if(!T)return{sections:[],startsWithHeading:!1,headingCount:0};let I=!1;try{let P=Array.from(T.childNodes||[]).find(H=>H?.nodeType===1&&String(H?.textContent||"").trim());I=!!(P&&/^H[1-6]$/.test(String(P.nodeName||"")))}catch{I=!1}let A=[],w=null,D=()=>{if(!w)return;let P=document.createElement("div");for(let O of w.nodes)try{P.appendChild(O.cloneNode(!0))}catch{}let H=String(P.innerText||P.textContent||"").trimEnd();A.push({level:w.level,title:w.title,bodyText:H}),w=null};for(let P of Array.from(T.childNodes||[])){let F=(P?.nodeType===1?String(P.nodeName||"").toUpperCase():"").match(/^H([1-6])$/);if(F){D();let U=Number(F[1]),J=String(P.textContent||"").trim();if(!J)continue;w={level:U,title:J,nodes:[]};continue}w&&w.nodes.push(P)}return D(),{sections:A,startsWithHeading:I,headingCount:A.length}},g=B=>{let C=B?.selection?.$from;if(!C)return null;for(let N=C.depth;N>0;N-=1)if(C.node(N)?.type?.name==="outlineSection")return C.before(N);return null},k=(B,C)=>{let N=String(C||"").replace(/\r\n/g,`
`).trimEnd(),T=B.nodes.paragraph;if(!T)return[];let I=B.nodes.hardBreak||B.nodes.hard_break||null,A=P=>{let H=String(P||"").split(`
`),O=[];for(let F=0;F<H.length;F+=1){let U=H[F];F>0&&I&&O.push(I.create()),U&&O.push(B.text(U))}return T.create({},O)};if(!N.trim())return[T.create({},[])];let w=N.split(/\n{2,}/),D=[];for(let P of w){let H=String(P||"").trimEnd();D.push(A(H))}return D.length?D:[T.create({},[])]},M=(B,C)=>{let N=B.nodes.outlineHeading.create({},C.title?[B.text(C.title)]:[]),T=k(B,C.bodyText),I=B.nodes.outlineBody.create({},T),A=(C.children||[]).map(D=>M(B,D)),w=B.nodes.outlineChildren.create({},A);return B.nodes.outlineSection.create({id:C.id,collapsed:!1},[N,I,w])},_=(B,C)=>{try{if(!(ke?.getState?.(B.state)||null)?.editingSectionId)return!1;let T=C?.clipboardData?.getData?.("text/html")||"",I=C?.clipboardData?.getData?.("text/plain")||"",A=T?E(T):{sections:[],startsWithHeading:!1,headingCount:0},w=!A.sections.length&&I?Ts(I):{sections:[],startsWithHeading:!1,headingCount:0},D=A.sections.length?A:w;if(!D.sections.length||!(D.startsWithHeading||D.sections.length>=2))return!1;C.preventDefault(),C.stopPropagation();let H=g(B.state);if(typeof H!="number")return!1;let O=B.state.doc.nodeAt(H);if(!O||O.type?.name!=="outlineSection")return!1;let F=bl(D.sections,{makeId:()=>Ut()});if(!F.length)return!1;let U=B.state.schema,J=F.map(xe=>M(U,xe)),G=B.state.tr,ae=H+O.nodeSize;for(let xe of J)G=G.insert(ae,xe),ae+=xe.nodeSize;return G=G.setMeta(le,!0),B.dispatch(G.scrollIntoView()),!0}catch{return!1}};return[new b({props:{handlePaste(B,C){return _(B,C)},handleDOMEvents:{paste(B,C){return _(B,C)}}}})]}}),Wt=(E="")=>{let g=String(E||"").trim();return g?g.startsWith("app:/")||g.startsWith("disk:/")?`/api/yandex/disk/file?path=${encodeURIComponent(g)}`:g:""},Tn=d.create({name:"outlineAttachmentUpload",addProseMirrorPlugins(){let E=C=>{let N=String(C?.type||"");return!(N&&N.startsWith("image/"))},g=(C,N)=>{let T=[];try{let I=[];if(N&&typeof N.length=="number")I.push(...Array.from(N||[]));else if(C&&typeof C.length=="number")for(let A of Array.from(C||[])){if(!A||A.kind!=="file")continue;let w=A.getAsFile?.();w&&I.push(w)}for(let A of I)A&&E(A)&&T.push(A)}catch{}return T},k=C=>`pending-attachment:${String(C||"")}`,M=(C,N)=>{let T=k(N),I=C?.type?.schema?.marks?.link||null;if(!I)return null;let A=null;return C.descendants((w,D)=>{if(A)return!1;!w||!w.isText||!(Array.isArray(w.marks)?w.marks:[]).find(O=>O?.type===I&&String(O?.attrs?.href||"")===T)||(A={from:D,to:D+w.nodeSize})}),A},_=(C,N)=>{let T=C?.state?.schema,I=T?.marks?.link||null;if(!T||!I){ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u0438\u0435: \u043D\u0435\u0442 \u0441\u0445\u0435\u043C\u044B \u0441\u0441\u044B\u043B\u043E\u043A");return}if(!u.articleId){ve("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}let A=Ut(),w=k(A),D=String(N?.name||"\u0444\u0430\u0439\u043B"),P=`${D} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430...)`,{from:H,to:O}=C.state.selection,F=C.state.tr.insertText(P,H,O);F=F.addMark(H,H+P.length,I.create({href:w})),F=F.setMeta(le,!0),C.dispatch(F.scrollIntoView()),No(u.articleId,N).then(U=>{let J=String(U?.storedPath||U?.url||U?.path||"").trim();if(!J)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443 \u043D\u0430 \u0444\u0430\u0439\u043B");let G=String(U?.originalName||N?.name||"\u0444\u0430\u0439\u043B"),ae=M(C.state.doc,A);if(!ae)return;let xe=C.state.tr.insertText(G,ae.from,ae.to);xe=xe.addMark(ae.from,ae.from+G.length,I.create({href:J})),xe=xe.setMeta(le,!0),C.dispatch(xe)}).catch(U=>{let J=M(C.state.doc,A);if(J){let G=`${D} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`,ae=C.state.tr.insertText(G,J.from,J.to);ae=ae.setMeta(le,!0),C.dispatch(ae)}ve(U?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u043D\u0430 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A")})},B=(C,N,T,I)=>{let A=g(T,I);if(!A.length)return!1;N.preventDefault(),N.stopPropagation();try{if(!(ke?.getState?.(C.state)||null)?.editingSectionId)return Rr(),!0}catch{return Rr(),!0}for(let w of A)_(C,w);return!0};return[new b({props:{handleDOMEvents:{drop(C,N){let T=N?.dataTransfer?.items||null,I=N?.dataTransfer?.files||null;return B(C,N,T,I)},paste(C,N){let T=N?.clipboardData?.items||null,I=N?.clipboardData?.files||null;return B(C,N,T,I)}}}})]}}),Bn=l.create({name:"doc",topNode:!0,content:"outlineSection+"}),Z=l.create({name:"outlineChildren",content:"outlineSection*",defining:!0,renderHTML(){return["div",{class:"outline-children","data-outline-children":"true"},0]},parseHTML(){return[{tag:"div[data-outline-children]"}]},addNodeView(){return({node:E})=>{let g=document.createElement("div");g.className="outline-children",g.setAttribute("data-outline-children","true");let k=M=>{let _=!M||M.childCount===0;g.setAttribute("data-empty",_?"true":"false")};return k(E),{dom:g,contentDOM:g,update(M){return!M||M.type?.name!=="outlineChildren"?!1:(k(M),!0)}}}}}),fe=E=>{try{if(!E||E.childCount===0)return!0;let g=!1;return E.descendants(k=>{if(g)return!1;let M=k?.type?.name;return M==="image"||M==="table"||k.isText&&String(k.text||"").replace(/\u00a0/g," ").trim()?(g=!0,!1):!0}),!g}catch{return!1}},ge=l.create({name:"outlineBody",content:"block*",defining:!0,renderHTML(){return["div",{class:"outline-body","data-outline-body":"true"},0]},parseHTML(){return[{tag:"div[data-outline-body]"}]},addNodeView(){return({node:E})=>{let g=document.createElement("div");g.className="outline-body",g.setAttribute("data-outline-body","true");let k=M=>{let _=fe(M);g.setAttribute("data-empty",_?"true":"false")};return k(E),{dom:g,contentDOM:g,update(M){return!M||M.type?.name!=="outlineBody"?!1:(k(M),!0)}}}}}),de=l.create({name:"outlineHeading",content:"inline*",defining:!0,renderHTML(){return["div",{class:"outline-heading","data-outline-heading":"true"},0]},parseHTML(){return[{tag:"div[data-outline-heading]"}]},addNodeView(){return({editor:E,getPos:g,node:k})=>{let M=document.createElement("div");M.className="outline-heading",M.setAttribute("data-outline-heading","true");let _=document.createElement("button");_.type="button",_.className="outline-heading__toggle",_.title="\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C/\u0440\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C (Ctrl+\u2190/\u2192), \u0441 \u0434\u0435\u0442\u044C\u043C\u0438 (Ctrl+\u2191/\u2193)",_.setAttribute("aria-label","\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C/\u0440\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C");let B=document.createElement("div");B.className="outline-heading__content";let C=document.createElement("button");C.type="button",C.className="outline-heading__select",C.setAttribute("role","checkbox"),C.setAttribute("aria-checked","false"),C.setAttribute("aria-label","\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0431\u043B\u043E\u043A"),C.textContent="\u2713",C.addEventListener("pointerdown",T=>{T.preventDefault()}),C.addEventListener("click",T=>{if(T.preventDefault(),T.stopPropagation(),!Fn)return;let I=typeof g=="function"?g():null;if(typeof I!="number")return;let A=I-1,w=E.state.doc.nodeAt(A),D=String(w?.attrs?.id||"").trim();D&&ep(D)});let N=()=>{let T=typeof g=="function"?g():null;if(typeof T!="number")return;let I=T-1,A=E.state.doc.nodeAt(I),w=String(A?.attrs?.id||"");w&&M.setAttribute("data-section-id",w),M.dataset.empty=k.content.size===0?"true":"false";let D=E.state.doc.resolve(Math.max(0,I+1)),P=0;for(let O=D.depth;O>=0;O-=1)D.node(O)?.type?.name==="outlineSection"&&(P+=1);M.dataset.depth=String(Math.min(6,Math.max(1,P||1)));let H=Fn&&w&&nr.has(w);C.setAttribute("aria-checked",H?"true":"false"),C.style.display=Fn?"inline-flex":"none"};return _.addEventListener("click",T=>{T.preventDefault(),T.stopPropagation();let I=typeof g=="function"?g():null;if(typeof I!="number")return;let A=I-1,w=E.state.doc.nodeAt(A);if(!w)return;let D=!w.attrs?.collapsed,P=E.state.tr.setNodeMarkup(A,void 0,{...w.attrs,collapsed:D});try{D&&ke&&(ke.getState(E.state)||{}).editingSectionId&&(P=P.setMeta(ke,{type:"exit"}))}catch{}P.setMeta(le,!0),E.view.dispatch(P),E.view.focus()}),M.appendChild(_),M.appendChild(B),M.appendChild(C),N(),{dom:M,contentDOM:B,update:T=>T.type.name!=="outlineHeading"?!1:(k=T,N(),!0)}}}}),se=l.create({name:"outlineSection",group:"block",content:"outlineHeading outlineBody outlineChildren",defining:!0,isolating:!0,draggable:!0,addAttributes(){return{collapsed:{default:!1}}},renderHTML({node:E,HTMLAttributes:g}){let k={...g,class:`outline-section${g?.class?` ${g.class}`:""}`,"data-outline-section":"true","data-section-id":E.attrs.id||"","data-collapsed":E.attrs.collapsed?"true":"false"};return["div",h(k),0]},parseHTML(){return[{tag:"div[data-outline-section]"}]}}),pe=E=>{if(!E)return!0;if((E.textContent||"").replace(/\u00a0/g," ").trim())return!1;if(E.childCount)for(let k=0;k<E.childCount;k+=1){let M=E.child(k);if(M.type?.name!=="paragraph"||(M.textContent||"").replace(/\u00a0/g," ").trim())return!1}return!0},me=E=>{if(!E)return!0;try{let g=E.child(0),k=E.child(1),M=E.child(2);return pe(g)&&pe(k)&&(!M||M.childCount===0)}catch{return!0}},Q=(E,g,k)=>{let M=E.doc.nodeAt(k);if(!M)return!1;let _=String(M.attrs?.id||"").trim(),B=E.doc.resolve(k),C=B.index(),N=B.parent;if(!N)return!1;if(N.childCount<=1){if(N.type?.name==="doc"){let U=E.doc.type.schema,J=U.nodes.outlineSection.create({...M.attrs,collapsed:!1},[U.nodes.outlineHeading.create({},[]),U.nodes.outlineBody.create({},[U.nodes.paragraph.create({},[])]),U.nodes.outlineChildren.create({},[])]),G=E.tr.replaceWith(k,k+M.nodeSize,J);G=G.setMeta(le,!0);let ae=J.child(0),xe=k+1+ae.nodeSize;return g(G.setSelection(m.near(G.doc.resolve(xe+2),1)).scrollIntoView()),!0}_&&_r(_);let O=null;try{for(let U=B.depth;U>0;U-=1)if(B.node(U)?.type?.name==="outlineSection"){O=B.before(U);break}}catch{O=null}let F=E.tr.delete(k,k+M.nodeSize);F=F.setMeta(le,!0);try{if(typeof O=="number"){let U=F.mapping.map(O,-1),J=F.doc.nodeAt(U);if(J&&J.type?.name==="outlineSection"){let G=J.child(0),ae=J.child(1),xe=U+1+G.nodeSize;if(!ae.childCount){let ie=F.doc.type.schema;F=F.insert(xe+1,ie.nodes.paragraph.create({},[]))}F=F.setSelection(m.near(F.doc.resolve(xe+2),1))}}}catch{}return g(F.scrollIntoView()),!0}let T=C>0,I=C<N.childCount-1,A=T?N.child(C-1):null,w=T?k-A.nodeSize:null,D=k+M.nodeSize;_&&_r(_);let P=E.tr.delete(k,k+M.nodeSize),H=(O,F)=>{try{let U=O.doc.nodeAt(F);if(!U||U.type?.name!=="outlineSection")return O;let J=U.child(0),ae=F+1+J.nodeSize-1;return O.setSelection(m.near(O.doc.resolve(ae),-1))}catch{return O}};if(I){let O=k<P.doc.content.size?k:D;P.doc.nodeAt(O)&&(P=H(P,O))}else T&&typeof w=="number"&&P.doc.nodeAt(w)&&(P=H(P,w));return P=P.setMeta(le,!0),g(P.scrollIntoView()),!0},ye=(E,g,k)=>{let M=E.doc.nodeAt(k);if(!M)return!1;let _=E.doc.resolve(k),B=_.index(),C=_.parent;if(!C||B<=0)return!1;let N=C.child(B-1),T=k-N.nodeSize,I=M.child(0),A=M.child(1),w=M.child(2),D=E.tr.delete(k,k+M.nodeSize),P=D.doc.nodeAt(T);if(!P)return D=D.setMeta(le,!0),g(D.scrollIntoView()),!0;let H=D.doc.type.schema,O=P.child(0),F=P.child(1),U=P.child(2),J=[],G=(I?.textContent||"").replace(/\u00a0/g," ").trim();G&&J.push(H.nodes.paragraph.create({},[H.text(G)])),A?.content?.forEach?.(Je=>{J.push(Je)});let ae=J.length?H.nodes.outlineBody.create({},J).content:null,xe=ae?F.content.append(ae):F.content,ie=U.content.append(w.content),Be=H.nodes.outlineSection.create(P.attrs,[O,H.nodes.outlineBody.create({},xe),H.nodes.outlineChildren.create({},ie)]);D=D.replaceWith(T,T+P.nodeSize,Be);let De=D.doc.nodeAt(T);if(De){let Je=De.child(0),it=De.child(1),st=T+1+Je.nodeSize+it.nodeSize-1;D=D.setSelection(m.near(D.doc.resolve(st),-1))}return D=D.setMeta(le,!0),g(D.scrollIntoView()),!0},Pe=(E,g,k)=>{let M=E.doc.nodeAt(k);if(!M)return!1;let _=E.selection.$from,B=null,C=null;for(let Je=_.depth;Je>0;Je-=1)if(_.node(Je)?.type?.name==="outlineSection")if(B===null)B=Je;else{C=Je;break}if(B===null||C===null)return!1;let N=_.before(C);if(!E.doc.nodeAt(N))return!1;let I=E.doc.type.schema,A=M.child(0),w=M.child(1),D=M.child(2),P=E.tr.delete(k,k+M.nodeSize),H=P.doc.nodeAt(N);if(!H)return P=P.setMeta(le,!0),g(P.scrollIntoView()),!0;let O=H.child(0),F=H.child(1),U=H.child(2),J=[],G=(A?.textContent||"").replace(/\u00a0/g," ").trim();G&&J.push(I.nodes.paragraph.create({},[I.text(G)])),w?.content?.forEach?.(Je=>{J.push(Je)});let ae=J.length?I.nodes.outlineBody.create({},J).content:null,xe=ae?F.content.append(ae):F.content,ie=D.content.append(U.content),Be=I.nodes.outlineSection.create({...H.attrs,collapsed:!1},[O,I.nodes.outlineBody.create({},xe),I.nodes.outlineChildren.create({},ie)]);P=P.replaceWith(N,N+H.nodeSize,Be);let De=P.doc.nodeAt(N);if(De){let Je=De.child(0),it=De.child(1),st=N+1+Je.nodeSize+it.nodeSize-1;P=P.setSelection(m.near(P.doc.resolve(st),-1))}return P=P.setMeta(le,!0),g(P.scrollIntoView()),!0},He=d.create({name:"outlineCommands",addKeyboardShortcuts(){let E=(z,ne)=>{for(let K=ne.depth;K>0;K-=1)if(ne.node(K)?.type?.name==="outlineSection")return ne.before(K);return null},g=(z,ne)=>{for(let K=z.depth;K>0;K-=1)if(z.node(K)?.type?.name===ne)return K;return null},k=z=>{if(!z)return!0;if((z.textContent||"").replace(/\u00a0/g," ").trim())return!1;if(z.childCount)for(let K=0;K<z.childCount;K+=1){let Y=z.child(K);if(Y.type?.name!=="paragraph"||(Y.textContent||"").replace(/\u00a0/g," ").trim())return!1}return!0},M=(z,ne)=>{let{selection:K}=z;if(!K||K.empty)return!1;let Y=E(z.doc,K.$from),oe=E(z.doc,K.$to);if(typeof Y!="number"||typeof oe!="number"||Y===oe||g(K.$from,"outlineBody")===null||K.$to.parent?.type?.name!=="outlineHeading"||K.$to.parentOffset!==0)return!1;let ue=z.doc.nodeAt(Y);if(!ue)return!1;let we=ue.child(0),Ie=ue.child(1),Ne=Y+1+we.nodeSize,Se=Ne+1,Le=Ne+Ie.nodeSize-1,Me=Math.max(K.from,Se),Te=Math.min(K.to,Le);if(Te<Me)return!0;let Ae=z.tr.delete(Me,Te),Ce=Ae.doc.nodeAt(Ne);if(Ce&&Ce.content.size===0){let Ee=Ae.doc.type.schema;Ae=Ae.insert(Se,Ee.nodes.paragraph.create({},[]))}return Ae=Ae.setSelection(m.near(Ae.doc.resolve(Se+1),1)),ne(Ae.scrollIntoView()),!0},_=(z,ne,K={})=>{let{selection:Y}=z;if(!Y||Y.empty)return!1;let oe=E(z.doc,Y.$from),ee=E(z.doc,Y.$to);if(typeof oe!="number"||typeof ee!="number"||oe!==ee)return!1;let ue=g(Y.$from,"outlineHeading"),we=g(Y.$to,"outlineHeading");if(ue===null||we===null)return!1;let Ie=z.doc.nodeAt(oe);if(!Ie)return!1;let Ne=Ie.child(0),Se=oe+1,Le=Se+1,Me=Se+Ne.nodeSize-1;if(Y.from<Le||Y.to>Me)return!1;let Te=Math.max(Y.from,Le),Ae=Math.min(Y.to,Me);if(Ae<Te)return!0;if(typeof K.onClipboard=="function")try{let Ee=z.doc.textBetween(Te,Ae,`
`,`
`);K.onClipboard(Ee)}catch{}let Ce=z.tr.delete(Te,Ae);return Ce=Ce.setSelection(m.near(Ce.doc.resolve(Le),1)),ne(Ce.scrollIntoView()),!0},B=z=>{if(!z)return!0;let ne=z.child(0),K=z.child(1),Y=z.child(2);return k(ne)&&k(K)&&(!Y||Y.childCount===0)},C=(z,ne,K)=>{let Y=z.doc.nodeAt(K);if(!Y)return!1;let oe=Y.child(0),ee=Y.child(1),we=K+1+oe.nodeSize+ee.nodeSize-1,Ie=z.tr.setSelection(m.near(z.doc.resolve(we),-1));return ne(Ie.scrollIntoView()),!0},N=(z,ne,K)=>{let Y=z.doc.nodeAt(K);if(!Y)return!1;let oe=Y.child(0),ee=K+1,ue=z.tr.setSelection(m.near(z.doc.resolve(ee+1),1));return ne(ue.scrollIntoView()),!0},T=(z,ne,K)=>{let Y=z.doc.nodeAt(K);if(!Y)return!1;let oe=Y.child(0),ee=Y.child(1),ue=K+1+oe.nodeSize,we=z.tr;if(!ee.childCount){let Ie=z.doc.type.schema;we=we.insert(ue+1,Ie.nodes.paragraph.create({},[]))}return we=we.setSelection(m.near(we.doc.resolve(ue+2),1)),ne(we.scrollIntoView()),!0},I=(z,ne,K)=>{let Y=z.doc.nodeAt(K);if(!Y)return!1;let oe=Y.child(0),ee=Y.child(1);if(!!Y.attrs?.collapsed){let Le=K+1+oe.nodeSize-1,Me=z.tr.setSelection(m.near(z.doc.resolve(Le),-1));return ne(Me),!0}let Ie=K+1+oe.nodeSize+ee.nodeSize-1,Ne=z.tr.setSelection(m.near(z.doc.resolve(Ie),-1));return ne(Ne),!0},A=(z,ne)=>{try{let K=z.resolve(Math.min(z.content.size,Math.max(0,ne+1)));for(let Y=K.depth;Y>0;Y-=1){let oe=K.node(Y);if(!(oe?.type?.name!=="outlineSection"||K.before(Y)===ne)&&oe.attrs?.collapsed)return!1}return!0}catch{return!0}},w=(z,ne)=>{let K=null;return z.nodesBetween(0,ne,(Y,oe)=>{if(oe>=ne)return!1;Y?.type?.name==="outlineSection"&&A(z,oe)&&(K=oe)}),K},D=(z,ne,K)=>{let Y=z.doc.nodeAt(K);if(!Y)return!1;let oe=String(Y.attrs?.id||"").trim(),ee=z.doc.resolve(K),ue=ee.index(),we=ee.parent;if(!we)return!1;if(we.childCount<=1){if(we.type?.name==="doc"){let Ce=z.doc.type.schema,Ee=Ce.nodes.outlineSection.create({...Y.attrs,collapsed:!1},[Ce.nodes.outlineHeading.create({},[]),Ce.nodes.outlineBody.create({},[Ce.nodes.paragraph.create({},[])]),Ce.nodes.outlineChildren.create({},[])]),Fe=z.tr.replaceWith(K,K+Y.nodeSize,Ee);Fe=Fe.setMeta(le,!0);let Re=Ee.child(0),Xe=K+1+Re.nodeSize;return ne(Fe.setSelection(m.near(Fe.doc.resolve(Xe+2),1)).scrollIntoView()),!0}let Te=null;try{for(let Ce=ee.depth;Ce>0;Ce-=1)if(ee.node(Ce)?.type?.name==="outlineSection"){Te=ee.before(Ce);break}}catch{Te=null}let Ae=z.tr.delete(K,K+Y.nodeSize);Ae=Ae.setMeta(le,!0);try{if(typeof Te=="number"){let Ce=Ae.mapping.map(Te,-1),Ee=Ae.doc.nodeAt(Ce);if(Ee&&Ee.type?.name==="outlineSection"){let Fe=Ee.child(0),Re=Ee.child(1),Xe=Ce+1+Fe.nodeSize;if(!Re.childCount){let lt=Ae.doc.type.schema;Ae=Ae.insert(Xe+1,lt.nodes.paragraph.create({},[]))}Ae=Ae.setSelection(m.near(Ae.doc.resolve(Xe+2),1))}}}catch{}return ne(Ae.scrollIntoView()),!0}oe&&_r(oe);let Ie=ue>0,Ne=Ie?we.child(ue-1):null,Se=Ie?K-Ne.nodeSize:null,Le=K+Y.nodeSize,Me=z.tr.delete(K,K+Y.nodeSize);if(Ie&&typeof Se=="number"){let Te=Me.doc.nodeAt(Se);if(Te){let Ae=Te.child(0),Ce=Te.child(1),Ee=Se+1+Ae.nodeSize;if(!Ce.childCount){let Fe=Me.doc.type.schema;Me=Me.insert(Ee+1,Fe.nodes.paragraph.create({},[]))}Me=Me.setSelection(m.near(Me.doc.resolve(Ee+2),1))}}else{let Te=K<Me.doc.content.size?K:Le,Ae=Me.doc.nodeAt(Te);if(Ae){let Ce=Ae.child(0),Ee=Ae.child(1),Fe=Te+1+Ce.nodeSize;if(!Ee.childCount){let Re=Me.doc.type.schema;Me=Me.insert(Fe+1,Re.nodes.paragraph.create({},[]))}Me=Me.setSelection(m.near(Me.doc.resolve(Fe+2),1))}}return Me=Me.setMeta(le,!0),ne(Me.scrollIntoView()),!0},P=(z,ne,K)=>{let Y=z.doc.nodeAt(K);if(!Y)return!1;let oe=String(Y.attrs?.id||"").trim(),ee=z.doc.resolve(K),ue=ee.index(),we=ee.parent;if(!we||ue<=0)return!1;oe&&_r(oe);let Ie=we.child(ue-1),Ne=K-Ie.nodeSize,Se=Y.child(0),Le=Y.child(1),Me=Y.child(2),Te=z.tr.delete(K,K+Y.nodeSize),Ae=Te.doc.nodeAt(Ne);if(!Ae)return Te=Te.setMeta(le,!0),ne(Te.scrollIntoView()),!0;let Ce=Te.doc.type.schema,Ee=Ae.child(0),Fe=Ae.child(1),Re=Ae.child(2),Xe=[],lt=(Se?.textContent||"").replace(/\u00a0/g," ").trim();lt&&Xe.push(Ce.nodes.paragraph.create({},[Ce.text(lt)])),Le?.content?.forEach?.(At=>{Xe.push(At)});let ft=Xe.length?Ce.nodes.outlineBody.create({},Xe).content:null,on=ft?Fe.content.append(ft):Fe.content,Rt=Re.content.append(Me.content),hn=Ce.nodes.outlineSection.create(Ae.attrs,[Ee,Ce.nodes.outlineBody.create({},on),Ce.nodes.outlineChildren.create({},Rt)]);Te=Te.replaceWith(Ne,Ne+Ae.nodeSize,hn);let dt=Te.doc.nodeAt(Ne);if(dt){let At=dt.child(0),wn=dt.child(1),Mt=Ne+1+At.nodeSize+wn.nodeSize-1;Te=Te.setSelection(m.near(Te.doc.resolve(Mt),-1))}return Te=Te.setMeta(le,!0),ne(Te.scrollIntoView()),!0},H=(z,ne,K)=>{let Y=z.doc.nodeAt(K);if(!Y)return!1;let oe=String(Y.attrs?.id||"").trim(),ee=z.selection.$from,ue=null,we=null;for(let At=ee.depth;At>0;At-=1)if(ee.node(At)?.type?.name==="outlineSection")if(ue===null)ue=At;else{we=At;break}if(ue===null||we===null)return!1;let Ie=ee.before(we);if(!z.doc.nodeAt(Ie))return!1;let Se=z.doc.type.schema,Le=Y.child(0),Me=Y.child(1),Te=Y.child(2);oe&&_r(oe);let Ae=z.tr.delete(K,K+Y.nodeSize),Ce=Ae.doc.nodeAt(Ie);if(!Ce)return Ae=Ae.setMeta(le,!0),ne(Ae.scrollIntoView()),!0;let Ee=Ce.child(0),Fe=Ce.child(1),Re=Ce.child(2),Xe=[],lt=(Le?.textContent||"").replace(/\u00a0/g," ").trim();lt&&Xe.push(Se.nodes.paragraph.create({},[Se.text(lt)])),Me?.content?.forEach?.(At=>{Xe.push(At)});let ft=Xe.length?Se.nodes.outlineBody.create({},Xe).content:null,on=ft?Fe.content.append(ft):Fe.content,Rt=Te.content.append(Re.content),hn=Se.nodes.outlineSection.create({...Ce.attrs,collapsed:!1},[Ee,Se.nodes.outlineBody.create({},on),Se.nodes.outlineChildren.create({},Rt)]);Ae=Ae.replaceWith(Ie,Ie+Ce.nodeSize,hn);let dt=Ae.doc.nodeAt(Ie);if(dt){let At=dt.child(0),wn=dt.child(1),Mt=Ie+1+At.nodeSize+wn.nodeSize-1;Ae=Ae.setSelection(m.near(Ae.doc.resolve(Mt),-1))}return Ae=Ae.setMeta(le,!0),ne(Ae.scrollIntoView()),!0},O=(z,ne,K)=>{let Y=z.doc.nodeAt(K);if(!Y)return!1;let oe=z.doc.resolve(K),ee=oe.index(),ue=oe.parent;if(!ue||ee>=ue.childCount-1)return!1;let we=K+Y.nodeSize,Ie=z.doc.nodeAt(we);if(!Ie||Ie.type?.name!=="outlineSection")return!1;let Ne=z.doc.type.schema,Se=Y.child(0),Le=Y.child(1),Me=Y.child(2),Te=Ie.child(1),Ae=Ie.child(2),Ce=Le.content.append(Te.content),Ee=Me.content.append(Ae.content),Fe=Ne.nodes.outlineSection.create({...Y.attrs,collapsed:!1},[Se,Ne.nodes.outlineBody.create({},Ce),Ne.nodes.outlineChildren.create({},Ee)]),Re=z.tr;Re=Re.delete(we,we+Ie.nodeSize),Re=Re.replaceWith(K,K+Y.nodeSize,Fe);let Xe=Re.doc.nodeAt(K);if(Xe){let lt=Xe.child(0),ft=Xe.child(1),Rt=K+1+lt.nodeSize+ft.nodeSize-1;Re=Re.setSelection(m.near(Re.doc.resolve(Rt),-1))}return Re=Re.setMeta(le,!0),ne(Re.scrollIntoView()),!0},F=z=>this.editor.commands.command(({state:ne,dispatch:K})=>{let Y=Te=>{try{if(typeof CSS<"u"&&CSS&&typeof CSS.escape=="function")return CSS.escape(String(Te||""))}catch{}return String(Te||"").replace(/["\\]/g,"\\$&")},oe=Te=>{try{let Ae=Te;for(;Ae&&Ae!==document.body;){let Ce=Ae.parentElement;if(!Ce)break;let Ee=window.getComputedStyle(Ce),Fe=String(Ee?.overflowY||"");if((Fe==="auto"||Fe==="scroll")&&Ce.scrollHeight>Ce.clientHeight+1)return Ce;Ae=Ce}}catch{}return document.scrollingElement||document.documentElement},ee=Te=>{try{let Ae=String(Te||"").trim();if(!Ae)return null;let Ce=document.querySelector(`.outline-heading[data-section-id="${Y(Ae)}"]`);if(!Ce)return null;let Ee=oe(Ce);return{sid:Ae,scrollEl:Ee,top:Ce.getBoundingClientRect().top}}catch{return null}},ue=Te=>{if(!Te)return;let{sid:Ae,scrollEl:Ce,top:Ee}=Te,Fe=()=>{try{let Re=document.querySelector(`.outline-heading[data-section-id="${Y(Ae)}"]`);if(!Re)return;let lt=Re.getBoundingClientRect().top-Ee;if(!Number.isFinite(lt)||Math.abs(lt)<1)return;Ce.scrollTop+=lt}catch{}};try{requestAnimationFrame(()=>requestAnimationFrame(Fe))}catch{setTimeout(Fe,0)}},we=E(ne.doc,ne.selection.$from);if(typeof we!="number")return!1;let Ie=ne.doc.resolve(we),Ne=Ie.index(),Se=Ie.parent;if(!Se)return!1;let Le=ne.doc.nodeAt(we);if(!Le)return!1;let Me=ee(String(Le.attrs?.id||"").trim());if(z==="up"){if(Ne>0){let Un=Se.child(Ne-1),Hn=we-Un.nodeSize,Lt=ne.tr.delete(we,we+Le.nodeSize).insert(Hn,Le).setMeta(le,!0),rr=m.near(Lt.doc.resolve(Hn+2),1);return Lt.setSelection(rr),K(Lt.scrollIntoView()),ue(Me),!0}let Te=ie(ne.doc,we);if(typeof Te!="number")return!1;let Ae=ne.doc.resolve(Te),Ce=Ae.index(),Ee=Ae.parent;if(!Ee||Ce<=0)return!1;let Fe=Ee.child(Ce-1),Re=Te-Fe.nodeSize,Xe=ne.doc.nodeAt(Re);if(!Xe||Xe.type?.name!=="outlineSection")return!1;let lt=Xe.child(0),ft=Xe.child(1),on=Xe.child(2),hn=Re+1+lt.nodeSize+ft.nodeSize+on.nodeSize-1,dt=ne.tr.delete(we,we+Le.nodeSize).setMeta(le,!0),At=dt.mapping.map(Re,-1),wn=dt.mapping.map(hn,-1);dt=dt.insert(wn,Le);let gn=dt.doc.nodeAt(At);gn?.type?.name==="outlineSection"&&gn.attrs?.collapsed&&(dt=dt.setNodeMarkup(At,void 0,{...gn.attrs,collapsed:!1}));let Mt=m.near(dt.doc.resolve(wn+2),1);return dt.setSelection(Mt),K(dt.scrollIntoView()),ue(Me),!0}if(z==="down"){if(Ne<Se.childCount-1){let Un=we+Le.nodeSize,Hn=ne.doc.nodeAt(Un);if(!Hn)return!1;let Lt=ne.tr.delete(we,we+Le.nodeSize).setMeta(le,!0),rr=we+Hn.nodeSize;Lt.insert(rr,Le);let wo=m.near(Lt.doc.resolve(rr+2),1);return Lt.setSelection(wo),K(Lt.scrollIntoView()),ue(Me),!0}let Te=ie(ne.doc,we);if(typeof Te!="number")return!1;let Ae=ne.doc.nodeAt(Te);if(!Ae||Ae.type?.name!=="outlineSection")return!1;let Ce=ne.doc.resolve(Te),Ee=Ce.index(),Fe=Ce.parent;if(!Fe||Ee>=Fe.childCount-1)return!1;let Re=Te+Ae.nodeSize,Xe=ne.doc.nodeAt(Re);if(!Xe||Xe.type?.name!=="outlineSection")return!1;let lt=Xe.child(0),ft=Xe.child(1),on=Xe.child(2),hn=Re+1+lt.nodeSize+ft.nodeSize+1,dt=ne.tr.delete(we,we+Le.nodeSize).setMeta(le,!0),At=dt.mapping.map(Re,-1),wn=dt.mapping.map(hn,-1);dt=dt.insert(wn,Le);let gn=dt.doc.nodeAt(At);gn?.type?.name==="outlineSection"&&gn.attrs?.collapsed&&(dt=dt.setNodeMarkup(At,void 0,{...gn.attrs,collapsed:!1}));let Mt=m.near(dt.doc.resolve(wn+2),1);return dt.setSelection(Mt),K(dt.scrollIntoView()),ue(Me),!0}return!1}),U=()=>this.editor.commands.command(({state:z,dispatch:ne})=>{let{selection:K}=z;if(!K?.empty)return!1;let{$from:Y}=K,oe=E(z.doc,Y);if(typeof oe!="number")return!1;let ee=z.doc.nodeAt(oe);if(!ee)return!1;let ue=z.doc.type.schema;if(ee.attrs?.collapsed){let Mt=oe+ee.nodeSize,Un=Ut(),Hn=ue.nodes.outlineSection.create({id:Un,collapsed:!1},[ue.nodes.outlineHeading.create({},[]),ue.nodes.outlineBody.create({},[ue.nodes.paragraph.create({},[])]),ue.nodes.outlineChildren.create({},[])]),Lt=z.tr.insert(Mt,Hn);return Lt=Lt.setSelection(m.create(Lt.doc,Mt+2)),Lt=Lt.setMeta(le,!0),ke&&(Lt=Lt.setMeta(ke,{type:"enter",sectionId:Un})),ne(Lt.scrollIntoView()),!0}let we=ue.nodes.outlineChildren.create({},[]),Ie=Mt=>Mt&&Mt.childCount?Mt:ue.nodes.outlineBody.create({},[ue.nodes.paragraph.create({},[])]);if(Y.parent?.type?.name==="outlineHeading"){let Mt=ee.child(0),Un=ee.child(1),Hn=ee.child(2),Lt=Y.parentOffset||0,rr=Mt.textBetween(0,Math.max(0,Math.min(Lt,Mt.content.size)),"",""),wo=Mt.textBetween(Math.max(0,Math.min(Lt,Mt.content.size)),Mt.content.size,"",""),yd=ue.nodes.outlineHeading.create({},rr?[ue.text(rr)]:[]),bd=ue.nodes.outlineHeading.create({},wo?[ue.text(wo)]:[]),ec=Ut(),tc=ue.nodes.outlineSection.create({...ee.attrs,collapsed:!1},[yd,Ie(ue.nodes.outlineBody.create({},[])),we]),wd=ue.nodes.outlineSection.create({id:ec,collapsed:!1},[bd,Ie(Un),Hn]),Sn=z.tr.replaceWith(oe,oe+ee.nodeSize,tc),nc=Sn.doc.nodeAt(oe),rc=oe+(nc?nc.nodeSize:tc.nodeSize);return Sn=Sn.insert(rc,wd),Sn=Sn.setSelection(m.create(Sn.doc,rc+2)),Sn=Sn.setMeta(le,!0),ke&&(Sn=Sn.setMeta(ke,{type:"enter",sectionId:ec})),ne(Sn.scrollIntoView()),!0}if(g(Y,"outlineBody")===null||!Y.parent?.isTextblock)return!1;let Se=z.tr,Le=K.from;try{Se=Se.split(Le)}catch{return!1}let Me=Se.mapping.map(Le);try{Se=Se.setSelection(m.near(Se.doc.resolve(Math.min(Se.doc.content.size,Me+1)),1))}catch{}let Te=Se.selection.$from,Ae=g(Te,"outlineBody"),Ce=g(Te,"paragraph");if(Ae===null||Ce===null)return!1;let Ee=Te.before(Ce),Fe=Te.end(Ae);if(typeof Ee!="number"||typeof Fe!="number"||Fe<Ee)return!1;let Re=Se.doc.slice(Ee,Fe).content;Se=Se.delete(Ee,Fe);let Xe=Se.mapping.map(oe,-1),lt=Se.doc.nodeAt(Xe);if(!lt)return ne(Se.scrollIntoView()),!0;let ft=lt.child(0),on=Ie(lt.child(1)),Rt=lt.child(2),hn=ue.nodes.outlineSection.create({...lt.attrs,collapsed:!1},[ft,on,we]),dt=Re&&Re.childCount?ue.nodes.outlineBody.create({},Re):ue.nodes.outlineBody.create({},[ue.nodes.paragraph.create({},[])]),At=Ut(),wn=ue.nodes.outlineSection.create({id:At,collapsed:!1},[ue.nodes.outlineHeading.create({},[]),dt,Rt]);Se=Se.replaceWith(Xe,Xe+lt.nodeSize,hn);let gn=Xe+hn.nodeSize;return Se=Se.insert(gn,wn),Se=Se.setSelection(m.create(Se.doc,gn+2)),Se=Se.setMeta(le,!0),ke&&(Se=Se.setMeta(ke,{type:"enter",sectionId:At})),ne(Se.scrollIntoView()),!0}),J=()=>this.editor.commands.command(({state:z,dispatch:ne})=>{let K=E(z.doc,z.selection.$from);if(typeof K!="number")return!1;let Y=z.doc.resolve(K),oe=0;for(let Xe=Y.depth;Xe>=0;Xe-=1)Y.node(Xe)?.type?.name==="outlineSection"&&(oe+=1);if(oe>=6)return!1;let ee=Y.index(),ue=Y.parent;if(!ue||ee<=0)return!1;let we=z.doc.nodeAt(K);if(!we)return!1;let Ie=ue.child(ee-1),Ne=K-Ie.nodeSize,Se=z.doc.nodeAt(Ne);if(!Se)return!1;let Le=Se.child(0),Me=Se.child(1),Te=Se.child(2),Ce=Ne+1+Le.nodeSize+Me.nodeSize+Te.nodeSize-1,Ee=z.tr.delete(K,K+we.nodeSize).insert(Ce,we).setMeta(le,!0),Fe=Ee.doc.nodeAt(Ne);Fe?.type?.name==="outlineSection"&&Fe.attrs?.collapsed&&(Ee=Ee.setNodeMarkup(Ne,void 0,{...Fe.attrs,collapsed:!1}));let Re=m.near(Ee.doc.resolve(Ce+2),1);return Ee.setSelection(Re),ne(Ee.scrollIntoView()),!0}),G=()=>this.editor.commands.command(({state:z,dispatch:ne})=>{let K=z.selection.$from,Y=null,oe=null;for(let Me=K.depth;Me>0;Me-=1)if(K.node(Me)?.type?.name==="outlineSection")if(Y===null)Y=Me;else{oe=Me;break}if(Y===null||oe===null)return!1;let ee=K.before(Y),ue=K.before(oe),we=z.doc.nodeAt(ee);if(!we)return!1;let Ie=z.tr.delete(ee,ee+we.nodeSize).setMeta(le,!0),Ne=Ie.doc.nodeAt(ue);if(!Ne)return!1;let Se=ue+Ne.nodeSize;Ie.insert(Se,we);let Le=m.near(Ie.doc.resolve(Se+2),1);return Ie.setSelection(Le),ne(Ie.scrollIntoView()),!0}),ae=z=>this.editor.commands.command(({state:ne,dispatch:K})=>{let Y=E(ne.doc,ne.selection.$from);if(typeof Y!="number")return!1;let oe=ne.doc.nodeAt(Y);if(!oe)return!1;let ee=typeof z=="boolean"?z:!oe.attrs?.collapsed,ue=ne.tr.setNodeMarkup(Y,void 0,{...oe.attrs,collapsed:ee}).setMeta(le,!0);try{ee&&ke&&(ke.getState(ne)||{}).editingSectionId&&(ue=ue.setMeta(ke,{type:"exit"}))}catch{}return K(ue),!0}),xe=(z,ne)=>{let K=z.nodeAt(ne);if(!K||K.type?.name!=="outlineSection")return[];let Y=[ne];return K.descendants((oe,ee)=>{oe?.type?.name==="outlineSection"&&Y.push(ne+1+ee)}),Y},ie=(z,ne)=>{try{let K=z.resolve(Math.min(z.content.size,ne+1)),Y=null;for(let oe=K.depth;oe>0;oe-=1){if(K.node(oe)?.type?.name!=="outlineSection")continue;if(K.before(oe)===ne){Y=oe;break}}if(Y===null)return null;for(let oe=Y-1;oe>0;oe-=1)if(K.node(oe)?.type?.name==="outlineSection")return K.before(oe);return null}catch{return null}},Be=(z,ne,K,Y)=>{let oe=!!Y,ee=z.tr;for(let ue of K){let we=ee.doc.nodeAt(ue);!we||we.type?.name!=="outlineSection"||!!we.attrs?.collapsed!==oe&&(ee=ee.setNodeMarkup(ue,void 0,{...we.attrs,collapsed:oe}))}ee=ee.setMeta(le,!0);try{oe&&ke&&(ke.getState(z)||{}).editingSectionId&&(ee=ee.setMeta(ke,{type:"exit"}))}catch{}ne(ee)},De=()=>this.editor.commands.command(({state:z,dispatch:ne})=>{let K=E(z.doc,z.selection.$from);if(typeof K!="number")return!1;let Y=ie(z.doc,K),oe=typeof Y=="number"?Y:K,ee=xe(z.doc,oe);if(!ee.length)return!1;let ue=z.tr;for(let Ie of ee){let Ne=ue.doc.nodeAt(Ie);!Ne||Ne.type?.name!=="outlineSection"||Ne.attrs?.collapsed||(ue=ue.setNodeMarkup(Ie,void 0,{...Ne.attrs,collapsed:!0}))}ue=ue.setMeta(le,!0);let we=ue.doc.nodeAt(oe);if(we){let Ie=we.child(0),Se=oe+1+Ie.nodeSize-1;ue=ue.setSelection(m.near(ue.doc.resolve(Se),-1))}return ne(ue.scrollIntoView()),!0}),Je=()=>this.editor.commands.command(({state:z,dispatch:ne})=>{let K=E(z.doc,z.selection.$from);if(typeof K!="number")return!1;let Y=xe(z.doc,K);return Y.length?(Be(z,ne,Y,!1),!0):!1}),it=(z,ne)=>{try{let K=z.nodeAt(ne);if(!K||K.type?.name!=="outlineSection")return[];if(K.childCount<3)return[];let Y=K.child(0),oe=K.child(1),ee=K.child(2);if(!ee||ee.type?.name!=="outlineChildren")return[];let ue=ne+1+Y.nodeSize+oe.nodeSize,we=[];return ee.descendants((Ie,Ne)=>{Ie?.type?.name==="outlineSection"&&we.push(ue+1+Ne)}),we}catch{return[]}},$e=(z,ne)=>{try{let K=ie(z,ne);if(typeof K!="number")return Dr(z);let Y=z.nodeAt(K);if(!Y||Y.type?.name!=="outlineSection"||Y.childCount<3)return Dr(z);let oe=Y.child(0),ee=Y.child(1),ue=Y.child(2);if(!ue||ue.type?.name!=="outlineChildren")return Dr(z);let we=K+1+oe.nodeSize+ee.nodeSize,Ie=[];return ue.descendants((Ne,Se)=>{Ne?.type?.name==="outlineSection"&&Ie.push(we+1+Se)}),Ie}catch{return Dr(z)}},st=(z,ne)=>{try{for(let K of ne||[]){let Y=z.nodeAt(K);if(!(!Y||Y.type?.name!=="outlineSection")&&Y.attrs?.collapsed)return!0}}catch{}return!1},ct=()=>this.editor.commands.command(({state:z,dispatch:ne})=>{let K=E(z.doc,z.selection.$from);if(typeof K!="number")return!1;let Y=z.doc.nodeAt(K);if(!Y||Y.type?.name!=="outlineSection")return!1;if(Y.attrs?.collapsed)return Be(z,ne,[K],!1),!0;let oe=it(z.doc,K);if(oe.length&&st(z.doc,oe))return Be(z,ne,oe,!1),!0;let ee=K;for(let we=0;we<64;we+=1){let Ie=$e(z.doc,ee);if(Ie.length&&st(z.doc,Ie))return Be(z,ne,Ie,!1),!0;let Ne=ie(z.doc,ee);if(typeof Ne!="number")break;ee=Ne}let ue=Dr(z.doc);return ue.length&&st(z.doc,ue)?(Be(z,ne,ue,!1),!0):!1}),xt=z=>this.editor.commands.command(({state:ne,dispatch:K})=>{let{selection:Y}=ne,ee=(Y?.node||null)?.type?.name==="outlineSection"?Y.from:E(ne.doc,ne.selection.$from);if(typeof ee!="number"||!ne.doc.nodeAt(ee))return!1;let we=!!z,Ie=xe(ne.doc,ee);return Ie.length?(Be(ne,K,Ie,we),!0):!1});return{"Alt-ArrowUp":()=>this.editor.isActive("table")?!1:F("up"),"Alt-ArrowDown":()=>this.editor.isActive("table")?!1:F("down"),"Alt-ArrowRight":()=>this.editor.isActive("table")?!1:J(),"Alt-ArrowLeft":()=>this.editor.isActive("table")?!1:G(),"Mod-ArrowRight":()=>ae(!1),"Mod-ArrowLeft":()=>ae(!0),"Mod-ArrowUp":()=>{try{let z=this.editor.state,ne=E(z.doc,z.selection.$from);if(typeof ne=="number"){let K=z.doc.nodeAt(ne);if(K?.type?.name==="outlineSection"&&typeof ie(z.doc,ne)!="number"&&K.attrs?.collapsed)return Ks(this.editor,!0)}}catch{}return De()},"Mod-ArrowDown":()=>ct(),"Mod-Enter":()=>{try{if(ke&&!(ke.getState(this.editor.state)||{}).editingSectionId)return!1}catch{}return U()},Backspace:()=>this.editor.commands.command(({state:z,dispatch:ne})=>{let{selection:K}=z;if(_(z,ne)||M(z,ne))return!0;if(!K?.empty)return!1;let{$from:Y}=K;if(Y.parent?.type?.name!=="outlineHeading"||Y.parentOffset!==0)return!1;let oe=E(z.doc,Y);if(typeof oe!="number")return!1;let ee=z.doc.nodeAt(oe);if(!ee)return!1;if(B(ee))return D(z,ne,oe);try{if(z.doc.resolve(oe).index()<=0)return H(z,ne,oe)}catch{}return P(z,ne,oe)}),Delete:()=>this.editor.commands.command(({state:z,dispatch:ne})=>{let{selection:K}=z;if(_(z,ne)||M(z,ne))return!0;if(!K?.empty)return!1;let{$from:Y}=K;if(g(Y,"outlineBody")!==null){let Ie=E(z.doc,Y);if(typeof Ie!="number")return!1;let Ne=z.doc.nodeAt(Ie);if(!Ne)return!1;let Se=Ne.child(0),Le=Ne.child(1),Te=Ie+1+Se.nodeSize+Le.nodeSize-1;return Y.pos===Te?O(z,ne,Ie):!1}if(Y.parent?.type?.name!=="outlineHeading")return!1;let ee=E(z.doc,Y);if(typeof ee!="number")return!1;let ue=z.doc.nodeAt(ee);if(!ue)return!1;let we=ue.child(0);if(Y.parentOffset===we.content.size){if(B(ue))return D(z,ne,ee);let Ie=ue.child(1),Ne=ee+1+we.nodeSize,Se=z.tr;if(!Ie.childCount){let Le=z.doc.type.schema;Se=Se.insert(Ne+1,Le.nodes.paragraph.create({},[]))}return Se=Se.setSelection(m.near(Se.doc.resolve(Ne+2),1)),ne(Se.scrollIntoView()),!0}return!1}),Enter:()=>this.editor.commands.command(({state:z,dispatch:ne})=>{let{selection:K}=z;if(!K?.empty)return!1;let{$from:Y}=K;if(Y.parent?.type?.name!=="outlineHeading")return!1;try{if(ke&&!(ke.getState(z)||{}).editingSectionId)return!1}catch{}let oe=E(z.doc,Y);if(typeof oe!="number")return!1;let ee=z.doc.nodeAt(oe);if(!ee)return!1;let ue=ee.child(0),we=ee.child(1),Ie=oe+1+ue.nodeSize,Ne=ue.content?.size??0;if(ee.attrs?.collapsed&&Y.parentOffset===Ne){let Le=oe+ee.nodeSize,Me=z.doc.type.schema,Te=Ut(),Ae=Me.nodes.outlineSection.create({id:Te,collapsed:!1},[Me.nodes.outlineHeading.create({},[]),Me.nodes.outlineBody.create({},[Me.nodes.paragraph.create({},[])]),Me.nodes.outlineChildren.create({},[])]),Ce=z.tr.insert(Le,Ae);return Ce=Ce.setSelection(m.create(Ce.doc,Le+2)),Ce=Ce.setMeta(le,!0),ke&&(Ce=Ce.setMeta(ke,{type:"enter",sectionId:Te})),ne(Ce.scrollIntoView()),!0}if(Y.parentOffset===0){let Le=z.doc.type.schema,Me=Ut(),Te=Le.nodes.outlineSection.create({id:Me,collapsed:!1},[Le.nodes.outlineHeading.create({},[]),Le.nodes.outlineBody.create({},[Le.nodes.paragraph.create({},[])]),Le.nodes.outlineChildren.create({},[])]),Ae=z.tr.insert(oe,Te);return Ae=Ae.setSelection(m.create(Ae.doc,oe+2)),Ae=Ae.setMeta(le,!0),ke&&(Ae=Ae.setMeta(ke,{type:"enter",sectionId:Me})),ne(Ae.scrollIntoView()),!0}if(Y.parentOffset>0&&Y.parentOffset<Ne){let Le=z.doc.type.schema,Me=ue.textBetween(0,Math.max(0,Math.min(Y.parentOffset,Ne)),"",""),Te=ue.textBetween(Math.max(0,Math.min(Y.parentOffset,Ne)),Ne,"",""),Ae=Le.nodes.outlineHeading.create({},Me?[Le.text(Me)]:[]),Ce=ee.child(2),Ee=[];try{for(let Rt=0;Rt<we.childCount;Rt+=1)Ee.push(we.child(Rt))}catch{}let Fe=Le.nodes.paragraph.create({},Te?[Le.text(Te)]:[]),Re=[];if(Te){let Rt=Ee[0]||null;Rt&&Rt.type?.name==="paragraph"&&k(Rt)?Re=[Fe,...Ee.slice(1)]:Re=[Fe,...Ee]}else Re=Ee;Re.length||(Re=[Le.nodes.paragraph.create({},[])]);let Xe=Le.nodes.outlineBody.create({},Re),lt=Le.nodes.outlineSection.create({...ee.attrs,collapsed:!1},[Ae,Xe,Ce]),ft=z.tr.replaceWith(oe,oe+ee.nodeSize,lt),on=ft.doc.nodeAt(oe);if(on){let Rt=on.child(0),hn=oe+1+Rt.nodeSize;ft=ft.setSelection(m.near(ft.doc.resolve(hn+2),1))}else ft=ft.setSelection(m.near(ft.doc.resolve(Ie+2),1));return ft=ft.setMeta(le,!0),ne(ft.scrollIntoView()),!0}let Se=z.tr;if(!we.childCount){let Le=z.doc.type.schema;Se=Se.insert(Ie+1,Le.nodes.paragraph.create({},[]))}return Se=Se.setSelection(m.near(Se.doc.resolve(Ie+2),1)),ne(Se.scrollIntoView()),!0}),ArrowUp:()=>this.editor.commands.command(({state:z,dispatch:ne})=>{let{selection:K}=z;if(!K?.empty)return!1;let{$from:Y}=K;if(Y.parent?.type?.name!=="outlineHeading"||Y.parentOffset!==0)return!1;let oe=E(z.doc,Y);if(typeof oe!="number")return!1;let ee=w(z.doc,oe);if(typeof ee=="number")return N(z,ne,ee);let ue=z.doc.resolve(oe),we=ue.index(),Ie=ue.parent;if(!Ie)return!1;if(we>0){let Me=Ie.child(we-1),Te=oe-Me.nodeSize;return N(z,ne,Te)}let Ne=null,Se=null;for(let Me=Y.depth;Me>0;Me-=1)if(Y.node(Me)?.type?.name==="outlineSection")if(Ne===null)Ne=Me;else{Se=Me;break}if(Se===null)return!1;let Le=Y.before(Se);return N(z,ne,Le)})}},addProseMirrorPlugins(){let E=(g,k)=>{for(let M=g.depth;M>0;M-=1)if(g.node(M)?.type?.name===k)return M;return null};return[new b({key:new x("outlineAltMoveRepeatGuard"),props:{handleKeyDown:(g,k)=>{try{if(!k||!k.altKey||k.metaKey||k.ctrlKey)return!1;let M=String(k.key||"");if(M!=="ArrowUp"&&M!=="ArrowDown"||!k.repeat)return!1;let _=g?.state,B=_?.selection?.$from;if(!B)return!1;for(let A=B.depth;A>0;A-=1){let w=B.node(A)?.type?.name;if(w&&String(w).startsWith("table"))return!1}let C=null;for(let A=B.depth;A>0;A-=1)if(B.node(A)?.type?.name==="outlineSection"){C=B.before(A);break}if(typeof C!="number")return!1;let N=_.doc.resolve(C),T=N.parent;if(!T)return!1;let I=N.index();return M==="ArrowUp"&&I<=0||M==="ArrowDown"&&I>=T.childCount-1}catch{return!1}}}}),new b({props:{handleDOMEvents:{cut:(g,k)=>{try{let{state:M}=g,{selection:_}=M;if(!_||_.empty)return!1;let B=(xe,ie)=>{for(let Be=ie.depth;Be>0;Be-=1)if(ie.node(Be)?.type?.name==="outlineSection")return ie.before(Be);return null},C=B(M.doc,_.$from),N=B(M.doc,_.$to);if(typeof C!="number"||typeof N!="number")return!1;let T=(xe="")=>String(xe||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");if(C===N){let xe=E(_.$from,"outlineHeading"),ie=E(_.$to,"outlineHeading");if(xe!==null&&ie!==null){let Be=M.doc.nodeAt(C);if(!Be)return!1;let De=Be.child(0),Je=C+1,it=Je+1,$e=Je+De.nodeSize-1;if(_.from>=it&&_.to<=$e){let st=Math.max(_.from,it),ct=Math.min(_.to,$e),xt=M.doc.textBetween(st,ct,`
`,`
`);if(k?.clipboardData)try{k.clipboardData.setData("text/plain",xt),k.clipboardData.setData("text/html",`<pre>${T(xt)}</pre>`)}catch{}k.preventDefault(),k.stopPropagation();let z=M.tr.delete(st,ct);return z=z.setSelection(m.near(z.doc.resolve(it),1)),g.dispatch(z.scrollIntoView()),!0}}return!1}if(E(_.$from,"outlineBody")===null||_.$to.parent?.type?.name!=="outlineHeading"||_.$to.parentOffset!==0)return!1;let A=M.doc.nodeAt(C);if(!A)return!1;let w=A.child(0),D=A.child(1),P=C+1+w.nodeSize,H=P+1,O=P+D.nodeSize-1,F=Math.max(_.from,H),U=Math.min(_.to,O);if(U<F)return!0;let J=M.doc.textBetween(F,U,`
`,`
`);if(k?.clipboardData)try{k.clipboardData.setData("text/plain",J),k.clipboardData.setData("text/html",`<pre>${T(J)}</pre>`)}catch{}k.preventDefault(),k.stopPropagation();let G=M.tr.delete(F,U),ae=G.doc.nodeAt(P);if(ae&&ae.content.size===0){let xe=G.doc.type.schema;G=G.insert(H,xe.nodes.paragraph.create({},[]))}return G=G.setSelection(m.near(G.doc.resolve(H+1),1)),g.dispatch(G.scrollIntoView()),!0}catch{return!1}}}}}),new b({props:{handleKeyDown:(g,k)=>{if(k.key!=="Backspace")return!1;let{state:M}=g,{selection:_}=M;if(!_?.empty)return!1;let{$from:B}=_;if(B.parent?.type?.name!=="paragraph"||B.parentOffset!==0)return!1;let C=null;for(let G=B.depth;G>0;G-=1)if(B.node(G)?.type?.name==="listItem"){C=G;break}if(C===null||B.index(C)!==0)return!1;let N=C-1,T=B.node(N);if(!T)return!1;let I=B.index(N);if(I<=0)return!1;let A=B.before(C),w=T.child(I-1),D=A-w.nodeSize,P=M.doc.nodeAt(A);if(!P||P.type?.name!=="listItem")return!1;k.preventDefault(),k.stopPropagation();let H=w.type.create(w.attrs,w.content.append(P.content),w.marks),O=M.tr.replaceWith(D,D+w.nodeSize,H),F=D+1+w.content.size,U=O.mapping.map(F,1),J=O.mapping.map(A);O=O.delete(J,J+P.nodeSize);try{O=O.setSelection(m.near(O.doc.resolve(U+1),1))}catch{}return g.dispatch(O.scrollIntoView()),!0}}}),new b({props:{handleKeyDown:(g,k)=>(k.key!=="Tab"||k.preventDefault(),!1)}}),new b({props:{handleKeyDown:(g,k)=>{if(!k.ctrlKey||k.shiftKey||k.altKey||k.metaKey||k.key!=="ArrowUp"&&k.key!=="ArrowDown")return!1;let{state:M}=g,{selection:_}=M;if(!_)return!1;let C=(()=>{if((_?.node||null)?.type?.name==="outlineSection")return _.from;let D=_.$from;for(let P=D.depth;P>0;P-=1)if(D.node(P)?.type?.name==="outlineSection")return D.before(P);return null})();if(typeof C!="number")return!1;let N=(w,D)=>{try{let P=w.resolve(Math.min(w.content.size,D+1)),H=null;for(let O=P.depth;O>0;O-=1)if(P.node(O)?.type?.name==="outlineSection"&&P.before(O)===D){H=O;break}if(H===null)return null;for(let O=H-1;O>0;O-=1)if(P.node(O)?.type?.name==="outlineSection")return P.before(O);return null}catch{return null}},T=(w,D)=>{let P=w.nodeAt(D);if(!P||P.type?.name!=="outlineSection")return[];let H=[D];return P.descendants((O,F)=>{O?.type?.name==="outlineSection"&&H.push(D+1+F)}),H};if(k.preventDefault(),k.stopPropagation(),k.key==="ArrowUp"){let w=N(M.doc,C),D=typeof w=="number"?w:C,P=T(M.doc,D);if(!P.length)return!0;let H=M.tr;for(let F of P){let U=H.doc.nodeAt(F);!U||U.type?.name!=="outlineSection"||U.attrs?.collapsed||(H=H.setNodeMarkup(F,void 0,{...U.attrs,collapsed:!0}))}let O=H.doc.nodeAt(D);if(O){let F=O.child(0),J=D+1+F.nodeSize-1;H=H.setSelection(m.near(H.doc.resolve(J),-1))}return g.dispatch(H.scrollIntoView()),!0}let I=T(M.doc,C);if(!I.length)return!0;let A=M.tr;for(let w of I){let D=A.doc.nodeAt(w);!D||D.type?.name!=="outlineSection"||D.attrs?.collapsed&&(A=A.setNodeMarkup(w,void 0,{...D.attrs,collapsed:!1}))}return g.dispatch(A),!0}}}),new b({props:{handleKeyDown:(g,k)=>{if(k.key!=="Enter")return!1;let{state:M}=g,{$from:_}=M.selection;if(!M.selection.empty)return!1;let B=E(_,"outlineBody");if(B===null)return!1;let C=E(_,"paragraph");if(C===null||_.node(C-1)?.type?.name!=="outlineBody")return!1;let N=_.node(C);if(!N||N.content.size!==0||_.parentOffset!==0&&_.parentOffset!==N.content.size)return!1;let T=_.node(B),I=_.index(B);if(I!==T.childCount-1||I<1)return!1;let A=T.child(I-1);if(!A||A.type?.name!=="paragraph"||A.content.size!==0)return!1;let w=E(_,"outlineSection");if(w===null)return!1;let D=_.before(w);k.preventDefault(),k.stopPropagation();let P=M.tr,H=_.start(B),O=H;for(let De=0;De<I;De+=1)O+=T.child(De).nodeSize;let F=I;for(let De=I;De>=0;De-=1){let Je=T.child(De);if(!Je||Je.type?.name!=="paragraph"||Je.content.size!==0)break;F=De}let U=H;for(let De=0;De<F;De+=1)U+=T.child(De).nodeSize;let J=O+T.child(I).nodeSize;P=P.delete(U,J);let G=P.doc.nodeAt(D);if(!G)return!0;let ae=D+G.nodeSize,xe=P.doc.type.schema,ie=Ut(),Be=xe.nodes.outlineSection.create({id:ie,collapsed:!1},[xe.nodes.outlineHeading.create({},[]),xe.nodes.outlineBody.create({},[xe.nodes.paragraph.create({},[])]),xe.nodes.outlineChildren.create({},[])]);return P=P.insert(ae,Be),P=P.setSelection(m.create(P.doc,ae+2)),P=P.setMeta(le,!0),ke&&(P=P.setMeta(ke,{type:"enter",sectionId:ie})),g.dispatch(P.scrollIntoView()),!0}}})]}}),Ge=d.create({name:"outlineActiveSection",addProseMirrorPlugins(){return[new b({props:{decorations(E){try{let g=vt(E.doc,E.selection.$from);if(typeof g!="number")return null;let k=E.doc.nodeAt(g);return k?L.create(E.doc,[v.node(g,g+k.nodeSize,{"data-active":"true"})]):null}catch{return null}}}})]}}),Ze=d.create({name:"outlineEditMode",addProseMirrorPlugins(){let E=new x("outlineEditMode");ke=E;let g=null,k=T=>{let I=vt(T.doc,T.selection.$from);if(typeof I!="number")return null;let A=T.doc.nodeAt(I);return String(A?.attrs?.id||"")||null},M=(T,I,A)=>{if(!I.docChanged)return!0;if(!A)return!1;let w=at(T.doc,A);if(typeof w!="number")return!1;let D=T.doc.nodeAt(w);if(!D)return!1;let P=D.child(0),H=D.child(1),O=w+1,F=O+1,U=O+P.nodeSize-1,J=w+1+P.nodeSize,G=J+1,ae=J+H.nodeSize-1,xe=(ie,Be)=>{let De=ie>=F&&Be<=U,Je=ie>=G&&Be<=ae;return De||Je};for(let ie of I.steps){let Be=ie.getMap(),De=!0;if(Be.forEach((Je,it)=>{xe(Je,it)||(De=!1)}),!De)return!1}return!0},_=()=>{try{ve("\u0414\u043B\u044F \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Enter \u0438\u043B\u0438 \u0434\u0432\u043E\u0439\u043D\u043E\u0439 \u043A\u043B\u0438\u043A \u043C\u044B\u0448\u043A\u043E\u0439. Esc \u0434\u043B\u044F \u0432\u044B\u0445\u043E\u0434\u0430.")}catch{}},B=()=>{try{ve("\u041D\u0430\u0436\u043C\u0438\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437, \u0447\u0442\u043E\u0431\u044B \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438")}catch{}},C=T=>{try{let{selection:I}=T;if(!I?.empty)return!1;let{$from:A}=I,w=null;for(let U=A.depth;U>0;U-=1)if(A.node(U)?.type?.name==="outlineHeading"){w=U;break}if(w===null||!(A.pos===A.start(w)))return!1;let P=vt(T.doc,A);if(typeof P!="number")return!1;if(T.doc.resolve(P).index()>0)return!0;let F=!1;for(let U=A.depth;U>0;U-=1)if(A.node(U)?.type?.name==="outlineSection"){if(!F){F=!0;continue}return!0}return!1}catch{return!1}},N=(T,I)=>{try{if(!I)return!1;let{selection:A}=T;if(!A?.empty)return!1;let{$from:w}=A,D=vt(T.doc,w);if(typeof D!="number")return!1;let P=T.doc.nodeAt(D);if(!P||String(P.attrs?.id||"")!==String(I))return!1;let H=P.child(0),O=P.child(1),U=D+1+H.nodeSize+O.nodeSize-1;if(w.pos!==U)return!1;let J=T.doc.resolve(D),G=J.index(),ae=J.parent;return ae?G<ae.childCount-1:!1}catch{return!1}};return[new b({key:E,state:{init(){return{editingSectionId:null}},apply(T,I){let A=T.getMeta(E);return A?A.type==="enter"?{editingSectionId:A.sectionId||null}:A.type==="exit"?{editingSectionId:null}:I:I}},filterTransaction(T,I){let w=(E.getState(I)||{}).editingSectionId||null;return T.getMeta(le)||T.getMeta("history$")!=null||T.getMeta("closeHistory$")!=null||!T.docChanged?!0:M(I,T,w)},props:{decorations(T){try{let A=(E.getState(T)||{}).editingSectionId||null;if(!A)return null;let w=at(T.doc,A);if(typeof w!="number")return null;let D=T.doc.nodeAt(w);return D?L.create(T.doc,[v.node(w,w+D.nodeSize,{"data-editing":"true"})]):null}catch{return null}},handleKeyDown(T,I){let A=T.state,D=(E.getState(A)||{}).editingSectionId||null;Ye("keydown",{key:I?.key||null,repeat:!!I?.repeat,editingSectionId:D||null,selection:{empty:!!A?.selection?.empty,parent:A?.selection?.$from?.parent?.type?.name||null,parentOffset:A?.selection?.$from?.parentOffset??null}});let P=k(A);if(!D&&(I.key==="Delete"||I.key==="Del"||I.key==="Backspace")&&(I.ctrlKey||I.metaKey)&&!I.shiftKey&&!I.altKey){try{deleteActiveSection()}catch{}return I.preventDefault(),I.stopPropagation(),!0}if(D&&I.key==="Backspace"&&!I.ctrlKey&&!I.metaKey&&!I.altKey){let O=mp(A,T.dispatch,D,m);if(Ye("editorProps.backspace.bodyToHeading",{promoted:O,editingSectionId:D}),O)return I.preventDefault(),I.stopPropagation(),!0;let F=pp(A,T.dispatch);if(Ye("editorProps.backspace.tableMerge",{merged:F,editingSectionId:D||null}),F)return I.preventDefault(),I.stopPropagation(),!0}try{let O=(I.key==="Enter"||I.code==="Enter"||I.code==="NumpadEnter")&&(I.ctrlKey||I.metaKey)&&!I.shiftKey&&!I.altKey;if(!u.isPublicView&&!D&&O){let F=A.selection,U=F?.$from||null;if(U){let J=vt(A.doc,U),G=typeof J=="number"?A.doc.nodeAt(J):null;if(typeof J=="number"&&G&&G.type?.name==="outlineSection"){let ae=!!(F&&F.empty),xe=U.parent?.type?.name==="outlineHeading",Be=ae&&xe&&U.parentOffset===0?J:J+G.nodeSize;I.preventDefault(),I.stopPropagation();let De=A.schema,Je=Ut(),it=De.nodes.outlineSection.create({id:Je,collapsed:!1},[De.nodes.outlineHeading.create({},[]),De.nodes.outlineBody.create({},[De.nodes.paragraph.create({},[])]),De.nodes.outlineChildren.create({},[])]),$e=A.tr.insert(Be,it);try{let ct=$e.doc.nodeAt(Be)?.child?.(0)||it.child(0),xt=Be+1+ct.nodeSize;$e=$e.setSelection(m.near($e.doc.resolve(xt+2),1))}catch{$e=$e.setSelection(m.create($e.doc,Be+2))}$e=$e.setMeta(le,!0),$e=$e.setMeta(E,{type:"enter",sectionId:Je}),T.dispatch($e.scrollIntoView());try{T.focus()}catch{}return!0}}}}catch{}if((!g||g.sectionId!==P||g.key!==I.key)&&(g=null),u.isPublicView&&!D&&(I.key==="Enter"&&!I.shiftKey&&!I.ctrlKey&&!I.metaKey&&!I.altKey||I.key==="F2"&&!I.shiftKey&&!I.ctrlKey&&!I.metaKey&&!I.altKey))return I.preventDefault(),I.stopPropagation(),!0;if(!D&&(I.key==="Enter"&&!I.shiftKey&&!I.ctrlKey&&!I.metaKey&&!I.altKey||I.key==="F2"&&!I.shiftKey&&!I.ctrlKey&&!I.metaKey&&!I.altKey)){let O=k(A);return O?(I.preventDefault(),I.stopPropagation(),T.dispatch(A.tr.setMeta(E,{type:"enter",sectionId:O})),!0):!1}if(D&&I.key==="Escape")return I.preventDefault(),I.stopPropagation(),T.dispatch(A.tr.setMeta(E,{type:"exit"})),!0;if(!D){let O=I.key&&I.key.length===1&&!I.metaKey&&!I.ctrlKey&&!I.altKey;if(I.key==="Backspace"||I.key==="Delete"){if(I.key==="Backspace"&&C(A))try{let{selection:U}=A,{$from:J}=U,G=findSectionPos(A.doc,J);if(typeof G!="number")return!1;let ae=A.doc.nodeAt(G);if(!ae)return!1;let xe=String(ae.attrs?.id||""),ie=null;try{let De=A.doc.resolve(G),Je=De.index(),it=De.parent;if(it&&Je>0){let $e=it.child(Je-1),st=G-$e.nodeSize,ct=A.doc.nodeAt(st);ie=String(ct?.attrs?.id||"")||null}else for(let $e=J.depth-1;$e>0;$e-=1){let st=J.node($e);if(st?.type?.name==="outlineSection"){let ct=String(st.attrs?.id||"");if(ct&&ct!==xe){ie=ct;break}}}}catch{ie=null}let Be=!1;if(me(ae))Be=Q(A,T.dispatch,G);else try{A.doc.resolve(G).index()<=0?Be=Pe(A,T.dispatch,G):Be=ye(A,T.dispatch,G)}catch{Be=ye(A,T.dispatch,G)}return Be&&ie&&window.setTimeout(()=>{try{if((E.getState(T.state)||{}).editingSectionId)return;let Je=at(T.state.doc,ie),it=typeof Je=="number"?T.state.doc.nodeAt(Je):null;if(!it)return;let $e=T.state.tr;it?.attrs?.collapsed&&($e=$e.setNodeMarkup(Je,void 0,{...it.attrs,collapsed:!1}),$e=$e.setMeta(le,!0)),$e=$e.setMeta(E,{type:"enter",sectionId:ie});try{let st=$e.doc.nodeAt(Je);if(st&&st.type?.name==="outlineSection"){let ct=st.child(0),xt=st.child(1),ne=Je+1+ct.nodeSize+xt.nodeSize-1;$e=$e.setSelection(m.near($e.doc.resolve(ne),-1))}}catch{}T.dispatch($e.scrollIntoView());try{T.focus()}catch{}}catch{}},0),I.preventDefault(),I.stopPropagation(),!0}catch{}return I.preventDefault(),I.stopPropagation(),!0}if(O)return I.preventDefault(),I.stopPropagation(),_(),!0}let H=I.key==="Backspace"&&C(A)||I.key==="Delete"&&N(A,D);if(D&&(I.key==="Backspace"||I.key==="Delete")&&H){if(I.repeat)return I.preventDefault(),I.stopPropagation(),!0;let O=Date.now();return g&&g.sectionId===D&&g.key===I.key&&O-g.ts<1200?(g=null,!1):(g={sectionId:D,key:I.key,ts:O},I.preventDefault(),I.stopPropagation(),B(),!0)}return!1},handleTextInput(){let T=arguments[0],I=T?.state?E.getState(T.state):null;return I&&I.editingSectionId?!1:(_(),!0)},handleDOMEvents:{paste(T,I){let A=T.state;return(E.getState(A)||{}).editingSectionId?!1:(I.preventDefault(),I.stopPropagation(),_(),!0)},drop(T,I){let A=T.state;return(E.getState(A)||{}).editingSectionId?!1:(I.preventDefault(),I.stopPropagation(),_(),!0)}}}})]}}),je=E=>{let g=(E||"").trim();if(!g)return[];let k=S(g,[y.configure({heading:!1,link:!1}),R.configure({openOnClick:!1,protocols:ri}),re,j.configure({table:{resizable:!0}})]),M=Array.isArray(k?.content)?k.content:[],_=[];for(let B=0;B<M.length;B+=1){let C=M[B];if(C?.type!=="paragraph"){_.push(C);continue}let T=_l(C).trim();if(!dn(T)){_.push(C);continue}let A=[],w=B,D=B;for(;D<M.length;D+=1){let O=M[D];if(O?.type!=="paragraph")break;let F=_l(O).trim();if(!F)break;A.push(F)}let P=yr(A);if(!P){_.push(C);continue}let H=gp(P);if(!H){_.push(C);continue}_.push(H),B=D-1,B<w&&(B=w)}return _};yo=je;let qe=d.create({name:"outlineMarkdown",addCommands(){return{insertMarkdown:E=>({editor:g})=>{if(!ke)return!1;if(!(ke.getState(g.state)||{}).editingSectionId)return Rr(),!1;if(!g?.storage?.markdown?.parser)return ve("Markdown \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F"),!1;let M=g.storage.markdown.parser.parse(String(E||""),{inline:!0}),_=je(M);return _.length?g.chain().focus().insertContent(_).run():!1}}}}),rt=d.create({name:"outlineFormattedPaste",addProseMirrorPlugins(){let E=this.editor,g=N=>{let T=String(N||"").trim();if(!T)return"";let I=null;try{I=new DOMParser().parseFromString(T,"text/html")}catch{return T}let A=I?.body;if(!A)return T;try{for(let w of Array.from(A.querySelectorAll("h1,h2,h3,h4,h5,h6"))){let D=I.createElement("p"),P=I.createElement("strong");try{for(;w.firstChild;)P.appendChild(w.firstChild)}catch{P.textContent=String(w.textContent||"")}D.appendChild(P),w.replaceWith(D)}}catch{}return String(A.innerHTML||"").trim()},k=N=>{let T=String(N||"").trim();if(!T||!T.includes("<")||!T.includes(">")||!/<\s*\/?\s*[a-z][^>]*>/i.test(T))return!1;try{let A=new DOMParser().parseFromString(T,"text/html")?.body;if(!A)return!1;let w=new Set(["p","br","strong","b","em","i","u","s","a","ul","ol","li","blockquote","pre","code","table","thead","tbody","tr","td","th","img","span","div","h1","h2","h3","h4","h5","h6"]);return!!Array.from(A.querySelectorAll("*")).find(P=>w.has(String(P.tagName||"").toLowerCase()))}catch{return!1}},M=N=>{let T=String(N||"").replace(/\r\n/g,`
`).trim();return T?[/```[\s\S]*```/m,/^\s{0,3}([-*+]|\d+\.)\s+\S/m,/^\s{0,3}>\s+\S/m,/\[[^\]]+\]\([^)]+\)/,/!\[[^\]]*\]\([^)]+\)/,/\*\*[^*\n]+\*\*/,/__[^_\n]+__/,/`[^`\n]+`/].some(A=>A.test(T)):!1},_=N=>{try{let T=String(N||"").replace(/\r\n/g,`
`).split(`
`).map(I=>String(I||"").trim()).filter(Boolean);return T.length<2?!1:!!yr(T)}catch{return!1}},B=(N,T)=>{if(!T||!Array.isArray(T)||!T.length)return!1;let I=N?.state?.selection?.from,A=N?.state?.selection?.to;if(!Number.isFinite(I)||!Number.isFinite(A))return!1;try{return E.chain().focus().command(({tr:w})=>(w.setMeta(le,!0),!0)).insertContentAt({from:I,to:A},T).run()}catch{return!1}},C=(N,T)=>{try{if(!(ke?.getState?.(N.state)||null)?.editingSectionId)return!1;let A=T?.clipboardData?.items||null,w=T?.clipboardData?.files||null;if(w&&w.length||A&&Array.from(A).some(H=>H?.kind==="file"))return!1;let D=String(T?.clipboardData?.getData?.("text/html")||"").trim(),P=String(T?.clipboardData?.getData?.("text/plain")||"").trim();if(D)try{if(!!/<h[1-6][\s>]/i.test(D))return!1}catch{}if(D){let H=g(D),O=je(H);return O.length?(T.preventDefault(),T.stopPropagation(),B(N,O)):!1}if(P&&k(P)){let H=g(P),O=je(H);return O.length?(T.preventDefault(),T.stopPropagation(),B(N,O)):!1}if(P&&M(P)){if(_(P))return!1;try{let G=Ts(P);if(G?.startsWithHeading||(G?.sections?.length||0)>=2)return!1}catch{}let H=E?.storage?.markdown?.parser||null;if(!H?.parse)return!1;let O=!P.includes(`
`)&&!/^\s{0,3}([-*+]|\d+\.)\s+\S/m.test(P)&&!/```[\s\S]*```/m.test(P)&&!/^\s{0,3}>\s+\S/m.test(P),F=String(H.parse(P,{inline:O})).trim();if(!F)return!1;let U=g(F),J=je(U);return J.length?(T.preventDefault(),T.stopPropagation(),B(N,J)):!1}return!1}catch{return!1}};return[new b({props:{handlePaste(N,T){return C(N,T)},handleDOMEvents:{paste(N,T){return C(N,T)}}}})]}}),tt=!1,Ke=null,Ve=pr()?performance.now():0,nt=u.article?.docJson||null;if(nt&&typeof nt=="object"&&nt.type==="doc"&&Array.isArray(nt.content)&&(Ke=nt),Ke||(Ke=Op({blocks:u.article?.blocks||[],parseHtmlToNodes:je}),tt=!!(u.article&&!u.article?.docJson&&!u.article?.encrypted)),Ve&&Or("build initial content",{ms:Math.round(performance.now()-Ve)}),ce){try{ce.destroy()}catch{}ce=null}let Ue=X?X.configure({html:!0,tightLists:!0,transformPastedText:!1,transformCopiedText:!1}):null,Ot=d.create({name:"outlineTableCellStyling",addOptions(){return{types:["tableCell","tableHeader"],textAlignValues:["left","center","right","justify"],verticalAlignValues:["top","middle","bottom"]}},addGlobalAttributes(){let E=(k,M)=>{try{let _=k?.style?.[M];return _?String(_).trim():""}catch{return""}},g=k=>{let M=[],_=k?.nodeTextAlign?String(k.nodeTextAlign):"",B=k?.nodeVerticalAlign?String(k.nodeVerticalAlign):"",C=k?.nodeTextColor?String(k.nodeTextColor):"",N=k?.nodeBackground?String(k.nodeBackground):"";return _&&this.options.textAlignValues.includes(_)&&M.push(`text-align: ${_}`),B&&this.options.verticalAlignValues.includes(B)&&M.push(`vertical-align: ${B}`),C&&M.push(`color: ${C}`),N&&M.push(`background-color: ${N}`),M.length?{style:M.join("; ")}:{}};return[{types:this.options.types,attributes:{nodeTextAlign:{default:null,parseHTML:k=>{let M=E(k,"textAlign");return M&&this.options.textAlignValues.includes(M)?M:null},renderHTML:k=>g(k)},nodeVerticalAlign:{default:null,parseHTML:k=>{let M=E(k,"verticalAlign");return M&&this.options.verticalAlignValues.includes(M)?M:null},renderHTML:k=>g(k)},nodeTextColor:{default:null,parseHTML:k=>{let M=E(k,"color");return M?String(M).replace(/['"]+/g,""):null},renderHTML:k=>g(k)},nodeBackground:{default:null,parseHTML:k=>{let M=E(k,"backgroundColor");return M?String(M).replace(/['"]+/g,""):null},renderHTML:k=>g(k)}}}]},addCommands(){let E=(k,M)=>({state:_,dispatch:B})=>{try{let C=Fs(_);if(!C.length)return!1;let N=_.tr,T=!1;for(let{node:I,pos:A}of C){if(!I||typeof A!="number")continue;let w={...I.attrs||{}};M==null||M===""?delete w[k]:w[k]=M,N=N.setNodeMarkup(A,void 0,w),T=!0}return T?(N=N.setMeta(le,!0),B(N),!0):!1}catch{return!1}},g=()=>({state:k,dispatch:M})=>{try{let _=Fs(k);if(!_.length)return!1;let B=k.schema.nodes?.paragraph||null;if(!B)return!1;let C=k.tr,N=[..._].sort((I,A)=>Number(A.pos)-Number(I.pos)),T=!1;for(let{node:I,pos:A}of N){if(!I||typeof A!="number")continue;let w=A+1,D=A+I.nodeSize-1;if(!(D>=w))continue;let P=B.createAndFill();P&&(C=C.replaceWith(w,D,P),T=!0)}return T?(C=C.setMeta(le,!0),M(C.scrollIntoView()),!0):!1}catch{return!1}};return{setNodeTextAlign:k=>E("nodeTextAlign",k),setNodeVAlign:k=>E("nodeVerticalAlign",k),setNodeTextColor:k=>E("nodeTextColor",k),setNodeBackground:k=>E("nodeBackground",k),unsetNodeAlignment:()=>({state:k,dispatch:M})=>{try{let _=Fs(k);if(!_.length)return!1;let B=k.tr,C=!1;for(let{node:N,pos:T}of _){if(!N||typeof T!="number")continue;let I=N.attrs?.nodeTextAlign||null,A=N.attrs?.nodeVerticalAlign||null;if(!I&&!A)continue;let w={...N.attrs||{}};delete w.nodeTextAlign,delete w.nodeVerticalAlign,B=B.setNodeMarkup(T,void 0,w),C=!0}return C?(B=B.setMeta(le,!0),M(B),!0):!1}catch{return!1}},clearNodeContents:()=>g()}}}),Ct=d.create({name:"outlineTablePercentWidths",addProseMirrorPlugins(){return[new b({view(E){let g=null,k=B=>{let C=String(B||"").trim();if(!C)return 0;let N=C.match(/(-?\\d+(?:\\.\\d+)?)px/i);return N&&Number(N[1])||0},M=()=>{g=null;try{let B=E?.dom;if(!B)return;let C=B.querySelectorAll(".tableWrapper > table");for(let N of C){let T=N.querySelector("colgroup");if(!T)continue;let I=Array.from(T.querySelectorAll("col"));if(!I.length||fr)continue;try{N.style.width="100%",N.style.maxWidth="100%",N.style.tableLayout="fixed"}catch{}let A=!1;for(let w of I){let D=w?.dataset?.ttPct||"",P=Number.parseFloat(String(D||""));if(Number.isFinite(P)&&P>0)A=!0,w.style.width=`${P.toFixed(4)}%`,w.style.minWidth="";else{let H=id(w.style.width);H!=null&&H>0&&(A=!0,w.dataset.ttPct=H.toFixed(4),w.style.width=`${H.toFixed(4)}%`,w.style.minWidth="")}}if(!A)try{let w=N.querySelector("tbody tr");if(!w)continue;let D=Array.from(w.children||[]).filter(U=>U&&U.nodeType===1);if(D.length<I.length)continue;let P=[];for(let U=0;U<I.length;U+=1){let J=D[U].getBoundingClientRect();P.push(Number.isFinite(J.width)?J.width:0)}let H=P.reduce((U,J)=>U+(Number.isFinite(J)?J:0),0);if(!(H>0))continue;let O=P.map(U=>Cn(U/H*100)),F=O.reduce((U,J)=>U+J,0);Math.abs(F-100)>.01&&(O[O.length-1]=Cn(O[O.length-1]+(100-F)));for(let U=0;U<I.length;U+=1)hi(I[U],O[U])}catch{}}}catch{}},_=()=>{g==null&&(g=window.requestAnimationFrame(M))};return _(),{update(){_()},destroy(){g!=null&&(window.cancelAnimationFrame(g),g=null)}}}})]}}),Nt=d.create({name:"outlineTableSmartMouseSelection",addProseMirrorPlugins(){let E=ht?.CellSelection||null;return E?[new b({view(g){let k=_=>{try{for(let B=_.depth;B>=0;B-=1){let C=_.node(B)?.type?.name;if(C==="tableCell"||C==="tableHeader")return _.before(B)}}catch{}return null},M=()=>{try{if(!(ke?.getState?.(g.state)||null)?.editingSectionId)return;let B=g.state.selection;if(!B||B.empty)return;let C=k(B.$anchor),N=k(B.$head);if(C==null||N==null||C===N)return;let T=typeof E.create=="function"?E.create(g.state.doc,C,N):null;if(!T)return;let I=g.state.tr.setSelection(T);I=I.setMeta(le,!0),g.dispatch(I)}catch{}};return g.dom.addEventListener("mouseup",M,!0),{destroy(){g.dom.removeEventListener("mouseup",M,!0)}}}})]:[]}}),Tt=d.create({name:"outlineTableResizeCapture",addProseMirrorPlugins(){return[new b({view(E){let g=M=>{try{if(!M?.target?.closest?.(".column-resize-handle")||!(ke?.getState?.(E.state)||null)?.editingSectionId)return;fr=!0}catch{}},k=()=>{if(fr){fr=!1;try{let M=E.domAtPos(E.state.selection.from),B=((M?.node&&M.node.nodeType===1?M.node:M?.node?.parentElement)||null)?.closest?.("table")||null;B&&di(B)}catch{}}};return E.dom.addEventListener("pointerdown",g,!0),document.addEventListener("pointerup",k,!0),document.addEventListener("pointercancel",k,!0),{destroy(){E.dom.removeEventListener("pointerdown",g,!0),document.removeEventListener("pointerup",k,!0),document.removeEventListener("pointercancel",k,!0)}}}})]}}),rn=d.create({name:"outlineTableNodeUi",addProseMirrorPlugins(){let E=this.editor,g=[{label:"Default text",value:null},{label:"Gray text",value:"var(--tt-color-text-gray)"},{label:"Brown text",value:"var(--tt-color-text-brown)"},{label:"Orange text",value:"var(--tt-color-text-orange)"},{label:"Yellow text",value:"var(--tt-color-text-yellow)"},{label:"Green text",value:"var(--tt-color-text-green)"},{label:"Blue text",value:"var(--tt-color-text-blue)"},{label:"Purple text",value:"var(--tt-color-text-purple)"},{label:"Pink text",value:"var(--tt-color-text-pink)"},{label:"Red text",value:"var(--tt-color-text-red)"}],k=[{label:"Default background",value:null},{label:"Gray background",value:"var(--tt-color-highlight-gray)"},{label:"Brown background",value:"var(--tt-color-highlight-brown)"},{label:"Orange background",value:"var(--tt-color-highlight-orange)"},{label:"Yellow background",value:"var(--tt-color-highlight-yellow)"},{label:"Green background",value:"var(--tt-color-highlight-green)"},{label:"Blue background",value:"var(--tt-color-highlight-blue)"},{label:"Purple background",value:"var(--tt-color-highlight-purple)"},{label:"Pink background",value:"var(--tt-color-highlight-pink)"},{label:"Red background",value:"var(--tt-color-highlight-red)"}],M=[{label:"Align left",value:"left"},{label:"Align center",value:"center"},{label:"Align right",value:"right"},{label:"Justify",value:"justify"}],_=[{label:"Align top",value:"top"},{label:"Align middle",value:"middle"},{label:"Align bottom",value:"bottom"}],B=I=>{try{if(!I)return null;let A={left:Number(I.left),top:Number(I.top),right:Number(I.right),bottom:Number(I.bottom),width:Number(I.width),height:Number(I.height)};return!Number.isFinite(A.left)||!Number.isFinite(A.top)?null:A}catch{return null}},C=(I,A,w,D,P=8)=>{try{let H=window.innerWidth||0,O=window.innerHeight||0,F=Math.max(P,Math.min(I,Math.max(P,H-w-P))),U=Math.max(P,Math.min(A,Math.max(P,O-D-P)));return{left:F,top:U}}catch{return{left:I,top:A}}};class N{constructor(){this.panels=[],this.onDocPointerDown=A=>{try{let w=A?.target||null,D=typeof A?.composedPath=="function"?A.composedPath():null,P=Array.isArray(D)&&D.length?D:w?[w]:[];if(!P.length)return;for(let H of P)for(let O of this.panels)if(O&&(H===O||O.contains(H)))return;this.closeAll()}catch{this.closeAll()}},this.onKeyDown=A=>{A?.key==="Escape"&&this.closeAll()}}isOpen(){return this.panels.length>0}closeAll(){try{for(let A of this.panels)A?.remove?.()}catch{}this.panels=[];try{document.removeEventListener("pointerdown",this.onDocPointerDown,!1),window.removeEventListener("keydown",this.onKeyDown,!1)}catch{}}openPanel({anchorRect:A,items:w,level:D=0}){let P=B(A);if(!P)return;for(;this.panels.length>D;){let G=this.panels.pop();try{G?.remove?.()}catch{}}let H=document.createElement("div");H.className="tt-table-menu",H.setAttribute("role","menu"),H.setAttribute("data-level",String(D)),H.addEventListener("pointerdown",G=>{G.stopPropagation()}),H.addEventListener("mousedown",G=>{G.stopPropagation()});for(let G of w){if(G.type==="separator"){let xe=document.createElement("div");xe.className="tt-table-menu-sep",H.appendChild(xe);continue}let ae=document.createElement("button");if(ae.type="button",ae.className="tt-table-menu-item",ae.textContent=G.label,ae.disabled=!!G.disabled,G.swatch){ae.classList.add("has-swatch");try{let xe=G.swatchValue==null?"transparent":String(G.swatchValue);ae.style.setProperty("--tt-swatch",xe)}catch{}}G.submenu&&ae.classList.add("has-submenu"),ae.addEventListener("click",xe=>{if(xe.preventDefault(),xe.stopPropagation(),!G.disabled){if(G.submenu){let ie=ae.getBoundingClientRect();this.openPanel({anchorRect:ie,items:G.submenu(),level:D+1});return}try{G.onClick?.()}finally{this.closeAll()}}}),H.appendChild(ae)}document.body.appendChild(H);let O=H.getBoundingClientRect(),F=P.right+8,U=P.top,J=C(F,U,O.width,O.height);H.style.left=`${J.left}px`,H.style.top=`${J.top}px`,this.panels.push(H);try{this.panels.length===1&&(document.addEventListener("pointerdown",this.onDocPointerDown,!1),window.addEventListener("keydown",this.onKeyDown,!1))}catch{}}}class T{constructor(A){this.view=A,this.menu=new N,this.wrapper=null,this.table=null,this.observedTable=null,this.resizeObserver=null,this.layoutRaf=null,this.resizeRaf=null,this.destroyed=!1,this.root=document.createElement("div"),this.root.className="tt-table-ui",this.root.style.display="none",this.cellOutline=document.createElement("div"),this.cellOutline.className="tt-table-active-cell-outline",this.cellOutline.style.display="none",this.root.appendChild(this.cellOutline),this.scheduleLayout=()=>{this.layoutRaf==null&&(this.layoutRaf=window.requestAnimationFrame(()=>{this.layoutRaf=null,!this.destroyed&&this.update(this.view)}))},this.scheduleResizeLoop=()=>{this.resizeRaf==null&&(this.resizeRaf=window.requestAnimationFrame(()=>{this.resizeRaf=null,!this.destroyed&&fr&&this.update(this.view)}))},this.onWrapperScroll=()=>this.scheduleLayout(),this.onWindowResize=()=>this.scheduleLayout();try{window.addEventListener("resize",this.onWindowResize,{passive:!0})}catch{}this.rowHandles=[],this.colHandles=[],this.dragState=null,this.suppressClickUntil=0,this.colDropIndicator=document.createElement("div"),this.colDropIndicator.className="tt-table-drop-indicator tt-table-drop-indicator-col",this.colDropIndicator.style.display="none",this.root.appendChild(this.colDropIndicator),this.rowDropIndicator=document.createElement("div"),this.rowDropIndicator.className="tt-table-drop-indicator tt-table-drop-indicator-row",this.rowDropIndicator.style.display="none",this.root.appendChild(this.rowDropIndicator),this.cellHandle=document.createElement("button"),this.cellHandle.type="button",this.cellHandle.className="tt-table-handle tt-table-cell-handle",this.cellHandle.setAttribute("aria-label","Cell actions"),this.cellHandle.addEventListener("click",w=>{w.preventDefault(),w.stopPropagation();let D=this.cellHandle.getBoundingClientRect();this.openCellMenu(D)}),this.root.appendChild(this.cellHandle)}hideDropIndicators(){try{this.colDropIndicator&&(this.colDropIndicator.style.display="none")}catch{}try{this.rowDropIndicator&&(this.rowDropIndicator.style.display="none")}catch{}}cancelDrag(){let A=this.dragState;if(A){this.dragState=null,this.hideDropIndicators();try{window.removeEventListener("pointermove",A.onMove),window.removeEventListener("pointerup",A.onUp),window.removeEventListener("pointercancel",A.onUp)}catch{}try{document.body.classList.remove("tt-table-dragging")}catch{}}}destroy(){this.destroyed=!0,this.cancelDrag();try{this.cellOutline.style.display="none"}catch{}this.menu.closeAll();try{this.layoutRaf!=null&&window.cancelAnimationFrame(this.layoutRaf)}catch{}this.layoutRaf=null;try{this.resizeRaf!=null&&window.cancelAnimationFrame(this.resizeRaf)}catch{}this.resizeRaf=null;try{window.removeEventListener("resize",this.onWindowResize)}catch{}try{this.wrapper?.removeEventListener?.("scroll",this.onWrapperScroll)}catch{}try{this.resizeObserver?.disconnect?.()}catch{}this.resizeObserver=null,this.observedTable=null;try{this.root.remove()}catch{}this.wrapper=null,this.table=null}ensureAttached(A){if(A&&this.wrapper!==A){try{this.wrapper?.removeEventListener?.("scroll",this.onWrapperScroll)}catch{}try{this.root.remove()}catch{}this.wrapper=A;try{this.wrapper.addEventListener("scroll",this.onWrapperScroll,{passive:!0})}catch{}this.wrapper.appendChild(this.root)}}buildRowHandles(A){for(;this.rowHandles.length>A;){let w=this.rowHandles.pop();try{w?.remove?.()}catch{}}for(;this.rowHandles.length<A;){let w=document.createElement("button");w.type="button",w.className="tt-table-handle tt-table-row-handle",w.setAttribute("aria-label","Row actions"),w.dataset.idx=String(this.rowHandles.length),w.addEventListener("pointerdown",D=>this.onHandlePointerDown(D,w,"row")),w.addEventListener("click",D=>{if(Date.now()<this.suppressClickUntil){D.preventDefault(),D.stopPropagation();return}D.preventDefault(),D.stopPropagation();let P=Dt(this.view?.state)?.tablePos,H=w.getBoundingClientRect();E?.chain?.().focus?.().run?.();let O=Number(w.dataset.idx||0);wp(E,O),this.openRowMenu(H,O,P)}),this.rowHandles.push(w),this.root.appendChild(w)}}buildColHandles(A){for(;this.colHandles.length>A;){let w=this.colHandles.pop();try{w?.remove?.()}catch{}}for(;this.colHandles.length<A;){let w=document.createElement("button");w.type="button",w.className="tt-table-handle tt-table-col-handle",w.setAttribute("aria-label","Column actions"),w.dataset.idx=String(this.colHandles.length),w.addEventListener("pointerdown",D=>this.onHandlePointerDown(D,w,"col")),w.addEventListener("click",D=>{if(Date.now()<this.suppressClickUntil){D.preventDefault(),D.stopPropagation();return}D.preventDefault(),D.stopPropagation();let P=Dt(this.view?.state)?.tablePos,H=w.getBoundingClientRect();E?.chain?.().focus?.().run?.();let O=Number(w.dataset.idx||0);xp(E,O),this.openColumnMenu(H,O,P)}),this.colHandles.push(w),this.root.appendChild(w)}}onHandlePointerDown(A,w,D){try{if(!A||A.button!==0)return;A.preventDefault(),A.stopPropagation(),E?.chain?.().focus?.().run?.();let P=Number(w?.dataset?.idx||0);try{typeof w.setPointerCapture=="function"&&w.setPointerCapture(A.pointerId)}catch{}let H={kind:D,btn:w,pointerId:A.pointerId,fromIndex:P,startX:A.clientX,startY:A.clientY,moved:!1};this.dragState=H;let O=U=>this.onHandlePointerMove(U),F=U=>this.onHandlePointerUp(U);H.onMove=O,H.onUp=F,window.addEventListener("pointermove",O,{passive:!1}),window.addEventListener("pointerup",F,{passive:!1}),window.addEventListener("pointercancel",F,{passive:!1})}catch{}}onHandlePointerMove(A){let w=this.dragState;if(!w||!A||A.pointerId!==w.pointerId)return;try{A.preventDefault()}catch{}let D=A.clientX-w.startX,P=A.clientY-w.startY;if(!w.moved&&Math.hypot(D,P)>=4){w.moved=!0;try{document.body.classList.add("tt-table-dragging")}catch{}}if(w.moved){let H=this.getDropIndexFromPointer(w.kind,A.clientX,A.clientY);w.dropIndex=H,H==null?this.hideDropIndicators():this.updateDropIndicator(w.kind,H,A.clientX,A.clientY)}}getDropIndexFromPointer(A,w,D){try{let P=this.table;if(!P)return null;let H=Array.from(P.querySelectorAll("tbody tr"));if(!H.length)return null;if(A==="col"){let F=Array.from(H[0].children||[]).filter(J=>J&&J.nodeType===1);if(!F.length)return null;let U=F.map(J=>{let G=J.getBoundingClientRect();return G.left+G.width/2});if(!U.length)return null;if(w<U[0])return 0;for(let J=0;J<U.length-1;J+=1)if(w>=U[J]&&w<U[J+1])return J+1;return U.length-1}let O=H.map(F=>{let U=F.children&&F.children[0];if(!U)return null;let J=U.getBoundingClientRect();return J.top+J.height/2}).filter(F=>typeof F=="number");if(!O.length)return null;if(D<O[0])return 0;for(let F=0;F<O.length-1;F+=1)if(D>=O[F]&&D<O[F+1])return F+1;return O.length-1}catch{return null}}updateDropIndicator(A,w,D,P){try{let H=this.table,O=this.wrapper;if(!H||!O)return;let F=O.getBoundingClientRect(),U=H.getBoundingClientRect(),J=U.top-F.top,G=U.left-F.left,ae=U.width,xe=U.height,ie=Array.from(H.querySelectorAll("tbody tr"));if(!ie.length)return;if(A==="col"){let xt=Array.from(ie[0].children||[]).filter(ee=>ee&&ee.nodeType===1);if(!xt.length)return;let z=Math.max(0,Math.min(xt.length-1,Number(w))),ne=xt[z].getBoundingClientRect(),K=xt[xt.length-1].getBoundingClientRect(),Y=K.left+K.width/2,oe=z===xt.length-1&&D>Y?K.right-F.left:ne.left-F.left;this.colDropIndicator.style.display="",this.rowDropIndicator.style.display="none",this.colDropIndicator.style.left=`${Math.round(oe)}px`,this.colDropIndicator.style.top=`${Math.round(J)}px`,this.colDropIndicator.style.height=`${Math.max(0,Math.round(xe))}px`;return}let Be=Math.max(0,Math.min(ie.length-1,Number(w))),De=ie[Be]?.children?.[0];if(!De)return;let Je=De.getBoundingClientRect(),$e=(ie[ie.length-1]?.children?.[0]||null)?.getBoundingClientRect?.()||null,st=$e?$e.top+$e.height/2:null,ct=Be===ie.length-1&&$e&&typeof st=="number"&&P>st?$e.bottom-F.top:Je.top-F.top;this.rowDropIndicator.style.display="",this.colDropIndicator.style.display="none",this.rowDropIndicator.style.left=`${Math.round(G)}px`,this.rowDropIndicator.style.top=`${Math.round(ct)}px`,this.rowDropIndicator.style.width=`${Math.max(0,Math.round(ae))}px`}catch{}}onHandlePointerUp(A){let w=this.dragState;if(!w||!A||A.pointerId!==w.pointerId)return;try{A.preventDefault(),A.stopPropagation()}catch{}this.dragState=null;try{window.removeEventListener("pointermove",w.onMove),window.removeEventListener("pointerup",w.onUp),window.removeEventListener("pointercancel",w.onUp)}catch{}try{document.body.classList.remove("tt-table-dragging")}catch{}if(this.hideDropIndicators(),!w.moved)return;this.suppressClickUntil=Date.now()+250;let D=w.dropIndex??this.getDropIndexFromPointer(w.kind,A.clientX,A.clientY);if(D!=null){try{E?.chain?.().focus?.().run?.()}catch{}w.kind==="col"?ld(E,w.fromIndex,D):dd(E,w.fromIndex,D),this.scheduleLayout()}}isEnabled(){try{return!!(ke?.getState?.(this.view.state)||null)?.editingSectionId&&!u.isPublicView}catch{return!1}}update(A){if(this.view=A,!fr&&this.resizeRaf!=null){try{window.cancelAnimationFrame(this.resizeRaf)}catch{}this.resizeRaf=null}if(!this.isEnabled()){this.root.style.display="none",this.menu.closeAll();try{this.cellOutline.style.display="none"}catch{}return}let w=Dt(A.state),D=bp(A),P=D?.closest?.("table")||Kt(A),H=P?.closest?.(".tableWrapper")||null;if(!w||!P||!H||!D){this.root.style.display="none",this.menu.isOpen()||this.menu.closeAll();try{this.cellOutline.style.display="none"}catch{}return}this.ensureAttached(H),this.table=P;try{typeof ResizeObserver=="function"&&(this.resizeObserver||(this.resizeObserver=new ResizeObserver(()=>this.scheduleLayout())),this.observedTable!==P&&(this.resizeObserver.disconnect(),this.resizeObserver.observe(P),this.observedTable=P))}catch{}this.root.style.display="";let O=Array.from(P.querySelectorAll("tbody tr")),F=Number(w.map?.height||O.length||0),U=Number(w.map?.width||0);this.buildRowHandles(Math.max(0,F)),this.buildColHandles(Math.max(0,U));let J=H.getBoundingClientRect(),G=P.getBoundingClientRect(),ae=G.top-J.top,xe=G.left-J.left,ie=14,Be=4,De=ie/2,Je=Math.max(0,Math.min(Math.max(0,F-1),Number(w.rowIndex||0))),it=Math.max(0,Math.min(Math.max(0,U-1),Number(w.colIndex||0))),$e=Math.max(De,ae-(ie/2+Be)),st=Math.max(De,xe-(ie/2+Be)),ct=D.getBoundingClientRect(),xt=ct.left-J.left+ct.width/2,z=ct.top-J.top+ct.height/2,ne=ct.left-J.left,K=ct.top-J.top,Y="cell";try{let oe=A.state.selection,ee=oe?.$anchorCell?.pos,ue=oe?.$headCell?.pos;if(typeof ee=="number"&&typeof ue=="number"&&ee!==ue){let we=ee-(w.tablePos+1),Ie=ue-(w.tablePos+1),Ne=w.map?.rectBetween?.(we,Ie)||null;if(Ne){let Se=Number(Ne.right)-Number(Ne.left),Le=Number(Ne.bottom)-Number(Ne.top);Se===1&&Le>1?Y="col":Le===1&&Se>1?Y="row":Y="range"}else Y="range"}}catch{Y="cell"}try{Y==="cell"?(this.cellOutline.style.display="",this.cellOutline.style.left=`${Math.round(ne)}px`,this.cellOutline.style.top=`${Math.round(K)}px`,this.cellOutline.style.width=`${Math.max(0,Math.round(ct.width))}px`,this.cellOutline.style.height=`${Math.max(0,Math.round(ct.height))}px`):this.cellOutline.style.display="none"}catch{try{this.cellOutline.style.display="none"}catch{}}for(let oe=0;oe<this.colHandles.length;oe+=1){let ee=this.colHandles[oe];if(ee){if(ee.dataset.idx=String(oe),oe!==it){ee.style.display="none";continue}ee.style.display="",ee.style.width=`${Math.max(18,Math.round(ct.width))}px`,ee.style.height=`${ie}px`,ee.style.left=`${Math.round(xt)}px`,ee.style.top=`${Math.round($e)}px`}}for(let oe=0;oe<this.rowHandles.length;oe+=1){let ee=this.rowHandles[oe];if(ee){if(ee.dataset.idx=String(oe),oe!==Je){ee.style.display="none";continue}ee.style.display="",ee.style.width=`${ie}px`,ee.style.height=`${Math.max(18,Math.round(ct.height))}px`,ee.style.left=`${Math.round(st)}px`,ee.style.top=`${Math.round(z)}px`}}try{if(Y!=="cell")this.cellHandle.style.display="none";else{let oe=ct.right-J.left;this.cellHandle.style.display="",this.cellHandle.style.left=`${Math.round(oe)}px`,this.cellHandle.style.top=`${Math.round(z)}px`}}catch{this.cellHandle.style.display="none"}fr&&this.scheduleResizeLoop()}openCellMenu(A){let w=()=>{try{E?.chain?.().focus?.().run?.()}catch{}},D=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>g.map(P=>({label:P.label,swatch:!0,swatchValue:P.value,onClick:()=>{w(),E.commands.setNodeTextColor(P.value)}}))},{label:"Background color",submenu:()=>k.map(P=>({label:P.label,swatch:!0,swatchValue:P.value,onClick:()=>{w(),E.commands.setNodeBackground(P.value)}}))}]},{label:"Alignment",submenu:()=>[...M.map(P=>({label:P.label,onClick:()=>{w(),E.commands.setNodeTextAlign(P.value)}})),{type:"separator"},..._.map(P=>({label:P.label,onClick:()=>{w(),E.commands.setNodeVAlign(P.value)}}))]},{type:"separator"},{label:"Clear contents",onClick:()=>{w(),E.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:A,items:D,level:0})}openRowMenu(A,w,D){let P=()=>{try{E?.chain?.().focus?.().run?.()}catch{}Number.isFinite(Number(D))&&Sp(E,D,w)},H=(J,G)=>{try{E?.chain?.().focus?.().run?.()}catch{}return E.commands.command(({state:ae,dispatch:xe})=>{let ie=Number.isFinite(Number(D))?Number(D):Dt(ae)?.tablePos,Be=Number.isFinite(Number(w))?Number(w):Dt(ae)?.rowIndex;return!Number.isFinite(Number(ie))||!Number.isFinite(Number(Be))?!1:Ip({pmState:ae,dispatch:xe},{tablePos:ie,rowIndex:Be,attr:J,value:G})})},O=J=>()=>(P(),J?.()),F=J=>{try{return typeof J!="function"?!1:(P(),E.commands.command(({state:G,dispatch:ae})=>J(G,typeof ae=="function"?ie=>{try{ie=ie.setMeta(le,!0)}catch{}ae(ie)}:void 0)))}catch{return!1}},U=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>g.map(J=>({label:J.label,swatch:!0,swatchValue:J.value,onClick:()=>H("nodeTextColor",J.value)}))},{label:"Background color",submenu:()=>k.map(J=>({label:J.label,swatch:!0,swatchValue:J.value,onClick:()=>H("nodeBackground",J.value)}))}]},{label:"Alignment",submenu:()=>[...M.map(J=>({label:J.label,onClick:()=>H("nodeTextAlign",J.value)})),{type:"separator"},..._.map(J=>({label:J.label,onClick:()=>H("nodeVerticalAlign",J.value)}))]},{type:"separator"},{label:"Insert row above",onClick:()=>F(ht?.addRowBefore)},{label:"Insert row below",onClick:()=>F(ht?.addRowAfter)},{label:"Sort ",submenu:()=>[{label:"Sort column A-Z",onClick:O(()=>Hl(E,{direction:"asc"}))},{label:"Sort column Z-A",onClick:O(()=>Hl(E,{direction:"desc"}))}]},{label:"Header row",onClick:()=>F(ht?.toggleHeaderRow)},{label:"Move ",submenu:()=>[{label:"Move row up",onClick:O(()=>Ol(E,-1))},{label:"Move row down",onClick:O(()=>Ol(E,1))},{label:"Move row left",disabled:!0,onClick:()=>{}},{label:"Move row right",disabled:!0,onClick:()=>{}}]},{label:"Duplicate row",onClick:O(()=>Ep(E))},{label:"Delete row",onClick:()=>F(ht?.deleteRow)},{type:"separator"},{label:"Clear row contents",onClick:()=>{P(),E.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:A,items:U,level:0})}openColumnMenu(A,w,D){let P=()=>{try{E?.chain?.().focus?.().run?.()}catch{}Number.isFinite(Number(D))&&Ap(E,D,w)},H=(J,G)=>{try{E?.chain?.().focus?.().run?.()}catch{}return E.commands.command(({state:ae,dispatch:xe})=>{let ie=Number.isFinite(Number(D))?Number(D):Dt(ae)?.tablePos,Be=Number.isFinite(Number(w))?Number(w):Dt(ae)?.colIndex;return!Number.isFinite(Number(ie))||!Number.isFinite(Number(Be))?!1:kp({pmState:ae,dispatch:xe},{tablePos:ie,colIndex:Be,attr:J,value:G})})},O=J=>()=>(P(),J?.()),F=J=>{try{return typeof J!="function"?!1:(P(),E.commands.command(({state:G,dispatch:ae})=>J(G,typeof ae=="function"?ie=>{try{ie=ie.setMeta(le,!0)}catch{}ae(ie)}:void 0)))}catch{return!1}},U=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>g.map(J=>({label:J.label,swatch:!0,swatchValue:J.value,onClick:()=>H("nodeTextColor",J.value)}))},{label:"Background color",submenu:()=>k.map(J=>({label:J.label,swatch:!0,swatchValue:J.value,onClick:()=>H("nodeBackground",J.value)}))}]},{label:"Alignment",submenu:()=>[...M.map(J=>({label:J.label,onClick:()=>H("nodeTextAlign",J.value)})),{type:"separator"},..._.map(J=>({label:J.label,onClick:()=>H("nodeVerticalAlign",J.value)}))]},{type:"separator"},{label:"Insert column left",onClick:()=>{P();let J=Math.max(0,Number(w||0));F(ht?.addColumnBefore)&&window.requestAnimationFrame(()=>{try{fi(E,{insertIndex:J,newColPct:10})}catch{let ae=Kt(E.view);di(ae)}})}},{label:"Insert column right",onClick:()=>{P();let J=Math.max(0,Number(w||0)+1);F(ht?.addColumnAfter)&&window.requestAnimationFrame(()=>{try{fi(E,{insertIndex:J,newColPct:10})}catch{let ae=Kt(E.view);di(ae)}})}},{label:"Sort ",submenu:()=>[{label:"Sort row A-Z",onClick:O(()=>Rl(E,{direction:"asc"}))},{label:"Sort row Z-A",onClick:O(()=>Rl(E,{direction:"desc"}))}]},{label:"Header column",onClick:()=>F(ht?.toggleHeaderColumn)},{label:"Move ",submenu:()=>[{label:"Move column up",disabled:!0,onClick:()=>{}},{label:"Move column down",disabled:!0,onClick:()=>{}},{label:"Move column left",onClick:O(()=>Dl(E,-1))},{label:"Move column right",onClick:O(()=>Dl(E,1))}]},{label:"Duplicate column",onClick:O(()=>Cp(E))},{label:"Delete column",onClick:()=>{P();let J=Kt(E.view),G=Hr(J),ae=Number.isFinite(Number(w))?Number(w):null,xe=G&&ae!=null?cd(G,ae):null;F(ht?.deleteColumn)&&Array.isArray(xe)&&window.requestAnimationFrame(()=>{let Be=Kt(E.view);$r(Be,xe)})}},{type:"separator"},{label:"Clear column contents",onClick:()=>{P(),E.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:A,items:U,level:0})}}return[new b({view(I){let A=new T(I);return A.update(I),{update(w){A.update(w)},destroy(){A.destroy()}}}})]}}),bt=pr()?performance.now():0;ce=new a({element:e,extensions:[Bn,se,de,ge,Z,be,Oe,Ge,Ze,he,Tn,Qe,yt,qt,Et,rt,$.configure({types:["outlineSection"],attributeName:"id",generateID:()=>Ut()}),y.configure({document:!1,heading:!1,link:!1}),R.configure({openOnClick:!1,protocols:ri}),Ue,re,He,Ot,j.configure({table:{resizable:!0}}),rn,Nt,Tt,Ct,qe].filter(Boolean),content:Ke,editorProps:{attributes:{class:"outline-prosemirror"},handleKeyDown(E,g){try{if(g?.altKey&&!g.ctrlKey&&!g.metaKey){let k=String(g.key||"");if((k==="ArrowUp"||k==="ArrowDown")&&g.repeat){let M=E?.state?.selection?.$from;if(M){let _=!1;for(let B=M.depth;B>0;B-=1){let C=M.node(B)?.type?.name;if(C&&String(C).startsWith("table")){_=!0;break}}if(!_){let B=null;for(let C=M.depth;C>0;C-=1)if(M.node(C)?.type?.name==="outlineSection"){B=M.before(C);break}if(typeof B=="number"){let C=E.state.doc.resolve(B),N=C.parent;if(N){let T=C.index();if(k==="ArrowUp"&&T<=0||k==="ArrowDown"&&T>=N.childCount-1)return!0}}}}}}}catch{}Ye("editorProps.keydown",{key:g?.key||null,repeat:!!g?.repeat,selection:{empty:!!E.state?.selection?.empty,parent:E.state?.selection?.$from?.parent?.type?.name||null,parentOffset:E.state?.selection?.$from?.parentOffset??null,pos:E.state?.selection?.$from?.pos??null}});try{let k=ze?.pmStateMod?.TextSelection;if(k){let _=(ke?.getState?.(E.state)||null)?.editingSectionId||null,B=(g.key==="Enter"||g.code==="Enter"||g.code==="NumpadEnter")&&(g.ctrlKey||g.metaKey)&&!g.shiftKey&&!g.altKey;if(!u.isPublicView&&!_&&B){let C=E.state.selection,N=C?.$from||null;if(N){let T=vt(E.state.doc,N),I=typeof T=="number"?E.state.doc.nodeAt(T):null;if(typeof T=="number"&&I?.type?.name==="outlineSection"){let A=!!(C&&C.empty),w=N.parent?.type?.name==="outlineHeading",P=A&&w&&N.parentOffset===0?T:T+I.nodeSize,H=E.state.schema,O=Ut(),F=H.nodes.outlineSection.create({id:O,collapsed:!1},[H.nodes.outlineHeading.create({},[]),H.nodes.outlineBody.create({},[H.nodes.paragraph.create({},[])]),H.nodes.outlineChildren.create({},[])]),U=E.state.tr.insert(P,F);try{let G=U.doc.nodeAt(P)?.child?.(0)||F.child(0),ae=P+1+G.nodeSize;U=U.setSelection(k.near(U.doc.resolve(ae+2),1))}catch{U=U.setSelection(k.create(U.doc,P+2))}U=U.setMeta(le,!0),ke&&(U=U.setMeta(ke,{type:"enter",sectionId:O})),E.dispatch(U.scrollIntoView());try{E.focus()}catch{}return g.preventDefault(),g.stopPropagation(),!0}}}}}catch{}try{let k=g.altKey&&!g.ctrlKey&&!g.metaKey&&!g.shiftKey,M=String(g.key||"");if(k&&(M==="ArrowLeft"||M==="ArrowRight"||M==="ArrowUp"||M==="ArrowDown")&&(ke?.getState?.(E.state)||null)?.editingSectionId&&ce){let B=()=>{try{let C=E?.state?.selection?.$from||null;if(!C)return!1;for(let N=C.depth;N>0;N-=1){let T=C.node(N)?.type?.name;if(T==="table"||T==="tableRow"||T==="tableCell"||T==="tableHeader")return!0}return!1}catch{return!1}};if(M==="ArrowLeft"||M==="ArrowRight"){let C=ce.chain().focus();C.command(({tr:T})=>(T.setMeta(le,!0),!0));let N=!1;if(ce.isActive("bulletList")||ce.isActive("orderedList")?M==="ArrowRight"?N=C.sinkListItem("listItem").run():(N=C.liftListItem("listItem").run(),!N&&ce.isActive("bulletList")&&(N=C.toggleBulletList().run()),!N&&ce.isActive("orderedList")&&(N=C.toggleOrderedList().run())):M==="ArrowRight"&&(N=C.toggleBulletList().run()),N)return g.preventDefault(),g.stopPropagation(),!0}else if((M==="ArrowUp"||M==="ArrowDown")&&(M==="ArrowUp"?Fl(ce,-1)||$l(ce,-1):Fl(ce,1)||$l(ce,1)))return g.preventDefault(),g.stopPropagation(),!0}}catch{}try{if((g.ctrlKey||g.metaKey)&&!g.altKey&&!g.shiftKey&&(g.code==="KeyA"||String(g.key||"").toLowerCase()==="a")){let M=ze?.pmStateMod?.TextSelection;if(!M)return Ye("editorProps.modA",{handled:!1,reason:"no-TextSelection"}),!1;let _=E.state,B=_.selection,C=B?.$from||null;if(!C)return Ye("editorProps.modA",{handled:!1,reason:"no-$from"}),!1;let N=vt(_.doc,C);if(typeof N!="number")return Ye("editorProps.modA",{handled:!1,reason:"no-sectionPos"}),!1;let T=_.doc.nodeAt(N);if(!T||T.type?.name!=="outlineSection")return Ye("editorProps.modA",{handled:!1,reason:"not-outlineSection"}),!1;let I=T.child(0),A=T.child(1);if(!I||!A)return Ye("editorProps.modA",{handled:!1,reason:"missing-heading/body"}),!1;let w=N+1,D=w+1,P=w+I.nodeSize-1,H=N+1+I.nodeSize,O=H+1,F=H+A.nodeSize-1,U=F;try{let ie=null;_.doc.nodesBetween(O,Math.min(_.doc.content.size,F),(Be,De)=>{Be?.isTextblock&&(ie=De+Be.nodeSize-1)}),typeof ie=="number"&&(U=ie)}catch{}U<O&&(U=P);let J=D,G=(()=>{try{for(let ie=C.depth;ie>0;ie-=1)if(C.node(ie)?.type?.name==="outlineHeading")return!0}catch{}return!1})(),ae=!!B&&typeof B.from=="number"&&typeof B.to=="number"&&Math.min(B.from,B.to)===J&&Math.max(B.from,B.to)===U;if(G&&ae)return Ye("editorProps.modA",{handled:!1,reason:"pass-through-doc-select"}),!1;g.preventDefault(),g.stopPropagation();let xe=M.create(_.doc,J,U);return E.dispatch(_.tr.setSelection(xe)),Ye("editorProps.modA",{handled:!0,blockFrom:J,blockTo:U,isInHeading:G,alreadySelectedBlock:ae}),!0}}catch{}try{if(!ke)return!1;let M=(ke.getState(E.state)||{}).editingSectionId||null;if(!M){let _=(g.ctrlKey||g.metaKey)&&!g.altKey&&!g.shiftKey&&(g.key==="Delete"||g.key==="Del"||g.key==="Backspace"),B=g.key==="Backspace"||g.key==="Delete",C=g.key&&g.key.length===1&&!g.metaKey&&!g.ctrlKey&&!g.altKey,N=!g.metaKey&&!g.ctrlKey&&!g.altKey&&!g.shiftKey&&(g.key===" "||g.key==="Spacebar");if(_){let T=vt(E.state.doc,E.state.selection.$from),I=!1;try{typeof T=="number"&&(I=Q(E.state,E.dispatch,T))}catch{I=!1}return Ye("editorProps.modDelete",{ok:I,sectionPos:T}),g.preventDefault(),g.stopPropagation(),!0}if(N){let T=document.activeElement;if(!(!!(T&&T.closest&&T.closest(".outline-editor"))||!!(g?.target&&g.target.closest&&g.target.closest(".outline-editor"))))return!1;if(g.repeat)return g.preventDefault(),g.stopPropagation(),!0;let A=g?.target||null,w=String(A?.tagName||"").toLowerCase();if(w==="button"||w==="input"||w==="textarea"||w==="select"||A?.closest?.("button, a[href], input, textarea, select")||!!!A?.closest?.(".outline-prosemirror")&&A?.closest?.('[contenteditable="true"]'))return!1;let P=vt(E.state.doc,E.state.selection.$from);if(typeof P!="number")return g.preventDefault(),g.stopPropagation(),!0;let H=E.state.doc.nodeAt(P);if(!H)return g.preventDefault(),g.stopPropagation(),!0;let O=!H.attrs?.collapsed,F=E.state.tr.setNodeMarkup(P,void 0,{...H.attrs,collapsed:O});F=F.setMeta(le,!0);try{let U=H.child(0),G=P+1+U.nodeSize-1,{TextSelection:ae}=ze?.pmStateMod||{};ae&&(F=F.setSelection(ae.near(F.doc.resolve(G),-1)))}catch{}return g.preventDefault(),g.stopPropagation(),E.dispatch(F.scrollIntoView()),!0}if(B){if(g.key==="Backspace")try{let T=E.state,I=T.selection,A=I?.$from||null,w=null;try{for(let H=A?.depth||0;H>0;H-=1)if(A.node(H)?.type?.name==="outlineHeading"){w=H;break}}catch{w=null}let D=w!==null&&A?A.start(w):null,P=!!(I&&I.empty)&&!!A&&w!==null&&typeof D=="number"&&A.pos===D;if(Ye("editorProps.backspace.check",{empty:!!I?.empty,headingDepth:w,headingStart:D,pos:A?.pos??null,parent:A?.parent?.type?.name||null,parentOffset:A?.parentOffset??null,atHeadingStart:P}),P){let H=vt(T.doc,A),O=typeof H=="number"?T.doc.nodeAt(H):null;if(Ye("editorProps.backspace.sectionPos",{sectionPos:H,hasNode:!!O}),typeof H=="number"&&O){let F=String(O.attrs?.id||""),U=null;try{let G=T.doc.resolve(H),ae=G.index(),xe=G.parent;if(xe&&ae>0){let ie=xe.child(ae-1),Be=H-ie.nodeSize,De=T.doc.nodeAt(Be);U=String(De?.attrs?.id||"")||null}else for(let ie=A.depth-1;ie>0;ie-=1){let Be=A.node(ie);if(Be?.type?.name==="outlineSection"){let De=String(Be.attrs?.id||"");if(De&&De!==F){U=De;break}}}}catch{U=null}Ye("editorProps.backspace.mergeCandidate",{sectionPos:H,currentSectionId:F,targetSectionId:U});let J=!1;if(me(O))J=Q(T,E.dispatch,H);else try{T.doc.resolve(H).index()<=0?J=Pe(T,E.dispatch,H):J=ye(T,E.dispatch,H)}catch{J=ye(T,E.dispatch,H)}return Ye("editorProps.backspace.mergeDone",{ok:J,targetSectionId:U}),J&&U&&ke&&window.setTimeout(()=>{try{if((ke.getState(E.state)||{}).editingSectionId)return;let ae=at(E.state.doc,U),xe=typeof ae=="number"?E.state.doc.nodeAt(ae):null;if(!xe)return;let ie=E.state.tr;xe?.attrs?.collapsed&&(ie=ie.setNodeMarkup(ae,void 0,{...xe.attrs,collapsed:!1}),ie=ie.setMeta(le,!0)),ie=ie.setMeta(ke,{type:"enter",sectionId:U});try{let Be=ie.doc.nodeAt(ae);if(Be&&Be.type?.name==="outlineSection"){let De=Be.child(0),Je=Be.child(1),$e=ae+1+De.nodeSize+Je.nodeSize-1;ie=ie.setSelection(m.near(ie.doc.resolve($e),-1))}}catch{}E.dispatch(ie.scrollIntoView());try{E.focus()}catch{}Ye("editorProps.backspace.enterEdit.done",{targetSectionId:U})}catch{}},0),g.preventDefault(),g.stopPropagation(),!0}}}catch{}return g.preventDefault(),g.stopPropagation(),!0}if(C)return g.preventDefault(),g.stopPropagation(),Rr(),!0}if(u.isPublicView&&!M&&(g.key==="Enter"&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey&&!g.altKey||g.key==="F2"&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey&&!g.altKey))return g.preventDefault(),g.stopPropagation(),!0;if(!M&&(g.key==="Enter"&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey&&!g.altKey||g.key==="F2"&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey&&!g.altKey)){let _=vt(E.state.doc,E.state.selection.$from);if(typeof _!="number")return!1;let B=E.state.doc.nodeAt(_),C=String(B?.attrs?.id||"");if(!C)return!1;if(g.preventDefault(),g.stopPropagation(),B?.attrs?.collapsed){let N=E.state.tr.setNodeMarkup(_,void 0,{...B.attrs,collapsed:!1});return N.setMeta(le,!0),E.dispatch(N.scrollIntoView()),!0}return E.dispatch(E.state.tr.setMeta(ke,{type:"enter",sectionId:C})),!0}if(M&&g.key==="Escape"){g.preventDefault(),g.stopPropagation();let _=M;E.dispatch(E.state.tr.setMeta(ke,{type:"exit"}));try{let B=ce;if(B&&!B.isDestroyed){let C=gr(E.state.doc,_);Vl(B,E.state.doc,_),C&&tn({delayMs:350})}}catch{}return!0}}catch{}return!1},handleDOMEvents:{click(E,g){try{let k=g.target?.closest?.("a[href]");if(!k||!ke||(ke.getState(E.state)||{}).editingSectionId||null)return!1;let B=String(k.getAttribute("href")||"").trim();if(!B)return!1;if(u.isPublicView){let A=String(k.getAttribute("rel")||"").split(/\s+/).filter(Boolean);if(k.getAttribute("data-unpublished")==="1"||A.includes("unpublished")||B==="#")return alert("\u042D\u0442\u0430 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435 \u043E\u043F\u0443\u0431\u043B\u0438\u043A\u043E\u0432\u0430\u043D\u0430"),g.preventDefault(),g.stopPropagation(),!0}if(B.startsWith("app:/")||B.startsWith("disk:/")){g.preventDefault(),g.stopPropagation();let I=Wt(B);if(I)return window.open(I,"_blank","noopener,noreferrer"),!0}let C=I=>{let A=String(I||"").trim();if(!A||A.startsWith("/")||A.startsWith("#")||/\s/.test(A)||A.includes("://")||/^[a-z][a-z0-9+.-]*:/i.test(A))return!1;let w=A.split(/[/?#]/,1)[0];return!(!w||!w.includes(".")||w.startsWith(".")||w.endsWith(".")||w.includes(".."))},N=I=>{let A=String(I||"").trim();return A&&(A.startsWith("//")?`https:${A}`:C(A)?`https://${A}`:A)};if(g.preventDefault(),g.stopPropagation(),B.startsWith("/"))return u.isPublicView?(window.location.href=B,!0):(pn(B),!0);let T=N(B);return/^https?:\/\//i.test(T)||/^mailto:/i.test(T)||/^tel:/i.test(T),window.open(T,"_blank","noopener,noreferrer"),!0}catch{return!1}},beforeinput(E,g){try{if(!ke)return!1;let M=(ke.getState(E.state)||{}).editingSectionId||null;if(M)return!1;let _=String(g?.inputType||"");if(_.startsWith("history"))return!1;if(Ye("beforeinput",{inputType:_,key:g?.data??null,editingSectionId:M||null,selection:{empty:!!E.state?.selection?.empty,parent:E.state?.selection?.$from?.parent?.type?.name||null,parentOffset:E.state?.selection?.$from?.parentOffset??null}}),_==="deleteContentBackward"){try{let B=E.state,C=B.selection,N=C?.$from||null,T=null;try{for(let w=N?.depth||0;w>0;w-=1)if(N.node(w)?.type?.name==="outlineHeading"){T=w;break}}catch{T=null}let I=T!==null&&N?N.start(T):null,A=!!(C&&C.empty)&&!!N&&T!==null&&typeof I=="number"&&N.pos===I;if(Ye("beforeinput.deleteContentBackward.check",{empty:!!C?.empty,headingDepth:T,headingStart:I,pos:N?.pos??null,parent:N?.parent?.type?.name||null,parentOffset:N?.parentOffset??null,atHeadingStart:A}),A){let w=vt(B.doc,N),D=typeof w=="number"?B.doc.nodeAt(w):null;if(typeof w=="number"&&D){let P=String(D.attrs?.id||"");Ye("beforeinput.deleteContentBackward.candidate",{sectionPos:w,currentSectionId:P});let H=null;try{let F=B.doc.resolve(w),U=F.index(),J=F.parent;if(J&&U>0){let G=J.child(U-1),ae=w-G.nodeSize,xe=B.doc.nodeAt(ae);H=String(xe?.attrs?.id||"")||null}else for(let G=N.depth-1;G>0;G-=1){let ae=N.node(G);if(ae?.type?.name==="outlineSection"){let xe=String(ae.attrs?.id||"");if(xe&&xe!==P){H=xe;break}}}}catch{H=null}let O=!1;if(me(D))Ye("beforeinput.merge",{kind:"deleteEmpty",sectionPos:w}),O=Q(B,E.dispatch,w);else try{B.doc.resolve(w).index()<=0?(Ye("beforeinput.merge",{kind:"intoParent",sectionPos:w,targetSectionId:H}),O=Pe(B,E.dispatch,w)):(Ye("beforeinput.merge",{kind:"intoPrev",sectionPos:w,targetSectionId:H}),O=ye(B,E.dispatch,w))}catch{Ye("beforeinput.merge",{kind:"intoPrev.catch",sectionPos:w,targetSectionId:H}),O=ye(B,E.dispatch,w)}return Ye("beforeinput.merge.done",{ok:O,targetSectionId:H}),O&&H&&window.setTimeout(()=>{try{if((ke.getState(E.state)||{}).editingSectionId)return;let U=at(E.state.doc,H),J=typeof U=="number"?E.state.doc.nodeAt(U):null;if(!J)return;let G=E.state.tr;J?.attrs?.collapsed&&(G=G.setNodeMarkup(U,void 0,{...J.attrs,collapsed:!1}),G=G.setMeta(le,!0)),G=G.setMeta(ke,{type:"enter",sectionId:H});try{let ae=E.state.doc.nodeAt(U);if(ae&&ae.type?.name==="outlineSection"){let xe=ae.child(0),ie=U+1+xe.nodeSize,Be=Math.min(G.doc.content.size,ie+2);G=G.setSelection(m.create(G.doc,Be))}}catch{}E.dispatch(G.scrollIntoView());try{E.focus()}catch{}Ye("beforeinput.enterEdit.done",{targetSectionId:H})}catch{}},0),g.preventDefault(),g.stopPropagation(),!0}}}catch{}return Ye("beforeinput.deleteContentBackward.block",{inputType:_}),g.preventDefault(),g.stopPropagation(),!0}return _.startsWith("delete")?(Ye("beforeinput.delete.block",{inputType:_}),g.preventDefault(),g.stopPropagation(),!0):(g.preventDefault(),g.stopPropagation(),Rr(),!0)}catch{return!1}},dblclick(E,g){try{if(u.isPublicView||!ke||(ke.getState(E.state)||{}).editingSectionId||null)return!1;let _=g?.target&&g.target.closest&&g.target.closest('[data-outline-heading="true"]')||g?.target&&g.target.closest&&g.target.closest(".outline-heading"),B=g?.target&&g.target.closest&&g.target.closest('[data-outline-body="true"]')||g?.target&&g.target.closest&&g.target.closest(".outline-body");if(!_&&!B)return!1;let C={left:g.clientX,top:g.clientY},N=E.posAtCoords(C),T=N&&typeof N.pos=="number"?N.pos:null;if(typeof T!="number")return!1;let I=E.state.doc.resolve(Math.max(0,Math.min(E.state.doc.content.size,T))),A=vt(E.state.doc,I);if(typeof A!="number")return!1;let w=E.state.doc.nodeAt(A),D=String(w?.attrs?.id||"");if(!D)return!1;window.setTimeout(()=>{try{if((ke.getState(E.state)||{}).editingSectionId)return;let H=at(E.state.doc,D),O=typeof H=="number"?E.state.doc.nodeAt(H):null,F=!!O?.attrs?.collapsed,U=E.state.tr;if(F&&typeof H=="number"&&O&&(U=U.setNodeMarkup(H,void 0,{...O.attrs,collapsed:!1}),U=U.setMeta(le,!0)),F){E.dispatch(U.scrollIntoView());try{E.focus()}catch{}return}U=U.setMeta(ke,{type:"enter",sectionId:D});try{let{TextSelection:J}=ze?.pmStateMod||{},G=typeof H=="number"?U.doc.nodeAt(H):null;if(G&&G.type?.name==="outlineSection"){let ae=G.child(0),xe=H+1+ae.nodeSize,ie=Math.min(U.doc.content.size,xe+2);J&&(U=U.setSelection(J.near(U.doc.resolve(ie),1)))}}catch{}E.dispatch(U.scrollIntoView());try{E.focus()}catch{}}catch{}},0)}catch{}return!1}}},onCreate:({editor:E})=>{if(tt&&u.articleId&&u.article&&!u.article.encrypted)try{let g=E.getJSON();u.article.docJson=g,Dc(u.articleId,g).catch(()=>{})}catch{}try{zp(E.state.doc)}catch{}er.clear(),nn=!1,jl=null,en=null;try{li=Ll(E.state.doc),En=!1;try{mn.clear()}catch{mn.clear()}_t&&(clearTimeout(_t),_t=null)}catch{}zn("")},onUpdate:()=>{nn=!0;try{let E=ke?.getState?.(ce?.state)||null,g=String(E?.editingSectionId||"").trim();if(g){let k=ce?.state?.doc||null;k&&gr(k,g)&&ip(ce)}}catch{}try{let E=ce?.state?.doc||null;if(E){let g=Ll(E);g&&g!==li&&(li=g,op({articleId:St||u.articleId,editor:ce}))}}catch{}try{zl(ce)}catch{}tn({delayMs:1500})},onSelectionUpdate:({editor:E})=>{let{state:g}=E,{selection:k}=g;if(!k)return;let M=vt(g.doc,k.$from);if(typeof M!="number")return;let _=g.doc.nodeAt(M),B=String(_?.attrs?.id||"");if(!B)return;try{let T=(ke?.getState?.(g)||null)?.editingSectionId||null;T&&T!==B&&E.view.dispatch(g.tr.setMeta(ke,{type:"exit"}))}catch{}if(en&&en!==B){let N=gr(g.doc,en);try{On("leave_section",{from:en,to:B,changed:N})}catch{}try{er.has(en)&&Vl(E,g.doc,en)}catch{}N&&tn({delayMs:350})}let C=en;en=B;try{zl(E)}catch{}try{!(ke?.getState?.(g)||null)?.editingSectionId&&C&&C!==B&&Hp(E,{lines:4})}catch{}}}),bt&&Or("new Editor()",{ms:Math.round(performance.now()-bt)});try{(St||u.articleId)&&(Zf(St||u.articleId),navigator.onLine&&Wl(St||u.articleId))}catch{}e.focus?.({preventScroll:!0}),pi=E=>{try{if(!ce)return;let g=ce.state.tr.setMeta(te,{activeKey:E||null});ce.view.dispatch(g)}catch{}};try{rd()}catch{}try{let E=pr()?performance.now():0;yp(ce),E&&Or("convertMarkdownTablesInOutlineDoc()",{ms:Math.round(performance.now()-E)})}catch{}t&&Or("mountOutlineEditor() total",{ms:Math.round(performance.now()-t)})})();try{await uo}finally{uo=null}}function Jl(e=""){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}async function Vp(e={}){if(u.isPublicView||!u.articleId||!u.article||!ce)return;let t=St||u.articleId;if(!t)return;let n=!!e.silent,r=e&&typeof e.mode=="string"?e.mode:"network",o=Array.from(new Set([...er||[],en].filter(Boolean))),i=(s,c)=>{let a=s?String(s):"",l=c?String(c):"";return a?l?a>=l?a:l:a||null:l||null};try{if(n||Ai("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C outline\u2026"),u.article.encrypted){n||(or(),ve("Outline-\u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u0435 docJson \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0434\u043B\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0445 \u0441\u0442\u0430\u0442\u0435\u0439"));return}let s=ce.getJSON(),c=Gf(s);if(u.articleId&&t!==u.articleId){await sn(t,c,u.article?.updatedAt||null).catch(()=>{}),n||or(),zn("\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0447\u0435\u0440\u043D\u043E\u0432\u0438\u043A \u0441\u043E\u0445\u0440\u0430\u043D\u0451\u043D \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E");return}let a=Date.now();await sn(t,c,u.article?.updatedAt||null).catch(()=>{});try{en&&gr(ce.state.doc,en)}catch{}if(!0){let d=mn.size?Array.from(mn):[];try{d.length&&(mn.clear(),await Jt("delete_sections",{articleId:t,payload:{sectionIds:d,clientQueuedAt:a},coalesceKey:`delete:${t}`}))}catch{}n||or(),u.article&&(u.article.docJson=c),nn=!1,jl=new Date,zn("\u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E");try{rd()}catch{}try{qp(ce,ce.state.doc,o)}catch{}return}}catch(s){n?zn("\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F"):(or(),ve(s?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C outline"));try{let c=ce.getJSON();c&&typeof c=="object"&&await sn(t,c,u.article?.updatedAt||null).catch(()=>{})}catch{}tn({delayMs:5e3})}}function Jp(){return en||null}function jp(){try{if(!ce||ce.isDestroyed)return null;let e=ce.state,t=vt(e.doc,e.selection.$from);if(typeof t!="number")return null;let n=e.doc.nodeAt(t);if(!n||n.type?.name!=="outlineSection")return null;let r=String(n.attrs?.id||"").trim();return r?{sectionId:r,collapsed:!!n.attrs?.collapsed}:null}catch{return null}}function Kp(e,t){try{let n=String(t||"");if(!e||!n)return null;let r=(i,s,c)=>{if(!i||i.type?.name!=="outlineSection")return null;let a=String(i.attrs?.id||""),l=[...c,s];if(a===n)return l;let d=i.child(0),p=i.child(1),h=i.child(2);if(!h||h.type?.name!=="outlineChildren")return null;let S=s+1+d.nodeSize+p.nodeSize+1;for(let f=0;f<h.childCount;f+=1){let m=h.child(f),b=S;S+=m.nodeSize;let x=r(m,b,l);if(x)return x}return null},o=0;for(let i=0;i<e.childCount;i+=1){let s=e.child(i),c=o;o+=s.nodeSize;let a=r(s,c,[]);if(a)return a}return null}catch{return null}}function hd(e,t={}){try{if(!ce||ce.isDestroyed)return!1;let n=String(e||"");if(!n)return!1;let{state:r,view:o}=ce,i=ze?.pmStateMod?.TextSelection,s=Kp(r.doc,n);if(!Array.isArray(s)||!s.length)return!1;let c=r.tr;for(let a of s){let l=c.doc.nodeAt(a);!l||l.type?.name!=="outlineSection"||l.attrs?.collapsed&&(c=c.setNodeMarkup(a,void 0,{...l.attrs,collapsed:!1}))}c=c.setMeta(le,!0);try{let a=at(c.doc,n),l=typeof a=="number"?c.doc.nodeAt(a):null;if(typeof a=="number"&&l?.type?.name==="outlineSection"){let d=l.child(0),p=a+1+d.nodeSize,h=Math.min(c.doc.content.size,p+2);i&&(c=c.setSelection(i.create(c.doc,h)))}}catch{}o.dispatch(c.scrollIntoView());try{let a=typeof CSS<"u"&&CSS.escape?CSS.escape(n):n.replace(/"/g,'\\"');window.requestAnimationFrame(()=>{try{let l=o.dom?.querySelector?.(`[data-outline-section][data-section-id="${a}"]`)||o.dom?.querySelector?.(`[data-section-id="${a}"]`);l&&typeof l.scrollIntoView=="function"&&l.scrollIntoView({block:"center",inline:"nearest"})}catch{}})}catch{}if(t&&t.focus)try{o.focus()}catch{}return!0}catch{return!1}}function Wp(e,t){if(!ce)return!1;let n=String(e||"");if(!n)return!1;let r=at(ce.state.doc,n);if(typeof r!="number")return!1;let o=ce.state.doc.nodeAt(r);if(!o)return!1;let i=ce.state.doc.type.schema,s=Dn(String(t||"")),c=Ys(s.titleHtml||"")||Ys(s.bodyHtml||"").slice(0,80)||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",a=yo?yo(s.bodyHtml||""):[],l=[];for(let f of a||[])try{l.push(i.nodeFromJSON(f))}catch{}l.length||l.push(i.nodes.paragraph.create({},[]));let d=i.nodes.outlineHeading.create({},c?[i.text(c)]:[]),p=i.nodes.outlineBody.create({},l),h=o.child(2),y=i.nodes.outlineSection.create(o.attrs,[d,p,h]),S=ce.state.tr.replaceWith(r,r+o.nodeSize,y);try{let f=ze?.pmStateMod?.TextSelection;f&&(S=S.setSelection(f.create(S.doc,r+2)))}catch{}return ce.view.dispatch(S),ce.view.focus(),nn=!0,tn({delayMs:200}),!0}function Yp(e,t){if(!ce)return!1;let n=String(e||"");if(!n)return!1;let r=at(ce.state.doc,n);if(typeof r!="number")return!1;let o=ce.state.doc.nodeAt(r);if(!o)return!1;let i=t&&typeof t=="object"?t:{},s=ce.state.doc.type.schema,c=null,a=null;try{i.heading&&typeof i.heading=="object"&&(c=s.nodeFromJSON(i.heading))}catch{c=null}try{i.body&&typeof i.body=="object"&&(a=s.nodeFromJSON(i.body))}catch{a=null}(!c||c.type?.name!=="outlineHeading")&&(c=s.nodes.outlineHeading.create({},[])),(!a||a.type?.name!=="outlineBody")&&(a=s.nodes.outlineBody.create({},[s.nodes.paragraph.create({},[])])),a.childCount||(a=s.nodes.outlineBody.create({},[s.nodes.paragraph.create({},[])]));let l=o.child(2),d=s.nodes.outlineSection.create(o.attrs,[c,a,l]),p=ce.state.tr.replaceWith(r,r+o.nodeSize,d);try{let h=ze?.pmStateMod?.TextSelection;h&&(p=p.setSelection(h.create(p.doc,r+2)))}catch{}return ce.view.dispatch(p),ce.view.focus(),nn=!0,tn({delayMs:200}),!0}function Xp(e,t){if(!ce)return!1;let n=String(e||"").trim();if(!n||typeof at(ce.state.doc,n)=="number")return!1;let o=t&&typeof t=="object"?t:{},i=ce.state.doc.type.schema,s=null,c=null;try{o.heading&&typeof o.heading=="object"&&(s=i.nodeFromJSON(o.heading))}catch{s=null}try{o.body&&typeof o.body=="object"&&(c=i.nodeFromJSON(o.body))}catch{c=null}(!s||s.type?.name!=="outlineHeading")&&(s=i.nodes.outlineHeading.create({},[])),(!c||c.type?.name!=="outlineBody")&&(c=i.nodes.outlineBody.create({},[i.nodes.paragraph.create({},[])])),c.childCount||(c=i.nodes.outlineBody.create({},[i.nodes.paragraph.create({},[])]));let a=i.nodes.outlineChildren.create({},[]),l=i.nodes.outlineSection.create({id:n,collapsed:!1},[s,c,a]),d=ce.state.doc.content.size,p=ce.state.tr.insert(d,l);try{let h=ze?.pmStateMod?.TextSelection;if(h){let y=Math.min(p.doc.content.size,d+2);p=p.setSelection(h.near(p.doc.resolve(Math.max(0,y)),1))}}catch{}return p=p.setMeta(le,!0),ce.view.dispatch(p.scrollIntoView()),ce.view.focus(),nn=!0,tn({delayMs:200}),!0}function Qp({enterEditMode:e=!0}={}){if(!ce)return null;let t=ce.state.doc.type.schema,n=ce.state.doc.content.size,r=Ut(),o=t.nodes.outlineSection.create({id:r,collapsed:!1},[t.nodes.outlineHeading.create({},[]),t.nodes.outlineBody.create({},[t.nodes.paragraph.create({},[])]),t.nodes.outlineChildren.create({},[])]),i=ce.state.tr.insert(n,o);try{let s=ze?.pmStateMod?.TextSelection;if(s){let c=at(i.doc,r),a=typeof c=="number"?bi(i.doc,c):null;typeof a=="number"?i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,a+2)),1)):i=i.setSelection(s.create(i.doc,n+2))}}catch{}return i=i.setMeta(le,!0),e&&ke&&(i=i.setMeta(ke,{type:"enter",sectionId:r})),ce.view.dispatch(i.scrollIntoView()),ce.view.focus(),nn=!0,tn({delayMs:200}),r}function bi(e,t){try{let n=e.nodeAt(t);if(!n||n.type?.name!=="outlineSection")return null;let r=n.child(0);return t+1+r.nodeSize}catch{return null}}function Gp(e,{focusBody:t=!0}={}){if(!ce||!ke)return!1;let n=String(e||"").trim();if(!n)return!1;let r=at(ce.state.doc,n);if(typeof r!="number"||ce.state.doc.nodeAt(r)?.attrs?.collapsed)return!1;let i=ce.state.tr;if(t)try{let s=ze?.pmStateMod?.TextSelection,c=bi(i.doc,r);s&&typeof c=="number"&&(i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,c+2)),1)))}catch{}return i=i.setMeta(le,!0),i=i.setMeta(ke,{type:"enter",sectionId:n}),ce.view.dispatch(i.scrollIntoView()),ce.view.focus(),!0}function Zp({enterEditMode:e=!0}={}){if(!ce)return null;let t=ce.state.doc.type.schema,n=0,r=Ut(),o=t.nodes.outlineSection.create({id:r,collapsed:!1},[t.nodes.outlineHeading.create({},[]),t.nodes.outlineBody.create({},[t.nodes.paragraph.create({},[])]),t.nodes.outlineChildren.create({},[])]),i=ce.state.tr.insert(n,o);try{let s=ze?.pmStateMod?.TextSelection;if(s){let c=at(i.doc,r),a=typeof c=="number"?bi(i.doc,c):null;typeof a=="number"?i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,a+2)),1)):i=i.setSelection(s.create(i.doc,n+2))}}catch{}return i=i.setMeta(le,!0),e&&ke&&(i=i.setMeta(ke,{type:"enter",sectionId:r})),ce.view.dispatch(i.scrollIntoView()),ce.view.focus(),nn=!0,tn({delayMs:200}),r}function em(e,t,{enterEditMode:n=!1}={}){if(!ce)return!1;let r=String(e||"").trim();if(!r||typeof at(ce.state.doc,r)=="number")return!1;let i=ce.state.doc.type.schema,s=i.nodes.paragraph,c=i.nodes.hardBreak||i.nodes.hard_break||null,a=String(t||"").replace(/\r\n/g,`
`).trimEnd(),l=()=>{if(!s)return[];if(!a.trim())return[s.create({},[])];let m=a.split(/\n{2,}/),b=[];for(let x of m){let v=String(x||"").split(`
`),L=[];for(let R=0;R<v.length;R+=1){let q=v[R];R>0&&c&&L.push(c.create()),q&&L.push(i.text(q))}b.push(s.create({},L))}return b.length?b:[s.create({},[])]},d=i.nodes.outlineHeading.create({},[]),p=i.nodes.outlineBody.create({},l()),h=i.nodes.outlineChildren.create({},[]),y=i.nodes.outlineSection.create({id:r,collapsed:!1},[d,p,h]),S=0,f=ce.state.tr.insert(S,y);try{let m=ze?.pmStateMod?.TextSelection;if(m){let b=at(f.doc,r),x=typeof b=="number"?bi(f.doc,b):null;typeof x=="number"?f=f.setSelection(m.near(f.doc.resolve(Math.min(f.doc.content.size,x+2)),1)):f=f.setSelection(m.create(f.doc,S+2))}}catch{}return f=f.setMeta(le,!0),n&&ke&&(f=f.setMeta(ke,{type:"enter",sectionId:r})),ce.view.dispatch(f.scrollIntoView()),ce.view.focus(),nn=!0,tn({delayMs:200}),!0}async function tm(){if(u.isPublicView||u.isRagView){ve("Outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0432 \u044D\u0442\u043E\u043C \u0440\u0435\u0436\u0438\u043C\u0435");return}if(!u.articleId||!u.article){ve("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}if(St=u.articleId,!V.outlineEditor||!V.blocksContainer){ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440");return}u.isOutlineEditing=!0,V.articleToolbar&&V.articleToolbar.classList.add("hidden"),V.outlineToolbar&&V.outlineToolbar.classList.remove("hidden"),V.outlineTagsBar&&V.outlineTagsBar.classList.remove("hidden"),V.outlineEditor.classList.remove("hidden"),V.blocksContainer.classList.add("hidden"),od({loading:!0});try{ot("outline.open",{articleId:St,updatedAt:u.article?.updatedAt||null,docHash:Pt(u.article?.docJson||null)})}catch{}try{if(!u.scrollTargetBlockId&&St){let e=Rp(St);e?.sectionId&&(u.currentBlockId=e.sectionId)}}catch{}try{await md();try{Bp(ce)}catch{}try{let t=u.scrollTargetBlockId||null;t&&(hd(t,{focus:!1}),u.scrollTargetBlockId=null,u.currentBlockId=t)}catch{}try{let t=u.currentBlockId||null;t&&_p(ce,t)}catch{}let e=V.outlineEditor.querySelector(".outline-editor__loading");if(e&&e.classList.add("hidden"),zn("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u0442\u0441\u044F \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438"),Tl||(Tl=!0,window.addEventListener("online",()=>{if(u.isOutlineEditing){try{Wl(St||u.articleId)}catch{}ho({force:!0})}}),window.addEventListener("blur",()=>{u.isOutlineEditing&&ho({force:!0})}),document.addEventListener("visibilitychange",()=>{u.isOutlineEditing&&document.visibilityState!=="visible"&&ho({force:!0})})),!mo){let t=r=>{if(!u.isOutlineEditing)return;let o=r?.dataTransfer;if(!(o&&(o.files&&o.files.length||o.items&&o.items.length)))return;let s=r?.target;V.outlineEditor&&s&&V.outlineEditor.contains(s)||r.preventDefault()},n=r=>{if(!u.isOutlineEditing)return;let o=r?.dataTransfer;if(!(o&&o.files&&o.files.length))return;let s=r?.target;V.outlineEditor&&s&&V.outlineEditor.contains(s)||(r.preventDefault(),r.stopPropagation())};window.addEventListener("dragover",t,{passive:!1}),window.addEventListener("drop",n,{passive:!1}),mo=()=>{window.removeEventListener("dragover",t),window.removeEventListener("drop",n),mo=null}}}catch(e){ve(e?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440"),gd()}}function gd(){u.isOutlineEditing=!1,Np(),ke=null,St=null,tr=null,pi=null,Sr={counts:new Map,labelByKey:new Map,sectionIdsByKey:new Map,sectionPosById:new Map};try{V.outlineTagsBar&&(V.outlineTagsBar.innerHTML="",V.outlineTagsBar.classList.add("hidden"))}catch{}po(!1),mo&&mo(),V.outlineToolbar&&V.outlineToolbar.classList.add("hidden"),V.articleToolbar&&V.articleToolbar.classList.remove("hidden"),Rn&&(clearTimeout(Rn),Rn=null),_t&&(clearTimeout(_t),_t=null),mr&&(clearTimeout(mr),mr=null),zs=null,En=!1,li="";try{mn.clear()}catch{}if(ci=!1,er.clear(),wr.clear(),en=null,nn=!1,ce){try{ce.destroy()}catch{}ce=null}ze=null,V.outlineEditor&&V.outlineEditor.classList.add("hidden"),V.blocksContainer&&V.blocksContainer.classList.remove("hidden")}async function nm(e={}){let t=e&&typeof e.mode=="string"?e.mode:"network",n=e&&typeof e.timeoutMs=="number"?Math.max(0,Math.floor(e.timeoutMs)):0;if(!ce)return;Rn&&(clearTimeout(Rn),Rn=null);try{let o=St||u.articleId;if(o&&!u.article?.encrypted){let i=ce.getJSON();if(i&&typeof i=="object")try{await sn(o,i,u.article?.updatedAt||null)}catch{}try{try{let s=ke?.getState?.(ce?.state)||null,c=String(s?.editingSectionId||"").trim();c&&await Gs({articleId:o,doc:ce.state.doc,sectionId:c,reason:"pagehide"})}catch{}if(En){let s=bo(ce.state.doc);s.length&&(Jt("structure_snapshot",{articleId:o,payload:{nodes:s},coalesceKey:`structure:${o}`}),En=!1)}}catch{}try{if(mn.size){let s=Array.from(mn);mn.clear();let c=Date.now();await Jt("delete_sections",{articleId:o,payload:{sectionIds:s,clientQueuedAt:c},coalesceKey:`delete:${o}:${c}`})}}catch{}}}catch{}if(t==="queue")return;let r=ho({force:!0,silent:!0});if(n>0){await Promise.race([r,new Promise(o=>setTimeout(o,n))]);return}await r}async function rm({docJson:e}={}){if(V.outlineEditor){if(!e||typeof e!="object"){ve("\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F: \u043D\u0435\u0442 \u0434\u043E\u043A\u0443\u043C\u0435\u043D\u0442\u0430");return}u.isPublicView=!0,u.isRagView=!1,u.isOutlineEditing=!1,u.articleId=null,u.article={docJson:e,encrypted:!1};try{V.outlineEditor.classList.add("outline-editor")}catch{}V.outlineEditor.classList.remove("hidden"),V.outlineEditor.querySelector("#outlineEditorContent")||od({loading:!0});try{await md();let t=V.outlineEditor.querySelector(".outline-editor__loading");t&&t.classList.add("hidden"),zn("\u0422\u043E\u043B\u044C\u043A\u043E \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440")}catch(t){ve(t?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E")}}}var Cl,ze,ce,uo,Rn,ci,mr,zs,Ds,jl,en,go,wr,er,nn,Tl,yo,Us,qs,ht,fr,Os,Bl,fo,ai,ke,mo,St,tr,pi,Sr,Fn,nr,Xf,ii,Vs,Js,Qf,Ml,ui,En,li,_t,mn,Hs,le,Pl,sp,cp,ap,si,om,im,Ye,Ko=We(()=>{wt();un();Vt();vn();Jn();Yt();Yr();ar();Ur();qr();gl();jn();yl();wl();zr();Cl=!1,ze=null,ce=null,uo=null,Rn=null,ci=!1,mr=null,zs=null,Ds=0,jl=null,en=null,go=new Map,wr=new Map,er=new Set,nn=!1,Tl=!1,yo=null,Us=null,qs=null,ht={TableMap:null,CellSelection:null,moveTableColumn:null,moveTableRow:null,addRowBefore:null,addRowAfter:null,deleteRow:null,addColumnBefore:null,addColumnAfter:null,deleteColumn:null,toggleHeaderRow:null,toggleHeaderColumn:null},fr=!1,Os=new Map,Bl=30*1e3,fo=new Map,ai=null,ke=null,mo=null,St=null,tr=null,pi=null,Sr={counts:new Map,labelByKey:new Map,sectionIdsByKey:new Map,sectionPosById:new Map},Fn=!1,nr=new Set,Xf=650,ii={articleId:null,sectionId:null,collapsed:null},Vs="ttree_outline_section_clipboard_v1",Js="pending-attachment:",Qf=2e3;Ml="ttree_outline_section_seq_v1",ui=262144;En=!1,li="",_t=null,mn=new Set,Hs=null;le="outlineAllowMutation",Pl=0,sp="ttree_outline_debug_md_table";cp="ttree_profile_v1";ap="ttree_outline_debug_proofread_v1";si=null;om="ttree_debug_outline_keys_v1",im=()=>{try{return window?.localStorage?.getItem?.(om)==="1"}catch{return!1}},Ye=(e,t={})=>{try{if(!im())return;console.log("[outline][keys]",e,t)}catch{}}});(()=>{let e=window.__memusAppModule||"/app.js",t="ttree_boot_session_v1",n="ttree_last_user_v1",r="ttree_last_active_at_v1",o=200,i=900*1e3,s=2500,c="ttree_debug_quick_notes_v1",a="ttree_offline_known_user_keys_v1",l="memus_offline_v1_",d="ttree_offline_recovery_force_index_v1",p="ttree_boot_open_offline_requested_v1",h=!1;try{h=window.sessionStorage?.getItem?.(p)==="1",h&&window.sessionStorage?.removeItem?.(p)}catch{}function y(){try{return window?.localStorage?.getItem?.(c)==="1"}catch{return!1}}function S(...g){try{if(!y())return;console.log("[quick-notes][boot]",...g)}catch{}}function f(...g){try{console.log("[quick-notes][recovery]",...g)}catch{}}function m(...g){try{console.error("[quick-notes][recovery]",...g)}catch{}}function b(){if("serviceWorker"in navigator)try{navigator.serviceWorker.register("/uploads-sw.js",{scope:"/",updateViaCache:"none"}).then(g=>{try{g&&g.waiting&&g.waiting.postMessage({type:"memus:skipWaiting"}),g?.addEventListener?.("updatefound",()=>{try{let k=g.installing;if(!k)return;k.addEventListener("statechange",()=>{if(k.state==="installed"&&navigator.serviceWorker.controller)try{g.waiting?.postMessage?.({type:"memus:skipWaiting"})}catch{}})}catch{}})}catch{}try{let k=g?.update?.();k&&typeof k.catch=="function"&&k.catch(()=>{})}catch{}}).catch(()=>{});try{let g=!!navigator.serviceWorker.controller,k=L(),M=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{if(!M&&(M=!0,!h&&g&&!k))try{window.location.reload()}catch{}})}catch{}}catch{}}function x(){try{return String(window.location.pathname||"").startsWith("/p/")}catch{return!1}}function v(){try{return!!(typeof navigator<"u"&&navigator&&navigator.onLine===!1)}catch{return!1}}function L(){try{let g=performance.getEntriesByType?.("navigation")||[],k=g&&g[0];return String(k?.type||"")==="reload"}catch{return!1}}function R(){try{let g=window.localStorage.getItem(r)||"",k=Number(g);return Number.isFinite(k)?k:0}catch{return 0}}function q(){try{window.localStorage.setItem(r,String(Date.now()))}catch{}}function j(){let g=R();return g?Date.now()-g>i:!0}function $(){try{return window.sessionStorage.getItem(t)?!1:(window.sessionStorage.setItem(t,"1"),!0)}catch{return!0}}function X(){try{let g=window.localStorage.getItem(n);if(!g)return!1;let k=JSON.parse(g);return!!(k&&(k.id||k.username))}catch{return!1}}function W(){try{if(globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function")return globalThis.crypto.randomUUID()}catch{}return`id-${Date.now()}-${Math.random().toString(16).slice(2)}`}function te(){return new Date().toISOString()}function be(){try{let g=window.localStorage.getItem(a)||"[]",k=JSON.parse(g);return Array.isArray(k)?k.filter(Boolean).map(String):[]}catch{return[]}}async function Oe(){try{if(!("indexedDB"in window))return[];if(typeof indexedDB.databases=="function"){let M=(await indexedDB.databases()||[]).map(B=>B&&B.name).filter(Boolean).filter(B=>String(B).startsWith(l)).map(B=>String(B).slice(l.length)).filter(Boolean);return Array.from(new Set(M))}}catch{}return Array.from(new Set(be()))}function re(g,k){return new Promise((M,_)=>{try{let B=k?indexedDB.open(g,k):indexedDB.open(g);k&&(B.onupgradeneeded=()=>{try{let C=B.result;if(C.objectStoreNames.contains("meta")||C.createObjectStore("meta",{keyPath:"key"}),!C.objectStoreNames.contains("articles")){let N=C.createObjectStore("articles",{keyPath:"id"});N.createIndex("byUpdatedAt","updatedAt",{unique:!1}),N.createIndex("byDeletedAt","deletedAt",{unique:!1})}if(!C.objectStoreNames.contains("outline_sections")){let N=C.createObjectStore("outline_sections",{keyPath:"sectionId"});N.createIndex("byArticleId","articleId",{unique:!1}),N.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!C.objectStoreNames.contains("section_embeddings")){let N=C.createObjectStore("section_embeddings",{keyPath:"sectionId"});N.createIndex("byArticleId","articleId",{unique:!1}),N.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!C.objectStoreNames.contains("media_assets")){let N=C.createObjectStore("media_assets",{keyPath:"url"});N.createIndex("byStatus","status",{unique:!1}),N.createIndex("byFetchedAtMs","fetchedAtMs",{unique:!1}),N.createIndex("byStatusFetchedAtMs",["status","fetchedAtMs"],{unique:!1})}if(!C.objectStoreNames.contains("media_refs")){let N=C.createObjectStore("media_refs",{keyPath:"key"});N.createIndex("byArticleId","articleId",{unique:!1}),N.createIndex("byUrl","url",{unique:!1})}if(C.objectStoreNames.contains("outbox"))try{let T=B.transaction.objectStore("outbox");T.indexNames.contains("byTypeCoalesceKey")||T.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}catch{}else{let N=C.createObjectStore("outbox",{keyPath:"id"});N.createIndex("byCreatedAtMs","createdAtMs",{unique:!1}),N.createIndex("byTypeArticleId",["type","articleId"],{unique:!1}),N.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}if(!C.objectStoreNames.contains("pending_uploads")){let N=C.createObjectStore("pending_uploads",{keyPath:"token"});N.createIndex("byArticleId","articleId",{unique:!1}),N.createIndex("byCreatedAtMs","createdAtMs",{unique:!1})}}catch{}}),B.onsuccess=()=>M(B.result),B.onerror=()=>{let C=B.error||new Error("IndexedDB open failed");m("idb.open.error",{name:g,version:k||null,message:String(C?.message||C)}),_(C)}}catch(B){m("idb.open.throw",{name:g,version:k||null,message:String(B?.message||B)}),_(B)}})}function he(g,k){return new Promise((M,_)=>{try{let N=g.transaction([k],"readonly").objectStore(k).getAll();N.onsuccess=()=>M(Array.isArray(N.result)?N.result:[]),N.onerror=()=>{let T=N.error||new Error("IndexedDB getAll failed");m("idb.getAll.error",{storeName:k,message:String(T?.message||T)}),_(T)}}catch(B){m("idb.getAll.throw",{storeName:k,message:String(B?.message||B)}),_(B)}})}function Qe(g,k){return new Promise((M,_)=>{try{let N=g.transaction([k],"readonly").objectStore(k).count();N.onsuccess=()=>M(Number(N.result||0)),N.onerror=()=>{let T=N.error||new Error("IndexedDB count failed");m("idb.count.error",{storeName:k,message:String(T?.message||T)}),_(T)}}catch(B){m("idb.count.throw",{storeName:k,message:String(B?.message||B)}),_(B)}})}function yt(g,k){try{let M=JSON.stringify(k),_=new Blob([M],{type:"application/json;charset=utf-8"}),B=URL.createObjectURL(_),C=document.createElement("a");return C.href=B,C.download=g,C.rel="noopener",document.body.appendChild(C),C.click(),setTimeout(()=>{try{C.remove(),URL.revokeObjectURL(B)}catch{}},0),!0}catch{return!1}}function Et(g,k){try{let M=URL.createObjectURL(k),_=document.createElement("a");return _.href=M,_.download=g,_.rel="noopener",document.body.appendChild(_),_.click(),setTimeout(()=>{try{_.remove(),URL.revokeObjectURL(M)}catch{}},0),!0}catch{return!1}}async function qt(g,{method:k="GET",body:M=null,timeoutMs:_=2e4}={}){let B=typeof AbortController<"u"?new AbortController:null,C={method:k,credentials:"include",headers:{},signal:B?.signal};M!==null&&(C.headers["Content-Type"]="application/json",C.body=JSON.stringify(M));let N=null,T=!1;B&&typeof _=="number"&&_>0&&(N=setTimeout(()=>{try{T=!0;try{B.abort(new Error(`timeout after ${_}ms`))}catch{B.abort()}}catch{}},_));let I;try{I=await fetch(g,C)}finally{N&&clearTimeout(N)}let A=await I.text().catch(()=>""),w=null;try{w=A?JSON.parse(A):null}catch{w=null}if(!I.ok){let D=w&&(w.detail||w.error)||A||`${I.status} ${I.statusText}`,P=new Error(D);throw P.status=I.status,P.payload=w,P}return w}async function Wt(g,k){try{return await qt(g,k)}catch(M){if(String(M?.name||"")==="AbortError"||String(M?.message||"").toLowerCase().includes("aborted")){let B=typeof k?.timeoutMs=="number"?k.timeoutMs:null,C=new Error(B?`timeout after ${B}ms`:"request aborted");throw C.name="TimeoutError",C}throw M}}function Tn(g){try{return g?JSON.parse(g):null}catch{return null}}function Bn(g){let k=String(g||"");return!!(!k||k==="inbox"||k.startsWith("inbox-"))}async function Z({userKey:g,onProgress:k}){let M=String(g||"").trim();if(!M)throw new Error("No userKey");let _=await re(`${l}${M}`).catch(O=>{throw m("restore.server.idb.open.error",{userKey:M,message:String(O?.message||O)}),O}),B=await he(_,"articles").catch(O=>{throw m("restore.server.idb.read.error",{userKey:M,message:String(O?.message||O)}),O});try{_.close()}catch{}let C=(Array.isArray(B)?B:[]).filter(O=>O&&!O.deletedAt&&!Bn(O.id)).map(O=>{let F=Tn(O.articleJsonStr)||{},U=Tn(O.docJsonStr)||F.docJson||null;return{id:String(O.id),title:(O.title||F.title||"").toString(),parentId:O.parentId??F.parentId??null,position:typeof O.position=="number"?O.position:typeof F.position=="number"?F.position:0,docJson:U&&typeof U=="object"?U:null}}).filter(O=>O.id&&O.docJson),N=C.length,T={n:0},I={n:0},A={n:0},w=(O,F={})=>{try{k?.({phase:O,total:N,created:T.n,saved:I.n,moved:A.n,...F})}catch{}};w("start");for(let O=0;O<C.length;O+=1){let F=C[O];w("content",{idx:O+1,articleId:F.id,title:F.title});try{f("restore.server.create.start",{idx:O+1,id:F.id}),await Wt("/api/articles",{method:"POST",body:{id:F.id,title:F.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"},timeoutMs:15e3}),T.n+=1,f("restore.server.create.done",{idx:O+1,id:F.id})}catch(U){f("restore.server.create.skip",{idx:O+1,id:F.id,status:U?.status||null,message:String(U?.message||U)})}try{f("restore.server.save.start",{idx:O+1,id:F.id}),await Wt(`/api/articles/${encodeURIComponent(F.id)}/doc-json`,{method:"PUT",body:{docJson:F.docJson},timeoutMs:3e4}),I.n+=1,f("restore.server.save.done",{idx:O+1,id:F.id})}catch(U){m("restore.server.save.error",{idx:O+1,id:F.id,status:U?.status||null,message:String(U?.message||U),stack:String(U?.stack||"")})}}let D=new Map;for(let O of C){let F=O.parentId||null;D.has(F)||D.set(F,[]),D.get(F).push(O)}for(let[O,F]of D.entries())F.sort((U,J)=>Number(U.position||0)-Number(J.position||0)),D.set(O,F);let P=[null],H=new Set;for(w("structure");P.length;){let O=P.shift(),F=O||"__root__";if(H.has(F))continue;H.add(F);let U=D.get(O||null)||[];for(let J of U){w("structure",{articleId:J.id,title:J.title});try{await qt(`/api/articles/${encodeURIComponent(J.id)}/move-tree`,{method:"POST",body:{parentId:O||null,anchorId:null,placement:"inside"}}),A.n+=1}catch(G){f("restore.server.move.skip",{id:J.id,status:G?.status||null,message:String(G?.message||G)})}D.has(J.id)&&P.push(J.id)}}return w("done"),{total:N,created:T.n,saved:I.n,moved:A.n}}function fe(g){let k=new TextEncoder,M=Object.entries(g?.stores||{}),_={type:"meta",exportedAt:g?.exportedAt||te(),sourceUserKey:g?.sourceUserKey||null,dbName:g?.dbName||null,format:"ndjson.v1"},B=!1,C=0,N=-1;return new ReadableStream({pull(T){try{if(!B){B=!0,T.enqueue(k.encode(`${JSON.stringify(_)}
`));return}for(;C<M.length;){let[I,A]=M[C],w=Array.isArray(A)?A:[];if(N===-1){N=0,T.enqueue(k.encode(`${JSON.stringify({type:"store",store:I,count:w.length})}
`));return}if(N>=w.length){C+=1,N=-1;continue}let D={type:"item",store:I,value:w[N]};N+=1,T.enqueue(k.encode(`${JSON.stringify(D)}
`));return}T.close()}catch(I){m("ndjson.stream.error",{message:String(I?.message||I),stack:String(I?.stack||"")}),T.error(I)}}})}async function ge(g,k){let M=fe(k),_=typeof CompressionStream<"u",B=_?M.pipeThrough(new CompressionStream("gzip")):M,C=await new Response(B).blob(),N=_?`${g}.ndjson.gz`:`${g}.ndjson`;if(Et(N,C))return{ok:!0,method:"download",filename:N};try{let T=URL.createObjectURL(C);try{window.open(T,"_blank","noopener")}catch{window.location.href=T}return{ok:!0,method:"open",filename:N}}catch(T){m("export.open.error",{filename:N,message:String(T?.message||T),stack:String(T?.stack||"")})}return{ok:!1,method:"none",filename:N}}function de(){try{let g=window.localStorage.getItem(n)||"",k=g?JSON.parse(g):null;return k?.id||k?.username||""}catch{return""}}async function se(g){let k=String(g||"").trim();if(!k)throw new Error("No userKey");let M=`${l}${k}`,_=await re(M,3),B=["articles","outline_sections","media_assets","media_refs","outbox","pending_uploads","section_embeddings","meta"].filter(N=>{try{return _.objectStoreNames.contains(N)}catch{return!1}}),C={exportedAt:te(),sourceUserKey:k,dbName:M,stores:{}};for(let N of B)C.stores[N]=await he(_,N).catch(T=>(m("export.store.read.error",{userKey:k,store:N,message:String(T?.message||T)}),[]));try{_.close()}catch{}return C}async function pe(g,k){let M=String(k||"").trim();if(!M)throw new Error("No target userKey");if(!g||typeof g!="object"||!g.stores||typeof g.stores!="object")throw new Error("Invalid dump");let _=`${l}${M}`,B=await re(_,3),C=async(T,I)=>{if(!B.objectStoreNames.contains(T))return 0;let A=Array.isArray(I)?I:[];if(!A.length)return 0;let w=B.transaction([T],"readwrite"),D=w.objectStore(T),P=0;return await new Promise((H,O)=>{w.oncomplete=()=>H(),w.onerror=()=>{let F=w.error||new Error("tx failed");m("import.tx.error",{storeName:T,message:String(F?.message||F)}),O(F)},w.onabort=()=>{let F=w.error||new Error("tx aborted");m("import.tx.abort",{storeName:T,message:String(F?.message||F)}),O(F)};for(let F of A)try{D.put(F),P+=1}catch{}}),P},N=0;N+=await C("articles",g.stores.articles),N+=await C("outline_sections",g.stores.outline_sections),N+=await C("media_assets",g.stores.media_assets),N+=await C("media_refs",g.stores.media_refs),N+=await C("pending_uploads",g.stores.pending_uploads),N+=await C("section_embeddings",g.stores.section_embeddings);try{B.close()}catch{}return N}let me="ttree_pending_quick_notes_v1";function Q(){try{let g=window.localStorage.getItem(me)||"";if(!g)return[];let k=JSON.parse(g);return Array.isArray(k)?k.filter(Boolean):[]}catch{return[]}}function ye(g){try{window.localStorage.setItem(me,JSON.stringify(Array.isArray(g)?g:[]))}catch{}}function Pe(g){let k=String(g||"").trim();if(!k)return null;let M=W(),_={id:M,sectionId:M,createdAt:te(),text:k},B=Q(),C=[_,...B].slice(0,o);return ye(C),S("saved.pending",{id:_.id,len:C.length}),_}function He(){if(document.getElementById("quickNoteBootStyles"))return;let g=document.createElement("style");g.id="quickNoteBootStyles",g.textContent=`
      .boot-modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:99999;display:flex;align-items:center;justify-content:center;padding:16px}
      .boot-modal{width:min(720px,100%);background:#0b1220;border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:0 24px 80px rgba(0,0,0,.5);color:#e5e7eb}
      .boot-modal__hdr{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between;gap:12px}
      .boot-modal__title{font-size:14px;font-weight:600;letter-spacing:.2px}
      .boot-modal__meta{font-size:12px;color:#9ca3af}
      .boot-modal__body{padding:12px 16px}
      .boot-note{width:100%;min-height:34vh;max-height:52vh;resize:vertical;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:12px 12px;font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;outline:none}
      .boot-note:focus{border-color:rgba(59,130,246,.6);box-shadow:0 0 0 3px rgba(59,130,246,.25)}
      .boot-modal__ftr{padding:12px 16px;border-top:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
      .boot-actions{display:flex;gap:10px;flex-wrap:wrap}
      .boot-btn{appearance:none;border:1px solid rgba(255,255,255,.14);background:#111827;color:#e5e7eb;border-radius:999px;padding:10px 14px;font:600 13px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;cursor:pointer}
      .boot-btn:hover{background:#0f172a}
      .boot-btn--primary{background:#2563eb;border-color:#2563eb}
      .boot-btn--primary:hover{background:#1d4ed8}
      .boot-btn--ghost{background:transparent}
      .boot-hint{font-size:12px;color:#9ca3af}
      .boot-toast{margin-left:auto;font-size:12px;color:#a7f3d0}
    `,document.head.appendChild(g)}function Ge(g,{timeout:k=5e3,fallbackDelay:M=1200}={}){try{if(typeof requestIdleCallback=="function"){requestIdleCallback(()=>g(),{timeout:k});return}}catch{}setTimeout(()=>g(),M)}function Ze(){Ge(()=>{try{import(e).catch(()=>{})}catch{}})}function je({reason:g=""}={}){He();let k=document.createElement("div");k.className="boot-modal-backdrop";let M=document.createElement("div");M.className="boot-modal";let _=document.createElement("div");_.className="boot-modal__hdr";let B=document.createElement("div"),C=document.createElement("div");C.className="boot-modal__title",C.textContent="\u0411\u044B\u0441\u0442\u0440\u0430\u044F \u0437\u0430\u043C\u0435\u0442\u043A\u0430 (\u043E\u0444\u0444\u043B\u0430\u0439\u043D-\u0431\u0443\u0444\u0435\u0440)";let N=document.createElement("div");N.className="boot-modal__meta";let T=Q().length;N.textContent=T?`\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438: ${T}`:g?`\u041F\u0440\u0438\u0447\u0438\u043D\u0430: ${g}`:"\u041C\u043E\u0436\u043D\u043E \u0431\u0435\u0437 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430 \u0438 \u0431\u0435\u0437 \u0432\u0445\u043E\u0434\u0430",B.appendChild(C),B.appendChild(N);let I=document.createElement("button");I.type="button",I.className="boot-btn boot-btn--ghost",I.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",_.appendChild(B),_.appendChild(I);let A=document.createElement("div");A.className="boot-modal__body";let w=document.createElement("textarea");w.className="boot-note",w.placeholder=`\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0443\u2026

Ctrl+Enter \u2014 \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C
Esc \u2014 \u0437\u0430\u043A\u0440\u044B\u0442\u044C`,A.appendChild(w);let D=document.createElement("div");D.className="boot-modal__ftr";let P=document.createElement("div");P.className="boot-hint",P.textContent="\u0417\u0430\u043C\u0435\u0442\u043A\u0438 \u0441\u043E\u0445\u0440\u0430\u043D\u044F\u044E\u0442\u0441\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E \u0438 \u0431\u0443\u0434\u0443\u0442 \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u044B \u0432 \u201C\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438\u201D \u043F\u0440\u0438 \u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0435\u043C \u0432\u0445\u043E\u0434\u0435.";let H=document.createElement("div");H.className="boot-actions";let O=document.createElement("button");O.type="button",O.className="boot-btn boot-btn--primary",O.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C";let F=document.createElement("button");F.type="button",F.className="boot-btn",F.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0438 \u0435\u0449\u0451",H.appendChild(O),H.appendChild(F);let U=document.createElement("div");U.className="boot-toast",D.appendChild(P),D.appendChild(H),D.appendChild(U),M.appendChild(_),M.appendChild(A),M.appendChild(D),k.appendChild(M);let J=()=>{let ie=Q().length;N.textContent=ie?`\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438: ${ie}`:g?`\u041F\u0440\u0438\u0447\u0438\u043D\u0430: ${g}`:"\u041C\u043E\u0436\u043D\u043E \u0431\u0435\u0437 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430 \u0438 \u0431\u0435\u0437 \u0432\u0445\u043E\u0434\u0430"},G=()=>{try{k.remove()}catch{}},ae=ie=>{let Be=Pe(w.value);if(Be){w.value="",U.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E",J(),q();try{window.dispatchEvent(new CustomEvent("memus:queued-inbox-changed",{detail:{note:Be}})),S("event.dispatched",{type:"memus:queued-inbox-changed"})}catch{}ie||G(),setTimeout(()=>{try{U.textContent=""}catch{}},1200)}};I.addEventListener("click",G),k.addEventListener("click",ie=>{ie.target===k&&G()}),O.addEventListener("click",()=>ae(!1)),F.addEventListener("click",()=>ae(!0)),w.addEventListener("keydown",ie=>{if(ie.key==="Escape"){ie.preventDefault(),G();return}ie.key==="Enter"&&(ie.ctrlKey||ie.metaKey)&&(ie.preventDefault(),ae(!0))});let xe=async()=>{He();let ie=document.createElement("div");ie.className="boot-modal-backdrop";let Be=document.createElement("div");Be.className="boot-modal";let De=document.createElement("div");De.className="boot-modal__hdr";let Je=document.createElement("div"),it=document.createElement("div");it.className="boot-modal__title",it.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0445 \u0434\u0430\u043D\u043D\u044B\u0445";let $e=document.createElement("div");$e.className="boot-modal__meta",$e.textContent="\u0418\u0449\u0435\u043C \u0441\u0442\u0430\u0440\u044B\u0435 \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0435 \u0431\u0430\u0437\u044B\u2026",Je.appendChild(it),Je.appendChild($e);let st=document.createElement("button");st.type="button",st.className="boot-btn boot-btn--ghost",st.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",De.appendChild(Je),De.appendChild(st);let ct=document.createElement("div");ct.className="boot-modal__body";let xt=document.createElement("div");xt.style.display="flex",xt.style.flexDirection="column",xt.style.gap="10px",ct.appendChild(xt);let z=document.createElement("div");z.className="boot-modal__ftr";let ne=document.createElement("div");ne.className="boot-hint",ne.textContent="\u0415\u0441\u043B\u0438 \u043F\u043E\u0441\u043B\u0435 \u0432\u0445\u043E\u0434\u0430 \u0432\u0441\u0435 \u0441\u0442\u0430\u0442\u044C\u0438 \u043F\u0440\u043E\u043F\u0430\u043B\u0438, \u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E \u0438\u0437\u043C\u0435\u043D\u0438\u043B\u0441\u044F userKey. \u0417\u0434\u0435\u0441\u044C \u043C\u043E\u0436\u043D\u043E \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0430\u0440\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 \u0438\u043B\u0438 \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0438\u0445 \u0432 \u0442\u0435\u043A\u0443\u0449\u0435\u0433\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F.";let K=document.createElement("div");K.className="boot-toast",z.appendChild(ne),z.appendChild(K),Be.appendChild(De),Be.appendChild(ct),Be.appendChild(z),ie.appendChild(Be);let Y=()=>{try{ie.remove()}catch{}};st.addEventListener("click",Y),ie.addEventListener("click",ee=>{ee.target===ie&&Y()}),document.body.appendChild(ie);let oe=(ee,{articleCount:ue}={})=>{let we=document.createElement("div");we.style.border="1px solid rgba(255,255,255,.12)",we.style.borderRadius="12px",we.style.padding="12px",we.style.display="flex",we.style.flexDirection="column",we.style.gap="10px";let Ie=document.createElement("div");Ie.style.display="flex",Ie.style.alignItems="baseline",Ie.style.justifyContent="space-between",Ie.style.gap="12px";let Ne=document.createElement("div");Ne.style.fontWeight="600",Ne.style.fontSize="13px",Ne.textContent=ee;let Se=document.createElement("div");Se.dataset.recoveryMeta="1",Se.style.fontSize="12px",Se.style.color="#9ca3af",Se.textContent=typeof ue=="number"?`\u0421\u0442\u0430\u0442\u0435\u0439: ${ue}`:"",Ie.appendChild(Ne),Ie.appendChild(Se);let Le=document.createElement("div");Le.className="boot-actions";let Me=document.createElement("button");Me.type="button",Me.className="boot-btn",Me.textContent="\u042D\u043A\u0441\u043F\u043E\u0440\u0442 JSON";let Te=document.createElement("button");Te.type="button",Te.className="boot-btn boot-btn--primary",Te.textContent="\u0418\u043C\u043F\u043E\u0440\u0442 \u0432 \u0442\u0435\u043A\u0443\u0449\u0435\u0433\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F";let Ae=document.createElement("button");return Ae.type="button",Ae.className="boot-btn",Ae.textContent="\u041D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440",Le.appendChild(Me),Le.appendChild(Te),Le.appendChild(Ae),we.appendChild(Ie),we.appendChild(Le),Me.addEventListener("click",async()=>{let Ce=performance.now();try{K.textContent="\u042D\u043A\u0441\u043F\u043E\u0440\u0442\u2026",f("export.start",{userKey:ee});let Ee=await se(ee),Fe=`memus-offline-recovery-${ee}-${new Date().toISOString().replace(/[:.]/g,"-")}`,Re=await ge(Fe,Ee);f("export.done",{userKey:ee,ok:Re.ok,method:Re.method,filename:Re.filename,ms:Math.round(performance.now()-Ce)}),K.textContent=Re.ok?Re.method==="download"?`\u0421\u043A\u0430\u0447\u0438\u0432\u0430\u043D\u0438\u0435 \u043D\u0430\u0447\u0430\u043B\u043E\u0441\u044C: ${Re.filename}`:Re.method==="open"?`\u041E\u0442\u043A\u0440\u044B\u043B \u0444\u0430\u0439\u043B \u0432 \u043D\u043E\u0432\u043E\u0439 \u0432\u043A\u043B\u0430\u0434\u043A\u0435: ${Re.filename}`:`\u042D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043E: ${Re.filename}`:"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C (\u043E\u0433\u0440\u0430\u043D\u0438\u0447\u0435\u043D\u0438\u044F \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0430)"}catch(Ee){m("export.button.error",{userKey:ee,message:String(Ee?.message||Ee),stack:String(Ee?.stack||"")}),K.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430 \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0430: ${String(Ee&&Ee.message?Ee.message:Ee)}`}finally{setTimeout(()=>{try{K.textContent=""}catch{}},8e3)}}),Te.addEventListener("click",async()=>{let Ce=performance.now();try{let Ee=de();if(!Ee){K.textContent="\u041D\u0435\u0442 \u201C\u0442\u0435\u043A\u0443\u0449\u0435\u0433\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\u201D \u0432 localStorage. \u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0434\u0438\u043D \u0440\u0430\u0437 \u0432\u043E\u0439\u0434\u0438\u0442\u0435.";return}K.textContent="\u0418\u043C\u043F\u043E\u0440\u0442\u2026",f("import.start",{from:ee,to:Ee});let Fe=await se(ee),Re=await pe(Fe,Ee);try{window.localStorage.setItem(d,"1")}catch{}let Xe=await re(`${l}${Ee}`).catch(()=>null),lt=null,ft=null;if(Xe){lt=await Qe(Xe,"articles").catch(()=>null),ft=await Qe(Xe,"outline_sections").catch(()=>null);try{Xe.close()}catch{}}f("import.done",{from:ee,to:Ee,imported:Re,targetArticles:lt,targetSections:ft,ms:Math.round(performance.now()-Ce)});let on=typeof lt=="number"?` (\u0432 \u0431\u0430\u0437\u0435 \u0441\u0442\u0430\u0442\u0435\u0439: ${lt})`:"";K.textContent=`\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0437\u0430\u043F\u0438\u0441\u0435\u0439: ${Re}${on}`;try{window.dispatchEvent(new CustomEvent("memus:offline-recovery-imported",{detail:{from:ee,to:Ee}}))}catch{}}catch(Ee){m("import.button.error",{userKey:ee,message:String(Ee?.message||Ee),stack:String(Ee?.stack||"")}),K.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430 \u0438\u043C\u043F\u043E\u0440\u0442\u0430: ${String(Ee&&Ee.message?Ee.message:Ee)}`}finally{setTimeout(()=>{try{K.textContent=""}catch{}},8e3)}}),Ae.addEventListener("click",async()=>{let Ce=performance.now();try{K.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u043D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u2026",f("restore.server.start",{userKey:ee});let Ee=await Z({userKey:ee,onProgress:Fe=>{let Re=Fe.phase;Re==="content"?K.textContent=`\u041D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440: ${Fe.idx}/${Fe.total} \xB7 ${Fe.title||Fe.articleId}`:Re==="structure"?K.textContent=`\u0421\u0442\u0440\u0443\u043A\u0442\u0443\u0440\u0430\u2026 (${Fe.moved}/${Fe.total})`:Re==="done"&&(K.textContent=`\u0413\u043E\u0442\u043E\u0432\u043E: \u0441\u0442\u0430\u0442\u0435\u0439=${Fe.total}, \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E=${Fe.saved}`),f("restore.server.progress",Fe)}});f("restore.server.done",{...Ee,ms:Math.round(performance.now()-Ce)}),K.textContent=`\u041D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440: \u0441\u0442\u0430\u0442\u0435\u0439=${Ee.total}, \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E=${Ee.saved}`}catch(Ee){m("restore.server.error",{userKey:ee,message:String(Ee?.message||Ee),stack:String(Ee?.stack||"")}),K.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430: ${String(Ee?.message||Ee)}`}finally{setTimeout(()=>{try{K.textContent=""}catch{}},12e3)}}),we};try{let ee=await Oe();if(!ee.length){$e.textContent="\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0435 \u0431\u0430\u0437\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B. \u0415\u0441\u043B\u0438 \u0432\u044B \u0442\u043E\u0447\u043D\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043B\u0438\u0441\u044C Memus \u043D\u0430 \u044D\u0442\u043E\u043C \u0443\u0441\u0442\u0440\u043E\u0439\u0441\u0442\u0432\u0435, \u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E \u0431\u0440\u0430\u0443\u0437\u0435\u0440 \u043D\u0435 \u0434\u0430\u0451\u0442 \u043F\u0435\u0440\u0435\u0447\u0438\u0441\u043B\u044F\u0442\u044C IndexedDB.";return}$e.textContent=`\u041D\u0430\u0439\u0434\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0445 \u0431\u0430\u0437: ${ee.length}`;for(let ue of ee){let we=oe(ue);xt.appendChild(we);let Ie=await re(`${l}${ue}`).catch(()=>null);if(Ie){let Ne=await Qe(Ie,"articles").catch(()=>null);try{Ie.close()}catch{}if(typeof Ne=="number")try{let Se=we.querySelector('[data-recovery-meta="1"]');Se&&(Se.textContent=`\u0421\u0442\u0430\u0442\u0435\u0439: ${Ne}`)}catch{}}}}catch(ee){$e.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430: ${String(ee&&ee.message?ee.message:ee)}`}};document.body.appendChild(k),setTimeout(()=>w.focus({preventScroll:!0}),0)}function qe(){let g=()=>q();try{window.addEventListener("pointerdown",g,{passive:!0}),window.addEventListener("keydown",g,{passive:!0}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&g()})}catch{}}function rt(){let g=()=>{try{Promise.resolve().then(()=>(Ko(),jo)).then(k=>k.flushOutlineAutosave?.({mode:"queue"})).catch(()=>{})}catch{}try{Promise.resolve().then(()=>(_s(),Ps)).then(k=>k.flushOutboxOnce?.()).catch(()=>{})}catch{}};try{window.addEventListener("pagehide",g),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&g()})}catch{}}let tt=!1,Ke=g=>{if(!tt){tt=!0;try{document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>je({reason:g}),{once:!0}):je({reason:g})}catch{}}};function Ve({subtitle:g=null,error:k=null,showRetry:M=!1,showOffline:_=!1}={}){try{let B=document.getElementById("authOverlay");if(!B)return;let C=document.getElementById("authSubtitle"),N=document.getElementById("authError");if(C&&g!=null&&(C.textContent=String(g)),N){let w=k!=null?String(k):"";N.textContent=w,N.classList.toggle("hidden",!w)}let T=B.querySelector(".auth-card")||B,I=document.getElementById("bootLoadActions");I||(I=document.createElement("div"),I.id="bootLoadActions",I.style.display="flex",I.style.gap="10px",I.style.flexWrap="wrap",I.style.marginTop="12px",T.appendChild(I)),I.innerHTML="";let A=(w,D)=>{let P=document.createElement("button");return P.type="button",P.className="auth-submit",P.style.padding="10px 14px",P.style.borderRadius="999px",P.style.fontSize="13px",P.textContent=w,P.addEventListener("click",D),P};if(M&&I.appendChild(A("\u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C",()=>{try{window.location.reload()}catch{}})),_){let w=()=>{let D=!1;try{D=!!("serviceWorker"in navigator&&navigator.serviceWorker?.controller)}catch{D=!1}if(v()&&!D){Ve({subtitle:"\u041D\u0435\u0442 \u0441\u0435\u0442\u0438",error:`\u041E\u0444\u0444\u043B\u0430\u0439\u043D-\u0440\u0435\u0436\u0438\u043C \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u043F\u043E\u0441\u043B\u0435 \u0442\u043E\u0433\u043E, \u043A\u0430\u043A \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435 \u0445\u043E\u0442\u044F \u0431\u044B \u043E\u0434\u0438\u043D \u0440\u0430\u0437 \u043E\u0442\u043A\u0440\u044B\u043B\u043E\u0441\u044C \u0441 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u043E\u043C \u0438 \u0437\u0430\u043A\u0435\u0448\u0438\u0440\u043E\u0432\u0430\u043B\u043E \u0444\u0430\u0439\u043B\u044B.

\u0415\u0441\u043B\u0438 \u0432\u044B \u0442\u043E\u043B\u044C\u043A\u043E \u0447\u0442\u043E \u0443\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u043B\u0438 PWA \u2014 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0435\u0433\u043E \u043E\u043D\u043B\u0430\u0439\u043D, \u0434\u043E\u0436\u0434\u0438\u0442\u0435\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438, \u0437\u0430\u0442\u0435\u043C \u043C\u043E\u0436\u043D\u043E \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u0431\u0435\u0437 \u0441\u0435\u0442\u0438.`,showRetry:!0,showOffline:!0});return}try{window.sessionStorage?.setItem?.(p,"1")}catch{}try{let H=document.getElementById("authSubtitle");H&&(H.textContent="\u041E\u0442\u043A\u0440\u044B\u0432\u0430\u0435\u043C \u0430\u0432\u0442\u043E\u043D\u043E\u043C\u043D\u044B\u0439 \u0440\u0435\u0436\u0438\u043C\u2026");let O=document.getElementById("authError");O&&(O.textContent="",O.classList.add("hidden"))}catch{}try{if(D){window.location.reload();return}}catch{}try{window.location.reload();return}catch{}try{Ot({reason:"offline_button",background:!1})}catch{}};I.appendChild(A("\u041E\u0442\u043A\u0440\u044B\u0442\u044C \u043E\u0444\u0444\u043B\u0430\u0439\u043D-\u0431\u0443\u0444\u0435\u0440",()=>{try{w()}catch{}}))}}catch{}}let nt=!1,Ue=!1;function Ot({reason:g="",background:k=!1}={}){if(!Ue&&!(nt&&!k)){nt=!0;try{let M=import(e);M&&typeof M.catch=="function"&&M.catch(_=>{Ue=!0;let C="\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435. "+(v()?"\u041F\u043E\u0445\u043E\u0436\u0435, \u0441\u0435\u0439\u0447\u0430\u0441 \u043D\u0435\u0442 \u0441\u0435\u0442\u0438.":"\u041F\u043E\u0445\u043E\u0436\u0435, \u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u0435\u0442\u044C\u044E/\u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C.")+" \u041C\u043E\u0436\u043D\u043E \u043F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C \u0432 \u0430\u0432\u0442\u043E\u043D\u043E\u043C\u043D\u043E\u043C \u0440\u0435\u0436\u0438\u043C\u0435 \u0438\u043B\u0438 \u043F\u043E\u043F\u0440\u043E\u0431\u043E\u0432\u0430\u0442\u044C \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443.";if(Ve({subtitle:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",error:C,showRetry:!0,showOffline:!0}),!h)try{tt||Ke("\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438")}catch{}S("app.import.failed",{reason:g,message:String(_?.message||_||"")})})}catch(M){Ue=!0,Ve({subtitle:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",error:"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435. \u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443.",showRetry:!0,showOffline:!0}),S("app.import.throw",{reason:g,message:String(M?.message||M||"")})}}}if(x()){b(),Ot({reason:"public",background:!1});return}b();let Ct=$(),Nt=X(),Tt=v(),rn=L(),bt=j();qe(),rt(),q(),(Tt&&!h||rn||bt||Ct&&Nt)&&Ke(Tt?"\u043D\u0435\u0442 \u0441\u0435\u0442\u0438":rn?"\u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430":bt?"\u043F\u0440\u043E\u0441\u0442\u043E\u0439 > 15 \u043C\u0438\u043D":"\u0445\u043E\u043B\u043E\u0434\u043D\u044B\u0439 \u0441\u0442\u0430\u0440\u0442"),window.setTimeout(()=>{try{if(tt||window.__memusAppStarted||h)return;Ve({subtitle:"\u041C\u0435\u0434\u043B\u0435\u043D\u043D\u0430\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430\u2026",error:"\u0415\u0441\u043B\u0438 \u0441\u0435\u0442\u044C \u043D\u0435\u0441\u0442\u0430\u0431\u0438\u043B\u044C\u043D\u0430, \u043C\u043E\u0436\u043D\u043E \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u043E\u0444\u0444\u043B\u0430\u0439\u043D-\u0431\u0443\u0444\u0435\u0440. \u041F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435 \u043F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442 \u043F\u044B\u0442\u0430\u0442\u044C\u0441\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C\u0441\u044F \u0432 \u0444\u043E\u043D\u0435.",showRetry:!0,showOffline:!0}),Ke("\u043C\u0435\u0434\u043B\u0435\u043D\u043D\u0430\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430")}catch{}},s),tt||Tt?Ge(()=>Ot({reason:"idle",background:!0}),{timeout:5e3,fallbackDelay:1200}):Ot({reason:"foreground",background:!1})})();
