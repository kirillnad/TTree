var hu=Object.defineProperty;var et=(e,t)=>()=>(e&&(t=e(e=0)),t);var Uo=(e,t)=>{for(var n in t)hu(e,n,{get:t[n],enumerable:!0})};function Va(e){Qi=e}var u,Qi,Ht=et(()=>{u={mode:"view",serverStatus:"unknown",serverStatusText:"",offlineReady:!1,offlineInitStatus:"idle",offlineInitError:"",offlineInitStartedAt:null,mediaStatusText:"",mediaPrefetchPaused:!1,isOutlineEditing:!1,outlineStatusText:"",isPublicView:!1,isRagView:!1,currentUser:null,articleId:null,article:null,currentBlockId:null,editingBlockId:null,selectionAnchorBlockId:null,selectedBlockIds:[],undoStack:[],redoStack:[],pendingTextPreview:null,editingUndo:null,editingInitialText:"",searchQuery:"",searchResults:[],searchError:"",searchLoading:!1,searchRequestId:0,searchMode:"classic",sidebarSearchView:"list",ragQuery:"",ragResults:[],ragBlockMap:{},ragSummaryHtml:"",ragSummaryLoading:!1,ragSummaryError:"",scrollTargetBlockId:null,pendingEditBlockId:null,isEditingTitle:!1,isSidebarCollapsed:!1,isSidebarMobileOpen:!1,articlesIndex:[],deletedArticlesIndex:[],articleFilterQuery:"",isMarkdownInserting:!1,isTrashView:!1,favoriteArticles:[],sidebarArticlesMode:"tree",recentArticleIds:[],sidebarSelectedArticleId:null,listSelectedArticleId:null,sidebarCollapsedArticleIds:[],listCollapsedArticleIds:[],isDragModeEnabled:!1,articleEncryptionKeys:{},isMergingBlocks:!1,isMovingBlock:!1,isDeletingBlock:!1,moveQueue:[],isMoveQueueProcessing:!1,editingScrollTop:null,editingCaretPosition:"start",outboxCount:null,offlineArticlesWithDoc:null,offlineArticlesTotal:null},Qi=!1});var V,Bn=et(()=>{V={authOverlay:document.getElementById("authOverlay"),authLoginTab:document.getElementById("authLoginTab"),authRegisterTab:document.getElementById("authRegisterTab"),authLoginForm:document.getElementById("authLoginForm"),authRegisterForm:document.getElementById("authRegisterForm"),authLoginUsername:document.getElementById("authLoginUsername"),authLoginPassword:document.getElementById("authLoginPassword"),authRegisterUsername:document.getElementById("authRegisterUsername"),authRegisterPassword:document.getElementById("authRegisterPassword"),authRegisterDisplayName:document.getElementById("authRegisterDisplayName"),authError:document.getElementById("authError"),authSubtitle:document.getElementById("authSubtitle"),authGoogleLoginBtn:document.getElementById("authGoogleLoginBtn"),authYandexLoginBtn:document.getElementById("authYandexLoginBtn"),authStorageInfo:document.getElementById("authStorageInfo"),currentUserLabel:document.getElementById("currentUserLabel"),logoutBtn:document.getElementById("logoutBtn"),userMenuBtn:document.getElementById("userMenuBtn"),userMenu:document.getElementById("userMenu"),sidebarSyncStatusPill:document.getElementById("sidebarSyncStatusPill"),syncMenu:document.getElementById("syncMenu"),syncMenuStatusLabel:document.getElementById("syncMenuStatusLabel"),syncMenuArticlesLabel:document.getElementById("syncMenuArticlesLabel"),syncMenuOutboxLabel:document.getElementById("syncMenuOutboxLabel"),offlineStatusItem:document.getElementById("offlineStatusItem"),offlineStatusLabel:document.getElementById("offlineStatusLabel"),offlineFetchBtn:document.getElementById("offlineFetchBtn"),offlineRepairBtn:document.getElementById("offlineRepairBtn"),telegramLinkBtn:document.getElementById("telegramLinkBtn"),telegramBotOpenBtn:document.getElementById("telegramBotOpenBtn"),telegramFeedbackBotOpenBtn:document.getElementById("telegramFeedbackBotOpenBtn"),openUsersViewBtn:document.getElementById("openUsersViewBtn"),usersView:document.getElementById("usersView"),usersList:document.getElementById("usersList"),usersBackBtn:document.getElementById("usersBackBtn"),graphView:document.getElementById("graphView"),graphCanvas:document.getElementById("graphCanvas"),graphBackBtn:document.getElementById("graphBackBtn"),articleListView:document.getElementById("articleListView"),articleView:document.getElementById("articleView"),articleHeader:document.getElementById("articleHeader"),articleTitle:document.getElementById("articleTitle"),updatedAt:document.getElementById("updatedAt"),articleStatusText:document.getElementById("articleStatusText"),mediaStatusText:document.getElementById("mediaStatusText"),mediaPrefetchToggleBtn:document.getElementById("mediaPrefetchToggleBtn"),blocksContainer:document.getElementById("blocksContainer"),articleList:document.getElementById("articleList"),createArticleBtn:document.getElementById("createArticleBtn"),backToList:document.getElementById("backToList"),toast:document.getElementById("toast"),searchInput:document.getElementById("searchInput"),searchClearBtn:document.getElementById("searchClearBtn"),searchResults:document.getElementById("searchResults"),searchPanel:document.querySelector(".search-panel"),searchModeToggle:document.getElementById("searchModeToggle"),sidebarSearchViewToggle:document.getElementById("sidebarSearchViewToggle"),ragOpenBtn:document.getElementById("ragOpenBtn"),articleTitleInput:document.getElementById("articleTitleInput"),editTitleBtn:document.getElementById("editTitleBtn"),hintToggleBtn:document.getElementById("hintToggleBtn"),hintPopover:document.getElementById("hintPopover"),sidebar:document.getElementById("sidebar"),sidebarToggle:document.getElementById("sidebarToggle"),sidebarArticleList:document.getElementById("sidebarArticleList"),sidebarNewArticleBtn:document.getElementById("sidebarNewArticleBtn"),sidebarRecentBtn:document.getElementById("sidebarRecentBtn"),openInboxBtn:document.getElementById("openInboxBtn"),quickNoteAddBtn:document.getElementById("quickNoteAddBtn"),articleFilterInput:document.getElementById("articleFilterInput"),trashTabBtn:document.getElementById("trashTabBtn"),articlesTabBtn:document.getElementById("articlesTabBtn"),semanticReindexBtn:document.getElementById("semanticReindexBtn"),graphToggleBtn:document.getElementById("graphToggleBtn"),listMenuBtn:document.getElementById("listMenuBtn"),listMenu:document.getElementById("listMenu"),articleMenuBtn:document.getElementById("articleMenuBtn"),articleMenu:document.getElementById("articleMenu"),articleFavoriteBtn:document.getElementById("articleFavoriteBtn"),articlePublicLinkBtn:document.getElementById("articlePublicLinkBtn"),articlePublicToggleBtn:document.getElementById("articlePublicToggleBtn"),articleEncryptionBtn:document.getElementById("articleEncryptionBtn"),articleEncryptionRemoveBtn:document.getElementById("articleEncryptionRemoveBtn"),deleteArticleBtn:document.getElementById("deleteArticleBtn"),exportArticleBtn:document.getElementById("exportArticleBtn"),outlineEditBtn:document.getElementById("outlineEditBtn"),saveVersionBtn:document.getElementById("saveVersionBtn"),versionsBtn:document.getElementById("versionsBtn"),blockHistoryBtn:document.getElementById("blockHistoryBtn"),articleHistoryBtn:document.getElementById("articleHistoryBtn"),exportAllHtmlZipBtn:document.getElementById("exportAllHtmlZipBtn"),importArticleBtn:document.getElementById("importArticleBtn"),importMarkdownBtn:document.getElementById("importMarkdownBtn"),importLogseqBtn:document.getElementById("importLogseqBtn"),importBackupFolderBtn:document.getElementById("importBackupFolderBtn"),articleUndoBtn:document.getElementById("articleUndoBtn"),articleRedoBtn:document.getElementById("articleRedoBtn"),mergeBlocksBtn:document.getElementById("mergeBlocksBtn"),splitBlockBtn:document.getElementById("splitBlockBtn"),insertTableBtn:document.getElementById("insertTableBtn"),deleteCurrentBlockBtn:document.getElementById("deleteCurrentBlockBtn"),exportCurrentBlockBtn:document.getElementById("exportCurrentBlockBtn"),articleBlockTrashBtn:document.getElementById("articleBlockTrashBtn"),articleNewBlockBtn:document.getElementById("articleNewBlockBtn"),articleToolbar:document.getElementById("articleToolbar"),outlineToolbar:document.getElementById("outlineToolbar"),outlineTagsBar:document.getElementById("outlineTagsBar"),outlineUndoBtn:document.getElementById("outlineUndoBtn"),outlineRedoBtn:document.getElementById("outlineRedoBtn"),outlineDeleteBtn:document.getElementById("outlineDeleteBtn"),outlineMoveUpBtn:document.getElementById("outlineMoveUpBtn"),outlineMoveDownBtn:document.getElementById("outlineMoveDownBtn"),outlineOutdentBtn:document.getElementById("outlineOutdentBtn"),outlineIndentBtn:document.getElementById("outlineIndentBtn"),outlineNewBelowBtn:document.getElementById("outlineNewBelowBtn"),outlineBoldBtn:document.getElementById("outlineBoldBtn"),outlineBulletListBtn:document.getElementById("outlineBulletListBtn"),outlineOrderedListBtn:document.getElementById("outlineOrderedListBtn"),outlineBlockquoteBtn:document.getElementById("outlineBlockquoteBtn"),outlineCodeBtn:document.getElementById("outlineCodeBtn"),outlineInsertTableBtn:document.getElementById("outlineInsertTableBtn"),outlineDeleteTableBtn:document.getElementById("outlineDeleteTableBtn"),outlineAddRowBtn:document.getElementById("outlineAddRowBtn"),outlineAddColBtn:document.getElementById("outlineAddColBtn"),pasteProgress:document.getElementById("pasteProgress"),mobileSidebarBtn:document.getElementById("mobileSidebarBtn"),sidebarBackdrop:document.getElementById("sidebarBackdrop"),dragModeToggleBtn:document.getElementById("dragModeToggleBtn"),listSidebarBtn:document.getElementById("listSidebarBtn"),outlineEditor:document.getElementById("outlineEditor")}});function ja(){uo!==null&&(clearTimeout(uo),uo=null)}function es(e){Zi=!!e,V.toast&&(Zi?V.toast.dataset.protected="true":V.toast.removeAttribute("data-protected"))}function ve(e,t={}){if(!V.toast)return;let n=typeof t.duration=="number"?t.duration:2500;t.protect?es(!0):es(!1),ja(),V.toast.textContent=e,V.toast.classList.remove("hidden"),requestAnimationFrame(()=>{V.toast.classList.add("show")}),n>0&&(uo=setTimeout(()=>{V.toast.classList.remove("show"),setTimeout(()=>V.toast.classList.add("hidden"),200),uo=null},n))}function ts(e,t={}){ve(e,{...t,duration:0})}function Ar(e={}){V.toast&&(Zi&&!e.force||(ja(),es(!1),V.toast.classList.remove("show"),V.toast.classList.add("hidden")))}var uo,Zi,an=et(()=>{Bn();uo=null,Zi=!1;V.toast&&V.toast.addEventListener("click",()=>{Ar()})});function Fe(e){return new Promise((t,n)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error||new Error("IndexedDB request failed"))})}function Hr(e,t,n={}){let r=t instanceof Error?t:new Error(String(t?.message||t||"IndexedDB error"));try{r.idbKind=String(e||"unknown"),r.cause=t,r.extra=n}catch{}return r}function nt(e){return new Promise((t,n)=>{e.oncomplete=()=>t(),e.onabort=()=>n(e.error||new Error("IndexedDB transaction aborted")),e.onerror=()=>n(e.error||new Error("IndexedDB transaction failed"))})}function gu(e){return String(e||"anon").replace(/[^a-zA-Z0-9_-]/g,"_")}function yu(e){return`memus_offline_v1_${gu(e)}`}function Su(e){try{let t=String(e||"").trim();if(!t)return;let n=window?.localStorage?.getItem?.(Ja)||"[]",r=JSON.parse(n),o=Array.isArray(r)?r:[];o.includes(t)||o.push(t),window.localStorage.setItem(Ja,JSON.stringify(o.slice(-200)))}catch{}}async function Wa({userKey:e}={}){let t=e||"anon";Su(t);let n=yu(t);if(typeof indexedDB>"u"){let a=new Error("IndexedDB is not available in this browser");throw a.name="IDBNotSupportedError",Hr("no_idb",a,{name:n})}let r=indexedDB.open(n,bu),o=3e3,i=!1;r.onblocked=()=>{i=!0},r.onupgradeneeded=()=>{let a=r.result;if(a.objectStoreNames.contains("meta")||a.createObjectStore("meta",{keyPath:"key"}),!a.objectStoreNames.contains("articles")){let c=a.createObjectStore("articles",{keyPath:"id"});c.createIndex("byUpdatedAt","updatedAt",{unique:!1}),c.createIndex("byDeletedAt","deletedAt",{unique:!1})}if(!a.objectStoreNames.contains("outline_sections")){let c=a.createObjectStore("outline_sections",{keyPath:"sectionId"});c.createIndex("byArticleId","articleId",{unique:!1}),c.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!a.objectStoreNames.contains("section_embeddings")){let c=a.createObjectStore("section_embeddings",{keyPath:"sectionId"});c.createIndex("byArticleId","articleId",{unique:!1}),c.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!a.objectStoreNames.contains("media_assets")){let c=a.createObjectStore("media_assets",{keyPath:"url"});c.createIndex("byStatus","status",{unique:!1}),c.createIndex("byFetchedAtMs","fetchedAtMs",{unique:!1}),c.createIndex("byStatusFetchedAtMs",["status","fetchedAtMs"],{unique:!1})}if(!a.objectStoreNames.contains("media_refs")){let c=a.createObjectStore("media_refs",{keyPath:"key"});c.createIndex("byArticleId","articleId",{unique:!1}),c.createIndex("byUrl","url",{unique:!1})}if(a.objectStoreNames.contains("outbox")){let c=r.transaction;try{let l=c.objectStore("outbox");l.indexNames.contains("byTypeCoalesceKey")||l.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}catch{}}else{let c=a.createObjectStore("outbox",{keyPath:"id"});c.createIndex("byCreatedAtMs","createdAtMs",{unique:!1}),c.createIndex("byTypeArticleId",["type","articleId"],{unique:!1}),c.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}if(!a.objectStoreNames.contains("pending_uploads")){let c=a.createObjectStore("pending_uploads",{keyPath:"token"});c.createIndex("byArticleId","articleId",{unique:!1}),c.createIndex("byCreatedAtMs","createdAtMs",{unique:!1})}if(!a.objectStoreNames.contains("tags_global")){let c=a.createObjectStore("tags_global",{keyPath:"key"});c.createIndex("byCount","count",{unique:!1}),c.createIndex("byLastSeenAtMs","lastSeenAtMs",{unique:!1})}a.objectStoreNames.contains("tags_by_article")||a.createObjectStore("tags_by_article",{keyPath:"articleId"}).createIndex("byUpdatedAt","updatedAt",{unique:!1})};let s=await Promise.race([Fe(r),new Promise((a,c)=>{setTimeout(()=>{let l=new Error(i?"IndexedDB upgrade is blocked by another tab":"IndexedDB open timeout");l.name=i?"IDBBlockedError":"IDBTimeoutError",c(Hr(i?"blocked":"timeout",l,{name:n}))},o)})]).catch(a=>{let c=String(a?.name||"");throw c==="IDBBlockedError"||c==="IDBTimeoutError"?a:c==="SecurityError"?Hr("security",a,{name:n}):c==="InvalidStateError"?Hr("invalid_state",a,{name:n}):c==="QuotaExceededError"?Hr("quota",a,{name:n}):Hr("unknown",a,{name:n})});try{s.onversionchange=()=>{try{s.close()}catch{}}}catch{}return s}async function Ya(e){let t=e.transaction(["meta"],"readonly"),n=t.objectStore("meta");await Fe(n.get("ping")),await nt(t)}var bu,Ja,Ln=et(()=>{bu=4,Ja="ttree_offline_known_user_keys_v1"});async function Ko({userKey:e}={}){let t=String(e||"").trim();if(!t||t==="anon")try{let n=window?.localStorage?.getItem?.("ttree_offline_user_key_v1")||"",r=String(n||"").trim();r&&(t=r)}catch{}if(!t||t==="anon")try{let n=window?.localStorage?.getItem?.("ttree_last_user_v1")||"",r=n?JSON.parse(n):null,o=String(r?.id||r?.username||"").trim();o&&(t=o)}catch{}return t||(t="anon"),qo&&Ga===t||(Ga=t,qo=(async()=>await Wa({userKey:t}))()),qo}var qo,Ga,ns=et(()=>{Ln();qo=null,Ga=null});function jo(){try{return window?.localStorage?.getItem?.(wu)==="1"}catch{return!1}}function ec(){try{return window?.localStorage?.getItem?.(xu)==="1"}catch{return!1}}function rs(e,t={}){try{if(!jo())return;console.log("[perf][offline]",e,t)}catch{}}function Au(){try{let e=window.__BUILD_ID__;return e?String(e):""}catch{return""}}function os(e,t){try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:e,data:t})}).catch(()=>{})}catch{}}async function is(){let e={};try{e.ua=navigator?.userAgent||""}catch{e.ua=""}try{e.buildId=Au()}catch{e.buildId=""}try{e.onLine=navigator?.onLine!==!1}catch{e.onLine=null}try{e.indexedDB=typeof indexedDB<"u"}catch{e.indexedDB=null}try{e.storagePersist=typeof navigator?.storage?.persist=="function"}catch{e.storagePersist=null}try{e.storageEstimate=typeof navigator?.storage?.estimate=="function"}catch{e.storageEstimate=null}try{if(navigator?.storage?.estimate){let t=await navigator.storage.estimate().catch(()=>null);t&&typeof t=="object"&&(e.quota=Number(t.quota||0)||null,e.usage=Number(t.usage||0)||null)}}catch{}return e}function ku(e){try{let t=window?.localStorage?.getItem?.("ttree_offline_user_key_v1")||"",n=String(t||"").trim();if(n)return n}catch{}return e&&(e.id||e.username)||"anon"}function Iu(e){let t=String(e?.idbKind||"").trim(),n=String(e?.name||"").trim(),r=String(e?.message||"").trim();return t==="no_idb"||n==="IDBNotSupportedError"?{status:"unavailable",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0432 \u044D\u0442\u043E\u043C \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435 (\u043D\u0435\u0442 IndexedDB). \u041E\u0444\u0444\u043B\u0430\u0439\u043D \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u0435\u0442."}:t==="security"||n==="SecurityError"?{status:"unavailable",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u0430 \u043D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0430\u043C\u0438 \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0430/\u043F\u0440\u0438\u0432\u0430\u0442\u043D\u044B\u043C \u0440\u0435\u0436\u0438\u043C\u043E\u043C. \u041E\u0444\u0444\u043B\u0430\u0439\u043D \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u0435\u0442."}:t==="blocked"||n==="IDBBlockedError"?{status:"blocked",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u0437\u0430\u043D\u044F\u0442\u0430 \u0434\u0440\u0443\u0433\u043E\u0439 \u0432\u043A\u043B\u0430\u0434\u043A\u043E\u0439 Memus. \u0417\u0430\u043A\u0440\u043E\u0439\u0442\u0435 \u0434\u0440\u0443\u0433\u0438\u0435 \u0432\u043A\u043B\u0430\u0434\u043A\u0438 \u0438 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443."}:t==="timeout"||n==="IDBTimeoutError"?{status:"timeout",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435 \u043E\u0442\u0432\u0435\u0447\u0430\u0435\u0442 (\u0432\u043A\u043B\u0430\u0434\u043A\u0430 \u043C\u043E\u0433\u043B\u0430 \u201C\u0443\u0441\u043D\u0443\u0442\u044C\u201D). \u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443."}:t==="quota"||n==="QuotaExceededError"?{status:"quota",message:"\u041D\u0435\u0434\u043E\u0441\u0442\u0430\u0442\u043E\u0447\u043D\u043E \u043C\u0435\u0441\u0442\u0430 \u0434\u043B\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u043A\u044D\u0448\u0430. \u041E\u0447\u0438\u0441\u0442\u0438\u0442\u0435 \u043A\u044D\u0448 \u043A\u0430\u0440\u0442\u0438\u043D\u043E\u043A \u0438\u043B\u0438 \u043E\u0441\u0432\u043E\u0431\u043E\u0434\u0438\u0442\u0435 \u043C\u0435\u0441\u0442\u043E \u0432 \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435."}:t==="invalid_state"||n==="InvalidStateError"?{status:"error",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043F\u043E\u0432\u0440\u0435\u0436\u0434\u0435\u043D\u0430 \u0438\u043B\u0438 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430. \u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438\u043B\u0438 \u0441\u0431\u0440\u043E\u0441\u0438\u0442\u044C \u043E\u0444\u0444\u043B\u0430\u0439\u043D\u2011\u043A\u044D\u0448."}:r?{status:"error",message:`\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430: ${r}`}:{status:"error",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430."}}async function Eu(e){let t=ku(e);if($r&&Xa===t)return $r;Xa=t,Qa+=1;let n=Qa;return $r=(async()=>{let r=jo()?performance.now():0;u.offlineReady=!1,u.offlineInitStatus="initializing",u.offlineInitError="",u.offlineInitStartedAt=Date.now();try{if(Za!==n){Za=n;let o=await is().catch(()=>({}));os("offline.init.start",{t:new Date().toISOString(),attempt:n,userKey:t,env:o})}}catch{}try{ec()&&console.log("[offline] init start",{userKey:t})}catch{}try{let o=jo()?performance.now():0,i=await Ko({userKey:t});o&&rs("getOfflineDb()",{ms:Math.round(performance.now()-o)});let s=jo()?performance.now():0;await Ya(i),s&&rs("idb.ping",{ms:Math.round(performance.now()-s)});try{navigator?.storage?.persist&&navigator.storage.persist().catch(()=>{})}catch{}u.offlineReady=!0,u.offlineInitStatus="ready",u.offlineInitError="",u.offlineInitStartedAt=null;try{if(Vo!==n){Vo=n;let a=await is().catch(()=>({}));os("offline.init.ready",{t:new Date().toISOString(),attempt:n,userKey:t,env:a})}}catch{}try{ec()&&console.log("[offline] init ready")}catch{}return r&&rs("initOfflineForUser.total",{userKey:t,ms:Math.round(performance.now()-r)}),i}catch(o){u.offlineReady=!1;let i=Iu(o);u.offlineInitStatus=i.status||"error",u.offlineInitStartedAt=null;try{console.error("[offline] init failed",o)}catch{}let s=i.message;u.offlineInitError=s,ve(s);try{if(Vo!==n){Vo=n;let a=await is().catch(()=>({}));os("offline.init.failed",{t:new Date().toISOString(),attempt:n,userKey:t,msg:s,err:{name:String(o?.name||""),message:String(o?.message||""),stack:String(o?.stack||"").slice(0,1500)},env:a})}}catch{}throw o}})(),$r}async function xt(){return $r||Eu(u.currentUser)}var $r,Xa,Qa,Za,Vo,wu,xu,ir=et(()=>{Ht();an();ns();Ln();$r=null,Xa=null,Qa=0,Za=null,Vo=null,wu="ttree_profile_v1",xu="ttree_debug_offline_v1"});function ss(e){if(!e)return"";if(e.type==="text")return String(e.text||"");let t=Array.isArray(e.content)?e.content:[];if(!t.length)return"";let n=[];for(let r of t){let o=ss(r);o&&n.push(o),r&&(r.type==="paragraph"||r.type==="hardBreak"||r.type==="heading")&&n.push(`
`)}return n.join("")}function tc(e){return String(e||"").replace(/\r\n/g,`
`).replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}function nc(e,t=[]){for(let n of e||[]){if(!n||n.type!=="outlineSection")continue;let r=String(n.attrs?.id||""),o=n.content?.[0],i=n.content?.[1],s=n.content?.[2],a=tc(ss(o))||"",c=tc(ss(i))||"",l=`${a}
${c}`.trim();r&&t.push({sectionId:r,title:a,text:l});let d=s?.content||[];nc(d,t)}return t}function Cu(e){let t=Array.isArray(e?.content)?e.content:[];return nc(t,[])}function vu(e){return String(e||"").trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9а-яё_-]/gi,"")}function rc(e,t){for(let n of e||[]){if(!n)continue;if(n.type==="tag"){let o=n.attrs?.key||n.attrs?.label||"",i=vu(o);i&&t.add(i)}let r=Array.isArray(n.content)?n.content:[];r.length&&rc(r,t)}}function Tu(e){let t=new Set,n=Array.isArray(e?.content)?e.content:[];return rc(n,t),Array.from(t)}async function Jo(e,{articleId:t,docJson:n,updatedAt:r}){if(!e||!t||!n||typeof n!="object")return;let o=String(t),i=Tu(n),s=Date.now(),a=e.transaction(["tags_by_article","tags_global"],"readwrite"),c=a.objectStore("tags_by_article"),l=a.objectStore("tags_global"),d=await Fe(c.get(o)).catch(()=>null),m=new Set(Array.isArray(d?.tags)?d.tags.map(f=>String(f||"").trim()).filter(Boolean):[]),h=new Set(i),b=[],w=[];for(let f of m)h.has(f)||b.push(f);for(let f of h)m.has(f)||w.push(f);for(let f of b){let p=await Fe(l.get(f)).catch(()=>null),y=Math.max(0,(Number(p?.count||0)||0)-1);y<=0?await Fe(l.delete(f)).catch(()=>{}):await Fe(l.put({...p||{},key:f,label:String(p?.label||f),count:y,lastSeenAtMs:Number(p?.lastSeenAtMs||0)||0})).catch(()=>{})}for(let f of h){let p=await Fe(l.get(f)).catch(()=>null),y=(Number(p?.count||0)||0)+(w.includes(f)?1:0);await Fe(l.put({...p||{},key:f,label:String(p?.label||f),count:Math.max(1,y),lastSeenAtMs:s})).catch(()=>{})}await Fe(c.put({articleId:o,tags:i,updatedAt:r||null,indexedAtMs:s})),await nt(a)}async function Wo(e,{articleId:t,docJson:n,updatedAt:r}){if(!e||!t||!n||typeof n!="object")return;let o=Cu(n),i=e.transaction(["outline_sections"],"readwrite"),s=i.objectStore("outline_sections"),a=s.index("byArticleId"),c=IDBKeyRange.only(String(t)),l=await Fe(a.openCursor(c));for(;l;)l.delete(),l=await Fe(l.continue());for(let d of o)await Fe(s.put({sectionId:d.sectionId,articleId:String(t),title:d.title||"",text:d.text||"",updatedAt:r||null}));await nt(i)}var oc=et(()=>{Ln()});function Nu(){try{return localStorage.getItem(Bu)==="1"}catch{return!1}}function Mu(e){let t=String(e||"").trim();if(!t)return null;try{let n=new URL(t,window.location.origin);return n.origin!==window.location.origin?/^https?:\/\/memus\.pro\b/i.test(t)&&n.pathname.startsWith("/uploads/")?n.pathname+(n.search||""):null:n.pathname.startsWith("/uploads/")?n.pathname+(n.search||""):null}catch{return t.startsWith("/uploads/")?t:null}}function Lu(e){let t=new Set,n=r=>{if(!r)return;if(Array.isArray(r)){r.forEach(n);return}if(r.type==="image"){let i=Mu(r.attrs?.src);i&&t.add(i)}(Array.isArray(r.content)?r.content:[]).forEach(n)};return n(e?.content||[]),Array.from(t)}async function Fr(e,t){let n=await xt(),r=Lu(t),o=n.transaction(["media_refs","media_assets"],"readwrite"),i=o.objectStore("media_refs"),s=o.objectStore("media_assets"),a=i.index("byArticleId"),c=IDBKeyRange.only(String(e)),l=await Fe(a.openCursor(c)).catch(()=>null);for(;l;)l.delete(),l=await Fe(l.continue()).catch(()=>null);for(let d of r){let m=`${String(e)}|${String(d)}`;await Fe(i.put({key:m,articleId:String(e),url:String(d)})),await Fe(s.get(d)).catch(()=>null)||await Fe(s.put({url:String(d),status:"needed",fetchedAtMs:0,failCount:0,lastError:null}))}await nt(o)}async function ic(e,t){let n=e.transaction(["media_assets"],"readwrite"),r=n.objectStore("media_assets"),o=await Fe(r.get(t)).catch(()=>null);await Fe(r.put({...o||{},url:String(t),status:"ok",fetchedAtMs:Date.now(),failCount:0,lastError:null})),await nt(n)}async function Pu(e,t,n){let r=String(n?.message||n||"error"),o=e.transaction(["media_assets"],"readwrite"),i=o.objectStore("media_assets"),s=await Fe(i.get(t)).catch(()=>null),a=Number(s?.failCount||0)+1;await Fe(i.put({...s||{},url:String(t),status:"error",fetchedAtMs:Date.now(),failCount:a,lastError:r})),await nt(o)}async function _u(e,t){let n=e.transaction(["media_assets"],"readonly"),o=n.objectStore("media_assets").index("byFetchedAtMs"),i=[],s=await Fe(o.openCursor()).catch(()=>null);for(;s;){let a=s.value,c=String(a?.status||""),l=Number(a?.failCount||0);if(c!=="ok"&&l<5){let d=String(a?.url||"");if(d&&i.push(d),i.length>=t)break}s=await Fe(s.continue()).catch(()=>null)}return await nt(n),i}async function Du(e,t){try{return!!await e.match(t,{ignoreSearch:!1})}catch{return!1}}async function Ou(e,t){let n=await fetch(t,{credentials:"include"});if(!n||!n.ok)throw new Error(`HTTP ${n?.status||0}`);await e.put(t,n.clone())}function Ru(){try{let e=navigator.connection||navigator.mozConnection||navigator.webkitConnection,t=String(e?.effectiveType||"");if(!!e?.saveData||t.includes("2g"))return 1;if(t.includes("3g"))return 2}catch{}return 3}function cc(){if(sc)return;sc=!0;let e=async()=>{if(!navigator.onLine||Nu())return;let t=Ru();if(Yo>=t)return;let n=await xt(),r=await caches.open(ac),o=await _u(n,Math.max(5,t*3));if(o.length)for(let i of o){if(Yo>=t)break;Yo+=1,(async()=>{try{if(await Du(r,i)){await ic(n,i);return}await Ou(r,i),await ic(n,i)}catch(s){await Pu(n,i,s)}finally{Yo-=1}})()}};setInterval(()=>{e().catch(()=>{})},1200),window.addEventListener("online",()=>{e().catch(()=>{})})}async function lc(){let e=await xt(),t=await caches.open(ac),n=e.transaction(["media_assets","media_refs"],"readwrite"),r=n.objectStore("media_assets"),i=n.objectStore("media_refs").index("byUrl"),s=[],a=await Fe(r.openCursor()).catch(()=>null);for(;a&&s.length<500;){let c=String(a.value?.url||"");c&&(await Fe(i.count(IDBKeyRange.only(c))).catch(()=>0)||(s.push(c),a.delete())),a=await Fe(a.continue()).catch(()=>null)}if(await nt(n),!s.length)return 0;for(let c of s)try{await t.delete(c)}catch{}return s.length}var ac,Bu,sc,Yo,as=et(()=>{ir();Ln();ac="memus-uploads-v1",Bu="ttree_media_prefetch_paused_v1";sc=!1,Yo=0});function cs(){try{window.dispatchEvent(new CustomEvent("offline-outbox-changed"))}catch{}}function Hu(){return globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?globalThis.crypto.randomUUID():`id-${Date.now()}-${Math.random().toString(16).slice(2)}`}function dc(){return new Date().toISOString()}async function cn(e,{articleId:t,payload:n,coalesceKey:r}={}){let o=await xt(),i=Hu(),s=dc(),a=n?JSON.stringify(n):"{}",c=o.transaction(["outbox"],"readwrite"),l=c.objectStore("outbox"),d=l.index("byTypeArticleId"),m=l.index("byTypeCoalesceKey");if(r){let h=[String(e||""),String(r||"")],b=await Fe(m.openCursor(IDBKeyRange.only(h))).catch(()=>null);for(;b;)b.delete(),b=await Fe(b.continue()).catch(()=>null)}else if(t){let h=[String(e||""),t||null],b=await Fe(d.openCursor(IDBKeyRange.only(h))).catch(()=>null);for(;b;)b.delete(),b=await Fe(b.continue()).catch(()=>null)}return await Fe(l.put({id:i,createdAt:s,createdAtMs:Date.now(),type:String(e||""),articleId:t||null,coalesceKey:r?String(r):null,payloadJson:a,attempts:0,lastError:null,lastAttemptAt:null})),await nt(c),cs(),i}async function kr(e=50){let n=(await xt()).transaction(["outbox"],"readonly"),o=n.objectStore("outbox").index("byCreatedAtMs"),i=[],s=await Fe(o.openCursor()).catch(()=>null);for(;s&&(i.push(s.value),!(i.length>=e));)s=await Fe(s.continue()).catch(()=>null);return await nt(n),i.map(a=>{let c={};try{c=JSON.parse(a?.payloadJson||"{}")}catch{c={}}return{id:a.id,createdAt:a.createdAt,type:a.type,articleId:a.articleId,payload:c,attempts:a.attempts||0}})}async function $u(e=[],t=null){let n=String(t||"").trim(),r=Array.isArray(e)?e.map(c=>String(c||"").trim()).filter(Boolean):[];if(!n||!r.length)return!1;let i=(await xt()).transaction(["outbox"],"readonly"),a=i.objectStore("outbox").index("byTypeArticleId");for(let c of r)try{let l=[String(c),n];if(await Fe(a.openCursor(IDBKeyRange.only(l))).catch(()=>null))return await nt(i),!0}catch{}return await nt(i),!1}async function uc(e){return $u(["delete_sections","section_upsert_content","structure_snapshot","save_doc_json"],e)}async function fc(e,t){let r=(await xt()).transaction(["outbox"],"readwrite"),o=r.objectStore("outbox"),i=await Fe(o.get(e)).catch(()=>null);i&&await Fe(o.put({...i,attempts:Number(i.attempts||0)+1,lastError:String(t||"error"),lastAttemptAt:dc()})),await nt(r),cs()}async function sr(e){let n=(await xt()).transaction(["outbox"],"readwrite"),r=n.objectStore("outbox");await Fe(r.delete(e)),await nt(n),cs()}var zr=et(()=>{ir();Ln()});function mc(e){fo.counts=new Map,fo.labelByKey=new Map;for(let t of e||[]){let n=String(t?.key||"").trim();if(!n)continue;let r=Number(t?.count||0)||0,o=String(t?.label||n);fo.counts.set(n,r),fo.labelByKey.set(n,o)}pc=!0}async function hc(e){let t=e.transaction(["tags_global"],"readonly"),n=t.objectStore("tags_global"),r=await Fe(n.getAll()).catch(()=>[]);return await nt(t),Array.isArray(r)?r:[]}function gc(){return fo}function yc(){pc||ls||(ls=(async()=>{try{let e=await xt(),t=await hc(e);mc(t)}catch{}finally{ls=null}})())}function Go(){ds||(ds=setTimeout(()=>{ds=null,Fu().catch(()=>{})},800))}async function Fu(){try{let e=await xt(),t=await hc(e);mc(t)}catch{}}var pc,ls,ds,fo,us=et(()=>{ir();Ln();pc=!1,ls=null,ds=null,fo={counts:new Map,labelByKey:new Map}});function Ku(e=null){try{if(window?.localStorage?.getItem?.(zu)!=="1")return!1;let t=String(window?.localStorage?.getItem?.(Uu)||"").trim();if(!t)return!0;let n=String(e||"").trim();return n?n===t:!0}catch{return!1}}function Vu(){try{return window?.localStorage?.getItem?.(qu)==="1"}catch{return!1}}function ju(e){try{return JSON.stringify(e)}catch{return'"[unserializable]"'}}function Ju(e){try{let t=String(e||""),n=2166136261;for(let r=0;r<t.length;r+=1)n^=t.charCodeAt(r),n=Math.imul(n,16777619);return(n>>>0).toString(16)}catch{return"0"}}function Ut(e){try{return!e||typeof e!="object"?null:Ju(ju(e))}catch{return null}}function gt(e,t={}){try{let n=t?.articleId?String(t.articleId):null;if(!Ku(n))return!1;let r={t:new Date().toISOString(),kind:String(e||"event"),data:t&&typeof t=="object"?t:{value:t}},o=[];try{let i=window?.localStorage?.getItem?.(Xo)||"";o=i?JSON.parse(i):[],Array.isArray(o)||(o=[])}catch{o=[]}o.push(r),o.length>250&&(o=o.slice(o.length-250));try{window?.localStorage?.setItem?.(Xo,JSON.stringify(o))}catch{}if(Vu()&&navigator.onLine!==!1)try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:`revert:${r.kind}`,data:r})}).catch(()=>{})}catch{}return!0}catch{return!1}}function Wu(){try{let e=window?.localStorage?.getItem?.(Xo)||"",t=e?JSON.parse(e):[];return Array.isArray(t)?t:[]}catch{return[]}}function Yu(){try{window?.localStorage?.removeItem?.(Xo)}catch{}}var zu,Uu,qu,Xo,po=et(()=>{zu="ttree_debug_revert_v1",Uu="ttree_debug_revert_article_v1",qu="ttree_client_log_v1",Xo="ttree_revert_log_v1";try{window.memusRevertLogDump=()=>Wu(),window.memusRevertLogClear=()=>Yu()}catch{}});function Gu(e){return{id:e.id,title:e.title,updatedAt:e.updatedAt,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:!!e.encrypted}}async function Jn(e){let t=await xt(),n=Array.isArray(e)?e:[],r=50;for(let o=0;o<n.length;o+=r){let i=n.slice(o,o+r),s=t.transaction(["articles"],"readwrite"),a=s.objectStore("articles");for(let c of i){let l=Gu(c),m={...await Fe(a.get(l.id)).catch(()=>null)||{},id:l.id,title:l.title||"",updatedAt:l.updatedAt||null,parentId:l.parentId??null,position:typeof l.position=="number"?l.position:0,publicSlug:l.publicSlug??null,encrypted:l.encrypted?1:0,deletedAt:null};await Fe(a.put(m))}await nt(s),await new Promise(c=>setTimeout(c,0))}}async function Ur(){let t=(await xt()).transaction(["articles"],"readonly"),n=t.objectStore("articles"),r=1200,o=null,i=await Promise.race([Fe(n.getAll()),new Promise((s,a)=>{o=setTimeout(()=>{try{t.abort()}catch{}let c=new Error("IndexedDB read timeout (articles index)");c.name="IDBTimeoutError";try{c.idbKind="timeout"}catch{}a(c)},r)})]).catch(s=>{try{String(s?.name||"")==="QuotaExceededError"&&(s.idbKind="quota")}catch{}throw s});return o&&clearTimeout(o),await nt(t),i.filter(s=>s&&!s.deletedAt).sort((s,a)=>Number(s.position||0)-Number(a.position||0)).map(s=>({id:s.id,title:s.title||"",updatedAt:s.updatedAt||null,parentId:s.parentId??null,position:typeof s.position=="number"?s.position:0,publicSlug:s.publicSlug??null,encrypted:!!s.encrypted}))}async function bc(){let t=(await xt()).transaction(["articles"],"readonly"),n=t.objectStore("articles"),r=await Fe(n.getAll()).catch(()=>[])||[];return await nt(t),r.filter(o=>o&&!o.deletedAt).map(o=>({id:o.id,updatedAt:o.updatedAt||null,hasDocJson:!!o.docJsonStr}))}async function qr(e){if(!e||!e.id)return;let t=await xt(),n=e.docJson&&typeof e.docJson=="object"?e.docJson:null,r=e.updatedAt||null,o=t.transaction(["articles"],"readwrite"),i=o.objectStore("articles"),s=await Fe(i.get(e.id)).catch(()=>null),a=null;try{a=s?.articleJsonStr?JSON.parse(s.articleJsonStr):null}catch{a=null}let c=!!(a&&a.localDraft),l=e&&Object.prototype.hasOwnProperty.call(e,"outlineStructureRev")?Number(e.outlineStructureRev):null;try{let m=String(s?.updatedAt||"").trim(),h=String(r||"").trim();if(m&&h&&h<m){gt("cache.article.put.skip_older",{articleId:e.id,existingUpdatedAt:m,incomingUpdatedAt:h,incomingDocHash:Ut(n)}),await nt(o);return}if(c&&m&&h&&m===h){let b=!1;try{b=await uc(e.id)}catch{b=!1}if(b){let w=Ut(s?.docJsonStr?JSON.parse(s.docJsonStr):null),f=Ut(n);if(w&&f&&w!==f){let p=a&&typeof a=="object"?{...a}:{};p.id=e.id,p.title=e.title||p.title||"",p.updatedAt=m,p.parentId=e.parentId??p.parentId??null,p.position=typeof e.position=="number"?e.position:p.position??0,p.publicSlug=e.publicSlug??p.publicSlug??null,p.encrypted=!!e.encrypted,Object.prototype.hasOwnProperty.call(e,"outlineStructureRev")&&(p.outlineStructureRev=Number(e.outlineStructureRev)||0),p.localDraft=!0;let y={...s||{},id:e.id,title:e.title||"",updatedAt:m,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:e.encrypted?1:0,deletedAt:null,outlineStructureRev:Number.isFinite(l)?l:Number(s?.outlineStructureRev),docJsonStr:s?.docJsonStr??null,articleJsonStr:JSON.stringify(p)};await Fe(i.put(y)),await nt(o);try{gt("cache.article.put.skip_localDraft",{articleId:e.id,updatedAt:m,existingDocHash:w,incomingDocHash:f})}catch{}return}}else try{gt("cache.article.put.clear_stale_localDraft",{articleId:e.id,updatedAt:m})}catch{}}}catch{}let d={...s||{},id:e.id,title:e.title||"",updatedAt:r,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:e.encrypted?1:0,deletedAt:null,outlineStructureRev:Number.isFinite(l)?l:Number(s?.outlineStructureRev),docJsonStr:n?JSON.stringify(n):null,articleJsonStr:JSON.stringify(e)};await Fe(i.put(d)),await nt(o);try{gt("cache.article.put",{articleId:e.id,updatedAt:r,hasDocJson:!!n,docHash:Ut(n)})}catch{}n&&(Wo(t,{articleId:e.id,docJson:n,updatedAt:r}).catch(()=>{}),Jo(t,{articleId:e.id,docJson:n,updatedAt:r}).then(Go).catch(()=>{}),Fr(e.id,n).catch(()=>{}))}async function Sc(e,t){if(!e||!t)return;let n=await xt(),r=String(t),o=e.docJson&&typeof e.docJson=="object"?e.docJson:null,i=e.updatedAt||null,s=n.transaction(["articles"],"readwrite"),a=s.objectStore("articles"),c=await Fe(a.get(r)).catch(()=>null);try{let d=String(c?.updatedAt||"").trim(),m=String(i||"").trim();if(d&&m&&m<d){gt("cache.articleUnderId.put.skip_older",{articleId:r,existingUpdatedAt:d,incomingUpdatedAt:m,incomingDocHash:Ut(o)}),await nt(s);return}}catch{}let l={...c||{},id:r,title:e.title||c?.title||"",updatedAt:i||c?.updatedAt||null,parentId:e.parentId??c?.parentId??null,position:typeof e.position=="number"?e.position:c?.position||0,publicSlug:e.publicSlug??c?.publicSlug??null,encrypted:e.encrypted||c?.encrypted?1:0,deletedAt:null,docJsonStr:o?JSON.stringify(o):c?.docJsonStr??null,articleJsonStr:JSON.stringify(e)};await Fe(a.put(l)),await nt(s),o&&(Wo(n,{articleId:r,docJson:o,updatedAt:i}).catch(()=>{}),Jo(n,{articleId:r,docJson:o,updatedAt:i}).then(Go).catch(()=>{}),Fr(r,o).catch(()=>{}))}async function Zn(e){if(!e)return null;let n=(await xt()).transaction(["articles"],"readonly"),r=n.objectStore("articles"),o=await Fe(r.get(e)).catch(()=>null);if(await nt(n),!o)return null;try{let i=JSON.parse(o.articleJsonStr||"null");return i&&!i.docJson&&o.docJsonStr&&(i.docJson=JSON.parse(o.docJsonStr)),i}catch{try{let i=o.docJsonStr?JSON.parse(o.docJsonStr):null,s={id:e,title:o.title||"",createdAt:o.createdAt||o.updatedAt||null,updatedAt:o.updatedAt||null,deletedAt:o.deletedAt||null,parentId:o.parentId??null,position:typeof o.position=="number"?o.position:0,authorId:null,publicSlug:o.publicSlug??null,encrypted:!!o.encrypted,outlineStructureRev:Number.isFinite(Number(o.outlineStructureRev))?Number(o.outlineStructureRev):void 0,docJson:i&&typeof i=="object"?i:null,history:[],redoHistory:[],blockTrash:[]};try{gt("cache.article.get.fallback_docJsonStr",{articleId:e,updatedAt:s.updatedAt||null,docHash:Ut(s.docJson)})}catch{}return s}catch{return null}}}async function xn(e,t,n){if(!e)return;let r=await xt(),o=r.transaction(["articles"],"readwrite"),i=o.objectStore("articles"),s=await Fe(i.get(e)).catch(()=>null),a=n||s&&s.updatedAt||null,c=()=>{let m=String(e)==="inbox"?"\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438":"",h=(s&&typeof s.title=="string"?s.title:"")||m,b=a,w={id:e,title:h,createdAt:s&&s.createdAt||b||null,updatedAt:b,deletedAt:s&&s.deletedAt||null,parentId:(s&&s.parentId)??null,position:typeof(s&&s.position)=="number"?s.position:0,authorId:null,publicSlug:(s&&s.publicSlug)??null,encrypted:!!(s&&s.encrypted),docJson:null,history:[],blocks:[]};return JSON.stringify(w)},l=()=>{let m=s&&s.articleJsonStr||"",h=null;try{h=m?JSON.parse(m):null}catch{h=null}if(!h||typeof h!="object")try{h=JSON.parse(c())}catch{h={id:e}}return h.id=e,h.updatedAt=a||h.updatedAt||null,h.docJson=t&&typeof t=="object"?t:null,t&&typeof t=="object"&&(h.localDraft=!0),!h.title&&s?.title&&(h.title=s.title),h.deletedAt===void 0&&(h.deletedAt=null),h.parentId===void 0&&(h.parentId=s?.parentId??null),h.position===void 0&&(h.position=typeof s?.position=="number"?s.position:0),h.publicSlug===void 0&&(h.publicSlug=s?.publicSlug??null),h.encrypted===void 0&&(h.encrypted=!!s?.encrypted),h.history===void 0&&(h.history=[]),h.blocks===void 0&&(h.blocks=[]),JSON.stringify(h)},d={...s||{id:e},id:e,outlineStructureRev:s?.outlineStructureRev,docJsonStr:t?JSON.stringify(t):null,updatedAt:a,articleJsonStr:l()};await Fe(i.put(d)),await nt(o);try{gt("cache.docJson.put",{articleId:e,updatedAt:a,docHash:Ut(t)})}catch{}t&&typeof t=="object"&&(Wo(r,{articleId:e,docJson:t,updatedAt:n}).catch(()=>{}),Jo(r,{articleId:e,docJson:t,updatedAt:n}).then(Go).catch(()=>{}),Fr(e,t).catch(()=>{}))}async function Qo(e,t){let n=String(e||"").trim();if(!n)return;let r=String(t||new Date().toISOString()).trim(),i=(await xt()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),a=await Fe(s.get(n)).catch(()=>null);if(!a){await nt(i);return}let c=null;try{c=a.articleJsonStr?JSON.parse(a.articleJsonStr):null}catch{c=null}(!c||typeof c!="object")&&(c={id:n}),c.id=n,c.deletedAt=r;let l={...a,deletedAt:r,articleJsonStr:JSON.stringify(c)};await Fe(s.put(l)),await nt(i)}async function wc(e){let t=String(e||"").trim();if(!t)return;let r=(await xt()).transaction(["articles"],"readwrite"),o=r.objectStore("articles"),i=await Fe(o.get(t)).catch(()=>null);if(!i){await nt(r);return}let s=null;try{s=i.articleJsonStr?JSON.parse(i.articleJsonStr):null}catch{s=null}(!s||typeof s!="object")&&(s={id:t}),s.id=t,delete s.localDraft;let a={...i,articleJsonStr:JSON.stringify(s)};await Fe(o.put(a)),await nt(r)}async function xc(e){let t=await xt(),n=Array.isArray(e)?e:[];if(!n.length)return;let r=t.transaction(["articles"],"readwrite"),o=r.objectStore("articles");for(let i of n){if(!i||!i.id)continue;let s=await Fe(o.get(i.id)).catch(()=>null);if(!s)continue;let a={...s,parentId:i.parentId??null,position:typeof i.position=="number"?i.position:0};await Fe(o.put(a))}await nt(r)}async function fs(e,t){let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return;let i=(await xt()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),a=await Fe(s.get(n)).catch(()=>null);if(!a){await nt(i);return}let c=null;try{c=a.articleJsonStr?JSON.parse(a.articleJsonStr):null}catch{c=null}(!c||typeof c!="object")&&(c={id:n}),c.id=n,c.updatedAt=r;let l={...a,updatedAt:r,articleJsonStr:JSON.stringify(c)};await Fe(s.put(l)),await nt(i)}async function ps(e,t){let n=String(e||"").trim();if(!n)return;let r=Number(t);if(!Number.isFinite(r)||r<0)return;let i=(await xt()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),a=await Fe(s.get(n)).catch(()=>null);if(!a){await nt(i);return}let c=null;try{c=a.articleJsonStr?JSON.parse(a.articleJsonStr):null}catch{c=null}(!c||typeof c!="object")&&(c={id:n}),c.id=n,c.outlineStructureRev=r;let l={...a,outlineStructureRev:r,articleJsonStr:JSON.stringify(c)};await Fe(s.put(l)),await nt(i)}var Kr=et(()=>{ir();Ln();oc();as();zr();us();po()});function Zu(e){let t=Array.isArray(e)?e:[],n=new Float32Array(t.length),r=0;for(let o=0;o<t.length;o+=1){let i=Number(t[o]||0);n[o]=i,r+=i*i}if(r>0){let o=1/Math.sqrt(r);for(let i=0;i<n.length;i+=1)n[i]*=o}return n}function Ac(){Xu=null,Qu=0}async function ms(e,t){if(!e)return;let n=await xt(),r=Array.isArray(t)?t:[],o=n.transaction(["section_embeddings"],"readwrite"),i=o.objectStore("section_embeddings");for(let s of r){let a=String(s?.blockId||s?.sectionId||""),c=String(s?.updatedAt||"")||null,l=s?.embedding;if(!a||!Array.isArray(l)||!l.length)continue;let d=Zu(l);await Fe(i.put({sectionId:a,articleId:String(e),updatedAt:c,vec:d}))}await nt(o),Ac()}async function Zo(e){let t=(e||[]).map(i=>String(i||"")).filter(Boolean);if(!t.length)return;let r=(await xt()).transaction(["section_embeddings"],"readwrite"),o=r.objectStore("section_embeddings");for(let i of t)await Fe(o.delete(i));await nt(r),Ac()}var Xu,Qu,hs=et(()=>{ir();Ln();Xu=null,Qu=0});var kc=et(()=>{ir();hs();Ln()});function ei(){try{return window?.localStorage?.getItem?.(ef)==="1"}catch{return!1}}function Qt(...e){try{if(!ei())return;console.log(...e)}catch{}}async function Nt(e,t={}){let n=ei()?performance.now():0,r=n?performance.now():0,o=await fetch(e,{headers:{"Content-Type":"application/json",...t.headers||{}},credentials:"include",...t}),i=r?performance.now():0;if(!o.ok){if(o.status===401||o.status===403){try{u.serverStatus="auth",u.serverStatusText="auth"}catch{}try{window.dispatchEvent(new CustomEvent("memus:auth-required",{detail:{path:e,status:o.status}}))}catch{}}let l=await o.json().catch(()=>({}));n&&console.log("[perf][api]",e,{status:o.status,ms:Math.round(performance.now()-n),fetchMs:i?Math.round(i-r):null});let d=new Error(l.detail||"Request failed");try{d.status=o.status,d.path=e}catch{}throw d}try{u.serverStatus==="down"&&(u.serverStatus="ok",u.serverStatusText="")}catch{}if(o.status===204)return n&&console.log("[perf][api]",e,{status:204,ms:Math.round(performance.now()-n),fetchMs:i?Math.round(i-r):null}),null;let s=n?performance.now():0,a=await o.json(),c=n?performance.now():0;try{if(window?.localStorage?.getItem?.("ttree_debug_article_load_v1")==="1"){let l=o.headers.get("X-Memus-Article-ms"),d=o.headers.get("X-Memus-DocJson-bytes");(l||d)&&console.log("[api]",e,{ms:l,docJsonBytes:d})}}catch{}if(n){let l=o.headers.get("X-Memus-Article-ms")||o.headers.get("X-Memus-Articles-ms")||o.headers.get("X-Memus-Server-ms"),d=o.headers.get("X-Memus-DocJson-bytes"),m=o.headers.get("X-Memus-Articles-count"),h=o.headers.get("Content-Length");console.log("[perf][api]",e,{status:o.status,ms:Math.round(c-n),fetchMs:i?Math.round(i-r):null,jsonMs:s?Math.round(c-s):null,serverMs:l?Number(l):null,docJsonBytes:d?Number(d):null,articlesCount:m?Number(m):null,contentLength:h?Number(h):null})}return a}function nf(){try{return window?.localStorage?.getItem?.(tf)==="1"}catch{return!1}}async function Ic({timeoutMs:e}){let t=typeof e=="number"?Math.max(0,Math.floor(e)):0,n=null,r=null;try{return t>0&&typeof AbortController<"u"&&(r=new AbortController,n=setTimeout(()=>{try{r.abort()}catch{}},t)),await Nt("/api/articles",r?{signal:r.signal}:{})}catch(o){if((o?.message||String(o||"")).toLowerCase().includes("abort"))try{u.serverStatus="down",u.serverStatusText="timeout"}catch{}throw o}finally{n&&clearTimeout(n)}}function Nn(){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return Ur().catch(()=>[]);if(mo)return mo;let e=u?.offlineReady?600:250,t=2200;return mo=(async()=>{let n=ei()?performance.now():0,r=null,o=!1,i=new Promise(l=>{r=setTimeout(()=>{!o&&n&&Qt("[offline-first][articles] cache.lookup.timeout",{preferCacheMs:e}),l(null)},e)}),s=Ur().then(l=>(o=!0,r&&clearTimeout(r),r=null,n&&Qt("[offline-first][articles] cache.lookup.done",{ms:Math.round(performance.now()-n),hit:!!(l&&l.length)}),l)).catch(l=>{o=!0,r&&clearTimeout(r),r=null;try{if(u.offlineReady){let d=String(l?.idbKind||l?.name||"").toLowerCase();d.includes("timeout")?(u.offlineInitStatus="timeout",u.offlineInitError="\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435 \u043E\u0442\u0432\u0435\u0447\u0430\u0435\u0442 (\u0442\u0430\u0439\u043C\u0430\u0443\u0442 \u0447\u0442\u0435\u043D\u0438\u044F \u0441\u043F\u0438\u0441\u043A\u0430 \u0441\u0442\u0430\u0442\u0435\u0439). \u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443."):d.includes("quota")?(u.offlineInitStatus="quota",u.offlineInitError="\u041D\u0435\u0434\u043E\u0441\u0442\u0430\u0442\u043E\u0447\u043D\u043E \u043C\u0435\u0441\u0442\u0430 \u0434\u043B\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u043A\u044D\u0448\u0430. \u041E\u0447\u0438\u0441\u0442\u0438\u0442\u0435 \u043A\u044D\u0448 \u043A\u0430\u0440\u0442\u0438\u043D\u043E\u043A \u0438\u043B\u0438 \u043E\u0441\u0432\u043E\u0431\u043E\u0434\u0438\u0442\u0435 \u043C\u0435\u0441\u0442\u043E."):(u.offlineInitStatus="error",u.offlineInitError="\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0440\u043E\u0447\u0438\u0442\u0430\u0442\u044C \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A \u0441\u0442\u0430\u0442\u0435\u0439. \u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438\u043B\u0438 \u0441\u0431\u0440\u043E\u0441\u044C\u0442\u0435 \u043E\u0444\u0444\u043B\u0430\u0439\u043D\u2011\u043A\u044D\u0448.")}}catch{}return null}),a=await Promise.race([s,i]);if(a&&a.length)return gs||(gs=Ic({timeoutMs:t}).then(async l=>{try{typeof requestIdleCallback=="function"?requestIdleCallback(()=>Jn(l).catch(()=>{}),{timeout:2500}):setTimeout(()=>Jn(l).catch(()=>{}),250)}catch{Jn(l).catch(()=>{})}}).catch(()=>{}).finally(()=>{gs=null})),a;let c=await Ic({timeoutMs:t});try{typeof requestIdleCallback=="function"?requestIdleCallback(()=>Jn(c).catch(()=>{}),{timeout:2500}):setTimeout(()=>Jn(c).catch(()=>{}),250)}catch{Jn(c).catch(()=>{})}try{let l=await Ur().catch(()=>null),d=Array.isArray(c)?c.length:0,m=l&&Array.isArray(l)?l.length:0;if(m>=20&&d<=3||nf()&&m&&m>d)return l}catch{}return c})().catch(async n=>{let r=await Ur().catch(()=>null);if(r&&r.length)return r;throw n}).finally(()=>{mo=null}),mo}function vc(){return typeof navigator<"u"&&navigator&&navigator.onLine===!1?Promise.resolve([]):Nt("/api/articles/deleted").catch(async e=>[])}function Tc(e,t={}){let n=String(e||"").trim();e=n.startsWith("inbox-")?"inbox":n;let{cacheTimeoutMs:o,metaTimeoutMs:i,...s}=t||{},a=u?.offlineReady?400:150,c=typeof o=="number"?Math.max(0,Math.floor(o)):a,l=typeof i=="number"?Math.max(0,Math.floor(i)):350,d=ei()?performance.now():0,m=null,h=!1,b=new Promise(z=>{m=setTimeout(()=>{!h&&d&&Qt("[offline-first][article] cache.lookup.timeout",{id:e,cacheTimeoutMs:c}),z(null)},c)}),w=Zn(e).then(z=>(h=!0,m&&clearTimeout(m),m=null,d&&Qt("[offline-first][article] cache.lookup.done",{id:e,ms:Math.round(performance.now()-d),hit:!!z}),z)).catch(z=>(h=!0,m&&clearTimeout(m),m=null,d&&Qt("[offline-first][article] cache.lookup.failed",{id:e,ms:Math.round(performance.now()-d),message:z?.message||String(z||"")}),null)),f=Promise.race([w,b]),p=()=>Nt(`/api/articles/${e}?include_history=0`,{...s,cache:"no-store"}).then(async z=>{try{gt("article.fetch.network.ok",{articleId:e,updatedAt:z?.updatedAt||null,docHash:Ut(z?.docJson||null)})}catch{}return qr(z).catch(()=>{}),z&&z.id&&String(z.id)!==String(e)&&Sc(z,e).catch(()=>{}),z}).catch(async z=>{let X=await Zn(e).catch(()=>null);try{gt("article.fetch.network.err",{articleId:e,message:z?.message||String(z||""),cachedHit:!!X,cachedUpdatedAt:X?.updatedAt||null,cachedDocHash:Ut(X?.docJson||null)})}catch{}if(X)return X;throw z}),y=()=>{let z=new Date().toISOString(),Q={type:"doc",content:[{type:"outlineSection",attrs:{id:(globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?()=>globalThis.crypto.randomUUID():()=>`id-${Date.now()}-${Math.random().toString(16).slice(2)}`)(),collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}]};return{id:"inbox",title:"\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438",createdAt:z,updatedAt:z,deletedAt:null,parentId:null,position:0,authorId:null,publicSlug:null,encrypted:!1,docJson:Q,history:[]}},x="ttree_pending_quick_notes_v1",A=()=>{try{let z=window?.localStorage?.getItem?.(x)||"";if(!z)return[];let X=JSON.parse(z);return Array.isArray(X)?X.filter(Boolean):[]}catch{return[]}},I=(z,X)=>{let Q=String(z||"").trim();if(!Q)return null;let we=String(X||"").trim().split(/\r?\n/),Pe=[];for(let te=0;te<we.length;te+=1){let Se=we[te];Se&&Pe.push({type:"text",text:Se}),te!==we.length-1&&Pe.push({type:"hardBreak"})}return{type:"outlineSection",attrs:{id:Q,collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[Pe.length?{type:"paragraph",content:Pe}:{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}},N=z=>{try{if(!z||String(z.id||"")!=="inbox")return z;let X=A();if(!X.length)return z;let Q=z?.docJson&&typeof z.docJson=="object"?z.docJson:{type:"doc",content:[]},oe=Array.isArray(Q.content)?Q.content:[],we=new Set(oe.filter(te=>te&&te.type==="outlineSection"&&te.attrs&&te.attrs.id).map(te=>String(te.attrs.id))),Pe=[];for(let te of X){let Se=String(te?.sectionId||te?.id||"").trim();if(!Se||we.has(Se))continue;let tt=I(Se,te?.text||"");tt&&Pe.push(tt)}return Pe.length?{...z,docJson:{...Q,type:Q.type||"doc",content:[...Pe,...oe]}}:z}catch{return z}},$=()=>Nt(`/api/articles/${encodeURIComponent(e)}/meta`,{method:"GET",headers:{...s.headers||{}},cache:"no-store"}),q=()=>l?Promise.race([$(),new Promise((z,X)=>setTimeout(()=>{let Q=new Error("meta_timeout");Q.name="TimeoutError",X(Q)},l))]):$();return f.then(async z=>{if(!z){if(!navigator.onLine&&String(e)==="inbox"){try{let Pe=await Promise.race([w,new Promise(te=>setTimeout(()=>te(null),Math.max(500,l*5)))]);if(Pe){Qt("[offline-first][article] choose.cache.late.offline.inbox",{id:e});try{gt("article.choose",{articleId:e,choose:"cache.late.offline.inbox"})}catch{}return N(Pe)}}catch{}return Qt("[offline-first][article] choose.local.inbox.offline",{id:e}),N(y())}let Q=w.then(Pe=>Pe?{src:"cache",article:N(Pe)}:new Promise(()=>{})).catch(()=>new Promise(()=>{})),oe=(async()=>({src:"network",article:await N(p())}))(),we=await Promise.race([Q,oe]);if(we?.src==="cache"){Qt("[offline-first][article] choose.cache.late",{id:e});try{gt("article.choose",{articleId:e,choose:"cache.late"})}catch{}return oe.catch(()=>{}),we.article}Qt("[offline-first][article] choose.network.no-cache",{id:e});try{gt("article.choose",{articleId:e,choose:"network.no_cache"})}catch{}return we.article}if(!navigator.onLine){Qt("[offline-first][article] choose.cache.offline",{id:e,updatedAt:z?.updatedAt||null});try{gt("article.choose",{articleId:e,choose:"cache.offline",cachedUpdatedAt:z?.updatedAt||null,cachedDocHash:Ut(z?.docJson||null)})}catch{}return N(z)}let X=String(z.updatedAt||z.updated_at||"").trim();if(!X){Qt("[offline-first][article] choose.network.no-cached-updatedAt",{id:e});try{gt("article.choose",{articleId:e,choose:"network.no_cached_updatedAt",cachedDocHash:Ut(z?.docJson||null)})}catch{}return N(await p())}try{Qt("[offline-first][article] meta.check.start",{id:e,cachedUpdatedAt:X});let Q=await q(),oe=String(Q?.updatedAt||"").trim();if(oe&&oe===X){Qt("[offline-first][article] choose.cache.meta.same",{id:e,cachedUpdatedAt:X});try{gt("article.choose",{articleId:e,choose:"cache.meta.same",cachedUpdatedAt:X,serverUpdatedAt:oe,cachedDocHash:Ut(z?.docJson||null)})}catch{}return N(z)}Qt("[offline-first][article] choose.network.meta.diff",{id:e,cachedUpdatedAt:X,serverUpdatedAt:oe||null});try{gt("article.choose",{articleId:e,choose:"network.meta.diff",cachedUpdatedAt:X,serverUpdatedAt:oe||null,cachedDocHash:Ut(cached?.docJson||null)})}catch{}return N(await p())}catch(Q){String(Q?.name||"")==="TimeoutError"||String(Q?.message||"")==="meta_timeout"?Qt("[offline-first][article] meta.check.timeout",{id:e,metaTimeoutMs:l}):Qt("[offline-first][article] meta.check.failed",{id:e,message:Q?.message||String(Q||"")}),p().catch(()=>{}),String(Q?.name||"")==="TimeoutError"||String(Q?.message||"")==="meta_timeout"?Qt("[offline-first][article] choose.cache.meta.timeout",{id:e,cachedUpdatedAt:X,metaTimeoutMs:l}):Qt("[offline-first][article] choose.cache.meta.failed",{id:e,cachedUpdatedAt:X});try{gt("article.choose",{articleId:e,choose:String(Q?.name||"")==="TimeoutError"||String(Q?.message||"")==="meta_timeout"?"cache.meta.timeout":"cache.meta.failed",cachedUpdatedAt:X,cachedDocHash:Ut(z?.docJson||null),error:Q?.message||String(Q||"")})}catch{}return N(z)}})}function Bc(e,t){return e?!t||typeof t!="object"?Promise.reject(new Error("docJson must be object")):Nt(`/api/articles/${encodeURIComponent(e)}/doc-json`,{method:"PUT",body:JSON.stringify({docJson:t})}):Promise.reject(new Error("articleId is required"))}function Nc(e){return typeof e!="string"?Promise.reject(new Error("text must be string")):Nt("/api/outline/generate-title",{method:"POST",body:JSON.stringify({text:e})})}function ys(e){return typeof e!="string"?Promise.reject(new Error("html must be string")):Nt("/api/outline/proofread-html",{method:"POST",body:JSON.stringify({html:e})})}function Mc(e,t={}){let n=t.force?"?force=true":"";return Nt(`/api/articles/${e}${n}`,{method:"DELETE"}).then(r=>{let o=n?new Date().toISOString():new Date().toISOString();return Qo(e,o).catch(()=>{}),r})}function Lc(e){return Nt(`/api/articles/${e}/restore`,{method:"POST"})}function Pc(e,t,n={}){let r=Array.isArray(t)?t.filter(Boolean).map(o=>String(o)):[];return e?r.length?Nt(`/api/articles/${encodeURIComponent(e)}/sections/delete`,{method:"PUT",cache:"no-store",body:JSON.stringify({opId:n?.opId||null,sectionIds:r})}):Promise.resolve({status:"ok",removedBlockIds:[]}):Promise.reject(new Error("articleId is required"))}function ho(e){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return Promise.reject(new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D"));let t=new FormData;t.append("file",e);let n=i=>{if(!(typeof navigator<"u"&&navigator&&navigator.onLine===!1))try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"uploadImageFile",data:i})}).catch(()=>{})}catch{}},r=()=>fetch("/api/uploads",{method:"POST",credentials:"include",body:t}).then(async i=>{let s=await i.json().catch(()=>null);if(n({transport:"fetch",status:i.status,ok:i.ok,details:s,name:e&&e.name,type:e&&e.type,size:e&&e.size}),!i.ok){let a=s?.detail||`Upload failed (status ${i.status})`,c=new Error(a);throw c.status=i.status,c.details=s,c}return s}),o=()=>new Promise((i,s)=>{let a=new XMLHttpRequest;a.open("POST","/api/uploads"),a.withCredentials=!0,a.onreadystatechange=()=>{if(a.readyState===XMLHttpRequest.DONE)try{let c=a.status,l=null;try{l=JSON.parse(a.responseText||"null")}catch{l=null}if(n({transport:"xhr",status:c,ok:c>=200&&c<300,details:l,name:e&&e.name,type:e&&e.type,size:e&&e.size}),c>=200&&c<300)i(l);else{let d=l&&l.detail||`Upload failed (status ${c})`,m=new Error(d);m.status=c,m.details=l,s(m)}}catch(c){s(c)}},a.onerror=()=>{n({transport:"xhr",status:0,ok:!1,details:{detail:"Network error during image upload"},name:e&&e.name,type:e&&e.type,size:e&&e.size});let c=new Error("Upload failed (network error)");c.status=0,c.details={detail:"Network error during image upload"},s(c)},a.send(t)});return r().catch(i=>{let s=String(i&&i.message?i.message:"").toLowerCase();if(s.includes("status ")||s.includes("upload failed"))throw i;return o()})}function rf(e,t,n=()=>{},{sectionId:r}={}){return typeof navigator<"u"&&navigator&&navigator.onLine===!1?Promise.reject(new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D")):new Promise((o,i)=>{let s=new XMLHttpRequest;s.open("POST",`/api/articles/${e}/attachments`),s.withCredentials=!0,s.upload.onprogress=c=>{if(c.lengthComputable){let l=Math.round(c.loaded/c.total*100);n(l)}},s.onreadystatechange=()=>{if(s.readyState===XMLHttpRequest.DONE)if(s.status>=200&&s.status<300)try{let c=JSON.parse(s.responseText||"{}");o(c)}catch(c){i(c)}else{let c=`Attachment upload failed (status ${s.status})`;try{let l=JSON.parse(s.responseText||"{}");l?.detail&&(c=l.detail)}catch{}i(new Error(c))}},s.onerror=()=>i(new Error("Network error during upload"));let a=new FormData;a.append("file",t),r&&a.append("sectionId",String(r)),s.send(a)})}function of(e){let t=new Map;for(let n of e||[]){let r=n.parentId??null;t.has(r)||t.set(r,[]),t.get(r).push(n)}for(let n of t.values())n.sort((r,o)=>(r.position||0)-(o.position||0));return t}function Ec(e){let t=[];for(let n=0;n<e.length;n+=1){let r=e[n];if(!r)continue;let o=n;(r.position||0)!==o&&(r.position=o,t.push({id:r.id,parentId:r.parentId??null,position:o}))}return t}function bs(e,t){return e?Nt(`/api/articles/${encodeURIComponent(e)}/move-tree`,{method:"POST",body:JSON.stringify(t||{})}).catch(async()=>{let r=await Ur().catch(()=>[]),o=of(r),i=(r||[]).find(p=>p.id===e);if(!i)return null;let s=t&&t.placement||null,a=t&&t.anchorId||null,c=t?t.parentId??null:null;s==="inside"&&a&&(c=a);let l=i.parentId??null,m=(o.get(l)||[]).filter(p=>p.id!==e),b=(o.get(c)||[]).filter(p=>p.id!==e),w=b.length;if(a){let p=b.findIndex(y=>y.id===a);p!==-1&&(s==="before"?w=p:s==="after"?w=p+1:s==="inside"&&(w=b.length))}i.parentId=c,b.splice(w,0,i);let f=[];return f.push(...Ec(m)),f.push(...Ec(b)),xc(f).catch(()=>{}),cn("move_article_tree",{articleId:e,payload:t||{},coalesceKey:`${e}:move-tree`}).catch(()=>{}),{id:e}}):Promise.resolve(null)}async function sf({articleId:e,filename:t,overwrite:n=!1,sha256:r="",size:o=0}){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D");let s=await fetch("/api/yandex/disk/upload-url",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({filename:t||"",articleId:e||"",overwrite:!!n,sha256:r||"",size:typeof o=="number"?o:0})}),a=await s.json().catch(()=>null);if(!s.ok){let c=a&&a.detail||`Yandex upload URL failed (status ${s.status})`;throw new Error(c)}return a}async function Cc(e,{path:t,originalName:n,contentType:r,size:o,sectionId:i}){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D");let s={path:t||"",originalName:n||"",contentType:r||"",size:typeof o=="number"?o:0};i&&(s.sectionId=String(i));let a=await fetch(`/api/articles/${e}/attachments/yandex`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),c=await a.json().catch(()=>null);if(!a.ok){let l=c&&c.detail||`Register Yandex attachment failed (status ${a.status})`;throw new Error(l)}return c}async function ti(e,t,{onProgress:n,sectionId:r}={}){if(!t)throw new Error("\u0424\u0430\u0439\u043B \u043D\u0435 \u0443\u043A\u0430\u0437\u0430\u043D");let o="";try{if(window.crypto&&window.crypto.subtle&&typeof t.arrayBuffer=="function"){let h=await t.arrayBuffer(),b=await window.crypto.subtle.digest("SHA-256",h),w=new Uint8Array(b);o=Array.from(w).map(f=>f.toString(16).padStart(2,"0")).join("")}}catch{o=""}let{href:i,method:s,path:a,exists:c,same:l}=await sf({articleId:e,filename:t.name||"attachment",overwrite:!1,sha256:o,size:t.size||0});if(c&&l&&!i)return await Cc(e,{path:a,originalName:t.name||"attachment",contentType:t.type||"",size:t.size||0,sectionId:r});let d=!1;if(i)try{await new Promise((h,b)=>{let w=new XMLHttpRequest;w.open(s||"PUT",i),w.upload.onprogress=f=>{if(n&&f.lengthComputable){let p=Math.round(f.loaded/f.total*100);try{n(p)}catch{}}},w.onreadystatechange=()=>{w.readyState===XMLHttpRequest.DONE&&(w.status>=200&&w.status<300?h():b(new Error(`Yandex upload failed (status ${w.status})`)))},w.onerror=()=>b(new Error("Network error during Yandex upload")),w.send(t)}),d=!0}catch(h){console.warn("[attachments] Direct Yandex upload failed, falling back to server upload",h),d=!1}return d?await Cc(e,{path:a,originalName:t.name||"attachment",contentType:t.type||"",size:t.size||0,sectionId:r}):await rf(e,t,n,{sectionId:r})}var ef,mo,gs,tf,mn=et(()=>{Kr();zr();kc();Ht();po();ef="ttree_profile_v1";mo=null,gs=null,tf="ttree_offline_recovery_force_index_v1"});function _c(){if(!V.articlePublicToggleBtn)return;let e=u.article?.publicSlug||null;V.articlePublicToggleBtn.textContent=e?"\u041E\u0442\u043C\u0435\u043D\u0438\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435":"\u0414\u0430\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435"}function go(){let e=u.article;if(!e)return;let t=e.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";if(V.articleTitle&&(V.articleTitle.textContent=t,V.articleTitle.classList.toggle("article-title--encrypted",!!e.encrypted),V.articleTitle.classList.toggle("hidden",u.isEditingTitle)),V.articleTitleInput&&(u.isEditingTitle||(V.articleTitleInput.value=t),V.articleTitleInput.classList.toggle("hidden",!u.isEditingTitle)),V.editTitleBtn&&V.editTitleBtn.classList.toggle("hidden",u.isEditingTitle),V.articleFavoriteBtn){let r=new Set(u.favoriteArticles||[]).has(e.id),o=V.articleFavoriteBtn.querySelector?.("i.bx")||V.articleFavoriteBtn.querySelector?.("span.bx")||V.articleFavoriteBtn.querySelector?.(".bx")||null;o&&o.classList?(o.classList.toggle("bxs-star",r),o.classList.toggle("bx-star",!r)):V.articleFavoriteBtn.innerHTML=`<i class="bx ${r?"bxs-star":"bx-star"}" aria-hidden="true"></i>`,V.articleFavoriteBtn.title=r?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}if(V.articlePublicLinkBtn){let n=!!e.publicSlug;V.articlePublicLinkBtn.classList.toggle("hidden",!n),n&&(V.articlePublicLinkBtn.title="\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0441\u044B\u043B\u043A\u0443")}if(V.deleteArticleBtn&&V.deleteArticleBtn.classList.toggle("hidden",e.id==="inbox"),V.articleEncryptionBtn&&(V.articleEncryptionBtn.textContent=e.encrypted?"\u0421\u043C\u0435\u043D\u0438\u0442\u044C \u043F\u0430\u0440\u043E\u043B\u044C":"\u0417\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C"),V.articleEncryptionRemoveBtn&&V.articleEncryptionRemoveBtn.classList.toggle("hidden",!e.encrypted),V.updatedAt&&(u.isOutlineEditing?V.updatedAt.textContent=u.outlineStatusText||"":e.updatedAt?V.updatedAt.textContent=`\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${new Date(e.updatedAt).toLocaleString()}`:V.updatedAt.textContent=""),V.articleStatusText&&(u.isOutlineEditing?V.articleStatusText.textContent=u.outlineStatusText||"":e.updatedAt?V.articleStatusText.textContent=`\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${new Date(e.updatedAt).toLocaleString()}`:V.articleStatusText.textContent=""),V.mediaStatusText&&(V.mediaStatusText.textContent=u.mediaStatusText||""),V.mediaPrefetchToggleBtn){let n=!!u.mediaPrefetchPaused;V.mediaPrefetchToggleBtn.textContent=n?"\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C":"\u041F\u0430\u0443\u0437\u0430",V.mediaPrefetchToggleBtn.classList.toggle("is-active",n)}}var yo=et(()=>{Ht();Bn()});function ln(...e){console.log("[debug]",...e)}function Zt(e=""){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Dc(e=""){let t=(e||"").replace(/<br\s*\/?>/gi,`
`).replace(/<\/(?:div|p|li|h[1-6])>/gi,`
`),n=document.createElement("template");return n.innerHTML=t,(n.content.textContent||"").split(`
`).map(r=>r.replace(/\s+/g," ").trim()).filter(r=>r.length)}function ni(e){if(!e||!e.isConnected)return;let t=window.getSelection();if(!t)return;let n=document.createRange();n.selectNodeContents(e),n.collapse(!1),t.removeAllRanges(),t.addRange(n)}function Ss(e){if(!e||!e.isConnected)return;let t=window.getSelection();if(!t)return;let n=document.createRange();n.selectNodeContents(e),n.collapse(!0),t.removeAllRanges(),t.addRange(n)}function er(e,t){if(!e||!document.contains(e))return;e.focus();let n=window.getSelection();if(!n)return;let r=n.rangeCount>0?n.getRangeAt(0):document.createRange();e.contains(r.commonAncestorContainer)||(r=document.createRange(),r.selectNodeContents(e),r.collapse(!1)),n.removeAllRanges(),n.addRange(r);let o=r.createContextualFragment(t);r.deleteContents(),r.insertNode(o),r.collapse(!1),n.removeAllRanges(),n.addRange(r)}var Fn=et(()=>{});var xs={};Uo(xs,{showArticleHistoryModal:()=>hf,showArticleLinkPrompt:()=>cf,showBlockHistoryModal:()=>pf,showBlockTrashPicker:()=>gf,showConfirm:()=>Hc,showImagePreview:()=>bo,showImportConflictDialog:()=>yf,showLinkPrompt:()=>ws,showPasswordWithHintPrompt:()=>$c,showPrompt:()=>ar,showPublicLinkModal:()=>lf,showVersionCompareTargetPicker:()=>uf,showVersionDiffModal:()=>ff,showVersionsPicker:()=>df});function An(){let e=document.getElementById(Oc);return e||(e=document.createElement("div"),e.id=Oc,document.body.appendChild(e)),e}function Pn({title:e,message:t,confirmText:n,cancelText:r,renderBody:o}){let i=document.createElement("div");i.className="modal-overlay";let s=document.createElement("form");s.className="modal-form",s.addEventListener("submit",w=>{w.preventDefault()});let a=document.createElement("div");a.className="modal-card",a.setAttribute("role","dialog"),a.setAttribute("aria-modal","true"),a.tabIndex=-1;let c=document.createElement("div");c.className="modal-header";let l=document.createElement("h3");l.textContent=e||"\u041F\u043E\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043D\u0438\u0435",c.appendChild(l);let d=document.createElement("div");if(d.className="modal-body",typeof o=="function"){let w=o();Array.isArray(w)?w.forEach(f=>{f&&d.appendChild(f)}):w&&d.appendChild(w)}else d.textContent=t||"";let m=document.createElement("div");m.className="modal-footer modal-footer--stacked";let h=document.createElement("button");h.type="button",h.className="ghost",h.textContent=r||"\u041E\u0442\u043C\u0435\u043D\u0430";let b=document.createElement("button");return b.type="button",b.className="primary danger-btn",b.textContent=n||"\u0423\u0434\u0430\u043B\u0438\u0442\u044C",m.appendChild(b),m.appendChild(h),a.appendChild(c),a.appendChild(d),a.appendChild(m),s.appendChild(a),i.appendChild(s),{overlay:i,card:a,confirmBtn:b,cancelBtn:h,form:s}}function af(e="",t=""){let n=String(e||"").length,r=String(t||"").length;if(n*r>2e6||n+r>2e4)return null;let s=Array.from(e),a=Array.from(t),c=s.length,l=a.length,d=Array.from({length:c+1},()=>new Array(l+1).fill(0));for(let f=c-1;f>=0;f-=1)for(let p=l-1;p>=0;p-=1)s[f]===a[p]?d[f][p]=d[f+1][p+1]+1:d[f][p]=Math.max(d[f+1][p],d[f][p+1]);let m=[],h=0,b=0;for(;h<c&&b<l;)s[h]===a[b]?(m.push({type:"same",value:s[h]}),h+=1,b+=1):d[h+1][b]>=d[h][b+1]?(m.push({type:"removed",value:s[h]}),h+=1):(m.push({type:"added",value:a[b]}),b+=1);for(;h<c;)m.push({type:"removed",value:s[h]}),h+=1;for(;b<l;)m.push({type:"added",value:a[b]}),b+=1;let w=[];return m.forEach(f=>{if(!f.value)return;let p=w[w.length-1];p&&p.type===f.type?p.value+=f.value:w.push({type:f.type,value:f.value})}),w}function Vr({baseText:e="",nextText:t="",mode:n="before"}={}){let r=document.createDocumentFragment(),o=af(e,t);if(!o){let s=String(n==="before"?e||"":t||""),a=s.length>2e5?`${s.slice(0,2e5)}

\u2026(\u043E\u0431\u0440\u0435\u0437\u0430\u043D\u043E)`:s,c=document.createElement("div");c.className="meta",c.style.marginBottom="6px",c.textContent="Diff \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 \u2014 \u043F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0435\u043C \u0442\u0435\u043A\u0441\u0442 \u0431\u0435\u0437 \u043F\u043E\u0434\u0441\u0432\u0435\u0442\u043A\u0438.";let l=document.createElement("pre");return l.className="diff-plain",l.style.whiteSpace="pre-wrap",l.style.wordBreak="break-word",l.textContent=a,r.appendChild(c),r.appendChild(l),r}return o.forEach(i=>{if(n==="before"&&i.type==="added"||n==="after"&&i.type==="removed")return;let s=document.createElement("span");s.className="diff-seg",i.type==="added"&&s.classList.add("diff-seg--added"),i.type==="removed"&&s.classList.add("diff-seg--removed"),s.textContent=i.value,r.appendChild(s)}),r}function Hc(e={}){let t=An(),{overlay:n,card:r,confirmBtn:o,cancelBtn:i,form:s}=Pn(e),a=!1,c=()=>{},l=()=>{n.classList.add("modal-overlay--hide"),setTimeout(()=>n.remove(),150),document.removeEventListener("keydown",m)},d=h=>{a||(a=!0,l(),c(h))},m=h=>{h.code==="Escape"&&(h.preventDefault(),d(!1)),h.code==="Enter"&&(h.preventDefault(),d(!0))};return new Promise(h=>{c=h,s.addEventListener("submit",b=>{b.preventDefault(),d(!0)}),o.addEventListener("click",()=>d(!0)),i.addEventListener("click",()=>d(!1)),n.addEventListener("click",b=>{b.target===n&&d(!1)}),document.addEventListener("keydown",m),t.appendChild(n),requestAnimationFrame(()=>{r.focus({preventScroll:!0})})})}function ar(e={}){let t=An(),n=null,r=null,o=Array.isArray(e.suggestions)?e.suggestions:[],i=null,{overlay:s,card:a,confirmBtn:c,cancelBtn:l,form:d}=Pn({...e,renderBody:()=>{let x=document.createDocumentFragment();if(e.message){let I=document.createElement("p");I.className="modal-body__text",I.textContent=e.message,x.appendChild(I)}let A=document.createElement("input");if(A.type=e.inputType==="password"?"password":"text",A.className="modal-input",A.placeholder=e.placeholder||"",A.value=e.defaultValue||"",A.autocomplete="off",x.appendChild(A),e.checkbox&&typeof e.checkbox=="object"){let I=document.createElement("label");I.className="modal-checkbox";let N=document.createElement("input");N.type="checkbox",N.checked=!!e.checkbox.checked,N.disabled=!!e.checkbox.disabled;let $=document.createElement("span");$.className="modal-checkbox__label",$.textContent=String(e.checkbox.label||"").trim(),I.appendChild(N),I.appendChild($),x.appendChild(I),r=N}return o.length&&(i=document.createElement("div"),i.className="modal-suggestions",x.appendChild(i)),n=A,x}}),m=!1,h=()=>{},b=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",f)},w=x=>{if(!m)if(m=!0,b(),e.returnMeta){let A={value:x??null,selectedId:n?.dataset?.selectedId||null,checkboxChecked:r?!!r.checked:null};h(A)}else h(x)},f=x=>{if(x.code==="Escape"){x.preventDefault(),w(null);return}if(x.code==="Enter"&&n&&!e.hideConfirm){let A=n.value.trim();if(!A&&!e.allowEmpty)return;x.preventDefault(),w(A)}},p=()=>{if(!c||!n)return;let x=!!n.value.trim();c.disabled=!x&&!e.allowEmpty},y=()=>{if(!i||!n)return;let x=n.value.trim().toLowerCase();n.dataset.selectedId="";let A=o.filter(I=>(I.title||"").toLowerCase().includes(x)||(I.id||"").toLowerCase().includes(x)).slice(0,8);if(i.innerHTML="",!x||!A.length){i.classList.add("hidden");return}i.classList.remove("hidden"),A.forEach(I=>{let N=document.createElement("button");N.type="button",N.className="modal-suggestion",N.textContent=I.title||I.id||"",N.addEventListener("click",()=>{n.value=I.title||I.id||"",n.dataset.selectedId=I.id||"",p(),y(),w(n.value)}),i.appendChild(N)})};return new Promise(x=>{h=x,c.classList.remove("danger-btn"),e.hideConfirm?c.style.display="none":c.textContent=e.confirmText||"OK",l.textContent=e.cancelText||"Cancel";let A=()=>{if(!n){w(null);return}let I=n.value.trim();if(!I){n.focus();return}w(I)};d.addEventListener("submit",I=>{I.preventDefault(),A()}),c.addEventListener("click",A),l.addEventListener("click",()=>w(null)),s.addEventListener("click",I=>{I.target===s&&w(null)}),document.addEventListener("keydown",f),n?(n.dataset.selectedId="",n.addEventListener("input",()=>{n.dataset.selectedId="",p(),o.length&&y()}),e.hideConfirm&&n.addEventListener("keydown",I=>{I.code==="Enter"&&(I.preventDefault(),w(n.value.trim()))}),p(),o.length&&y()):p(),t.appendChild(s),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):a.focus({preventScroll:!0})})})}function cf(e={}){let t=An(),n=null,r=null,o=Array.isArray(e.suggestions)?e.suggestions:[],i=null,{overlay:s,card:a,confirmBtn:c,cancelBtn:l,form:d}=Pn({title:e.title||"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",renderBody:()=>{let x=document.createDocumentFragment();if(e.message){let q=document.createElement("p");q.className="modal-body__text",q.textContent=e.message,x.appendChild(q)}let A=document.createElement("label");A.className="modal-label",A.textContent=e.articleLabel||"\u0421\u0442\u0430\u0442\u044C\u044F";let I=document.createElement("input");I.type="text",I.className="modal-input",I.placeholder=e.articlePlaceholder||"ID \u0438\u043B\u0438 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435\u2026",I.value=e.defaultArticleValue||"",I.autocomplete="off",A.appendChild(I),x.appendChild(A),n=I,o.length&&(i=document.createElement("div"),i.className="modal-suggestions",x.appendChild(i));let N=document.createElement("label");N.className="modal-label",N.textContent=e.textLabel||"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)";let $=document.createElement("input");return $.type="text",$.className="modal-input",$.placeholder=e.textPlaceholder||"",$.value=e.defaultTextValue||"",$.autocomplete="off",N.appendChild($),x.appendChild(N),r=$,x}}),m=!1,h=()=>{},b=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",y)},w=x=>{m||(m=!0,b(),h(x))},f=()=>{if(!c||!n)return;let x=!!n.value.trim()||!!n.dataset.selectedId;c.disabled=!x},p=()=>{if(!i||!n)return;let x=n.value.trim().toLowerCase();n.dataset.selectedId="";let A=o.filter(I=>(I.title||"").toLowerCase().includes(x)||(I.id||"").toLowerCase().includes(x)).slice(0,8);if(i.innerHTML="",!x||!A.length){i.classList.add("hidden");return}i.classList.remove("hidden"),A.forEach(I=>{let N=document.createElement("button");N.type="button",N.className="modal-suggestion",N.textContent=I.title||I.id||"",N.addEventListener("click",()=>{n.value=I.title||I.id||"",n.dataset.selectedId=I.id||"",f(),p(),r&&!r.value.trim()&&!e.lockTextValue&&(r.value=I.title||""),r?.focus?.({preventScroll:!0}),r?.select?.()}),i.appendChild(N)})},y=x=>{if(x.code==="Escape"){x.preventDefault(),w(null);return}x.code};return new Promise(x=>{h=x,c.classList.remove("danger-btn"),c.textContent=e.confirmText||"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",l.textContent=e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430";let A=()=>{if(!n||!r){w(null);return}let I=n.value.trim(),N=n.dataset.selectedId||"";if(!I&&!N){n.focus();return}w({articleValue:I,selectedId:N||null,textValue:r.value??""})};d.addEventListener("submit",I=>{I.preventDefault(),A()}),c.addEventListener("click",A),l.addEventListener("click",()=>w(null)),s.addEventListener("click",I=>{I.target===s&&w(null)}),document.addEventListener("keydown",y),n?(n.dataset.selectedId="",n.addEventListener("input",()=>{n.dataset.selectedId="",f(),o.length&&p()}),f(),o.length&&p()):f(),t.appendChild(s),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):a.focus({preventScroll:!0})})})}function lf(e={}){let t=An(),n=null,r=e.url||"",{overlay:o,card:i,confirmBtn:s,cancelBtn:a}=Pn({title:e.title||"\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u0430\u044F \u0441\u0441\u044B\u043B\u043A\u0430",renderBody:()=>{let f=document.createDocumentFragment(),p=document.createElement("label");p.className="modal-label",p.textContent=e.label||"\u041F\u0440\u043E\u0441\u043C\u043E\u0442\u0440 \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435";let y=document.createElement("input");return y.type="text",y.className="modal-input",y.value=r,y.readOnly=!0,y.autocomplete="off",p.appendChild(y),n=y,f.appendChild(p),f}}),c=!1,l=()=>{},d=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",h)},m=()=>{c||(c=!0,d(),l())},h=f=>{f.code==="Escape"&&(f.preventDefault(),m())},b=f=>{if(!f)return!1;let p=document.createElement("textarea");p.value=f,p.setAttribute("readonly",""),p.style.position="absolute",p.style.left="-9999px",document.body.appendChild(p),p.focus(),p.select();let y=!1;try{y=document.execCommand("copy")}catch{y=!1}return document.body.removeChild(p),y},w=()=>{let f=n&&n.value||r;if(f){ve("\u0421\u0441\u044B\u043B\u043A\u0430 \u0441\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u0430");try{if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function"){let p=navigator.clipboard.writeText(f);p&&typeof p.catch=="function"&&p.catch(()=>{b(f)})}else b(f)}catch{b(f)}}};return new Promise(f=>{l=f,s.classList.remove("danger-btn"),s.innerHTML='<i class="bx bx-copy" aria-hidden="true"></i> \u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443',s.setAttribute("aria-label",e.copyLabel||"\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443"),a.classList.add("hidden"),s.addEventListener("click",()=>{w(),m()}),o.addEventListener("click",p=>{p.target===o&&m()}),document.addEventListener("keydown",h),t.appendChild(o),requestAnimationFrame(()=>{n?n.focus({preventScroll:!0}):i.focus({preventScroll:!0})})})}function df(e={}){let t=An(),n=Array.isArray(e.versions)?e.versions:[],r=n[0]?.id||"",o=y=>{try{let x=new Date(y);return Number.isNaN(x.getTime())?String(y||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(x)}catch{return String(y||"")}},{overlay:i,card:s,confirmBtn:a,cancelBtn:c,form:l}=Pn({title:e.title||"\u0412\u0435\u0440\u0441\u0438\u0438",confirmText:e.confirmText||"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",cancelText:e.cancelText||"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",renderBody:()=>{let y=document.createDocumentFragment(),x=document.createElement("p");if(x.className="modal-body__text",x.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0435\u0440\u0441\u0438\u044E \u0441\u0442\u0430\u0442\u044C\u0438 \u0434\u043B\u044F \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F.",y.appendChild(x),!n.length){let I=document.createElement("div");return I.className="modal-empty",I.textContent="\u0412\u0435\u0440\u0441\u0438\u0439 \u043F\u043E\u043A\u0430 \u043D\u0435\u0442.",y.appendChild(I),y}let A=document.createElement("div");return A.className="modal-list",n.forEach((I,N)=>{let $=document.createElement("label");$.className="modal-list__item";let q=document.createElement("input");q.type="radio",q.name="version",q.value=I.id||"",q.checked=N===0,q.addEventListener("change",()=>{r=q.value,a.disabled=!r,d.disabled=!r});let z=document.createElement("div");z.className="modal-list__meta";let X=document.createElement("div");X.className="modal-list__title",X.textContent=I.label||o(I.created_at||I.createdAt);let Q=document.createElement("div");Q.className="modal-list__subtitle";let oe=I.reason||"",we=o(I.created_at||I.createdAt);Q.textContent=[we,oe].filter(Boolean).join(" \xB7 "),z.appendChild(X),z.appendChild(Q),$.appendChild(q),$.appendChild(z),A.appendChild($)}),y.appendChild(A),y}});s.classList.add("modal-card--diff-light"),a.classList.remove("danger-btn"),a.disabled=!r;let d=document.createElement("button");d.type="button",d.className="ghost",d.textContent=e.compareText||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C",d.disabled=!r;let m=s.querySelector(".modal-footer");m&&m.insertBefore(d,a);let h=!1,b=()=>{},w=()=>{i.classList.add("modal-overlay--hide"),setTimeout(()=>i.remove(),150),document.removeEventListener("keydown",p)},f=y=>{h||(h=!0,w(),b(y))},p=y=>{y.code==="Escape"&&(y.preventDefault(),f(null))};return new Promise(y=>{b=y;let x=()=>{r&&f({action:"restore",versionId:r})};l.addEventListener("submit",A=>{A.preventDefault(),x()}),a.addEventListener("click",x),d.addEventListener("click",()=>{r&&f({action:"compare",versionId:r})}),c.addEventListener("click",()=>f(null)),i.addEventListener("click",A=>{A.target===i&&f(null)}),document.addEventListener("keydown",p),t.appendChild(i),requestAnimationFrame(()=>{s.focus({preventScroll:!0})})})}function uf(e={}){let t=An(),n=Array.isArray(e.versions)?e.versions:[],r=String(e.excludeId||""),o=[{kind:"current",id:"__current__",title:"\u0422\u0435\u043A\u0443\u0449\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F"},...n.filter(p=>String(p.id||"")&&String(p.id||"")!==r).map(p=>({kind:"version",id:String(p.id),title:p.label||p.created_at||p.createdAt||p.id}))],i=o[0]?.id||"",{overlay:s,card:a,confirmBtn:c,cancelBtn:l,form:d}=Pn({title:e.title||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C \u0441\u2026",confirmText:e.confirmText||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C",cancelText:e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430",renderBody:()=>{let p=document.createDocumentFragment(),y=document.createElement("p");y.className="modal-body__text",y.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0442\u043E\u0440\u0443\u044E \u0441\u0442\u043E\u0440\u043E\u043D\u0443 \u0441\u0440\u0430\u0432\u043D\u0435\u043D\u0438\u044F.",p.appendChild(y);let x=document.createElement("div");return x.className="modal-list",o.forEach((A,I)=>{let N=document.createElement("label");N.className="modal-list__item";let $=document.createElement("input");$.type="radio",$.name="compareTarget",$.value=A.id,$.checked=I===0,$.addEventListener("change",()=>{i=$.value,c.disabled=!i});let q=document.createElement("div");q.className="modal-list__meta";let z=document.createElement("div");z.className="modal-list__title",z.textContent=A.title,q.appendChild(z),N.appendChild($),N.appendChild(q),x.appendChild(N)}),p.appendChild(x),p}});a.classList.add("modal-card--diff-light"),c.classList.remove("danger-btn"),c.disabled=!i;let m=!1,h=()=>{},b=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",f)},w=p=>{m||(m=!0,b(),h(p))},f=p=>{p.code==="Escape"&&(p.preventDefault(),w(null))};return new Promise(p=>{h=p;let y=()=>{if(!i)return;let x=o.find(A=>A.id===i)||null;if(!x){w(null);return}if(x.kind==="current"){w({target:"current"});return}w({target:"version",versionId:x.id})};d.addEventListener("submit",x=>{x.preventDefault(),y()}),c.addEventListener("click",y),l.addEventListener("click",()=>w(null)),s.addEventListener("click",x=>{x.target===s&&w(null)}),document.addEventListener("keydown",f),t.appendChild(s),requestAnimationFrame(()=>{a.focus({preventScroll:!0})})})}function ff(e={}){let t=An(),n=Array.isArray(e.changes)?e.changes:[],r=n.find(b=>b.type==="changed")||n[0]||null,{overlay:o,card:i,confirmBtn:s,cancelBtn:a}=Pn({title:e.title||"\u041E\u0442\u043B\u0438\u0447\u0438\u044F \u0432\u0435\u0440\u0441\u0438\u0439",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:"",renderBody:()=>{let b=document.createDocumentFragment(),w=document.createElement("div");w.className="diff-summary";let f=n.reduce((X,Q)=>(X[Q.type]=(X[Q.type]||0)+1,X),{added:0,removed:0,changed:0});if(w.textContent=`\u0418\u0437\u043C\u0435\u043D\u0435\u043D\u043E: ${f.changed||0} \xB7 \u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E: ${f.added||0} \xB7 \u0423\u0434\u0430\u043B\u0435\u043D\u043E: ${f.removed||0}`,b.appendChild(w),!n.length){let X=document.createElement("div");return X.className="modal-empty",X.textContent="\u041D\u0435\u0442 \u043E\u0442\u043B\u0438\u0447\u0438\u0439.",b.appendChild(X),b}let p=document.createElement("div");p.className="modal-list",n.forEach(X=>{let Q=document.createElement("button");Q.type="button",Q.className=`diff-item diff-item--${X.type}${r&&r.id===X.id?" diff-item--active":""}`;let oe=X.label||X.id;Q.textContent=`${X.type==="changed"?"\u2260":X.type==="added"?"+":"\u2212"} ${oe}`,Q.addEventListener("click",()=>{r=X,p.querySelectorAll(".diff-item").forEach(we=>we.classList.remove("diff-item--active")),Q.classList.add("diff-item--active"),z()}),p.appendChild(Q)}),b.appendChild(p);let y=document.createElement("div");y.className="diff-panes";let x=document.createElement("div");x.className="diff-pane-wrap";let A=document.createElement("div");A.className="diff-pane-wrap";let I=document.createElement("div");I.className="diff-pane-title",I.textContent=e.beforeTitle||"\u0412\u0435\u0440\u0441\u0438\u044F";let N=document.createElement("div");N.className="diff-pane-title",N.textContent=e.afterTitle||"\u0422\u0435\u043A\u0443\u0449\u0430\u044F";let $=document.createElement("div");$.className="diff-pane diff-pane--before";let q=document.createElement("div");q.className="diff-pane diff-pane--after",x.appendChild(I),x.appendChild($),A.appendChild(N),A.appendChild(q),y.appendChild(x),y.appendChild(A),b.appendChild(y);let z=()=>{let X=r?.before||"",Q=r?.after||"";$.innerHTML="",q.innerHTML="",$.appendChild(Vr({baseText:X,nextText:Q,mode:"before"})),q.appendChild(Vr({baseText:X,nextText:Q,mode:"after"}))};return z(),b}});i.classList.add("modal-card--fullscreen"),i.classList.add("modal-card--diff-light"),s.classList.remove("danger-btn"),a&&(a.style.display="none");let c=!1,l=()=>{},d=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",h)},m=()=>{c||(c=!0,d(),l())},h=b=>{b.code==="Escape"&&(b.preventDefault(),m())};return new Promise(b=>{l=b,s.addEventListener("click",m),o.addEventListener("click",w=>{w.target===o&&m()}),document.addEventListener("keydown",h),t.appendChild(o),requestAnimationFrame(()=>{i.focus({preventScroll:!0})})})}function pf(e={}){let t=An(),n=Array.isArray(e.entries)?e.entries:[],r=n[0]||null,o=r,i=[],s=null,a=y=>{try{let x=new Date(y);return Number.isNaN(x.getTime())?String(y||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(x)}catch{return String(y||"")}},{overlay:c,card:l,confirmBtn:d,cancelBtn:m}=Pn({title:e.title||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0431\u043B\u043E\u043A\u0430",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:e.canRestore?"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C (\u043F\u043E\u0441\u043B\u0435 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F)":"",renderBody:()=>{let y=document.createDocumentFragment(),x=document.createElement("p");if(x.className="modal-body__text",x.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0435. \u041C\u043E\u0436\u043D\u043E \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430 \u0434\u043E \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F.",y.appendChild(x),!n.length){let te=document.createElement("div");return te.className="modal-empty",te.textContent="\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430.",y.appendChild(te),y}let A=document.createElement("div");A.className="diff-layout";let I=document.createElement("div");I.className="modal-list diff-sidebar",i=[],n.forEach(te=>{let Se=document.createElement("button");Se.type="button";let tt=!!(r&&r.id===te.id);Se.className=`diff-item${tt?" diff-item--active":""}`,Se.setAttribute("aria-selected",tt?"true":"false");let Lt=a(te.timestamp);Se.textContent=Lt?`\u2260 ${Lt}`:`\u2260 ${te.id||""}`.trim(),Se.addEventListener("click",()=>{r=te,I.querySelectorAll(".diff-item").forEach(_t=>{_t.classList.remove("diff-item--active"),_t.setAttribute("aria-selected","false")}),Se.classList.add("diff-item--active"),Se.setAttribute("aria-selected","true"),Pe()}),I.appendChild(Se),i.push(Se)});let N=document.createElement("div");N.className="diff-main";let $=document.createElement("div");$.className="diff-panes diff-panes--side";let q=document.createElement("div");q.className="diff-pane-wrap";let z=document.createElement("div");z.className="diff-pane-wrap";let X=document.createElement("div");X.className="diff-pane-title",X.textContent=e.beforeTitle||"\u0414\u043E";let Q=document.createElement("div");Q.className="diff-pane-title",Q.textContent=e.afterTitle||"\u041F\u043E\u0441\u043B\u0435";let oe=document.createElement("div");oe.className="diff-pane diff-pane--before";let we=document.createElement("div");we.className="diff-pane diff-pane--after",q.appendChild(X),q.appendChild(oe),z.appendChild(Q),z.appendChild(we),$.appendChild(q),$.appendChild(z),N.appendChild($),A.appendChild(I),A.appendChild(N),y.appendChild(A);let Pe=()=>{o=r;let te=r?.beforePlain||r?.before||"",Se=r?.afterPlain||r?.after||"";oe.innerHTML="",we.innerHTML="",oe.appendChild(Vr({baseText:te,nextText:Se,mode:"before"})),we.appendChild(Vr({baseText:te,nextText:Se,mode:"after"}))};return s=Pe,Pe(),y}});l.classList.add("modal-card--fullscreen"),l.classList.add("modal-card--diff-light"),d.classList.remove("danger-btn"),!e.canRestore&&m&&(m.style.display="none"),m&&m.classList.add("danger-btn");let h=!1,b=()=>{},w=()=>{c.classList.add("modal-overlay--hide"),setTimeout(()=>c.remove(),150),document.removeEventListener("keydown",p)},f=y=>{h||(h=!0,w(),b(y))},p=y=>{if(y.code==="Escape"&&(y.preventDefault(),f(null)),y.code==="ArrowUp"||y.code==="ArrowDown"){if(!n.length)return;y.preventDefault();let x=String(r?.id||""),A=n.findIndex($=>String($?.id||"")===x);A<0&&(A=0),A=y.code==="ArrowUp"?Math.max(0,A-1):Math.min(n.length-1,A+1);let I=n[A]||null;if(!I)return;r=I;let N=i[A];if(i.forEach($=>{$.classList.remove("diff-item--active"),$.setAttribute("aria-selected","false")}),N){N.classList.add("diff-item--active"),N.setAttribute("aria-selected","true"),N.focus({preventScroll:!0});try{N.scrollIntoView({block:"nearest"})}catch{}}typeof s=="function"&&s()}};return new Promise(y=>{b=y,d.addEventListener("click",()=>f(null)),m&&e.canRestore&&m.addEventListener("click",()=>f({action:"restore",entry:o||r||null})),c.addEventListener("click",x=>{x.target===c&&f(null)}),document.addEventListener("keydown",p),t.appendChild(c),requestAnimationFrame(()=>{l.focus({preventScroll:!0})})})}function Rc(e){let t=[],n=r=>{if(!r)return;if(typeof r=="string"){t.push(r);return}if(Array.isArray(r)){r.forEach(n);return}if(typeof r!="object")return;typeof r.text=="string"&&t.push(r.text);let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(e),t.join("").replace(/\u00a0/g," ").trim()}function mf(e){return!e||typeof e!="object"?!1:!!(e.beforeHeadingJson||e.beforeBodyJson||e.afterHeadingJson||e.afterBodyJson)}function hf(e={}){let t=An(),r=(Array.isArray(e.entries)?e.entries:[]).filter(mf),o=typeof e.onRestore=="function"?e.onRestore:null,i=z=>String(z??"").replace(/\u00a0/g," ").trim(),s=r.map(z=>({...z,beforePlain:i(z.beforePlain??z.before??""),afterPlain:i(z.afterPlain??z.after??"")})),a=new Map;for(let z of s){let X=String(z?.blockId||"").trim();if(!X)continue;let Q=a.get(X)||{blockId:X,entries:[],latestAt:0,label:""};Q.entries.push(z);let oe=Date.parse(z.timestamp||"")||0;if(oe>Q.latestAt&&(Q.latestAt=oe),!Q.label){let we=Rc(z.afterHeadingJson)||Rc(z.beforeHeadingJson)||"",Pe=(z.afterPlain||z.beforePlain||"").split(`
`).map(te=>te.trim()).find(Boolean)||"";Q.label=we||Pe||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"}a.set(X,Q)}let c=Array.from(a.values()).sort((z,X)=>(X.latestAt||0)-(z.latestAt||0)),l=c[0]?.blockId||null,d=null,m=!1,h=z=>{try{let X=new Date(z);return Number.isNaN(X.getTime())?String(z||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(X)}catch{return String(z||"")}},{overlay:b,card:w,confirmBtn:f,cancelBtn:p}=Pn({title:e.title||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0441\u0442\u0430\u0442\u044C\u0438",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:e.canRestore?"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C":"",renderBody:()=>{let z=document.createDocumentFragment(),X=document.createElement("p");if(X.className="modal-body__text",X.textContent=e.message||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439 outline-\u0440\u0435\u0436\u0438\u043C\u0430. \u041C\u043E\u0436\u043D\u043E \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0435 \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0441\u0435\u043A\u0446\u0438\u0438 (\u0435\u0441\u043B\u0438 \u0441\u0435\u043A\u0446\u0438\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u2014 \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u043D\u0435\u0446 \u0441\u0442\u0430\u0442\u044C\u0438).",z.appendChild(X),!c.length){let zt=document.createElement("div");return zt.className="modal-empty",zt.textContent="\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430.",z.appendChild(zt),z}let Q=document.createElement("div");Q.className="diff-layout diff-layout--article-history";let oe=document.createElement("div");oe.className="modal-list diff-sidebar",oe.classList.add("diff-sections");let we=document.createElement("input");we.type="text",we.className="modal-input",we.placeholder="\u041F\u043E\u0438\u0441\u043A \u043F\u043E \u0438\u0441\u0442\u043E\u0440\u0438\u0438\u2026",oe.appendChild(we);let Pe=document.createElement("div");Pe.style.marginTop="8px",oe.appendChild(Pe);let te=document.createElement("div");te.className="diff-main";let Se=document.createElement("div");Se.className="diff-layout diff-layout--article-history-inner";let tt=document.createElement("div");tt.className="modal-list diff-sidebar",tt.classList.add("diff-revisions");let Lt=document.createElement("div");Lt.className="diff-panes diff-panes--side";let _t=document.createElement("div");_t.className="diff-pane-wrap";let fn=document.createElement("div");fn.className="diff-pane-wrap";let Sn=document.createElement("div");Sn.className="diff-pane-title",Sn.textContent=e.beforeTitle||"\u0414\u043E";let vn=document.createElement("div");vn.className="diff-pane-title",vn.textContent=e.afterTitle||"\u041F\u043E\u0441\u043B\u0435";let On=document.createElement("div");On.className="diff-pane diff-pane--before";let Vn=document.createElement("div");Vn.className="diff-pane diff-pane--after",_t.appendChild(Sn),_t.appendChild(On),fn.appendChild(vn),fn.appendChild(Vn),Lt.appendChild(_t),Lt.appendChild(fn),Se.appendChild(tt),Se.appendChild(Lt),te.appendChild(Se),Q.appendChild(oe),Q.appendChild(te),z.appendChild(Q);let jn=()=>{let zt=we.value.trim().toLowerCase(),Yt=zt?c.filter(Tt=>(Tt.label||"").toLowerCase().includes(zt)?!0:(Tt.entries||[]).some(At=>`${At.beforePlain||""}
${At.afterPlain||""}`.toLowerCase().includes(zt))):c;Pe.innerHTML="",Yt.forEach(Tt=>{let At=document.createElement("button");At.type="button";let Dt=Tt.blockId===l;At.className=`diff-item${Dt?" diff-item--active":""}`,At.setAttribute("aria-selected",Dt?"true":"false");let Tn=Tt.latestAt?h(new Date(Tt.latestAt).toISOString()):"",Y=Array.isArray(Tt.entries)?Tt.entries.length:0;At.textContent=`${Tt.label||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"}${Tn?` \xB7 ${Tn}`:""}${Y?` \xB7 ${Y}`:""}`,At.addEventListener("click",()=>{l=Tt.blockId,d=null,m=!1,jn(),Rn(),Hn()}),Pe.appendChild(At)}),l&&!Yt.some(Tt=>Tt.blockId===l)&&(l=Yt[0]?.blockId||null,d=null,m=!1,Rn(),Hn())},Rn=()=>{let zt=l?a.get(l):null,Yt=Array.isArray(zt?.entries)?zt.entries.slice():[];Yt.sort((At,Dt)=>(Date.parse(Dt.timestamp||"")||0)-(Date.parse(At.timestamp||"")||0));let Tt=d&&Yt.some(At=>String(At?.id||"")===String(d||""));(!m||!Tt)&&(d=Yt[0]?.id||null),tt.innerHTML="",Yt.forEach(At=>{let Dt=document.createElement("button");Dt.type="button";let Tn=String(At.id||"")===String(d||"");Dt.className=`diff-item${Tn?" diff-item--active":""}`,Dt.setAttribute("aria-selected",Tn?"true":"false");let Y=h(At.timestamp),ce=(At.afterPlain||At.beforePlain||"").slice(0,64).trim();Dt.textContent=`${Y?`\u2260 ${Y}`:`\u2260 ${At.id||""}`}${ce?` \xB7 ${ce}`:""}`,Dt.addEventListener("click",()=>{d=At.id||null,m=!0,Rn(),Hn()}),tt.appendChild(Dt)})},Hn=()=>{let zt=l?a.get(l):null,Yt=Array.isArray(zt?.entries)?zt.entries:[],Tt=Yt.find(Tn=>String(Tn?.id||"")===String(d||""))||Yt[0]||null,At=Tt?.beforePlain||"",Dt=Tt?.afterPlain||"";On.innerHTML="",Vn.innerHTML="",On.appendChild(Vr({baseText:At,nextText:Dt,mode:"before"})),Vn.appendChild(Vr({baseText:At,nextText:Dt,mode:"after"}))};return we.addEventListener("input",()=>{jn()}),jn(),Rn(),Hn(),z}});w.classList.add("modal-card--fullscreen"),w.classList.add("modal-card--diff-light"),f.classList.remove("danger-btn"),!e.canRestore&&p&&(p.style.display="none"),p&&p.classList.add("danger-btn");let y=!1,x=()=>{},A=!1,I=()=>{b.classList.add("modal-overlay--hide"),setTimeout(()=>b.remove(),150),document.removeEventListener("keydown",$)},N=z=>{y||(y=!0,I(),x(z))},$=z=>{z.code==="Escape"&&(z.preventDefault(),N(null))},q=()=>{let z=l?a.get(l):null,X=Array.isArray(z?.entries)?z.entries:[];return X.find(Q=>String(Q?.id||"")===String(d||""))||X[0]||null};return new Promise(z=>{x=z,f.addEventListener("click",()=>N(null)),p&&e.canRestore&&p.addEventListener("click",async()=>{let X=q();if(!X){ve("\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430");return}if(!o){N({action:"restore",entry:X});return}if(A)return;A=!0;let Q=p.textContent;try{p.disabled=!0,f.disabled=!0,p.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C\u2026",await o(X)}catch(oe){ve(oe?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C")}finally{A=!1,p.textContent=Q,p.disabled=!1,f.disabled=!1}}),b.addEventListener("click",X=>{X.target===b&&N(null)}),document.addEventListener("keydown",$),t.appendChild(b),requestAnimationFrame(()=>{w.focus({preventScroll:!0})})})}function ws(e={}){let t=An(),n=null,r=null,{overlay:o,card:i,confirmBtn:s,cancelBtn:a,form:c}=Pn({...e,renderBody:()=>{let f=document.createDocumentFragment();if(e.message){let I=document.createElement("p");I.className="modal-body__text",I.textContent=e.message,f.appendChild(I)}let p=document.createElement("label");p.className="modal-label",p.textContent=e.textLabel||"\u0422\u0435\u043A\u0441\u0442";let y=document.createElement("input");y.type="text",y.className="modal-input",y.placeholder=e.textPlaceholder||"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438",y.value=e.defaultText||"",y.autocomplete="off",p.appendChild(y);let x=document.createElement("label");x.className="modal-label",x.textContent=e.urlLabel||"\u0421\u0441\u044B\u043B\u043A\u0430";let A=document.createElement("input");return A.type="text",A.className="modal-input",A.placeholder=e.urlPlaceholder||"https://example.com",A.value=e.defaultUrl||"",A.autocomplete="off",x.appendChild(A),n=y,r=A,f.appendChild(p),f.appendChild(x),f}}),l=!1,d=()=>{},m=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",b)},h=f=>{l||(l=!0,m(),d(f))},b=f=>{if(f.code==="Escape"){f.preventDefault(),h(null);return}f.code==="Enter"&&!s.disabled&&(f.preventDefault(),h({text:(n?.value||"").trim(),url:(r?.value||"").trim()}))},w=()=>{let f=!!(r?.value||"").trim();s.disabled=!f};return new Promise(f=>{d=f,s.classList.remove("danger-btn"),s.textContent=e.confirmText||"OK",a.textContent=e.cancelText||"Cancel";let p=()=>{h({text:(n?.value||"").trim(),url:(r?.value||"").trim()})};c.addEventListener("submit",x=>{x.preventDefault(),s.disabled||p()}),s.addEventListener("click",p),a.addEventListener("click",()=>h(null)),o.addEventListener("click",x=>{x.target===o&&h(null)}),document.addEventListener("keydown",b);let y=x=>{x&&x.addEventListener("input",w)};y(n),y(r),w(),t.appendChild(o),requestAnimationFrame(()=>{r?(r.focus({preventScroll:!0}),r.value&&r.setSelectionRange(r.value.length,r.value.length)):i.focus({preventScroll:!0})})})}function $c(e={}){let t=An(),n=null,r=null,{overlay:o,card:i,confirmBtn:s,cancelBtn:a,form:c}=Pn({...e,renderBody:()=>{let f=document.createDocumentFragment();if(e.message){let I=document.createElement("p");I.className="modal-body__text",I.textContent=e.message,f.appendChild(I)}let p=document.createElement("label");p.className="modal-label",p.textContent="\u041F\u0430\u0440\u043E\u043B\u044C";let y=document.createElement("input");y.type="password",y.className="modal-input",y.placeholder="\u041F\u0430\u0440\u043E\u043B\u044C \u0434\u043B\u044F \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B",y.autocomplete="off",p.appendChild(y);let x=document.createElement("label");x.className="modal-label",x.textContent="\u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0430 (\u043D\u0435\u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u044C\u043D\u043E)";let A=document.createElement("input");return A.type="text",A.className="modal-input",A.placeholder="\u041D\u0430\u043F\u043E\u043C\u0438\u043D\u0430\u043D\u0438\u0435 \u043E \u043F\u0430\u0440\u043E\u043B\u0435",A.autocomplete="off",x.appendChild(A),n=y,r=A,f.appendChild(p),f.appendChild(x),f}}),l=!1,d=()=>{},m=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",b)},h=f=>{l||(l=!0,m(),d(f))},b=f=>{if(f.code==="Escape"){f.preventDefault(),h(null);return}f.code==="Enter"&&!s.disabled&&(f.preventDefault(),h({password:(n?.value||"").trim(),hint:(r?.value||"").trim()}))},w=()=>{let f=!!(n?.value||"").trim();s.disabled=!f};return new Promise(f=>{d=f,s.classList.remove("danger-btn"),s.textContent=e.confirmText||"\u0417\u0430\u0449\u0438\u0442\u0438\u0442\u044C",a.textContent=e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430";let p=()=>{s.disabled||h({password:(n?.value||"").trim(),hint:(r?.value||"").trim()})};s.addEventListener("click",p),c.addEventListener("submit",y=>{y.preventDefault(),p()}),a.addEventListener("click",()=>h(null)),o.addEventListener("click",y=>{y.target===o&&h(null)}),document.addEventListener("keydown",b),n&&n.addEventListener("input",w),w(),t.appendChild(o),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):i.focus({preventScroll:!0})})})}function gf(e={}){let t=An(),n=Array.isArray(e.items)?e.items:[],{overlay:r,card:o,confirmBtn:i,cancelBtn:s}=Pn({title:e.title||"\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432",renderBody:()=>{let h=document.createElement("div");if(!n.length){let w=document.createElement("p");return w.className="modal-body__text",w.textContent="\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432 \u043F\u0443\u0441\u0442\u0430",h.appendChild(w),h}let b=document.createElement("div");return b.className="block-trash-list",n.forEach(w=>{let f=document.createElement("div");f.className="block-trash-item";let p=w.block&&w.block.text||"",y=Dc(p),x=document.createElement("div");x.className="block-trash-item__title",x.textContent=y[0]||"(\u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A)";let A=document.createElement("div");A.className="block-trash-item__meta";let I=w.deletedAt?new Date(w.deletedAt).toLocaleString():"";A.textContent=I||"";let N=document.createElement("div");N.className="block-trash-item__info",N.appendChild(x),I&&N.appendChild(A);let $=document.createElement("button");$.type="button",$.className="primary",$.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",$.addEventListener("click",()=>{d(w)}),f.appendChild(N),f.appendChild($),b.appendChild(f)}),h.appendChild(b),h}}),a=!1,c=()=>{},l=()=>{r.classList.add("modal-overlay--hide"),setTimeout(()=>r.remove(),150),document.removeEventListener("keydown",m)},d=h=>{a||(a=!0,l(),c(h||null))},m=h=>{h.code==="Escape"&&(h.preventDefault(),d(null))};return new Promise(h=>{c=h,i.classList.remove("hidden"),i.textContent="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u043A\u043E\u0440\u0437\u0438\u043D\u0443",i.classList.add("danger-btn"),s.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",i.addEventListener("click",()=>d({action:"clear"})),s.addEventListener("click",()=>d(null)),r.addEventListener("click",b=>{b.target===r&&d(null)}),document.addEventListener("keydown",m),t.appendChild(r),requestAnimationFrame(()=>{o.focus({preventScroll:!0})})})}function yf(e={}){let t=An(),{title:n,message:r,existingTitle:o,importedTitle:i,existingCreatedAt:s,existingUpdatedAt:a,importedCreatedAt:c,importedUpdatedAt:l,allowApplyToAll:d=!0}=e||{},m=document.createElement("div");m.className="modal-overlay";let h=document.createElement("div");h.className="modal-card",h.setAttribute("role","dialog"),h.setAttribute("aria-modal","true"),h.tabIndex=-1;let b=document.createElement("div");b.className="modal-header";let w=document.createElement("h3");w.textContent=n||"\u041A\u043E\u043D\u0444\u043B\u0438\u043A\u0442 \u043F\u0440\u0438 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0438",b.appendChild(w);let f=document.createElement("div");if(f.className="modal-body",r){let oe=document.createElement("p");oe.className="modal-body__text",oe.textContent=r,f.appendChild(oe)}if(o||i){let oe=document.createElement("p");oe.className="modal-body__text",oe.innerHTML=[o?`<strong>\u0412 \u0431\u0430\u0437\u0435:</strong> ${o}`:"",i?`<strong>\u0418\u0437 \u0444\u0430\u0439\u043B\u0430:</strong> ${i}`:""].filter(Boolean).join("<br />"),f.appendChild(oe)}if(s||a||c||l){let oe=te=>{if(!te)return"";let Se=new Date(te);return Number.isNaN(Se.getTime())?te:Se.toLocaleString()},we=document.createElement("p");we.className="modal-body__text";let Pe=[];if(s||a){let te=s?oe(s):"\u2014",Se=a?oe(a):"\u2014";Pe.push(`<strong>\u0412 \u0431\u0430\u0437\u0435:</strong> \u0441\u043E\u0437\u0434\u0430\u043D\u0430 ${te}, \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430 ${Se}`)}if(c||l){let te=c?oe(c):"\u2014",Se=l?oe(l):"\u2014";Pe.push(`<strong>\u0418\u0437 \u0444\u0430\u0439\u043B\u0430:</strong> \u0441\u043E\u0437\u0434\u0430\u043D\u0430 ${te}, \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430 ${Se}`)}we.innerHTML=Pe.join("<br />"),f.appendChild(we)}let p=null;if(d){let oe=document.createElement("label");oe.className="modal-label";let we=document.createElement("input");we.type="checkbox",we.style.marginRight="0.5rem",oe.appendChild(we),oe.appendChild(document.createTextNode("\u041F\u0440\u0438\u043C\u0435\u043D\u044F\u0442\u044C \u044D\u0442\u043E \u0440\u0435\u0448\u0435\u043D\u0438\u0435 \u043A\u043E \u0432\u0441\u0435\u043C \u043A\u043E\u043D\u0444\u043B\u0438\u043A\u0442\u0430\u043C")),p=we,f.appendChild(oe)}let y=document.createElement("div");y.className="modal-footer modal-footer--stacked";let x=document.createElement("button");x.type="button",x.className="ghost",x.textContent="\u041E\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0443\u044E";let A=document.createElement("button");A.type="button",A.className="primary danger-btn",A.textContent="\u041F\u0435\u0440\u0435\u0437\u0430\u043F\u0438\u0441\u0430\u0442\u044C";let I=document.createElement("button");I.type="button",I.className="ghost",I.textContent="\u0421\u043E\u0437\u0434\u0430\u0442\u044C \u043A\u043E\u043F\u0438\u044E";let N=document.createElement("button");N.type="button",N.className="ghost",N.textContent="\u041E\u0442\u043C\u0435\u043D\u0430",y.appendChild(x),y.appendChild(A),y.appendChild(I),y.appendChild(N),h.appendChild(b),h.appendChild(f),h.appendChild(y),m.appendChild(h);let $=!1,q=()=>{},z=()=>{m.classList.add("modal-overlay--hide"),setTimeout(()=>m.remove(),150),document.removeEventListener("keydown",Q)},X=oe=>{if($)return;$=!0;let we=!!(p&&p.checked);z(),q({action:oe,applyToAll:we})},Q=oe=>{oe.code==="Escape"&&(oe.preventDefault(),X(null))};return new Promise(oe=>{q=oe,x.addEventListener("click",()=>X("keep")),A.addEventListener("click",()=>X("overwrite")),I.addEventListener("click",()=>X("copy")),N.addEventListener("click",()=>X(null)),m.addEventListener("click",we=>{we.target===m&&X(null)}),document.addEventListener("keydown",Q),t.appendChild(m),requestAnimationFrame(()=>{h.focus({preventScroll:!0})})})}function bo(e,t=""){let n=An(),r=document.createElement("div");r.className="modal-overlay image-modal";let o=document.createElement("div");o.className="image-modal__card",o.setAttribute("role","dialog"),o.setAttribute("aria-modal","true"),o.tabIndex=-1;let i=document.createElement("img");i.className="image-modal__img",i.src=e,t&&(i.alt=t),o.appendChild(i),r.appendChild(o);let s,a=()=>{s&&s()},c=l=>{l.code==="Escape"&&(l.preventDefault(),a())};s=()=>{document.removeEventListener("keydown",c),r.classList.add("modal-overlay--hide"),setTimeout(()=>r.remove(),150)},r.addEventListener("click",l=>{l.target===r&&a()}),document.addEventListener("keydown",c),n.appendChild(r),requestAnimationFrame(()=>{o.focus({preventScroll:!0})})}var Oc,cr=et(()=>{Fn();an();Oc="modal-root"});function Fc(e){if(typeof btoa=="function"){let t="";for(let n=0;n<e.length;n+=1)t+=String.fromCharCode(e[n]);return btoa(t)}if(typeof Buffer<"u")return Buffer.from(e).toString("base64");throw new Error("No base64 encoder available")}function zc(e){if(!e)return new Uint8Array(0);if(typeof atob=="function"){let t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r+=1)n[r]=t.charCodeAt(r);return n}if(typeof Buffer<"u"){let t=Buffer.from(e,"base64"),n=new Uint8Array(t.length);for(let r=0;r<t.length;r+=1)n[r]=t[r];return n}throw new Error("No base64 decoder available")}function ks(e){return typeof e=="string"&&e.startsWith(As)}async function Uc(e,t){if(!e)throw new Error("Password is required");let n=t&&t.length?zc(t):qc(16),r=ri(e||""),o=new Uint8Array(r.length+n.length);return o.set(r,0),o.set(n,r.length),{key:{raw:ri(String.fromCharCode(...o))},salt:Fc(n)}}function ri(e=""){let t=2166136261,n=16777619;for(let o=0;o<e.length;o+=1){let i=e.charCodeAt(o);t^=i,t=t*16777619>>>0,n^=i<<o%8,n=n*16777619>>>0}let r=new Uint8Array(32);for(let o=0;o<32;o+=1){let i=o<16?t:n;r[o]=i>>>o%4*8&255}return r}function qc(e){let t=new Uint8Array(e);for(let n=0;n<e;n+=1)t[n]=Math.floor(Math.random()*256);return t}async function Sf(e,t=""){if(!e)throw new Error("Missing encryption key");let n=e&&e.raw?e.raw:ri("fallback-key"),r=qc(12),i=new TextEncoder().encode(t||""),s=new Uint8Array(r.length+i.length);s.set(r,0);for(let a=0;a<i.length;a+=1){let c=n[a%n.length],l=r[a%r.length];s[r.length+a]=i[a]^c^l}return`${As}${Fc(s)}`}async function Is(e,t){if(!e)throw new Error("Missing encryption key");if(!ks(t))throw new Error("Data is not in encrypted format");let n=t.slice(As.length),r=zc(n);if(r.length<13)throw new Error("Encrypted payload is too short");let o=r.slice(0,12),i=r.slice(12),s=e&&e.raw?e.raw:ri("fallback-key"),a=new Uint8Array(i.length);for(let l=0;l<i.length;l+=1){let d=s[l%s.length],m=o[l%o.length];a[l]=i[l]^d^m}return new TextDecoder().decode(a)}async function Kc(e,t){if(!t)return!1;try{return await Is(e,t)===bf}catch{return!1}}async function Vc(e,t){if(!e)return;if(typeof e.text=="string"&&ks(e.text))try{e.text=await Is(t,e.text)}catch{e.text=""}let n=Array.isArray(e.children)?e.children:[];for(let r of n)await Vc(r,t)}async function Es(e,t){if(!(!e||!Array.isArray(e.blocks)))for(let n of e.blocks)await Vc(n,t)}async function Cs(e,t){return Sf(e,t||"")}var As,bf,So=et(()=>{As="enc-v1:",bf="memus-article-encryption-ok"});function kn(e){if(window.location.pathname===e){jc(e);return}window.history.pushState({},"",e),jc(e)}function jc(e){let t=e.match(/^\/p\/([^/?#]+)/);if(t){Ts(decodeURIComponent(t[1]));return}let n=e.match(/^\/article\/([0-9a-zA-Z-]+)/);if(n){let r=String(n[1]||"");if(r.startsWith("inbox-")){try{window.history.replaceState({},"",dn.article("inbox"))}catch{}oi("inbox");return}oi(r);return}vs()}var dn,lr=et(()=>{Ir();dn={list:"/",article:e=>`/article/${e}`,public:e=>`/p/${e}`}});var Jc=et(()=>{ir();Ln()});function Wc(){V.searchResults&&V.searchResults.classList.add("hidden")}var Yc=et(()=>{Ht();Bn();Fn();mn();lr();dr();an();Jc()});function ii(){try{localStorage.setItem(xf,JSON.stringify(u.sidebarCollapsedArticleIds||[]))}catch{}}function si(){try{localStorage.setItem(Af,JSON.stringify(u.listCollapsedArticleIds||[]))}catch{}}var xf,Af,jr=et(()=>{Ht();xf="ttree_collapsed_articles",Af="ttree_list_collapsed_articles"});function Bs(){V.articlesTabBtn&&(V.articlesTabBtn.classList.toggle("active",!u.isTrashView),V.articlesTabBtn.setAttribute("aria-pressed",u.isTrashView?"false":"true")),V.trashTabBtn&&(V.trashTabBtn.classList.toggle("active",u.isTrashView),V.trashTabBtn.setAttribute("aria-pressed",u.isTrashView?"true":"false")),V.createArticleBtn&&(V.createArticleBtn.disabled=u.isTrashView),V.sidebarNewArticleBtn&&(V.sidebarNewArticleBtn.disabled=u.isTrashView)}function ai(){Qi&&(Va(!1),V.hintPopover&&V.hintPopover.classList.add("hidden"),V.hintToggleBtn&&V.hintToggleBtn.setAttribute("aria-expanded","false"))}function wo(e){u.isSidebarMobileOpen=e,V.sidebar&&V.sidebar.classList.toggle("mobile-open",e),V.sidebarBackdrop&&V.sidebarBackdrop.classList.toggle("hidden",!e),e&&(ai(),Wc())}function xo(e){V.articleView.classList.toggle("hidden",!e),V.articleListView.classList.toggle("hidden",e),V.articleHeader&&V.articleHeader.classList.toggle("hidden",!e),e||ai(),e&&u.isTrashView&&(u.isTrashView=!1,Bs())}var ci=et(()=>{Ht();Bn();Yc();jr()});function el({renderSidebarArticleList:e,renderMainArticleList:t,setArticlesIndex:n}={}){Qc=typeof e=="function"?e:null,Ns=typeof t=="function"?t:null,Zc=typeof n=="function"?n:null}function di(){zn&&(zn.classList.remove("drop-before","drop-after","drop-inside"),zn=null)}function tl(e,t){e&&(zn&&zn!==e&&zn.classList.remove("drop-before","drop-after","drop-inside"),zn=e,zn.classList.remove("drop-before","drop-after","drop-inside"),t==="before"?zn.classList.add("drop-before"):t==="after"?zn.classList.add("drop-after"):t==="inside"&&zn.classList.add("drop-inside"))}function Ef(){Ct&&(Ct.sourceEl instanceof Element&&Ct.sourceEl.classList.remove("article-dnd-source"),typeof document<"u"&&document.body&&document.body.classList.remove("article-dnd-active"),window.removeEventListener("pointermove",Ps),window.removeEventListener("pointerup",Ao),window.removeEventListener("pointercancel",Ao),window.removeEventListener("touchmove",nl),window.removeEventListener("touchend",li),window.removeEventListener("touchcancel",li),Ct=null,di(),window.__ttreeDraggingArticleId=null)}function Gc(e){return e instanceof Element?!!(e.closest(".star-btn")||e.closest(".row-actions")):!1}function Cf(e,t){if(!t||Ct||!e.touches||e.touches.length!==1)return;let n=e.touches[0],r=e.currentTarget instanceof Element?e.currentTarget:null;Ct={pointerId:"legacy-touch",articleId:t,startX:n.clientX,startY:n.clientY,dragging:!1,lastTargetId:null,lastDropMode:null,sourceEl:r},window.__ttreeDraggingArticleId=t,typeof document<"u"&&document.body&&document.body.classList.add("article-dnd-active");try{let o=window.getSelection?window.getSelection():null;o&&!o.isCollapsed&&o.removeAllRanges()}catch{}window.addEventListener("touchmove",nl,{passive:!1}),window.addEventListener("touchend",li),window.addEventListener("touchcancel",li)}function nl(e){if(!Ct||!e.touches||e.touches.length===0)return;let t=e.touches[0];Ps({pointerId:"legacy-touch",clientX:t.clientX,clientY:t.clientY,preventDefault:()=>{e.preventDefault()}})}function li(){Ct&&Ao({pointerId:"legacy-touch"})}function vf(e,t){let n=document.elementFromPoint(e,t);if(!n)return null;let r=n.closest(".sidebar-article-item, #articleList li");return!r||!r.dataset||!r.dataset.articleId?null:r}function Tf(e,t){if(!t||Ct)return;let n=e.currentTarget instanceof Element?e.currentTarget:null;Ct={pointerId:e.pointerId,articleId:t,startX:e.clientX,startY:e.clientY,dragging:!1,lastTargetId:null,lastDropMode:null,sourceEl:n},window.__ttreeDraggingArticleId=t,typeof document<"u"&&document.body&&document.body.classList.add("article-dnd-active");try{let r=window.getSelection?window.getSelection():null;r&&!r.isCollapsed&&r.removeAllRanges()}catch{}try{e.currentTarget?.setPointerCapture?.(e.pointerId)}catch{}window.addEventListener("pointermove",Ps),window.addEventListener("pointerup",Ao),window.addEventListener("pointercancel",Ao)}function Ps(e){if(!Ct||e.pointerId!==Ct.pointerId)return;let t=e.clientX-Ct.startX,n=e.clientY-Ct.startY;if(!Ct.dragging){if(Math.hypot(t,n)<kf)return;Ct.dragging=!0,Ct.sourceEl instanceof Element&&Ct.sourceEl.classList.add("article-dnd-source")}e.preventDefault();let r=vf(e.clientX,e.clientY);if(!r||!r.dataset||!r.dataset.articleId||r.dataset.articleId===Ct.articleId){di(),Ct.lastTargetId=null,Ct.lastDropMode=null;return}let o=r.getBoundingClientRect(),i=e.clientY-o.top,s=o.height/3,a;i<s?a="before":i>o.height-s?a="after":a="inside",Ct.lastTargetId=r.dataset.articleId,Ct.lastDropMode=a,tl(r,a)}function Ao(e){if(!Ct||e.pointerId!==Ct.pointerId)return;let t=Ct;Ef(),!(!t.dragging||!t.lastTargetId||!t.lastDropMode)&&t.lastTargetId!==t.articleId&&rl(t.articleId,t.lastTargetId,t.lastDropMode)}function _s(e,t){e&&(If?e.addEventListener("pointerdown",n=>{if(n.pointerType!=="touch"||typeof n.button=="number"&&n.button!==0||Gc(n.target))return;let r=n.pointerId,o=350,i=!1,s=window.setTimeout(()=>{i=!0,Tf(n,t)},o),a=c=>{c.pointerId===r&&(i||window.clearTimeout(s),window.removeEventListener("pointerup",a,!0),window.removeEventListener("pointercancel",a,!0))};window.addEventListener("pointerup",a,!0),window.addEventListener("pointercancel",a,!0)}):e.addEventListener("touchstart",n=>{if(!n.touches||n.touches.length!==1)return;let r=n.target;if(Gc(r))return;let o=350,i=!1,s=window.setTimeout(()=>{i=!0,Cf(n,t)},o),a=()=>{i||window.clearTimeout(s),window.removeEventListener("touchend",a,!0),window.removeEventListener("touchcancel",a,!0)};window.addEventListener("touchend",a,!0),window.addEventListener("touchcancel",a,!0)},{passive:!1}))}function Ls(e){return e&&(u.articlesIndex||[]).find(t=>t.id===e)||null}function Xc(e){let t=e||null;return(u.articlesIndex||[]).filter(n=>(n.parentId||null)===t).sort((n,r)=>n.position!==r.position?n.position-r.position:new Date(n.updatedAt||0)-new Date(r.updatedAt||0))}function Bf(e,t,n,r){if(!e)return;let o=Ls(e);if(!o)return;let i=t||null,s=o.parentId||null,c=Xc(s).filter(b=>b.id!==e),l;i===s?l=c:l=Xc(i);let d=l.filter(b=>b.id!==e),m=d.length;if(n&&r&&r!=="inside"){let b=d.findIndex(w=>w.id===n);b!==-1&&(m=r==="before"?b:b+1)}r==="inside"&&(m=d.length),m<0&&(m=0),m>d.length&&(m=d.length);let h=d.slice();h.splice(m,0,o),o.parentId=i,c.forEach((b,w)=>{b.position=w}),h.forEach((b,w)=>{b.parentId=i,b.position=w})}function rl(e,t,n){if(!e||!t||!n)return;let r=Ls(e),o=Ls(t);if(!r||!o)return;let i=n==="inside"?o.id:o.parentId||null,s=n==="inside"?null:o.id;Bf(e,i,s,n),Qc?.(),Ns?.(),(async()=>{try{await bs(e,{parentId:i,anchorId:s,placement:n})}catch(a){try{let c=await Nn();Zc?.(c),Ns?.()}catch{}ve(a.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443")}})()}function Nf(e){window.__ttreeDraggingArticleId?In=window.__ttreeDraggingArticleId:In=e.currentTarget?.dataset?.articleId||null,e.dataTransfer&&(e.dataTransfer.effectAllowed="move",In&&e.dataTransfer.setData("text/plain",In))}function Mf(e){if(!In){let s=window.__ttreeDraggingArticleId,a=null;if(!s&&e?.dataTransfer)try{a=e.dataTransfer.getData("text/plain")||null}catch{a=null}In=s||a||null}if(!In||!e.currentTarget||!e.currentTarget.dataset.articleId)return;e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="move");let t=e.currentTarget,n=t.getBoundingClientRect(),r=e.clientY-n.top,o=n.height/3,i;r<o?i="before":r>n.height-o?i="after":i="inside",tl(t,i)}function Lf(e){if(!In){let a=window.__ttreeDraggingArticleId,c=null;if(!a&&e?.dataTransfer)try{c=e.dataTransfer.getData("text/plain")||null}catch{c=null}In=a||c||null}if(!In)return;let t=e.currentTarget,n=t?.dataset?.articleId||null;if(!n||n===In)return;e.preventDefault(),di();let r=t.getBoundingClientRect(),o=e.clientY-r.top,i=r.height/3,s;o<i?s="before":o>r.height-i?s="after":s="inside",rl(In,n,s),In=null}function Pf(){In=null,window.__ttreeDraggingArticleId=null,di()}function Ds(e){e&&(e.draggable=!0,e.addEventListener("dragstart",Nf),e.addEventListener("dragover",Mf),e.addEventListener("drop",Lf),e.addEventListener("dragend",Pf))}var Qc,Ns,Zc,Ms,In,zn,kf,Ct,If,Os=et(()=>{Ht();mn();an();Qc=null,Ns=null,Zc=null;Ms=!1;typeof window<"u"&&(window.matchMedia&&window.matchMedia("(pointer: coarse)").matches||"ontouchstart"in window)&&(Ms=!0);In=null,zn=null,kf=6,Ct=null,If=typeof window<"u"&&"PointerEvent"in window&&!Ms});function ol(){try{if(u.sidebarSearchView!=="list"||!V.searchInput||!!!((V.searchInput.value||"").trim()||(u.articleFilterQuery||"").trim()))return;V.searchInput.value="",u.articleFilterQuery="",V.searchInput.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}function _f(){try{let e=localStorage.getItem(sl),t=e?JSON.parse(e):[];u.favoriteArticles=Array.isArray(t)?t:[]}catch{u.favoriteArticles=[]}}function Df(){try{localStorage.setItem(sl,JSON.stringify(u.favoriteArticles||[]))}catch{}}function al(e=[]){let t=new Set(u.favoriteArticles||[]);return[...e].sort((n,r)=>{let o=t.has(n.id),i=t.has(r.id);return o!==i?o?-1:1:new Date(r.updatedAt||r.deletedAt||0)-new Date(n.updatedAt||n.deletedAt||0)})}function ui(e){if(!e)return;u.favoriteArticles||(u.favoriteArticles=[]);let t=new Set(u.favoriteArticles);t.has(e)?t.delete(e):t.add(e),u.favoriteArticles=Array.from(t),Df(),Jt(),_n()}function fi(e=[]){(!u.favoriteArticles||!u.favoriteArticles.length)&&_f();let t=Array.isArray(e)?e:[];u.articlesIndex=t.map(r=>({id:r.id,title:r.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",updatedAt:r.updatedAt||new Date().toISOString(),deletedAt:r.deletedAt||null,publicSlug:r.publicSlug||null,parentId:r.parentId||null,position:typeof r.position=="number"?r.position:0}));let n=new Set(u.articlesIndex.map(r=>r.id));Array.isArray(u.sidebarCollapsedArticleIds)&&u.sidebarCollapsedArticleIds.length&&(u.sidebarCollapsedArticleIds=u.sidebarCollapsedArticleIds.filter(r=>n.has(r)),ii()),Array.isArray(u.listCollapsedArticleIds)&&u.listCollapsedArticleIds.length&&(u.listCollapsedArticleIds=u.listCollapsedArticleIds.filter(r=>n.has(r)),si()),Jt()}function cl(e=[]){let t=al(Array.isArray(e)?e:[]);u.deletedArticlesIndex=t,Jt()}function Jr(e){if(!e||!e.id||e.deletedAt)return;let t={id:e.id,title:e.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",updatedAt:e.updatedAt||new Date().toISOString(),publicSlug:e.publicSlug||null,parentId:e.parentId||null,position:typeof e.position=="number"?e.position:0},n=u.articlesIndex.findIndex(r=>r.id===t.id);n>=0?u.articlesIndex[n]={...u.articlesIndex[n],...t}:u.articlesIndex.unshift(t),Jt()}function Rs(e){if(!e)return;let t=u.articlesIndex.length;u.articlesIndex=u.articlesIndex.filter(n=>n.id!==e),t!==u.articlesIndex.length&&(Jt(),_n())}function Hs(e){if(!e)return;let t=u.deletedArticlesIndex.length;u.deletedArticlesIndex=u.deletedArticlesIndex.filter(n=>n.id!==e),t!==u.deletedArticlesIndex.length&&(Jt(),_n())}function ll(e=[]){let t=new Map;e.forEach(o=>{t.set(o.id,{...o,children:[]})});let n=[];t.forEach(o=>{let i=o.parentId||null;i&&t.has(i)?t.get(i).children.push(o):n.push(o)});let r=o=>{o.sort((i,s)=>{let a=(u.favoriteArticles||[]).includes(i.id),c=(u.favoriteArticles||[]).includes(s.id);return a!==c?a?-1:1:i.position!==s.position?i.position-s.position:new Date(s.updatedAt||0)-new Date(i.updatedAt||0)}),o.forEach(i=>r(i.children||[]))};return r(n),n}function Jt(){if(!V.sidebarArticleList)return;V.sidebarArticleList.innerHTML="",V.backToList&&V.backToList.classList.toggle("active",u.sidebarArticlesMode!=="recent"),V.sidebarRecentBtn&&V.sidebarRecentBtn.classList.toggle("active",u.sidebarArticlesMode==="recent");let e=(u.articleFilterQuery||"").trim().toLowerCase(),t=u.sidebarArticlesMode==="recent"?"recent":"tree",n=u.isTrashView?u.deletedArticlesIndex:u.articlesIndex,r=new Set(u.favoriteArticles||[]),o=new Set(u.sidebarCollapsedArticleIds||[]),i=u.sidebarSelectedArticleId||u.articleId,s=Array.isArray(u.recentArticleIds)?u.recentArticleIds:[],a=[];if(!u.isTrashView&&(r.has("RAG")||t==="recent"&&s.includes("RAG"))){let f=(u.ragQuery||"").trim();a.push({id:"RAG",title:f?`AI: ${f}`:"AI: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B \u043F\u043E\u0438\u0441\u043A\u0430",updatedAt:new Date().toISOString(),deletedAt:null,publicSlug:null,parentId:null,position:0})}let l=new Set(a.map(f=>f.id)),d=a.length&&!u.isTrashView?[...(n||[]).filter(f=>!l.has(f.id)),...a]:n,m=new Set;(d||[]).forEach(f=>{let p=f.parentId||null;p&&m.add(p)});let h=(d||[]).filter(f=>(e?(f.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(e):!0)&&(u.isTrashView?!0:f.id!=="inbox"));if(!h.length){let f=document.createElement("li");f.className="sidebar-article-empty",f.textContent=u.isTrashView?e?"No deleted pages match the filter":"Trash is empty":e?"\u041D\u0435\u0442 \u0441\u043E\u0432\u043F\u0430\u0434\u0435\u043D\u0438\u0439":"\u041D\u0435\u0442 \u0441\u0442\u0430\u0442\u0435\u0439",V.sidebarArticleList.appendChild(f);return}if(t==="recent"){let f=new Map(h.map(I=>[I.id,I])),p=new Set(s),y=s.map(I=>f.get(I)).filter(Boolean),x=al(h.filter(I=>!p.has(I.id)));[...y,...x].forEach(I=>{let N=document.createElement("li");N.className="sidebar-article-item",N.dataset.articleId=I.id;let $=document.createElement("div");$.className="sidebar-article-row";let q=document.createElement("button");q.type="button",!u.isTrashView&&I.id===i&&q.classList.add("active");let z=r.has(I.id),X=Zt(I.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),Q=I.publicSlug?'<i class="bx bx-link-external article-public-icon" aria-hidden="true"></i>':"",oe=z?"bxs-star":"bx-star";q.innerHTML=`<span class="sidebar-article-title">${Q}${X}</span><span class="star-btn ${z?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${z?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}"><i class="bx ${oe}" aria-hidden="true"></i></span>`,q.addEventListener("click",()=>{window.__ttreeDraggingArticleId||(u.sidebarSelectedArticleId=I.id,ol(),kn(dn.article(I.id)),u.isSidebarMobileOpen&&wo(!1))});let we=q.querySelector(".star-btn");we&&we.addEventListener("click",Pe=>{Pe.stopPropagation(),ui(I.id)}),$.appendChild(q),N.appendChild($),V.sidebarArticleList.appendChild(N)});return}let b=ll(h),w=(f,p)=>{let y=document.createElement("li");y.className="sidebar-article-item",m.has(f.id)&&(y.classList.add("has-children"),o.has(f.id)&&y.classList.add("is-collapsed")),y.dataset.articleId=f.id,y.style.paddingLeft=`${p*1.25}rem`;let x=document.createElement("div");x.className="sidebar-article-row";let A=document.createElement("button");A.type="button",!u.isTrashView&&f.id===i&&A.classList.add("active");let I=r.has(f.id),N=Zt(f.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),$=f.publicSlug?'<i class="bx bx-link-external article-public-icon" aria-hidden="true"></i>':"",q=I?"bxs-star":"bx-star";A.innerHTML=`<span class="sidebar-article-title">${$}${N}</span><span class="star-btn ${I?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${I?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}"><i class="bx ${q}" aria-hidden="true"></i></span>`,A.addEventListener("click",()=>{if(window.__ttreeDraggingArticleId)return;u.sidebarSelectedArticleId=f.id,u.sidebarCollapsedArticleIds||(u.sidebarCollapsedArticleIds=[]);let X=new Set(u.sidebarCollapsedArticleIds);X.has(f.id)?X.delete(f.id):X.add(f.id),u.sidebarCollapsedArticleIds=Array.from(X),ii(),Jt()}),A.addEventListener("dblclick",X=>{X.preventDefault(),X.stopPropagation(),u.sidebarSelectedArticleId=f.id,ol(),kn(dn.article(f.id)),u.isSidebarMobileOpen&&wo(!1)});let z=A.querySelector(".star-btn");z&&z.addEventListener("click",X=>{X.stopPropagation(),ui(f.id)}),x.appendChild(A),y.appendChild(x),u.isTrashView||(Ds(y),_s(y,f.id)),V.sidebarArticleList.appendChild(y),o.has(f.id)||(f.children||[]).forEach(X=>w(X,p+1))};b.forEach(f=>w(f,0))}function _n(e=null){if(!V.articleList)return;V.articleList.innerHTML="";let t="",n=Array.isArray(e)&&e.length?e:u.isTrashView?u.deletedArticlesIndex:u.articlesIndex,r=new Set(u.favoriteArticles||[]),o=new Set(u.listCollapsedArticleIds||[]),i=u.listSelectedArticleId||u.articleId,s=new Set;if(n.forEach(d=>{let m=d.parentId||null;m&&s.add(m)}),!n.length){let d=document.createElement("li");d.textContent=u.isTrashView?t?"No deleted pages match the filter":"Trash is empty":t?"\u041D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E":"\u0421\u043F\u0438\u0441\u043E\u043A \u043F\u0443\u0441\u0442.",V.articleList.appendChild(d);return}if(u.isTrashView){n.slice().filter(d=>(t?(d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(t):!0)&&(u.isTrashView?!0:d.id!=="inbox")).forEach(d=>{let m=document.createElement("li");m.dataset.articleId=d.id,m.innerHTML=`
      <span>
        <strong>${Zt(d.title)}</strong>
      </span>
      <div class="row-actions">
        <button class="ghost restore-btn" data-id="${d.id}">\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C</button>
        <button class="ghost danger delete-btn" data-id="${d.id}">\u0423\u0434\u0430\u043B\u0438\u0442\u044C</button>
      </div>
    `;let h=m.querySelector(".restore-btn"),b=m.querySelector(".delete-btn");h&&h.addEventListener("click",async w=>{w.preventDefault(),w.stopPropagation(),await Of(d.id)}),b&&b.addEventListener("click",async w=>{w.preventDefault(),w.stopPropagation(),await Rf(d.id)}),V.articleList.appendChild(m)});return}let a=n.slice().filter(d=>(t?(d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(t):!0)&&d.id!=="inbox"),c=ll(a),l=(d,m)=>{let h=document.createElement("li");s.has(d.id)&&(h.classList.add("has-children"),o.has(d.id)&&h.classList.add("is-collapsed")),h.dataset.articleId=d.id;let b=r.has(d.id),w=Zt(d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),f=d.publicSlug?'<i class="bx bx-link-external article-public-icon" aria-hidden="true"></i>':"",p=b?"bxs-star":"bx-star";h.style.paddingLeft=`${m*1.25}rem`,h.innerHTML=`
      <span>
        <strong>${f}${w}</strong>
      </span>
      <button class="ghost star-btn ${b?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${b?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}"><i class="bx ${p}" aria-hidden="true"></i></button>
    `;let y=h.querySelector(".star-btn");y&&y.addEventListener("click",x=>{x.preventDefault(),x.stopPropagation(),ui(d.id)}),d.id===i&&h.classList.add("active-article"),h.addEventListener("click",()=>{if(window.__ttreeDraggingArticleId)return;u.listSelectedArticleId=d.id,u.listCollapsedArticleIds||(u.listCollapsedArticleIds=[]);let x=new Set(u.listCollapsedArticleIds);x.has(d.id)?x.delete(d.id):x.add(d.id),u.listCollapsedArticleIds=Array.from(x),si(),_n()}),h.addEventListener("dblclick",x=>{x.preventDefault(),x.stopPropagation(),u.listSelectedArticleId=d.id,kn(dn.article(d.id))}),V.articleList.appendChild(h),u.isTrashView||(Ds(h),_s(h,d.id)),o.has(d.id)||(d.children||[]).forEach(x=>l(x,m+1))};c.forEach(d=>l(d,0))}async function Of(e){if(e)try{let t=await Lc(e);Hs(e),Jr(t),await dl(!1),kn(dn.article(t.id)),ve("Page restored")}catch(t){ve(t.message)}}async function Rf(e){if(e)try{await Mc(e,{force:!0}),Hs(e),ve("\u0421\u0442\u0430\u0442\u044C\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u0431\u0435\u0437\u0432\u043E\u0437\u0432\u0440\u0430\u0442\u043D\u043E"),_n(),Jt()}catch(t){ve(t.message)}}async function dl(e){u.isTrashView=e,Bs(),e?await pi():await ko(),Jt(),_n()}async function ko(){if(u.articlesIndex.length)return u.isTrashView||Jt(),u.articlesIndex;let e=await Nn();return fi(e),e}async function pi(){if(u.deletedArticlesIndex.length)return u.isTrashView&&Jt(),u.deletedArticlesIndex;let e=await vc();return cl(e),e}var sl,mi=et(()=>{Ht();Bn();Fn();lr();mn();an();ci();jr();Os();sl="ttree_favorites"});function Ff(){try{let e=Array.isArray(u.recentArticleIds)?u.recentArticleIds:[];window.localStorage.setItem($f,JSON.stringify(e.slice(0,ul)))}catch{}}function hi(e){if(!e||e==="inbox"||u.isPublicView)return;let t=Array.isArray(u.recentArticleIds)?u.recentArticleIds:[],n=[e,...t.filter(r=>r!==e)];u.recentArticleIds=n.slice(0,ul),Ff(),u.sidebarArticlesMode==="recent"&&Jt()}var $f,ul,$s=et(()=>{Ht();mi();jr();$f="ttree_recent_articles",ul=300});var dr=et(()=>{Bn();Ht();$s();jr();ci();Os();mi();jr();$s();ci();mi();el({renderSidebarArticleList:Jt,renderMainArticleList:_n,setArticlesIndex:fi})});function Uf(e){u.articleId&&(u.articleEncryptionKeys||(u.articleEncryptionKeys={}),e?u.articleEncryptionKeys[u.articleId]=e:delete u.articleEncryptionKeys[u.articleId])}async function fl(e){if(!e||!e.encrypted)return e;let t=u.articleEncryptionKeys?.[e.id]||null;if(t)return await Es(e,t),e;let n=0;for(;;){n+=1;let r=null;try{let o=e.encryptionHint||"",i="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C \u0434\u043B\u044F \u044D\u0442\u043E\u0439 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B.",s=o?`${i}
\u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0430: ${o}`:i;r=await ar({title:"\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430",message:s,confirmText:"\u041E\u0442\u043A\u0440\u044B\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"\u041F\u0430\u0440\u043E\u043B\u044C",inputType:"password"})}catch{r=window.prompt("\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430. \u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C:")||""}if(!r)throw new Error("\u041F\u0430\u0440\u043E\u043B\u044C \u043D\u0435 \u0432\u0432\u0435\u0434\u0451\u043D");try{let{key:o}=await Uc(r,e.encryptionSalt||"");if(!await Kc(o,e.encryptionVerifier||"")){if(n>=3)throw new Error("\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C");window.alert("\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C, \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437.");continue}return await Es(e,o),Uf(o),e}catch(o){if(n>=3)throw new Error(o.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");window.alert("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443, \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437.")}}}var Fs=et(()=>{Ht();mn();an();cr();Fn();So();dr();yo()});function Kf(e,t){if(!t.length)return;let n=document.createElement("div");n.className="diff-images",t.forEach(r=>{let o=document.createElement("div");o.className=`diff-image-card diff-image-card--${r.type}`;let i=document.createElement("div");i.className="diff-image-card__label",i.textContent=r.type==="added"?"\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E":"\u0423\u0434\u0430\u043B\u0435\u043D\u043E";let s=document.createElement("img");s.src=r.src,s.alt=r.alt||"",o.append(i,s),n.appendChild(o)}),e.appendChild(n)}function Vf(e,t,n,r=[]){let o=document.createElement("div");o.className="diff-inline";let i=document.createElement("div");i.className="diff-inline__content",n.forEach(a=>{let c=document.createElement("span");a.type==="added"?c.className="diff-inline__segment diff-inline__segment--added":a.type==="removed"&&(c.className="diff-inline__segment diff-inline__segment--removed"),c.textContent=a.value,i.appendChild(c)}),Kf(i,r);let s=document.createElement("div");s.className="diff-inline__hint",s.textContent=t==="undo"?"\u041F\u043E\u0432\u0442\u043E\u0440\u043D\u043E \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Ctrl+Z, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C \u043E\u0442\u043C\u0435\u043D\u0443":"\u041F\u043E\u0432\u0442\u043E\u0440\u043D\u043E \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Ctrl+Y, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C \u043F\u043E\u0432\u0442\u043E\u0440",o.append(i,s),e.innerHTML="",e.appendChild(o)}function pl(){let e=u.pendingTextPreview;if(!e)return;let t=document.querySelector(`.block[data-block-id="${e.blockId}"] .block-text`);t&&Vf(t,e.mode,e.chunks,e.imageDiff||[])}function ml(e){gi({restoreDom:!1});let t=n=>({type:"text",blockId:n.blockId,historyEntryId:n.id});u.undoStack=(e.history||[]).map(t),u.redoStack=(e.redoHistory||[]).map(t)}function Wr(e){e&&(ln("pushUndoEntry",e),u.undoStack.push(e),u.redoStack=[])}function Io(e){try{return JSON.parse(JSON.stringify(e||{}))}catch{return null}}function jf(e){if(!e||!u.article||!Array.isArray(u.article.blocks))return;let t=!1,n=r=>{if(Array.isArray(r))for(let o=0;o<r.length;o+=1){let i=r[o];if(i){if(i===e)if(!t)t=!0;else{r.splice(o,1),o-=1;continue}Array.isArray(i.children)&&i.children.length&&n(i.children)}}};n(u.article.blocks)}async function Jf(e){e&&(await zs(e),ur(e))}function gi({restoreDom:e=!0}={}){let t=u.pendingTextPreview;if(t){if(e){let n=document.querySelector(`.block[data-block-id="${t.blockId}"] .block-text`);n&&(n.innerHTML=t.originalHTML)}u.pendingTextPreview=null}}async function hl(e,t=null,n=null,r={}){if(!e)return{success:!1};let{skipRecord:o=!1,anchorId:i=null,placement:s=null,suppressRerender:a=!1}=r,c=Et(e);if(!c)return ve("\u0411\u043B\u043E\u043A \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D"),{success:!1};let l=c.parent?.id||null,d=c.index??0,m=t?Et(t)?.block:null,h=m?m.children?.length||0:(u.article?.blocks||[]).length,b=typeof n=="number"&&n>=0?Math.min(n,h):h;if(l===t&&d===b)return{success:!0,noOp:!0,from:{parentId:l,index:d},to:{parentId:t,index:b}};let w=b;t===l&&d<w&&(w=Math.max(w-1,0));try{let f=await Nt(`/api/articles/${u.articleId}/blocks/${e}/relocate`,{method:"POST",body:JSON.stringify({parentId:t||null,index:w,anchorId:i||null,placement:s||null})});if(u.article&&Array.isArray(u.article.blocks)){let y=c.siblings||u.article.blocks,x=c.index??y.findIndex($=>$.id===e),A=null;x>=0&&([A]=y.splice(x,1)),A||(A=c.block);let I;if(t){let $=Et(t);$&&$.block?(Array.isArray($.block.children)||($.block.children=[]),I=$.block.children):I=u.article.blocks}else I=u.article.blocks;let N=typeof w=="number"&&w>=0?Math.min(w,I.length):I.length;if(I.splice(N,0,A),jf(A),u.article.updatedAt)try{u.article.updatedAt=new Date().toISOString()}catch{}}u.currentBlockId=e;let p=f?.parentId??t??null;return a||(l&&p?(await hn(l),p!==l&&await hn(p)):l&&!p?Wt("undo.moveBlockToParent.toRoot.fullRender"):!l&&p?Wt("undo.moveBlockToParent.fromRoot.fullRender"):Wt("undo.moveBlockToParent.rootReorder.fullRender")),o||Wr({type:"structure",action:{kind:"reorder",blockId:e,fromParentId:l,fromIndex:d,toParentId:f?.parentId??t??null,toIndex:f?.index??w}}),await Jf(e),{success:!0,from:{parentId:l,index:d},to:{parentId:f?.parentId??t??null,index:f?.index??w}}}catch(f){return ve(f.message),{success:!1}}}var Er=et(()=>{Ht();mn();an();Ir();Ir();Un();Fn();So()});function Xf(){try{return window?.localStorage?.getItem?.(Yf)==="1"}catch{return!1}}function yl(){try{return window?.localStorage?.getItem?.(Gf)==="1"}catch{return!1}}function Yr(...e){try{if(!Xf())return;console.log("[article-load]",...e)}catch{}}function Qf(e){try{let t=e?.content;if(!Array.isArray(t))return null;for(let n of t)if(n?.type==="outlineSection"){let r=String(n?.attrs?.id||"");if(r)return r}return null}catch{return null}}async function Wn(e,t={}){let{desiredBlockId:n,resetUndoStacks:r,editBlockId:o}=t,i=u.articleId!==e;if(Yr("load.start",{id:e,switchingArticle:i,mode:u.mode,isOutlineEditing:u.isOutlineEditing}),i)try{let h=u.articleId,b=await Promise.resolve().then(()=>(bi(),yi));try{let w=b?.getOutlineActiveSectionSnapshot?.()||null;if(h&&w?.sectionId){let f=window?.localStorage?.getItem?.(gl)||"{}",p=JSON.parse(f||"{}"),y=p&&typeof p=="object"?p:{};y[String(h)]={sectionId:w.sectionId,collapsed:!!w.collapsed,savedAt:new Date().toISOString()},window?.localStorage?.setItem?.(gl,JSON.stringify(y))}}catch{}b?.flushOutlineAutosave&&await b.flushOutlineAutosave({mode:"queue"}),b?.closeOutlineEditor&&b.closeOutlineEditor()}catch{}u.articleId=e,u.isEditingTitle=!1,u.pendingTextPreview=null,u.article=null,u.currentBlockId=null;let s=performance.now(),a=await Tc(e);yl()&&console.log("[perf][article-load] fetchArticle",{id:e,ms:Math.round(performance.now()-s)}),Yr("load.fetched",{id:e,ms:Math.round(performance.now()-s),hasDocJson:!!a?.docJson,docContent:Array.isArray(a?.docJson?.content)?a.docJson.content.length:null,blocksCount:Array.isArray(a?.blocks)?a.blocks.length:null,updatedAt:a?.updatedAt});let c=a;try{c=await fl(a)}catch(h){throw ve(h.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u0443\u044E \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443"),h}u.article=c,(typeof r=="boolean"?r:i)&&ml(c);let d=n||o||u.pendingEditBlockId||null;u.pendingEditBlockId=null;let m=Qf(c.docJson)||c.blocks?.[0]?.id||null;if(u.currentBlockId=d||m,u.mode="view",u.editingBlockId=null,Jr(c),_c(),!u.isPublicView&&!u.isRagView&&!c.encrypted)try{let h=await Promise.resolve().then(()=>(bi(),yi));if(h?.openOutlineEditor){Yr("outline.open.start",{id:e});let b=yl()?performance.now():0;h.openOutlineEditor(),b&&console.log("[perf][article-load] outline.open scheduled",{id:e,ms:Math.round(performance.now()-b)}),Yr("outline.open.scheduled",{id:e,isOutlineEditing:u.isOutlineEditing})}}catch(h){u.isOutlineEditing=!1,Yr("outline.open.failed",{id:e,message:h?.message||String(h||"error")}),ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C outline-\u0440\u0435\u0436\u0438\u043C (\u0441\u043C. \u043A\u043E\u043D\u0441\u043E\u043B\u044C)")}return Yr("load.done",{id:e,currentBlockId:u.currentBlockId}),c}var Yf,Gf,gl,Us=et(()=>{Ht();mn();Er();an();dr();Fs();yo();Yf="ttree_debug_article_load_v1",Gf="ttree_profile_v1",gl="ttree_outline_last_active_v1"});var bl=et(()=>{Fn();Un()});function Zf(e){if(!e)return;e.focus({preventScroll:!0});let t=window.getSelection&&window.getSelection();if(!t)return;t.removeAllRanges();let n=document.createRange();n.selectNodeContents(e),n.collapse(!1),t.addRange(n)}async function qs(e){return!u.article||!u.article.encrypted||!u.articleEncryptionKey?e:Cs(u.articleEncryptionKey,e)}async function wl(){if(!u.currentBlockId||u.isRagView)return;let e=u.currentBlockId;u.editingScrollTop=V.blocksContainer?V.blocksContainer.scrollTop:null,u.mode="edit",u.scrollTargetBlockId=null,u.editingBlockId=u.currentBlockId,u.editingInitialText=Et(u.currentBlockId)?.block.text||"",u.editingUndo=null,await hn(e);let t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`);if(t||(Wt("actions.startEditing.fallback.fullRender"),await hn(e),t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`)),!t){u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.editingUndo=null,u.currentBlockId=e,ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430");return}Zf(t)}async function xl(){if(u.mode!=="edit"||!u.editingBlockId)return;let e=u.editingBlockId,t=Et(e),n=t?.block.text||"",o=document.querySelector(`.block[data-block-id="${u.editingBlockId}"] .block-text`)?.innerHTML||"",{cleanupEditableHtml:i}=await Promise.resolve().then(()=>(Un(),Js)),s=i(o);if(!(s||"").trim()){let c=wi(e),l=Et(e),d=!!(l?.block&&l.block.__isNew);if(l&&u.article&&Array.isArray(u.article.blocks)){let m=l.siblings||u.article.blocks,h=l.index??m.findIndex(b=>b&&b.id===e);if(h>=0&&m.splice(h,1),u.article.updatedAt)try{u.article.updatedAt=new Date().toISOString()}catch{}if(!d){let b=Io(l.block);Vs(b,l.parent?.id||null,l.index??null)}}u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.currentBlockId=c,u.scrollTargetBlockId=c,Si(e),Wt("actions.saveEditing.empty.delete.localRender"),(async()=>{try{let m=d?`/api/articles/${u.articleId}/blocks/${e}/permanent`:`/api/articles/${u.articleId}/blocks/${e}`,h=await Nt(m,{method:"DELETE"});if(!d&&h?.block){let b=Io(h.block);Wr({type:"structure",action:{kind:"delete",parentId:h.parentId||null,index:h.index??null,block:b,blockId:b?.id,fallbackId:c}})}ve("\u041F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A \u0443\u0434\u0430\u043B\u0451\u043D")}catch(m){ve(m.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Wn(u.articleId,{desiredBlockId:c||null}),Wt("actions.saveEditing.empty.delete.reloadAfterError")}catch{}}})();return}if(s===n){u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.editingUndo=null,u.pendingEditBlockId=null,u.currentBlockId=e,u.scrollTargetBlockId=e,await hn(e);return}if(t&&u.article&&Array.isArray(u.article.blocks)&&(t.block.text=s,u.article.updatedAt))try{u.article.updatedAt=new Date().toISOString()}catch{}u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.editingUndo=null,u.pendingEditBlockId=null,u.currentBlockId=e,u.scrollTargetBlockId=e,await hn(e),(async()=>{try{let c=await qs(s),l=await Nt(`/api/articles/${u.articleId}/blocks/${e}`,{method:"PATCH",body:JSON.stringify({text:c})});n!==s&&(!!(t?.block&&t.block.__isNew)?delete t.block.__isNew:Wr({type:"text",blockId:e,historyEntryId:l?.historyEntryId||null})),ve("\u0411\u043B\u043E\u043A \u043E\u0431\u043D\u043E\u0432\u043B\u0451\u043D")}catch(c){ve(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Wn(u.articleId,{desiredBlockId:e}),Wt("actions.saveEditing.patchError.reload")}catch{}}})()}async function Al(){if(u.mode!=="edit"||!u.editingBlockId)return;let e=u.editingBlockId,r=!(document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`)?.textContent||"").replace(/\u00a0/g," ").trim();if(u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.editingUndo=null,r){let o=wi(e),i=Et(e),s=!!(i?.block&&i.block.__isNew);if(i&&u.article&&Array.isArray(u.article.blocks)){let c=i.siblings||u.article.blocks,l=i.index??c.findIndex(d=>d&&d.id===e);if(l>=0&&c.splice(l,1),u.article.updatedAt)try{u.article.updatedAt=new Date().toISOString()}catch{}}u.currentBlockId=o,u.scrollTargetBlockId=o,Si(e);let a=i?.parent?.id||null;a?await hn(a):Wt("actions.cancelEditing.empty.delete.localRender"),(async()=>{try{let c=s?`/api/articles/${u.articleId}/blocks/${e}/permanent`:`/api/articles/${u.articleId}/blocks/${e}`,l=await Nt(c,{method:"DELETE"});if(!s&&l?.block){let d=Io(l.block);Wr({type:"structure",action:{kind:"delete",parentId:l.parentId||null,index:l.index??null,block:d,blockId:d?.id,fallbackId:o}})}}catch(c){ve(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Wn(u.articleId,{desiredBlockId:o||null}),Wt("actions.cancelEditing.empty.delete.reloadAfterError")}catch{}}})();return}u.currentBlockId=e,await hn(e)}async function kl(){if(u.mode!=="edit"||!u.editingBlockId)return;let e=u.editingBlockId,t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`);if(!t)return;let n=window.getSelection();if(!n||n.rangeCount===0||!t.contains(n.anchorNode))return;let r=n.getRangeAt(0).cloneRange(),o=document.createElement("span"),i=`split-marker-${Date.now()}-${Math.random().toString(16).slice(2)}`;o.setAttribute("data-split-marker",i),o.textContent="",r.insertNode(o);let s=t.innerHTML;o.parentNode.removeChild(o);let a=`<span data-split-marker="${i}"></span>`,c=s.split(a);if(c.length!==2)return;let[l,d]=c,{cleanupEditableHtml:m}=await Promise.resolve().then(()=>(Un(),Js)),h=m(l||""),b=m(d||"");if(!(!b||b===h))try{let w=Et(e),f=w?.block,p=f?Io(f):null,y=await qs(h);await Nt(`/api/articles/${u.articleId}/blocks/${e}`,{method:"PATCH",body:JSON.stringify({text:y})});let A=(await Nt(`/api/articles/${u.articleId}/blocks/${e}/siblings`,{method:"POST",body:JSON.stringify({direction:"after"})}))?.block?.id;if(!A){ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043D\u043E\u0432\u044B\u0439 \u0431\u043B\u043E\u043A");return}let I=await qs(b);if(await Nt(`/api/articles/${u.articleId}/blocks/${A}`,{method:"PATCH",body:JSON.stringify({text:I})}),w&&u.article&&Array.isArray(u.article.blocks)){w.block.text=h;let $=w.parent,q=w.siblings||u.article.blocks||[],z=(w.index??0)+1,X={id:A,text:b,children:[],collapsed:!1};if(q.splice(z,0,X),u.article.updatedAt)try{u.article.updatedAt=new Date().toISOString()}catch{}}u.mode="edit",u.editingBlockId=A,u.pendingEditBlockId=null,u.currentBlockId=A,u.scrollTargetBlockId=A,u.editingCaretPosition="start";let N=w?.parent?.id||null;N?await hn(N):Wt(),p&&Wr({type:"text",blockId:e,block:p})}catch(w){ve(w.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0437\u0431\u0438\u0442\u044C \u0431\u043B\u043E\u043A")}}var Ks=et(()=>{Ht();mn();Bn();an();Ir();Ir();Er();Un();bl();Fn();So()});function Tl(){if(!$t||!Co()||$t.pointerType==="mouse")return;let e=window.getSelection?window.getSelection():null;if(!(!e||e.isCollapsed))try{e.removeAllRanges()}catch{}}function op(){xi||(document.addEventListener("selectionchange",Tl),xi=!0)}function ip(){xi&&(document.removeEventListener("selectionchange",Tl),xi=!1)}function Co(){return!!(u.isDragModeEnabled&&u.mode==="view"&&u.articleId!=="inbox")}function Bl(e){return e instanceof Element?!!e.closest(rp):!1}function Nl(){if($t){window.removeEventListener("pointermove",Dl),window.removeEventListener("pointerup",Ai),window.removeEventListener("pointercancel",Ai);try{$t.sourceEl?.releasePointerCapture?.($t.pointerId)}catch{}$t=null,ip(),cp()}}function sp(e,t,n,{bypassInteractiveCheck:r=!1}={}){if(!u.article||!u.isDragModeEnabled||!Co()||e.pointerType==="mouse"&&e.button!==0||!r&&Bl(e.target))return;let o=Et(t);if(o){$t={pointerType:e.pointerType||"mouse",blockId:t,pointerId:e.pointerId,originParentId:o.parent?.id||null,originIndex:o.index??0,startX:e.clientX,startY:e.clientY,dragging:!1,forbidden:Ll(o.block),lastDrop:null,sourceEl:n};try{n?.setPointerCapture?.(e.pointerId)}catch{}window.addEventListener("pointermove",Dl),window.addEventListener("pointerup",Ai),window.addEventListener("pointercancel",Ai),op()}}function Ml(e,t,{allowInteractive:n=!1}={}){e&&e.addEventListener("pointerdown",r=>{if(!n&&Bl(r.target))return;(r.pointerType==="touch"||r.pointerType==="pen")&&Co()&&r.preventDefault(),sp(r,t,e,{bypassInteractiveCheck:n})})}function Gr(){let e=!!u.article,t=V.dragModeToggleBtn;if(t){t.disabled=!e,t.classList.toggle("active",!!u.isDragModeEnabled),t.setAttribute("aria-pressed",u.isDragModeEnabled?"true":"false");let o=u.isDragModeEnabled?"\u041F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435 \u0431\u043B\u043E\u043A \u0437\u0430 \u0435\u0433\u043E \u043F\u043E\u0432\u0435\u0440\u0445\u043D\u043E\u0441\u0442\u044C":"\u0412\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0440\u0435\u0436\u0438\u043C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u044F \u0431\u043B\u043E\u043A\u043E\u0432";e?u.articleId==="inbox"?o="\u041F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0432 \u0431\u044B\u0441\u0442\u0440\u044B\u0445 \u0437\u0430\u043C\u0435\u0442\u043A\u0430\u0445":u.mode!=="view"&&(o="\u041F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043C\u043E\u0436\u043D\u043E \u0442\u043E\u043B\u044C\u043A\u043E \u0432 \u0440\u0435\u0436\u0438\u043C\u0435 \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440\u0430"):o="\u041E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E, \u0447\u0442\u043E\u0431\u044B \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0442\u044C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435\u043C",t.title=o}let n=Co();[V.articleView,V.blocksContainer].forEach(o=>{o&&o.classList.toggle("drag-mode-enabled",n)}),document.body.classList.toggle("drag-mode-enabled",n)}function Ll(e,t=new Set){return e&&(t.add(e.id),(e.children||[]).forEach(n=>Ll(n,t))),t}function ap(){if(Eo)return Eo;let e=document.createElement("div");return e.className="block-drop-line hidden",document.body.appendChild(e),Eo=e,e}function cp(){Eo&&Eo.classList.add("hidden"),gn&&(gn.classList.remove("drop-inside-target"),gn=null),Cr&&(Cr.remove(),Cr=null),document.body.classList.remove("block-dnd-active")}function lp(e){Cr&&(Cr.style.left=`${e.clientX+12}px`,Cr.style.top=`${e.clientY+12}px`)}function dp(e){let t=document.createElement("div");t.className="block-drag-preview";let n=V.blocksContainer?.querySelector(`.block[data-block-id="${e}"]`),r=n?.querySelector(".block-title")?.textContent?.trim(),o=n?.querySelector(".block-text")?.textContent?.trim();t.textContent=r||o||"\u0411\u043B\u043E\u043A",document.body.appendChild(t),Cr=t}function Pl(){return Dn&&Dn.isConnected?(V.blocksContainer&&Dn.parentNode!==V.blocksContainer&&V.blocksContainer.appendChild(Dn),Dn):(Dn=document.createElement("div"),Dn.className="drag-layer",V.blocksContainer&&(V.blocksContainer.appendChild(Dn),Il||(V.blocksContainer.addEventListener("scroll",El,{passive:!0}),window.addEventListener("resize",El,{passive:!0}),Il=!0)),Dn)}function _l(){vl.clear(),Dn&&(Dn.innerHTML="")}function El(){let e=V.blocksContainer;if(!e||!Dn)return;let t=e.getBoundingClientRect(),n=e.scrollTop;vl.forEach(({handle:r,blockEl:o})=>{let i=o.getBoundingClientRect(),s=o.querySelector(".block-header__left"),a=o.querySelector(".block-header"),c=o.querySelector(".collapse-btn"),l=s?.getBoundingClientRect(),d=a?.getBoundingClientRect(),m=c?.getBoundingClientRect(),h=(l&&l.height>0?l:null)||(d&&d.height>0?d:null)||(m&&m.height>0?m:null)||i,b=h.top-t.top+n+h.height/2;r.style.top=`${b}px`,r.style.right="8px"})}function up(e){let t=ap();if(!e){t.classList.add("hidden"),gn&&(gn.classList.remove("drop-inside-target"),gn=null);return}if(e.placement==="inside"){t.classList.add("hidden"),gn&&gn.dataset.blockId!==e.targetId&&gn.classList.remove("drop-inside-target"),gn=V.blocksContainer?.querySelector(`.block[data-block-id="${e.targetId}"]`)||null,gn&&gn.classList.add("drop-inside-target");return}gn&&(gn.classList.remove("drop-inside-target"),gn=null),t.classList.remove("hidden");let n=e.placement==="before"?e.rect.top:e.rect.top+e.rect.height,r=Math.min(e.depth*Cl,e.rect.width-32),o=e.rect.left+r,i=Math.max(e.rect.width-r,48);t.style.top=`${n}px`,t.style.left=`${o}px`,t.style.width=`${i}px`}function fp(e,t){if(!V.blocksContainer||!$t)return null;let r=Array.from(V.blocksContainer.querySelectorAll(".block")).filter(A=>{let I=A.dataset.blockId;return I&&!$t.forbidden.has(I)});if(!r.length)return null;let o=null,i=1/0;if(r.forEach(A=>{let I=A.getBoundingClientRect(),N=I.top+I.height/2,$=Math.abs(t-N);$<i&&(i=$,o=A)}),!o)return null;let s=o.getBoundingClientRect(),a=s.height>0?(t-s.top)/s.height:.5,c=a<tp?"before":a>np?"after":"inside",l=o.dataset.blockId,d=Et(l);if(!d)return null;let m=(d.ancestors||[]).length,h=c==="inside"?l:d.parent?.id||null;if($t.forbidden.has(h||""))return null;let b=l,w=h,f=c,p=s,y=c==="inside"?m+1:m,x=f==="after"?d.index+1:d.index;if(f!=="inside"&&d.parent){let A=d,I=s,N=s.left+Cl;for(;A.parent;){let $=e<=N,q=t<=I.top||t>=I.bottom;if(!$&&!q)break;let z=Et(A.parent.id);if(!z)break;let Q=V.blocksContainer?.querySelector(`.block[data-block-id="${z.block.id}"]`)?.getBoundingClientRect();A=z,I=Q||I,b=A.block.id,p=I,y=(A.ancestors||[]).length,w=A.parent?.id||null,x=f==="after"?A.index+1:A.index}}return{targetId:b,placement:f,parentId:w,index:x,depth:y,rect:p}}function pp(e){if(!V.blocksContainer)return;let t=V.blocksContainer.getBoundingClientRect(),n=60;e.clientY<t.top+n?V.blocksContainer.scrollTop-=12:e.clientY>t.bottom-n&&(V.blocksContainer.scrollTop+=12)}function Dl(e){if(!$t||e.pointerId!==$t.pointerId)return;if(!Co()){Nl();return}let t=e.clientX-$t.startX,n=e.clientY-$t.startY;if(!$t.dragging){if(Math.hypot(t,n)<ep)return;$t.dragging=!0;let o=$t.pointerType||e.pointerType||"mouse";(o==="touch"||o==="pen")&&document.body.classList.add("block-dnd-active"),dp($t.blockId)}e.preventDefault(),lp(e);let r=fp(e.clientX,e.clientY);$t.lastDrop=r,up(r),pp(e)}async function Ai(e){if(!$t||e.pointerId!==$t.pointerId)return;let t=$t;Nl();let n=t.dragging&&t.lastDrop,r=t.lastDrop,o=t.blockId;!n||!r||await hl(o,r.parentId||null,r.index,{anchorId:r.targetId,placement:r.placement})}var ep,Cl,tp,np,rp,$t,Eo,gn,Cr,Dn,vl,Il,xi,vo=et(()=>{Ht();Bn();Un();Er();an();ep=6,Cl=20,tp=.35,np=.65,rp='button, a, input, textarea, select, [contenteditable="true"], .block-edit-actions, .move-block-btn, .collapse-btn',$t=null,Eo=null,gn=null,Cr=null,Dn=null,vl=new Map,Il=!1,xi=!1});function Rl(){try{return window?.localStorage?.getItem?.(mp)==="1"}catch{return!1}}function gp(){try{let e=window?.localStorage?.getItem?.(hp);return e==="0"?!1:e==="1"?!0:Rl()}catch{return!1}}function yp(e){try{let t=String(e||""),n=2166136261;for(let r=0;r<t.length;r+=1)n^=t.charCodeAt(r),n=Math.imul(n,16777619);return(n>>>0).toString(16)}catch{return"0"}}function bp(e){try{let t=window?.localStorage?.getItem?.(Ol)||"",n=t?JSON.parse(t):[],r=Array.isArray(n)?n:[];r.push(e);let o=r.length>250?r.slice(r.length-250):r;window?.localStorage?.setItem?.(Ol,JSON.stringify(o))}catch{}}function ki(e,t={}){try{let n={t:new Date().toISOString(),kind:String(e||"event"),data:t&&typeof t=="object"?t:{value:t}};if(bp(n),gp()&&console.log(`[client] ${n.kind}`,n.data),Rl()&&navigator.onLine!==!1)try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:`client:${n.kind}`,data:n})}).catch(()=>{})}catch{}return!0}catch{return!1}}function Ii(e){try{let t=typeof e=="string"?e:String(e?.stack||""),r=t.split(`
`).map(s=>s.trim()).filter(Boolean).filter(s=>!s.includes("stackSummary")&&!s.includes("clientLog")),o=r.slice(0,6).join(`
`),i=yp(r.slice(0,20).join(`
`));return{top:o,hash:i,bytes:t.length,raw:t.slice(0,1600)}}catch{return{top:"",hash:"0",bytes:0,raw:""}}}var mp,hp,Ol,Ws=et(()=>{mp="ttree_client_log_v1",hp="ttree_client_log_console_v1",Ol="ttree_client_event_log_v1"});function Hl(e){Gs=typeof e=="function"?e:null}function Sp(e){let t=new Set,n=r=>{if(Array.isArray(r))for(let o=0;o<r.length;o+=1){let i=r[o];if(!i||!i.id){r.splice(o,1),o-=1;continue}if(t.has(i.id)){r.splice(o,1),o-=1;continue}t.add(i.id),Array.isArray(i.children)&&i.children.length&&n(i.children)}};n(e)}function $l(){if(!V.blocksContainer)return;let e=new Set;V.blocksContainer.querySelectorAll(".block[data-block-id]").forEach(n=>{let r=n.getAttribute("data-block-id");if(r)if(e.has(r)){let o=n.parentNode;o&&o.removeChild(n)}else e.add(r)})}function Fl(){if(!V.blocksContainer||!u.article||!Array.isArray(u.article.blocks))return;let e=Yn(u.article.blocks),t=new Set(e.map(r=>r.id));V.blocksContainer.querySelectorAll(".block[data-block-id]").forEach(r=>{let o=r.getAttribute("data-block-id");if(o&&!t.has(o)){let i=r.parentNode;i&&i.removeChild(r)}})}function Vs(e,t,n,r){if(!u.article||!e||!e.id)return;let o=Array.isArray(u.article.blockTrash)?u.article.blockTrash:[],i=r||new Date().toISOString();o.push({id:e.id,block:e,parentId:t||null,index:typeof n=="number"?n:null,deletedAt:i}),u.article.blockTrash=o}function Si(e){if(!e||!V.blocksContainer)return;V.blocksContainer.querySelectorAll(`.block[data-block-id="${e}"]`).forEach(n=>{let r=n.parentElement;if(!r)return;let o=n.nextElementSibling;if(o&&o.classList.contains("block-children")){let i=o;o=o.nextElementSibling,i.parentNode===r&&r.removeChild(i)}n.parentNode===r&&r.removeChild(n)})}async function Xs(e,t,n=1){for(let r of e){let o=document.createElement("div");o.className="block",o.dataset.blockId=r.id,typeof r.collapsed=="boolean"&&(o.dataset.collapsed=r.collapsed?"true":"false"),(r.id===u.currentBlockId||Array.isArray(u.selectedBlockIds)&&u.selectedBlockIds.includes(r.id))&&o.classList.add("selected"),r.id===u.editingBlockId&&o.classList.add("editing");let s=document.createElement("div");s.className="block-surface";let a=document.createElement("div");a.className="block-content";let c=Gn(r.text||""),l=!!c.titleHtml,d=!!(c.bodyHtml&&c.bodyHtml.trim()),m=!!r.children?.length;if(!l&&m){let N=document.createElement("div");N.innerHTML=c.bodyHtml||r.text||"";let $=Array.from(N.childNodes||[]).filter(q=>q.nodeType===Node.TEXT_NODE?(q.textContent||"").trim().length>0:q.nodeType===Node.ELEMENT_NODE?q.tagName==="BR"?!1:q.tagName==="P"?(q.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim().length>0:!0:!1);if($.length===1){let q=$[0];q.nodeType===Node.ELEMENT_NODE&&q.tagName==="P"&&(c={titleHtml:q.outerHTML,bodyHtml:""},l=!0,d=!1)}}let h=l||m,b=!l&&!m;o.classList.toggle("block--no-title",!l);let w=u.mode==="edit"&&u.editingBlockId===r.id,f=null;if(h||b){let N=document.createElement("button");N.className="collapse-btn",b?(N.classList.add("collapse-btn--placeholder"),N.setAttribute("aria-hidden","true"),N.removeAttribute("aria-expanded"),N.removeAttribute("title")):(N.setAttribute("aria-expanded",r.collapsed?"false":"true"),N.title=r.collapsed?"\u0420\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C":"\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C"),f=document.createElement("div"),f.className="block-header",l||f.classList.add("block-header--no-title");let $=document.createElement("div");if($.className="block-header__left",$.appendChild(N),l){let q=Math.min(Math.max(n,1),6),z=document.createElement(`h${q}`);z.className="block-title",z.innerHTML=c.titleHtml||"",$.appendChild(z)}else{let q=document.createElement("div");q.className="block-title-spacer",q.style.flex="1",q.style.minWidth="0",$.appendChild(q)}f.appendChild($)}let p=document.createElement("div");p.className="block-text block-body";let y=w?Zs(r.text||""):c.bodyHtml||"";if(p.innerHTML=y,(!y||!y.trim())&&(p.classList.add("block-body--empty"),w&&(p.innerHTML="<p><br /></p>")),p.classList.toggle("block-body--no-title",!l),w?(p.setAttribute("contenteditable","true"),p.setAttribute("spellcheck","false"),p.dataset.placeholder="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0442\u0435\u043A\u0441\u0442"):p.removeAttribute("contenteditable"),f&&a.appendChild(f),(w||!l||y)&&a.appendChild(p),u.articleId==="inbox"&&!w){let N=document.createElement("div");N.className="block-footer";let $=document.createElement("button");$.type="button",$.className="ghost small move-block-btn",$.innerHTML='<i class="bx bx-transfer-alt" aria-hidden="true"></i>',$.title="\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0431\u043B\u043E\u043A \u0432 \u0434\u0440\u0443\u0433\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E",$.addEventListener("click",q=>{q.stopPropagation(),Gs?Gs(r.id):ve("\u041F\u0435\u0440\u0435\u043D\u043E\u0441 \u0431\u043B\u043E\u043A\u0430 \u0432\u0440\u0435\u043C\u0435\u043D\u043D\u043E \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D")}),N.appendChild($),a.appendChild(N)}if(s.appendChild(a),w&&("ontouchstart"in window||navigator.maxTouchPoints>0)&&a.addEventListener("click",$=>{let q=a.querySelector('.block-text[contenteditable="true"]');q&&(q.contains($.target)||($.stopPropagation(),q.focus(),u.editingCaretPosition==="start"?(q.scrollTop=0,Ss(q)):ni(q)))}),Ml(s,r.id),w){let N=document.createElement("div");N.className="block-edit-actions";let $=document.createElement("button");$.type="button",$.className="ghost small block-attach-btn",$.innerHTML='<i class="bx bx-paperclip block-attach-btn__icon" aria-hidden="true"></i><span class="block-attach-btn__label">\u0424\u0430\u0439\u043B</span>',$.title="\u041F\u0440\u0438\u043A\u0440\u0435\u043F\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u0438\u043B\u0438 \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0443",$.addEventListener("click",X=>{X.preventDefault(),X.stopPropagation();let Q=o.querySelector('.block-text[contenteditable="true"]');if(!Q)return;let oe=document.createElement("input");oe.type="file",oe.multiple=!0,oe.style.display="none",oe.addEventListener("change",()=>{let we=Array.from(oe.files||[]);we.length&&ta(Q,we,r.id),oe.remove()}),document.body.appendChild(oe),oe.click()});let q=document.createElement("button");q.type="button",q.className="ghost small",q.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C",q.addEventListener("click",async X=>{X.preventDefault(),X.stopPropagation(),await xl()});let z=document.createElement("button");z.type="button",z.className="ghost small",z.textContent="\u041E\u0442\u043C\u0435\u043D\u0430",z.addEventListener("click",X=>{X.preventDefault(),X.stopPropagation(),Al()}),N.appendChild($),N.appendChild(q),N.appendChild(z),a.appendChild(N)}na(p,r.id),o.appendChild(s),o.addEventListener("click",N=>{if(N.stopPropagation(),u.isRagView&&u.ragBlockMap&&u.ragBlockMap[r.id]){let tt=u.ragBlockMap[r.id];if(tt&&tt.articleId&&tt.blockId){u.scrollTargetBlockId=tt.blockId,u.currentBlockId=tt.blockId,kn(dn.article(tt.articleId));return}}let $=N.target.closest('button, a, [contenteditable="true"], .block-edit-actions'),q=o.querySelector(".block-header"),z=o.querySelector(".block-text.block-body"),X=!!q,Q=!!(q&&!q.classList.contains("block-header--no-title")),oe=X&&q.contains(N.target),we=z&&z.contains(N.target),Pe=Q,te=u.currentBlockId===r.id,Se=!1;(Pe&&oe||!Pe&&te&&we&&!$)&&(Se=!0),Se&&ea(r.id),ur(r.id)}),s.addEventListener("dblclick",N=>{if(u.mode!=="view"||u.isPublicView||u.isRagView)return;let $=N.target.closest('button, a, [contenteditable="true"]');$&&!$.matches('.block-text[contenteditable="true"]')||(N.stopPropagation(),ur(r.id),wl())});let A=r.collapsed&&r.id!==u.editingBlockId&&l;p.classList.contains("block-body--empty")||p.classList.toggle("collapsed",A);let I=null;r.children?.length>0&&!r.collapsed&&(I=document.createElement("div"),I.className="block-children",await Xs(r.children,I,n+1)),t.appendChild(o),I&&(w?t.appendChild(I):o.appendChild(I))}}async function hn(e){if(!u.article||!Array.isArray(u.article.blocks))return;let t=Et(e);if(!t)return;let n=(Array.isArray(t.ancestors)?t.ancestors.length:0)+1,r=document.querySelector(`.block[data-block-id="${e}"]`);if(!r)return;let o=r.parentElement;if(!o)return;let i=[],s=r.nextElementSibling;s&&s.classList.contains("block-children")&&i.push(s);let a=(i[i.length-1]||r).nextSibling;o.removeChild(r),i.forEach(d=>{d.parentNode===o&&o.removeChild(d)});let c=document.createElement("div");await Xs([t.block],c,n),Array.from(c.childNodes).forEach(d=>{o.insertBefore(d,a)}),$l(),Fl()}function Wt(e=null){let t=u.article;if(!t)return;try{let o=!(!u.isPublicView&&!u.isRagView&&u.isOutlineEditing),i=Ii(new Error),s=Date.now();if(!(Ys.hash===i.hash&&s-Ys.atMs<400)){Ys={atMs:s,hash:i.hash};let c=Array.isArray(t.blocks)?t.blocks.length:null,l=null;try{l=o?V.blocksContainer?.querySelectorAll?.(".block[data-block-id]")?.length??null:null}catch{l=null}ki("ui.renderArticle",{articleId:u.articleId||null,mode:u.mode,isOutlineEditing:!!u.isOutlineEditing,willFullRender:o,currentBlockId:u.currentBlockId||null,editingBlockId:u.editingBlockId||null,blocksCount:c,domBlocksCount:l,trace:e?String(e).slice(0,120):null,stackHash:i.hash,stackTop:i.top})}}catch{}if(!u.isPublicView&&!u.isRagView&&u.isOutlineEditing){Jt(),go();return}Array.isArray(t.blocks)&&Sp(t.blocks),Jt();let n=t.id==="inbox"?[...t.blocks||[]].reverse():t.blocks;go(),V.blocksContainer.innerHTML="",Gr(),_l(),Pl();let r=()=>{if(u.mode!=="edit"||!u.editingBlockId||u.editingCaretPosition==="start")return;let o=V.blocksContainer?.querySelector(`.block[data-block-id="${u.editingBlockId}"] .block-text[contenteditable="true"]`);if(!o)return;let i=document.activeElement;o===i||o.contains(i)||(o.focus({preventScroll:!0}),o.scrollHeight>o.clientHeight&&(o.scrollTop=o.scrollHeight),ni(o))};Xs(n,V.blocksContainer).then(()=>{if(Fl(),$l(),pl(),u.scrollTargetBlockId&&u.mode==="view"){let o=u.scrollTargetBlockId;requestAnimationFrame(()=>{let i=document.querySelector(`.block[data-block-id="${o}"]`);if(i){(i.querySelector(".block-content")||i).scrollIntoView({behavior:"smooth",block:"nearest"});let a=i.querySelector('.block-text[contenteditable="true"]');a&&u.mode==="edit"&&u.editingBlockId===o?(a.focus({preventScroll:!0}),u.editingCaretPosition==="start"?(a.scrollTop=0,Ss(a)):ni(a)):(i.setAttribute("tabindex","-1"),i.focus({preventScroll:!0}))}u.currentBlockId=o,u.scrollTargetBlockId=null})}r(),u.mode==="edit"&&typeof u.editingScrollTop=="number"&&V.blocksContainer&&(V.blocksContainer.scrollTop=u.editingScrollTop)})}var Gs,Ys,Qs=et(()=>{Ht();Bn();mn();an();cr();Ks();Fn();Un();Un();dr();Er();lr();yo();vo();Ws();Gs=null;Ys={atMs:0,hash:null}});function wp(){try{let e=window?.localStorage?.getItem?.(zl)||"";if(!e)return[];let t=JSON.parse(e);return Array.isArray(t)?t.filter(Boolean):[]}catch{return[]}}function xp(e){try{window?.localStorage?.setItem?.(zl,JSON.stringify(Array.isArray(e)?e:[]))}catch{}}function Ul(e){let t=String(e||"").trim();if(!t)return!1;let n=wp(),r=n.filter(o=>String(o?.sectionId||o?.id||"")!==t);return r.length===n.length?!1:(xp(r),!0)}async function Ap(){let e=await fetch("/api/articles/inbox?include_history=0",{method:"GET",credentials:"include"});if(e.status===401||e.status===403){let t=new Error("auth");throw t.status=e.status,t}if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()}async function ql(){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return{status:"offline"};let e=await Ap(),t=new Date().toISOString();try{e?.docJson&&typeof e.docJson=="object"&&await xn("inbox",e.docJson,t)}catch{}return{status:"refreshed",updatedAt:e?.updatedAt||null,docJson:e?.docJson||null}}var zl,ra=et(()=>{zr();Kr();zl="ttree_pending_quick_notes_v1"});async function kp(e){try{let n=(u.articlesIndex.length?u.articlesIndex:await Nn()).filter(d=>d.id!=="inbox"),r=n.map(d=>({id:d.id,title:d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),o=await ar({title:"\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0432 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0438\u043B\u0438 \u0432\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E",confirmText:"\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:r,returnMeta:!0,hideConfirm:!1}),s=(o?.selectedId||(typeof o=="object"?o?.value:o)||""||"").trim();if(!s)return;let a=s.toLowerCase(),c=n.find(d=>d.id&&d.id.toLowerCase()===a||(d.title||"").toLowerCase()===a),l=c?c.id:s;if(!l||l==="inbox"){ve("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}await apiRequest(`/api/articles/${u.articleId}/blocks/${e}/move-to/${l}`,{method:"POST"}),await Wn("inbox",{resetUndoStacks:!0}),Wt("views.moveBlockFromInbox.reloadInbox"),ve("\u0411\u043B\u043E\u043A \u043F\u0435\u0440\u0435\u043D\u0435\u0441\u0451\u043D")}catch(t){ve(t.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0431\u043B\u043E\u043A")}}async function oi(e){try{String(e||"").startsWith("inbox-")&&(e="inbox")}catch{}u.isPublicView=!1,u.isRagView=!1,document.body.classList.remove("public-embedded"),u.isEditingTitle=!1,await ko(),xo(!0),V.usersView&&V.usersView.classList.add("hidden"),V.blocksContainer.innerHTML="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...";try{if(e==="RAG"){u.isRagView=!0,u.mode="view",u.editingBlockId=null,u.pendingEditBlockId=null,u.scrollTargetBlockId=null,u.ragBlockMap={},hi("RAG");let r=(u.ragQuery||"").trim(),o=Array.isArray(u.ragResults)?u.ragResults:[],i=o.length,s=Array.from(new Set(o.map(m=>m&&m.articleTitle?String(m.articleTitle):"").filter(Boolean))),a=s.slice(0,8),c=["<p><strong>\u0421\u0432\u043E\u0434\u043A\u0430</strong></p>"];u.ragSummaryLoading?c.push('<p class="meta">\u0413\u0435\u043D\u0435\u0440\u0438\u0440\u0443\u044E \u0441\u0432\u043E\u0434\u043A\u0443\u2026</p>'):u.ragSummaryError?c.push(`<p class="meta">\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0432\u043E\u0434\u043A\u0438: ${u.ragSummaryError}</p>`):u.ragSummaryHtml?c.push(u.ragSummaryHtml):c.push('<p class="meta">\u0421\u0432\u043E\u0434\u043A\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435 \u0433\u043E\u0442\u043E\u0432\u0430.</p>');let l=["<p><strong>AI-\u043F\u043E\u0438\u0441\u043A: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B</strong></p>",`<p><span class="meta">\u0417\u0430\u043F\u0440\u043E\u0441:</span> ${r||"\u2014"}</p>`,`<p><span class="meta">\u041D\u0430\u0439\u0434\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432:</span> ${i}</p>`];a.length&&l.push(`<p><span class="meta">\u0421\u0442\u0430\u0442\u044C\u0438:</span> ${a.join(" \xB7 ")}</p>`),s.length>a.length&&l.push(`<p><span class="meta">\u2026\u0438 \u0435\u0449\u0451:</span> ${s.length-a.length}</p>`);let d=[{id:"rag-ai-summary",text:c.join(""),children:[],collapsed:!1},{id:"rag-meta",text:l.join(""),children:[],collapsed:!1},...o.filter(m=>m&&m.type==="block").map((m,h)=>{let b=m.blockText||"",w=m.articleTitle?String(m.articleTitle):"",f=w?`<p><strong>${w}</strong></p>`:`<p><strong>\u0420\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442 ${h+1}</strong></p>`,p=`rag-${m.blockId||h}`;return m.articleId&&m.blockId&&(u.ragBlockMap[p]={articleId:m.articleId,blockId:m.blockId}),{id:p,text:`${f}${b}`,children:[],collapsed:!1}})];u.article={id:"RAG",title:r?`AI: ${r}`:"AI: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B \u043F\u043E\u0438\u0441\u043A\u0430",blocks:d,updated_at:new Date().toISOString()},u.articleId="RAG",u.currentBlockId=d[0]?.id||null,Wt("views.loadArticleView.rag.render");return}let t=u.pendingEditBlockId||void 0,n=u.scrollTargetBlockId||void 0;if(await Wn(e,{resetUndoStacks:!0,desiredBlockId:n,editBlockId:t}),Wt("views.loadArticleView.afterLoadArticle"),hi(e),e==="inbox"&&navigator.onLine&&u.serverStatus==="ok")try{await ql().catch(()=>{}),u.articleId==="inbox"&&!u.editingBlockId&&(await Wn("inbox",{resetUndoStacks:!1}),Wt("views.loadArticleView.inbox.refreshCache"))}catch{}}catch(t){try{if((Number(t?.status||0)||null)===404&&e&&e!=="inbox"){Qo(e,new Date().toISOString()).catch(()=>{}),Rs(e),ve("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430 (\u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E, \u0443\u0434\u0430\u043B\u0435\u043D\u0430)."),kn(dn.list);return}}catch{}V.blocksContainer.innerHTML=`<p class="meta">\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u044C\u044E: ${t.message}</p>`}}async function vs(){u.isPublicView=!1,u.isRagView=!1,document.body.classList.remove("public-embedded"),V.usersView&&V.usersView.classList.add("hidden"),u.article=null,u.articleId=null,u.currentBlockId=null,u.isEditingTitle=!1,u.mode="view",u.editingBlockId=null,u.undoStack=[],u.redoStack=[],u.pendingEditBlockId=null,gi({restoreDom:!1}),xo(!1),Gr();try{if(u.isTrashView){let e=await pi();_n(e)}else{let e=await ko();_n(e)}}catch(e){V.articleList.innerHTML=`<li>\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u043F\u0438\u0441\u043E\u043A: ${e.message}</li>`}}async function Ts(e){u.isPublicView=!0,u.isRagView=!1,document.body.classList.add("public-embedded"),V.usersView&&V.usersView.classList.add("hidden"),xo(!0),u.isEditingTitle=!1,u.mode="view",u.editingBlockId=null,u.pendingEditBlockId=null,u.selectionAnchorBlockId=null,u.selectedBlockIds=[],u.undoStack=[],u.redoStack=[],gi({restoreDom:!1}),V.blocksContainer&&(V.blocksContainer.innerHTML="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...");try{let t=await apiRequest(`/api/public/articles/${encodeURIComponent(e)}`,{method:"GET",credentials:"omit"});u.article=t,u.articleId=t?.id||null;let n=Yn(t?.blocks||[])[0];u.currentBlockId=n?n.id:null,Wt("views.loadPublicArticleView.render")}catch(t){V.blocksContainer&&(V.blocksContainer.innerHTML=`<p class="meta">\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E: ${t.message}</p>`)}}var Kl=et(()=>{Ht();Bn();mn();an();cr();lr();Kr();dr();dr();dr();Er();Un();Us();Qs();vo();ra();Hl(kp)});var Ir=et(()=>{yo();Fs();Us();Qs();Kl();vo();vo();Gr()});function Ip(e){try{let t=window.getComputedStyle(e).lineHeight,n=Number.parseFloat(t);if(Number.isFinite(n)&&n>0)return n}catch{}return 24}function Ep(e,{behavior:t="smooth",topLines:n=2,bottomLines:r=5}={}){if(!e)return;let o=V.blocksContainer||document.scrollingElement||document.documentElement;if(!o)return;let i=o.getBoundingClientRect(),s=e.getBoundingClientRect(),a=Ip(o),c=Math.round(a*n),l=Math.round(a*r),d=0,m=i.top+c,h=i.bottom-l;if(s.bottom>h)d=s.bottom-h;else if(s.top<m)d=s.top-m;else return;if(o===document.body||o===document.documentElement||o===document.scrollingElement){window.scrollBy({top:d,behavior:t});return}o.scrollBy({top:d,behavior:t})}function Yn(e=[],t=[]){return(e||[]).forEach(n=>{t.push(n),n.children&&n.children.length>0&&!n.collapsed&&Yn(n.children,t)}),t}function Et(e,t=u.article?.blocks||[],n=null,r=[]){for(let o=0;o<t.length;o+=1){let i=t[o];if(i.id===e)return{block:i,parent:n,index:o,siblings:t,ancestors:r};let s=Et(e,i.children||[],i,[...r,i]);if(s)return s}return null}function To({scrollIntoView:e=!1,scrollBehavior:t="smooth"}={}){let n=new Set(Array.isArray(u.selectedBlockIds)?u.selectedBlockIds:[]);if(u.currentBlockId&&n.add(u.currentBlockId),document.querySelectorAll(".block[data-block-id]").forEach(o=>{let i=o.getAttribute("data-block-id"),s=i&&n.has(i);o.classList.toggle("selected",!!s),o.classList.remove("block--selected-root-ancestor");let a=o.querySelector(":scope > .block-surface");a&&a.classList.remove("block--selected-root-ancestor")}),u.currentBlockId&&u.article&&Array.isArray(u.article.blocks)){let o=Et(u.currentBlockId),i=o?.ancestors||[],s=i.length>0?i[0]?.id:o?.block?.id;if(s){let a=document.querySelector(`.block[data-block-id="${s}"]`);if(a){let c=a.querySelector(":scope > .block-surface");c&&c.classList.add("block--selected-root-ancestor")}}}if(e&&u.mode==="view"&&u.currentBlockId){let o=document.querySelector(`.block[data-block-id="${u.currentBlockId}"]`);o&&Ep(o,{behavior:t||"smooth",topLines:2,bottomLines:5})}}function Vl(e,t={}){if(!e||u.currentBlockId===e)return;let{preserveSelection:n=!1,scrollIntoView:r,scrollBehavior:o}=t;u.currentBlockId=e,n||(u.selectionAnchorBlockId=null,u.selectedBlockIds=[]);let i=typeof r=="boolean"?r:u.mode==="view";To({scrollIntoView:i,scrollBehavior:o||"smooth"})}function ur(e,t={}){Vl(e,{preserveSelection:!1,...t})}function jl(e){if(!u.article)return;let t=Yn(u.article.blocks),n=t.findIndex(o=>o.id===u.currentBlockId);if(n===-1)return;let r=t[n+e];r&&(u.mode==="view"&&(u.scrollTargetBlockId=r.id),Vl(r.id,{preserveSelection:!1}))}function Jl(e){if(!u.article)return;let t=Yn(u.article.blocks);if(!t.length)return;let n=u.selectionAnchorBlockId||u.currentBlockId||t[0].id;n||(n=t[0].id),u.selectionAnchorBlockId||(u.selectionAnchorBlockId=n);let r=t.findIndex(d=>d.id===n);if(r===-1)return;let o=u.currentBlockId||n,i=t.findIndex(d=>d.id===o);i===-1&&(i=r);let s=i+e;if(s<0||s>=t.length)return;let[a,c]=s>=r?[r,s]:[s,r],l=t.slice(a,c+1).map(d=>d.id);u.selectedBlockIds=l,u.currentBlockId=t[s].id,u.mode==="view"&&(u.scrollTargetBlockId=u.currentBlockId),To({scrollIntoView:u.mode==="view"})}var Wl=et(()=>{Ht();Bn()});function fr(e){return e?e.nodeType===Node.TEXT_NODE?/\n\s*\n/.test(e.textContent||""):e.nodeType===Node.ELEMENT_NODE&&(e.tagName==="BR"||(e.tagName==="P"||e.tagName==="DIV")&&(!(e.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&(nbsp|#160);/gi,"").trim()||!(e.textContent||"").replace(/\u00a0/g,"").trim()&&!e.querySelector("img"))):!1}function Ei(e=[]){let t=document.createElement("div");return e.forEach(n=>t.appendChild(n)),t.innerHTML.trim()}function oa(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=[],r=(i="")=>{let s=document.createElement("p");i?s.innerHTML=i:s.appendChild(document.createElement("br")),n.push(s)};Array.from(t.content.childNodes).forEach(i=>{if(i.nodeType===Node.TEXT_NODE){let s=(i.textContent||"").trim();s&&r(s);return}if(i.nodeType===Node.ELEMENT_NODE){if(i.tagName==="P"){n.push(i.cloneNode(!0));return}if(i.tagName==="BR"){r("");return}if(i.tagName==="DIV"){r(i.innerHTML);return}r(i.outerHTML)}}),n.length||r("");let o=document.createElement("div");return n.forEach(i=>o.appendChild(i)),o.innerHTML}function Gn(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll(".block-header").forEach(m=>{let h=m.parentNode;if(h){for(;m.firstChild;)h.insertBefore(m.firstChild,m);h.removeChild(m)}});let n=Array.from(t.content.childNodes),r=m=>m?.nodeType===Node.TEXT_NODE&&!(m.textContent||"").trim(),o=0;for(;o<n.length&&r(n[o]);)o+=1;let i=n[o];if(!i||i.nodeType!==Node.ELEMENT_NODE||i.tagName!=="P"||fr(i))return{titleHtml:"",bodyHtml:Ei(n)};let s=o+1;for(;s<n.length&&r(n[s]);)s+=1;let a=n[s];if(!(!!a&&fr(a)&&(a.nodeType===Node.ELEMENT_NODE?a.tagName==="P"||a.tagName==="DIV"||a.tagName==="BR":!1)))return{titleHtml:"",bodyHtml:Ei(n)};let l=[i.cloneNode(!0)],d=[];for(let m=s+1;m<n.length;m+=1)d.push(n[m].cloneNode(!0));return{titleHtml:Ei(l),bodyHtml:Ei(d)}}function Yl({event:e,element:t,range:n,selection:r,notifyEditingInput:o,logDebug:i}){if(!e||!t||!n||!r||!n.collapsed)return!1;let s=e.key==="Backspace"||e.code==="Backspace"||e.keyCode===8,a=e.key==="Delete"||e.key==="Del"||e.code==="Delete"||e.code==="Del"||e.keyCode===46;if(!s&&!a)return!1;let c=p=>{try{r.removeAllRanges(),r.addRange(p)}catch{}try{t.focus({preventScroll:!0})}catch{t.focus()}},l=p=>{let x=(n.commonAncestorContainer?.nodeType===Node.ELEMENT_NODE?n.commonAncestorContainer:n.commonAncestorContainer?.parentElement)?.closest?.("p");if(x)return x;let A=t,I=Array.from(A.childNodes),N=n.startContainer;for(;N&&N.parentNode!==A;)N=N.parentNode;let $=N?I.indexOf(N):-1,q=z=>{let X=z==="prev"?-1:1,Q=$;for(Q===-1?Q=z==="prev"?I.length-1:0:Q=z==="prev"?Q-1:Q;Q>=0&&Q<I.length;){let oe=I[Q];if(oe?.nodeType===Node.ELEMENT_NODE&&oe.tagName==="P")return oe;Q+=X}return null};return p==="Delete"?q("next")||q("prev"):p==="Backspace"?q("prev")||q("next"):null},d=()=>{if(n.startContainer!==t)return{prev:null,next:null};let p=Array.from(t.childNodes),y=n.startOffset,x=null,A=null;for(let I=y-1;I>=0;I-=1){let N=p[I];if(N?.nodeType===Node.ELEMENT_NODE&&N.tagName==="P"){x=N;break}}for(let I=y;I<p.length;I+=1){let N=p[I];if(N?.nodeType===Node.ELEMENT_NODE&&N.tagName==="P"){A=N;break}}return{prev:x,next:A}},m=p=>{let y=p?.previousElementSibling;for(;y&&y.tagName!=="P";)y=y.previousElementSibling;return y&&y.tagName==="P"?y:null},h=p=>{let y=p?.nextElementSibling;for(;y&&y.tagName!=="P";)y=y.nextElementSibling;return y&&y.tagName==="P"?y:null},b=p=>{if(!p)return!0;let y=new Set(["span","b","strong","i","em","u","s","mark","code"]),x=new Set(["img","video","audio","iframe"]),A=I=>{if(!I)return!1;if(I.nodeType===Node.TEXT_NODE)return(I.textContent||"").replace(/\u00a0/g,"").replace(/[\u200B-\u200D\uFEFF]/g,"").trim().length>0;if(I.nodeType!==Node.ELEMENT_NODE)return!1;let N=(I.tagName||"").toLowerCase();return N==="br"?!1:x.has(N)?!0:N==="span"&&(I.getAttribute("class")||"").includes("resizable-image__handle")?!1:y.has(N)?Array.from(I.childNodes||[]).some(A):!0};return!Array.from(p.childNodes||[]).some(A)},w=p=>{if(!p)return!1;let y=document.createRange();y.selectNodeContents(p);try{y.setEnd(n.startContainer,n.startOffset)}catch{return!1}if(b(y.cloneContents()))return!0;try{let x=document.createRange();return x.selectNodeContents(p),x.collapse(!0),n.compareBoundaryPoints(Range.START_TO_START,x)===0}catch{return!1}},f=p=>{if(!p)return!1;let y=document.createRange();y.selectNodeContents(p);try{y.setStart(n.startContainer,n.startOffset)}catch{return!1}if(b(y.cloneContents()))return!0;try{let x=document.createRange();return x.selectNodeContents(p),x.collapse(!1),n.compareBoundaryPoints(Range.END_TO_END,x)===0}catch{return!1}};if(window.__debugMergeP&&i("mergeP.keydown",{key:e.key,code:e.code,keyCode:e.keyCode,startContainer:n.startContainer?.nodeName,startOffset:n.startOffset,collapsed:n.collapsed}),s){if(n.startContainer===t){let A=d();if(A.prev&&A.next){e.preventDefault(),e.stopPropagation();let I=document.createRange();for(I.selectNodeContents(A.prev),I.collapse(!1);A.next.firstChild;)A.prev.appendChild(A.next.firstChild);return A.next.remove(),c(I),o(t),!0}return!1}let p=l("Backspace");if(!p||!t.contains(p)||!w(p))return!1;let y=m(p);if(!y||!t.contains(y))return!1;e.preventDefault(),e.stopPropagation();let x=document.createRange();for(x.selectNodeContents(y),x.collapse(!1);p.firstChild;)y.appendChild(p.firstChild);return p.remove(),c(x),o(t),!0}if(a){let p=l("Delete");if(!p||!t.contains(p)){let A=d();if(A.prev&&A.next){e.preventDefault(),e.stopPropagation();let I=document.createRange();for(I.selectNodeContents(A.prev),I.collapse(!1);A.next.firstChild;)A.prev.appendChild(A.next.firstChild);return A.next.remove(),c(I),o(t),!0}return!1}if(!f(p))return!1;let y=h(p);if(!y||!t.contains(y))return!1;e.preventDefault(),e.stopPropagation();let x=document.createRange();for(x.selectNodeContents(p),x.collapse(!1);y.firstChild;)p.appendChild(y.firstChild);return y.remove(),c(x),o(t),!0}return!1}var ia=et(()=>{});function Bo(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=r=>{if(r&&!(r.nodeType===Node.ELEMENT_NODE&&r.tagName==="A")){if(r.nodeType===Node.TEXT_NODE){let o=r.textContent||"";if(Ci.lastIndex=0,!Ci.test(o))return;let s=document.createDocumentFragment(),a=0;Ci.lastIndex=0;let c;for(;(c=Ci.exec(o))!==null;){let[l]=c;c.index>a&&s.appendChild(document.createTextNode(o.slice(a,c.index)));let d=l.startsWith("http")?l:`https://${l}`,m=document.createElement("a");m.href=d,m.target="_blank",m.rel="noopener noreferrer",m.textContent=l,s.appendChild(m),a=c.index+l.length}a<o.length&&s.appendChild(document.createTextNode(o.slice(a))),r.parentNode&&r.parentNode.replaceChild(s,r);return}Array.from(r.childNodes||[]).forEach(n)}};return Array.from(t.content.childNodes).forEach(n),t.innerHTML}function Gl(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll("script, style").forEach(o=>o.remove());let n=(o="")=>/^javascript:/i.test(o.trim()),r=o=>{if(!o||o.nodeType!==Node.ELEMENT_NODE){Array.from(o?.childNodes||[]).forEach(r);return}Array.from(o.attributes||[]).forEach(i=>{let s=i.name.toLowerCase(),a=i.value||"";if(s.startsWith("on")||s==="style"){o.removeAttribute(i.name);return}(s==="href"||s==="src")&&n(a)&&o.removeAttribute(i.name)}),Array.from(o.childNodes||[]).forEach(r)};return Array.from(t.content.childNodes||[]).forEach(r),t.innerHTML}function vi(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=r=>{if(!r)return!0;if(r.nodeType===Node.TEXT_NODE)return!(r.textContent||"").replace(/\u00a0/g,"").trim();if(r.nodeType!==Node.ELEMENT_NODE)return!1;if(r.tagName==="BR")return!0;let o=(r.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&nbsp;/gi,"").trim(),i=(r.textContent||"").replace(/\u00a0/g,"").trim(),s=!!r.querySelector("img,video,audio,iframe");return!o&&!i&&!s};for(;t.content.firstChild&&n(t.content.firstChild);)t.content.removeChild(t.content.firstChild);for(;t.content.lastChild&&n(t.content.lastChild);)t.content.removeChild(t.content.lastChild);return t.innerHTML}function Xl(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=(t.content.textContent||"").replace(/\u00a0/g," ").trim(),r=!!t.content.querySelector("a"),o=!1;{let w=Array.from(t.content.childNodes||[]);for(let f=0;f<w.length;f+=1){let p=w[f];if(p.nodeType===Node.TEXT_NODE){if(!(p.textContent||"").trim())continue;break}fr(p)&&(o=!0);break}}let i=document.createElement("template");i.innerHTML=e||"",i.content.querySelectorAll("img").forEach(w=>{let f=String(w.getAttribute("src")||"").trim();if(!/^(blob:|filesystem:)/i.test(f))return;let p=String(w.getAttribute("alt")||"").trim()||"image",y=w.closest?.(".resizable-image")||w;try{y.replaceWith(document.createTextNode(`[${p} \u2014 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0431\u044B\u043B\u043E blob: \u0438 \u043D\u0435 \u0431\u044B\u043B\u043E \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E]`))}catch{}});let a=(()=>{if(!Array.from(i.content.childNodes||[]).length)return!1;let f=Array.from(i.content.querySelectorAll("p"));if(f.length<2)return!1;let p=te=>{let Se=te.trim();return Se.startsWith("|")&&Se.indexOf("|",1)!==-1},x=f.map(te=>(te.textContent||"").replace(/\u00a0/g," ").trim()).filter(te=>te);if(x.length<2||!x.every(p))return!1;let A=x.map(te=>{let Se=te.trim();return(Se.endsWith("|")?Se.slice(1,-1):Se.slice(1)).split("|").map(Lt=>Lt.trim())}),I=A[0],N=A.slice(1),$=N.reduce((te,Se)=>Math.max(te,Se.length),I.length),q=document.createElement("table");q.className="memus-table";let z=document.createElement("colgroup"),X=100/Math.max($,1);for(let te=0;te<$;te+=1){let Se=document.createElement("col");Se.setAttribute("width",`${X.toFixed(4)}%`),z.appendChild(Se)}q.appendChild(z);let Q=document.createElement("thead"),oe=document.createElement("tr");for(let te=0;te<$;te+=1){let Se=document.createElement("th");Se.textContent=I[te]||"",oe.appendChild(Se)}Q.appendChild(oe),q.appendChild(Q);let we=document.createElement("tbody");return N.forEach(te=>{let Se=document.createElement("tr"),tt=[...te];for(let Lt=0;Lt<$;Lt+=1){let _t=document.createElement("td");_t.textContent=tt[Lt]||"",Se.appendChild(_t)}we.appendChild(Se)}),q.appendChild(we),i.content.innerHTML="",i.content.appendChild(q),Bo(i.innerHTML).replace(/<\/a>\s*<a/gi,"</a> <a")})();if(a)return a;i.content.querySelectorAll(".table-toolbar, .table-toolbar-btn").forEach(w=>{w.remove()}),i.content.querySelectorAll(".block-header").forEach(w=>{let f=w.parentNode;if(f){for(;w.firstChild;)f.insertBefore(w.firstChild,w);f.removeChild(w)}});let c=w=>{Array.from(w.childNodes).forEach(f=>{if(f.nodeType===Node.ELEMENT_NODE){if(f.tagName==="DIV"){let p=document.createElement("p");p.innerHTML=f.innerHTML,f.parentNode.replaceChild(p,f),c(p);return}c(f)}})};c(i.content),(w=>{Array.from(w.childNodes||[]).forEach(p=>{if(p.nodeType===Node.TEXT_NODE){let x=(p.textContent||"").replace(/\u00a0/g," ");if(!x.trim()){if(p.previousSibling&&p.nextSibling){p.textContent=" ";return}w.removeChild(p);return}let I=document.createElement("p");I.textContent=x,w.replaceChild(I,p)}})})(i.content),i.content.querySelectorAll("p").forEach(w=>{(w.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim()||(w.innerHTML="",w.appendChild(document.createElement("br")))});let d=i.content;if(!!d.querySelector("p")){if(o){let w=Array.from(d.childNodes||[]),f=null;for(let p=0;p<w.length;p+=1){let y=w[p];if(!(y.nodeType===Node.TEXT_NODE&&!(y.textContent||"").trim())){f=y;break}}if(f){if(!(f.tagName==="P"&&fr(f))){let p=document.createElement("p");p.appendChild(document.createElement("br")),d.insertBefore(p,f)}}else{let p=document.createElement("p");p.appendChild(document.createElement("br")),d.appendChild(p)}}}else{let w=document.createElement("p");w.appendChild(document.createElement("br")),d.appendChild(w)}let b=Bo(i.innerHTML).replace(/<\/a>\s*<a/gi,"</a> <a");return!b.trim()&&(n||r)?e||"":b}var Ci,Ql=et(()=>{ia();Ci=/((?:https?:\/\/|www\.)[^\s<>"']+)/gi});function pr(e){if(!e)return;if(!(e.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&nbsp;/gi,"").trim()){e.innerHTML="";let n=document.createRange();n.selectNodeContents(e),n.collapse(!0);let r=window.getSelection();r&&(r.removeAllRanges(),r.addRange(n))}}var sa=et(()=>{});function vr(e){if(!e)return!1;if(e.type&&e.type.startsWith("image/"))return!0;let t=(e.name||"").toLowerCase();return t?/\.(png|jpe?g|gif|webp|bmp|svg|heic|heif)$/i.test(t):!1}function aa(e=[],t=[]){let n=[];return Array.from(e||[]).forEach(r=>{if(r.kind==="file"){let o=typeof r.getAsFile=="function"?r.getAsFile():null;o&&vr(o)&&n.push(o)}}),!n.length&&t?.length&&Array.from(t).forEach(r=>{vr(r)&&n.push(r)}),n}function ca(e=[],t=[]){let n=[];return Array.from(e||[]).forEach(r=>{if(r.kind==="file"){let o=typeof r.getAsFile=="function"?r.getAsFile():null;o&&!vr(o)&&n.push(o)}}),!n.length&&t?.length&&Array.from(t).forEach(r=>{vr(r)||n.push(r)}),n}async function Ti(e,t,n){let r=`img-${Date.now()}-${Math.random().toString(16).slice(2)}`,o=t&&t.name?t.name:"image",i=Zt(o).replace(/"/g,"&quot;");try{pr(e),er(e,`<span data-pending-image="true" data-image-token="${r}">${i} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F...)</span>`)}catch{}try{let{url:s}=await ho(t),c=`
      <span class="resizable-image" style="width:320px;max-width:100%;">
        <span class="resizable-image__inner">${`<img src="${s}" alt="${i}" draggable="false" />`}</span>
        <span class="resizable-image__handle" data-direction="e" aria-hidden="true"></span>
      </span>
    `,l=e,d=l&&l.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`);if(n&&(!d||!l.isConnected)){let m=document.querySelector(`.block[data-block-id="${n}"]`);if(m){let b=m.querySelector('.block-text[contenteditable="true"]')||m.querySelector(".block-text.block-body");b&&(l=b,d=l.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`))}}d?(d.removeAttribute("data-pending-image"),d.removeAttribute("data-image-token"),d.outerHTML=c):l&&(pr(l),er(l,c))}catch(s){try{let c=e;if(n&&!c.isConnected){let l=document.querySelector(`.block[data-block-id="${n}"]`);if(l){let m=l.querySelector('.block-text[contenteditable="true"]')||l.querySelector(".block-text.block-body");m&&(c=m)}}if(c){let l=c.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`);l&&(l.textContent=`${o} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F)`,l.removeAttribute("data-pending-image"))}}catch{}try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"insertImageFromFileError",data:{message:s&&s.message?String(s.message):String(s),name:t&&t.name,type:t&&t.type,size:t&&t.size}})}).catch(()=>{})}catch{}try{let c={where:"insertImageFromFile",message:s&&s.message?String(s.message):String(s),status:typeof s?.status=="number"?s.status:null,name:t&&t.name,type:t&&t.type,size:t&&t.size},l=c.status===null?"null":String(c.status);window.alert(`upload failed (status ${l}):\\n${JSON.stringify(c,null,2)}`)}catch{}let a=String(s?.message||"").toLowerCase();a.includes("status 0")||a.includes("network error")?ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 (\u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C). \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438, \u043F\u0440\u0438 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u043E\u0441\u0442\u0438, \u0432\u043E\u0439\u0434\u0438\u0442\u0435 \u0437\u0430\u043D\u043E\u0432\u043E."):ve(s.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435")}}function Cp(e){if(e.button!==0)return;let t=e.target?.closest(".resizable-image__handle");if(!t)return;let n=t.closest(".resizable-image"),o=n?.closest(".block")?.dataset?.blockId;if(!n||!o||u.mode!=="edit"||u.editingBlockId!==o)return;e.preventDefault(),e.stopPropagation();let i=n.getBoundingClientRect();mr={wrapper:n,startWidth:i.width,startX:e.clientX},n.classList.add("resizable-image--resizing")}function vp(e){if(!mr)return;e.preventDefault();let t=e.clientX-mr.startX,r=parseFloat(getComputedStyle(document.documentElement).fontSize)||16,o=Math.max(r,document.documentElement.clientWidth-32),i=mr.startWidth+t;i=Math.max(r,Math.min(i,o)),mr.wrapper.style.width=`${i}px`}function ed(){mr&&(mr.wrapper.classList.remove("resizable-image--resizing"),mr=null)}function td(){Zl||(Zl=!0,document.addEventListener("pointerdown",Cp),document.addEventListener("pointermove",vp),document.addEventListener("pointerup",ed),document.addEventListener("pointercancel",ed))}var mr,Zl,nd=et(()=>{Ht();mn();an();Fn();sa();mr=null,Zl=!1});function rd({listTag:e,resolveTarget:t,restoreSelection:n,richContextRange:r,notifyEditingInput:o,setRichContextRange:i}){let s=t();if(!s||!document.contains(s))return;n();let a=window.getSelection(),c=null;if(r&&s.contains(r.commonAncestorContainer))c=r.cloneRange();else if(a&&a.rangeCount>0){let x=a.getRangeAt(0);s.contains(x.commonAncestorContainer)&&(c=x.cloneRange())}c||(c=document.createRange(),c.selectNodeContents(s),c.collapse(!1));let l=c.startContainer?.nodeType===Node.ELEMENT_NODE?c.startContainer:c.startContainer?.parentElement,d=l?.closest?.("li"),m=d?.closest?.("ol,ul"),h=x=>{if(!x)return;let A=document.createRange();A.selectNodeContents(x),A.collapse(!1),a&&(a.removeAllRanges(),a.addRange(A)),i(A);try{s.focus({preventScroll:!0})}catch{s.focus()}s.classList.remove("block-body--empty"),o(s)},b=x=>{let A=x.parentElement?.tagName==="P"&&x.parentElement.childNodes.length===1?x.parentElement:x,I=Array.from(x.children||[]).filter(q=>q.nodeType===Node.ELEMENT_NODE&&q.tagName==="LI"),N=document.createDocumentFragment(),$=[];I.forEach(q=>{let z=document.createElement("p");for(;q.firstChild;)z.appendChild(q.firstChild);$.push(z),N.appendChild(z)}),A.replaceWith(N),h($[0]||null)};if(m){if(m.tagName.toLowerCase()===e){b(m);return}let A=document.createElement(e);for(;m.firstChild;)A.appendChild(m.firstChild);m.replaceWith(A),h(d||A.lastElementChild||A);return}let w=()=>{if(!c.collapsed)return null;let x=l?.closest?.("p")||null;if(x&&s.contains(x))return x;if(c.startContainer===s){let A=Array.from(s.childNodes),I=c.startOffset;for(let N=I-1;N>=0;N-=1){let $=A[N];if($?.nodeType===Node.ELEMENT_NODE&&$.tagName==="P")return $}for(let N=I;N<A.length;N+=1){let $=A[N];if($?.nodeType===Node.ELEMENT_NODE&&$.tagName==="P")return $}}return null},f=[];if(c.collapsed){let x=w();x&&(f=[x])}else if(f=Array.from(s.querySelectorAll(":scope > p")).filter(A=>{try{return c.intersectsNode(A)}catch{return!1}}),!f.length){let A=l?.closest?.("p");A&&s.contains(A)&&(f=[A])}if(!f.length)return;let p=document.createElement(e);f.forEach(x=>{let A=document.createElement("li");for(;x.firstChild;)A.appendChild(x.firstChild);p.appendChild(A)}),f[0].replaceWith(p),f.slice(1).forEach(x=>x.remove()),h(p.firstElementChild||p)}var od=et(()=>{});var Js={};Uo(Js,{applyEditingUndoStep:()=>Lp,attachRichContentHandlers:()=>na,buildEditableBlockHtml:()=>Zs,buildStoredBlockHtml:()=>Sl,cleanupEditableHtml:()=>Xl,clearEditingUndoSession:()=>Mp,countBlocks:()=>js,ensureBlockVisible:()=>zs,expandCollapsedAncestors:()=>_p,extendSelection:()=>Jl,extractBlockSections:()=>Gn,findBlock:()=>Et,findCollapsibleTarget:()=>Pp,findFallbackBlockId:()=>wi,flattenVisible:()=>Yn,initEditingUndoForElement:()=>Np,insertFilesIntoEditable:()=>ta,isSeparatorNode:()=>fr,moveSelection:()=>jl,setCollapseState:()=>Bi,setCurrentBlock:()=>ur,toggleCollapse:()=>ea});function cd(e=""){return e?e.startsWith("app:/")?`/api/yandex/disk/file?path=${encodeURIComponent(e)}`:e.startsWith("disk:/")?`/api/yandex/disk/file?path=${encodeURIComponent(e)}`:e:""}function Bp(e,t){if(e===t)return!1;if(t.startsWith(e)){let n=t.slice(e.length);if(n.length>0&&n.length<=Tp&&/^[A-Za-zА-Яа-я0-9]+$/.test(n))return!1}return!0}function Np(e,t){if(!e||!t)return;u.editingUndo={blockId:t,snapshots:[e.innerHTML],index:0,lastText:e.textContent||"",lastSnapshotAt:Date.now()};let n=()=>{let r=u.editingUndo;if(!r||r.blockId!==t)return;let o=e.innerHTML,i=e.textContent||"",{snapshots:s,index:a,lastText:c,lastSnapshotAt:l}=r,d=Date.now();if(!Bp(c||"",i)){r.lastText=i;return}if(s[a]===o){r.lastText=i,r.lastSnapshotAt=d;return}a<s.length-1&&s.splice(a+1),s.push(o),r.index=s.length-1,r.lastText=i,r.lastSnapshotAt=d};e.addEventListener("input",()=>{!u.editingUndo||u.editingUndo.blockId!==t||u.mode!=="edit"||u.editingBlockId!==t||n()})}function Mp(){u.editingUndo=null}function No(e){if(e)try{let t=typeof InputEvent=="function"?new InputEvent("input",{bubbles:!0}):new Event("input",{bubbles:!0});e.dispatchEvent(t)}catch{try{let n=document.createEvent("Event");n.initEvent("input",!0,!1),e.dispatchEvent(n)}catch{}}}function Lp(e){let t=u.editingUndo;if(!t||!t.blockId||!e||u.mode!=="edit"||u.editingBlockId!==t.blockId)return!1;let n=document.querySelector(`.block[data-block-id="${t.blockId}"] .block-text[contenteditable="true"]`);if(!n)return!1;let r=t.index+e;if(r<0||r>=t.snapshots.length)return!1;t.index=r;let o=t.snapshots[r];n.innerHTML=o;try{n.focus({preventScroll:!0})}catch{n.focus()}try{let i=window.getSelection&&window.getSelection();if(i){let s=document.createRange();s.selectNodeContents(n),s.collapse(!1),i.removeAllRanges(),i.addRange(s)}}catch{}return!0}function Zs(e=""){let t=Gn(e);if(!t.titleHtml)return e||"";let n=oa(t.titleHtml),r=t.bodyHtml||"";if(r){let i=document.createElement("template");i.innerHTML=r;let s=i.content.firstChild;for(;s&&fr(s);){let a=s;s=s.nextSibling,i.content.removeChild(a)}r=i.innerHTML}let o=oa(r||"");return`${n}<p><br /></p>${o}`}function Sl(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll(".block-header").forEach(i=>{let s=i.parentNode;if(s){for(;i.firstChild;)s.insertBefore(i.firstChild,i);s.removeChild(i)}});let n=t.innerHTML,r=Gn(n);if(!r.titleHtml)return e||"";let o=`<div class="block-header">${r.titleHtml}</div>`;return r.bodyHtml?`${o}<div><br /></div>${r.bodyHtml}`:o}async function ea(e){let t=Et(e);t&&Bi(e,!t.block.collapsed)}async function Bi(e,t){let n=Et(e);if(!n||n.block.collapsed===t)return;let r=()=>{let s=document.getElementById("blocksContainer");if(!s)return null;let a=u.currentBlockId;if(!a)return{container:s};let c=s.querySelector(`.block[data-block-id="${a}"]`);if(!c)return{container:s};let l=s.getBoundingClientRect(),d=c.getBoundingClientRect();return{container:s,currentId:a,topOffset:d.top-l.top}},o=s=>{if(!s?.container)return;let{container:a}=s;if(!s.currentId||typeof s.topOffset!="number")return;let c=a.querySelector(`.block[data-block-id="${s.currentId}"]`);if(!c)return;let l=a.getBoundingClientRect(),m=c.getBoundingClientRect().top-l.top;a.scrollTop+=m-s.topOffset},i=r();n.block.collapsed=t,await hn(e),To({scrollIntoView:!1}),o(i);try{let s=await Nt(`/api/articles/${u.articleId}/collapse`,{method:"PATCH",body:JSON.stringify({blockId:e,collapsed:t})});s?.updatedAt&&(u.article.updatedAt=s.updatedAt)}catch(s){n.block.collapsed=!t,await hn(e),To({scrollIntoView:!1}),o(i),ve(s.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430")}}function Pp(e,t){let n=Et(e);for(;n;){let o=!!Gn(n.block.text||"").titleHtml,i=!!n.block.children?.length;if((o||i)&&n.block.collapsed!==t)return n.block.id;if(!n.parent)break;n=Et(n.parent.id)}return null}async function _p(e){let t=Et(e);if(!t)return;let n=(t.ancestors||[]).filter(r=>r.collapsed);for(let r of n)await Bi(r.id,!1)}function wi(e){let t=Et(e);if(!t)return null;let n=t.siblings?.[t.index+1];if(n)return n.id;let r=t.siblings?.[t.index-1];return r?r.id:t.parent?t.parent.id:null}function js(e=[]){return(e||[]).reduce((t,n)=>t+1+js(n.children||[]),0)}async function da(e,t,n){if(!u.articleId){ve("\u041D\u0435 \u0432\u044B\u0431\u0440\u0430\u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044F \u0434\u043B\u044F \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0444\u0430\u0439\u043B\u0430");return}let r=`att-${Date.now()}-${Math.random().toString(16).slice(2)}`,o=Zt(t?.name||"\u0444\u0430\u0439\u043B"),i=t?.name||"\u0444\u0430\u0439\u043B",s="";ln("attachment: uploading to Yandex Disk",{name:t?.name,type:t?.type,size:t?.size,articleId:u.articleId,token:r});try{pr(e),er(e,`<a data-pending-attachment="true" data-attachment-token="${r}">${o} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430...)</a>`)}catch{}try{let a=await ti(u.articleId,t,{onProgress:h=>{let b=Math.max(0,Math.min(100,Math.round(h||0)));ln("attachment upload progress",{percent:b,name:t?.name});try{let w=e,f=w.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);if(n&&(!f||!w.isConnected)){let p=document.querySelector(`.block[data-block-id="${n}"]`);if(p){let x=p.querySelector('.block-text[contenteditable="true"]')||p.querySelector(".block-text.block-body");x&&(w=x,f=w.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`))}}if(f){let p=b>=100?`${i} (\u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0430...)`:`${i} (${b}%)`;p!==s&&(s=p,f.textContent=p)}}catch{}}}),c=Zt(a.originalName||t.name||"\u0444\u0430\u0439\u043B"),l=a.storedPath||a.url||"",d=cd(l),m=Zt(d);if(m){let h=e,b=h.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);if(n&&(!b||!h.isConnected)){let w=document.querySelector(`.block[data-block-id="${n}"]`);if(w){let p=w.querySelector('.block-text[contenteditable="true"]')||w.querySelector(".block-text.block-body");p&&(h=p,b=h.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`))}}b?(b.removeAttribute("data-pending-attachment"),b.removeAttribute("data-attachment-token"),b.setAttribute("href",m),b.setAttribute("target","_blank"),b.setAttribute("rel","noopener noreferrer"),b.textContent=c):(pr(h),er(h,`<a href="${m}" target="_blank" rel="noopener noreferrer">${c}</a>`))}}catch(a){try{let l=e;if(n&&!l.isConnected){let m=document.querySelector(`.block[data-block-id="${n}"]`);if(m){let b=m.querySelector('.block-text[contenteditable="true"]')||m.querySelector(".block-text.block-body");b&&(l=b)}}let d=l.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);d&&(d.textContent=`${o} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`)}catch{}let c=String(a?.message||"").toLowerCase();c.includes("status 0")||c.includes("network error")?ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B (\u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C). \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438, \u043F\u0440\u0438 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u043E\u0441\u0442\u0438, \u0432\u043E\u0439\u0434\u0438\u0442\u0435 \u0437\u0430\u043D\u043E\u0432\u043E."):ve(a.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u043D\u0430 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A")}}function ta(e,t=[],n){if(!e||!t||!t.length)return;let r=Array.from(t),o=r.filter(s=>vr(s)),i=r.filter(s=>s&&!vr(s));o.forEach(s=>Ti(e,s,n)),i.forEach(s=>da(e,s,n))}function na(e,t){ad(e,t);let n=e.closest(".block-content");n&&n!==e&&ad(n,t,e),e.addEventListener("paste",r=>{if(u.mode!=="edit"||u.editingBlockId!==t)return;let o=aa(r.clipboardData?.items),i=ca(r.clipboardData?.items);if(o.length>0)r.preventDefault(),o.forEach(s=>Ti(e,s,t));else if(i.length>0)r.preventDefault(),ln("paste: non-image files detected",i.map(s=>({name:s.name,type:s.type,size:s.size}))),i.forEach(s=>da(e,s,t));else{r.preventDefault();let s=h=>{let b=String(h||"").trim();if(!b)return"";let w=document.createElement("template");w.innerHTML=b;let f=w.content.querySelector("body");return((f?f.innerHTML:w.innerHTML)||"").replace(/<!--\s*StartFragment\s*-->/gi,"").replace(/<!--\s*EndFragment\s*-->/gi,"").trim()},a=h=>{let b=String(h||"").trim();if(!b)return"";if(/<\s*(table|ul|ol)\b/i.test(b)||!/<\s*(p|div|h[1-6])\b/i.test(b))return b;let w=document.createElement("template");w.innerHTML=b,(A=>{w.content.querySelectorAll(A).forEach(I=>{let N=I.parentNode;if(N){for(;I.firstChild;)N.insertBefore(I.firstChild,I);N.removeChild(I)}})})("ms-cmark-node");let p=[],y=A=>{let I=String(A||"").replace(/^\s*(<br\s*\/?>\s*)+/gi,"").replace(/(\s*<br\s*\/?>\s*)+$/gi,"").trim();I&&p.push(I)},x=Array.from(w.content.childNodes||[]);for(let A of x){if(!A)continue;if(A.nodeType===Node.TEXT_NODE){let N=(A.textContent||"").replace(/\u00a0/g," ").trim();N&&y(Zt(N));continue}if(A.nodeType!==Node.ELEMENT_NODE)continue;let I=(A.tagName||"").toUpperCase();if(/^H[1-6]$/.test(I)){y(`<strong>${A.innerHTML||""}</strong>`);continue}if(I==="P"||I==="DIV"||I==="LI"||I==="BLOCKQUOTE"){y(A.innerHTML||"");continue}if(I==="BR"){y("<br />");continue}y(A.outerHTML||A.innerHTML||"")}return p.length?p.join("<br /><br />"):""},c=h=>{pr(e);try{e.focus({preventScroll:!0})}catch{e.focus()}try{if(typeof document.execCommand=="function"&&document.execCommand("insertHTML",!1,h))return!0}catch{}return er(e,h),!0},l=h=>{let b=s(h);if(!b)return!1;let f=(I=>{let N=document.createElement("template");N.innerHTML=String(I||"");let $=!1;return N.content.querySelectorAll("img").forEach(q=>{let z=String(q.getAttribute("src")||"").trim();if(!/^(blob:|filesystem:)/i.test(z))return;$=!0;let X=String(q.getAttribute("alt")||"").trim()||"image",Q=q.closest?.(".resizable-image")||q;try{Q.replaceWith(document.createTextNode(`[${X} \u2014 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0438\u0437 \u0431\u0443\u0444\u0435\u0440\u0430 \u043E\u0431\u043C\u0435\u043D\u0430 (blob:) \u043D\u0435 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E]`))}catch{}}),{html:N.innerHTML,hadUnstable:$}})(b);f.hadUnstable&&ve("\u041A\u0430\u0440\u0442\u0438\u043D\u043A\u0430 \u0431\u044B\u043B\u0430 \u0432\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u0430 \u043A\u0430\u043A blob: URL \u0438 \u043D\u0435 \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u0441\u044F \u043F\u043E\u0441\u043B\u0435 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438. \u0412\u0441\u0442\u0430\u0432\u044C\u0442\u0435 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u043A\u0430\u043A \u0444\u0430\u0439\u043B (\u043F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435/\u0432\u0441\u0442\u0430\u0432\u044C\u0442\u0435 \u0444\u0430\u0439\u043B \u0438\u043B\u0438 \u0441\u043A\u0440\u0438\u043D\u0448\u043E\u0442).");let p=Gl(f.html),y=a(p);if(!y)return!1;let x=vi(p),A=vi(y)||x;return c(Bo(A)),No(e),!0},d=h=>{let b=String(h||""),w=b.trim();if(/^https?:\/\/\S+$/i.test(w)){let A=Zt(w);return pr(e),er(e,`<a href="${A}" target="_blank" rel="noopener noreferrer">${A}</a>`),No(e),!0}let p=b.replace(/\r\n/g,`
`).replace(/\r/g,`
`),y=Zt(p).replace(/\n{2,}/g,"<br /><br />").replace(/\n/g,"<br />"),x=Bo(vi(y));return c(x),No(e),!0},m=(r.clipboardData?.getData("text/html")||"").trim();if(m&&l(m))return;try{let b=Array.from(r.clipboardData?.items||[]).find(w=>w&&w.kind==="string"&&w.type==="text/html");if(b&&typeof b.getAsString=="function"){b.getAsString(w=>{try{if(l(w))return}catch{}try{let f=r.clipboardData?.getData("text/plain")||"";d(f)}catch{}});return}}catch{}{let h=r.clipboardData?.getData("text/plain")||"";d(h)}}}),e.addEventListener("drop",r=>{if(u.mode!=="edit"||u.editingBlockId!==t){ln("drop ignored",{mode:u.mode,editingBlockId:u.editingBlockId,targetBlockId:t});return}let o=Array.from(r.dataTransfer?.files||[]);if(!o.length)return;let i=o.filter(a=>a.type?.startsWith("image/")),s=o.filter(a=>!a.type||!a.type.startsWith("image/"));!i.length&&!s.length||(r.preventDefault(),ln("drop: files detected",o.map(a=>({name:a.name,type:a.type,size:a.size}))),i.forEach(a=>Ti(e,a,t)),s.forEach(a=>da(e,a,t)))}),e.addEventListener("click",r=>{let o=r.target?.closest("img");if(o){if(r.target?.closest(".resizable-image__handle")){r.preventDefault();return}r.preventDefault(),bo(o.src,o.alt||"");return}let i=r.target?.closest("a[href]");if(!i)return;let s=i.getAttribute("href")||"";if(!s.startsWith("app:/")&&!s.startsWith("disk:/"))return;r.preventDefault();let a=cd(s);a&&window.open(a,"_blank","noopener,noreferrer")}),u.articleId==="inbox"&&e.addEventListener("click",async r=>{if(r.target?.closest(".move-block-btn")){r.preventDefault(),r.stopPropagation();try{let s=(u.articlesIndex.length?u.articlesIndex:await Nn()).filter(d=>d.id!=="inbox").map(d=>({id:d.id,title:d.title||"\u0420\u2018\u0420\xB5\u0420\xB7 \u0420\u0405\u0420\xB0\u0420\xB7\u0420\u0406\u0420\xB0\u0420\u0405\u0420\u0451\u0421\u040F"})),a=await ar({title:"\u0420\u045F\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451 \u0420\u0406 \u0421\u0403\u0421\u201A\u0420\xB0\u0421\u201A\u0421\u040A\u0421\u040B",message:"\u0420\u2019\u0420\u0406\u0420\xB5\u0420\u0491\u0420\u0451\u0421\u201A\u0420\xB5 ID \u0420\u0451\u0420\xBB\u0420\u0451 \u0420\u0406\u0421\u2039\u0420\xB1\u0420\xB5\u0421\u0402\u0420\u0451\u0421\u201A\u0420\xB5 \u0421\u0403\u0421\u201A\u0420\xB0\u0421\u201A\u0421\u040A\u0421\u040B",confirmText:"\u0420\u045F\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451",cancelText:"\u0420\u045B\u0421\u201A\u0420\u0458\u0420\xB5\u0420\u0405\u0420\xB0",suggestions:s,returnMeta:!0,hideConfirm:!1}),l=(a?.selectedId||(typeof a=="object"?a?.value:a)||""||"").trim();if(!l)return;await Nt(`/api/articles/${u.articleId}/blocks/${t}/move-to/${l}`,{method:"POST"}),kn(dn.article("inbox"))}catch(i){ve(i.message||"\u0420\u045C\u0420\xB5 \u0421\u0453\u0420\u0491\u0420\xB0\u0420\xBB\u0420\u0455\u0421\u0403\u0421\u040A \u0420\u0457\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451 \u0420\xB1\u0420\xBB\u0420\u0455\u0420\u0454")}}}),e.addEventListener("dragover",r=>{if(u.mode!=="edit"||u.editingBlockId!==t)return;(aa(r.dataTransfer?.items).length>0||ca(r.dataTransfer?.items).length>0)&&r.preventDefault()}),e.addEventListener("keydown",r=>{if(u.mode!=="edit"||u.editingBlockId!==t)return;let o=window.getSelection();if(!o||o.rangeCount===0)return;let i=o.getRangeAt(0);if(!i||!i.collapsed||Yl({event:r,element:e,range:i,selection:o,notifyEditingInput:No,logDebug:ln})||r.key!=="Tab"||!(i.commonAncestorContainer?.nodeType===Node.ELEMENT_NODE?i.commonAncestorContainer:i.commonAncestorContainer?.parentElement)?.closest?.("li"))return;r.preventDefault(),r.stopPropagation();let c=r.shiftKey?"outdent":"indent";document.execCommand(c,!1,null)})}function ld(){let e=window.getSelection();if(!e||e.rangeCount===0)return;let t=e.getRangeAt(0),n=t.commonAncestorContainer,o=(n?.nodeType===Node.ELEMENT_NODE?n:n?.parentElement)?.closest('.block-text[contenteditable="true"]');if(!o){Lo=null;return}let s=o.closest(".block")?.dataset?.blockId;if(u.mode!=="edit"||u.editingBlockId!==s){Lo=null;return}Lo=t.cloneRange()}function Dp(){if(la)return la;id||(document.addEventListener("selectionchange",ld),id=!0);let e=document.createElement("div");e.className="rich-context-menu hidden",e.innerHTML=`
	    <div class="rich-context-menu__col rich-context-menu__col--buffer">
	      <div class="rich-context-menu__grid">
	        <button class="rich-context-menu__icon-btn" data-action="copy" aria-label="\u041A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C" title="\u041A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C"><i class="bx bx-copy" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="cut" aria-label="\u0412\u044B\u0440\u0435\u0437\u0430\u0442\u044C" title="\u0412\u044B\u0440\u0435\u0437\u0430\u0442\u044C"><i class="bx bx-cut" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="paste" aria-label="\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C" title="\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C"><i class="bx bx-paste" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="select-all" aria-label="\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0432\u0441\u0451" title="\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0432\u0441\u0451"><i class="bx bx-select-multiple" aria-hidden="true"></i></button>
	      </div>
	    </div>
	    <div class="rich-context-menu__col">
	      <div class="rich-context-menu__grid">
	        <button class="rich-context-menu__icon-btn" data-action="bold" aria-label="\u041F\u043E\u043B\u0443\u0436\u0438\u0440\u043D\u044B\u0439" title="\u041F\u043E\u043B\u0443\u0436\u0438\u0440\u043D\u044B\u0439"><strong>\u0416</strong></button>
	        <button class="rich-context-menu__icon-btn" data-action="italic" aria-label="\u041A\u0443\u0440\u0441\u0438\u0432" title="\u041A\u0443\u0440\u0441\u0438\u0432"><em>/</em></button>
	        <button class="rich-context-menu__icon-btn" data-action="underline" aria-label="\u041F\u043E\u0434\u0447\u0435\u0440\u043A\u043D\u0443\u0442\u044C" title="\u041F\u043E\u0434\u0447\u0435\u0440\u043A\u043D\u0443\u0442\u044C"><u>\u0427</u></button>
	        <button class="rich-context-menu__icon-btn" data-action="remove-format" aria-label="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0444\u043E\u0440\u043C\u0430\u0442" title="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0444\u043E\u0440\u043C\u0430\u0442"><i class="bx bx-eraser" aria-hidden="true"></i></button>
	      </div>
	    </div>
	    <div class="rich-context-menu__col">
	      <div class="rich-context-menu__grid">
	        <button class="rich-context-menu__icon-btn" data-action="ul" aria-label="\u041C\u0430\u0440\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A" title="\u041C\u0430\u0440\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A"><i class="bx bx-list-ul" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="ol" aria-label="\u041D\u0443\u043C\u0435\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A" title="\u041D\u0443\u043C\u0435\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A"><i class="bx bx-list-ol" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="quote" aria-label="\u0426\u0438\u0442\u0430\u0442\u0430" title="\u0426\u0438\u0442\u0430\u0442\u0430"><i class="bx bx-quote-left" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="code" aria-label="\u041A\u043E\u0434" title="\u041A\u043E\u0434"><i class="bx bx-code-alt" aria-hidden="true"></i></button>
	      </div>
	    </div>
	    <div class="rich-context-menu__col">
	      <div class="rich-context-menu__grid">
	        <button class="rich-context-menu__icon-btn" data-action="link" aria-label="\u0421\u0441\u044B\u043B\u043A\u0430" title="\u0421\u0441\u044B\u043B\u043A\u0430"><i class="bx bx-link" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="unlink" aria-label="\u0423\u0431\u0440\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443" title="\u0423\u0431\u0440\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443"><i class="bx bx-unlink" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="insert-article-link" aria-label="\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E" title="\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E"><i class="bx bx-link-alt" aria-hidden="true"></i></button>
	      </div>
	    </div>
	    <div class="rich-context-menu__col">
	      <div class="rich-context-menu__grid">
	        <button class="rich-context-menu__icon-btn" data-action="split-at-caret" aria-label="\u0420\u0430\u0437\u0434\u0435\u043B\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043F\u043E \u043A\u0443\u0440\u0441\u043E\u0440\u0443" title="\u0420\u0430\u0437\u0434\u0435\u043B\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043F\u043E \u043A\u0443\u0440\u0441\u043E\u0440\u0443"><i class="bx bx-cut" aria-hidden="true"></i></button>
	      </div>
	    </div>
	  `,document.body.appendChild(e);let t=()=>{e.classList.add("hidden"),e.style.visibility="",qt=null,Qr=null,Mo=null},n=()=>{if(qt){let o=window.getSelection();o.removeAllRanges(),o.addRange(qt)}},r=async o=>{n();let i=()=>{if(Qr&&document.contains(Qr))return Qr;let h=window.getSelection()?.anchorNode?.parentElement?.closest(".block-text[contenteditable]");if(h)return h;if(qt){let w=qt.commonAncestorContainer;if(w?.parentElement){let f=w.parentElement.closest(".block-text[contenteditable]");if(f)return f}}if(Mo&&document.contains(Mo))return Mo;if(u.editingBlockId){let w=document.querySelector(`.block[data-block-id="${u.editingBlockId}"] .block-text[contenteditable="true"]`);if(w)return w}let b=document.activeElement;if(b&&b.closest){let w=b.closest(".block-text[contenteditable]");if(w)return w}return null},s=d=>{rd({listTag:d,resolveTarget:i,restoreSelection:n,richContextRange:qt,notifyEditingInput:No,setRichContextRange:m=>{qt=m?m.cloneRange():null}})},a=async()=>{let d=i();if(!d){ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0441\u0441\u044B\u043B\u043A\u0438");return}let m=u.articlesIndex.length?u.articlesIndex:await Nn(),h=m.map(A=>({id:A.id,title:A.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),b="",w="";try{let A=await ar({title:"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438. \u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0438 \u043F\u043E\u043C\u043E\u0433\u0443\u0442 \u043D\u0430\u0439\u0442\u0438 \u043D\u0443\u0436\u043D\u0443\u044E.",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:h,returnMeta:!0,hideConfirm:!0});A&&typeof A=="object"?(b=A.value||"",w=A.selectedId||""):b=A||""}catch{b=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438")||""}let f=(b||"").trim().toLowerCase();if(!f&&!w)return;let p=m.find(A=>{let I=(A.title||"").toLowerCase();return w&&A.id===w||A.id&&A.id.toLowerCase()===f||I===f||I.includes(f)});if(!p){ve("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}if(!d||!document.contains(d)){ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0441\u0441\u044B\u043B\u043A\u0438");return}n(),d.focus();let y=`<a href="${dn.article(p.id)}" class="article-link" data-article-id="${p.id}">${Zt(p.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F")}</a>`;er(d,y);let x=(d.innerHTML||"").trim();(!x||x==="<br>"||x==="<br/>"||x==="<br />")&&(d.innerHTML=y),d.classList.remove("block-body--empty")},c=()=>{n();let d=window.getSelection();if(!(!d||d.rangeCount===0)){document.execCommand("removeFormat");for(let m=0;m<4;m+=1)document.execCommand("outdent");document.execCommand("formatBlock",!1,"p")}},l=d=>{let m=i();if(!m||!document.contains(m))return ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u0442\u0435\u043A\u0441\u0442 \u0434\u043B\u044F \u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F"),null;let h=window.getSelection();if(!h||h.rangeCount===0)return null;let b=h.getRangeAt(0).cloneRange();if(!b||b.collapsed)return null;let w=b.cloneContents(),f=document.createElement("div");f.appendChild(w);let p=f.innerHTML||"",y=f.textContent||"",A=m.closest(".block")?.dataset.blockId||null;return Xr={html:p,text:y,sourceBlockId:A},ln("clipboard.capture",{kind:d,hasHtml:!!p,length:y.length,blockId:A}),{range:b,target:m}};switch(o){case"cut":{if(!l("cut"))break;document.execCommand("cut");break}case"copy":l("copy"),document.execCommand("copy");break;case"select-all":{let d=i();if(!d||!document.contains(d))break;let m=document.createRange();m.selectNodeContents(d);let h=window.getSelection();h&&(h.removeAllRanges(),h.addRange(m)),qt=m.cloneRange();break}case"paste":{let d=i();if(!d||!document.contains(d)){ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438");break}if(!Xr||!Xr.html&&!Xr.text){ve("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0441\u043A\u043E\u043F\u0438\u0440\u0443\u0439\u0442\u0435 \u0438\u043B\u0438 \u0432\u044B\u0440\u0435\u0436\u044C\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u0432 \u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440\u0435");break}n();let m=window.getSelection(),h=null;if(qt&&d.contains(qt.commonAncestorContainer))h=qt.cloneRange();else if(m&&m.rangeCount>0){let p=m.getRangeAt(0);d.contains(p.commonAncestorContainer)&&(h=p.cloneRange())}h||(h=document.createRange(),h.selectNodeContents(d),h.collapse(!1));let b=Xr.html||Zt(Xr.text).replace(/\n/g,"<br />"),w=document.createElement("div");w.innerHTML=b;let f=document.createDocumentFragment();for(;w.firstChild;)f.appendChild(w.firstChild);h.deleteContents(),h.insertNode(f),h.collapse(!1),m&&(m.removeAllRanges(),m.addRange(h)),d.focus({preventScroll:!0}),d.classList.remove("block-body--empty");break}case"bold":document.execCommand("bold");break;case"italic":document.execCommand("italic");break;case"underline":document.execCommand("underline");break;case"ul":s("ul");break;case"ol":s("ol");break;case"quote":document.execCommand("formatBlock",!1,"blockquote");break;case"code":document.execCommand("formatBlock",!1,"pre");break;case"link":{let d=window.getSelection(),m=d?d.toString():"",h=d?.anchorNode,b=h?h.parentElement?.closest("a"):null,w=b?.getAttribute("href")||"",f=await ws({title:"\u0421\u0441\u044B\u043B\u043A\u0430",textLabel:"\u0422\u0435\u043A\u0441\u0442",urlLabel:"\u0421\u0441\u044B\u043B\u043A\u0430",defaultText:m||b?.textContent||"",defaultUrl:w,confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"});if(ln("link action: prompt result",{hasResult:!!f,url:f?.url,text:f?.text}),!f||!f.url)break;let p=f.url.match(/^[a-z]+:/i)?f.url:`https://${f.url}`,y=f.text?.trim()||p;n();let x=i();if(ln("link action: target",{targetExists:!!x,inDom:!!(x&&document.contains(x)),className:x?.className}),!x||!document.contains(x))break;let A=window.getSelection(),I=null;qt&&x.contains(qt.commonAncestorContainer)?I=qt.cloneRange():A&&A.rangeCount>0&&x.contains(A.getRangeAt(0).commonAncestorContainer)&&(I=A.getRangeAt(0).cloneRange()),I||(I=document.createRange(),I.selectNodeContents(x),I.collapse(!1)),ln("link action: range chosen",{usedSelectionRange:!!(A&&A.rangeCount>0&&x.contains(A.getRangeAt(0).commonAncestorContainer)),usedStoredRange:!!(qt&&x.contains(qt.commonAncestorContainer)),selectionRangeCollapsed:!!(A&&A.rangeCount>0&&A.getRangeAt(0).collapsed),rangeStartNode:I?.startContainer?.nodeName,rangeOffset:I?.startOffset,labelLength:(y||"").length,url:p});let N=document.createElement("a");N.href=p,N.target="_blank",N.rel="noopener noreferrer",N.textContent=y,I.deleteContents(),I.insertNode(N),I.setStartAfter(N),I.setEndAfter(N),ln("link action: inserted link",{outerHTML:N.outerHTML,parentClass:N.parentElement?.className,targetInner:x.innerHTML.slice(0,120)}),A&&(A.removeAllRanges(),A.addRange(I)),x.focus({preventScroll:!0}),x.classList.remove("block-body--empty");break}case"unlink":{let d=i();if(ln("unlink action: target",{targetExists:!!d,inDom:!!(d&&document.contains(d)),className:d?.className}),!d||!document.contains(d))break;let m=window.getSelection(),h=null;if(m&&m.rangeCount>0){let b=m.getRangeAt(0).commonAncestorContainer;h=b?.parentElement?.closest("a")||b?.closest?.("a")}if(!h&&qt){let b=qt.commonAncestorContainer;h=b?.parentElement?.closest("a")||b?.closest?.("a")}if(h||(h=d.querySelector("a")),h){let b=document.createTextNode(h.textContent||"");h.replaceWith(b)}else document.execCommand("unlink");break}case"remove-format":c();break;case"insert-article-link":a().finally(()=>{t()});return;case"split-at-caret":await kl();break;default:break}t()};return e.addEventListener("click",o=>{let i=o.target.closest("button[data-action]");if(!i)return;let s=i.dataset.action;r(s)}),document.addEventListener("click",o=>{e.classList.contains("hidden")||e.contains(o.target)||t()}),document.addEventListener("touchstart",o=>{e.classList.contains("hidden")||e.contains(o.target)||t()},{passive:!0}),document.addEventListener("keydown",o=>{o.code==="Escape"&&t()}),window.addEventListener("scroll",t,!0),la=e,e}function sd(e){let t=Dp();t.classList.remove("hidden"),t.style.visibility="hidden",ld();let n=window.getSelection();n&&n.rangeCount>0?qt=n.getRangeAt(0).cloneRange():Lo?qt=Lo.cloneRange():qt=null;let r=t.getBoundingClientRect(),o=22,i=12,s=e.clientX+14,a=e.clientY+o;a+r.height+i>window.innerHeight&&(a=Math.max(i,e.clientY-r.height-o));let c=Math.min(Math.max(s,i),window.innerWidth-r.width-i),l=Math.min(Math.max(a,i),window.innerHeight-r.height-i);t.style.left=`${c}px`,t.style.top=`${l}px`,t.style.visibility="visible"}function ad(e,t,n){let r=n||e;e.addEventListener("focusin",()=>{Mo=r}),e.addEventListener("contextmenu",s=>{u.mode!=="edit"||u.editingBlockId!==t||(s.preventDefault(),Qr=r,sd(s))});let o=null;e.addEventListener("touchstart",s=>{if(u.mode!=="edit"||u.editingBlockId!==t||s.touches.length!==1)return;let a=s.touches[0];o=window.setTimeout(()=>{Qr=r,sd({clientX:a.clientX,clientY:a.clientY})},500)},{passive:!0});let i=()=>{o!==null&&(clearTimeout(o),o=null)};e.addEventListener("touchend",i,{passive:!0}),e.addEventListener("touchcancel",i,{passive:!0})}async function zs(e){if(!e)return;let t=Et(e);if(!t)return;let n=(t.ancestors||[]).filter(r=>r.collapsed);for(let r of n)await Bi(r.id,!1)}var Tp,la,qt,Qr,Mo,Xr,Lo,id,Un=et(()=>{Ht();mn();an();Ir();Fn();cr();mn();lr();lr();Ks();Wl();ia();Ql();sa();nd();od();Tp=16;la=null,qt=null,Qr=null,Mo=null,Xr={html:"",text:"",sourceBlockId:null},Lo=null,id=!1;td()});function Op(){let e=u?.currentUser||null;return e&&(e.id||e.username)||"anon"}async function Ni(){return Ko({userKey:Op()})}async function dd(e={}){let t=String(e?.token||"").trim(),n=String(e?.articleId||"").trim();if(!t||!n)return!1;let r=String(e?.kind||"image"),o=e?.blob||null,i=String(e?.mime||o&&o.type||"").trim(),s=String(e?.fileName||"").trim()||null,a=Date.now(),l=(await Ni()).transaction(["pending_uploads"],"readwrite"),d=l.objectStore("pending_uploads"),m=await Fe(d.get(t)).catch(()=>null),h=Number(m?.createdAtMs||e?.createdAtMs||a)||a,b={token:t,articleId:n,kind:r,blob:o,mime:i,fileName:s,status:String(e?.status||m?.status||"pending"),errorMessage:String(e?.errorMessage||m?.errorMessage||""),createdAtMs:h,updatedAtMs:a};return await Fe(d.put(b)),await nt(l),!0}async function ua(e){let t=String(e||"").trim();if(!t)return!1;let r=(await Ni()).transaction(["pending_uploads"],"readwrite"),o=r.objectStore("pending_uploads");return await Fe(o.delete(t)),await nt(r),!0}async function fa(e,t){let n=String(e||"").trim();if(!n)return!1;let o=(await Ni()).transaction(["pending_uploads"],"readwrite"),i=o.objectStore("pending_uploads"),s=await Fe(i.get(n)).catch(()=>null);return s?(s.status="error",s.errorMessage=String(t||"error"),s.updatedAtMs=Date.now(),await Fe(i.put(s)),await nt(o),!0):(await nt(o),!1)}async function pa({articleId:e=null,limit:t=50}={}){let r=(await Ni()).transaction(["pending_uploads"],"readonly"),o=r.objectStore("pending_uploads"),i=[];try{let s=Number(t||0)||0;if(e){let a=o.index("byArticleId");i=await Fe(a.getAll(String(e),s>0?s:void 0))}else i=await Fe(o.getAll(s>0?s:void 0))}catch{i=[]}return await nt(r),Array.isArray(i)?(i.sort((s,a)=>Number(s?.createdAtMs||0)-Number(a?.createdAtMs||0)),i):[]}var ud=et(()=>{Ht();ns();Ln()});var Mi,fd=et(()=>{Mi=["pending-attachment","app","disk"]});function ma(e){let n=String(e||"").replace(/\r\n/g,`
`).split(`
`),r=c=>{let l=String(c||"").match(/^(#{1,6})\s+(.*)$/);if(!l)return null;let d=String(l[2]||"").trim();return d?{level:l[1].length,title:d}:null},o=!1;try{let c=n.find(l=>String(l||"").trim().length>0)||"";o=!!r(c)}catch{o=!1}let i=[],s=null,a=()=>{if(s){try{for(;s.bodyLines.length&&!String(s.bodyLines[0]||"").trim();)s.bodyLines.shift()}catch{}s.bodyText=s.bodyLines.join(`
`).trimEnd(),delete s.bodyLines,i.push(s),s=null}};for(let c of n){let l=r(c);if(l){a(),s={level:l.level,title:l.title,bodyLines:[]};continue}s&&s.bodyLines.push(c)}return a(),{sections:i,startsWithHeading:o,headingCount:i.length}}function pd(e,t={}){let n=Array.isArray(e)?e.filter(Boolean):[],r=typeof t.makeId=="function"?t.makeId:()=>`${Date.now()}-${Math.random()}`;if(!n.length)return[];let o=Number.isFinite(t.baseLevel)?t.baseLevel:Number(n[0].level||1),i=[],s=[];for(let a of n){let c=Number(a.level||1),l=String(a.title||"").trim(),d=String(a.bodyText||"").trimEnd();if(!l)continue;let m=Math.max(0,c-o);for(;s.length>m;)s.pop();m>s.length&&(m=s.length);let h={id:r(),title:l,bodyText:d,children:[]},b=m>0?s[m-1]:null;b?b.children.push(h):i.push(h),s.push(h)}return i}var md=et(()=>{});var Sa={};Uo(Sa,{flushOutboxOnce:()=>Zr,getBackgroundFullPullStatus:()=>Jp,startBackgroundFullPull:()=>nm,startSyncLoop:()=>tm,tryPullBootstrap:()=>Yp});function Rp(e,t=null){try{if(!e)return;let n=window.localStorage.getItem(Li)||"";if(!n)return;let r=JSON.parse(n);if(!r||typeof r!="object")return;let o=String(e),i=r[o]||null;if(!i)return;let s=Number(i?.queuedAt||0)||0,a=typeof t=="number"&&Number.isFinite(t)?t:null;if(a!=null&&s>a)return;delete r[o],window.localStorage.setItem(Li,JSON.stringify(r))}catch{}}function Fp(e,t){try{let n=e&&typeof e=="object"?e:{type:"doc",content:[]},r=Array.isArray(n.content)?n.content:[],o=new Map,i=d=>{if(Array.isArray(d))for(let m of d){if(!m||typeof m!="object"||m.type!=="outlineSection")continue;let h=String(m?.attrs?.id||"").trim();h&&o.set(h,m);let w=(Array.isArray(m.content)?m.content:[]).find(f=>f&&typeof f=="object"&&f.type==="outlineChildren")||null;w&&Array.isArray(w.content)&&i(w.content)}};i(r);let s=(d,m)=>{let h=d&&typeof d=="object"?d:{type:"outlineSection",attrs:{id:m,collapsed:!1},content:[]};h.type="outlineSection";let b=h.attrs&&typeof h.attrs=="object"?h.attrs:{};b.id=m,h.attrs=b;let w=Array.isArray(h.content)?h.content:[],f=w.find(x=>x&&typeof x=="object"&&x.type==="outlineHeading")||{type:"outlineHeading",content:[]},p=w.find(x=>x&&typeof x=="object"&&x.type==="outlineBody")||{type:"outlineBody",content:[{type:"paragraph"}]},y=w.find(x=>x&&typeof x=="object"&&x.type==="outlineChildren")||{type:"outlineChildren",content:[]};return Array.isArray(y.content)||(y={...y,content:[]}),h.content=[f,p,y],h},a=new Set,c=new Map;for(let d of Array.isArray(t)?t:[]){let m=String(d?.sectionId||"").trim();if(!m)continue;let h=d?.parentId,b=h!=null&&String(h).trim()?String(h).trim():null,w=Number.isFinite(Number(d?.position))?Number(d.position):0,f=!!d?.collapsed,p=s(o.get(m),m);p.attrs={...p.attrs||{},id:m,collapsed:f},o.set(m,p),a.add(m),c.has(b)||c.set(b,[]),c.get(b).push({pos:w,sid:m,sec:p})}for(let[d,m]of c.entries())m.sort((h,b)=>h.pos-b.pos||String(h.sid).localeCompare(String(b.sid))),c.set(d,m);for(let[d,m]of o.entries()){let b=(c.get(d)||[]).map(w=>w.sec);try{Array.isArray(m.content)||(m.content=[]),(!m.content[2]||m.content[2].type!=="outlineChildren")&&(m.content[2]={type:"outlineChildren",content:[]}),m.content[2].content=b}catch{}}let l=(c.get(null)||[]).map(d=>d.sec);for(let[d,m]of o.entries())a.has(d)||l.push(m);return n.type="doc",n.content=l,n}catch{return e}}function zp(e,t,n,r){try{let o=String(t||"").trim();if(!o)return e;let i=e&&typeof e=="object"?e:{type:"doc",content:[]},s=[i];for(;s.length;){let a=s.pop();if(!a||typeof a!="object")continue;if(a.type==="outlineSection"&&String(a?.attrs?.id||"").trim()===o){let d=(Array.isArray(a.content)?a.content:[]).find(m=>m&&typeof m=="object"&&m.type==="outlineChildren")||{type:"outlineChildren",content:[]};return a.content=[n,r,d],i}let c=a.content;if(Array.isArray(c))for(let l of c)s.push(l)}return i}catch{return e}}function ba(e){let t=e?.type||"";return t==="section_upsert_content"||t==="delete_sections"||t==="structure_snapshot"}function Up(e,t,n){try{let r=String(e||"").trim(),o=String(t||"").trim(),i=Number(n);if(!r||!o||!Number.isFinite(i)||i<=0)return;let s="ttree_outline_section_seq_v1",a=window.localStorage.getItem(s)||"",c=a?JSON.parse(a):{},l=c&&typeof c=="object"?c:{},d=(l[r]&&typeof l[r]=="object"?l[r]:{})||{};if((Number(d[o]||0)||0)>=i)return;d[o]=i,l[r]=d,window.localStorage.setItem(s,JSON.stringify(l))}catch{}}function qp(e){let t=[],n=(i,s)=>{if(!Array.isArray(i))return;let a=0;for(let c of i){if(!c||typeof c!="object"||c.type!=="outlineSection")continue;let l=String(c?.attrs?.id||"").trim();if(!l)continue;t.push({sectionId:l,parentId:s||null,position:a,collapsed:!!c?.attrs?.collapsed}),a+=1;let m=(Array.isArray(c.content)?c.content:[]).find(b=>b&&typeof b=="object"&&b.type==="outlineChildren")||null,h=m&&Array.isArray(m.content)?m.content:[];n(h,l)}},r=e&&typeof e=="object"?e:null,o=r&&Array.isArray(r.content)?r.content:[];return n(o,null),t}function Kp(e,t){try{let n=e&&typeof e=="object"?{...e}:null;if(!n||n.type!=="outlineHeading")return e;let r=String(t||"");if(!r)return e;let o=Array.isArray(n.content)?[...n.content]:[];return o.unshift({type:"text",text:r}),n.content=o,n}catch{return e}}function Vp(e,t,n){let r=e&&typeof e=="object"?e:{type:"doc",content:[]};Array.isArray(r.content)||(r.content=[]);let o=String(t||"").trim(),i=a=>{for(let c=0;c<a.length;c+=1){let l=a[c];if(!l||typeof l!="object"||l.type!=="outlineSection")continue;let d=String(l?.attrs?.id||"").trim();if(o&&d===o)return a.splice(c+1,0,n),!0;let h=(Array.isArray(l.content)?l.content:[]).find(b=>b&&typeof b=="object"&&b.type==="outlineChildren")||null;if(h&&Array.isArray(h.content)&&i(h.content))return!0}return!1};return i(r.content)||r.content.push(n),r}function jp(){try{return window?.localStorage?.getItem?.("ttree_debug_offline_v1")==="1"}catch{return!1}}function Sd(...e){try{if(!jp())return;console.log("[offline][queue]",...e)}catch{}}function xd(){try{let e=window.localStorage.getItem(Li)||"";if(!e)return{changed:!1,removed:0};let t=JSON.parse(e);if(!t||typeof t!="object")return{changed:!1,removed:0};let n=Object.keys(t);if(!n.length)return{changed:!1,removed:0};let r=0;for(let o of n)o!=="inbox"&&(delete t[o],r+=1);return r?(window.localStorage.setItem(Li,JSON.stringify(t)),Sd("prune.queue",{removed:r}),{changed:!0,removed:r}):{changed:!1,removed:0}}catch(e){return Sd("prune.queue.error",{message:e?.message||String(e||"error")}),{changed:!1,removed:0}}}function hr(){try{window.dispatchEvent(new CustomEvent("offline-full-pull-status",{detail:{...Ft}}))}catch{}}function Jp(){return{...Ft}}async function yn(e,t={}){let n=await fetch(e,{headers:{"Content-Type":"application/json",...t.headers||{}},credentials:"include",...t});if(!n.ok){let r=await n.json().catch(()=>({})),o=new Error(r.detail||"Request failed");throw o.status=n.status,o.details=r,o.path=e,o}return n.status===204?null:n.json()}function wd(e){let t=Number(e?.status||0);return!t||t>=500||t===408||t===429||t===401||t===403}function Wp(e,t){let n=Number(e?.status||0);return n===404||n===410?!0:n>=400&&n<500&&n!==401&&n!==403&&n!==408&&n!==429?t?.type==="save_doc_json"||String(t?.type||"").startsWith("section_")||t?.type==="structure_snapshot"||t?.type==="delete_sections":!1}async function Yp(){try{let e=await Nn();return Jn(e).catch(()=>{}),Array.isArray(e)?e:[]}catch{return null}}function Gp(e,t){try{let n=new Set((Array.isArray(t)?t:[]).map(i=>String(i||"").trim()).filter(Boolean));if(!n.size)return e;let r=e&&typeof e=="object"?e:{type:"doc",content:[]},o=i=>{if(!Array.isArray(i))return[];let s=[];for(let a of i)if(!(!a||typeof a!="object")){if(a.type==="outlineSection"){let c=String(a?.attrs?.id||"").trim();if(c&&n.has(c))continue;let d=(Array.isArray(a.content)?a.content:[]).find(m=>m&&typeof m=="object"&&m.type==="outlineChildren")||null;d&&Array.isArray(d.content)&&(d.content=o(d.content))}s.push(a)}return s};return Array.isArray(r.content)?r.content=o(r.content):r.content=[],r.type=r.type||"doc",r}catch{return e}}async function Xp(e){if(e.type==="create_article"){let t=e.payload?.title||"\u041D\u043E\u0432\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F",n=e.payload?.id||e.articleId,r=e.payload?.parentId??null,o=await yn("/api/articles",{method:"POST",body:JSON.stringify({title:t,id:n,parentId:r})});await qr(o);return}if(e.type==="save_doc_json"){let t=e.payload?.docJson||null;if(!t||typeof t!="object")return;let n=await yn(`/api/articles/${encodeURIComponent(e.articleId)}/doc-json/save`,{method:"PUT",body:JSON.stringify({docJson:t,createVersionIfStaleHours:12})}),r=n?.updatedAt||null;await xn(e.articleId,t,r);try{gt("sync.flush.save_doc_json.ok",{articleId:e.articleId,opId:e.id,updatedAt:r,docHash:Ut(t)})}catch{}try{let o=Array.isArray(n?.changedBlockIds)?n.changedBlockIds:[],i=Array.isArray(n?.removedBlockIds)?n.removedBlockIds:[];if(i.length&&await Zo(i),o.length){let s=await yn(`/api/articles/${encodeURIComponent(e.articleId)}/embeddings?ids=${encodeURIComponent(o.join(","))}`);await ms(e.articleId,s?.embeddings||[])}}catch{}return}if(e.type==="section_upsert_content"){let t=e.payload?.sectionId||null,n=e.payload?.headingJson||null,r=e.payload?.bodyJson||null,o=e.payload?.seq||null;if(!t||!n||!r||!o)return;let i=await yn(`/api/articles/${encodeURIComponent(e.articleId)}/sections/upsert-content`,{method:"PUT",body:JSON.stringify({opId:e.payload?.opId||e.id,sectionId:t,headingJson:n,bodyJson:r,seq:o,createVersionIfStaleHours:12})});try{if(i?.updatedAt){let s=await Zn(e.articleId).catch(()=>null),a=s?.docJson&&typeof s.docJson=="object"?s.docJson:null;if(a){let c=zp(a,t,n,r);await xn(e.articleId,c,i.updatedAt)}}try{gt("sync.flush.section_upsert_content.ok",{articleId:e.articleId,opId:e.id,sectionId:t,updatedAt:i?.updatedAt||null})}catch{}}catch{}return}if(e.type==="structure_snapshot"){let t=e.payload?.nodes||null;if(!Array.isArray(t)||!t.length)return;let n=await yn(`/api/articles/${encodeURIComponent(e.articleId)}/structure/snapshot`,{method:"PUT",body:JSON.stringify({opId:e.payload?.opId||e.id,nodes:t})});try{if(n?.updatedAt){let r=await Zn(e.articleId).catch(()=>null),o=r?.docJson&&typeof r.docJson=="object"?r.docJson:null;if(o){let i=Fp(o,t);await xn(e.articleId,i,n.updatedAt)}}try{gt("sync.flush.structure_snapshot.ok",{articleId:e.articleId,opId:e.id,updatedAt:n?.updatedAt||null,nodesCount:Array.isArray(t)?t.length:null})}catch{}}catch{}return}if(e.type==="delete_sections"){let t=Array.isArray(e.payload?.sectionIds)?e.payload.sectionIds:[];if(!t.length)return;let n=await Pc(e.articleId,t,{opId:e.payload?.opId||e.id});try{let r=n?.updatedAt||null,o=await Zn(e.articleId).catch(()=>null),i=o?.docJson&&typeof o.docJson=="object"?o.docJson:null;if(i&&r){let a=Gp(i,t);await xn(e.articleId,a,r)}let s=Array.isArray(n?.removedBlockIds)?n.removedBlockIds:[];s.length&&await Zo(s),gt("sync.flush.delete_sections.ok",{articleId:e.articleId,opId:e.id,updatedAt:r||null,sectionIdsCount:t.length,removedCount:s.length})}catch{}return}if(e.type==="move_article_position"){let t=e.payload?.direction||null;if(!t)return;await yn(`/api/articles/${encodeURIComponent(e.articleId)}/move`,{method:"POST",body:JSON.stringify({direction:t})});return}if(e.type==="indent_article"){await yn(`/api/articles/${encodeURIComponent(e.articleId)}/indent`,{method:"POST",body:JSON.stringify({})});return}if(e.type==="outdent_article"){await yn(`/api/articles/${encodeURIComponent(e.articleId)}/outdent`,{method:"POST",body:JSON.stringify({})});return}if(e.type==="move_article_tree"){await yn(`/api/articles/${encodeURIComponent(e.articleId)}/move-tree`,{method:"POST",body:JSON.stringify(e.payload||{})});return}}async function Qp(e){try{if(!e||!e.articleId||!(e.type==="save_doc_json"||e.type==="section_upsert_content"||e.type==="structure_snapshot"||e.type==="delete_sections"))return;let n=e.payload?.clientQueuedAt??null;if(typeof n!="number"||!Number.isFinite(n)||(await kr(500)||[]).some(i=>i&&i.articleId===e.articleId&&(i.type==="save_doc_json"||i.type==="section_upsert_content"||i.type==="structure_snapshot")&&(i.payload?.clientQueuedAt??null)===n))return;Rp(e.articleId,n)}catch{}}async function Zp(e,t){let n=String(e||"").trim();if(n)for(let r of t||[])try{let o=String(r?.sectionId||"").trim(),i=r?.headingJson||null,s=r?.bodyJson||null;if(!o||!i||!s)continue;let a=globalThis.crypto?.randomUUID?.()||`conflict-${Date.now()}-${Math.random().toString(16).slice(2)}`,c=await Zn(n).catch(()=>null),l=c?.docJson&&typeof c.docJson=="object"?c.docJson:null,d=Kp(i,"\u041A\u043E\u043D\u0444\u043B\u0438\u043A\u0442\u043D\u0430\u044F \u043A\u043E\u043F\u0438\u044F: "),h=Vp(l||{type:"doc",content:[]},o,{type:"outlineSection",attrs:{id:a,collapsed:!1,isConflictCopy:!0},content:[d||{type:"outlineHeading",content:[]},s||{type:"outlineBody",content:[{type:"paragraph"}]},{type:"outlineChildren",content:[]}]});await xn(n,h,c?.updatedAt||null).catch(()=>{}),Up(n,a,1);let b=Date.now();await cn("section_upsert_content",{articleId:n,payload:{sectionId:a,headingJson:d,bodyJson:s,seq:1,clientQueuedAt:b},coalesceKey:`content:${n}:${a}`}).catch(()=>{});let w=qp(h);w.length&&await cn("structure_snapshot",{articleId:n,payload:{nodes:w,clientQueuedAt:b},coalesceKey:`structure:${n}`}).catch(()=>{});try{window.dispatchEvent(new CustomEvent("outline-sync-conflict",{detail:{articleId:n,sectionId:o,conflictCopySectionId:a}}))}catch{}}catch{}}async function em(e,t){let n=String(e||"").trim();if(!n)return;let r=Date.now(),o=Number(yd.get(n)||0)||0;if(o&&r-o<Hp)return;yd.set(n,r);let i=async()=>{let f=await kr(200),p=[],y=[],x=[];for(let A of f||[])!A||String(A.articleId||"")!==n||(A.type==="delete_sections"?p.push(A):A.type==="section_upsert_content"?y.push(A):A.type==="structure_snapshot"&&x.push(A));return{deleteOps:p,upsertOps:y,structureOps:x}},s=0,a=[],c=[],l=[];try{({deleteOps:a,upsertOps:c,structureOps:l}=await i())}catch{a=[],c=[],l=[];for(let f of t||[])!f||String(f.articleId||"")!==n||(f.type==="delete_sections"?a.push(f):f.type==="section_upsert_content"?c.push(f):f.type==="structure_snapshot"&&l.push(f))}let d=new Set;for(let f of a){let p=Array.isArray(f.payload?.sectionIds)?f.payload.sectionIds:[];for(let y of p){let x=String(y||"").trim();x&&d.add(x)}}if(d.size&&c.length)for(let f of c)try{let p=String(f.payload?.sectionId||"").trim();p&&d.has(p)&&await sr(f.id)}catch{}let m=a.map(f=>{let p=Array.isArray(f.payload?.sectionIds)?f.payload.sectionIds:[];return{opId:f.payload?.opId||f.id,sectionIds:p.filter(Boolean).map(y=>String(y)),_outboxId:f.id}}).filter(f=>f.sectionIds.length),h=c.map(f=>{let p=String(f.payload?.sectionId||"").trim();return!p||d.has(p)?null:{opId:f.payload?.opId||f.id,sectionId:p,headingJson:f.payload?.headingJson||null,bodyJson:f.payload?.bodyJson||null,seq:f.payload?.seq||null,clientQueuedAt:f.payload?.clientQueuedAt??null,_outboxId:f.id}}).filter(Boolean),b=async()=>{let f=a.map(q=>{let z=Array.isArray(q.payload?.sectionIds)?q.payload.sectionIds:[];return{opId:q.payload?.opId||q.id,sectionIds:z.filter(Boolean).map(X=>String(X)),_outboxId:q.id}}).filter(q=>q.sectionIds.length),p=c.map(q=>{let z=String(q.payload?.sectionId||"").trim();return!z||d.has(z)?null:{opId:q.payload?.opId||q.id,sectionId:z,headingJson:q.payload?.headingJson||null,bodyJson:q.payload?.bodyJson||null,seq:q.payload?.seq||null,clientQueuedAt:q.payload?.clientQueuedAt??null,_outboxId:q.id}}).filter(Boolean),y=new Map;for(let q of f)y.set(String(q.opId),q._outboxId);for(let q of p)y.set(String(q.opId),q._outboxId);if(!f.length&&!p.length)return!1;try{gt("sync.flush.outline_compact.start",{articleId:n,deletesCount:f.length,upsertsCount:p.length})}catch{}let x=await yn(`/api/articles/${encodeURIComponent(n)}/sync/compact`,{method:"PUT",body:JSON.stringify({deletes:f.map(({opId:q,sectionIds:z})=>({opId:q,sectionIds:z})),upserts:p.map(({opId:q,sectionId:z,headingJson:X,bodyJson:Q,seq:oe})=>({opId:q,sectionId:z,headingJson:X,bodyJson:Q,seq:oe}))})}),A=x?.updatedAt||null;A&&await fs(n,A).catch(()=>{});try{gt("sync.flush.outline_compact.ok",{articleId:n,updatedAt:A||null,deleteAcks:Array.isArray(x?.deleteAcks)?x.deleteAcks.length:null,upsertAcks:Array.isArray(x?.upsertAcks)?x.upsertAcks.length:null})}catch{}let I=Array.isArray(x?.deleteAcks)?x.deleteAcks:[];for(let q of I){let z=String(q?.opId||"").trim();if(!z)continue;let X=y.get(z)||z;await sr(X).catch(()=>{});try{let Q=Array.isArray(q?.removedBlockIds)?q.removedBlockIds:[];Q.length&&await Zo(Q)}catch{}}let N=[],$=Array.isArray(x?.upsertAcks)?x.upsertAcks:[];for(let q of $){let z=String(q?.opId||"").trim(),X=String(q?.sectionId||"").trim();if(!z||!X)continue;let Q=y.get(z)||z,oe=String(q?.result||"").trim();if(oe==="ok"||oe==="duplicate")await sr(Q).catch(()=>{});else if(oe==="conflict"){await sr(Q).catch(()=>{});let we=p.find(Pe=>String(Pe.opId)===z)||null;we&&N.push({sectionId:X,headingJson:we.headingJson,bodyJson:we.bodyJson})}}return N.length&&await Zp(n,N),!0};for(;s<2&&(s+=1,!!await b());)try{({deleteOps:a,upsertOps:c,structureOps:l}=await i())}catch{break}let w=null;try{({deleteOps:a,upsertOps:c,structureOps:l}=await i())}catch{}if(!a.length&&!c.length&&(w=l.length?l[l.length-1]:null),w){try{let p=Number(bd.get(n)||0)||0,y=Date.now();if(p&&y-p<$p)return}catch{}let f=w.payload?.nodes||null;if(Array.isArray(f)&&f.length){try{gt("sync.flush.structure_snapshot.start",{articleId:n,opId:w.id,nodesCount:f.length})}catch{}let p=await yn(`/api/articles/${encodeURIComponent(n)}/structure/snapshot`,{method:"PUT",body:JSON.stringify({opId:w.payload?.opId||w.id,nodes:f})}),y=p?.updatedAt||null;y&&await fs(n,y).catch(()=>{}),Number.isFinite(Number(p?.newStructureRev))?await ps(n,Number(p.newStructureRev)):Number.isFinite(Number(p?.currentStructureRev))&&await ps(n,Number(p.currentStructureRev));try{gt("sync.flush.structure_snapshot.done",{articleId:n,opId:w.id,status:String(p?.status||""),updatedAt:y||null,newStructureRev:Number.isFinite(Number(p?.newStructureRev))?Number(p.newStructureRev):null,currentStructureRev:Number.isFinite(Number(p?.currentStructureRev))?Number(p.currentStructureRev):null})}catch{}let x=String(p?.status||"");if(x==="ok"||x==="duplicate"){await sr(w.id).catch(()=>{});try{bd.set(n,Date.now())}catch{}}}}try{(await kr(200)||[]).some(y=>ba(y)&&String(y.articleId||"")===n)||(await wc(n).catch(()=>{}),gt("sync.flush.localDraft.cleared",{articleId:n}))}catch{}}async function Zr(){if(ha)return null;if(!navigator.onLine)return!1;ha=!0;try{let e=await kr(200),t=new Set,n=[];for(let o of e||[]){if(!ba(o))continue;let i=String(o.articleId||"").trim();!i||t.has(i)||(t.add(i),n.push(i))}for(let o of n)try{await em(o,e)}catch(i){if(wd(i))break}let r=await kr(50);for(let o of r)if(!ba(o))try{await Xp(o),await sr(o.id);try{if(o.type==="section_upsert_content"&&String(o.articleId||"")==="inbox"){let i=String(o.payload?.sectionId||"").trim();i&&Ul(i)}}catch{}await Qp(o)}catch(i){let s=Number(i?.status||0)||null,a=s?`${s}: ${i?.message||"error"}`:i?.message||String(i||"error");if(await fc(o.id,a),Wp(i,o)){try{console.warn("[offline][outbox] drop op",{opId:o.id,type:o.type,articleId:o.articleId,status:s,message:i?.message||null})}catch{}try{await sr(o.id)}catch{}continue}if(wd(i))break;break}}finally{ha=!1}try{let e=await kr(1);return Array.isArray(e)&&e.length>0}catch{return!0}}function Po(){Tr||(Tr=window.setInterval(async()=>{try{await Zr()===!1&&(window.clearInterval(Tr),Tr=null,xd())}catch{}},15e3))}function ya(){Tr&&(window.clearInterval(Tr),Tr=null)}function tm(){if(!hd){hd=!0,xd();try{cc()}catch{}window.addEventListener("online",()=>{Zr().then(e=>{e?Po():ya()}).catch(()=>{})}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&Zr().then(e=>{e?Po():ya()}).catch(()=>{})}),window.addEventListener("offline-outbox-changed",()=>{Zr().then(e=>{e?Po():ya()}).catch(()=>{Po()})}),Zr().then(e=>{e&&Po()}).catch(()=>{})}}function nm(e={}){let t=!!(e&&e.force);ga||gd&&!t||(gd=!0,ga=!0,Ft={running:!0,processed:0,total:0,errors:0,phase:"index",lastError:null,startedAt:new Date().toISOString(),finishedAt:null},hr(),(async()=>{try{if(!navigator.onLine){Ft={...Ft,running:!1,phase:"error",lastError:"offline",finishedAt:new Date().toISOString()},hr();return}let n=new Map;try{let o=await bc();n=new Map((o||[]).map(i=>[i.id,i]))}catch{}let r=[];try{Array.isArray(e?.initialIndex)?r=e.initialIndex:r=await yn("/api/articles")||[],Jn(r).catch(()=>{})}catch(o){Ft={...Ft,running:!1,phase:"error",lastError:o?.message||String(o||"error"),finishedAt:new Date().toISOString()},hr();return}Ft={...Ft,phase:"articles",total:Array.isArray(r)?r.length:0},hr();for(let o of r||[]){try{let i=o.updatedAt||null,s=n.get(o.id);if(i&&s?.updatedAt===i&&s?.hasDocJson){try{let c=await Zn(o.id),l=c?.docJson&&typeof c.docJson=="object"?c.docJson:null;l&&Fr(o.id,l).catch(()=>{})}catch{}continue}let a=await yn(`/api/articles/${encodeURIComponent(o.id)}`);await qr(a);try{let c=await yn(`/api/articles/${encodeURIComponent(o.id)}/embeddings`);await ms(o.id,c?.embeddings||[])}catch{}}catch{Ft={...Ft,errors:Number(Ft.errors||0)+1}}Ft={...Ft,processed:Number(Ft.processed||0)+1},hr(),await new Promise(i=>setTimeout(i,120))}try{Ft={...Ft,phase:"inbox"},hr();let o=await yn("/api/articles/inbox?include_history=0");await qr(o)}catch{Ft={...Ft,errors:Number(Ft.errors||0)+1},hr()}lc().catch(()=>{}),Ft={...Ft,running:!1,phase:"done",finishedAt:new Date().toISOString()},hr()}finally{ga=!1}})().catch(()=>{}))}var Li,hd,ha,gd,ga,Tr,Hp,yd,$p,bd,Ft,wa=et(()=>{Kr();zr();hs();as();mn();ra();po();Li="ttree_outline_autosave_queue_docjson_v1";hd=!1,ha=!1,gd=!1,ga=!1,Tr=null,Hp=2e3,yd=new Map,$p=3e3,bd=new Map;Ft={running:!1,processed:0,total:0,errors:0,phase:"idle",lastError:null,startedAt:null,finishedAt:null}});var yi={};Uo(yi,{closeOutlineEditor:()=>uu,enterOutlineSectionEditMode:()=>lh,flushOutlineAutosave:()=>ph,getOutlineActiveSectionId:()=>nh,getOutlineActiveSectionSnapshot:()=>rh,insertNewOutlineSectionAtEnd:()=>ch,insertNewOutlineSectionAtStart:()=>dh,insertOutlineSectionFromPlainTextAtStart:()=>uh,insertOutlineSectionFromSectionFragmentsAtEnd:()=>ah,openOutlineEditor:()=>fh,openPublicOutlineViewer:()=>mh,restoreOutlineSectionFromBlockHtml:()=>ih,restoreOutlineSectionFromSectionFragments:()=>sh,revealOutlineSection:()=>du});function gr(e,t={},{dedupeMs:n=250}={}){try{let r=Ii(new Error),o=Date.now();if(ka.hash===r.hash&&o-ka.atMs<n)return;ka={atMs:o,hash:r.hash},ki(e,{articleId:wt||u.articleId||null,isOutlineEditing:!!u.isOutlineEditing,mode:u.mode,stackHash:r.hash,stackTop:r.top,...t})}catch{}}function Hi(e,t){let n=null,r=String(t||"").trim();return!e||!r?null:(e.descendants((o,i)=>{if(n!==null)return!1;o?.type?.name==="image"&&String(o.attrs?.uploadToken||"")===r&&(n=i)}),n)}function sm(e){let t=String(e||"").trim();if(!t)return;let n=Dr.get(t)||null;if(n){Dr.delete(t);try{URL.revokeObjectURL(n)}catch{}}}function Fd(e,t=3e4){let n=String(e||"").trim();if(n){try{let r=Ro.get(n)||null;r&&clearTimeout(r)}catch{}try{let r=setTimeout(()=>{try{Ro.delete(n)}catch{}sm(n)},Math.max(0,Number(t)||0));Ro.set(n,r)}catch{}}}function Ma(e){if(!e)return!1;if(e.type&&String(e.type).startsWith("image/"))return!0;let t=String(e.name||"").toLowerCase();return!!(t&&/\.(png|jpe?g|gif|webp|bmp|svg|heic|heif)$/i.test(t))}function zd(e,t){try{let n=e?.state?.schema,r=n?.nodes?.image||null;if(!n||!r)return ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435"),!1;let o=`upl-${Date.now()}-${Math.random().toString(16).slice(2)}`,i=URL.createObjectURL(t);try{Dr.set(o,i)}catch{}try{let p=wt||u.articleId||null;dd({token:o,articleId:p,kind:"image",blob:t,fileName:t?.name||"image",mime:t?.type||""})}catch{}let s=r.create({src:i,alt:t?.name||"image",width:320,uploadToken:o}),a=Je?.pmStateMod?.TextSelection,c=e.state.tr,l=c.selection.from,d=c.selection.to,m="\xA0\xA0";d>l&&(c=c.delete(l,d));let h=Math.max(0,Math.min(c.doc.content.size,l));c=c.insertText(m,h,h);let b=Math.max(0,Math.min(c.doc.content.size,h+m.length));c=c.replaceRangeWith(b,b,s);let w=Math.max(0,Math.min(c.doc.content.size,b+s.nodeSize));c=c.insertText(m,w,w);let f=Math.max(0,Math.min(c.doc.content.size,w+m.length));a&&(c=c.setSelection(a.create(c.doc,f))),c=c.setMeta(ue,!0),e.dispatch(c.scrollIntoView());try{let p=new Image;p.decoding="async",p.onload=()=>{try{let y=Number(p.naturalWidth||0),x=Number(p.naturalHeight||0);if(!(y>0&&x>0))return;let A=y/x,I=Hi(e.state.doc,o);if(typeof I!="number")return;let N=e.state.doc.nodeAt(I);if(!N||N.type?.name!=="image"||Number.isFinite(Number(N.attrs?.aspectRatio))&&Number(N.attrs.aspectRatio)>0)return;let $={...N.attrs,aspectRatio:A},q=e.state.tr.setNodeMarkup(I,void 0,$);q=q.setMeta(ue,!0),e.dispatch(q)}catch{}},p.onerror=()=>{},p.src=i}catch{}try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return ve("\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E \u0438 \u0431\u0443\u0434\u0435\u0442 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E \u043F\u0440\u0438 \u043F\u043E\u044F\u0432\u043B\u0435\u043D\u0438\u0438 \u0441\u0435\u0442\u0438"),!0}catch{}return ho(t).then(p=>{let y=String(p?.url||"").trim();if(!y)throw new Error("Upload failed");let x=Hi(e.state.doc,o);if(typeof x!="number")return;let A=e.state.doc.nodeAt(x);if(!A||A.type?.name!=="image")return;let I={...A.attrs,src:y,uploadToken:null},N=e.state.tr.setNodeMarkup(x,void 0,I);N=N.setMeta(ue,!0),e.dispatch(N),Fd(o),ua(o).catch(()=>{})}).catch(p=>{ve(p?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435");try{let y=Hi(e.state.doc,o);if(typeof y!="number")return;let x=e.state.doc.nodeAt(y);if(!x||x.type?.name!=="image")return;let A=String(x.attrs?.title||"").trim(),I=A?`${A} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",N=String(x.attrs?.alt||t?.name||"image"),$={...x.attrs,src:i,alt:N,title:I,uploadToken:o},q=e.state.tr.setNodeMarkup(y,void 0,$);q=q.setMeta(ue,!0),e.dispatch(q)}catch{}try{fa(o,String(p?.message||p||"error"))}catch{}}),!0}catch{return!1}}function Ud(e,t){try{let n=e?.state?.schema,r=n?.marks?.link||null;if(!n||!r)return ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u0438\u0435: \u043D\u0435\u0442 \u0441\u0445\u0435\u043C\u044B \u0441\u0441\u044B\u043B\u043E\u043A"),!1;if(!u.articleId)return ve("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E"),!1;let o=en(),i=`pending-attachment:${String(o||"")}`,s=String(t?.name||"\u0444\u0430\u0439\u043B"),a=`${s} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430...)`,{from:c,to:l}=e.state.selection,d=e.state.tr.insertText(a,c,l);d=d.addMark(c,c+a.length,r.create({href:i})),d=d.setMeta(ue,!0),e.dispatch(d.scrollIntoView());let m=null;try{m=(Ee?.getState?.(e.state)||null)?.editingSectionId||null}catch{m=null}let h=(b,w)=>{let f=`pending-attachment:${String(w||"")}`,p=b?.type?.schema?.marks?.link||null;if(!p)return null;let y=null;return b.descendants((x,A)=>{if(y)return!1;!x||!x.isText||!(Array.isArray(x.marks)?x.marks:[]).find($=>$?.type===p&&String($?.attrs?.href||"")===f)||(y={from:A,to:A+x.nodeSize})}),y};return ti(u.articleId,t,{sectionId:m}).then(b=>{let w=String(b?.storedPath||b?.url||b?.path||"").trim();if(!w)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443 \u043D\u0430 \u0444\u0430\u0439\u043B");let f=String(b?.originalName||t?.name||"\u0444\u0430\u0439\u043B"),p=h(e.state.doc,o);if(!p)return;let y=e.state.tr.insertText(f,p.from,p.to);y=y.addMark(p.from,p.from+f.length,r.create({href:w})),y=y.setMeta(ue,!0),e.dispatch(y)}).catch(b=>{let w=h(e.state.doc,o);if(w){let f=`${s} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`,p=e.state.tr.insertText(f,w.from,w.to);p=p.setMeta(ue,!0),e.dispatch(p)}ve(b?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u043D\u0430 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A")}),!0}catch{return!1}}function am(e){try{if(!e||typeof e!="object")return e;let t=typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e)),n=r=>{if(!r||typeof r!="object")return;if(r.type==="image"&&r.attrs&&typeof r.attrs=="object"){let i=String(r.attrs.uploadToken||"").trim(),s=String(r.attrs.src||"");i&&s.startsWith("blob:")&&(r.attrs={...r.attrs,src:`${qi}${i}`})}let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(t),t}catch{return e}}function kd(e){try{if(!e||typeof e!="object")return e;let t=typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e)),n=r=>{if(!r||typeof r!="object")return;if(r.type==="image"&&r.attrs&&typeof r.attrs=="object"){let i=String(r.attrs.uploadToken||"").trim(),s=String(r.attrs.src||"");i&&s.startsWith("blob:")&&(r.attrs={...r.attrs,src:`${qi}${i}`})}let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(t),t}catch{return e}}async function cm(e){try{if(!ie||ie.isDestroyed)return;let t=String(e||"").trim();if(!t)return;let n=await pa({articleId:t,limit:200}).catch(()=>[]);if(!n.length)return;let r=new Map;for(let c of n){let l=String(c?.token||"").trim();l&&(c?.kind&&String(c.kind)!=="image"||c?.blob&&r.set(l,c.blob))}if(!r.size)return;let{state:o,view:i}=ie,s=o.tr,a=!1;o.doc.descendants((c,l)=>{if(c?.type?.name!=="image")return;let d=String(c.attrs?.uploadToken||"").trim(),m=String(c.attrs?.src||""),h=m.startsWith(qi)?m.slice(qi.length).trim():"",b=d||h;if(!b)return;let w=r.get(b);if(!w)return;let f=Dr.get(b)||null;if(!f)try{f=URL.createObjectURL(w),Dr.set(b,f)}catch{f=null}if(!f)return;let p={...c.attrs,src:f,uploadToken:b};s=s.setNodeMarkup(l,void 0,p),a=!0}),a&&(s=s.setMeta(ue,!0),i.dispatch(s))}catch{}}async function qd(e){try{if(!navigator.onLine||!ie||ie.isDestroyed)return!1;let t=String(e||"").trim();if(!t)return!1;let n=await pa({articleId:t,limit:50}).catch(()=>[]);if(!n.length)return!1;let r=!1;for(let o of n){let i=String(o?.token||"").trim();if(!i||o?.kind&&String(o.kind)!=="image")continue;let s=o?.blob||null;if(s)try{let a=s instanceof File?s:new File([s],o?.fileName||"image",{type:o?.mime||s.type||"application/octet-stream"}),c=await ho(a),l=String(c?.url||"").trim();if(!l)throw new Error("Upload failed");try{let{state:d,view:m}=ie,h=Hi(d.doc,i);if(typeof h=="number"){let b=d.doc.nodeAt(h);if(b?.type?.name==="image"){let w={...b.attrs,src:l,uploadToken:null,title:String(b.attrs?.title||"").replace(/\s*\(ошибка загрузки\)\s*$/i,"").trim()},f=d.tr.setNodeMarkup(h,void 0,w);f=f.setMeta(ue,!0),m.dispatch(f)}}}catch{}Fd(i),await ua(i).catch(()=>{}),r=!0}catch(a){let c=a?.message||String(a||"error");await fa(i,c).catch(()=>{})}}if(r)try{rn({delayMs:350})}catch{}return r}catch{return!1}}function La(){try{let e=window?.localStorage?.getItem?.(Na)||"";if(!e)return null;let t=JSON.parse(e);return!t||typeof t!="object"||!Array.isArray(t.sections)?null:{mode:t.mode==="cut"?"cut":"copy",sourceArticleId:typeof t.sourceArticleId=="string"?t.sourceArticleId:null,createdAt:typeof t.createdAt=="string"?t.createdAt:null,sections:t.sections}}catch{return null}}function $i(e){try{if(!e){window?.localStorage?.removeItem?.(Na);return}window?.localStorage?.setItem?.(Na,JSON.stringify(e))}catch{}}function so(e){nr=!!e,nr||(wr=new Set);try{V?.outlineEditor&&V.outlineEditor.classList.toggle("outline-select-mode",nr)}catch{}try{Kd()}catch{}}function lm(e){let t=String(e||"").trim();if(t){wr.has(t)?wr.delete(t):wr.add(t);try{Kd()}catch{}}}function Kd(){if(!V?.outlineEditor)return;V.outlineEditor.querySelectorAll(".outline-heading[data-section-id] .outline-heading__select").forEach(t=>{let r=t.closest(".outline-heading")?.getAttribute?.("data-section-id")||"",o=r&&wr.has(r);t.setAttribute("aria-checked",o?"true":"false"),t.style.display=nr?"inline-flex":"none"})}function dm(e,t){let n=t instanceof Set?t:new Set,r=[];if(!e||!n.size)return r;let o=(i,s)=>{let a=String(i?.attrs?.id||"").trim(),c=a&&n.has(a);if(c&&!s){r.push({id:a,node:i});return}let l=i?.childCount>=3?i.child(2):null;if(l)try{l.forEach(d=>{d?.type?.name==="outlineSection"&&o(d,s||c)})}catch{}};try{e.forEach(i=>{i?.type?.name==="outlineSection"&&o(i,!1)})}catch{}return r}function Ha(e){return JSON.parse(JSON.stringify(e))}function Vd(e,t){let n=Ha(e),r=o=>{if(!o||typeof o!="object")return;if(o.type==="outlineSection"){let s=t();o.attrs&&typeof o.attrs=="object"?o.attrs.id=s:o.attrs={id:s,collapsed:!!o.attrs?.collapsed}}let i=Array.isArray(o.content)?o.content:[];for(let s of i)r(s)};return r(n),n}async function um(e){let t=String(e||"");if(t){try{if(navigator?.clipboard?.writeText){await navigator.clipboard.writeText(t);return}}catch{}try{let n=document.createElement("textarea");n.value=t,n.setAttribute("readonly","true"),n.style.position="fixed",n.style.left="-9999px",n.style.top="0",document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n)}catch{}}}function jd(e,{baseLevel:t=2,depth:n=0}={}){let r=e;if(!r||r.type?.name!=="outlineSection")return"";let o="",i="";try{let c=r.child(0);o=String(c?.textContent||"").trim()}catch{o=""}try{let c=r.child(1);i=c?String(c.textBetween(0,c.content.size,`
`)).trimEnd():""}catch{i=""}let s=Math.min(6,Math.max(1,Number(t)+Number(n||0))),a=[];o&&a.push(`${"#".repeat(s)} ${o}`),i&&a.push(i);try{let c=r.child(2);if(c){let l=[];c.forEach(d=>{if(d?.type?.name!=="outlineSection")return;let m=jd(d,{baseLevel:t,depth:n+1});m&&l.push(m)}),l.length&&a.push(l.join(`

`))}}catch{}return a.filter(Boolean).join(`

`).trim()}function Jd(e,t){try{let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return 1;let o=window.localStorage.getItem(Id)||"",i=o?JSON.parse(o):{},s=i&&typeof i=="object"?i:{},a=(s[n]&&typeof s[n]=="object"?s[n]:{})||{},l=(Number(a[r]||0)||0)+1;return a[r]=l,s[n]=a,window.localStorage.setItem(Id,JSON.stringify(s)),l}catch{return Date.now()}}function Wd(e,t){try{let n=JSON.stringify({headingJson:e,bodyJson:t});return globalThis.TextEncoder?new TextEncoder().encode(n).length:n.length*2}catch{return 0}}function ro(e){try{let t=String(e||"").trim();if(!t)return;Mn.add(t);let n=wt||u.articleId||null;if(!n||u.article?.encrypted||Ia)return;Ia=setTimeout(()=>{Ia=null;try{if(!Mn.size)return;let r=Array.from(Mn);Mn.clear();let o=Date.now();cn("delete_sections",{articleId:n,payload:{sectionIds:r,clientQueuedAt:o},coalesceKey:`delete:${n}`})}catch{}},0)}catch{}}function zo(e){let t=[],n=o=>{try{if(!o||o.type?.name!=="outlineSection")return null;for(let i=0;i<o.childCount;i+=1){let s=o.child(i);if(s?.type?.name==="outlineChildren")return s}return null}catch{return null}},r=(o,i)=>{try{if(!o)return;let s=0;o.forEach(a=>{if(!a||a.type?.name!=="outlineSection")return;let c=String(a.attrs?.id||"").trim();if(!c)return;t.push({sectionId:c,parentId:i||null,position:s,collapsed:!!a.attrs?.collapsed}),s+=1;let l=n(a);l&&r(l,c)})}catch{}};try{if(!e)return[];r(e,null)}catch{return[]}return t}function Ed(e){try{return zo(e).map(n=>`${n.parentId||""}|${n.position}|${n.sectionId}|${n.collapsed?1:0}`).join(`
`)}catch{return""}}function oo(e){let t=[];try{if(!e)return t;e.descendants((n,r)=>{n?.type?.name==="outlineSection"&&t.push(r)})}catch{}return t}function Pa(e,t){try{if(!e||e.isDestroyed)return!1;let n=!!t;return e.commands.command(({state:r,dispatch:o})=>{let i=oo(r.doc);if(!i.length)return!1;let s=r.tr;for(let a of i){let c=s.doc.nodeAt(a);!c||c.type?.name!=="outlineSection"||!!c.attrs?.collapsed!==n&&(s=s.setNodeMarkup(a,void 0,{...c.attrs,collapsed:n}))}s=s.setMeta(ue,!0);try{n&&Ee&&(Ee.getState(r)||{}).editingSectionId&&(s=s.setMeta(Ee,{type:"exit"}))}catch{}try{if(n&&TextSelection){let a=Mt(r.doc,r.selection.$from),c=typeof a=="number"?a:i[0],l=s.doc.nodeAt(c);if(l?.type?.name==="outlineSection"){let d=l.child(0),h=c+1+d.nodeSize-1;s=s.setSelection(TextSelection.near(s.doc.resolve(h),-1))}}}catch{}return o(s.scrollIntoView()),!0})}catch{return!1}}function fm({articleId:e,editor:t}={}){try{let n=String(e||"").trim();if(!n||!t)return;qn=!0;try{if((Ee?.getState?.(t.state)||null)?.editingSectionId){Vt&&(clearTimeout(Vt),Vt=null);return}}catch{}Vt&&clearTimeout(Vt),Vt=setTimeout(()=>{Vt=null;try{if(!qn)return;let r=t.state?.doc,o=zo(r);if(!o.length)return;try{let i=null;try{i=o.filter(s=>s&&(s.parentId==null||s.parentId==="")&&Number(s.position)>=0).sort((s,a)=>Number(s.position)-Number(a.position)).slice(0,3).map(s=>String(s.sectionId||""))}catch{i=null}gt("outline.enqueue.structure_snapshot",{articleId:n,nodesCount:o.length,rootFirst:i})}catch{}cn("structure_snapshot",{articleId:n,payload:{nodes:o},coalesceKey:`structure:${n}`}),qn=!1}catch{}},om)}catch{}}async function $a({articleId:e,doc:t,sectionId:n,reason:r}){let o=String(e||"").trim(),i=String(n||"").trim();if(!o||!i||!t)return!1;let s=St(t,i),a=typeof s=="number"?t.nodeAt(s):null;if(!a||a.type?.name!=="outlineSection")return!1;try{if(!Lr(t,i))return!1}catch{return!1}let c=a.child(0),l=a.child(1),d=c?.toJSON?c.toJSON():null,m=l?.toJSON?l.toJSON():null;if(!d||!m)return!1;try{d=kd(d),m=kd(m)}catch{}let h=Wd(d,m);if(h>Ki){let f=Date.now();return(!xa||f-xa>5e3)&&(xa=f,ve(`\u0411\u043B\u043E\u043A \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 (${Math.ceil(h/1024)} KB). \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C: ${Math.ceil(Ki/1024)} KB. \u0420\u0430\u0437\u0431\u0435\u0439\u0442\u0435 \u0431\u043B\u043E\u043A \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E.`)),!1}let b=Date.now(),w=Jd(o,i);try{gt("outline.enqueue.section_upsert_content",{articleId:o,sectionId:i,seq:w,bytes:h,reason:String(r||"")})}catch{}await cn("section_upsert_content",{articleId:o,payload:{sectionId:i,headingJson:d,bodyJson:m,seq:w,clientQueuedAt:b},coalesceKey:`content:${o}:${i}`}).catch(()=>{});try{if(qn){let f=zo(t);if(f.length){let p=null;try{p=f.filter(y=>y&&(y.parentId==null||y.parentId==="")&&Number(y.position)>=0).sort((y,x)=>Number(y.position)-Number(x.position)).slice(0,3).map(y=>String(y.sectionId||""))}catch{p=null}try{gt("outline.enqueue.structure_snapshot",{articleId:o,nodesCount:f.length,reason:"after_section_upsert",rootFirst:p})}catch{}cn("structure_snapshot",{articleId:o,payload:{nodes:f},coalesceKey:`structure:${o}`})}qn=!1,Vt&&(clearTimeout(Vt),Vt=null)}}catch{}try{Or.set(i,Gi(a)),Rr.delete(i)}catch{}try{Promise.resolve().then(()=>(wa(),Sa)).then(f=>f.flushOutboxOnce?.()).catch(()=>{})}catch{}return!0}function pm(e){try{if(!e||e.isDestroyed)return;let t=Ee?.getState?.(e.state)||null,n=String(t?.editingSectionId||"").trim();if(!n)return;let r=wt||u.articleId||null;if(!r)return;va=n,Mr&&clearTimeout(Mr),Mr=setTimeout(()=>{Mr=null;try{if(!ie||ie.isDestroyed)return;let o=Ee?.getState?.(ie.state)||null,i=String(o?.editingSectionId||"").trim();if(!i||i!==va)return;$a({articleId:r,doc:ie.state.doc,sectionId:i,reason:"edit_heartbeat"})}catch{}},im)}catch{}}function _a(){try{return window?.localStorage?.getItem?.(mm)==="1"}catch{return!1}}function En(...e){_a()}function Nr(){try{return window?.localStorage?.getItem?.(hm)==="1"}catch{return!1}}function io(e,t={}){Nr()}function ym(){try{return window?.localStorage?.getItem?.(gm)==="1"}catch{return!1}}function Kt(e,t={}){ym()}function zi(e){let t=String(e||"").replace(/\s+/g," ").trim().toLowerCase();return t?t.length>60?t.slice(0,60):t:null}function Do(e){return String(e||"").replace(/\s+/g," ").trim().toLowerCase()}function bm(e,t="tag"){let n=new Map,r=new Map,o=new Map,i=new Map;return e?(e.descendants((s,a)=>{if(s?.type?.name!=="outlineSection")return;let c=String(s.attrs?.id||"");c&&i.set(c,a);let l=new Set,d=m=>{m?.descendants?.(h=>{if(h?.type?.name!==t)return;let b=zi(h.attrs?.label||h.textContent||"");if(!b)return;let w=Do(h.attrs?.key||b);w&&(n.set(w,(n.get(w)||0)+1),r.set(w,w),l.add(w))})};try{d(s.child(0)),d(s.child(1))}catch{}if(c)for(let m of l)o.has(m)||o.set(m,new Set),o.get(m).add(c);return!1}),{counts:n,labelByKey:r,sectionIdsByKey:o,sectionPosById:i}):{counts:n,labelByKey:r,sectionIdsByKey:o,sectionPosById:i}}function Yd(){let e=V?.outlineTagsBar;if(!e)return;let t=Array.from(or.counts.entries()).map(([n,r])=>({key:n,label:or.labelByKey.get(n)||n,count:r})).filter(n=>n.key&&n.count>0).sort((n,r)=>r.count!==n.count?r.count-n.count:n.label.localeCompare(r.label));if(!t.length){e.innerHTML="",e.classList.add("hidden");return}e.classList.remove("hidden"),e.innerHTML=t.map(n=>{let r=Sr&&Sr===n.key?"true":"false",o=$o(n.label);return`<button type="button" class="outline-tag-pill" data-tag-key="${$o(n.key)}" aria-pressed="${r}">${o} <span class="outline-tag-pill__count">(${n.count})</span></button>`}).join("")}function Gd(){if(ie){if(or=bm(ie.state.doc,"tag"),Sr&&!or.counts.has(Sr)){Sr=null;try{ji?.(null)}catch{}}Yd()}}function Sm(e){let t=String(e||"");if(!t||!ie)return;let n=or.sectionIdsByKey.get(t);if(!n||!n.size)return;let r=new Set;for(let s of n){let a=or.sectionPosById.get(s);if(typeof a=="number"){r.add(a);try{let c=ie.state.doc.resolve(Math.min(ie.state.doc.content.size,a+1));for(let l=c.depth;l>0;l-=1)c.node(l)?.type?.name==="outlineSection"&&r.add(c.before(l))}catch{}}}let o=ie.state.tr,i=!1;for(let s of r){let a=o.doc.nodeAt(s);!a||a.type?.name!=="outlineSection"||a.attrs?.collapsed&&(o=o.setNodeMarkup(s,void 0,{...a.attrs,collapsed:!1}),i=!0)}i&&(o=o.setMeta(ue,!0),ie.view.dispatch(o))}function wm({setActiveTagKey:e}){let t=V?.outlineTagsBar;if(!t)return()=>{};let n=r=>{let o=r.target?.closest?.("[data-tag-key]");if(!o)return;let i=String(o.getAttribute("data-tag-key")||"");if(!i)return;let s=Sr===i?null:i;Sr=s;try{e(s)}catch{}s&&Sm(s),Yd()};return t.addEventListener("click",n),()=>t.removeEventListener("click",n)}function Cn(e){let t=String(e||"").trim();if(!t.includes("|"))return null;let n=t;n.startsWith("|")&&(n=n.slice(1)),n.endsWith("|")&&(n=n.slice(0,-1));let r=n.split("|").map(o=>o.trim());return r.length<2||r.every(o=>!o)?null:r}function Ji(e){let t=String(e||"").trim();return t?/^:?-{3,}:?$/.test(t):!1}function Pr(e){let t=(Array.isArray(e)?e:[]).map(i=>String(i||"").replace(/\r/g,"").trimEnd()).filter(i=>i.length>0);if(t.length<2)return null;let n=Cn(t[0]),r=Cn(t[1]);if(!n||!r||n.length!==r.length||!r.every(Ji))return null;let o=[];for(let i=2;i<t.length;i+=1){let s=Cn(t[i]);if(!s||s.length!==n.length)return null;o.push(s)}return{header:n,rows:o}}function _r(e){let t=(Array.isArray(e)?e:[]).map(s=>String(s||"").replace(/\r/g,"").trimEnd()).filter(s=>s.length>0);if(t.length<1)return null;let n=Cn(t[0]);if(!n)return null;let r=n.length;if(r<2)return null;let o=[n];for(let s=1;s<t.length;s+=1){let a=Cn(t[s]);if(!a||a.length!==r)break;if(s===1&&a.every(Ji))return null;o.push(a)}return o.flat().filter(s=>String(s||"").trim().length>0).length<2?null:{rows:o}}function Fa(e){let t=String(e||"").replace(/\r/g,"").split(`
`).map(n=>String(n||"").trimEnd());for(;t.length&&!t[0].trim();)t.shift();for(;t.length&&!t[t.length-1].trim();)t.pop();return t}function yr(e,t){if(!e||!t)return null;let{header:n,rows:r,withHeader:o}=t,i=e.nodes.table,s=e.nodes.tableRow,a=e.nodes.tableCell,c=e.nodes.tableHeader,l=e.nodes.paragraph;if(!i||!s||!a||!c||!l||typeof e.text!="function")return null;let d=w=>l.create({},w?[e.text(String(w))]:[]),m=(w,f)=>w.map(p=>(f?c:a).create({},[d(p)])),h=(w,f)=>s.create({},m(w,f)),b=[];return o&&Array.isArray(n)&&n.length&&b.push(h(n,!0)),(Array.isArray(r)?r:[]).forEach(w=>b.push(h(w,!1))),b.length?i.create({},b):null}function xm(e,t){try{let n=e?.selection,r=n?.$from;if(!n?.empty||!r)return st("table.merge.skip",{reason:"no-cursor"}),!1;if(r.parent?.type?.name!=="paragraph")return!1;if(r.parentOffset!==0)return st("table.merge.skip",{reason:"not-at-paragraph-start"}),!1;let o=null,i=null,s=null;for(let te=r.depth;te>0;te-=1){let Se=r.node(te)?.type?.name;if(!s&&(Se==="tableCell"||Se==="tableHeader")?s=te:!i&&Se==="tableRow"?i=te:!o&&Se==="table"&&(o=te),o&&i&&s)break}if(o==null||i==null||s==null)return st("table.merge.skip",{reason:"not-in-table"}),!1;let a=r.depth===s+1,c=r.index(o),l=r.index(i),d=r.index(s);if(st("table.merge.check",{parent:r.parent?.type?.name||null,parentOffset:r.parentOffset,tableDepth:o,rowDepth:i,cellDepth:s,isDirectParagraphInCell:a,rowIndex:c,colIndex:l,childIndexInCell:d}),!a)return st("table.merge.skip",{reason:"paragraph-not-direct-child-of-cell"}),!1;if(c!==0||l!==0||d!==0)return st("table.merge.skip",{reason:"not-in-first-cell",rowIndex:c,colIndex:l,childIndexInCell:d}),!1;let m=r.before(o),h=e.doc.nodeAt(m);if(!h||h.type?.name!=="table")return st("table.merge.skip",{reason:"no-current-table",tablePos:m}),!1;let b=e.doc.resolve(m),w=b.index(),f=b.parent;if(!f||w<=0)return st("table.merge.skip",{reason:"no-prev-sibling",idx:w,parent:f?.type?.name||null}),!1;let p=null,y=w-1;for(;y>=0;){let te=f.child(y);if(te?.type?.name==="paragraph"&&!String(te.textContent||"").trim()){y-=1;continue}p=te;break}if(!p||p.type?.name!=="table")return st("table.merge.skip",{reason:"no-prev-table"}),!1;let x=p.childCount?p.child(0):null,A=h.childCount?h.child(0):null;if(!x||!A)return st("table.merge.skip",{reason:"missing-rows"}),!1;if(x.childCount!==A.childCount)return st("table.merge.skip",{reason:"different-columns",prevCols:x.childCount,curCols:A.childCount}),!1;let I=x.childCount,N=(te,Se)=>{try{return te?.type?.name==="tableRow"&&te.childCount===Se}catch{return!1}};for(let te=0;te<p.childCount;te+=1){let Se=p.child(te);if(!N(Se,I))return st("table.merge.skip",{reason:"prev-row-mismatch",rowIndex:te,colsExpected:I,colsGot:Se?.childCount??null}),!1}for(let te=0;te<h.childCount;te+=1){let Se=h.child(te);if(!N(Se,I))return st("table.merge.skip",{reason:"cur-row-mismatch",rowIndex:te,colsExpected:I,colsGot:Se?.childCount??null}),!1}let $=m;for(let te=w-1;te>=y;te-=1)$-=f.child(te).nodeSize;let q=p.childCount,z=e.doc.type.schema,X=$+p.nodeSize,Q=e.tr;m>X&&(Q=Q.delete(X,m));let oe=X;Q=Q.delete(oe,oe+h.nodeSize);let we=Q.doc.nodeAt($);if(!we||we.type?.name!=="table")return st("table.merge.skip",{reason:"prev-after-missing",prevStart:$,prevAfterType:we?.type?.name||null}),!1;st("table.merge.plan",{idx:w,prevIdx:y,prevStart:$,prevEnd:X,tablePos:m,tablePos2:oe,cols:I,prevRowCount:q,curRowCount:h.childCount});try{let te=we.content.append(h.content),Se=z.nodes.table.create(we.attrs,te,we.marks);Q=Q.replaceWith($,$+we.nodeSize,Se)}catch(te){return st("table.merge.error",{message:String(te?.message||te||""),stack:String(te?.stack||"")}),!1}let Pe=Q.doc.nodeAt($);st("table.merge.afterReplace",{mergedType:Pe?.type?.name||null,mergedRows:Pe?.type?.name==="table"?Pe.childCount:null});try{let te=Je?.pmStateMod?.TextSelection||Je?.pm?.state?.TextSelection||null;if(Pe&&Pe.type?.name==="table"){let Se=Math.min(q,Math.max(0,Pe.childCount-1));if(Pe.child(Se)?.childCount){let Lt=(()=>{let fn=$+1;for(let Sn=0;Sn<Se;Sn+=1)fn+=Pe.child(Sn).nodeSize;return fn+=1,fn})(),_t=Math.min(Q.doc.content.size,Lt+2);te&&(Q=Q.setSelection(te.near(Q.doc.resolve(_t),1)))}}}catch(te){st("table.merge.selection.error",{message:String(te?.message||te||""),stack:String(te?.stack||"")})}Q=Q.setMeta(ue,!0);try{t(Q.scrollIntoView())}catch(te){return st("table.merge.dispatch.error",{message:String(te?.message||te||""),stack:String(te?.stack||"")}),!1}return!0}catch(n){try{st("table.merge.exception",{message:String(n?.message||n||""),stack:String(n?.stack||"")})}catch{}return!1}}function Am(e,t,n,r){try{let o=(Se,tt={})=>{},i=(Se={})=>{};if(!n)return!1;if(!r)return o("no-TextSelection"),!1;let s=e?.selection;if(!s?.empty)return o("selection-not-empty"),!1;let a=s.$from||null;if(!a)return o("no-$from"),!1;i({from:s.from,parent:a.parent?.type?.name||null,parentOffset:a.parentOffset??null});let c=St(e.doc,n);if(typeof c!="number")return o("section-not-found"),!1;let l=e.doc.nodeAt(c);if(!l||l.type?.name!=="outlineSection")return o("not-outlineSection",{found:l?.type?.name||null}),!1;let d=l.child(0),m=l.child(1);if(!d||d.type?.name!=="outlineHeading")return o("missing-heading",{found:d?.type?.name||null}),!1;if(!m||m.type?.name!=="outlineBody")return o("missing-body",{found:m?.type?.name||null}),!1;let h=String(d.textContent||"").replace(/\u00a0/g," "),b=!!h.trim(),w=/\s$/.test(h),f=null;for(let Se=a.depth;Se>=0;Se-=1)if(a.node(Se)?.type?.name==="outlineBody"){f=Se;break}if(f==null)return o("not-in-outlineBody",{parent:a.parent?.type?.name||null}),!1;if(a.index(f)!==0)return o("not-first-body-child",{index:a.index(f)}),!1;if(a.parent?.type?.name!=="paragraph")return o("parent-not-paragraph",{parent:a.parent?.type?.name||null}),!1;if((a.parentOffset??null)!==0)return o("not-at-paragraph-start",{parentOffset:a.parentOffset??null}),!1;let p=c+1,y=s.from,x=a.parent,A=0,I=null;for(let Se=0;Se<x.childCount;Se+=1){let tt=x.child(Se);if(tt.type?.name==="hardBreak"){I=A;break}A+=tt.nodeSize}let N=y+(I??x.content.size);if(N<=y)return o("empty-first-line"),!1;let $=e.doc.slice(y,N);if(!$?.content||$.content.size<=0)return o("empty-slice"),!1;let q=I==null?N:N+1,z=p+1,X=p+d.nodeSize-1,Q=e.tr;b&&!w&&(Q=Q.insertText(" ",X),Q=Q.setMeta(ue,!0));let oe=Q.mapping.map(X,1),we=oe;Q=Q.insert(oe,$.content);let Pe=Q.mapping.map(y,1),te=Q.mapping.map(q,-1);Q=Q.delete(Pe,te);try{Q=Q.setSelection(r.create(Q.doc,we))}catch{}return Q=Q.setMeta(ue,!0),t(Q.scrollIntoView()),!0}catch(o){return!1}}function km(e,t){try{if(!e?.doc||!t)return null;let n=St(e.doc,t);if(typeof n!="number")return null;let r=e.doc.nodeAt(n);if(!r)return null;let o=r.child(0),i=r.child(1);if(!i||i.type?.name!=="outlineBody")return null;let a=n+1+o.nodeSize+1,c=[],l=0,d=0;for(;d<i.childCount;){let h=i.child(d),b=a+l;if(h.type?.name!=="paragraph"){l+=h.nodeSize,d+=1;continue}let w=br(h).trim();if(w.includes(`
`)&&w.includes("|")){let Q=Fa(w),oe=Pr(Q),we=oe?null:_r(Q),Pe=oe?{header:oe.header,rows:oe.rows,withHeader:!0}:we?{header:null,rows:we.rows,withHeader:!1}:null,te=null;if(Pe)try{te=yr(e.schema,Pe)}catch(Se){En("convert: buildTableNode error (single)",{message:String(Se?.message||Se||""),stack:String(Se?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),te=null}if(te){let Se=b,tt=b+h.nodeSize;c.push({from:Se,to:tt,tableNode:te}),En("convert: single-paragraph table",{sectionId:t,from:Se,to:tt,lines:Q}),l+=h.nodeSize,d+=1;continue}}let f=Cn(w);if(!f||d+1>=i.childCount){if(f){let Q=[w],oe=l+h.nodeSize,we=d+1;for(;we<i.childCount;){let tt=i.child(we);if(tt.type?.name!=="paragraph")break;let Lt=br(tt).trim();if(!Lt)break;let _t=Cn(Lt);if(!_t||_t.length!==f.length)break;Q.push(Lt),oe+=tt.nodeSize,we+=1}let Pe=_r(Q),te=Pe?{header:null,rows:Pe.rows,withHeader:!1}:null,Se=null;if(te)try{Se=yr(e.schema,te)}catch(tt){En("convert: buildTableNode error (rows-only)",{message:String(tt?.message||tt||""),stack:String(tt?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),Se=null}if(Se){c.push({from:b,to:a+oe,tableNode:Se}),En("convert: rows-only table",{sectionId:t,from:b,to:a+oe,lines:Q}),l=oe,d=we;continue}}l+=h.nodeSize,d+=1;continue}let p=i.child(d+1);if(p.type?.name!=="paragraph"){l+=h.nodeSize,d+=1;continue}let y=br(p).trim(),x=Cn(y);if(!x||x.length!==f.length||!x.every(Ji)){l+=h.nodeSize,d+=1;continue}let A=[w,y],I=l+h.nodeSize+p.nodeSize,N=d+2;for(;N<i.childCount;){let Q=i.child(N);if(Q.type?.name!=="paragraph")break;let oe=br(Q).trim();if(!oe)break;let we=Cn(oe);if(!we||we.length!==f.length)break;A.push(oe),I+=Q.nodeSize,N+=1}let $=Pr(A),q=$?null:_r(A),z=$?{header:$.header,rows:$.rows,withHeader:!0}:q?{header:null,rows:q.rows,withHeader:!1}:null,X=null;if(z)try{X=yr(e.schema,z)}catch(Q){En("convert: buildTableNode error (multi)",{message:String(Q?.message||Q||""),stack:String(Q?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),X=null}if(!X){l+=h.nodeSize,d+=1;continue}c.push({from:b,to:a+I,tableNode:X}),En("convert: multi-paragraph table",{sectionId:t,from:b,to:a+I,lines:A}),l=I,d=N}if(!c.length)return null;c.sort((h,b)=>b.from-h.from);let m=e.tr;for(let h of c)m=m.replaceRangeWith(h.from,h.to,h.tableNode);return m=m.setMeta(ue,!0),m}catch{return null}}function br(e){if(!e)return"";let t="";return e.descendants(n=>{n.isText?t+=n.text||"":n.type?.name==="hardBreak"&&(t+=`
`)}),t}function vd(e){try{if(!e||e.type!=="paragraph")return"";let t=[],n=r=>{if(!r)return;if(r.type==="text"){t.push(String(r.text||""));return}if(r.type==="hardBreak"){t.push(`
`);return}let o=Array.isArray(r.content)?r.content:[];for(let i of o)n(i)};return n(e),t.join("")}catch{return""}}function Im(e){if(!e)return null;let{header:t,rows:n}=e;if(!Array.isArray(t)||t.length===0)return null;let r=s=>({type:"paragraph",content:String(s||"").length?[{type:"text",text:String(s||"")}]:[]}),o={type:"tableRow",content:t.map(s=>({type:"tableHeader",content:[r(s)]}))},i=(Array.isArray(n)?n:[]).map(s=>({type:"tableRow",content:s.map(a=>({type:"tableCell",content:[r(a)]}))}));return{type:"table",content:[o,...i]}}function Em(e){if(!e)return!1;try{let{doc:t,schema:n}=e.state,r=[];if(t.descendants((i,s)=>{if(i.type?.name!=="outlineBody")return;let a=s+1,c=0,l=0;for(;l<i.childCount;){let d=i.child(l),m=a+c;if(d.type?.name!=="paragraph"){c+=d.nodeSize,l+=1;continue}let h=br(d).trim();if(h.includes(`
`)&&h.includes("|")){let q=Fa(h),z=Pr(q),X=z?null:_r(q),Q=z?{header:z.header,rows:z.rows,withHeader:!0}:X?{header:null,rows:X.rows,withHeader:!1}:null,oe=Q?yr(n,Q):null;if(oe){r.push({from:m,to:m+d.nodeSize,tableNode:oe}),c+=d.nodeSize,l+=1;continue}}let b=Cn(h);if(!b){c+=d.nodeSize,l+=1;continue}if(l+1>=i.childCount){let q=_r([h]),z=q?{header:null,rows:q.rows,withHeader:!1}:null,X=z?yr(n,z):null;X&&r.push({from:m,to:m+d.nodeSize,tableNode:X}),c+=d.nodeSize,l+=1;continue}let w=i.child(l+1);if(w.type?.name!=="paragraph"){c+=d.nodeSize,l+=1;continue}let f=br(w).trim(),p=Cn(f);if(!p||p.length!==b.length||!p.every(Ji)){let q=[h],z=c+d.nodeSize,X=l+1;for(;X<i.childCount;){let Pe=i.child(X);if(Pe.type?.name!=="paragraph")break;let te=br(Pe).trim();if(!te)break;let Se=Cn(te);if(!Se||Se.length!==b.length)break;q.push(te),z+=Pe.nodeSize,X+=1}let Q=_r(q),oe=Q?{header:null,rows:Q.rows,withHeader:!1}:null,we=oe?yr(n,oe):null;if(we){r.push({from:m,to:a+z,tableNode:we}),c=z,l=X;continue}c+=d.nodeSize,l+=1;continue}let y=[h,f],x=c+d.nodeSize+w.nodeSize,A=l+2;for(;A<i.childCount;){let q=i.child(A);if(q.type?.name!=="paragraph")break;let z=br(q).trim();if(!z)break;let X=Cn(z);if(!X||X.length!==b.length)break;y.push(z),x+=q.nodeSize,A+=1}let I=Pr(y),N=I?{header:I.header,rows:I.rows,withHeader:!0}:null,$=N?yr(n,N):null;if(!$){c+=d.nodeSize,l+=1;continue}r.push({from:m,to:a+x,tableNode:$}),c=x,l=A}}),!r.length)return!1;r.sort((i,s)=>s.from-i.from);let o=e.state.tr;for(let i of r)o=o.replaceRangeWith(i.from,i.to,i.tableNode);return o=o.setMeta(ue,!0),e.view.dispatch(o),!0}catch{return!1}}function Xn(){let e=Date.now();if(!(e-Cd<900)){Cd=e;try{ve("\u0414\u043B\u044F \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Enter \u0438\u043B\u0438 \u0434\u0432\u043E\u0439\u043D\u043E\u0439 \u043A\u043B\u0438\u043A \u043C\u044B\u0448\u043A\u043E\u0439. Esc \u0434\u043B\u044F \u0432\u044B\u0445\u043E\u0434\u0430.")}catch{}}}function Da(e=""){let t=document.createElement("div");return t.innerHTML=e||"",(t.textContent||"").replace(/\u00a0/g," ").trim()}function tr(e=""){return String(e||"").replace(/\u00a0/g," ").replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}function Oa(e=""){let t=String(e||""),n=0;for(let r=0;r<t.length;r+=1)n=n*31+t.charCodeAt(r)>>>0;return String(n)}function no(e=""){return Oa(String(e||"").slice(0,12e3))}function en(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`sec-${Date.now()}-${Math.random().toString(16).slice(2)}`}function Xd({loading:e=!1}={}){V.outlineEditor&&(V.outlineEditor.innerHTML=`
    <div class="outline-editor__body">
      <div class="outline-editor__content" id="outlineEditorContent"></div>
      <div class="outline-editor__loading ${e?"":"hidden"}">\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440\u2026</div>
    </div>
  `,Ca||(Ca=!0))}function Qd(e){let t=String(e||"").trim();if(!t)return null;let n=t.match(/(-?\d+(?:\.\d+)?)%/);if(!n)return null;let r=Number.parseFloat(n[1]);return Number.isFinite(r)?r:null}function Kn(e){let t=Number(e);return Number.isFinite(t)?Math.max(0,Math.min(100,t)):0}function Zd(e){try{let t=e?.dataset?.ttPct||"",n=Number.parseFloat(String(t||""));if(Number.isFinite(n)&&n>0)return n;let r=Qd(e?.style?.width||"");return r!=null&&r>0?r:null}catch{return null}}function Wi(e,t){try{let n=Kn(t);return e.dataset.ttPct=n.toFixed(4),e.style.width=`${n.toFixed(4)}%`,e.style.minWidth="",!0}catch{return!1}}function Vi(e,{insertIndex:t,newColPct:n=10}={}){try{let r=e?.view;if(!r)return!1;let o=Number(t);if(!Number.isFinite(o)||o<0)return!1;let i=r.domAtPos(r.state.selection.from),a=((i?.node&&i.node.nodeType===1?i.node:i?.node?.parentElement)||null)?.closest?.("table")||null;if(!a)return!1;let c=a.querySelector("colgroup");if(!c)return!1;let l=Array.from(c.querySelectorAll("col"));if(!l.length||o>=l.length)return!1;let d=100/l.length,m=l.map(I=>Zd(I)??d),h=Kn(n);m[o]=h;let b=o-1,w=b>=0?m.slice(0,b+1).reduce((I,N)=>I+N,0):0,f=o+1,p=Math.max(0,l.length-f),y=p>0?m.slice(f).reduce((I,N)=>I+N,0):0,x=100-w-h;if(x<0){let I=Math.max(0,o-1),N=Math.max(0,m[I]-1),$=Math.abs(x),q=Math.min(N,$);m[I]=Math.max(1,m[I]-q),x=100-m.slice(0,b+1).reduce((z,X)=>z+X,0)-h,x=Math.max(0,x)}if(p>0)if(y>0){let I=x/y;for(let N=f;N<l.length;N+=1)m[N]*=I}else{let I=x/p;for(let N=f;N<l.length;N+=1)m[N]=I}let A=m.reduce((I,N)=>I+N,0);if(A>0&&Math.abs(A-100)>.01){let I=100-A,N=l.length-1;m[N]=Kn(m[N]+I),A=m.reduce(($,q)=>$+q,0)}for(let I=0;I<l.length;I+=1)Wi(l[I],m[I]);try{a.style.width="100%",a.style.maxWidth="100%",a.style.tableLayout="fixed"}catch{}return!0}catch{return!1}}function Ui(e){try{if(!e)return!1;let t=e.querySelector("colgroup");if(!t)return!1;let n=Array.from(t.querySelectorAll("col"));if(!n.length)return!1;let r=e.getBoundingClientRect();if(!Number.isFinite(r.width)||r.width<=0)return!1;let o=e.querySelector("tbody tr");if(!o)return!1;let i=Array.from(o.children||[]).filter(c=>c&&c.nodeType===1);if(!i.length)return!1;let s=[];for(let c=0;c<n.length;c+=1){let l=i[c]||null;if(!l){s.push(0);continue}let d=l.getBoundingClientRect();s.push(Number.isFinite(d.width)?d.width:0)}let a=s.reduce((c,l)=>c+(Number.isFinite(l)?l:0),0);if(!(a>0))return!1;for(let c=0;c<n.length;c+=1){let l=Kn(s[c]/a*100);Wi(n[c],l)}return!0}catch{return!1}}function un(e){try{if(!e?.state?.selection)return null;let t=e.state.selection;try{let o=t?.$anchorCell?.pos,i=t?.$headCell?.pos,s=Number.isFinite(o)?o:Number.isFinite(i)?i:null;if(s!=null){let a=e.nodeDOM?.(s)||null;if(a&&a.nodeType===1)return a.closest?.("table")||null}}catch{}let n=e.domAtPos(t.from);return((n?.node&&n.node.nodeType===1?n.node:n?.node?.parentElement)||null)?.closest?.("table")||null}catch{return null}}function Cm(e){try{let t=e?.state?.selection||null,n=t?.$from||null;if(!n)return null;try{let s=t?.$anchorCell?.pos,a=t?.$headCell?.pos,c=Number.isFinite(s)?s:Number.isFinite(a)?a:null;if(c!=null){let l=e.nodeDOM?.(c)||null;if(l&&l.nodeType===1)return l}}catch{}let r=null;for(let s=n.depth;s>=0;s-=1){let a=n.node(s)?.type?.name;if(a==="tableCell"||a==="tableHeader"){r=s;break}}if(r!=null){let s=n.before(r),a=e.nodeDOM?.(s)||null;if(a&&a.nodeType===1)return a}let o=e.domAtPos(t.from);return((o?.node&&o.node.nodeType===1?o.node:o?.node?.parentElement)||null)?.closest?.("td,th")||null}catch{return null}}function co(e){try{if(!e)return null;let t=e.querySelector("colgroup");if(!t)return null;let n=Array.from(t.querySelectorAll("col"));if(!n.length)return null;let r=n.map(l=>Zd(l));if(r.some(l=>typeof l=="number"&&Number.isFinite(l)&&l>0)){let l=100/n.length;return r.map(d=>typeof d=="number"&&Number.isFinite(d)&&d>0?d:l)}let i=e.querySelector("tbody tr");if(!i)return null;let s=Array.from(i.children||[]).filter(l=>l&&l.nodeType===1);if(s.length<n.length)return null;let a=[];for(let l=0;l<n.length;l+=1){let d=s[l].getBoundingClientRect();a.push(Number.isFinite(d.width)?d.width:0)}let c=a.reduce((l,d)=>l+(Number.isFinite(d)?d:0),0);return c>0?a.map(l=>Kn(l/c*100)):null}catch{return null}}function lo(e,t){try{if(!e)return!1;let n=e.querySelector("colgroup");if(!n)return!1;let r=Array.from(n.querySelectorAll("col"));if(!r.length||!Array.isArray(t)||t.length!==r.length)return!1;for(let o=0;o<r.length;o+=1)Wi(r[o],t[o]);try{e.style.width="100%",e.style.maxWidth="100%",e.style.tableLayout="fixed"}catch{}return!0}catch{return!1}}function eu(e,t){try{let n=Array.isArray(e)?e.map(m=>Number(m)||0):null,r=Number(t);if(!n||!Number.isFinite(r)||r<0||r>=n.length||n.length<=1)return null;let o=Math.max(0,n[r]||0),i=n.slice(0,r),s=n.slice(r+1),a=s.reduce((m,h)=>m+(Number.isFinite(h)?h:0),0),c=s;if(s.length)if(a>0){let m=(a+o)/a;c=s.map(h=>Number.isFinite(h)?h*m:0)}else{let m=(o||0)/s.length;c=s.map(()=>m)}else i.length&&(i[i.length-1]=Math.max(1,(i[i.length-1]||0)+o));let l=[...i,...c].map(m=>Kn(m)),d=l.reduce((m,h)=>m+(Number.isFinite(h)?h:0),0);return d>0&&Math.abs(d-100)>.01&&(l[l.length-1]=Kn(l[l.length-1]+(100-d))),l}catch{return null}}function jt(e){try{let t=vt?.TableMap||null,n=e?.selection||null,r=n?.$from||null,i=n?.$anchorCell||null||r||null;if(!i)return null;let s=null;for(let p=i.depth;p>=0;p-=1)if(i.node(p)?.type?.name==="table"){s=p;break}if(s==null)return null;let a=i.before(s),c=e.doc.nodeAt(a);if(!c||c.type?.name!=="table")return null;let l=null;for(let p=s+1;p<=i.depth;p+=1){let y=i.node(p)?.type?.name;if(y==="tableCell"||y==="tableHeader"){l=p;break}}if(l==null)return null;let d=i.before(l),m=t?.get?t.get(c):null;if(!m)return null;let h=d-a-1,b=m.findCell(h),w=Number(b?.left??0),f=Number(b?.top??0);return{tablePos:a,tableNode:c,map:m,colIndex:w,rowIndex:f}}catch{return null}}function Ea(e){try{let t=[],n=e?.selection,r=e?.doc;if(!n||!r)return t;try{r.nodesBetween(n.from,n.to,(i,s)=>{let a=i?.type?.name;(a==="tableCell"||a==="tableHeader")&&t.push({node:i,pos:s})})}catch{}if(!t.length)try{let i=n.$from||null;if(i)for(let s=i.depth;s>=0;s-=1){let a=i.node(s)?.type?.name;if(a==="tableCell"||a==="tableHeader"){let c=i.before(s),l=r.nodeAt(c);l&&t.push({node:l,pos:c});break}}}catch{}let o=new Map;for(let i of t){let s=Number(i?.pos);Number.isFinite(s)&&(o.has(s)||o.set(s,i))}return Array.from(o.values()).sort((i,s)=>Number(i.pos)-Number(s.pos))}catch{return[]}}function vm(e,t){try{let n=vt?.CellSelection||null,r=vt?.TableMap||null;return!n||!r?!1:e.commands.command(({state:o,dispatch:i})=>{let s=jt(o);if(!s)return!1;let{tablePos:a,tableNode:c,map:l}=s,d=Number(t);if(!Number.isFinite(d)||d<0||d>=l.height)return!1;let m=l.positionAt(d,0,c),h=l.positionAt(d,l.width-1,c),b=a+1+m,w=a+1+h,f=null;try{typeof n.create=="function"&&(f=n.create(o.doc,b,w))}catch{f=null}if(!f)return!1;let p=o.tr.setSelection(f);return p=p.setMeta(ue,!0),i(p.scrollIntoView()),!0})}catch{return!1}}function Tm(e,t,n){try{let r=vt?.CellSelection||null,o=vt?.TableMap||null;if(!r||!o)return!1;let i=Number(t),s=Number(n);return!Number.isFinite(i)||i<0||!Number.isFinite(s)||s<0?!1:e.commands.command(({state:a,dispatch:c})=>{let l=a?.doc?.nodeAt?.(i)||null;if(!l||l.type?.name!=="table")return!1;let d=o?.get?o.get(l):null;if(!d||s>=d.height)return!1;let m=d.positionAt(s,0,l),h=d.positionAt(s,d.width-1,l),b=i+1+m,w=i+1+h,f=null;try{typeof r.create=="function"&&(f=r.create(a.doc,b,w))}catch{f=null}if(!f)return!1;let p=a.tr.setSelection(f);return p=p.setMeta(ue,!0),c(p.scrollIntoView()),!0})}catch{return!1}}function Bm(e,t){try{let n=vt?.CellSelection||null,r=vt?.TableMap||null;return!n||!r?!1:e.commands.command(({state:o,dispatch:i})=>{let s=jt(o);if(!s)return!1;let{tablePos:a,tableNode:c,map:l}=s,d=Number(t);if(!Number.isFinite(d)||d<0||d>=l.width)return!1;let m=l.positionAt(0,d,c),h=l.positionAt(l.height-1,d,c),b=a+1+m,w=a+1+h,f=null;try{typeof n.create=="function"&&(f=n.create(o.doc,b,w))}catch{f=null}if(!f)return!1;let p=o.tr.setSelection(f);return p=p.setMeta(ue,!0),i(p.scrollIntoView()),!0})}catch{return!1}}function Nm(e,t,n){try{let r=vt?.CellSelection||null,o=vt?.TableMap||null;if(!r||!o)return!1;let i=Number(t),s=Number(n);return!Number.isFinite(i)||i<0||!Number.isFinite(s)||s<0?!1:e.commands.command(({state:a,dispatch:c})=>{let l=a?.doc?.nodeAt?.(i)||null;if(!l||l.type?.name!=="table")return!1;let d=o?.get?o.get(l):null;if(!d||s>=d.width)return!1;let m=d.positionAt(0,s,l),h=d.positionAt(d.height-1,s,l),b=i+1+m,w=i+1+h,f=null;try{typeof r.create=="function"&&(f=r.create(a.doc,b,w))}catch{f=null}if(!f)return!1;let p=a.tr.setSelection(f);return p=p.setMeta(ue,!0),c(p.scrollIntoView()),!0})}catch{return!1}}function Mm({pmState:e,dispatch:t},{tablePos:n,rowIndex:r,attr:o,value:i}){try{let s=vt?.CellSelection||null,a=vt?.TableMap||null;if(!a)return!1;let c=Number(n),l=Number(r);if(!Number.isFinite(c)||c<0||!Number.isFinite(l)||l<0)return!1;let d=e?.doc?.nodeAt?.(c)||null;if(!d||d.type?.name!=="table")return!1;let m=a?.get?a.get(d):null;if(!m||l>=m.height)return!1;let h=e.tr;try{if(s?.create){let f=m.positionAt(l,0,d),p=m.positionAt(l,m.width-1,d),y=c+1+f,x=c+1+p;h=h.setSelection(s.create(h.doc,y,x))}}catch{}let b=new Set;for(let f=0;f<m.width;f+=1){let p=m.map[l*m.width+f];Number.isFinite(p)&&b.add(c+1+p)}if(!b.size)return!1;let w=!1;for(let f of b){let p=h.doc.nodeAt(f),y=p?.type?.name;if(y!=="tableCell"&&y!=="tableHeader")continue;let x={...p.attrs||{}};i==null||i===""?delete x[o]:x[o]=i,h=h.setNodeMarkup(f,void 0,x),w=!0}return w?(h=h.setMeta(ue,!0),t(h),!0):!1}catch{return!1}}function Lm({pmState:e,dispatch:t},{tablePos:n,colIndex:r,attr:o,value:i}){try{let s=vt?.CellSelection||null,a=vt?.TableMap||null;if(!a)return!1;let c=Number(n),l=Number(r);if(!Number.isFinite(c)||c<0||!Number.isFinite(l)||l<0)return!1;let d=e?.doc?.nodeAt?.(c)||null;if(!d||d.type?.name!=="table")return!1;let m=a?.get?a.get(d):null;if(!m||l>=m.width)return!1;let h=e.tr;try{if(s?.create){let f=m.positionAt(0,l,d),p=m.positionAt(m.height-1,l,d),y=c+1+f,x=c+1+p;h=h.setSelection(s.create(h.doc,y,x))}}catch{}let b=new Set;for(let f=0;f<m.height;f+=1){let p=m.map[f*m.width+l];Number.isFinite(p)&&b.add(c+1+p)}if(!b.size)return!1;let w=!1;for(let f of b){let p=h.doc.nodeAt(f),y=p?.type?.name;if(y!=="tableCell"&&y!=="tableHeader")continue;let x={...p.attrs||{}};i==null||i===""?delete x[o]:x[o]=i,h=h.setNodeMarkup(f,void 0,x),w=!0}return w?(h=h.setMeta(ue,!0),t(h),!0):!1}catch{return!1}}function Yi(e,t="\u0442\u0430\u0431\u043B\u0438\u0446\u044B"){try{let n=!1;return e.descendants(r=>{if(n)return!1;let o=r?.type?.name;if(o==="tableCell"||o==="tableHeader"){let i=Number(r.attrs?.colspan||1),s=Number(r.attrs?.rowspan||1);if(i!==1||s!==1)return n=!0,!1}return!0}),n?(ve(`\u041F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 ${t} \u043F\u043E\u043A\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u0445 \u044F\u0447\u0435\u0435\u043A`),!1):!0}catch{return!1}}function tu(e,{kind:t,fromIndex:n,toIndex:r}){try{if(!e||!(vt?.TableMap||null))return!0;let i=e.map||null,s=e.tableNode||null;if(!i||!s)return!0;let a=Number(n),c=Number(r);if(!Number.isFinite(a)||!Number.isFinite(c))return!0;let l=t==="row"?Math.max(0,Math.min(i.height-1,a)):Math.max(0,Math.min(i.width-1,a)),d=t==="row"?Math.max(0,Math.min(i.height-1,c)):Math.max(0,Math.min(i.width-1,c)),m=new Set;for(let h of i.map){let b=Number(h);if(!Number.isFinite(b)||b<0||m.has(b))continue;m.add(b);let w=null;try{w=i.findCell(b)}catch{w=null}if(!w)continue;let f=Number(w.right)-Number(w.left),p=Number(w.bottom)-Number(w.top);if(f>1||p>1)if(t==="col"){let y=Number(w.left),x=Number(w.right);if(y<=l&&l<x||y<=d&&d<x)return!0}else{let y=Number(w.top),x=Number(w.bottom);if(y<=l&&l<x||y<=d&&d<x)return!0}}return!1}catch{return!0}}function Td(e,t){try{if(!e?.view)return!1;let n=jt(e.state);if(!n)return!1;let{colIndex:r}=n,o=n.map?.width||0;if(!(o>0))return!1;let i=t<0?-1:1,s=r+i;return s>=0&&s<o?nu(e,r,s):!1}catch{return!1}}function Bd(e,t){try{if(!e?.view)return!1;let n=jt(e.state);if(!n)return!1;let{rowIndex:r}=n,o=n.map?.height||0;if(!(o>0))return!1;let i=t<0?-1:1,s=r+i;return s>=0&&s<o?ru(e,r,s):!1}catch{return!1}}function nu(e,t,n){try{if(!e?.view)return!1;let r=e.state,o=jt(r);if(!o)return!1;let{tableNode:i}=o,s=o.map?.width||0;if(!(s>0))return!1;let a=Number(t),c=Number(n);if(!Number.isFinite(a)||!Number.isFinite(c)||a<0||a>=s||c<0||c>=s)return!1;if(a===c)return!0;if(tu(o,{kind:"col",fromIndex:a,toIndex:c}))return ve("\u041D\u0435\u043B\u044C\u0437\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u043E\u043B\u0431\u0435\u0446: \u0438\u0441\u0445\u043E\u0434\u043D\u0430\u044F \u0438\u043B\u0438 \u0446\u0435\u043B\u0435\u0432\u0430\u044F \u043A\u043E\u043B\u043E\u043D\u043A\u0430 \u043F\u0435\u0440\u0435\u0441\u0435\u043A\u0430\u0435\u0442\u0441\u044F \u0441 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u043C\u0438 \u044F\u0447\u0435\u0439\u043A\u0430\u043C\u0438"),!1;let l=un(e.view),d=co(l),m=Array.isArray(d)&&d.length===s?(()=>{let f=d.slice(),p=f.splice(a,1)[0];return f.splice(c,0,p),f})():null,h=vt?.moveTableColumn||null;if(typeof h!="function")return!1;let b=h({from:a,to:c,select:!0});return e.commands.command(({state:f,dispatch:p})=>b(f,typeof p=="function"?x=>{try{x=x.setMeta(ue,!0)}catch{}p(x)}:void 0))?(m&&window.requestAnimationFrame(()=>{let f=un(e.view);lo(f,m);try{(f?.closest?.(".tableWrapper")||null)?.dispatchEvent?.(new Event("scroll"))}catch{}}),!0):!1}catch{return!1}}function ru(e,t,n){try{if(!e?.view)return!1;let r=e.state,o=jt(r);if(!o)return!1;let i=o.map?.height||0,s=o.map?.width||0;if(!(s>0&&i>0))return!1;let a=Number(t),c=Number(n);if(!Number.isFinite(a)||!Number.isFinite(c)||a<0||a>=i||c<0||c>=i)return!1;if(a===c)return!0;if(tu(o,{kind:"row",fromIndex:a,toIndex:c}))return ve("\u041D\u0435\u043B\u044C\u0437\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u043E\u043A\u0443: \u0438\u0441\u0445\u043E\u0434\u043D\u0430\u044F \u0438\u043B\u0438 \u0446\u0435\u043B\u0435\u0432\u0430\u044F \u0441\u0442\u0440\u043E\u043A\u0430 \u043F\u0435\u0440\u0435\u0441\u0435\u043A\u0430\u0435\u0442\u0441\u044F \u0441 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u043C\u0438 \u044F\u0447\u0435\u0439\u043A\u0430\u043C\u0438"),!1;let l=un(e.view),d=co(l),m=vt?.moveTableRow||null;if(typeof m!="function")return!1;let h=m({from:a,to:c,select:!0});return e.commands.command(({state:w,dispatch:f})=>h(w,typeof f=="function"?y=>{try{y=y.setMeta(ue,!0)}catch{}f(y)}:void 0))?(Array.isArray(d)&&d.length===s&&window.requestAnimationFrame(()=>{let w=un(e.view);lo(w,d)}),!0):!1}catch{return!1}}function ou(e){try{if(!e)return"";let t=e.textContent||"";return String(t).replace(/\s+/g," ").trim()}catch{return""}}function Pm(e){try{if(!e)return!1;for(let t=0;t<e.childCount;t+=1)if(e.child(t)?.type?.name==="tableHeader")return!0;return!1}catch{return!1}}function Nd(e,{direction:t="asc"}={}){try{if(!e?.view)return!1;let n=e.state,r=jt(n);if(!r)return!1;let{tablePos:o,tableNode:i,colIndex:s}=r,a=i.child(0)?.childCount||0,c=i.childCount||0;if(!(a>0&&c>1)||!(s>=0&&s<a)||!Yi(i,"\u0442\u0430\u0431\u043B\u0438\u0446\u044B"))return!1;let l=Pm(i.child(0))?i.child(0):null,d=l?1:0,m=[];for(let p=d;p<c;p+=1){let y=i.child(p),x=y.child(s);m.push({rowIndex:p,rowNode:y,key:ou(x)})}let h=t==="desc"?-1:1;m.sort((p,y)=>h*p.key.localeCompare(y.key,void 0,{sensitivity:"base",numeric:!0}));let b=[];l&&b.push(l);for(let p of m)b.push(p.rowNode);let w=i.type.create(i.attrs,b),f=n.tr.replaceWith(o,o+i.nodeSize,w);return f=f.setMeta(ue,!0),e.view.dispatch(f.scrollIntoView()),!0}catch{return!1}}function Md(e,{direction:t="asc"}={}){try{if(!e?.view)return!1;let n=e.state,r=jt(n);if(!r)return!1;let{tablePos:o,tableNode:i,rowIndex:s}=r,a=i.child(0)?.childCount||0,c=i.childCount||0;if(!(a>1&&c>0)||!(s>=0&&s<c)||!Yi(i,"\u0442\u0430\u0431\u043B\u0438\u0446\u044B"))return!1;let l=i.child(s),d=[];for(let A=0;A<a;A+=1)d.push({colIndex:A,key:ou(l.child(A))});let m=t==="desc"?-1:1;d.sort((A,I)=>m*A.key.localeCompare(I.key,void 0,{sensitivity:"base",numeric:!0}));let h=d.map(A=>A.colIndex),b=un(e.view),w=co(b),f=Array.isArray(w)&&w.length===a?h.map(A=>w[A]):null,p=[];for(let A=0;A<c;A+=1){let I=i.child(A),N=h.map($=>I.child($));p.push(I.type.create(I.attrs,N))}let y=i.type.create(i.attrs,p),x=n.tr.replaceWith(o,o+i.nodeSize,y);return x=x.setMeta(ue,!0),e.view.dispatch(x.scrollIntoView()),f&&window.requestAnimationFrame(()=>{let A=un(e.view);lo(A,f)}),!0}catch{return!1}}function _m(e){try{if(!e?.view)return!1;let t=e.state,n=jt(t);if(!n)return!1;let{tablePos:r,tableNode:o,rowIndex:i,colIndex:s}=n,a=o.child(0)?.childCount||0,c=o.childCount||0;if(!(a>0&&c>0)||!(i>=0&&i<c)||!Yi(o,"\u0441\u0442\u0440\u043E\u043A"))return!1;let l=o.child(i),d=[];for(let b=0;b<c;b+=1)d.push(o.child(b)),b===i&&d.push(l.type.create(l.attrs,l.content,l.marks));let m=o.type.create(o.attrs,d),h=t.tr.replaceWith(r,r+o.nodeSize,m);h=h.setMeta(ue,!0);try{let b=Je?.pmStateMod?.TextSelection;if(b){let w=Math.min(m.childCount-1,i+1),f=Math.min(a-1,Math.max(0,s)),p=m.child(w),y=p.child(f),x=r+1;for(let $=0;$<w;$+=1)x+=m.child($).nodeSize;x+=1;for(let $=0;$<f;$+=1)x+=p.child($).nodeSize;let A=x,I=A+1,N=A+y.nodeSize-1;h=h.setSelection(b.near(h.doc.resolve(Math.min(N,I+1)),1))}}catch{}return e.view.dispatch(h.scrollIntoView()),!0}catch{return!1}}function Dm(e){try{if(!e?.view)return!1;let t=e.state,n=jt(t);if(!n)return!1;let{tablePos:r,tableNode:o,rowIndex:i,colIndex:s}=n,a=o.child(0)?.childCount||0,c=o.childCount||0;if(!(a>0&&c>0)||!(s>=0&&s<a)||!Yi(o,"\u0441\u0442\u043E\u043B\u0431\u0446\u043E\u0432"))return!1;let l=un(e.view),d=co(l),m=null;if(Array.isArray(d)&&d.length===a){let f=[...d],p=Math.max(0,Number(f[s]||0)),y=Kn(p/2);f[s]=y,f.splice(s+1,0,y);let x=f.reduce((A,I)=>A+(Number.isFinite(I)?I:0),0);x>0&&Math.abs(x-100)>.01&&(f[f.length-1]=Kn(f[f.length-1]+(100-x))),m=f}let h=[];for(let f=0;f<c;f+=1){let p=o.child(f),y=[];for(let x=0;x<a;x+=1){let A=p.child(x);y.push(A),x===s&&y.push(A.type.create(A.attrs,A.content,A.marks))}h.push(p.type.create(p.attrs,y))}let b=o.type.create(o.attrs,h),w=t.tr.replaceWith(r,r+o.nodeSize,b);w=w.setMeta(ue,!0);try{let f=Je?.pmStateMod?.TextSelection;if(f){let p=Math.min(b.childCount-1,Math.max(0,i)),y=Math.min(a,Math.max(0,s+1)),x=b.child(p),A=x.child(y),I=r+1;for(let z=0;z<p;z+=1)I+=b.child(z).nodeSize;I+=1;for(let z=0;z<y;z+=1)I+=x.child(z).nodeSize;let N=I,$=N+1,q=N+A.nodeSize-1;w=w.setSelection(f.near(w.doc.resolve(Math.min(q,$+1)),1))}}catch{}return e.view.dispatch(w.scrollIntoView()),Array.isArray(m)&&m.length===a+1?window.requestAnimationFrame(()=>{let f=un(e.view);lo(f,m)}):window.requestAnimationFrame(()=>{let f=un(e.view);Ui(f)}),!0}catch{return!1}}function Om(e,t,n){try{if(!e?.view)return!1;let{state:r,view:o}=e,{selection:i}=r,s=i?.$from||null;if(!s)return!1;let a=n instanceof Set?n:new Set(Array.from(n||[])),c=null;for(let $=s.depth;$>0;$-=1)if(s.node($)?.type?.name==="paragraph"){let q=s.node($-1)?.type?.name||"";a.has(q)&&(c=$);break}if(c==null)return!1;let l=c-1,d=s.node(l),m=s.index(l);if(!d)return!1;let h=t<0?-1:1,b=m+h;if(!(b>=0&&b<d.childCount))return!1;let w=d.child(m),f=d.child(b);if(w?.type?.name!=="paragraph"||f?.type?.name!=="paragraph")return!1;let p=s.before(c),y=w.nodeSize,x=h<0?p-f.nodeSize:p+y,A=f.nodeSize,I=Math.max(0,i.from-s.start(c)),N=r.tr;if(h<0){N=N.delete(p,p+y),N=N.insert(x,w);let $=x,q=$+1,z=$+w.nodeSize-1,X=q+I,Q=Math.min(Math.max(X,q),z);try{let oe=Je?.pmStateMod?.TextSelection;oe&&(N=N.setSelection(oe.near(N.doc.resolve(Q),1)))}catch{}}else{N=N.delete(p,p+y);let $=p+A;N=N.insert($,w);let q=$,z=q+1,X=q+w.nodeSize-1,Q=z+I,oe=Math.min(Math.max(Q,z),X);try{let we=Je?.pmStateMod?.TextSelection;we&&(N=N.setSelection(we.near(N.doc.resolve(oe),1)))}catch{}}return N=N.setMeta(ue,!0),o.dispatch(N.scrollIntoView()),!0}catch{return!1}}function Ld(e,t){return Om(e,t,new Set(["outlineBody","tableCell","tableHeader"]))}function Pd(e,t){try{if(!e?.view)return!1;let{state:n,view:r}=e,{selection:o}=n,i=o?.$from||null;if(!i)return!1;let s=null;for(let I=i.depth;I>0;I-=1)if(i.node(I)?.type?.name==="listItem"){s=I;break}if(s==null)return!1;let a=s-1,c=i.node(a),l=c?.type?.name||"";if(l!=="bulletList"&&l!=="orderedList")return!1;let d=i.index(a),m=t<0?-1:1,h=d+m;if(!(h>=0&&h<c.childCount))return!1;let b=c.child(d),w=c.child(h);if(b?.type?.name!=="listItem"||w?.type?.name!=="listItem")return!1;let f=i.before(s),p=b.nodeSize,y=w.nodeSize,x=Math.max(0,o.from-i.start(s)),A=n.tr;if(m<0){let I=f-y;A=A.delete(f,f+p),A=A.insert(I,b);let N=I,$=N+1,q=N+b.nodeSize-1,z=$+x,X=Math.min(Math.max(z,$),q);try{let Q=Je?.pmStateMod?.TextSelection;Q&&(A=A.setSelection(Q.near(A.doc.resolve(X),1)))}catch{}}else{A=A.delete(f,f+p);let I=f+y;A=A.insert(I,b);let N=I,$=N+1,q=N+b.nodeSize-1,z=$+x,X=Math.min(Math.max(z,$),q);try{let Q=Je?.pmStateMod?.TextSelection;Q&&(A=A.setSelection(Q.near(A.doc.resolve(X),1)))}catch{}}return A=A.setMeta(ue,!0),r.dispatch(A.scrollIntoView()),!0}catch{return!1}}function Rm(e){if(!V.outlineToolbar||!e)return;let t=V.outlineToolbar,n=null,r={undo:V.outlineUndoBtn,redo:V.outlineRedoBtn,attachBtn:t.querySelector("#outlineAttachBtn"),attachInput:t.querySelector("#outlineAttachInput"),deleteBtn:V.outlineDeleteBtn,moveUpBtn:V.outlineMoveUpBtn,moveDownBtn:V.outlineMoveDownBtn,outdentBtn:V.outlineOutdentBtn,indentBtn:V.outlineIndentBtn,newBelowBtn:V.outlineNewBelowBtn,blocksMenuBtn:t.querySelector("#outlineBlocksMenuBtn"),textMenuBtn:t.querySelector("#outlineTextMenuBtn"),calloutMenuBtn:t.querySelector("#outlineCalloutMenuBtn"),listsMenuBtn:t.querySelector("#outlineListsMenuBtn"),tableMenuBtn:t.querySelector("#outlineTableMenuBtn")},o=new Set(Array.from(t.querySelectorAll(".outline-toolbar__dropdown-btn")));r.blocksMenuBtn&&o.add(r.blocksMenuBtn),r.textMenuBtn&&o.add(r.textMenuBtn),r.calloutMenuBtn&&o.add(r.calloutMenuBtn),r.listsMenuBtn&&o.add(r.listsMenuBtn),r.tableMenuBtn&&o.add(r.tableMenuBtn);let i=Array.from(o),s=Array.from(t.querySelectorAll(".outline-toolbar__menu")),a=Array.from(t.querySelectorAll("[data-outline-action]")),c=Array.from(t.querySelectorAll("[data-outline-clipboard-action]")),l=(Y,ce)=>{if(!Y)return()=>{};let pe=me=>{me.preventDefault(),me.stopPropagation(),ce()};return Y.addEventListener("click",pe),()=>Y.removeEventListener("click",pe)},d=(Y,ce)=>{Y&&(Y.classList.toggle("is-active",!!ce),Y.setAttribute("aria-pressed",ce?"true":"false"))},m=()=>{for(let Y of s)Y.classList.add("hidden");for(let Y of i)Y.setAttribute("aria-expanded","false")},h=()=>{let Y=La(),ce=!!(Y&&Array.isArray(Y.sections)&&Y.sections.length);for(let pe of c)pe?.getAttribute?.("data-outline-clipboard-action")==="paste"&&pe.toggleAttribute("disabled",!ce)},b=Y=>{if(!Y)return;let ce=Y.getAttribute("aria-controls"),pe=ce?t.querySelector(`#${ce}`)||document.getElementById(ce):null;if(!pe)return!1;let me=!pe.classList.contains("hidden");return m(),me||(ce==="outlineBlocksMenu"&&h(),pe.classList.remove("hidden"),Y.setAttribute("aria-expanded","true")),!0},w="ttree_outline_debug_dropdown_v1",f=()=>{try{return window?.localStorage?.getItem?.(w)==="1"}catch{return!1}},p=(Y,ce={})=>{try{if(!f())return;console.log("[outline][dropdown]",Y,ce)}catch{}},y=Y=>{try{let ce=e.can().chain();return A()&&ce.command(({tr:pe})=>(pe.setMeta(ue,!0),!0)),Y(ce),ce.run()}catch{return!1}},x=Y=>{if(!Y)return!1;try{let ce=e.chain().focus();if(A()&&ce.command(({tr:pe})=>(pe.setMeta(ue,!0),!0)),Y==="collapseAllBlocks")return Pa(e,!0);if(Y==="expandAllBlocks")return Pa(e,!1);if(Y==="toggleBold")return ce.toggleBold().run();if(Y==="toggleItalic")return ce.toggleItalic().run();if(Y==="toggleStrike")return ce.toggleStrike().run();if(Y==="toggleCodeBlock")return e.commands.command(({state:pe,dispatch:me})=>{let fe=pe.schema.nodes?.codeBlock||null;if(!fe)return!1;let ke=pe.selection,{from:Te,to:ne}=ke;if(Te===ne){let dt=pe.tr.setMeta(ue,!0);return me(dt),e.commands.toggleCodeBlock()}let Ne=ke.$from?.blockRange?.(ke.$to)||null;if(!Ne){let dt=pe.tr.setMeta(ue,!0);return me(dt),e.commands.toggleCodeBlock()}if(!Ne.parent?.canReplaceWith?.(Ne.startIndex,Ne.endIndex,fe)){let dt=pe.tr.setMeta(ue,!0);return me(dt),e.commands.toggleCodeBlock()}let Ye=pe.doc.textBetween(Ne.start,Ne.end,`
`,`
`),Qe=String(Ye||"").replace(/\n+$/g,"").trimEnd();if(!Qe)return!1;let ct=fe.create(null,pe.schema.text(Qe)),rt=pe.tr.replaceRangeWith(Ne.start,Ne.end,ct);return rt=rt.setMeta(ue,!0),te&&(rt=rt.setSelection(te.near(rt.doc.resolve(Ne.start+2),1))),me(rt.scrollIntoView()),!0});if(Y==="toggleBlockquote")return ce.toggleBlockquote().run();if(Y.startsWith("setTextBg:")){if(!I())return!1;let pe=Y.slice(10);return e.commands.setTextBg(pe)}if(Y==="clearTextBg")return I()?e.commands.clearTextBg():!1;if(Y.startsWith("setCallout:")){try{if(!(Ee?.getState?.(e.state)||null)?.editingSectionId)return Xn(),!1}catch{return Xn(),!1}let pe=Y.split(":")[1]||"";return e.commands.setCallout(pe)}if(Y==="unsetCallout"){try{if(!(Ee?.getState?.(e.state)||null)?.editingSectionId)return Xn(),!1}catch{return Xn(),!1}return e.commands.unsetCallout()}if(Y==="unsetLink")return ce.unsetLink().run();if(Y==="toggleBulletList")return e.isActive("orderedList")?ce.toggleOrderedList().toggleBulletList().run():ce.toggleBulletList().run();if(Y==="toggleOrderedList")return e.isActive("bulletList")?ce.toggleBulletList().toggleOrderedList().run():ce.toggleOrderedList().run();if(Y==="unsetList")return e.isActive("bulletList")?ce.toggleBulletList().run():e.isActive("orderedList")?ce.toggleOrderedList().run():ce.liftListItem("listItem").run();if(Y==="insertTable")return ce.insertTable({rows:2,cols:2,withHeaderRow:!1}).run();if(Y==="toggleHeaderRow")return ce.toggleHeaderRow().run();if(Y==="toggleHeaderColumn")return ce.toggleHeaderColumn().run();if(Y==="addRowBefore")return ce.addRowBefore().run();if(Y==="addRowAfter")return ce.addRowAfter().run();if(Y==="deleteRow")return ce.deleteRow().run();if(Y==="addColumnBefore"){let pe=jt(e.state),me=pe?Math.max(0,Number(pe.colIndex||0)):0,fe=ce.addColumnBefore().run();return fe&&Vi(e,{insertIndex:me,newColPct:10}),fe}if(Y==="addColumnAfter"){let pe=jt(e.state),me=pe?Math.max(0,Number(pe.colIndex||0)+1):1,fe=ce.addColumnAfter().run();return fe&&Vi(e,{insertIndex:me,newColPct:10}),fe}if(Y==="deleteColumn"){let pe=un(e.view),me=co(pe),fe=jt(e.state),ke=fe?Number(fe.colIndex||0):null,Te=me&&ke!=null?eu(me,ke):null,ne=ce.deleteColumn().run();return ne&&Array.isArray(Te)&&window.requestAnimationFrame(()=>{let Ne=un(e.view);lo(Ne,Te)}),ne}return Y==="mergeCells"?ce.mergeCells().run():Y==="splitCell"?ce.splitCell().run():Y==="copyColumn"||Y==="pasteColumnAfter"||Y==="moveColumnRight"?!1:Y==="cancelTable"?N():Y==="deleteTable"?ce.deleteTable().run():!1}catch{return!1}},A=()=>{try{return!!(Ee?.getState?.(e.state)||null)?.editingSectionId}catch{return!1}},I=()=>A()?!0:(Xn(),!1),N=()=>{if(!I())return!1;try{let{state:Y,view:ce}=e,{schema:pe,selection:me}=Y,fe=me?.$from;if(!fe)return!1;let ke=null;for(let ee=fe.depth;ee>=0;ee-=1)fe.node(ee)?.type?.name==="table"&&(ke=ee);if(ke==null)return!1;let Te=null,ne=null;for(let ee=ke+1;ee<=fe.depth;ee+=1){let ye=fe.node(ee)?.type?.name;if(Te==null&&ye==="tableRow"&&(Te=ee),ne==null&&(ye==="tableCell"||ye==="tableHeader")&&(ne=ee),Te!=null&&ne!=null)break}let Ne=fe.before(ke),Ye=Y.doc.nodeAt(Ne);if(!Ye||Ye.type?.name!=="table")return!1;let Qe=Te!=null?fe.index(ke):null,ct=Te!=null&&ne!=null?fe.index(Te):null,rt=null;if(typeof Qe=="number"&&typeof ct=="number"){let ee=Ye.childCount&&Ye.child(0)?.childCount||0;ee>0&&(rt=Qe*ee+ct)}let dt=[],Xe=0,mt=0;for(let ee=0;ee<Ye.childCount;ee+=1){let de=Ye.child(ee);for(let ye=0;ye<de.childCount;ye+=1){let Ve=de.child(ye),Re=[];try{for(let _e=0;_e<(Ve?.content?.childCount||0);_e+=1){let Ce=Ve.content.child(_e);Ce&&Re.push(Ce)}}catch{}Re.length||Re.push(pe.nodes.paragraph.create(null,[])),rt!=null&&Xe===rt&&(mt=dt.length),dt.push(...Re),Xe+=1}}if(!dt.length)return!1;let ft=pe.nodes.outlineBody?pe.nodes.outlineBody.create({},dt).content:pe.nodes.doc.create({},dt).content,lt=Y.tr.replaceWith(Ne,Ne+Ye.nodeSize,ft);lt=lt.setMeta(ue,!0);try{let ee=Je?.pmStateMod?.TextSelection;if(ee){let de=Ne;for(let Ce=0;Ce<mt;Ce+=1)de+=dt[Ce].nodeSize;let ye=null,Ve=Math.min(lt.doc.content.size,de),Re=Math.min(lt.doc.content.size,de+2e4);lt.doc.nodesBetween(Ve,Re,(Ce,Ge)=>ye!=null?!1:Ce?.isTextblock?(ye=Ge+1,!1):!0);let _e=ye??Math.min(lt.doc.content.size,de+1);lt=lt.setSelection(ee.near(lt.doc.resolve(_e),1))}}catch{}return ce.dispatch(lt.scrollIntoView()),ce.focus?.(),!0}catch{return!1}},$=()=>{if(!I())return!1;try{let{state:Y,view:ce}=e,{selection:pe}=Y,me=pe?.$from;if(!me)return!1;let fe=null,ke=null,Te=null;for(let lt=me.depth;lt>=0;lt-=1){let de=me.node(lt)?.type?.name;if(Te==null&&(de==="tableCell"||de==="tableHeader")&&(Te=lt),ke==null&&de==="tableRow"&&(ke=lt),de==="table"){fe=lt;break}}if(fe==null||ke==null||Te==null)return!1;let ne=me.before(fe),Ne=Y.doc.nodeAt(ne);if(!Ne||Ne.type?.name!=="table")return!1;let Ye=me.index(fe),Qe=me.index(ke),ct=Ne.child(0)?.childCount||0;if(!(ct>0)||!(Qe>=0&&Qe<ct-1))return!1;let rt=!1;if(Ne.descendants(lt=>{if(rt)return!1;let ee=lt?.type?.name;if(ee==="tableCell"||ee==="tableHeader"){let de=Number(lt.attrs?.colspan||1),ye=Number(lt.attrs?.rowspan||1);if(de!==1||ye!==1)return rt=!0,!1}return!0}),rt)return ve("\u041F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 \u0441\u0442\u043E\u043B\u0431\u0446\u043E\u0432 \u043F\u043E\u043A\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u0445 \u044F\u0447\u0435\u0435\u043A"),!1;let dt=pe.from-me.start(Te),Xe=[];for(let lt=0;lt<Ne.childCount;lt+=1){let ee=Ne.child(lt);if(ee.type?.name!=="tableRow"||ee.childCount!==ct)return!1;let de=[];for(let ye=0;ye<ct;ye+=1)ye===Qe?de.push(ee.child(ye+1)):ye===Qe+1?de.push(ee.child(ye-1)):de.push(ee.child(ye));Xe.push(ee.type.create(ee.attrs,de))}let mt=Ne.type.create(Ne.attrs,Xe),ft=Y.tr.replaceWith(ne,ne+Ne.nodeSize,mt);ft=ft.setMeta(ue,!0);try{let lt=Je?.pmStateMod?.TextSelection;if(lt){let ee=Math.min(mt.childCount-1,Math.max(0,Ye)),de=Qe+1,ye=mt.child(ee),Ve=ye.child(de),Re=ne+1;for(let E=0;E<ee;E+=1)Re+=mt.child(E).nodeSize;Re+=1;for(let E=0;E<de;E+=1)Re+=ye.child(E).nodeSize;let _e=Re,Ce=_e+1,Ge=_e+Ve.nodeSize-1,S=Ce+Math.max(0,dt),g=Math.min(Math.max(S,Ce),Ge);ft=ft.setSelection(lt.near(ft.doc.resolve(g),1))}}catch{}return ce.dispatch(ft.scrollIntoView()),ce.focus?.(),!0}catch{return!1}},q=(Y,ce,pe={})=>{let me=String(Y||"").trim();if(!me)return!1;let fe=String(ce||"").trim()||me,{from:ke,to:Te,empty:ne}=e.state.selection,Ne={href:me,...pe},Ye=e.chain().focus();return A()&&Ye.command(({tr:Qe})=>(Qe.setMeta(ue,!0),!0)),!ne&&ke!==Te?Ye.setLink(Ne).run():Ye.insertContent({type:"text",text:fe,marks:[{type:"link",attrs:Ne}]}).run()},z=async()=>{if(!I())return;let{from:Y,to:ce,empty:pe}=e.state.selection,me=pe?"":e.state.doc.textBetween(Y,ce," ").trim(),fe="",ke=me;try{let ne=await(await Promise.resolve().then(()=>(cr(),xs))).showLinkPrompt({title:"\u0421\u0441\u044B\u043B\u043A\u0430 (URL)",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0441\u0441\u044B\u043B\u043A\u0443 (\u043B\u044E\u0431\u043E\u0439 \u0444\u043E\u0440\u043C\u0430\u0442) \u0438 \u0442\u0435\u043A\u0441\u0442 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E).",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",textLabel:"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)",urlLabel:"\u0421\u0441\u044B\u043B\u043A\u0430",defaultText:me,defaultUrl:"",urlPlaceholder:""});if(!ne||typeof ne!="object")return;fe=String(ne.url||""),ke=String(ne.text??me)}catch{fe=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0441\u0441\u044B\u043B\u043A\u0443")||"",ke=me||window.prompt("\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)")||""}fe=(fe||"").trim(),fe&&q(fe,ke,{target:"_blank",rel:"noopener noreferrer"})},X=async()=>{if(!I())return;let Y=Array.isArray(u.articlesIndex)?u.articlesIndex:[];Y.length||(Y=await Nn().catch(()=>[])||[],Array.isArray(Y)&&(u.articlesIndex=Y));let ce=(Array.isArray(Y)?Y:[]).map(dt=>({id:dt.id,title:dt.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),{from:pe,to:me,empty:fe}=e.state.selection,ke=fe?"":e.state.doc.textBetween(pe,me," ").trim(),Te=!!ke,ne="",Ne="",Ye=ke;try{let Xe=await(await Promise.resolve().then(()=>(cr(),xs))).showArticleLinkPrompt({title:"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E \u0438 \u0437\u0430\u0434\u0430\u0439\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438.",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:ce,defaultTextValue:ke,lockTextValue:Te});if(Xe&&typeof Xe=="object")ne=Xe.articleValue||"",Ne=Xe.selectedId||"",Ye=Xe.textValue||"";else return}catch{ne=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438")||"",Ye=ke||window.prompt("\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)")||""}let Qe=(ne||"").trim().toLowerCase();if(!Qe&&!Ne)return;let ct=(Array.isArray(Y)?Y:[]).find(dt=>{let Xe=(dt.title||"").toLowerCase();return Ne&&dt.id===Ne||dt.id&&dt.id.toLowerCase()===Qe||Xe===Qe||Xe.includes(Qe)});if(!ct){ve("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}let rt=(Ye||"").trim()||ct.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";q(dn.article(ct.id),rt,{class:"article-link"})},Q=()=>{if(!u.isOutlineEditing||!e||e.isDestroyed)return;let Y=A();if(t.dataset.editing=Y?"true":"false",n===null?n=Y:n!==Y&&(m(),n=Y),r.deleteBtn&&(r.deleteBtn.hidden=Y),r.moveUpBtn&&(r.moveUpBtn.hidden=Y),r.moveDownBtn&&(r.moveDownBtn.hidden=Y),r.outdentBtn&&(r.outdentBtn.hidden=Y),r.indentBtn&&(r.indentBtn.hidden=Y),r.newBelowBtn&&(r.newBelowBtn.hidden=Y),r.blocksMenuBtn&&(r.blocksMenuBtn.hidden=Y),r.attachBtn&&(r.attachBtn.hidden=!Y),Y&&nr&&so(!1),r.undo&&(r.undo.disabled=!y(me=>me.undo())),r.redo&&(r.redo.disabled=!y(me=>me.redo())),r.textMenuBtn){let me=e.isActive("bold")||e.isActive("italic")||e.isActive("strike")||e.isActive("codeBlock")||e.isActive("blockquote");d(r.textMenuBtn,me),r.textMenuBtn.hidden=!Y}if(r.listsMenuBtn){let me=e.isActive("bulletList")||e.isActive("orderedList");d(r.listsMenuBtn,me),r.listsMenuBtn.hidden=!Y}if(r.tableMenuBtn){let me=e.isActive("table");d(r.tableMenuBtn,me),r.tableMenuBtn.hidden=!Y}if(r.calloutMenuBtn){let me=e.isActive("callout");d(r.calloutMenuBtn,me),r.calloutMenuBtn.hidden=!Y}let ce=null,pe=()=>{if(ce)return ce;let me={total:0,collapsed:0};try{e.state.doc.descendants(fe=>{fe?.type?.name==="outlineSection"&&(me.total+=1,fe.attrs?.collapsed&&(me.collapsed+=1))})}catch{}return ce=me,me};for(let me of a){let fe=me.dataset.outlineAction||"";if(!fe)continue;let ke=!1,Te=!1;if(fe==="collapseAllBlocks"){let ne=pe();ke=!1,Te=ne.total===0||ne.collapsed>=ne.total}else if(fe==="expandAllBlocks"){let ne=pe();ke=!1,Te=ne.total===0||ne.collapsed<=0}else if(fe==="toggleBold")ke=e.isActive("bold"),Te=!y(ne=>ne.toggleBold());else if(fe==="toggleItalic")ke=e.isActive("italic"),Te=!y(ne=>ne.toggleItalic());else if(fe==="toggleStrike")ke=e.isActive("strike"),Te=!y(ne=>ne.toggleStrike());else if(fe==="toggleCodeBlock")ke=e.isActive("codeBlock"),Te=!A();else if(fe==="toggleBlockquote")ke=e.isActive("blockquote"),Te=!y(ne=>ne.toggleBlockquote());else if(fe.startsWith("setTextBg:"))ke=!1,Te=!A()||!y(ne=>ne.setTextBg(fe.slice(10)));else if(fe==="clearTextBg")ke=!1,Te=!A()||!y(ne=>ne.clearTextBg());else if(fe.startsWith("setCallout:")){let ne=fe.split(":")[1]||"";ke=e.isActive("callout",{kind:ne}),Te=!A()||!y(Ne=>Ne.setCallout(ne))}else fe==="unsetCallout"?(ke=!1,Te=!A()||!e.isActive("callout")||!y(ne=>ne.unsetCallout())):fe==="insertHttpLink"||fe==="insertArticleLink"?(ke=!1,Te=!A()):fe==="unsetLink"?(ke=e.isActive("link"),Te=!y(ne=>ne.unsetLink())):fe==="toggleBulletList"?(ke=e.isActive("bulletList"),e.isActive("orderedList")?Te=!(y(ne=>ne.toggleOrderedList())&&y(ne=>ne.toggleBulletList())):Te=!y(ne=>ne.toggleBulletList())):fe==="toggleOrderedList"?(ke=e.isActive("orderedList"),e.isActive("bulletList")?Te=!(y(ne=>ne.toggleBulletList())&&y(ne=>ne.toggleOrderedList())):Te=!y(ne=>ne.toggleOrderedList())):fe==="unsetList"?(ke=!1,e.isActive("bulletList")?Te=!y(ne=>ne.toggleBulletList()):e.isActive("orderedList")?Te=!y(ne=>ne.toggleOrderedList()):Te=!y(ne=>ne.liftListItem("listItem"))):fe==="insertTable"?(ke=!1,Te=!y(ne=>ne.insertTable({rows:2,cols:2,withHeaderRow:!1}))):fe==="toggleHeaderRow"?(ke=e.isActive("tableHeader"),Te=!y(ne=>ne.toggleHeaderRow())):fe==="toggleHeaderColumn"?(ke=e.isActive("tableHeader"),Te=!y(ne=>ne.toggleHeaderColumn())):fe==="addRowBefore"?(ke=!1,Te=!y(ne=>ne.addRowBefore())):fe==="addRowAfter"?(ke=!1,Te=!y(ne=>ne.addRowAfter())):fe==="deleteRow"?(ke=!1,Te=!y(ne=>ne.deleteRow())):fe==="addColumnBefore"?(ke=!1,Te=!y(ne=>ne.addColumnBefore())):fe==="addColumnAfter"?(ke=!1,Te=!y(ne=>ne.addColumnAfter())):fe==="deleteColumn"?(ke=!1,Te=!y(ne=>ne.deleteColumn())):fe==="copyColumn"||fe==="pasteColumnAfter"||fe==="moveColumnRight"?(ke=!1,Te=!0):fe==="mergeCells"?(ke=!1,Te=!y(ne=>ne.mergeCells())):fe==="splitCell"?(ke=!1,Te=!y(ne=>ne.splitCell())):fe==="cancelTable"?(ke=!1,Te=!A()||!e.isActive("table")):fe==="deleteTable"&&(ke=!1,Te=!y(ne=>ne.deleteTable()));me.disabled=!!Te,me.classList.toggle("is-active",!!ke)}},oe=null,we=()=>{oe||(oe=window.requestAnimationFrame(()=>{oe=null,Q()}))},Pe=[l(r.undo,()=>e.chain().focus().undo().run()),l(r.redo,()=>e.chain().focus().redo().run()),l(r.attachBtn,()=>{if(!I())return;let Y=r.attachInput;if(!Y){ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0432\u044B\u0431\u043E\u0440 \u0444\u0430\u0439\u043B\u0430");return}try{Y.value=""}catch{}try{if(typeof Y.showPicker=="function"){Y.showPicker();return}}catch{}Y.click()})];try{let Y=r.attachInput;Y&&!Y.__ttreeOutlineAttachBound&&(Object.defineProperty(Y,"__ttreeOutlineAttachBound",{value:!0}),Y.addEventListener("change",()=>{if(!I())return;let ce=Array.from(Y.files||[]);if(ce.length){for(let pe of ce)if(pe)try{Ma(pe)?zd(e.view,pe):Ud(e.view,pe)}catch{}}},{passive:!0}))}catch{}let te=Je?.pmStateMod?.TextSelection||null,Se=(Y,ce)=>{try{let pe=Y.resolve(Math.min(Y.content.size,ce+1)),me=null;for(let fe=pe.depth;fe>0;fe-=1){if(pe.node(fe)?.type?.name!=="outlineSection")continue;if(pe.before(fe)===ce){me=fe;break}}if(me===null)return null;for(let fe=me-1;fe>0;fe-=1)if(pe.node(fe)?.type?.name==="outlineSection")return pe.before(fe);return null}catch{return null}},tt=Y=>{try{if(!te)return;e.commands.command(({state:ce,dispatch:pe})=>{let me=Mt(ce.doc,ce.selection.$from);if(typeof me!="number")return!1;let fe=ce.doc.resolve(me),ke=fe.index(),Te=fe.parent;if(!Te)return!1;let ne=ce.doc.nodeAt(me);if(!ne)return!1;if(Y==="up"){if(ke>0){let Ce=Te.child(ke-1),Ge=me-Ce.nodeSize,S=ce.tr.delete(me,me+ne.nodeSize).insert(Ge,ne);return S=S.setMeta(ue,!0),S=S.setSelection(te.near(S.doc.resolve(Ge+2),1)),pe(S.scrollIntoView()),!0}let Ne=Se(ce.doc,me);if(typeof Ne!="number")return!1;let Ye=ce.doc.resolve(Ne),Qe=Ye.index(),ct=Ye.parent;if(!ct||Qe<=0)return!1;let rt=ct.child(Qe-1),dt=Ne-rt.nodeSize,Xe=ce.doc.nodeAt(dt);if(!Xe||Xe.type?.name!=="outlineSection")return!1;let mt=Xe.child(0),ft=Xe.child(1),lt=Xe.child(2),de=dt+1+mt.nodeSize+ft.nodeSize+lt.nodeSize-1,ye=ce.tr.delete(me,me+ne.nodeSize).setMeta(ue,!0),Ve=ye.mapping.map(dt,-1),Re=ye.mapping.map(de,-1);ye=ye.insert(Re,ne);let _e=ye.doc.nodeAt(Ve);return _e?.type?.name==="outlineSection"&&_e.attrs?.collapsed&&(ye=ye.setNodeMarkup(Ve,void 0,{..._e.attrs,collapsed:!1})),ye=ye.setSelection(te.near(ye.doc.resolve(Re+2),1)),pe(ye.scrollIntoView()),!0}if(Y==="down"){if(ke<Te.childCount-1){let Ce=me+ne.nodeSize,Ge=ce.doc.nodeAt(Ce);if(!Ge)return!1;let S=ce.tr.delete(me,me+ne.nodeSize),g=me+Ge.nodeSize;return S=S.insert(g,ne),S=S.setMeta(ue,!0),S=S.setSelection(te.near(S.doc.resolve(g+2),1)),pe(S.scrollIntoView()),!0}let Ne=Se(ce.doc,me);if(typeof Ne!="number")return!1;let Ye=ce.doc.nodeAt(Ne);if(!Ye||Ye.type?.name!=="outlineSection")return!1;let Qe=ce.doc.resolve(Ne),ct=Qe.index(),rt=Qe.parent;if(!rt||ct>=rt.childCount-1)return!1;let dt=Ne+Ye.nodeSize,Xe=ce.doc.nodeAt(dt);if(!Xe||Xe.type?.name!=="outlineSection")return!1;let mt=Xe.child(0),ft=Xe.child(1),lt=Xe.child(2),de=dt+1+mt.nodeSize+ft.nodeSize+1,ye=ce.tr.delete(me,me+ne.nodeSize).setMeta(ue,!0),Ve=ye.mapping.map(dt,-1),Re=ye.mapping.map(de,-1);ye=ye.insert(Re,ne);let _e=ye.doc.nodeAt(Ve);return _e?.type?.name==="outlineSection"&&_e.attrs?.collapsed&&(ye=ye.setNodeMarkup(Ve,void 0,{..._e.attrs,collapsed:!1})),ye=ye.setSelection(te.near(ye.doc.resolve(Re+2),1)),pe(ye.scrollIntoView()),!0}return!1})}catch{}},Lt=()=>{try{if(!te)return;e.commands.command(({state:Y,dispatch:ce})=>{let pe=Mt(Y.doc,Y.selection.$from);if(typeof pe!="number")return!1;let me=Y.doc.resolve(pe),fe=0;for(let ee=me.depth;ee>=0;ee-=1)me.node(ee)?.type?.name==="outlineSection"&&(fe+=1);if(fe>=6)return!1;let ke=me.index(),Te=me.parent;if(!Te||ke<=0)return!1;let ne=Y.doc.nodeAt(pe);if(!ne)return!1;let Ne=Te.child(ke-1),Ye=pe-Ne.nodeSize,Qe=Y.doc.nodeAt(Ye);if(!Qe)return!1;let ct=Qe.child(0),rt=Qe.child(1),dt=Qe.child(2),mt=Ye+1+ct.nodeSize+rt.nodeSize+dt.nodeSize-1,ft=Y.tr.delete(pe,pe+ne.nodeSize).insert(mt,ne),lt=ft.doc.nodeAt(Ye);return lt?.type?.name==="outlineSection"&&lt.attrs?.collapsed&&(ft=ft.setNodeMarkup(Ye,void 0,{...lt.attrs,collapsed:!1})),ft=ft.setMeta(ue,!0),ft=ft.setSelection(te.near(ft.doc.resolve(mt+2),1)),ce(ft.scrollIntoView()),!0})}catch{}},_t=()=>{try{if(!te)return;e.commands.command(({state:Y,dispatch:ce})=>{let pe=Y.selection.$from,me=null,fe=null;for(let ct=pe.depth;ct>0;ct-=1)if(pe.node(ct)?.type?.name==="outlineSection")if(me===null)me=ct;else{fe=ct;break}if(me===null||fe===null)return!1;let ke=pe.before(me),Te=pe.before(fe),ne=Y.doc.nodeAt(ke);if(!ne)return!1;let Ne=Y.tr.delete(ke,ke+ne.nodeSize),Ye=Ne.doc.nodeAt(Te);if(!Ye)return!1;let Qe=Te+Ye.nodeSize;return Ne=Ne.insert(Qe,ne),Ne=Ne.setMeta(ue,!0),Ne=Ne.setSelection(te.near(Ne.doc.resolve(Qe+2),1)),ce(Ne.scrollIntoView()),!0})}catch{}},fn=()=>{try{if(!te)return;e.commands.command(({state:Y,dispatch:ce})=>{let pe=Mt(Y.doc,Y.selection.$from);if(typeof pe!="number")return!1;let me=Y.doc.nodeAt(pe);if(!me)return!1;let fe=String(me.attrs?.id||"").trim(),ke=Y.doc.resolve(pe),Te=ke.index(),ne=ke.parent;if(!ne)return!1;let Ne=Y.doc.type.schema;if(ne.childCount<=1){let mt=Ne.nodes.outlineSection.create({...me.attrs,collapsed:!1},[Ne.nodes.outlineHeading.create({},[]),Ne.nodes.outlineBody.create({},[Ne.nodes.paragraph.create({},[])]),Ne.nodes.outlineChildren.create({},[])]),ft=Y.tr.replaceWith(pe,pe+me.nodeSize,mt);ft=ft.setMeta(ue,!0);let lt=mt.child(0),ee=pe+1+lt.nodeSize;return ft=ft.setSelection(te.near(ft.doc.resolve(ee+2),1)),ce(ft.scrollIntoView()),!0}fe&&ro(fe);let Ye=Te>0,Qe=Ye?ne.child(Te-1):null,ct=Ye?pe-Qe.nodeSize:null,rt=Y.tr.delete(pe,pe+me.nodeSize);rt=rt.setMeta(ue,!0);let dt=Ye&&typeof ct=="number"?ct:Math.min(rt.doc.content.size,pe),Xe=rt.doc.nodeAt(dt);if(Xe?.type?.name==="outlineSection"){let mt=Xe.child(0),ft=Xe.child(1),lt=dt+1+mt.nodeSize;ft.childCount||(rt=rt.insert(lt+1,Ne.nodes.paragraph.create({},[]))),rt=rt.setSelection(te.near(rt.doc.resolve(lt+2),1))}return ce(rt.scrollIntoView()),!0})}catch{}},Sn=()=>{try{if(!te)return;e.commands.command(({state:Y,dispatch:ce})=>{let pe=Mt(Y.doc,Y.selection.$from);if(typeof pe!="number")return!1;let me=Y.doc.nodeAt(pe);if(!me)return!1;let fe=Y.doc.type.schema,ke=pe+me.nodeSize,Te=en(),ne=fe.nodes.outlineSection.create({id:Te,collapsed:!1},[fe.nodes.outlineHeading.create({},[]),fe.nodes.outlineBody.create({},[fe.nodes.paragraph.create({},[])]),fe.nodes.outlineChildren.create({},[])]),Ne=Y.tr.insert(ke,ne);return Ne=Ne.setSelection(te.create(Ne.doc,ke+2)),Ne=Ne.setMeta(ue,!0),Ee&&(Ne=Ne.setMeta(Ee,{type:"enter",sectionId:Te})),ce(Ne.scrollIntoView()),!0})}catch{}};Pe.push(l(r.deleteBtn,()=>fn())),Pe.push(l(r.moveUpBtn,()=>tt("up"))),Pe.push(l(r.moveDownBtn,()=>tt("down"))),Pe.push(l(r.outdentBtn,()=>_t())),Pe.push(l(r.indentBtn,()=>Lt())),Pe.push(l(r.newBelowBtn,()=>Sn()));let vn=0,On=Y=>{try{return Y?.target&&Y.target.nodeType===1?Y.target:Y?.target?.parentElement||null}catch{return null}},Vn=Y=>{let ce=On(Y);if(!ce)return null;let pe=ce.closest?.(".outline-toolbar__dropdown-btn")||null;return!pe||!t.contains(pe)?null:pe},jn=(Y,{source:ce})=>{try{let pe=Date.now();if(vn&&pe-vn<700){p("toggle.skip.dedupe",{source:ce,dtMs:pe-vn});return}let me=Vn(Y);if(!me){p("toggle.skip.no-btn",{source:ce,targetClass:String(On(Y)?.className||"")});return}if(me.disabled){p("toggle.skip.disabled",{source:ce,btnId:me.id||null});return}Y?.cancelable&&Y.preventDefault(),Y.stopPropagation();let fe=b(me);p("toggle",{source:ce,ok:fe,btnId:me.id||null,menuId:me.getAttribute("aria-controls")||null,expanded:me.getAttribute("aria-expanded")||null}),fe&&(vn=pe)}catch(pe){p("toggle.error",{source:ce,message:String(pe?.message||pe||"")})}},Rn=Y=>{try{let ce=String(Y?.pointerType||"");if(ce!=="touch"&&ce!=="pen")return}catch{return}jn(Y,{source:"pointerdown"})},Hn=Y=>{jn(Y,{source:"click"})};try{t.addEventListener("pointerdown",Rn,!0),Pe.push(()=>t.removeEventListener("pointerdown",Rn,!0))}catch{}t.addEventListener("click",Hn,!0),Pe.push(()=>t.removeEventListener("click",Hn,!0));let zt=Y=>{try{if(!u.isOutlineEditing)return;t.contains(Y.target)||m()}catch{}},Yt=Y=>{try{if(!u.isOutlineEditing)return;t.contains(Y.target)||m()}catch{}};try{document.addEventListener("touchstart",zt,{passive:!0}),Pe.push(()=>document.removeEventListener("touchstart",zt))}catch{}document.addEventListener("click",Yt),Pe.push(()=>document.removeEventListener("click",Yt));for(let Y of a)Pe.push(l(Y,()=>{let ce=Y.dataset.outlineAction||"";if(ce==="insertHttpLink"){m(),z().finally(()=>we());return}if(ce==="insertArticleLink"){m(),X().finally(()=>we());return}let pe=x(ce);m(),pe&&we()}));for(let Y of c)Pe.push(l(Y,()=>{let ce=Y.getAttribute("data-outline-clipboard-action")||"";if(!ce)return;m();let pe=bn||null,me=wr instanceof Set?wr:new Set,fe=me.size?new Set(me):pe?new Set([pe]):new Set;if(ce==="toggleSelectMode"){so(!nr);return}if(ce==="clear"){$i(null),ve("\u0411\u0443\u0444\u0435\u0440 \u043E\u0447\u0438\u0449\u0435\u043D");return}if(ie){if(ce==="copy"||ce==="cut"){if(!fe.size){ve("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A");return}let ke=dm(ie.state.doc,fe);if(!ke.length){ve("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A");return}let Te=ke.map(Ye=>Ye.node.toJSON());try{let Ye=ke.map(Qe=>jd(Qe.node)).filter(Boolean).join(`

`);um(Ye)}catch{}if($i({mode:ce==="cut"?"cut":"copy",sourceArticleId:wt||u.articleId||null,createdAt:new Date().toISOString(),sections:Te}),ce==="copy"){ve(`\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${Te.length}`);return}let ne=[];for(let Ye of ke){let Qe=St(ie.state.doc,Ye.id),ct=typeof Qe=="number"?ie.state.doc.nodeAt(Qe):null;typeof Qe=="number"&&ct&&ne.push({pos:Qe,size:ct.nodeSize})}ne.sort((Ye,Qe)=>Qe.pos-Ye.pos);let Ne=ie.state.tr;for(let{pos:Ye,size:Qe}of ne)Ne=Ne.delete(Ye,Ye+Qe);Ne=Ne.setMeta(ue,!0),ie.view.dispatch(Ne.scrollIntoView()),ie.view.focus(),on=!0,rn({delayMs:200}),so(!1),ve(`\u0412\u044B\u0440\u0435\u0437\u0430\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${Te.length}`);return}if(ce==="paste"){let ke=La();if(!ke||!Array.isArray(ke.sections)||!ke.sections.length){ve("\u0411\u0443\u0444\u0435\u0440 \u043F\u0443\u0441\u0442");return}let Te=ie.state,ne=Te.doc.content.size;if(pe){let Xe=St(Te.doc,pe),mt=typeof Xe=="number"?Te.doc.nodeAt(Xe):null;typeof Xe=="number"&&mt&&(ne=Xe+mt.nodeSize)}let Ne=new Set;try{Te.doc.descendants(Xe=>{if(Xe?.type?.name!=="outlineSection")return;let mt=String(Xe.attrs?.id||"").trim();mt&&Ne.add(mt)})}catch{}let Ye=[];if(ke.mode==="copy")for(let Xe of ke.sections)Ye.push(Vd(Xe,()=>en()));else for(let Xe of ke.sections){let mt=String(Xe?.attrs?.id||"").trim();if(mt&&Ne.has(mt)){ve("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C: \u0431\u043B\u043E\u043A \u0441 \u0442\u0430\u043A\u0438\u043C id \u0443\u0436\u0435 \u0435\u0441\u0442\u044C");return}Ye.push(Ha(Xe))}let Qe=Te.doc.type.schema,ct=[];for(let Xe of Ye)try{let mt=Qe.nodeFromJSON(Xe);mt?.type?.name==="outlineSection"&&ct.push(mt)}catch{}if(!ct.length){ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438");return}let rt=Te.tr,dt=ne;for(let Xe of ct)rt=rt.insert(dt,Xe),dt+=Xe.nodeSize;rt=rt.setMeta(ue,!0),ie.view.dispatch(rt.scrollIntoView()),ie.view.focus(),on=!0,rn({delayMs:200}),ke.mode==="cut"&&$i(null),so(!1),ve(`\u0412\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${ct.length}`)}}}));let Tt=Y=>{u.isOutlineEditing&&(t.contains(Y.target)||m())},At=Y=>{u.isOutlineEditing&&Y.key==="Escape"&&m()};document.addEventListener("pointerdown",Tt),document.addEventListener("keydown",At),Pe.push(()=>document.removeEventListener("pointerdown",Tt)),Pe.push(()=>document.removeEventListener("keydown",At));let Dt=e.on("transaction",we),Tn=e.on("selectionUpdate",we);Pe.push(()=>Dt?.()),Pe.push(()=>Tn?.());try{let Y=wm({setActiveTagKey:ce=>{try{ji?.(ce)}catch{}}});Pe.push(()=>Y?.())}catch{}we(),Ri=()=>{oe&&(window.cancelAnimationFrame(oe),oe=null);for(let Y of Pe)try{Y()}catch{}}}function Hm(){if(Ri)try{Ri()}catch{}Ri=null}function rr(e=""){let t=String(e||"");u.outlineStatusText=t,V.updatedAt&&u.isOutlineEditing&&(V.updatedAt.textContent=t)}function $m(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=r.child(1),s=t+1+o.nodeSize,a=n.tr;if(!i.childCount){let l=n.doc.type.schema;a=a.insert(s+1,l.nodes.paragraph.create({},[]))}let{TextSelection:c}=Je?.pmStateMod||{};return c?(a=a.setSelection(c.near(a.doc.resolve(s+2),1)),e.view.dispatch(a.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0):!1}catch{return!1}}function Fm(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=t+1,{TextSelection:s}=Je?.pmStateMod||{};if(!s)return!1;let a=i+1,c=i+o.nodeSize-1,l=Math.min(Math.max(a,a),Math.max(a,c)),d=n.tr.setSelection(s.near(n.doc.resolve(l),1));return d=d.setMeta(ue,!0),e.view.dispatch(d.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0}catch{return!1}}function zm(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=t+1,{TextSelection:s}=Je?.pmStateMod||{};if(!s)return!1;let a=i+1,c=i+o.nodeSize-1,l=Math.max(a,c),d=n.tr.setSelection(s.near(n.doc.resolve(l),-1));return d=d.setMeta(ue,!0),e.view.dispatch(d.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0}catch{return!1}}function Um(e,t){try{if(!e)return!1;let n=String(t||"").trim();if(!n)return!1;let r=e.state,o=St(r.doc,n);if(typeof o!="number")return!1;let i=r.doc.nodeAt(o);if(!i||i.type?.name!=="outlineSection")return!1;if(i.attrs?.collapsed)return Fm(e,o);try{if(!i.child(1)?.childCount)return zm(e,o)}catch{}return $m(e,o)}catch{return!1}}function qm(e,t,{block:n="center"}={}){try{let r=String(t||"").trim();if(!e||!r)return!1;let o=e.view;if(!o?.dom?.querySelector)return!1;let i=typeof CSS<"u"&&CSS.escape?CSS.escape(r):r.replace(/"/g,'\\"'),s=()=>{try{let a=o.dom?.querySelector?.(`[data-outline-section][data-section-id="${i}"]`)||o.dom?.querySelector?.(`[data-section-id="${i}"]`);a&&typeof a.scrollIntoView=="function"&&a.scrollIntoView({block:n||"center",inline:"nearest"})}catch{}};try{window.requestAnimationFrame(s)}catch{}try{setTimeout(s,80)}catch{}return!0}catch{return!1}}async function Km(){if(Je)return Je;if(typeof window>"u")throw new Error("Outline editor is browser-only");let e=Nr()?performance.now():0,t=await import("/outline/tiptap.bundle.js");return e&&io("import tiptap.bundle.js",{ms:Math.round(performance.now()-e)}),Je={core:t.core,starterKitMod:t.starterKitMod,htmlMod:t.htmlMod,pmStateMod:t.pmStateMod,pmViewMod:t.pmViewMod,pmTablesMod:t.pmTablesMod,linkMod:t.linkMod,imageMod:t.imageMod,mentionMod:t.mentionMod,tableMod:t.tableMod,tableRowMod:t.tableRowMod,tableCellMod:t.tableCellMod,tableHeaderMod:t.tableHeaderMod,uniqueIdMod:t.uniqueIdMod,markdownMod:t.markdownMod},Je}function Vm({blocks:e,parseHtmlToNodes:t}){let n=i=>Array.isArray(i)&&i.length>0?i:[{type:"paragraph",content:[]}],r=i=>{let s=String(i?.id||en()),a=!!i?.collapsed,c=Gn(String(i?.text||"")),l=Da(c.titleHtml)||"",d=n(t(c.bodyHtml||"")),m=Array.isArray(i?.children)?i.children:[];return{type:"outlineSection",attrs:{id:s,collapsed:a},content:[{type:"outlineHeading",content:l?[{type:"text",text:l}]:[]},{type:"outlineBody",content:d},{type:"outlineChildren",content:m.map(r)}]}},o=(Array.isArray(e)?e:[]).map(r);return{type:"doc",content:o.length?o:[r({id:en(),text:"",collapsed:!1,children:[]})]}}function jm(e){try{let t=String(e||"").trim();if(!t)return null;let n=window?.localStorage?.getItem?.("ttree_outline_last_active_v1")||"{}",r=JSON.parse(n||"{}"),o=r&&typeof r=="object"?r[t]:null;if(!o||typeof o!="object")return null;let i=String(o.sectionId||"").trim();return i?{sectionId:i,collapsed:!!o.collapsed}:null}catch{return null}}function iu(e,t,n){try{let r=String(e||"").trim(),o=String(t||"").trim();if(!r||!o)return!1;let i=window?.localStorage?.getItem?.("ttree_outline_last_active_v1")||"{}",s=JSON.parse(i||"{}"),a=s&&typeof s=="object"?s:{};return a[r]={sectionId:o,collapsed:!!n,savedAt:new Date().toISOString()},window?.localStorage?.setItem?.("ttree_outline_last_active_v1",JSON.stringify(a)),!0}catch{return!1}}function _d(e){try{let t=wt||u.articleId||null;if(!t||!e||e.isDestroyed)return!1;let n=e.state,r=Mt(n.doc,n.selection.$from);if(typeof r!="number")return!1;let o=n.doc.nodeAt(r);if(!o||o.type?.name!=="outlineSection")return!1;let i=String(o.attrs?.id||"").trim();if(!i)return!1;let s=!!o.attrs?.collapsed;return _i.articleId===t&&_i.sectionId===i&&_i.collapsed===s?!1:(_i={articleId:t,sectionId:i,collapsed:s},iu(t,i,s))}catch{return!1}}function Jm(e,{lines:t=4}={}){try{if(!e||e.isDestroyed)return!1;let n=e.view;if(!n||!n.state||!n.dom)return!1;let r=n.state.selection;return!r||typeof r.from!="number"?!1:(Di&&cancelAnimationFrame(Di),Di=requestAnimationFrame(()=>{Di=null;try{let o=n.coordsAtPos(r.from);if(!o||typeof o.bottom!="number")return;let s=(y=>{try{let x=y;for(;x&&x!==document.body&&x!==document.documentElement;){let A=window.getComputedStyle(x),I=String(A.overflowY||"");if((I==="auto"||I==="scroll"||I==="overlay")&&x.scrollHeight>x.clientHeight+2)return x;x=x.parentElement}}catch{}return document.scrollingElement||document.documentElement})(n.dom),a=window.getComputedStyle(n.dom),c=String(a.lineHeight||"").trim(),l=c==="normal"?20:Number.parseFloat(c)||20,d=Math.max(24,l*Math.max(1,Number(t)||4)+12),m=window.innerHeight||0,h=0;if(s&&s!==document.scrollingElement&&s!==document.documentElement&&s!==document.body){let y=s.getBoundingClientRect();h=y.top,m=y.height}if(!m)return;let b=o.bottom-h,w=m-d;if(b<=w)return;let f=b-w,p=Math.max(0,(s.scrollTop||0)+f);s.scrollTop=p}catch{}}),!0)}catch{return!1}}function Mt(e,t){try{if(t?.nodeAfter?.type?.name==="outlineSection")return t.pos}catch{}for(let n=t.depth;n>0;n-=1)if(t.node(n)?.type?.name==="outlineSection")return t.before(n);return null}function Gi(e){if(!e)return"";let t=e.child(0),n=e.child(1),r=tr(t?.textContent||""),o="";try{o=tr(n?.textBetween?.(0,n.content.size,`
`,`
`)||"")}catch{o=tr(n?.textContent||"")}return tr(`${r}
${o}`)}function Dd(e){if(!e)return"";let t=e.child(1),n="";try{n=tr(t?.textBetween?.(0,t.content.size,`
`,`
`)||"")}catch{n=tr(t?.textContent||"")}return n}function Od(e){if(!Ta||!Ba)return"";let t=[];return e?.content?.forEach?.(o=>{t.push(o.toJSON())}),(Ta({type:"doc",content:t},Ba)||""||"").trim()}function Rd(e){try{return tr(String(e?.textContent||"").replace(/\u00a0/g," ")).trim()}catch{return""}}function Wm(e){try{let t=document.createElement("template");return t.innerHTML=String(e||""),tr(String(t.content.textContent||"").replace(/\u00a0/g," ")).trim()}catch{return""}}function su(e){try{if(!e)return null;let t=e.state?.selection||null;if(!t)return null;let n=Number.isFinite(t.anchor)?t.anchor:t.from,r=Number.isFinite(t.head)?t.head:t.to,o=t.$from||null,i=null;try{let s=o?Mt(e.state.doc,o):null;if(typeof s=="number"){let a=e.state.doc.nodeAt(s);i=String(a?.attrs?.id||"")||null}}catch{i=null}return!Number.isFinite(n)||!Number.isFinite(r)?null:{anchor:n,head:r,sectionId:i}}catch{return null}}function au(e,t,n){try{if(!e?.view||!t)return!1;let{TextSelection:r}=Je?.pmStateMod||{};if(!r||!n)return e.view.dispatch(t),!0;let o=t.doc?.content?.size??null;if(!Number.isFinite(o))return e.view.dispatch(t),!0;let i=t.mapping.map(Math.max(0,Math.min(n.anchor,o)),1),s=t.mapping.map(Math.max(0,Math.min(n.head,o)),1);try{t=t.setSelection(r.create(t.doc,i,s))}catch{}return e.view.dispatch(t),!0}catch{try{return e?.view?.dispatch?.(t),!0}catch{return!1}}}function Ym(e,t,n,r={}){if(!e||!t)return!1;let o=St(e.state.doc,t);if(typeof o!="number")return!1;let i=e.state.doc.nodeAt(o);if(!i)return!1;let s=e.state.schema,a=i.child(0),c=o+1,l=String(n||"").replace(/\u00a0/g," ").trim(),d=s.nodes.outlineHeading.create({},l?[s.text(l)]:[]),m=e.state.tr.replaceWith(c,c+a.nodeSize,d).setMeta(ue,!0),h=r?.preserveSelection?su(e):null;return au(e,m,h),!0}function Gm(e,t,n,r={}){if(!e||!t||!Fo)return!1;let o=St(e.state.doc,t);if(typeof o!="number")return!1;let i=e.state.doc.nodeAt(o);if(!i)return!1;let s=i.child(0),a=i.child(1),c=o+1+s.nodeSize,l=e.state.schema,d=[];try{d=Fo(n||"")}catch{d=[]}let m=[];try{m=(Array.isArray(d)?d:[]).map(f=>l.nodeFromJSON(f))}catch{m=[l.nodes.paragraph.create({},[])]}m.length||(m=[l.nodes.paragraph.create({},[])]);let h=l.nodes.outlineBody.create({},m),b=e.state.tr.replaceWith(c,c+a.nodeSize,h).setMeta(ue,!0),w=r?.preserveSelection?su(e):null;return au(e,b,w),!0}function Ra(e){if(!e)return!0;let t=e.child(0);return!tr(t?.textContent||"")}function Xm(e,t,n){if(!e||!t)return!1;let r=St(e.state.doc,t);if(typeof r!="number")return!1;let o=e.state.doc.nodeAt(r);if(!o||!Ra(o))return!1;let i=o.child(0),s=r+1,a=s+1,c=s+i.nodeSize-1,l=String(n||"").trim();if(!l)return!1;let d=l.length>200?l.slice(0,200):l,m=e.state.tr.insertText(d,a,c).setMeta(ue,!0);return e.view.dispatch(m),!0}function Qm(e){Or.clear(),e.descendants(t=>{if(t?.type?.name!=="outlineSection")return;let n=String(t.attrs?.id||"");n&&Or.set(n,Gi(t))})}function St(e,t){let n=null;return e.descendants((r,o)=>{if(n!==null)return!1;r?.type?.name==="outlineSection"&&String(r.attrs?.id||"")===String(t||"")&&(n=o)}),n}function Zm(e,t){try{let n=e.doc,r=St(n,t),o=typeof r=="number"?n.nodeAt(r):null;if(!o)return null;let i=e.schema,s=i.marks?.code||null,a=i.nodes?.codeBlock||null;if(!s||!a)return null;let c=o.child(0),l=o.child(1);if(!c||!l)return null;let m=r+1+c.nodeSize+1,h=[];if(l.descendants((w,f)=>{if(!w||w.type?.name!=="paragraph")return;let p=!1,y=!1,x=!0;for(let N=0;N<w.childCount;N+=1){let $=w.child(N);if($){if($.type?.name==="hardBreak"){y=!0;continue}if($.isText){if(!String($.text||""))continue;if(!(Array.isArray($.marks)?$.marks:[]).some(Q=>Q?.type===s)){x=!1;break}p=!0;continue}x=!1;break}}if(!x||!p||!y)return;let A="";for(let N=0;N<w.childCount;N+=1){let $=w.child(N);if($){if($.type?.name==="hardBreak"){A+=`
`;continue}$.isText&&(A+=String($.text||""))}}if(!A.trim())return;let I=m+f;h.push({from:I,to:I+w.nodeSize,text:A})}),!h.length)return null;let b=e.tr;for(let w=h.length-1;w>=0;w-=1){let{from:f,to:p,text:y}=h[w],x=b.doc.resolve(f),A=x.parent,I=x.index();if(!A?.canReplaceWith?.(I,I+1,a))continue;let N=i.text(y),$=a.create(null,N);b=b.replaceWith(f,p,$)}return b.docChanged?b.setMeta(ue,!0):null}catch{return null}}function cu(e,t,n){if(!e||!t||!n||u.article?.encrypted)return;let r=St(t,n),o=typeof r=="number"?t.nodeAt(r):null;if(!o||!Ra(o))return;let i=Dd(o);if(!i)return;let s=Oa(i),a=Aa.get(n)||null;a?.inFlight||a?.bodyHash!==s&&(Aa.set(n,{bodyHash:s,inFlight:!0}),Nc(i).then(c=>{let l=String(c?.title||"").trim();if(!l||l.length>200)return;let d=e.state.doc,m=St(d,n),h=typeof m=="number"?d.nodeAt(m):null;if(!h||!Ra(h))return;let b=Dd(h);if(!(Oa(b)!==s||!Xm(e,n,l))){on=!0;try{let f=wt||u.articleId||null;f&&($a({articleId:f,doc:e.state.doc,sectionId:n,reason:"generate_title"}),rr("\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438 \u043D\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044E"))}catch{}rn({delayMs:900})}}).catch(()=>{}).finally(()=>{Aa.set(n,{bodyHash:s,inFlight:!1})}))}function eh(e,t,n){if(!(!e||!t)&&!(!Array.isArray(n)||!n.length)&&!u.article?.encrypted&&!(typeof navigator<"u"&&navigator&&navigator.onLine===!1)){try{if((Ee?.getState?.(e.state)||null)?.editingSectionId)return}catch{}for(let r of n)try{cu(e,t,r)}catch{}}}function Hd(e,t,n){let r=String(n||"").trim(),o=($,q={})=>Kt("skip",{reason:$,sectionId:r,...q});if(!e||!t||!r){o("missing_args",{hasEditor:!!e,hasDoc:!!t,hasSectionId:!!r});return}if(u.article?.encrypted){o("encrypted_article");return}try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1){o("offline");return}}catch{}let i=St(t,r),s=typeof i=="number"?t.nodeAt(i):null;if(!s){o("section_not_found",{pos:typeof i=="number"?i:null});return}let a=s.child(0),c=s.child(1),l=Rd(a),d=l?`<p>${$o(l)}</p>`:"",m=Od(c);if(!d&&!m){o("empty_heading_and_body");return}let h=d?no(d):"",b=m?no(m):"",w=($,q)=>{if(!q||$?.inFlight||$?.status==="ok"&&$?.htmlHash===q)return!0;if($?.status==="error"&&$?.htmlHash===q){let z=Number($?.lastAttemptAtMs||0)||0;if(Date.now()-z<rm)return!0}return!1},f=to.get(r)||null,p=eo.get(r)||null,y=w(f,h),x=w(p,b);if(y&&x){o("already_ok_or_in_flight",{headingHash:h||null,bodyHash:b||null});try{ao.delete(r)}catch{}return}let A=y,I=x,N=()=>{try{A&&I&&ao.delete(r)}catch{}};y||(Kt("start_heading",{sectionId:r,htmlHash:h}),to.set(r,{htmlHash:h,inFlight:!0,status:f?.status||"ok",lastAttemptAtMs:Date.now()}),ys(d).then($=>{if($&&$.ok===!1){Kt("unavailable_heading",{sectionId:r,reason:String($.reason||"")}),to.set(r,{htmlHash:h,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()});let tt=Date.now();tt-Pi>6e4&&(Pi=tt,ve("\u041A\u043E\u0440\u0440\u0435\u043A\u0442\u0443\u0440\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 (\u043D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0430 \u043A OpenAI)."));return}let q=String($?.html||"").trim();if(!q){Kt("skip_apply_heading",{sectionId:r,reason:"empty_corrected_html"});return}let z=Wm(q);if(!z){Kt("skip_apply_heading",{sectionId:r,reason:"empty_corrected_plain"});return}let X=e.state.doc,Q=St(X,r),oe=typeof Q=="number"?X.nodeAt(Q):null;if(!oe){Kt("skip_apply_heading",{sectionId:r,reason:"section_not_found_current_doc"});return}let we=Rd(oe.child(0)),Pe=we?`<p>${$o(we)}</p>`:"";if(no(Pe)!==h){Kt("skip_apply_heading",{sectionId:r,reason:"heading_changed_since_request"});return}if(no(`<p>${$o(z)}</p>`)===h){Kt("skip_apply_heading",{sectionId:r,reason:"no_changes_from_server"});return}if(!Ym(e,r,z,{preserveSelection:!0})){Kt("skip_apply_heading",{sectionId:r,reason:"apply_failed"});return}on=!0,rn({delayMs:900})}).catch(()=>{Kt("error_heading",{sectionId:r,htmlHash:h}),to.set(r,{htmlHash:h,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()})}).finally(()=>{(to.get(r)||null)?.status!=="error"&&to.set(r,{htmlHash:h,inFlight:!1,status:"ok",lastAttemptAtMs:Date.now()}),Kt("done_heading",{sectionId:r,htmlHash:h}),A=!0,N()})),x||(Kt("start",{sectionId:r,htmlHash:b}),eo.set(r,{htmlHash:b,inFlight:!0,status:p?.status||"ok",lastAttemptAtMs:Date.now()}),ys(m).then($=>{if($&&$.ok===!1){Kt("unavailable",{sectionId:r,reason:String($.reason||"")}),eo.set(r,{htmlHash:b,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()});let Pe=Date.now();Pe-Pi>6e4&&(Pi=Pe,ve("\u041A\u043E\u0440\u0440\u0435\u043A\u0442\u0443\u0440\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 (\u043D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0430 \u043A OpenAI)."));return}let q=String($?.html||"").trim();if(!q){Kt("skip_apply",{sectionId:r,reason:"empty_corrected_html"});return}let z=e.state.doc,X=St(z,r),Q=typeof X=="number"?z.nodeAt(X):null;if(!Q){Kt("skip_apply",{sectionId:r,reason:"section_not_found_current_doc"});return}let oe=Od(Q.child(1));if(no(oe)!==b){Kt("skip_apply",{sectionId:r,reason:"body_changed_since_request"});return}if(no(q)===b){Kt("skip_apply",{sectionId:r,reason:"no_changes_from_server"});return}if(!Gm(e,r,q,{preserveSelection:!0})){Kt("skip_apply",{sectionId:r,reason:"apply_failed"});return}on=!0,rn({delayMs:900})}).catch(()=>{Kt("error",{sectionId:r,htmlHash:b}),eo.set(r,{htmlHash:b,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()})}).finally(()=>{(eo.get(r)||null)?.status!=="error"&&eo.set(r,{htmlHash:b,inFlight:!1,status:"ok",lastAttemptAtMs:Date.now()}),Kt("done",{sectionId:r,htmlHash:b}),I=!0,N()}))}function Lr(e,t){if(!t)return!1;let n=St(e,t);if(typeof n!="number")return!1;let r=e.nodeAt(n);if(!r)return!1;let o=Gi(r),i=Or.get(t)||"";if(o===i)return!1;Rr.add(t);try{ao.add(t)}catch{}return!0}function rn({delayMs:e=1200}={}){u.isOutlineEditing&&ie&&(u.isPublicView||wt&&u.articleId&&wt!==u.articleId||(Qn&&clearTimeout(Qn),Qn=setTimeout(()=>{Qn=null,Ho()},Math.max(200,e))))}async function Ho({force:e=!1}={}){if(u.isOutlineEditing&&ie&&!u.isPublicView&&!(wt&&u.articleId&&wt!==u.articleId)&&!Oi&&!(!e&&!on&&!Rr.size)){Oi=!0,rr("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C\u2026");try{try{let t=ie.state,n=Mt(t.doc,t.selection.$from);if(typeof n=="number"){let r=t.doc.nodeAt(n),o=String(r?.attrs?.id||"");o&&Lr(t.doc,o)}}catch{}await th({silent:!0,mode:"queue"})}finally{Oi=!1}}}async function lu(){if(!V.outlineEditor)return;let e=V.outlineEditor.querySelector("#outlineEditorContent");if(!e){ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043C\u043E\u043D\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440");return}if(yc(),_o)return _o;gr("outline.mount.start",{outlineArticleId:wt,hadInstance:!!ie,hadTiptap:!!Je,mounted:Ca}),_o=(async()=>{let t=Nr()?performance.now():0,n=Nr()?performance.now():0,{core:r,starterKitMod:o,htmlMod:i,pmStateMod:s,pmViewMod:a}=await Km();n&&io("loadTiptap()",{ms:Math.round(performance.now()-n)});let{Editor:c,Node:l,Extension:d,Mark:m,InputRule:h,mergeAttributes:b}=r,w=o.default||o.StarterKit||o,{generateJSON:f,generateHTML:p}=i,{TextSelection:y}=s,{Plugin:x,PluginKey:A}=s,{Decoration:I,DecorationSet:N}=a,$=Je.linkMod.default||Je.linkMod.Link||Je.linkMod,q=Je.imageMod.default||Je.imageMod.Image||Je.imageMod,z=Je.mentionMod?.default||Je.mentionMod?.Mention||Je.mentionMod,X=Je.tableMod.TableKit||Je.tableMod.tableKit;vt={TableMap:Je.pmTablesMod?.TableMap||null,CellSelection:Je.pmTablesMod?.CellSelection||null,moveTableColumn:Je.pmTablesMod?.moveTableColumn||null,moveTableRow:Je.pmTablesMod?.moveTableRow||null,addRowBefore:Je.pmTablesMod?.addRowBefore||null,addRowAfter:Je.pmTablesMod?.addRowAfter||null,deleteRow:Je.pmTablesMod?.deleteRow||null,addColumnBefore:Je.pmTablesMod?.addColumnBefore||null,addColumnAfter:Je.pmTablesMod?.addColumnAfter||null,deleteColumn:Je.pmTablesMod?.deleteColumn||null,toggleHeaderRow:Je.pmTablesMod?.toggleHeaderRow||null,toggleHeaderColumn:Je.pmTablesMod?.toggleHeaderColumn||null};let Q=Je.uniqueIdMod.default||Je.uniqueIdMod.UniqueID||Je.uniqueIdMod,oe=Je.markdownMod?.Markdown||Je.markdownMod?.default?.Markdown||Je.markdownMod?.default||null,we=S=>{let g=String(S||"").trim();if(!g)return null;let E=g.match(/(\d+(?:\.\d+)?)px/i);if(!E)return null;let T=Number.parseFloat(E[1]);return Number.isFinite(T)?T:null},Pe=new A("outlineTagHighlighter"),te=null,Se=d.create({name:"outlineTagSuggestKeys",addProseMirrorPlugins(){return[new x({key:new A("outlineTagSuggestKeys"),props:{handleKeyDown(S,g){try{return te?.isOpen?.()?!!te.handleKeyDown?.(g):!1}catch{return!1}}}})]}}),tt=(()=>{if(!z||typeof z.extend!="function")return null;let S=()=>{let g=null,E=null,T=[],_=0,R=null,P=null,H=()=>{g||(g=document.createElement("div"),g.className="tt-tag-suggest",E=document.createElement("div"),E.className="tt-tag-suggest__list",g.appendChild(E),document.body.appendChild(g))},O=()=>{try{g?.remove()}catch{}g=null,E=null,T=[],_=0,R=null,te===P&&(te=null)},B=v=>{if(!g||!v)return;let D=v();D&&(g.style.left=`${Math.max(8,D.left)}px`,g.style.top=`${Math.max(8,D.bottom+6)}px`)},C=v=>{if(!(!g||!E)&&(R=v||null,T=Array.isArray(v?.items)?v.items:[],E.innerHTML="",T.forEach((D,F)=>{let J=document.createElement("button");J.type="button",J.className=F===_?"tt-tag-suggest__item active":"tt-tag-suggest__item",J.textContent=String(D?.label||D?.key||""),J.addEventListener("pointerdown",K=>{K.preventDefault(),K.stopPropagation(),v.command(D)}),E.appendChild(J)}),!T.length)){let D=document.createElement("div");D.className="tt-tag-suggest__empty",D.textContent="\u041D\u0435\u0442 \u0441\u043E\u0432\u043F\u0430\u0434\u0435\u043D\u0438\u0439",E.appendChild(D)}},k=v=>{let D=T.length;D&&(_=(_+v+D)%D)},M=v=>{if(!v||!g)return!1;if(v.key==="Escape")return v.preventDefault(),v.stopPropagation(),O(),!0;if(v.key===" "||v.code==="Space"){if(!R)return!1;if(!T.length){let F=Do(R?.query||"");return F?(v.preventDefault(),v.stopPropagation(),R.command({key:F,label:F}),!0):!1}v.preventDefault(),v.stopPropagation();let D=T[_];return D&&R.command(D),!0}if(v.key==="ArrowDown")return v.preventDefault(),v.stopPropagation(),k(1),C(R),!0;if(v.key==="ArrowUp")return v.preventDefault(),v.stopPropagation(),k(-1),C(R),!0;if(v.key==="Enter"){if(!R)return!1;v.preventDefault(),v.stopPropagation();let D=T[_];return D&&R.command(D),!0}return!1};return P={isOpen:()=>!!g,handleKeyDown:M},te=P,{char:"\\",allowedPrefixes:null,allowSpaces:!1,startOfLine:!1,items:({query:v})=>{let D=String(v||""),F=Do(D),J=gc(),K=new Map,U=new Map;try{for(let[be,Ie]of J?.counts?.entries?.()||[]){let ge=String(be||"").trim();ge&&(K.set(ge,Number(Ie||0)||0),U.set(ge,String(J?.labelByKey?.get?.(ge)||ge)))}}catch{}for(let[be,Ie]of or.counts.entries()){let ge=String(be||"").trim();ge&&(K.has(ge)||K.set(ge,Number(Ie||0)||0),U.has(ge)||U.set(ge,String(or.labelByKey.get(ge)||ge)))}let Z=Array.from(K.entries()).map(([be,Ie])=>({key:be,label:U.get(be)||be,count:Ie})).sort((be,Ie)=>(Ie.count||0)-(be.count||0));return(F?Z.filter(be=>String(be.key||"").includes(F)||String(be.label||"").toLowerCase().includes(F.toLowerCase())):Z).slice(0,8)},command:({editor:v,range:D,props:F})=>{try{let J=String(F?.key||F?.label||""),K=zi(J),U=Do(K);if(!U)return;v.chain().focus().insertContentAt(D,[{type:"tag",attrs:{label:U,key:U}}]).insertContent(" ").run()}catch{}},render:()=>({onStart:v=>{_=0,H(),C(v),B(v.clientRect)},onUpdate:v=>{_=0,H(),C(v),B(v.clientRect)},onKeyDown:v=>M(v?.event),onExit:()=>O()})}};return z.extend({name:"tag",group:"inline",inline:!0,atom:!0,selectable:!1,addAttributes(){return{label:{default:""},key:{default:""}}},parseHTML(){return[{tag:'span[data-tt-tag="1"]'}]},renderText({node:g}){try{return zi(g?.attrs?.label||g?.attrs?.key||"")||""}catch{return""}},renderHTML({node:g,HTMLAttributes:E}){let T=zi(g?.attrs?.label||g?.attrs?.key||"")||"",_=Do(g?.attrs?.key||T)||"";return["span",b(E,{"data-tt-tag":"1","data-tag-key":_,class:"tt-tag"}),T||_||""]}}).configure({suggestion:S()})})(),Lt=d.create({name:"outlineTagHighlighter",addProseMirrorPlugins(){return[new x({key:Pe,state:{init:()=>({activeKey:null}),apply:(S,g)=>{let E=S.getMeta(Pe);return E&&Object.prototype.hasOwnProperty.call(E,"activeKey")?{activeKey:E.activeKey?String(E.activeKey):null}:g}},props:{decorations(S){let g=Pe.getState(S)?.activeKey||null,E=[];return S.doc.descendants((T,_)=>{if(T?.type?.name!=="tag")return;let R=String(T.attrs?.key||"").trim();if(!R)return;let P=g&&R===g?"tt-tag tt-tag--active":"tt-tag";E.push(I.node(_,_+T.nodeSize,{class:P}))}),E.length?N.create(S.doc,E):null}}})]}}),_t=q.extend({inline:!0,group:"inline",addAttributes(){return{...typeof this.parent=="function"?this.parent():{},width:{default:320,parseHTML:g=>{try{let E=g,T=E&&E.classList&&E.classList.contains("resizable-image")?E:E?.closest?.(".resizable-image"),_=we(T?.style?.width||"");if(_!==null)return Math.round(_);let R=we(T?.getAttribute?.("style")||"")||we(E?.getAttribute?.("style")||"");if(R!==null)return Math.round(R);let P=T?.getAttribute?.("data-width")||E?.getAttribute?.("data-width")||"",H=Number.parseFloat(String(P||""));return Number.isFinite(H)&&H>0?Math.round(H):320}catch{return 320}},renderHTML:()=>({})},aspectRatio:{default:null,parseHTML:g=>{try{let E=g,T=E&&E.classList&&E.classList.contains("resizable-image")?E:E?.closest?.(".resizable-image"),_=T?.style?.aspectRatio||T?.getAttribute?.("data-aspect-ratio")||E?.getAttribute?.("data-aspect-ratio")||"",R=Number.parseFloat(String(_||"").replace(",","."));return Number.isFinite(R)&&R>0?R:null}catch{return null}},renderHTML:()=>({})},uploadToken:{default:null,parseHTML:()=>null,renderHTML:()=>({})}}},parseHTML(){return[{tag:"span.resizable-image",getAttrs:S=>{let g=S,E=g?.querySelector?.("img"),T=E?.getAttribute?.("src")||"";if(!T)return!1;let _=E?.getAttribute?.("alt")||"",R=E?.getAttribute?.("title")||"",P=we(g?.style?.width||"")??320;return{src:T,alt:_,title:R,width:Math.round(P)}}},{tag:"img[src]",getAttrs:S=>{let g=S,E=g?.getAttribute?.("src")||"";if(!E)return!1;let T=g?.getAttribute?.("alt")||"",_=g?.getAttribute?.("title")||"";return{src:E,alt:T,title:_,width:320}}}]},renderHTML({node:S,HTMLAttributes:g}){let E=S?.attrs?.width,T=Number.isFinite(Number(E))?Math.round(Number(E)):320,_=S?.attrs?.aspectRatio,R=Number.isFinite(Number(_))&&Number(_)>0?Number(_):null,P={...g};return delete P.width,delete P.aspectRatio,delete P.uploadToken,P.style=`${String(P.style||"").trim()};width:100%;height:auto;display:block;`.replace(/^;\s*/,""),["span",b({class:"resizable-image",style:`width:${T}px;max-width:100%;${R?`aspect-ratio:${R.toFixed(6)};`:""}`,...R?{"data-aspect-ratio":String(R)}:{}},{}),["span",{class:"resizable-image__inner"},["img",b(P,{draggable:"false"})]],["span",{class:"resizable-image__handle","data-direction":"e","aria-hidden":"true"}]]}});Ta=p,Ba=[w.configure({heading:!1,link:!1}),$.configure({openOnClick:!1,protocols:Mi}),_t,X.configure({table:{resizable:!0}})];let fn=d.create({name:"outlineImageUpload",addProseMirrorPlugins(){let S=(E,T)=>{let _=[];return Array.from(E||[]).forEach(R=>{if(R.kind!=="file")return;let P=typeof R.getAsFile=="function"?R.getAsFile():null;P&&Ma(P)&&_.push(P)}),!_.length&&T?.length&&Array.from(T).forEach(R=>{Ma(R)&&_.push(R)}),_},g=(E,T,_,R)=>{try{if(!(Ee?.getState?.(E.state)||null)?.editingSectionId)return!1}catch{return!1}let P=S(_,R);if(!P.length)return!1;T.preventDefault(),T.stopPropagation();for(let H of P)zd(E,H);return!0};return[new x({props:{handleDOMEvents:{paste(E,T){let _=T?.clipboardData?.items||null,R=T?.clipboardData?.files||null;return g(E,T,_,R)},drop(E,T){let _=T?.dataTransfer?.items||null,R=T?.dataTransfer?.files||null;return g(E,T,_,R)}}},view(E){return{update(T,_){try{let R=Ee?.getState?.(_)||{},P=Ee?.getState?.(T.state)||{},H=R.editingSectionId||null,O=P.editingSectionId||null;if(H&&!O){let B=String(H||"").trim(),C=wt||u.articleId||null;if(!B||!C)return;let k=!1;try{let M=St(T.state.doc,B),v=typeof M=="number"?T.state.doc.nodeAt(M):null;v?.type?.name==="outlineSection"&&(k=!!v.attrs?.collapsed)}catch{}iu(C,B,k);try{let M=St(T.state.doc,B),v=typeof M=="number"?T.state.doc.nodeAt(M):null;if(!v||v.type?.name!=="outlineSection")return;let D=!Or.has(B),F=D||Lr(T.state.doc,B),J=!1;if(F){let U=v.child(0),Z=v.child(1),se=U?.toJSON?U.toJSON():null,he=Z?.toJSON?Z.toJSON():null;if(se&&he){let be=Wd(se,he);if(be>Ki){ve(`\u0411\u043B\u043E\u043A \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 (${Math.ceil(be/1024)} KB). \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C: ${Math.ceil(Ki/1024)} KB. \u0420\u0430\u0437\u0431\u0435\u0439\u0442\u0435 \u0431\u043B\u043E\u043A \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E.`);try{let He=T.state.tr.setMeta(ue,!0);He=He.setMeta(Ee,{type:"enter",sectionId:B}),T.dispatch(He)}catch{}return}let Ie=Date.now(),ge=Jd(C,B);try{gt("outline.enqueue.section_upsert_content",{articleId:C,sectionId:B,seq:ge,bytes:be,reason:D?"exit_edit_mode_new_section":"exit_edit_mode"})}catch{}J=!0,cn("section_upsert_content",{articleId:C,payload:{sectionId:B,headingJson:se,bodyJson:he,seq:ge,clientQueuedAt:Ie},coalesceKey:`content:${C}:${B}`})}}let K=!1;if(D||qn||Vt){let U=zo(T.state.doc);if(U.length){let Z=null;try{Z=U.filter(se=>se&&(se.parentId==null||se.parentId==="")&&Number(se.position)>=0).sort((se,he)=>Number(se.position)-Number(he.position)).slice(0,3).map(se=>String(se.sectionId||""))}catch{Z=null}try{gt("outline.enqueue.structure_snapshot",{articleId:C,nodesCount:U.length,reason:D?"exit_edit_mode_new_section":"exit_edit_mode",rootFirst:Z})}catch{}cn("structure_snapshot",{articleId:C,payload:{nodes:U},coalesceKey:`structure:${C}`}),K=!0}qn=!1,Vt&&(clearTimeout(Vt),Vt=null)}try{(J||D)&&(Or.set(B,Gi(v)),Rr.delete(B))}catch{}try{J&&ie&&!ie.isDestroyed&&ie.view===T&&cu(ie,T.state.doc,B)}catch{}(J||K)&&rr("\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438 \u043D\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044E")}catch{}}}catch{}}}}})]}}),Sn=d.create({name:"outlineImageResize",addProseMirrorPlugins(){return[new x({view(S){let g=null,E=(P,H)=>{try{if((S.state.selection?.node||null)?.type?.name==="image"&&typeof S.state.selection.from=="number")return S.state.selection.from;let B=J=>{if(typeof J!="number")return null;let K=[J,J-1,J+1,J-2,J+2];for(let U of K){if(U<0)continue;if(S.state.doc.nodeAt(U)?.type?.name==="image")return U}return null},C=P?.querySelector?.("img")||null,k=B(S.posAtDOM(P,0));if(typeof k=="number")return k;let M=C?B(S.posAtDOM(C,0)):null;if(typeof M=="number")return M;let v=H&&typeof H.clientX=="number"&&typeof H.clientY=="number"?{left:H.clientX,top:H.clientY}:null,D=v?S.posAtCoords(v):null,F=D&&typeof D.pos=="number"?B(D.pos):null;return typeof F=="number"?F:null}catch{return null}},T=P=>{if(P.button!==0)return;let H=P.target?.closest?.(".resizable-image__handle");if(!H)return;let O=H.closest(".resizable-image");if(!O||!S.dom.contains(O)||!(Ee?.getState?.(S.state)||null)?.editingSectionId)return;let C=E(O,P);if(typeof C!="number")return;let k=S.state.doc.nodeAt(C);if(!k||k.type?.name!=="image")return;P.preventDefault(),P.stopPropagation();let M=O.getBoundingClientRect();g={pos:C,startWidth:M.width,startX:P.clientX,wrapper:O,lastWidth:M.width},O.classList.add("resizable-image--resizing")},_=P=>{if(!g)return;P.preventDefault();let H=P.clientX-g.startX,B=parseFloat(getComputedStyle(document.documentElement).fontSize)||16,C=Math.max(B,document.documentElement.clientWidth-32),k=10,M=g.startWidth+H;M=Math.max(B,Math.min(M,C)),M=Math.round(M/k)*k,M=Math.max(B,Math.min(M,C)),g.lastWidth=M,g.wrapper.style.width=`${Math.round(M)}px`},R=()=>{if(!g)return;let{pos:P,wrapper:H}=g;H.classList.remove("resizable-image--resizing");let O=S.state.doc.nodeAt(P)?.type?.name==="image"?P:E(H,null),B=typeof O=="number"?S.state.doc.nodeAt(O):null;if(B&&B.type?.name==="image"){let k=Number(g.lastWidth||0)||H.getBoundingClientRect().width,M=Math.max(1,Math.round(k/10)*10),v={...B.attrs,width:M},D=S.state.tr.setNodeMarkup(O,void 0,v);D=D.setMeta(ue,!0),S.dispatch(D)}g=null};return S.dom.addEventListener("pointerdown",T),document.addEventListener("pointermove",_),document.addEventListener("pointerup",R),document.addEventListener("pointercancel",R),{destroy(){S.dom.removeEventListener("pointerdown",T),document.removeEventListener("pointermove",_),document.removeEventListener("pointerup",R),document.removeEventListener("pointercancel",R)}}}})]}}),vn=d.create({name:"outlineImagePreview",addProseMirrorPlugins(){return[new x({props:{handleDOMEvents:{click(S,g){try{if((Ee?.getState?.(S.state)||null)?.editingSectionId)return!1;let T=g?.target?.closest?.("img");return T?g.target?.closest?.(".resizable-image__handle")?(g.preventDefault(),!0):(g.preventDefault(),bo(T.src,T.alt||""),!0):!1}catch{return!1}}}}})]}}),On=d.create({name:"outlineMarkdownTablePaste",addProseMirrorPlugins(){let S=(g,E)=>{try{if(!(Ee?.getState?.(g.state)||null)?.editingSectionId)return!1;let _=E?.clipboardData?.getData?.("text/plain")||"";if(En("paste: text/plain",{len:_.length,sample:_.slice(0,200)}),!_)return!1;let R=Fa(_),P=Pr(R);En("paste: parsed",{ok:!!P,lines:R});let H=P?null:_r(R);if(!P&&!H)return!1;let O=P?{header:P.header,rows:P.rows,withHeader:!0}:{header:null,rows:H.rows,withHeader:!1},B=null;try{B=yr(g.state.schema,O)}catch(k){return En("paste: buildTableNode error",{message:String(k?.message||k||""),stack:String(k?.stack||""),schemaNodes:Object.keys(g.state.schema?.nodes||{})}),!1}if(En("paste: tableNode",{ok:!!B,schemaNodes:_a()?Object.keys(g.state.schema?.nodes||{}):void 0}),!B)return!1;E.preventDefault(),E.stopPropagation();let C=g.state.tr;g.state.selection.empty||(C=C.deleteSelection());try{C=C.replaceSelectionWith(B,!1)}catch(k){return En("paste: replaceSelectionWith error",{message:String(k?.message||k||""),stack:String(k?.stack||""),selection:{from:g.state.selection?.from,to:g.state.selection?.to,empty:g.state.selection?.empty,$fromParent:g.state.selection?.$from?.parent?.type?.name}}),!1}return C=C.setMeta(ue,!0),g.dispatch(C.scrollIntoView()),!0}catch(T){return En("paste: unexpected error",{message:String(T?.message||T||""),stack:String(T?.stack||"")}),!1}};return[new x({appendTransaction(g,E,T){try{let _=g?.some?.(C=>C?.docChanged),R=null;if(Ee)for(let C of g||[]){let k=C?.getMeta?.(Ee)||null;if(k?.type==="enter"&&k?.sectionId){R=String(k.sectionId);break}}let P=!!R;if(!_&&!P||g.some(C=>C.getMeta?.(ue)))return null;let H=Ee?.getState?.(T)||null,O=R||H?.editingSectionId||null;if(!O)return null;En("appendTransaction: try convert",{didDocChange:_,didEnterEditMode:P,sectionId:O});let B=km(T,O);if(B)return B;if(_a()){let C=St(T.doc,O),k=typeof C=="number"?T.doc.nodeAt(C):null,M=k?k.child(1):null,v=M?M.textContent:"";String(v||"").includes("|")&&En("appendTransaction: saw pipes but no conversion",{sectionId:O})}return Zm(T,O)}catch{return null}},props:{handlePaste(g,E){return S(g,E)},handleDOMEvents:{paste(g,E){return S(g,E)}}}})]}}),Vn=d.create({name:"outlineStructuredSectionPaste",addProseMirrorPlugins(){let S=R=>{let P=String(R||"").trim();if(!P)return{sections:[],startsWithHeading:!1,headingCount:0};if(!/<h[1-6][\s>]/i.test(P))return{sections:[],startsWithHeading:!1,headingCount:0};let H=null;try{H=new DOMParser().parseFromString(P,"text/html")}catch{return{sections:[],startsWithHeading:!1,headingCount:0}}let O=H?.body;if(!O)return{sections:[],startsWithHeading:!1,headingCount:0};let B=!1;try{let v=Array.from(O.childNodes||[]).find(D=>D?.nodeType===1&&String(D?.textContent||"").trim());B=!!(v&&/^H[1-6]$/.test(String(v.nodeName||"")))}catch{B=!1}let C=[],k=null,M=()=>{if(!k)return;let v=document.createElement("div");for(let F of k.nodes)try{v.appendChild(F.cloneNode(!0))}catch{}let D=String(v.innerText||v.textContent||"").trimEnd();C.push({level:k.level,title:k.title,bodyText:D}),k=null};for(let v of Array.from(O.childNodes||[])){let J=(v?.nodeType===1?String(v.nodeName||"").toUpperCase():"").match(/^H([1-6])$/);if(J){M();let K=Number(J[1]),U=String(v.textContent||"").trim();if(!U)continue;k={level:K,title:U,nodes:[]};continue}k&&k.nodes.push(v)}return M(),{sections:C,startsWithHeading:B,headingCount:C.length}},g=R=>{let P=R?.selection?.$from;if(!P)return null;for(let H=P.depth;H>0;H-=1)if(P.node(H)?.type?.name==="outlineSection")return P.before(H);return null},E=(R,P)=>{let H=String(P||"").replace(/\r\n/g,`
`).trimEnd(),O=R.nodes.paragraph;if(!O)return[];let B=R.nodes.hardBreak||R.nodes.hard_break||null,C=v=>{let D=String(v||"").split(`
`),F=[];for(let J=0;J<D.length;J+=1){let K=D[J];J>0&&B&&F.push(B.create()),K&&F.push(R.text(K))}return O.create({},F)};if(!H.trim())return[O.create({},[])];let k=H.split(/\n{2,}/),M=[];for(let v of k){let D=String(v||"").trimEnd();M.push(C(D))}return M.length?M:[O.create({},[])]},T=(R,P)=>{let H=R.nodes.outlineHeading.create({},P.title?[R.text(P.title)]:[]),O=E(R,P.bodyText),B=R.nodes.outlineBody.create({},O),C=(P.children||[]).map(M=>T(R,M)),k=R.nodes.outlineChildren.create({},C);return R.nodes.outlineSection.create({id:P.id,collapsed:!1},[H,B,k])},_=(R,P)=>{try{if(!(Ee?.getState?.(R.state)||null)?.editingSectionId)return!1;let O=P?.clipboardData?.getData?.("text/html")||"",B=P?.clipboardData?.getData?.("text/plain")||"",C=O?S(O):{sections:[],startsWithHeading:!1,headingCount:0},k=!C.sections.length&&B?ma(B):{sections:[],startsWithHeading:!1,headingCount:0},M=C.sections.length?C:k;if(!M.sections.length||!(M.startsWithHeading||M.sections.length>=2))return!1;P.preventDefault(),P.stopPropagation();let D=g(R.state);if(typeof D!="number")return!1;let F=R.state.doc.nodeAt(D);if(!F||F.type?.name!=="outlineSection")return!1;let J=pd(M.sections,{makeId:()=>en()});if(!J.length)return!1;let K=R.state.schema,U=J.map(he=>T(K,he)),Z=R.state.tr,se=D+F.nodeSize;for(let he of U)Z=Z.insert(se,he),se+=he.nodeSize;return Z=Z.setMeta(ue,!0),R.dispatch(Z.scrollIntoView()),!0}catch{return!1}};return[new x({props:{handlePaste(R,P){return _(R,P)},handleDOMEvents:{paste(R,P){return _(R,P)}}}})]}}),jn=(S="")=>{let g=String(S||"").trim();return g?g.startsWith("app:/")||g.startsWith("disk:/")?`/api/yandex/disk/file?path=${encodeURIComponent(g)}`:g:""},Rn=d.create({name:"outlineAttachmentUpload",addProseMirrorPlugins(){let S=T=>{let _=String(T?.type||"");return!(_&&_.startsWith("image/"))},g=(T,_)=>{let R=[];try{let P=[];if(_&&typeof _.length=="number")P.push(...Array.from(_||[]));else if(T&&typeof T.length=="number")for(let H of Array.from(T||[])){if(!H||H.kind!=="file")continue;let O=H.getAsFile?.();O&&P.push(O)}for(let H of P)H&&S(H)&&R.push(H)}catch{}return R},E=(T,_,R,P)=>{let H=g(R,P);if(!H.length)return!1;_.preventDefault(),_.stopPropagation();try{if(!(Ee?.getState?.(T.state)||null)?.editingSectionId)return Xn(),!0}catch{return Xn(),!0}for(let O of H)Ud(T,O);return!0};return[new x({props:{handleDOMEvents:{drop(T,_){let R=_?.dataTransfer?.items||null,P=_?.dataTransfer?.files||null;return E(T,_,R,P)},paste(T,_){let R=_?.clipboardData?.items||null,P=_?.clipboardData?.files||null;return E(T,_,R,P)}}}})]}}),Hn=l.create({name:"doc",topNode:!0,content:"outlineSection+"}),zt=l.create({name:"outlineChildren",content:"outlineSection*",defining:!0,renderHTML(){return["div",{class:"outline-children","data-outline-children":"true"},0]},parseHTML(){return[{tag:"div[data-outline-children]"}]},addNodeView(){return({node:S})=>{let g=document.createElement("div");g.className="outline-children",g.setAttribute("data-outline-children","true");let E=T=>{let _=!T||T.childCount===0;g.setAttribute("data-empty",_?"true":"false")};return E(S),{dom:g,contentDOM:g,update(T){return!T||T.type?.name!=="outlineChildren"?!1:(E(T),!0)}}}}}),Yt=S=>{try{if(!S||S.childCount===0)return!0;let g=!1;return S.descendants(E=>{if(g)return!1;let T=E?.type?.name;return T==="image"||T==="table"||E.isText&&String(E.text||"").replace(/\u00a0/g," ").trim()?(g=!0,!1):!0}),!g}catch{return!1}},Tt=l.create({name:"outlineBody",content:"block*",defining:!0,renderHTML(){return["div",{class:"outline-body","data-outline-body":"true"},0]},parseHTML(){return[{tag:"div[data-outline-body]"}]},addNodeView(){return({node:S})=>{let g=document.createElement("div");g.className="outline-body",g.setAttribute("data-outline-body","true");let E=T=>{let _=Yt(T);g.setAttribute("data-empty",_?"true":"false")};return E(S),{dom:g,contentDOM:g,update(T){return!T||T.type?.name!=="outlineBody"?!1:(E(T),!0)}}}}}),At=["note","info","success","warning","danger"],Dt=S=>{let g=String(S||"").trim().toLowerCase();return At.includes(g)?g:"note"},Tn=l.create({name:"callout",group:"block",content:"block+",defining:!0,addAttributes(){return{kind:{default:"note",parseHTML:S=>Dt(S?.getAttribute?.("data-kind")),renderHTML:S=>({"data-kind":Dt(S?.kind)})}}},parseHTML(){return[{tag:"div[data-tt-callout]"}]},renderHTML({node:S,HTMLAttributes:g}){let E=Dt(S?.attrs?.kind),T=String(g?.class||"").trim(),_=`tt-callout tt-callout--${E}${T?` ${T}`:""}`;return["div",{...g,class:_,"data-tt-callout":"1","data-kind":E},0]},addCommands(){return{setCallout:S=>({editor:g,commands:E})=>{let T=Dt(S);return g.isActive("callout")?E.updateAttributes("callout",{kind:T}):E.toggleWrap("callout",{kind:T})},unsetCallout:()=>({editor:S,commands:g})=>S.isActive("callout")?g.toggleWrap("callout"):!1}}}),Y=m.create({name:"ttTextBg",inclusive:!1,addAttributes(){return{color:{default:null,parseHTML:S=>{try{return String(S?.style?.backgroundColor||"").trim()||null}catch{return null}},renderHTML:S=>{let g=S?.color?String(S.color).trim():"";return g?{style:`background-color: ${g}`}:{}}}}},parseHTML(){return[{tag:'span[data-tt-text-bg="1"]'}]},renderHTML({HTMLAttributes:S}){return["span",b(S,{class:"tt-text-bg","data-tt-text-bg":"1"}),0]}}),ce=d.create({name:"outlineTextBgNodes",addGlobalAttributes(){let S=(g,E)=>{try{let T=g?.style?.[E];return T?String(T).trim():""}catch{return""}};return[{types:["paragraph","outlineHeading"],attributes:{nodeBackground:{default:null,parseHTML:g=>{let E=S(g,"backgroundColor");return E?String(E).replace(/['"]+/g,""):null},renderHTML:g=>{let E=g?.nodeBackground?String(g.nodeBackground):"";return E?{style:`background-color: ${E}`,"data-tt-node-bg":"1"}:{}}}}},{types:["blockquote"],attributes:{nodeBorderColor:{default:null,parseHTML:g=>{let E=S(g,"borderLeftColor");return E?String(E).replace(/['"]+/g,""):null},renderHTML:g=>{let E=g?.nodeBorderColor?String(g.nodeBorderColor):"";return E?{style:`border-left-color: ${E}`,"data-tt-bq-border":"1"}:{}}}}}]},addCommands(){let S=(E,T)=>{try{let _=E.selection?.$from;if(!_)return null;for(let R=_.depth;R>=0;R-=1)if(_.node(R)?.type?.name===T)return _.before(R);return null}catch{return null}},g=(E,T,_,R,P)=>{try{let H=E.doc.nodeAt(_);if(!H)return!1;if(!T)return!0;let O={...H.attrs||{}};P==null||P===""?delete O[R]:O[R]=P;let B=E.tr.setNodeMarkup(_,void 0,O);return B=B.setMeta(ue,!0),T(B),!0}catch{return!1}};return{setTextBg:E=>({editor:T,state:_,dispatch:R})=>{let P=String(E||"").trim(),H=_.selection;if(!H)return!1;if(H.from!==H.to){try{T.chain().focus().run()}catch{}let M=_.schema?.marks?.ttTextBg||null;if(!M)return!1;if(!R)return!0;let v=_.tr.addMark(H.from,H.to,M.create({color:P}));v=v.setMeta(ue,!0);try{y&&(v=v.setSelection(y.create(v.doc,H.to,H.to)))}catch{}R(v);try{window?.getSelection?.()?.removeAllRanges?.()}catch{}return!0}let B=S(_,"blockquote");if(typeof B=="number")return g(_,R,B,"nodeBorderColor",P);let C=S(_,"paragraph");if(typeof C=="number")return g(_,R,C,"nodeBackground",P);let k=S(_,"outlineHeading");return typeof k=="number"?g(_,R,k,"nodeBackground",P):!1},clearTextBg:()=>({editor:E,state:T,dispatch:_})=>{let R=T.selection;if(!R)return!1;let P=R.from!==R.to,H=!1;if(P){try{E.chain().focus().run()}catch{}let k=T.schema?.marks?.ttTextBg||null;if(k){if(!_)return!0;let M=T.tr.removeMark(R.from,R.to,k);M=M.setMeta(ue,!0);try{y&&(M=M.setSelection(y.create(M.doc,R.to,R.to)))}catch{}_(M),H=!0}try{window?.getSelection?.()?.removeAllRanges?.()}catch{}}let O=S(T,"blockquote");typeof O=="number"&&(H=g(T,_,O,"nodeBorderColor",null)||H);let B=S(T,"paragraph");typeof B=="number"&&(H=g(T,_,B,"nodeBackground",null)||H);let C=S(T,"outlineHeading");return typeof C=="number"&&(H=g(T,_,C,"nodeBackground",null)||H),H}}}}),pe=l.create({name:"outlineHeading",content:"inline*",defining:!0,renderHTML(){return["div",{class:"outline-heading","data-outline-heading":"true"},0]},parseHTML(){return[{tag:"div[data-outline-heading]"}]},addNodeView(){return({editor:S,getPos:g,node:E})=>{let T=document.createElement("div");T.className="outline-heading",T.setAttribute("data-outline-heading","true");let _=document.createElement("button");_.type="button",_.className="outline-heading__toggle",_.title="\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C/\u0440\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C (Ctrl+\u2190/\u2192), \u0441 \u0434\u0435\u0442\u044C\u043C\u0438 (Ctrl+\u2191/\u2193)",_.setAttribute("aria-label","\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C/\u0440\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C");let R=document.createElement("div");R.className="outline-heading__content";let P=document.createElement("button");P.type="button",P.className="outline-heading__select",P.setAttribute("role","checkbox"),P.setAttribute("aria-checked","false"),P.setAttribute("aria-label","\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0431\u043B\u043E\u043A"),P.textContent="\u2713",P.addEventListener("pointerdown",O=>{O.preventDefault()}),P.addEventListener("click",O=>{if(O.preventDefault(),O.stopPropagation(),!nr)return;let B=typeof g=="function"?g():null;if(typeof B!="number")return;let C=B-1,k=S.state.doc.nodeAt(C),M=String(k?.attrs?.id||"").trim();M&&lm(M)});let H=()=>{let O=typeof g=="function"?g():null;if(typeof O!="number")return;let B=O-1,C=S.state.doc.nodeAt(B),k=String(C?.attrs?.id||"");k&&T.setAttribute("data-section-id",k),T.dataset.empty=E.content.size===0?"true":"false";let M=S.state.doc.resolve(Math.max(0,B+1)),v=0;for(let F=M.depth;F>=0;F-=1)M.node(F)?.type?.name==="outlineSection"&&(v+=1);T.dataset.depth=String(Math.min(6,Math.max(1,v||1)));let D=nr&&k&&wr.has(k);P.setAttribute("aria-checked",D?"true":"false"),P.style.display=nr?"inline-flex":"none"};return _.addEventListener("click",O=>{O.preventDefault(),O.stopPropagation();let B=typeof g=="function"?g():null;if(typeof B!="number")return;let C=B-1,k=S.state.doc.nodeAt(C);if(!k)return;let M=!k.attrs?.collapsed,v=S.state.tr.setNodeMarkup(C,void 0,{...k.attrs,collapsed:M});try{M&&Ee&&(Ee.getState(S.state)||{}).editingSectionId&&(v=v.setMeta(Ee,{type:"exit"}))}catch{}v.setMeta(ue,!0),S.view.dispatch(v),S.view.focus()}),T.appendChild(_),T.appendChild(R),T.appendChild(P),H(),{dom:T,contentDOM:R,update:O=>O.type.name!=="outlineHeading"?!1:(E=O,H(),!0)}}}}),me=l.create({name:"outlineSection",group:"block",content:"outlineHeading outlineBody outlineChildren",defining:!0,isolating:!0,draggable:!0,addAttributes(){return{collapsed:{default:!1}}},renderHTML({node:S,HTMLAttributes:g}){let E={...g,class:`outline-section${g?.class?` ${g.class}`:""}`,"data-outline-section":"true","data-section-id":S.attrs.id||"","data-collapsed":S.attrs.collapsed?"true":"false"};return["div",b(E),0]},parseHTML(){return[{tag:"div[data-outline-section]"}]}}),fe=S=>{if(!S)return!0;if((S.textContent||"").replace(/\u00a0/g," ").trim())return!1;if(S.childCount)for(let E=0;E<S.childCount;E+=1){let T=S.child(E);if(T.type?.name!=="paragraph"||(T.textContent||"").replace(/\u00a0/g," ").trim())return!1}return!0},ke=S=>{if(!S)return!0;try{let g=S.child(0),E=S.child(1),T=S.child(2);return fe(g)&&fe(E)&&(!T||T.childCount===0)}catch{return!0}},Te=(S,g,E)=>{let T=S.doc.nodeAt(E);if(!T)return!1;let _=String(T.attrs?.id||"").trim(),R=S.doc.resolve(E),P=R.index(),H=R.parent;if(!H)return!1;if(H.childCount<=1){if(H.type?.name==="doc"){let K=S.doc.type.schema,U=K.nodes.outlineSection.create({...T.attrs,collapsed:!1},[K.nodes.outlineHeading.create({},[]),K.nodes.outlineBody.create({},[K.nodes.paragraph.create({},[])]),K.nodes.outlineChildren.create({},[])]),Z=S.tr.replaceWith(E,E+T.nodeSize,U);Z=Z.setMeta(ue,!0);let se=U.child(0),he=E+1+se.nodeSize;return g(Z.setSelection(y.near(Z.doc.resolve(he+2),1)).scrollIntoView()),!0}_&&ro(_);let F=null;try{for(let K=R.depth;K>0;K-=1)if(R.node(K)?.type?.name==="outlineSection"){F=R.before(K);break}}catch{F=null}let J=S.tr.delete(E,E+T.nodeSize);J=J.setMeta(ue,!0);try{if(typeof F=="number"){let K=J.mapping.map(F,-1),U=J.doc.nodeAt(K);if(U&&U.type?.name==="outlineSection"){let Z=U.child(0),se=U.child(1),he=K+1+Z.nodeSize;if(!se.childCount){let be=J.doc.type.schema;J=J.insert(he+1,be.nodes.paragraph.create({},[]))}J=J.setSelection(y.near(J.doc.resolve(he+2),1))}}}catch{}return g(J.scrollIntoView()),!0}let O=P>0,B=P<H.childCount-1,C=O?H.child(P-1):null,k=O?E-C.nodeSize:null,M=E+T.nodeSize;_&&ro(_);let v=S.tr.delete(E,E+T.nodeSize),D=(F,J)=>{try{let K=F.doc.nodeAt(J);if(!K||K.type?.name!=="outlineSection")return F;let U=K.child(0),se=J+1+U.nodeSize-1;return F.setSelection(y.near(F.doc.resolve(se),-1))}catch{return F}};if(B){let F=E<v.doc.content.size?E:M;v.doc.nodeAt(F)&&(v=D(v,F))}else O&&typeof k=="number"&&v.doc.nodeAt(k)&&(v=D(v,k));return v=v.setMeta(ue,!0),g(v.scrollIntoView()),!0},ne=(S,g,E)=>{let T=S.doc.nodeAt(E);if(!T)return!1;let _=S.doc.resolve(E),R=_.index(),P=_.parent;if(!P||R<=0)return!1;let H=P.child(R-1),O=E-H.nodeSize,B=T.child(0),C=T.child(1),k=T.child(2),M=S.tr.delete(E,E+T.nodeSize),v=M.doc.nodeAt(O);if(!v)return M=M.setMeta(ue,!0),g(M.scrollIntoView()),!0;let D=M.doc.type.schema,F=v.child(0),J=v.child(1),K=v.child(2),U=[],Z=(B?.textContent||"").replace(/\u00a0/g," ").trim();Z&&U.push(D.nodes.paragraph.create({},[D.text(Z)])),C?.content?.forEach?.(He=>{U.push(He)});let se=U.length?D.nodes.outlineBody.create({},U).content:null,he=se?J.content.append(se):J.content,be=K.content.append(k.content),Ie=D.nodes.outlineSection.create(v.attrs,[F,D.nodes.outlineBody.create({},he),D.nodes.outlineChildren.create({},be)]);M=M.replaceWith(O,O+v.nodeSize,Ie);let ge=M.doc.nodeAt(O);if(ge){let He=ge.child(0),Be=ge.child(1),qe=O+1+He.nodeSize+Be.nodeSize-1;M=M.setSelection(y.near(M.doc.resolve(qe),-1))}return M=M.setMeta(ue,!0),g(M.scrollIntoView()),!0},Ne=(S,g,E)=>{let T=S.doc.nodeAt(E);if(!T)return!1;let _=S.selection.$from,R=null,P=null;for(let He=_.depth;He>0;He-=1)if(_.node(He)?.type?.name==="outlineSection")if(R===null)R=He;else{P=He;break}if(R===null||P===null)return!1;let H=_.before(P);if(!S.doc.nodeAt(H))return!1;let B=S.doc.type.schema,C=T.child(0),k=T.child(1),M=T.child(2),v=S.tr.delete(E,E+T.nodeSize),D=v.doc.nodeAt(H);if(!D)return v=v.setMeta(ue,!0),g(v.scrollIntoView()),!0;let F=D.child(0),J=D.child(1),K=D.child(2),U=[],Z=(C?.textContent||"").replace(/\u00a0/g," ").trim();Z&&U.push(B.nodes.paragraph.create({},[B.text(Z)])),k?.content?.forEach?.(He=>{U.push(He)});let se=U.length?B.nodes.outlineBody.create({},U).content:null,he=se?J.content.append(se):J.content,be=M.content.append(K.content),Ie=B.nodes.outlineSection.create({...D.attrs,collapsed:!1},[F,B.nodes.outlineBody.create({},he),B.nodes.outlineChildren.create({},be)]);v=v.replaceWith(H,H+D.nodeSize,Ie);let ge=v.doc.nodeAt(H);if(ge){let He=ge.child(0),Be=ge.child(1),qe=H+1+He.nodeSize+Be.nodeSize-1;v=v.setSelection(y.near(v.doc.resolve(qe),-1))}return v=v.setMeta(ue,!0),g(v.scrollIntoView()),!0},Ye=d.create({name:"outlineCommands",addKeyboardShortcuts(){let S=(L,G)=>{for(let j=G.depth;j>0;j-=1)if(G.node(j)?.type?.name==="outlineSection")return G.before(j);return null},g=(L,G)=>{for(let j=L.depth;j>0;j-=1)if(L.node(j)?.type?.name===G)return j;return null},E=L=>{if(!L)return!0;if((L.textContent||"").replace(/\u00a0/g," ").trim())return!1;if(L.childCount)for(let j=0;j<L.childCount;j+=1){let W=L.child(j);if(W.type?.name!=="paragraph"||(W.textContent||"").replace(/\u00a0/g," ").trim())return!1}return!0},T=(L,G)=>{let{selection:j}=L;if(!j||j.empty)return!1;let W=S(L.doc,j.$from),re=S(L.doc,j.$to);if(typeof W!="number"||typeof re!="number"||W===re||g(j.$from,"outlineBody")===null||j.$to.parent?.type?.name!=="outlineHeading"||j.$to.parentOffset!==0)return!1;let ae=L.doc.nodeAt(W);if(!ae)return!1;let Ae=ae.child(0),Me=ae.child(1),ze=W+1+Ae.nodeSize,Le=ze+1,Ke=ze+Me.nodeSize-1,Ue=Math.max(j.from,Le),$e=Math.min(j.to,Ke);if($e<Ue)return!0;let Oe=L.tr.delete(Ue,$e),De=Oe.doc.nodeAt(ze);if(De&&De.content.size===0){let je=Oe.doc.type.schema;Oe=Oe.insert(Le,je.nodes.paragraph.create({},[]))}return Oe=Oe.setSelection(y.near(Oe.doc.resolve(Le+1),1)),G(Oe.scrollIntoView()),!0},_=(L,G,j={})=>{let{selection:W}=L;if(!W||W.empty)return!1;let re=S(L.doc,W.$from),le=S(L.doc,W.$to);if(typeof re!="number"||typeof le!="number"||re!==le)return!1;let ae=g(W.$from,"outlineHeading"),Ae=g(W.$to,"outlineHeading");if(ae===null||Ae===null)return!1;let Me=L.doc.nodeAt(re);if(!Me)return!1;let ze=Me.child(0),Le=re+1,Ke=Le+1,Ue=Le+ze.nodeSize-1;if(W.from<Ke||W.to>Ue)return!1;let $e=Math.max(W.from,Ke),Oe=Math.min(W.to,Ue);if(Oe<$e)return!0;if(typeof j.onClipboard=="function")try{let je=L.doc.textBetween($e,Oe,`
`,`
`);j.onClipboard(je)}catch{}let De=L.tr.delete($e,Oe);return De=De.setSelection(y.near(De.doc.resolve(Ke),1)),G(De.scrollIntoView()),!0},R=L=>{if(!L)return!0;let G=L.child(0),j=L.child(1),W=L.child(2);return E(G)&&E(j)&&(!W||W.childCount===0)},P=(L,G,j)=>{let W=L.doc.nodeAt(j);if(!W)return!1;let re=W.child(0),le=W.child(1),Ae=j+1+re.nodeSize+le.nodeSize-1,Me=L.tr.setSelection(y.near(L.doc.resolve(Ae),-1));return G(Me.scrollIntoView()),!0},H=(L,G,j)=>{let W=L.doc.nodeAt(j);if(!W)return!1;let re=W.child(0),le=j+1,ae=L.tr.setSelection(y.near(L.doc.resolve(le+1),1));return G(ae.scrollIntoView()),!0},O=(L,G,j)=>{let W=L.doc.nodeAt(j);if(!W)return!1;let re=W.child(0),le=W.child(1);if(!le||le.childCount<=0)return C(L,G,j);let Ae=j+1+re.nodeSize+1,Me=null;try{le.descendants((Ke,Ue)=>{Ke?.isTextblock&&(Me=Ue)})}catch{Me=null}if(typeof Me!="number")return P(L,G,j);let ze=Ae+Me+1,Le=L.tr.setSelection(y.near(L.doc.resolve(ze),1));return G(Le.scrollIntoView()),!0},B=(L,G,j)=>{let W=L.doc.nodeAt(j);return W?W.attrs?.collapsed?H(L,G,j):O(L,G,j):!1},C=(L,G,j)=>{let W=L.doc.nodeAt(j);if(!W)return!1;let re=W.child(0),le=W.child(1),ae=j+1+re.nodeSize,Ae=L.tr;if(!le.childCount){let Me=L.doc.type.schema;Ae=Ae.insert(ae+1,Me.nodes.paragraph.create({},[]))}return Ae=Ae.setSelection(y.near(Ae.doc.resolve(ae+2),1)),G(Ae.scrollIntoView()),!0},k=(L,G,j)=>{let W=L.doc.nodeAt(j);if(!W)return!1;let re=W.child(0),le=W.child(1);if(!!W.attrs?.collapsed){let Ke=j+1+re.nodeSize-1,Ue=L.tr.setSelection(y.near(L.doc.resolve(Ke),-1));return G(Ue),!0}let Me=j+1+re.nodeSize+le.nodeSize-1,ze=L.tr.setSelection(y.near(L.doc.resolve(Me),-1));return G(ze),!0},M=(L,G)=>{try{let j=L.resolve(Math.min(L.content.size,Math.max(0,G+1)));for(let W=j.depth;W>0;W-=1){let re=j.node(W);if(!(re?.type?.name!=="outlineSection"||j.before(W)===G)&&re.attrs?.collapsed)return!1}return!0}catch{return!0}},v=(L,G)=>{let j=null;return L.nodesBetween(0,G,(W,re)=>{if(re>=G)return!1;W?.type?.name==="outlineSection"&&M(L,re)&&(j=re)}),j},D=(L,G,j)=>{let W=L.doc.nodeAt(j);if(!W)return!1;let re=String(W.attrs?.id||"").trim(),le=L.doc.resolve(j),ae=le.index(),Ae=le.parent;if(!Ae)return!1;if(Ae.childCount<=1){if(Ae.type?.name==="doc"){let De=L.doc.type.schema,je=De.nodes.outlineSection.create({...W.attrs,collapsed:!1},[De.nodes.outlineHeading.create({},[]),De.nodes.outlineBody.create({},[De.nodes.paragraph.create({},[])]),De.nodes.outlineChildren.create({},[])]),it=L.tr.replaceWith(j,j+W.nodeSize,je);it=it.setMeta(ue,!0);let Ze=je.child(0),ot=j+1+Ze.nodeSize;return G(it.setSelection(y.near(it.doc.resolve(ot+2),1)).scrollIntoView()),!0}let $e=null;try{for(let De=le.depth;De>0;De-=1)if(le.node(De)?.type?.name==="outlineSection"){$e=le.before(De);break}}catch{$e=null}let Oe=L.tr.delete(j,j+W.nodeSize);Oe=Oe.setMeta(ue,!0);try{if(typeof $e=="number"){let De=Oe.mapping.map($e,-1),je=Oe.doc.nodeAt(De);if(je&&je.type?.name==="outlineSection"){let it=je.child(0),Ze=je.child(1),ot=De+1+it.nodeSize;if(!Ze.childCount){let yt=Oe.doc.type.schema;Oe=Oe.insert(ot+1,yt.nodes.paragraph.create({},[]))}Oe=Oe.setSelection(y.near(Oe.doc.resolve(ot+2),1))}}}catch{}return G(Oe.scrollIntoView()),!0}re&&ro(re);let Me=ae>0,ze=Me?Ae.child(ae-1):null,Le=Me?j-ze.nodeSize:null,Ke=j+W.nodeSize,Ue=L.tr.delete(j,j+W.nodeSize);if(Me&&typeof Le=="number"){let $e=Ue.doc.nodeAt(Le);if($e){let Oe=$e.child(0),De=$e.child(1),je=Le+1+Oe.nodeSize;if(!De.childCount){let it=Ue.doc.type.schema;Ue=Ue.insert(je+1,it.nodes.paragraph.create({},[]))}Ue=Ue.setSelection(y.near(Ue.doc.resolve(je+2),1))}}else{let $e=j<Ue.doc.content.size?j:Ke,Oe=Ue.doc.nodeAt($e);if(Oe){let De=Oe.child(0),je=Oe.child(1),it=$e+1+De.nodeSize;if(!je.childCount){let Ze=Ue.doc.type.schema;Ue=Ue.insert(it+1,Ze.nodes.paragraph.create({},[]))}Ue=Ue.setSelection(y.near(Ue.doc.resolve(it+2),1))}}return Ue=Ue.setMeta(ue,!0),G(Ue.scrollIntoView()),!0},F=(L,G,j)=>{let W=L.doc.nodeAt(j);if(!W)return!1;let re=String(W.attrs?.id||"").trim(),le=L.doc.resolve(j),ae=le.index(),Ae=le.parent;if(!Ae||ae<=0)return!1;re&&ro(re);let Me=Ae.child(ae-1),ze=j-Me.nodeSize,Le=W.child(0),Ke=W.child(1),Ue=W.child(2),$e=L.tr.delete(j,j+W.nodeSize),Oe=$e.doc.nodeAt(ze);if(!Oe)return $e=$e.setMeta(ue,!0),G($e.scrollIntoView()),!0;let De=$e.doc.type.schema,je=Oe.child(0),it=Oe.child(1),Ze=Oe.child(2),ot=Number(it?.content?.size||0)||0,yt=[],ht=(Le?.textContent||"").replace(/\u00a0/g," ").trim();ht&&yt.push(De.nodes.paragraph.create({},[De.text(ht)])),Ke?.content?.forEach?.(Pt=>{yt.push(Pt)});let Rt=yt.length?De.nodes.outlineBody.create({},yt).content:null,Bt=Rt?it.content.append(Rt):it.content,tn=Ze.content.append(Ue.content),kt=De.nodes.outlineSection.create(Oe.attrs,[je,De.nodes.outlineBody.create({},Bt),De.nodes.outlineChildren.create({},tn)]);$e=$e.replaceWith(ze,ze+Oe.nodeSize,kt);let Xt=$e.doc.nodeAt(ze);if(Xt){let Pt=Xt.child(0),wn=Xt.child(1),nn=ze+1+Pt.nodeSize+1+ot,pn=Math.min($e.doc.content.size,Math.max(0,nn+1));$e=$e.setSelection(y.near($e.doc.resolve(pn),1))}return $e=$e.setMeta(ue,!0),G($e.scrollIntoView()),!0},J=(L,G,j)=>{let W=L.doc.nodeAt(j);if(!W)return!1;let re=String(W.attrs?.id||"").trim(),le=L.selection.$from,ae=null,Ae=null;for(let Pt=le.depth;Pt>0;Pt-=1)if(le.node(Pt)?.type?.name==="outlineSection")if(ae===null)ae=Pt;else{Ae=Pt;break}if(ae===null||Ae===null)return!1;let Me=le.before(Ae);if(!L.doc.nodeAt(Me))return!1;let Le=L.doc.type.schema,Ke=W.child(0),Ue=W.child(1),$e=W.child(2);re&&ro(re);let Oe=L.tr.delete(j,j+W.nodeSize),De=Oe.doc.nodeAt(Me);if(!De)return Oe=Oe.setMeta(ue,!0),G(Oe.scrollIntoView()),!0;let je=De.child(0),it=De.child(1),Ze=De.child(2),ot=Number(it?.content?.size||0)||0,yt=[],ht=(Ke?.textContent||"").replace(/\u00a0/g," ").trim();ht&&yt.push(Le.nodes.paragraph.create({},[Le.text(ht)])),Ue?.content?.forEach?.(Pt=>{yt.push(Pt)});let Rt=yt.length?Le.nodes.outlineBody.create({},yt).content:null,Bt=Rt?it.content.append(Rt):it.content,tn=$e.content.append(Ze.content),kt=Le.nodes.outlineSection.create({...De.attrs,collapsed:!1},[je,Le.nodes.outlineBody.create({},Bt),Le.nodes.outlineChildren.create({},tn)]);Oe=Oe.replaceWith(Me,Me+De.nodeSize,kt);let Xt=Oe.doc.nodeAt(Me);if(Xt){let Pt=Xt.child(0),bt=Me+1+Pt.nodeSize+1+ot,nn=Math.min(Oe.doc.content.size,Math.max(0,bt+1));Oe=Oe.setSelection(y.near(Oe.doc.resolve(nn),1))}return Oe=Oe.setMeta(ue,!0),G(Oe.scrollIntoView()),!0},K=(L,G,j)=>{let W=L.doc.nodeAt(j);if(!W)return!1;let re=L.doc.resolve(j),le=re.index(),ae=re.parent;if(!ae||le>=ae.childCount-1)return!1;let Ae=j+W.nodeSize,Me=L.doc.nodeAt(Ae);if(!Me||Me.type?.name!=="outlineSection")return!1;let ze=L.doc.type.schema,Le=W.child(0),Ke=W.child(1),Ue=W.child(2),$e=Me.child(1),Oe=Me.child(2),De=Ke.content.append($e.content),je=Ue.content.append(Oe.content),it=ze.nodes.outlineSection.create({...W.attrs,collapsed:!1},[Le,ze.nodes.outlineBody.create({},De),ze.nodes.outlineChildren.create({},je)]),Ze=L.tr;Ze=Ze.delete(Ae,Ae+Me.nodeSize),Ze=Ze.replaceWith(j,j+W.nodeSize,it);let ot=Ze.doc.nodeAt(j);if(ot){let yt=ot.child(0),ht=ot.child(1),Bt=j+1+yt.nodeSize+ht.nodeSize-1;Ze=Ze.setSelection(y.near(Ze.doc.resolve(Bt),-1))}return Ze=Ze.setMeta(ue,!0),G(Ze.scrollIntoView()),!0},U=L=>this.editor.commands.command(({state:G,dispatch:j})=>{let W=$e=>{try{if(typeof CSS<"u"&&CSS&&typeof CSS.escape=="function")return CSS.escape(String($e||""))}catch{}return String($e||"").replace(/["\\]/g,"\\$&")},re=$e=>{try{let Oe=$e;for(;Oe&&Oe!==document.body;){let De=Oe.parentElement;if(!De)break;let je=window.getComputedStyle(De),it=String(je?.overflowY||"");if((it==="auto"||it==="scroll")&&De.scrollHeight>De.clientHeight+1)return De;Oe=De}}catch{}return document.scrollingElement||document.documentElement},le=$e=>{try{let Oe=String($e||"").trim();if(!Oe)return null;let De=document.querySelector(`.outline-heading[data-section-id="${W(Oe)}"]`);if(!De)return null;let je=re(De);return{sid:Oe,scrollEl:je,top:De.getBoundingClientRect().top}}catch{return null}},ae=$e=>{if(!$e)return;let{sid:Oe,scrollEl:De,top:je}=$e,it=()=>{try{let Ze=document.querySelector(`.outline-heading[data-section-id="${W(Oe)}"]`);if(!Ze)return;let yt=Ze.getBoundingClientRect().top-je;if(!Number.isFinite(yt)||Math.abs(yt)<1)return;De.scrollTop+=yt}catch{}};try{requestAnimationFrame(()=>requestAnimationFrame(it))}catch{setTimeout(it,0)}},Ae=S(G.doc,G.selection.$from);if(typeof Ae!="number")return!1;let Me=G.doc.resolve(Ae),ze=Me.index(),Le=Me.parent;if(!Le)return!1;let Ke=G.doc.nodeAt(Ae);if(!Ke)return!1;let Ue=le(String(Ke.attrs?.id||"").trim());if(L==="up"){if(ze>0){let nn=Le.child(ze-1),pn=Ae-nn.nodeSize,pt=G.tr.delete(Ae,Ae+Ke.nodeSize).insert(pn,Ke).setMeta(ue,!0),sn=y.near(pt.doc.resolve(pn+2),1);return pt.setSelection(sn),j(pt.scrollIntoView()),ae(Ue),!0}let $e=Be(G.doc,Ae);if(typeof $e!="number")return!1;let Oe=G.doc.resolve($e),De=Oe.index(),je=Oe.parent;if(!je||De<=0)return!1;let it=je.child(De-1),Ze=$e-it.nodeSize,ot=G.doc.nodeAt(Ze);if(!ot||ot.type?.name!=="outlineSection")return!1;let yt=ot.child(0),ht=ot.child(1),Rt=ot.child(2),tn=Ze+1+yt.nodeSize+ht.nodeSize+Rt.nodeSize-1,kt=G.tr.delete(Ae,Ae+Ke.nodeSize).setMeta(ue,!0),Xt=kt.mapping.map(Ze,-1),Pt=kt.mapping.map(tn,-1);kt=kt.insert(Pt,Ke);let wn=kt.doc.nodeAt(Xt);wn?.type?.name==="outlineSection"&&wn.attrs?.collapsed&&(kt=kt.setNodeMarkup(Xt,void 0,{...wn.attrs,collapsed:!1}));let bt=y.near(kt.doc.resolve(Pt+2),1);return kt.setSelection(bt),j(kt.scrollIntoView()),ae(Ue),!0}if(L==="down"){if(ze<Le.childCount-1){let nn=Ae+Ke.nodeSize,pn=G.doc.nodeAt(nn);if(!pn)return!1;let pt=G.tr.delete(Ae,Ae+Ke.nodeSize).setMeta(ue,!0),sn=Ae+pn.nodeSize;pt.insert(sn,Ke);let xr=y.near(pt.doc.resolve(sn+2),1);return pt.setSelection(xr),j(pt.scrollIntoView()),ae(Ue),!0}let $e=Be(G.doc,Ae);if(typeof $e!="number")return!1;let Oe=G.doc.nodeAt($e);if(!Oe||Oe.type?.name!=="outlineSection")return!1;let De=G.doc.resolve($e),je=De.index(),it=De.parent;if(!it||je>=it.childCount-1)return!1;let Ze=$e+Oe.nodeSize,ot=G.doc.nodeAt(Ze);if(!ot||ot.type?.name!=="outlineSection")return!1;let yt=ot.child(0),ht=ot.child(1),Rt=ot.child(2),tn=Ze+1+yt.nodeSize+ht.nodeSize+1,kt=G.tr.delete(Ae,Ae+Ke.nodeSize).setMeta(ue,!0),Xt=kt.mapping.map(Ze,-1),Pt=kt.mapping.map(tn,-1);kt=kt.insert(Pt,Ke);let wn=kt.doc.nodeAt(Xt);wn?.type?.name==="outlineSection"&&wn.attrs?.collapsed&&(kt=kt.setNodeMarkup(Xt,void 0,{...wn.attrs,collapsed:!1}));let bt=y.near(kt.doc.resolve(Pt+2),1);return kt.setSelection(bt),j(kt.scrollIntoView()),ae(Ue),!0}return!1}),Z=()=>this.editor.commands.command(({state:L,dispatch:G})=>{let{selection:j}=L;if(!j?.empty)return!1;let{$from:W}=j,re=S(L.doc,W);if(typeof re!="number")return!1;let le=L.doc.nodeAt(re);if(!le)return!1;let ae=L.doc.type.schema;if(le.attrs?.collapsed){let bt=re+le.nodeSize,nn=en(),pn=ae.nodes.outlineSection.create({id:nn,collapsed:!1},[ae.nodes.outlineHeading.create({},[]),ae.nodes.outlineBody.create({},[ae.nodes.paragraph.create({},[])]),ae.nodes.outlineChildren.create({},[])]),pt=L.tr.insert(bt,pn);return pt=pt.setSelection(y.create(pt.doc,bt+2)),pt=pt.setMeta(ue,!0),Ee&&(pt=pt.setMeta(Ee,{type:"enter",sectionId:nn})),G(pt.scrollIntoView()),!0}let Ae=ae.nodes.outlineChildren.create({},[]),Me=bt=>bt&&bt.childCount?bt:ae.nodes.outlineBody.create({},[ae.nodes.paragraph.create({},[])]);if(W.parent?.type?.name==="outlineHeading"){let bt=le.child(0),nn=le.child(1),pn=le.child(2),pt=W.parentOffset||0,sn=bt.textBetween(0,Math.max(0,Math.min(pt,bt.content.size)),"",""),xr=bt.textBetween(Math.max(0,Math.min(pt,bt.content.size)),bt.content.size,"",""),fu=ae.nodes.outlineHeading.create({},sn?[ae.text(sn)]:[]),pu=ae.nodes.outlineHeading.create({},xr?[ae.text(xr)]:[]),za=en(),Ua=ae.nodes.outlineSection.create({...le.attrs,collapsed:!1},[fu,Me(ae.nodes.outlineBody.create({},[])),Ae]),mu=ae.nodes.outlineSection.create({id:za,collapsed:!1},[pu,Me(nn),pn]),$n=L.tr.replaceWith(re,re+le.nodeSize,Ua),qa=$n.doc.nodeAt(re),Ka=re+(qa?qa.nodeSize:Ua.nodeSize);return $n=$n.insert(Ka,mu),$n=$n.setSelection(y.create($n.doc,Ka+2)),$n=$n.setMeta(ue,!0),Ee&&($n=$n.setMeta(Ee,{type:"enter",sectionId:za})),G($n.scrollIntoView()),!0}if(g(W,"outlineBody")===null||!W.parent?.isTextblock)return!1;let Le=L.tr,Ke=j.from;try{Le=Le.split(Ke)}catch{return!1}let Ue=Le.mapping.map(Ke);try{Le=Le.setSelection(y.near(Le.doc.resolve(Math.min(Le.doc.content.size,Ue+1)),1))}catch{}let $e=Le.selection.$from,Oe=g($e,"outlineBody"),De=g($e,"paragraph");if(Oe===null||De===null)return!1;let je=$e.before(De),it=$e.end(Oe);if(typeof je!="number"||typeof it!="number"||it<je)return!1;let Ze=Le.doc.slice(je,it).content;Le=Le.delete(je,it);let ot=Le.mapping.map(re,-1),yt=Le.doc.nodeAt(ot);if(!yt)return G(Le.scrollIntoView()),!0;let ht=yt.child(0),Rt=Me(yt.child(1)),Bt=yt.child(2),tn=ae.nodes.outlineSection.create({...yt.attrs,collapsed:!1},[ht,Rt,Ae]),kt=Ze&&Ze.childCount?ae.nodes.outlineBody.create({},Ze):ae.nodes.outlineBody.create({},[ae.nodes.paragraph.create({},[])]),Xt=en(),Pt=ae.nodes.outlineSection.create({id:Xt,collapsed:!1},[ae.nodes.outlineHeading.create({},[]),kt,Bt]);Le=Le.replaceWith(ot,ot+yt.nodeSize,tn);let wn=ot+tn.nodeSize;return Le=Le.insert(wn,Pt),Le=Le.setSelection(y.create(Le.doc,wn+2)),Le=Le.setMeta(ue,!0),Ee&&(Le=Le.setMeta(Ee,{type:"enter",sectionId:Xt})),G(Le.scrollIntoView()),!0}),se=()=>this.editor.commands.command(({state:L,dispatch:G})=>{let j=S(L.doc,L.selection.$from);if(typeof j!="number")return!1;let W=L.doc.resolve(j),re=0;for(let ot=W.depth;ot>=0;ot-=1)W.node(ot)?.type?.name==="outlineSection"&&(re+=1);if(re>=6)return!1;let le=W.index(),ae=W.parent;if(!ae||le<=0)return!1;let Ae=L.doc.nodeAt(j);if(!Ae)return!1;let Me=ae.child(le-1),ze=j-Me.nodeSize,Le=L.doc.nodeAt(ze);if(!Le)return!1;let Ke=Le.child(0),Ue=Le.child(1),$e=Le.child(2),De=ze+1+Ke.nodeSize+Ue.nodeSize+$e.nodeSize-1,je=L.tr.delete(j,j+Ae.nodeSize).insert(De,Ae).setMeta(ue,!0),it=je.doc.nodeAt(ze);it?.type?.name==="outlineSection"&&it.attrs?.collapsed&&(je=je.setNodeMarkup(ze,void 0,{...it.attrs,collapsed:!1}));let Ze=y.near(je.doc.resolve(De+2),1);return je.setSelection(Ze),G(je.scrollIntoView()),!0}),he=()=>this.editor.commands.command(({state:L,dispatch:G})=>{let j=L.selection.$from,W=null,re=null;for(let Ue=j.depth;Ue>0;Ue-=1)if(j.node(Ue)?.type?.name==="outlineSection")if(W===null)W=Ue;else{re=Ue;break}if(W===null||re===null)return!1;let le=j.before(W),ae=j.before(re),Ae=L.doc.nodeAt(le);if(!Ae)return!1;let Me=L.tr.delete(le,le+Ae.nodeSize).setMeta(ue,!0),ze=Me.doc.nodeAt(ae);if(!ze)return!1;let Le=ae+ze.nodeSize;Me.insert(Le,Ae);let Ke=y.near(Me.doc.resolve(Le+2),1);return Me.setSelection(Ke),G(Me.scrollIntoView()),!0}),be=L=>this.editor.commands.command(({state:G,dispatch:j})=>{let W=S(G.doc,G.selection.$from);if(typeof W!="number")return!1;let re=G.doc.nodeAt(W);if(!re)return!1;let le=typeof L=="boolean"?L:!re.attrs?.collapsed,ae=G.tr.setNodeMarkup(W,void 0,{...re.attrs,collapsed:le}).setMeta(ue,!0);try{le&&Ee&&(Ee.getState(G)||{}).editingSectionId&&(ae=ae.setMeta(Ee,{type:"exit"}))}catch{}return j(ae),!0}),Ie=()=>this.editor.commands.command(({state:L,dispatch:G})=>{let j=S(L.doc,L.selection.$from);if(typeof j!="number")return!1;let W=L.doc.nodeAt(j);if(!W||W.type?.name!=="outlineSection"||!W.attrs?.collapsed)return!1;let re=Be(L.doc,j);if(typeof re!="number"){let Me=j+1,ze=L.tr.setSelection(y.near(L.doc.resolve(Me+1),1));return G(ze.scrollIntoView()),!0}let le=L.doc.nodeAt(re);if(!le||le.type?.name!=="outlineSection")return!1;let ae=L.tr.setNodeMarkup(re,void 0,{...le.attrs,collapsed:!0}).setMeta(ue,!0);try{Ee&&(Ee.getState(L)||{}).editingSectionId&&(ae=ae.setMeta(Ee,{type:"exit"}))}catch{}let Ae=re+1;return ae=ae.setSelection(y.near(ae.doc.resolve(Ae+1),1)),G(ae.scrollIntoView()),!0}),ge=()=>this.editor.commands.command(({state:L,dispatch:G})=>{let{selection:j}=L;if(!j?.empty)return!1;let{$from:W}=j;if(W.parent?.type?.name==="outlineHeading")return!1;let re=S(L.doc,W);if(typeof re!="number")return!1;let le=L.doc.nodeAt(re);if(!le||le.type?.name!=="outlineSection"||le.attrs?.collapsed)return!1;let ae=L.doc.type.schema,Ae=g(W,"outlineBody");if(Ae===null)return!1;let Me=null;for(let pt=W.depth;pt>Ae;pt-=1){let sn=W.node(pt),xr=W.node(pt-1);if(sn?.type?.name==="paragraph"&&xr?.type?.name==="outlineBody"){Me=pt;break}}if(Me===null)return!1;let ze=W.node(Me);if(!ze)return!1;let Le=le.child(0),Ke=le.child(1),Ue=le.child(2),Oe=re+1+Le.nodeSize+1,De=W.before(Me),je=null;try{let pt=0;for(let sn=0;sn<Ke.childCount;sn+=1){if(Oe+pt===De){je=sn;break}pt+=Ke.child(sn).nodeSize}}catch{je=null}if(je===null)return!1;let it=W.pos-W.start(Me),Ze=Math.max(0,Math.min(it,ze.content.size)),ot=ze.textBetween(0,Ze,"",""),yt=ze.textBetween(Ze,ze.content.size,"",""),ht=String(ot||"").trimEnd(),Rt=String(yt||"").trim(),Bt=[];for(let pt=0;pt<je;pt+=1)Bt.push(Ke.child(pt));Bt.push(ae.nodes.paragraph.create({},ht?[ae.text(ht)]:[])),Bt.length||Bt.push(ae.nodes.paragraph.create({},[]));let tn=[];for(let pt=je+1;pt<Ke.childCount;pt+=1)tn.push(Ke.child(pt));tn.length||tn.push(ae.nodes.paragraph.create({},[]));let kt=ae.nodes.outlineChildren.create({},[]),Xt=ae.nodes.outlineSection.create({...le.attrs,collapsed:!1},[Le,ae.nodes.outlineBody.create({},Bt),kt]),Pt=en(),wn=ae.nodes.outlineSection.create({id:Pt,collapsed:!1},[ae.nodes.outlineHeading.create({},Rt?[ae.text(Rt)]:[]),ae.nodes.outlineBody.create({},tn),Ue]),bt=L.tr.replaceWith(re,re+le.nodeSize,Xt),nn=re+Xt.nodeSize;bt=bt.insert(nn,wn);let pn=bt.doc.nodeAt(nn);if(pn&&pn.type?.name==="outlineSection"){let pt=pn.child(0),sn=nn+1+pt.nodeSize;bt=bt.setSelection(y.near(bt.doc.resolve(sn+2),1))}else bt=bt.setSelection(y.near(bt.doc.resolve(nn+2),1));return bt=bt.setMeta(ue,!0),Ee&&(bt=bt.setMeta(Ee,{type:"enter",sectionId:Pt})),G(bt.scrollIntoView()),!0}),He=(L,G)=>{let j=L.nodeAt(G);if(!j||j.type?.name!=="outlineSection")return[];let W=[G];return j.descendants((re,le)=>{re?.type?.name==="outlineSection"&&W.push(G+1+le)}),W},Be=(L,G)=>{try{let j=L.resolve(Math.min(L.content.size,G+1)),W=null;for(let re=j.depth;re>0;re-=1){if(j.node(re)?.type?.name!=="outlineSection")continue;if(j.before(re)===G){W=re;break}}if(W===null)return null;for(let re=W-1;re>0;re-=1)if(j.node(re)?.type?.name==="outlineSection")return j.before(re);return null}catch{return null}},xe=(L,G,j,W)=>{let re=!!W,le=L.tr;for(let ae of j){let Ae=le.doc.nodeAt(ae);!Ae||Ae.type?.name!=="outlineSection"||!!Ae.attrs?.collapsed!==re&&(le=le.setNodeMarkup(ae,void 0,{...Ae.attrs,collapsed:re}))}le=le.setMeta(ue,!0);try{re&&Ee&&(Ee.getState(L)||{}).editingSectionId&&(le=le.setMeta(Ee,{type:"exit"}))}catch{}G(le)},qe=()=>this.editor.commands.command(({state:L,dispatch:G})=>{let j=S(L.doc,L.selection.$from);if(typeof j!="number")return!1;let W=Be(L.doc,j),re=typeof W=="number"?W:j,le=He(L.doc,re);if(!le.length)return!1;let ae=L.tr;for(let Me of le){let ze=ae.doc.nodeAt(Me);!ze||ze.type?.name!=="outlineSection"||ze.attrs?.collapsed||(ae=ae.setNodeMarkup(Me,void 0,{...ze.attrs,collapsed:!0}))}ae=ae.setMeta(ue,!0);let Ae=ae.doc.nodeAt(re);if(Ae){let Me=Ae.child(0),Le=re+1+Me.nodeSize-1;ae=ae.setSelection(y.near(ae.doc.resolve(Le),-1))}return G(ae.scrollIntoView()),!0}),We=()=>this.editor.commands.command(({state:L,dispatch:G})=>{let j=S(L.doc,L.selection.$from);if(typeof j!="number")return!1;let W=He(L.doc,j);return W.length?(xe(L,G,W,!1),!0):!1}),ut=(L,G)=>{try{let j=L.nodeAt(G);if(!j||j.type?.name!=="outlineSection")return[];if(j.childCount<3)return[];let W=j.child(0),re=j.child(1),le=j.child(2);if(!le||le.type?.name!=="outlineChildren")return[];let ae=G+1+W.nodeSize+re.nodeSize,Ae=[];return le.descendants((Me,ze)=>{Me?.type?.name==="outlineSection"&&Ae.push(ae+1+ze)}),Ae}catch{return[]}},at=(L,G)=>{try{let j=Be(L,G);if(typeof j!="number")return oo(L);let W=L.nodeAt(j);if(!W||W.type?.name!=="outlineSection"||W.childCount<3)return oo(L);let re=W.child(0),le=W.child(1),ae=W.child(2);if(!ae||ae.type?.name!=="outlineChildren")return oo(L);let Ae=j+1+re.nodeSize+le.nodeSize,Me=[];return ae.descendants((ze,Le)=>{ze?.type?.name==="outlineSection"&&Me.push(Ae+1+Le)}),Me}catch{return oo(L)}},It=(L,G)=>{try{for(let j of G||[]){let W=L.nodeAt(j);if(!(!W||W.type?.name!=="outlineSection")&&W.attrs?.collapsed)return!0}}catch{}return!1},Ot=()=>this.editor.commands.command(({state:L,dispatch:G})=>{let j=S(L.doc,L.selection.$from);if(typeof j!="number")return!1;let W=L.doc.nodeAt(j);if(!W||W.type?.name!=="outlineSection")return!1;if(W.attrs?.collapsed)return xe(L,G,[j],!1),!0;let re=ut(L.doc,j);if(re.length&&It(L.doc,re))return xe(L,G,re,!1),!0;let le=j;for(let Ae=0;Ae<64;Ae+=1){let Me=at(L.doc,le);if(Me.length&&It(L.doc,Me))return xe(L,G,Me,!1),!0;let ze=Be(L.doc,le);if(typeof ze!="number")break;le=ze}let ae=oo(L.doc);return ae.length&&It(L.doc,ae)?(xe(L,G,ae,!1),!0):!1}),Gt=L=>this.editor.commands.command(({state:G,dispatch:j})=>{let{selection:W}=G,le=(W?.node||null)?.type?.name==="outlineSection"?W.from:S(G.doc,G.selection.$from);if(typeof le!="number"||!G.doc.nodeAt(le))return!1;let Ae=!!L,Me=He(G.doc,le);return Me.length?(xe(G,j,Me,Ae),!0):!1});return{"Alt-ArrowUp":()=>this.editor.isActive("table")?!1:U("up"),"Alt-ArrowDown":()=>this.editor.isActive("table")?!1:U("down"),"Alt-ArrowRight":()=>this.editor.isActive("table")?!1:se(),"Alt-ArrowLeft":()=>this.editor.isActive("table")?!1:he(),"Ctrl-Alt-ArrowUp":()=>this.editor.isActive("table")?!1:U("up"),"Alt-Ctrl-ArrowUp":()=>this.editor.isActive("table")?!1:U("up"),"Ctrl-Alt-ArrowDown":()=>this.editor.isActive("table")?!1:U("down"),"Alt-Ctrl-ArrowDown":()=>this.editor.isActive("table")?!1:U("down"),"Ctrl-Alt-ArrowRight":()=>this.editor.isActive("table")?!1:se(),"Alt-Ctrl-ArrowRight":()=>this.editor.isActive("table")?!1:se(),"Ctrl-Alt-ArrowLeft":()=>this.editor.isActive("table")?!1:he(),"Alt-Ctrl-ArrowLeft":()=>this.editor.isActive("table")?!1:he(),"Mod-ArrowRight":()=>be(!1),"Mod-ArrowLeft":()=>Ie()?!0:be(!0),"Mod-ArrowUp":()=>{try{let L=this.editor.state,G=S(L.doc,L.selection.$from);if(typeof G=="number"){let j=L.doc.nodeAt(G);if(j?.type?.name==="outlineSection"&&typeof Be(L.doc,G)!="number"&&j.attrs?.collapsed)return Pa(this.editor,!0)}}catch{}return qe()},"Mod-ArrowDown":()=>Ot(),"Mod-Enter":()=>{try{if(Ee&&!(Ee.getState(this.editor.state)||{}).editingSectionId)return!1}catch{}try{if(this.editor.state.selection?.$from?.parent?.type?.name==="outlineHeading")return Z()}catch{}return ge()?!0:Z()},Backspace:()=>this.editor.commands.command(({state:L,dispatch:G})=>{let{selection:j}=L;if(_(L,G)||T(L,G))return!0;if(!j?.empty)return!1;let{$from:W}=j;if(W.parent?.type?.name!=="outlineHeading"||W.parentOffset!==0)return!1;let re=S(L.doc,W);if(typeof re!="number")return!1;let le=L.doc.nodeAt(re);if(!le)return!1;if(R(le))return D(L,G,re);try{if(L.doc.resolve(re).index()<=0)return J(L,G,re)}catch{}return F(L,G,re)}),Delete:()=>this.editor.commands.command(({state:L,dispatch:G})=>{let{selection:j}=L;if(_(L,G)||T(L,G))return!0;if(!j?.empty)return!1;let{$from:W}=j;if(g(W,"outlineBody")!==null){let Me=S(L.doc,W);if(typeof Me!="number")return!1;let ze=L.doc.nodeAt(Me);if(!ze)return!1;let Le=ze.child(0),Ke=ze.child(1),$e=Me+1+Le.nodeSize+Ke.nodeSize-1;return W.pos===$e?K(L,G,Me):!1}if(W.parent?.type?.name!=="outlineHeading")return!1;let le=S(L.doc,W);if(typeof le!="number")return!1;let ae=L.doc.nodeAt(le);if(!ae)return!1;let Ae=ae.child(0);if(W.parentOffset===Ae.content.size){if(R(ae))return D(L,G,le);let Me=ae.child(1),ze=le+1+Ae.nodeSize,Le=L.tr;if(!Me.childCount){let Ke=L.doc.type.schema;Le=Le.insert(ze+1,Ke.nodes.paragraph.create({},[]))}return Le=Le.setSelection(y.near(Le.doc.resolve(ze+2),1)),G(Le.scrollIntoView()),!0}return!1}),Enter:()=>this.editor.commands.command(({state:L,dispatch:G})=>{let{selection:j}=L;if(!j?.empty)return!1;let{$from:W}=j;if(W.parent?.type?.name!=="outlineHeading")return!1;try{if(Ee&&!(Ee.getState(L)||{}).editingSectionId)return!1}catch{}let re=S(L.doc,W);if(typeof re!="number")return!1;let le=L.doc.nodeAt(re);if(!le)return!1;let ae=le.child(0),Ae=le.child(1),Me=re+1+ae.nodeSize,ze=ae.content?.size??0;if(le.attrs?.collapsed&&W.parentOffset===ze){let Ke=re+le.nodeSize,Ue=L.doc.type.schema,$e=en(),Oe=Ue.nodes.outlineSection.create({id:$e,collapsed:!1},[Ue.nodes.outlineHeading.create({},[]),Ue.nodes.outlineBody.create({},[Ue.nodes.paragraph.create({},[])]),Ue.nodes.outlineChildren.create({},[])]),De=L.tr.insert(Ke,Oe);return De=De.setSelection(y.create(De.doc,Ke+2)),De=De.setMeta(ue,!0),Ee&&(De=De.setMeta(Ee,{type:"enter",sectionId:$e})),G(De.scrollIntoView()),!0}if(W.parentOffset===0){let Ke=L.doc.type.schema,Ue=ae.textBetween(0,ze,"",""),$e=Ke.nodes.outlineHeading.create({},[]),Oe=le.child(2),De=[];try{for(let ht=0;ht<Ae.childCount;ht+=1)De.push(Ae.child(ht))}catch{}let je=[];if(Ue){let ht=Ke.nodes.paragraph.create({},[Ke.text(Ue)]),Rt=De[0]||null;Rt&&Rt.type?.name==="paragraph"&&E(Rt)?je=[ht,...De.slice(1)]:je=[ht,...De]}else je=De;je.length||(je=[Ke.nodes.paragraph.create({},[])]);let it=Ke.nodes.outlineBody.create({},je),Ze=Ke.nodes.outlineSection.create({...le.attrs,collapsed:!1},[$e,it,Oe]),ot=L.tr.replaceWith(re,re+le.nodeSize,Ze),yt=ot.doc.nodeAt(re);if(yt){let ht=yt.child(0),Rt=re+1+ht.nodeSize;ot=ot.setSelection(y.near(ot.doc.resolve(Rt+2),1))}else ot=ot.setSelection(y.near(ot.doc.resolve(Me+2),1));return ot=ot.setMeta(ue,!0),G(ot.scrollIntoView()),!0}if(W.parentOffset>0&&W.parentOffset<ze){let Ke=L.doc.type.schema,Ue=ae.textBetween(0,Math.max(0,Math.min(W.parentOffset,ze)),"",""),$e=ae.textBetween(Math.max(0,Math.min(W.parentOffset,ze)),ze,"",""),Oe=Ke.nodes.outlineHeading.create({},Ue?[Ke.text(Ue)]:[]),De=le.child(2),je=[];try{for(let Bt=0;Bt<Ae.childCount;Bt+=1)je.push(Ae.child(Bt))}catch{}let it=Ke.nodes.paragraph.create({},$e?[Ke.text($e)]:[]),Ze=[];if($e){let Bt=je[0]||null;Bt&&Bt.type?.name==="paragraph"&&E(Bt)?Ze=[it,...je.slice(1)]:Ze=[it,...je]}else Ze=je;Ze.length||(Ze=[Ke.nodes.paragraph.create({},[])]);let ot=Ke.nodes.outlineBody.create({},Ze),yt=Ke.nodes.outlineSection.create({...le.attrs,collapsed:!1},[Oe,ot,De]),ht=L.tr.replaceWith(re,re+le.nodeSize,yt),Rt=ht.doc.nodeAt(re);if(Rt){let Bt=Rt.child(0),tn=re+1+Bt.nodeSize;ht=ht.setSelection(y.near(ht.doc.resolve(tn+2),1))}else ht=ht.setSelection(y.near(ht.doc.resolve(Me+2),1));return ht=ht.setMeta(ue,!0),G(ht.scrollIntoView()),!0}let Le=L.tr;if(!Ae.childCount){let Ke=L.doc.type.schema;Le=Le.insert(Me+1,Ke.nodes.paragraph.create({},[]))}return Le=Le.setSelection(y.near(Le.doc.resolve(Me+2),1)),G(Le.scrollIntoView()),!0}),ArrowUp:()=>this.editor.commands.command(({state:L,dispatch:G})=>{let{selection:j}=L;if(!j?.empty)return!1;let{$from:W}=j;if(W.parent?.type?.name!=="outlineHeading"||W.parentOffset!==0)return!1;let re=S(L.doc,W);if(typeof re!="number")return!1;let le=v(L.doc,re);if(typeof le=="number")return B(L,G,le);let ae=L.doc.resolve(re),Ae=ae.index(),Me=ae.parent;if(!Me)return!1;if(Ae>0){let Ue=Me.child(Ae-1),$e=re-Ue.nodeSize;return H(L,G,$e)}let ze=null,Le=null;for(let Ue=W.depth;Ue>0;Ue-=1)if(W.node(Ue)?.type?.name==="outlineSection")if(ze===null)ze=Ue;else{Le=Ue;break}if(Le===null)return!1;let Ke=W.before(Le);return H(L,G,Ke)})}},addProseMirrorPlugins(){let S=(g,E)=>{for(let T=g.depth;T>0;T-=1)if(g.node(T)?.type?.name===E)return T;return null};return[new x({key:new A("outlineAltMoveRepeatGuard"),props:{handleKeyDown:(g,E)=>{let T=R=>{try{return!!R?.getModifierState?.("AltGraph")}catch{return!1}},_=R=>{try{return(!!R?.altKey||T(R))&&!R?.metaKey&&(!R?.ctrlKey||T(R))}catch{return!1}};try{if(!E||!_(E))return!1;let R=String(E.key||"");if(R!=="ArrowUp"&&R!=="ArrowDown"||!E.repeat)return!1;let P=g?.state,H=P?.selection?.$from;if(!H)return!1;for(let M=H.depth;M>0;M-=1){let v=H.node(M)?.type?.name;if(v&&String(v).startsWith("table"))return!1}let O=null;for(let M=H.depth;M>0;M-=1)if(H.node(M)?.type?.name==="outlineSection"){O=H.before(M);break}if(typeof O!="number")return!1;let B=P.doc.resolve(O),C=B.parent;if(!C)return!1;let k=B.index();return R==="ArrowUp"&&k<=0||R==="ArrowDown"&&k>=C.childCount-1}catch{return!1}}}}),new x({props:{handleDOMEvents:{cut:(g,E)=>{try{let{state:T}=g,{selection:_}=T;if(!_||_.empty)return!1;let R=(he,be)=>{for(let Ie=be.depth;Ie>0;Ie-=1)if(be.node(Ie)?.type?.name==="outlineSection")return be.before(Ie);return null},P=R(T.doc,_.$from),H=R(T.doc,_.$to);if(typeof P!="number"||typeof H!="number")return!1;let O=(he="")=>String(he||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");if(P===H){let he=S(_.$from,"outlineHeading"),be=S(_.$to,"outlineHeading");if(he!==null&&be!==null){let Ie=T.doc.nodeAt(P);if(!Ie)return!1;let ge=Ie.child(0),He=P+1,Be=He+1,xe=He+ge.nodeSize-1;if(_.from>=Be&&_.to<=xe){let qe=Math.max(_.from,Be),We=Math.min(_.to,xe),ut=T.doc.textBetween(qe,We,`
`,`
`);if(E?.clipboardData)try{E.clipboardData.setData("text/plain",ut),E.clipboardData.setData("text/html",`<pre>${O(ut)}</pre>`)}catch{}E.preventDefault(),E.stopPropagation();let at=T.tr.delete(qe,We);return at=at.setSelection(y.near(at.doc.resolve(Be),1)),g.dispatch(at.scrollIntoView()),!0}}return!1}if(S(_.$from,"outlineBody")===null||_.$to.parent?.type?.name!=="outlineHeading"||_.$to.parentOffset!==0)return!1;let C=T.doc.nodeAt(P);if(!C)return!1;let k=C.child(0),M=C.child(1),v=P+1+k.nodeSize,D=v+1,F=v+M.nodeSize-1,J=Math.max(_.from,D),K=Math.min(_.to,F);if(K<J)return!0;let U=T.doc.textBetween(J,K,`
`,`
`);if(E?.clipboardData)try{E.clipboardData.setData("text/plain",U),E.clipboardData.setData("text/html",`<pre>${O(U)}</pre>`)}catch{}E.preventDefault(),E.stopPropagation();let Z=T.tr.delete(J,K),se=Z.doc.nodeAt(v);if(se&&se.content.size===0){let he=Z.doc.type.schema;Z=Z.insert(D,he.nodes.paragraph.create({},[]))}return Z=Z.setSelection(y.near(Z.doc.resolve(D+1),1)),g.dispatch(Z.scrollIntoView()),!0}catch{return!1}}}}}),new x({props:{handleKeyDown:(g,E)=>{if(E.key!=="Backspace")return!1;let{state:T}=g,{selection:_}=T;if(!_?.empty)return!1;let{$from:R}=_;if(R.parent?.type?.name!=="paragraph"||R.parentOffset!==0)return!1;let P=null;for(let Z=R.depth;Z>0;Z-=1)if(R.node(Z)?.type?.name==="listItem"){P=Z;break}if(P===null||R.index(P)!==0)return!1;let H=P-1,O=R.node(H);if(!O)return!1;let B=R.index(H);if(B<=0)return!1;let C=R.before(P),k=O.child(B-1),M=C-k.nodeSize,v=T.doc.nodeAt(C);if(!v||v.type?.name!=="listItem")return!1;E.preventDefault(),E.stopPropagation();let D=k.type.create(k.attrs,k.content.append(v.content),k.marks),F=T.tr.replaceWith(M,M+k.nodeSize,D),J=M+1+k.content.size,K=F.mapping.map(J,1),U=F.mapping.map(C);F=F.delete(U,U+v.nodeSize);try{F=F.setSelection(y.near(F.doc.resolve(K+1),1))}catch{}return g.dispatch(F.scrollIntoView()),!0}}}),new x({props:{handleKeyDown:(g,E)=>(E.key!=="Tab"||E.preventDefault(),!1)}}),new x({props:{handleKeyDown:(g,E)=>{if(!E.ctrlKey||E.shiftKey||E.altKey||E.metaKey||E.key!=="ArrowUp"&&E.key!=="ArrowDown")return!1;let{state:T}=g,{selection:_}=T;if(!_)return!1;let P=(()=>{if((_?.node||null)?.type?.name==="outlineSection")return _.from;let M=_.$from;for(let v=M.depth;v>0;v-=1)if(M.node(v)?.type?.name==="outlineSection")return M.before(v);return null})();if(typeof P!="number")return!1;let H=(k,M)=>{try{let v=k.resolve(Math.min(k.content.size,M+1)),D=null;for(let F=v.depth;F>0;F-=1)if(v.node(F)?.type?.name==="outlineSection"&&v.before(F)===M){D=F;break}if(D===null)return null;for(let F=D-1;F>0;F-=1)if(v.node(F)?.type?.name==="outlineSection")return v.before(F);return null}catch{return null}},O=(k,M)=>{let v=k.nodeAt(M);if(!v||v.type?.name!=="outlineSection")return[];let D=[M];return v.descendants((F,J)=>{F?.type?.name==="outlineSection"&&D.push(M+1+J)}),D};if(E.preventDefault(),E.stopPropagation(),E.key==="ArrowUp"){let k=H(T.doc,P),M=typeof k=="number"?k:P,v=O(T.doc,M);if(!v.length)return!0;let D=T.tr;for(let J of v){let K=D.doc.nodeAt(J);!K||K.type?.name!=="outlineSection"||K.attrs?.collapsed||(D=D.setNodeMarkup(J,void 0,{...K.attrs,collapsed:!0}))}let F=D.doc.nodeAt(M);if(F){let J=F.child(0),U=M+1+J.nodeSize-1;D=D.setSelection(y.near(D.doc.resolve(U),-1))}return g.dispatch(D.scrollIntoView()),!0}let B=O(T.doc,P);if(!B.length)return!0;let C=T.tr;for(let k of B){let M=C.doc.nodeAt(k);!M||M.type?.name!=="outlineSection"||M.attrs?.collapsed&&(C=C.setNodeMarkup(k,void 0,{...M.attrs,collapsed:!1}))}return g.dispatch(C),!0}}}),new x({props:{handleKeyDown:(g,E)=>{if(E.key!=="Enter")return!1;let{state:T}=g,{$from:_}=T.selection;if(!T.selection.empty)return!1;let R=S(_,"outlineBody");if(R===null)return!1;let P=S(_,"paragraph");if(P===null||_.node(P-1)?.type?.name!=="outlineBody")return!1;let H=_.node(P);if(!H||H.content.size!==0||_.parentOffset!==0&&_.parentOffset!==H.content.size)return!1;let O=_.node(R),B=_.index(R);if(B!==O.childCount-1||B<1)return!1;let C=O.child(B-1);if(!C||C.type?.name!=="paragraph"||C.content.size!==0)return!1;let k=S(_,"outlineSection");if(k===null)return!1;let M=_.before(k);E.preventDefault(),E.stopPropagation();let v=T.tr,D=_.start(R),F=D;for(let ge=0;ge<B;ge+=1)F+=O.child(ge).nodeSize;let J=B;for(let ge=B;ge>=0;ge-=1){let He=O.child(ge);if(!He||He.type?.name!=="paragraph"||He.content.size!==0)break;J=ge}let K=D;for(let ge=0;ge<J;ge+=1)K+=O.child(ge).nodeSize;let U=F+O.child(B).nodeSize;v=v.delete(K,U);let Z=v.doc.nodeAt(M);if(!Z)return!0;let se=M+Z.nodeSize,he=v.doc.type.schema,be=en(),Ie=he.nodes.outlineSection.create({id:be,collapsed:!1},[he.nodes.outlineHeading.create({},[]),he.nodes.outlineBody.create({},[he.nodes.paragraph.create({},[])]),he.nodes.outlineChildren.create({},[])]);return v=v.insert(se,Ie),v=v.setSelection(y.create(v.doc,se+2)),v=v.setMeta(ue,!0),Ee&&(v=v.setMeta(Ee,{type:"enter",sectionId:be})),g.dispatch(v.scrollIntoView()),!0}}})]}}),Qe=d.create({name:"outlineActiveSection",addProseMirrorPlugins(){return[new x({props:{decorations(S){try{let g=Mt(S.doc,S.selection.$from);if(typeof g!="number")return null;let E=S.doc.nodeAt(g);return E?N.create(S.doc,[I.node(g,g+E.nodeSize,{"data-active":"true"})]):null}catch{return null}}}})]}}),ct=d.create({name:"outlineEditMode",addProseMirrorPlugins(){let S=new A("outlineEditMode");Ee=S;let g=null,E=O=>{let B=Mt(O.doc,O.selection.$from);if(typeof B!="number")return null;let C=O.doc.nodeAt(B);return String(C?.attrs?.id||"")||null},T=(O,B,C)=>{if(!B.docChanged)return!0;if(!C)return!1;let k=St(O.doc,C);if(typeof k!="number")return!1;let M=O.doc.nodeAt(k);if(!M)return!1;let v=M.child(0),D=M.child(1),F=k+1,J=F+1,K=F+v.nodeSize-1,U=k+1+v.nodeSize,Z=U+1,se=U+D.nodeSize-1,he=(be,Ie)=>{let ge=be>=J&&Ie<=K,He=be>=Z&&Ie<=se;return ge||He};for(let be of B.steps){let Ie=be.getMap(),ge=!0;if(Ie.forEach((He,Be)=>{he(He,Be)||(ge=!1)}),!ge)return!1}return!0},_=()=>{try{ve("\u0414\u043B\u044F \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Enter \u0438\u043B\u0438 \u0434\u0432\u043E\u0439\u043D\u043E\u0439 \u043A\u043B\u0438\u043A \u043C\u044B\u0448\u043A\u043E\u0439. Esc \u0434\u043B\u044F \u0432\u044B\u0445\u043E\u0434\u0430.")}catch{}},R=()=>{try{ve("\u041D\u0430\u0436\u043C\u0438\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437, \u0447\u0442\u043E\u0431\u044B \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438")}catch{}},P=O=>{try{let{selection:B}=O;if(!B?.empty)return!1;let{$from:C}=B,k=null;for(let K=C.depth;K>0;K-=1)if(C.node(K)?.type?.name==="outlineHeading"){k=K;break}if(k===null||!(C.pos===C.start(k)))return!1;let v=Mt(O.doc,C);if(typeof v!="number")return!1;if(O.doc.resolve(v).index()>0)return!0;let J=!1;for(let K=C.depth;K>0;K-=1)if(C.node(K)?.type?.name==="outlineSection"){if(!J){J=!0;continue}return!0}return!1}catch{return!1}},H=(O,B)=>{try{if(!B)return!1;let{selection:C}=O;if(!C?.empty)return!1;let{$from:k}=C,M=Mt(O.doc,k);if(typeof M!="number")return!1;let v=O.doc.nodeAt(M);if(!v||String(v.attrs?.id||"")!==String(B))return!1;let D=v.child(0),F=v.child(1),K=M+1+D.nodeSize+F.nodeSize-1;if(k.pos!==K)return!1;let U=O.doc.resolve(M),Z=U.index(),se=U.parent;return se?Z<se.childCount-1:!1}catch{return!1}};return[new x({key:S,state:{init(){return{editingSectionId:null}},apply(O,B){let C=O.getMeta(S);return C?C.type==="enter"?{editingSectionId:C.sectionId||null}:C.type==="exit"?{editingSectionId:null}:B:B}},filterTransaction(O,B){let k=(S.getState(B)||{}).editingSectionId||null;return O.getMeta(ue)||O.getMeta("history$")!=null||O.getMeta("closeHistory$")!=null||!O.docChanged?!0:T(B,O,k)},props:{decorations(O){try{let C=(S.getState(O)||{}).editingSectionId||null;if(!C)return null;let k=St(O.doc,C);if(typeof k!="number")return null;let M=O.doc.nodeAt(k);return M?N.create(O.doc,[I.node(k,k+M.nodeSize,{"data-editing":"true"})]):null}catch{return null}},handleKeyDown(O,B){let C=O.state,M=(S.getState(C)||{}).editingSectionId||null;st("keydown",{key:B?.key||null,repeat:!!B?.repeat,editingSectionId:M||null,selection:{empty:!!C?.selection?.empty,parent:C?.selection?.$from?.parent?.type?.name||null,parentOffset:C?.selection?.$from?.parentOffset??null}});let v=E(C);if(!M&&(B.key==="Delete"||B.key==="Del"||B.key==="Backspace")&&(B.ctrlKey||B.metaKey)&&!B.shiftKey&&!B.altKey){try{deleteActiveSection()}catch{}return B.preventDefault(),B.stopPropagation(),!0}if(M&&B.key==="Backspace"&&!B.ctrlKey&&!B.metaKey&&!B.altKey){let F=Am(C,O.dispatch,M,y);if(st("editorProps.backspace.bodyToHeading",{promoted:F,editingSectionId:M}),F)return B.preventDefault(),B.stopPropagation(),!0;let J=xm(C,O.dispatch);if(st("editorProps.backspace.tableMerge",{merged:J,editingSectionId:M||null}),J)return B.preventDefault(),B.stopPropagation(),!0}try{let F=(B.key==="Enter"||B.code==="Enter"||B.code==="NumpadEnter")&&(B.ctrlKey||B.metaKey)&&!B.shiftKey&&!B.altKey;if(!u.isPublicView&&!M&&F){let J=C.selection,K=J?.$from||null;if(K){let U=Mt(C.doc,K),Z=typeof U=="number"?C.doc.nodeAt(U):null;if(typeof U=="number"&&Z&&Z.type?.name==="outlineSection"){let se=!!(J&&J.empty),he=K.parent?.type?.name==="outlineHeading",Ie=se&&he&&K.parentOffset===0?U:U+Z.nodeSize;B.preventDefault(),B.stopPropagation();let ge=C.schema,He=en(),Be=ge.nodes.outlineSection.create({id:He,collapsed:!1},[ge.nodes.outlineHeading.create({},[]),ge.nodes.outlineBody.create({},[ge.nodes.paragraph.create({},[])]),ge.nodes.outlineChildren.create({},[])]),xe=C.tr.insert(Ie,Be);try{let We=xe.doc.nodeAt(Ie)?.child?.(0)||Be.child(0),ut=Ie+1+We.nodeSize;xe=xe.setSelection(y.near(xe.doc.resolve(ut+2),1))}catch{xe=xe.setSelection(y.create(xe.doc,Ie+2))}xe=xe.setMeta(ue,!0),xe=xe.setMeta(S,{type:"enter",sectionId:He}),O.dispatch(xe.scrollIntoView());try{O.focus()}catch{}return!0}}}}catch{}if((!g||g.sectionId!==v||g.key!==B.key)&&(g=null),u.isPublicView&&!M&&(B.key==="Enter"&&!B.shiftKey&&!B.ctrlKey&&!B.metaKey&&!B.altKey||B.key==="F2"&&!B.shiftKey&&!B.ctrlKey&&!B.metaKey&&!B.altKey))return B.preventDefault(),B.stopPropagation(),!0;if(!M&&(B.key==="Enter"&&!B.shiftKey&&!B.ctrlKey&&!B.metaKey&&!B.altKey||B.key==="F2"&&!B.shiftKey&&!B.ctrlKey&&!B.metaKey&&!B.altKey)){let F=E(C);return F?(B.preventDefault(),B.stopPropagation(),O.dispatch(C.tr.setMeta(S,{type:"enter",sectionId:F})),!0):!1}if(M&&B.key==="Escape")return B.preventDefault(),B.stopPropagation(),O.dispatch(C.tr.setMeta(S,{type:"exit"})),!0;if(!M){let F=B.key&&B.key.length===1&&!B.metaKey&&!B.ctrlKey&&!B.altKey;if(B.key==="Backspace"||B.key==="Delete"){if(B.key==="Backspace"&&P(C))try{let{selection:K}=C,{$from:U}=K,Z=findSectionPos(C.doc,U);if(typeof Z!="number")return!1;let se=C.doc.nodeAt(Z);if(!se)return!1;let he=String(se.attrs?.id||""),be=null;try{let ge=C.doc.resolve(Z),He=ge.index(),Be=ge.parent;if(Be&&He>0){let xe=Be.child(He-1),qe=Z-xe.nodeSize,We=C.doc.nodeAt(qe);be=String(We?.attrs?.id||"")||null}else for(let xe=U.depth-1;xe>0;xe-=1){let qe=U.node(xe);if(qe?.type?.name==="outlineSection"){let We=String(qe.attrs?.id||"");if(We&&We!==he){be=We;break}}}}catch{be=null}let Ie=!1;if(ke(se))Ie=Te(C,O.dispatch,Z);else try{C.doc.resolve(Z).index()<=0?Ie=Ne(C,O.dispatch,Z):Ie=ne(C,O.dispatch,Z)}catch{Ie=ne(C,O.dispatch,Z)}return Ie&&be&&window.setTimeout(()=>{try{if((S.getState(O.state)||{}).editingSectionId)return;let He=St(O.state.doc,be),Be=typeof He=="number"?O.state.doc.nodeAt(He):null;if(!Be)return;let xe=O.state.tr;Be?.attrs?.collapsed&&(xe=xe.setNodeMarkup(He,void 0,{...Be.attrs,collapsed:!1}),xe=xe.setMeta(ue,!0)),xe=xe.setMeta(S,{type:"enter",sectionId:be});try{let qe=xe.doc.nodeAt(He);if(qe&&qe.type?.name==="outlineSection"){let We=qe.child(0),ut=qe.child(1),It=He+1+We.nodeSize+ut.nodeSize-1;xe=xe.setSelection(y.near(xe.doc.resolve(It),-1))}}catch{}O.dispatch(xe.scrollIntoView());try{O.focus()}catch{}}catch{}},0),B.preventDefault(),B.stopPropagation(),!0}catch{}return B.preventDefault(),B.stopPropagation(),!0}if(F)return B.preventDefault(),B.stopPropagation(),_(),!0}let D=B.key==="Backspace"&&P(C)||B.key==="Delete"&&H(C,M);if(M&&(B.key==="Backspace"||B.key==="Delete")&&D){if(B.repeat)return B.preventDefault(),B.stopPropagation(),!0;let F=Date.now();return g&&g.sectionId===M&&g.key===B.key&&F-g.ts<1200?(g=null,!1):(g={sectionId:M,key:B.key,ts:F},B.preventDefault(),B.stopPropagation(),R(),!0)}return!1},handleTextInput(){let O=arguments[0],B=O?.state?S.getState(O.state):null;return B&&B.editingSectionId?!1:(_(),!0)},handleDOMEvents:{paste(O,B){let C=O.state;return(S.getState(C)||{}).editingSectionId?!1:(B.preventDefault(),B.stopPropagation(),_(),!0)},drop(O,B){let C=O.state;return(S.getState(C)||{}).editingSectionId?!1:(B.preventDefault(),B.stopPropagation(),_(),!0)}}}})]}}),rt=S=>{let g=(S||"").trim();if(!g)return[];let E=f(g,[w.configure({heading:!1,link:!1}),$.configure({openOnClick:!1,protocols:Mi}),_t,X.configure({table:{resizable:!0}})]),T=Array.isArray(E?.content)?E.content:[],_=[];for(let R=0;R<T.length;R+=1){let P=T[R];if(P?.type!=="paragraph"){_.push(P);continue}let O=vd(P).trim();if(!Cn(O)){_.push(P);continue}let C=[],k=R,M=R;for(;M<T.length;M+=1){let F=T[M];if(F?.type!=="paragraph")break;let J=vd(F).trim();if(!J)break;C.push(J)}let v=Pr(C);if(!v){_.push(P);continue}let D=Im(v);if(!D){_.push(P);continue}_.push(D),R=M-1,R<k&&(R=k)}return _};Fo=rt;let dt=d.create({name:"outlineMarkdown",addCommands(){return{insertMarkdown:S=>({editor:g})=>{if(!Ee)return!1;if(!(Ee.getState(g.state)||{}).editingSectionId)return Xn(),!1;if(!g?.storage?.markdown?.parser)return ve("Markdown \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F"),!1;let T=g.storage.markdown.parser.parse(String(S||""),{inline:!0}),_=rt(T);return _.length?g.chain().focus().insertContent(_).run():!1}}}}),Xe=d.create({name:"outlineFormattedPaste",addProseMirrorPlugins(){let S=this.editor,g=H=>{let O=String(H||"").trim();if(!O)return"";let B=null;try{B=new DOMParser().parseFromString(O,"text/html")}catch{return O}let C=B?.body;if(!C)return O;try{for(let k of Array.from(C.querySelectorAll("ms-cmark-node"))){let M=k.parentNode;if(M){for(;k.firstChild;)M.insertBefore(k.firstChild,k);M.removeChild(k)}}}catch{}try{for(let k of Array.from(C.querySelectorAll("h1,h2,h3,h4,h5,h6"))){let M=B.createElement("p"),v=B.createElement("strong");try{for(;k.firstChild;)v.appendChild(k.firstChild)}catch{v.textContent=String(k.textContent||"")}M.appendChild(v),k.replaceWith(M)}}catch{}return String(C.innerHTML||"").replace(/<!--\s*StartFragment\s*-->/gi,"").replace(/<!--\s*EndFragment\s*-->/gi,"").trim()},E=H=>{let O=String(H||"").trim();if(!O||!O.includes("<")||!O.includes(">")||!/<\s*\/?\s*[a-z][^>]*>/i.test(O))return!1;try{let C=new DOMParser().parseFromString(O,"text/html")?.body;if(!C)return!1;let k=new Set(["p","br","strong","b","em","i","u","s","a","ul","ol","li","blockquote","pre","code","table","thead","tbody","tr","td","th","img","span","div","h1","h2","h3","h4","h5","h6"]);return!!Array.from(C.querySelectorAll("*")).find(v=>k.has(String(v.tagName||"").toLowerCase()))}catch{return!1}},T=H=>{let O=String(H||"").replace(/\r\n/g,`
`).trim();return O?[/```[\s\S]*```/m,/^\s{0,3}([-*+]|\d+\.)\s+\S/m,/^\s{0,3}>\s+\S/m,/\[[^\]]+\]\([^)]+\)/,/!\[[^\]]*\]\([^)]+\)/,/\*\*[^*\n]+\*\*/,/__[^_\n]+__/,/`[^`\n]+`/].some(C=>C.test(O)):!1},_=H=>{try{let O=String(H||"").replace(/\r\n/g,`
`).split(`
`).map(B=>String(B||"").trim()).filter(Boolean);return O.length<2?!1:!!Pr(O)}catch{return!1}},R=(H,O)=>{if(!O||!Array.isArray(O)||!O.length)return!1;let B=H?.state?.selection?.from,C=H?.state?.selection?.to;if(!Number.isFinite(B)||!Number.isFinite(C))return!1;try{return S.chain().focus().command(({tr:k})=>(k.setMeta(ue,!0),!0)).insertContentAt({from:B,to:C},O).run()}catch{return!1}},P=(H,O)=>{try{if(!(Ee?.getState?.(H.state)||null)?.editingSectionId)return!1;let C=O?.clipboardData?.items||null,k=O?.clipboardData?.files||null;if(k&&k.length||C&&Array.from(C).some(D=>D?.kind==="file"))return!1;let M=String(O?.clipboardData?.getData?.("text/html")||"").trim(),v=String(O?.clipboardData?.getData?.("text/plain")||"").trim();if(M)try{let D=String(M).match(/<h[1-6][\s>]/gi);if((Array.isArray(D)?D.length:0)>=2)return!1}catch{}if(M){let D=g(M),F=rt(D);return F.length?(O.preventDefault(),O.stopPropagation(),R(H,F)):!1}if(v&&E(v)){let D=g(v),F=rt(D);return F.length?(O.preventDefault(),O.stopPropagation(),R(H,F)):!1}if(v&&T(v)){if(_(v))return!1;try{let Z=ma(v);if(Z?.startsWithHeading||(Z?.sections?.length||0)>=2)return!1}catch{}let D=S?.storage?.markdown?.parser||null;if(!D?.parse)return!1;let F=!v.includes(`
`)&&!/^\s{0,3}([-*+]|\d+\.)\s+\S/m.test(v)&&!/```[\s\S]*```/m.test(v)&&!/^\s{0,3}>\s+\S/m.test(v),J=String(D.parse(v,{inline:F})).trim();if(!J)return!1;let K=g(J),U=rt(K);return U.length?(O.preventDefault(),O.stopPropagation(),R(H,U)):!1}return!1}catch{return!1}};return[new x({props:{handlePaste(H,O){return P(H,O)},handleDOMEvents:{paste(H,O){return P(H,O)}}}})]}}),mt=!1,ft=null,lt=Nr()?performance.now():0,ee=u.article?.docJson||null;if(ee&&typeof ee=="object"&&ee.type==="doc"&&Array.isArray(ee.content)&&(ft=ee),ft||(ft=Vm({blocks:u.article?.blocks||[],parseHtmlToNodes:rt}),mt=!!(u.article&&!u.article?.docJson&&!u.article?.encrypted)),lt&&io("build initial content",{ms:Math.round(performance.now()-lt)}),ie){try{ie.destroy()}catch{}ie=null}let de=oe?oe.configure({html:!0,tightLists:!0,transformPastedText:!1,transformCopiedText:!1}):null,ye=d.create({name:"outlineTableCellStyling",addOptions(){return{types:["tableCell","tableHeader"],textAlignValues:["left","center","right","justify"],verticalAlignValues:["top","middle","bottom"]}},addGlobalAttributes(){let S=(E,T)=>{try{let _=E?.style?.[T];return _?String(_).trim():""}catch{return""}},g=E=>{let T=[],_=E?.nodeTextAlign?String(E.nodeTextAlign):"",R=E?.nodeVerticalAlign?String(E.nodeVerticalAlign):"",P=E?.nodeTextColor?String(E.nodeTextColor):"",H=E?.nodeBackground?String(E.nodeBackground):"";return _&&this.options.textAlignValues.includes(_)&&T.push(`text-align: ${_}`),R&&this.options.verticalAlignValues.includes(R)&&T.push(`vertical-align: ${R}`),P&&T.push(`color: ${P}`),H&&T.push(`background-color: ${H}`),T.length?{style:T.join("; ")}:{}};return[{types:this.options.types,attributes:{nodeTextAlign:{default:null,parseHTML:E=>{let T=S(E,"textAlign");return T&&this.options.textAlignValues.includes(T)?T:null},renderHTML:E=>g(E)},nodeVerticalAlign:{default:null,parseHTML:E=>{let T=S(E,"verticalAlign");return T&&this.options.verticalAlignValues.includes(T)?T:null},renderHTML:E=>g(E)},nodeTextColor:{default:null,parseHTML:E=>{let T=S(E,"color");return T?String(T).replace(/['"]+/g,""):null},renderHTML:E=>g(E)},nodeBackground:{default:null,parseHTML:E=>{let T=S(E,"backgroundColor");return T?String(T).replace(/['"]+/g,""):null},renderHTML:E=>g(E)}}}]},addCommands(){let S=(E,T)=>({state:_,dispatch:R})=>{try{let P=Ea(_);if(!P.length)return!1;let H=_.tr,O=!1;for(let{node:B,pos:C}of P){if(!B||typeof C!="number")continue;let k={...B.attrs||{}};T==null||T===""?delete k[E]:k[E]=T,H=H.setNodeMarkup(C,void 0,k),O=!0}return O?(H=H.setMeta(ue,!0),R(H),!0):!1}catch{return!1}},g=()=>({state:E,dispatch:T})=>{try{let _=Ea(E);if(!_.length)return!1;let R=E.schema.nodes?.paragraph||null;if(!R)return!1;let P=E.tr,H=[..._].sort((B,C)=>Number(C.pos)-Number(B.pos)),O=!1;for(let{node:B,pos:C}of H){if(!B||typeof C!="number")continue;let k=C+1,M=C+B.nodeSize-1;if(!(M>=k))continue;let v=R.createAndFill();v&&(P=P.replaceWith(k,M,v),O=!0)}return O?(P=P.setMeta(ue,!0),T(P.scrollIntoView()),!0):!1}catch{return!1}};return{setNodeTextAlign:E=>S("nodeTextAlign",E),setNodeVAlign:E=>S("nodeVerticalAlign",E),setNodeTextColor:E=>S("nodeTextColor",E),setNodeBackground:E=>S("nodeBackground",E),unsetNodeAlignment:()=>({state:E,dispatch:T})=>{try{let _=Ea(E);if(!_.length)return!1;let R=E.tr,P=!1;for(let{node:H,pos:O}of _){if(!H||typeof O!="number")continue;let B=H.attrs?.nodeTextAlign||null,C=H.attrs?.nodeVerticalAlign||null;if(!B&&!C)continue;let k={...H.attrs||{}};delete k.nodeTextAlign,delete k.nodeVerticalAlign,R=R.setNodeMarkup(O,void 0,k),P=!0}return P?(R=R.setMeta(ue,!0),T(R),!0):!1}catch{return!1}},clearNodeContents:()=>g()}}}),Ve=d.create({name:"outlineTablePercentWidths",addProseMirrorPlugins(){return[new x({view(S){let g=null,E=R=>{let P=String(R||"").trim();if(!P)return 0;let H=P.match(/(-?\\d+(?:\\.\\d+)?)px/i);return H&&Number(H[1])||0},T=()=>{g=null;try{let R=S?.dom;if(!R)return;let P=R.querySelectorAll(".tableWrapper > table");for(let H of P){let O=H.querySelector("colgroup");if(!O)continue;let B=Array.from(O.querySelectorAll("col"));if(!B.length||Br)continue;try{H.style.width="100%",H.style.maxWidth="100%",H.style.tableLayout="fixed"}catch{}let C=!1;for(let k of B){let M=k?.dataset?.ttPct||"",v=Number.parseFloat(String(M||""));if(Number.isFinite(v)&&v>0)C=!0,k.style.width=`${v.toFixed(4)}%`,k.style.minWidth="";else{let D=Qd(k.style.width);D!=null&&D>0&&(C=!0,k.dataset.ttPct=D.toFixed(4),k.style.width=`${D.toFixed(4)}%`,k.style.minWidth="")}}if(!C)try{let k=H.querySelector("tbody tr");if(!k)continue;let M=Array.from(k.children||[]).filter(K=>K&&K.nodeType===1);if(M.length<B.length)continue;let v=[];for(let K=0;K<B.length;K+=1){let U=M[K].getBoundingClientRect();v.push(Number.isFinite(U.width)?U.width:0)}let D=v.reduce((K,U)=>K+(Number.isFinite(U)?U:0),0);if(!(D>0))continue;let F=v.map(K=>Kn(K/D*100)),J=F.reduce((K,U)=>K+U,0);Math.abs(J-100)>.01&&(F[F.length-1]=Kn(F[F.length-1]+(100-J)));for(let K=0;K<B.length;K+=1)Wi(B[K],F[K])}catch{}}}catch{}},_=()=>{g==null&&(g=window.requestAnimationFrame(T))};return _(),{update(){_()},destroy(){g!=null&&(window.cancelAnimationFrame(g),g=null)}}}})]}}),Re=d.create({name:"outlineTableSmartMouseSelection",addProseMirrorPlugins(){let S=vt?.CellSelection||null;return S?[new x({view(g){let E=_=>{try{for(let R=_.depth;R>=0;R-=1){let P=_.node(R)?.type?.name;if(P==="tableCell"||P==="tableHeader")return _.before(R)}}catch{}return null},T=()=>{try{if(!(Ee?.getState?.(g.state)||null)?.editingSectionId)return;let R=g.state.selection;if(!R||R.empty)return;let P=E(R.$anchor),H=E(R.$head);if(P==null||H==null||P===H)return;let O=typeof S.create=="function"?S.create(g.state.doc,P,H):null;if(!O)return;let B=g.state.tr.setSelection(O);B=B.setMeta(ue,!0),g.dispatch(B)}catch{}};return g.dom.addEventListener("mouseup",T,!0),{destroy(){g.dom.removeEventListener("mouseup",T,!0)}}}})]:[]}}),_e=d.create({name:"outlineTableResizeCapture",addProseMirrorPlugins(){return[new x({view(S){let g=T=>{try{if(!T?.target?.closest?.(".column-resize-handle")||!(Ee?.getState?.(S.state)||null)?.editingSectionId)return;Br=!0}catch{}},E=()=>{if(Br){Br=!1;try{let T=S.domAtPos(S.state.selection.from),R=((T?.node&&T.node.nodeType===1?T.node:T?.node?.parentElement)||null)?.closest?.("table")||null;R&&Ui(R)}catch{}}};return S.dom.addEventListener("pointerdown",g,!0),document.addEventListener("pointerup",E,!0),document.addEventListener("pointercancel",E,!0),{destroy(){S.dom.removeEventListener("pointerdown",g,!0),document.removeEventListener("pointerup",E,!0),document.removeEventListener("pointercancel",E,!0)}}}})]}}),Ce=d.create({name:"outlineTableNodeUi",addProseMirrorPlugins(){let S=this.editor,g=[{label:"Default text",value:null},{label:"Gray text",value:"var(--tt-color-text-gray)"},{label:"Brown text",value:"var(--tt-color-text-brown)"},{label:"Orange text",value:"var(--tt-color-text-orange)"},{label:"Yellow text",value:"var(--tt-color-text-yellow)"},{label:"Green text",value:"var(--tt-color-text-green)"},{label:"Blue text",value:"var(--tt-color-text-blue)"},{label:"Purple text",value:"var(--tt-color-text-purple)"},{label:"Pink text",value:"var(--tt-color-text-pink)"},{label:"Red text",value:"var(--tt-color-text-red)"}],E=[{label:"Default background",value:null},{label:"Gray background",value:"var(--tt-color-highlight-gray)"},{label:"Brown background",value:"var(--tt-color-highlight-brown)"},{label:"Orange background",value:"var(--tt-color-highlight-orange)"},{label:"Yellow background",value:"var(--tt-color-highlight-yellow)"},{label:"Green background",value:"var(--tt-color-highlight-green)"},{label:"Blue background",value:"var(--tt-color-highlight-blue)"},{label:"Purple background",value:"var(--tt-color-highlight-purple)"},{label:"Pink background",value:"var(--tt-color-highlight-pink)"},{label:"Red background",value:"var(--tt-color-highlight-red)"}],T=[{label:"Align left",value:"left"},{label:"Align center",value:"center"},{label:"Align right",value:"right"},{label:"Justify",value:"justify"}],_=[{label:"Align top",value:"top"},{label:"Align middle",value:"middle"},{label:"Align bottom",value:"bottom"}],R=B=>{try{if(!B)return null;let C={left:Number(B.left),top:Number(B.top),right:Number(B.right),bottom:Number(B.bottom),width:Number(B.width),height:Number(B.height)};return!Number.isFinite(C.left)||!Number.isFinite(C.top)?null:C}catch{return null}},P=(B,C,k,M,v=8)=>{try{let D=window.innerWidth||0,F=window.innerHeight||0,J=Math.max(v,Math.min(B,Math.max(v,D-k-v))),K=Math.max(v,Math.min(C,Math.max(v,F-M-v)));return{left:J,top:K}}catch{return{left:B,top:C}}};class H{constructor(){this.panels=[],this.onDocPointerDown=C=>{try{let k=C?.target||null,M=typeof C?.composedPath=="function"?C.composedPath():null,v=Array.isArray(M)&&M.length?M:k?[k]:[];if(!v.length)return;for(let D of v)for(let F of this.panels)if(F&&(D===F||F.contains(D)))return;this.closeAll()}catch{this.closeAll()}},this.onKeyDown=C=>{C?.key==="Escape"&&this.closeAll()}}isOpen(){return this.panels.length>0}closeAll(){try{for(let C of this.panels)C?.remove?.()}catch{}this.panels=[];try{document.removeEventListener("pointerdown",this.onDocPointerDown,!1),window.removeEventListener("keydown",this.onKeyDown,!1)}catch{}}openPanel({anchorRect:C,items:k,level:M=0}){let v=R(C);if(!v)return;for(;this.panels.length>M;){let Z=this.panels.pop();try{Z?.remove?.()}catch{}}let D=document.createElement("div");D.className="tt-table-menu",D.setAttribute("role","menu"),D.setAttribute("data-level",String(M)),D.addEventListener("pointerdown",Z=>{Z.stopPropagation()}),D.addEventListener("mousedown",Z=>{Z.stopPropagation()});for(let Z of k){if(Z.type==="separator"){let he=document.createElement("div");he.className="tt-table-menu-sep",D.appendChild(he);continue}let se=document.createElement("button");if(se.type="button",se.className="tt-table-menu-item",se.textContent=Z.label,se.disabled=!!Z.disabled,Z.swatch){se.classList.add("has-swatch");try{let he=Z.swatchValue==null?"transparent":String(Z.swatchValue);se.style.setProperty("--tt-swatch",he)}catch{}}Z.submenu&&se.classList.add("has-submenu"),se.addEventListener("click",he=>{if(he.preventDefault(),he.stopPropagation(),!Z.disabled){if(Z.submenu){let be=se.getBoundingClientRect();this.openPanel({anchorRect:be,items:Z.submenu(),level:M+1});return}try{Z.onClick?.()}finally{this.closeAll()}}}),D.appendChild(se)}document.body.appendChild(D);let F=D.getBoundingClientRect(),J=v.right+8,K=v.top,U=P(J,K,F.width,F.height);D.style.left=`${U.left}px`,D.style.top=`${U.top}px`,this.panels.push(D);try{this.panels.length===1&&(document.addEventListener("pointerdown",this.onDocPointerDown,!1),window.addEventListener("keydown",this.onKeyDown,!1))}catch{}}}class O{constructor(C){this.view=C,this.menu=new H,this.wrapper=null,this.table=null,this.observedTable=null,this.resizeObserver=null,this.layoutRaf=null,this.resizeRaf=null,this.destroyed=!1,this.root=document.createElement("div"),this.root.className="tt-table-ui",this.root.style.display="none",this.cellOutline=document.createElement("div"),this.cellOutline.className="tt-table-active-cell-outline",this.cellOutline.style.display="none",this.root.appendChild(this.cellOutline),this.scheduleLayout=()=>{this.layoutRaf==null&&(this.layoutRaf=window.requestAnimationFrame(()=>{this.layoutRaf=null,!this.destroyed&&this.update(this.view)}))},this.scheduleResizeLoop=()=>{this.resizeRaf==null&&(this.resizeRaf=window.requestAnimationFrame(()=>{this.resizeRaf=null,!this.destroyed&&Br&&this.update(this.view)}))},this.onWrapperScroll=()=>this.scheduleLayout(),this.onWindowResize=()=>this.scheduleLayout();try{window.addEventListener("resize",this.onWindowResize,{passive:!0})}catch{}this.rowHandles=[],this.colHandles=[],this.dragState=null,this.suppressClickUntil=0,this.colDropIndicator=document.createElement("div"),this.colDropIndicator.className="tt-table-drop-indicator tt-table-drop-indicator-col",this.colDropIndicator.style.display="none",this.root.appendChild(this.colDropIndicator),this.rowDropIndicator=document.createElement("div"),this.rowDropIndicator.className="tt-table-drop-indicator tt-table-drop-indicator-row",this.rowDropIndicator.style.display="none",this.root.appendChild(this.rowDropIndicator),this.cellHandle=document.createElement("button"),this.cellHandle.type="button",this.cellHandle.className="tt-table-handle tt-table-cell-handle",this.cellHandle.setAttribute("aria-label","Cell actions"),this.cellHandle.addEventListener("click",k=>{k.preventDefault(),k.stopPropagation();let M=this.cellHandle.getBoundingClientRect();this.openCellMenu(M)}),this.root.appendChild(this.cellHandle)}hideDropIndicators(){try{this.colDropIndicator&&(this.colDropIndicator.style.display="none")}catch{}try{this.rowDropIndicator&&(this.rowDropIndicator.style.display="none")}catch{}}cancelDrag(){let C=this.dragState;if(C){this.dragState=null,this.hideDropIndicators();try{window.removeEventListener("pointermove",C.onMove),window.removeEventListener("pointerup",C.onUp),window.removeEventListener("pointercancel",C.onUp)}catch{}try{document.body.classList.remove("tt-table-dragging")}catch{}}}destroy(){this.destroyed=!0,this.cancelDrag();try{this.cellOutline.style.display="none"}catch{}this.menu.closeAll();try{this.layoutRaf!=null&&window.cancelAnimationFrame(this.layoutRaf)}catch{}this.layoutRaf=null;try{this.resizeRaf!=null&&window.cancelAnimationFrame(this.resizeRaf)}catch{}this.resizeRaf=null;try{window.removeEventListener("resize",this.onWindowResize)}catch{}try{this.wrapper?.removeEventListener?.("scroll",this.onWrapperScroll)}catch{}try{this.resizeObserver?.disconnect?.()}catch{}this.resizeObserver=null,this.observedTable=null;try{this.root.remove()}catch{}this.wrapper=null,this.table=null}ensureAttached(C){if(C&&this.wrapper!==C){try{this.wrapper?.removeEventListener?.("scroll",this.onWrapperScroll)}catch{}try{this.root.remove()}catch{}this.wrapper=C;try{this.wrapper.addEventListener("scroll",this.onWrapperScroll,{passive:!0})}catch{}this.wrapper.appendChild(this.root)}}buildRowHandles(C){for(;this.rowHandles.length>C;){let k=this.rowHandles.pop();try{k?.remove?.()}catch{}}for(;this.rowHandles.length<C;){let k=document.createElement("button");k.type="button",k.className="tt-table-handle tt-table-row-handle",k.setAttribute("aria-label","Row actions"),k.dataset.idx=String(this.rowHandles.length),k.addEventListener("pointerdown",M=>this.onHandlePointerDown(M,k,"row")),k.addEventListener("click",M=>{if(Date.now()<this.suppressClickUntil){M.preventDefault(),M.stopPropagation();return}M.preventDefault(),M.stopPropagation();let v=jt(this.view?.state)?.tablePos,D=k.getBoundingClientRect();S?.chain?.().focus?.().run?.();let F=Number(k.dataset.idx||0);vm(S,F),this.openRowMenu(D,F,v)}),this.rowHandles.push(k),this.root.appendChild(k)}}buildColHandles(C){for(;this.colHandles.length>C;){let k=this.colHandles.pop();try{k?.remove?.()}catch{}}for(;this.colHandles.length<C;){let k=document.createElement("button");k.type="button",k.className="tt-table-handle tt-table-col-handle",k.setAttribute("aria-label","Column actions"),k.dataset.idx=String(this.colHandles.length),k.addEventListener("pointerdown",M=>this.onHandlePointerDown(M,k,"col")),k.addEventListener("click",M=>{if(Date.now()<this.suppressClickUntil){M.preventDefault(),M.stopPropagation();return}M.preventDefault(),M.stopPropagation();let v=jt(this.view?.state)?.tablePos,D=k.getBoundingClientRect();S?.chain?.().focus?.().run?.();let F=Number(k.dataset.idx||0);Bm(S,F),this.openColumnMenu(D,F,v)}),this.colHandles.push(k),this.root.appendChild(k)}}onHandlePointerDown(C,k,M){try{if(!C||C.button!==0)return;C.preventDefault(),C.stopPropagation(),S?.chain?.().focus?.().run?.();let v=Number(k?.dataset?.idx||0);try{typeof k.setPointerCapture=="function"&&k.setPointerCapture(C.pointerId)}catch{}let D={kind:M,btn:k,pointerId:C.pointerId,fromIndex:v,startX:C.clientX,startY:C.clientY,moved:!1};this.dragState=D;let F=K=>this.onHandlePointerMove(K),J=K=>this.onHandlePointerUp(K);D.onMove=F,D.onUp=J,window.addEventListener("pointermove",F,{passive:!1}),window.addEventListener("pointerup",J,{passive:!1}),window.addEventListener("pointercancel",J,{passive:!1})}catch{}}onHandlePointerMove(C){let k=this.dragState;if(!k||!C||C.pointerId!==k.pointerId)return;try{C.preventDefault()}catch{}let M=C.clientX-k.startX,v=C.clientY-k.startY;if(!k.moved&&Math.hypot(M,v)>=4){k.moved=!0;try{document.body.classList.add("tt-table-dragging")}catch{}}if(k.moved){let D=this.getDropIndexFromPointer(k.kind,C.clientX,C.clientY);k.dropIndex=D,D==null?this.hideDropIndicators():this.updateDropIndicator(k.kind,D,C.clientX,C.clientY)}}getDropIndexFromPointer(C,k,M){try{let v=this.table;if(!v)return null;let D=Array.from(v.querySelectorAll("tbody tr"));if(!D.length)return null;if(C==="col"){let J=Array.from(D[0].children||[]).filter(U=>U&&U.nodeType===1);if(!J.length)return null;let K=J.map(U=>{let Z=U.getBoundingClientRect();return Z.left+Z.width/2});if(!K.length)return null;if(k<K[0])return 0;for(let U=0;U<K.length-1;U+=1)if(k>=K[U]&&k<K[U+1])return U+1;return K.length-1}let F=D.map(J=>{let K=J.children&&J.children[0];if(!K)return null;let U=K.getBoundingClientRect();return U.top+U.height/2}).filter(J=>typeof J=="number");if(!F.length)return null;if(M<F[0])return 0;for(let J=0;J<F.length-1;J+=1)if(M>=F[J]&&M<F[J+1])return J+1;return F.length-1}catch{return null}}updateDropIndicator(C,k,M,v){try{let D=this.table,F=this.wrapper;if(!D||!F)return;let J=F.getBoundingClientRect(),K=D.getBoundingClientRect(),U=K.top-J.top,Z=K.left-J.left,se=K.width,he=K.height,be=Array.from(D.querySelectorAll("tbody tr"));if(!be.length)return;if(C==="col"){let ut=Array.from(be[0].children||[]).filter(G=>G&&G.nodeType===1);if(!ut.length)return;let at=Math.max(0,Math.min(ut.length-1,Number(k))),It=ut[at].getBoundingClientRect(),Ot=ut[ut.length-1].getBoundingClientRect(),Gt=Ot.left+Ot.width/2,L=at===ut.length-1&&M>Gt?Ot.right-J.left:It.left-J.left;this.colDropIndicator.style.display="",this.rowDropIndicator.style.display="none",this.colDropIndicator.style.left=`${Math.round(L)}px`,this.colDropIndicator.style.top=`${Math.round(U)}px`,this.colDropIndicator.style.height=`${Math.max(0,Math.round(he))}px`;return}let Ie=Math.max(0,Math.min(be.length-1,Number(k))),ge=be[Ie]?.children?.[0];if(!ge)return;let He=ge.getBoundingClientRect(),xe=(be[be.length-1]?.children?.[0]||null)?.getBoundingClientRect?.()||null,qe=xe?xe.top+xe.height/2:null,We=Ie===be.length-1&&xe&&typeof qe=="number"&&v>qe?xe.bottom-J.top:He.top-J.top;this.rowDropIndicator.style.display="",this.colDropIndicator.style.display="none",this.rowDropIndicator.style.left=`${Math.round(Z)}px`,this.rowDropIndicator.style.top=`${Math.round(We)}px`,this.rowDropIndicator.style.width=`${Math.max(0,Math.round(se))}px`}catch{}}onHandlePointerUp(C){let k=this.dragState;if(!k||!C||C.pointerId!==k.pointerId)return;try{C.preventDefault(),C.stopPropagation()}catch{}this.dragState=null;try{window.removeEventListener("pointermove",k.onMove),window.removeEventListener("pointerup",k.onUp),window.removeEventListener("pointercancel",k.onUp)}catch{}try{document.body.classList.remove("tt-table-dragging")}catch{}if(this.hideDropIndicators(),!k.moved)return;this.suppressClickUntil=Date.now()+250;let M=k.dropIndex??this.getDropIndexFromPointer(k.kind,C.clientX,C.clientY);if(M!=null){try{S?.chain?.().focus?.().run?.()}catch{}k.kind==="col"?nu(S,k.fromIndex,M):ru(S,k.fromIndex,M),this.scheduleLayout()}}isEnabled(){try{return!!(Ee?.getState?.(this.view.state)||null)?.editingSectionId&&!u.isPublicView}catch{return!1}}update(C){if(this.view=C,!Br&&this.resizeRaf!=null){try{window.cancelAnimationFrame(this.resizeRaf)}catch{}this.resizeRaf=null}if(!this.isEnabled()){this.root.style.display="none",this.menu.closeAll();try{this.cellOutline.style.display="none"}catch{}return}let k=jt(C.state),M=Cm(C),v=M?.closest?.("table")||un(C),D=v?.closest?.(".tableWrapper")||null;if(!k||!v||!D||!M){this.root.style.display="none",this.menu.isOpen()||this.menu.closeAll();try{this.cellOutline.style.display="none"}catch{}return}this.ensureAttached(D),this.table=v;try{typeof ResizeObserver=="function"&&(this.resizeObserver||(this.resizeObserver=new ResizeObserver(()=>this.scheduleLayout())),this.observedTable!==v&&(this.resizeObserver.disconnect(),this.resizeObserver.observe(v),this.observedTable=v))}catch{}this.root.style.display="";let F=Array.from(v.querySelectorAll("tbody tr")),J=Number(k.map?.height||F.length||0),K=Number(k.map?.width||0);this.buildRowHandles(Math.max(0,J)),this.buildColHandles(Math.max(0,K));let U=D.getBoundingClientRect(),Z=v.getBoundingClientRect(),se=Z.top-U.top,he=Z.left-U.left,be=14,Ie=4,ge=be/2,He=Math.max(0,Math.min(Math.max(0,J-1),Number(k.rowIndex||0))),Be=Math.max(0,Math.min(Math.max(0,K-1),Number(k.colIndex||0))),xe=Math.max(ge,se-(be/2+Ie)),qe=Math.max(ge,he-(be/2+Ie)),We=M.getBoundingClientRect(),ut=We.left-U.left+We.width/2,at=We.top-U.top+We.height/2,It=We.left-U.left,Ot=We.top-U.top,Gt="cell";try{let L=C.state.selection,G=L?.$anchorCell?.pos,j=L?.$headCell?.pos;if(typeof G=="number"&&typeof j=="number"&&G!==j){let W=G-(k.tablePos+1),re=j-(k.tablePos+1),le=k.map?.rectBetween?.(W,re)||null;if(le){let ae=Number(le.right)-Number(le.left),Ae=Number(le.bottom)-Number(le.top);ae===1&&Ae>1?Gt="col":Ae===1&&ae>1?Gt="row":Gt="range"}else Gt="range"}}catch{Gt="cell"}try{Gt==="cell"?(this.cellOutline.style.display="",this.cellOutline.style.left=`${Math.round(It)}px`,this.cellOutline.style.top=`${Math.round(Ot)}px`,this.cellOutline.style.width=`${Math.max(0,Math.round(We.width))}px`,this.cellOutline.style.height=`${Math.max(0,Math.round(We.height))}px`):this.cellOutline.style.display="none"}catch{try{this.cellOutline.style.display="none"}catch{}}for(let L=0;L<this.colHandles.length;L+=1){let G=this.colHandles[L];if(G){if(G.dataset.idx=String(L),L!==Be){G.style.display="none";continue}G.style.display="",G.style.width=`${Math.max(18,Math.round(We.width))}px`,G.style.height=`${be}px`,G.style.left=`${Math.round(ut)}px`,G.style.top=`${Math.round(xe)}px`}}for(let L=0;L<this.rowHandles.length;L+=1){let G=this.rowHandles[L];if(G){if(G.dataset.idx=String(L),L!==He){G.style.display="none";continue}G.style.display="",G.style.width=`${be}px`,G.style.height=`${Math.max(18,Math.round(We.height))}px`,G.style.left=`${Math.round(qe)}px`,G.style.top=`${Math.round(at)}px`}}try{if(Gt!=="cell")this.cellHandle.style.display="none";else{let L=We.right-U.left;this.cellHandle.style.display="",this.cellHandle.style.left=`${Math.round(L)}px`,this.cellHandle.style.top=`${Math.round(at)}px`}}catch{this.cellHandle.style.display="none"}Br&&this.scheduleResizeLoop()}openCellMenu(C){let k=()=>{try{S?.chain?.().focus?.().run?.()}catch{}},M=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>g.map(v=>({label:v.label,swatch:!0,swatchValue:v.value,onClick:()=>{k(),S.commands.setNodeTextColor(v.value)}}))},{label:"Background color",submenu:()=>E.map(v=>({label:v.label,swatch:!0,swatchValue:v.value,onClick:()=>{k(),S.commands.setNodeBackground(v.value)}}))}]},{label:"Alignment",submenu:()=>[...T.map(v=>({label:v.label,onClick:()=>{k(),S.commands.setNodeTextAlign(v.value)}})),{type:"separator"},..._.map(v=>({label:v.label,onClick:()=>{k(),S.commands.setNodeVAlign(v.value)}}))]},{type:"separator"},{label:"Clear contents",onClick:()=>{k(),S.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:C,items:M,level:0})}openRowMenu(C,k,M){let v=()=>{try{S?.chain?.().focus?.().run?.()}catch{}Number.isFinite(Number(M))&&Tm(S,M,k)},D=(U,Z)=>{try{S?.chain?.().focus?.().run?.()}catch{}return S.commands.command(({state:se,dispatch:he})=>{let be=Number.isFinite(Number(M))?Number(M):jt(se)?.tablePos,Ie=Number.isFinite(Number(k))?Number(k):jt(se)?.rowIndex;return!Number.isFinite(Number(be))||!Number.isFinite(Number(Ie))?!1:Mm({pmState:se,dispatch:he},{tablePos:be,rowIndex:Ie,attr:U,value:Z})})},F=U=>()=>(v(),U?.()),J=U=>{try{return typeof U!="function"?!1:(v(),S.commands.command(({state:Z,dispatch:se})=>U(Z,typeof se=="function"?be=>{try{be=be.setMeta(ue,!0)}catch{}se(be)}:void 0)))}catch{return!1}},K=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>g.map(U=>({label:U.label,swatch:!0,swatchValue:U.value,onClick:()=>D("nodeTextColor",U.value)}))},{label:"Background color",submenu:()=>E.map(U=>({label:U.label,swatch:!0,swatchValue:U.value,onClick:()=>D("nodeBackground",U.value)}))}]},{label:"Alignment",submenu:()=>[...T.map(U=>({label:U.label,onClick:()=>D("nodeTextAlign",U.value)})),{type:"separator"},..._.map(U=>({label:U.label,onClick:()=>D("nodeVerticalAlign",U.value)}))]},{type:"separator"},{label:"Insert row above",onClick:()=>J(vt?.addRowBefore)},{label:"Insert row below",onClick:()=>J(vt?.addRowAfter)},{label:"Sort ",submenu:()=>[{label:"Sort column A-Z",onClick:F(()=>Md(S,{direction:"asc"}))},{label:"Sort column Z-A",onClick:F(()=>Md(S,{direction:"desc"}))}]},{label:"Header row",onClick:()=>J(vt?.toggleHeaderRow)},{label:"Move ",submenu:()=>[{label:"Move row up",onClick:F(()=>Bd(S,-1))},{label:"Move row down",onClick:F(()=>Bd(S,1))},{label:"Move row left",disabled:!0,onClick:()=>{}},{label:"Move row right",disabled:!0,onClick:()=>{}}]},{label:"Duplicate row",onClick:F(()=>_m(S))},{label:"Delete row",onClick:()=>J(vt?.deleteRow)},{type:"separator"},{label:"Clear row contents",onClick:()=>{v(),S.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:C,items:K,level:0})}openColumnMenu(C,k,M){let v=()=>{try{S?.chain?.().focus?.().run?.()}catch{}Number.isFinite(Number(M))&&Nm(S,M,k)},D=(U,Z)=>{try{S?.chain?.().focus?.().run?.()}catch{}return S.commands.command(({state:se,dispatch:he})=>{let be=Number.isFinite(Number(M))?Number(M):jt(se)?.tablePos,Ie=Number.isFinite(Number(k))?Number(k):jt(se)?.colIndex;return!Number.isFinite(Number(be))||!Number.isFinite(Number(Ie))?!1:Lm({pmState:se,dispatch:he},{tablePos:be,colIndex:Ie,attr:U,value:Z})})},F=U=>()=>(v(),U?.()),J=U=>{try{return typeof U!="function"?!1:(v(),S.commands.command(({state:Z,dispatch:se})=>U(Z,typeof se=="function"?be=>{try{be=be.setMeta(ue,!0)}catch{}se(be)}:void 0)))}catch{return!1}},K=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>g.map(U=>({label:U.label,swatch:!0,swatchValue:U.value,onClick:()=>D("nodeTextColor",U.value)}))},{label:"Background color",submenu:()=>E.map(U=>({label:U.label,swatch:!0,swatchValue:U.value,onClick:()=>D("nodeBackground",U.value)}))}]},{label:"Alignment",submenu:()=>[...T.map(U=>({label:U.label,onClick:()=>D("nodeTextAlign",U.value)})),{type:"separator"},..._.map(U=>({label:U.label,onClick:()=>D("nodeVerticalAlign",U.value)}))]},{type:"separator"},{label:"Insert column left",onClick:()=>{v();let U=Math.max(0,Number(k||0));J(vt?.addColumnBefore)&&window.requestAnimationFrame(()=>{try{Vi(S,{insertIndex:U,newColPct:10})}catch{let se=un(S.view);Ui(se)}})}},{label:"Insert column right",onClick:()=>{v();let U=Math.max(0,Number(k||0)+1);J(vt?.addColumnAfter)&&window.requestAnimationFrame(()=>{try{Vi(S,{insertIndex:U,newColPct:10})}catch{let se=un(S.view);Ui(se)}})}},{label:"Sort ",submenu:()=>[{label:"Sort row A-Z",onClick:F(()=>Nd(S,{direction:"asc"}))},{label:"Sort row Z-A",onClick:F(()=>Nd(S,{direction:"desc"}))}]},{label:"Header column",onClick:()=>J(vt?.toggleHeaderColumn)},{label:"Move ",submenu:()=>[{label:"Move column up",disabled:!0,onClick:()=>{}},{label:"Move column down",disabled:!0,onClick:()=>{}},{label:"Move column left",onClick:F(()=>Td(S,-1))},{label:"Move column right",onClick:F(()=>Td(S,1))}]},{label:"Duplicate column",onClick:F(()=>Dm(S))},{label:"Delete column",onClick:()=>{v();let U=un(S.view),Z=co(U),se=Number.isFinite(Number(k))?Number(k):null,he=Z&&se!=null?eu(Z,se):null;J(vt?.deleteColumn)&&Array.isArray(he)&&window.requestAnimationFrame(()=>{let Ie=un(S.view);lo(Ie,he)})}},{type:"separator"},{label:"Clear column contents",onClick:()=>{v(),S.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:C,items:K,level:0})}}return[new x({view(B){let C=new O(B);return C.update(B),{update(k){C.update(k)},destroy(){C.destroy()}}}})]}}),Ge=Nr()?performance.now():0;if(ie){gr("outline.mount.remountDetected",{outlineArticleId:wt,hadInstance:!0});try{ie.destroy()}catch{}ie=null}ie=new c({element:e,extensions:[Hn,me,pe,Tt,Tn,zt,Y,ce,tt,Lt,Se,Qe,ct,fn,Rn,Sn,vn,Vn,On,Xe,Q.configure({types:["outlineSection"],attributeName:"id",generateID:()=>en()}),w.configure({document:!1,heading:!1,link:!1}),$.configure({openOnClick:!1,protocols:Mi}),de,_t,Ye,ye,X.configure({table:{resizable:!0}}),Ce,Re,_e,Ve,dt].filter(Boolean),content:ft,editorProps:{attributes:{class:"outline-prosemirror"},handleKeyDown(S,g){try{if(te?.isOpen?.()&&te.isOpen()&&!!te.handleKeyDown?.(g))return!0}catch{}try{if((g?.ctrlKey||g?.metaKey)&&!g?.shiftKey&&!g?.altKey&&(String(g?.key||"").toLowerCase()==="v"||String(g?.code||"")==="KeyV")&&!u.isPublicView&&!((Ee?.getState?.(S.state)||null)?.editingSectionId||null)){let D=La();if(D&&Array.isArray(D.sections)&&D.sections.length){g.preventDefault(),g.stopPropagation();let F=S.state,K=F.selection?.$from||null,U=K?Mt(F.doc,K):null,Z=typeof U=="number"?F.doc.nodeAt(U):null,se=F.doc.content.size;typeof U=="number"&&Z&&(se=U+Z.nodeSize);let he=new Set;try{F.doc.descendants(xe=>{if(xe?.type?.name!=="outlineSection")return;let qe=String(xe.attrs?.id||"").trim();qe&&he.add(qe)})}catch{}let be=[];if(D.mode==="copy")for(let xe of D.sections)be.push(Vd(xe,()=>en()));else for(let xe of D.sections){let qe=String(xe?.attrs?.id||"").trim();if(qe&&he.has(qe))return ve("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C: \u0431\u043B\u043E\u043A \u0441 \u0442\u0430\u043A\u0438\u043C id \u0443\u0436\u0435 \u0435\u0441\u0442\u044C"),!0;be.push(Ha(xe))}let Ie=F.doc.type.schema,ge=[];for(let xe of be)try{let qe=Ie.nodeFromJSON(xe);qe?.type?.name==="outlineSection"&&ge.push(qe)}catch{}if(!ge.length)return ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438"),!0;let He=F.tr,Be=se;for(let xe of ge)He=He.insert(Be,xe),Be+=xe.nodeSize;return He=He.setMeta(ue,!0),S.dispatch(He.scrollIntoView()),on=!0,rn({delayMs:200}),D.mode==="cut"&&$i(null),so(!1),ve(`\u0412\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${ge.length}`),!0}}}catch{}try{let k=g&&!g.defaultPrevented&&!g.isComposing&&!g.metaKey&&!g.ctrlKey&&!g.altKey,M=k&&String(g?.key||"")==="\\",v=k&&(String(g?.code||"")==="Backslash"||String(g?.code||"")==="IntlBackslash");if(M){g.preventDefault();let{from:D,to:F}=S.state.selection,J=S.state.tr.insertText("\\",D,F).setMeta(ue,!0);return S.dispatch(J),!0}if(v)try{window?.localStorage?.getItem?.("ttree_outline_debug_tag_v1")==="1"&&console.log("[outline][tag-debug] backslash-code",{key:String(g?.key||""),code:String(g?.code||""),shiftKey:!!g?.shiftKey,altKey:!!g?.altKey,ctrlKey:!!g?.ctrlKey,metaKey:!!g?.metaKey})}catch{}}catch{}if(g&&g.__memusSyntheticAltProxy)return!1;let E="ttree_outline_debug_alt_v1",T=()=>{try{return window?.localStorage?.getItem?.(E)==="1"}catch{return!1}},_=k=>{try{return!!k?.getModifierState?.("AltGraph")}catch{return!1}};((k,M)=>{try{if(!T())return;let v=String(k?.key||""),D=String(k?.code||"");if(!v.startsWith("Arrow")&&D!=="Enter"&&D!=="NumpadEnter")return;let F={altKey:!!k?.altKey,ctrlKey:!!k?.ctrlKey,metaKey:!!k?.metaKey,shiftKey:!!k?.shiftKey,altGraph:_(k),repeat:!!k?.repeat,location:k?.location??null},J=[];F.metaKey&&J.push("Meta"),F.ctrlKey&&J.push("Ctrl"),F.altKey&&J.push(F.altGraph?"AltGraph":"Alt"),F.shiftKey&&J.push("Shift"),J.push(D||v||"?"),console.log("[outline][alt-debug]",M,{key:v,code:D,name:J.join("-"),...F})}catch{}})(g,"keydown");let P=k=>{try{return!!k?.getModifierState?.("AltGraph")}catch{return!1}},H=k=>{try{return(!!k?.altKey||P(k))&&!k?.metaKey&&(!k?.ctrlKey||P(k))}catch{return!1}},O="ttree_outline_debug_nav_v1",B=()=>{try{return window?.localStorage?.getItem?.(O)==="1"}catch{return!1}},C=(k,M)=>{if(B())try{console.log("[outline][nav-debug]",k,M)}catch{}};try{let M=(Ee?.getState?.(S.state)||null)?.editingSectionId||null;C("keydown",{key:String(g?.key||""),code:String(g?.code||""),altKey:!!g?.altKey,altGraph:!!_(g),ctrlKey:!!g?.ctrlKey,metaKey:!!g?.metaKey,shiftKey:!!g?.shiftKey,repeat:!!g?.repeat,editingSectionId:M?String(M):null,selection:{empty:!!S.state?.selection?.empty,parent:S.state?.selection?.$from?.parent?.type?.name||null,parentOffset:S.state?.selection?.$from?.parentOffset??null,pos:S.state?.selection?.$from?.pos??null}});try{let K=(se,he,be)=>{try{let Ie=Je?.pmStateMod?.TextSelection;if(!Ie)return!1;let ge=se.doc.nodeAt(be);if(!ge||ge.type?.name!=="outlineSection")return!1;let He=ge.child(0),xe=be+1+1,qe=se.tr;return qe=qe.setSelection(Ie.near(qe.doc.resolve(xe),1)),he(qe.scrollIntoView()),!0}catch{return!1}},U=String(g?.key||""),Z=!g?.shiftKey&&!g?.metaKey&&!g?.ctrlKey&&!g?.altKey&&!_(g);if(!M&&Z&&(U==="ArrowUp"||U==="ArrowDown")){let se=S.state,he=Mt(se.doc,se.selection.$from);if(C("nav.check",{key:U,sectionPos:he}),typeof he=="number"){let be=(Be,xe)=>{try{let qe=Be.resolve(Math.min(Be.content.size,Math.max(0,xe+1)));for(let We=qe.depth;We>0;We-=1){let ut=qe.node(We);if(!(ut?.type?.name!=="outlineSection"||qe.before(We)===xe)&&ut.attrs?.collapsed)return!1}return!0}catch{return!0}},He=U==="ArrowUp"?((Be,xe)=>{let qe=null;return Be.nodesBetween(0,xe,(We,ut)=>{if(ut>=xe)return!1;We?.type?.name==="outlineSection"&&be(Be,ut)&&(qe=ut)}),qe})(se.doc,he):((Be,xe)=>{let qe=null;return Be.nodesBetween(xe+1,Be.content.size,(We,ut)=>{if(qe!==null)return!1;ut<=xe||We?.type?.name==="outlineSection"&&be(Be,ut)&&(qe=ut)}),qe})(se.doc,he);if(C("nav.target",{key:U,sectionPos:he,target:He}),typeof He=="number"){let Be=K(se,S.dispatch,He);if(C("nav.apply",{ok:Be}),Be)return g.preventDefault(),g.stopPropagation(),!0}}}}catch{}let v=!!_(g)&&!g?.altKey&&!g?.ctrlKey&&!g?.metaKey&&!g?.shiftKey,D=String(g?.key||""),F=String(g?.code||"");if(!M&&v&&(D==="ArrowUp"||D==="ArrowDown"||D==="ArrowLeft"||D==="ArrowRight")){let K=null;try{K=new KeyboardEvent("keydown",{key:D,code:F||D,altKey:!0,ctrlKey:!1,metaKey:!1,shiftKey:!1,bubbles:!0,cancelable:!0});try{Object.defineProperty(K,"__memusSyntheticAltProxy",{value:!0})}catch{}}catch{K=null}if(K||(K={key:D,code:F||D,altKey:!0,ctrlKey:!1,metaKey:!1,shiftKey:!1,bubbles:!0,cancelable:!0,__memusSyntheticAltProxy:!0,preventDefault(){},stopPropagation(){},getModifierState(Z){return!1}}),!!S?.someProp?.("handleKeyDown",Z=>Z(S,K)))return g.preventDefault(),g.stopPropagation(),!0}}catch{}try{if(H(g)){let k=String(g.key||"");if((k==="ArrowUp"||k==="ArrowDown")&&g.repeat){let M=S?.state?.selection?.$from}}}catch{}st("editorProps.keydown",{key:g?.key||null,repeat:!!g?.repeat,selection:{empty:!!S.state?.selection?.empty,parent:S.state?.selection?.$from?.parent?.type?.name||null,parentOffset:S.state?.selection?.$from?.parentOffset??null,pos:S.state?.selection?.$from?.pos??null}});try{let k=Je?.pmStateMod?.TextSelection;if(k){let v=(Ee?.getState?.(S.state)||null)?.editingSectionId||null,D=(g.key==="Enter"||g.code==="Enter"||g.code==="NumpadEnter")&&(g.ctrlKey||g.metaKey)&&!g.shiftKey&&!g.altKey;if(!u.isPublicView&&!v&&D){let F=S.state.selection,J=F?.$from||null;if(J){let K=Mt(S.state.doc,J),U=typeof K=="number"?S.state.doc.nodeAt(K):null;if(typeof K=="number"&&U?.type?.name==="outlineSection"){let Z=!!(F&&F.empty),se=J.parent?.type?.name==="outlineHeading",be=Z&&se&&J.parentOffset===0?K:K+U.nodeSize,Ie=S.state.schema,ge=en(),He=Ie.nodes.outlineSection.create({id:ge,collapsed:!1},[Ie.nodes.outlineHeading.create({},[]),Ie.nodes.outlineBody.create({},[Ie.nodes.paragraph.create({},[])]),Ie.nodes.outlineChildren.create({},[])]),Be=S.state.tr.insert(be,He);try{let qe=Be.doc.nodeAt(be)?.child?.(0)||He.child(0),We=be+1+qe.nodeSize;Be=Be.setSelection(k.near(Be.doc.resolve(We+2),1))}catch{Be=Be.setSelection(k.create(Be.doc,be+2))}Be=Be.setMeta(ue,!0),Ee&&(Be=Be.setMeta(Ee,{type:"enter",sectionId:ge})),S.dispatch(Be.scrollIntoView());try{S.focus()}catch{}return g.preventDefault(),g.stopPropagation(),!0}}}}}catch{}try{let k=H(g)&&!g.shiftKey,M=String(g.key||"");if(k&&(M==="ArrowLeft"||M==="ArrowRight"||M==="ArrowUp"||M==="ArrowDown")&&(Ee?.getState?.(S.state)||null)?.editingSectionId&&ie){let D=()=>{try{let F=S?.state?.selection?.$from||null;if(!F)return!1;for(let J=F.depth;J>0;J-=1){let K=F.node(J)?.type?.name;if(K==="table"||K==="tableRow"||K==="tableCell"||K==="tableHeader")return!0}return!1}catch{return!1}};if(M==="ArrowLeft"||M==="ArrowRight"){let F=ie.chain().focus();F.command(({tr:K})=>(K.setMeta(ue,!0),!0));let J=!1;if(ie.isActive("bulletList")||ie.isActive("orderedList")?M==="ArrowRight"?J=F.sinkListItem("listItem").run():(J=F.liftListItem("listItem").run(),!J&&ie.isActive("bulletList")&&(J=F.toggleBulletList().run()),!J&&ie.isActive("orderedList")&&(J=F.toggleOrderedList().run())):M==="ArrowRight"&&(J=F.toggleBulletList().run()),J)return g.preventDefault(),g.stopPropagation(),!0}else if((M==="ArrowUp"||M==="ArrowDown")&&(M==="ArrowUp"?Pd(ie,-1)||Ld(ie,-1):Pd(ie,1)||Ld(ie,1)))return g.preventDefault(),g.stopPropagation(),!0}}catch{}try{if((g.ctrlKey||g.metaKey)&&!g.altKey&&!g.shiftKey&&(g.code==="KeyA"||String(g.key||"").toLowerCase()==="a")){let M=Je?.pmStateMod?.TextSelection;if(!M)return st("editorProps.modA",{handled:!1,reason:"no-TextSelection"}),!1;let v=S.state,D=v.selection,F=D?.$from||null;if(!F)return st("editorProps.modA",{handled:!1,reason:"no-$from"}),!1;let J=Mt(v.doc,F);if(typeof J!="number")return st("editorProps.modA",{handled:!1,reason:"no-sectionPos"}),!1;let K=v.doc.nodeAt(J);if(!K||K.type?.name!=="outlineSection")return st("editorProps.modA",{handled:!1,reason:"not-outlineSection"}),!1;let U=K.child(0),Z=K.child(1);if(!U||!Z)return st("editorProps.modA",{handled:!1,reason:"missing-heading/body"}),!1;let se=J+1,he=se+1,be=se+U.nodeSize-1,Ie=J+1+U.nodeSize,ge=Ie+1,He=Ie+Z.nodeSize-1,Be=He;try{let at=null;v.doc.nodesBetween(ge,Math.min(v.doc.content.size,He),(It,Ot)=>{It?.isTextblock&&(at=Ot+It.nodeSize-1)}),typeof at=="number"&&(Be=at)}catch{}Be<ge&&(Be=be);let xe=he,qe=(()=>{try{for(let at=F.depth;at>0;at-=1)if(F.node(at)?.type?.name==="outlineHeading")return!0}catch{}return!1})(),We=!!D&&typeof D.from=="number"&&typeof D.to=="number"&&Math.min(D.from,D.to)===xe&&Math.max(D.from,D.to)===Be;if(qe&&We)return st("editorProps.modA",{handled:!1,reason:"pass-through-doc-select"}),!1;g.preventDefault(),g.stopPropagation();let ut=M.create(v.doc,xe,Be);return S.dispatch(v.tr.setSelection(ut)),st("editorProps.modA",{handled:!0,blockFrom:xe,blockTo:Be,isInHeading:qe,alreadySelectedBlock:We}),!0}}catch{}try{if(!Ee)return!1;let M=(Ee.getState(S.state)||{}).editingSectionId||null;if(!M){let v=(g.ctrlKey||g.metaKey)&&!g.altKey&&!g.shiftKey&&(g.key==="Delete"||g.key==="Del"||g.key==="Backspace"),D=g.key==="Backspace"||g.key==="Delete",F=g.key&&g.key.length===1&&!g.metaKey&&!g.ctrlKey&&!g.altKey,J=!g.metaKey&&!g.ctrlKey&&!g.altKey&&!g.shiftKey&&(g.key===" "||g.key==="Spacebar");if(v){let K=Mt(S.state.doc,S.state.selection.$from),U=!1;try{typeof K=="number"&&(U=Te(S.state,S.dispatch,K))}catch{U=!1}return st("editorProps.modDelete",{ok:U,sectionPos:K}),g.preventDefault(),g.stopPropagation(),!0}if(J){let K=document.activeElement;if(!(!!(K&&K.closest&&K.closest(".outline-editor"))||!!(g?.target&&g.target.closest&&g.target.closest(".outline-editor"))))return!1;if(g.repeat)return g.preventDefault(),g.stopPropagation(),!0;let Z=g?.target||null,se=String(Z?.tagName||"").toLowerCase();if(se==="button"||se==="input"||se==="textarea"||se==="select"||Z?.closest?.("button, a[href], input, textarea, select")||!!!Z?.closest?.(".outline-prosemirror")&&Z?.closest?.('[contenteditable="true"]'))return!1;let be=Mt(S.state.doc,S.state.selection.$from);if(typeof be!="number")return g.preventDefault(),g.stopPropagation(),!0;let Ie=S.state.doc.nodeAt(be);if(!Ie)return g.preventDefault(),g.stopPropagation(),!0;let ge=!Ie.attrs?.collapsed,He=S.state.tr.setNodeMarkup(be,void 0,{...Ie.attrs,collapsed:ge});He=He.setMeta(ue,!0);try{let Be=Ie.child(0),qe=be+1+Be.nodeSize-1,{TextSelection:We}=Je?.pmStateMod||{};We&&(He=He.setSelection(We.near(He.doc.resolve(qe),-1)))}catch{}return g.preventDefault(),g.stopPropagation(),S.dispatch(He.scrollIntoView()),!0}if(D){if(g.key==="Backspace")try{let K=S.state,U=K.selection,Z=U?.$from||null,se=null;try{for(let Ie=Z?.depth||0;Ie>0;Ie-=1)if(Z.node(Ie)?.type?.name==="outlineHeading"){se=Ie;break}}catch{se=null}let he=se!==null&&Z?Z.start(se):null,be=!!(U&&U.empty)&&!!Z&&se!==null&&typeof he=="number"&&Z.pos===he;if(st("editorProps.backspace.check",{empty:!!U?.empty,headingDepth:se,headingStart:he,pos:Z?.pos??null,parent:Z?.parent?.type?.name||null,parentOffset:Z?.parentOffset??null,atHeadingStart:be}),be){let Ie=Mt(K.doc,Z),ge=typeof Ie=="number"?K.doc.nodeAt(Ie):null;if(st("editorProps.backspace.sectionPos",{sectionPos:Ie,hasNode:!!ge}),typeof Ie=="number"&&ge){let He=String(ge.attrs?.id||""),Be=null;try{let qe=K.doc.resolve(Ie),We=qe.index(),ut=qe.parent;if(ut&&We>0){let at=ut.child(We-1),It=Ie-at.nodeSize,Ot=K.doc.nodeAt(It);Be=String(Ot?.attrs?.id||"")||null}else for(let at=Z.depth-1;at>0;at-=1){let It=Z.node(at);if(It?.type?.name==="outlineSection"){let Ot=String(It.attrs?.id||"");if(Ot&&Ot!==He){Be=Ot;break}}}}catch{Be=null}st("editorProps.backspace.mergeCandidate",{sectionPos:Ie,currentSectionId:He,targetSectionId:Be});let xe=!1;if(ke(ge))xe=Te(K,S.dispatch,Ie);else try{K.doc.resolve(Ie).index()<=0?xe=Ne(K,S.dispatch,Ie):xe=ne(K,S.dispatch,Ie)}catch{xe=ne(K,S.dispatch,Ie)}return st("editorProps.backspace.mergeDone",{ok:xe,targetSectionId:Be}),xe&&Be&&Ee&&window.setTimeout(()=>{try{if((Ee.getState(S.state)||{}).editingSectionId)return;let We=St(S.state.doc,Be),ut=typeof We=="number"?S.state.doc.nodeAt(We):null;if(!ut)return;let at=S.state.tr;ut?.attrs?.collapsed&&(at=at.setNodeMarkup(We,void 0,{...ut.attrs,collapsed:!1}),at=at.setMeta(ue,!0)),at=at.setMeta(Ee,{type:"enter",sectionId:Be});try{let It=at.doc.nodeAt(We);if(It&&It.type?.name==="outlineSection"){let Ot=It.child(0),Gt=It.child(1),G=We+1+Ot.nodeSize+Gt.nodeSize-1;at=at.setSelection(y.near(at.doc.resolve(G),-1))}}catch{}S.dispatch(at.scrollIntoView());try{S.focus()}catch{}st("editorProps.backspace.enterEdit.done",{targetSectionId:Be})}catch{}},0),g.preventDefault(),g.stopPropagation(),!0}}}catch{}return g.preventDefault(),g.stopPropagation(),!0}if(F)return g.preventDefault(),g.stopPropagation(),Xn(),!0}if(u.isPublicView&&!M&&(g.key==="Enter"&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey&&!g.altKey||g.key==="F2"&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey&&!g.altKey))return g.preventDefault(),g.stopPropagation(),!0;if(!M&&(g.key==="Enter"&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey&&!g.altKey||g.key==="F2"&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey&&!g.altKey)){let v=Mt(S.state.doc,S.state.selection.$from);if(typeof v!="number")return!1;let D=S.state.doc.nodeAt(v),F=String(D?.attrs?.id||"");if(!F)return!1;if(g.preventDefault(),g.stopPropagation(),D?.attrs?.collapsed){let J=S.state.tr.setNodeMarkup(v,void 0,{...D.attrs,collapsed:!1});return J.setMeta(ue,!0),S.dispatch(J.scrollIntoView()),!0}return S.dispatch(S.state.tr.setMeta(Ee,{type:"enter",sectionId:F})),!0}if(M&&g.key==="Escape"){g.preventDefault(),g.stopPropagation();let v=M;S.dispatch(S.state.tr.setMeta(Ee,{type:"exit"}));try{let D=ie;if(D&&!D.isDestroyed){let F=Lr(S.state.doc,v);Hd(D,S.state.doc,v),F&&rn({delayMs:350})}}catch{}return!0}}catch{}return!1},handleDOMEvents:{click(S,g){try{let E=g.target?.closest?.("a[href]");if(!E||!Ee)return!1;let T=String(E.getAttribute("href")||"").trim();if(!T)return!1;if(u.isPublicView){let C=String(E.getAttribute("rel")||"").split(/\s+/).filter(Boolean);if(E.getAttribute("data-unpublished")==="1"||C.includes("unpublished")||T==="#")return alert("\u042D\u0442\u0430 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435 \u043E\u043F\u0443\u0431\u043B\u0438\u043A\u043E\u0432\u0430\u043D\u0430"),g.preventDefault(),g.stopPropagation(),!0}if(T.startsWith("app:/")||T.startsWith("disk:/")){g.preventDefault(),g.stopPropagation();let B=jn(T);if(B)return window.open(B,"_blank","noopener,noreferrer"),!0}if((Ee.getState(S.state)||{}).editingSectionId||null)return!1;let P=B=>{let C=String(B||"").trim();if(!C||C.startsWith("/")||C.startsWith("#")||/\s/.test(C)||C.includes("://")||/^[a-z][a-z0-9+.-]*:/i.test(C))return!1;let k=C.split(/[/?#]/,1)[0];return!(!k||!k.includes(".")||k.startsWith(".")||k.endsWith(".")||k.includes(".."))},H=B=>{let C=String(B||"").trim();return C&&(C.startsWith("//")?`https:${C}`:P(C)?`https://${C}`:C)};if(g.preventDefault(),g.stopPropagation(),T.startsWith("/"))return u.isPublicView?(window.location.href=T,!0):(kn(T),!0);let O=H(T);return/^https?:\/\//i.test(O)||/^mailto:/i.test(O)||/^tel:/i.test(O),window.open(O,"_blank","noopener,noreferrer"),!0}catch{return!1}},beforeinput(S,g){try{if(!Ee)return!1;let T=(Ee.getState(S.state)||{}).editingSectionId||null;if(T)return!1;let _=String(g?.inputType||"");if(_.startsWith("history"))return!1;if(st("beforeinput",{inputType:_,key:g?.data??null,editingSectionId:T||null,selection:{empty:!!S.state?.selection?.empty,parent:S.state?.selection?.$from?.parent?.type?.name||null,parentOffset:S.state?.selection?.$from?.parentOffset??null}}),_==="deleteContentBackward"){try{let R=S.state,P=R.selection,H=P?.$from||null,O=null;try{for(let k=H?.depth||0;k>0;k-=1)if(H.node(k)?.type?.name==="outlineHeading"){O=k;break}}catch{O=null}let B=O!==null&&H?H.start(O):null,C=!!(P&&P.empty)&&!!H&&O!==null&&typeof B=="number"&&H.pos===B;if(st("beforeinput.deleteContentBackward.check",{empty:!!P?.empty,headingDepth:O,headingStart:B,pos:H?.pos??null,parent:H?.parent?.type?.name||null,parentOffset:H?.parentOffset??null,atHeadingStart:C}),C){let k=Mt(R.doc,H),M=typeof k=="number"?R.doc.nodeAt(k):null;if(typeof k=="number"&&M){let v=String(M.attrs?.id||"");st("beforeinput.deleteContentBackward.candidate",{sectionPos:k,currentSectionId:v});let D=null;try{let J=R.doc.resolve(k),K=J.index(),U=J.parent;if(U&&K>0){let Z=U.child(K-1),se=k-Z.nodeSize,he=R.doc.nodeAt(se);D=String(he?.attrs?.id||"")||null}else for(let Z=H.depth-1;Z>0;Z-=1){let se=H.node(Z);if(se?.type?.name==="outlineSection"){let he=String(se.attrs?.id||"");if(he&&he!==v){D=he;break}}}}catch{D=null}let F=!1;if(ke(M))st("beforeinput.merge",{kind:"deleteEmpty",sectionPos:k}),F=Te(R,S.dispatch,k);else try{R.doc.resolve(k).index()<=0?(st("beforeinput.merge",{kind:"intoParent",sectionPos:k,targetSectionId:D}),F=Ne(R,S.dispatch,k)):(st("beforeinput.merge",{kind:"intoPrev",sectionPos:k,targetSectionId:D}),F=ne(R,S.dispatch,k))}catch{st("beforeinput.merge",{kind:"intoPrev.catch",sectionPos:k,targetSectionId:D}),F=ne(R,S.dispatch,k)}return st("beforeinput.merge.done",{ok:F,targetSectionId:D}),F&&D&&window.setTimeout(()=>{try{if((Ee.getState(S.state)||{}).editingSectionId)return;let K=St(S.state.doc,D),U=typeof K=="number"?S.state.doc.nodeAt(K):null;if(!U)return;let Z=S.state.tr;U?.attrs?.collapsed&&(Z=Z.setNodeMarkup(K,void 0,{...U.attrs,collapsed:!1}),Z=Z.setMeta(ue,!0)),Z=Z.setMeta(Ee,{type:"enter",sectionId:D});try{let se=S.state.doc.nodeAt(K);if(se&&se.type?.name==="outlineSection"){let he=se.child(0),be=K+1+he.nodeSize,Ie=Math.min(Z.doc.content.size,be+2);Z=Z.setSelection(y.create(Z.doc,Ie))}}catch{}S.dispatch(Z.scrollIntoView());try{S.focus()}catch{}st("beforeinput.enterEdit.done",{targetSectionId:D})}catch{}},0),g.preventDefault(),g.stopPropagation(),!0}}}catch{}return st("beforeinput.deleteContentBackward.block",{inputType:_}),g.preventDefault(),g.stopPropagation(),!0}return _.startsWith("delete")?(st("beforeinput.delete.block",{inputType:_}),g.preventDefault(),g.stopPropagation(),!0):(g.preventDefault(),g.stopPropagation(),Xn(),!0)}catch{return!1}},dblclick(S,g){try{if(u.isPublicView||!Ee||(Ee.getState(S.state)||{}).editingSectionId||null)return!1;let _=g?.target&&g.target.closest&&g.target.closest('[data-outline-heading="true"]')||g?.target&&g.target.closest&&g.target.closest(".outline-heading"),R=g?.target&&g.target.closest&&g.target.closest('[data-outline-body="true"]')||g?.target&&g.target.closest&&g.target.closest(".outline-body");if(!_&&!R)return!1;let P={left:g.clientX,top:g.clientY},H=S.posAtCoords(P),O=H&&typeof H.pos=="number"?H.pos:null;if(typeof O!="number")return!1;let B=S.state.doc.resolve(Math.max(0,Math.min(S.state.doc.content.size,O))),C=Mt(S.state.doc,B);if(typeof C!="number")return!1;let k=S.state.doc.nodeAt(C),M=String(k?.attrs?.id||"");if(!M)return!1;window.setTimeout(()=>{try{if((Ee.getState(S.state)||{}).editingSectionId)return;let D=St(S.state.doc,M),F=typeof D=="number"?S.state.doc.nodeAt(D):null,J=!!F?.attrs?.collapsed,K=S.state.tr;if(J&&typeof D=="number"&&F&&(K=K.setNodeMarkup(D,void 0,{...F.attrs,collapsed:!1}),K=K.setMeta(ue,!0)),J){S.dispatch(K.scrollIntoView());try{S.focus()}catch{}return}K=K.setMeta(Ee,{type:"enter",sectionId:M});try{let{TextSelection:U}=Je?.pmStateMod||{},Z=typeof D=="number"?K.doc.nodeAt(D):null;if(Z&&Z.type?.name==="outlineSection"){let se=Z.child(0),he=D+1+se.nodeSize,be=Math.min(K.doc.content.size,he+2);U&&(K=K.setSelection(U.near(K.doc.resolve(be),1)))}}catch{}S.dispatch(K.scrollIntoView());try{S.focus()}catch{}}catch{}},0)}catch{}return!1}}},onCreate:({editor:S})=>{if(mt&&u.articleId&&u.article&&!u.article.encrypted)try{let g=S.getJSON();u.article.docJson=g,Bc(u.articleId,g).catch(()=>{})}catch{}try{Qm(S.state.doc)}catch{}Rr.clear();try{ao.clear()}catch{}on=!1,$d=null,bn=null;try{Fi=Ed(S.state.doc),qn=!1;try{Mn.clear()}catch{Mn.clear()}Vt&&(clearTimeout(Vt),Vt=null)}catch{}rr("")},onUpdate:()=>{on=!0;try{let S=Ee?.getState?.(ie?.state)||null,g=String(S?.editingSectionId||"").trim();if(g){let E=ie?.state?.doc||null;E&&Lr(E,g)&&pm(ie)}}catch{}try{let S=ie?.state?.doc||null;if(S){let g=Ed(S);g&&g!==Fi&&(Fi=g,fm({articleId:wt||u.articleId,editor:ie}))}}catch{}try{_d(ie)}catch{}rn({delayMs:1500})},onSelectionUpdate:({editor:S})=>{let{state:g}=S,{selection:E}=g;if(!E)return;let T=Mt(g.doc,E.$from);if(typeof T!="number")return;let _=g.doc.nodeAt(T),R=String(_?.attrs?.id||"");if(!R)return;try{let O=(Ee?.getState?.(g)||null)?.editingSectionId||null;O&&O!==R&&S.view.dispatch(g.tr.setMeta(Ee,{type:"exit"}))}catch{}if(bn&&bn!==R){let H=Lr(g.doc,bn);try{Kt("leave_section",{from:bn,to:R,changed:H})}catch{}try{ao.has(bn)&&Hd(S,g.doc,bn)}catch{}H&&rn({delayMs:350})}let P=bn;bn=R;try{_d(S)}catch{}try{(Ee?.getState?.(g)||null)?.editingSectionId||Jm(S,{lines:5})}catch{}}}),Ge&&io("new Editor()",{ms:Math.round(performance.now()-Ge)});try{let S=ie?.state?.doc?.content?.size??null;gr("outline.mount.editorCreated",{outlineArticleId:wt,docSize:S})}catch{}try{(wt||u.articleId)&&(cm(wt||u.articleId),navigator.onLine&&qd(wt||u.articleId))}catch{}e.focus?.({preventScroll:!0}),ji=S=>{try{if(!ie)return;let g=ie.state.tr.setMeta(Pe,{activeKey:S||null});ie.view.dispatch(g)}catch{}};try{Gd()}catch{}try{let S=Nr()?performance.now():0;Em(ie),S&&io("convertMarkdownTablesInOutlineDoc()",{ms:Math.round(performance.now()-S)})}catch{}t&&io("mountOutlineEditor() total",{ms:Math.round(performance.now()-t)})})();try{await _o}finally{_o=null,gr("outline.mount.done",{outlineArticleId:wt,hasInstance:!!ie})}}function $o(e=""){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}async function th(e={}){if(u.isPublicView||!u.articleId||!u.article||!ie)return;let t=wt||u.articleId;if(!t)return;let n=!!e.silent,r=e&&typeof e.mode=="string"?e.mode:"network",o=Array.from(new Set([...Rr||[],bn].filter(Boolean))),i=(s,a)=>{let c=s?String(s):"",l=a?String(a):"";return c?l?c>=l?c:l:c||null:l||null};try{if(n||ts("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C outline\u2026"),u.article.encrypted){n||(Ar(),ve("Outline-\u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u0435 docJson \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0434\u043B\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0445 \u0441\u0442\u0430\u0442\u0435\u0439"));return}let s=ie.getJSON(),a=am(s);if(u.articleId&&t!==u.articleId){await xn(t,a,u.article?.updatedAt||null).catch(()=>{}),n||Ar(),rr("\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0447\u0435\u0440\u043D\u043E\u0432\u0438\u043A \u0441\u043E\u0445\u0440\u0430\u043D\u0451\u043D \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E");return}let c=Date.now();await xn(t,a,u.article?.updatedAt||null).catch(()=>{});try{bn&&Lr(ie.state.doc,bn)}catch{}if(!0){let d=Mn.size?Array.from(Mn):[];try{d.length&&(Mn.clear(),await cn("delete_sections",{articleId:t,payload:{sectionIds:d,clientQueuedAt:c},coalesceKey:`delete:${t}`}))}catch{}n||Ar(),u.article&&(u.article.docJson=a),on=!1,$d=new Date,rr("\u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E");try{Gd()}catch{}try{eh(ie,ie.state.doc,o)}catch{}return}}catch(s){n?rr("\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F"):(Ar(),ve(s?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C outline"));try{let a=ie.getJSON();a&&typeof a=="object"&&await xn(t,a,u.article?.updatedAt||null).catch(()=>{})}catch{}rn({delayMs:5e3})}}function nh(){return bn||null}function rh(){try{if(!ie||ie.isDestroyed)return null;let e=ie.state,t=Mt(e.doc,e.selection.$from);if(typeof t!="number")return null;let n=e.doc.nodeAt(t);if(!n||n.type?.name!=="outlineSection")return null;let r=String(n.attrs?.id||"").trim();return r?{sectionId:r,collapsed:!!n.attrs?.collapsed}:null}catch{return null}}function oh(e,t){try{let n=String(t||"");if(!e||!n)return null;let r=(i,s,a)=>{if(!i||i.type?.name!=="outlineSection")return null;let c=String(i.attrs?.id||""),l=[...a,s];if(c===n)return l;let d=i.child(0),m=i.child(1),h=i.child(2);if(!h||h.type?.name!=="outlineChildren")return null;let w=s+1+d.nodeSize+m.nodeSize+1;for(let f=0;f<h.childCount;f+=1){let p=h.child(f),y=w;w+=p.nodeSize;let x=r(p,y,l);if(x)return x}return null},o=0;for(let i=0;i<e.childCount;i+=1){let s=e.child(i),a=o;o+=s.nodeSize;let c=r(s,a,[]);if(c)return c}return null}catch{return null}}function du(e,t={}){try{if(!ie||ie.isDestroyed)return!1;let n=String(e||"");if(!n)return!1;let{state:r,view:o}=ie,i=Je?.pmStateMod?.TextSelection,s=oh(r.doc,n);if(!Array.isArray(s)||!s.length)return!1;let a=r.tr;for(let c of s){let l=a.doc.nodeAt(c);!l||l.type?.name!=="outlineSection"||l.attrs?.collapsed&&(a=a.setNodeMarkup(c,void 0,{...l.attrs,collapsed:!1}))}a=a.setMeta(ue,!0);try{let c=St(a.doc,n),l=typeof c=="number"?a.doc.nodeAt(c):null;if(typeof c=="number"&&l?.type?.name==="outlineSection"){let d=l.child(0),m=c+1+d.nodeSize,h=Math.min(a.doc.content.size,m+2);i&&(a=a.setSelection(i.create(a.doc,h)))}}catch{}o.dispatch(a.scrollIntoView());try{let c=typeof CSS<"u"&&CSS.escape?CSS.escape(n):n.replace(/"/g,'\\"');window.requestAnimationFrame(()=>{try{let l=o.dom?.querySelector?.(`[data-outline-section][data-section-id="${c}"]`)||o.dom?.querySelector?.(`[data-section-id="${c}"]`);l&&typeof l.scrollIntoView=="function"&&l.scrollIntoView({block:"center",inline:"nearest"})}catch{}})}catch{}if(t&&t.focus)try{o.focus()}catch{}return!0}catch{return!1}}function ih(e,t){if(!ie)return!1;let n=String(e||"");if(!n)return!1;let r=St(ie.state.doc,n);if(typeof r!="number")return!1;let o=ie.state.doc.nodeAt(r);if(!o)return!1;let i=ie.state.doc.type.schema,s=Gn(String(t||"")),a=Da(s.titleHtml||"")||Da(s.bodyHtml||"").slice(0,80)||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",c=Fo?Fo(s.bodyHtml||""):[],l=[];for(let f of c||[])try{l.push(i.nodeFromJSON(f))}catch{}l.length||l.push(i.nodes.paragraph.create({},[]));let d=i.nodes.outlineHeading.create({},a?[i.text(a)]:[]),m=i.nodes.outlineBody.create({},l),h=o.child(2),b=i.nodes.outlineSection.create(o.attrs,[d,m,h]),w=ie.state.tr.replaceWith(r,r+o.nodeSize,b);try{let f=Je?.pmStateMod?.TextSelection;f&&(w=w.setSelection(f.create(w.doc,r+2)))}catch{}return ie.view.dispatch(w),ie.view.focus(),on=!0,rn({delayMs:200}),!0}function sh(e,t){if(!ie)return!1;let n=String(e||"");if(!n)return!1;let r=St(ie.state.doc,n);if(typeof r!="number")return!1;let o=ie.state.doc.nodeAt(r);if(!o)return!1;let i=t&&typeof t=="object"?t:{},s=ie.state.doc.type.schema,a=null,c=null;try{i.heading&&typeof i.heading=="object"&&(a=s.nodeFromJSON(i.heading))}catch{a=null}try{i.body&&typeof i.body=="object"&&(c=s.nodeFromJSON(i.body))}catch{c=null}(!a||a.type?.name!=="outlineHeading")&&(a=s.nodes.outlineHeading.create({},[])),(!c||c.type?.name!=="outlineBody")&&(c=s.nodes.outlineBody.create({},[s.nodes.paragraph.create({},[])])),c.childCount||(c=s.nodes.outlineBody.create({},[s.nodes.paragraph.create({},[])]));let l=o.child(2),d=s.nodes.outlineSection.create(o.attrs,[a,c,l]),m=ie.state.tr.replaceWith(r,r+o.nodeSize,d);try{let h=Je?.pmStateMod?.TextSelection;h&&(m=m.setSelection(h.create(m.doc,r+2)))}catch{}return ie.view.dispatch(m),ie.view.focus(),on=!0,rn({delayMs:200}),!0}function ah(e,t){if(!ie)return!1;let n=String(e||"").trim();if(!n||typeof St(ie.state.doc,n)=="number")return!1;let o=t&&typeof t=="object"?t:{},i=ie.state.doc.type.schema,s=null,a=null;try{o.heading&&typeof o.heading=="object"&&(s=i.nodeFromJSON(o.heading))}catch{s=null}try{o.body&&typeof o.body=="object"&&(a=i.nodeFromJSON(o.body))}catch{a=null}(!s||s.type?.name!=="outlineHeading")&&(s=i.nodes.outlineHeading.create({},[])),(!a||a.type?.name!=="outlineBody")&&(a=i.nodes.outlineBody.create({},[i.nodes.paragraph.create({},[])])),a.childCount||(a=i.nodes.outlineBody.create({},[i.nodes.paragraph.create({},[])]));let c=i.nodes.outlineChildren.create({},[]),l=i.nodes.outlineSection.create({id:n,collapsed:!1},[s,a,c]),d=ie.state.doc.content.size,m=ie.state.tr.insert(d,l);try{let h=Je?.pmStateMod?.TextSelection;if(h){let b=Math.min(m.doc.content.size,d+2);m=m.setSelection(h.near(m.doc.resolve(Math.max(0,b)),1))}}catch{}return m=m.setMeta(ue,!0),ie.view.dispatch(m.scrollIntoView()),ie.view.focus(),on=!0,rn({delayMs:200}),!0}function ch({enterEditMode:e=!0}={}){if(!ie)return null;let t=ie.state.doc.type.schema,n=ie.state.doc.content.size,r=en(),o=t.nodes.outlineSection.create({id:r,collapsed:!1},[t.nodes.outlineHeading.create({},[]),t.nodes.outlineBody.create({},[t.nodes.paragraph.create({},[])]),t.nodes.outlineChildren.create({},[])]),i=ie.state.tr.insert(n,o);try{let s=Je?.pmStateMod?.TextSelection;if(s){let a=St(i.doc,r),c=typeof a=="number"?Xi(i.doc,a):null;typeof c=="number"?i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,c+2)),1)):i=i.setSelection(s.create(i.doc,n+2))}}catch{}return i=i.setMeta(ue,!0),e&&Ee&&(i=i.setMeta(Ee,{type:"enter",sectionId:r})),ie.view.dispatch(i.scrollIntoView()),ie.view.focus(),on=!0,rn({delayMs:200}),r}function Xi(e,t){try{let n=e.nodeAt(t);if(!n||n.type?.name!=="outlineSection")return null;let r=n.child(0);return t+1+r.nodeSize}catch{return null}}function lh(e,{focusBody:t=!0}={}){if(!ie||!Ee)return!1;let n=String(e||"").trim();if(!n)return!1;let r=St(ie.state.doc,n);if(typeof r!="number"||ie.state.doc.nodeAt(r)?.attrs?.collapsed)return!1;let i=ie.state.tr;if(t)try{let s=Je?.pmStateMod?.TextSelection,a=Xi(i.doc,r);s&&typeof a=="number"&&(i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,a+2)),1)))}catch{}return i=i.setMeta(ue,!0),i=i.setMeta(Ee,{type:"enter",sectionId:n}),ie.view.dispatch(i.scrollIntoView()),ie.view.focus(),!0}function dh({enterEditMode:e=!0}={}){if(!ie)return null;let t=ie.state.doc.type.schema,n=0,r=en(),o=t.nodes.outlineSection.create({id:r,collapsed:!1},[t.nodes.outlineHeading.create({},[]),t.nodes.outlineBody.create({},[t.nodes.paragraph.create({},[])]),t.nodes.outlineChildren.create({},[])]),i=ie.state.tr.insert(n,o);try{let s=Je?.pmStateMod?.TextSelection;if(s){let a=St(i.doc,r),c=typeof a=="number"?Xi(i.doc,a):null;typeof c=="number"?i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,c+2)),1)):i=i.setSelection(s.create(i.doc,n+2))}}catch{}return i=i.setMeta(ue,!0),e&&Ee&&(i=i.setMeta(Ee,{type:"enter",sectionId:r})),ie.view.dispatch(i.scrollIntoView()),ie.view.focus(),on=!0,rn({delayMs:200}),r}function uh(e,t,{enterEditMode:n=!1}={}){if(!ie)return!1;let r=String(e||"").trim();if(!r||typeof St(ie.state.doc,r)=="number")return!1;let i=ie.state.doc.type.schema,s=i.nodes.paragraph,a=i.nodes.hardBreak||i.nodes.hard_break||null,c=String(t||"").replace(/\r\n/g,`
`).trimEnd(),l=()=>{if(!s)return[];if(!c.trim())return[s.create({},[])];let p=c.split(/\n{2,}/),y=[];for(let x of p){let A=String(x||"").split(`
`),I=[];for(let N=0;N<A.length;N+=1){let $=A[N];N>0&&a&&I.push(a.create()),$&&I.push(i.text($))}y.push(s.create({},I))}return y.length?y:[s.create({},[])]},d=i.nodes.outlineHeading.create({},[]),m=i.nodes.outlineBody.create({},l()),h=i.nodes.outlineChildren.create({},[]),b=i.nodes.outlineSection.create({id:r,collapsed:!1},[d,m,h]),w=0,f=ie.state.tr.insert(w,b);try{let p=Je?.pmStateMod?.TextSelection;if(p){let y=St(f.doc,r),x=typeof y=="number"?Xi(f.doc,y):null;typeof x=="number"?f=f.setSelection(p.near(f.doc.resolve(Math.min(f.doc.content.size,x+2)),1)):f=f.setSelection(p.create(f.doc,w+2))}}catch{}return f=f.setMeta(ue,!0),n&&Ee&&(f=f.setMeta(Ee,{type:"enter",sectionId:r})),ie.view.dispatch(f.scrollIntoView()),ie.view.focus(),on=!0,rn({delayMs:200}),!0}async function fh(){if(u.isPublicView||u.isRagView){ve("Outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0432 \u044D\u0442\u043E\u043C \u0440\u0435\u0436\u0438\u043C\u0435");return}if(!u.articleId||!u.article){ve("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}if(wt=u.articleId,gr("outline.open.start",{outlineArticleId:wt,updatedAt:u.article?.updatedAt||null,docHash:Ut(u.article?.docJson||null)}),!V.outlineEditor||!V.blocksContainer){ve("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440");return}u.isOutlineEditing=!0,V.articleToolbar&&V.articleToolbar.classList.add("hidden"),V.outlineToolbar&&V.outlineToolbar.classList.remove("hidden"),V.outlineTagsBar&&V.outlineTagsBar.classList.remove("hidden"),V.outlineEditor.classList.remove("hidden"),V.blocksContainer.classList.add("hidden"),Xd({loading:!0});try{gt("outline.open",{articleId:wt,updatedAt:u.article?.updatedAt||null,docHash:Ut(u.article?.docJson||null)})}catch{}try{if(!u.scrollTargetBlockId&&wt){let e=jm(wt);e?.sectionId&&(u.currentBlockId=e.sectionId)}}catch{}try{await lu(),gr("outline.open.mounted",{outlineArticleId:wt,hasInstance:!!ie});try{Rm(ie)}catch{}try{let t=u.scrollTargetBlockId||null;t&&(du(t,{focus:!1}),u.scrollTargetBlockId=null,u.currentBlockId=t)}catch{}try{let t=u.currentBlockId||null;t&&(Um(ie,t),qm(ie,t,{block:"center"}))}catch{}let e=V.outlineEditor.querySelector(".outline-editor__loading");if(e&&e.classList.add("hidden"),rr("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u0442\u0441\u044F \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438"),gr("outline.open.ready",{outlineArticleId:wt,currentBlockId:u.currentBlockId||null}),Ad||(Ad=!0,window.addEventListener("online",()=>{if(u.isOutlineEditing){try{qd(wt||u.articleId)}catch{}Ho({force:!0})}}),window.addEventListener("blur",()=>{u.isOutlineEditing&&Ho({force:!0})}),document.addEventListener("visibilitychange",()=>{u.isOutlineEditing&&document.visibilityState!=="visible"&&Ho({force:!0})})),!Oo){let t=r=>{if(!u.isOutlineEditing)return;let o=r?.dataTransfer;if(!(o&&(o.files&&o.files.length||o.items&&o.items.length)))return;let s=r?.target;V.outlineEditor&&s&&V.outlineEditor.contains(s)||r.preventDefault()},n=r=>{if(!u.isOutlineEditing)return;let o=r?.dataTransfer;if(!(o&&o.files&&o.files.length))return;let s=r?.target;V.outlineEditor&&s&&V.outlineEditor.contains(s)||(r.preventDefault(),r.stopPropagation())};window.addEventListener("dragover",t,{passive:!1}),window.addEventListener("drop",n,{passive:!1}),Oo=()=>{window.removeEventListener("dragover",t),window.removeEventListener("drop",n),Oo=null}}}catch(e){ve(e?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440"),uu()}}function uu(){gr("outline.close",{outlineArticleId:wt,hadInstance:!!ie}),u.isOutlineEditing=!1,Hm(),Ee=null,wt=null,Sr=null,ji=null,or={counts:new Map,labelByKey:new Map,sectionIdsByKey:new Map,sectionPosById:new Map};try{V.outlineTagsBar&&(V.outlineTagsBar.innerHTML="",V.outlineTagsBar.classList.add("hidden"))}catch{}so(!1),Oo&&Oo(),V.outlineToolbar&&V.outlineToolbar.classList.add("hidden"),V.articleToolbar&&V.articleToolbar.classList.remove("hidden"),Qn&&(clearTimeout(Qn),Qn=null),Vt&&(clearTimeout(Vt),Vt=null),Mr&&(clearTimeout(Mr),Mr=null),va=null,qn=!1,Fi="";try{Mn.clear()}catch{}Oi=!1,Rr.clear();try{ao.clear()}catch{}Or.clear(),bn=null,on=!1;try{for(let[,e]of Ro)try{clearTimeout(e)}catch{}Ro.clear()}catch{}try{for(let[,e]of Dr)try{URL.revokeObjectURL(e)}catch{}Dr.clear()}catch{}if(ie){try{ie.destroy()}catch{}ie=null}Je=null,V.outlineEditor&&V.outlineEditor.classList.add("hidden"),V.blocksContainer&&V.blocksContainer.classList.remove("hidden")}async function ph(e={}){let t=e&&typeof e.mode=="string"?e.mode:"network",n=e&&typeof e.timeoutMs=="number"?Math.max(0,Math.floor(e.timeoutMs)):0;if(!ie)return;Qn&&(clearTimeout(Qn),Qn=null);try{let o=wt||u.articleId;if(o&&!u.article?.encrypted){let i=ie.getJSON();if(i&&typeof i=="object")try{await xn(o,i,u.article?.updatedAt||null)}catch{}try{try{let s=Ee?.getState?.(ie?.state)||null,a=String(s?.editingSectionId||"").trim();a&&await $a({articleId:o,doc:ie.state.doc,sectionId:a,reason:"pagehide"})}catch{}if(qn){let s=zo(ie.state.doc);s.length&&(cn("structure_snapshot",{articleId:o,payload:{nodes:s},coalesceKey:`structure:${o}`}),qn=!1)}}catch{}try{if(Mn.size){let s=Array.from(Mn);Mn.clear();let a=Date.now();await cn("delete_sections",{articleId:o,payload:{sectionIds:s,clientQueuedAt:a},coalesceKey:`delete:${o}:${a}`})}}catch{}}}catch{}if(t==="queue")return;let r=Ho({force:!0,silent:!0});if(n>0){await Promise.race([r,new Promise(o=>setTimeout(o,n))]);return}await r}async function mh({docJson:e}={}){if(V.outlineEditor){if(!e||typeof e!="object"){ve("\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F: \u043D\u0435\u0442 \u0434\u043E\u043A\u0443\u043C\u0435\u043D\u0442\u0430");return}u.isPublicView=!0,u.isRagView=!1,u.isOutlineEditing=!1,u.articleId=null,u.article={docJson:e,encrypted:!1};try{V.outlineEditor.classList.add("outline-editor")}catch{}V.outlineEditor.classList.remove("hidden"),V.outlineEditor.querySelector("#outlineEditorContent")||Xd({loading:!0});try{await lu();let t=V.outlineEditor.querySelector(".outline-editor__loading");t&&t.classList.add("hidden"),rr("\u0422\u043E\u043B\u044C\u043A\u043E \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440")}catch(t){ve(t?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E")}}}var Ca,Je,ie,_o,Qn,Oi,Mr,va,xa,$d,bn,Dr,Or,Rr,ao,on,Ad,Fo,Ta,Ba,vt,Br,Aa,rm,eo,to,Pi,Ri,Ee,Oo,wt,Sr,ji,or,nr,wr,ka,om,_i,Na,qi,im,Ro,Id,Ki,qn,Fi,Vt,Mn,Ia,ue,Cd,mm,hm,gm,Di,hh,gh,st,bi=et(()=>{Ht();Bn();an();Un();cr();mn();So();Er();Kr();zr();us();ud();lr();fd();md();po();Ws();Ca=!1,Je=null,ie=null,_o=null,Qn=null,Oi=!1,Mr=null,va=null,xa=0,$d=null,bn=null,Dr=new Map,Or=new Map,Rr=new Set,ao=new Set,on=!1,Ad=!1,Fo=null,Ta=null,Ba=null,vt={TableMap:null,CellSelection:null,moveTableColumn:null,moveTableRow:null,addRowBefore:null,addRowAfter:null,deleteRow:null,addColumnBefore:null,addColumnAfter:null,deleteColumn:null,toggleHeaderRow:null,toggleHeaderColumn:null},Br=!1,Aa=new Map,rm=30*1e3,eo=new Map,to=new Map,Pi=0,Ri=null,Ee=null,Oo=null,wt=null,Sr=null,ji=null,or={counts:new Map,labelByKey:new Map,sectionIdsByKey:new Map,sectionPosById:new Map},nr=!1,wr=new Set,ka={atMs:0,hash:null};om=650,_i={articleId:null,sectionId:null,collapsed:null},Na="ttree_outline_section_clipboard_v1",qi="pending-attachment:",im=2e3,Ro=new Map;Id="ttree_outline_section_seq_v1",Ki=262144;qn=!1,Fi="",Vt=null,Mn=new Set,Ia=null;ue="outlineAllowMutation",Cd=0,mm="ttree_outline_debug_md_table";hm="ttree_profile_v1";gm="ttree_outline_debug_proofread_v1";Di=null;hh="ttree_debug_outline_keys_v1",gh=()=>{try{return window?.localStorage?.getItem?.(hh)==="1"}catch{return!1}},st=(e,t={})=>{gh()}});(()=>{let e=window.__memusAppModule||"/app.js",t="ttree_boot_session_v1",n="ttree_last_user_v1",r="ttree_last_active_at_v1",o=200,i=900*1e3,s=2500,a="ttree_debug_quick_notes_v1",c="ttree_offline_known_user_keys_v1",l="memus_offline_v1_",d="ttree_offline_recovery_force_index_v1",m="ttree_boot_open_offline_requested_v1",h=!1;try{h=window.sessionStorage?.getItem?.(m)==="1",h&&window.sessionStorage?.removeItem?.(m)}catch{}function b(){try{return window?.localStorage?.getItem?.(a)==="1"}catch{return!1}}function w(...ee){try{if(!b())return;console.log("[quick-notes][boot]",...ee)}catch{}}function f(...ee){try{console.log("[quick-notes][recovery]",...ee)}catch{}}function p(...ee){try{console.error("[quick-notes][recovery]",...ee)}catch{}}function y(){if("serviceWorker"in navigator)try{navigator.serviceWorker.register("/uploads-sw.js",{scope:"/",updateViaCache:"none"}).then(ee=>{try{ee&&ee.waiting&&ee.waiting.postMessage({type:"memus:skipWaiting"}),ee?.addEventListener?.("updatefound",()=>{try{let de=ee.installing;if(!de)return;de.addEventListener("statechange",()=>{if(de.state==="installed"&&navigator.serviceWorker.controller)try{ee.waiting?.postMessage?.({type:"memus:skipWaiting"})}catch{}})}catch{}})}catch{}try{let de=ee?.update?.();de&&typeof de.catch=="function"&&de.catch(()=>{})}catch{}}).catch(()=>{});try{let ee=!!navigator.serviceWorker.controller,de=I(),ye=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{if(!ye&&(ye=!0,!h&&ee&&!de))try{window.location.reload()}catch{}})}catch{}}catch{}}function x(){try{return String(window.location.pathname||"").startsWith("/p/")}catch{return!1}}function A(){try{return!!(typeof navigator<"u"&&navigator&&navigator.onLine===!1)}catch{return!1}}function I(){try{let ee=performance.getEntriesByType?.("navigation")||[],de=ee&&ee[0];return String(de?.type||"")==="reload"}catch{return!1}}function N(){try{let ee=window.localStorage.getItem(r)||"",de=Number(ee);return Number.isFinite(de)?de:0}catch{return 0}}function $(){try{window.localStorage.setItem(r,String(Date.now()))}catch{}}function q(){let ee=N();return ee?Date.now()-ee>i:!0}function z(){try{return window.sessionStorage.getItem(t)?!1:(window.sessionStorage.setItem(t,"1"),!0)}catch{return!0}}function X(){try{let ee=window.localStorage.getItem(n);if(!ee)return!1;let de=JSON.parse(ee);return!!(de&&(de.id||de.username))}catch{return!1}}function Q(){try{if(globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function")return globalThis.crypto.randomUUID()}catch{}return`id-${Date.now()}-${Math.random().toString(16).slice(2)}`}function oe(){return new Date().toISOString()}function we(){try{let ee=window.localStorage.getItem(c)||"[]",de=JSON.parse(ee);return Array.isArray(de)?de.filter(Boolean).map(String):[]}catch{return[]}}async function Pe(){try{if(!("indexedDB"in window))return[];if(typeof indexedDB.databases=="function"){let ye=(await indexedDB.databases()||[]).map(Re=>Re&&Re.name).filter(Boolean).filter(Re=>String(Re).startsWith(l)).map(Re=>String(Re).slice(l.length)).filter(Boolean);return Array.from(new Set(ye))}}catch{}return Array.from(new Set(we()))}function te(ee,de){return new Promise((ye,Ve)=>{try{let Re=de?indexedDB.open(ee,de):indexedDB.open(ee);de&&(Re.onupgradeneeded=()=>{try{let _e=Re.result;if(_e.objectStoreNames.contains("meta")||_e.createObjectStore("meta",{keyPath:"key"}),!_e.objectStoreNames.contains("articles")){let Ce=_e.createObjectStore("articles",{keyPath:"id"});Ce.createIndex("byUpdatedAt","updatedAt",{unique:!1}),Ce.createIndex("byDeletedAt","deletedAt",{unique:!1})}if(!_e.objectStoreNames.contains("outline_sections")){let Ce=_e.createObjectStore("outline_sections",{keyPath:"sectionId"});Ce.createIndex("byArticleId","articleId",{unique:!1}),Ce.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!_e.objectStoreNames.contains("section_embeddings")){let Ce=_e.createObjectStore("section_embeddings",{keyPath:"sectionId"});Ce.createIndex("byArticleId","articleId",{unique:!1}),Ce.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!_e.objectStoreNames.contains("media_assets")){let Ce=_e.createObjectStore("media_assets",{keyPath:"url"});Ce.createIndex("byStatus","status",{unique:!1}),Ce.createIndex("byFetchedAtMs","fetchedAtMs",{unique:!1}),Ce.createIndex("byStatusFetchedAtMs",["status","fetchedAtMs"],{unique:!1})}if(!_e.objectStoreNames.contains("media_refs")){let Ce=_e.createObjectStore("media_refs",{keyPath:"key"});Ce.createIndex("byArticleId","articleId",{unique:!1}),Ce.createIndex("byUrl","url",{unique:!1})}if(_e.objectStoreNames.contains("outbox"))try{let Ge=Re.transaction.objectStore("outbox");Ge.indexNames.contains("byTypeCoalesceKey")||Ge.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}catch{}else{let Ce=_e.createObjectStore("outbox",{keyPath:"id"});Ce.createIndex("byCreatedAtMs","createdAtMs",{unique:!1}),Ce.createIndex("byTypeArticleId",["type","articleId"],{unique:!1}),Ce.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}if(!_e.objectStoreNames.contains("pending_uploads")){let Ce=_e.createObjectStore("pending_uploads",{keyPath:"token"});Ce.createIndex("byArticleId","articleId",{unique:!1}),Ce.createIndex("byCreatedAtMs","createdAtMs",{unique:!1})}}catch{}}),Re.onsuccess=()=>ye(Re.result),Re.onerror=()=>{let _e=Re.error||new Error("IndexedDB open failed");p("idb.open.error",{name:ee,version:de||null,message:String(_e?.message||_e)}),Ve(_e)}}catch(Re){p("idb.open.throw",{name:ee,version:de||null,message:String(Re?.message||Re)}),Ve(Re)}})}function Se(ee,de){return new Promise((ye,Ve)=>{try{let Ce=ee.transaction([de],"readonly").objectStore(de).getAll();Ce.onsuccess=()=>ye(Array.isArray(Ce.result)?Ce.result:[]),Ce.onerror=()=>{let Ge=Ce.error||new Error("IndexedDB getAll failed");p("idb.getAll.error",{storeName:de,message:String(Ge?.message||Ge)}),Ve(Ge)}}catch(Re){p("idb.getAll.throw",{storeName:de,message:String(Re?.message||Re)}),Ve(Re)}})}function tt(ee,de){return new Promise((ye,Ve)=>{try{let Ce=ee.transaction([de],"readonly").objectStore(de).count();Ce.onsuccess=()=>ye(Number(Ce.result||0)),Ce.onerror=()=>{let Ge=Ce.error||new Error("IndexedDB count failed");p("idb.count.error",{storeName:de,message:String(Ge?.message||Ge)}),Ve(Ge)}}catch(Re){p("idb.count.throw",{storeName:de,message:String(Re?.message||Re)}),Ve(Re)}})}function Lt(ee,de){try{let ye=JSON.stringify(de),Ve=new Blob([ye],{type:"application/json;charset=utf-8"}),Re=URL.createObjectURL(Ve),_e=document.createElement("a");return _e.href=Re,_e.download=ee,_e.rel="noopener",document.body.appendChild(_e),_e.click(),setTimeout(()=>{try{_e.remove(),URL.revokeObjectURL(Re)}catch{}},0),!0}catch{return!1}}function _t(ee,de){try{let ye=URL.createObjectURL(de),Ve=document.createElement("a");return Ve.href=ye,Ve.download=ee,Ve.rel="noopener",document.body.appendChild(Ve),Ve.click(),setTimeout(()=>{try{Ve.remove(),URL.revokeObjectURL(ye)}catch{}},0),!0}catch{return!1}}async function fn(ee,{method:de="GET",body:ye=null,timeoutMs:Ve=2e4}={}){let Re=typeof AbortController<"u"?new AbortController:null,_e={method:de,credentials:"include",headers:{},signal:Re?.signal};ye!==null&&(_e.headers["Content-Type"]="application/json",_e.body=JSON.stringify(ye));let Ce=null,Ge=!1;Re&&typeof Ve=="number"&&Ve>0&&(Ce=setTimeout(()=>{try{Ge=!0;try{Re.abort(new Error(`timeout after ${Ve}ms`))}catch{Re.abort()}}catch{}},Ve));let S;try{S=await fetch(ee,_e)}finally{Ce&&clearTimeout(Ce)}let g=await S.text().catch(()=>""),E=null;try{E=g?JSON.parse(g):null}catch{E=null}if(!S.ok){let T=E&&(E.detail||E.error)||g||`${S.status} ${S.statusText}`,_=new Error(T);throw _.status=S.status,_.payload=E,_}return E}async function Sn(ee,de){try{return await fn(ee,de)}catch(ye){if(String(ye?.name||"")==="AbortError"||String(ye?.message||"").toLowerCase().includes("aborted")){let Re=typeof de?.timeoutMs=="number"?de.timeoutMs:null,_e=new Error(Re?`timeout after ${Re}ms`:"request aborted");throw _e.name="TimeoutError",_e}throw ye}}function vn(ee){try{return ee?JSON.parse(ee):null}catch{return null}}function On(ee){let de=String(ee||"");return!!(!de||de==="inbox"||de.startsWith("inbox-"))}async function Vn({userKey:ee,onProgress:de}){let ye=String(ee||"").trim();if(!ye)throw new Error("No userKey");let Ve=await te(`${l}${ye}`).catch(P=>{throw p("restore.server.idb.open.error",{userKey:ye,message:String(P?.message||P)}),P}),Re=await Se(Ve,"articles").catch(P=>{throw p("restore.server.idb.read.error",{userKey:ye,message:String(P?.message||P)}),P});try{Ve.close()}catch{}let _e=(Array.isArray(Re)?Re:[]).filter(P=>P&&!P.deletedAt&&!On(P.id)).map(P=>{let H=vn(P.articleJsonStr)||{},O=vn(P.docJsonStr)||H.docJson||null;return{id:String(P.id),title:(P.title||H.title||"").toString(),parentId:P.parentId??H.parentId??null,position:typeof P.position=="number"?P.position:typeof H.position=="number"?H.position:0,docJson:O&&typeof O=="object"?O:null}}).filter(P=>P.id&&P.docJson),Ce=_e.length,Ge={n:0},S={n:0},g={n:0},E=(P,H={})=>{try{de?.({phase:P,total:Ce,created:Ge.n,saved:S.n,moved:g.n,...H})}catch{}};E("start");for(let P=0;P<_e.length;P+=1){let H=_e[P];E("content",{idx:P+1,articleId:H.id,title:H.title});try{f("restore.server.create.start",{idx:P+1,id:H.id}),await Sn("/api/articles",{method:"POST",body:{id:H.id,title:H.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"},timeoutMs:15e3}),Ge.n+=1,f("restore.server.create.done",{idx:P+1,id:H.id})}catch(O){f("restore.server.create.skip",{idx:P+1,id:H.id,status:O?.status||null,message:String(O?.message||O)})}try{f("restore.server.save.start",{idx:P+1,id:H.id}),await Sn(`/api/articles/${encodeURIComponent(H.id)}/doc-json`,{method:"PUT",body:{docJson:H.docJson},timeoutMs:3e4}),S.n+=1,f("restore.server.save.done",{idx:P+1,id:H.id})}catch(O){p("restore.server.save.error",{idx:P+1,id:H.id,status:O?.status||null,message:String(O?.message||O),stack:String(O?.stack||"")})}}let T=new Map;for(let P of _e){let H=P.parentId||null;T.has(H)||T.set(H,[]),T.get(H).push(P)}for(let[P,H]of T.entries())H.sort((O,B)=>Number(O.position||0)-Number(B.position||0)),T.set(P,H);let _=[null],R=new Set;for(E("structure");_.length;){let P=_.shift(),H=P||"__root__";if(R.has(H))continue;R.add(H);let O=T.get(P||null)||[];for(let B of O){E("structure",{articleId:B.id,title:B.title});try{await fn(`/api/articles/${encodeURIComponent(B.id)}/move-tree`,{method:"POST",body:{parentId:P||null,anchorId:null,placement:"inside"}}),g.n+=1}catch(C){f("restore.server.move.skip",{id:B.id,status:C?.status||null,message:String(C?.message||C)})}T.has(B.id)&&_.push(B.id)}}return E("done"),{total:Ce,created:Ge.n,saved:S.n,moved:g.n}}function jn(ee){let de=new TextEncoder,ye=Object.entries(ee?.stores||{}),Ve={type:"meta",exportedAt:ee?.exportedAt||oe(),sourceUserKey:ee?.sourceUserKey||null,dbName:ee?.dbName||null,format:"ndjson.v1"},Re=!1,_e=0,Ce=-1;return new ReadableStream({pull(Ge){try{if(!Re){Re=!0,Ge.enqueue(de.encode(`${JSON.stringify(Ve)}
`));return}for(;_e<ye.length;){let[S,g]=ye[_e],E=Array.isArray(g)?g:[];if(Ce===-1){Ce=0,Ge.enqueue(de.encode(`${JSON.stringify({type:"store",store:S,count:E.length})}
`));return}if(Ce>=E.length){_e+=1,Ce=-1;continue}let T={type:"item",store:S,value:E[Ce]};Ce+=1,Ge.enqueue(de.encode(`${JSON.stringify(T)}
`));return}Ge.close()}catch(S){p("ndjson.stream.error",{message:String(S?.message||S),stack:String(S?.stack||"")}),Ge.error(S)}}})}async function Rn(ee,de){let ye=jn(de),Ve=typeof CompressionStream<"u",Re=Ve?ye.pipeThrough(new CompressionStream("gzip")):ye,_e=await new Response(Re).blob(),Ce=Ve?`${ee}.ndjson.gz`:`${ee}.ndjson`;if(_t(Ce,_e))return{ok:!0,method:"download",filename:Ce};try{let Ge=URL.createObjectURL(_e);try{window.open(Ge,"_blank","noopener")}catch{window.location.href=Ge}return{ok:!0,method:"open",filename:Ce}}catch(Ge){p("export.open.error",{filename:Ce,message:String(Ge?.message||Ge),stack:String(Ge?.stack||"")})}return{ok:!1,method:"none",filename:Ce}}function Hn(){try{let ee=window.localStorage.getItem(n)||"",de=ee?JSON.parse(ee):null;return de?.id||de?.username||""}catch{return""}}async function zt(ee){let de=String(ee||"").trim();if(!de)throw new Error("No userKey");let ye=`${l}${de}`,Ve=await te(ye,3),Re=["articles","outline_sections","media_assets","media_refs","outbox","pending_uploads","section_embeddings","meta"].filter(Ce=>{try{return Ve.objectStoreNames.contains(Ce)}catch{return!1}}),_e={exportedAt:oe(),sourceUserKey:de,dbName:ye,stores:{}};for(let Ce of Re)_e.stores[Ce]=await Se(Ve,Ce).catch(Ge=>(p("export.store.read.error",{userKey:de,store:Ce,message:String(Ge?.message||Ge)}),[]));try{Ve.close()}catch{}return _e}async function Yt(ee,de){let ye=String(de||"").trim();if(!ye)throw new Error("No target userKey");if(!ee||typeof ee!="object"||!ee.stores||typeof ee.stores!="object")throw new Error("Invalid dump");let Ve=`${l}${ye}`,Re=await te(Ve,3),_e=async(Ge,S)=>{if(!Re.objectStoreNames.contains(Ge))return 0;let g=Array.isArray(S)?S:[];if(!g.length)return 0;let E=Re.transaction([Ge],"readwrite"),T=E.objectStore(Ge),_=0;return await new Promise((R,P)=>{E.oncomplete=()=>R(),E.onerror=()=>{let H=E.error||new Error("tx failed");p("import.tx.error",{storeName:Ge,message:String(H?.message||H)}),P(H)},E.onabort=()=>{let H=E.error||new Error("tx aborted");p("import.tx.abort",{storeName:Ge,message:String(H?.message||H)}),P(H)};for(let H of g)try{T.put(H),_+=1}catch{}}),_},Ce=0;Ce+=await _e("articles",ee.stores.articles),Ce+=await _e("outline_sections",ee.stores.outline_sections),Ce+=await _e("media_assets",ee.stores.media_assets),Ce+=await _e("media_refs",ee.stores.media_refs),Ce+=await _e("pending_uploads",ee.stores.pending_uploads),Ce+=await _e("section_embeddings",ee.stores.section_embeddings);try{Re.close()}catch{}return Ce}let Tt="ttree_pending_quick_notes_v1";function At(){try{let ee=window.localStorage.getItem(Tt)||"";if(!ee)return[];let de=JSON.parse(ee);return Array.isArray(de)?de.filter(Boolean):[]}catch{return[]}}function Dt(ee){try{window.localStorage.setItem(Tt,JSON.stringify(Array.isArray(ee)?ee:[]))}catch{}}function Tn(ee){let de=String(ee||"").trim();if(!de)return null;let ye=Q(),Ve={id:ye,sectionId:ye,createdAt:oe(),text:de},Re=At(),_e=[Ve,...Re].slice(0,o);return Dt(_e),w("saved.pending",{id:Ve.id,len:_e.length}),Ve}function Y(){if(document.getElementById("quickNoteBootStyles"))return;let ee=document.createElement("style");ee.id="quickNoteBootStyles",ee.textContent=`
      .boot-modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.22);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);z-index:99999;display:flex;align-items:center;justify-content:center;padding:16px}
      .boot-modal{width:min(720px,100%);background:rgba(255,255,255,.92);border:1px solid rgba(203,213,225,.9);border-radius:16px;box-shadow:0 24px 80px rgba(15,23,42,.18);color:#0f172a}
      .boot-modal__hdr{padding:14px 16px;border-bottom:1px solid rgba(203,213,225,.7);display:flex;align-items:center;justify-content:space-between;gap:12px}
      .boot-modal__title{font-size:14px;font-weight:600;letter-spacing:.2px}
      .boot-modal__meta{font-size:12px;color:#64748b}
      .boot-modal__body{padding:12px 16px}
      .boot-note{width:100%;min-height:34vh;max-height:52vh;resize:vertical;background:rgba(255,255,255,.95);color:#0f172a;border:1px solid rgba(203,213,225,.9);border-radius:12px;padding:12px 12px;font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;outline:none}
      .boot-note:focus{border-color:rgba(37,99,235,.65);box-shadow:0 0 0 4px rgba(37,99,235,.14)}
      .boot-modal__ftr{padding:12px 16px;border-top:1px solid rgba(203,213,225,.7);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
      .boot-actions{display:flex;gap:10px;flex-wrap:wrap}
      .boot-btn{appearance:none;border:1px solid rgba(203,213,225,.9);background:rgba(255,255,255,.7);color:#0f172a;border-radius:999px;padding:10px 14px;font:600 13px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;cursor:pointer}
      .boot-btn:hover{background:rgba(241,245,249,.9)}
      .boot-btn--primary{background:#007ACC;border-color:#007ACC;color:#ffffff}
      .boot-btn--primary:hover{background:#0062A3}
      .boot-btn--ghost{background:transparent}
      .boot-hint{font-size:12px;color:#64748b}
      .boot-toast{margin-left:auto;font-size:12px;color:#16a34a}
    `,document.head.appendChild(ee)}function ce(ee,{timeout:de=5e3,fallbackDelay:ye=1200}={}){try{if(typeof requestIdleCallback=="function"){requestIdleCallback(()=>ee(),{timeout:de});return}}catch{}setTimeout(()=>ee(),ye)}function pe(){ce(()=>{try{import(e).catch(()=>{})}catch{}})}function me({reason:ee=""}={}){Y();let de=document.createElement("div");de.className="boot-modal-backdrop";let ye=document.createElement("div");ye.className="boot-modal";let Ve=document.createElement("div");Ve.className="boot-modal__hdr";let Re=document.createElement("div"),_e=document.createElement("div");_e.className="boot-modal__title",_e.textContent="\u0411\u044B\u0441\u0442\u0440\u0430\u044F \u0437\u0430\u043C\u0435\u0442\u043A\u0430",Re.appendChild(_e);let Ce=document.createElement("button");Ce.type="button",Ce.className="boot-btn boot-btn--ghost",Ce.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",Ve.appendChild(Re),Ve.appendChild(Ce);let Ge=document.createElement("div");Ge.className="boot-modal__body";let S=document.createElement("textarea");S.className="boot-note",S.placeholder=`\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0443\u2026

Ctrl+Enter \u2014 \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C
Esc \u2014 \u0437\u0430\u043A\u0440\u044B\u0442\u044C`,Ge.appendChild(S);let g=document.createElement("div");g.className="boot-modal__ftr";let E=document.createElement("div");E.className="boot-hint",E.textContent="\u0417\u0430\u043C\u0435\u0442\u043A\u0438 \u0441\u043E\u0445\u0440\u0430\u043D\u044F\u044E\u0442\u0441\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E \u0438 \u0431\u0443\u0434\u0443\u0442 \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u044B \u0432 \u201C\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438\u201D \u043F\u0440\u0438 \u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0435\u043C \u0432\u0445\u043E\u0434\u0435.";let T=document.createElement("div");T.className="boot-actions";let _=document.createElement("button");_.type="button",_.className="boot-btn boot-btn--primary",_.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C";let R=document.createElement("button");R.type="button",R.className="boot-btn",R.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0438 \u0435\u0449\u0451",T.appendChild(_),T.appendChild(R);let P=document.createElement("div");P.className="boot-toast",g.appendChild(E),g.appendChild(T),g.appendChild(P),ye.appendChild(Ve),ye.appendChild(Ge),ye.appendChild(g),de.appendChild(ye);let H=()=>{try{de.remove()}catch{}},O=C=>{let k=Tn(S.value);if(k){S.value="",P.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E",$();try{window.dispatchEvent(new CustomEvent("memus:queued-inbox-changed",{detail:{note:k}})),w("event.dispatched",{type:"memus:queued-inbox-changed"})}catch{}C||H(),setTimeout(()=>{try{P.textContent=""}catch{}},1200)}};Ce.addEventListener("click",H),de.addEventListener("click",C=>{C.target===de&&H()}),_.addEventListener("click",()=>O(!1)),R.addEventListener("click",()=>O(!0)),S.addEventListener("keydown",C=>{if(C.key==="Escape"){C.preventDefault(),H();return}C.key==="Enter"&&(C.ctrlKey||C.metaKey)&&(C.preventDefault(),O(!0))});let B=async()=>{Y();let C=document.createElement("div");C.className="boot-modal-backdrop";let k=document.createElement("div");k.className="boot-modal";let M=document.createElement("div");M.className="boot-modal__hdr";let v=document.createElement("div"),D=document.createElement("div");D.className="boot-modal__title",D.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0445 \u0434\u0430\u043D\u043D\u044B\u0445";let F=document.createElement("div");F.className="boot-modal__meta",F.textContent="\u0418\u0449\u0435\u043C \u0441\u0442\u0430\u0440\u044B\u0435 \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0435 \u0431\u0430\u0437\u044B\u2026",v.appendChild(D),v.appendChild(F);let J=document.createElement("button");J.type="button",J.className="boot-btn boot-btn--ghost",J.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",M.appendChild(v),M.appendChild(J);let K=document.createElement("div");K.className="boot-modal__body";let U=document.createElement("div");U.style.display="flex",U.style.flexDirection="column",U.style.gap="10px",K.appendChild(U);let Z=document.createElement("div");Z.className="boot-modal__ftr";let se=document.createElement("div");se.className="boot-hint",se.textContent="\u0415\u0441\u043B\u0438 \u043F\u043E\u0441\u043B\u0435 \u0432\u0445\u043E\u0434\u0430 \u0432\u0441\u0435 \u0441\u0442\u0430\u0442\u044C\u0438 \u043F\u0440\u043E\u043F\u0430\u043B\u0438, \u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E \u0438\u0437\u043C\u0435\u043D\u0438\u043B\u0441\u044F userKey. \u0417\u0434\u0435\u0441\u044C \u043C\u043E\u0436\u043D\u043E \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0430\u0440\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 \u0438\u043B\u0438 \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0438\u0445 \u0432 \u0442\u0435\u043A\u0443\u0449\u0435\u0433\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F.";let he=document.createElement("div");he.className="boot-toast",Z.appendChild(se),Z.appendChild(he),k.appendChild(M),k.appendChild(K),k.appendChild(Z),C.appendChild(k);let be=()=>{try{C.remove()}catch{}};J.addEventListener("click",be),C.addEventListener("click",ge=>{ge.target===C&&be()}),document.body.appendChild(C);let Ie=(ge,{articleCount:He}={})=>{let Be=document.createElement("div");Be.style.border="1px solid rgba(255,255,255,.12)",Be.style.borderRadius="12px",Be.style.padding="12px",Be.style.display="flex",Be.style.flexDirection="column",Be.style.gap="10px";let xe=document.createElement("div");xe.style.display="flex",xe.style.alignItems="baseline",xe.style.justifyContent="space-between",xe.style.gap="12px";let qe=document.createElement("div");qe.style.fontWeight="600",qe.style.fontSize="13px",qe.textContent=ge;let We=document.createElement("div");We.dataset.recoveryMeta="1",We.style.fontSize="12px",We.style.color="#9ca3af",We.textContent=typeof He=="number"?`\u0421\u0442\u0430\u0442\u0435\u0439: ${He}`:"",xe.appendChild(qe),xe.appendChild(We);let ut=document.createElement("div");ut.className="boot-actions";let at=document.createElement("button");at.type="button",at.className="boot-btn",at.textContent="\u042D\u043A\u0441\u043F\u043E\u0440\u0442 JSON";let It=document.createElement("button");It.type="button",It.className="boot-btn boot-btn--primary",It.textContent="\u0418\u043C\u043F\u043E\u0440\u0442 \u0432 \u0442\u0435\u043A\u0443\u0449\u0435\u0433\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F";let Ot=document.createElement("button");return Ot.type="button",Ot.className="boot-btn",Ot.textContent="\u041D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440",ut.appendChild(at),ut.appendChild(It),ut.appendChild(Ot),Be.appendChild(xe),Be.appendChild(ut),at.addEventListener("click",async()=>{let Gt=performance.now();try{he.textContent="\u042D\u043A\u0441\u043F\u043E\u0440\u0442\u2026",f("export.start",{userKey:ge});let L=await zt(ge),G=`memus-offline-recovery-${ge}-${new Date().toISOString().replace(/[:.]/g,"-")}`,j=await Rn(G,L);f("export.done",{userKey:ge,ok:j.ok,method:j.method,filename:j.filename,ms:Math.round(performance.now()-Gt)}),he.textContent=j.ok?j.method==="download"?`\u0421\u043A\u0430\u0447\u0438\u0432\u0430\u043D\u0438\u0435 \u043D\u0430\u0447\u0430\u043B\u043E\u0441\u044C: ${j.filename}`:j.method==="open"?`\u041E\u0442\u043A\u0440\u044B\u043B \u0444\u0430\u0439\u043B \u0432 \u043D\u043E\u0432\u043E\u0439 \u0432\u043A\u043B\u0430\u0434\u043A\u0435: ${j.filename}`:`\u042D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043E: ${j.filename}`:"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C (\u043E\u0433\u0440\u0430\u043D\u0438\u0447\u0435\u043D\u0438\u044F \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0430)"}catch(L){p("export.button.error",{userKey:ge,message:String(L?.message||L),stack:String(L?.stack||"")}),he.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430 \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0430: ${String(L&&L.message?L.message:L)}`}finally{setTimeout(()=>{try{he.textContent=""}catch{}},8e3)}}),It.addEventListener("click",async()=>{let Gt=performance.now();try{let L=Hn();if(!L){he.textContent="\u041D\u0435\u0442 \u201C\u0442\u0435\u043A\u0443\u0449\u0435\u0433\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\u201D \u0432 localStorage. \u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0434\u0438\u043D \u0440\u0430\u0437 \u0432\u043E\u0439\u0434\u0438\u0442\u0435.";return}he.textContent="\u0418\u043C\u043F\u043E\u0440\u0442\u2026",f("import.start",{from:ge,to:L});let G=await zt(ge),j=await Yt(G,L);try{window.localStorage.setItem(d,"1")}catch{}let W=await te(`${l}${L}`).catch(()=>null),re=null,le=null;if(W){re=await tt(W,"articles").catch(()=>null),le=await tt(W,"outline_sections").catch(()=>null);try{W.close()}catch{}}f("import.done",{from:ge,to:L,imported:j,targetArticles:re,targetSections:le,ms:Math.round(performance.now()-Gt)});let ae=typeof re=="number"?` (\u0432 \u0431\u0430\u0437\u0435 \u0441\u0442\u0430\u0442\u0435\u0439: ${re})`:"";he.textContent=`\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0437\u0430\u043F\u0438\u0441\u0435\u0439: ${j}${ae}`;try{window.dispatchEvent(new CustomEvent("memus:offline-recovery-imported",{detail:{from:ge,to:L}}))}catch{}}catch(L){p("import.button.error",{userKey:ge,message:String(L?.message||L),stack:String(L?.stack||"")}),he.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430 \u0438\u043C\u043F\u043E\u0440\u0442\u0430: ${String(L&&L.message?L.message:L)}`}finally{setTimeout(()=>{try{he.textContent=""}catch{}},8e3)}}),Ot.addEventListener("click",async()=>{let Gt=performance.now();try{he.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u043D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u2026",f("restore.server.start",{userKey:ge});let L=await Vn({userKey:ge,onProgress:G=>{let j=G.phase;j==="content"?he.textContent=`\u041D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440: ${G.idx}/${G.total} \xB7 ${G.title||G.articleId}`:j==="structure"?he.textContent=`\u0421\u0442\u0440\u0443\u043A\u0442\u0443\u0440\u0430\u2026 (${G.moved}/${G.total})`:j==="done"&&(he.textContent=`\u0413\u043E\u0442\u043E\u0432\u043E: \u0441\u0442\u0430\u0442\u0435\u0439=${G.total}, \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E=${G.saved}`),f("restore.server.progress",G)}});f("restore.server.done",{...L,ms:Math.round(performance.now()-Gt)}),he.textContent=`\u041D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440: \u0441\u0442\u0430\u0442\u0435\u0439=${L.total}, \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E=${L.saved}`}catch(L){p("restore.server.error",{userKey:ge,message:String(L?.message||L),stack:String(L?.stack||"")}),he.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430: ${String(L?.message||L)}`}finally{setTimeout(()=>{try{he.textContent=""}catch{}},12e3)}}),Be};try{let ge=await Pe();if(!ge.length){F.textContent="\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0435 \u0431\u0430\u0437\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B. \u0415\u0441\u043B\u0438 \u0432\u044B \u0442\u043E\u0447\u043D\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043B\u0438\u0441\u044C Memus \u043D\u0430 \u044D\u0442\u043E\u043C \u0443\u0441\u0442\u0440\u043E\u0439\u0441\u0442\u0432\u0435, \u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E \u0431\u0440\u0430\u0443\u0437\u0435\u0440 \u043D\u0435 \u0434\u0430\u0451\u0442 \u043F\u0435\u0440\u0435\u0447\u0438\u0441\u043B\u044F\u0442\u044C IndexedDB.";return}F.textContent=`\u041D\u0430\u0439\u0434\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0445 \u0431\u0430\u0437: ${ge.length}`;for(let He of ge){let Be=Ie(He);U.appendChild(Be);let xe=await te(`${l}${He}`).catch(()=>null);if(xe){let qe=await tt(xe,"articles").catch(()=>null);try{xe.close()}catch{}if(typeof qe=="number")try{let We=Be.querySelector('[data-recovery-meta="1"]');We&&(We.textContent=`\u0421\u0442\u0430\u0442\u0435\u0439: ${qe}`)}catch{}}}}catch(ge){F.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430: ${String(ge&&ge.message?ge.message:ge)}`}};document.body.appendChild(de),setTimeout(()=>S.focus({preventScroll:!0}),0)}function fe(){let ee=()=>$();try{window.addEventListener("pointerdown",ee,{passive:!0}),window.addEventListener("keydown",ee,{passive:!0}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&ee()})}catch{}}function ke(){let ee=()=>{try{Promise.resolve().then(()=>(bi(),yi)).then(de=>de.flushOutlineAutosave?.({mode:"queue"})).catch(()=>{})}catch{}try{Promise.resolve().then(()=>(wa(),Sa)).then(de=>de.flushOutboxOnce?.()).catch(()=>{})}catch{}};try{window.addEventListener("pagehide",ee),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&ee()})}catch{}}let Te=!1,ne=ee=>{if(!Te){Te=!0;try{document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>me({reason:ee}),{once:!0}):me({reason:ee})}catch{}}};function Ne({subtitle:ee=null,error:de=null,showRetry:ye=!1,showOffline:Ve=!1}={}){try{let Re=document.getElementById("authOverlay");if(!Re)return;let _e=document.getElementById("authSubtitle"),Ce=document.getElementById("authError");if(_e&&ee!=null&&(_e.textContent=String(ee)),Ce){let E=de!=null?String(de):"";Ce.textContent=E,Ce.classList.toggle("hidden",!E)}let Ge=Re.querySelector(".auth-card")||Re,S=document.getElementById("bootLoadActions");S||(S=document.createElement("div"),S.id="bootLoadActions",S.style.display="flex",S.style.gap="10px",S.style.flexWrap="wrap",S.style.marginTop="12px",Ge.appendChild(S)),S.innerHTML="";let g=(E,T)=>{let _=document.createElement("button");return _.type="button",_.className="auth-submit",_.style.padding="10px 14px",_.style.borderRadius="999px",_.style.fontSize="13px",_.textContent=E,_.addEventListener("click",T),_};if(ye&&S.appendChild(g("\u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C",()=>{try{window.location.reload()}catch{}})),Ve){let E=()=>{let T=!1;try{T=!!("serviceWorker"in navigator&&navigator.serviceWorker?.controller)}catch{T=!1}if(A()&&!T){Ne({subtitle:"\u041D\u0435\u0442 \u0441\u0435\u0442\u0438",error:`\u041E\u0444\u0444\u043B\u0430\u0439\u043D-\u0440\u0435\u0436\u0438\u043C \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u043F\u043E\u0441\u043B\u0435 \u0442\u043E\u0433\u043E, \u043A\u0430\u043A \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435 \u0445\u043E\u0442\u044F \u0431\u044B \u043E\u0434\u0438\u043D \u0440\u0430\u0437 \u043E\u0442\u043A\u0440\u044B\u043B\u043E\u0441\u044C \u0441 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u043E\u043C \u0438 \u0437\u0430\u043A\u0435\u0448\u0438\u0440\u043E\u0432\u0430\u043B\u043E \u0444\u0430\u0439\u043B\u044B.

\u0415\u0441\u043B\u0438 \u0432\u044B \u0442\u043E\u043B\u044C\u043A\u043E \u0447\u0442\u043E \u0443\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u043B\u0438 PWA \u2014 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0435\u0433\u043E \u043E\u043D\u043B\u0430\u0439\u043D, \u0434\u043E\u0436\u0434\u0438\u0442\u0435\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438, \u0437\u0430\u0442\u0435\u043C \u043C\u043E\u0436\u043D\u043E \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u0431\u0435\u0437 \u0441\u0435\u0442\u0438.`,showRetry:!0,showOffline:!0});return}try{window.sessionStorage?.setItem?.(m,"1")}catch{}try{let R=document.getElementById("authSubtitle");R&&(R.textContent="\u041E\u0442\u043A\u0440\u044B\u0432\u0430\u0435\u043C \u0430\u0432\u0442\u043E\u043D\u043E\u043C\u043D\u044B\u0439 \u0440\u0435\u0436\u0438\u043C\u2026");let P=document.getElementById("authError");P&&(P.textContent="",P.classList.add("hidden"))}catch{}try{if(T){window.location.reload();return}}catch{}try{window.location.reload();return}catch{}try{ct({reason:"offline_button",background:!1})}catch{}};S.appendChild(g("\u041E\u0442\u043A\u0440\u044B\u0442\u044C \u043E\u0444\u0444\u043B\u0430\u0439\u043D-\u0431\u0443\u0444\u0435\u0440",()=>{try{E()}catch{}}))}}catch{}}let Ye=!1,Qe=!1;function ct({reason:ee="",background:de=!1}={}){if(!Qe&&!(Ye&&!de)){Ye=!0;try{let ye=import(e);ye&&typeof ye.catch=="function"&&ye.catch(Ve=>{Qe=!0;let _e="\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435. "+(A()?"\u041F\u043E\u0445\u043E\u0436\u0435, \u0441\u0435\u0439\u0447\u0430\u0441 \u043D\u0435\u0442 \u0441\u0435\u0442\u0438.":"\u041F\u043E\u0445\u043E\u0436\u0435, \u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u0435\u0442\u044C\u044E/\u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C.")+" \u041C\u043E\u0436\u043D\u043E \u043F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C \u0432 \u0430\u0432\u0442\u043E\u043D\u043E\u043C\u043D\u043E\u043C \u0440\u0435\u0436\u0438\u043C\u0435 \u0438\u043B\u0438 \u043F\u043E\u043F\u0440\u043E\u0431\u043E\u0432\u0430\u0442\u044C \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443.";if(Ne({subtitle:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",error:_e,showRetry:!0,showOffline:!0}),!h)try{Te||ne("\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438")}catch{}w("app.import.failed",{reason:ee,message:String(Ve?.message||Ve||"")})})}catch(ye){Qe=!0,Ne({subtitle:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",error:"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435. \u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443.",showRetry:!0,showOffline:!0}),w("app.import.throw",{reason:ee,message:String(ye?.message||ye||"")})}}}if(x()){y(),ct({reason:"public",background:!1});return}y();let rt=z(),dt=X(),Xe=A(),mt=I(),ft=q();fe(),ke(),$(),(Xe&&!h||mt||ft||rt&&dt)&&ne(Xe?"\u043D\u0435\u0442 \u0441\u0435\u0442\u0438":mt?"\u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430":ft?"\u043F\u0440\u043E\u0441\u0442\u043E\u0439 > 15 \u043C\u0438\u043D":"\u0445\u043E\u043B\u043E\u0434\u043D\u044B\u0439 \u0441\u0442\u0430\u0440\u0442"),window.setTimeout(()=>{try{if(Te||window.__memusAppStarted||h)return;Ne({subtitle:"\u041C\u0435\u0434\u043B\u0435\u043D\u043D\u0430\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430\u2026",error:"\u0415\u0441\u043B\u0438 \u0441\u0435\u0442\u044C \u043D\u0435\u0441\u0442\u0430\u0431\u0438\u043B\u044C\u043D\u0430, \u043C\u043E\u0436\u043D\u043E \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u043E\u0444\u0444\u043B\u0430\u0439\u043D-\u0431\u0443\u0444\u0435\u0440. \u041F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435 \u043F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442 \u043F\u044B\u0442\u0430\u0442\u044C\u0441\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C\u0441\u044F \u0432 \u0444\u043E\u043D\u0435.",showRetry:!0,showOffline:!0}),ne("\u043C\u0435\u0434\u043B\u0435\u043D\u043D\u0430\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430")}catch{}},s),Te||Xe?ce(()=>ct({reason:"idle",background:!0}),{timeout:5e3,fallbackDelay:1200}):ct({reason:"foreground",background:!1})})();
