var tu=Object.defineProperty;var Ge=(e,t)=>()=>(e&&(t=e(e=0)),t);var Do=(e,t)=>{for(var n in t)tu(e,n,{get:t[n],enumerable:!0})};function La(e){qi=e}var u,qi,Bt=Ge(()=>{u={mode:"view",serverStatus:"unknown",serverStatusText:"",offlineReady:!1,offlineInitStatus:"idle",offlineInitError:"",offlineInitStartedAt:null,mediaStatusText:"",mediaPrefetchPaused:!1,isOutlineEditing:!1,outlineStatusText:"",isPublicView:!1,isRagView:!1,currentUser:null,articleId:null,article:null,currentBlockId:null,editingBlockId:null,selectionAnchorBlockId:null,selectedBlockIds:[],undoStack:[],redoStack:[],pendingTextPreview:null,editingUndo:null,editingInitialText:"",searchQuery:"",searchResults:[],searchError:"",searchLoading:!1,searchRequestId:0,searchMode:"classic",sidebarSearchView:"list",ragQuery:"",ragResults:[],ragBlockMap:{},ragSummaryHtml:"",ragSummaryLoading:!1,ragSummaryError:"",scrollTargetBlockId:null,pendingEditBlockId:null,isEditingTitle:!1,isSidebarCollapsed:!1,isSidebarMobileOpen:!1,articlesIndex:[],deletedArticlesIndex:[],articleFilterQuery:"",isMarkdownInserting:!1,isTrashView:!1,favoriteArticles:[],sidebarArticlesMode:"tree",recentArticleIds:[],sidebarSelectedArticleId:null,listSelectedArticleId:null,sidebarCollapsedArticleIds:[],listCollapsedArticleIds:[],isDragModeEnabled:!1,articleEncryptionKeys:{},isMergingBlocks:!1,isMovingBlock:!1,isDeletingBlock:!1,moveQueue:[],isMoveQueueProcessing:!1,editingScrollTop:null,editingCaretPosition:"start",outboxCount:null,offlineArticlesWithDoc:null,offlineArticlesTotal:null},qi=!1});var j,In=Ge(()=>{j={authOverlay:document.getElementById("authOverlay"),authLoginTab:document.getElementById("authLoginTab"),authRegisterTab:document.getElementById("authRegisterTab"),authLoginForm:document.getElementById("authLoginForm"),authRegisterForm:document.getElementById("authRegisterForm"),authLoginUsername:document.getElementById("authLoginUsername"),authLoginPassword:document.getElementById("authLoginPassword"),authRegisterUsername:document.getElementById("authRegisterUsername"),authRegisterPassword:document.getElementById("authRegisterPassword"),authRegisterDisplayName:document.getElementById("authRegisterDisplayName"),authError:document.getElementById("authError"),authSubtitle:document.getElementById("authSubtitle"),authGoogleLoginBtn:document.getElementById("authGoogleLoginBtn"),authYandexLoginBtn:document.getElementById("authYandexLoginBtn"),authStorageInfo:document.getElementById("authStorageInfo"),currentUserLabel:document.getElementById("currentUserLabel"),logoutBtn:document.getElementById("logoutBtn"),userMenuBtn:document.getElementById("userMenuBtn"),userMenu:document.getElementById("userMenu"),sidebarSyncStatusPill:document.getElementById("sidebarSyncStatusPill"),syncMenu:document.getElementById("syncMenu"),syncMenuStatusLabel:document.getElementById("syncMenuStatusLabel"),syncMenuArticlesLabel:document.getElementById("syncMenuArticlesLabel"),syncMenuOutboxLabel:document.getElementById("syncMenuOutboxLabel"),offlineStatusItem:document.getElementById("offlineStatusItem"),offlineStatusLabel:document.getElementById("offlineStatusLabel"),offlineFetchBtn:document.getElementById("offlineFetchBtn"),offlineRepairBtn:document.getElementById("offlineRepairBtn"),telegramLinkBtn:document.getElementById("telegramLinkBtn"),telegramBotOpenBtn:document.getElementById("telegramBotOpenBtn"),telegramFeedbackBotOpenBtn:document.getElementById("telegramFeedbackBotOpenBtn"),openUsersViewBtn:document.getElementById("openUsersViewBtn"),usersView:document.getElementById("usersView"),usersList:document.getElementById("usersList"),usersBackBtn:document.getElementById("usersBackBtn"),graphView:document.getElementById("graphView"),graphCanvas:document.getElementById("graphCanvas"),graphBackBtn:document.getElementById("graphBackBtn"),articleListView:document.getElementById("articleListView"),articleView:document.getElementById("articleView"),articleHeader:document.getElementById("articleHeader"),articleTitle:document.getElementById("articleTitle"),updatedAt:document.getElementById("updatedAt"),articleStatusText:document.getElementById("articleStatusText"),mediaStatusText:document.getElementById("mediaStatusText"),mediaPrefetchToggleBtn:document.getElementById("mediaPrefetchToggleBtn"),blocksContainer:document.getElementById("blocksContainer"),articleList:document.getElementById("articleList"),createArticleBtn:document.getElementById("createArticleBtn"),backToList:document.getElementById("backToList"),toast:document.getElementById("toast"),searchInput:document.getElementById("searchInput"),searchClearBtn:document.getElementById("searchClearBtn"),searchResults:document.getElementById("searchResults"),searchPanel:document.querySelector(".search-panel"),searchModeToggle:document.getElementById("searchModeToggle"),sidebarSearchViewToggle:document.getElementById("sidebarSearchViewToggle"),ragOpenBtn:document.getElementById("ragOpenBtn"),articleTitleInput:document.getElementById("articleTitleInput"),editTitleBtn:document.getElementById("editTitleBtn"),hintToggleBtn:document.getElementById("hintToggleBtn"),hintPopover:document.getElementById("hintPopover"),sidebar:document.getElementById("sidebar"),sidebarToggle:document.getElementById("sidebarToggle"),sidebarArticleList:document.getElementById("sidebarArticleList"),sidebarNewArticleBtn:document.getElementById("sidebarNewArticleBtn"),sidebarRecentBtn:document.getElementById("sidebarRecentBtn"),openInboxBtn:document.getElementById("openInboxBtn"),quickNoteAddBtn:document.getElementById("quickNoteAddBtn"),articleFilterInput:document.getElementById("articleFilterInput"),trashTabBtn:document.getElementById("trashTabBtn"),articlesTabBtn:document.getElementById("articlesTabBtn"),semanticReindexBtn:document.getElementById("semanticReindexBtn"),graphToggleBtn:document.getElementById("graphToggleBtn"),listMenuBtn:document.getElementById("listMenuBtn"),listMenu:document.getElementById("listMenu"),articleMenuBtn:document.getElementById("articleMenuBtn"),articleMenu:document.getElementById("articleMenu"),articleFavoriteBtn:document.getElementById("articleFavoriteBtn"),articlePublicLinkBtn:document.getElementById("articlePublicLinkBtn"),articlePublicToggleBtn:document.getElementById("articlePublicToggleBtn"),articleEncryptionBtn:document.getElementById("articleEncryptionBtn"),articleEncryptionRemoveBtn:document.getElementById("articleEncryptionRemoveBtn"),deleteArticleBtn:document.getElementById("deleteArticleBtn"),exportArticleBtn:document.getElementById("exportArticleBtn"),outlineEditBtn:document.getElementById("outlineEditBtn"),saveVersionBtn:document.getElementById("saveVersionBtn"),versionsBtn:document.getElementById("versionsBtn"),blockHistoryBtn:document.getElementById("blockHistoryBtn"),articleHistoryBtn:document.getElementById("articleHistoryBtn"),exportAllHtmlZipBtn:document.getElementById("exportAllHtmlZipBtn"),importArticleBtn:document.getElementById("importArticleBtn"),importMarkdownBtn:document.getElementById("importMarkdownBtn"),importLogseqBtn:document.getElementById("importLogseqBtn"),importBackupFolderBtn:document.getElementById("importBackupFolderBtn"),articleUndoBtn:document.getElementById("articleUndoBtn"),articleRedoBtn:document.getElementById("articleRedoBtn"),mergeBlocksBtn:document.getElementById("mergeBlocksBtn"),splitBlockBtn:document.getElementById("splitBlockBtn"),insertTableBtn:document.getElementById("insertTableBtn"),deleteCurrentBlockBtn:document.getElementById("deleteCurrentBlockBtn"),exportCurrentBlockBtn:document.getElementById("exportCurrentBlockBtn"),articleBlockTrashBtn:document.getElementById("articleBlockTrashBtn"),articleNewBlockBtn:document.getElementById("articleNewBlockBtn"),articleToolbar:document.getElementById("articleToolbar"),outlineToolbar:document.getElementById("outlineToolbar"),outlineTagsBar:document.getElementById("outlineTagsBar"),outlineUndoBtn:document.getElementById("outlineUndoBtn"),outlineRedoBtn:document.getElementById("outlineRedoBtn"),outlineDeleteBtn:document.getElementById("outlineDeleteBtn"),outlineMoveUpBtn:document.getElementById("outlineMoveUpBtn"),outlineMoveDownBtn:document.getElementById("outlineMoveDownBtn"),outlineOutdentBtn:document.getElementById("outlineOutdentBtn"),outlineIndentBtn:document.getElementById("outlineIndentBtn"),outlineNewBelowBtn:document.getElementById("outlineNewBelowBtn"),outlineBoldBtn:document.getElementById("outlineBoldBtn"),outlineBulletListBtn:document.getElementById("outlineBulletListBtn"),outlineOrderedListBtn:document.getElementById("outlineOrderedListBtn"),outlineBlockquoteBtn:document.getElementById("outlineBlockquoteBtn"),outlineCodeBtn:document.getElementById("outlineCodeBtn"),outlineInsertTableBtn:document.getElementById("outlineInsertTableBtn"),outlineDeleteTableBtn:document.getElementById("outlineDeleteTableBtn"),outlineAddRowBtn:document.getElementById("outlineAddRowBtn"),outlineAddColBtn:document.getElementById("outlineAddColBtn"),pasteProgress:document.getElementById("pasteProgress"),mobileSidebarBtn:document.getElementById("mobileSidebarBtn"),sidebarBackdrop:document.getElementById("sidebarBackdrop"),dragModeToggleBtn:document.getElementById("dragModeToggleBtn"),listSidebarBtn:document.getElementById("listSidebarBtn"),outlineEditor:document.getElementById("outlineEditor")}});function Pa(){ro!==null&&(clearTimeout(ro),ro=null)}function Vi(e){Ki=!!e,j.toast&&(Ki?j.toast.dataset.protected="true":j.toast.removeAttribute("data-protected"))}function Ie(e,t={}){if(!j.toast)return;let n=typeof t.duration=="number"?t.duration:2500;t.protect?Vi(!0):Vi(!1),Pa(),j.toast.textContent=e,j.toast.classList.remove("hidden"),requestAnimationFrame(()=>{j.toast.classList.add("show")}),n>0&&(ro=setTimeout(()=>{j.toast.classList.remove("show"),setTimeout(()=>j.toast.classList.add("hidden"),200),ro=null},n))}function ji(e,t={}){Ie(e,{...t,duration:0})}function mr(e={}){j.toast&&(Ki&&!e.force||(Pa(),Vi(!1),j.toast.classList.remove("show"),j.toast.classList.add("hidden")))}var ro,Ki,en=Ge(()=>{In();ro=null,Ki=!1;j.toast&&j.toast.addEventListener("click",()=>{mr()})});function Re(e){return new Promise((t,n)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error||new Error("IndexedDB request failed"))})}function Nr(e,t,n={}){let r=t instanceof Error?t:new Error(String(t?.message||t||"IndexedDB error"));try{r.idbKind=String(e||"unknown"),r.cause=t,r.extra=n}catch{}return r}function Xe(e){return new Promise((t,n)=>{e.oncomplete=()=>t(),e.onabort=()=>n(e.error||new Error("IndexedDB transaction aborted")),e.onerror=()=>n(e.error||new Error("IndexedDB transaction failed"))})}function nu(e){return String(e||"anon").replace(/[^a-zA-Z0-9_-]/g,"_")}function ru(e){return`memus_offline_v1_${nu(e)}`}function iu(e){try{let t=String(e||"").trim();if(!t)return;let n=window?.localStorage?.getItem?.(_a)||"[]",r=JSON.parse(n),o=Array.isArray(r)?r:[];o.includes(t)||o.push(t),window.localStorage.setItem(_a,JSON.stringify(o.slice(-200)))}catch{}}async function Da({userKey:e}={}){let t=e||"anon";iu(t);let n=ru(t);if(typeof indexedDB>"u"){let a=new Error("IndexedDB is not available in this browser");throw a.name="IDBNotSupportedError",Nr("no_idb",a,{name:n})}let r=indexedDB.open(n,ou),o=3e3,i=!1;r.onblocked=()=>{i=!0},r.onupgradeneeded=()=>{let a=r.result;if(a.objectStoreNames.contains("meta")||a.createObjectStore("meta",{keyPath:"key"}),!a.objectStoreNames.contains("articles")){let c=a.createObjectStore("articles",{keyPath:"id"});c.createIndex("byUpdatedAt","updatedAt",{unique:!1}),c.createIndex("byDeletedAt","deletedAt",{unique:!1})}if(!a.objectStoreNames.contains("outline_sections")){let c=a.createObjectStore("outline_sections",{keyPath:"sectionId"});c.createIndex("byArticleId","articleId",{unique:!1}),c.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!a.objectStoreNames.contains("section_embeddings")){let c=a.createObjectStore("section_embeddings",{keyPath:"sectionId"});c.createIndex("byArticleId","articleId",{unique:!1}),c.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!a.objectStoreNames.contains("media_assets")){let c=a.createObjectStore("media_assets",{keyPath:"url"});c.createIndex("byStatus","status",{unique:!1}),c.createIndex("byFetchedAtMs","fetchedAtMs",{unique:!1}),c.createIndex("byStatusFetchedAtMs",["status","fetchedAtMs"],{unique:!1})}if(!a.objectStoreNames.contains("media_refs")){let c=a.createObjectStore("media_refs",{keyPath:"key"});c.createIndex("byArticleId","articleId",{unique:!1}),c.createIndex("byUrl","url",{unique:!1})}if(a.objectStoreNames.contains("outbox")){let c=r.transaction;try{let l=c.objectStore("outbox");l.indexNames.contains("byTypeCoalesceKey")||l.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}catch{}}else{let c=a.createObjectStore("outbox",{keyPath:"id"});c.createIndex("byCreatedAtMs","createdAtMs",{unique:!1}),c.createIndex("byTypeArticleId",["type","articleId"],{unique:!1}),c.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}if(!a.objectStoreNames.contains("pending_uploads")){let c=a.createObjectStore("pending_uploads",{keyPath:"token"});c.createIndex("byArticleId","articleId",{unique:!1}),c.createIndex("byCreatedAtMs","createdAtMs",{unique:!1})}if(!a.objectStoreNames.contains("tags_global")){let c=a.createObjectStore("tags_global",{keyPath:"key"});c.createIndex("byCount","count",{unique:!1}),c.createIndex("byLastSeenAtMs","lastSeenAtMs",{unique:!1})}a.objectStoreNames.contains("tags_by_article")||a.createObjectStore("tags_by_article",{keyPath:"articleId"}).createIndex("byUpdatedAt","updatedAt",{unique:!1})};let s=await Promise.race([Re(r),new Promise((a,c)=>{setTimeout(()=>{let l=new Error(i?"IndexedDB upgrade is blocked by another tab":"IndexedDB open timeout");l.name=i?"IDBBlockedError":"IDBTimeoutError",c(Nr(i?"blocked":"timeout",l,{name:n}))},o)})]).catch(a=>{let c=String(a?.name||"");throw c==="IDBBlockedError"||c==="IDBTimeoutError"?a:c==="SecurityError"?Nr("security",a,{name:n}):c==="InvalidStateError"?Nr("invalid_state",a,{name:n}):c==="QuotaExceededError"?Nr("quota",a,{name:n}):Nr("unknown",a,{name:n})});try{s.onversionchange=()=>{try{s.close()}catch{}}}catch{}return s}async function Oa(e){let t=e.transaction(["meta"],"readonly"),n=t.objectStore("meta");await Re(n.get("ping")),await Xe(t)}var ou,_a,Cn=Ge(()=>{ou=4,_a="ttree_offline_known_user_keys_v1"});async function Ro({userKey:e}={}){let t=String(e||"").trim();if(!t||t==="anon")try{let n=window?.localStorage?.getItem?.("ttree_offline_user_key_v1")||"",r=String(n||"").trim();r&&(t=r)}catch{}if(!t||t==="anon")try{let n=window?.localStorage?.getItem?.("ttree_last_user_v1")||"",r=n?JSON.parse(n):null,o=String(r?.id||r?.username||"").trim();o&&(t=o)}catch{}return t||(t="anon"),Oo&&Ra===t||(Ra=t,Oo=(async()=>await Da({userKey:t}))()),Oo}var Oo,Ra,Ji=Ge(()=>{Cn();Oo=null,Ra=null});function $o(){try{return window?.localStorage?.getItem?.(su)==="1"}catch{return!1}}function za(){try{return window?.localStorage?.getItem?.(au)==="1"}catch{return!1}}function Wi(e,t={}){try{if(!$o())return;console.log("[perf][offline]",e,t)}catch{}}function cu(){try{let e=window.__BUILD_ID__;return e?String(e):""}catch{return""}}function Yi(e,t){try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:e,data:t})}).catch(()=>{})}catch{}}async function Gi(){let e={};try{e.ua=navigator?.userAgent||""}catch{e.ua=""}try{e.buildId=cu()}catch{e.buildId=""}try{e.onLine=navigator?.onLine!==!1}catch{e.onLine=null}try{e.indexedDB=typeof indexedDB<"u"}catch{e.indexedDB=null}try{e.storagePersist=typeof navigator?.storage?.persist=="function"}catch{e.storagePersist=null}try{e.storageEstimate=typeof navigator?.storage?.estimate=="function"}catch{e.storageEstimate=null}try{if(navigator?.storage?.estimate){let t=await navigator.storage.estimate().catch(()=>null);t&&typeof t=="object"&&(e.quota=Number(t.quota||0)||null,e.usage=Number(t.usage||0)||null)}}catch{}return e}function lu(e){try{let t=window?.localStorage?.getItem?.("ttree_offline_user_key_v1")||"",n=String(t||"").trim();if(n)return n}catch{}return e&&(e.id||e.username)||"anon"}function du(e){let t=String(e?.idbKind||"").trim(),n=String(e?.name||"").trim(),r=String(e?.message||"").trim();return t==="no_idb"||n==="IDBNotSupportedError"?{status:"unavailable",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u0432 \u044D\u0442\u043E\u043C \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435 (\u043D\u0435\u0442 IndexedDB). \u041E\u0444\u0444\u043B\u0430\u0439\u043D \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u0435\u0442."}:t==="security"||n==="SecurityError"?{status:"unavailable",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u0437\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u0430 \u043D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0430\u043C\u0438 \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0430/\u043F\u0440\u0438\u0432\u0430\u0442\u043D\u044B\u043C \u0440\u0435\u0436\u0438\u043C\u043E\u043C. \u041E\u0444\u0444\u043B\u0430\u0439\u043D \u043D\u0435 \u0440\u0430\u0431\u043E\u0442\u0430\u0435\u0442."}:t==="blocked"||n==="IDBBlockedError"?{status:"blocked",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u0437\u0430\u043D\u044F\u0442\u0430 \u0434\u0440\u0443\u0433\u043E\u0439 \u0432\u043A\u043B\u0430\u0434\u043A\u043E\u0439 Memus. \u0417\u0430\u043A\u0440\u043E\u0439\u0442\u0435 \u0434\u0440\u0443\u0433\u0438\u0435 \u0432\u043A\u043B\u0430\u0434\u043A\u0438 \u0438 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443."}:t==="timeout"||n==="IDBTimeoutError"?{status:"timeout",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435 \u043E\u0442\u0432\u0435\u0447\u0430\u0435\u0442 (\u0432\u043A\u043B\u0430\u0434\u043A\u0430 \u043C\u043E\u0433\u043B\u0430 \u201C\u0443\u0441\u043D\u0443\u0442\u044C\u201D). \u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443."}:t==="quota"||n==="QuotaExceededError"?{status:"quota",message:"\u041D\u0435\u0434\u043E\u0441\u0442\u0430\u0442\u043E\u0447\u043D\u043E \u043C\u0435\u0441\u0442\u0430 \u0434\u043B\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u043A\u044D\u0448\u0430. \u041E\u0447\u0438\u0441\u0442\u0438\u0442\u0435 \u043A\u044D\u0448 \u043A\u0430\u0440\u0442\u0438\u043D\u043E\u043A \u0438\u043B\u0438 \u043E\u0441\u0432\u043E\u0431\u043E\u0434\u0438\u0442\u0435 \u043C\u0435\u0441\u0442\u043E \u0432 \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0435."}:t==="invalid_state"||n==="InvalidStateError"?{status:"error",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043F\u043E\u0432\u0440\u0435\u0436\u0434\u0435\u043D\u0430 \u0438\u043B\u0438 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430. \u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438\u043B\u0438 \u0441\u0431\u0440\u043E\u0441\u0438\u0442\u044C \u043E\u0444\u0444\u043B\u0430\u0439\u043D\u2011\u043A\u044D\u0448."}:r?{status:"error",message:`\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430: ${r}`}:{status:"error",message:"\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430."}}async function uu(e){let t=lu(e);if(Mr&&Ha===t)return Mr;Ha=t,$a+=1;let n=$a;return Mr=(async()=>{let r=$o()?performance.now():0;u.offlineReady=!1,u.offlineInitStatus="initializing",u.offlineInitError="",u.offlineInitStartedAt=Date.now();try{if(Fa!==n){Fa=n;let o=await Gi().catch(()=>({}));Yi("offline.init.start",{t:new Date().toISOString(),attempt:n,userKey:t,env:o})}}catch{}try{za()&&console.log("[offline] init start",{userKey:t})}catch{}try{let o=$o()?performance.now():0,i=await Ro({userKey:t});o&&Wi("getOfflineDb()",{ms:Math.round(performance.now()-o)});let s=$o()?performance.now():0;await Oa(i),s&&Wi("idb.ping",{ms:Math.round(performance.now()-s)});try{navigator?.storage?.persist&&navigator.storage.persist().catch(()=>{})}catch{}u.offlineReady=!0,u.offlineInitStatus="ready",u.offlineInitError="",u.offlineInitStartedAt=null;try{if(Ho!==n){Ho=n;let a=await Gi().catch(()=>({}));Yi("offline.init.ready",{t:new Date().toISOString(),attempt:n,userKey:t,env:a})}}catch{}try{za()&&console.log("[offline] init ready")}catch{}return r&&Wi("initOfflineForUser.total",{userKey:t,ms:Math.round(performance.now()-r)}),i}catch(o){u.offlineReady=!1;let i=du(o);u.offlineInitStatus=i.status||"error",u.offlineInitStartedAt=null;try{console.error("[offline] init failed",o)}catch{}let s=i.message;u.offlineInitError=s,Ie(s);try{if(Ho!==n){Ho=n;let a=await Gi().catch(()=>({}));Yi("offline.init.failed",{t:new Date().toISOString(),attempt:n,userKey:t,msg:s,err:{name:String(o?.name||""),message:String(o?.message||""),stack:String(o?.stack||"").slice(0,1500)},env:a})}}catch{}throw o}})(),Mr}async function ht(){return Mr||uu(u.currentUser)}var Mr,Ha,$a,Fa,Ho,su,au,Qn=Ge(()=>{Bt();en();Ji();Cn();Mr=null,Ha=null,$a=0,Fa=null,Ho=null,su="ttree_profile_v1",au="ttree_debug_offline_v1"});function Xi(e){if(!e)return"";if(e.type==="text")return String(e.text||"");let t=Array.isArray(e.content)?e.content:[];if(!t.length)return"";let n=[];for(let r of t){let o=Xi(r);o&&n.push(o),r&&(r.type==="paragraph"||r.type==="hardBreak"||r.type==="heading")&&n.push(`
`)}return n.join("")}function Ua(e){return String(e||"").replace(/\r\n/g,`
`).replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}function qa(e,t=[]){for(let n of e||[]){if(!n||n.type!=="outlineSection")continue;let r=String(n.attrs?.id||""),o=n.content?.[0],i=n.content?.[1],s=n.content?.[2],a=Ua(Xi(o))||"",c=Ua(Xi(i))||"",l=`${a}
${c}`.trim();r&&t.push({sectionId:r,title:a,text:l});let d=s?.content||[];qa(d,t)}return t}function fu(e){let t=Array.isArray(e?.content)?e.content:[];return qa(t,[])}function pu(e){return String(e||"").trim().toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9а-яё_-]/gi,"")}function Ka(e,t){for(let n of e||[]){if(!n)continue;if(n.type==="tag"){let o=n.attrs?.key||n.attrs?.label||"",i=pu(o);i&&t.add(i)}let r=Array.isArray(n.content)?n.content:[];r.length&&Ka(r,t)}}function mu(e){let t=new Set,n=Array.isArray(e?.content)?e.content:[];return Ka(n,t),Array.from(t)}async function Fo(e,{articleId:t,docJson:n,updatedAt:r}){if(!e||!t||!n||typeof n!="object")return;let o=String(t),i=mu(n),s=Date.now(),a=e.transaction(["tags_by_article","tags_global"],"readwrite"),c=a.objectStore("tags_by_article"),l=a.objectStore("tags_global"),d=await Re(c.get(o)).catch(()=>null),m=new Set(Array.isArray(d?.tags)?d.tags.map(p=>String(p||"").trim()).filter(Boolean):[]),h=new Set(i),b=[],S=[];for(let p of m)h.has(p)||b.push(p);for(let p of h)m.has(p)||S.push(p);for(let p of b){let f=await Re(l.get(p)).catch(()=>null),w=Math.max(0,(Number(f?.count||0)||0)-1);w<=0?await Re(l.delete(p)).catch(()=>{}):await Re(l.put({...f||{},key:p,label:String(f?.label||p),count:w,lastSeenAtMs:Number(f?.lastSeenAtMs||0)||0})).catch(()=>{})}for(let p of h){let f=await Re(l.get(p)).catch(()=>null),w=(Number(f?.count||0)||0)+(S.includes(p)?1:0);await Re(l.put({...f||{},key:p,label:String(f?.label||p),count:Math.max(1,w),lastSeenAtMs:s})).catch(()=>{})}await Re(c.put({articleId:o,tags:i,updatedAt:r||null,indexedAtMs:s})),await Xe(a)}async function zo(e,{articleId:t,docJson:n,updatedAt:r}){if(!e||!t||!n||typeof n!="object")return;let o=fu(n),i=e.transaction(["outline_sections"],"readwrite"),s=i.objectStore("outline_sections"),a=s.index("byArticleId"),c=IDBKeyRange.only(String(t)),l=await Re(a.openCursor(c));for(;l;)l.delete(),l=await Re(l.continue());for(let d of o)await Re(s.put({sectionId:d.sectionId,articleId:String(t),title:d.title||"",text:d.text||"",updatedAt:r||null}));await Xe(i)}var Va=Ge(()=>{Cn()});function gu(){try{return localStorage.getItem(hu)==="1"}catch{return!1}}function yu(e){let t=String(e||"").trim();if(!t)return null;try{let n=new URL(t,window.location.origin);return n.origin!==window.location.origin?/^https?:\/\/memus\.pro\b/i.test(t)&&n.pathname.startsWith("/uploads/")?n.pathname+(n.search||""):null:n.pathname.startsWith("/uploads/")?n.pathname+(n.search||""):null}catch{return t.startsWith("/uploads/")?t:null}}function bu(e){let t=new Set,n=r=>{if(!r)return;if(Array.isArray(r)){r.forEach(n);return}if(r.type==="image"){let i=yu(r.attrs?.src);i&&t.add(i)}(Array.isArray(r.content)?r.content:[]).forEach(n)};return n(e?.content||[]),Array.from(t)}async function Lr(e,t){let n=await ht(),r=bu(t),o=n.transaction(["media_refs","media_assets"],"readwrite"),i=o.objectStore("media_refs"),s=o.objectStore("media_assets"),a=i.index("byArticleId"),c=IDBKeyRange.only(String(e)),l=await Re(a.openCursor(c)).catch(()=>null);for(;l;)l.delete(),l=await Re(l.continue()).catch(()=>null);for(let d of r){let m=`${String(e)}|${String(d)}`;await Re(i.put({key:m,articleId:String(e),url:String(d)})),await Re(s.get(d)).catch(()=>null)||await Re(s.put({url:String(d),status:"needed",fetchedAtMs:0,failCount:0,lastError:null}))}await Xe(o)}async function ja(e,t){let n=e.transaction(["media_assets"],"readwrite"),r=n.objectStore("media_assets"),o=await Re(r.get(t)).catch(()=>null);await Re(r.put({...o||{},url:String(t),status:"ok",fetchedAtMs:Date.now(),failCount:0,lastError:null})),await Xe(n)}async function Su(e,t,n){let r=String(n?.message||n||"error"),o=e.transaction(["media_assets"],"readwrite"),i=o.objectStore("media_assets"),s=await Re(i.get(t)).catch(()=>null),a=Number(s?.failCount||0)+1;await Re(i.put({...s||{},url:String(t),status:"error",fetchedAtMs:Date.now(),failCount:a,lastError:r})),await Xe(o)}async function wu(e,t){let n=e.transaction(["media_assets"],"readonly"),o=n.objectStore("media_assets").index("byFetchedAtMs"),i=[],s=await Re(o.openCursor()).catch(()=>null);for(;s;){let a=s.value,c=String(a?.status||""),l=Number(a?.failCount||0);if(c!=="ok"&&l<5){let d=String(a?.url||"");if(d&&i.push(d),i.length>=t)break}s=await Re(s.continue()).catch(()=>null)}return await Xe(n),i}async function xu(e,t){try{return!!await e.match(t,{ignoreSearch:!1})}catch{return!1}}async function Au(e,t){let n=await fetch(t,{credentials:"include"});if(!n||!n.ok)throw new Error(`HTTP ${n?.status||0}`);await e.put(t,n.clone())}function Iu(){try{let e=navigator.connection||navigator.mozConnection||navigator.webkitConnection,t=String(e?.effectiveType||"");if(!!e?.saveData||t.includes("2g"))return 1;if(t.includes("3g"))return 2}catch{}return 3}function Ya(){if(Ja)return;Ja=!0;let e=async()=>{if(!navigator.onLine||gu())return;let t=Iu();if(Uo>=t)return;let n=await ht(),r=await caches.open(Wa),o=await wu(n,Math.max(5,t*3));if(o.length)for(let i of o){if(Uo>=t)break;Uo+=1,(async()=>{try{if(await xu(r,i)){await ja(n,i);return}await Au(r,i),await ja(n,i)}catch(s){await Su(n,i,s)}finally{Uo-=1}})()}};setInterval(()=>{e().catch(()=>{})},1200),window.addEventListener("online",()=>{e().catch(()=>{})})}async function Ga(){let e=await ht(),t=await caches.open(Wa),n=e.transaction(["media_assets","media_refs"],"readwrite"),r=n.objectStore("media_assets"),i=n.objectStore("media_refs").index("byUrl"),s=[],a=await Re(r.openCursor()).catch(()=>null);for(;a&&s.length<500;){let c=String(a.value?.url||"");c&&(await Re(i.count(IDBKeyRange.only(c))).catch(()=>0)||(s.push(c),a.delete())),a=await Re(a.continue()).catch(()=>null)}if(await Xe(n),!s.length)return 0;for(let c of s)try{await t.delete(c)}catch{}return s.length}var Wa,hu,Ja,Uo,Qi=Ge(()=>{Qn();Cn();Wa="memus-uploads-v1",hu="ttree_media_prefetch_paused_v1";Ja=!1,Uo=0});function Zi(){try{window.dispatchEvent(new CustomEvent("offline-outbox-changed"))}catch{}}function ku(){return globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?globalThis.crypto.randomUUID():`id-${Date.now()}-${Math.random().toString(16).slice(2)}`}function Xa(){return new Date().toISOString()}async function tn(e,{articleId:t,payload:n,coalesceKey:r}={}){let o=await ht(),i=ku(),s=Xa(),a=n?JSON.stringify(n):"{}",c=o.transaction(["outbox"],"readwrite"),l=c.objectStore("outbox"),d=l.index("byTypeArticleId"),m=l.index("byTypeCoalesceKey");if(r){let h=[String(e||""),String(r||"")],b=await Re(m.openCursor(IDBKeyRange.only(h))).catch(()=>null);for(;b;)b.delete(),b=await Re(b.continue()).catch(()=>null)}else if(t){let h=[String(e||""),t||null],b=await Re(d.openCursor(IDBKeyRange.only(h))).catch(()=>null);for(;b;)b.delete(),b=await Re(b.continue()).catch(()=>null)}return await Re(l.put({id:i,createdAt:s,createdAtMs:Date.now(),type:String(e||""),articleId:t||null,coalesceKey:r?String(r):null,payloadJson:a,attempts:0,lastError:null,lastAttemptAt:null})),await Xe(c),Zi(),i}async function hr(e=50){let n=(await ht()).transaction(["outbox"],"readonly"),o=n.objectStore("outbox").index("byCreatedAtMs"),i=[],s=await Re(o.openCursor()).catch(()=>null);for(;s&&(i.push(s.value),!(i.length>=e));)s=await Re(s.continue()).catch(()=>null);return await Xe(n),i.map(a=>{let c={};try{c=JSON.parse(a?.payloadJson||"{}")}catch{c={}}return{id:a.id,createdAt:a.createdAt,type:a.type,articleId:a.articleId,payload:c,attempts:a.attempts||0}})}async function Eu(e=[],t=null){let n=String(t||"").trim(),r=Array.isArray(e)?e.map(c=>String(c||"").trim()).filter(Boolean):[];if(!n||!r.length)return!1;let i=(await ht()).transaction(["outbox"],"readonly"),a=i.objectStore("outbox").index("byTypeArticleId");for(let c of r)try{let l=[String(c),n];if(await Re(a.openCursor(IDBKeyRange.only(l))).catch(()=>null))return await Xe(i),!0}catch{}return await Xe(i),!1}async function Qa(e){return Eu(["delete_sections","section_upsert_content","structure_snapshot","save_doc_json"],e)}async function Za(e,t){let r=(await ht()).transaction(["outbox"],"readwrite"),o=r.objectStore("outbox"),i=await Re(o.get(e)).catch(()=>null);i&&await Re(o.put({...i,attempts:Number(i.attempts||0)+1,lastError:String(t||"error"),lastAttemptAt:Xa()})),await Xe(r),Zi()}async function Zn(e){let n=(await ht()).transaction(["outbox"],"readwrite"),r=n.objectStore("outbox");await Re(r.delete(e)),await Xe(n),Zi()}var Pr=Ge(()=>{Qn();Cn()});function tc(e){oo.counts=new Map,oo.labelByKey=new Map;for(let t of e||[]){let n=String(t?.key||"").trim();if(!n)continue;let r=Number(t?.count||0)||0,o=String(t?.label||n);oo.counts.set(n,r),oo.labelByKey.set(n,o)}ec=!0}async function nc(e){let t=e.transaction(["tags_global"],"readonly"),n=t.objectStore("tags_global"),r=await Re(n.getAll()).catch(()=>[]);return await Xe(t),Array.isArray(r)?r:[]}function rc(){return oo}function oc(){ec||es||(es=(async()=>{try{let e=await ht(),t=await nc(e);tc(t)}catch{}finally{es=null}})())}function qo(){ts||(ts=setTimeout(()=>{ts=null,Cu().catch(()=>{})},800))}async function Cu(){try{let e=await ht(),t=await nc(e);tc(t)}catch{}}var ec,es,ts,oo,ns=Ge(()=>{Qn();Cn();ec=!1,es=null,ts=null,oo={counts:new Map,labelByKey:new Map}});function Nu(e=null){try{if(window?.localStorage?.getItem?.(vu)!=="1")return!1;let t=String(window?.localStorage?.getItem?.(Tu)||"").trim();if(!t)return!0;let n=String(e||"").trim();return n?n===t:!0}catch{return!1}}function Mu(){try{return window?.localStorage?.getItem?.(Bu)==="1"}catch{return!1}}function Lu(e){try{return JSON.stringify(e)}catch{return'"[unserializable]"'}}function Pu(e){try{let t=String(e||""),n=2166136261;for(let r=0;r<t.length;r+=1)n^=t.charCodeAt(r),n=Math.imul(n,16777619);return(n>>>0).toString(16)}catch{return"0"}}function $t(e){try{return!e||typeof e!="object"?null:Pu(Lu(e))}catch{return null}}function dt(e,t={}){try{let n=t?.articleId?String(t.articleId):null;if(!Nu(n))return!1;let r={t:new Date().toISOString(),kind:String(e||"event"),data:t&&typeof t=="object"?t:{value:t}},o=[];try{let i=window?.localStorage?.getItem?.(Ko)||"";o=i?JSON.parse(i):[],Array.isArray(o)||(o=[])}catch{o=[]}o.push(r),o.length>250&&(o=o.slice(o.length-250));try{window?.localStorage?.setItem?.(Ko,JSON.stringify(o))}catch{}if(Mu()&&navigator.onLine!==!1)try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:`revert:${r.kind}`,data:r})}).catch(()=>{})}catch{}return!0}catch{return!1}}function _u(){try{let e=window?.localStorage?.getItem?.(Ko)||"",t=e?JSON.parse(e):[];return Array.isArray(t)?t:[]}catch{return[]}}function Du(){try{window?.localStorage?.removeItem?.(Ko)}catch{}}var vu,Tu,Bu,Ko,io=Ge(()=>{vu="ttree_debug_revert_v1",Tu="ttree_debug_revert_article_v1",Bu="ttree_client_log_v1",Ko="ttree_revert_log_v1";try{window.memusRevertLogDump=()=>_u(),window.memusRevertLogClear=()=>Du()}catch{}});function Ou(e){return{id:e.id,title:e.title,updatedAt:e.updatedAt,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:!!e.encrypted}}async function zn(e){let t=await ht(),n=Array.isArray(e)?e:[],r=50;for(let o=0;o<n.length;o+=r){let i=n.slice(o,o+r),s=t.transaction(["articles"],"readwrite"),a=s.objectStore("articles");for(let c of i){let l=Ou(c),m={...await Re(a.get(l.id)).catch(()=>null)||{},id:l.id,title:l.title||"",updatedAt:l.updatedAt||null,parentId:l.parentId??null,position:typeof l.position=="number"?l.position:0,publicSlug:l.publicSlug??null,encrypted:l.encrypted?1:0,deletedAt:null};await Re(a.put(m))}await Xe(s),await new Promise(c=>setTimeout(c,0))}}async function _r(){let t=(await ht()).transaction(["articles"],"readonly"),n=t.objectStore("articles"),r=1200,o=null,i=await Promise.race([Re(n.getAll()),new Promise((s,a)=>{o=setTimeout(()=>{try{t.abort()}catch{}let c=new Error("IndexedDB read timeout (articles index)");c.name="IDBTimeoutError";try{c.idbKind="timeout"}catch{}a(c)},r)})]).catch(s=>{try{String(s?.name||"")==="QuotaExceededError"&&(s.idbKind="quota")}catch{}throw s});return o&&clearTimeout(o),await Xe(t),i.filter(s=>s&&!s.deletedAt).sort((s,a)=>Number(s.position||0)-Number(a.position||0)).map(s=>({id:s.id,title:s.title||"",updatedAt:s.updatedAt||null,parentId:s.parentId??null,position:typeof s.position=="number"?s.position:0,publicSlug:s.publicSlug??null,encrypted:!!s.encrypted}))}async function ic(){let t=(await ht()).transaction(["articles"],"readonly"),n=t.objectStore("articles"),r=await Re(n.getAll()).catch(()=>[])||[];return await Xe(t),r.filter(o=>o&&!o.deletedAt).map(o=>({id:o.id,updatedAt:o.updatedAt||null,hasDocJson:!!o.docJsonStr}))}async function Dr(e){if(!e||!e.id)return;let t=await ht(),n=e.docJson&&typeof e.docJson=="object"?e.docJson:null,r=e.updatedAt||null,o=t.transaction(["articles"],"readwrite"),i=o.objectStore("articles"),s=await Re(i.get(e.id)).catch(()=>null),a=null;try{a=s?.articleJsonStr?JSON.parse(s.articleJsonStr):null}catch{a=null}let c=!!(a&&a.localDraft),l=e&&Object.prototype.hasOwnProperty.call(e,"outlineStructureRev")?Number(e.outlineStructureRev):null;try{let m=String(s?.updatedAt||"").trim(),h=String(r||"").trim();if(m&&h&&h<m){dt("cache.article.put.skip_older",{articleId:e.id,existingUpdatedAt:m,incomingUpdatedAt:h,incomingDocHash:$t(n)}),await Xe(o);return}if(c&&m&&h&&m===h){let b=!1;try{b=await Qa(e.id)}catch{b=!1}if(b){let S=$t(s?.docJsonStr?JSON.parse(s.docJsonStr):null),p=$t(n);if(S&&p&&S!==p){let f=a&&typeof a=="object"?{...a}:{};f.id=e.id,f.title=e.title||f.title||"",f.updatedAt=m,f.parentId=e.parentId??f.parentId??null,f.position=typeof e.position=="number"?e.position:f.position??0,f.publicSlug=e.publicSlug??f.publicSlug??null,f.encrypted=!!e.encrypted,Object.prototype.hasOwnProperty.call(e,"outlineStructureRev")&&(f.outlineStructureRev=Number(e.outlineStructureRev)||0),f.localDraft=!0;let w={...s||{},id:e.id,title:e.title||"",updatedAt:m,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:e.encrypted?1:0,deletedAt:null,outlineStructureRev:Number.isFinite(l)?l:Number(s?.outlineStructureRev),docJsonStr:s?.docJsonStr??null,articleJsonStr:JSON.stringify(f)};await Re(i.put(w)),await Xe(o);try{dt("cache.article.put.skip_localDraft",{articleId:e.id,updatedAt:m,existingDocHash:S,incomingDocHash:p})}catch{}return}}else try{dt("cache.article.put.clear_stale_localDraft",{articleId:e.id,updatedAt:m})}catch{}}}catch{}let d={...s||{},id:e.id,title:e.title||"",updatedAt:r,parentId:e.parentId??null,position:typeof e.position=="number"?e.position:0,publicSlug:e.publicSlug??null,encrypted:e.encrypted?1:0,deletedAt:null,outlineStructureRev:Number.isFinite(l)?l:Number(s?.outlineStructureRev),docJsonStr:n?JSON.stringify(n):null,articleJsonStr:JSON.stringify(e)};await Re(i.put(d)),await Xe(o);try{dt("cache.article.put",{articleId:e.id,updatedAt:r,hasDocJson:!!n,docHash:$t(n)})}catch{}n&&(zo(t,{articleId:e.id,docJson:n,updatedAt:r}).catch(()=>{}),Fo(t,{articleId:e.id,docJson:n,updatedAt:r}).then(qo).catch(()=>{}),Lr(e.id,n).catch(()=>{}))}async function sc(e,t){if(!e||!t)return;let n=await ht(),r=String(t),o=e.docJson&&typeof e.docJson=="object"?e.docJson:null,i=e.updatedAt||null,s=n.transaction(["articles"],"readwrite"),a=s.objectStore("articles"),c=await Re(a.get(r)).catch(()=>null);try{let d=String(c?.updatedAt||"").trim(),m=String(i||"").trim();if(d&&m&&m<d){dt("cache.articleUnderId.put.skip_older",{articleId:r,existingUpdatedAt:d,incomingUpdatedAt:m,incomingDocHash:$t(o)}),await Xe(s);return}}catch{}let l={...c||{},id:r,title:e.title||c?.title||"",updatedAt:i||c?.updatedAt||null,parentId:e.parentId??c?.parentId??null,position:typeof e.position=="number"?e.position:c?.position||0,publicSlug:e.publicSlug??c?.publicSlug??null,encrypted:e.encrypted||c?.encrypted?1:0,deletedAt:null,docJsonStr:o?JSON.stringify(o):c?.docJsonStr??null,articleJsonStr:JSON.stringify(e)};await Re(a.put(l)),await Xe(s),o&&(zo(n,{articleId:r,docJson:o,updatedAt:i}).catch(()=>{}),Fo(n,{articleId:r,docJson:o,updatedAt:i}).then(qo).catch(()=>{}),Lr(r,o).catch(()=>{}))}async function jn(e){if(!e)return null;let n=(await ht()).transaction(["articles"],"readonly"),r=n.objectStore("articles"),o=await Re(r.get(e)).catch(()=>null);if(await Xe(n),!o)return null;try{let i=JSON.parse(o.articleJsonStr||"null");return i&&!i.docJson&&o.docJsonStr&&(i.docJson=JSON.parse(o.docJsonStr)),i}catch{try{let i=o.docJsonStr?JSON.parse(o.docJsonStr):null,s={id:e,title:o.title||"",createdAt:o.createdAt||o.updatedAt||null,updatedAt:o.updatedAt||null,deletedAt:o.deletedAt||null,parentId:o.parentId??null,position:typeof o.position=="number"?o.position:0,authorId:null,publicSlug:o.publicSlug??null,encrypted:!!o.encrypted,outlineStructureRev:Number.isFinite(Number(o.outlineStructureRev))?Number(o.outlineStructureRev):void 0,docJson:i&&typeof i=="object"?i:null,history:[],redoHistory:[],blockTrash:[]};try{dt("cache.article.get.fallback_docJsonStr",{articleId:e,updatedAt:s.updatedAt||null,docHash:$t(s.docJson)})}catch{}return s}catch{return null}}}async function gn(e,t,n){if(!e)return;let r=await ht(),o=r.transaction(["articles"],"readwrite"),i=o.objectStore("articles"),s=await Re(i.get(e)).catch(()=>null),a=n||s&&s.updatedAt||null,c=()=>{let m=String(e)==="inbox"?"\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438":"",h=(s&&typeof s.title=="string"?s.title:"")||m,b=a,S={id:e,title:h,createdAt:s&&s.createdAt||b||null,updatedAt:b,deletedAt:s&&s.deletedAt||null,parentId:(s&&s.parentId)??null,position:typeof(s&&s.position)=="number"?s.position:0,authorId:null,publicSlug:(s&&s.publicSlug)??null,encrypted:!!(s&&s.encrypted),docJson:null,history:[],blocks:[]};return JSON.stringify(S)},l=()=>{let m=s&&s.articleJsonStr||"",h=null;try{h=m?JSON.parse(m):null}catch{h=null}if(!h||typeof h!="object")try{h=JSON.parse(c())}catch{h={id:e}}return h.id=e,h.updatedAt=a||h.updatedAt||null,h.docJson=t&&typeof t=="object"?t:null,t&&typeof t=="object"&&(h.localDraft=!0),!h.title&&s?.title&&(h.title=s.title),h.deletedAt===void 0&&(h.deletedAt=null),h.parentId===void 0&&(h.parentId=s?.parentId??null),h.position===void 0&&(h.position=typeof s?.position=="number"?s.position:0),h.publicSlug===void 0&&(h.publicSlug=s?.publicSlug??null),h.encrypted===void 0&&(h.encrypted=!!s?.encrypted),h.history===void 0&&(h.history=[]),h.blocks===void 0&&(h.blocks=[]),JSON.stringify(h)},d={...s||{id:e},id:e,outlineStructureRev:s?.outlineStructureRev,docJsonStr:t?JSON.stringify(t):null,updatedAt:a,articleJsonStr:l()};await Re(i.put(d)),await Xe(o);try{dt("cache.docJson.put",{articleId:e,updatedAt:a,docHash:$t(t)})}catch{}t&&typeof t=="object"&&(zo(r,{articleId:e,docJson:t,updatedAt:n}).catch(()=>{}),Fo(r,{articleId:e,docJson:t,updatedAt:n}).then(qo).catch(()=>{}),Lr(e,t).catch(()=>{}))}async function Vo(e,t){let n=String(e||"").trim();if(!n)return;let r=String(t||new Date().toISOString()).trim(),i=(await ht()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),a=await Re(s.get(n)).catch(()=>null);if(!a){await Xe(i);return}let c=null;try{c=a.articleJsonStr?JSON.parse(a.articleJsonStr):null}catch{c=null}(!c||typeof c!="object")&&(c={id:n}),c.id=n,c.deletedAt=r;let l={...a,deletedAt:r,articleJsonStr:JSON.stringify(c)};await Re(s.put(l)),await Xe(i)}async function ac(e){let t=String(e||"").trim();if(!t)return;let r=(await ht()).transaction(["articles"],"readwrite"),o=r.objectStore("articles"),i=await Re(o.get(t)).catch(()=>null);if(!i){await Xe(r);return}let s=null;try{s=i.articleJsonStr?JSON.parse(i.articleJsonStr):null}catch{s=null}(!s||typeof s!="object")&&(s={id:t}),s.id=t,delete s.localDraft;let a={...i,articleJsonStr:JSON.stringify(s)};await Re(o.put(a)),await Xe(r)}async function cc(e){let t=await ht(),n=Array.isArray(e)?e:[];if(!n.length)return;let r=t.transaction(["articles"],"readwrite"),o=r.objectStore("articles");for(let i of n){if(!i||!i.id)continue;let s=await Re(o.get(i.id)).catch(()=>null);if(!s)continue;let a={...s,parentId:i.parentId??null,position:typeof i.position=="number"?i.position:0};await Re(o.put(a))}await Xe(r)}async function rs(e,t){let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return;let i=(await ht()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),a=await Re(s.get(n)).catch(()=>null);if(!a){await Xe(i);return}let c=null;try{c=a.articleJsonStr?JSON.parse(a.articleJsonStr):null}catch{c=null}(!c||typeof c!="object")&&(c={id:n}),c.id=n,c.updatedAt=r;let l={...a,updatedAt:r,articleJsonStr:JSON.stringify(c)};await Re(s.put(l)),await Xe(i)}async function os(e,t){let n=String(e||"").trim();if(!n)return;let r=Number(t);if(!Number.isFinite(r)||r<0)return;let i=(await ht()).transaction(["articles"],"readwrite"),s=i.objectStore("articles"),a=await Re(s.get(n)).catch(()=>null);if(!a){await Xe(i);return}let c=null;try{c=a.articleJsonStr?JSON.parse(a.articleJsonStr):null}catch{c=null}(!c||typeof c!="object")&&(c={id:n}),c.id=n,c.outlineStructureRev=r;let l={...a,outlineStructureRev:r,articleJsonStr:JSON.stringify(c)};await Re(s.put(l)),await Xe(i)}var Or=Ge(()=>{Qn();Cn();Va();Qi();Pr();ns();io()});function $u(e){let t=Array.isArray(e)?e:[],n=new Float32Array(t.length),r=0;for(let o=0;o<t.length;o+=1){let i=Number(t[o]||0);n[o]=i,r+=i*i}if(r>0){let o=1/Math.sqrt(r);for(let i=0;i<n.length;i+=1)n[i]*=o}return n}function lc(){Ru=null,Hu=0}async function is(e,t){if(!e)return;let n=await ht(),r=Array.isArray(t)?t:[],o=n.transaction(["section_embeddings"],"readwrite"),i=o.objectStore("section_embeddings");for(let s of r){let a=String(s?.blockId||s?.sectionId||""),c=String(s?.updatedAt||"")||null,l=s?.embedding;if(!a||!Array.isArray(l)||!l.length)continue;let d=$u(l);await Re(i.put({sectionId:a,articleId:String(e),updatedAt:c,vec:d}))}await Xe(o),lc()}async function jo(e){let t=(e||[]).map(i=>String(i||"")).filter(Boolean);if(!t.length)return;let r=(await ht()).transaction(["section_embeddings"],"readwrite"),o=r.objectStore("section_embeddings");for(let i of t)await Re(o.delete(i));await Xe(r),lc()}var Ru,Hu,ss=Ge(()=>{Qn();Cn();Ru=null,Hu=0});var dc=Ge(()=>{Qn();ss();Cn()});function Jo(){try{return window?.localStorage?.getItem?.(Fu)==="1"}catch{return!1}}function jt(...e){try{if(!Jo())return;console.log(...e)}catch{}}async function Et(e,t={}){let n=Jo()?performance.now():0,r=n?performance.now():0,o=await fetch(e,{headers:{"Content-Type":"application/json",...t.headers||{}},credentials:"include",...t}),i=r?performance.now():0;if(!o.ok){if(o.status===401||o.status===403){try{u.serverStatus="auth",u.serverStatusText="auth"}catch{}try{window.dispatchEvent(new CustomEvent("memus:auth-required",{detail:{path:e,status:o.status}}))}catch{}}let l=await o.json().catch(()=>({}));n&&console.log("[perf][api]",e,{status:o.status,ms:Math.round(performance.now()-n),fetchMs:i?Math.round(i-r):null});let d=new Error(l.detail||"Request failed");try{d.status=o.status,d.path=e}catch{}throw d}try{u.serverStatus==="down"&&(u.serverStatus="ok",u.serverStatusText="")}catch{}if(o.status===204)return n&&console.log("[perf][api]",e,{status:204,ms:Math.round(performance.now()-n),fetchMs:i?Math.round(i-r):null}),null;let s=n?performance.now():0,a=await o.json(),c=n?performance.now():0;try{if(window?.localStorage?.getItem?.("ttree_debug_article_load_v1")==="1"){let l=o.headers.get("X-Memus-Article-ms"),d=o.headers.get("X-Memus-DocJson-bytes");(l||d)&&console.log("[api]",e,{ms:l,docJsonBytes:d})}}catch{}if(n){let l=o.headers.get("X-Memus-Article-ms")||o.headers.get("X-Memus-Articles-ms")||o.headers.get("X-Memus-Server-ms"),d=o.headers.get("X-Memus-DocJson-bytes"),m=o.headers.get("X-Memus-Articles-count"),h=o.headers.get("Content-Length");console.log("[perf][api]",e,{status:o.status,ms:Math.round(c-n),fetchMs:i?Math.round(i-r):null,jsonMs:s?Math.round(c-s):null,serverMs:l?Number(l):null,docJsonBytes:d?Number(d):null,articlesCount:m?Number(m):null,contentLength:h?Number(h):null})}return a}function Uu(){try{return window?.localStorage?.getItem?.(zu)==="1"}catch{return!1}}async function uc({timeoutMs:e}){let t=typeof e=="number"?Math.max(0,Math.floor(e)):0,n=null,r=null;try{return t>0&&typeof AbortController<"u"&&(r=new AbortController,n=setTimeout(()=>{try{r.abort()}catch{}},t)),await Et("/api/articles",r?{signal:r.signal}:{})}catch(o){if((o?.message||String(o||"")).toLowerCase().includes("abort"))try{u.serverStatus="down",u.serverStatusText="timeout"}catch{}throw o}finally{n&&clearTimeout(n)}}function kn(){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return _r().catch(()=>[]);if(so)return so;let e=u?.offlineReady?600:250,t=2200;return so=(async()=>{let n=Jo()?performance.now():0,r=null,o=!1,i=new Promise(l=>{r=setTimeout(()=>{!o&&n&&jt("[offline-first][articles] cache.lookup.timeout",{preferCacheMs:e}),l(null)},e)}),s=_r().then(l=>(o=!0,r&&clearTimeout(r),r=null,n&&jt("[offline-first][articles] cache.lookup.done",{ms:Math.round(performance.now()-n),hit:!!(l&&l.length)}),l)).catch(l=>{o=!0,r&&clearTimeout(r),r=null;try{if(u.offlineReady){let d=String(l?.idbKind||l?.name||"").toLowerCase();d.includes("timeout")?(u.offlineInitStatus="timeout",u.offlineInitError="\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u0430\u044F \u0431\u0430\u0437\u0430 \u043D\u0435 \u043E\u0442\u0432\u0435\u0447\u0430\u0435\u0442 (\u0442\u0430\u0439\u043C\u0430\u0443\u0442 \u0447\u0442\u0435\u043D\u0438\u044F \u0441\u043F\u0438\u0441\u043A\u0430 \u0441\u0442\u0430\u0442\u0435\u0439). \u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443."):d.includes("quota")?(u.offlineInitStatus="quota",u.offlineInitError="\u041D\u0435\u0434\u043E\u0441\u0442\u0430\u0442\u043E\u0447\u043D\u043E \u043C\u0435\u0441\u0442\u0430 \u0434\u043B\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u043A\u044D\u0448\u0430. \u041E\u0447\u0438\u0441\u0442\u0438\u0442\u0435 \u043A\u044D\u0448 \u043A\u0430\u0440\u0442\u0438\u043D\u043E\u043A \u0438\u043B\u0438 \u043E\u0441\u0432\u043E\u0431\u043E\u0434\u0438\u0442\u0435 \u043C\u0435\u0441\u0442\u043E."):(u.offlineInitStatus="error",u.offlineInitError="\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0440\u043E\u0447\u0438\u0442\u0430\u0442\u044C \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A \u0441\u0442\u0430\u0442\u0435\u0439. \u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438\u043B\u0438 \u0441\u0431\u0440\u043E\u0441\u044C\u0442\u0435 \u043E\u0444\u0444\u043B\u0430\u0439\u043D\u2011\u043A\u044D\u0448.")}}catch{}return null}),a=await Promise.race([s,i]);if(a&&a.length)return as||(as=uc({timeoutMs:t}).then(async l=>{try{typeof requestIdleCallback=="function"?requestIdleCallback(()=>zn(l).catch(()=>{}),{timeout:2500}):setTimeout(()=>zn(l).catch(()=>{}),250)}catch{zn(l).catch(()=>{})}}).catch(()=>{}).finally(()=>{as=null})),a;let c=await uc({timeoutMs:t});try{typeof requestIdleCallback=="function"?requestIdleCallback(()=>zn(c).catch(()=>{}),{timeout:2500}):setTimeout(()=>zn(c).catch(()=>{}),250)}catch{zn(c).catch(()=>{})}try{let l=await _r().catch(()=>null),d=Array.isArray(c)?c.length:0,m=l&&Array.isArray(l)?l.length:0;if(m>=20&&d<=3||Uu()&&m&&m>d)return l}catch{}return c})().catch(async n=>{let r=await _r().catch(()=>null);if(r&&r.length)return r;throw n}).finally(()=>{so=null}),so}function mc(){return typeof navigator<"u"&&navigator&&navigator.onLine===!1?Promise.resolve([]):Et("/api/articles/deleted").catch(async e=>[])}function hc(e,t={}){let n=String(e||"").trim();e=n.startsWith("inbox-")?"inbox":n;let{cacheTimeoutMs:o,metaTimeoutMs:i,...s}=t||{},a=u?.offlineReady?400:150,c=typeof o=="number"?Math.max(0,Math.floor(o)):a,l=typeof i=="number"?Math.max(0,Math.floor(i)):350,d=Jo()?performance.now():0,m=null,h=!1,b=new Promise(F=>{m=setTimeout(()=>{!h&&d&&jt("[offline-first][article] cache.lookup.timeout",{id:e,cacheTimeoutMs:c}),F(null)},c)}),S=jn(e).then(F=>(h=!0,m&&clearTimeout(m),m=null,d&&jt("[offline-first][article] cache.lookup.done",{id:e,ms:Math.round(performance.now()-d),hit:!!F}),F)).catch(F=>(h=!0,m&&clearTimeout(m),m=null,d&&jt("[offline-first][article] cache.lookup.failed",{id:e,ms:Math.round(performance.now()-d),message:F?.message||String(F||"")}),null)),p=Promise.race([S,b]),f=()=>Et(`/api/articles/${e}?include_history=0`,{...s,cache:"no-store"}).then(async F=>{try{dt("article.fetch.network.ok",{articleId:e,updatedAt:F?.updatedAt||null,docHash:$t(F?.docJson||null)})}catch{}return Dr(F).catch(()=>{}),F&&F.id&&String(F.id)!==String(e)&&sc(F,e).catch(()=>{}),F}).catch(async F=>{let X=await jn(e).catch(()=>null);try{dt("article.fetch.network.err",{articleId:e,message:F?.message||String(F||""),cachedHit:!!X,cachedUpdatedAt:X?.updatedAt||null,cachedDocHash:$t(X?.docJson||null)})}catch{}if(X)return X;throw F}),w=()=>{let F=new Date().toISOString(),G={type:"doc",content:[{type:"outlineSection",attrs:{id:(globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function"?()=>globalThis.crypto.randomUUID():()=>`id-${Date.now()}-${Math.random().toString(16).slice(2)}`)(),collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}]};return{id:"inbox",title:"\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438",createdAt:F,updatedAt:F,deletedAt:null,parentId:null,position:0,authorId:null,publicSlug:null,encrypted:!1,docJson:G,history:[]}},x="ttree_pending_quick_notes_v1",A=()=>{try{let F=window?.localStorage?.getItem?.(x)||"";if(!F)return[];let X=JSON.parse(F);return Array.isArray(X)?X.filter(Boolean):[]}catch{return[]}},C=(F,X)=>{let G=String(F||"").trim();if(!G)return null;let we=String(X||"").trim().split(/\r?\n/),Ce=[];for(let ne=0;ne<we.length;ne+=1){let ye=we[ne];ye&&Ce.push({type:"text",text:ye}),ne!==we.length-1&&Ce.push({type:"hardBreak"})}return{type:"outlineSection",attrs:{id:G,collapsed:!1},content:[{type:"outlineHeading",content:[]},{type:"outlineBody",content:[Ce.length?{type:"paragraph",content:Ce}:{type:"paragraph"}]},{type:"outlineChildren",content:[]}]}},L=F=>{try{if(!F||String(F.id||"")!=="inbox")return F;let X=A();if(!X.length)return F;let G=F?.docJson&&typeof F.docJson=="object"?F.docJson:{type:"doc",content:[]},oe=Array.isArray(G.content)?G.content:[],we=new Set(oe.filter(ne=>ne&&ne.type==="outlineSection"&&ne.attrs&&ne.attrs.id).map(ne=>String(ne.attrs.id))),Ce=[];for(let ne of X){let ye=String(ne?.sectionId||ne?.id||"").trim();if(!ye||we.has(ye))continue;let Ye=C(ye,ne?.text||"");Ye&&Ce.push(Ye)}return Ce.length?{...F,docJson:{...G,type:G.type||"doc",content:[...Ce,...oe]}}:F}catch{return F}},H=()=>Et(`/api/articles/${encodeURIComponent(e)}/meta`,{method:"GET",headers:{...s.headers||{}},cache:"no-store"}),U=()=>l?Promise.race([H(),new Promise((F,X)=>setTimeout(()=>{let G=new Error("meta_timeout");G.name="TimeoutError",X(G)},l))]):H();return p.then(async F=>{if(!F){if(!navigator.onLine&&String(e)==="inbox"){try{let Ce=await Promise.race([S,new Promise(ne=>setTimeout(()=>ne(null),Math.max(500,l*5)))]);if(Ce){jt("[offline-first][article] choose.cache.late.offline.inbox",{id:e});try{dt("article.choose",{articleId:e,choose:"cache.late.offline.inbox"})}catch{}return L(Ce)}}catch{}return jt("[offline-first][article] choose.local.inbox.offline",{id:e}),L(w())}let G=S.then(Ce=>Ce?{src:"cache",article:L(Ce)}:new Promise(()=>{})).catch(()=>new Promise(()=>{})),oe=(async()=>({src:"network",article:await L(f())}))(),we=await Promise.race([G,oe]);if(we?.src==="cache"){jt("[offline-first][article] choose.cache.late",{id:e});try{dt("article.choose",{articleId:e,choose:"cache.late"})}catch{}return oe.catch(()=>{}),we.article}jt("[offline-first][article] choose.network.no-cache",{id:e});try{dt("article.choose",{articleId:e,choose:"network.no_cache"})}catch{}return we.article}if(!navigator.onLine){jt("[offline-first][article] choose.cache.offline",{id:e,updatedAt:F?.updatedAt||null});try{dt("article.choose",{articleId:e,choose:"cache.offline",cachedUpdatedAt:F?.updatedAt||null,cachedDocHash:$t(F?.docJson||null)})}catch{}return L(F)}let X=String(F.updatedAt||F.updated_at||"").trim();if(!X){jt("[offline-first][article] choose.network.no-cached-updatedAt",{id:e});try{dt("article.choose",{articleId:e,choose:"network.no_cached_updatedAt",cachedDocHash:$t(F?.docJson||null)})}catch{}return L(await f())}try{jt("[offline-first][article] meta.check.start",{id:e,cachedUpdatedAt:X});let G=await U(),oe=String(G?.updatedAt||"").trim();if(oe&&oe===X){jt("[offline-first][article] choose.cache.meta.same",{id:e,cachedUpdatedAt:X});try{dt("article.choose",{articleId:e,choose:"cache.meta.same",cachedUpdatedAt:X,serverUpdatedAt:oe,cachedDocHash:$t(F?.docJson||null)})}catch{}return L(F)}jt("[offline-first][article] choose.network.meta.diff",{id:e,cachedUpdatedAt:X,serverUpdatedAt:oe||null});try{dt("article.choose",{articleId:e,choose:"network.meta.diff",cachedUpdatedAt:X,serverUpdatedAt:oe||null,cachedDocHash:$t(cached?.docJson||null)})}catch{}return L(await f())}catch(G){String(G?.name||"")==="TimeoutError"||String(G?.message||"")==="meta_timeout"?jt("[offline-first][article] meta.check.timeout",{id:e,metaTimeoutMs:l}):jt("[offline-first][article] meta.check.failed",{id:e,message:G?.message||String(G||"")}),f().catch(()=>{}),String(G?.name||"")==="TimeoutError"||String(G?.message||"")==="meta_timeout"?jt("[offline-first][article] choose.cache.meta.timeout",{id:e,cachedUpdatedAt:X,metaTimeoutMs:l}):jt("[offline-first][article] choose.cache.meta.failed",{id:e,cachedUpdatedAt:X});try{dt("article.choose",{articleId:e,choose:String(G?.name||"")==="TimeoutError"||String(G?.message||"")==="meta_timeout"?"cache.meta.timeout":"cache.meta.failed",cachedUpdatedAt:X,cachedDocHash:$t(F?.docJson||null),error:G?.message||String(G||"")})}catch{}return L(F)}})}function gc(e,t){return e?!t||typeof t!="object"?Promise.reject(new Error("docJson must be object")):Et(`/api/articles/${encodeURIComponent(e)}/doc-json`,{method:"PUT",body:JSON.stringify({docJson:t})}):Promise.reject(new Error("articleId is required"))}function yc(e){return typeof e!="string"?Promise.reject(new Error("text must be string")):Et("/api/outline/generate-title",{method:"POST",body:JSON.stringify({text:e})})}function cs(e){return typeof e!="string"?Promise.reject(new Error("html must be string")):Et("/api/outline/proofread-html",{method:"POST",body:JSON.stringify({html:e})})}function bc(e,t={}){let n=t.force?"?force=true":"";return Et(`/api/articles/${e}${n}`,{method:"DELETE"}).then(r=>{let o=n?new Date().toISOString():new Date().toISOString();return Vo(e,o).catch(()=>{}),r})}function Sc(e){return Et(`/api/articles/${e}/restore`,{method:"POST"})}function wc(e,t,n={}){let r=Array.isArray(t)?t.filter(Boolean).map(o=>String(o)):[];return e?r.length?Et(`/api/articles/${encodeURIComponent(e)}/sections/delete`,{method:"PUT",cache:"no-store",body:JSON.stringify({opId:n?.opId||null,sectionIds:r})}):Promise.resolve({status:"ok",removedBlockIds:[]}):Promise.reject(new Error("articleId is required"))}function ao(e){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return Promise.reject(new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D"));let t=new FormData;t.append("file",e);let n=i=>{if(!(typeof navigator<"u"&&navigator&&navigator.onLine===!1))try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"uploadImageFile",data:i})}).catch(()=>{})}catch{}},r=()=>fetch("/api/uploads",{method:"POST",credentials:"include",body:t}).then(async i=>{let s=await i.json().catch(()=>null);if(n({transport:"fetch",status:i.status,ok:i.ok,details:s,name:e&&e.name,type:e&&e.type,size:e&&e.size}),!i.ok){let a=s?.detail||`Upload failed (status ${i.status})`,c=new Error(a);throw c.status=i.status,c.details=s,c}return s}),o=()=>new Promise((i,s)=>{let a=new XMLHttpRequest;a.open("POST","/api/uploads"),a.withCredentials=!0,a.onreadystatechange=()=>{if(a.readyState===XMLHttpRequest.DONE)try{let c=a.status,l=null;try{l=JSON.parse(a.responseText||"null")}catch{l=null}if(n({transport:"xhr",status:c,ok:c>=200&&c<300,details:l,name:e&&e.name,type:e&&e.type,size:e&&e.size}),c>=200&&c<300)i(l);else{let d=l&&l.detail||`Upload failed (status ${c})`,m=new Error(d);m.status=c,m.details=l,s(m)}}catch(c){s(c)}},a.onerror=()=>{n({transport:"xhr",status:0,ok:!1,details:{detail:"Network error during image upload"},name:e&&e.name,type:e&&e.type,size:e&&e.size});let c=new Error("Upload failed (network error)");c.status=0,c.details={detail:"Network error during image upload"},s(c)},a.send(t)});return r().catch(i=>{let s=String(i&&i.message?i.message:"").toLowerCase();if(s.includes("status ")||s.includes("upload failed"))throw i;return o()})}function qu(e,t,n=()=>{},{sectionId:r}={}){return typeof navigator<"u"&&navigator&&navigator.onLine===!1?Promise.reject(new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D")):new Promise((o,i)=>{let s=new XMLHttpRequest;s.open("POST",`/api/articles/${e}/attachments`),s.withCredentials=!0,s.upload.onprogress=c=>{if(c.lengthComputable){let l=Math.round(c.loaded/c.total*100);n(l)}},s.onreadystatechange=()=>{if(s.readyState===XMLHttpRequest.DONE)if(s.status>=200&&s.status<300)try{let c=JSON.parse(s.responseText||"{}");o(c)}catch(c){i(c)}else{let c=`Attachment upload failed (status ${s.status})`;try{let l=JSON.parse(s.responseText||"{}");l?.detail&&(c=l.detail)}catch{}i(new Error(c))}},s.onerror=()=>i(new Error("Network error during upload"));let a=new FormData;a.append("file",t),r&&a.append("sectionId",String(r)),s.send(a)})}function Ku(e){let t=new Map;for(let n of e||[]){let r=n.parentId??null;t.has(r)||t.set(r,[]),t.get(r).push(n)}for(let n of t.values())n.sort((r,o)=>(r.position||0)-(o.position||0));return t}function fc(e){let t=[];for(let n=0;n<e.length;n+=1){let r=e[n];if(!r)continue;let o=n;(r.position||0)!==o&&(r.position=o,t.push({id:r.id,parentId:r.parentId??null,position:o}))}return t}function ls(e,t){return e?Et(`/api/articles/${encodeURIComponent(e)}/move-tree`,{method:"POST",body:JSON.stringify(t||{})}).catch(async()=>{let r=await _r().catch(()=>[]),o=Ku(r),i=(r||[]).find(f=>f.id===e);if(!i)return null;let s=t&&t.placement||null,a=t&&t.anchorId||null,c=t?t.parentId??null:null;s==="inside"&&a&&(c=a);let l=i.parentId??null,m=(o.get(l)||[]).filter(f=>f.id!==e),b=(o.get(c)||[]).filter(f=>f.id!==e),S=b.length;if(a){let f=b.findIndex(w=>w.id===a);f!==-1&&(s==="before"?S=f:s==="after"?S=f+1:s==="inside"&&(S=b.length))}i.parentId=c,b.splice(S,0,i);let p=[];return p.push(...fc(m)),p.push(...fc(b)),cc(p).catch(()=>{}),tn("move_article_tree",{articleId:e,payload:t||{},coalesceKey:`${e}:move-tree`}).catch(()=>{}),{id:e}}):Promise.resolve(null)}async function Vu({articleId:e,filename:t,overwrite:n=!1,sha256:r="",size:o=0}){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D");let s=await fetch("/api/yandex/disk/upload-url",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({filename:t||"",articleId:e||"",overwrite:!!n,sha256:r||"",size:typeof o=="number"?o:0})}),a=await s.json().catch(()=>null);if(!s.ok){let c=a&&a.detail||`Yandex upload URL failed (status ${s.status})`;throw new Error(c)}return a}async function pc(e,{path:t,originalName:n,contentType:r,size:o,sectionId:i}){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)throw new Error("\u041D\u0435\u0442 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u0430: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u043E\u0432 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 \u043E\u0444\u0444\u043B\u0430\u0439\u043D");let s={path:t||"",originalName:n||"",contentType:r||"",size:typeof o=="number"?o:0};i&&(s.sectionId=String(i));let a=await fetch(`/api/articles/${e}/attachments/yandex`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),c=await a.json().catch(()=>null);if(!a.ok){let l=c&&c.detail||`Register Yandex attachment failed (status ${a.status})`;throw new Error(l)}return c}async function Wo(e,t,{onProgress:n,sectionId:r}={}){if(!t)throw new Error("\u0424\u0430\u0439\u043B \u043D\u0435 \u0443\u043A\u0430\u0437\u0430\u043D");let o="";try{if(window.crypto&&window.crypto.subtle&&typeof t.arrayBuffer=="function"){let h=await t.arrayBuffer(),b=await window.crypto.subtle.digest("SHA-256",h),S=new Uint8Array(b);o=Array.from(S).map(p=>p.toString(16).padStart(2,"0")).join("")}}catch{o=""}let{href:i,method:s,path:a,exists:c,same:l}=await Vu({articleId:e,filename:t.name||"attachment",overwrite:!1,sha256:o,size:t.size||0});if(c&&l&&!i)return await pc(e,{path:a,originalName:t.name||"attachment",contentType:t.type||"",size:t.size||0,sectionId:r});let d=!1;if(i)try{await new Promise((h,b)=>{let S=new XMLHttpRequest;S.open(s||"PUT",i),S.upload.onprogress=p=>{if(n&&p.lengthComputable){let f=Math.round(p.loaded/p.total*100);try{n(f)}catch{}}},S.onreadystatechange=()=>{S.readyState===XMLHttpRequest.DONE&&(S.status>=200&&S.status<300?h():b(new Error(`Yandex upload failed (status ${S.status})`)))},S.onerror=()=>b(new Error("Network error during Yandex upload")),S.send(t)}),d=!0}catch(h){console.warn("[attachments] Direct Yandex upload failed, falling back to server upload",h),d=!1}return d?await pc(e,{path:a,originalName:t.name||"attachment",contentType:t.type||"",size:t.size||0,sectionId:r}):await qu(e,t,n,{sectionId:r})}var Fu,so,as,zu,ln=Ge(()=>{Or();Pr();dc();Bt();io();Fu="ttree_profile_v1";so=null,as=null,zu="ttree_offline_recovery_force_index_v1"});function xc(){if(!j.articlePublicToggleBtn)return;let e=u.article?.publicSlug||null;j.articlePublicToggleBtn.textContent=e?"\u041E\u0442\u043C\u0435\u043D\u0438\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435":"\u0414\u0430\u0442\u044C \u0434\u043E\u0441\u0442\u0443\u043F \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435"}function co(){let e=u.article;if(!e)return;let t=e.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";if(j.articleTitle&&(j.articleTitle.textContent=t,j.articleTitle.classList.toggle("article-title--encrypted",!!e.encrypted),j.articleTitle.classList.toggle("hidden",u.isEditingTitle)),j.articleTitleInput&&(u.isEditingTitle||(j.articleTitleInput.value=t),j.articleTitleInput.classList.toggle("hidden",!u.isEditingTitle)),j.editTitleBtn&&j.editTitleBtn.classList.toggle("hidden",u.isEditingTitle),j.articleFavoriteBtn){let r=new Set(u.favoriteArticles||[]).has(e.id),o=j.articleFavoriteBtn.querySelector?.("i.bx")||j.articleFavoriteBtn.querySelector?.("span.bx")||j.articleFavoriteBtn.querySelector?.(".bx")||null;o&&o.classList?(o.classList.toggle("bxs-star",r),o.classList.toggle("bx-star",!r)):j.articleFavoriteBtn.innerHTML=`<i class="bx ${r?"bxs-star":"bx-star"}" aria-hidden="true"></i>`,j.articleFavoriteBtn.title=r?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0432 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}if(j.articlePublicLinkBtn){let n=!!e.publicSlug;j.articlePublicLinkBtn.classList.toggle("hidden",!n),n&&(j.articlePublicLinkBtn.title="\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0441\u044B\u043B\u043A\u0443")}if(j.deleteArticleBtn&&j.deleteArticleBtn.classList.toggle("hidden",e.id==="inbox"),j.articleEncryptionBtn&&(j.articleEncryptionBtn.textContent=e.encrypted?"\u0421\u043C\u0435\u043D\u0438\u0442\u044C \u043F\u0430\u0440\u043E\u043B\u044C":"\u0417\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C"),j.articleEncryptionRemoveBtn&&j.articleEncryptionRemoveBtn.classList.toggle("hidden",!e.encrypted),j.updatedAt&&(u.isOutlineEditing?j.updatedAt.textContent=u.outlineStatusText||"":e.updatedAt?j.updatedAt.textContent=`\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${new Date(e.updatedAt).toLocaleString()}`:j.updatedAt.textContent=""),j.articleStatusText&&(u.isOutlineEditing?j.articleStatusText.textContent=u.outlineStatusText||"":e.updatedAt?j.articleStatusText.textContent=`\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u043E: ${new Date(e.updatedAt).toLocaleString()}`:j.articleStatusText.textContent=""),j.mediaStatusText&&(j.mediaStatusText.textContent=u.mediaStatusText||""),j.mediaPrefetchToggleBtn){let n=!!u.mediaPrefetchPaused;j.mediaPrefetchToggleBtn.textContent=n?"\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C":"\u041F\u0430\u0443\u0437\u0430",j.mediaPrefetchToggleBtn.classList.toggle("is-active",n)}}var lo=Ge(()=>{Bt();In()});function nn(...e){console.log("[debug]",...e)}function Jt(e=""){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Ac(e=""){let t=(e||"").replace(/<br\s*\/?>/gi,`
`).replace(/<\/(?:div|p|li|h[1-6])>/gi,`
`),n=document.createElement("template");return n.innerHTML=t,(n.content.textContent||"").split(`
`).map(r=>r.replace(/\s+/g," ").trim()).filter(r=>r.length)}function Yo(e){if(!e||!e.isConnected)return;let t=window.getSelection();if(!t)return;let n=document.createRange();n.selectNodeContents(e),n.collapse(!1),t.removeAllRanges(),t.addRange(n)}function ds(e){if(!e||!e.isConnected)return;let t=window.getSelection();if(!t)return;let n=document.createRange();n.selectNodeContents(e),n.collapse(!0),t.removeAllRanges(),t.addRange(n)}function Jn(e,t){if(!e||!document.contains(e))return;e.focus();let n=window.getSelection();if(!n)return;let r=n.rangeCount>0?n.getRangeAt(0):document.createRange();e.contains(r.commonAncestorContainer)||(r=document.createRange(),r.selectNodeContents(e),r.collapse(!1)),n.removeAllRanges(),n.addRange(r);let o=r.createContextualFragment(t);r.deleteContents(),r.insertNode(o),r.collapse(!1),n.removeAllRanges(),n.addRange(r)}var _n=Ge(()=>{});var fs={};Do(fs,{showArticleHistoryModal:()=>ef,showArticleLinkPrompt:()=>Ju,showBlockHistoryModal:()=>Qu,showBlockTrashPicker:()=>tf,showConfirm:()=>Ec,showImagePreview:()=>uo,showImportConflictDialog:()=>nf,showLinkPrompt:()=>us,showPasswordWithHintPrompt:()=>Cc,showPrompt:()=>er,showPublicLinkModal:()=>Wu,showVersionCompareTargetPicker:()=>Gu,showVersionDiffModal:()=>Xu,showVersionsPicker:()=>Yu});function yn(){let e=document.getElementById(Ic);return e||(e=document.createElement("div"),e.id=Ic,document.body.appendChild(e)),e}function vn({title:e,message:t,confirmText:n,cancelText:r,renderBody:o}){let i=document.createElement("div");i.className="modal-overlay";let s=document.createElement("form");s.className="modal-form",s.addEventListener("submit",S=>{S.preventDefault()});let a=document.createElement("div");a.className="modal-card",a.setAttribute("role","dialog"),a.setAttribute("aria-modal","true"),a.tabIndex=-1;let c=document.createElement("div");c.className="modal-header";let l=document.createElement("h3");l.textContent=e||"\u041F\u043E\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043D\u0438\u0435",c.appendChild(l);let d=document.createElement("div");if(d.className="modal-body",typeof o=="function"){let S=o();Array.isArray(S)?S.forEach(p=>{p&&d.appendChild(p)}):S&&d.appendChild(S)}else d.textContent=t||"";let m=document.createElement("div");m.className="modal-footer modal-footer--stacked";let h=document.createElement("button");h.type="button",h.className="ghost",h.textContent=r||"\u041E\u0442\u043C\u0435\u043D\u0430";let b=document.createElement("button");return b.type="button",b.className="primary danger-btn",b.textContent=n||"\u0423\u0434\u0430\u043B\u0438\u0442\u044C",m.appendChild(b),m.appendChild(h),a.appendChild(c),a.appendChild(d),a.appendChild(m),s.appendChild(a),i.appendChild(s),{overlay:i,card:a,confirmBtn:b,cancelBtn:h,form:s}}function ju(e="",t=""){let n=String(e||"").length,r=String(t||"").length;if(n*r>2e6||n+r>2e4)return null;let s=Array.from(e),a=Array.from(t),c=s.length,l=a.length,d=Array.from({length:c+1},()=>new Array(l+1).fill(0));for(let p=c-1;p>=0;p-=1)for(let f=l-1;f>=0;f-=1)s[p]===a[f]?d[p][f]=d[p+1][f+1]+1:d[p][f]=Math.max(d[p+1][f],d[p][f+1]);let m=[],h=0,b=0;for(;h<c&&b<l;)s[h]===a[b]?(m.push({type:"same",value:s[h]}),h+=1,b+=1):d[h+1][b]>=d[h][b+1]?(m.push({type:"removed",value:s[h]}),h+=1):(m.push({type:"added",value:a[b]}),b+=1);for(;h<c;)m.push({type:"removed",value:s[h]}),h+=1;for(;b<l;)m.push({type:"added",value:a[b]}),b+=1;let S=[];return m.forEach(p=>{if(!p.value)return;let f=S[S.length-1];f&&f.type===p.type?f.value+=p.value:S.push({type:p.type,value:p.value})}),S}function Rr({baseText:e="",nextText:t="",mode:n="before"}={}){let r=document.createDocumentFragment(),o=ju(e,t);if(!o){let s=String(n==="before"?e||"":t||""),a=s.length>2e5?`${s.slice(0,2e5)}

\u2026(\u043E\u0431\u0440\u0435\u0437\u0430\u043D\u043E)`:s,c=document.createElement("div");c.className="meta",c.style.marginBottom="6px",c.textContent="Diff \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 \u2014 \u043F\u043E\u043A\u0430\u0437\u044B\u0432\u0430\u0435\u043C \u0442\u0435\u043A\u0441\u0442 \u0431\u0435\u0437 \u043F\u043E\u0434\u0441\u0432\u0435\u0442\u043A\u0438.";let l=document.createElement("pre");return l.className="diff-plain",l.style.whiteSpace="pre-wrap",l.style.wordBreak="break-word",l.textContent=a,r.appendChild(c),r.appendChild(l),r}return o.forEach(i=>{if(n==="before"&&i.type==="added"||n==="after"&&i.type==="removed")return;let s=document.createElement("span");s.className="diff-seg",i.type==="added"&&s.classList.add("diff-seg--added"),i.type==="removed"&&s.classList.add("diff-seg--removed"),s.textContent=i.value,r.appendChild(s)}),r}function Ec(e={}){let t=yn(),{overlay:n,card:r,confirmBtn:o,cancelBtn:i,form:s}=vn(e),a=!1,c=()=>{},l=()=>{n.classList.add("modal-overlay--hide"),setTimeout(()=>n.remove(),150),document.removeEventListener("keydown",m)},d=h=>{a||(a=!0,l(),c(h))},m=h=>{h.code==="Escape"&&(h.preventDefault(),d(!1)),h.code==="Enter"&&(h.preventDefault(),d(!0))};return new Promise(h=>{c=h,s.addEventListener("submit",b=>{b.preventDefault(),d(!0)}),o.addEventListener("click",()=>d(!0)),i.addEventListener("click",()=>d(!1)),n.addEventListener("click",b=>{b.target===n&&d(!1)}),document.addEventListener("keydown",m),t.appendChild(n),requestAnimationFrame(()=>{r.focus({preventScroll:!0})})})}function er(e={}){let t=yn(),n=null,r=null,o=Array.isArray(e.suggestions)?e.suggestions:[],i=null,{overlay:s,card:a,confirmBtn:c,cancelBtn:l,form:d}=vn({...e,renderBody:()=>{let x=document.createDocumentFragment();if(e.message){let C=document.createElement("p");C.className="modal-body__text",C.textContent=e.message,x.appendChild(C)}let A=document.createElement("input");if(A.type=e.inputType==="password"?"password":"text",A.className="modal-input",A.placeholder=e.placeholder||"",A.value=e.defaultValue||"",A.autocomplete="off",x.appendChild(A),e.checkbox&&typeof e.checkbox=="object"){let C=document.createElement("label");C.className="modal-checkbox";let L=document.createElement("input");L.type="checkbox",L.checked=!!e.checkbox.checked,L.disabled=!!e.checkbox.disabled;let H=document.createElement("span");H.className="modal-checkbox__label",H.textContent=String(e.checkbox.label||"").trim(),C.appendChild(L),C.appendChild(H),x.appendChild(C),r=L}return o.length&&(i=document.createElement("div"),i.className="modal-suggestions",x.appendChild(i)),n=A,x}}),m=!1,h=()=>{},b=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",p)},S=x=>{if(!m)if(m=!0,b(),e.returnMeta){let A={value:x??null,selectedId:n?.dataset?.selectedId||null,checkboxChecked:r?!!r.checked:null};h(A)}else h(x)},p=x=>{if(x.code==="Escape"){x.preventDefault(),S(null);return}if(x.code==="Enter"&&n&&!e.hideConfirm){let A=n.value.trim();if(!A&&!e.allowEmpty)return;x.preventDefault(),S(A)}},f=()=>{if(!c||!n)return;let x=!!n.value.trim();c.disabled=!x&&!e.allowEmpty},w=()=>{if(!i||!n)return;let x=n.value.trim().toLowerCase();n.dataset.selectedId="";let A=o.filter(C=>(C.title||"").toLowerCase().includes(x)||(C.id||"").toLowerCase().includes(x)).slice(0,8);if(i.innerHTML="",!x||!A.length){i.classList.add("hidden");return}i.classList.remove("hidden"),A.forEach(C=>{let L=document.createElement("button");L.type="button",L.className="modal-suggestion",L.textContent=C.title||C.id||"",L.addEventListener("click",()=>{n.value=C.title||C.id||"",n.dataset.selectedId=C.id||"",f(),w(),S(n.value)}),i.appendChild(L)})};return new Promise(x=>{h=x,c.classList.remove("danger-btn"),e.hideConfirm?c.style.display="none":c.textContent=e.confirmText||"OK",l.textContent=e.cancelText||"Cancel";let A=()=>{if(!n){S(null);return}let C=n.value.trim();if(!C){n.focus();return}S(C)};d.addEventListener("submit",C=>{C.preventDefault(),A()}),c.addEventListener("click",A),l.addEventListener("click",()=>S(null)),s.addEventListener("click",C=>{C.target===s&&S(null)}),document.addEventListener("keydown",p),n?(n.dataset.selectedId="",n.addEventListener("input",()=>{n.dataset.selectedId="",f(),o.length&&w()}),e.hideConfirm&&n.addEventListener("keydown",C=>{C.code==="Enter"&&(C.preventDefault(),S(n.value.trim()))}),f(),o.length&&w()):f(),t.appendChild(s),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):a.focus({preventScroll:!0})})})}function Ju(e={}){let t=yn(),n=null,r=null,o=Array.isArray(e.suggestions)?e.suggestions:[],i=null,{overlay:s,card:a,confirmBtn:c,cancelBtn:l,form:d}=vn({title:e.title||"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",renderBody:()=>{let x=document.createDocumentFragment();if(e.message){let U=document.createElement("p");U.className="modal-body__text",U.textContent=e.message,x.appendChild(U)}let A=document.createElement("label");A.className="modal-label",A.textContent=e.articleLabel||"\u0421\u0442\u0430\u0442\u044C\u044F";let C=document.createElement("input");C.type="text",C.className="modal-input",C.placeholder=e.articlePlaceholder||"ID \u0438\u043B\u0438 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435\u2026",C.value=e.defaultArticleValue||"",C.autocomplete="off",A.appendChild(C),x.appendChild(A),n=C,o.length&&(i=document.createElement("div"),i.className="modal-suggestions",x.appendChild(i));let L=document.createElement("label");L.className="modal-label",L.textContent=e.textLabel||"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)";let H=document.createElement("input");return H.type="text",H.className="modal-input",H.placeholder=e.textPlaceholder||"",H.value=e.defaultTextValue||"",H.autocomplete="off",L.appendChild(H),x.appendChild(L),r=H,x}}),m=!1,h=()=>{},b=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",w)},S=x=>{m||(m=!0,b(),h(x))},p=()=>{if(!c||!n)return;let x=!!n.value.trim()||!!n.dataset.selectedId;c.disabled=!x},f=()=>{if(!i||!n)return;let x=n.value.trim().toLowerCase();n.dataset.selectedId="";let A=o.filter(C=>(C.title||"").toLowerCase().includes(x)||(C.id||"").toLowerCase().includes(x)).slice(0,8);if(i.innerHTML="",!x||!A.length){i.classList.add("hidden");return}i.classList.remove("hidden"),A.forEach(C=>{let L=document.createElement("button");L.type="button",L.className="modal-suggestion",L.textContent=C.title||C.id||"",L.addEventListener("click",()=>{n.value=C.title||C.id||"",n.dataset.selectedId=C.id||"",p(),f(),r&&!r.value.trim()&&!e.lockTextValue&&(r.value=C.title||""),r?.focus?.({preventScroll:!0}),r?.select?.()}),i.appendChild(L)})},w=x=>{if(x.code==="Escape"){x.preventDefault(),S(null);return}x.code};return new Promise(x=>{h=x,c.classList.remove("danger-btn"),c.textContent=e.confirmText||"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",l.textContent=e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430";let A=()=>{if(!n||!r){S(null);return}let C=n.value.trim(),L=n.dataset.selectedId||"";if(!C&&!L){n.focus();return}S({articleValue:C,selectedId:L||null,textValue:r.value??""})};d.addEventListener("submit",C=>{C.preventDefault(),A()}),c.addEventListener("click",A),l.addEventListener("click",()=>S(null)),s.addEventListener("click",C=>{C.target===s&&S(null)}),document.addEventListener("keydown",w),n?(n.dataset.selectedId="",n.addEventListener("input",()=>{n.dataset.selectedId="",p(),o.length&&f()}),p(),o.length&&f()):p(),t.appendChild(s),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):a.focus({preventScroll:!0})})})}function Wu(e={}){let t=yn(),n=null,r=e.url||"",{overlay:o,card:i,confirmBtn:s,cancelBtn:a}=vn({title:e.title||"\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u0430\u044F \u0441\u0441\u044B\u043B\u043A\u0430",renderBody:()=>{let p=document.createDocumentFragment(),f=document.createElement("label");f.className="modal-label",f.textContent=e.label||"\u041F\u0440\u043E\u0441\u043C\u043E\u0442\u0440 \u043F\u043E \u0441\u0441\u044B\u043B\u043A\u0435";let w=document.createElement("input");return w.type="text",w.className="modal-input",w.value=r,w.readOnly=!0,w.autocomplete="off",f.appendChild(w),n=w,p.appendChild(f),p}}),c=!1,l=()=>{},d=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",h)},m=()=>{c||(c=!0,d(),l())},h=p=>{p.code==="Escape"&&(p.preventDefault(),m())},b=p=>{if(!p)return!1;let f=document.createElement("textarea");f.value=p,f.setAttribute("readonly",""),f.style.position="absolute",f.style.left="-9999px",document.body.appendChild(f),f.focus(),f.select();let w=!1;try{w=document.execCommand("copy")}catch{w=!1}return document.body.removeChild(f),w},S=()=>{let p=n&&n.value||r;if(p){Ie("\u0421\u0441\u044B\u043B\u043A\u0430 \u0441\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u0430");try{if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function"){let f=navigator.clipboard.writeText(p);f&&typeof f.catch=="function"&&f.catch(()=>{b(p)})}else b(p)}catch{b(p)}}};return new Promise(p=>{l=p,s.classList.remove("danger-btn"),s.innerHTML='<i class="bx bx-copy" aria-hidden="true"></i> \u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443',s.setAttribute("aria-label",e.copyLabel||"\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443"),a.classList.add("hidden"),s.addEventListener("click",()=>{S(),m()}),o.addEventListener("click",f=>{f.target===o&&m()}),document.addEventListener("keydown",h),t.appendChild(o),requestAnimationFrame(()=>{n?n.focus({preventScroll:!0}):i.focus({preventScroll:!0})})})}function Yu(e={}){let t=yn(),n=Array.isArray(e.versions)?e.versions:[],r=n[0]?.id||"",o=w=>{try{let x=new Date(w);return Number.isNaN(x.getTime())?String(w||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(x)}catch{return String(w||"")}},{overlay:i,card:s,confirmBtn:a,cancelBtn:c,form:l}=vn({title:e.title||"\u0412\u0435\u0440\u0441\u0438\u0438",confirmText:e.confirmText||"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",cancelText:e.cancelText||"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",renderBody:()=>{let w=document.createDocumentFragment(),x=document.createElement("p");if(x.className="modal-body__text",x.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0435\u0440\u0441\u0438\u044E \u0441\u0442\u0430\u0442\u044C\u0438 \u0434\u043B\u044F \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F.",w.appendChild(x),!n.length){let C=document.createElement("div");return C.className="modal-empty",C.textContent="\u0412\u0435\u0440\u0441\u0438\u0439 \u043F\u043E\u043A\u0430 \u043D\u0435\u0442.",w.appendChild(C),w}let A=document.createElement("div");return A.className="modal-list",n.forEach((C,L)=>{let H=document.createElement("label");H.className="modal-list__item";let U=document.createElement("input");U.type="radio",U.name="version",U.value=C.id||"",U.checked=L===0,U.addEventListener("change",()=>{r=U.value,a.disabled=!r,d.disabled=!r});let F=document.createElement("div");F.className="modal-list__meta";let X=document.createElement("div");X.className="modal-list__title",X.textContent=C.label||o(C.created_at||C.createdAt);let G=document.createElement("div");G.className="modal-list__subtitle";let oe=C.reason||"",we=o(C.created_at||C.createdAt);G.textContent=[we,oe].filter(Boolean).join(" \xB7 "),F.appendChild(X),F.appendChild(G),H.appendChild(U),H.appendChild(F),A.appendChild(H)}),w.appendChild(A),w}});s.classList.add("modal-card--diff-light"),a.classList.remove("danger-btn"),a.disabled=!r;let d=document.createElement("button");d.type="button",d.className="ghost",d.textContent=e.compareText||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C",d.disabled=!r;let m=s.querySelector(".modal-footer");m&&m.insertBefore(d,a);let h=!1,b=()=>{},S=()=>{i.classList.add("modal-overlay--hide"),setTimeout(()=>i.remove(),150),document.removeEventListener("keydown",f)},p=w=>{h||(h=!0,S(),b(w))},f=w=>{w.code==="Escape"&&(w.preventDefault(),p(null))};return new Promise(w=>{b=w;let x=()=>{r&&p({action:"restore",versionId:r})};l.addEventListener("submit",A=>{A.preventDefault(),x()}),a.addEventListener("click",x),d.addEventListener("click",()=>{r&&p({action:"compare",versionId:r})}),c.addEventListener("click",()=>p(null)),i.addEventListener("click",A=>{A.target===i&&p(null)}),document.addEventListener("keydown",f),t.appendChild(i),requestAnimationFrame(()=>{s.focus({preventScroll:!0})})})}function Gu(e={}){let t=yn(),n=Array.isArray(e.versions)?e.versions:[],r=String(e.excludeId||""),o=[{kind:"current",id:"__current__",title:"\u0422\u0435\u043A\u0443\u0449\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F"},...n.filter(f=>String(f.id||"")&&String(f.id||"")!==r).map(f=>({kind:"version",id:String(f.id),title:f.label||f.created_at||f.createdAt||f.id}))],i=o[0]?.id||"",{overlay:s,card:a,confirmBtn:c,cancelBtn:l,form:d}=vn({title:e.title||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C \u0441\u2026",confirmText:e.confirmText||"\u0421\u0440\u0430\u0432\u043D\u0438\u0442\u044C",cancelText:e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430",renderBody:()=>{let f=document.createDocumentFragment(),w=document.createElement("p");w.className="modal-body__text",w.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0432\u0442\u043E\u0440\u0443\u044E \u0441\u0442\u043E\u0440\u043E\u043D\u0443 \u0441\u0440\u0430\u0432\u043D\u0435\u043D\u0438\u044F.",f.appendChild(w);let x=document.createElement("div");return x.className="modal-list",o.forEach((A,C)=>{let L=document.createElement("label");L.className="modal-list__item";let H=document.createElement("input");H.type="radio",H.name="compareTarget",H.value=A.id,H.checked=C===0,H.addEventListener("change",()=>{i=H.value,c.disabled=!i});let U=document.createElement("div");U.className="modal-list__meta";let F=document.createElement("div");F.className="modal-list__title",F.textContent=A.title,U.appendChild(F),L.appendChild(H),L.appendChild(U),x.appendChild(L)}),f.appendChild(x),f}});a.classList.add("modal-card--diff-light"),c.classList.remove("danger-btn"),c.disabled=!i;let m=!1,h=()=>{},b=()=>{s.classList.add("modal-overlay--hide"),setTimeout(()=>s.remove(),150),document.removeEventListener("keydown",p)},S=f=>{m||(m=!0,b(),h(f))},p=f=>{f.code==="Escape"&&(f.preventDefault(),S(null))};return new Promise(f=>{h=f;let w=()=>{if(!i)return;let x=o.find(A=>A.id===i)||null;if(!x){S(null);return}if(x.kind==="current"){S({target:"current"});return}S({target:"version",versionId:x.id})};d.addEventListener("submit",x=>{x.preventDefault(),w()}),c.addEventListener("click",w),l.addEventListener("click",()=>S(null)),s.addEventListener("click",x=>{x.target===s&&S(null)}),document.addEventListener("keydown",p),t.appendChild(s),requestAnimationFrame(()=>{a.focus({preventScroll:!0})})})}function Xu(e={}){let t=yn(),n=Array.isArray(e.changes)?e.changes:[],r=n.find(b=>b.type==="changed")||n[0]||null,{overlay:o,card:i,confirmBtn:s,cancelBtn:a}=vn({title:e.title||"\u041E\u0442\u043B\u0438\u0447\u0438\u044F \u0432\u0435\u0440\u0441\u0438\u0439",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:"",renderBody:()=>{let b=document.createDocumentFragment(),S=document.createElement("div");S.className="diff-summary";let p=n.reduce((X,G)=>(X[G.type]=(X[G.type]||0)+1,X),{added:0,removed:0,changed:0});if(S.textContent=`\u0418\u0437\u043C\u0435\u043D\u0435\u043D\u043E: ${p.changed||0} \xB7 \u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E: ${p.added||0} \xB7 \u0423\u0434\u0430\u043B\u0435\u043D\u043E: ${p.removed||0}`,b.appendChild(S),!n.length){let X=document.createElement("div");return X.className="modal-empty",X.textContent="\u041D\u0435\u0442 \u043E\u0442\u043B\u0438\u0447\u0438\u0439.",b.appendChild(X),b}let f=document.createElement("div");f.className="modal-list",n.forEach(X=>{let G=document.createElement("button");G.type="button",G.className=`diff-item diff-item--${X.type}${r&&r.id===X.id?" diff-item--active":""}`;let oe=X.label||X.id;G.textContent=`${X.type==="changed"?"\u2260":X.type==="added"?"+":"\u2212"} ${oe}`,G.addEventListener("click",()=>{r=X,f.querySelectorAll(".diff-item").forEach(we=>we.classList.remove("diff-item--active")),G.classList.add("diff-item--active"),F()}),f.appendChild(G)}),b.appendChild(f);let w=document.createElement("div");w.className="diff-panes";let x=document.createElement("div");x.className="diff-pane-wrap";let A=document.createElement("div");A.className="diff-pane-wrap";let C=document.createElement("div");C.className="diff-pane-title",C.textContent=e.beforeTitle||"\u0412\u0435\u0440\u0441\u0438\u044F";let L=document.createElement("div");L.className="diff-pane-title",L.textContent=e.afterTitle||"\u0422\u0435\u043A\u0443\u0449\u0430\u044F";let H=document.createElement("div");H.className="diff-pane diff-pane--before";let U=document.createElement("div");U.className="diff-pane diff-pane--after",x.appendChild(C),x.appendChild(H),A.appendChild(L),A.appendChild(U),w.appendChild(x),w.appendChild(A),b.appendChild(w);let F=()=>{let X=r?.before||"",G=r?.after||"";H.innerHTML="",U.innerHTML="",H.appendChild(Rr({baseText:X,nextText:G,mode:"before"})),U.appendChild(Rr({baseText:X,nextText:G,mode:"after"}))};return F(),b}});i.classList.add("modal-card--fullscreen"),i.classList.add("modal-card--diff-light"),s.classList.remove("danger-btn"),a&&(a.style.display="none");let c=!1,l=()=>{},d=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",h)},m=()=>{c||(c=!0,d(),l())},h=b=>{b.code==="Escape"&&(b.preventDefault(),m())};return new Promise(b=>{l=b,s.addEventListener("click",m),o.addEventListener("click",S=>{S.target===o&&m()}),document.addEventListener("keydown",h),t.appendChild(o),requestAnimationFrame(()=>{i.focus({preventScroll:!0})})})}function Qu(e={}){let t=yn(),n=Array.isArray(e.entries)?e.entries:[],r=n[0]||null,o=r,i=[],s=null,a=w=>{try{let x=new Date(w);return Number.isNaN(x.getTime())?String(w||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(x)}catch{return String(w||"")}},{overlay:c,card:l,confirmBtn:d,cancelBtn:m}=vn({title:e.title||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0431\u043B\u043E\u043A\u0430",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:e.canRestore?"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C (\u043F\u043E\u0441\u043B\u0435 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F)":"",renderBody:()=>{let w=document.createDocumentFragment(),x=document.createElement("p");if(x.className="modal-body__text",x.textContent=e.message||"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0435. \u041C\u043E\u0436\u043D\u043E \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430 \u0434\u043E \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F.",w.appendChild(x),!n.length){let ne=document.createElement("div");return ne.className="modal-empty",ne.textContent="\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430.",w.appendChild(ne),w}let A=document.createElement("div");A.className="diff-layout";let C=document.createElement("div");C.className="modal-list diff-sidebar",i=[],n.forEach(ne=>{let ye=document.createElement("button");ye.type="button";let Ye=!!(r&&r.id===ne.id);ye.className=`diff-item${Ye?" diff-item--active":""}`,ye.setAttribute("aria-selected",Ye?"true":"false");let wt=a(ne.timestamp);ye.textContent=wt?`\u2260 ${wt}`:`\u2260 ${ne.id||""}`.trim(),ye.addEventListener("click",()=>{r=ne,C.querySelectorAll(".diff-item").forEach(Pt=>{Pt.classList.remove("diff-item--active"),Pt.setAttribute("aria-selected","false")}),ye.classList.add("diff-item--active"),ye.setAttribute("aria-selected","true"),Ce()}),C.appendChild(ye),i.push(ye)});let L=document.createElement("div");L.className="diff-main";let H=document.createElement("div");H.className="diff-panes diff-panes--side";let U=document.createElement("div");U.className="diff-pane-wrap";let F=document.createElement("div");F.className="diff-pane-wrap";let X=document.createElement("div");X.className="diff-pane-title",X.textContent=e.beforeTitle||"\u0414\u043E";let G=document.createElement("div");G.className="diff-pane-title",G.textContent=e.afterTitle||"\u041F\u043E\u0441\u043B\u0435";let oe=document.createElement("div");oe.className="diff-pane diff-pane--before";let we=document.createElement("div");we.className="diff-pane diff-pane--after",U.appendChild(X),U.appendChild(oe),F.appendChild(G),F.appendChild(we),H.appendChild(U),H.appendChild(F),L.appendChild(H),A.appendChild(C),A.appendChild(L),w.appendChild(A);let Ce=()=>{o=r;let ne=r?.beforePlain||r?.before||"",ye=r?.afterPlain||r?.after||"";oe.innerHTML="",we.innerHTML="",oe.appendChild(Rr({baseText:ne,nextText:ye,mode:"before"})),we.appendChild(Rr({baseText:ne,nextText:ye,mode:"after"}))};return s=Ce,Ce(),w}});l.classList.add("modal-card--fullscreen"),l.classList.add("modal-card--diff-light"),d.classList.remove("danger-btn"),!e.canRestore&&m&&(m.style.display="none"),m&&m.classList.add("danger-btn");let h=!1,b=()=>{},S=()=>{c.classList.add("modal-overlay--hide"),setTimeout(()=>c.remove(),150),document.removeEventListener("keydown",f)},p=w=>{h||(h=!0,S(),b(w))},f=w=>{if(w.code==="Escape"&&(w.preventDefault(),p(null)),w.code==="ArrowUp"||w.code==="ArrowDown"){if(!n.length)return;w.preventDefault();let x=String(r?.id||""),A=n.findIndex(H=>String(H?.id||"")===x);A<0&&(A=0),A=w.code==="ArrowUp"?Math.max(0,A-1):Math.min(n.length-1,A+1);let C=n[A]||null;if(!C)return;r=C;let L=i[A];if(i.forEach(H=>{H.classList.remove("diff-item--active"),H.setAttribute("aria-selected","false")}),L){L.classList.add("diff-item--active"),L.setAttribute("aria-selected","true"),L.focus({preventScroll:!0});try{L.scrollIntoView({block:"nearest"})}catch{}}typeof s=="function"&&s()}};return new Promise(w=>{b=w,d.addEventListener("click",()=>p(null)),m&&e.canRestore&&m.addEventListener("click",()=>p({action:"restore",entry:o||r||null})),c.addEventListener("click",x=>{x.target===c&&p(null)}),document.addEventListener("keydown",f),t.appendChild(c),requestAnimationFrame(()=>{l.focus({preventScroll:!0})})})}function kc(e){let t=[],n=r=>{if(!r)return;if(typeof r=="string"){t.push(r);return}if(Array.isArray(r)){r.forEach(n);return}if(typeof r!="object")return;typeof r.text=="string"&&t.push(r.text);let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(e),t.join("").replace(/\u00a0/g," ").trim()}function Zu(e){return!e||typeof e!="object"?!1:!!(e.beforeHeadingJson||e.beforeBodyJson||e.afterHeadingJson||e.afterBodyJson)}function ef(e={}){let t=yn(),r=(Array.isArray(e.entries)?e.entries:[]).filter(Zu),o=typeof e.onRestore=="function"?e.onRestore:null,i=F=>String(F??"").replace(/\u00a0/g," ").trim(),s=r.map(F=>({...F,beforePlain:i(F.beforePlain??F.before??""),afterPlain:i(F.afterPlain??F.after??"")})),a=new Map;for(let F of s){let X=String(F?.blockId||"").trim();if(!X)continue;let G=a.get(X)||{blockId:X,entries:[],latestAt:0,label:""};G.entries.push(F);let oe=Date.parse(F.timestamp||"")||0;if(oe>G.latestAt&&(G.latestAt=oe),!G.label){let we=kc(F.afterHeadingJson)||kc(F.beforeHeadingJson)||"",Ce=(F.afterPlain||F.beforePlain||"").split(`
`).map(ne=>ne.trim()).find(Boolean)||"";G.label=we||Ce||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"}a.set(X,G)}let c=Array.from(a.values()).sort((F,X)=>(X.latestAt||0)-(F.latestAt||0)),l=c[0]?.blockId||null,d=null,m=!1,h=F=>{try{let X=new Date(F);return Number.isNaN(X.getTime())?String(F||""):new Intl.DateTimeFormat("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(X)}catch{return String(F||"")}},{overlay:b,card:S,confirmBtn:p,cancelBtn:f}=vn({title:e.title||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0441\u0442\u0430\u0442\u044C\u0438",confirmText:"\u0417\u0430\u043A\u0440\u044B\u0442\u044C",cancelText:e.canRestore?"\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C":"",renderBody:()=>{let F=document.createDocumentFragment(),X=document.createElement("p");if(X.className="modal-body__text",X.textContent=e.message||"\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439 outline-\u0440\u0435\u0436\u0438\u043C\u0430. \u041C\u043E\u0436\u043D\u043E \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u0432\u044B\u0431\u0440\u0430\u043D\u043D\u043E\u0435 \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0441\u0435\u043A\u0446\u0438\u0438 (\u0435\u0441\u043B\u0438 \u0441\u0435\u043A\u0446\u0438\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u2014 \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432 \u043A\u043E\u043D\u0435\u0446 \u0441\u0442\u0430\u0442\u044C\u0438).",F.appendChild(X),!c.length){let _t=document.createElement("div");return _t.className="modal-empty",_t.textContent="\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430.",F.appendChild(_t),F}let G=document.createElement("div");G.className="diff-layout diff-layout--article-history";let oe=document.createElement("div");oe.className="modal-list diff-sidebar",oe.classList.add("diff-sections");let we=document.createElement("input");we.type="text",we.className="modal-input",we.placeholder="\u041F\u043E\u0438\u0441\u043A \u043F\u043E \u0438\u0441\u0442\u043E\u0440\u0438\u0438\u2026",oe.appendChild(we);let Ce=document.createElement("div");Ce.style.marginTop="8px",oe.appendChild(Ce);let ne=document.createElement("div");ne.className="diff-main";let ye=document.createElement("div");ye.className="diff-layout diff-layout--article-history-inner";let Ye=document.createElement("div");Ye.className="modal-list diff-sidebar",Ye.classList.add("diff-revisions");let wt=document.createElement("div");wt.className="diff-panes diff-panes--side";let Pt=document.createElement("div");Pt.className="diff-pane-wrap";let sn=document.createElement("div");sn.className="diff-pane-wrap";let mn=document.createElement("div");mn.className="diff-pane-title",mn.textContent=e.beforeTitle||"\u0414\u043E";let An=document.createElement("div");An.className="diff-pane-title",An.textContent=e.afterTitle||"\u041F\u043E\u0441\u043B\u0435";let Nn=document.createElement("div");Nn.className="diff-pane diff-pane--before";let $n=document.createElement("div");$n.className="diff-pane diff-pane--after",Pt.appendChild(mn),Pt.appendChild(Nn),sn.appendChild(An),sn.appendChild($n),wt.appendChild(Pt),wt.appendChild(sn),ye.appendChild(Ye),ye.appendChild(wt),ne.appendChild(ye),G.appendChild(oe),G.appendChild(ne),F.appendChild(G);let Fn=()=>{let _t=we.value.trim().toLowerCase(),Kt=_t?c.filter(It=>(It.label||"").toLowerCase().includes(_t)?!0:(It.entries||[]).some(gt=>`${gt.beforePlain||""}
${gt.afterPlain||""}`.toLowerCase().includes(_t))):c;Ce.innerHTML="",Kt.forEach(It=>{let gt=document.createElement("button");gt.type="button";let Dt=It.blockId===l;gt.className=`diff-item${Dt?" diff-item--active":""}`,gt.setAttribute("aria-selected",Dt?"true":"false");let an=It.latestAt?h(new Date(It.latestAt).toISOString()):"",Y=Array.isArray(It.entries)?It.entries.length:0;gt.textContent=`${It.label||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"}${an?` \xB7 ${an}`:""}${Y?` \xB7 ${Y}`:""}`,gt.addEventListener("click",()=>{l=It.blockId,d=null,m=!1,Fn(),Mn(),Ln()}),Ce.appendChild(gt)}),l&&!Kt.some(It=>It.blockId===l)&&(l=Kt[0]?.blockId||null,d=null,m=!1,Mn(),Ln())},Mn=()=>{let _t=l?a.get(l):null,Kt=Array.isArray(_t?.entries)?_t.entries.slice():[];Kt.sort((gt,Dt)=>(Date.parse(Dt.timestamp||"")||0)-(Date.parse(gt.timestamp||"")||0));let It=d&&Kt.some(gt=>String(gt?.id||"")===String(d||""));(!m||!It)&&(d=Kt[0]?.id||null),Ye.innerHTML="",Kt.forEach(gt=>{let Dt=document.createElement("button");Dt.type="button";let an=String(gt.id||"")===String(d||"");Dt.className=`diff-item${an?" diff-item--active":""}`,Dt.setAttribute("aria-selected",an?"true":"false");let Y=h(gt.timestamp),ie=(gt.afterPlain||gt.beforePlain||"").slice(0,64).trim();Dt.textContent=`${Y?`\u2260 ${Y}`:`\u2260 ${gt.id||""}`}${ie?` \xB7 ${ie}`:""}`,Dt.addEventListener("click",()=>{d=gt.id||null,m=!0,Mn(),Ln()}),Ye.appendChild(Dt)})},Ln=()=>{let _t=l?a.get(l):null,Kt=Array.isArray(_t?.entries)?_t.entries:[],It=Kt.find(an=>String(an?.id||"")===String(d||""))||Kt[0]||null,gt=It?.beforePlain||"",Dt=It?.afterPlain||"";Nn.innerHTML="",$n.innerHTML="",Nn.appendChild(Rr({baseText:gt,nextText:Dt,mode:"before"})),$n.appendChild(Rr({baseText:gt,nextText:Dt,mode:"after"}))};return we.addEventListener("input",()=>{Fn()}),Fn(),Mn(),Ln(),F}});S.classList.add("modal-card--fullscreen"),S.classList.add("modal-card--diff-light"),p.classList.remove("danger-btn"),!e.canRestore&&f&&(f.style.display="none"),f&&f.classList.add("danger-btn");let w=!1,x=()=>{},A=!1,C=()=>{b.classList.add("modal-overlay--hide"),setTimeout(()=>b.remove(),150),document.removeEventListener("keydown",H)},L=F=>{w||(w=!0,C(),x(F))},H=F=>{F.code==="Escape"&&(F.preventDefault(),L(null))},U=()=>{let F=l?a.get(l):null,X=Array.isArray(F?.entries)?F.entries:[];return X.find(G=>String(G?.id||"")===String(d||""))||X[0]||null};return new Promise(F=>{x=F,p.addEventListener("click",()=>L(null)),f&&e.canRestore&&f.addEventListener("click",async()=>{let X=U();if(!X){Ie("\u0418\u0441\u0442\u043E\u0440\u0438\u044F \u043F\u0443\u0441\u0442\u0430");return}if(!o){L({action:"restore",entry:X});return}if(A)return;A=!0;let G=f.textContent;try{f.disabled=!0,p.disabled=!0,f.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u0430\u0432\u043B\u0438\u0432\u0430\u0435\u043C\u2026",await o(X)}catch(oe){Ie(oe?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C")}finally{A=!1,f.textContent=G,f.disabled=!1,p.disabled=!1}}),b.addEventListener("click",X=>{X.target===b&&L(null)}),document.addEventListener("keydown",H),t.appendChild(b),requestAnimationFrame(()=>{S.focus({preventScroll:!0})})})}function us(e={}){let t=yn(),n=null,r=null,{overlay:o,card:i,confirmBtn:s,cancelBtn:a,form:c}=vn({...e,renderBody:()=>{let p=document.createDocumentFragment();if(e.message){let C=document.createElement("p");C.className="modal-body__text",C.textContent=e.message,p.appendChild(C)}let f=document.createElement("label");f.className="modal-label",f.textContent=e.textLabel||"\u0422\u0435\u043A\u0441\u0442";let w=document.createElement("input");w.type="text",w.className="modal-input",w.placeholder=e.textPlaceholder||"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438",w.value=e.defaultText||"",w.autocomplete="off",f.appendChild(w);let x=document.createElement("label");x.className="modal-label",x.textContent=e.urlLabel||"\u0421\u0441\u044B\u043B\u043A\u0430";let A=document.createElement("input");return A.type="text",A.className="modal-input",A.placeholder=e.urlPlaceholder||"https://example.com",A.value=e.defaultUrl||"",A.autocomplete="off",x.appendChild(A),n=w,r=A,p.appendChild(f),p.appendChild(x),p}}),l=!1,d=()=>{},m=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",b)},h=p=>{l||(l=!0,m(),d(p))},b=p=>{if(p.code==="Escape"){p.preventDefault(),h(null);return}p.code==="Enter"&&!s.disabled&&(p.preventDefault(),h({text:(n?.value||"").trim(),url:(r?.value||"").trim()}))},S=()=>{let p=!!(r?.value||"").trim();s.disabled=!p};return new Promise(p=>{d=p,s.classList.remove("danger-btn"),s.textContent=e.confirmText||"OK",a.textContent=e.cancelText||"Cancel";let f=()=>{h({text:(n?.value||"").trim(),url:(r?.value||"").trim()})};c.addEventListener("submit",x=>{x.preventDefault(),s.disabled||f()}),s.addEventListener("click",f),a.addEventListener("click",()=>h(null)),o.addEventListener("click",x=>{x.target===o&&h(null)}),document.addEventListener("keydown",b);let w=x=>{x&&x.addEventListener("input",S)};w(n),w(r),S(),t.appendChild(o),requestAnimationFrame(()=>{r?(r.focus({preventScroll:!0}),r.value&&r.setSelectionRange(r.value.length,r.value.length)):i.focus({preventScroll:!0})})})}function Cc(e={}){let t=yn(),n=null,r=null,{overlay:o,card:i,confirmBtn:s,cancelBtn:a,form:c}=vn({...e,renderBody:()=>{let p=document.createDocumentFragment();if(e.message){let C=document.createElement("p");C.className="modal-body__text",C.textContent=e.message,p.appendChild(C)}let f=document.createElement("label");f.className="modal-label",f.textContent="\u041F\u0430\u0440\u043E\u043B\u044C";let w=document.createElement("input");w.type="password",w.className="modal-input",w.placeholder="\u041F\u0430\u0440\u043E\u043B\u044C \u0434\u043B\u044F \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B",w.autocomplete="off",f.appendChild(w);let x=document.createElement("label");x.className="modal-label",x.textContent="\u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0430 (\u043D\u0435\u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u044C\u043D\u043E)";let A=document.createElement("input");return A.type="text",A.className="modal-input",A.placeholder="\u041D\u0430\u043F\u043E\u043C\u0438\u043D\u0430\u043D\u0438\u0435 \u043E \u043F\u0430\u0440\u043E\u043B\u0435",A.autocomplete="off",x.appendChild(A),n=w,r=A,p.appendChild(f),p.appendChild(x),p}}),l=!1,d=()=>{},m=()=>{o.classList.add("modal-overlay--hide"),setTimeout(()=>o.remove(),150),document.removeEventListener("keydown",b)},h=p=>{l||(l=!0,m(),d(p))},b=p=>{if(p.code==="Escape"){p.preventDefault(),h(null);return}p.code==="Enter"&&!s.disabled&&(p.preventDefault(),h({password:(n?.value||"").trim(),hint:(r?.value||"").trim()}))},S=()=>{let p=!!(n?.value||"").trim();s.disabled=!p};return new Promise(p=>{d=p,s.classList.remove("danger-btn"),s.textContent=e.confirmText||"\u0417\u0430\u0449\u0438\u0442\u0438\u0442\u044C",a.textContent=e.cancelText||"\u041E\u0442\u043C\u0435\u043D\u0430";let f=()=>{s.disabled||h({password:(n?.value||"").trim(),hint:(r?.value||"").trim()})};s.addEventListener("click",f),c.addEventListener("submit",w=>{w.preventDefault(),f()}),a.addEventListener("click",()=>h(null)),o.addEventListener("click",w=>{w.target===o&&h(null)}),document.addEventListener("keydown",b),n&&n.addEventListener("input",S),S(),t.appendChild(o),requestAnimationFrame(()=>{n?(n.focus({preventScroll:!0}),n.select()):i.focus({preventScroll:!0})})})}function tf(e={}){let t=yn(),n=Array.isArray(e.items)?e.items:[],{overlay:r,card:o,confirmBtn:i,cancelBtn:s}=vn({title:e.title||"\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432",renderBody:()=>{let h=document.createElement("div");if(!n.length){let S=document.createElement("p");return S.className="modal-body__text",S.textContent="\u041A\u043E\u0440\u0437\u0438\u043D\u0430 \u0431\u043B\u043E\u043A\u043E\u0432 \u043F\u0443\u0441\u0442\u0430",h.appendChild(S),h}let b=document.createElement("div");return b.className="block-trash-list",n.forEach(S=>{let p=document.createElement("div");p.className="block-trash-item";let f=S.block&&S.block.text||"",w=Ac(f),x=document.createElement("div");x.className="block-trash-item__title",x.textContent=w[0]||"(\u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A)";let A=document.createElement("div");A.className="block-trash-item__meta";let C=S.deletedAt?new Date(S.deletedAt).toLocaleString():"";A.textContent=C||"";let L=document.createElement("div");L.className="block-trash-item__info",L.appendChild(x),C&&L.appendChild(A);let H=document.createElement("button");H.type="button",H.className="primary",H.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C",H.addEventListener("click",()=>{d(S)}),p.appendChild(L),p.appendChild(H),b.appendChild(p)}),h.appendChild(b),h}}),a=!1,c=()=>{},l=()=>{r.classList.add("modal-overlay--hide"),setTimeout(()=>r.remove(),150),document.removeEventListener("keydown",m)},d=h=>{a||(a=!0,l(),c(h||null))},m=h=>{h.code==="Escape"&&(h.preventDefault(),d(null))};return new Promise(h=>{c=h,i.classList.remove("hidden"),i.textContent="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u043A\u043E\u0440\u0437\u0438\u043D\u0443",i.classList.add("danger-btn"),s.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",i.addEventListener("click",()=>d({action:"clear"})),s.addEventListener("click",()=>d(null)),r.addEventListener("click",b=>{b.target===r&&d(null)}),document.addEventListener("keydown",m),t.appendChild(r),requestAnimationFrame(()=>{o.focus({preventScroll:!0})})})}function nf(e={}){let t=yn(),{title:n,message:r,existingTitle:o,importedTitle:i,existingCreatedAt:s,existingUpdatedAt:a,importedCreatedAt:c,importedUpdatedAt:l,allowApplyToAll:d=!0}=e||{},m=document.createElement("div");m.className="modal-overlay";let h=document.createElement("div");h.className="modal-card",h.setAttribute("role","dialog"),h.setAttribute("aria-modal","true"),h.tabIndex=-1;let b=document.createElement("div");b.className="modal-header";let S=document.createElement("h3");S.textContent=n||"\u041A\u043E\u043D\u0444\u043B\u0438\u043A\u0442 \u043F\u0440\u0438 \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0438",b.appendChild(S);let p=document.createElement("div");if(p.className="modal-body",r){let oe=document.createElement("p");oe.className="modal-body__text",oe.textContent=r,p.appendChild(oe)}if(o||i){let oe=document.createElement("p");oe.className="modal-body__text",oe.innerHTML=[o?`<strong>\u0412 \u0431\u0430\u0437\u0435:</strong> ${o}`:"",i?`<strong>\u0418\u0437 \u0444\u0430\u0439\u043B\u0430:</strong> ${i}`:""].filter(Boolean).join("<br />"),p.appendChild(oe)}if(s||a||c||l){let oe=ne=>{if(!ne)return"";let ye=new Date(ne);return Number.isNaN(ye.getTime())?ne:ye.toLocaleString()},we=document.createElement("p");we.className="modal-body__text";let Ce=[];if(s||a){let ne=s?oe(s):"\u2014",ye=a?oe(a):"\u2014";Ce.push(`<strong>\u0412 \u0431\u0430\u0437\u0435:</strong> \u0441\u043E\u0437\u0434\u0430\u043D\u0430 ${ne}, \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430 ${ye}`)}if(c||l){let ne=c?oe(c):"\u2014",ye=l?oe(l):"\u2014";Ce.push(`<strong>\u0418\u0437 \u0444\u0430\u0439\u043B\u0430:</strong> \u0441\u043E\u0437\u0434\u0430\u043D\u0430 ${ne}, \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430 ${ye}`)}we.innerHTML=Ce.join("<br />"),p.appendChild(we)}let f=null;if(d){let oe=document.createElement("label");oe.className="modal-label";let we=document.createElement("input");we.type="checkbox",we.style.marginRight="0.5rem",oe.appendChild(we),oe.appendChild(document.createTextNode("\u041F\u0440\u0438\u043C\u0435\u043D\u044F\u0442\u044C \u044D\u0442\u043E \u0440\u0435\u0448\u0435\u043D\u0438\u0435 \u043A\u043E \u0432\u0441\u0435\u043C \u043A\u043E\u043D\u0444\u043B\u0438\u043A\u0442\u0430\u043C")),f=we,p.appendChild(oe)}let w=document.createElement("div");w.className="modal-footer modal-footer--stacked";let x=document.createElement("button");x.type="button",x.className="ghost",x.textContent="\u041E\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0443\u044E";let A=document.createElement("button");A.type="button",A.className="primary danger-btn",A.textContent="\u041F\u0435\u0440\u0435\u0437\u0430\u043F\u0438\u0441\u0430\u0442\u044C";let C=document.createElement("button");C.type="button",C.className="ghost",C.textContent="\u0421\u043E\u0437\u0434\u0430\u0442\u044C \u043A\u043E\u043F\u0438\u044E";let L=document.createElement("button");L.type="button",L.className="ghost",L.textContent="\u041E\u0442\u043C\u0435\u043D\u0430",w.appendChild(x),w.appendChild(A),w.appendChild(C),w.appendChild(L),h.appendChild(b),h.appendChild(p),h.appendChild(w),m.appendChild(h);let H=!1,U=()=>{},F=()=>{m.classList.add("modal-overlay--hide"),setTimeout(()=>m.remove(),150),document.removeEventListener("keydown",G)},X=oe=>{if(H)return;H=!0;let we=!!(f&&f.checked);F(),U({action:oe,applyToAll:we})},G=oe=>{oe.code==="Escape"&&(oe.preventDefault(),X(null))};return new Promise(oe=>{U=oe,x.addEventListener("click",()=>X("keep")),A.addEventListener("click",()=>X("overwrite")),C.addEventListener("click",()=>X("copy")),L.addEventListener("click",()=>X(null)),m.addEventListener("click",we=>{we.target===m&&X(null)}),document.addEventListener("keydown",G),t.appendChild(m),requestAnimationFrame(()=>{h.focus({preventScroll:!0})})})}function uo(e,t=""){let n=yn(),r=document.createElement("div");r.className="modal-overlay image-modal";let o=document.createElement("div");o.className="image-modal__card",o.setAttribute("role","dialog"),o.setAttribute("aria-modal","true"),o.tabIndex=-1;let i=document.createElement("img");i.className="image-modal__img",i.src=e,t&&(i.alt=t),o.appendChild(i),r.appendChild(o);let s,a=()=>{s&&s()},c=l=>{l.code==="Escape"&&(l.preventDefault(),a())};s=()=>{document.removeEventListener("keydown",c),r.classList.add("modal-overlay--hide"),setTimeout(()=>r.remove(),150)},r.addEventListener("click",l=>{l.target===r&&a()}),document.addEventListener("keydown",c),n.appendChild(r),requestAnimationFrame(()=>{o.focus({preventScroll:!0})})}var Ic,tr=Ge(()=>{_n();en();Ic="modal-root"});function vc(e){if(typeof btoa=="function"){let t="";for(let n=0;n<e.length;n+=1)t+=String.fromCharCode(e[n]);return btoa(t)}if(typeof Buffer<"u")return Buffer.from(e).toString("base64");throw new Error("No base64 encoder available")}function Tc(e){if(!e)return new Uint8Array(0);if(typeof atob=="function"){let t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r+=1)n[r]=t.charCodeAt(r);return n}if(typeof Buffer<"u"){let t=Buffer.from(e,"base64"),n=new Uint8Array(t.length);for(let r=0;r<t.length;r+=1)n[r]=t[r];return n}throw new Error("No base64 decoder available")}function ms(e){return typeof e=="string"&&e.startsWith(ps)}async function Bc(e,t){if(!e)throw new Error("Password is required");let n=t&&t.length?Tc(t):Nc(16),r=Go(e||""),o=new Uint8Array(r.length+n.length);return o.set(r,0),o.set(n,r.length),{key:{raw:Go(String.fromCharCode(...o))},salt:vc(n)}}function Go(e=""){let t=2166136261,n=16777619;for(let o=0;o<e.length;o+=1){let i=e.charCodeAt(o);t^=i,t=t*16777619>>>0,n^=i<<o%8,n=n*16777619>>>0}let r=new Uint8Array(32);for(let o=0;o<32;o+=1){let i=o<16?t:n;r[o]=i>>>o%4*8&255}return r}function Nc(e){let t=new Uint8Array(e);for(let n=0;n<e;n+=1)t[n]=Math.floor(Math.random()*256);return t}async function of(e,t=""){if(!e)throw new Error("Missing encryption key");let n=e&&e.raw?e.raw:Go("fallback-key"),r=Nc(12),i=new TextEncoder().encode(t||""),s=new Uint8Array(r.length+i.length);s.set(r,0);for(let a=0;a<i.length;a+=1){let c=n[a%n.length],l=r[a%r.length];s[r.length+a]=i[a]^c^l}return`${ps}${vc(s)}`}async function hs(e,t){if(!e)throw new Error("Missing encryption key");if(!ms(t))throw new Error("Data is not in encrypted format");let n=t.slice(ps.length),r=Tc(n);if(r.length<13)throw new Error("Encrypted payload is too short");let o=r.slice(0,12),i=r.slice(12),s=e&&e.raw?e.raw:Go("fallback-key"),a=new Uint8Array(i.length);for(let l=0;l<i.length;l+=1){let d=s[l%s.length],m=o[l%o.length];a[l]=i[l]^d^m}return new TextDecoder().decode(a)}async function Mc(e,t){if(!t)return!1;try{return await hs(e,t)===rf}catch{return!1}}async function Lc(e,t){if(!e)return;if(typeof e.text=="string"&&ms(e.text))try{e.text=await hs(t,e.text)}catch{e.text=""}let n=Array.isArray(e.children)?e.children:[];for(let r of n)await Lc(r,t)}async function gs(e,t){if(!(!e||!Array.isArray(e.blocks)))for(let n of e.blocks)await Lc(n,t)}async function ys(e,t){return of(e,t||"")}var ps,rf,fo=Ge(()=>{ps="enc-v1:",rf="memus-article-encryption-ok"});function bn(e){if(window.location.pathname===e){Pc(e);return}window.history.pushState({},"",e),Pc(e)}function Pc(e){let t=e.match(/^\/p\/([^/?#]+)/);if(t){Ss(decodeURIComponent(t[1]));return}let n=e.match(/^\/article\/([0-9a-zA-Z-]+)/);if(n){let r=String(n[1]||"");if(r.startsWith("inbox-")){try{window.history.replaceState({},"",rn.article("inbox"))}catch{}Xo("inbox");return}Xo(r);return}bs()}var rn,nr=Ge(()=>{gr();rn={list:"/",article:e=>`/article/${e}`,public:e=>`/p/${e}`}});var _c=Ge(()=>{Qn();Cn()});function Dc(){j.searchResults&&j.searchResults.classList.add("hidden")}var Oc=Ge(()=>{Bt();In();_n();ln();nr();rr();en();_c()});function Qo(){try{localStorage.setItem(af,JSON.stringify(u.sidebarCollapsedArticleIds||[]))}catch{}}function Zo(){try{localStorage.setItem(cf,JSON.stringify(u.listCollapsedArticleIds||[]))}catch{}}var af,cf,Hr=Ge(()=>{Bt();af="ttree_collapsed_articles",cf="ttree_list_collapsed_articles"});function ws(){j.articlesTabBtn&&(j.articlesTabBtn.classList.toggle("active",!u.isTrashView),j.articlesTabBtn.setAttribute("aria-pressed",u.isTrashView?"false":"true")),j.trashTabBtn&&(j.trashTabBtn.classList.toggle("active",u.isTrashView),j.trashTabBtn.setAttribute("aria-pressed",u.isTrashView?"true":"false")),j.createArticleBtn&&(j.createArticleBtn.disabled=u.isTrashView),j.sidebarNewArticleBtn&&(j.sidebarNewArticleBtn.disabled=u.isTrashView)}function ei(){qi&&(La(!1),j.hintPopover&&j.hintPopover.classList.add("hidden"),j.hintToggleBtn&&j.hintToggleBtn.setAttribute("aria-expanded","false"))}function po(e){u.isSidebarMobileOpen=e,j.sidebar&&j.sidebar.classList.toggle("mobile-open",e),j.sidebarBackdrop&&j.sidebarBackdrop.classList.toggle("hidden",!e),e&&(ei(),Dc())}function mo(e){j.articleView.classList.toggle("hidden",!e),j.articleListView.classList.toggle("hidden",e),j.articleHeader&&j.articleHeader.classList.toggle("hidden",!e),e||ei(),e&&u.isTrashView&&(u.isTrashView=!1,ws())}var ti=Ge(()=>{Bt();In();Oc();Hr()});function zc({renderSidebarArticleList:e,renderMainArticleList:t,setArticlesIndex:n}={}){$c=typeof e=="function"?e:null,xs=typeof t=="function"?t:null,Fc=typeof n=="function"?n:null}function ri(){Dn&&(Dn.classList.remove("drop-before","drop-after","drop-inside"),Dn=null)}function Uc(e,t){e&&(Dn&&Dn!==e&&Dn.classList.remove("drop-before","drop-after","drop-inside"),Dn=e,Dn.classList.remove("drop-before","drop-after","drop-inside"),t==="before"?Dn.classList.add("drop-before"):t==="after"?Dn.classList.add("drop-after"):t==="inside"&&Dn.classList.add("drop-inside"))}function uf(){xt&&(xt.sourceEl instanceof Element&&xt.sourceEl.classList.remove("article-dnd-source"),typeof document<"u"&&document.body&&document.body.classList.remove("article-dnd-active"),window.removeEventListener("pointermove",ks),window.removeEventListener("pointerup",ho),window.removeEventListener("pointercancel",ho),window.removeEventListener("touchmove",qc),window.removeEventListener("touchend",ni),window.removeEventListener("touchcancel",ni),xt=null,ri(),window.__ttreeDraggingArticleId=null)}function Rc(e){return e instanceof Element?!!(e.closest(".star-btn")||e.closest(".row-actions")):!1}function ff(e,t){if(!t||xt||!e.touches||e.touches.length!==1)return;let n=e.touches[0],r=e.currentTarget instanceof Element?e.currentTarget:null;xt={pointerId:"legacy-touch",articleId:t,startX:n.clientX,startY:n.clientY,dragging:!1,lastTargetId:null,lastDropMode:null,sourceEl:r},window.__ttreeDraggingArticleId=t,typeof document<"u"&&document.body&&document.body.classList.add("article-dnd-active");try{let o=window.getSelection?window.getSelection():null;o&&!o.isCollapsed&&o.removeAllRanges()}catch{}window.addEventListener("touchmove",qc,{passive:!1}),window.addEventListener("touchend",ni),window.addEventListener("touchcancel",ni)}function qc(e){if(!xt||!e.touches||e.touches.length===0)return;let t=e.touches[0];ks({pointerId:"legacy-touch",clientX:t.clientX,clientY:t.clientY,preventDefault:()=>{e.preventDefault()}})}function ni(){xt&&ho({pointerId:"legacy-touch"})}function pf(e,t){let n=document.elementFromPoint(e,t);if(!n)return null;let r=n.closest(".sidebar-article-item, #articleList li");return!r||!r.dataset||!r.dataset.articleId?null:r}function mf(e,t){if(!t||xt)return;let n=e.currentTarget instanceof Element?e.currentTarget:null;xt={pointerId:e.pointerId,articleId:t,startX:e.clientX,startY:e.clientY,dragging:!1,lastTargetId:null,lastDropMode:null,sourceEl:n},window.__ttreeDraggingArticleId=t,typeof document<"u"&&document.body&&document.body.classList.add("article-dnd-active");try{let r=window.getSelection?window.getSelection():null;r&&!r.isCollapsed&&r.removeAllRanges()}catch{}try{e.currentTarget?.setPointerCapture?.(e.pointerId)}catch{}window.addEventListener("pointermove",ks),window.addEventListener("pointerup",ho),window.addEventListener("pointercancel",ho)}function ks(e){if(!xt||e.pointerId!==xt.pointerId)return;let t=e.clientX-xt.startX,n=e.clientY-xt.startY;if(!xt.dragging){if(Math.hypot(t,n)<lf)return;xt.dragging=!0,xt.sourceEl instanceof Element&&xt.sourceEl.classList.add("article-dnd-source")}e.preventDefault();let r=pf(e.clientX,e.clientY);if(!r||!r.dataset||!r.dataset.articleId||r.dataset.articleId===xt.articleId){ri(),xt.lastTargetId=null,xt.lastDropMode=null;return}let o=r.getBoundingClientRect(),i=e.clientY-o.top,s=o.height/3,a;i<s?a="before":i>o.height-s?a="after":a="inside",xt.lastTargetId=r.dataset.articleId,xt.lastDropMode=a,Uc(r,a)}function ho(e){if(!xt||e.pointerId!==xt.pointerId)return;let t=xt;uf(),!(!t.dragging||!t.lastTargetId||!t.lastDropMode)&&t.lastTargetId!==t.articleId&&Kc(t.articleId,t.lastTargetId,t.lastDropMode)}function Es(e,t){e&&(df?e.addEventListener("pointerdown",n=>{if(n.pointerType!=="touch"||typeof n.button=="number"&&n.button!==0||Rc(n.target))return;let r=n.pointerId,o=350,i=!1,s=window.setTimeout(()=>{i=!0,mf(n,t)},o),a=c=>{c.pointerId===r&&(i||window.clearTimeout(s),window.removeEventListener("pointerup",a,!0),window.removeEventListener("pointercancel",a,!0))};window.addEventListener("pointerup",a,!0),window.addEventListener("pointercancel",a,!0)}):e.addEventListener("touchstart",n=>{if(!n.touches||n.touches.length!==1)return;let r=n.target;if(Rc(r))return;let o=350,i=!1,s=window.setTimeout(()=>{i=!0,ff(n,t)},o),a=()=>{i||window.clearTimeout(s),window.removeEventListener("touchend",a,!0),window.removeEventListener("touchcancel",a,!0)};window.addEventListener("touchend",a,!0),window.addEventListener("touchcancel",a,!0)},{passive:!1}))}function Is(e){return e&&(u.articlesIndex||[]).find(t=>t.id===e)||null}function Hc(e){let t=e||null;return(u.articlesIndex||[]).filter(n=>(n.parentId||null)===t).sort((n,r)=>n.position!==r.position?n.position-r.position:new Date(n.updatedAt||0)-new Date(r.updatedAt||0))}function hf(e,t,n,r){if(!e)return;let o=Is(e);if(!o)return;let i=t||null,s=o.parentId||null,c=Hc(s).filter(b=>b.id!==e),l;i===s?l=c:l=Hc(i);let d=l.filter(b=>b.id!==e),m=d.length;if(n&&r&&r!=="inside"){let b=d.findIndex(S=>S.id===n);b!==-1&&(m=r==="before"?b:b+1)}r==="inside"&&(m=d.length),m<0&&(m=0),m>d.length&&(m=d.length);let h=d.slice();h.splice(m,0,o),o.parentId=i,c.forEach((b,S)=>{b.position=S}),h.forEach((b,S)=>{b.parentId=i,b.position=S})}function Kc(e,t,n){if(!e||!t||!n)return;let r=Is(e),o=Is(t);if(!r||!o)return;let i=n==="inside"?o.id:o.parentId||null,s=n==="inside"?null:o.id;hf(e,i,s,n),$c?.(),xs?.(),(async()=>{try{await ls(e,{parentId:i,anchorId:s,placement:n})}catch(a){try{let c=await kn();Fc?.(c),xs?.()}catch{}Ie(a.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443")}})()}function gf(e){window.__ttreeDraggingArticleId?Sn=window.__ttreeDraggingArticleId:Sn=e.currentTarget?.dataset?.articleId||null,e.dataTransfer&&(e.dataTransfer.effectAllowed="move",Sn&&e.dataTransfer.setData("text/plain",Sn))}function yf(e){if(!Sn){let s=window.__ttreeDraggingArticleId,a=null;if(!s&&e?.dataTransfer)try{a=e.dataTransfer.getData("text/plain")||null}catch{a=null}Sn=s||a||null}if(!Sn||!e.currentTarget||!e.currentTarget.dataset.articleId)return;e.preventDefault(),e.dataTransfer&&(e.dataTransfer.dropEffect="move");let t=e.currentTarget,n=t.getBoundingClientRect(),r=e.clientY-n.top,o=n.height/3,i;r<o?i="before":r>n.height-o?i="after":i="inside",Uc(t,i)}function bf(e){if(!Sn){let a=window.__ttreeDraggingArticleId,c=null;if(!a&&e?.dataTransfer)try{c=e.dataTransfer.getData("text/plain")||null}catch{c=null}Sn=a||c||null}if(!Sn)return;let t=e.currentTarget,n=t?.dataset?.articleId||null;if(!n||n===Sn)return;e.preventDefault(),ri();let r=t.getBoundingClientRect(),o=e.clientY-r.top,i=r.height/3,s;o<i?s="before":o>r.height-i?s="after":s="inside",Kc(Sn,n,s),Sn=null}function Sf(){Sn=null,window.__ttreeDraggingArticleId=null,ri()}function Cs(e){e&&(e.draggable=!0,e.addEventListener("dragstart",gf),e.addEventListener("dragover",yf),e.addEventListener("drop",bf),e.addEventListener("dragend",Sf))}var $c,xs,Fc,As,Sn,Dn,lf,xt,df,vs=Ge(()=>{Bt();ln();en();$c=null,xs=null,Fc=null;As=!1;typeof window<"u"&&(window.matchMedia&&window.matchMedia("(pointer: coarse)").matches||"ontouchstart"in window)&&(As=!0);Sn=null,Dn=null,lf=6,xt=null,df=typeof window<"u"&&"PointerEvent"in window&&!As});function Vc(){try{if(u.sidebarSearchView!=="list"||!j.searchInput||!!!((j.searchInput.value||"").trim()||(u.articleFilterQuery||"").trim()))return;j.searchInput.value="",u.articleFilterQuery="",j.searchInput.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}}function wf(){try{let e=localStorage.getItem(Jc),t=e?JSON.parse(e):[];u.favoriteArticles=Array.isArray(t)?t:[]}catch{u.favoriteArticles=[]}}function xf(){try{localStorage.setItem(Jc,JSON.stringify(u.favoriteArticles||[]))}catch{}}function Wc(e=[]){let t=new Set(u.favoriteArticles||[]);return[...e].sort((n,r)=>{let o=t.has(n.id),i=t.has(r.id);return o!==i?o?-1:1:new Date(r.updatedAt||r.deletedAt||0)-new Date(n.updatedAt||n.deletedAt||0)})}function oi(e){if(!e)return;u.favoriteArticles||(u.favoriteArticles=[]);let t=new Set(u.favoriteArticles);t.has(e)?t.delete(e):t.add(e),u.favoriteArticles=Array.from(t),xf(),Ut(),Tn()}function ii(e=[]){(!u.favoriteArticles||!u.favoriteArticles.length)&&wf();let t=Array.isArray(e)?e:[];u.articlesIndex=t.map(r=>({id:r.id,title:r.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",updatedAt:r.updatedAt||new Date().toISOString(),deletedAt:r.deletedAt||null,publicSlug:r.publicSlug||null,parentId:r.parentId||null,position:typeof r.position=="number"?r.position:0}));let n=new Set(u.articlesIndex.map(r=>r.id));Array.isArray(u.sidebarCollapsedArticleIds)&&u.sidebarCollapsedArticleIds.length&&(u.sidebarCollapsedArticleIds=u.sidebarCollapsedArticleIds.filter(r=>n.has(r)),Qo()),Array.isArray(u.listCollapsedArticleIds)&&u.listCollapsedArticleIds.length&&(u.listCollapsedArticleIds=u.listCollapsedArticleIds.filter(r=>n.has(r)),Zo()),Ut()}function Yc(e=[]){let t=Wc(Array.isArray(e)?e:[]);u.deletedArticlesIndex=t,Ut()}function $r(e){if(!e||!e.id||e.deletedAt)return;let t={id:e.id,title:e.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",updatedAt:e.updatedAt||new Date().toISOString(),publicSlug:e.publicSlug||null,parentId:e.parentId||null,position:typeof e.position=="number"?e.position:0},n=u.articlesIndex.findIndex(r=>r.id===t.id);n>=0?u.articlesIndex[n]={...u.articlesIndex[n],...t}:u.articlesIndex.unshift(t),Ut()}function Ts(e){if(!e)return;let t=u.articlesIndex.length;u.articlesIndex=u.articlesIndex.filter(n=>n.id!==e),t!==u.articlesIndex.length&&(Ut(),Tn())}function Bs(e){if(!e)return;let t=u.deletedArticlesIndex.length;u.deletedArticlesIndex=u.deletedArticlesIndex.filter(n=>n.id!==e),t!==u.deletedArticlesIndex.length&&(Ut(),Tn())}function Gc(e=[]){let t=new Map;e.forEach(o=>{t.set(o.id,{...o,children:[]})});let n=[];t.forEach(o=>{let i=o.parentId||null;i&&t.has(i)?t.get(i).children.push(o):n.push(o)});let r=o=>{o.sort((i,s)=>{let a=(u.favoriteArticles||[]).includes(i.id),c=(u.favoriteArticles||[]).includes(s.id);return a!==c?a?-1:1:i.position!==s.position?i.position-s.position:new Date(s.updatedAt||0)-new Date(i.updatedAt||0)}),o.forEach(i=>r(i.children||[]))};return r(n),n}function Ut(){if(!j.sidebarArticleList)return;j.sidebarArticleList.innerHTML="",j.backToList&&j.backToList.classList.toggle("active",u.sidebarArticlesMode!=="recent"),j.sidebarRecentBtn&&j.sidebarRecentBtn.classList.toggle("active",u.sidebarArticlesMode==="recent");let e=(u.articleFilterQuery||"").trim().toLowerCase(),t=u.sidebarArticlesMode==="recent"?"recent":"tree",n=u.isTrashView?u.deletedArticlesIndex:u.articlesIndex,r=new Set(u.favoriteArticles||[]),o=new Set(u.sidebarCollapsedArticleIds||[]),i=u.sidebarSelectedArticleId||u.articleId,s=Array.isArray(u.recentArticleIds)?u.recentArticleIds:[],a=[];if(!u.isTrashView&&(r.has("RAG")||t==="recent"&&s.includes("RAG"))){let p=(u.ragQuery||"").trim();a.push({id:"RAG",title:p?`AI: ${p}`:"AI: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B \u043F\u043E\u0438\u0441\u043A\u0430",updatedAt:new Date().toISOString(),deletedAt:null,publicSlug:null,parentId:null,position:0})}let l=new Set(a.map(p=>p.id)),d=a.length&&!u.isTrashView?[...(n||[]).filter(p=>!l.has(p.id)),...a]:n,m=new Set;(d||[]).forEach(p=>{let f=p.parentId||null;f&&m.add(f)});let h=(d||[]).filter(p=>(e?(p.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(e):!0)&&(u.isTrashView?!0:p.id!=="inbox"));if(!h.length){let p=document.createElement("li");p.className="sidebar-article-empty",p.textContent=u.isTrashView?e?"No deleted pages match the filter":"Trash is empty":e?"\u041D\u0435\u0442 \u0441\u043E\u0432\u043F\u0430\u0434\u0435\u043D\u0438\u0439":"\u041D\u0435\u0442 \u0441\u0442\u0430\u0442\u0435\u0439",j.sidebarArticleList.appendChild(p);return}if(t==="recent"){let p=new Map(h.map(C=>[C.id,C])),f=new Set(s),w=s.map(C=>p.get(C)).filter(Boolean),x=Wc(h.filter(C=>!f.has(C.id)));[...w,...x].forEach(C=>{let L=document.createElement("li");L.className="sidebar-article-item",L.dataset.articleId=C.id;let H=document.createElement("div");H.className="sidebar-article-row";let U=document.createElement("button");U.type="button",!u.isTrashView&&C.id===i&&U.classList.add("active");let F=r.has(C.id),X=Jt(C.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),G=C.publicSlug?'<i class="bx bx-link-external article-public-icon" aria-hidden="true"></i>':"",oe=F?"bxs-star":"bx-star";U.innerHTML=`<span class="sidebar-article-title">${G}${X}</span><span class="star-btn ${F?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${F?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}"><i class="bx ${oe}" aria-hidden="true"></i></span>`,U.addEventListener("click",()=>{window.__ttreeDraggingArticleId||(u.sidebarSelectedArticleId=C.id,Vc(),bn(rn.article(C.id)),u.isSidebarMobileOpen&&po(!1))});let we=U.querySelector(".star-btn");we&&we.addEventListener("click",Ce=>{Ce.stopPropagation(),oi(C.id)}),H.appendChild(U),L.appendChild(H),j.sidebarArticleList.appendChild(L)});return}let b=Gc(h),S=(p,f)=>{let w=document.createElement("li");w.className="sidebar-article-item",m.has(p.id)&&(w.classList.add("has-children"),o.has(p.id)&&w.classList.add("is-collapsed")),w.dataset.articleId=p.id,w.style.paddingLeft=`${f*1.25}rem`;let x=document.createElement("div");x.className="sidebar-article-row";let A=document.createElement("button");A.type="button",!u.isTrashView&&p.id===i&&A.classList.add("active");let C=r.has(p.id),L=Jt(p.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),H=p.publicSlug?'<i class="bx bx-link-external article-public-icon" aria-hidden="true"></i>':"",U=C?"bxs-star":"bx-star";A.innerHTML=`<span class="sidebar-article-title">${H}${L}</span><span class="star-btn ${C?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${C?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}"><i class="bx ${U}" aria-hidden="true"></i></span>`,A.addEventListener("click",()=>{if(window.__ttreeDraggingArticleId)return;u.sidebarSelectedArticleId=p.id,u.sidebarCollapsedArticleIds||(u.sidebarCollapsedArticleIds=[]);let X=new Set(u.sidebarCollapsedArticleIds);X.has(p.id)?X.delete(p.id):X.add(p.id),u.sidebarCollapsedArticleIds=Array.from(X),Qo(),Ut()}),A.addEventListener("dblclick",X=>{X.preventDefault(),X.stopPropagation(),u.sidebarSelectedArticleId=p.id,Vc(),bn(rn.article(p.id)),u.isSidebarMobileOpen&&po(!1)});let F=A.querySelector(".star-btn");F&&F.addEventListener("click",X=>{X.stopPropagation(),oi(p.id)}),x.appendChild(A),w.appendChild(x),u.isTrashView||(Cs(w),Es(w,p.id)),j.sidebarArticleList.appendChild(w),o.has(p.id)||(p.children||[]).forEach(X=>S(X,f+1))};b.forEach(p=>S(p,0))}function Tn(e=null){if(!j.articleList)return;j.articleList.innerHTML="";let t="",n=Array.isArray(e)&&e.length?e:u.isTrashView?u.deletedArticlesIndex:u.articlesIndex,r=new Set(u.favoriteArticles||[]),o=new Set(u.listCollapsedArticleIds||[]),i=u.listSelectedArticleId||u.articleId,s=new Set;if(n.forEach(d=>{let m=d.parentId||null;m&&s.add(m)}),!n.length){let d=document.createElement("li");d.textContent=u.isTrashView?t?"No deleted pages match the filter":"Trash is empty":t?"\u041D\u0438\u0447\u0435\u0433\u043E \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u043E":"\u0421\u043F\u0438\u0441\u043E\u043A \u043F\u0443\u0441\u0442.",j.articleList.appendChild(d);return}if(u.isTrashView){n.slice().filter(d=>(t?(d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(t):!0)&&(u.isTrashView?!0:d.id!=="inbox")).forEach(d=>{let m=document.createElement("li");m.dataset.articleId=d.id,m.innerHTML=`
      <span>
        <strong>${Jt(d.title)}</strong>
      </span>
      <div class="row-actions">
        <button class="ghost restore-btn" data-id="${d.id}">\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C</button>
        <button class="ghost danger delete-btn" data-id="${d.id}">\u0423\u0434\u0430\u043B\u0438\u0442\u044C</button>
      </div>
    `;let h=m.querySelector(".restore-btn"),b=m.querySelector(".delete-btn");h&&h.addEventListener("click",async S=>{S.preventDefault(),S.stopPropagation(),await Af(d.id)}),b&&b.addEventListener("click",async S=>{S.preventDefault(),S.stopPropagation(),await If(d.id)}),j.articleList.appendChild(m)});return}let a=n.slice().filter(d=>(t?(d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F").toLowerCase().includes(t):!0)&&d.id!=="inbox"),c=Gc(a),l=(d,m)=>{let h=document.createElement("li");s.has(d.id)&&(h.classList.add("has-children"),o.has(d.id)&&h.classList.add("is-collapsed")),h.dataset.articleId=d.id;let b=r.has(d.id),S=Jt(d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"),p=d.publicSlug?'<i class="bx bx-link-external article-public-icon" aria-hidden="true"></i>':"",f=b?"bxs-star":"bx-star";h.style.paddingLeft=`${m*1.25}rem`,h.innerHTML=`
      <span>
        <strong>${p}${S}</strong>
      </span>
      <button class="ghost star-btn ${b?"active":""}" aria-label="\u0418\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435" title="${b?"\u0423\u0431\u0440\u0430\u0442\u044C \u0438\u0437 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0433\u043E":"\u0412 \u0438\u0437\u0431\u0440\u0430\u043D\u043D\u043E\u0435"}"><i class="bx ${f}" aria-hidden="true"></i></button>
    `;let w=h.querySelector(".star-btn");w&&w.addEventListener("click",x=>{x.preventDefault(),x.stopPropagation(),oi(d.id)}),d.id===i&&h.classList.add("active-article"),h.addEventListener("click",()=>{if(window.__ttreeDraggingArticleId)return;u.listSelectedArticleId=d.id,u.listCollapsedArticleIds||(u.listCollapsedArticleIds=[]);let x=new Set(u.listCollapsedArticleIds);x.has(d.id)?x.delete(d.id):x.add(d.id),u.listCollapsedArticleIds=Array.from(x),Zo(),Tn()}),h.addEventListener("dblclick",x=>{x.preventDefault(),x.stopPropagation(),u.listSelectedArticleId=d.id,bn(rn.article(d.id))}),j.articleList.appendChild(h),u.isTrashView||(Cs(h),Es(h,d.id)),o.has(d.id)||(d.children||[]).forEach(x=>l(x,m+1))};c.forEach(d=>l(d,0))}async function Af(e){if(e)try{let t=await Sc(e);Bs(e),$r(t),await Xc(!1),bn(rn.article(t.id)),Ie("Page restored")}catch(t){Ie(t.message)}}async function If(e){if(e)try{await bc(e,{force:!0}),Bs(e),Ie("\u0421\u0442\u0430\u0442\u044C\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u0431\u0435\u0437\u0432\u043E\u0437\u0432\u0440\u0430\u0442\u043D\u043E"),Tn(),Ut()}catch(t){Ie(t.message)}}async function Xc(e){u.isTrashView=e,ws(),e?await si():await go(),Ut(),Tn()}async function go(){if(u.articlesIndex.length)return u.isTrashView||Ut(),u.articlesIndex;let e=await kn();return ii(e),e}async function si(){if(u.deletedArticlesIndex.length)return u.isTrashView&&Ut(),u.deletedArticlesIndex;let e=await mc();return Yc(e),e}var Jc,ai=Ge(()=>{Bt();In();_n();nr();ln();en();ti();Hr();vs();Jc="ttree_favorites"});function Cf(){try{let e=Array.isArray(u.recentArticleIds)?u.recentArticleIds:[];window.localStorage.setItem(Ef,JSON.stringify(e.slice(0,Qc)))}catch{}}function ci(e){if(!e||e==="inbox"||u.isPublicView)return;let t=Array.isArray(u.recentArticleIds)?u.recentArticleIds:[],n=[e,...t.filter(r=>r!==e)];u.recentArticleIds=n.slice(0,Qc),Cf(),u.sidebarArticlesMode==="recent"&&Ut()}var Ef,Qc,Ns=Ge(()=>{Bt();ai();Hr();Ef="ttree_recent_articles",Qc=300});var rr=Ge(()=>{In();Bt();Ns();Hr();ti();vs();ai();Hr();Ns();ti();ai();zc({renderSidebarArticleList:Ut,renderMainArticleList:Tn,setArticlesIndex:ii})});function Tf(e){u.articleId&&(u.articleEncryptionKeys||(u.articleEncryptionKeys={}),e?u.articleEncryptionKeys[u.articleId]=e:delete u.articleEncryptionKeys[u.articleId])}async function Zc(e){if(!e||!e.encrypted)return e;let t=u.articleEncryptionKeys?.[e.id]||null;if(t)return await gs(e,t),e;let n=0;for(;;){n+=1;let r=null;try{let o=e.encryptionHint||"",i="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C \u0434\u043B\u044F \u044D\u0442\u043E\u0439 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u044B.",s=o?`${i}
\u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0430: ${o}`:i;r=await er({title:"\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430",message:s,confirmText:"\u041E\u0442\u043A\u0440\u044B\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",placeholder:"\u041F\u0430\u0440\u043E\u043B\u044C",inputType:"password"})}catch{r=window.prompt("\u0421\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u0430. \u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043F\u0430\u0440\u043E\u043B\u044C:")||""}if(!r)throw new Error("\u041F\u0430\u0440\u043E\u043B\u044C \u043D\u0435 \u0432\u0432\u0435\u0434\u0451\u043D");try{let{key:o}=await Bc(r,e.encryptionSalt||"");if(!await Mc(o,e.encryptionVerifier||"")){if(n>=3)throw new Error("\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C");window.alert("\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u043F\u0430\u0440\u043E\u043B\u044C, \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437.");continue}return await gs(e,o),Tf(o),e}catch(o){if(n>=3)throw new Error(o.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");window.alert("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0441\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443, \u043F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437.")}}}var Ms=Ge(()=>{Bt();ln();en();tr();_n();fo();rr();lo()});function Nf(e,t){if(!t.length)return;let n=document.createElement("div");n.className="diff-images",t.forEach(r=>{let o=document.createElement("div");o.className=`diff-image-card diff-image-card--${r.type}`;let i=document.createElement("div");i.className="diff-image-card__label",i.textContent=r.type==="added"?"\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E":"\u0423\u0434\u0430\u043B\u0435\u043D\u043E";let s=document.createElement("img");s.src=r.src,s.alt=r.alt||"",o.append(i,s),n.appendChild(o)}),e.appendChild(n)}function Mf(e,t,n,r=[]){let o=document.createElement("div");o.className="diff-inline";let i=document.createElement("div");i.className="diff-inline__content",n.forEach(a=>{let c=document.createElement("span");a.type==="added"?c.className="diff-inline__segment diff-inline__segment--added":a.type==="removed"&&(c.className="diff-inline__segment diff-inline__segment--removed"),c.textContent=a.value,i.appendChild(c)}),Nf(i,r);let s=document.createElement("div");s.className="diff-inline__hint",s.textContent=t==="undo"?"\u041F\u043E\u0432\u0442\u043E\u0440\u043D\u043E \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Ctrl+Z, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C \u043E\u0442\u043C\u0435\u043D\u0443":"\u041F\u043E\u0432\u0442\u043E\u0440\u043D\u043E \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Ctrl+Y, \u0447\u0442\u043E\u0431\u044B \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C \u043F\u043E\u0432\u0442\u043E\u0440",o.append(i,s),e.innerHTML="",e.appendChild(o)}function el(){let e=u.pendingTextPreview;if(!e)return;let t=document.querySelector(`.block[data-block-id="${e.blockId}"] .block-text`);t&&Mf(t,e.mode,e.chunks,e.imageDiff||[])}function tl(e){li({restoreDom:!1});let t=n=>({type:"text",blockId:n.blockId,historyEntryId:n.id});u.undoStack=(e.history||[]).map(t),u.redoStack=(e.redoHistory||[]).map(t)}function Fr(e){e&&(nn("pushUndoEntry",e),u.undoStack.push(e),u.redoStack=[])}function yo(e){try{return JSON.parse(JSON.stringify(e||{}))}catch{return null}}function Lf(e){if(!e||!u.article||!Array.isArray(u.article.blocks))return;let t=!1,n=r=>{if(Array.isArray(r))for(let o=0;o<r.length;o+=1){let i=r[o];if(i){if(i===e)if(!t)t=!0;else{r.splice(o,1),o-=1;continue}Array.isArray(i.children)&&i.children.length&&n(i.children)}}};n(u.article.blocks)}async function Pf(e){e&&(await Ls(e),or(e))}function li({restoreDom:e=!0}={}){let t=u.pendingTextPreview;if(t){if(e){let n=document.querySelector(`.block[data-block-id="${t.blockId}"] .block-text`);n&&(n.innerHTML=t.originalHTML)}u.pendingTextPreview=null}}async function nl(e,t=null,n=null,r={}){if(!e)return{success:!1};let{skipRecord:o=!1,anchorId:i=null,placement:s=null,suppressRerender:a=!1}=r,c=St(e);if(!c)return Ie("\u0411\u043B\u043E\u043A \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D"),{success:!1};let l=c.parent?.id||null,d=c.index??0,m=t?St(t)?.block:null,h=m?m.children?.length||0:(u.article?.blocks||[]).length,b=typeof n=="number"&&n>=0?Math.min(n,h):h;if(l===t&&d===b)return{success:!0,noOp:!0,from:{parentId:l,index:d},to:{parentId:t,index:b}};let S=b;t===l&&d<S&&(S=Math.max(S-1,0));try{let p=await Et(`/api/articles/${u.articleId}/blocks/${e}/relocate`,{method:"POST",body:JSON.stringify({parentId:t||null,index:S,anchorId:i||null,placement:s||null})});if(u.article&&Array.isArray(u.article.blocks)){let w=c.siblings||u.article.blocks,x=c.index??w.findIndex(H=>H.id===e),A=null;x>=0&&([A]=w.splice(x,1)),A||(A=c.block);let C;if(t){let H=St(t);H&&H.block?(Array.isArray(H.block.children)||(H.block.children=[]),C=H.block.children):C=u.article.blocks}else C=u.article.blocks;let L=typeof S=="number"&&S>=0?Math.min(S,C.length):C.length;if(C.splice(L,0,A),Lf(A),u.article.updatedAt)try{u.article.updatedAt=new Date().toISOString()}catch{}}u.currentBlockId=e;let f=p?.parentId??t??null;return a||(l&&f?(await dn(l),f!==l&&await dn(f)):l&&!f?qt():!l&&f?qt():qt()),o||Fr({type:"structure",action:{kind:"reorder",blockId:e,fromParentId:l,fromIndex:d,toParentId:p?.parentId??t??null,toIndex:p?.index??S}}),await Pf(e),{success:!0,from:{parentId:l,index:d},to:{parentId:p?.parentId??t??null,index:p?.index??S}}}catch(p){return Ie(p.message),{success:!1}}}var yr=Ge(()=>{Bt();ln();en();gr();gr();On();_n();fo()});function Rf(){try{return window?.localStorage?.getItem?.(Df)==="1"}catch{return!1}}function ol(){try{return window?.localStorage?.getItem?.(Of)==="1"}catch{return!1}}function zr(...e){try{if(!Rf())return;console.log("[article-load]",...e)}catch{}}function Hf(e){try{let t=e?.content;if(!Array.isArray(t))return null;for(let n of t)if(n?.type==="outlineSection"){let r=String(n?.attrs?.id||"");if(r)return r}return null}catch{return null}}async function Un(e,t={}){let{desiredBlockId:n,resetUndoStacks:r,editBlockId:o}=t,i=u.articleId!==e;if(zr("load.start",{id:e,switchingArticle:i,mode:u.mode,isOutlineEditing:u.isOutlineEditing}),i)try{let h=u.articleId,b=await Promise.resolve().then(()=>(ui(),di));try{let S=b?.getOutlineActiveSectionSnapshot?.()||null;if(h&&S?.sectionId){let p=window?.localStorage?.getItem?.(rl)||"{}",f=JSON.parse(p||"{}"),w=f&&typeof f=="object"?f:{};w[String(h)]={sectionId:S.sectionId,collapsed:!!S.collapsed,savedAt:new Date().toISOString()},window?.localStorage?.setItem?.(rl,JSON.stringify(w))}}catch{}b?.flushOutlineAutosave&&await b.flushOutlineAutosave({mode:"queue"}),b?.closeOutlineEditor&&b.closeOutlineEditor()}catch{}u.articleId=e,u.isEditingTitle=!1,u.pendingTextPreview=null,u.article=null,u.currentBlockId=null;let s=performance.now(),a=await hc(e);ol()&&console.log("[perf][article-load] fetchArticle",{id:e,ms:Math.round(performance.now()-s)}),zr("load.fetched",{id:e,ms:Math.round(performance.now()-s),hasDocJson:!!a?.docJson,docContent:Array.isArray(a?.docJson?.content)?a.docJson.content.length:null,blocksCount:Array.isArray(a?.blocks)?a.blocks.length:null,updatedAt:a?.updatedAt});let c=a;try{c=await Zc(a)}catch(h){throw Ie(h.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u0443\u044E \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443"),h}u.article=c,(typeof r=="boolean"?r:i)&&tl(c);let d=n||o||u.pendingEditBlockId||null;u.pendingEditBlockId=null;let m=Hf(c.docJson)||c.blocks?.[0]?.id||null;if(u.currentBlockId=d||m,u.mode="view",u.editingBlockId=null,$r(c),xc(),!u.isPublicView&&!u.isRagView&&!c.encrypted)try{let h=await Promise.resolve().then(()=>(ui(),di));if(h?.openOutlineEditor){zr("outline.open.start",{id:e});let b=ol()?performance.now():0;h.openOutlineEditor(),b&&console.log("[perf][article-load] outline.open scheduled",{id:e,ms:Math.round(performance.now()-b)}),zr("outline.open.scheduled",{id:e,isOutlineEditing:u.isOutlineEditing})}}catch(h){u.isOutlineEditing=!1,zr("outline.open.failed",{id:e,message:h?.message||String(h||"error")}),Ie("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C outline-\u0440\u0435\u0436\u0438\u043C (\u0441\u043C. \u043A\u043E\u043D\u0441\u043E\u043B\u044C)")}return zr("load.done",{id:e,currentBlockId:u.currentBlockId}),c}var Df,Of,rl,Ps=Ge(()=>{Bt();ln();yr();en();rr();Ms();lo();Df="ttree_debug_article_load_v1",Of="ttree_profile_v1",rl="ttree_outline_last_active_v1"});var il=Ge(()=>{_n();On()});function $f(e){if(!e)return;e.focus({preventScroll:!0});let t=window.getSelection&&window.getSelection();if(!t)return;t.removeAllRanges();let n=document.createRange();n.selectNodeContents(e),n.collapse(!1),t.addRange(n)}async function _s(e){return!u.article||!u.article.encrypted||!u.articleEncryptionKey?e:ys(u.articleEncryptionKey,e)}async function al(){if(!u.currentBlockId||u.isRagView)return;let e=u.currentBlockId;u.editingScrollTop=j.blocksContainer?j.blocksContainer.scrollTop:null,u.mode="edit",u.scrollTargetBlockId=null,u.editingBlockId=u.currentBlockId,u.editingInitialText=St(u.currentBlockId)?.block.text||"",u.editingUndo=null,await dn(e);let t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`);if(t||(qt(),await dn(e),t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`)),!t){u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.editingUndo=null,u.currentBlockId=e,Ie("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430");return}$f(t)}async function cl(){if(u.mode!=="edit"||!u.editingBlockId)return;let e=u.editingBlockId,t=St(e),n=t?.block.text||"",o=document.querySelector(`.block[data-block-id="${u.editingBlockId}"] .block-text`)?.innerHTML||"",{cleanupEditableHtml:i}=await Promise.resolve().then(()=>(On(),Hs)),s=i(o);if(!(s||"").trim()){let c=pi(e),l=St(e),d=!!(l?.block&&l.block.__isNew);if(l&&u.article&&Array.isArray(u.article.blocks)){let m=l.siblings||u.article.blocks,h=l.index??m.findIndex(b=>b&&b.id===e);if(h>=0&&m.splice(h,1),u.article.updatedAt)try{u.article.updatedAt=new Date().toISOString()}catch{}if(!d){let b=yo(l.block);Os(b,l.parent?.id||null,l.index??null)}}u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.currentBlockId=c,u.scrollTargetBlockId=c,fi(e),qt(),(async()=>{try{let m=d?`/api/articles/${u.articleId}/blocks/${e}/permanent`:`/api/articles/${u.articleId}/blocks/${e}`,h=await Et(m,{method:"DELETE"});if(!d&&h?.block){let b=yo(h.block);Fr({type:"structure",action:{kind:"delete",parentId:h.parentId||null,index:h.index??null,block:b,blockId:b?.id,fallbackId:c}})}Ie("\u041F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A \u0443\u0434\u0430\u043B\u0451\u043D")}catch(m){Ie(m.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Un(u.articleId,{desiredBlockId:c||null}),qt()}catch{}}})();return}if(s===n){u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.editingUndo=null,u.pendingEditBlockId=null,u.currentBlockId=e,u.scrollTargetBlockId=e,await dn(e);return}if(t&&u.article&&Array.isArray(u.article.blocks)&&(t.block.text=s,u.article.updatedAt))try{u.article.updatedAt=new Date().toISOString()}catch{}u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.editingUndo=null,u.pendingEditBlockId=null,u.currentBlockId=e,u.scrollTargetBlockId=e,await dn(e),(async()=>{try{let c=await _s(s),l=await Et(`/api/articles/${u.articleId}/blocks/${e}`,{method:"PATCH",body:JSON.stringify({text:c})});n!==s&&(!!(t?.block&&t.block.__isNew)?delete t.block.__isNew:Fr({type:"text",blockId:e,historyEntryId:l?.historyEntryId||null})),Ie("\u0411\u043B\u043E\u043A \u043E\u0431\u043D\u043E\u0432\u043B\u0451\u043D")}catch(c){Ie(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Un(u.articleId,{desiredBlockId:e}),qt()}catch{}}})()}async function ll(){if(u.mode!=="edit"||!u.editingBlockId)return;let e=u.editingBlockId,r=!(document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`)?.textContent||"").replace(/\u00a0/g," ").trim();if(u.mode="view",u.editingBlockId=null,u.editingInitialText="",u.editingUndo=null,r){let o=pi(e),i=St(e),s=!!(i?.block&&i.block.__isNew);if(i&&u.article&&Array.isArray(u.article.blocks)){let c=i.siblings||u.article.blocks,l=i.index??c.findIndex(d=>d&&d.id===e);if(l>=0&&c.splice(l,1),u.article.updatedAt)try{u.article.updatedAt=new Date().toISOString()}catch{}}u.currentBlockId=o,u.scrollTargetBlockId=o,fi(e);let a=i?.parent?.id||null;a?await dn(a):qt(),(async()=>{try{let c=s?`/api/articles/${u.articleId}/blocks/${e}/permanent`:`/api/articles/${u.articleId}/blocks/${e}`,l=await Et(c,{method:"DELETE"});if(!s&&l?.block){let d=yo(l.block);Fr({type:"structure",action:{kind:"delete",parentId:l.parentId||null,index:l.index??null,block:d,blockId:d?.id,fallbackId:o}})}}catch(c){Ie(c.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0443\u0441\u0442\u043E\u0439 \u0431\u043B\u043E\u043A, \u043E\u0431\u043D\u043E\u0432\u043B\u044F\u0435\u043C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443");try{await Un(u.articleId,{desiredBlockId:o||null}),qt()}catch{}}})();return}u.currentBlockId=e,await dn(e)}async function dl(){if(u.mode!=="edit"||!u.editingBlockId)return;let e=u.editingBlockId,t=document.querySelector(`.block[data-block-id="${e}"] .block-text[contenteditable="true"]`);if(!t)return;let n=window.getSelection();if(!n||n.rangeCount===0||!t.contains(n.anchorNode))return;let r=n.getRangeAt(0).cloneRange(),o=document.createElement("span"),i=`split-marker-${Date.now()}-${Math.random().toString(16).slice(2)}`;o.setAttribute("data-split-marker",i),o.textContent="",r.insertNode(o);let s=t.innerHTML;o.parentNode.removeChild(o);let a=`<span data-split-marker="${i}"></span>`,c=s.split(a);if(c.length!==2)return;let[l,d]=c,{cleanupEditableHtml:m}=await Promise.resolve().then(()=>(On(),Hs)),h=m(l||""),b=m(d||"");if(!(!b||b===h))try{let S=St(e),p=S?.block,f=p?yo(p):null,w=await _s(h);await Et(`/api/articles/${u.articleId}/blocks/${e}`,{method:"PATCH",body:JSON.stringify({text:w})});let A=(await Et(`/api/articles/${u.articleId}/blocks/${e}/siblings`,{method:"POST",body:JSON.stringify({direction:"after"})}))?.block?.id;if(!A){Ie("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u043D\u043E\u0432\u044B\u0439 \u0431\u043B\u043E\u043A");return}let C=await _s(b);if(await Et(`/api/articles/${u.articleId}/blocks/${A}`,{method:"PATCH",body:JSON.stringify({text:C})}),S&&u.article&&Array.isArray(u.article.blocks)){S.block.text=h;let H=S.parent,U=S.siblings||u.article.blocks||[],F=(S.index??0)+1,X={id:A,text:b,children:[],collapsed:!1};if(U.splice(F,0,X),u.article.updatedAt)try{u.article.updatedAt=new Date().toISOString()}catch{}}u.mode="edit",u.editingBlockId=A,u.pendingEditBlockId=null,u.currentBlockId=A,u.scrollTargetBlockId=A,u.editingCaretPosition="start";let L=S?.parent?.id||null;L?await dn(L):qt(),f&&Fr({type:"text",blockId:e,block:f})}catch(S){Ie(S.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0437\u0431\u0438\u0442\u044C \u0431\u043B\u043E\u043A")}}var Ds=Ge(()=>{Bt();ln();In();en();gr();gr();yr();On();il();_n();fo()});function hl(){if(!Mt||!So()||Mt.pointerType==="mouse")return;let e=window.getSelection?window.getSelection():null;if(!(!e||e.isCollapsed))try{e.removeAllRanges()}catch{}}function Kf(){mi||(document.addEventListener("selectionchange",hl),mi=!0)}function Vf(){mi&&(document.removeEventListener("selectionchange",hl),mi=!1)}function So(){return!!(u.isDragModeEnabled&&u.mode==="view"&&u.articleId!=="inbox")}function gl(e){return e instanceof Element?!!e.closest(qf):!1}function yl(){if(Mt){window.removeEventListener("pointermove",Al),window.removeEventListener("pointerup",hi),window.removeEventListener("pointercancel",hi);try{Mt.sourceEl?.releasePointerCapture?.(Mt.pointerId)}catch{}Mt=null,Vf(),Wf()}}function jf(e,t,n,{bypassInteractiveCheck:r=!1}={}){if(!u.article||!u.isDragModeEnabled||!So()||e.pointerType==="mouse"&&e.button!==0||!r&&gl(e.target))return;let o=St(t);if(o){Mt={pointerType:e.pointerType||"mouse",blockId:t,pointerId:e.pointerId,originParentId:o.parent?.id||null,originIndex:o.index??0,startX:e.clientX,startY:e.clientY,dragging:!1,forbidden:Sl(o.block),lastDrop:null,sourceEl:n};try{n?.setPointerCapture?.(e.pointerId)}catch{}window.addEventListener("pointermove",Al),window.addEventListener("pointerup",hi),window.addEventListener("pointercancel",hi),Kf()}}function bl(e,t,{allowInteractive:n=!1}={}){e&&e.addEventListener("pointerdown",r=>{if(!n&&gl(r.target))return;(r.pointerType==="touch"||r.pointerType==="pen")&&So()&&r.preventDefault(),jf(r,t,e,{bypassInteractiveCheck:n})})}function Ur(){let e=!!u.article,t=j.dragModeToggleBtn;if(t){t.disabled=!e,t.classList.toggle("active",!!u.isDragModeEnabled),t.setAttribute("aria-pressed",u.isDragModeEnabled?"true":"false");let o=u.isDragModeEnabled?"\u041F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435 \u0431\u043B\u043E\u043A \u0437\u0430 \u0435\u0433\u043E \u043F\u043E\u0432\u0435\u0440\u0445\u043D\u043E\u0441\u0442\u044C":"\u0412\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0440\u0435\u0436\u0438\u043C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u044F \u0431\u043B\u043E\u043A\u043E\u0432";e?u.articleId==="inbox"?o="\u041F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0432 \u0431\u044B\u0441\u0442\u0440\u044B\u0445 \u0437\u0430\u043C\u0435\u0442\u043A\u0430\u0445":u.mode!=="view"&&(o="\u041F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043C\u043E\u0436\u043D\u043E \u0442\u043E\u043B\u044C\u043A\u043E \u0432 \u0440\u0435\u0436\u0438\u043C\u0435 \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440\u0430"):o="\u041E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E, \u0447\u0442\u043E\u0431\u044B \u0443\u043F\u0440\u0430\u0432\u043B\u044F\u0442\u044C \u043F\u0435\u0440\u0435\u0442\u0430\u0441\u043A\u0438\u0432\u0430\u043D\u0438\u0435\u043C",t.title=o}let n=So();[j.articleView,j.blocksContainer].forEach(o=>{o&&o.classList.toggle("drag-mode-enabled",n)}),document.body.classList.toggle("drag-mode-enabled",n)}function Sl(e,t=new Set){return e&&(t.add(e.id),(e.children||[]).forEach(n=>Sl(n,t))),t}function Jf(){if(bo)return bo;let e=document.createElement("div");return e.className="block-drop-line hidden",document.body.appendChild(e),bo=e,e}function Wf(){bo&&bo.classList.add("hidden"),un&&(un.classList.remove("drop-inside-target"),un=null),br&&(br.remove(),br=null),document.body.classList.remove("block-dnd-active")}function Yf(e){br&&(br.style.left=`${e.clientX+12}px`,br.style.top=`${e.clientY+12}px`)}function Gf(e){let t=document.createElement("div");t.className="block-drag-preview";let n=j.blocksContainer?.querySelector(`.block[data-block-id="${e}"]`),r=n?.querySelector(".block-title")?.textContent?.trim(),o=n?.querySelector(".block-text")?.textContent?.trim();t.textContent=r||o||"\u0411\u043B\u043E\u043A",document.body.appendChild(t),br=t}function wl(){return Bn&&Bn.isConnected?(j.blocksContainer&&Bn.parentNode!==j.blocksContainer&&j.blocksContainer.appendChild(Bn),Bn):(Bn=document.createElement("div"),Bn.className="drag-layer",j.blocksContainer&&(j.blocksContainer.appendChild(Bn),ul||(j.blocksContainer.addEventListener("scroll",fl,{passive:!0}),window.addEventListener("resize",fl,{passive:!0}),ul=!0)),Bn)}function xl(){ml.clear(),Bn&&(Bn.innerHTML="")}function fl(){let e=j.blocksContainer;if(!e||!Bn)return;let t=e.getBoundingClientRect(),n=e.scrollTop;ml.forEach(({handle:r,blockEl:o})=>{let i=o.getBoundingClientRect(),s=o.querySelector(".block-header__left"),a=o.querySelector(".block-header"),c=o.querySelector(".collapse-btn"),l=s?.getBoundingClientRect(),d=a?.getBoundingClientRect(),m=c?.getBoundingClientRect(),h=(l&&l.height>0?l:null)||(d&&d.height>0?d:null)||(m&&m.height>0?m:null)||i,b=h.top-t.top+n+h.height/2;r.style.top=`${b}px`,r.style.right="8px"})}function Xf(e){let t=Jf();if(!e){t.classList.add("hidden"),un&&(un.classList.remove("drop-inside-target"),un=null);return}if(e.placement==="inside"){t.classList.add("hidden"),un&&un.dataset.blockId!==e.targetId&&un.classList.remove("drop-inside-target"),un=j.blocksContainer?.querySelector(`.block[data-block-id="${e.targetId}"]`)||null,un&&un.classList.add("drop-inside-target");return}un&&(un.classList.remove("drop-inside-target"),un=null),t.classList.remove("hidden");let n=e.placement==="before"?e.rect.top:e.rect.top+e.rect.height,r=Math.min(e.depth*pl,e.rect.width-32),o=e.rect.left+r,i=Math.max(e.rect.width-r,48);t.style.top=`${n}px`,t.style.left=`${o}px`,t.style.width=`${i}px`}function Qf(e,t){if(!j.blocksContainer||!Mt)return null;let r=Array.from(j.blocksContainer.querySelectorAll(".block")).filter(A=>{let C=A.dataset.blockId;return C&&!Mt.forbidden.has(C)});if(!r.length)return null;let o=null,i=1/0;if(r.forEach(A=>{let C=A.getBoundingClientRect(),L=C.top+C.height/2,H=Math.abs(t-L);H<i&&(i=H,o=A)}),!o)return null;let s=o.getBoundingClientRect(),a=s.height>0?(t-s.top)/s.height:.5,c=a<zf?"before":a>Uf?"after":"inside",l=o.dataset.blockId,d=St(l);if(!d)return null;let m=(d.ancestors||[]).length,h=c==="inside"?l:d.parent?.id||null;if(Mt.forbidden.has(h||""))return null;let b=l,S=h,p=c,f=s,w=c==="inside"?m+1:m,x=p==="after"?d.index+1:d.index;if(p!=="inside"&&d.parent){let A=d,C=s,L=s.left+pl;for(;A.parent;){let H=e<=L,U=t<=C.top||t>=C.bottom;if(!H&&!U)break;let F=St(A.parent.id);if(!F)break;let G=j.blocksContainer?.querySelector(`.block[data-block-id="${F.block.id}"]`)?.getBoundingClientRect();A=F,C=G||C,b=A.block.id,f=C,w=(A.ancestors||[]).length,S=A.parent?.id||null,x=p==="after"?A.index+1:A.index}}return{targetId:b,placement:p,parentId:S,index:x,depth:w,rect:f}}function Zf(e){if(!j.blocksContainer)return;let t=j.blocksContainer.getBoundingClientRect(),n=60;e.clientY<t.top+n?j.blocksContainer.scrollTop-=12:e.clientY>t.bottom-n&&(j.blocksContainer.scrollTop+=12)}function Al(e){if(!Mt||e.pointerId!==Mt.pointerId)return;if(!So()){yl();return}let t=e.clientX-Mt.startX,n=e.clientY-Mt.startY;if(!Mt.dragging){if(Math.hypot(t,n)<Ff)return;Mt.dragging=!0;let o=Mt.pointerType||e.pointerType||"mouse";(o==="touch"||o==="pen")&&document.body.classList.add("block-dnd-active"),Gf(Mt.blockId)}e.preventDefault(),Yf(e);let r=Qf(e.clientX,e.clientY);Mt.lastDrop=r,Xf(r),Zf(e)}async function hi(e){if(!Mt||e.pointerId!==Mt.pointerId)return;let t=Mt;yl();let n=t.dragging&&t.lastDrop,r=t.lastDrop,o=t.blockId;!n||!r||await nl(o,r.parentId||null,r.index,{anchorId:r.targetId,placement:r.placement})}var Ff,pl,zf,Uf,qf,Mt,bo,un,br,Bn,ml,ul,mi,wo=Ge(()=>{Bt();In();On();yr();en();Ff=6,pl=20,zf=.35,Uf=.65,qf='button, a, input, textarea, select, [contenteditable="true"], .block-edit-actions, .move-block-btn, .collapse-btn',Mt=null,bo=null,un=null,br=null,Bn=null,ml=new Map,ul=!1,mi=!1});function Il(e){$s=typeof e=="function"?e:null}function ep(e){let t=new Set,n=r=>{if(Array.isArray(r))for(let o=0;o<r.length;o+=1){let i=r[o];if(!i||!i.id){r.splice(o,1),o-=1;continue}if(t.has(i.id)){r.splice(o,1),o-=1;continue}t.add(i.id),Array.isArray(i.children)&&i.children.length&&n(i.children)}};n(e)}function kl(){if(!j.blocksContainer)return;let e=new Set;j.blocksContainer.querySelectorAll(".block[data-block-id]").forEach(n=>{let r=n.getAttribute("data-block-id");if(r)if(e.has(r)){let o=n.parentNode;o&&o.removeChild(n)}else e.add(r)})}function El(){if(!j.blocksContainer||!u.article||!Array.isArray(u.article.blocks))return;let e=qn(u.article.blocks),t=new Set(e.map(r=>r.id));j.blocksContainer.querySelectorAll(".block[data-block-id]").forEach(r=>{let o=r.getAttribute("data-block-id");if(o&&!t.has(o)){let i=r.parentNode;i&&i.removeChild(r)}})}function Os(e,t,n,r){if(!u.article||!e||!e.id)return;let o=Array.isArray(u.article.blockTrash)?u.article.blockTrash:[],i=r||new Date().toISOString();o.push({id:e.id,block:e,parentId:t||null,index:typeof n=="number"?n:null,deletedAt:i}),u.article.blockTrash=o}function fi(e){if(!e||!j.blocksContainer)return;j.blocksContainer.querySelectorAll(`.block[data-block-id="${e}"]`).forEach(n=>{let r=n.parentElement;if(!r)return;let o=n.nextElementSibling;if(o&&o.classList.contains("block-children")){let i=o;o=o.nextElementSibling,i.parentNode===r&&r.removeChild(i)}n.parentNode===r&&r.removeChild(n)})}async function Fs(e,t,n=1){for(let r of e){let o=document.createElement("div");o.className="block",o.dataset.blockId=r.id,typeof r.collapsed=="boolean"&&(o.dataset.collapsed=r.collapsed?"true":"false"),(r.id===u.currentBlockId||Array.isArray(u.selectedBlockIds)&&u.selectedBlockIds.includes(r.id))&&o.classList.add("selected"),r.id===u.editingBlockId&&o.classList.add("editing");let s=document.createElement("div");s.className="block-surface";let a=document.createElement("div");a.className="block-content";let c=Kn(r.text||""),l=!!c.titleHtml,d=!!(c.bodyHtml&&c.bodyHtml.trim()),m=!!r.children?.length;if(!l&&m){let L=document.createElement("div");L.innerHTML=c.bodyHtml||r.text||"";let H=Array.from(L.childNodes||[]).filter(U=>U.nodeType===Node.TEXT_NODE?(U.textContent||"").trim().length>0:U.nodeType===Node.ELEMENT_NODE?U.tagName==="BR"?!1:U.tagName==="P"?(U.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim().length>0:!0:!1);if(H.length===1){let U=H[0];U.nodeType===Node.ELEMENT_NODE&&U.tagName==="P"&&(c={titleHtml:U.outerHTML,bodyHtml:""},l=!0,d=!1)}}let h=l||m,b=!l&&!m;o.classList.toggle("block--no-title",!l);let S=u.mode==="edit"&&u.editingBlockId===r.id,p=null;if(h||b){let L=document.createElement("button");L.className="collapse-btn",b?(L.classList.add("collapse-btn--placeholder"),L.setAttribute("aria-hidden","true"),L.removeAttribute("aria-expanded"),L.removeAttribute("title")):(L.setAttribute("aria-expanded",r.collapsed?"false":"true"),L.title=r.collapsed?"\u0420\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C":"\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C"),p=document.createElement("div"),p.className="block-header",l||p.classList.add("block-header--no-title");let H=document.createElement("div");if(H.className="block-header__left",H.appendChild(L),l){let U=Math.min(Math.max(n,1),6),F=document.createElement(`h${U}`);F.className="block-title",F.innerHTML=c.titleHtml||"",H.appendChild(F)}else{let U=document.createElement("div");U.className="block-title-spacer",U.style.flex="1",U.style.minWidth="0",H.appendChild(U)}p.appendChild(H)}let f=document.createElement("div");f.className="block-text block-body";let w=S?Us(r.text||""):c.bodyHtml||"";if(f.innerHTML=w,(!w||!w.trim())&&(f.classList.add("block-body--empty"),S&&(f.innerHTML="<p><br /></p>")),f.classList.toggle("block-body--no-title",!l),S?(f.setAttribute("contenteditable","true"),f.setAttribute("spellcheck","false"),f.dataset.placeholder="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0442\u0435\u043A\u0441\u0442"):f.removeAttribute("contenteditable"),p&&a.appendChild(p),(S||!l||w)&&a.appendChild(f),u.articleId==="inbox"&&!S){let L=document.createElement("div");L.className="block-footer";let H=document.createElement("button");H.type="button",H.className="ghost small move-block-btn",H.innerHTML='<i class="bx bx-transfer-alt" aria-hidden="true"></i>',H.title="\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0431\u043B\u043E\u043A \u0432 \u0434\u0440\u0443\u0433\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E",H.addEventListener("click",U=>{U.stopPropagation(),$s?$s(r.id):Ie("\u041F\u0435\u0440\u0435\u043D\u043E\u0441 \u0431\u043B\u043E\u043A\u0430 \u0432\u0440\u0435\u043C\u0435\u043D\u043D\u043E \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D")}),L.appendChild(H),a.appendChild(L)}if(s.appendChild(a),S&&("ontouchstart"in window||navigator.maxTouchPoints>0)&&a.addEventListener("click",H=>{let U=a.querySelector('.block-text[contenteditable="true"]');U&&(U.contains(H.target)||(H.stopPropagation(),U.focus(),u.editingCaretPosition==="start"?(U.scrollTop=0,ds(U)):Yo(U)))}),bl(s,r.id),S){let L=document.createElement("div");L.className="block-edit-actions";let H=document.createElement("button");H.type="button",H.className="ghost small block-attach-btn",H.innerHTML='<i class="bx bx-paperclip block-attach-btn__icon" aria-hidden="true"></i><span class="block-attach-btn__label">\u0424\u0430\u0439\u043B</span>',H.title="\u041F\u0440\u0438\u043A\u0440\u0435\u043F\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u0438\u043B\u0438 \u043A\u0430\u0440\u0442\u0438\u043D\u043A\u0443",H.addEventListener("click",X=>{X.preventDefault(),X.stopPropagation();let G=o.querySelector('.block-text[contenteditable="true"]');if(!G)return;let oe=document.createElement("input");oe.type="file",oe.multiple=!0,oe.style.display="none",oe.addEventListener("change",()=>{let we=Array.from(oe.files||[]);we.length&&Ks(G,we,r.id),oe.remove()}),document.body.appendChild(oe),oe.click()});let U=document.createElement("button");U.type="button",U.className="ghost small",U.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C",U.addEventListener("click",async X=>{X.preventDefault(),X.stopPropagation(),await cl()});let F=document.createElement("button");F.type="button",F.className="ghost small",F.textContent="\u041E\u0442\u043C\u0435\u043D\u0430",F.addEventListener("click",X=>{X.preventDefault(),X.stopPropagation(),ll()}),L.appendChild(H),L.appendChild(U),L.appendChild(F),a.appendChild(L)}Vs(f,r.id),o.appendChild(s),o.addEventListener("click",L=>{if(L.stopPropagation(),u.isRagView&&u.ragBlockMap&&u.ragBlockMap[r.id]){let Ye=u.ragBlockMap[r.id];if(Ye&&Ye.articleId&&Ye.blockId){u.scrollTargetBlockId=Ye.blockId,u.currentBlockId=Ye.blockId,bn(rn.article(Ye.articleId));return}}let H=L.target.closest('button, a, [contenteditable="true"], .block-edit-actions'),U=o.querySelector(".block-header"),F=o.querySelector(".block-text.block-body"),X=!!U,G=!!(U&&!U.classList.contains("block-header--no-title")),oe=X&&U.contains(L.target),we=F&&F.contains(L.target),Ce=G,ne=u.currentBlockId===r.id,ye=!1;(Ce&&oe||!Ce&&ne&&we&&!H)&&(ye=!0),ye&&qs(r.id),or(r.id)}),s.addEventListener("dblclick",L=>{if(u.mode!=="view"||u.isPublicView||u.isRagView)return;let H=L.target.closest('button, a, [contenteditable="true"]');H&&!H.matches('.block-text[contenteditable="true"]')||(L.stopPropagation(),or(r.id),al())});let A=r.collapsed&&r.id!==u.editingBlockId&&l;f.classList.contains("block-body--empty")||f.classList.toggle("collapsed",A);let C=null;r.children?.length>0&&!r.collapsed&&(C=document.createElement("div"),C.className="block-children",await Fs(r.children,C,n+1)),t.appendChild(o),C&&(S?t.appendChild(C):o.appendChild(C))}}async function dn(e){if(!u.article||!Array.isArray(u.article.blocks))return;let t=St(e);if(!t)return;let n=(Array.isArray(t.ancestors)?t.ancestors.length:0)+1,r=document.querySelector(`.block[data-block-id="${e}"]`);if(!r)return;let o=r.parentElement;if(!o)return;let i=[],s=r.nextElementSibling;s&&s.classList.contains("block-children")&&i.push(s);let a=(i[i.length-1]||r).nextSibling;o.removeChild(r),i.forEach(d=>{d.parentNode===o&&o.removeChild(d)});let c=document.createElement("div");await Fs([t.block],c,n),Array.from(c.childNodes).forEach(d=>{o.insertBefore(d,a)}),kl(),El()}function qt(){let e=u.article;if(!e)return;if(!u.isPublicView&&!u.isRagView&&u.isOutlineEditing){Ut(),co();return}Array.isArray(e.blocks)&&ep(e.blocks),Ut();let t=e.id==="inbox"?[...e.blocks||[]].reverse():e.blocks;co(),j.blocksContainer.innerHTML="",Ur(),xl(),wl();let n=()=>{if(u.mode!=="edit"||!u.editingBlockId||u.editingCaretPosition==="start")return;let r=j.blocksContainer?.querySelector(`.block[data-block-id="${u.editingBlockId}"] .block-text[contenteditable="true"]`);if(!r)return;let o=document.activeElement;r===o||r.contains(o)||(r.focus({preventScroll:!0}),r.scrollHeight>r.clientHeight&&(r.scrollTop=r.scrollHeight),Yo(r))};Fs(t,j.blocksContainer).then(()=>{if(El(),kl(),el(),u.scrollTargetBlockId&&u.mode==="view"){let r=u.scrollTargetBlockId;requestAnimationFrame(()=>{let o=document.querySelector(`.block[data-block-id="${r}"]`);if(o){(o.querySelector(".block-content")||o).scrollIntoView({behavior:"smooth",block:"nearest"});let s=o.querySelector('.block-text[contenteditable="true"]');s&&u.mode==="edit"&&u.editingBlockId===r?(s.focus({preventScroll:!0}),u.editingCaretPosition==="start"?(s.scrollTop=0,ds(s)):Yo(s)):(o.setAttribute("tabindex","-1"),o.focus({preventScroll:!0}))}u.currentBlockId=r,u.scrollTargetBlockId=null})}n(),u.mode==="edit"&&typeof u.editingScrollTop=="number"&&j.blocksContainer&&(j.blocksContainer.scrollTop=u.editingScrollTop)})}var $s,zs=Ge(()=>{Bt();In();ln();en();tr();Ds();_n();On();On();rr();yr();nr();lo();wo();$s=null});function tp(){try{let e=window?.localStorage?.getItem?.(Cl)||"";if(!e)return[];let t=JSON.parse(e);return Array.isArray(t)?t.filter(Boolean):[]}catch{return[]}}function np(e){try{window?.localStorage?.setItem?.(Cl,JSON.stringify(Array.isArray(e)?e:[]))}catch{}}function vl(e){let t=String(e||"").trim();if(!t)return!1;let n=tp(),r=n.filter(o=>String(o?.sectionId||o?.id||"")!==t);return r.length===n.length?!1:(np(r),!0)}async function rp(){let e=await fetch("/api/articles/inbox?include_history=0",{method:"GET",credentials:"include"});if(e.status===401||e.status===403){let t=new Error("auth");throw t.status=e.status,t}if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()}async function Tl(){if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return{status:"offline"};let e=await rp(),t=new Date().toISOString();try{e?.docJson&&typeof e.docJson=="object"&&await gn("inbox",e.docJson,t)}catch{}return{status:"refreshed",updatedAt:e?.updatedAt||null,docJson:e?.docJson||null}}var Cl,js=Ge(()=>{Pr();Or();Cl="ttree_pending_quick_notes_v1"});async function op(e){try{let n=(u.articlesIndex.length?u.articlesIndex:await kn()).filter(d=>d.id!=="inbox"),r=n.map(d=>({id:d.id,title:d.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),o=await er({title:"\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0432 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0438\u043B\u0438 \u0432\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E",confirmText:"\u041F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:r,returnMeta:!0,hideConfirm:!1}),s=(o?.selectedId||(typeof o=="object"?o?.value:o)||""||"").trim();if(!s)return;let a=s.toLowerCase(),c=n.find(d=>d.id&&d.id.toLowerCase()===a||(d.title||"").toLowerCase()===a),l=c?c.id:s;if(!l||l==="inbox"){Ie("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}await apiRequest(`/api/articles/${u.articleId}/blocks/${e}/move-to/${l}`,{method:"POST"}),await Un("inbox",{resetUndoStacks:!0}),qt(),Ie("\u0411\u043B\u043E\u043A \u043F\u0435\u0440\u0435\u043D\u0435\u0441\u0451\u043D")}catch(t){Ie(t.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0435\u0440\u0435\u043D\u0435\u0441\u0442\u0438 \u0431\u043B\u043E\u043A")}}async function Xo(e){try{String(e||"").startsWith("inbox-")&&(e="inbox")}catch{}u.isPublicView=!1,u.isRagView=!1,document.body.classList.remove("public-embedded"),u.isEditingTitle=!1,await go(),mo(!0),j.usersView&&j.usersView.classList.add("hidden"),j.blocksContainer.innerHTML="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...";try{if(e==="RAG"){u.isRagView=!0,u.mode="view",u.editingBlockId=null,u.pendingEditBlockId=null,u.scrollTargetBlockId=null,u.ragBlockMap={},ci("RAG");let r=(u.ragQuery||"").trim(),o=Array.isArray(u.ragResults)?u.ragResults:[],i=o.length,s=Array.from(new Set(o.map(m=>m&&m.articleTitle?String(m.articleTitle):"").filter(Boolean))),a=s.slice(0,8),c=["<p><strong>\u0421\u0432\u043E\u0434\u043A\u0430</strong></p>"];u.ragSummaryLoading?c.push('<p class="meta">\u0413\u0435\u043D\u0435\u0440\u0438\u0440\u0443\u044E \u0441\u0432\u043E\u0434\u043A\u0443\u2026</p>'):u.ragSummaryError?c.push(`<p class="meta">\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0432\u043E\u0434\u043A\u0438: ${u.ragSummaryError}</p>`):u.ragSummaryHtml?c.push(u.ragSummaryHtml):c.push('<p class="meta">\u0421\u0432\u043E\u0434\u043A\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435 \u0433\u043E\u0442\u043E\u0432\u0430.</p>');let l=["<p><strong>AI-\u043F\u043E\u0438\u0441\u043A: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B</strong></p>",`<p><span class="meta">\u0417\u0430\u043F\u0440\u043E\u0441:</span> ${r||"\u2014"}</p>`,`<p><span class="meta">\u041D\u0430\u0439\u0434\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432:</span> ${i}</p>`];a.length&&l.push(`<p><span class="meta">\u0421\u0442\u0430\u0442\u044C\u0438:</span> ${a.join(" \xB7 ")}</p>`),s.length>a.length&&l.push(`<p><span class="meta">\u2026\u0438 \u0435\u0449\u0451:</span> ${s.length-a.length}</p>`);let d=[{id:"rag-ai-summary",text:c.join(""),children:[],collapsed:!1},{id:"rag-meta",text:l.join(""),children:[],collapsed:!1},...o.filter(m=>m&&m.type==="block").map((m,h)=>{let b=m.blockText||"",S=m.articleTitle?String(m.articleTitle):"",p=S?`<p><strong>${S}</strong></p>`:`<p><strong>\u0420\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442 ${h+1}</strong></p>`,f=`rag-${m.blockId||h}`;return m.articleId&&m.blockId&&(u.ragBlockMap[f]={articleId:m.articleId,blockId:m.blockId}),{id:f,text:`${p}${b}`,children:[],collapsed:!1}})];u.article={id:"RAG",title:r?`AI: ${r}`:"AI: \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B \u043F\u043E\u0438\u0441\u043A\u0430",blocks:d,updated_at:new Date().toISOString()},u.articleId="RAG",u.currentBlockId=d[0]?.id||null,qt();return}let t=u.pendingEditBlockId||void 0,n=u.scrollTargetBlockId||void 0;if(await Un(e,{resetUndoStacks:!0,desiredBlockId:n,editBlockId:t}),qt(),ci(e),e==="inbox"&&navigator.onLine&&u.serverStatus==="ok")try{await Tl().catch(()=>{}),u.articleId==="inbox"&&!u.editingBlockId&&(await Un("inbox",{resetUndoStacks:!1}),qt())}catch{}}catch(t){try{if((Number(t?.status||0)||null)===404&&e&&e!=="inbox"){Vo(e,new Date().toISOString()).catch(()=>{}),Ts(e),Ie("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430 (\u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E, \u0443\u0434\u0430\u043B\u0435\u043D\u0430)."),bn(rn.list);return}}catch{}j.blocksContainer.innerHTML=`<p class="meta">\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0430\u0442\u044C\u044E: ${t.message}</p>`}}async function bs(){u.isPublicView=!1,u.isRagView=!1,document.body.classList.remove("public-embedded"),j.usersView&&j.usersView.classList.add("hidden"),u.article=null,u.articleId=null,u.currentBlockId=null,u.isEditingTitle=!1,u.mode="view",u.editingBlockId=null,u.undoStack=[],u.redoStack=[],u.pendingEditBlockId=null,li({restoreDom:!1}),mo(!1),Ur();try{if(u.isTrashView){let e=await si();Tn(e)}else{let e=await go();Tn(e)}}catch(e){j.articleList.innerHTML=`<li>\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u043F\u0438\u0441\u043E\u043A: ${e.message}</li>`}}async function Ss(e){u.isPublicView=!0,u.isRagView=!1,document.body.classList.add("public-embedded"),j.usersView&&j.usersView.classList.add("hidden"),mo(!0),u.isEditingTitle=!1,u.mode="view",u.editingBlockId=null,u.pendingEditBlockId=null,u.selectionAnchorBlockId=null,u.selectedBlockIds=[],u.undoStack=[],u.redoStack=[],li({restoreDom:!1}),j.blocksContainer&&(j.blocksContainer.innerHTML="\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430...");try{let t=await apiRequest(`/api/public/articles/${encodeURIComponent(e)}`,{method:"GET",credentials:"omit"});u.article=t,u.articleId=t?.id||null;let n=qn(t?.blocks||[])[0];u.currentBlockId=n?n.id:null,qt()}catch(t){j.blocksContainer&&(j.blocksContainer.innerHTML=`<p class="meta">\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E: ${t.message}</p>`)}}var Bl=Ge(()=>{Bt();In();ln();en();tr();nr();Or();rr();rr();rr();yr();On();Ps();zs();wo();js();Il(op)});var gr=Ge(()=>{lo();Ms();Ps();zs();Bl();wo();wo();Ur()});function ip(e){try{let t=window.getComputedStyle(e).lineHeight,n=Number.parseFloat(t);if(Number.isFinite(n)&&n>0)return n}catch{}return 24}function sp(e,{behavior:t="smooth",topLines:n=2,bottomLines:r=5}={}){if(!e)return;let o=j.blocksContainer||document.scrollingElement||document.documentElement;if(!o)return;let i=o.getBoundingClientRect(),s=e.getBoundingClientRect(),a=ip(o),c=Math.round(a*n),l=Math.round(a*r),d=0,m=i.top+c,h=i.bottom-l;if(s.bottom>h)d=s.bottom-h;else if(s.top<m)d=s.top-m;else return;if(o===document.body||o===document.documentElement||o===document.scrollingElement){window.scrollBy({top:d,behavior:t});return}o.scrollBy({top:d,behavior:t})}function qn(e=[],t=[]){return(e||[]).forEach(n=>{t.push(n),n.children&&n.children.length>0&&!n.collapsed&&qn(n.children,t)}),t}function St(e,t=u.article?.blocks||[],n=null,r=[]){for(let o=0;o<t.length;o+=1){let i=t[o];if(i.id===e)return{block:i,parent:n,index:o,siblings:t,ancestors:r};let s=St(e,i.children||[],i,[...r,i]);if(s)return s}return null}function xo({scrollIntoView:e=!1,scrollBehavior:t="smooth"}={}){let n=new Set(Array.isArray(u.selectedBlockIds)?u.selectedBlockIds:[]);if(u.currentBlockId&&n.add(u.currentBlockId),document.querySelectorAll(".block[data-block-id]").forEach(o=>{let i=o.getAttribute("data-block-id"),s=i&&n.has(i);o.classList.toggle("selected",!!s),o.classList.remove("block--selected-root-ancestor");let a=o.querySelector(":scope > .block-surface");a&&a.classList.remove("block--selected-root-ancestor")}),u.currentBlockId&&u.article&&Array.isArray(u.article.blocks)){let o=St(u.currentBlockId),i=o?.ancestors||[],s=i.length>0?i[0]?.id:o?.block?.id;if(s){let a=document.querySelector(`.block[data-block-id="${s}"]`);if(a){let c=a.querySelector(":scope > .block-surface");c&&c.classList.add("block--selected-root-ancestor")}}}if(e&&u.mode==="view"&&u.currentBlockId){let o=document.querySelector(`.block[data-block-id="${u.currentBlockId}"]`);o&&sp(o,{behavior:t||"smooth",topLines:2,bottomLines:5})}}function Nl(e,t={}){if(!e||u.currentBlockId===e)return;let{preserveSelection:n=!1,scrollIntoView:r,scrollBehavior:o}=t;u.currentBlockId=e,n||(u.selectionAnchorBlockId=null,u.selectedBlockIds=[]);let i=typeof r=="boolean"?r:u.mode==="view";xo({scrollIntoView:i,scrollBehavior:o||"smooth"})}function or(e,t={}){Nl(e,{preserveSelection:!1,...t})}function Ml(e){if(!u.article)return;let t=qn(u.article.blocks),n=t.findIndex(o=>o.id===u.currentBlockId);if(n===-1)return;let r=t[n+e];r&&(u.mode==="view"&&(u.scrollTargetBlockId=r.id),Nl(r.id,{preserveSelection:!1}))}function Ll(e){if(!u.article)return;let t=qn(u.article.blocks);if(!t.length)return;let n=u.selectionAnchorBlockId||u.currentBlockId||t[0].id;n||(n=t[0].id),u.selectionAnchorBlockId||(u.selectionAnchorBlockId=n);let r=t.findIndex(d=>d.id===n);if(r===-1)return;let o=u.currentBlockId||n,i=t.findIndex(d=>d.id===o);i===-1&&(i=r);let s=i+e;if(s<0||s>=t.length)return;let[a,c]=s>=r?[r,s]:[s,r],l=t.slice(a,c+1).map(d=>d.id);u.selectedBlockIds=l,u.currentBlockId=t[s].id,u.mode==="view"&&(u.scrollTargetBlockId=u.currentBlockId),xo({scrollIntoView:u.mode==="view"})}var Pl=Ge(()=>{Bt();In()});function ir(e){return e?e.nodeType===Node.TEXT_NODE?/\n\s*\n/.test(e.textContent||""):e.nodeType===Node.ELEMENT_NODE&&(e.tagName==="BR"||(e.tagName==="P"||e.tagName==="DIV")&&(!(e.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&(nbsp|#160);/gi,"").trim()||!(e.textContent||"").replace(/\u00a0/g,"").trim()&&!e.querySelector("img"))):!1}function gi(e=[]){let t=document.createElement("div");return e.forEach(n=>t.appendChild(n)),t.innerHTML.trim()}function Js(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=[],r=(i="")=>{let s=document.createElement("p");i?s.innerHTML=i:s.appendChild(document.createElement("br")),n.push(s)};Array.from(t.content.childNodes).forEach(i=>{if(i.nodeType===Node.TEXT_NODE){let s=(i.textContent||"").trim();s&&r(s);return}if(i.nodeType===Node.ELEMENT_NODE){if(i.tagName==="P"){n.push(i.cloneNode(!0));return}if(i.tagName==="BR"){r("");return}if(i.tagName==="DIV"){r(i.innerHTML);return}r(i.outerHTML)}}),n.length||r("");let o=document.createElement("div");return n.forEach(i=>o.appendChild(i)),o.innerHTML}function Kn(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll(".block-header").forEach(m=>{let h=m.parentNode;if(h){for(;m.firstChild;)h.insertBefore(m.firstChild,m);h.removeChild(m)}});let n=Array.from(t.content.childNodes),r=m=>m?.nodeType===Node.TEXT_NODE&&!(m.textContent||"").trim(),o=0;for(;o<n.length&&r(n[o]);)o+=1;let i=n[o];if(!i||i.nodeType!==Node.ELEMENT_NODE||i.tagName!=="P"||ir(i))return{titleHtml:"",bodyHtml:gi(n)};let s=o+1;for(;s<n.length&&r(n[s]);)s+=1;let a=n[s];if(!(!!a&&ir(a)&&(a.nodeType===Node.ELEMENT_NODE?a.tagName==="P"||a.tagName==="DIV"||a.tagName==="BR":!1)))return{titleHtml:"",bodyHtml:gi(n)};let l=[i.cloneNode(!0)],d=[];for(let m=s+1;m<n.length;m+=1)d.push(n[m].cloneNode(!0));return{titleHtml:gi(l),bodyHtml:gi(d)}}function _l({event:e,element:t,range:n,selection:r,notifyEditingInput:o,logDebug:i}){if(!e||!t||!n||!r||!n.collapsed)return!1;let s=e.key==="Backspace"||e.code==="Backspace"||e.keyCode===8,a=e.key==="Delete"||e.key==="Del"||e.code==="Delete"||e.code==="Del"||e.keyCode===46;if(!s&&!a)return!1;let c=f=>{try{r.removeAllRanges(),r.addRange(f)}catch{}try{t.focus({preventScroll:!0})}catch{t.focus()}},l=f=>{let x=(n.commonAncestorContainer?.nodeType===Node.ELEMENT_NODE?n.commonAncestorContainer:n.commonAncestorContainer?.parentElement)?.closest?.("p");if(x)return x;let A=t,C=Array.from(A.childNodes),L=n.startContainer;for(;L&&L.parentNode!==A;)L=L.parentNode;let H=L?C.indexOf(L):-1,U=F=>{let X=F==="prev"?-1:1,G=H;for(G===-1?G=F==="prev"?C.length-1:0:G=F==="prev"?G-1:G;G>=0&&G<C.length;){let oe=C[G];if(oe?.nodeType===Node.ELEMENT_NODE&&oe.tagName==="P")return oe;G+=X}return null};return f==="Delete"?U("next")||U("prev"):f==="Backspace"?U("prev")||U("next"):null},d=()=>{if(n.startContainer!==t)return{prev:null,next:null};let f=Array.from(t.childNodes),w=n.startOffset,x=null,A=null;for(let C=w-1;C>=0;C-=1){let L=f[C];if(L?.nodeType===Node.ELEMENT_NODE&&L.tagName==="P"){x=L;break}}for(let C=w;C<f.length;C+=1){let L=f[C];if(L?.nodeType===Node.ELEMENT_NODE&&L.tagName==="P"){A=L;break}}return{prev:x,next:A}},m=f=>{let w=f?.previousElementSibling;for(;w&&w.tagName!=="P";)w=w.previousElementSibling;return w&&w.tagName==="P"?w:null},h=f=>{let w=f?.nextElementSibling;for(;w&&w.tagName!=="P";)w=w.nextElementSibling;return w&&w.tagName==="P"?w:null},b=f=>{if(!f)return!0;let w=new Set(["span","b","strong","i","em","u","s","mark","code"]),x=new Set(["img","video","audio","iframe"]),A=C=>{if(!C)return!1;if(C.nodeType===Node.TEXT_NODE)return(C.textContent||"").replace(/\u00a0/g,"").replace(/[\u200B-\u200D\uFEFF]/g,"").trim().length>0;if(C.nodeType!==Node.ELEMENT_NODE)return!1;let L=(C.tagName||"").toLowerCase();return L==="br"?!1:x.has(L)?!0:L==="span"&&(C.getAttribute("class")||"").includes("resizable-image__handle")?!1:w.has(L)?Array.from(C.childNodes||[]).some(A):!0};return!Array.from(f.childNodes||[]).some(A)},S=f=>{if(!f)return!1;let w=document.createRange();w.selectNodeContents(f);try{w.setEnd(n.startContainer,n.startOffset)}catch{return!1}if(b(w.cloneContents()))return!0;try{let x=document.createRange();return x.selectNodeContents(f),x.collapse(!0),n.compareBoundaryPoints(Range.START_TO_START,x)===0}catch{return!1}},p=f=>{if(!f)return!1;let w=document.createRange();w.selectNodeContents(f);try{w.setStart(n.startContainer,n.startOffset)}catch{return!1}if(b(w.cloneContents()))return!0;try{let x=document.createRange();return x.selectNodeContents(f),x.collapse(!1),n.compareBoundaryPoints(Range.END_TO_END,x)===0}catch{return!1}};if(window.__debugMergeP&&i("mergeP.keydown",{key:e.key,code:e.code,keyCode:e.keyCode,startContainer:n.startContainer?.nodeName,startOffset:n.startOffset,collapsed:n.collapsed}),s){if(n.startContainer===t){let A=d();if(A.prev&&A.next){e.preventDefault(),e.stopPropagation();let C=document.createRange();for(C.selectNodeContents(A.prev),C.collapse(!1);A.next.firstChild;)A.prev.appendChild(A.next.firstChild);return A.next.remove(),c(C),o(t),!0}return!1}let f=l("Backspace");if(!f||!t.contains(f)||!S(f))return!1;let w=m(f);if(!w||!t.contains(w))return!1;e.preventDefault(),e.stopPropagation();let x=document.createRange();for(x.selectNodeContents(w),x.collapse(!1);f.firstChild;)w.appendChild(f.firstChild);return f.remove(),c(x),o(t),!0}if(a){let f=l("Delete");if(!f||!t.contains(f)){let A=d();if(A.prev&&A.next){e.preventDefault(),e.stopPropagation();let C=document.createRange();for(C.selectNodeContents(A.prev),C.collapse(!1);A.next.firstChild;)A.prev.appendChild(A.next.firstChild);return A.next.remove(),c(C),o(t),!0}return!1}if(!p(f))return!1;let w=h(f);if(!w||!t.contains(w))return!1;e.preventDefault(),e.stopPropagation();let x=document.createRange();for(x.selectNodeContents(f),x.collapse(!1);w.firstChild;)f.appendChild(w.firstChild);return w.remove(),c(x),o(t),!0}return!1}var Ws=Ge(()=>{});function Ao(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=r=>{if(r&&!(r.nodeType===Node.ELEMENT_NODE&&r.tagName==="A")){if(r.nodeType===Node.TEXT_NODE){let o=r.textContent||"";if(yi.lastIndex=0,!yi.test(o))return;let s=document.createDocumentFragment(),a=0;yi.lastIndex=0;let c;for(;(c=yi.exec(o))!==null;){let[l]=c;c.index>a&&s.appendChild(document.createTextNode(o.slice(a,c.index)));let d=l.startsWith("http")?l:`https://${l}`,m=document.createElement("a");m.href=d,m.target="_blank",m.rel="noopener noreferrer",m.textContent=l,s.appendChild(m),a=c.index+l.length}a<o.length&&s.appendChild(document.createTextNode(o.slice(a))),r.parentNode&&r.parentNode.replaceChild(s,r);return}Array.from(r.childNodes||[]).forEach(n)}};return Array.from(t.content.childNodes).forEach(n),t.innerHTML}function Dl(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll("script, style").forEach(o=>o.remove());let n=(o="")=>/^javascript:/i.test(o.trim()),r=o=>{if(!o||o.nodeType!==Node.ELEMENT_NODE){Array.from(o?.childNodes||[]).forEach(r);return}Array.from(o.attributes||[]).forEach(i=>{let s=i.name.toLowerCase(),a=i.value||"";if(s.startsWith("on")||s==="style"){o.removeAttribute(i.name);return}(s==="href"||s==="src")&&n(a)&&o.removeAttribute(i.name)}),Array.from(o.childNodes||[]).forEach(r)};return Array.from(t.content.childNodes||[]).forEach(r),t.innerHTML}function bi(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=r=>{if(!r)return!0;if(r.nodeType===Node.TEXT_NODE)return!(r.textContent||"").replace(/\u00a0/g,"").trim();if(r.nodeType!==Node.ELEMENT_NODE)return!1;if(r.tagName==="BR")return!0;let o=(r.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&nbsp;/gi,"").trim(),i=(r.textContent||"").replace(/\u00a0/g,"").trim(),s=!!r.querySelector("img,video,audio,iframe");return!o&&!i&&!s};for(;t.content.firstChild&&n(t.content.firstChild);)t.content.removeChild(t.content.firstChild);for(;t.content.lastChild&&n(t.content.lastChild);)t.content.removeChild(t.content.lastChild);return t.innerHTML}function Ol(e=""){let t=document.createElement("template");t.innerHTML=e||"";let n=(t.content.textContent||"").replace(/\u00a0/g," ").trim(),r=!!t.content.querySelector("a"),o=!1;{let S=Array.from(t.content.childNodes||[]);for(let p=0;p<S.length;p+=1){let f=S[p];if(f.nodeType===Node.TEXT_NODE){if(!(f.textContent||"").trim())continue;break}ir(f)&&(o=!0);break}}let i=document.createElement("template");i.innerHTML=e||"",i.content.querySelectorAll("img").forEach(S=>{let p=String(S.getAttribute("src")||"").trim();if(!/^(blob:|filesystem:)/i.test(p))return;let f=String(S.getAttribute("alt")||"").trim()||"image",w=S.closest?.(".resizable-image")||S;try{w.replaceWith(document.createTextNode(`[${f} \u2014 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0431\u044B\u043B\u043E blob: \u0438 \u043D\u0435 \u0431\u044B\u043B\u043E \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E]`))}catch{}});let a=(()=>{if(!Array.from(i.content.childNodes||[]).length)return!1;let p=Array.from(i.content.querySelectorAll("p"));if(p.length<2)return!1;let f=ne=>{let ye=ne.trim();return ye.startsWith("|")&&ye.indexOf("|",1)!==-1},x=p.map(ne=>(ne.textContent||"").replace(/\u00a0/g," ").trim()).filter(ne=>ne);if(x.length<2||!x.every(f))return!1;let A=x.map(ne=>{let ye=ne.trim();return(ye.endsWith("|")?ye.slice(1,-1):ye.slice(1)).split("|").map(wt=>wt.trim())}),C=A[0],L=A.slice(1),H=L.reduce((ne,ye)=>Math.max(ne,ye.length),C.length),U=document.createElement("table");U.className="memus-table";let F=document.createElement("colgroup"),X=100/Math.max(H,1);for(let ne=0;ne<H;ne+=1){let ye=document.createElement("col");ye.setAttribute("width",`${X.toFixed(4)}%`),F.appendChild(ye)}U.appendChild(F);let G=document.createElement("thead"),oe=document.createElement("tr");for(let ne=0;ne<H;ne+=1){let ye=document.createElement("th");ye.textContent=C[ne]||"",oe.appendChild(ye)}G.appendChild(oe),U.appendChild(G);let we=document.createElement("tbody");return L.forEach(ne=>{let ye=document.createElement("tr"),Ye=[...ne];for(let wt=0;wt<H;wt+=1){let Pt=document.createElement("td");Pt.textContent=Ye[wt]||"",ye.appendChild(Pt)}we.appendChild(ye)}),U.appendChild(we),i.content.innerHTML="",i.content.appendChild(U),Ao(i.innerHTML).replace(/<\/a>\s*<a/gi,"</a> <a")})();if(a)return a;i.content.querySelectorAll(".table-toolbar, .table-toolbar-btn").forEach(S=>{S.remove()}),i.content.querySelectorAll(".block-header").forEach(S=>{let p=S.parentNode;if(p){for(;S.firstChild;)p.insertBefore(S.firstChild,S);p.removeChild(S)}});let c=S=>{Array.from(S.childNodes).forEach(p=>{if(p.nodeType===Node.ELEMENT_NODE){if(p.tagName==="DIV"){let f=document.createElement("p");f.innerHTML=p.innerHTML,p.parentNode.replaceChild(f,p),c(f);return}c(p)}})};c(i.content),(S=>{Array.from(S.childNodes||[]).forEach(f=>{if(f.nodeType===Node.TEXT_NODE){let x=(f.textContent||"").replace(/\u00a0/g," ");if(!x.trim()){if(f.previousSibling&&f.nextSibling){f.textContent=" ";return}S.removeChild(f);return}let C=document.createElement("p");C.textContent=x,S.replaceChild(C,f)}})})(i.content),i.content.querySelectorAll("p").forEach(S=>{(S.innerHTML||"").replace(/&nbsp;/gi,"").replace(/<br\s*\/?>/gi,"").trim()||(S.innerHTML="",S.appendChild(document.createElement("br")))});let d=i.content;if(!!d.querySelector("p")){if(o){let S=Array.from(d.childNodes||[]),p=null;for(let f=0;f<S.length;f+=1){let w=S[f];if(!(w.nodeType===Node.TEXT_NODE&&!(w.textContent||"").trim())){p=w;break}}if(p){if(!(p.tagName==="P"&&ir(p))){let f=document.createElement("p");f.appendChild(document.createElement("br")),d.insertBefore(f,p)}}else{let f=document.createElement("p");f.appendChild(document.createElement("br")),d.appendChild(f)}}}else{let S=document.createElement("p");S.appendChild(document.createElement("br")),d.appendChild(S)}let b=Ao(i.innerHTML).replace(/<\/a>\s*<a/gi,"</a> <a");return!b.trim()&&(n||r)?e||"":b}var yi,Rl=Ge(()=>{Ws();yi=/((?:https?:\/\/|www\.)[^\s<>"']+)/gi});function sr(e){if(!e)return;if(!(e.innerHTML||"").replace(/<br\s*\/?>/gi,"").replace(/&nbsp;/gi,"").trim()){e.innerHTML="";let n=document.createRange();n.selectNodeContents(e),n.collapse(!0);let r=window.getSelection();r&&(r.removeAllRanges(),r.addRange(n))}}var Ys=Ge(()=>{});function Sr(e){if(!e)return!1;if(e.type&&e.type.startsWith("image/"))return!0;let t=(e.name||"").toLowerCase();return t?/\.(png|jpe?g|gif|webp|bmp|svg|heic|heif)$/i.test(t):!1}function Gs(e=[],t=[]){let n=[];return Array.from(e||[]).forEach(r=>{if(r.kind==="file"){let o=typeof r.getAsFile=="function"?r.getAsFile():null;o&&Sr(o)&&n.push(o)}}),!n.length&&t?.length&&Array.from(t).forEach(r=>{Sr(r)&&n.push(r)}),n}function Xs(e=[],t=[]){let n=[];return Array.from(e||[]).forEach(r=>{if(r.kind==="file"){let o=typeof r.getAsFile=="function"?r.getAsFile():null;o&&!Sr(o)&&n.push(o)}}),!n.length&&t?.length&&Array.from(t).forEach(r=>{Sr(r)||n.push(r)}),n}async function Si(e,t,n){let r=`img-${Date.now()}-${Math.random().toString(16).slice(2)}`,o=t&&t.name?t.name:"image",i=Jt(o).replace(/"/g,"&quot;");try{sr(e),Jn(e,`<span data-pending-image="true" data-image-token="${r}">${i} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F...)</span>`)}catch{}try{let{url:s}=await ao(t),c=`
      <span class="resizable-image" style="width:320px;max-width:100%;">
        <span class="resizable-image__inner">${`<img src="${s}" alt="${i}" draggable="false" />`}</span>
        <span class="resizable-image__handle" data-direction="e" aria-hidden="true"></span>
      </span>
    `,l=e,d=l&&l.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`);if(n&&(!d||!l.isConnected)){let m=document.querySelector(`.block[data-block-id="${n}"]`);if(m){let b=m.querySelector('.block-text[contenteditable="true"]')||m.querySelector(".block-text.block-body");b&&(l=b,d=l.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`))}}d?(d.removeAttribute("data-pending-image"),d.removeAttribute("data-image-token"),d.outerHTML=c):l&&(sr(l),Jn(l,c))}catch(s){try{let c=e;if(n&&!c.isConnected){let l=document.querySelector(`.block[data-block-id="${n}"]`);if(l){let m=l.querySelector('.block-text[contenteditable="true"]')||l.querySelector(".block-text.block-body");m&&(c=m)}}if(c){let l=c.querySelector(`span[data-image-token="${r}"][data-pending-image="true"]`);l&&(l.textContent=`${o} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F)`,l.removeAttribute("data-pending-image"))}}catch{}try{fetch("/api/client/log",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind:"insertImageFromFileError",data:{message:s&&s.message?String(s.message):String(s),name:t&&t.name,type:t&&t.type,size:t&&t.size}})}).catch(()=>{})}catch{}try{let c={where:"insertImageFromFile",message:s&&s.message?String(s.message):String(s),status:typeof s?.status=="number"?s.status:null,name:t&&t.name,type:t&&t.type,size:t&&t.size},l=c.status===null?"null":String(c.status);window.alert(`upload failed (status ${l}):\\n${JSON.stringify(c,null,2)}`)}catch{}let a=String(s?.message||"").toLowerCase();a.includes("status 0")||a.includes("network error")?Ie("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 (\u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C). \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438, \u043F\u0440\u0438 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u043E\u0441\u0442\u0438, \u0432\u043E\u0439\u0434\u0438\u0442\u0435 \u0437\u0430\u043D\u043E\u0432\u043E."):Ie(s.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435")}}function ap(e){if(e.button!==0)return;let t=e.target?.closest(".resizable-image__handle");if(!t)return;let n=t.closest(".resizable-image"),o=n?.closest(".block")?.dataset?.blockId;if(!n||!o||u.mode!=="edit"||u.editingBlockId!==o)return;e.preventDefault(),e.stopPropagation();let i=n.getBoundingClientRect();ar={wrapper:n,startWidth:i.width,startX:e.clientX},n.classList.add("resizable-image--resizing")}function cp(e){if(!ar)return;e.preventDefault();let t=e.clientX-ar.startX,r=parseFloat(getComputedStyle(document.documentElement).fontSize)||16,o=Math.max(r,document.documentElement.clientWidth-32),i=ar.startWidth+t;i=Math.max(r,Math.min(i,o)),ar.wrapper.style.width=`${i}px`}function $l(){ar&&(ar.wrapper.classList.remove("resizable-image--resizing"),ar=null)}function Fl(){Hl||(Hl=!0,document.addEventListener("pointerdown",ap),document.addEventListener("pointermove",cp),document.addEventListener("pointerup",$l),document.addEventListener("pointercancel",$l))}var ar,Hl,zl=Ge(()=>{Bt();ln();en();_n();Ys();ar=null,Hl=!1});function Ul({listTag:e,resolveTarget:t,restoreSelection:n,richContextRange:r,notifyEditingInput:o,setRichContextRange:i}){let s=t();if(!s||!document.contains(s))return;n();let a=window.getSelection(),c=null;if(r&&s.contains(r.commonAncestorContainer))c=r.cloneRange();else if(a&&a.rangeCount>0){let x=a.getRangeAt(0);s.contains(x.commonAncestorContainer)&&(c=x.cloneRange())}c||(c=document.createRange(),c.selectNodeContents(s),c.collapse(!1));let l=c.startContainer?.nodeType===Node.ELEMENT_NODE?c.startContainer:c.startContainer?.parentElement,d=l?.closest?.("li"),m=d?.closest?.("ol,ul"),h=x=>{if(!x)return;let A=document.createRange();A.selectNodeContents(x),A.collapse(!1),a&&(a.removeAllRanges(),a.addRange(A)),i(A);try{s.focus({preventScroll:!0})}catch{s.focus()}s.classList.remove("block-body--empty"),o(s)},b=x=>{let A=x.parentElement?.tagName==="P"&&x.parentElement.childNodes.length===1?x.parentElement:x,C=Array.from(x.children||[]).filter(U=>U.nodeType===Node.ELEMENT_NODE&&U.tagName==="LI"),L=document.createDocumentFragment(),H=[];C.forEach(U=>{let F=document.createElement("p");for(;U.firstChild;)F.appendChild(U.firstChild);H.push(F),L.appendChild(F)}),A.replaceWith(L),h(H[0]||null)};if(m){if(m.tagName.toLowerCase()===e){b(m);return}let A=document.createElement(e);for(;m.firstChild;)A.appendChild(m.firstChild);m.replaceWith(A),h(d||A.lastElementChild||A);return}let S=()=>{if(!c.collapsed)return null;let x=l?.closest?.("p")||null;if(x&&s.contains(x))return x;if(c.startContainer===s){let A=Array.from(s.childNodes),C=c.startOffset;for(let L=C-1;L>=0;L-=1){let H=A[L];if(H?.nodeType===Node.ELEMENT_NODE&&H.tagName==="P")return H}for(let L=C;L<A.length;L+=1){let H=A[L];if(H?.nodeType===Node.ELEMENT_NODE&&H.tagName==="P")return H}}return null},p=[];if(c.collapsed){let x=S();x&&(p=[x])}else if(p=Array.from(s.querySelectorAll(":scope > p")).filter(A=>{try{return c.intersectsNode(A)}catch{return!1}}),!p.length){let A=l?.closest?.("p");A&&s.contains(A)&&(p=[A])}if(!p.length)return;let f=document.createElement(e);p.forEach(x=>{let A=document.createElement("li");for(;x.firstChild;)A.appendChild(x.firstChild);f.appendChild(A)}),p[0].replaceWith(f),p.slice(1).forEach(x=>x.remove()),h(f.firstElementChild||f)}var ql=Ge(()=>{});var Hs={};Do(Hs,{applyEditingUndoStep:()=>pp,attachRichContentHandlers:()=>Vs,buildEditableBlockHtml:()=>Us,buildStoredBlockHtml:()=>sl,cleanupEditableHtml:()=>Ol,clearEditingUndoSession:()=>fp,countBlocks:()=>Rs,ensureBlockVisible:()=>Ls,expandCollapsedAncestors:()=>hp,extendSelection:()=>Ll,extractBlockSections:()=>Kn,findBlock:()=>St,findCollapsibleTarget:()=>mp,findFallbackBlockId:()=>pi,flattenVisible:()=>qn,initEditingUndoForElement:()=>up,insertFilesIntoEditable:()=>Ks,isSeparatorNode:()=>ir,moveSelection:()=>Ml,setCollapseState:()=>wi,setCurrentBlock:()=>or,toggleCollapse:()=>qs});function Jl(e=""){return e?e.startsWith("app:/")?`/api/yandex/disk/file?path=${encodeURIComponent(e)}`:e.startsWith("disk:/")?`/api/yandex/disk/file?path=${encodeURIComponent(e)}`:e:""}function dp(e,t){if(e===t)return!1;if(t.startsWith(e)){let n=t.slice(e.length);if(n.length>0&&n.length<=lp&&/^[A-Za-zА-Яа-я0-9]+$/.test(n))return!1}return!0}function up(e,t){if(!e||!t)return;u.editingUndo={blockId:t,snapshots:[e.innerHTML],index:0,lastText:e.textContent||"",lastSnapshotAt:Date.now()};let n=()=>{let r=u.editingUndo;if(!r||r.blockId!==t)return;let o=e.innerHTML,i=e.textContent||"",{snapshots:s,index:a,lastText:c,lastSnapshotAt:l}=r,d=Date.now();if(!dp(c||"",i)){r.lastText=i;return}if(s[a]===o){r.lastText=i,r.lastSnapshotAt=d;return}a<s.length-1&&s.splice(a+1),s.push(o),r.index=s.length-1,r.lastText=i,r.lastSnapshotAt=d};e.addEventListener("input",()=>{!u.editingUndo||u.editingUndo.blockId!==t||u.mode!=="edit"||u.editingBlockId!==t||n()})}function fp(){u.editingUndo=null}function Io(e){if(e)try{let t=typeof InputEvent=="function"?new InputEvent("input",{bubbles:!0}):new Event("input",{bubbles:!0});e.dispatchEvent(t)}catch{try{let n=document.createEvent("Event");n.initEvent("input",!0,!1),e.dispatchEvent(n)}catch{}}}function pp(e){let t=u.editingUndo;if(!t||!t.blockId||!e||u.mode!=="edit"||u.editingBlockId!==t.blockId)return!1;let n=document.querySelector(`.block[data-block-id="${t.blockId}"] .block-text[contenteditable="true"]`);if(!n)return!1;let r=t.index+e;if(r<0||r>=t.snapshots.length)return!1;t.index=r;let o=t.snapshots[r];n.innerHTML=o;try{n.focus({preventScroll:!0})}catch{n.focus()}try{let i=window.getSelection&&window.getSelection();if(i){let s=document.createRange();s.selectNodeContents(n),s.collapse(!1),i.removeAllRanges(),i.addRange(s)}}catch{}return!0}function Us(e=""){let t=Kn(e);if(!t.titleHtml)return e||"";let n=Js(t.titleHtml),r=t.bodyHtml||"";if(r){let i=document.createElement("template");i.innerHTML=r;let s=i.content.firstChild;for(;s&&ir(s);){let a=s;s=s.nextSibling,i.content.removeChild(a)}r=i.innerHTML}let o=Js(r||"");return`${n}<p><br /></p>${o}`}function sl(e=""){let t=document.createElement("template");t.innerHTML=e||"",t.content.querySelectorAll(".block-header").forEach(i=>{let s=i.parentNode;if(s){for(;i.firstChild;)s.insertBefore(i.firstChild,i);s.removeChild(i)}});let n=t.innerHTML,r=Kn(n);if(!r.titleHtml)return e||"";let o=`<div class="block-header">${r.titleHtml}</div>`;return r.bodyHtml?`${o}<div><br /></div>${r.bodyHtml}`:o}async function qs(e){let t=St(e);t&&wi(e,!t.block.collapsed)}async function wi(e,t){let n=St(e);if(!n||n.block.collapsed===t)return;let r=()=>{let s=document.getElementById("blocksContainer");if(!s)return null;let a=u.currentBlockId;if(!a)return{container:s};let c=s.querySelector(`.block[data-block-id="${a}"]`);if(!c)return{container:s};let l=s.getBoundingClientRect(),d=c.getBoundingClientRect();return{container:s,currentId:a,topOffset:d.top-l.top}},o=s=>{if(!s?.container)return;let{container:a}=s;if(!s.currentId||typeof s.topOffset!="number")return;let c=a.querySelector(`.block[data-block-id="${s.currentId}"]`);if(!c)return;let l=a.getBoundingClientRect(),m=c.getBoundingClientRect().top-l.top;a.scrollTop+=m-s.topOffset},i=r();n.block.collapsed=t,await dn(e),xo({scrollIntoView:!1}),o(i);try{let s=await Et(`/api/articles/${u.articleId}/collapse`,{method:"PATCH",body:JSON.stringify({blockId:e,collapsed:t})});s?.updatedAt&&(u.article.updatedAt=s.updatedAt)}catch(s){n.block.collapsed=!t,await dn(e),xo({scrollIntoView:!1}),o(i),Ie(s.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0441\u043E\u0441\u0442\u043E\u044F\u043D\u0438\u0435 \u0431\u043B\u043E\u043A\u0430")}}function mp(e,t){let n=St(e);for(;n;){let o=!!Kn(n.block.text||"").titleHtml,i=!!n.block.children?.length;if((o||i)&&n.block.collapsed!==t)return n.block.id;if(!n.parent)break;n=St(n.parent.id)}return null}async function hp(e){let t=St(e);if(!t)return;let n=(t.ancestors||[]).filter(r=>r.collapsed);for(let r of n)await wi(r.id,!1)}function pi(e){let t=St(e);if(!t)return null;let n=t.siblings?.[t.index+1];if(n)return n.id;let r=t.siblings?.[t.index-1];return r?r.id:t.parent?t.parent.id:null}function Rs(e=[]){return(e||[]).reduce((t,n)=>t+1+Rs(n.children||[]),0)}async function Zs(e,t,n){if(!u.articleId){Ie("\u041D\u0435 \u0432\u044B\u0431\u0440\u0430\u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044F \u0434\u043B\u044F \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0444\u0430\u0439\u043B\u0430");return}let r=`att-${Date.now()}-${Math.random().toString(16).slice(2)}`,o=Jt(t?.name||"\u0444\u0430\u0439\u043B"),i=t?.name||"\u0444\u0430\u0439\u043B",s="";nn("attachment: uploading to Yandex Disk",{name:t?.name,type:t?.type,size:t?.size,articleId:u.articleId,token:r});try{sr(e),Jn(e,`<a data-pending-attachment="true" data-attachment-token="${r}">${o} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430...)</a>`)}catch{}try{let a=await Wo(u.articleId,t,{onProgress:h=>{let b=Math.max(0,Math.min(100,Math.round(h||0)));nn("attachment upload progress",{percent:b,name:t?.name});try{let S=e,p=S.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);if(n&&(!p||!S.isConnected)){let f=document.querySelector(`.block[data-block-id="${n}"]`);if(f){let x=f.querySelector('.block-text[contenteditable="true"]')||f.querySelector(".block-text.block-body");x&&(S=x,p=S.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`))}}if(p){let f=b>=100?`${i} (\u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0430...)`:`${i} (${b}%)`;f!==s&&(s=f,p.textContent=f)}}catch{}}}),c=Jt(a.originalName||t.name||"\u0444\u0430\u0439\u043B"),l=a.storedPath||a.url||"",d=Jl(l),m=Jt(d);if(m){let h=e,b=h.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);if(n&&(!b||!h.isConnected)){let S=document.querySelector(`.block[data-block-id="${n}"]`);if(S){let f=S.querySelector('.block-text[contenteditable="true"]')||S.querySelector(".block-text.block-body");f&&(h=f,b=h.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`))}}b?(b.removeAttribute("data-pending-attachment"),b.removeAttribute("data-attachment-token"),b.setAttribute("href",m),b.setAttribute("target","_blank"),b.setAttribute("rel","noopener noreferrer"),b.textContent=c):(sr(h),Jn(h,`<a href="${m}" target="_blank" rel="noopener noreferrer">${c}</a>`))}}catch(a){try{let l=e;if(n&&!l.isConnected){let m=document.querySelector(`.block[data-block-id="${n}"]`);if(m){let b=m.querySelector('.block-text[contenteditable="true"]')||m.querySelector(".block-text.block-body");b&&(l=b)}}let d=l.querySelector(`a[data-attachment-token="${r}"][data-pending-attachment="true"]`);d&&(d.textContent=`${o} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`)}catch{}let c=String(a?.message||"").toLowerCase();c.includes("status 0")||c.includes("network error")?Ie("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B (\u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C). \u041E\u0431\u043D\u043E\u0432\u0438\u0442\u0435 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443 \u0438, \u043F\u0440\u0438 \u043D\u0435\u043E\u0431\u0445\u043E\u0434\u0438\u043C\u043E\u0441\u0442\u0438, \u0432\u043E\u0439\u0434\u0438\u0442\u0435 \u0437\u0430\u043D\u043E\u0432\u043E."):Ie(a.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u043D\u0430 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A")}}function Ks(e,t=[],n){if(!e||!t||!t.length)return;let r=Array.from(t),o=r.filter(s=>Sr(s)),i=r.filter(s=>s&&!Sr(s));o.forEach(s=>Si(e,s,n)),i.forEach(s=>Zs(e,s,n))}function Vs(e,t){jl(e,t);let n=e.closest(".block-content");n&&n!==e&&jl(n,t,e),e.addEventListener("paste",r=>{if(u.mode!=="edit"||u.editingBlockId!==t)return;let o=Gs(r.clipboardData?.items),i=Xs(r.clipboardData?.items);if(o.length>0)r.preventDefault(),o.forEach(s=>Si(e,s,t));else if(i.length>0)r.preventDefault(),nn("paste: non-image files detected",i.map(s=>({name:s.name,type:s.type,size:s.size}))),i.forEach(s=>Zs(e,s,t));else{r.preventDefault();let s=h=>{let b=String(h||"").trim();if(!b)return"";let S=document.createElement("template");S.innerHTML=b;let p=S.content.querySelector("body");return((p?p.innerHTML:S.innerHTML)||"").replace(/<!--\s*StartFragment\s*-->/gi,"").replace(/<!--\s*EndFragment\s*-->/gi,"").trim()},a=h=>{let b=String(h||"").trim();if(!b)return"";if(/<\s*(table|ul|ol)\b/i.test(b)||!/<\s*(p|div|h[1-6])\b/i.test(b))return b;let S=document.createElement("template");S.innerHTML=b,(A=>{S.content.querySelectorAll(A).forEach(C=>{let L=C.parentNode;if(L){for(;C.firstChild;)L.insertBefore(C.firstChild,C);L.removeChild(C)}})})("ms-cmark-node");let f=[],w=A=>{let C=String(A||"").replace(/^\s*(<br\s*\/?>\s*)+/gi,"").replace(/(\s*<br\s*\/?>\s*)+$/gi,"").trim();C&&f.push(C)},x=Array.from(S.content.childNodes||[]);for(let A of x){if(!A)continue;if(A.nodeType===Node.TEXT_NODE){let L=(A.textContent||"").replace(/\u00a0/g," ").trim();L&&w(Jt(L));continue}if(A.nodeType!==Node.ELEMENT_NODE)continue;let C=(A.tagName||"").toUpperCase();if(/^H[1-6]$/.test(C)){w(`<strong>${A.innerHTML||""}</strong>`);continue}if(C==="P"||C==="DIV"||C==="LI"||C==="BLOCKQUOTE"){w(A.innerHTML||"");continue}if(C==="BR"){w("<br />");continue}w(A.outerHTML||A.innerHTML||"")}return f.length?f.join("<br /><br />"):""},c=h=>{sr(e);try{e.focus({preventScroll:!0})}catch{e.focus()}try{if(typeof document.execCommand=="function"&&document.execCommand("insertHTML",!1,h))return!0}catch{}return Jn(e,h),!0},l=h=>{let b=s(h);if(!b)return!1;let p=(C=>{let L=document.createElement("template");L.innerHTML=String(C||"");let H=!1;return L.content.querySelectorAll("img").forEach(U=>{let F=String(U.getAttribute("src")||"").trim();if(!/^(blob:|filesystem:)/i.test(F))return;H=!0;let X=String(U.getAttribute("alt")||"").trim()||"image",G=U.closest?.(".resizable-image")||U;try{G.replaceWith(document.createTextNode(`[${X} \u2014 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0438\u0437 \u0431\u0443\u0444\u0435\u0440\u0430 \u043E\u0431\u043C\u0435\u043D\u0430 (blob:) \u043D\u0435 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E]`))}catch{}}),{html:L.innerHTML,hadUnstable:H}})(b);p.hadUnstable&&Ie("\u041A\u0430\u0440\u0442\u0438\u043D\u043A\u0430 \u0431\u044B\u043B\u0430 \u0432\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u0430 \u043A\u0430\u043A blob: URL \u0438 \u043D\u0435 \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u0441\u044F \u043F\u043E\u0441\u043B\u0435 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438. \u0412\u0441\u0442\u0430\u0432\u044C\u0442\u0435 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u043A\u0430\u043A \u0444\u0430\u0439\u043B (\u043F\u0435\u0440\u0435\u0442\u0430\u0449\u0438\u0442\u0435/\u0432\u0441\u0442\u0430\u0432\u044C\u0442\u0435 \u0444\u0430\u0439\u043B \u0438\u043B\u0438 \u0441\u043A\u0440\u0438\u043D\u0448\u043E\u0442).");let f=Dl(p.html),w=a(f);if(!w)return!1;let x=bi(f),A=bi(w)||x;return c(Ao(A)),Io(e),!0},d=h=>{let b=String(h||""),S=b.trim();if(/^https?:\/\/\S+$/i.test(S)){let A=Jt(S);return sr(e),Jn(e,`<a href="${A}" target="_blank" rel="noopener noreferrer">${A}</a>`),Io(e),!0}let f=b.replace(/\r\n/g,`
`).replace(/\r/g,`
`),w=Jt(f).replace(/\n{2,}/g,"<br /><br />").replace(/\n/g,"<br />"),x=Ao(bi(w));return c(x),Io(e),!0},m=(r.clipboardData?.getData("text/html")||"").trim();if(m&&l(m))return;try{let b=Array.from(r.clipboardData?.items||[]).find(S=>S&&S.kind==="string"&&S.type==="text/html");if(b&&typeof b.getAsString=="function"){b.getAsString(S=>{try{if(l(S))return}catch{}try{let p=r.clipboardData?.getData("text/plain")||"";d(p)}catch{}});return}}catch{}{let h=r.clipboardData?.getData("text/plain")||"";d(h)}}}),e.addEventListener("drop",r=>{if(u.mode!=="edit"||u.editingBlockId!==t){nn("drop ignored",{mode:u.mode,editingBlockId:u.editingBlockId,targetBlockId:t});return}let o=Array.from(r.dataTransfer?.files||[]);if(!o.length)return;let i=o.filter(a=>a.type?.startsWith("image/")),s=o.filter(a=>!a.type||!a.type.startsWith("image/"));!i.length&&!s.length||(r.preventDefault(),nn("drop: files detected",o.map(a=>({name:a.name,type:a.type,size:a.size}))),i.forEach(a=>Si(e,a,t)),s.forEach(a=>Zs(e,a,t)))}),e.addEventListener("click",r=>{let o=r.target?.closest("img");if(o){if(r.target?.closest(".resizable-image__handle")){r.preventDefault();return}r.preventDefault(),uo(o.src,o.alt||"");return}let i=r.target?.closest("a[href]");if(!i)return;let s=i.getAttribute("href")||"";if(!s.startsWith("app:/")&&!s.startsWith("disk:/"))return;r.preventDefault();let a=Jl(s);a&&window.open(a,"_blank","noopener,noreferrer")}),u.articleId==="inbox"&&e.addEventListener("click",async r=>{if(r.target?.closest(".move-block-btn")){r.preventDefault(),r.stopPropagation();try{let s=(u.articlesIndex.length?u.articlesIndex:await kn()).filter(d=>d.id!=="inbox").map(d=>({id:d.id,title:d.title||"\u0420\u2018\u0420\xB5\u0420\xB7 \u0420\u0405\u0420\xB0\u0420\xB7\u0420\u0406\u0420\xB0\u0420\u0405\u0420\u0451\u0421\u040F"})),a=await er({title:"\u0420\u045F\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451 \u0420\u0406 \u0421\u0403\u0421\u201A\u0420\xB0\u0421\u201A\u0421\u040A\u0421\u040B",message:"\u0420\u2019\u0420\u0406\u0420\xB5\u0420\u0491\u0420\u0451\u0421\u201A\u0420\xB5 ID \u0420\u0451\u0420\xBB\u0420\u0451 \u0420\u0406\u0421\u2039\u0420\xB1\u0420\xB5\u0421\u0402\u0420\u0451\u0421\u201A\u0420\xB5 \u0421\u0403\u0421\u201A\u0420\xB0\u0421\u201A\u0421\u040A\u0421\u040B",confirmText:"\u0420\u045F\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451",cancelText:"\u0420\u045B\u0421\u201A\u0420\u0458\u0420\xB5\u0420\u0405\u0420\xB0",suggestions:s,returnMeta:!0,hideConfirm:!1}),l=(a?.selectedId||(typeof a=="object"?a?.value:a)||""||"").trim();if(!l)return;await Et(`/api/articles/${u.articleId}/blocks/${t}/move-to/${l}`,{method:"POST"}),bn(rn.article("inbox"))}catch(i){Ie(i.message||"\u0420\u045C\u0420\xB5 \u0421\u0453\u0420\u0491\u0420\xB0\u0420\xBB\u0420\u0455\u0421\u0403\u0421\u040A \u0420\u0457\u0420\xB5\u0421\u0402\u0420\xB5\u0420\u0405\u0420\xB5\u0421\u0403\u0421\u201A\u0420\u0451 \u0420\xB1\u0420\xBB\u0420\u0455\u0420\u0454")}}}),e.addEventListener("dragover",r=>{if(u.mode!=="edit"||u.editingBlockId!==t)return;(Gs(r.dataTransfer?.items).length>0||Xs(r.dataTransfer?.items).length>0)&&r.preventDefault()}),e.addEventListener("keydown",r=>{if(u.mode!=="edit"||u.editingBlockId!==t)return;let o=window.getSelection();if(!o||o.rangeCount===0)return;let i=o.getRangeAt(0);if(!i||!i.collapsed||_l({event:r,element:e,range:i,selection:o,notifyEditingInput:Io,logDebug:nn})||r.key!=="Tab"||!(i.commonAncestorContainer?.nodeType===Node.ELEMENT_NODE?i.commonAncestorContainer:i.commonAncestorContainer?.parentElement)?.closest?.("li"))return;r.preventDefault(),r.stopPropagation();let c=r.shiftKey?"outdent":"indent";document.execCommand(c,!1,null)})}function Wl(){let e=window.getSelection();if(!e||e.rangeCount===0)return;let t=e.getRangeAt(0),n=t.commonAncestorContainer,o=(n?.nodeType===Node.ELEMENT_NODE?n:n?.parentElement)?.closest('.block-text[contenteditable="true"]');if(!o){Eo=null;return}let s=o.closest(".block")?.dataset?.blockId;if(u.mode!=="edit"||u.editingBlockId!==s){Eo=null;return}Eo=t.cloneRange()}function gp(){if(Qs)return Qs;Kl||(document.addEventListener("selectionchange",Wl),Kl=!0);let e=document.createElement("div");e.className="rich-context-menu hidden",e.innerHTML=`
	    <div class="rich-context-menu__col rich-context-menu__col--buffer">
	      <div class="rich-context-menu__grid">
	        <button class="rich-context-menu__icon-btn" data-action="copy" aria-label="\u041A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C" title="\u041A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C"><i class="bx bx-copy" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="cut" aria-label="\u0412\u044B\u0440\u0435\u0437\u0430\u0442\u044C" title="\u0412\u044B\u0440\u0435\u0437\u0430\u0442\u044C"><i class="bx bx-cut" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="paste" aria-label="\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C" title="\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C"><i class="bx bx-paste" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="select-all" aria-label="\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0432\u0441\u0451" title="\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0432\u0441\u0451"><i class="bx bx-select-multiple" aria-hidden="true"></i></button>
	      </div>
	    </div>
	    <div class="rich-context-menu__col">
	      <div class="rich-context-menu__grid">
	        <button class="rich-context-menu__icon-btn" data-action="bold" aria-label="\u041F\u043E\u043B\u0443\u0436\u0438\u0440\u043D\u044B\u0439" title="\u041F\u043E\u043B\u0443\u0436\u0438\u0440\u043D\u044B\u0439"><strong>\u0416</strong></button>
	        <button class="rich-context-menu__icon-btn" data-action="italic" aria-label="\u041A\u0443\u0440\u0441\u0438\u0432" title="\u041A\u0443\u0440\u0441\u0438\u0432"><em>/</em></button>
	        <button class="rich-context-menu__icon-btn" data-action="underline" aria-label="\u041F\u043E\u0434\u0447\u0435\u0440\u043A\u043D\u0443\u0442\u044C" title="\u041F\u043E\u0434\u0447\u0435\u0440\u043A\u043D\u0443\u0442\u044C"><u>\u0427</u></button>
	        <button class="rich-context-menu__icon-btn" data-action="remove-format" aria-label="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0444\u043E\u0440\u043C\u0430\u0442" title="\u041E\u0447\u0438\u0441\u0442\u0438\u0442\u044C \u0444\u043E\u0440\u043C\u0430\u0442"><i class="bx bx-eraser" aria-hidden="true"></i></button>
	      </div>
	    </div>
	    <div class="rich-context-menu__col">
	      <div class="rich-context-menu__grid">
	        <button class="rich-context-menu__icon-btn" data-action="ul" aria-label="\u041C\u0430\u0440\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A" title="\u041C\u0430\u0440\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A"><i class="bx bx-list-ul" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="ol" aria-label="\u041D\u0443\u043C\u0435\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A" title="\u041D\u0443\u043C\u0435\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0439 \u0441\u043F\u0438\u0441\u043E\u043A"><i class="bx bx-list-ol" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="quote" aria-label="\u0426\u0438\u0442\u0430\u0442\u0430" title="\u0426\u0438\u0442\u0430\u0442\u0430"><i class="bx bx-quote-left" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="code" aria-label="\u041A\u043E\u0434" title="\u041A\u043E\u0434"><i class="bx bx-code-alt" aria-hidden="true"></i></button>
	      </div>
	    </div>
	    <div class="rich-context-menu__col">
	      <div class="rich-context-menu__grid">
	        <button class="rich-context-menu__icon-btn" data-action="link" aria-label="\u0421\u0441\u044B\u043B\u043A\u0430" title="\u0421\u0441\u044B\u043B\u043A\u0430"><i class="bx bx-link" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="unlink" aria-label="\u0423\u0431\u0440\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443" title="\u0423\u0431\u0440\u0430\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443"><i class="bx bx-unlink" aria-hidden="true"></i></button>
	        <button class="rich-context-menu__icon-btn" data-action="insert-article-link" aria-label="\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E" title="\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E"><i class="bx bx-link-alt" aria-hidden="true"></i></button>
	      </div>
	    </div>
	    <div class="rich-context-menu__col">
	      <div class="rich-context-menu__grid">
	        <button class="rich-context-menu__icon-btn" data-action="split-at-caret" aria-label="\u0420\u0430\u0437\u0434\u0435\u043B\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043F\u043E \u043A\u0443\u0440\u0441\u043E\u0440\u0443" title="\u0420\u0430\u0437\u0434\u0435\u043B\u0438\u0442\u044C \u0431\u043B\u043E\u043A \u043F\u043E \u043A\u0443\u0440\u0441\u043E\u0440\u0443"><i class="bx bx-cut" aria-hidden="true"></i></button>
	      </div>
	    </div>
	  `,document.body.appendChild(e);let t=()=>{e.classList.add("hidden"),e.style.visibility="",Ot=null,Kr=null,ko=null},n=()=>{if(Ot){let o=window.getSelection();o.removeAllRanges(),o.addRange(Ot)}},r=async o=>{n();let i=()=>{if(Kr&&document.contains(Kr))return Kr;let h=window.getSelection()?.anchorNode?.parentElement?.closest(".block-text[contenteditable]");if(h)return h;if(Ot){let S=Ot.commonAncestorContainer;if(S?.parentElement){let p=S.parentElement.closest(".block-text[contenteditable]");if(p)return p}}if(ko&&document.contains(ko))return ko;if(u.editingBlockId){let S=document.querySelector(`.block[data-block-id="${u.editingBlockId}"] .block-text[contenteditable="true"]`);if(S)return S}let b=document.activeElement;if(b&&b.closest){let S=b.closest(".block-text[contenteditable]");if(S)return S}return null},s=d=>{Ul({listTag:d,resolveTarget:i,restoreSelection:n,richContextRange:Ot,notifyEditingInput:Io,setRichContextRange:m=>{Ot=m?m.cloneRange():null}})},a=async()=>{let d=i();if(!d){Ie("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0441\u0441\u044B\u043B\u043A\u0438");return}let m=u.articlesIndex.length?u.articlesIndex:await kn(),h=m.map(A=>({id:A.id,title:A.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),b="",S="";try{let A=await er({title:"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438. \u041F\u043E\u0434\u0441\u043A\u0430\u0437\u043A\u0438 \u043F\u043E\u043C\u043E\u0433\u0443\u0442 \u043D\u0430\u0439\u0442\u0438 \u043D\u0443\u0436\u043D\u0443\u044E.",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:h,returnMeta:!0,hideConfirm:!0});A&&typeof A=="object"?(b=A.value||"",S=A.selectedId||""):b=A||""}catch{b=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438")||""}let p=(b||"").trim().toLowerCase();if(!p&&!S)return;let f=m.find(A=>{let C=(A.title||"").toLowerCase();return S&&A.id===S||A.id&&A.id.toLowerCase()===p||C===p||C.includes(p)});if(!f){Ie("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}if(!d||!document.contains(d)){Ie("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438 \u0441\u0441\u044B\u043B\u043A\u0438");return}n(),d.focus();let w=`<a href="${rn.article(f.id)}" class="article-link" data-article-id="${f.id}">${Jt(f.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F")}</a>`;Jn(d,w);let x=(d.innerHTML||"").trim();(!x||x==="<br>"||x==="<br/>"||x==="<br />")&&(d.innerHTML=w),d.classList.remove("block-body--empty")},c=()=>{n();let d=window.getSelection();if(!(!d||d.rangeCount===0)){document.execCommand("removeFormat");for(let m=0;m<4;m+=1)document.execCommand("outdent");document.execCommand("formatBlock",!1,"p")}},l=d=>{let m=i();if(!m||!document.contains(m))return Ie("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u0442\u0435\u043A\u0441\u0442 \u0434\u043B\u044F \u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F"),null;let h=window.getSelection();if(!h||h.rangeCount===0)return null;let b=h.getRangeAt(0).cloneRange();if(!b||b.collapsed)return null;let S=b.cloneContents(),p=document.createElement("div");p.appendChild(S);let f=p.innerHTML||"",w=p.textContent||"",A=m.closest(".block")?.dataset.blockId||null;return qr={html:f,text:w,sourceBlockId:A},nn("clipboard.capture",{kind:d,hasHtml:!!f,length:w.length,blockId:A}),{range:b,target:m}};switch(o){case"cut":{if(!l("cut"))break;document.execCommand("cut");break}case"copy":l("copy"),document.execCommand("copy");break;case"select-all":{let d=i();if(!d||!document.contains(d))break;let m=document.createRange();m.selectNodeContents(d);let h=window.getSelection();h&&(h.removeAllRanges(),h.addRange(m)),Ot=m.cloneRange();break}case"paste":{let d=i();if(!d||!document.contains(d)){Ie("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043D\u0430\u0439\u0442\u0438 \u043C\u0435\u0441\u0442\u043E \u0432\u0441\u0442\u0430\u0432\u043A\u0438");break}if(!qr||!qr.html&&!qr.text){Ie("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u0441\u043A\u043E\u043F\u0438\u0440\u0443\u0439\u0442\u0435 \u0438\u043B\u0438 \u0432\u044B\u0440\u0435\u0436\u044C\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u0432 \u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440\u0435");break}n();let m=window.getSelection(),h=null;if(Ot&&d.contains(Ot.commonAncestorContainer))h=Ot.cloneRange();else if(m&&m.rangeCount>0){let f=m.getRangeAt(0);d.contains(f.commonAncestorContainer)&&(h=f.cloneRange())}h||(h=document.createRange(),h.selectNodeContents(d),h.collapse(!1));let b=qr.html||Jt(qr.text).replace(/\n/g,"<br />"),S=document.createElement("div");S.innerHTML=b;let p=document.createDocumentFragment();for(;S.firstChild;)p.appendChild(S.firstChild);h.deleteContents(),h.insertNode(p),h.collapse(!1),m&&(m.removeAllRanges(),m.addRange(h)),d.focus({preventScroll:!0}),d.classList.remove("block-body--empty");break}case"bold":document.execCommand("bold");break;case"italic":document.execCommand("italic");break;case"underline":document.execCommand("underline");break;case"ul":s("ul");break;case"ol":s("ol");break;case"quote":document.execCommand("formatBlock",!1,"blockquote");break;case"code":document.execCommand("formatBlock",!1,"pre");break;case"link":{let d=window.getSelection(),m=d?d.toString():"",h=d?.anchorNode,b=h?h.parentElement?.closest("a"):null,S=b?.getAttribute("href")||"",p=await us({title:"\u0421\u0441\u044B\u043B\u043A\u0430",textLabel:"\u0422\u0435\u043A\u0441\u0442",urlLabel:"\u0421\u0441\u044B\u043B\u043A\u0430",defaultText:m||b?.textContent||"",defaultUrl:S,confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430"});if(nn("link action: prompt result",{hasResult:!!p,url:p?.url,text:p?.text}),!p||!p.url)break;let f=p.url.match(/^[a-z]+:/i)?p.url:`https://${p.url}`,w=p.text?.trim()||f;n();let x=i();if(nn("link action: target",{targetExists:!!x,inDom:!!(x&&document.contains(x)),className:x?.className}),!x||!document.contains(x))break;let A=window.getSelection(),C=null;Ot&&x.contains(Ot.commonAncestorContainer)?C=Ot.cloneRange():A&&A.rangeCount>0&&x.contains(A.getRangeAt(0).commonAncestorContainer)&&(C=A.getRangeAt(0).cloneRange()),C||(C=document.createRange(),C.selectNodeContents(x),C.collapse(!1)),nn("link action: range chosen",{usedSelectionRange:!!(A&&A.rangeCount>0&&x.contains(A.getRangeAt(0).commonAncestorContainer)),usedStoredRange:!!(Ot&&x.contains(Ot.commonAncestorContainer)),selectionRangeCollapsed:!!(A&&A.rangeCount>0&&A.getRangeAt(0).collapsed),rangeStartNode:C?.startContainer?.nodeName,rangeOffset:C?.startOffset,labelLength:(w||"").length,url:f});let L=document.createElement("a");L.href=f,L.target="_blank",L.rel="noopener noreferrer",L.textContent=w,C.deleteContents(),C.insertNode(L),C.setStartAfter(L),C.setEndAfter(L),nn("link action: inserted link",{outerHTML:L.outerHTML,parentClass:L.parentElement?.className,targetInner:x.innerHTML.slice(0,120)}),A&&(A.removeAllRanges(),A.addRange(C)),x.focus({preventScroll:!0}),x.classList.remove("block-body--empty");break}case"unlink":{let d=i();if(nn("unlink action: target",{targetExists:!!d,inDom:!!(d&&document.contains(d)),className:d?.className}),!d||!document.contains(d))break;let m=window.getSelection(),h=null;if(m&&m.rangeCount>0){let b=m.getRangeAt(0).commonAncestorContainer;h=b?.parentElement?.closest("a")||b?.closest?.("a")}if(!h&&Ot){let b=Ot.commonAncestorContainer;h=b?.parentElement?.closest("a")||b?.closest?.("a")}if(h||(h=d.querySelector("a")),h){let b=document.createTextNode(h.textContent||"");h.replaceWith(b)}else document.execCommand("unlink");break}case"remove-format":c();break;case"insert-article-link":a().finally(()=>{t()});return;case"split-at-caret":await dl();break;default:break}t()};return e.addEventListener("click",o=>{let i=o.target.closest("button[data-action]");if(!i)return;let s=i.dataset.action;r(s)}),document.addEventListener("click",o=>{e.classList.contains("hidden")||e.contains(o.target)||t()}),document.addEventListener("touchstart",o=>{e.classList.contains("hidden")||e.contains(o.target)||t()},{passive:!0}),document.addEventListener("keydown",o=>{o.code==="Escape"&&t()}),window.addEventListener("scroll",t,!0),Qs=e,e}function Vl(e){let t=gp();t.classList.remove("hidden"),t.style.visibility="hidden",Wl();let n=window.getSelection();n&&n.rangeCount>0?Ot=n.getRangeAt(0).cloneRange():Eo?Ot=Eo.cloneRange():Ot=null;let r=t.getBoundingClientRect(),o=22,i=12,s=e.clientX+14,a=e.clientY+o;a+r.height+i>window.innerHeight&&(a=Math.max(i,e.clientY-r.height-o));let c=Math.min(Math.max(s,i),window.innerWidth-r.width-i),l=Math.min(Math.max(a,i),window.innerHeight-r.height-i);t.style.left=`${c}px`,t.style.top=`${l}px`,t.style.visibility="visible"}function jl(e,t,n){let r=n||e;e.addEventListener("focusin",()=>{ko=r}),e.addEventListener("contextmenu",s=>{u.mode!=="edit"||u.editingBlockId!==t||(s.preventDefault(),Kr=r,Vl(s))});let o=null;e.addEventListener("touchstart",s=>{if(u.mode!=="edit"||u.editingBlockId!==t||s.touches.length!==1)return;let a=s.touches[0];o=window.setTimeout(()=>{Kr=r,Vl({clientX:a.clientX,clientY:a.clientY})},500)},{passive:!0});let i=()=>{o!==null&&(clearTimeout(o),o=null)};e.addEventListener("touchend",i,{passive:!0}),e.addEventListener("touchcancel",i,{passive:!0})}async function Ls(e){if(!e)return;let t=St(e);if(!t)return;let n=(t.ancestors||[]).filter(r=>r.collapsed);for(let r of n)await wi(r.id,!1)}var lp,Qs,Ot,Kr,ko,qr,Eo,Kl,On=Ge(()=>{Bt();ln();en();gr();_n();tr();ln();nr();nr();Ds();Pl();Ws();Rl();Ys();zl();ql();lp=16;Qs=null,Ot=null,Kr=null,ko=null,qr={html:"",text:"",sourceBlockId:null},Eo=null,Kl=!1;Fl()});function yp(){let e=u?.currentUser||null;return e&&(e.id||e.username)||"anon"}async function xi(){return Ro({userKey:yp()})}async function Yl(e={}){let t=String(e?.token||"").trim(),n=String(e?.articleId||"").trim();if(!t||!n)return!1;let r=String(e?.kind||"image"),o=e?.blob||null,i=String(e?.mime||o&&o.type||"").trim(),s=String(e?.fileName||"").trim()||null,a=Date.now(),l=(await xi()).transaction(["pending_uploads"],"readwrite"),d=l.objectStore("pending_uploads"),m=await Re(d.get(t)).catch(()=>null),h=Number(m?.createdAtMs||e?.createdAtMs||a)||a,b={token:t,articleId:n,kind:r,blob:o,mime:i,fileName:s,status:String(e?.status||m?.status||"pending"),errorMessage:String(e?.errorMessage||m?.errorMessage||""),createdAtMs:h,updatedAtMs:a};return await Re(d.put(b)),await Xe(l),!0}async function ea(e){let t=String(e||"").trim();if(!t)return!1;let r=(await xi()).transaction(["pending_uploads"],"readwrite"),o=r.objectStore("pending_uploads");return await Re(o.delete(t)),await Xe(r),!0}async function ta(e,t){let n=String(e||"").trim();if(!n)return!1;let o=(await xi()).transaction(["pending_uploads"],"readwrite"),i=o.objectStore("pending_uploads"),s=await Re(i.get(n)).catch(()=>null);return s?(s.status="error",s.errorMessage=String(t||"error"),s.updatedAtMs=Date.now(),await Re(i.put(s)),await Xe(o),!0):(await Xe(o),!1)}async function na({articleId:e=null,limit:t=50}={}){let r=(await xi()).transaction(["pending_uploads"],"readonly"),o=r.objectStore("pending_uploads"),i=[];try{let s=Number(t||0)||0;if(e){let a=o.index("byArticleId");i=await Re(a.getAll(String(e),s>0?s:void 0))}else i=await Re(o.getAll(s>0?s:void 0))}catch{i=[]}return await Xe(r),Array.isArray(i)?(i.sort((s,a)=>Number(s?.createdAtMs||0)-Number(a?.createdAtMs||0)),i):[]}var Gl=Ge(()=>{Bt();Ji();Cn()});var Ai,Xl=Ge(()=>{Ai=["pending-attachment","app","disk"]});function ra(e){let n=String(e||"").replace(/\r\n/g,`
`).split(`
`),r=c=>{let l=String(c||"").match(/^(#{1,6})\s+(.*)$/);if(!l)return null;let d=String(l[2]||"").trim();return d?{level:l[1].length,title:d}:null},o=!1;try{let c=n.find(l=>String(l||"").trim().length>0)||"";o=!!r(c)}catch{o=!1}let i=[],s=null,a=()=>{if(s){try{for(;s.bodyLines.length&&!String(s.bodyLines[0]||"").trim();)s.bodyLines.shift()}catch{}s.bodyText=s.bodyLines.join(`
`).trimEnd(),delete s.bodyLines,i.push(s),s=null}};for(let c of n){let l=r(c);if(l){a(),s={level:l.level,title:l.title,bodyLines:[]};continue}s&&s.bodyLines.push(c)}return a(),{sections:i,startsWithHeading:o,headingCount:i.length}}function Ql(e,t={}){let n=Array.isArray(e)?e.filter(Boolean):[],r=typeof t.makeId=="function"?t.makeId:()=>`${Date.now()}-${Math.random()}`;if(!n.length)return[];let o=Number.isFinite(t.baseLevel)?t.baseLevel:Number(n[0].level||1),i=[],s=[];for(let a of n){let c=Number(a.level||1),l=String(a.title||"").trim(),d=String(a.bodyText||"").trimEnd();if(!l)continue;let m=Math.max(0,c-o);for(;s.length>m;)s.pop();m>s.length&&(m=s.length);let h={id:r(),title:l,bodyText:d,children:[]},b=m>0?s[m-1]:null;b?b.children.push(h):i.push(h),s.push(h)}return i}var Zl=Ge(()=>{});var ca={};Do(ca,{flushOutboxOnce:()=>Vr,getBackgroundFullPullStatus:()=>Tp,startBackgroundFullPull:()=>Rp,startSyncLoop:()=>Op,tryPullBootstrap:()=>Np});function bp(e,t=null){try{if(!e)return;let n=window.localStorage.getItem(Ii)||"";if(!n)return;let r=JSON.parse(n);if(!r||typeof r!="object")return;let o=String(e),i=r[o]||null;if(!i)return;let s=Number(i?.queuedAt||0)||0,a=typeof t=="number"&&Number.isFinite(t)?t:null;if(a!=null&&s>a)return;delete r[o],window.localStorage.setItem(Ii,JSON.stringify(r))}catch{}}function xp(e,t){try{let n=e&&typeof e=="object"?e:{type:"doc",content:[]},r=Array.isArray(n.content)?n.content:[],o=new Map,i=d=>{if(Array.isArray(d))for(let m of d){if(!m||typeof m!="object"||m.type!=="outlineSection")continue;let h=String(m?.attrs?.id||"").trim();h&&o.set(h,m);let S=(Array.isArray(m.content)?m.content:[]).find(p=>p&&typeof p=="object"&&p.type==="outlineChildren")||null;S&&Array.isArray(S.content)&&i(S.content)}};i(r);let s=(d,m)=>{let h=d&&typeof d=="object"?d:{type:"outlineSection",attrs:{id:m,collapsed:!1},content:[]};h.type="outlineSection";let b=h.attrs&&typeof h.attrs=="object"?h.attrs:{};b.id=m,h.attrs=b;let S=Array.isArray(h.content)?h.content:[],p=S.find(x=>x&&typeof x=="object"&&x.type==="outlineHeading")||{type:"outlineHeading",content:[]},f=S.find(x=>x&&typeof x=="object"&&x.type==="outlineBody")||{type:"outlineBody",content:[{type:"paragraph"}]},w=S.find(x=>x&&typeof x=="object"&&x.type==="outlineChildren")||{type:"outlineChildren",content:[]};return Array.isArray(w.content)||(w={...w,content:[]}),h.content=[p,f,w],h},a=new Set,c=new Map;for(let d of Array.isArray(t)?t:[]){let m=String(d?.sectionId||"").trim();if(!m)continue;let h=d?.parentId,b=h!=null&&String(h).trim()?String(h).trim():null,S=Number.isFinite(Number(d?.position))?Number(d.position):0,p=!!d?.collapsed,f=s(o.get(m),m);f.attrs={...f.attrs||{},id:m,collapsed:p},o.set(m,f),a.add(m),c.has(b)||c.set(b,[]),c.get(b).push({pos:S,sid:m,sec:f})}for(let[d,m]of c.entries())m.sort((h,b)=>h.pos-b.pos||String(h.sid).localeCompare(String(b.sid))),c.set(d,m);for(let[d,m]of o.entries()){let b=(c.get(d)||[]).map(S=>S.sec);try{Array.isArray(m.content)||(m.content=[]),(!m.content[2]||m.content[2].type!=="outlineChildren")&&(m.content[2]={type:"outlineChildren",content:[]}),m.content[2].content=b}catch{}}let l=(c.get(null)||[]).map(d=>d.sec);for(let[d,m]of o.entries())a.has(d)||l.push(m);return n.type="doc",n.content=l,n}catch{return e}}function Ap(e,t,n,r){try{let o=String(t||"").trim();if(!o)return e;let i=e&&typeof e=="object"?e:{type:"doc",content:[]},s=[i];for(;s.length;){let a=s.pop();if(!a||typeof a!="object")continue;if(a.type==="outlineSection"&&String(a?.attrs?.id||"").trim()===o){let d=(Array.isArray(a.content)?a.content:[]).find(m=>m&&typeof m=="object"&&m.type==="outlineChildren")||{type:"outlineChildren",content:[]};return a.content=[n,r,d],i}let c=a.content;if(Array.isArray(c))for(let l of c)s.push(l)}return i}catch{return e}}function aa(e){let t=e?.type||"";return t==="section_upsert_content"||t==="delete_sections"||t==="structure_snapshot"}function Ip(e,t,n){try{let r=String(e||"").trim(),o=String(t||"").trim(),i=Number(n);if(!r||!o||!Number.isFinite(i)||i<=0)return;let s="ttree_outline_section_seq_v1",a=window.localStorage.getItem(s)||"",c=a?JSON.parse(a):{},l=c&&typeof c=="object"?c:{},d=(l[r]&&typeof l[r]=="object"?l[r]:{})||{};if((Number(d[o]||0)||0)>=i)return;d[o]=i,l[r]=d,window.localStorage.setItem(s,JSON.stringify(l))}catch{}}function kp(e){let t=[],n=(i,s)=>{if(!Array.isArray(i))return;let a=0;for(let c of i){if(!c||typeof c!="object"||c.type!=="outlineSection")continue;let l=String(c?.attrs?.id||"").trim();if(!l)continue;t.push({sectionId:l,parentId:s||null,position:a,collapsed:!!c?.attrs?.collapsed}),a+=1;let m=(Array.isArray(c.content)?c.content:[]).find(b=>b&&typeof b=="object"&&b.type==="outlineChildren")||null,h=m&&Array.isArray(m.content)?m.content:[];n(h,l)}},r=e&&typeof e=="object"?e:null,o=r&&Array.isArray(r.content)?r.content:[];return n(o,null),t}function Ep(e,t){try{let n=e&&typeof e=="object"?{...e}:null;if(!n||n.type!=="outlineHeading")return e;let r=String(t||"");if(!r)return e;let o=Array.isArray(n.content)?[...n.content]:[];return o.unshift({type:"text",text:r}),n.content=o,n}catch{return e}}function Cp(e,t,n){let r=e&&typeof e=="object"?e:{type:"doc",content:[]};Array.isArray(r.content)||(r.content=[]);let o=String(t||"").trim(),i=a=>{for(let c=0;c<a.length;c+=1){let l=a[c];if(!l||typeof l!="object"||l.type!=="outlineSection")continue;let d=String(l?.attrs?.id||"").trim();if(o&&d===o)return a.splice(c+1,0,n),!0;let h=(Array.isArray(l.content)?l.content:[]).find(b=>b&&typeof b=="object"&&b.type==="outlineChildren")||null;if(h&&Array.isArray(h.content)&&i(h.content))return!0}return!1};return i(r.content)||r.content.push(n),r}function vp(){try{return window?.localStorage?.getItem?.("ttree_debug_offline_v1")==="1"}catch{return!1}}function od(...e){try{if(!vp())return;console.log("[offline][queue]",...e)}catch{}}function sd(){try{let e=window.localStorage.getItem(Ii)||"";if(!e)return{changed:!1,removed:0};let t=JSON.parse(e);if(!t||typeof t!="object")return{changed:!1,removed:0};let n=Object.keys(t);if(!n.length)return{changed:!1,removed:0};let r=0;for(let o of n)o!=="inbox"&&(delete t[o],r+=1);return r?(window.localStorage.setItem(Ii,JSON.stringify(t)),od("prune.queue",{removed:r}),{changed:!0,removed:r}):{changed:!1,removed:0}}catch(e){return od("prune.queue.error",{message:e?.message||String(e||"error")}),{changed:!1,removed:0}}}function cr(){try{window.dispatchEvent(new CustomEvent("offline-full-pull-status",{detail:{...Lt}}))}catch{}}function Tp(){return{...Lt}}async function fn(e,t={}){let n=await fetch(e,{headers:{"Content-Type":"application/json",...t.headers||{}},credentials:"include",...t});if(!n.ok){let r=await n.json().catch(()=>({})),o=new Error(r.detail||"Request failed");throw o.status=n.status,o.details=r,o.path=e,o}return n.status===204?null:n.json()}function id(e){let t=Number(e?.status||0);return!t||t>=500||t===408||t===429||t===401||t===403}function Bp(e,t){let n=Number(e?.status||0);return n===404||n===410?!0:n>=400&&n<500&&n!==401&&n!==403&&n!==408&&n!==429?t?.type==="save_doc_json"||String(t?.type||"").startsWith("section_")||t?.type==="structure_snapshot"||t?.type==="delete_sections":!1}async function Np(){try{let e=await kn();return zn(e).catch(()=>{}),Array.isArray(e)?e:[]}catch{return null}}function Mp(e,t){try{let n=new Set((Array.isArray(t)?t:[]).map(i=>String(i||"").trim()).filter(Boolean));if(!n.size)return e;let r=e&&typeof e=="object"?e:{type:"doc",content:[]},o=i=>{if(!Array.isArray(i))return[];let s=[];for(let a of i)if(!(!a||typeof a!="object")){if(a.type==="outlineSection"){let c=String(a?.attrs?.id||"").trim();if(c&&n.has(c))continue;let d=(Array.isArray(a.content)?a.content:[]).find(m=>m&&typeof m=="object"&&m.type==="outlineChildren")||null;d&&Array.isArray(d.content)&&(d.content=o(d.content))}s.push(a)}return s};return Array.isArray(r.content)?r.content=o(r.content):r.content=[],r.type=r.type||"doc",r}catch{return e}}async function Lp(e){if(e.type==="create_article"){let t=e.payload?.title||"\u041D\u043E\u0432\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F",n=e.payload?.id||e.articleId,r=e.payload?.parentId??null,o=await fn("/api/articles",{method:"POST",body:JSON.stringify({title:t,id:n,parentId:r})});await Dr(o);return}if(e.type==="save_doc_json"){let t=e.payload?.docJson||null;if(!t||typeof t!="object")return;let n=await fn(`/api/articles/${encodeURIComponent(e.articleId)}/doc-json/save`,{method:"PUT",body:JSON.stringify({docJson:t,createVersionIfStaleHours:12})}),r=n?.updatedAt||null;await gn(e.articleId,t,r);try{dt("sync.flush.save_doc_json.ok",{articleId:e.articleId,opId:e.id,updatedAt:r,docHash:$t(t)})}catch{}try{let o=Array.isArray(n?.changedBlockIds)?n.changedBlockIds:[],i=Array.isArray(n?.removedBlockIds)?n.removedBlockIds:[];if(i.length&&await jo(i),o.length){let s=await fn(`/api/articles/${encodeURIComponent(e.articleId)}/embeddings?ids=${encodeURIComponent(o.join(","))}`);await is(e.articleId,s?.embeddings||[])}}catch{}return}if(e.type==="section_upsert_content"){let t=e.payload?.sectionId||null,n=e.payload?.headingJson||null,r=e.payload?.bodyJson||null,o=e.payload?.seq||null;if(!t||!n||!r||!o)return;let i=await fn(`/api/articles/${encodeURIComponent(e.articleId)}/sections/upsert-content`,{method:"PUT",body:JSON.stringify({opId:e.payload?.opId||e.id,sectionId:t,headingJson:n,bodyJson:r,seq:o,createVersionIfStaleHours:12})});try{if(i?.updatedAt){let s=await jn(e.articleId).catch(()=>null),a=s?.docJson&&typeof s.docJson=="object"?s.docJson:null;if(a){let c=Ap(a,t,n,r);await gn(e.articleId,c,i.updatedAt)}}try{dt("sync.flush.section_upsert_content.ok",{articleId:e.articleId,opId:e.id,sectionId:t,updatedAt:i?.updatedAt||null})}catch{}}catch{}return}if(e.type==="structure_snapshot"){let t=e.payload?.nodes||null;if(!Array.isArray(t)||!t.length)return;let n=await fn(`/api/articles/${encodeURIComponent(e.articleId)}/structure/snapshot`,{method:"PUT",body:JSON.stringify({opId:e.payload?.opId||e.id,nodes:t})});try{if(n?.updatedAt){let r=await jn(e.articleId).catch(()=>null),o=r?.docJson&&typeof r.docJson=="object"?r.docJson:null;if(o){let i=xp(o,t);await gn(e.articleId,i,n.updatedAt)}}try{dt("sync.flush.structure_snapshot.ok",{articleId:e.articleId,opId:e.id,updatedAt:n?.updatedAt||null,nodesCount:Array.isArray(t)?t.length:null})}catch{}}catch{}return}if(e.type==="delete_sections"){let t=Array.isArray(e.payload?.sectionIds)?e.payload.sectionIds:[];if(!t.length)return;let n=await wc(e.articleId,t,{opId:e.payload?.opId||e.id});try{let r=n?.updatedAt||null,o=await jn(e.articleId).catch(()=>null),i=o?.docJson&&typeof o.docJson=="object"?o.docJson:null;if(i&&r){let a=Mp(i,t);await gn(e.articleId,a,r)}let s=Array.isArray(n?.removedBlockIds)?n.removedBlockIds:[];s.length&&await jo(s),dt("sync.flush.delete_sections.ok",{articleId:e.articleId,opId:e.id,updatedAt:r||null,sectionIdsCount:t.length,removedCount:s.length})}catch{}return}if(e.type==="move_article_position"){let t=e.payload?.direction||null;if(!t)return;await fn(`/api/articles/${encodeURIComponent(e.articleId)}/move`,{method:"POST",body:JSON.stringify({direction:t})});return}if(e.type==="indent_article"){await fn(`/api/articles/${encodeURIComponent(e.articleId)}/indent`,{method:"POST",body:JSON.stringify({})});return}if(e.type==="outdent_article"){await fn(`/api/articles/${encodeURIComponent(e.articleId)}/outdent`,{method:"POST",body:JSON.stringify({})});return}if(e.type==="move_article_tree"){await fn(`/api/articles/${encodeURIComponent(e.articleId)}/move-tree`,{method:"POST",body:JSON.stringify(e.payload||{})});return}}async function Pp(e){try{if(!e||!e.articleId||!(e.type==="save_doc_json"||e.type==="section_upsert_content"||e.type==="structure_snapshot"||e.type==="delete_sections"))return;let n=e.payload?.clientQueuedAt??null;if(typeof n!="number"||!Number.isFinite(n)||(await hr(500)||[]).some(i=>i&&i.articleId===e.articleId&&(i.type==="save_doc_json"||i.type==="section_upsert_content"||i.type==="structure_snapshot")&&(i.payload?.clientQueuedAt??null)===n))return;bp(e.articleId,n)}catch{}}async function _p(e,t){let n=String(e||"").trim();if(n)for(let r of t||[])try{let o=String(r?.sectionId||"").trim(),i=r?.headingJson||null,s=r?.bodyJson||null;if(!o||!i||!s)continue;let a=globalThis.crypto?.randomUUID?.()||`conflict-${Date.now()}-${Math.random().toString(16).slice(2)}`,c=await jn(n).catch(()=>null),l=c?.docJson&&typeof c.docJson=="object"?c.docJson:null,d=Ep(i,"\u041A\u043E\u043D\u0444\u043B\u0438\u043A\u0442\u043D\u0430\u044F \u043A\u043E\u043F\u0438\u044F: "),h=Cp(l||{type:"doc",content:[]},o,{type:"outlineSection",attrs:{id:a,collapsed:!1,isConflictCopy:!0},content:[d||{type:"outlineHeading",content:[]},s||{type:"outlineBody",content:[{type:"paragraph"}]},{type:"outlineChildren",content:[]}]});await gn(n,h,c?.updatedAt||null).catch(()=>{}),Ip(n,a,1);let b=Date.now();await tn("section_upsert_content",{articleId:n,payload:{sectionId:a,headingJson:d,bodyJson:s,seq:1,clientQueuedAt:b},coalesceKey:`content:${n}:${a}`}).catch(()=>{});let S=kp(h);S.length&&await tn("structure_snapshot",{articleId:n,payload:{nodes:S,clientQueuedAt:b},coalesceKey:`structure:${n}`}).catch(()=>{});try{window.dispatchEvent(new CustomEvent("outline-sync-conflict",{detail:{articleId:n,sectionId:o,conflictCopySectionId:a}}))}catch{}}catch{}}async function Dp(e,t){let n=String(e||"").trim();if(!n)return;let r=Date.now(),o=Number(nd.get(n)||0)||0;if(o&&r-o<Sp)return;nd.set(n,r);let i=async()=>{let p=await hr(200),f=[],w=[],x=[];for(let A of p||[])!A||String(A.articleId||"")!==n||(A.type==="delete_sections"?f.push(A):A.type==="section_upsert_content"?w.push(A):A.type==="structure_snapshot"&&x.push(A));return{deleteOps:f,upsertOps:w,structureOps:x}},s=0,a=[],c=[],l=[];try{({deleteOps:a,upsertOps:c,structureOps:l}=await i())}catch{a=[],c=[],l=[];for(let p of t||[])!p||String(p.articleId||"")!==n||(p.type==="delete_sections"?a.push(p):p.type==="section_upsert_content"?c.push(p):p.type==="structure_snapshot"&&l.push(p))}let d=new Set;for(let p of a){let f=Array.isArray(p.payload?.sectionIds)?p.payload.sectionIds:[];for(let w of f){let x=String(w||"").trim();x&&d.add(x)}}if(d.size&&c.length)for(let p of c)try{let f=String(p.payload?.sectionId||"").trim();f&&d.has(f)&&await Zn(p.id)}catch{}let m=a.map(p=>{let f=Array.isArray(p.payload?.sectionIds)?p.payload.sectionIds:[];return{opId:p.payload?.opId||p.id,sectionIds:f.filter(Boolean).map(w=>String(w)),_outboxId:p.id}}).filter(p=>p.sectionIds.length),h=c.map(p=>{let f=String(p.payload?.sectionId||"").trim();return!f||d.has(f)?null:{opId:p.payload?.opId||p.id,sectionId:f,headingJson:p.payload?.headingJson||null,bodyJson:p.payload?.bodyJson||null,seq:p.payload?.seq||null,clientQueuedAt:p.payload?.clientQueuedAt??null,_outboxId:p.id}}).filter(Boolean),b=async()=>{let p=a.map(U=>{let F=Array.isArray(U.payload?.sectionIds)?U.payload.sectionIds:[];return{opId:U.payload?.opId||U.id,sectionIds:F.filter(Boolean).map(X=>String(X)),_outboxId:U.id}}).filter(U=>U.sectionIds.length),f=c.map(U=>{let F=String(U.payload?.sectionId||"").trim();return!F||d.has(F)?null:{opId:U.payload?.opId||U.id,sectionId:F,headingJson:U.payload?.headingJson||null,bodyJson:U.payload?.bodyJson||null,seq:U.payload?.seq||null,clientQueuedAt:U.payload?.clientQueuedAt??null,_outboxId:U.id}}).filter(Boolean),w=new Map;for(let U of p)w.set(String(U.opId),U._outboxId);for(let U of f)w.set(String(U.opId),U._outboxId);if(!p.length&&!f.length)return!1;try{dt("sync.flush.outline_compact.start",{articleId:n,deletesCount:p.length,upsertsCount:f.length})}catch{}let x=await fn(`/api/articles/${encodeURIComponent(n)}/sync/compact`,{method:"PUT",body:JSON.stringify({deletes:p.map(({opId:U,sectionIds:F})=>({opId:U,sectionIds:F})),upserts:f.map(({opId:U,sectionId:F,headingJson:X,bodyJson:G,seq:oe})=>({opId:U,sectionId:F,headingJson:X,bodyJson:G,seq:oe}))})}),A=x?.updatedAt||null;A&&await rs(n,A).catch(()=>{});try{dt("sync.flush.outline_compact.ok",{articleId:n,updatedAt:A||null,deleteAcks:Array.isArray(x?.deleteAcks)?x.deleteAcks.length:null,upsertAcks:Array.isArray(x?.upsertAcks)?x.upsertAcks.length:null})}catch{}let C=Array.isArray(x?.deleteAcks)?x.deleteAcks:[];for(let U of C){let F=String(U?.opId||"").trim();if(!F)continue;let X=w.get(F)||F;await Zn(X).catch(()=>{});try{let G=Array.isArray(U?.removedBlockIds)?U.removedBlockIds:[];G.length&&await jo(G)}catch{}}let L=[],H=Array.isArray(x?.upsertAcks)?x.upsertAcks:[];for(let U of H){let F=String(U?.opId||"").trim(),X=String(U?.sectionId||"").trim();if(!F||!X)continue;let G=w.get(F)||F,oe=String(U?.result||"").trim();if(oe==="ok"||oe==="duplicate")await Zn(G).catch(()=>{});else if(oe==="conflict"){await Zn(G).catch(()=>{});let we=f.find(Ce=>String(Ce.opId)===F)||null;we&&L.push({sectionId:X,headingJson:we.headingJson,bodyJson:we.bodyJson})}}return L.length&&await _p(n,L),!0};for(;s<2&&(s+=1,!!await b());)try{({deleteOps:a,upsertOps:c,structureOps:l}=await i())}catch{break}let S=null;try{({deleteOps:a,upsertOps:c,structureOps:l}=await i())}catch{}if(!a.length&&!c.length&&(S=l.length?l[l.length-1]:null),S){try{let f=Number(rd.get(n)||0)||0,w=Date.now();if(f&&w-f<wp)return}catch{}let p=S.payload?.nodes||null;if(Array.isArray(p)&&p.length){try{dt("sync.flush.structure_snapshot.start",{articleId:n,opId:S.id,nodesCount:p.length})}catch{}let f=await fn(`/api/articles/${encodeURIComponent(n)}/structure/snapshot`,{method:"PUT",body:JSON.stringify({opId:S.payload?.opId||S.id,nodes:p})}),w=f?.updatedAt||null;w&&await rs(n,w).catch(()=>{}),Number.isFinite(Number(f?.newStructureRev))?await os(n,Number(f.newStructureRev)):Number.isFinite(Number(f?.currentStructureRev))&&await os(n,Number(f.currentStructureRev));try{dt("sync.flush.structure_snapshot.done",{articleId:n,opId:S.id,status:String(f?.status||""),updatedAt:w||null,newStructureRev:Number.isFinite(Number(f?.newStructureRev))?Number(f.newStructureRev):null,currentStructureRev:Number.isFinite(Number(f?.currentStructureRev))?Number(f.currentStructureRev):null})}catch{}let x=String(f?.status||"");if(x==="ok"||x==="duplicate"){await Zn(S.id).catch(()=>{});try{rd.set(n,Date.now())}catch{}}}}try{(await hr(200)||[]).some(w=>aa(w)&&String(w.articleId||"")===n)||(await ac(n).catch(()=>{}),dt("sync.flush.localDraft.cleared",{articleId:n}))}catch{}}async function Vr(){if(oa)return null;if(!navigator.onLine)return!1;oa=!0;try{let e=await hr(200),t=new Set,n=[];for(let o of e||[]){if(!aa(o))continue;let i=String(o.articleId||"").trim();!i||t.has(i)||(t.add(i),n.push(i))}for(let o of n)try{await Dp(o,e)}catch(i){if(id(i))break}let r=await hr(50);for(let o of r)if(!aa(o))try{await Lp(o),await Zn(o.id);try{if(o.type==="section_upsert_content"&&String(o.articleId||"")==="inbox"){let i=String(o.payload?.sectionId||"").trim();i&&vl(i)}}catch{}await Pp(o)}catch(i){let s=Number(i?.status||0)||null,a=s?`${s}: ${i?.message||"error"}`:i?.message||String(i||"error");if(await Za(o.id,a),Bp(i,o)){try{console.warn("[offline][outbox] drop op",{opId:o.id,type:o.type,articleId:o.articleId,status:s,message:i?.message||null})}catch{}try{await Zn(o.id)}catch{}continue}if(id(i))break;break}}finally{oa=!1}try{let e=await hr(1);return Array.isArray(e)&&e.length>0}catch{return!0}}function Co(){wr||(wr=window.setInterval(async()=>{try{await Vr()===!1&&(window.clearInterval(wr),wr=null,sd())}catch{}},15e3))}function sa(){wr&&(window.clearInterval(wr),wr=null)}function Op(){if(!ed){ed=!0,sd();try{Ya()}catch{}window.addEventListener("online",()=>{Vr().then(e=>{e?Co():sa()}).catch(()=>{})}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&Vr().then(e=>{e?Co():sa()}).catch(()=>{})}),window.addEventListener("offline-outbox-changed",()=>{Vr().then(e=>{e?Co():sa()}).catch(()=>{Co()})}),Vr().then(e=>{e&&Co()}).catch(()=>{})}}function Rp(e={}){let t=!!(e&&e.force);ia||td&&!t||(td=!0,ia=!0,Lt={running:!0,processed:0,total:0,errors:0,phase:"index",lastError:null,startedAt:new Date().toISOString(),finishedAt:null},cr(),(async()=>{try{if(!navigator.onLine){Lt={...Lt,running:!1,phase:"error",lastError:"offline",finishedAt:new Date().toISOString()},cr();return}let n=new Map;try{let o=await ic();n=new Map((o||[]).map(i=>[i.id,i]))}catch{}let r=[];try{Array.isArray(e?.initialIndex)?r=e.initialIndex:r=await fn("/api/articles")||[],zn(r).catch(()=>{})}catch(o){Lt={...Lt,running:!1,phase:"error",lastError:o?.message||String(o||"error"),finishedAt:new Date().toISOString()},cr();return}Lt={...Lt,phase:"articles",total:Array.isArray(r)?r.length:0},cr();for(let o of r||[]){try{let i=o.updatedAt||null,s=n.get(o.id);if(i&&s?.updatedAt===i&&s?.hasDocJson){try{let c=await jn(o.id),l=c?.docJson&&typeof c.docJson=="object"?c.docJson:null;l&&Lr(o.id,l).catch(()=>{})}catch{}continue}let a=await fn(`/api/articles/${encodeURIComponent(o.id)}`);await Dr(a);try{let c=await fn(`/api/articles/${encodeURIComponent(o.id)}/embeddings`);await is(o.id,c?.embeddings||[])}catch{}}catch{Lt={...Lt,errors:Number(Lt.errors||0)+1}}Lt={...Lt,processed:Number(Lt.processed||0)+1},cr(),await new Promise(i=>setTimeout(i,120))}try{Lt={...Lt,phase:"inbox"},cr();let o=await fn("/api/articles/inbox?include_history=0");await Dr(o)}catch{Lt={...Lt,errors:Number(Lt.errors||0)+1},cr()}Ga().catch(()=>{}),Lt={...Lt,running:!1,phase:"done",finishedAt:new Date().toISOString()},cr()}finally{ia=!1}})().catch(()=>{}))}var Ii,ed,oa,td,ia,wr,Sp,nd,wp,rd,Lt,la=Ge(()=>{Or();Pr();ss();Qi();ln();js();io();Ii="ttree_outline_autosave_queue_docjson_v1";ed=!1,oa=!1,td=!1,ia=!1,wr=null,Sp=2e3,nd=new Map,wp=3e3,rd=new Map;Lt={running:!1,processed:0,total:0,errors:0,phase:"idle",lastError:null,startedAt:null,finishedAt:null}});var di={};Do(di,{closeOutlineEditor:()=>Xd,enterOutlineSectionEditMode:()=>Km,flushOutlineAutosave:()=>Wm,getOutlineActiveSectionId:()=>Rm,getOutlineActiveSectionSnapshot:()=>Hm,insertNewOutlineSectionAtEnd:()=>qm,insertNewOutlineSectionAtStart:()=>Vm,insertOutlineSectionFromPlainTextAtStart:()=>jm,insertOutlineSectionFromSectionFragmentsAtEnd:()=>Um,openOutlineEditor:()=>Jm,openPublicOutlineViewer:()=>Ym,restoreOutlineSectionFromBlockHtml:()=>Fm,restoreOutlineSectionFromSectionFragments:()=>zm,revealOutlineSection:()=>Gd});function Bi(e,t){let n=null,r=String(t||"").trim();return!e||!r?null:(e.descendants((o,i)=>{if(n!==null)return!1;o?.type?.name==="image"&&String(o.attrs?.uploadToken||"")===r&&(n=i)}),n)}function zp(e){let t=String(e||"").trim();if(!t)return;let n=vr.get(t)||null;if(n){vr.delete(t);try{URL.revokeObjectURL(n)}catch{}}}function Cd(e,t=3e4){let n=String(e||"").trim();if(n){try{let r=No.get(n)||null;r&&clearTimeout(r)}catch{}try{let r=setTimeout(()=>{try{No.delete(n)}catch{}zp(n)},Math.max(0,Number(t)||0));No.set(n,r)}catch{}}}function ba(e){if(!e)return!1;if(e.type&&String(e.type).startsWith("image/"))return!0;let t=String(e.name||"").toLowerCase();return!!(t&&/\.(png|jpe?g|gif|webp|bmp|svg|heic|heif)$/i.test(t))}function vd(e,t){try{let n=e?.state?.schema,r=n?.nodes?.image||null;if(!n||!r)return Ie("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435"),!1;let o=`upl-${Date.now()}-${Math.random().toString(16).slice(2)}`,i=URL.createObjectURL(t);try{vr.set(o,i)}catch{}try{let f=Nt||u.articleId||null;Yl({token:o,articleId:f,kind:"image",blob:t,fileName:t?.name||"image",mime:t?.type||""})}catch{}let s=r.create({src:i,alt:t?.name||"image",width:320,uploadToken:o}),a=qe?.pmStateMod?.TextSelection,c=e.state.tr,l=c.selection.from,d=c.selection.to,m="\xA0\xA0";d>l&&(c=c.delete(l,d));let h=Math.max(0,Math.min(c.doc.content.size,l));c=c.insertText(m,h,h);let b=Math.max(0,Math.min(c.doc.content.size,h+m.length));c=c.replaceRangeWith(b,b,s);let S=Math.max(0,Math.min(c.doc.content.size,b+s.nodeSize));c=c.insertText(m,S,S);let p=Math.max(0,Math.min(c.doc.content.size,S+m.length));a&&(c=c.setSelection(a.create(c.doc,p))),c=c.setMeta(ue,!0),e.dispatch(c.scrollIntoView());try{let f=new Image;f.decoding="async",f.onload=()=>{try{let w=Number(f.naturalWidth||0),x=Number(f.naturalHeight||0);if(!(w>0&&x>0))return;let A=w/x,C=Bi(e.state.doc,o);if(typeof C!="number")return;let L=e.state.doc.nodeAt(C);if(!L||L.type?.name!=="image"||Number.isFinite(Number(L.attrs?.aspectRatio))&&Number(L.attrs.aspectRatio)>0)return;let H={...L.attrs,aspectRatio:A},U=e.state.tr.setNodeMarkup(C,void 0,H);U=U.setMeta(ue,!0),e.dispatch(U)}catch{}},f.onerror=()=>{},f.src=i}catch{}try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1)return Ie("\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u043E \u0438 \u0431\u0443\u0434\u0435\u0442 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E \u043F\u0440\u0438 \u043F\u043E\u044F\u0432\u043B\u0435\u043D\u0438\u0438 \u0441\u0435\u0442\u0438"),!0}catch{}return ao(t).then(f=>{let w=String(f?.url||"").trim();if(!w)throw new Error("Upload failed");let x=Bi(e.state.doc,o);if(typeof x!="number")return;let A=e.state.doc.nodeAt(x);if(!A||A.type?.name!=="image")return;let C={...A.attrs,src:w,uploadToken:null},L=e.state.tr.setNodeMarkup(x,void 0,C);L=L.setMeta(ue,!0),e.dispatch(L),Cd(o),ea(o).catch(()=>{})}).catch(f=>{Ie(f?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435");try{let w=Bi(e.state.doc,o);if(typeof w!="number")return;let x=e.state.doc.nodeAt(w);if(!x||x.type?.name!=="image")return;let A=String(x.attrs?.title||"").trim(),C=A?`${A} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",L=String(x.attrs?.alt||t?.name||"image"),H={...x.attrs,src:i,alt:L,title:C,uploadToken:o},U=e.state.tr.setNodeMarkup(w,void 0,H);U=U.setMeta(ue,!0),e.dispatch(U)}catch{}try{ta(o,String(f?.message||f||"error"))}catch{}}),!0}catch{return!1}}function Td(e,t){try{let n=e?.state?.schema,r=n?.marks?.link||null;if(!n||!r)return Ie("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0432\u043B\u043E\u0436\u0435\u043D\u0438\u0435: \u043D\u0435\u0442 \u0441\u0445\u0435\u043C\u044B \u0441\u0441\u044B\u043B\u043E\u043A"),!1;if(!u.articleId)return Ie("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E"),!1;let o=Wt(),i=`pending-attachment:${String(o||"")}`,s=String(t?.name||"\u0444\u0430\u0439\u043B"),a=`${s} (\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430...)`,{from:c,to:l}=e.state.selection,d=e.state.tr.insertText(a,c,l);d=d.addMark(c,c+a.length,r.create({href:i})),d=d.setMeta(ue,!0),e.dispatch(d.scrollIntoView());let m=null;try{m=(Ee?.getState?.(e.state)||null)?.editingSectionId||null}catch{m=null}let h=(b,S)=>{let p=`pending-attachment:${String(S||"")}`,f=b?.type?.schema?.marks?.link||null;if(!f)return null;let w=null;return b.descendants((x,A)=>{if(w)return!1;!x||!x.isText||!(Array.isArray(x.marks)?x.marks:[]).find(H=>H?.type===f&&String(H?.attrs?.href||"")===p)||(w={from:A,to:A+x.nodeSize})}),w};return Wo(u.articleId,t,{sectionId:m}).then(b=>{let S=String(b?.storedPath||b?.url||b?.path||"").trim();if(!S)throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u043E\u043B\u0443\u0447\u0438\u0442\u044C \u0441\u0441\u044B\u043B\u043A\u0443 \u043D\u0430 \u0444\u0430\u0439\u043B");let p=String(b?.originalName||t?.name||"\u0444\u0430\u0439\u043B"),f=h(e.state.doc,o);if(!f)return;let w=e.state.tr.insertText(p,f.from,f.to);w=w.addMark(f.from,f.from+p.length,r.create({href:S})),w=w.setMeta(ue,!0),e.dispatch(w)}).catch(b=>{let S=h(e.state.doc,o);if(S){let p=`${s} (\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438)`,f=e.state.tr.insertText(p,S.from,S.to);f=f.setMeta(ue,!0),e.dispatch(f)}Ie(b?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0444\u0430\u0439\u043B \u043D\u0430 \u042F\u043D\u0434\u0435\u043A\u0441.\u0414\u0438\u0441\u043A")}),!0}catch{return!1}}function Up(e){try{if(!e||typeof e!="object")return e;let t=typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e)),n=r=>{if(!r||typeof r!="object")return;if(r.type==="image"&&r.attrs&&typeof r.attrs=="object"){let i=String(r.attrs.uploadToken||"").trim(),s=String(r.attrs.src||"");i&&s.startsWith("blob:")&&(r.attrs={...r.attrs,src:`${_i}${i}`})}let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(t),t}catch{return e}}function ld(e){try{if(!e||typeof e!="object")return e;let t=typeof structuredClone=="function"?structuredClone(e):JSON.parse(JSON.stringify(e)),n=r=>{if(!r||typeof r!="object")return;if(r.type==="image"&&r.attrs&&typeof r.attrs=="object"){let i=String(r.attrs.uploadToken||"").trim(),s=String(r.attrs.src||"");i&&s.startsWith("blob:")&&(r.attrs={...r.attrs,src:`${_i}${i}`})}let o=r.content;Array.isArray(o)&&o.forEach(n)};return n(t),t}catch{return e}}async function qp(e){try{if(!le||le.isDestroyed)return;let t=String(e||"").trim();if(!t)return;let n=await na({articleId:t,limit:200}).catch(()=>[]);if(!n.length)return;let r=new Map;for(let c of n){let l=String(c?.token||"").trim();l&&(c?.kind&&String(c.kind)!=="image"||c?.blob&&r.set(l,c.blob))}if(!r.size)return;let{state:o,view:i}=le,s=o.tr,a=!1;o.doc.descendants((c,l)=>{if(c?.type?.name!=="image")return;let d=String(c.attrs?.uploadToken||"").trim(),m=String(c.attrs?.src||""),h=m.startsWith(_i)?m.slice(_i.length).trim():"",b=d||h;if(!b)return;let S=r.get(b);if(!S)return;let p=vr.get(b)||null;if(!p)try{p=URL.createObjectURL(S),vr.set(b,p)}catch{p=null}if(!p)return;let f={...c.attrs,src:p,uploadToken:b};s=s.setNodeMarkup(l,void 0,f),a=!0}),a&&(s=s.setMeta(ue,!0),i.dispatch(s))}catch{}}async function Bd(e){try{if(!navigator.onLine||!le||le.isDestroyed)return!1;let t=String(e||"").trim();if(!t)return!1;let n=await na({articleId:t,limit:50}).catch(()=>[]);if(!n.length)return!1;let r=!1;for(let o of n){let i=String(o?.token||"").trim();if(!i||o?.kind&&String(o.kind)!=="image")continue;let s=o?.blob||null;if(s)try{let a=s instanceof File?s:new File([s],o?.fileName||"image",{type:o?.mime||s.type||"application/octet-stream"}),c=await ao(a),l=String(c?.url||"").trim();if(!l)throw new Error("Upload failed");try{let{state:d,view:m}=le,h=Bi(d.doc,i);if(typeof h=="number"){let b=d.doc.nodeAt(h);if(b?.type?.name==="image"){let S={...b.attrs,src:l,uploadToken:null,title:String(b.attrs?.title||"").replace(/\s*\(ошибка загрузки\)\s*$/i,"").trim()},p=d.tr.setNodeMarkup(h,void 0,S);p=p.setMeta(ue,!0),m.dispatch(p)}}}catch{}Cd(i),await ea(i).catch(()=>{}),r=!0}catch(a){let c=a?.message||String(a||"error");await ta(i,c).catch(()=>{})}}if(r)try{Xt({delayMs:350})}catch{}return r}catch{return!1}}function Sa(){try{let e=window?.localStorage?.getItem?.(ya)||"";if(!e)return null;let t=JSON.parse(e);return!t||typeof t!="object"||!Array.isArray(t.sections)?null:{mode:t.mode==="cut"?"cut":"copy",sourceArticleId:typeof t.sourceArticleId=="string"?t.sourceArticleId:null,createdAt:typeof t.createdAt=="string"?t.createdAt:null,sections:t.sections}}catch{return null}}function Ni(e){try{if(!e){window?.localStorage?.removeItem?.(ya);return}window?.localStorage?.setItem?.(ya,JSON.stringify(e))}catch{}}function Zr(e){Yn=!!e,Yn||(fr=new Set);try{j?.outlineEditor&&j.outlineEditor.classList.toggle("outline-select-mode",Yn)}catch{}try{Nd()}catch{}}function Kp(e){let t=String(e||"").trim();if(t){fr.has(t)?fr.delete(t):fr.add(t);try{Nd()}catch{}}}function Nd(){if(!j?.outlineEditor)return;j.outlineEditor.querySelectorAll(".outline-heading[data-section-id] .outline-heading__select").forEach(t=>{let r=t.closest(".outline-heading")?.getAttribute?.("data-section-id")||"",o=r&&fr.has(r);t.setAttribute("aria-checked",o?"true":"false"),t.style.display=Yn?"inline-flex":"none"})}function Vp(e,t){let n=t instanceof Set?t:new Set,r=[];if(!e||!n.size)return r;let o=(i,s)=>{let a=String(i?.attrs?.id||"").trim(),c=a&&n.has(a);if(c&&!s){r.push({id:a,node:i});return}let l=i?.childCount>=3?i.child(2):null;if(l)try{l.forEach(d=>{d?.type?.name==="outlineSection"&&o(d,s||c)})}catch{}};try{e.forEach(i=>{i?.type?.name==="outlineSection"&&o(i,!1)})}catch{}return r}function Ea(e){return JSON.parse(JSON.stringify(e))}function Md(e,t){let n=Ea(e),r=o=>{if(!o||typeof o!="object")return;if(o.type==="outlineSection"){let s=t();o.attrs&&typeof o.attrs=="object"?o.attrs.id=s:o.attrs={id:s,collapsed:!!o.attrs?.collapsed}}let i=Array.isArray(o.content)?o.content:[];for(let s of i)r(s)};return r(n),n}async function jp(e){let t=String(e||"");if(t){try{if(navigator?.clipboard?.writeText){await navigator.clipboard.writeText(t);return}}catch{}try{let n=document.createElement("textarea");n.value=t,n.setAttribute("readonly","true"),n.style.position="fixed",n.style.left="-9999px",n.style.top="0",document.body.appendChild(n),n.select(),document.execCommand("copy"),document.body.removeChild(n)}catch{}}}function Ld(e,{baseLevel:t=2,depth:n=0}={}){let r=e;if(!r||r.type?.name!=="outlineSection")return"";let o="",i="";try{let c=r.child(0);o=String(c?.textContent||"").trim()}catch{o=""}try{let c=r.child(1);i=c?String(c.textBetween(0,c.content.size,`
`)).trimEnd():""}catch{i=""}let s=Math.min(6,Math.max(1,Number(t)+Number(n||0))),a=[];o&&a.push(`${"#".repeat(s)} ${o}`),i&&a.push(i);try{let c=r.child(2);if(c){let l=[];c.forEach(d=>{if(d?.type?.name!=="outlineSection")return;let m=Ld(d,{baseLevel:t,depth:n+1});m&&l.push(m)}),l.length&&a.push(l.join(`

`))}}catch{}return a.filter(Boolean).join(`

`).trim()}function Pd(e,t){try{let n=String(e||"").trim(),r=String(t||"").trim();if(!n||!r)return 1;let o=window.localStorage.getItem(dd)||"",i=o?JSON.parse(o):{},s=i&&typeof i=="object"?i:{},a=(s[n]&&typeof s[n]=="object"?s[n]:{})||{},l=(Number(a[r]||0)||0)+1;return a[r]=l,s[n]=a,window.localStorage.setItem(dd,JSON.stringify(s)),l}catch{return Date.now()}}function _d(e,t){try{let n=JSON.stringify({headingJson:e,bodyJson:t});return globalThis.TextEncoder?new TextEncoder().encode(n).length:n.length*2}catch{return 0}}function Yr(e){try{let t=String(e||"").trim();if(!t)return;En.add(t);let n=Nt||u.articleId||null;if(!n||u.article?.encrypted||fa)return;fa=setTimeout(()=>{fa=null;try{if(!En.size)return;let r=Array.from(En);En.clear();let o=Date.now();tn("delete_sections",{articleId:n,payload:{sectionIds:r,clientQueuedAt:o},coalesceKey:`delete:${n}`})}catch{}},0)}catch{}}function _o(e){let t=[],n=o=>{try{if(!o||o.type?.name!=="outlineSection")return null;for(let i=0;i<o.childCount;i+=1){let s=o.child(i);if(s?.type?.name==="outlineChildren")return s}return null}catch{return null}},r=(o,i)=>{try{if(!o)return;let s=0;o.forEach(a=>{if(!a||a.type?.name!=="outlineSection")return;let c=String(a.attrs?.id||"").trim();if(!c)return;t.push({sectionId:c,parentId:i||null,position:s,collapsed:!!a.attrs?.collapsed}),s+=1;let l=n(a);l&&r(l,c)})}catch{}};try{if(!e)return[];r(e,null)}catch{return[]}return t}function ud(e){try{return _o(e).map(n=>`${n.parentId||""}|${n.position}|${n.sectionId}|${n.collapsed?1:0}`).join(`
`)}catch{return""}}function Gr(e){let t=[];try{if(!e)return t;e.descendants((n,r)=>{n?.type?.name==="outlineSection"&&t.push(r)})}catch{}return t}function wa(e,t){try{if(!e||e.isDestroyed)return!1;let n=!!t;return e.commands.command(({state:r,dispatch:o})=>{let i=Gr(r.doc);if(!i.length)return!1;let s=r.tr;for(let a of i){let c=s.doc.nodeAt(a);!c||c.type?.name!=="outlineSection"||!!c.attrs?.collapsed!==n&&(s=s.setNodeMarkup(a,void 0,{...c.attrs,collapsed:n}))}s=s.setMeta(ue,!0);try{n&&Ee&&(Ee.getState(r)||{}).editingSectionId&&(s=s.setMeta(Ee,{type:"exit"}))}catch{}try{if(n&&TextSelection){let a=Ct(r.doc,r.selection.$from),c=typeof a=="number"?a:i[0],l=s.doc.nodeAt(c);if(l?.type?.name==="outlineSection"){let d=l.child(0),h=c+1+d.nodeSize-1;s=s.setSelection(TextSelection.near(s.doc.resolve(h),-1))}}}catch{}return o(s.scrollIntoView()),!0})}catch{return!1}}function Jp({articleId:e,editor:t}={}){try{let n=String(e||"").trim();if(!n||!t)return;Rn=!0;try{if((Ee?.getState?.(t.state)||null)?.editingSectionId){Ft&&(clearTimeout(Ft),Ft=null);return}}catch{}Ft&&clearTimeout(Ft),Ft=setTimeout(()=>{Ft=null;try{if(!Rn)return;let r=t.state?.doc,o=_o(r);if(!o.length)return;try{let i=null;try{i=o.filter(s=>s&&(s.parentId==null||s.parentId==="")&&Number(s.position)>=0).sort((s,a)=>Number(s.position)-Number(a.position)).slice(0,3).map(s=>String(s.sectionId||""))}catch{i=null}dt("outline.enqueue.structure_snapshot",{articleId:n,nodesCount:o.length,rootFirst:i})}catch{}tn("structure_snapshot",{articleId:n,payload:{nodes:o},coalesceKey:`structure:${n}`}),Rn=!1}catch{}},$p)}catch{}}async function Ca({articleId:e,doc:t,sectionId:n,reason:r}){let o=String(e||"").trim(),i=String(n||"").trim();if(!o||!i||!t)return!1;let s=mt(t,i),a=typeof s=="number"?t.nodeAt(s):null;if(!a||a.type?.name!=="outlineSection")return!1;try{if(!kr(t,i))return!1}catch{return!1}let c=a.child(0),l=a.child(1),d=c?.toJSON?c.toJSON():null,m=l?.toJSON?l.toJSON():null;if(!d||!m)return!1;try{d=ld(d),m=ld(m)}catch{}let h=_d(d,m);if(h>Di){let p=Date.now();return(!da||p-da>5e3)&&(da=p,Ie(`\u0411\u043B\u043E\u043A \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 (${Math.ceil(h/1024)} KB). \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C: ${Math.ceil(Di/1024)} KB. \u0420\u0430\u0437\u0431\u0435\u0439\u0442\u0435 \u0431\u043B\u043E\u043A \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E.`)),!1}let b=Date.now(),S=Pd(o,i);try{dt("outline.enqueue.section_upsert_content",{articleId:o,sectionId:i,seq:S,bytes:h,reason:String(r||"")})}catch{}await tn("section_upsert_content",{articleId:o,payload:{sectionId:i,headingJson:d,bodyJson:m,seq:S,clientQueuedAt:b},coalesceKey:`content:${o}:${i}`}).catch(()=>{});try{if(Rn){let p=_o(t);if(p.length){let f=null;try{f=p.filter(w=>w&&(w.parentId==null||w.parentId==="")&&Number(w.position)>=0).sort((w,x)=>Number(w.position)-Number(x.position)).slice(0,3).map(w=>String(w.sectionId||""))}catch{f=null}try{dt("outline.enqueue.structure_snapshot",{articleId:o,nodesCount:p.length,reason:"after_section_upsert",rootFirst:f})}catch{}tn("structure_snapshot",{articleId:o,payload:{nodes:p},coalesceKey:`structure:${o}`})}Rn=!1,Ft&&(clearTimeout(Ft),Ft=null)}}catch{}try{Tr.set(i,zi(a)),Br.delete(i)}catch{}try{Promise.resolve().then(()=>(la(),ca)).then(p=>p.flushOutboxOnce?.()).catch(()=>{})}catch{}return!0}function Wp(e){try{if(!e||e.isDestroyed)return;let t=Ee?.getState?.(e.state)||null,n=String(t?.editingSectionId||"").trim();if(!n)return;let r=Nt||u.articleId||null;if(!r)return;ma=n,Ir&&clearTimeout(Ir),Ir=setTimeout(()=>{Ir=null;try{if(!le||le.isDestroyed)return;let o=Ee?.getState?.(le.state)||null,i=String(o?.editingSectionId||"").trim();if(!i||i!==ma)return;Ca({articleId:r,doc:le.state.doc,sectionId:i,reason:"edit_heartbeat"})}catch{}},Fp)}catch{}}function xa(){try{return window?.localStorage?.getItem?.(Yp)==="1"}catch{return!1}}function wn(...e){xa()}function Ar(){try{return window?.localStorage?.getItem?.(Gp)==="1"}catch{return!1}}function Xr(e,t={}){Ar()}function Qp(){try{return window?.localStorage?.getItem?.(Xp)==="1"}catch{return!1}}function Rt(e,t={}){Qp()}function Li(e){let t=String(e||"").replace(/\s+/g," ").trim().toLowerCase();return t?t.length>60?t.slice(0,60):t:null}function To(e){return String(e||"").replace(/\s+/g," ").trim().toLowerCase()}function Zp(e,t="tag"){let n=new Map,r=new Map,o=new Map,i=new Map;return e?(e.descendants((s,a)=>{if(s?.type?.name!=="outlineSection")return;let c=String(s.attrs?.id||"");c&&i.set(c,a);let l=new Set,d=m=>{m?.descendants?.(h=>{if(h?.type?.name!==t)return;let b=Li(h.attrs?.label||h.textContent||"");if(!b)return;let S=To(h.attrs?.key||b);S&&(n.set(S,(n.get(S)||0)+1),r.set(S,S),l.add(S))})};try{d(s.child(0)),d(s.child(1))}catch{}if(c)for(let m of l)o.has(m)||o.set(m,new Set),o.get(m).add(c);return!1}),{counts:n,labelByKey:r,sectionIdsByKey:o,sectionPosById:i}):{counts:n,labelByKey:r,sectionIdsByKey:o,sectionPosById:i}}function Dd(){let e=j?.outlineTagsBar;if(!e)return;let t=Array.from(Xn.counts.entries()).map(([n,r])=>({key:n,label:Xn.labelByKey.get(n)||n,count:r})).filter(n=>n.key&&n.count>0).sort((n,r)=>r.count!==n.count?r.count-n.count:n.label.localeCompare(r.label));if(!t.length){e.innerHTML="",e.classList.add("hidden");return}e.classList.remove("hidden"),e.innerHTML=t.map(n=>{let r=ur&&ur===n.key?"true":"false",o=Lo(n.label);return`<button type="button" class="outline-tag-pill" data-tag-key="${Lo(n.key)}" aria-pressed="${r}">${o} <span class="outline-tag-pill__count">(${n.count})</span></button>`}).join("")}function Od(){if(le){if(Xn=Zp(le.state.doc,"tag"),ur&&!Xn.counts.has(ur)){ur=null;try{Ri?.(null)}catch{}}Dd()}}function em(e){let t=String(e||"");if(!t||!le)return;let n=Xn.sectionIdsByKey.get(t);if(!n||!n.size)return;let r=new Set;for(let s of n){let a=Xn.sectionPosById.get(s);if(typeof a=="number"){r.add(a);try{let c=le.state.doc.resolve(Math.min(le.state.doc.content.size,a+1));for(let l=c.depth;l>0;l-=1)c.node(l)?.type?.name==="outlineSection"&&r.add(c.before(l))}catch{}}}let o=le.state.tr,i=!1;for(let s of r){let a=o.doc.nodeAt(s);!a||a.type?.name!=="outlineSection"||a.attrs?.collapsed&&(o=o.setNodeMarkup(s,void 0,{...a.attrs,collapsed:!1}),i=!0)}i&&(o=o.setMeta(ue,!0),le.view.dispatch(o))}function tm({setActiveTagKey:e}){let t=j?.outlineTagsBar;if(!t)return()=>{};let n=r=>{let o=r.target?.closest?.("[data-tag-key]");if(!o)return;let i=String(o.getAttribute("data-tag-key")||"");if(!i)return;let s=ur===i?null:i;ur=s;try{e(s)}catch{}s&&em(s),Dd()};return t.addEventListener("click",n),()=>t.removeEventListener("click",n)}function xn(e){let t=String(e||"").trim();if(!t.includes("|"))return null;let n=t;n.startsWith("|")&&(n=n.slice(1)),n.endsWith("|")&&(n=n.slice(0,-1));let r=n.split("|").map(o=>o.trim());return r.length<2||r.every(o=>!o)?null:r}function Hi(e){let t=String(e||"").trim();return t?/^:?-{3,}:?$/.test(t):!1}function Er(e){let t=(Array.isArray(e)?e:[]).map(i=>String(i||"").replace(/\r/g,"").trimEnd()).filter(i=>i.length>0);if(t.length<2)return null;let n=xn(t[0]),r=xn(t[1]);if(!n||!r||n.length!==r.length||!r.every(Hi))return null;let o=[];for(let i=2;i<t.length;i+=1){let s=xn(t[i]);if(!s||s.length!==n.length)return null;o.push(s)}return{header:n,rows:o}}function Cr(e){let t=(Array.isArray(e)?e:[]).map(s=>String(s||"").replace(/\r/g,"").trimEnd()).filter(s=>s.length>0);if(t.length<1)return null;let n=xn(t[0]);if(!n)return null;let r=n.length;if(r<2)return null;let o=[n];for(let s=1;s<t.length;s+=1){let a=xn(t[s]);if(!a||a.length!==r)break;if(s===1&&a.every(Hi))return null;o.push(a)}return o.flat().filter(s=>String(s||"").trim().length>0).length<2?null:{rows:o}}function va(e){let t=String(e||"").replace(/\r/g,"").split(`
`).map(n=>String(n||"").trimEnd());for(;t.length&&!t[0].trim();)t.shift();for(;t.length&&!t[t.length-1].trim();)t.pop();return t}function lr(e,t){if(!e||!t)return null;let{header:n,rows:r,withHeader:o}=t,i=e.nodes.table,s=e.nodes.tableRow,a=e.nodes.tableCell,c=e.nodes.tableHeader,l=e.nodes.paragraph;if(!i||!s||!a||!c||!l||typeof e.text!="function")return null;let d=S=>l.create({},S?[e.text(String(S))]:[]),m=(S,p)=>S.map(f=>(p?c:a).create({},[d(f)])),h=(S,p)=>s.create({},m(S,p)),b=[];return o&&Array.isArray(n)&&n.length&&b.push(h(n,!0)),(Array.isArray(r)?r:[]).forEach(S=>b.push(h(S,!1))),b.length?i.create({},b):null}function nm(e,t){try{let n=e?.selection,r=n?.$from;if(!n?.empty||!r)return tt("table.merge.skip",{reason:"no-cursor"}),!1;if(r.parent?.type?.name!=="paragraph")return!1;if(r.parentOffset!==0)return tt("table.merge.skip",{reason:"not-at-paragraph-start"}),!1;let o=null,i=null,s=null;for(let ne=r.depth;ne>0;ne-=1){let ye=r.node(ne)?.type?.name;if(!s&&(ye==="tableCell"||ye==="tableHeader")?s=ne:!i&&ye==="tableRow"?i=ne:!o&&ye==="table"&&(o=ne),o&&i&&s)break}if(o==null||i==null||s==null)return tt("table.merge.skip",{reason:"not-in-table"}),!1;let a=r.depth===s+1,c=r.index(o),l=r.index(i),d=r.index(s);if(tt("table.merge.check",{parent:r.parent?.type?.name||null,parentOffset:r.parentOffset,tableDepth:o,rowDepth:i,cellDepth:s,isDirectParagraphInCell:a,rowIndex:c,colIndex:l,childIndexInCell:d}),!a)return tt("table.merge.skip",{reason:"paragraph-not-direct-child-of-cell"}),!1;if(c!==0||l!==0||d!==0)return tt("table.merge.skip",{reason:"not-in-first-cell",rowIndex:c,colIndex:l,childIndexInCell:d}),!1;let m=r.before(o),h=e.doc.nodeAt(m);if(!h||h.type?.name!=="table")return tt("table.merge.skip",{reason:"no-current-table",tablePos:m}),!1;let b=e.doc.resolve(m),S=b.index(),p=b.parent;if(!p||S<=0)return tt("table.merge.skip",{reason:"no-prev-sibling",idx:S,parent:p?.type?.name||null}),!1;let f=null,w=S-1;for(;w>=0;){let ne=p.child(w);if(ne?.type?.name==="paragraph"&&!String(ne.textContent||"").trim()){w-=1;continue}f=ne;break}if(!f||f.type?.name!=="table")return tt("table.merge.skip",{reason:"no-prev-table"}),!1;let x=f.childCount?f.child(0):null,A=h.childCount?h.child(0):null;if(!x||!A)return tt("table.merge.skip",{reason:"missing-rows"}),!1;if(x.childCount!==A.childCount)return tt("table.merge.skip",{reason:"different-columns",prevCols:x.childCount,curCols:A.childCount}),!1;let C=x.childCount,L=(ne,ye)=>{try{return ne?.type?.name==="tableRow"&&ne.childCount===ye}catch{return!1}};for(let ne=0;ne<f.childCount;ne+=1){let ye=f.child(ne);if(!L(ye,C))return tt("table.merge.skip",{reason:"prev-row-mismatch",rowIndex:ne,colsExpected:C,colsGot:ye?.childCount??null}),!1}for(let ne=0;ne<h.childCount;ne+=1){let ye=h.child(ne);if(!L(ye,C))return tt("table.merge.skip",{reason:"cur-row-mismatch",rowIndex:ne,colsExpected:C,colsGot:ye?.childCount??null}),!1}let H=m;for(let ne=S-1;ne>=w;ne-=1)H-=p.child(ne).nodeSize;let U=f.childCount,F=e.doc.type.schema,X=H+f.nodeSize,G=e.tr;m>X&&(G=G.delete(X,m));let oe=X;G=G.delete(oe,oe+h.nodeSize);let we=G.doc.nodeAt(H);if(!we||we.type?.name!=="table")return tt("table.merge.skip",{reason:"prev-after-missing",prevStart:H,prevAfterType:we?.type?.name||null}),!1;tt("table.merge.plan",{idx:S,prevIdx:w,prevStart:H,prevEnd:X,tablePos:m,tablePos2:oe,cols:C,prevRowCount:U,curRowCount:h.childCount});try{let ne=we.content.append(h.content),ye=F.nodes.table.create(we.attrs,ne,we.marks);G=G.replaceWith(H,H+we.nodeSize,ye)}catch(ne){return tt("table.merge.error",{message:String(ne?.message||ne||""),stack:String(ne?.stack||"")}),!1}let Ce=G.doc.nodeAt(H);tt("table.merge.afterReplace",{mergedType:Ce?.type?.name||null,mergedRows:Ce?.type?.name==="table"?Ce.childCount:null});try{let ne=qe?.pmStateMod?.TextSelection||qe?.pm?.state?.TextSelection||null;if(Ce&&Ce.type?.name==="table"){let ye=Math.min(U,Math.max(0,Ce.childCount-1));if(Ce.child(ye)?.childCount){let wt=(()=>{let sn=H+1;for(let mn=0;mn<ye;mn+=1)sn+=Ce.child(mn).nodeSize;return sn+=1,sn})(),Pt=Math.min(G.doc.content.size,wt+2);ne&&(G=G.setSelection(ne.near(G.doc.resolve(Pt),1)))}}}catch(ne){tt("table.merge.selection.error",{message:String(ne?.message||ne||""),stack:String(ne?.stack||"")})}G=G.setMeta(ue,!0);try{t(G.scrollIntoView())}catch(ne){return tt("table.merge.dispatch.error",{message:String(ne?.message||ne||""),stack:String(ne?.stack||"")}),!1}return!0}catch(n){try{tt("table.merge.exception",{message:String(n?.message||n||""),stack:String(n?.stack||"")})}catch{}return!1}}function rm(e,t,n,r){try{let o=(ye,Ye={})=>{},i=(ye={})=>{};if(!n)return!1;if(!r)return o("no-TextSelection"),!1;let s=e?.selection;if(!s?.empty)return o("selection-not-empty"),!1;let a=s.$from||null;if(!a)return o("no-$from"),!1;i({from:s.from,parent:a.parent?.type?.name||null,parentOffset:a.parentOffset??null});let c=mt(e.doc,n);if(typeof c!="number")return o("section-not-found"),!1;let l=e.doc.nodeAt(c);if(!l||l.type?.name!=="outlineSection")return o("not-outlineSection",{found:l?.type?.name||null}),!1;let d=l.child(0),m=l.child(1);if(!d||d.type?.name!=="outlineHeading")return o("missing-heading",{found:d?.type?.name||null}),!1;if(!m||m.type?.name!=="outlineBody")return o("missing-body",{found:m?.type?.name||null}),!1;let h=String(d.textContent||"").replace(/\u00a0/g," "),b=!!h.trim(),S=/\s$/.test(h),p=null;for(let ye=a.depth;ye>=0;ye-=1)if(a.node(ye)?.type?.name==="outlineBody"){p=ye;break}if(p==null)return o("not-in-outlineBody",{parent:a.parent?.type?.name||null}),!1;if(a.index(p)!==0)return o("not-first-body-child",{index:a.index(p)}),!1;if(a.parent?.type?.name!=="paragraph")return o("parent-not-paragraph",{parent:a.parent?.type?.name||null}),!1;if((a.parentOffset??null)!==0)return o("not-at-paragraph-start",{parentOffset:a.parentOffset??null}),!1;let f=c+1,w=s.from,x=a.parent,A=0,C=null;for(let ye=0;ye<x.childCount;ye+=1){let Ye=x.child(ye);if(Ye.type?.name==="hardBreak"){C=A;break}A+=Ye.nodeSize}let L=w+(C??x.content.size);if(L<=w)return o("empty-first-line"),!1;let H=e.doc.slice(w,L);if(!H?.content||H.content.size<=0)return o("empty-slice"),!1;let U=C==null?L:L+1,F=f+1,X=f+d.nodeSize-1,G=e.tr;b&&!S&&(G=G.insertText(" ",X),G=G.setMeta(ue,!0));let oe=G.mapping.map(X,1),we=oe;G=G.insert(oe,H.content);let Ce=G.mapping.map(w,1),ne=G.mapping.map(U,-1);G=G.delete(Ce,ne);try{G=G.setSelection(r.create(G.doc,we))}catch{}return G=G.setMeta(ue,!0),t(G.scrollIntoView()),!0}catch(o){return!1}}function om(e,t){try{if(!e?.doc||!t)return null;let n=mt(e.doc,t);if(typeof n!="number")return null;let r=e.doc.nodeAt(n);if(!r)return null;let o=r.child(0),i=r.child(1);if(!i||i.type?.name!=="outlineBody")return null;let a=n+1+o.nodeSize+1,c=[],l=0,d=0;for(;d<i.childCount;){let h=i.child(d),b=a+l;if(h.type?.name!=="paragraph"){l+=h.nodeSize,d+=1;continue}let S=dr(h).trim();if(S.includes(`
`)&&S.includes("|")){let G=va(S),oe=Er(G),we=oe?null:Cr(G),Ce=oe?{header:oe.header,rows:oe.rows,withHeader:!0}:we?{header:null,rows:we.rows,withHeader:!1}:null,ne=null;if(Ce)try{ne=lr(e.schema,Ce)}catch(ye){wn("convert: buildTableNode error (single)",{message:String(ye?.message||ye||""),stack:String(ye?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),ne=null}if(ne){let ye=b,Ye=b+h.nodeSize;c.push({from:ye,to:Ye,tableNode:ne}),wn("convert: single-paragraph table",{sectionId:t,from:ye,to:Ye,lines:G}),l+=h.nodeSize,d+=1;continue}}let p=xn(S);if(!p||d+1>=i.childCount){if(p){let G=[S],oe=l+h.nodeSize,we=d+1;for(;we<i.childCount;){let Ye=i.child(we);if(Ye.type?.name!=="paragraph")break;let wt=dr(Ye).trim();if(!wt)break;let Pt=xn(wt);if(!Pt||Pt.length!==p.length)break;G.push(wt),oe+=Ye.nodeSize,we+=1}let Ce=Cr(G),ne=Ce?{header:null,rows:Ce.rows,withHeader:!1}:null,ye=null;if(ne)try{ye=lr(e.schema,ne)}catch(Ye){wn("convert: buildTableNode error (rows-only)",{message:String(Ye?.message||Ye||""),stack:String(Ye?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),ye=null}if(ye){c.push({from:b,to:a+oe,tableNode:ye}),wn("convert: rows-only table",{sectionId:t,from:b,to:a+oe,lines:G}),l=oe,d=we;continue}}l+=h.nodeSize,d+=1;continue}let f=i.child(d+1);if(f.type?.name!=="paragraph"){l+=h.nodeSize,d+=1;continue}let w=dr(f).trim(),x=xn(w);if(!x||x.length!==p.length||!x.every(Hi)){l+=h.nodeSize,d+=1;continue}let A=[S,w],C=l+h.nodeSize+f.nodeSize,L=d+2;for(;L<i.childCount;){let G=i.child(L);if(G.type?.name!=="paragraph")break;let oe=dr(G).trim();if(!oe)break;let we=xn(oe);if(!we||we.length!==p.length)break;A.push(oe),C+=G.nodeSize,L+=1}let H=Er(A),U=H?null:Cr(A),F=H?{header:H.header,rows:H.rows,withHeader:!0}:U?{header:null,rows:U.rows,withHeader:!1}:null,X=null;if(F)try{X=lr(e.schema,F)}catch(G){wn("convert: buildTableNode error (multi)",{message:String(G?.message||G||""),stack:String(G?.stack||""),schemaNodes:Object.keys(e.schema?.nodes||{})}),X=null}if(!X){l+=h.nodeSize,d+=1;continue}c.push({from:b,to:a+C,tableNode:X}),wn("convert: multi-paragraph table",{sectionId:t,from:b,to:a+C,lines:A}),l=C,d=L}if(!c.length)return null;c.sort((h,b)=>b.from-h.from);let m=e.tr;for(let h of c)m=m.replaceRangeWith(h.from,h.to,h.tableNode);return m=m.setMeta(ue,!0),m}catch{return null}}function dr(e){if(!e)return"";let t="";return e.descendants(n=>{n.isText?t+=n.text||"":n.type?.name==="hardBreak"&&(t+=`
`)}),t}function pd(e){try{if(!e||e.type!=="paragraph")return"";let t=[],n=r=>{if(!r)return;if(r.type==="text"){t.push(String(r.text||""));return}if(r.type==="hardBreak"){t.push(`
`);return}let o=Array.isArray(r.content)?r.content:[];for(let i of o)n(i)};return n(e),t.join("")}catch{return""}}function im(e){if(!e)return null;let{header:t,rows:n}=e;if(!Array.isArray(t)||t.length===0)return null;let r=s=>({type:"paragraph",content:String(s||"").length?[{type:"text",text:String(s||"")}]:[]}),o={type:"tableRow",content:t.map(s=>({type:"tableHeader",content:[r(s)]}))},i=(Array.isArray(n)?n:[]).map(s=>({type:"tableRow",content:s.map(a=>({type:"tableCell",content:[r(a)]}))}));return{type:"table",content:[o,...i]}}function sm(e){if(!e)return!1;try{let{doc:t,schema:n}=e.state,r=[];if(t.descendants((i,s)=>{if(i.type?.name!=="outlineBody")return;let a=s+1,c=0,l=0;for(;l<i.childCount;){let d=i.child(l),m=a+c;if(d.type?.name!=="paragraph"){c+=d.nodeSize,l+=1;continue}let h=dr(d).trim();if(h.includes(`
`)&&h.includes("|")){let U=va(h),F=Er(U),X=F?null:Cr(U),G=F?{header:F.header,rows:F.rows,withHeader:!0}:X?{header:null,rows:X.rows,withHeader:!1}:null,oe=G?lr(n,G):null;if(oe){r.push({from:m,to:m+d.nodeSize,tableNode:oe}),c+=d.nodeSize,l+=1;continue}}let b=xn(h);if(!b){c+=d.nodeSize,l+=1;continue}if(l+1>=i.childCount){let U=Cr([h]),F=U?{header:null,rows:U.rows,withHeader:!1}:null,X=F?lr(n,F):null;X&&r.push({from:m,to:m+d.nodeSize,tableNode:X}),c+=d.nodeSize,l+=1;continue}let S=i.child(l+1);if(S.type?.name!=="paragraph"){c+=d.nodeSize,l+=1;continue}let p=dr(S).trim(),f=xn(p);if(!f||f.length!==b.length||!f.every(Hi)){let U=[h],F=c+d.nodeSize,X=l+1;for(;X<i.childCount;){let Ce=i.child(X);if(Ce.type?.name!=="paragraph")break;let ne=dr(Ce).trim();if(!ne)break;let ye=xn(ne);if(!ye||ye.length!==b.length)break;U.push(ne),F+=Ce.nodeSize,X+=1}let G=Cr(U),oe=G?{header:null,rows:G.rows,withHeader:!1}:null,we=oe?lr(n,oe):null;if(we){r.push({from:m,to:a+F,tableNode:we}),c=F,l=X;continue}c+=d.nodeSize,l+=1;continue}let w=[h,p],x=c+d.nodeSize+S.nodeSize,A=l+2;for(;A<i.childCount;){let U=i.child(A);if(U.type?.name!=="paragraph")break;let F=dr(U).trim();if(!F)break;let X=xn(F);if(!X||X.length!==b.length)break;w.push(F),x+=U.nodeSize,A+=1}let C=Er(w),L=C?{header:C.header,rows:C.rows,withHeader:!0}:null,H=L?lr(n,L):null;if(!H){c+=d.nodeSize,l+=1;continue}r.push({from:m,to:a+x,tableNode:H}),c=x,l=A}}),!r.length)return!1;r.sort((i,s)=>s.from-i.from);let o=e.state.tr;for(let i of r)o=o.replaceRangeWith(i.from,i.to,i.tableNode);return o=o.setMeta(ue,!0),e.view.dispatch(o),!0}catch{return!1}}function Qr(){let e=Date.now();if(!(e-fd<900)){fd=e;try{Ie("\u0414\u043B\u044F \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Enter \u0438\u043B\u0438 \u0434\u0432\u043E\u0439\u043D\u043E\u0439 \u043A\u043B\u0438\u043A \u043C\u044B\u0448\u043A\u043E\u0439. Esc \u0434\u043B\u044F \u0432\u044B\u0445\u043E\u0434\u0430.")}catch{}}}function Aa(e=""){let t=document.createElement("div");return t.innerHTML=e||"",(t.textContent||"").replace(/\u00a0/g," ").trim()}function Wn(e=""){return String(e||"").replace(/\u00a0/g," ").replace(/[ \t]+\n/g,`
`).replace(/\n{3,}/g,`

`).trim()}function Ia(e=""){let t=String(e||""),n=0;for(let r=0;r<t.length;r+=1)n=n*31+t.charCodeAt(r)>>>0;return String(n)}function Wr(e=""){return Ia(String(e||"").slice(0,12e3))}function Wt(){return typeof crypto<"u"&&typeof crypto.randomUUID=="function"?crypto.randomUUID():`sec-${Date.now()}-${Math.random().toString(16).slice(2)}`}function Rd({loading:e=!1}={}){j.outlineEditor&&(j.outlineEditor.innerHTML=`
    <div class="outline-editor__body">
      <div class="outline-editor__content" id="outlineEditorContent"></div>
      <div class="outline-editor__loading ${e?"":"hidden"}">\u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440\u2026</div>
    </div>
  `,ad||(ad=!0))}function Hd(e){let t=String(e||"").trim();if(!t)return null;let n=t.match(/(-?\d+(?:\.\d+)?)%/);if(!n)return null;let r=Number.parseFloat(n[1]);return Number.isFinite(r)?r:null}function Hn(e){let t=Number(e);return Number.isFinite(t)?Math.max(0,Math.min(100,t)):0}function $d(e){try{let t=e?.dataset?.ttPct||"",n=Number.parseFloat(String(t||""));if(Number.isFinite(n)&&n>0)return n;let r=Hd(e?.style?.width||"");return r!=null&&r>0?r:null}catch{return null}}function $i(e,t){try{let n=Hn(t);return e.dataset.ttPct=n.toFixed(4),e.style.width=`${n.toFixed(4)}%`,e.style.minWidth="",!0}catch{return!1}}function Oi(e,{insertIndex:t,newColPct:n=10}={}){try{let r=e?.view;if(!r)return!1;let o=Number(t);if(!Number.isFinite(o)||o<0)return!1;let i=r.domAtPos(r.state.selection.from),a=((i?.node&&i.node.nodeType===1?i.node:i?.node?.parentElement)||null)?.closest?.("table")||null;if(!a)return!1;let c=a.querySelector("colgroup");if(!c)return!1;let l=Array.from(c.querySelectorAll("col"));if(!l.length||o>=l.length)return!1;let d=100/l.length,m=l.map(C=>$d(C)??d),h=Hn(n);m[o]=h;let b=o-1,S=b>=0?m.slice(0,b+1).reduce((C,L)=>C+L,0):0,p=o+1,f=Math.max(0,l.length-p),w=f>0?m.slice(p).reduce((C,L)=>C+L,0):0,x=100-S-h;if(x<0){let C=Math.max(0,o-1),L=Math.max(0,m[C]-1),H=Math.abs(x),U=Math.min(L,H);m[C]=Math.max(1,m[C]-U),x=100-m.slice(0,b+1).reduce((F,X)=>F+X,0)-h,x=Math.max(0,x)}if(f>0)if(w>0){let C=x/w;for(let L=p;L<l.length;L+=1)m[L]*=C}else{let C=x/f;for(let L=p;L<l.length;L+=1)m[L]=C}let A=m.reduce((C,L)=>C+L,0);if(A>0&&Math.abs(A-100)>.01){let C=100-A,L=l.length-1;m[L]=Hn(m[L]+C),A=m.reduce((H,U)=>H+U,0)}for(let C=0;C<l.length;C+=1)$i(l[C],m[C]);try{a.style.width="100%",a.style.maxWidth="100%",a.style.tableLayout="fixed"}catch{}return!0}catch{return!1}}function Pi(e){try{if(!e)return!1;let t=e.querySelector("colgroup");if(!t)return!1;let n=Array.from(t.querySelectorAll("col"));if(!n.length)return!1;let r=e.getBoundingClientRect();if(!Number.isFinite(r.width)||r.width<=0)return!1;let o=e.querySelector("tbody tr");if(!o)return!1;let i=Array.from(o.children||[]).filter(c=>c&&c.nodeType===1);if(!i.length)return!1;let s=[];for(let c=0;c<n.length;c+=1){let l=i[c]||null;if(!l){s.push(0);continue}let d=l.getBoundingClientRect();s.push(Number.isFinite(d.width)?d.width:0)}let a=s.reduce((c,l)=>c+(Number.isFinite(l)?l:0),0);if(!(a>0))return!1;for(let c=0;c<n.length;c+=1){let l=Hn(s[c]/a*100);$i(n[c],l)}return!0}catch{return!1}}function on(e){try{if(!e?.state?.selection)return null;let t=e.state.selection;try{let o=t?.$anchorCell?.pos,i=t?.$headCell?.pos,s=Number.isFinite(o)?o:Number.isFinite(i)?i:null;if(s!=null){let a=e.nodeDOM?.(s)||null;if(a&&a.nodeType===1)return a.closest?.("table")||null}}catch{}let n=e.domAtPos(t.from);return((n?.node&&n.node.nodeType===1?n.node:n?.node?.parentElement)||null)?.closest?.("table")||null}catch{return null}}function am(e){try{let t=e?.state?.selection||null,n=t?.$from||null;if(!n)return null;try{let s=t?.$anchorCell?.pos,a=t?.$headCell?.pos,c=Number.isFinite(s)?s:Number.isFinite(a)?a:null;if(c!=null){let l=e.nodeDOM?.(c)||null;if(l&&l.nodeType===1)return l}}catch{}let r=null;for(let s=n.depth;s>=0;s-=1){let a=n.node(s)?.type?.name;if(a==="tableCell"||a==="tableHeader"){r=s;break}}if(r!=null){let s=n.before(r),a=e.nodeDOM?.(s)||null;if(a&&a.nodeType===1)return a}let o=e.domAtPos(t.from);return((o?.node&&o.node.nodeType===1?o.node:o?.node?.parentElement)||null)?.closest?.("td,th")||null}catch{return null}}function to(e){try{if(!e)return null;let t=e.querySelector("colgroup");if(!t)return null;let n=Array.from(t.querySelectorAll("col"));if(!n.length)return null;let r=n.map(l=>$d(l));if(r.some(l=>typeof l=="number"&&Number.isFinite(l)&&l>0)){let l=100/n.length;return r.map(d=>typeof d=="number"&&Number.isFinite(d)&&d>0?d:l)}let i=e.querySelector("tbody tr");if(!i)return null;let s=Array.from(i.children||[]).filter(l=>l&&l.nodeType===1);if(s.length<n.length)return null;let a=[];for(let l=0;l<n.length;l+=1){let d=s[l].getBoundingClientRect();a.push(Number.isFinite(d.width)?d.width:0)}let c=a.reduce((l,d)=>l+(Number.isFinite(d)?d:0),0);return c>0?a.map(l=>Hn(l/c*100)):null}catch{return null}}function no(e,t){try{if(!e)return!1;let n=e.querySelector("colgroup");if(!n)return!1;let r=Array.from(n.querySelectorAll("col"));if(!r.length||!Array.isArray(t)||t.length!==r.length)return!1;for(let o=0;o<r.length;o+=1)$i(r[o],t[o]);try{e.style.width="100%",e.style.maxWidth="100%",e.style.tableLayout="fixed"}catch{}return!0}catch{return!1}}function Fd(e,t){try{let n=Array.isArray(e)?e.map(m=>Number(m)||0):null,r=Number(t);if(!n||!Number.isFinite(r)||r<0||r>=n.length||n.length<=1)return null;let o=Math.max(0,n[r]||0),i=n.slice(0,r),s=n.slice(r+1),a=s.reduce((m,h)=>m+(Number.isFinite(h)?h:0),0),c=s;if(s.length)if(a>0){let m=(a+o)/a;c=s.map(h=>Number.isFinite(h)?h*m:0)}else{let m=(o||0)/s.length;c=s.map(()=>m)}else i.length&&(i[i.length-1]=Math.max(1,(i[i.length-1]||0)+o));let l=[...i,...c].map(m=>Hn(m)),d=l.reduce((m,h)=>m+(Number.isFinite(h)?h:0),0);return d>0&&Math.abs(d-100)>.01&&(l[l.length-1]=Hn(l[l.length-1]+(100-d))),l}catch{return null}}function zt(e){try{let t=At?.TableMap||null,n=e?.selection||null,r=n?.$from||null,i=n?.$anchorCell||null||r||null;if(!i)return null;let s=null;for(let f=i.depth;f>=0;f-=1)if(i.node(f)?.type?.name==="table"){s=f;break}if(s==null)return null;let a=i.before(s),c=e.doc.nodeAt(a);if(!c||c.type?.name!=="table")return null;let l=null;for(let f=s+1;f<=i.depth;f+=1){let w=i.node(f)?.type?.name;if(w==="tableCell"||w==="tableHeader"){l=f;break}}if(l==null)return null;let d=i.before(l),m=t?.get?t.get(c):null;if(!m)return null;let h=d-a-1,b=m.findCell(h),S=Number(b?.left??0),p=Number(b?.top??0);return{tablePos:a,tableNode:c,map:m,colIndex:S,rowIndex:p}}catch{return null}}function pa(e){try{let t=[],n=e?.selection,r=e?.doc;if(!n||!r)return t;try{r.nodesBetween(n.from,n.to,(i,s)=>{let a=i?.type?.name;(a==="tableCell"||a==="tableHeader")&&t.push({node:i,pos:s})})}catch{}if(!t.length)try{let i=n.$from||null;if(i)for(let s=i.depth;s>=0;s-=1){let a=i.node(s)?.type?.name;if(a==="tableCell"||a==="tableHeader"){let c=i.before(s),l=r.nodeAt(c);l&&t.push({node:l,pos:c});break}}}catch{}let o=new Map;for(let i of t){let s=Number(i?.pos);Number.isFinite(s)&&(o.has(s)||o.set(s,i))}return Array.from(o.values()).sort((i,s)=>Number(i.pos)-Number(s.pos))}catch{return[]}}function cm(e,t){try{let n=At?.CellSelection||null,r=At?.TableMap||null;return!n||!r?!1:e.commands.command(({state:o,dispatch:i})=>{let s=zt(o);if(!s)return!1;let{tablePos:a,tableNode:c,map:l}=s,d=Number(t);if(!Number.isFinite(d)||d<0||d>=l.height)return!1;let m=l.positionAt(d,0,c),h=l.positionAt(d,l.width-1,c),b=a+1+m,S=a+1+h,p=null;try{typeof n.create=="function"&&(p=n.create(o.doc,b,S))}catch{p=null}if(!p)return!1;let f=o.tr.setSelection(p);return f=f.setMeta(ue,!0),i(f.scrollIntoView()),!0})}catch{return!1}}function lm(e,t,n){try{let r=At?.CellSelection||null,o=At?.TableMap||null;if(!r||!o)return!1;let i=Number(t),s=Number(n);return!Number.isFinite(i)||i<0||!Number.isFinite(s)||s<0?!1:e.commands.command(({state:a,dispatch:c})=>{let l=a?.doc?.nodeAt?.(i)||null;if(!l||l.type?.name!=="table")return!1;let d=o?.get?o.get(l):null;if(!d||s>=d.height)return!1;let m=d.positionAt(s,0,l),h=d.positionAt(s,d.width-1,l),b=i+1+m,S=i+1+h,p=null;try{typeof r.create=="function"&&(p=r.create(a.doc,b,S))}catch{p=null}if(!p)return!1;let f=a.tr.setSelection(p);return f=f.setMeta(ue,!0),c(f.scrollIntoView()),!0})}catch{return!1}}function dm(e,t){try{let n=At?.CellSelection||null,r=At?.TableMap||null;return!n||!r?!1:e.commands.command(({state:o,dispatch:i})=>{let s=zt(o);if(!s)return!1;let{tablePos:a,tableNode:c,map:l}=s,d=Number(t);if(!Number.isFinite(d)||d<0||d>=l.width)return!1;let m=l.positionAt(0,d,c),h=l.positionAt(l.height-1,d,c),b=a+1+m,S=a+1+h,p=null;try{typeof n.create=="function"&&(p=n.create(o.doc,b,S))}catch{p=null}if(!p)return!1;let f=o.tr.setSelection(p);return f=f.setMeta(ue,!0),i(f.scrollIntoView()),!0})}catch{return!1}}function um(e,t,n){try{let r=At?.CellSelection||null,o=At?.TableMap||null;if(!r||!o)return!1;let i=Number(t),s=Number(n);return!Number.isFinite(i)||i<0||!Number.isFinite(s)||s<0?!1:e.commands.command(({state:a,dispatch:c})=>{let l=a?.doc?.nodeAt?.(i)||null;if(!l||l.type?.name!=="table")return!1;let d=o?.get?o.get(l):null;if(!d||s>=d.width)return!1;let m=d.positionAt(0,s,l),h=d.positionAt(d.height-1,s,l),b=i+1+m,S=i+1+h,p=null;try{typeof r.create=="function"&&(p=r.create(a.doc,b,S))}catch{p=null}if(!p)return!1;let f=a.tr.setSelection(p);return f=f.setMeta(ue,!0),c(f.scrollIntoView()),!0})}catch{return!1}}function fm({pmState:e,dispatch:t},{tablePos:n,rowIndex:r,attr:o,value:i}){try{let s=At?.CellSelection||null,a=At?.TableMap||null;if(!a)return!1;let c=Number(n),l=Number(r);if(!Number.isFinite(c)||c<0||!Number.isFinite(l)||l<0)return!1;let d=e?.doc?.nodeAt?.(c)||null;if(!d||d.type?.name!=="table")return!1;let m=a?.get?a.get(d):null;if(!m||l>=m.height)return!1;let h=e.tr;try{if(s?.create){let p=m.positionAt(l,0,d),f=m.positionAt(l,m.width-1,d),w=c+1+p,x=c+1+f;h=h.setSelection(s.create(h.doc,w,x))}}catch{}let b=new Set;for(let p=0;p<m.width;p+=1){let f=m.map[l*m.width+p];Number.isFinite(f)&&b.add(c+1+f)}if(!b.size)return!1;let S=!1;for(let p of b){let f=h.doc.nodeAt(p),w=f?.type?.name;if(w!=="tableCell"&&w!=="tableHeader")continue;let x={...f.attrs||{}};i==null||i===""?delete x[o]:x[o]=i,h=h.setNodeMarkup(p,void 0,x),S=!0}return S?(h=h.setMeta(ue,!0),t(h),!0):!1}catch{return!1}}function pm({pmState:e,dispatch:t},{tablePos:n,colIndex:r,attr:o,value:i}){try{let s=At?.CellSelection||null,a=At?.TableMap||null;if(!a)return!1;let c=Number(n),l=Number(r);if(!Number.isFinite(c)||c<0||!Number.isFinite(l)||l<0)return!1;let d=e?.doc?.nodeAt?.(c)||null;if(!d||d.type?.name!=="table")return!1;let m=a?.get?a.get(d):null;if(!m||l>=m.width)return!1;let h=e.tr;try{if(s?.create){let p=m.positionAt(0,l,d),f=m.positionAt(m.height-1,l,d),w=c+1+p,x=c+1+f;h=h.setSelection(s.create(h.doc,w,x))}}catch{}let b=new Set;for(let p=0;p<m.height;p+=1){let f=m.map[p*m.width+l];Number.isFinite(f)&&b.add(c+1+f)}if(!b.size)return!1;let S=!1;for(let p of b){let f=h.doc.nodeAt(p),w=f?.type?.name;if(w!=="tableCell"&&w!=="tableHeader")continue;let x={...f.attrs||{}};i==null||i===""?delete x[o]:x[o]=i,h=h.setNodeMarkup(p,void 0,x),S=!0}return S?(h=h.setMeta(ue,!0),t(h),!0):!1}catch{return!1}}function Fi(e,t="\u0442\u0430\u0431\u043B\u0438\u0446\u044B"){try{let n=!1;return e.descendants(r=>{if(n)return!1;let o=r?.type?.name;if(o==="tableCell"||o==="tableHeader"){let i=Number(r.attrs?.colspan||1),s=Number(r.attrs?.rowspan||1);if(i!==1||s!==1)return n=!0,!1}return!0}),n?(Ie(`\u041F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 ${t} \u043F\u043E\u043A\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u0445 \u044F\u0447\u0435\u0435\u043A`),!1):!0}catch{return!1}}function zd(e,{kind:t,fromIndex:n,toIndex:r}){try{if(!e||!(At?.TableMap||null))return!0;let i=e.map||null,s=e.tableNode||null;if(!i||!s)return!0;let a=Number(n),c=Number(r);if(!Number.isFinite(a)||!Number.isFinite(c))return!0;let l=t==="row"?Math.max(0,Math.min(i.height-1,a)):Math.max(0,Math.min(i.width-1,a)),d=t==="row"?Math.max(0,Math.min(i.height-1,c)):Math.max(0,Math.min(i.width-1,c)),m=new Set;for(let h of i.map){let b=Number(h);if(!Number.isFinite(b)||b<0||m.has(b))continue;m.add(b);let S=null;try{S=i.findCell(b)}catch{S=null}if(!S)continue;let p=Number(S.right)-Number(S.left),f=Number(S.bottom)-Number(S.top);if(p>1||f>1)if(t==="col"){let w=Number(S.left),x=Number(S.right);if(w<=l&&l<x||w<=d&&d<x)return!0}else{let w=Number(S.top),x=Number(S.bottom);if(w<=l&&l<x||w<=d&&d<x)return!0}}return!1}catch{return!0}}function md(e,t){try{if(!e?.view)return!1;let n=zt(e.state);if(!n)return!1;let{colIndex:r}=n,o=n.map?.width||0;if(!(o>0))return!1;let i=t<0?-1:1,s=r+i;return s>=0&&s<o?Ud(e,r,s):!1}catch{return!1}}function hd(e,t){try{if(!e?.view)return!1;let n=zt(e.state);if(!n)return!1;let{rowIndex:r}=n,o=n.map?.height||0;if(!(o>0))return!1;let i=t<0?-1:1,s=r+i;return s>=0&&s<o?qd(e,r,s):!1}catch{return!1}}function Ud(e,t,n){try{if(!e?.view)return!1;let r=e.state,o=zt(r);if(!o)return!1;let{tableNode:i}=o,s=o.map?.width||0;if(!(s>0))return!1;let a=Number(t),c=Number(n);if(!Number.isFinite(a)||!Number.isFinite(c)||a<0||a>=s||c<0||c>=s)return!1;if(a===c)return!0;if(zd(o,{kind:"col",fromIndex:a,toIndex:c}))return Ie("\u041D\u0435\u043B\u044C\u0437\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u043E\u043B\u0431\u0435\u0446: \u0438\u0441\u0445\u043E\u0434\u043D\u0430\u044F \u0438\u043B\u0438 \u0446\u0435\u043B\u0435\u0432\u0430\u044F \u043A\u043E\u043B\u043E\u043D\u043A\u0430 \u043F\u0435\u0440\u0435\u0441\u0435\u043A\u0430\u0435\u0442\u0441\u044F \u0441 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u043C\u0438 \u044F\u0447\u0435\u0439\u043A\u0430\u043C\u0438"),!1;let l=on(e.view),d=to(l),m=Array.isArray(d)&&d.length===s?(()=>{let p=d.slice(),f=p.splice(a,1)[0];return p.splice(c,0,f),p})():null,h=At?.moveTableColumn||null;if(typeof h!="function")return!1;let b=h({from:a,to:c,select:!0});return e.commands.command(({state:p,dispatch:f})=>b(p,typeof f=="function"?x=>{try{x=x.setMeta(ue,!0)}catch{}f(x)}:void 0))?(m&&window.requestAnimationFrame(()=>{let p=on(e.view);no(p,m);try{(p?.closest?.(".tableWrapper")||null)?.dispatchEvent?.(new Event("scroll"))}catch{}}),!0):!1}catch{return!1}}function qd(e,t,n){try{if(!e?.view)return!1;let r=e.state,o=zt(r);if(!o)return!1;let i=o.map?.height||0,s=o.map?.width||0;if(!(s>0&&i>0))return!1;let a=Number(t),c=Number(n);if(!Number.isFinite(a)||!Number.isFinite(c)||a<0||a>=i||c<0||c>=i)return!1;if(a===c)return!0;if(zd(o,{kind:"row",fromIndex:a,toIndex:c}))return Ie("\u041D\u0435\u043B\u044C\u0437\u044F \u043F\u0435\u0440\u0435\u043C\u0435\u0441\u0442\u0438\u0442\u044C \u0441\u0442\u0440\u043E\u043A\u0443: \u0438\u0441\u0445\u043E\u0434\u043D\u0430\u044F \u0438\u043B\u0438 \u0446\u0435\u043B\u0435\u0432\u0430\u044F \u0441\u0442\u0440\u043E\u043A\u0430 \u043F\u0435\u0440\u0435\u0441\u0435\u043A\u0430\u0435\u0442\u0441\u044F \u0441 \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u043C\u0438 \u044F\u0447\u0435\u0439\u043A\u0430\u043C\u0438"),!1;let l=on(e.view),d=to(l),m=At?.moveTableRow||null;if(typeof m!="function")return!1;let h=m({from:a,to:c,select:!0});return e.commands.command(({state:S,dispatch:p})=>h(S,typeof p=="function"?w=>{try{w=w.setMeta(ue,!0)}catch{}p(w)}:void 0))?(Array.isArray(d)&&d.length===s&&window.requestAnimationFrame(()=>{let S=on(e.view);no(S,d)}),!0):!1}catch{return!1}}function Kd(e){try{if(!e)return"";let t=e.textContent||"";return String(t).replace(/\s+/g," ").trim()}catch{return""}}function mm(e){try{if(!e)return!1;for(let t=0;t<e.childCount;t+=1)if(e.child(t)?.type?.name==="tableHeader")return!0;return!1}catch{return!1}}function gd(e,{direction:t="asc"}={}){try{if(!e?.view)return!1;let n=e.state,r=zt(n);if(!r)return!1;let{tablePos:o,tableNode:i,colIndex:s}=r,a=i.child(0)?.childCount||0,c=i.childCount||0;if(!(a>0&&c>1)||!(s>=0&&s<a)||!Fi(i,"\u0442\u0430\u0431\u043B\u0438\u0446\u044B"))return!1;let l=mm(i.child(0))?i.child(0):null,d=l?1:0,m=[];for(let f=d;f<c;f+=1){let w=i.child(f),x=w.child(s);m.push({rowIndex:f,rowNode:w,key:Kd(x)})}let h=t==="desc"?-1:1;m.sort((f,w)=>h*f.key.localeCompare(w.key,void 0,{sensitivity:"base",numeric:!0}));let b=[];l&&b.push(l);for(let f of m)b.push(f.rowNode);let S=i.type.create(i.attrs,b),p=n.tr.replaceWith(o,o+i.nodeSize,S);return p=p.setMeta(ue,!0),e.view.dispatch(p.scrollIntoView()),!0}catch{return!1}}function yd(e,{direction:t="asc"}={}){try{if(!e?.view)return!1;let n=e.state,r=zt(n);if(!r)return!1;let{tablePos:o,tableNode:i,rowIndex:s}=r,a=i.child(0)?.childCount||0,c=i.childCount||0;if(!(a>1&&c>0)||!(s>=0&&s<c)||!Fi(i,"\u0442\u0430\u0431\u043B\u0438\u0446\u044B"))return!1;let l=i.child(s),d=[];for(let A=0;A<a;A+=1)d.push({colIndex:A,key:Kd(l.child(A))});let m=t==="desc"?-1:1;d.sort((A,C)=>m*A.key.localeCompare(C.key,void 0,{sensitivity:"base",numeric:!0}));let h=d.map(A=>A.colIndex),b=on(e.view),S=to(b),p=Array.isArray(S)&&S.length===a?h.map(A=>S[A]):null,f=[];for(let A=0;A<c;A+=1){let C=i.child(A),L=h.map(H=>C.child(H));f.push(C.type.create(C.attrs,L))}let w=i.type.create(i.attrs,f),x=n.tr.replaceWith(o,o+i.nodeSize,w);return x=x.setMeta(ue,!0),e.view.dispatch(x.scrollIntoView()),p&&window.requestAnimationFrame(()=>{let A=on(e.view);no(A,p)}),!0}catch{return!1}}function hm(e){try{if(!e?.view)return!1;let t=e.state,n=zt(t);if(!n)return!1;let{tablePos:r,tableNode:o,rowIndex:i,colIndex:s}=n,a=o.child(0)?.childCount||0,c=o.childCount||0;if(!(a>0&&c>0)||!(i>=0&&i<c)||!Fi(o,"\u0441\u0442\u0440\u043E\u043A"))return!1;let l=o.child(i),d=[];for(let b=0;b<c;b+=1)d.push(o.child(b)),b===i&&d.push(l.type.create(l.attrs,l.content,l.marks));let m=o.type.create(o.attrs,d),h=t.tr.replaceWith(r,r+o.nodeSize,m);h=h.setMeta(ue,!0);try{let b=qe?.pmStateMod?.TextSelection;if(b){let S=Math.min(m.childCount-1,i+1),p=Math.min(a-1,Math.max(0,s)),f=m.child(S),w=f.child(p),x=r+1;for(let H=0;H<S;H+=1)x+=m.child(H).nodeSize;x+=1;for(let H=0;H<p;H+=1)x+=f.child(H).nodeSize;let A=x,C=A+1,L=A+w.nodeSize-1;h=h.setSelection(b.near(h.doc.resolve(Math.min(L,C+1)),1))}}catch{}return e.view.dispatch(h.scrollIntoView()),!0}catch{return!1}}function gm(e){try{if(!e?.view)return!1;let t=e.state,n=zt(t);if(!n)return!1;let{tablePos:r,tableNode:o,rowIndex:i,colIndex:s}=n,a=o.child(0)?.childCount||0,c=o.childCount||0;if(!(a>0&&c>0)||!(s>=0&&s<a)||!Fi(o,"\u0441\u0442\u043E\u043B\u0431\u0446\u043E\u0432"))return!1;let l=on(e.view),d=to(l),m=null;if(Array.isArray(d)&&d.length===a){let p=[...d],f=Math.max(0,Number(p[s]||0)),w=Hn(f/2);p[s]=w,p.splice(s+1,0,w);let x=p.reduce((A,C)=>A+(Number.isFinite(C)?C:0),0);x>0&&Math.abs(x-100)>.01&&(p[p.length-1]=Hn(p[p.length-1]+(100-x))),m=p}let h=[];for(let p=0;p<c;p+=1){let f=o.child(p),w=[];for(let x=0;x<a;x+=1){let A=f.child(x);w.push(A),x===s&&w.push(A.type.create(A.attrs,A.content,A.marks))}h.push(f.type.create(f.attrs,w))}let b=o.type.create(o.attrs,h),S=t.tr.replaceWith(r,r+o.nodeSize,b);S=S.setMeta(ue,!0);try{let p=qe?.pmStateMod?.TextSelection;if(p){let f=Math.min(b.childCount-1,Math.max(0,i)),w=Math.min(a,Math.max(0,s+1)),x=b.child(f),A=x.child(w),C=r+1;for(let F=0;F<f;F+=1)C+=b.child(F).nodeSize;C+=1;for(let F=0;F<w;F+=1)C+=x.child(F).nodeSize;let L=C,H=L+1,U=L+A.nodeSize-1;S=S.setSelection(p.near(S.doc.resolve(Math.min(U,H+1)),1))}}catch{}return e.view.dispatch(S.scrollIntoView()),Array.isArray(m)&&m.length===a+1?window.requestAnimationFrame(()=>{let p=on(e.view);no(p,m)}):window.requestAnimationFrame(()=>{let p=on(e.view);Pi(p)}),!0}catch{return!1}}function ym(e,t,n){try{if(!e?.view)return!1;let{state:r,view:o}=e,{selection:i}=r,s=i?.$from||null;if(!s)return!1;let a=n instanceof Set?n:new Set(Array.from(n||[])),c=null;for(let H=s.depth;H>0;H-=1)if(s.node(H)?.type?.name==="paragraph"){let U=s.node(H-1)?.type?.name||"";a.has(U)&&(c=H);break}if(c==null)return!1;let l=c-1,d=s.node(l),m=s.index(l);if(!d)return!1;let h=t<0?-1:1,b=m+h;if(!(b>=0&&b<d.childCount))return!1;let S=d.child(m),p=d.child(b);if(S?.type?.name!=="paragraph"||p?.type?.name!=="paragraph")return!1;let f=s.before(c),w=S.nodeSize,x=h<0?f-p.nodeSize:f+w,A=p.nodeSize,C=Math.max(0,i.from-s.start(c)),L=r.tr;if(h<0){L=L.delete(f,f+w),L=L.insert(x,S);let H=x,U=H+1,F=H+S.nodeSize-1,X=U+C,G=Math.min(Math.max(X,U),F);try{let oe=qe?.pmStateMod?.TextSelection;oe&&(L=L.setSelection(oe.near(L.doc.resolve(G),1)))}catch{}}else{L=L.delete(f,f+w);let H=f+A;L=L.insert(H,S);let U=H,F=U+1,X=U+S.nodeSize-1,G=F+C,oe=Math.min(Math.max(G,F),X);try{let we=qe?.pmStateMod?.TextSelection;we&&(L=L.setSelection(we.near(L.doc.resolve(oe),1)))}catch{}}return L=L.setMeta(ue,!0),o.dispatch(L.scrollIntoView()),!0}catch{return!1}}function bd(e,t){return ym(e,t,new Set(["outlineBody","tableCell","tableHeader"]))}function Sd(e,t){try{if(!e?.view)return!1;let{state:n,view:r}=e,{selection:o}=n,i=o?.$from||null;if(!i)return!1;let s=null;for(let C=i.depth;C>0;C-=1)if(i.node(C)?.type?.name==="listItem"){s=C;break}if(s==null)return!1;let a=s-1,c=i.node(a),l=c?.type?.name||"";if(l!=="bulletList"&&l!=="orderedList")return!1;let d=i.index(a),m=t<0?-1:1,h=d+m;if(!(h>=0&&h<c.childCount))return!1;let b=c.child(d),S=c.child(h);if(b?.type?.name!=="listItem"||S?.type?.name!=="listItem")return!1;let p=i.before(s),f=b.nodeSize,w=S.nodeSize,x=Math.max(0,o.from-i.start(s)),A=n.tr;if(m<0){let C=p-w;A=A.delete(p,p+f),A=A.insert(C,b);let L=C,H=L+1,U=L+b.nodeSize-1,F=H+x,X=Math.min(Math.max(F,H),U);try{let G=qe?.pmStateMod?.TextSelection;G&&(A=A.setSelection(G.near(A.doc.resolve(X),1)))}catch{}}else{A=A.delete(p,p+f);let C=p+w;A=A.insert(C,b);let L=C,H=L+1,U=L+b.nodeSize-1,F=H+x,X=Math.min(Math.max(F,H),U);try{let G=qe?.pmStateMod?.TextSelection;G&&(A=A.setSelection(G.near(A.doc.resolve(X),1)))}catch{}}return A=A.setMeta(ue,!0),r.dispatch(A.scrollIntoView()),!0}catch{return!1}}function bm(e){if(!j.outlineToolbar||!e)return;let t=j.outlineToolbar,n=null,r={undo:j.outlineUndoBtn,redo:j.outlineRedoBtn,attachBtn:t.querySelector("#outlineAttachBtn"),attachInput:t.querySelector("#outlineAttachInput"),deleteBtn:j.outlineDeleteBtn,moveUpBtn:j.outlineMoveUpBtn,moveDownBtn:j.outlineMoveDownBtn,outdentBtn:j.outlineOutdentBtn,indentBtn:j.outlineIndentBtn,newBelowBtn:j.outlineNewBelowBtn,blocksMenuBtn:t.querySelector("#outlineBlocksMenuBtn"),textMenuBtn:t.querySelector("#outlineTextMenuBtn"),listsMenuBtn:t.querySelector("#outlineListsMenuBtn"),tableMenuBtn:t.querySelector("#outlineTableMenuBtn")},o=new Set(Array.from(t.querySelectorAll(".outline-toolbar__dropdown-btn")));r.blocksMenuBtn&&o.add(r.blocksMenuBtn),r.textMenuBtn&&o.add(r.textMenuBtn),r.listsMenuBtn&&o.add(r.listsMenuBtn),r.tableMenuBtn&&o.add(r.tableMenuBtn);let i=Array.from(o),s=Array.from(t.querySelectorAll(".outline-toolbar__menu")),a=Array.from(t.querySelectorAll("[data-outline-action]")),c=Array.from(t.querySelectorAll("[data-outline-clipboard-action]")),l=(Y,ie)=>{if(!Y)return()=>{};let pe=he=>{he.preventDefault(),he.stopPropagation(),ie()};return Y.addEventListener("click",pe),()=>Y.removeEventListener("click",pe)},d=(Y,ie)=>{Y&&(Y.classList.toggle("is-active",!!ie),Y.setAttribute("aria-pressed",ie?"true":"false"))},m=()=>{for(let Y of s)Y.classList.add("hidden");for(let Y of i)Y.setAttribute("aria-expanded","false")},h=()=>{let Y=Sa(),ie=!!(Y&&Array.isArray(Y.sections)&&Y.sections.length);for(let pe of c)pe?.getAttribute?.("data-outline-clipboard-action")==="paste"&&pe.toggleAttribute("disabled",!ie)},b=Y=>{if(!Y)return;let ie=Y.getAttribute("aria-controls"),pe=ie?t.querySelector(`#${ie}`)||document.getElementById(ie):null;if(!pe)return!1;let he=!pe.classList.contains("hidden");return m(),he||(ie==="outlineBlocksMenu"&&h(),pe.classList.remove("hidden"),Y.setAttribute("aria-expanded","true")),!0},S="ttree_outline_debug_dropdown_v1",p=()=>{try{return window?.localStorage?.getItem?.(S)==="1"}catch{return!1}},f=(Y,ie={})=>{try{if(!p())return;console.log("[outline][dropdown]",Y,ie)}catch{}},w=Y=>{try{let ie=e.can().chain();return A()&&ie.command(({tr:pe})=>(pe.setMeta(ue,!0),!0)),Y(ie),ie.run()}catch{return!1}},x=Y=>{if(!Y)return!1;try{let ie=e.chain().focus();if(A()&&ie.command(({tr:pe})=>(pe.setMeta(ue,!0),!0)),Y==="collapseAllBlocks")return wa(e,!0);if(Y==="expandAllBlocks")return wa(e,!1);if(Y==="toggleBold")return ie.toggleBold().run();if(Y==="toggleItalic")return ie.toggleItalic().run();if(Y==="toggleStrike")return ie.toggleStrike().run();if(Y==="toggleCodeBlock")return e.commands.command(({state:pe,dispatch:he})=>{let ge=pe.schema.nodes?.codeBlock||null;if(!ge)return!1;let Be=pe.selection,{from:ve,to:de}=Be;if(ve===de){let ot=pe.tr.setMeta(ue,!0);return he(ot),e.commands.toggleCodeBlock()}let Ne=Be.$from?.blockRange?.(Be.$to)||null;if(!Ne){let ot=pe.tr.setMeta(ue,!0);return he(ot),e.commands.toggleCodeBlock()}if(!Ne.parent?.canReplaceWith?.(Ne.startIndex,Ne.endIndex,ge)){let ot=pe.tr.setMeta(ue,!0);return he(ot),e.commands.toggleCodeBlock()}let Ke=pe.doc.textBetween(Ne.start,Ne.end,`
`,`
`),Ve=String(Ke||"").replace(/\n+$/g,"").trimEnd();if(!Ve)return!1;let rt=ge.create(null,pe.schema.text(Ve)),Ze=pe.tr.replaceRangeWith(Ne.start,Ne.end,rt);return Ze=Ze.setMeta(ue,!0),ne&&(Ze=Ze.setSelection(ne.near(Ze.doc.resolve(Ne.start+2),1))),he(Ze.scrollIntoView()),!0});if(Y==="toggleBlockquote")return ie.toggleBlockquote().run();if(Y==="unsetLink")return ie.unsetLink().run();if(Y==="toggleBulletList")return e.isActive("orderedList")?ie.toggleOrderedList().toggleBulletList().run():ie.toggleBulletList().run();if(Y==="toggleOrderedList")return e.isActive("bulletList")?ie.toggleBulletList().toggleOrderedList().run():ie.toggleOrderedList().run();if(Y==="unsetList")return e.isActive("bulletList")?ie.toggleBulletList().run():e.isActive("orderedList")?ie.toggleOrderedList().run():ie.liftListItem("listItem").run();if(Y==="insertTable")return ie.insertTable({rows:2,cols:2,withHeaderRow:!1}).run();if(Y==="toggleHeaderRow")return ie.toggleHeaderRow().run();if(Y==="toggleHeaderColumn")return ie.toggleHeaderColumn().run();if(Y==="addRowBefore")return ie.addRowBefore().run();if(Y==="addRowAfter")return ie.addRowAfter().run();if(Y==="deleteRow")return ie.deleteRow().run();if(Y==="addColumnBefore"){let pe=zt(e.state),he=pe?Math.max(0,Number(pe.colIndex||0)):0,ge=ie.addColumnBefore().run();return ge&&Oi(e,{insertIndex:he,newColPct:10}),ge}if(Y==="addColumnAfter"){let pe=zt(e.state),he=pe?Math.max(0,Number(pe.colIndex||0)+1):1,ge=ie.addColumnAfter().run();return ge&&Oi(e,{insertIndex:he,newColPct:10}),ge}if(Y==="deleteColumn"){let pe=on(e.view),he=to(pe),ge=zt(e.state),Be=ge?Number(ge.colIndex||0):null,ve=he&&Be!=null?Fd(he,Be):null,de=ie.deleteColumn().run();return de&&Array.isArray(ve)&&window.requestAnimationFrame(()=>{let Ne=on(e.view);no(Ne,ve)}),de}return Y==="mergeCells"?ie.mergeCells().run():Y==="splitCell"?ie.splitCell().run():Y==="copyColumn"||Y==="pasteColumnAfter"||Y==="moveColumnRight"?!1:Y==="cancelTable"?L():Y==="deleteTable"?ie.deleteTable().run():!1}catch{return!1}},A=()=>{try{return!!(Ee?.getState?.(e.state)||null)?.editingSectionId}catch{return!1}},C=()=>A()?!0:(Qr(),!1),L=()=>{if(!C())return!1;try{let{state:Y,view:ie}=e,{schema:pe,selection:he}=Y,ge=he?.$from;if(!ge)return!1;let Be=null;for(let te=ge.depth;te>=0;te-=1)ge.node(te)?.type?.name==="table"&&(Be=te);if(Be==null)return!1;let ve=null,de=null;for(let te=Be+1;te<=ge.depth;te+=1){let y=ge.node(te)?.type?.name;if(ve==null&&y==="tableRow"&&(ve=te),de==null&&(y==="tableCell"||y==="tableHeader")&&(de=te),ve!=null&&de!=null)break}let Ne=ge.before(Be),Ke=Y.doc.nodeAt(Ne);if(!Ke||Ke.type?.name!=="table")return!1;let Ve=ve!=null?ge.index(Be):null,rt=ve!=null&&de!=null?ge.index(ve):null,Ze=null;if(typeof Ve=="number"&&typeof rt=="number"){let te=Ke.childCount&&Ke.child(0)?.childCount||0;te>0&&(Ze=Ve*te+rt)}let ot=[],Je=0,at=0;for(let te=0;te<Ke.childCount;te+=1){let ce=Ke.child(te);for(let y=0;y<ce.childCount;y+=1){let g=ce.child(y),v=[];try{for(let k=0;k<(g?.content?.childCount||0);k+=1){let N=g.content.child(k);N&&v.push(N)}}catch{}v.length||v.push(pe.nodes.paragraph.create(null,[])),Ze!=null&&Je===Ze&&(at=ot.length),ot.push(...v),Je+=1}}if(!ot.length)return!1;let ct=pe.nodes.outlineBody?pe.nodes.outlineBody.create({},ot).content:pe.nodes.doc.create({},ot).content,it=Y.tr.replaceWith(Ne,Ne+Ke.nodeSize,ct);it=it.setMeta(ue,!0);try{let te=qe?.pmStateMod?.TextSelection;if(te){let ce=Ne;for(let N=0;N<at;N+=1)ce+=ot[N].nodeSize;let y=null,g=Math.min(it.doc.content.size,ce),v=Math.min(it.doc.content.size,ce+2e4);it.doc.nodesBetween(g,v,(N,_)=>y!=null?!1:N?.isTextblock?(y=_+1,!1):!0);let k=y??Math.min(it.doc.content.size,ce+1);it=it.setSelection(te.near(it.doc.resolve(k),1))}}catch{}return ie.dispatch(it.scrollIntoView()),ie.focus?.(),!0}catch{return!1}},H=()=>{if(!C())return!1;try{let{state:Y,view:ie}=e,{selection:pe}=Y,he=pe?.$from;if(!he)return!1;let ge=null,Be=null,ve=null;for(let it=he.depth;it>=0;it-=1){let ce=he.node(it)?.type?.name;if(ve==null&&(ce==="tableCell"||ce==="tableHeader")&&(ve=it),Be==null&&ce==="tableRow"&&(Be=it),ce==="table"){ge=it;break}}if(ge==null||Be==null||ve==null)return!1;let de=he.before(ge),Ne=Y.doc.nodeAt(de);if(!Ne||Ne.type?.name!=="table")return!1;let Ke=he.index(ge),Ve=he.index(Be),rt=Ne.child(0)?.childCount||0;if(!(rt>0)||!(Ve>=0&&Ve<rt-1))return!1;let Ze=!1;if(Ne.descendants(it=>{if(Ze)return!1;let te=it?.type?.name;if(te==="tableCell"||te==="tableHeader"){let ce=Number(it.attrs?.colspan||1),y=Number(it.attrs?.rowspan||1);if(ce!==1||y!==1)return Ze=!0,!1}return!0}),Ze)return Ie("\u041F\u0435\u0440\u0435\u043C\u0435\u0449\u0435\u043D\u0438\u0435 \u0441\u0442\u043E\u043B\u0431\u0446\u043E\u0432 \u043F\u043E\u043A\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F \u0434\u043B\u044F \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0451\u043D\u043D\u044B\u0445 \u044F\u0447\u0435\u0435\u043A"),!1;let ot=pe.from-he.start(ve),Je=[];for(let it=0;it<Ne.childCount;it+=1){let te=Ne.child(it);if(te.type?.name!=="tableRow"||te.childCount!==rt)return!1;let ce=[];for(let y=0;y<rt;y+=1)y===Ve?ce.push(te.child(y+1)):y===Ve+1?ce.push(te.child(y-1)):ce.push(te.child(y));Je.push(te.type.create(te.attrs,ce))}let at=Ne.type.create(Ne.attrs,Je),ct=Y.tr.replaceWith(de,de+Ne.nodeSize,at);ct=ct.setMeta(ue,!0);try{let it=qe?.pmStateMod?.TextSelection;if(it){let te=Math.min(at.childCount-1,Math.max(0,Ke)),ce=Ve+1,y=at.child(te),g=y.child(ce),v=de+1;for(let D=0;D<te;D+=1)v+=at.child(D).nodeSize;v+=1;for(let D=0;D<ce;D+=1)v+=y.child(D).nodeSize;let k=v,N=k+1,_=k+g.nodeSize-1,O=N+Math.max(0,ot),K=Math.min(Math.max(O,N),_);ct=ct.setSelection(it.near(ct.doc.resolve(K),1))}}catch{}return ie.dispatch(ct.scrollIntoView()),ie.focus?.(),!0}catch{return!1}},U=(Y,ie,pe={})=>{let he=String(Y||"").trim();if(!he)return!1;let ge=String(ie||"").trim()||he,{from:Be,to:ve,empty:de}=e.state.selection,Ne={href:he,...pe},Ke=e.chain().focus();return A()&&Ke.command(({tr:Ve})=>(Ve.setMeta(ue,!0),!0)),!de&&Be!==ve?Ke.setLink(Ne).run():Ke.insertContent({type:"text",text:ge,marks:[{type:"link",attrs:Ne}]}).run()},F=async()=>{if(!C())return;let{from:Y,to:ie,empty:pe}=e.state.selection,he=pe?"":e.state.doc.textBetween(Y,ie," ").trim(),ge="",Be=he;try{let de=await(await Promise.resolve().then(()=>(tr(),fs))).showLinkPrompt({title:"\u0421\u0441\u044B\u043B\u043A\u0430 (URL)",message:"\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0441\u0441\u044B\u043B\u043A\u0443 (\u043B\u044E\u0431\u043E\u0439 \u0444\u043E\u0440\u043C\u0430\u0442) \u0438 \u0442\u0435\u043A\u0441\u0442 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E).",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",textLabel:"\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)",urlLabel:"\u0421\u0441\u044B\u043B\u043A\u0430",defaultText:he,defaultUrl:"",urlPlaceholder:""});if(!de||typeof de!="object")return;ge=String(de.url||""),Be=String(de.text??he)}catch{ge=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0441\u0441\u044B\u043B\u043A\u0443")||"",Be=he||window.prompt("\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)")||""}ge=(ge||"").trim(),ge&&U(ge,Be,{target:"_blank",rel:"noopener noreferrer"})},X=async()=>{if(!C())return;let Y=Array.isArray(u.articlesIndex)?u.articlesIndex:[];Y.length||(Y=await kn().catch(()=>[])||[],Array.isArray(Y)&&(u.articlesIndex=Y));let ie=(Array.isArray(Y)?Y:[]).map(ot=>({id:ot.id,title:ot.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"})),{from:pe,to:he,empty:ge}=e.state.selection,Be=ge?"":e.state.doc.textBetween(pe,he," ").trim(),ve=!!Be,de="",Ne="",Ke=Be;try{let Je=await(await Promise.resolve().then(()=>(tr(),fs))).showArticleLinkPrompt({title:"\u0421\u0441\u044B\u043B\u043A\u0430 \u043D\u0430 \u0441\u0442\u0430\u0442\u044C\u044E",message:"\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E \u0438 \u0437\u0430\u0434\u0430\u0439\u0442\u0435 \u0442\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438.",confirmText:"\u0412\u0441\u0442\u0430\u0432\u0438\u0442\u044C",cancelText:"\u041E\u0442\u043C\u0435\u043D\u0430",suggestions:ie,defaultTextValue:Be,lockTextValue:ve});if(Je&&typeof Je=="object")de=Je.articleValue||"",Ne=Je.selectedId||"",Ke=Je.textValue||"";else return}catch{de=window.prompt("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 ID \u0441\u0442\u0430\u0442\u044C\u0438")||"",Ke=Be||window.prompt("\u0422\u0435\u043A\u0441\u0442 \u0441\u0441\u044B\u043B\u043A\u0438 (\u043C\u043E\u0436\u043D\u043E \u043F\u0443\u0441\u0442\u043E)")||""}let Ve=(de||"").trim().toLowerCase();if(!Ve&&!Ne)return;let rt=(Array.isArray(Y)?Y:[]).find(ot=>{let Je=(ot.title||"").toLowerCase();return Ne&&ot.id===Ne||ot.id&&ot.id.toLowerCase()===Ve||Je===Ve||Je.includes(Ve)});if(!rt){Ie("\u0421\u0442\u0430\u0442\u044C\u044F \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430");return}let Ze=(Ke||"").trim()||rt.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F";U(rn.article(rt.id),Ze,{class:"article-link"})},G=()=>{if(!u.isOutlineEditing||!e||e.isDestroyed)return;let Y=A();if(t.dataset.editing=Y?"true":"false",n===null?n=Y:n!==Y&&(m(),n=Y),r.deleteBtn&&(r.deleteBtn.hidden=Y),r.moveUpBtn&&(r.moveUpBtn.hidden=Y),r.moveDownBtn&&(r.moveDownBtn.hidden=Y),r.outdentBtn&&(r.outdentBtn.hidden=Y),r.indentBtn&&(r.indentBtn.hidden=Y),r.newBelowBtn&&(r.newBelowBtn.hidden=Y),r.blocksMenuBtn&&(r.blocksMenuBtn.hidden=Y),r.attachBtn&&(r.attachBtn.hidden=!Y),Y&&Yn&&Zr(!1),r.undo&&(r.undo.disabled=!w(he=>he.undo())),r.redo&&(r.redo.disabled=!w(he=>he.redo())),r.textMenuBtn){let he=e.isActive("bold")||e.isActive("italic")||e.isActive("strike")||e.isActive("codeBlock")||e.isActive("blockquote");d(r.textMenuBtn,he),r.textMenuBtn.hidden=!Y}if(r.listsMenuBtn){let he=e.isActive("bulletList")||e.isActive("orderedList");d(r.listsMenuBtn,he),r.listsMenuBtn.hidden=!Y}if(r.tableMenuBtn){let he=e.isActive("table");d(r.tableMenuBtn,he),r.tableMenuBtn.hidden=!Y}let ie=null,pe=()=>{if(ie)return ie;let he={total:0,collapsed:0};try{e.state.doc.descendants(ge=>{ge?.type?.name==="outlineSection"&&(he.total+=1,ge.attrs?.collapsed&&(he.collapsed+=1))})}catch{}return ie=he,he};for(let he of a){let ge=he.dataset.outlineAction||"";if(!ge)continue;let Be=!1,ve=!1;if(ge==="collapseAllBlocks"){let de=pe();Be=!1,ve=de.total===0||de.collapsed>=de.total}else if(ge==="expandAllBlocks"){let de=pe();Be=!1,ve=de.total===0||de.collapsed<=0}else ge==="toggleBold"?(Be=e.isActive("bold"),ve=!w(de=>de.toggleBold())):ge==="toggleItalic"?(Be=e.isActive("italic"),ve=!w(de=>de.toggleItalic())):ge==="toggleStrike"?(Be=e.isActive("strike"),ve=!w(de=>de.toggleStrike())):ge==="toggleCodeBlock"?(Be=e.isActive("codeBlock"),ve=!A()):ge==="toggleBlockquote"?(Be=e.isActive("blockquote"),ve=!w(de=>de.toggleBlockquote())):ge==="insertHttpLink"||ge==="insertArticleLink"?(Be=!1,ve=!A()):ge==="unsetLink"?(Be=e.isActive("link"),ve=!w(de=>de.unsetLink())):ge==="toggleBulletList"?(Be=e.isActive("bulletList"),e.isActive("orderedList")?ve=!(w(de=>de.toggleOrderedList())&&w(de=>de.toggleBulletList())):ve=!w(de=>de.toggleBulletList())):ge==="toggleOrderedList"?(Be=e.isActive("orderedList"),e.isActive("bulletList")?ve=!(w(de=>de.toggleBulletList())&&w(de=>de.toggleOrderedList())):ve=!w(de=>de.toggleOrderedList())):ge==="unsetList"?(Be=!1,e.isActive("bulletList")?ve=!w(de=>de.toggleBulletList()):e.isActive("orderedList")?ve=!w(de=>de.toggleOrderedList()):ve=!w(de=>de.liftListItem("listItem"))):ge==="insertTable"?(Be=!1,ve=!w(de=>de.insertTable({rows:2,cols:2,withHeaderRow:!1}))):ge==="toggleHeaderRow"?(Be=e.isActive("tableHeader"),ve=!w(de=>de.toggleHeaderRow())):ge==="toggleHeaderColumn"?(Be=e.isActive("tableHeader"),ve=!w(de=>de.toggleHeaderColumn())):ge==="addRowBefore"?(Be=!1,ve=!w(de=>de.addRowBefore())):ge==="addRowAfter"?(Be=!1,ve=!w(de=>de.addRowAfter())):ge==="deleteRow"?(Be=!1,ve=!w(de=>de.deleteRow())):ge==="addColumnBefore"?(Be=!1,ve=!w(de=>de.addColumnBefore())):ge==="addColumnAfter"?(Be=!1,ve=!w(de=>de.addColumnAfter())):ge==="deleteColumn"?(Be=!1,ve=!w(de=>de.deleteColumn())):ge==="copyColumn"||ge==="pasteColumnAfter"||ge==="moveColumnRight"?(Be=!1,ve=!0):ge==="mergeCells"?(Be=!1,ve=!w(de=>de.mergeCells())):ge==="splitCell"?(Be=!1,ve=!w(de=>de.splitCell())):ge==="cancelTable"?(Be=!1,ve=!A()||!e.isActive("table")):ge==="deleteTable"&&(Be=!1,ve=!w(de=>de.deleteTable()));he.disabled=!!ve,he.classList.toggle("is-active",!!Be)}},oe=null,we=()=>{oe||(oe=window.requestAnimationFrame(()=>{oe=null,G()}))},Ce=[l(r.undo,()=>e.chain().focus().undo().run()),l(r.redo,()=>e.chain().focus().redo().run()),l(r.attachBtn,()=>{if(!C())return;let Y=r.attachInput;if(!Y){Ie("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u0432\u044B\u0431\u043E\u0440 \u0444\u0430\u0439\u043B\u0430");return}try{Y.value=""}catch{}try{if(typeof Y.showPicker=="function"){Y.showPicker();return}}catch{}Y.click()})];try{let Y=r.attachInput;Y&&!Y.__ttreeOutlineAttachBound&&(Object.defineProperty(Y,"__ttreeOutlineAttachBound",{value:!0}),Y.addEventListener("change",()=>{if(!C())return;let ie=Array.from(Y.files||[]);if(ie.length){for(let pe of ie)if(pe)try{ba(pe)?vd(e.view,pe):Td(e.view,pe)}catch{}}},{passive:!0}))}catch{}let ne=qe?.pmStateMod?.TextSelection||null,ye=(Y,ie)=>{try{let pe=Y.resolve(Math.min(Y.content.size,ie+1)),he=null;for(let ge=pe.depth;ge>0;ge-=1){if(pe.node(ge)?.type?.name!=="outlineSection")continue;if(pe.before(ge)===ie){he=ge;break}}if(he===null)return null;for(let ge=he-1;ge>0;ge-=1)if(pe.node(ge)?.type?.name==="outlineSection")return pe.before(ge);return null}catch{return null}},Ye=Y=>{try{if(!ne)return;e.commands.command(({state:ie,dispatch:pe})=>{let he=Ct(ie.doc,ie.selection.$from);if(typeof he!="number")return!1;let ge=ie.doc.resolve(he),Be=ge.index(),ve=ge.parent;if(!ve)return!1;let de=ie.doc.nodeAt(he);if(!de)return!1;if(Y==="up"){if(Be>0){let N=ve.child(Be-1),_=he-N.nodeSize,O=ie.tr.delete(he,he+de.nodeSize).insert(_,de);return O=O.setMeta(ue,!0),O=O.setSelection(ne.near(O.doc.resolve(_+2),1)),pe(O.scrollIntoView()),!0}let Ne=ye(ie.doc,he);if(typeof Ne!="number")return!1;let Ke=ie.doc.resolve(Ne),Ve=Ke.index(),rt=Ke.parent;if(!rt||Ve<=0)return!1;let Ze=rt.child(Ve-1),ot=Ne-Ze.nodeSize,Je=ie.doc.nodeAt(ot);if(!Je||Je.type?.name!=="outlineSection")return!1;let at=Je.child(0),ct=Je.child(1),it=Je.child(2),ce=ot+1+at.nodeSize+ct.nodeSize+it.nodeSize-1,y=ie.tr.delete(he,he+de.nodeSize).setMeta(ue,!0),g=y.mapping.map(ot,-1),v=y.mapping.map(ce,-1);y=y.insert(v,de);let k=y.doc.nodeAt(g);return k?.type?.name==="outlineSection"&&k.attrs?.collapsed&&(y=y.setNodeMarkup(g,void 0,{...k.attrs,collapsed:!1})),y=y.setSelection(ne.near(y.doc.resolve(v+2),1)),pe(y.scrollIntoView()),!0}if(Y==="down"){if(Be<ve.childCount-1){let N=he+de.nodeSize,_=ie.doc.nodeAt(N);if(!_)return!1;let O=ie.tr.delete(he,he+de.nodeSize),K=he+_.nodeSize;return O=O.insert(K,de),O=O.setMeta(ue,!0),O=O.setSelection(ne.near(O.doc.resolve(K+2),1)),pe(O.scrollIntoView()),!0}let Ne=ye(ie.doc,he);if(typeof Ne!="number")return!1;let Ke=ie.doc.nodeAt(Ne);if(!Ke||Ke.type?.name!=="outlineSection")return!1;let Ve=ie.doc.resolve(Ne),rt=Ve.index(),Ze=Ve.parent;if(!Ze||rt>=Ze.childCount-1)return!1;let ot=Ne+Ke.nodeSize,Je=ie.doc.nodeAt(ot);if(!Je||Je.type?.name!=="outlineSection")return!1;let at=Je.child(0),ct=Je.child(1),it=Je.child(2),ce=ot+1+at.nodeSize+ct.nodeSize+1,y=ie.tr.delete(he,he+de.nodeSize).setMeta(ue,!0),g=y.mapping.map(ot,-1),v=y.mapping.map(ce,-1);y=y.insert(v,de);let k=y.doc.nodeAt(g);return k?.type?.name==="outlineSection"&&k.attrs?.collapsed&&(y=y.setNodeMarkup(g,void 0,{...k.attrs,collapsed:!1})),y=y.setSelection(ne.near(y.doc.resolve(v+2),1)),pe(y.scrollIntoView()),!0}return!1})}catch{}},wt=()=>{try{if(!ne)return;e.commands.command(({state:Y,dispatch:ie})=>{let pe=Ct(Y.doc,Y.selection.$from);if(typeof pe!="number")return!1;let he=Y.doc.resolve(pe),ge=0;for(let te=he.depth;te>=0;te-=1)he.node(te)?.type?.name==="outlineSection"&&(ge+=1);if(ge>=6)return!1;let Be=he.index(),ve=he.parent;if(!ve||Be<=0)return!1;let de=Y.doc.nodeAt(pe);if(!de)return!1;let Ne=ve.child(Be-1),Ke=pe-Ne.nodeSize,Ve=Y.doc.nodeAt(Ke);if(!Ve)return!1;let rt=Ve.child(0),Ze=Ve.child(1),ot=Ve.child(2),at=Ke+1+rt.nodeSize+Ze.nodeSize+ot.nodeSize-1,ct=Y.tr.delete(pe,pe+de.nodeSize).insert(at,de),it=ct.doc.nodeAt(Ke);return it?.type?.name==="outlineSection"&&it.attrs?.collapsed&&(ct=ct.setNodeMarkup(Ke,void 0,{...it.attrs,collapsed:!1})),ct=ct.setMeta(ue,!0),ct=ct.setSelection(ne.near(ct.doc.resolve(at+2),1)),ie(ct.scrollIntoView()),!0})}catch{}},Pt=()=>{try{if(!ne)return;e.commands.command(({state:Y,dispatch:ie})=>{let pe=Y.selection.$from,he=null,ge=null;for(let rt=pe.depth;rt>0;rt-=1)if(pe.node(rt)?.type?.name==="outlineSection")if(he===null)he=rt;else{ge=rt;break}if(he===null||ge===null)return!1;let Be=pe.before(he),ve=pe.before(ge),de=Y.doc.nodeAt(Be);if(!de)return!1;let Ne=Y.tr.delete(Be,Be+de.nodeSize),Ke=Ne.doc.nodeAt(ve);if(!Ke)return!1;let Ve=ve+Ke.nodeSize;return Ne=Ne.insert(Ve,de),Ne=Ne.setMeta(ue,!0),Ne=Ne.setSelection(ne.near(Ne.doc.resolve(Ve+2),1)),ie(Ne.scrollIntoView()),!0})}catch{}},sn=()=>{try{if(!ne)return;e.commands.command(({state:Y,dispatch:ie})=>{let pe=Ct(Y.doc,Y.selection.$from);if(typeof pe!="number")return!1;let he=Y.doc.nodeAt(pe);if(!he)return!1;let ge=String(he.attrs?.id||"").trim(),Be=Y.doc.resolve(pe),ve=Be.index(),de=Be.parent;if(!de)return!1;let Ne=Y.doc.type.schema;if(de.childCount<=1){let at=Ne.nodes.outlineSection.create({...he.attrs,collapsed:!1},[Ne.nodes.outlineHeading.create({},[]),Ne.nodes.outlineBody.create({},[Ne.nodes.paragraph.create({},[])]),Ne.nodes.outlineChildren.create({},[])]),ct=Y.tr.replaceWith(pe,pe+he.nodeSize,at);ct=ct.setMeta(ue,!0);let it=at.child(0),te=pe+1+it.nodeSize;return ct=ct.setSelection(ne.near(ct.doc.resolve(te+2),1)),ie(ct.scrollIntoView()),!0}ge&&Yr(ge);let Ke=ve>0,Ve=Ke?de.child(ve-1):null,rt=Ke?pe-Ve.nodeSize:null,Ze=Y.tr.delete(pe,pe+he.nodeSize);Ze=Ze.setMeta(ue,!0);let ot=Ke&&typeof rt=="number"?rt:Math.min(Ze.doc.content.size,pe),Je=Ze.doc.nodeAt(ot);if(Je?.type?.name==="outlineSection"){let at=Je.child(0),ct=Je.child(1),it=ot+1+at.nodeSize;ct.childCount||(Ze=Ze.insert(it+1,Ne.nodes.paragraph.create({},[]))),Ze=Ze.setSelection(ne.near(Ze.doc.resolve(it+2),1))}return ie(Ze.scrollIntoView()),!0})}catch{}},mn=()=>{try{if(!ne)return;e.commands.command(({state:Y,dispatch:ie})=>{let pe=Ct(Y.doc,Y.selection.$from);if(typeof pe!="number")return!1;let he=Y.doc.nodeAt(pe);if(!he)return!1;let ge=Y.doc.type.schema,Be=pe+he.nodeSize,ve=Wt(),de=ge.nodes.outlineSection.create({id:ve,collapsed:!1},[ge.nodes.outlineHeading.create({},[]),ge.nodes.outlineBody.create({},[ge.nodes.paragraph.create({},[])]),ge.nodes.outlineChildren.create({},[])]),Ne=Y.tr.insert(Be,de);return Ne=Ne.setSelection(ne.create(Ne.doc,Be+2)),Ne=Ne.setMeta(ue,!0),Ee&&(Ne=Ne.setMeta(Ee,{type:"enter",sectionId:ve})),ie(Ne.scrollIntoView()),!0})}catch{}};Ce.push(l(r.deleteBtn,()=>sn())),Ce.push(l(r.moveUpBtn,()=>Ye("up"))),Ce.push(l(r.moveDownBtn,()=>Ye("down"))),Ce.push(l(r.outdentBtn,()=>Pt())),Ce.push(l(r.indentBtn,()=>wt())),Ce.push(l(r.newBelowBtn,()=>mn()));let An=0,Nn=Y=>{try{return Y?.target&&Y.target.nodeType===1?Y.target:Y?.target?.parentElement||null}catch{return null}},$n=Y=>{let ie=Nn(Y);if(!ie)return null;let pe=ie.closest?.(".outline-toolbar__dropdown-btn")||null;return!pe||!t.contains(pe)?null:pe},Fn=(Y,{source:ie})=>{try{let pe=Date.now();if(An&&pe-An<700){f("toggle.skip.dedupe",{source:ie,dtMs:pe-An});return}let he=$n(Y);if(!he){f("toggle.skip.no-btn",{source:ie,targetClass:String(Nn(Y)?.className||"")});return}if(he.disabled){f("toggle.skip.disabled",{source:ie,btnId:he.id||null});return}Y?.cancelable&&Y.preventDefault(),Y.stopPropagation();let ge=b(he);f("toggle",{source:ie,ok:ge,btnId:he.id||null,menuId:he.getAttribute("aria-controls")||null,expanded:he.getAttribute("aria-expanded")||null}),ge&&(An=pe)}catch(pe){f("toggle.error",{source:ie,message:String(pe?.message||pe||"")})}},Mn=Y=>{try{let ie=String(Y?.pointerType||"");if(ie!=="touch"&&ie!=="pen")return}catch{return}Fn(Y,{source:"pointerdown"})},Ln=Y=>{Fn(Y,{source:"click"})};try{t.addEventListener("pointerdown",Mn,!0),Ce.push(()=>t.removeEventListener("pointerdown",Mn,!0))}catch{}t.addEventListener("click",Ln,!0),Ce.push(()=>t.removeEventListener("click",Ln,!0));let _t=Y=>{try{if(!u.isOutlineEditing)return;t.contains(Y.target)||m()}catch{}},Kt=Y=>{try{if(!u.isOutlineEditing)return;t.contains(Y.target)||m()}catch{}};try{document.addEventListener("touchstart",_t,{passive:!0}),Ce.push(()=>document.removeEventListener("touchstart",_t))}catch{}document.addEventListener("click",Kt),Ce.push(()=>document.removeEventListener("click",Kt));for(let Y of a)Ce.push(l(Y,()=>{let ie=Y.dataset.outlineAction||"";if(ie==="insertHttpLink"){m(),F().finally(()=>we());return}if(ie==="insertArticleLink"){m(),X().finally(()=>we());return}let pe=x(ie);m(),pe&&we()}));for(let Y of c)Ce.push(l(Y,()=>{let ie=Y.getAttribute("data-outline-clipboard-action")||"";if(!ie)return;m();let pe=pn||null,he=fr instanceof Set?fr:new Set,ge=he.size?new Set(he):pe?new Set([pe]):new Set;if(ie==="toggleSelectMode"){Zr(!Yn);return}if(ie==="clear"){Ni(null),Ie("\u0411\u0443\u0444\u0435\u0440 \u043E\u0447\u0438\u0449\u0435\u043D");return}if(le){if(ie==="copy"||ie==="cut"){if(!ge.size){Ie("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A");return}let Be=Vp(le.state.doc,ge);if(!Be.length){Ie("\u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u043B\u043E\u043A");return}let ve=Be.map(Ke=>Ke.node.toJSON());try{let Ke=Be.map(Ve=>Ld(Ve.node)).filter(Boolean).join(`

`);jp(Ke)}catch{}if(Ni({mode:ie==="cut"?"cut":"copy",sourceArticleId:Nt||u.articleId||null,createdAt:new Date().toISOString(),sections:ve}),ie==="copy"){Ie(`\u0421\u043A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${ve.length}`);return}let de=[];for(let Ke of Be){let Ve=mt(le.state.doc,Ke.id),rt=typeof Ve=="number"?le.state.doc.nodeAt(Ve):null;typeof Ve=="number"&&rt&&de.push({pos:Ve,size:rt.nodeSize})}de.sort((Ke,Ve)=>Ve.pos-Ke.pos);let Ne=le.state.tr;for(let{pos:Ke,size:Ve}of de)Ne=Ne.delete(Ke,Ke+Ve);Ne=Ne.setMeta(ue,!0),le.view.dispatch(Ne.scrollIntoView()),le.view.focus(),Qt=!0,Xt({delayMs:200}),Zr(!1),Ie(`\u0412\u044B\u0440\u0435\u0437\u0430\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${ve.length}`);return}if(ie==="paste"){let Be=Sa();if(!Be||!Array.isArray(Be.sections)||!Be.sections.length){Ie("\u0411\u0443\u0444\u0435\u0440 \u043F\u0443\u0441\u0442");return}let ve=le.state,de=ve.doc.content.size;if(pe){let Je=mt(ve.doc,pe),at=typeof Je=="number"?ve.doc.nodeAt(Je):null;typeof Je=="number"&&at&&(de=Je+at.nodeSize)}let Ne=new Set;try{ve.doc.descendants(Je=>{if(Je?.type?.name!=="outlineSection")return;let at=String(Je.attrs?.id||"").trim();at&&Ne.add(at)})}catch{}let Ke=[];if(Be.mode==="copy")for(let Je of Be.sections)Ke.push(Md(Je,()=>Wt()));else for(let Je of Be.sections){let at=String(Je?.attrs?.id||"").trim();if(at&&Ne.has(at)){Ie("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C: \u0431\u043B\u043E\u043A \u0441 \u0442\u0430\u043A\u0438\u043C id \u0443\u0436\u0435 \u0435\u0441\u0442\u044C");return}Ke.push(Ea(Je))}let Ve=ve.doc.type.schema,rt=[];for(let Je of Ke)try{let at=Ve.nodeFromJSON(Je);at?.type?.name==="outlineSection"&&rt.push(at)}catch{}if(!rt.length){Ie("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438");return}let Ze=ve.tr,ot=de;for(let Je of rt)Ze=Ze.insert(ot,Je),ot+=Je.nodeSize;Ze=Ze.setMeta(ue,!0),le.view.dispatch(Ze.scrollIntoView()),le.view.focus(),Qt=!0,Xt({delayMs:200}),Be.mode==="cut"&&Ni(null),Zr(!1),Ie(`\u0412\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${rt.length}`)}}}));let It=Y=>{u.isOutlineEditing&&(t.contains(Y.target)||m())},gt=Y=>{u.isOutlineEditing&&Y.key==="Escape"&&m()};document.addEventListener("pointerdown",It),document.addEventListener("keydown",gt),Ce.push(()=>document.removeEventListener("pointerdown",It)),Ce.push(()=>document.removeEventListener("keydown",gt));let Dt=e.on("transaction",we),an=e.on("selectionUpdate",we);Ce.push(()=>Dt?.()),Ce.push(()=>an?.());try{let Y=tm({setActiveTagKey:ie=>{try{Ri?.(ie)}catch{}}});Ce.push(()=>Y?.())}catch{}we(),Ti=()=>{oe&&(window.cancelAnimationFrame(oe),oe=null);for(let Y of Ce)try{Y()}catch{}}}function Sm(){if(Ti)try{Ti()}catch{}Ti=null}function Gn(e=""){let t=String(e||"");u.outlineStatusText=t,j.updatedAt&&u.isOutlineEditing&&(j.updatedAt.textContent=t)}function wm(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=r.child(1),s=t+1+o.nodeSize,a=n.tr;if(!i.childCount){let l=n.doc.type.schema;a=a.insert(s+1,l.nodes.paragraph.create({},[]))}let{TextSelection:c}=qe?.pmStateMod||{};return c?(a=a.setSelection(c.near(a.doc.resolve(s+2),1)),e.view.dispatch(a.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0):!1}catch{return!1}}function xm(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=t+1,{TextSelection:s}=qe?.pmStateMod||{};if(!s)return!1;let a=i+1,c=i+o.nodeSize-1,l=Math.min(Math.max(a,a),Math.max(a,c)),d=n.tr.setSelection(s.near(n.doc.resolve(l),1));return d=d.setMeta(ue,!0),e.view.dispatch(d.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0}catch{return!1}}function Am(e,t){if(!e||typeof t!="number")return!1;try{let n=e.state,r=n.doc.nodeAt(t);if(!r)return!1;let o=r.child(0),i=t+1,{TextSelection:s}=qe?.pmStateMod||{};if(!s)return!1;let a=i+1,c=i+o.nodeSize-1,l=Math.max(a,c),d=n.tr.setSelection(s.near(n.doc.resolve(l),-1));return d=d.setMeta(ue,!0),e.view.dispatch(d.scrollIntoView()),e.view.focus?.({preventScroll:!0}),!0}catch{return!1}}function Im(e,t){try{if(!e)return!1;let n=String(t||"").trim();if(!n)return!1;let r=e.state,o=mt(r.doc,n);if(typeof o!="number")return!1;let i=r.doc.nodeAt(o);if(!i||i.type?.name!=="outlineSection")return!1;if(i.attrs?.collapsed)return xm(e,o);try{if(!i.child(1)?.childCount)return Am(e,o)}catch{}return wm(e,o)}catch{return!1}}function km(e,t,{block:n="center"}={}){try{let r=String(t||"").trim();if(!e||!r)return!1;let o=e.view;if(!o?.dom?.querySelector)return!1;let i=typeof CSS<"u"&&CSS.escape?CSS.escape(r):r.replace(/"/g,'\\"'),s=()=>{try{let a=o.dom?.querySelector?.(`[data-outline-section][data-section-id="${i}"]`)||o.dom?.querySelector?.(`[data-section-id="${i}"]`);a&&typeof a.scrollIntoView=="function"&&a.scrollIntoView({block:n||"center",inline:"nearest"})}catch{}};try{window.requestAnimationFrame(s)}catch{}try{setTimeout(s,80)}catch{}return!0}catch{return!1}}async function Em(){if(qe)return qe;if(typeof window>"u")throw new Error("Outline editor is browser-only");let e=Ar()?performance.now():0,t=await import("/outline/tiptap.bundle.js");return e&&Xr("import tiptap.bundle.js",{ms:Math.round(performance.now()-e)}),qe={core:t.core,starterKitMod:t.starterKitMod,htmlMod:t.htmlMod,pmStateMod:t.pmStateMod,pmViewMod:t.pmViewMod,pmTablesMod:t.pmTablesMod,linkMod:t.linkMod,imageMod:t.imageMod,mentionMod:t.mentionMod,tableMod:t.tableMod,tableRowMod:t.tableRowMod,tableCellMod:t.tableCellMod,tableHeaderMod:t.tableHeaderMod,uniqueIdMod:t.uniqueIdMod,markdownMod:t.markdownMod},qe}function Cm({blocks:e,parseHtmlToNodes:t}){let n=i=>Array.isArray(i)&&i.length>0?i:[{type:"paragraph",content:[]}],r=i=>{let s=String(i?.id||Wt()),a=!!i?.collapsed,c=Kn(String(i?.text||"")),l=Aa(c.titleHtml)||"",d=n(t(c.bodyHtml||"")),m=Array.isArray(i?.children)?i.children:[];return{type:"outlineSection",attrs:{id:s,collapsed:a},content:[{type:"outlineHeading",content:l?[{type:"text",text:l}]:[]},{type:"outlineBody",content:d},{type:"outlineChildren",content:m.map(r)}]}},o=(Array.isArray(e)?e:[]).map(r);return{type:"doc",content:o.length?o:[r({id:Wt(),text:"",collapsed:!1,children:[]})]}}function vm(e){try{let t=String(e||"").trim();if(!t)return null;let n=window?.localStorage?.getItem?.("ttree_outline_last_active_v1")||"{}",r=JSON.parse(n||"{}"),o=r&&typeof r=="object"?r[t]:null;if(!o||typeof o!="object")return null;let i=String(o.sectionId||"").trim();return i?{sectionId:i,collapsed:!!o.collapsed}:null}catch{return null}}function Vd(e,t,n){try{let r=String(e||"").trim(),o=String(t||"").trim();if(!r||!o)return!1;let i=window?.localStorage?.getItem?.("ttree_outline_last_active_v1")||"{}",s=JSON.parse(i||"{}"),a=s&&typeof s=="object"?s:{};return a[r]={sectionId:o,collapsed:!!n,savedAt:new Date().toISOString()},window?.localStorage?.setItem?.("ttree_outline_last_active_v1",JSON.stringify(a)),!0}catch{return!1}}function wd(e){try{let t=Nt||u.articleId||null;if(!t||!e||e.isDestroyed)return!1;let n=e.state,r=Ct(n.doc,n.selection.$from);if(typeof r!="number")return!1;let o=n.doc.nodeAt(r);if(!o||o.type?.name!=="outlineSection")return!1;let i=String(o.attrs?.id||"").trim();if(!i)return!1;let s=!!o.attrs?.collapsed;return Ei.articleId===t&&Ei.sectionId===i&&Ei.collapsed===s?!1:(Ei={articleId:t,sectionId:i,collapsed:s},Vd(t,i,s))}catch{return!1}}function Tm(e,{lines:t=4}={}){try{if(!e||e.isDestroyed)return!1;let n=e.view;if(!n||!n.state||!n.dom)return!1;let r=n.state.selection;return!r||typeof r.from!="number"?!1:(Ci&&cancelAnimationFrame(Ci),Ci=requestAnimationFrame(()=>{Ci=null;try{let o=n.coordsAtPos(r.from);if(!o||typeof o.bottom!="number")return;let s=(w=>{try{let x=w;for(;x&&x!==document.body&&x!==document.documentElement;){let A=window.getComputedStyle(x),C=String(A.overflowY||"");if((C==="auto"||C==="scroll"||C==="overlay")&&x.scrollHeight>x.clientHeight+2)return x;x=x.parentElement}}catch{}return document.scrollingElement||document.documentElement})(n.dom),a=window.getComputedStyle(n.dom),c=String(a.lineHeight||"").trim(),l=c==="normal"?20:Number.parseFloat(c)||20,d=Math.max(24,l*Math.max(1,Number(t)||4)+12),m=window.innerHeight||0,h=0;if(s&&s!==document.scrollingElement&&s!==document.documentElement&&s!==document.body){let w=s.getBoundingClientRect();h=w.top,m=w.height}if(!m)return;let b=o.bottom-h,S=m-d;if(b<=S)return;let p=b-S,f=Math.max(0,(s.scrollTop||0)+p);s.scrollTop=f}catch{}}),!0)}catch{return!1}}function Ct(e,t){try{if(t?.nodeAfter?.type?.name==="outlineSection")return t.pos}catch{}for(let n=t.depth;n>0;n-=1)if(t.node(n)?.type?.name==="outlineSection")return t.before(n);return null}function zi(e){if(!e)return"";let t=e.child(0),n=e.child(1),r=Wn(t?.textContent||""),o="";try{o=Wn(n?.textBetween?.(0,n.content.size,`
`,`
`)||"")}catch{o=Wn(n?.textContent||"")}return Wn(`${r}
${o}`)}function xd(e){if(!e)return"";let t=e.child(1),n="";try{n=Wn(t?.textBetween?.(0,t.content.size,`
`,`
`)||"")}catch{n=Wn(t?.textContent||"")}return n}function Ad(e){if(!ha||!ga)return"";let t=[];return e?.content?.forEach?.(o=>{t.push(o.toJSON())}),(ha({type:"doc",content:t},ga)||""||"").trim()}function Id(e){try{return Wn(String(e?.textContent||"").replace(/\u00a0/g," ")).trim()}catch{return""}}function Bm(e){try{let t=document.createElement("template");return t.innerHTML=String(e||""),Wn(String(t.content.textContent||"").replace(/\u00a0/g," ")).trim()}catch{return""}}function jd(e){try{if(!e)return null;let t=e.state?.selection||null;if(!t)return null;let n=Number.isFinite(t.anchor)?t.anchor:t.from,r=Number.isFinite(t.head)?t.head:t.to,o=t.$from||null,i=null;try{let s=o?Ct(e.state.doc,o):null;if(typeof s=="number"){let a=e.state.doc.nodeAt(s);i=String(a?.attrs?.id||"")||null}}catch{i=null}return!Number.isFinite(n)||!Number.isFinite(r)?null:{anchor:n,head:r,sectionId:i}}catch{return null}}function Jd(e,t,n){try{if(!e?.view||!t)return!1;let{TextSelection:r}=qe?.pmStateMod||{};if(!r||!n)return e.view.dispatch(t),!0;let o=t.doc?.content?.size??null;if(!Number.isFinite(o))return e.view.dispatch(t),!0;let i=t.mapping.map(Math.max(0,Math.min(n.anchor,o)),1),s=t.mapping.map(Math.max(0,Math.min(n.head,o)),1);try{t=t.setSelection(r.create(t.doc,i,s))}catch{}return e.view.dispatch(t),!0}catch{try{return e?.view?.dispatch?.(t),!0}catch{return!1}}}function Nm(e,t,n,r={}){if(!e||!t)return!1;let o=mt(e.state.doc,t);if(typeof o!="number")return!1;let i=e.state.doc.nodeAt(o);if(!i)return!1;let s=e.state.schema,a=i.child(0),c=o+1,l=String(n||"").replace(/\u00a0/g," ").trim(),d=s.nodes.outlineHeading.create({},l?[s.text(l)]:[]),m=e.state.tr.replaceWith(c,c+a.nodeSize,d).setMeta(ue,!0),h=r?.preserveSelection?jd(e):null;return Jd(e,m,h),!0}function Mm(e,t,n,r={}){if(!e||!t||!Po)return!1;let o=mt(e.state.doc,t);if(typeof o!="number")return!1;let i=e.state.doc.nodeAt(o);if(!i)return!1;let s=i.child(0),a=i.child(1),c=o+1+s.nodeSize,l=e.state.schema,d=[];try{d=Po(n||"")}catch{d=[]}let m=[];try{m=(Array.isArray(d)?d:[]).map(p=>l.nodeFromJSON(p))}catch{m=[l.nodes.paragraph.create({},[])]}m.length||(m=[l.nodes.paragraph.create({},[])]);let h=l.nodes.outlineBody.create({},m),b=e.state.tr.replaceWith(c,c+a.nodeSize,h).setMeta(ue,!0),S=r?.preserveSelection?jd(e):null;return Jd(e,b,S),!0}function ka(e){if(!e)return!0;let t=e.child(0);return!Wn(t?.textContent||"")}function Lm(e,t,n){if(!e||!t)return!1;let r=mt(e.state.doc,t);if(typeof r!="number")return!1;let o=e.state.doc.nodeAt(r);if(!o||!ka(o))return!1;let i=o.child(0),s=r+1,a=s+1,c=s+i.nodeSize-1,l=String(n||"").trim();if(!l)return!1;let d=l.length>200?l.slice(0,200):l,m=e.state.tr.insertText(d,a,c).setMeta(ue,!0);return e.view.dispatch(m),!0}function Pm(e){Tr.clear(),e.descendants(t=>{if(t?.type?.name!=="outlineSection")return;let n=String(t.attrs?.id||"");n&&Tr.set(n,zi(t))})}function mt(e,t){let n=null;return e.descendants((r,o)=>{if(n!==null)return!1;r?.type?.name==="outlineSection"&&String(r.attrs?.id||"")===String(t||"")&&(n=o)}),n}function _m(e,t){try{let n=e.doc,r=mt(n,t),o=typeof r=="number"?n.nodeAt(r):null;if(!o)return null;let i=e.schema,s=i.marks?.code||null,a=i.nodes?.codeBlock||null;if(!s||!a)return null;let c=o.child(0),l=o.child(1);if(!c||!l)return null;let m=r+1+c.nodeSize+1,h=[];if(l.descendants((S,p)=>{if(!S||S.type?.name!=="paragraph")return;let f=!1,w=!1,x=!0;for(let L=0;L<S.childCount;L+=1){let H=S.child(L);if(H){if(H.type?.name==="hardBreak"){w=!0;continue}if(H.isText){if(!String(H.text||""))continue;if(!(Array.isArray(H.marks)?H.marks:[]).some(G=>G?.type===s)){x=!1;break}f=!0;continue}x=!1;break}}if(!x||!f||!w)return;let A="";for(let L=0;L<S.childCount;L+=1){let H=S.child(L);if(H){if(H.type?.name==="hardBreak"){A+=`
`;continue}H.isText&&(A+=String(H.text||""))}}if(!A.trim())return;let C=m+p;h.push({from:C,to:C+S.nodeSize,text:A})}),!h.length)return null;let b=e.tr;for(let S=h.length-1;S>=0;S-=1){let{from:p,to:f,text:w}=h[S],x=b.doc.resolve(p),A=x.parent,C=x.index();if(!A?.canReplaceWith?.(C,C+1,a))continue;let L=i.text(w),H=a.create(null,L);b=b.replaceWith(p,f,H)}return b.docChanged?b.setMeta(ue,!0):null}catch{return null}}function Wd(e,t,n){if(!e||!t||!n||u.article?.encrypted)return;let r=mt(t,n),o=typeof r=="number"?t.nodeAt(r):null;if(!o||!ka(o))return;let i=xd(o);if(!i)return;let s=Ia(i),a=ua.get(n)||null;a?.inFlight||a?.bodyHash!==s&&(ua.set(n,{bodyHash:s,inFlight:!0}),yc(i).then(c=>{let l=String(c?.title||"").trim();if(!l||l.length>200)return;let d=e.state.doc,m=mt(d,n),h=typeof m=="number"?d.nodeAt(m):null;if(!h||!ka(h))return;let b=xd(h);if(!(Ia(b)!==s||!Lm(e,n,l))){Qt=!0;try{let p=Nt||u.articleId||null;p&&(Ca({articleId:p,doc:e.state.doc,sectionId:n,reason:"generate_title"}),Gn("\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438 \u043D\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044E"))}catch{}Xt({delayMs:900})}}).catch(()=>{}).finally(()=>{ua.set(n,{bodyHash:s,inFlight:!1})}))}function Dm(e,t,n){if(!(!e||!t)&&!(!Array.isArray(n)||!n.length)&&!u.article?.encrypted&&!(typeof navigator<"u"&&navigator&&navigator.onLine===!1)){try{if((Ee?.getState?.(e.state)||null)?.editingSectionId)return}catch{}for(let r of n)try{Wd(e,t,r)}catch{}}}function kd(e,t,n){let r=String(n||"").trim(),o=(H,U={})=>Rt("skip",{reason:H,sectionId:r,...U});if(!e||!t||!r){o("missing_args",{hasEditor:!!e,hasDoc:!!t,hasSectionId:!!r});return}if(u.article?.encrypted){o("encrypted_article");return}try{if(typeof navigator<"u"&&navigator&&navigator.onLine===!1){o("offline");return}}catch{}let i=mt(t,r),s=typeof i=="number"?t.nodeAt(i):null;if(!s){o("section_not_found",{pos:typeof i=="number"?i:null});return}let a=s.child(0),c=s.child(1),l=Id(a),d=l?`<p>${Lo(l)}</p>`:"",m=Ad(c);if(!d&&!m){o("empty_heading_and_body");return}let h=d?Wr(d):"",b=m?Wr(m):"",S=(H,U)=>{if(!U||H?.inFlight||H?.status==="ok"&&H?.htmlHash===U)return!0;if(H?.status==="error"&&H?.htmlHash===U){let F=Number(H?.lastAttemptAtMs||0)||0;if(Date.now()-F<Hp)return!0}return!1},p=Jr.get(r)||null,f=jr.get(r)||null,w=S(p,h),x=S(f,b);if(w&&x){o("already_ok_or_in_flight",{headingHash:h||null,bodyHash:b||null});try{eo.delete(r)}catch{}return}let A=w,C=x,L=()=>{try{A&&C&&eo.delete(r)}catch{}};w||(Rt("start_heading",{sectionId:r,htmlHash:h}),Jr.set(r,{htmlHash:h,inFlight:!0,status:p?.status||"ok",lastAttemptAtMs:Date.now()}),cs(d).then(H=>{if(H&&H.ok===!1){Rt("unavailable_heading",{sectionId:r,reason:String(H.reason||"")}),Jr.set(r,{htmlHash:h,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()});let Ye=Date.now();Ye-ki>6e4&&(ki=Ye,Ie("\u041A\u043E\u0440\u0440\u0435\u043A\u0442\u0443\u0440\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 (\u043D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0430 \u043A OpenAI)."));return}let U=String(H?.html||"").trim();if(!U){Rt("skip_apply_heading",{sectionId:r,reason:"empty_corrected_html"});return}let F=Bm(U);if(!F){Rt("skip_apply_heading",{sectionId:r,reason:"empty_corrected_plain"});return}let X=e.state.doc,G=mt(X,r),oe=typeof G=="number"?X.nodeAt(G):null;if(!oe){Rt("skip_apply_heading",{sectionId:r,reason:"section_not_found_current_doc"});return}let we=Id(oe.child(0)),Ce=we?`<p>${Lo(we)}</p>`:"";if(Wr(Ce)!==h){Rt("skip_apply_heading",{sectionId:r,reason:"heading_changed_since_request"});return}if(Wr(`<p>${Lo(F)}</p>`)===h){Rt("skip_apply_heading",{sectionId:r,reason:"no_changes_from_server"});return}if(!Nm(e,r,F,{preserveSelection:!0})){Rt("skip_apply_heading",{sectionId:r,reason:"apply_failed"});return}Qt=!0,Xt({delayMs:900})}).catch(()=>{Rt("error_heading",{sectionId:r,htmlHash:h}),Jr.set(r,{htmlHash:h,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()})}).finally(()=>{(Jr.get(r)||null)?.status!=="error"&&Jr.set(r,{htmlHash:h,inFlight:!1,status:"ok",lastAttemptAtMs:Date.now()}),Rt("done_heading",{sectionId:r,htmlHash:h}),A=!0,L()})),x||(Rt("start",{sectionId:r,htmlHash:b}),jr.set(r,{htmlHash:b,inFlight:!0,status:f?.status||"ok",lastAttemptAtMs:Date.now()}),cs(m).then(H=>{if(H&&H.ok===!1){Rt("unavailable",{sectionId:r,reason:String(H.reason||"")}),jr.set(r,{htmlHash:b,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()});let Ce=Date.now();Ce-ki>6e4&&(ki=Ce,Ie("\u041A\u043E\u0440\u0440\u0435\u043A\u0442\u0443\u0440\u0430 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u0430 (\u043D\u0435\u0442 \u0434\u043E\u0441\u0442\u0443\u043F\u0430 \u043A OpenAI)."));return}let U=String(H?.html||"").trim();if(!U){Rt("skip_apply",{sectionId:r,reason:"empty_corrected_html"});return}let F=e.state.doc,X=mt(F,r),G=typeof X=="number"?F.nodeAt(X):null;if(!G){Rt("skip_apply",{sectionId:r,reason:"section_not_found_current_doc"});return}let oe=Ad(G.child(1));if(Wr(oe)!==b){Rt("skip_apply",{sectionId:r,reason:"body_changed_since_request"});return}if(Wr(U)===b){Rt("skip_apply",{sectionId:r,reason:"no_changes_from_server"});return}if(!Mm(e,r,U,{preserveSelection:!0})){Rt("skip_apply",{sectionId:r,reason:"apply_failed"});return}Qt=!0,Xt({delayMs:900})}).catch(()=>{Rt("error",{sectionId:r,htmlHash:b}),jr.set(r,{htmlHash:b,inFlight:!1,status:"error",lastAttemptAtMs:Date.now()})}).finally(()=>{(jr.get(r)||null)?.status!=="error"&&jr.set(r,{htmlHash:b,inFlight:!1,status:"ok",lastAttemptAtMs:Date.now()}),Rt("done",{sectionId:r,htmlHash:b}),C=!0,L()}))}function kr(e,t){if(!t)return!1;let n=mt(e,t);if(typeof n!="number")return!1;let r=e.nodeAt(n);if(!r)return!1;let o=zi(r),i=Tr.get(t)||"";if(o===i)return!1;Br.add(t);try{eo.add(t)}catch{}return!0}function Xt({delayMs:e=1200}={}){u.isOutlineEditing&&le&&(u.isPublicView||Nt&&u.articleId&&Nt!==u.articleId||(Vn&&clearTimeout(Vn),Vn=setTimeout(()=>{Vn=null,Mo()},Math.max(200,e))))}async function Mo({force:e=!1}={}){if(u.isOutlineEditing&&le&&!u.isPublicView&&!(Nt&&u.articleId&&Nt!==u.articleId)&&!vi&&!(!e&&!Qt&&!Br.size)){vi=!0,Gn("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C\u2026");try{try{let t=le.state,n=Ct(t.doc,t.selection.$from);if(typeof n=="number"){let r=t.doc.nodeAt(n),o=String(r?.attrs?.id||"");o&&kr(t.doc,o)}}catch{}await Om({silent:!0,mode:"queue"})}finally{vi=!1}}}async function Yd(){if(!j.outlineEditor)return;let e=j.outlineEditor.querySelector("#outlineEditorContent");if(!e){Ie("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043C\u043E\u043D\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440");return}if(oc(),vo)return vo;vo=(async()=>{let t=Ar()?performance.now():0,n=Ar()?performance.now():0,{core:r,starterKitMod:o,htmlMod:i,pmStateMod:s,pmViewMod:a}=await Em();n&&Xr("loadTiptap()",{ms:Math.round(performance.now()-n)});let{Editor:c,Node:l,Extension:d,InputRule:m,mergeAttributes:h}=r,b=o.default||o.StarterKit||o,{generateJSON:S,generateHTML:p}=i,{TextSelection:f}=s,{Plugin:w,PluginKey:x}=s,{Decoration:A,DecorationSet:C}=a,L=qe.linkMod.default||qe.linkMod.Link||qe.linkMod,H=qe.imageMod.default||qe.imageMod.Image||qe.imageMod,U=qe.mentionMod?.default||qe.mentionMod?.Mention||qe.mentionMod,F=qe.tableMod.TableKit||qe.tableMod.tableKit;At={TableMap:qe.pmTablesMod?.TableMap||null,CellSelection:qe.pmTablesMod?.CellSelection||null,moveTableColumn:qe.pmTablesMod?.moveTableColumn||null,moveTableRow:qe.pmTablesMod?.moveTableRow||null,addRowBefore:qe.pmTablesMod?.addRowBefore||null,addRowAfter:qe.pmTablesMod?.addRowAfter||null,deleteRow:qe.pmTablesMod?.deleteRow||null,addColumnBefore:qe.pmTablesMod?.addColumnBefore||null,addColumnAfter:qe.pmTablesMod?.addColumnAfter||null,deleteColumn:qe.pmTablesMod?.deleteColumn||null,toggleHeaderRow:qe.pmTablesMod?.toggleHeaderRow||null,toggleHeaderColumn:qe.pmTablesMod?.toggleHeaderColumn||null};let X=qe.uniqueIdMod.default||qe.uniqueIdMod.UniqueID||qe.uniqueIdMod,G=qe.markdownMod?.Markdown||qe.markdownMod?.default?.Markdown||qe.markdownMod?.default||null,oe=y=>{let g=String(y||"").trim();if(!g)return null;let v=g.match(/(\d+(?:\.\d+)?)px/i);if(!v)return null;let k=Number.parseFloat(v[1]);return Number.isFinite(k)?k:null},we=new x("outlineTagHighlighter"),Ce=null,ne=d.create({name:"outlineTagSuggestKeys",addProseMirrorPlugins(){return[new w({key:new x("outlineTagSuggestKeys"),props:{handleKeyDown(y,g){try{return Ce?.isOpen?.()?!!Ce.handleKeyDown?.(g):!1}catch{return!1}}}})]}}),ye=(()=>{if(!U||typeof U.extend!="function")return null;let y=()=>{let g=null,v=null,k=[],N=0,_=null,O=null,K=()=>{g||(g=document.createElement("div"),g.className="tt-tag-suggest",v=document.createElement("div"),v.className="tt-tag-suggest__list",g.appendChild(v),document.body.appendChild(g))},D=()=>{try{g?.remove()}catch{}g=null,v=null,k=[],N=0,_=null,Ce===O&&(Ce=null)},M=I=>{if(!g||!I)return;let P=I();P&&(g.style.left=`${Math.max(8,P.left)}px`,g.style.top=`${Math.max(8,P.bottom+6)}px`)},B=I=>{if(!(!g||!v)&&(_=I||null,k=Array.isArray(I?.items)?I.items:[],v.innerHTML="",k.forEach((P,$)=>{let V=document.createElement("button");V.type="button",V.className=$===N?"tt-tag-suggest__item active":"tt-tag-suggest__item",V.textContent=String(P?.label||P?.key||""),V.addEventListener("pointerdown",z=>{z.preventDefault(),z.stopPropagation(),I.command(P)}),v.appendChild(V)}),!k.length)){let P=document.createElement("div");P.className="tt-tag-suggest__empty",P.textContent="\u041D\u0435\u0442 \u0441\u043E\u0432\u043F\u0430\u0434\u0435\u043D\u0438\u0439",v.appendChild(P)}},E=I=>{let P=k.length;P&&(N=(N+I+P)%P)},T=I=>{if(!I||!g)return!1;if(I.key==="Escape")return I.preventDefault(),I.stopPropagation(),D(),!0;if(I.key===" "||I.code==="Space"){if(!_)return!1;if(!k.length){let $=To(_?.query||"");return $?(I.preventDefault(),I.stopPropagation(),_.command({key:$,label:$}),!0):!1}I.preventDefault(),I.stopPropagation();let P=k[N];return P&&_.command(P),!0}if(I.key==="ArrowDown")return I.preventDefault(),I.stopPropagation(),E(1),B(_),!0;if(I.key==="ArrowUp")return I.preventDefault(),I.stopPropagation(),E(-1),B(_),!0;if(I.key==="Enter"){if(!_)return!1;I.preventDefault(),I.stopPropagation();let P=k[N];return P&&_.command(P),!0}return!1};return O={isOpen:()=>!!g,handleKeyDown:T},Ce=O,{char:"\\",allowedPrefixes:null,allowSpaces:!1,startOfLine:!1,items:({query:I})=>{let P=String(I||""),$=To(P),V=rc(),z=new Map,q=new Map;try{for(let[me,Ae]of V?.counts?.entries?.()||[]){let Te=String(me||"").trim();Te&&(z.set(Te,Number(Ae||0)||0),q.set(Te,String(V?.labelByKey?.get?.(Te)||Te)))}}catch{}for(let[me,Ae]of Xn.counts.entries()){let Te=String(me||"").trim();Te&&(z.has(Te)||z.set(Te,Number(Ae||0)||0),q.has(Te)||q.set(Te,String(Xn.labelByKey.get(Te)||Te)))}let Z=Array.from(z.entries()).map(([me,Ae])=>({key:me,label:q.get(me)||me,count:Ae})).sort((me,Ae)=>(Ae.count||0)-(me.count||0));return($?Z.filter(me=>String(me.key||"").includes($)||String(me.label||"").toLowerCase().includes($.toLowerCase())):Z).slice(0,8)},command:({editor:I,range:P,props:$})=>{try{let V=String($?.key||$?.label||""),z=Li(V),q=To(z);if(!q)return;I.chain().focus().insertContentAt(P,[{type:"tag",attrs:{label:q,key:q}}]).insertContent(" ").run()}catch{}},render:()=>({onStart:I=>{N=0,K(),B(I),M(I.clientRect)},onUpdate:I=>{N=0,K(),B(I),M(I.clientRect)},onKeyDown:I=>T(I?.event),onExit:()=>D()})}};return U.extend({name:"tag",group:"inline",inline:!0,atom:!0,selectable:!1,addAttributes(){return{label:{default:""},key:{default:""}}},parseHTML(){return[{tag:'span[data-tt-tag="1"]'}]},renderText({node:g}){try{return Li(g?.attrs?.label||g?.attrs?.key||"")||""}catch{return""}},renderHTML({node:g,HTMLAttributes:v}){let k=Li(g?.attrs?.label||g?.attrs?.key||"")||"",N=To(g?.attrs?.key||k)||"";return["span",h(v,{"data-tt-tag":"1","data-tag-key":N,class:"tt-tag"}),k||N||""]}}).configure({suggestion:y()})})(),Ye=d.create({name:"outlineTagHighlighter",addProseMirrorPlugins(){return[new w({key:we,state:{init:()=>({activeKey:null}),apply:(y,g)=>{let v=y.getMeta(we);return v&&Object.prototype.hasOwnProperty.call(v,"activeKey")?{activeKey:v.activeKey?String(v.activeKey):null}:g}},props:{decorations(y){let g=we.getState(y)?.activeKey||null,v=[];return y.doc.descendants((k,N)=>{if(k?.type?.name!=="tag")return;let _=String(k.attrs?.key||"").trim();if(!_)return;let O=g&&_===g?"tt-tag tt-tag--active":"tt-tag";v.push(A.node(N,N+k.nodeSize,{class:O}))}),v.length?C.create(y.doc,v):null}}})]}}),wt=H.extend({inline:!0,group:"inline",addAttributes(){return{...typeof this.parent=="function"?this.parent():{},width:{default:320,parseHTML:g=>{try{let v=g,k=v&&v.classList&&v.classList.contains("resizable-image")?v:v?.closest?.(".resizable-image"),N=oe(k?.style?.width||"");if(N!==null)return Math.round(N);let _=oe(k?.getAttribute?.("style")||"")||oe(v?.getAttribute?.("style")||"");if(_!==null)return Math.round(_);let O=k?.getAttribute?.("data-width")||v?.getAttribute?.("data-width")||"",K=Number.parseFloat(String(O||""));return Number.isFinite(K)&&K>0?Math.round(K):320}catch{return 320}},renderHTML:()=>({})},aspectRatio:{default:null,parseHTML:g=>{try{let v=g,k=v&&v.classList&&v.classList.contains("resizable-image")?v:v?.closest?.(".resizable-image"),N=k?.style?.aspectRatio||k?.getAttribute?.("data-aspect-ratio")||v?.getAttribute?.("data-aspect-ratio")||"",_=Number.parseFloat(String(N||"").replace(",","."));return Number.isFinite(_)&&_>0?_:null}catch{return null}},renderHTML:()=>({})},uploadToken:{default:null,parseHTML:()=>null,renderHTML:()=>({})}}},parseHTML(){return[{tag:"span.resizable-image",getAttrs:y=>{let g=y,v=g?.querySelector?.("img"),k=v?.getAttribute?.("src")||"";if(!k)return!1;let N=v?.getAttribute?.("alt")||"",_=v?.getAttribute?.("title")||"",O=oe(g?.style?.width||"")??320;return{src:k,alt:N,title:_,width:Math.round(O)}}},{tag:"img[src]",getAttrs:y=>{let g=y,v=g?.getAttribute?.("src")||"";if(!v)return!1;let k=g?.getAttribute?.("alt")||"",N=g?.getAttribute?.("title")||"";return{src:v,alt:k,title:N,width:320}}}]},renderHTML({node:y,HTMLAttributes:g}){let v=y?.attrs?.width,k=Number.isFinite(Number(v))?Math.round(Number(v)):320,N=y?.attrs?.aspectRatio,_=Number.isFinite(Number(N))&&Number(N)>0?Number(N):null,O={...g};return delete O.width,delete O.aspectRatio,delete O.uploadToken,O.style=`${String(O.style||"").trim()};width:100%;height:auto;display:block;`.replace(/^;\s*/,""),["span",h({class:"resizable-image",style:`width:${k}px;max-width:100%;${_?`aspect-ratio:${_.toFixed(6)};`:""}`,..._?{"data-aspect-ratio":String(_)}:{}},{}),["span",{class:"resizable-image__inner"},["img",h(O,{draggable:"false"})]],["span",{class:"resizable-image__handle","data-direction":"e","aria-hidden":"true"}]]}});ha=p,ga=[b.configure({heading:!1,link:!1}),L.configure({openOnClick:!1,protocols:Ai}),wt,F.configure({table:{resizable:!0}})];let Pt=d.create({name:"outlineImageUpload",addProseMirrorPlugins(){let y=(v,k)=>{let N=[];return Array.from(v||[]).forEach(_=>{if(_.kind!=="file")return;let O=typeof _.getAsFile=="function"?_.getAsFile():null;O&&ba(O)&&N.push(O)}),!N.length&&k?.length&&Array.from(k).forEach(_=>{ba(_)&&N.push(_)}),N},g=(v,k,N,_)=>{try{if(!(Ee?.getState?.(v.state)||null)?.editingSectionId)return!1}catch{return!1}let O=y(N,_);if(!O.length)return!1;k.preventDefault(),k.stopPropagation();for(let K of O)vd(v,K);return!0};return[new w({props:{handleDOMEvents:{paste(v,k){let N=k?.clipboardData?.items||null,_=k?.clipboardData?.files||null;return g(v,k,N,_)},drop(v,k){let N=k?.dataTransfer?.items||null,_=k?.dataTransfer?.files||null;return g(v,k,N,_)}}},view(v){return{update(k,N){try{let _=Ee?.getState?.(N)||{},O=Ee?.getState?.(k.state)||{},K=_.editingSectionId||null,D=O.editingSectionId||null;if(K&&!D){let M=String(K||"").trim(),B=Nt||u.articleId||null;if(!M||!B)return;let E=!1;try{let T=mt(k.state.doc,M),I=typeof T=="number"?k.state.doc.nodeAt(T):null;I?.type?.name==="outlineSection"&&(E=!!I.attrs?.collapsed)}catch{}Vd(B,M,E);try{let T=mt(k.state.doc,M),I=typeof T=="number"?k.state.doc.nodeAt(T):null;if(!I||I.type?.name!=="outlineSection")return;let P=!Tr.has(M),$=P||kr(k.state.doc,M),V=!1;if($){let q=I.child(0),Z=I.child(1),se=q?.toJSON?q.toJSON():null,xe=Z?.toJSON?Z.toJSON():null;if(se&&xe){let me=_d(se,xe);if(me>Di){Ie(`\u0411\u043B\u043E\u043A \u0441\u043B\u0438\u0448\u043A\u043E\u043C \u0431\u043E\u043B\u044C\u0448\u043E\u0439 (${Math.ceil(me/1024)} KB). \u041C\u0430\u043A\u0441\u0438\u043C\u0443\u043C: ${Math.ceil(Di/1024)} KB. \u0420\u0430\u0437\u0431\u0435\u0439\u0442\u0435 \u0431\u043B\u043E\u043A \u043D\u0430 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u043E.`);try{let _e=k.state.tr.setMeta(ue,!0);_e=_e.setMeta(Ee,{type:"enter",sectionId:M}),k.dispatch(_e)}catch{}return}let Ae=Date.now(),Te=Pd(B,M);try{dt("outline.enqueue.section_upsert_content",{articleId:B,sectionId:M,seq:Te,bytes:me,reason:P?"exit_edit_mode_new_section":"exit_edit_mode"})}catch{}V=!0,tn("section_upsert_content",{articleId:B,payload:{sectionId:M,headingJson:se,bodyJson:xe,seq:Te,clientQueuedAt:Ae},coalesceKey:`content:${B}:${M}`})}}let z=!1;if(P||Rn||Ft){let q=_o(k.state.doc);if(q.length){let Z=null;try{Z=q.filter(se=>se&&(se.parentId==null||se.parentId==="")&&Number(se.position)>=0).sort((se,xe)=>Number(se.position)-Number(xe.position)).slice(0,3).map(se=>String(se.sectionId||""))}catch{Z=null}try{dt("outline.enqueue.structure_snapshot",{articleId:B,nodesCount:q.length,reason:P?"exit_edit_mode_new_section":"exit_edit_mode",rootFirst:Z})}catch{}tn("structure_snapshot",{articleId:B,payload:{nodes:q},coalesceKey:`structure:${B}`}),z=!0}Rn=!1,Ft&&(clearTimeout(Ft),Ft=null)}try{(V||P)&&(Tr.set(M,zi(I)),Br.delete(M))}catch{}try{V&&le&&!le.isDestroyed&&le.view===k&&Wd(le,k.state.doc,M)}catch{}(V||z)&&Gn("\u0412 \u043E\u0447\u0435\u0440\u0435\u0434\u0438 \u043D\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044E")}catch{}}}catch{}}}}})]}}),sn=d.create({name:"outlineImageResize",addProseMirrorPlugins(){return[new w({view(y){let g=null,v=(O,K)=>{try{if((y.state.selection?.node||null)?.type?.name==="image"&&typeof y.state.selection.from=="number")return y.state.selection.from;let M=V=>{if(typeof V!="number")return null;let z=[V,V-1,V+1,V-2,V+2];for(let q of z){if(q<0)continue;if(y.state.doc.nodeAt(q)?.type?.name==="image")return q}return null},B=O?.querySelector?.("img")||null,E=M(y.posAtDOM(O,0));if(typeof E=="number")return E;let T=B?M(y.posAtDOM(B,0)):null;if(typeof T=="number")return T;let I=K&&typeof K.clientX=="number"&&typeof K.clientY=="number"?{left:K.clientX,top:K.clientY}:null,P=I?y.posAtCoords(I):null,$=P&&typeof P.pos=="number"?M(P.pos):null;return typeof $=="number"?$:null}catch{return null}},k=O=>{if(O.button!==0)return;let K=O.target?.closest?.(".resizable-image__handle");if(!K)return;let D=K.closest(".resizable-image");if(!D||!y.dom.contains(D)||!(Ee?.getState?.(y.state)||null)?.editingSectionId)return;let B=v(D,O);if(typeof B!="number")return;let E=y.state.doc.nodeAt(B);if(!E||E.type?.name!=="image")return;O.preventDefault(),O.stopPropagation();let T=D.getBoundingClientRect();g={pos:B,startWidth:T.width,startX:O.clientX,wrapper:D,lastWidth:T.width},D.classList.add("resizable-image--resizing")},N=O=>{if(!g)return;O.preventDefault();let K=O.clientX-g.startX,M=parseFloat(getComputedStyle(document.documentElement).fontSize)||16,B=Math.max(M,document.documentElement.clientWidth-32),E=10,T=g.startWidth+K;T=Math.max(M,Math.min(T,B)),T=Math.round(T/E)*E,T=Math.max(M,Math.min(T,B)),g.lastWidth=T,g.wrapper.style.width=`${Math.round(T)}px`},_=()=>{if(!g)return;let{pos:O,wrapper:K}=g;K.classList.remove("resizable-image--resizing");let D=y.state.doc.nodeAt(O)?.type?.name==="image"?O:v(K,null),M=typeof D=="number"?y.state.doc.nodeAt(D):null;if(M&&M.type?.name==="image"){let E=Number(g.lastWidth||0)||K.getBoundingClientRect().width,T=Math.max(1,Math.round(E/10)*10),I={...M.attrs,width:T},P=y.state.tr.setNodeMarkup(D,void 0,I);P=P.setMeta(ue,!0),y.dispatch(P)}g=null};return y.dom.addEventListener("pointerdown",k),document.addEventListener("pointermove",N),document.addEventListener("pointerup",_),document.addEventListener("pointercancel",_),{destroy(){y.dom.removeEventListener("pointerdown",k),document.removeEventListener("pointermove",N),document.removeEventListener("pointerup",_),document.removeEventListener("pointercancel",_)}}}})]}}),mn=d.create({name:"outlineImagePreview",addProseMirrorPlugins(){return[new w({props:{handleDOMEvents:{click(y,g){try{if((Ee?.getState?.(y.state)||null)?.editingSectionId)return!1;let k=g?.target?.closest?.("img");return k?g.target?.closest?.(".resizable-image__handle")?(g.preventDefault(),!0):(g.preventDefault(),uo(k.src,k.alt||""),!0):!1}catch{return!1}}}}})]}}),An=d.create({name:"outlineMarkdownTablePaste",addProseMirrorPlugins(){let y=(g,v)=>{try{if(!(Ee?.getState?.(g.state)||null)?.editingSectionId)return!1;let N=v?.clipboardData?.getData?.("text/plain")||"";if(wn("paste: text/plain",{len:N.length,sample:N.slice(0,200)}),!N)return!1;let _=va(N),O=Er(_);wn("paste: parsed",{ok:!!O,lines:_});let K=O?null:Cr(_);if(!O&&!K)return!1;let D=O?{header:O.header,rows:O.rows,withHeader:!0}:{header:null,rows:K.rows,withHeader:!1},M=null;try{M=lr(g.state.schema,D)}catch(E){return wn("paste: buildTableNode error",{message:String(E?.message||E||""),stack:String(E?.stack||""),schemaNodes:Object.keys(g.state.schema?.nodes||{})}),!1}if(wn("paste: tableNode",{ok:!!M,schemaNodes:xa()?Object.keys(g.state.schema?.nodes||{}):void 0}),!M)return!1;v.preventDefault(),v.stopPropagation();let B=g.state.tr;g.state.selection.empty||(B=B.deleteSelection());try{B=B.replaceSelectionWith(M,!1)}catch(E){return wn("paste: replaceSelectionWith error",{message:String(E?.message||E||""),stack:String(E?.stack||""),selection:{from:g.state.selection?.from,to:g.state.selection?.to,empty:g.state.selection?.empty,$fromParent:g.state.selection?.$from?.parent?.type?.name}}),!1}return B=B.setMeta(ue,!0),g.dispatch(B.scrollIntoView()),!0}catch(k){return wn("paste: unexpected error",{message:String(k?.message||k||""),stack:String(k?.stack||"")}),!1}};return[new w({appendTransaction(g,v,k){try{let N=g?.some?.(B=>B?.docChanged),_=null;if(Ee)for(let B of g||[]){let E=B?.getMeta?.(Ee)||null;if(E?.type==="enter"&&E?.sectionId){_=String(E.sectionId);break}}let O=!!_;if(!N&&!O||g.some(B=>B.getMeta?.(ue)))return null;let K=Ee?.getState?.(k)||null,D=_||K?.editingSectionId||null;if(!D)return null;wn("appendTransaction: try convert",{didDocChange:N,didEnterEditMode:O,sectionId:D});let M=om(k,D);if(M)return M;if(xa()){let B=mt(k.doc,D),E=typeof B=="number"?k.doc.nodeAt(B):null,T=E?E.child(1):null,I=T?T.textContent:"";String(I||"").includes("|")&&wn("appendTransaction: saw pipes but no conversion",{sectionId:D})}return _m(k,D)}catch{return null}},props:{handlePaste(g,v){return y(g,v)},handleDOMEvents:{paste(g,v){return y(g,v)}}}})]}}),Nn=d.create({name:"outlineStructuredSectionPaste",addProseMirrorPlugins(){let y=_=>{let O=String(_||"").trim();if(!O)return{sections:[],startsWithHeading:!1,headingCount:0};if(!/<h[1-6][\s>]/i.test(O))return{sections:[],startsWithHeading:!1,headingCount:0};let K=null;try{K=new DOMParser().parseFromString(O,"text/html")}catch{return{sections:[],startsWithHeading:!1,headingCount:0}}let D=K?.body;if(!D)return{sections:[],startsWithHeading:!1,headingCount:0};let M=!1;try{let I=Array.from(D.childNodes||[]).find(P=>P?.nodeType===1&&String(P?.textContent||"").trim());M=!!(I&&/^H[1-6]$/.test(String(I.nodeName||"")))}catch{M=!1}let B=[],E=null,T=()=>{if(!E)return;let I=document.createElement("div");for(let $ of E.nodes)try{I.appendChild($.cloneNode(!0))}catch{}let P=String(I.innerText||I.textContent||"").trimEnd();B.push({level:E.level,title:E.title,bodyText:P}),E=null};for(let I of Array.from(D.childNodes||[])){let V=(I?.nodeType===1?String(I.nodeName||"").toUpperCase():"").match(/^H([1-6])$/);if(V){T();let z=Number(V[1]),q=String(I.textContent||"").trim();if(!q)continue;E={level:z,title:q,nodes:[]};continue}E&&E.nodes.push(I)}return T(),{sections:B,startsWithHeading:M,headingCount:B.length}},g=_=>{let O=_?.selection?.$from;if(!O)return null;for(let K=O.depth;K>0;K-=1)if(O.node(K)?.type?.name==="outlineSection")return O.before(K);return null},v=(_,O)=>{let K=String(O||"").replace(/\r\n/g,`
`).trimEnd(),D=_.nodes.paragraph;if(!D)return[];let M=_.nodes.hardBreak||_.nodes.hard_break||null,B=I=>{let P=String(I||"").split(`
`),$=[];for(let V=0;V<P.length;V+=1){let z=P[V];V>0&&M&&$.push(M.create()),z&&$.push(_.text(z))}return D.create({},$)};if(!K.trim())return[D.create({},[])];let E=K.split(/\n{2,}/),T=[];for(let I of E){let P=String(I||"").trimEnd();T.push(B(P))}return T.length?T:[D.create({},[])]},k=(_,O)=>{let K=_.nodes.outlineHeading.create({},O.title?[_.text(O.title)]:[]),D=v(_,O.bodyText),M=_.nodes.outlineBody.create({},D),B=(O.children||[]).map(T=>k(_,T)),E=_.nodes.outlineChildren.create({},B);return _.nodes.outlineSection.create({id:O.id,collapsed:!1},[K,M,E])},N=(_,O)=>{try{if(!(Ee?.getState?.(_.state)||null)?.editingSectionId)return!1;let D=O?.clipboardData?.getData?.("text/html")||"",M=O?.clipboardData?.getData?.("text/plain")||"",B=D?y(D):{sections:[],startsWithHeading:!1,headingCount:0},E=!B.sections.length&&M?ra(M):{sections:[],startsWithHeading:!1,headingCount:0},T=B.sections.length?B:E;if(!T.sections.length||!(T.startsWithHeading||T.sections.length>=2))return!1;O.preventDefault(),O.stopPropagation();let P=g(_.state);if(typeof P!="number")return!1;let $=_.state.doc.nodeAt(P);if(!$||$.type?.name!=="outlineSection")return!1;let V=Ql(T.sections,{makeId:()=>Wt()});if(!V.length)return!1;let z=_.state.schema,q=V.map(xe=>k(z,xe)),Z=_.state.tr,se=P+$.nodeSize;for(let xe of q)Z=Z.insert(se,xe),se+=xe.nodeSize;return Z=Z.setMeta(ue,!0),_.dispatch(Z.scrollIntoView()),!0}catch{return!1}};return[new w({props:{handlePaste(_,O){return N(_,O)},handleDOMEvents:{paste(_,O){return N(_,O)}}}})]}}),$n=(y="")=>{let g=String(y||"").trim();return g?g.startsWith("app:/")||g.startsWith("disk:/")?`/api/yandex/disk/file?path=${encodeURIComponent(g)}`:g:""},Fn=d.create({name:"outlineAttachmentUpload",addProseMirrorPlugins(){let y=k=>{let N=String(k?.type||"");return!(N&&N.startsWith("image/"))},g=(k,N)=>{let _=[];try{let O=[];if(N&&typeof N.length=="number")O.push(...Array.from(N||[]));else if(k&&typeof k.length=="number")for(let K of Array.from(k||[])){if(!K||K.kind!=="file")continue;let D=K.getAsFile?.();D&&O.push(D)}for(let K of O)K&&y(K)&&_.push(K)}catch{}return _},v=(k,N,_,O)=>{let K=g(_,O);if(!K.length)return!1;N.preventDefault(),N.stopPropagation();try{if(!(Ee?.getState?.(k.state)||null)?.editingSectionId)return Qr(),!0}catch{return Qr(),!0}for(let D of K)Td(k,D);return!0};return[new w({props:{handleDOMEvents:{drop(k,N){let _=N?.dataTransfer?.items||null,O=N?.dataTransfer?.files||null;return v(k,N,_,O)},paste(k,N){let _=N?.clipboardData?.items||null,O=N?.clipboardData?.files||null;return v(k,N,_,O)}}}})]}}),Mn=l.create({name:"doc",topNode:!0,content:"outlineSection+"}),Ln=l.create({name:"outlineChildren",content:"outlineSection*",defining:!0,renderHTML(){return["div",{class:"outline-children","data-outline-children":"true"},0]},parseHTML(){return[{tag:"div[data-outline-children]"}]},addNodeView(){return({node:y})=>{let g=document.createElement("div");g.className="outline-children",g.setAttribute("data-outline-children","true");let v=k=>{let N=!k||k.childCount===0;g.setAttribute("data-empty",N?"true":"false")};return v(y),{dom:g,contentDOM:g,update(k){return!k||k.type?.name!=="outlineChildren"?!1:(v(k),!0)}}}}}),_t=y=>{try{if(!y||y.childCount===0)return!0;let g=!1;return y.descendants(v=>{if(g)return!1;let k=v?.type?.name;return k==="image"||k==="table"||v.isText&&String(v.text||"").replace(/\u00a0/g," ").trim()?(g=!0,!1):!0}),!g}catch{return!1}},Kt=l.create({name:"outlineBody",content:"block*",defining:!0,renderHTML(){return["div",{class:"outline-body","data-outline-body":"true"},0]},parseHTML(){return[{tag:"div[data-outline-body]"}]},addNodeView(){return({node:y})=>{let g=document.createElement("div");g.className="outline-body",g.setAttribute("data-outline-body","true");let v=k=>{let N=_t(k);g.setAttribute("data-empty",N?"true":"false")};return v(y),{dom:g,contentDOM:g,update(k){return!k||k.type?.name!=="outlineBody"?!1:(v(k),!0)}}}}}),It=l.create({name:"outlineHeading",content:"inline*",defining:!0,renderHTML(){return["div",{class:"outline-heading","data-outline-heading":"true"},0]},parseHTML(){return[{tag:"div[data-outline-heading]"}]},addNodeView(){return({editor:y,getPos:g,node:v})=>{let k=document.createElement("div");k.className="outline-heading",k.setAttribute("data-outline-heading","true");let N=document.createElement("button");N.type="button",N.className="outline-heading__toggle",N.title="\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C/\u0440\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C (Ctrl+\u2190/\u2192), \u0441 \u0434\u0435\u0442\u044C\u043C\u0438 (Ctrl+\u2191/\u2193)",N.setAttribute("aria-label","\u0421\u0432\u0435\u0440\u043D\u0443\u0442\u044C/\u0440\u0430\u0437\u0432\u0435\u0440\u043D\u0443\u0442\u044C");let _=document.createElement("div");_.className="outline-heading__content";let O=document.createElement("button");O.type="button",O.className="outline-heading__select",O.setAttribute("role","checkbox"),O.setAttribute("aria-checked","false"),O.setAttribute("aria-label","\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0431\u043B\u043E\u043A"),O.textContent="\u2713",O.addEventListener("pointerdown",D=>{D.preventDefault()}),O.addEventListener("click",D=>{if(D.preventDefault(),D.stopPropagation(),!Yn)return;let M=typeof g=="function"?g():null;if(typeof M!="number")return;let B=M-1,E=y.state.doc.nodeAt(B),T=String(E?.attrs?.id||"").trim();T&&Kp(T)});let K=()=>{let D=typeof g=="function"?g():null;if(typeof D!="number")return;let M=D-1,B=y.state.doc.nodeAt(M),E=String(B?.attrs?.id||"");E&&k.setAttribute("data-section-id",E),k.dataset.empty=v.content.size===0?"true":"false";let T=y.state.doc.resolve(Math.max(0,M+1)),I=0;for(let $=T.depth;$>=0;$-=1)T.node($)?.type?.name==="outlineSection"&&(I+=1);k.dataset.depth=String(Math.min(6,Math.max(1,I||1)));let P=Yn&&E&&fr.has(E);O.setAttribute("aria-checked",P?"true":"false"),O.style.display=Yn?"inline-flex":"none"};return N.addEventListener("click",D=>{D.preventDefault(),D.stopPropagation();let M=typeof g=="function"?g():null;if(typeof M!="number")return;let B=M-1,E=y.state.doc.nodeAt(B);if(!E)return;let T=!E.attrs?.collapsed,I=y.state.tr.setNodeMarkup(B,void 0,{...E.attrs,collapsed:T});try{T&&Ee&&(Ee.getState(y.state)||{}).editingSectionId&&(I=I.setMeta(Ee,{type:"exit"}))}catch{}I.setMeta(ue,!0),y.view.dispatch(I),y.view.focus()}),k.appendChild(N),k.appendChild(_),k.appendChild(O),K(),{dom:k,contentDOM:_,update:D=>D.type.name!=="outlineHeading"?!1:(v=D,K(),!0)}}}}),gt=l.create({name:"outlineSection",group:"block",content:"outlineHeading outlineBody outlineChildren",defining:!0,isolating:!0,draggable:!0,addAttributes(){return{collapsed:{default:!1}}},renderHTML({node:y,HTMLAttributes:g}){let v={...g,class:`outline-section${g?.class?` ${g.class}`:""}`,"data-outline-section":"true","data-section-id":y.attrs.id||"","data-collapsed":y.attrs.collapsed?"true":"false"};return["div",h(v),0]},parseHTML(){return[{tag:"div[data-outline-section]"}]}}),Dt=y=>{if(!y)return!0;if((y.textContent||"").replace(/\u00a0/g," ").trim())return!1;if(y.childCount)for(let v=0;v<y.childCount;v+=1){let k=y.child(v);if(k.type?.name!=="paragraph"||(k.textContent||"").replace(/\u00a0/g," ").trim())return!1}return!0},an=y=>{if(!y)return!0;try{let g=y.child(0),v=y.child(1),k=y.child(2);return Dt(g)&&Dt(v)&&(!k||k.childCount===0)}catch{return!0}},Y=(y,g,v)=>{let k=y.doc.nodeAt(v);if(!k)return!1;let N=String(k.attrs?.id||"").trim(),_=y.doc.resolve(v),O=_.index(),K=_.parent;if(!K)return!1;if(K.childCount<=1){if(K.type?.name==="doc"){let z=y.doc.type.schema,q=z.nodes.outlineSection.create({...k.attrs,collapsed:!1},[z.nodes.outlineHeading.create({},[]),z.nodes.outlineBody.create({},[z.nodes.paragraph.create({},[])]),z.nodes.outlineChildren.create({},[])]),Z=y.tr.replaceWith(v,v+k.nodeSize,q);Z=Z.setMeta(ue,!0);let se=q.child(0),xe=v+1+se.nodeSize;return g(Z.setSelection(f.near(Z.doc.resolve(xe+2),1)).scrollIntoView()),!0}N&&Yr(N);let $=null;try{for(let z=_.depth;z>0;z-=1)if(_.node(z)?.type?.name==="outlineSection"){$=_.before(z);break}}catch{$=null}let V=y.tr.delete(v,v+k.nodeSize);V=V.setMeta(ue,!0);try{if(typeof $=="number"){let z=V.mapping.map($,-1),q=V.doc.nodeAt(z);if(q&&q.type?.name==="outlineSection"){let Z=q.child(0),se=q.child(1),xe=z+1+Z.nodeSize;if(!se.childCount){let me=V.doc.type.schema;V=V.insert(xe+1,me.nodes.paragraph.create({},[]))}V=V.setSelection(f.near(V.doc.resolve(xe+2),1))}}}catch{}return g(V.scrollIntoView()),!0}let D=O>0,M=O<K.childCount-1,B=D?K.child(O-1):null,E=D?v-B.nodeSize:null,T=v+k.nodeSize;N&&Yr(N);let I=y.tr.delete(v,v+k.nodeSize),P=($,V)=>{try{let z=$.doc.nodeAt(V);if(!z||z.type?.name!=="outlineSection")return $;let q=z.child(0),se=V+1+q.nodeSize-1;return $.setSelection(f.near($.doc.resolve(se),-1))}catch{return $}};if(M){let $=v<I.doc.content.size?v:T;I.doc.nodeAt($)&&(I=P(I,$))}else D&&typeof E=="number"&&I.doc.nodeAt(E)&&(I=P(I,E));return I=I.setMeta(ue,!0),g(I.scrollIntoView()),!0},ie=(y,g,v)=>{let k=y.doc.nodeAt(v);if(!k)return!1;let N=y.doc.resolve(v),_=N.index(),O=N.parent;if(!O||_<=0)return!1;let K=O.child(_-1),D=v-K.nodeSize,M=k.child(0),B=k.child(1),E=k.child(2),T=y.tr.delete(v,v+k.nodeSize),I=T.doc.nodeAt(D);if(!I)return T=T.setMeta(ue,!0),g(T.scrollIntoView()),!0;let P=T.doc.type.schema,$=I.child(0),V=I.child(1),z=I.child(2),q=[],Z=(M?.textContent||"").replace(/\u00a0/g," ").trim();Z&&q.push(P.nodes.paragraph.create({},[P.text(Z)])),B?.content?.forEach?.(_e=>{q.push(_e)});let se=q.length?P.nodes.outlineBody.create({},q).content:null,xe=se?V.content.append(se):V.content,me=z.content.append(E.content),Ae=P.nodes.outlineSection.create(I.attrs,[$,P.nodes.outlineBody.create({},xe),P.nodes.outlineChildren.create({},me)]);T=T.replaceWith(D,D+I.nodeSize,Ae);let Te=T.doc.nodeAt(D);if(Te){let _e=Te.child(0),Pe=Te.child(1),Fe=D+1+_e.nodeSize+Pe.nodeSize-1;T=T.setSelection(f.near(T.doc.resolve(Fe),-1))}return T=T.setMeta(ue,!0),g(T.scrollIntoView()),!0},pe=(y,g,v)=>{let k=y.doc.nodeAt(v);if(!k)return!1;let N=y.selection.$from,_=null,O=null;for(let _e=N.depth;_e>0;_e-=1)if(N.node(_e)?.type?.name==="outlineSection")if(_===null)_=_e;else{O=_e;break}if(_===null||O===null)return!1;let K=N.before(O);if(!y.doc.nodeAt(K))return!1;let M=y.doc.type.schema,B=k.child(0),E=k.child(1),T=k.child(2),I=y.tr.delete(v,v+k.nodeSize),P=I.doc.nodeAt(K);if(!P)return I=I.setMeta(ue,!0),g(I.scrollIntoView()),!0;let $=P.child(0),V=P.child(1),z=P.child(2),q=[],Z=(B?.textContent||"").replace(/\u00a0/g," ").trim();Z&&q.push(M.nodes.paragraph.create({},[M.text(Z)])),E?.content?.forEach?.(_e=>{q.push(_e)});let se=q.length?M.nodes.outlineBody.create({},q).content:null,xe=se?V.content.append(se):V.content,me=T.content.append(z.content),Ae=M.nodes.outlineSection.create({...P.attrs,collapsed:!1},[$,M.nodes.outlineBody.create({},xe),M.nodes.outlineChildren.create({},me)]);I=I.replaceWith(K,K+P.nodeSize,Ae);let Te=I.doc.nodeAt(K);if(Te){let _e=Te.child(0),Pe=Te.child(1),Fe=K+1+_e.nodeSize+Pe.nodeSize-1;I=I.setSelection(f.near(I.doc.resolve(Fe),-1))}return I=I.setMeta(ue,!0),g(I.scrollIntoView()),!0},he=d.create({name:"outlineCommands",addKeyboardShortcuts(){let y=(R,Q)=>{for(let W=Q.depth;W>0;W-=1)if(Q.node(W)?.type?.name==="outlineSection")return Q.before(W);return null},g=(R,Q)=>{for(let W=R.depth;W>0;W-=1)if(R.node(W)?.type?.name===Q)return W;return null},v=R=>{if(!R)return!0;if((R.textContent||"").replace(/\u00a0/g," ").trim())return!1;if(R.childCount)for(let W=0;W<R.childCount;W+=1){let J=R.child(W);if(J.type?.name!=="paragraph"||(J.textContent||"").replace(/\u00a0/g," ").trim())return!1}return!0},k=(R,Q)=>{let{selection:W}=R;if(!W||W.empty)return!1;let J=y(R.doc,W.$from),re=y(R.doc,W.$to);if(typeof J!="number"||typeof re!="number"||J===re||g(W.$from,"outlineBody")===null||W.$to.parent?.type?.name!=="outlineHeading"||W.$to.parentOffset!==0)return!1;let ee=R.doc.nodeAt(J);if(!ee)return!1;let fe=ee.child(0),be=ee.child(1),De=J+1+fe.nodeSize,ke=De+1,$e=De+be.nodeSize-1,He=Math.max(W.from,ke),Oe=Math.min(W.to,$e);if(Oe<He)return!0;let Le=R.tr.delete(He,Oe),Me=Le.doc.nodeAt(De);if(Me&&Me.content.size===0){let ze=Le.doc.type.schema;Le=Le.insert(ke,ze.nodes.paragraph.create({},[]))}return Le=Le.setSelection(f.near(Le.doc.resolve(ke+1),1)),Q(Le.scrollIntoView()),!0},N=(R,Q,W={})=>{let{selection:J}=R;if(!J||J.empty)return!1;let re=y(R.doc,J.$from),ae=y(R.doc,J.$to);if(typeof re!="number"||typeof ae!="number"||re!==ae)return!1;let ee=g(J.$from,"outlineHeading"),fe=g(J.$to,"outlineHeading");if(ee===null||fe===null)return!1;let be=R.doc.nodeAt(re);if(!be)return!1;let De=be.child(0),ke=re+1,$e=ke+1,He=ke+De.nodeSize-1;if(J.from<$e||J.to>He)return!1;let Oe=Math.max(J.from,$e),Le=Math.min(J.to,He);if(Le<Oe)return!0;if(typeof W.onClipboard=="function")try{let ze=R.doc.textBetween(Oe,Le,`
`,`
`);W.onClipboard(ze)}catch{}let Me=R.tr.delete(Oe,Le);return Me=Me.setSelection(f.near(Me.doc.resolve($e),1)),Q(Me.scrollIntoView()),!0},_=R=>{if(!R)return!0;let Q=R.child(0),W=R.child(1),J=R.child(2);return v(Q)&&v(W)&&(!J||J.childCount===0)},O=(R,Q,W)=>{let J=R.doc.nodeAt(W);if(!J)return!1;let re=J.child(0),ae=J.child(1),fe=W+1+re.nodeSize+ae.nodeSize-1,be=R.tr.setSelection(f.near(R.doc.resolve(fe),-1));return Q(be.scrollIntoView()),!0},K=(R,Q,W)=>{let J=R.doc.nodeAt(W);if(!J)return!1;let re=J.child(0),ae=W+1,ee=R.tr.setSelection(f.near(R.doc.resolve(ae+1),1));return Q(ee.scrollIntoView()),!0},D=(R,Q,W)=>{let J=R.doc.nodeAt(W);if(!J)return!1;let re=J.child(0),ae=J.child(1);if(!ae||ae.childCount<=0)return B(R,Q,W);let fe=W+1+re.nodeSize+1,be=null;try{ae.descendants(($e,He)=>{$e?.isTextblock&&(be=He)})}catch{be=null}if(typeof be!="number")return O(R,Q,W);let De=fe+be+1,ke=R.tr.setSelection(f.near(R.doc.resolve(De),1));return Q(ke.scrollIntoView()),!0},M=(R,Q,W)=>{let J=R.doc.nodeAt(W);return J?J.attrs?.collapsed?K(R,Q,W):D(R,Q,W):!1},B=(R,Q,W)=>{let J=R.doc.nodeAt(W);if(!J)return!1;let re=J.child(0),ae=J.child(1),ee=W+1+re.nodeSize,fe=R.tr;if(!ae.childCount){let be=R.doc.type.schema;fe=fe.insert(ee+1,be.nodes.paragraph.create({},[]))}return fe=fe.setSelection(f.near(fe.doc.resolve(ee+2),1)),Q(fe.scrollIntoView()),!0},E=(R,Q,W)=>{let J=R.doc.nodeAt(W);if(!J)return!1;let re=J.child(0),ae=J.child(1);if(!!J.attrs?.collapsed){let $e=W+1+re.nodeSize-1,He=R.tr.setSelection(f.near(R.doc.resolve($e),-1));return Q(He),!0}let be=W+1+re.nodeSize+ae.nodeSize-1,De=R.tr.setSelection(f.near(R.doc.resolve(be),-1));return Q(De),!0},T=(R,Q)=>{try{let W=R.resolve(Math.min(R.content.size,Math.max(0,Q+1)));for(let J=W.depth;J>0;J-=1){let re=W.node(J);if(!(re?.type?.name!=="outlineSection"||W.before(J)===Q)&&re.attrs?.collapsed)return!1}return!0}catch{return!0}},I=(R,Q)=>{let W=null;return R.nodesBetween(0,Q,(J,re)=>{if(re>=Q)return!1;J?.type?.name==="outlineSection"&&T(R,re)&&(W=re)}),W},P=(R,Q,W)=>{let J=R.doc.nodeAt(W);if(!J)return!1;let re=String(J.attrs?.id||"").trim(),ae=R.doc.resolve(W),ee=ae.index(),fe=ae.parent;if(!fe)return!1;if(fe.childCount<=1){if(fe.type?.name==="doc"){let Me=R.doc.type.schema,ze=Me.nodes.outlineSection.create({...J.attrs,collapsed:!1},[Me.nodes.outlineHeading.create({},[]),Me.nodes.outlineBody.create({},[Me.nodes.paragraph.create({},[])]),Me.nodes.outlineChildren.create({},[])]),et=R.tr.replaceWith(W,W+J.nodeSize,ze);et=et.setMeta(ue,!0);let We=ze.child(0),Qe=W+1+We.nodeSize;return Q(et.setSelection(f.near(et.doc.resolve(Qe+2),1)).scrollIntoView()),!0}let Oe=null;try{for(let Me=ae.depth;Me>0;Me-=1)if(ae.node(Me)?.type?.name==="outlineSection"){Oe=ae.before(Me);break}}catch{Oe=null}let Le=R.tr.delete(W,W+J.nodeSize);Le=Le.setMeta(ue,!0);try{if(typeof Oe=="number"){let Me=Le.mapping.map(Oe,-1),ze=Le.doc.nodeAt(Me);if(ze&&ze.type?.name==="outlineSection"){let et=ze.child(0),We=ze.child(1),Qe=Me+1+et.nodeSize;if(!We.childCount){let ft=Le.doc.type.schema;Le=Le.insert(Qe+1,ft.nodes.paragraph.create({},[]))}Le=Le.setSelection(f.near(Le.doc.resolve(Qe+2),1))}}}catch{}return Q(Le.scrollIntoView()),!0}re&&Yr(re);let be=ee>0,De=be?fe.child(ee-1):null,ke=be?W-De.nodeSize:null,$e=W+J.nodeSize,He=R.tr.delete(W,W+J.nodeSize);if(be&&typeof ke=="number"){let Oe=He.doc.nodeAt(ke);if(Oe){let Le=Oe.child(0),Me=Oe.child(1),ze=ke+1+Le.nodeSize;if(!Me.childCount){let et=He.doc.type.schema;He=He.insert(ze+1,et.nodes.paragraph.create({},[]))}He=He.setSelection(f.near(He.doc.resolve(ze+2),1))}}else{let Oe=W<He.doc.content.size?W:$e,Le=He.doc.nodeAt(Oe);if(Le){let Me=Le.child(0),ze=Le.child(1),et=Oe+1+Me.nodeSize;if(!ze.childCount){let We=He.doc.type.schema;He=He.insert(et+1,We.nodes.paragraph.create({},[]))}He=He.setSelection(f.near(He.doc.resolve(et+2),1))}}return He=He.setMeta(ue,!0),Q(He.scrollIntoView()),!0},$=(R,Q,W)=>{let J=R.doc.nodeAt(W);if(!J)return!1;let re=String(J.attrs?.id||"").trim(),ae=R.doc.resolve(W),ee=ae.index(),fe=ae.parent;if(!fe||ee<=0)return!1;re&&Yr(re);let be=fe.child(ee-1),De=W-be.nodeSize,ke=J.child(0),$e=J.child(1),He=J.child(2),Oe=R.tr.delete(W,W+J.nodeSize),Le=Oe.doc.nodeAt(De);if(!Le)return Oe=Oe.setMeta(ue,!0),Q(Oe.scrollIntoView()),!0;let Me=Oe.doc.type.schema,ze=Le.child(0),et=Le.child(1),We=Le.child(2),Qe=Number(et?.content?.size||0)||0,ft=[],lt=(ke?.textContent||"").replace(/\u00a0/g," ").trim();lt&&ft.push(Me.nodes.paragraph.create({},[Me.text(lt)])),$e?.content?.forEach?.(vt=>{ft.push(vt)});let Tt=ft.length?Me.nodes.outlineBody.create({},ft).content:null,kt=Tt?et.content.append(Tt):et.content,Yt=We.content.append(He.content),bt=Me.nodes.outlineSection.create(Le.attrs,[ze,Me.nodes.outlineBody.create({},kt),Me.nodes.outlineChildren.create({},Yt)]);Oe=Oe.replaceWith(De,De+Le.nodeSize,bt);let Vt=Oe.doc.nodeAt(De);if(Vt){let vt=Vt.child(0),hn=Vt.child(1),Gt=De+1+vt.nodeSize+1+Qe,cn=Math.min(Oe.doc.content.size,Math.max(0,Gt+1));Oe=Oe.setSelection(f.near(Oe.doc.resolve(cn),1))}return Oe=Oe.setMeta(ue,!0),Q(Oe.scrollIntoView()),!0},V=(R,Q,W)=>{let J=R.doc.nodeAt(W);if(!J)return!1;let re=String(J.attrs?.id||"").trim(),ae=R.selection.$from,ee=null,fe=null;for(let vt=ae.depth;vt>0;vt-=1)if(ae.node(vt)?.type?.name==="outlineSection")if(ee===null)ee=vt;else{fe=vt;break}if(ee===null||fe===null)return!1;let be=ae.before(fe);if(!R.doc.nodeAt(be))return!1;let ke=R.doc.type.schema,$e=J.child(0),He=J.child(1),Oe=J.child(2);re&&Yr(re);let Le=R.tr.delete(W,W+J.nodeSize),Me=Le.doc.nodeAt(be);if(!Me)return Le=Le.setMeta(ue,!0),Q(Le.scrollIntoView()),!0;let ze=Me.child(0),et=Me.child(1),We=Me.child(2),Qe=Number(et?.content?.size||0)||0,ft=[],lt=($e?.textContent||"").replace(/\u00a0/g," ").trim();lt&&ft.push(ke.nodes.paragraph.create({},[ke.text(lt)])),He?.content?.forEach?.(vt=>{ft.push(vt)});let Tt=ft.length?ke.nodes.outlineBody.create({},ft).content:null,kt=Tt?et.content.append(Tt):et.content,Yt=Oe.content.append(We.content),bt=ke.nodes.outlineSection.create({...Me.attrs,collapsed:!1},[ze,ke.nodes.outlineBody.create({},kt),ke.nodes.outlineChildren.create({},Yt)]);Le=Le.replaceWith(be,be+Me.nodeSize,bt);let Vt=Le.doc.nodeAt(be);if(Vt){let vt=Vt.child(0),pt=be+1+vt.nodeSize+1+Qe,Gt=Math.min(Le.doc.content.size,Math.max(0,pt+1));Le=Le.setSelection(f.near(Le.doc.resolve(Gt),1))}return Le=Le.setMeta(ue,!0),Q(Le.scrollIntoView()),!0},z=(R,Q,W)=>{let J=R.doc.nodeAt(W);if(!J)return!1;let re=R.doc.resolve(W),ae=re.index(),ee=re.parent;if(!ee||ae>=ee.childCount-1)return!1;let fe=W+J.nodeSize,be=R.doc.nodeAt(fe);if(!be||be.type?.name!=="outlineSection")return!1;let De=R.doc.type.schema,ke=J.child(0),$e=J.child(1),He=J.child(2),Oe=be.child(1),Le=be.child(2),Me=$e.content.append(Oe.content),ze=He.content.append(Le.content),et=De.nodes.outlineSection.create({...J.attrs,collapsed:!1},[ke,De.nodes.outlineBody.create({},Me),De.nodes.outlineChildren.create({},ze)]),We=R.tr;We=We.delete(fe,fe+be.nodeSize),We=We.replaceWith(W,W+J.nodeSize,et);let Qe=We.doc.nodeAt(W);if(Qe){let ft=Qe.child(0),lt=Qe.child(1),kt=W+1+ft.nodeSize+lt.nodeSize-1;We=We.setSelection(f.near(We.doc.resolve(kt),-1))}return We=We.setMeta(ue,!0),Q(We.scrollIntoView()),!0},q=R=>this.editor.commands.command(({state:Q,dispatch:W})=>{let J=Oe=>{try{if(typeof CSS<"u"&&CSS&&typeof CSS.escape=="function")return CSS.escape(String(Oe||""))}catch{}return String(Oe||"").replace(/["\\]/g,"\\$&")},re=Oe=>{try{let Le=Oe;for(;Le&&Le!==document.body;){let Me=Le.parentElement;if(!Me)break;let ze=window.getComputedStyle(Me),et=String(ze?.overflowY||"");if((et==="auto"||et==="scroll")&&Me.scrollHeight>Me.clientHeight+1)return Me;Le=Me}}catch{}return document.scrollingElement||document.documentElement},ae=Oe=>{try{let Le=String(Oe||"").trim();if(!Le)return null;let Me=document.querySelector(`.outline-heading[data-section-id="${J(Le)}"]`);if(!Me)return null;let ze=re(Me);return{sid:Le,scrollEl:ze,top:Me.getBoundingClientRect().top}}catch{return null}},ee=Oe=>{if(!Oe)return;let{sid:Le,scrollEl:Me,top:ze}=Oe,et=()=>{try{let We=document.querySelector(`.outline-heading[data-section-id="${J(Le)}"]`);if(!We)return;let ft=We.getBoundingClientRect().top-ze;if(!Number.isFinite(ft)||Math.abs(ft)<1)return;Me.scrollTop+=ft}catch{}};try{requestAnimationFrame(()=>requestAnimationFrame(et))}catch{setTimeout(et,0)}},fe=y(Q.doc,Q.selection.$from);if(typeof fe!="number")return!1;let be=Q.doc.resolve(fe),De=be.index(),ke=be.parent;if(!ke)return!1;let $e=Q.doc.nodeAt(fe);if(!$e)return!1;let He=ae(String($e.attrs?.id||"").trim());if(R==="up"){if(De>0){let Gt=ke.child(De-1),cn=fe-Gt.nodeSize,st=Q.tr.delete(fe,fe+$e.nodeSize).insert(cn,$e).setMeta(ue,!0),Zt=f.near(st.doc.resolve(cn+2),1);return st.setSelection(Zt),W(st.scrollIntoView()),ee(He),!0}let Oe=Pe(Q.doc,fe);if(typeof Oe!="number")return!1;let Le=Q.doc.resolve(Oe),Me=Le.index(),ze=Le.parent;if(!ze||Me<=0)return!1;let et=ze.child(Me-1),We=Oe-et.nodeSize,Qe=Q.doc.nodeAt(We);if(!Qe||Qe.type?.name!=="outlineSection")return!1;let ft=Qe.child(0),lt=Qe.child(1),Tt=Qe.child(2),Yt=We+1+ft.nodeSize+lt.nodeSize+Tt.nodeSize-1,bt=Q.tr.delete(fe,fe+$e.nodeSize).setMeta(ue,!0),Vt=bt.mapping.map(We,-1),vt=bt.mapping.map(Yt,-1);bt=bt.insert(vt,$e);let hn=bt.doc.nodeAt(Vt);hn?.type?.name==="outlineSection"&&hn.attrs?.collapsed&&(bt=bt.setNodeMarkup(Vt,void 0,{...hn.attrs,collapsed:!1}));let pt=f.near(bt.doc.resolve(vt+2),1);return bt.setSelection(pt),W(bt.scrollIntoView()),ee(He),!0}if(R==="down"){if(De<ke.childCount-1){let Gt=fe+$e.nodeSize,cn=Q.doc.nodeAt(Gt);if(!cn)return!1;let st=Q.tr.delete(fe,fe+$e.nodeSize).setMeta(ue,!0),Zt=fe+cn.nodeSize;st.insert(Zt,$e);let pr=f.near(st.doc.resolve(Zt+2),1);return st.setSelection(pr),W(st.scrollIntoView()),ee(He),!0}let Oe=Pe(Q.doc,fe);if(typeof Oe!="number")return!1;let Le=Q.doc.nodeAt(Oe);if(!Le||Le.type?.name!=="outlineSection")return!1;let Me=Q.doc.resolve(Oe),ze=Me.index(),et=Me.parent;if(!et||ze>=et.childCount-1)return!1;let We=Oe+Le.nodeSize,Qe=Q.doc.nodeAt(We);if(!Qe||Qe.type?.name!=="outlineSection")return!1;let ft=Qe.child(0),lt=Qe.child(1),Tt=Qe.child(2),Yt=We+1+ft.nodeSize+lt.nodeSize+1,bt=Q.tr.delete(fe,fe+$e.nodeSize).setMeta(ue,!0),Vt=bt.mapping.map(We,-1),vt=bt.mapping.map(Yt,-1);bt=bt.insert(vt,$e);let hn=bt.doc.nodeAt(Vt);hn?.type?.name==="outlineSection"&&hn.attrs?.collapsed&&(bt=bt.setNodeMarkup(Vt,void 0,{...hn.attrs,collapsed:!1}));let pt=f.near(bt.doc.resolve(vt+2),1);return bt.setSelection(pt),W(bt.scrollIntoView()),ee(He),!0}return!1}),Z=()=>this.editor.commands.command(({state:R,dispatch:Q})=>{let{selection:W}=R;if(!W?.empty)return!1;let{$from:J}=W,re=y(R.doc,J);if(typeof re!="number")return!1;let ae=R.doc.nodeAt(re);if(!ae)return!1;let ee=R.doc.type.schema;if(ae.attrs?.collapsed){let pt=re+ae.nodeSize,Gt=Wt(),cn=ee.nodes.outlineSection.create({id:Gt,collapsed:!1},[ee.nodes.outlineHeading.create({},[]),ee.nodes.outlineBody.create({},[ee.nodes.paragraph.create({},[])]),ee.nodes.outlineChildren.create({},[])]),st=R.tr.insert(pt,cn);return st=st.setSelection(f.create(st.doc,pt+2)),st=st.setMeta(ue,!0),Ee&&(st=st.setMeta(Ee,{type:"enter",sectionId:Gt})),Q(st.scrollIntoView()),!0}let fe=ee.nodes.outlineChildren.create({},[]),be=pt=>pt&&pt.childCount?pt:ee.nodes.outlineBody.create({},[ee.nodes.paragraph.create({},[])]);if(J.parent?.type?.name==="outlineHeading"){let pt=ae.child(0),Gt=ae.child(1),cn=ae.child(2),st=J.parentOffset||0,Zt=pt.textBetween(0,Math.max(0,Math.min(st,pt.content.size)),"",""),pr=pt.textBetween(Math.max(0,Math.min(st,pt.content.size)),pt.content.size,"",""),Qd=ee.nodes.outlineHeading.create({},Zt?[ee.text(Zt)]:[]),Zd=ee.nodes.outlineHeading.create({},pr?[ee.text(pr)]:[]),Ta=Wt(),Ba=ee.nodes.outlineSection.create({...ae.attrs,collapsed:!1},[Qd,be(ee.nodes.outlineBody.create({},[])),fe]),eu=ee.nodes.outlineSection.create({id:Ta,collapsed:!1},[Zd,be(Gt),cn]),Pn=R.tr.replaceWith(re,re+ae.nodeSize,Ba),Na=Pn.doc.nodeAt(re),Ma=re+(Na?Na.nodeSize:Ba.nodeSize);return Pn=Pn.insert(Ma,eu),Pn=Pn.setSelection(f.create(Pn.doc,Ma+2)),Pn=Pn.setMeta(ue,!0),Ee&&(Pn=Pn.setMeta(Ee,{type:"enter",sectionId:Ta})),Q(Pn.scrollIntoView()),!0}if(g(J,"outlineBody")===null||!J.parent?.isTextblock)return!1;let ke=R.tr,$e=W.from;try{ke=ke.split($e)}catch{return!1}let He=ke.mapping.map($e);try{ke=ke.setSelection(f.near(ke.doc.resolve(Math.min(ke.doc.content.size,He+1)),1))}catch{}let Oe=ke.selection.$from,Le=g(Oe,"outlineBody"),Me=g(Oe,"paragraph");if(Le===null||Me===null)return!1;let ze=Oe.before(Me),et=Oe.end(Le);if(typeof ze!="number"||typeof et!="number"||et<ze)return!1;let We=ke.doc.slice(ze,et).content;ke=ke.delete(ze,et);let Qe=ke.mapping.map(re,-1),ft=ke.doc.nodeAt(Qe);if(!ft)return Q(ke.scrollIntoView()),!0;let lt=ft.child(0),Tt=be(ft.child(1)),kt=ft.child(2),Yt=ee.nodes.outlineSection.create({...ft.attrs,collapsed:!1},[lt,Tt,fe]),bt=We&&We.childCount?ee.nodes.outlineBody.create({},We):ee.nodes.outlineBody.create({},[ee.nodes.paragraph.create({},[])]),Vt=Wt(),vt=ee.nodes.outlineSection.create({id:Vt,collapsed:!1},[ee.nodes.outlineHeading.create({},[]),bt,kt]);ke=ke.replaceWith(Qe,Qe+ft.nodeSize,Yt);let hn=Qe+Yt.nodeSize;return ke=ke.insert(hn,vt),ke=ke.setSelection(f.create(ke.doc,hn+2)),ke=ke.setMeta(ue,!0),Ee&&(ke=ke.setMeta(Ee,{type:"enter",sectionId:Vt})),Q(ke.scrollIntoView()),!0}),se=()=>this.editor.commands.command(({state:R,dispatch:Q})=>{let W=y(R.doc,R.selection.$from);if(typeof W!="number")return!1;let J=R.doc.resolve(W),re=0;for(let Qe=J.depth;Qe>=0;Qe-=1)J.node(Qe)?.type?.name==="outlineSection"&&(re+=1);if(re>=6)return!1;let ae=J.index(),ee=J.parent;if(!ee||ae<=0)return!1;let fe=R.doc.nodeAt(W);if(!fe)return!1;let be=ee.child(ae-1),De=W-be.nodeSize,ke=R.doc.nodeAt(De);if(!ke)return!1;let $e=ke.child(0),He=ke.child(1),Oe=ke.child(2),Me=De+1+$e.nodeSize+He.nodeSize+Oe.nodeSize-1,ze=R.tr.delete(W,W+fe.nodeSize).insert(Me,fe).setMeta(ue,!0),et=ze.doc.nodeAt(De);et?.type?.name==="outlineSection"&&et.attrs?.collapsed&&(ze=ze.setNodeMarkup(De,void 0,{...et.attrs,collapsed:!1}));let We=f.near(ze.doc.resolve(Me+2),1);return ze.setSelection(We),Q(ze.scrollIntoView()),!0}),xe=()=>this.editor.commands.command(({state:R,dispatch:Q})=>{let W=R.selection.$from,J=null,re=null;for(let He=W.depth;He>0;He-=1)if(W.node(He)?.type?.name==="outlineSection")if(J===null)J=He;else{re=He;break}if(J===null||re===null)return!1;let ae=W.before(J),ee=W.before(re),fe=R.doc.nodeAt(ae);if(!fe)return!1;let be=R.tr.delete(ae,ae+fe.nodeSize).setMeta(ue,!0),De=be.doc.nodeAt(ee);if(!De)return!1;let ke=ee+De.nodeSize;be.insert(ke,fe);let $e=f.near(be.doc.resolve(ke+2),1);return be.setSelection($e),Q(be.scrollIntoView()),!0}),me=R=>this.editor.commands.command(({state:Q,dispatch:W})=>{let J=y(Q.doc,Q.selection.$from);if(typeof J!="number")return!1;let re=Q.doc.nodeAt(J);if(!re)return!1;let ae=typeof R=="boolean"?R:!re.attrs?.collapsed,ee=Q.tr.setNodeMarkup(J,void 0,{...re.attrs,collapsed:ae}).setMeta(ue,!0);try{ae&&Ee&&(Ee.getState(Q)||{}).editingSectionId&&(ee=ee.setMeta(Ee,{type:"exit"}))}catch{}return W(ee),!0}),Ae=()=>this.editor.commands.command(({state:R,dispatch:Q})=>{let W=y(R.doc,R.selection.$from);if(typeof W!="number")return!1;let J=R.doc.nodeAt(W);if(!J||J.type?.name!=="outlineSection"||!J.attrs?.collapsed)return!1;let re=Pe(R.doc,W);if(typeof re!="number"){let be=W+1,De=R.tr.setSelection(f.near(R.doc.resolve(be+1),1));return Q(De.scrollIntoView()),!0}let ae=R.doc.nodeAt(re);if(!ae||ae.type?.name!=="outlineSection")return!1;let ee=R.tr.setNodeMarkup(re,void 0,{...ae.attrs,collapsed:!0}).setMeta(ue,!0);try{Ee&&(Ee.getState(R)||{}).editingSectionId&&(ee=ee.setMeta(Ee,{type:"exit"}))}catch{}let fe=re+1;return ee=ee.setSelection(f.near(ee.doc.resolve(fe+1),1)),Q(ee.scrollIntoView()),!0}),Te=()=>this.editor.commands.command(({state:R,dispatch:Q})=>{let{selection:W}=R;if(!W?.empty)return!1;let{$from:J}=W;if(J.parent?.type?.name==="outlineHeading")return!1;let re=y(R.doc,J);if(typeof re!="number")return!1;let ae=R.doc.nodeAt(re);if(!ae||ae.type?.name!=="outlineSection"||ae.attrs?.collapsed)return!1;let ee=R.doc.type.schema,fe=g(J,"outlineBody");if(fe===null)return!1;let be=null;for(let st=J.depth;st>fe;st-=1){let Zt=J.node(st),pr=J.node(st-1);if(Zt?.type?.name==="paragraph"&&pr?.type?.name==="outlineBody"){be=st;break}}if(be===null)return!1;let De=J.node(be);if(!De)return!1;let ke=ae.child(0),$e=ae.child(1),He=ae.child(2),Le=re+1+ke.nodeSize+1,Me=J.before(be),ze=null;try{let st=0;for(let Zt=0;Zt<$e.childCount;Zt+=1){if(Le+st===Me){ze=Zt;break}st+=$e.child(Zt).nodeSize}}catch{ze=null}if(ze===null)return!1;let et=J.pos-J.start(be),We=Math.max(0,Math.min(et,De.content.size)),Qe=De.textBetween(0,We,"",""),ft=De.textBetween(We,De.content.size,"",""),lt=String(Qe||"").trimEnd(),Tt=String(ft||"").trim(),kt=[];for(let st=0;st<ze;st+=1)kt.push($e.child(st));kt.push(ee.nodes.paragraph.create({},lt?[ee.text(lt)]:[])),kt.length||kt.push(ee.nodes.paragraph.create({},[]));let Yt=[];for(let st=ze+1;st<$e.childCount;st+=1)Yt.push($e.child(st));Yt.length||Yt.push(ee.nodes.paragraph.create({},[]));let bt=ee.nodes.outlineChildren.create({},[]),Vt=ee.nodes.outlineSection.create({...ae.attrs,collapsed:!1},[ke,ee.nodes.outlineBody.create({},kt),bt]),vt=Wt(),hn=ee.nodes.outlineSection.create({id:vt,collapsed:!1},[ee.nodes.outlineHeading.create({},Tt?[ee.text(Tt)]:[]),ee.nodes.outlineBody.create({},Yt),He]),pt=R.tr.replaceWith(re,re+ae.nodeSize,Vt),Gt=re+Vt.nodeSize;pt=pt.insert(Gt,hn);let cn=pt.doc.nodeAt(Gt);if(cn&&cn.type?.name==="outlineSection"){let st=cn.child(0),Zt=Gt+1+st.nodeSize;pt=pt.setSelection(f.near(pt.doc.resolve(Zt+2),1))}else pt=pt.setSelection(f.near(pt.doc.resolve(Gt+2),1));return pt=pt.setMeta(ue,!0),Ee&&(pt=pt.setMeta(Ee,{type:"enter",sectionId:vt})),Q(pt.scrollIntoView()),!0}),_e=(R,Q)=>{let W=R.nodeAt(Q);if(!W||W.type?.name!=="outlineSection")return[];let J=[Q];return W.descendants((re,ae)=>{re?.type?.name==="outlineSection"&&J.push(Q+1+ae)}),J},Pe=(R,Q)=>{try{let W=R.resolve(Math.min(R.content.size,Q+1)),J=null;for(let re=W.depth;re>0;re-=1){if(W.node(re)?.type?.name!=="outlineSection")continue;if(W.before(re)===Q){J=re;break}}if(J===null)return null;for(let re=J-1;re>0;re-=1)if(W.node(re)?.type?.name==="outlineSection")return W.before(re);return null}catch{return null}},Se=(R,Q,W,J)=>{let re=!!J,ae=R.tr;for(let ee of W){let fe=ae.doc.nodeAt(ee);!fe||fe.type?.name!=="outlineSection"||!!fe.attrs?.collapsed!==re&&(ae=ae.setNodeMarkup(ee,void 0,{...fe.attrs,collapsed:re}))}ae=ae.setMeta(ue,!0);try{re&&Ee&&(Ee.getState(R)||{}).editingSectionId&&(ae=ae.setMeta(Ee,{type:"exit"}))}catch{}Q(ae)},Fe=()=>this.editor.commands.command(({state:R,dispatch:Q})=>{let W=y(R.doc,R.selection.$from);if(typeof W!="number")return!1;let J=Pe(R.doc,W),re=typeof J=="number"?J:W,ae=_e(R.doc,re);if(!ae.length)return!1;let ee=R.tr;for(let be of ae){let De=ee.doc.nodeAt(be);!De||De.type?.name!=="outlineSection"||De.attrs?.collapsed||(ee=ee.setNodeMarkup(be,void 0,{...De.attrs,collapsed:!0}))}ee=ee.setMeta(ue,!0);let fe=ee.doc.nodeAt(re);if(fe){let be=fe.child(0),ke=re+1+be.nodeSize-1;ee=ee.setSelection(f.near(ee.doc.resolve(ke),-1))}return Q(ee.scrollIntoView()),!0}),je=()=>this.editor.commands.command(({state:R,dispatch:Q})=>{let W=y(R.doc,R.selection.$from);if(typeof W!="number")return!1;let J=_e(R.doc,W);return J.length?(Se(R,Q,J,!1),!0):!1}),Ue=(R,Q)=>{try{let W=R.nodeAt(Q);if(!W||W.type?.name!=="outlineSection")return[];if(W.childCount<3)return[];let J=W.child(0),re=W.child(1),ae=W.child(2);if(!ae||ae.type?.name!=="outlineChildren")return[];let ee=Q+1+J.nodeSize+re.nodeSize,fe=[];return ae.descendants((be,De)=>{be?.type?.name==="outlineSection"&&fe.push(ee+1+De)}),fe}catch{return[]}},nt=(R,Q)=>{try{let W=Pe(R,Q);if(typeof W!="number")return Gr(R);let J=R.nodeAt(W);if(!J||J.type?.name!=="outlineSection"||J.childCount<3)return Gr(R);let re=J.child(0),ae=J.child(1),ee=J.child(2);if(!ee||ee.type?.name!=="outlineChildren")return Gr(R);let fe=W+1+re.nodeSize+ae.nodeSize,be=[];return ee.descendants((De,ke)=>{De?.type?.name==="outlineSection"&&be.push(fe+1+ke)}),be}catch{return Gr(R)}},ut=(R,Q)=>{try{for(let W of Q||[]){let J=R.nodeAt(W);if(!(!J||J.type?.name!=="outlineSection")&&J.attrs?.collapsed)return!0}}catch{}return!1},yt=()=>this.editor.commands.command(({state:R,dispatch:Q})=>{let W=y(R.doc,R.selection.$from);if(typeof W!="number")return!1;let J=R.doc.nodeAt(W);if(!J||J.type?.name!=="outlineSection")return!1;if(J.attrs?.collapsed)return Se(R,Q,[W],!1),!0;let re=Ue(R.doc,W);if(re.length&&ut(R.doc,re))return Se(R,Q,re,!1),!0;let ae=W;for(let fe=0;fe<64;fe+=1){let be=nt(R.doc,ae);if(be.length&&ut(R.doc,be))return Se(R,Q,be,!1),!0;let De=Pe(R.doc,ae);if(typeof De!="number")break;ae=De}let ee=Gr(R.doc);return ee.length&&ut(R.doc,ee)?(Se(R,Q,ee,!1),!0):!1}),Ht=R=>this.editor.commands.command(({state:Q,dispatch:W})=>{let{selection:J}=Q,ae=(J?.node||null)?.type?.name==="outlineSection"?J.from:y(Q.doc,Q.selection.$from);if(typeof ae!="number"||!Q.doc.nodeAt(ae))return!1;let fe=!!R,be=_e(Q.doc,ae);return be.length?(Se(Q,W,be,fe),!0):!1});return{"Alt-ArrowUp":()=>this.editor.isActive("table")?!1:q("up"),"Alt-ArrowDown":()=>this.editor.isActive("table")?!1:q("down"),"Alt-ArrowRight":()=>this.editor.isActive("table")?!1:se(),"Alt-ArrowLeft":()=>this.editor.isActive("table")?!1:xe(),"Ctrl-Alt-ArrowUp":()=>this.editor.isActive("table")?!1:q("up"),"Alt-Ctrl-ArrowUp":()=>this.editor.isActive("table")?!1:q("up"),"Ctrl-Alt-ArrowDown":()=>this.editor.isActive("table")?!1:q("down"),"Alt-Ctrl-ArrowDown":()=>this.editor.isActive("table")?!1:q("down"),"Ctrl-Alt-ArrowRight":()=>this.editor.isActive("table")?!1:se(),"Alt-Ctrl-ArrowRight":()=>this.editor.isActive("table")?!1:se(),"Ctrl-Alt-ArrowLeft":()=>this.editor.isActive("table")?!1:xe(),"Alt-Ctrl-ArrowLeft":()=>this.editor.isActive("table")?!1:xe(),"Mod-ArrowRight":()=>me(!1),"Mod-ArrowLeft":()=>Ae()?!0:me(!0),"Mod-ArrowUp":()=>{try{let R=this.editor.state,Q=y(R.doc,R.selection.$from);if(typeof Q=="number"){let W=R.doc.nodeAt(Q);if(W?.type?.name==="outlineSection"&&typeof Pe(R.doc,Q)!="number"&&W.attrs?.collapsed)return wa(this.editor,!0)}}catch{}return Fe()},"Mod-ArrowDown":()=>yt(),"Mod-Enter":()=>{try{if(Ee&&!(Ee.getState(this.editor.state)||{}).editingSectionId)return!1}catch{}try{if(this.editor.state.selection?.$from?.parent?.type?.name==="outlineHeading")return Z()}catch{}return Te()?!0:Z()},Backspace:()=>this.editor.commands.command(({state:R,dispatch:Q})=>{let{selection:W}=R;if(N(R,Q)||k(R,Q))return!0;if(!W?.empty)return!1;let{$from:J}=W;if(J.parent?.type?.name!=="outlineHeading"||J.parentOffset!==0)return!1;let re=y(R.doc,J);if(typeof re!="number")return!1;let ae=R.doc.nodeAt(re);if(!ae)return!1;if(_(ae))return P(R,Q,re);try{if(R.doc.resolve(re).index()<=0)return V(R,Q,re)}catch{}return $(R,Q,re)}),Delete:()=>this.editor.commands.command(({state:R,dispatch:Q})=>{let{selection:W}=R;if(N(R,Q)||k(R,Q))return!0;if(!W?.empty)return!1;let{$from:J}=W;if(g(J,"outlineBody")!==null){let be=y(R.doc,J);if(typeof be!="number")return!1;let De=R.doc.nodeAt(be);if(!De)return!1;let ke=De.child(0),$e=De.child(1),Oe=be+1+ke.nodeSize+$e.nodeSize-1;return J.pos===Oe?z(R,Q,be):!1}if(J.parent?.type?.name!=="outlineHeading")return!1;let ae=y(R.doc,J);if(typeof ae!="number")return!1;let ee=R.doc.nodeAt(ae);if(!ee)return!1;let fe=ee.child(0);if(J.parentOffset===fe.content.size){if(_(ee))return P(R,Q,ae);let be=ee.child(1),De=ae+1+fe.nodeSize,ke=R.tr;if(!be.childCount){let $e=R.doc.type.schema;ke=ke.insert(De+1,$e.nodes.paragraph.create({},[]))}return ke=ke.setSelection(f.near(ke.doc.resolve(De+2),1)),Q(ke.scrollIntoView()),!0}return!1}),Enter:()=>this.editor.commands.command(({state:R,dispatch:Q})=>{let{selection:W}=R;if(!W?.empty)return!1;let{$from:J}=W;if(J.parent?.type?.name!=="outlineHeading")return!1;try{if(Ee&&!(Ee.getState(R)||{}).editingSectionId)return!1}catch{}let re=y(R.doc,J);if(typeof re!="number")return!1;let ae=R.doc.nodeAt(re);if(!ae)return!1;let ee=ae.child(0),fe=ae.child(1),be=re+1+ee.nodeSize,De=ee.content?.size??0;if(ae.attrs?.collapsed&&J.parentOffset===De){let $e=re+ae.nodeSize,He=R.doc.type.schema,Oe=Wt(),Le=He.nodes.outlineSection.create({id:Oe,collapsed:!1},[He.nodes.outlineHeading.create({},[]),He.nodes.outlineBody.create({},[He.nodes.paragraph.create({},[])]),He.nodes.outlineChildren.create({},[])]),Me=R.tr.insert($e,Le);return Me=Me.setSelection(f.create(Me.doc,$e+2)),Me=Me.setMeta(ue,!0),Ee&&(Me=Me.setMeta(Ee,{type:"enter",sectionId:Oe})),Q(Me.scrollIntoView()),!0}if(J.parentOffset===0){let $e=R.doc.type.schema,He=ee.textBetween(0,De,"",""),Oe=$e.nodes.outlineHeading.create({},[]),Le=ae.child(2),Me=[];try{for(let lt=0;lt<fe.childCount;lt+=1)Me.push(fe.child(lt))}catch{}let ze=[];if(He){let lt=$e.nodes.paragraph.create({},[$e.text(He)]),Tt=Me[0]||null;Tt&&Tt.type?.name==="paragraph"&&v(Tt)?ze=[lt,...Me.slice(1)]:ze=[lt,...Me]}else ze=Me;ze.length||(ze=[$e.nodes.paragraph.create({},[])]);let et=$e.nodes.outlineBody.create({},ze),We=$e.nodes.outlineSection.create({...ae.attrs,collapsed:!1},[Oe,et,Le]),Qe=R.tr.replaceWith(re,re+ae.nodeSize,We),ft=Qe.doc.nodeAt(re);if(ft){let lt=ft.child(0),Tt=re+1+lt.nodeSize;Qe=Qe.setSelection(f.near(Qe.doc.resolve(Tt+2),1))}else Qe=Qe.setSelection(f.near(Qe.doc.resolve(be+2),1));return Qe=Qe.setMeta(ue,!0),Q(Qe.scrollIntoView()),!0}if(J.parentOffset>0&&J.parentOffset<De){let $e=R.doc.type.schema,He=ee.textBetween(0,Math.max(0,Math.min(J.parentOffset,De)),"",""),Oe=ee.textBetween(Math.max(0,Math.min(J.parentOffset,De)),De,"",""),Le=$e.nodes.outlineHeading.create({},He?[$e.text(He)]:[]),Me=ae.child(2),ze=[];try{for(let kt=0;kt<fe.childCount;kt+=1)ze.push(fe.child(kt))}catch{}let et=$e.nodes.paragraph.create({},Oe?[$e.text(Oe)]:[]),We=[];if(Oe){let kt=ze[0]||null;kt&&kt.type?.name==="paragraph"&&v(kt)?We=[et,...ze.slice(1)]:We=[et,...ze]}else We=ze;We.length||(We=[$e.nodes.paragraph.create({},[])]);let Qe=$e.nodes.outlineBody.create({},We),ft=$e.nodes.outlineSection.create({...ae.attrs,collapsed:!1},[Le,Qe,Me]),lt=R.tr.replaceWith(re,re+ae.nodeSize,ft),Tt=lt.doc.nodeAt(re);if(Tt){let kt=Tt.child(0),Yt=re+1+kt.nodeSize;lt=lt.setSelection(f.near(lt.doc.resolve(Yt+2),1))}else lt=lt.setSelection(f.near(lt.doc.resolve(be+2),1));return lt=lt.setMeta(ue,!0),Q(lt.scrollIntoView()),!0}let ke=R.tr;if(!fe.childCount){let $e=R.doc.type.schema;ke=ke.insert(be+1,$e.nodes.paragraph.create({},[]))}return ke=ke.setSelection(f.near(ke.doc.resolve(be+2),1)),Q(ke.scrollIntoView()),!0}),ArrowUp:()=>this.editor.commands.command(({state:R,dispatch:Q})=>{let{selection:W}=R;if(!W?.empty)return!1;let{$from:J}=W;if(J.parent?.type?.name!=="outlineHeading"||J.parentOffset!==0)return!1;let re=y(R.doc,J);if(typeof re!="number")return!1;let ae=I(R.doc,re);if(typeof ae=="number")return M(R,Q,ae);let ee=R.doc.resolve(re),fe=ee.index(),be=ee.parent;if(!be)return!1;if(fe>0){let He=be.child(fe-1),Oe=re-He.nodeSize;return K(R,Q,Oe)}let De=null,ke=null;for(let He=J.depth;He>0;He-=1)if(J.node(He)?.type?.name==="outlineSection")if(De===null)De=He;else{ke=He;break}if(ke===null)return!1;let $e=J.before(ke);return K(R,Q,$e)})}},addProseMirrorPlugins(){let y=(g,v)=>{for(let k=g.depth;k>0;k-=1)if(g.node(k)?.type?.name===v)return k;return null};return[new w({key:new x("outlineAltMoveRepeatGuard"),props:{handleKeyDown:(g,v)=>{let k=_=>{try{return!!_?.getModifierState?.("AltGraph")}catch{return!1}},N=_=>{try{return(!!_?.altKey||k(_))&&!_?.metaKey&&(!_?.ctrlKey||k(_))}catch{return!1}};try{if(!v||!N(v))return!1;let _=String(v.key||"");if(_!=="ArrowUp"&&_!=="ArrowDown"||!v.repeat)return!1;let O=g?.state,K=O?.selection?.$from;if(!K)return!1;for(let T=K.depth;T>0;T-=1){let I=K.node(T)?.type?.name;if(I&&String(I).startsWith("table"))return!1}let D=null;for(let T=K.depth;T>0;T-=1)if(K.node(T)?.type?.name==="outlineSection"){D=K.before(T);break}if(typeof D!="number")return!1;let M=O.doc.resolve(D),B=M.parent;if(!B)return!1;let E=M.index();return _==="ArrowUp"&&E<=0||_==="ArrowDown"&&E>=B.childCount-1}catch{return!1}}}}),new w({props:{handleDOMEvents:{cut:(g,v)=>{try{let{state:k}=g,{selection:N}=k;if(!N||N.empty)return!1;let _=(xe,me)=>{for(let Ae=me.depth;Ae>0;Ae-=1)if(me.node(Ae)?.type?.name==="outlineSection")return me.before(Ae);return null},O=_(k.doc,N.$from),K=_(k.doc,N.$to);if(typeof O!="number"||typeof K!="number")return!1;let D=(xe="")=>String(xe||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");if(O===K){let xe=y(N.$from,"outlineHeading"),me=y(N.$to,"outlineHeading");if(xe!==null&&me!==null){let Ae=k.doc.nodeAt(O);if(!Ae)return!1;let Te=Ae.child(0),_e=O+1,Pe=_e+1,Se=_e+Te.nodeSize-1;if(N.from>=Pe&&N.to<=Se){let Fe=Math.max(N.from,Pe),je=Math.min(N.to,Se),Ue=k.doc.textBetween(Fe,je,`
`,`
`);if(v?.clipboardData)try{v.clipboardData.setData("text/plain",Ue),v.clipboardData.setData("text/html",`<pre>${D(Ue)}</pre>`)}catch{}v.preventDefault(),v.stopPropagation();let nt=k.tr.delete(Fe,je);return nt=nt.setSelection(f.near(nt.doc.resolve(Pe),1)),g.dispatch(nt.scrollIntoView()),!0}}return!1}if(y(N.$from,"outlineBody")===null||N.$to.parent?.type?.name!=="outlineHeading"||N.$to.parentOffset!==0)return!1;let B=k.doc.nodeAt(O);if(!B)return!1;let E=B.child(0),T=B.child(1),I=O+1+E.nodeSize,P=I+1,$=I+T.nodeSize-1,V=Math.max(N.from,P),z=Math.min(N.to,$);if(z<V)return!0;let q=k.doc.textBetween(V,z,`
`,`
`);if(v?.clipboardData)try{v.clipboardData.setData("text/plain",q),v.clipboardData.setData("text/html",`<pre>${D(q)}</pre>`)}catch{}v.preventDefault(),v.stopPropagation();let Z=k.tr.delete(V,z),se=Z.doc.nodeAt(I);if(se&&se.content.size===0){let xe=Z.doc.type.schema;Z=Z.insert(P,xe.nodes.paragraph.create({},[]))}return Z=Z.setSelection(f.near(Z.doc.resolve(P+1),1)),g.dispatch(Z.scrollIntoView()),!0}catch{return!1}}}}}),new w({props:{handleKeyDown:(g,v)=>{if(v.key!=="Backspace")return!1;let{state:k}=g,{selection:N}=k;if(!N?.empty)return!1;let{$from:_}=N;if(_.parent?.type?.name!=="paragraph"||_.parentOffset!==0)return!1;let O=null;for(let Z=_.depth;Z>0;Z-=1)if(_.node(Z)?.type?.name==="listItem"){O=Z;break}if(O===null||_.index(O)!==0)return!1;let K=O-1,D=_.node(K);if(!D)return!1;let M=_.index(K);if(M<=0)return!1;let B=_.before(O),E=D.child(M-1),T=B-E.nodeSize,I=k.doc.nodeAt(B);if(!I||I.type?.name!=="listItem")return!1;v.preventDefault(),v.stopPropagation();let P=E.type.create(E.attrs,E.content.append(I.content),E.marks),$=k.tr.replaceWith(T,T+E.nodeSize,P),V=T+1+E.content.size,z=$.mapping.map(V,1),q=$.mapping.map(B);$=$.delete(q,q+I.nodeSize);try{$=$.setSelection(f.near($.doc.resolve(z+1),1))}catch{}return g.dispatch($.scrollIntoView()),!0}}}),new w({props:{handleKeyDown:(g,v)=>(v.key!=="Tab"||v.preventDefault(),!1)}}),new w({props:{handleKeyDown:(g,v)=>{if(!v.ctrlKey||v.shiftKey||v.altKey||v.metaKey||v.key!=="ArrowUp"&&v.key!=="ArrowDown")return!1;let{state:k}=g,{selection:N}=k;if(!N)return!1;let O=(()=>{if((N?.node||null)?.type?.name==="outlineSection")return N.from;let T=N.$from;for(let I=T.depth;I>0;I-=1)if(T.node(I)?.type?.name==="outlineSection")return T.before(I);return null})();if(typeof O!="number")return!1;let K=(E,T)=>{try{let I=E.resolve(Math.min(E.content.size,T+1)),P=null;for(let $=I.depth;$>0;$-=1)if(I.node($)?.type?.name==="outlineSection"&&I.before($)===T){P=$;break}if(P===null)return null;for(let $=P-1;$>0;$-=1)if(I.node($)?.type?.name==="outlineSection")return I.before($);return null}catch{return null}},D=(E,T)=>{let I=E.nodeAt(T);if(!I||I.type?.name!=="outlineSection")return[];let P=[T];return I.descendants(($,V)=>{$?.type?.name==="outlineSection"&&P.push(T+1+V)}),P};if(v.preventDefault(),v.stopPropagation(),v.key==="ArrowUp"){let E=K(k.doc,O),T=typeof E=="number"?E:O,I=D(k.doc,T);if(!I.length)return!0;let P=k.tr;for(let V of I){let z=P.doc.nodeAt(V);!z||z.type?.name!=="outlineSection"||z.attrs?.collapsed||(P=P.setNodeMarkup(V,void 0,{...z.attrs,collapsed:!0}))}let $=P.doc.nodeAt(T);if($){let V=$.child(0),q=T+1+V.nodeSize-1;P=P.setSelection(f.near(P.doc.resolve(q),-1))}return g.dispatch(P.scrollIntoView()),!0}let M=D(k.doc,O);if(!M.length)return!0;let B=k.tr;for(let E of M){let T=B.doc.nodeAt(E);!T||T.type?.name!=="outlineSection"||T.attrs?.collapsed&&(B=B.setNodeMarkup(E,void 0,{...T.attrs,collapsed:!1}))}return g.dispatch(B),!0}}}),new w({props:{handleKeyDown:(g,v)=>{if(v.key!=="Enter")return!1;let{state:k}=g,{$from:N}=k.selection;if(!k.selection.empty)return!1;let _=y(N,"outlineBody");if(_===null)return!1;let O=y(N,"paragraph");if(O===null||N.node(O-1)?.type?.name!=="outlineBody")return!1;let K=N.node(O);if(!K||K.content.size!==0||N.parentOffset!==0&&N.parentOffset!==K.content.size)return!1;let D=N.node(_),M=N.index(_);if(M!==D.childCount-1||M<1)return!1;let B=D.child(M-1);if(!B||B.type?.name!=="paragraph"||B.content.size!==0)return!1;let E=y(N,"outlineSection");if(E===null)return!1;let T=N.before(E);v.preventDefault(),v.stopPropagation();let I=k.tr,P=N.start(_),$=P;for(let Te=0;Te<M;Te+=1)$+=D.child(Te).nodeSize;let V=M;for(let Te=M;Te>=0;Te-=1){let _e=D.child(Te);if(!_e||_e.type?.name!=="paragraph"||_e.content.size!==0)break;V=Te}let z=P;for(let Te=0;Te<V;Te+=1)z+=D.child(Te).nodeSize;let q=$+D.child(M).nodeSize;I=I.delete(z,q);let Z=I.doc.nodeAt(T);if(!Z)return!0;let se=T+Z.nodeSize,xe=I.doc.type.schema,me=Wt(),Ae=xe.nodes.outlineSection.create({id:me,collapsed:!1},[xe.nodes.outlineHeading.create({},[]),xe.nodes.outlineBody.create({},[xe.nodes.paragraph.create({},[])]),xe.nodes.outlineChildren.create({},[])]);return I=I.insert(se,Ae),I=I.setSelection(f.create(I.doc,se+2)),I=I.setMeta(ue,!0),Ee&&(I=I.setMeta(Ee,{type:"enter",sectionId:me})),g.dispatch(I.scrollIntoView()),!0}}})]}}),ge=d.create({name:"outlineActiveSection",addProseMirrorPlugins(){return[new w({props:{decorations(y){try{let g=Ct(y.doc,y.selection.$from);if(typeof g!="number")return null;let v=y.doc.nodeAt(g);return v?C.create(y.doc,[A.node(g,g+v.nodeSize,{"data-active":"true"})]):null}catch{return null}}}})]}}),Be=d.create({name:"outlineEditMode",addProseMirrorPlugins(){let y=new x("outlineEditMode");Ee=y;let g=null,v=D=>{let M=Ct(D.doc,D.selection.$from);if(typeof M!="number")return null;let B=D.doc.nodeAt(M);return String(B?.attrs?.id||"")||null},k=(D,M,B)=>{if(!M.docChanged)return!0;if(!B)return!1;let E=mt(D.doc,B);if(typeof E!="number")return!1;let T=D.doc.nodeAt(E);if(!T)return!1;let I=T.child(0),P=T.child(1),$=E+1,V=$+1,z=$+I.nodeSize-1,q=E+1+I.nodeSize,Z=q+1,se=q+P.nodeSize-1,xe=(me,Ae)=>{let Te=me>=V&&Ae<=z,_e=me>=Z&&Ae<=se;return Te||_e};for(let me of M.steps){let Ae=me.getMap(),Te=!0;if(Ae.forEach((_e,Pe)=>{xe(_e,Pe)||(Te=!1)}),!Te)return!1}return!0},N=()=>{try{Ie("\u0414\u043B\u044F \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u043D\u0430\u0436\u043C\u0438\u0442\u0435 Enter \u0438\u043B\u0438 \u0434\u0432\u043E\u0439\u043D\u043E\u0439 \u043A\u043B\u0438\u043A \u043C\u044B\u0448\u043A\u043E\u0439. Esc \u0434\u043B\u044F \u0432\u044B\u0445\u043E\u0434\u0430.")}catch{}},_=()=>{try{Ie("\u041D\u0430\u0436\u043C\u0438\u0442\u0435 \u0435\u0449\u0451 \u0440\u0430\u0437, \u0447\u0442\u043E\u0431\u044B \u043E\u0431\u044A\u0435\u0434\u0438\u043D\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438")}catch{}},O=D=>{try{let{selection:M}=D;if(!M?.empty)return!1;let{$from:B}=M,E=null;for(let z=B.depth;z>0;z-=1)if(B.node(z)?.type?.name==="outlineHeading"){E=z;break}if(E===null||!(B.pos===B.start(E)))return!1;let I=Ct(D.doc,B);if(typeof I!="number")return!1;if(D.doc.resolve(I).index()>0)return!0;let V=!1;for(let z=B.depth;z>0;z-=1)if(B.node(z)?.type?.name==="outlineSection"){if(!V){V=!0;continue}return!0}return!1}catch{return!1}},K=(D,M)=>{try{if(!M)return!1;let{selection:B}=D;if(!B?.empty)return!1;let{$from:E}=B,T=Ct(D.doc,E);if(typeof T!="number")return!1;let I=D.doc.nodeAt(T);if(!I||String(I.attrs?.id||"")!==String(M))return!1;let P=I.child(0),$=I.child(1),z=T+1+P.nodeSize+$.nodeSize-1;if(E.pos!==z)return!1;let q=D.doc.resolve(T),Z=q.index(),se=q.parent;return se?Z<se.childCount-1:!1}catch{return!1}};return[new w({key:y,state:{init(){return{editingSectionId:null}},apply(D,M){let B=D.getMeta(y);return B?B.type==="enter"?{editingSectionId:B.sectionId||null}:B.type==="exit"?{editingSectionId:null}:M:M}},filterTransaction(D,M){let E=(y.getState(M)||{}).editingSectionId||null;return D.getMeta(ue)||D.getMeta("history$")!=null||D.getMeta("closeHistory$")!=null||!D.docChanged?!0:k(M,D,E)},props:{decorations(D){try{let B=(y.getState(D)||{}).editingSectionId||null;if(!B)return null;let E=mt(D.doc,B);if(typeof E!="number")return null;let T=D.doc.nodeAt(E);return T?C.create(D.doc,[A.node(E,E+T.nodeSize,{"data-editing":"true"})]):null}catch{return null}},handleKeyDown(D,M){let B=D.state,T=(y.getState(B)||{}).editingSectionId||null;tt("keydown",{key:M?.key||null,repeat:!!M?.repeat,editingSectionId:T||null,selection:{empty:!!B?.selection?.empty,parent:B?.selection?.$from?.parent?.type?.name||null,parentOffset:B?.selection?.$from?.parentOffset??null}});let I=v(B);if(!T&&(M.key==="Delete"||M.key==="Del"||M.key==="Backspace")&&(M.ctrlKey||M.metaKey)&&!M.shiftKey&&!M.altKey){try{deleteActiveSection()}catch{}return M.preventDefault(),M.stopPropagation(),!0}if(T&&M.key==="Backspace"&&!M.ctrlKey&&!M.metaKey&&!M.altKey){let $=rm(B,D.dispatch,T,f);if(tt("editorProps.backspace.bodyToHeading",{promoted:$,editingSectionId:T}),$)return M.preventDefault(),M.stopPropagation(),!0;let V=nm(B,D.dispatch);if(tt("editorProps.backspace.tableMerge",{merged:V,editingSectionId:T||null}),V)return M.preventDefault(),M.stopPropagation(),!0}try{let $=(M.key==="Enter"||M.code==="Enter"||M.code==="NumpadEnter")&&(M.ctrlKey||M.metaKey)&&!M.shiftKey&&!M.altKey;if(!u.isPublicView&&!T&&$){let V=B.selection,z=V?.$from||null;if(z){let q=Ct(B.doc,z),Z=typeof q=="number"?B.doc.nodeAt(q):null;if(typeof q=="number"&&Z&&Z.type?.name==="outlineSection"){let se=!!(V&&V.empty),xe=z.parent?.type?.name==="outlineHeading",Ae=se&&xe&&z.parentOffset===0?q:q+Z.nodeSize;M.preventDefault(),M.stopPropagation();let Te=B.schema,_e=Wt(),Pe=Te.nodes.outlineSection.create({id:_e,collapsed:!1},[Te.nodes.outlineHeading.create({},[]),Te.nodes.outlineBody.create({},[Te.nodes.paragraph.create({},[])]),Te.nodes.outlineChildren.create({},[])]),Se=B.tr.insert(Ae,Pe);try{let je=Se.doc.nodeAt(Ae)?.child?.(0)||Pe.child(0),Ue=Ae+1+je.nodeSize;Se=Se.setSelection(f.near(Se.doc.resolve(Ue+2),1))}catch{Se=Se.setSelection(f.create(Se.doc,Ae+2))}Se=Se.setMeta(ue,!0),Se=Se.setMeta(y,{type:"enter",sectionId:_e}),D.dispatch(Se.scrollIntoView());try{D.focus()}catch{}return!0}}}}catch{}if((!g||g.sectionId!==I||g.key!==M.key)&&(g=null),u.isPublicView&&!T&&(M.key==="Enter"&&!M.shiftKey&&!M.ctrlKey&&!M.metaKey&&!M.altKey||M.key==="F2"&&!M.shiftKey&&!M.ctrlKey&&!M.metaKey&&!M.altKey))return M.preventDefault(),M.stopPropagation(),!0;if(!T&&(M.key==="Enter"&&!M.shiftKey&&!M.ctrlKey&&!M.metaKey&&!M.altKey||M.key==="F2"&&!M.shiftKey&&!M.ctrlKey&&!M.metaKey&&!M.altKey)){let $=v(B);return $?(M.preventDefault(),M.stopPropagation(),D.dispatch(B.tr.setMeta(y,{type:"enter",sectionId:$})),!0):!1}if(T&&M.key==="Escape")return M.preventDefault(),M.stopPropagation(),D.dispatch(B.tr.setMeta(y,{type:"exit"})),!0;if(!T){let $=M.key&&M.key.length===1&&!M.metaKey&&!M.ctrlKey&&!M.altKey;if(M.key==="Backspace"||M.key==="Delete"){if(M.key==="Backspace"&&O(B))try{let{selection:z}=B,{$from:q}=z,Z=findSectionPos(B.doc,q);if(typeof Z!="number")return!1;let se=B.doc.nodeAt(Z);if(!se)return!1;let xe=String(se.attrs?.id||""),me=null;try{let Te=B.doc.resolve(Z),_e=Te.index(),Pe=Te.parent;if(Pe&&_e>0){let Se=Pe.child(_e-1),Fe=Z-Se.nodeSize,je=B.doc.nodeAt(Fe);me=String(je?.attrs?.id||"")||null}else for(let Se=q.depth-1;Se>0;Se-=1){let Fe=q.node(Se);if(Fe?.type?.name==="outlineSection"){let je=String(Fe.attrs?.id||"");if(je&&je!==xe){me=je;break}}}}catch{me=null}let Ae=!1;if(an(se))Ae=Y(B,D.dispatch,Z);else try{B.doc.resolve(Z).index()<=0?Ae=pe(B,D.dispatch,Z):Ae=ie(B,D.dispatch,Z)}catch{Ae=ie(B,D.dispatch,Z)}return Ae&&me&&window.setTimeout(()=>{try{if((y.getState(D.state)||{}).editingSectionId)return;let _e=mt(D.state.doc,me),Pe=typeof _e=="number"?D.state.doc.nodeAt(_e):null;if(!Pe)return;let Se=D.state.tr;Pe?.attrs?.collapsed&&(Se=Se.setNodeMarkup(_e,void 0,{...Pe.attrs,collapsed:!1}),Se=Se.setMeta(ue,!0)),Se=Se.setMeta(y,{type:"enter",sectionId:me});try{let Fe=Se.doc.nodeAt(_e);if(Fe&&Fe.type?.name==="outlineSection"){let je=Fe.child(0),Ue=Fe.child(1),ut=_e+1+je.nodeSize+Ue.nodeSize-1;Se=Se.setSelection(f.near(Se.doc.resolve(ut),-1))}}catch{}D.dispatch(Se.scrollIntoView());try{D.focus()}catch{}}catch{}},0),M.preventDefault(),M.stopPropagation(),!0}catch{}return M.preventDefault(),M.stopPropagation(),!0}if($)return M.preventDefault(),M.stopPropagation(),N(),!0}let P=M.key==="Backspace"&&O(B)||M.key==="Delete"&&K(B,T);if(T&&(M.key==="Backspace"||M.key==="Delete")&&P){if(M.repeat)return M.preventDefault(),M.stopPropagation(),!0;let $=Date.now();return g&&g.sectionId===T&&g.key===M.key&&$-g.ts<1200?(g=null,!1):(g={sectionId:T,key:M.key,ts:$},M.preventDefault(),M.stopPropagation(),_(),!0)}return!1},handleTextInput(){let D=arguments[0],M=D?.state?y.getState(D.state):null;return M&&M.editingSectionId?!1:(N(),!0)},handleDOMEvents:{paste(D,M){let B=D.state;return(y.getState(B)||{}).editingSectionId?!1:(M.preventDefault(),M.stopPropagation(),N(),!0)},drop(D,M){let B=D.state;return(y.getState(B)||{}).editingSectionId?!1:(M.preventDefault(),M.stopPropagation(),N(),!0)}}}})]}}),ve=y=>{let g=(y||"").trim();if(!g)return[];let v=S(g,[b.configure({heading:!1,link:!1}),L.configure({openOnClick:!1,protocols:Ai}),wt,F.configure({table:{resizable:!0}})]),k=Array.isArray(v?.content)?v.content:[],N=[];for(let _=0;_<k.length;_+=1){let O=k[_];if(O?.type!=="paragraph"){N.push(O);continue}let D=pd(O).trim();if(!xn(D)){N.push(O);continue}let B=[],E=_,T=_;for(;T<k.length;T+=1){let $=k[T];if($?.type!=="paragraph")break;let V=pd($).trim();if(!V)break;B.push(V)}let I=Er(B);if(!I){N.push(O);continue}let P=im(I);if(!P){N.push(O);continue}N.push(P),_=T-1,_<E&&(_=E)}return N};Po=ve;let de=d.create({name:"outlineMarkdown",addCommands(){return{insertMarkdown:y=>({editor:g})=>{if(!Ee)return!1;if(!(Ee.getState(g.state)||{}).editingSectionId)return Qr(),!1;if(!g?.storage?.markdown?.parser)return Ie("Markdown \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F"),!1;let k=g.storage.markdown.parser.parse(String(y||""),{inline:!0}),N=ve(k);return N.length?g.chain().focus().insertContent(N).run():!1}}}}),Ne=d.create({name:"outlineFormattedPaste",addProseMirrorPlugins(){let y=this.editor,g=K=>{let D=String(K||"").trim();if(!D)return"";let M=null;try{M=new DOMParser().parseFromString(D,"text/html")}catch{return D}let B=M?.body;if(!B)return D;try{for(let E of Array.from(B.querySelectorAll("ms-cmark-node"))){let T=E.parentNode;if(T){for(;E.firstChild;)T.insertBefore(E.firstChild,E);T.removeChild(E)}}}catch{}try{for(let E of Array.from(B.querySelectorAll("h1,h2,h3,h4,h5,h6"))){let T=M.createElement("p"),I=M.createElement("strong");try{for(;E.firstChild;)I.appendChild(E.firstChild)}catch{I.textContent=String(E.textContent||"")}T.appendChild(I),E.replaceWith(T)}}catch{}return String(B.innerHTML||"").replace(/<!--\s*StartFragment\s*-->/gi,"").replace(/<!--\s*EndFragment\s*-->/gi,"").trim()},v=K=>{let D=String(K||"").trim();if(!D||!D.includes("<")||!D.includes(">")||!/<\s*\/?\s*[a-z][^>]*>/i.test(D))return!1;try{let B=new DOMParser().parseFromString(D,"text/html")?.body;if(!B)return!1;let E=new Set(["p","br","strong","b","em","i","u","s","a","ul","ol","li","blockquote","pre","code","table","thead","tbody","tr","td","th","img","span","div","h1","h2","h3","h4","h5","h6"]);return!!Array.from(B.querySelectorAll("*")).find(I=>E.has(String(I.tagName||"").toLowerCase()))}catch{return!1}},k=K=>{let D=String(K||"").replace(/\r\n/g,`
`).trim();return D?[/```[\s\S]*```/m,/^\s{0,3}([-*+]|\d+\.)\s+\S/m,/^\s{0,3}>\s+\S/m,/\[[^\]]+\]\([^)]+\)/,/!\[[^\]]*\]\([^)]+\)/,/\*\*[^*\n]+\*\*/,/__[^_\n]+__/,/`[^`\n]+`/].some(B=>B.test(D)):!1},N=K=>{try{let D=String(K||"").replace(/\r\n/g,`
`).split(`
`).map(M=>String(M||"").trim()).filter(Boolean);return D.length<2?!1:!!Er(D)}catch{return!1}},_=(K,D)=>{if(!D||!Array.isArray(D)||!D.length)return!1;let M=K?.state?.selection?.from,B=K?.state?.selection?.to;if(!Number.isFinite(M)||!Number.isFinite(B))return!1;try{return y.chain().focus().command(({tr:E})=>(E.setMeta(ue,!0),!0)).insertContentAt({from:M,to:B},D).run()}catch{return!1}},O=(K,D)=>{try{if(!(Ee?.getState?.(K.state)||null)?.editingSectionId)return!1;let B=D?.clipboardData?.items||null,E=D?.clipboardData?.files||null;if(E&&E.length||B&&Array.from(B).some(P=>P?.kind==="file"))return!1;let T=String(D?.clipboardData?.getData?.("text/html")||"").trim(),I=String(D?.clipboardData?.getData?.("text/plain")||"").trim();if(T)try{let P=String(T).match(/<h[1-6][\s>]/gi);if((Array.isArray(P)?P.length:0)>=2)return!1}catch{}if(T){let P=g(T),$=ve(P);return $.length?(D.preventDefault(),D.stopPropagation(),_(K,$)):!1}if(I&&v(I)){let P=g(I),$=ve(P);return $.length?(D.preventDefault(),D.stopPropagation(),_(K,$)):!1}if(I&&k(I)){if(N(I))return!1;try{let Z=ra(I);if(Z?.startsWithHeading||(Z?.sections?.length||0)>=2)return!1}catch{}let P=y?.storage?.markdown?.parser||null;if(!P?.parse)return!1;let $=!I.includes(`
`)&&!/^\s{0,3}([-*+]|\d+\.)\s+\S/m.test(I)&&!/```[\s\S]*```/m.test(I)&&!/^\s{0,3}>\s+\S/m.test(I),V=String(P.parse(I,{inline:$})).trim();if(!V)return!1;let z=g(V),q=ve(z);return q.length?(D.preventDefault(),D.stopPropagation(),_(K,q)):!1}return!1}catch{return!1}};return[new w({props:{handlePaste(K,D){return O(K,D)},handleDOMEvents:{paste(K,D){return O(K,D)}}}})]}}),Ke=!1,Ve=null,rt=Ar()?performance.now():0,Ze=u.article?.docJson||null;if(Ze&&typeof Ze=="object"&&Ze.type==="doc"&&Array.isArray(Ze.content)&&(Ve=Ze),Ve||(Ve=Cm({blocks:u.article?.blocks||[],parseHtmlToNodes:ve}),Ke=!!(u.article&&!u.article?.docJson&&!u.article?.encrypted)),rt&&Xr("build initial content",{ms:Math.round(performance.now()-rt)}),le){try{le.destroy()}catch{}le=null}let ot=G?G.configure({html:!0,tightLists:!0,transformPastedText:!1,transformCopiedText:!1}):null,Je=d.create({name:"outlineTableCellStyling",addOptions(){return{types:["tableCell","tableHeader"],textAlignValues:["left","center","right","justify"],verticalAlignValues:["top","middle","bottom"]}},addGlobalAttributes(){let y=(v,k)=>{try{let N=v?.style?.[k];return N?String(N).trim():""}catch{return""}},g=v=>{let k=[],N=v?.nodeTextAlign?String(v.nodeTextAlign):"",_=v?.nodeVerticalAlign?String(v.nodeVerticalAlign):"",O=v?.nodeTextColor?String(v.nodeTextColor):"",K=v?.nodeBackground?String(v.nodeBackground):"";return N&&this.options.textAlignValues.includes(N)&&k.push(`text-align: ${N}`),_&&this.options.verticalAlignValues.includes(_)&&k.push(`vertical-align: ${_}`),O&&k.push(`color: ${O}`),K&&k.push(`background-color: ${K}`),k.length?{style:k.join("; ")}:{}};return[{types:this.options.types,attributes:{nodeTextAlign:{default:null,parseHTML:v=>{let k=y(v,"textAlign");return k&&this.options.textAlignValues.includes(k)?k:null},renderHTML:v=>g(v)},nodeVerticalAlign:{default:null,parseHTML:v=>{let k=y(v,"verticalAlign");return k&&this.options.verticalAlignValues.includes(k)?k:null},renderHTML:v=>g(v)},nodeTextColor:{default:null,parseHTML:v=>{let k=y(v,"color");return k?String(k).replace(/['"]+/g,""):null},renderHTML:v=>g(v)},nodeBackground:{default:null,parseHTML:v=>{let k=y(v,"backgroundColor");return k?String(k).replace(/['"]+/g,""):null},renderHTML:v=>g(v)}}}]},addCommands(){let y=(v,k)=>({state:N,dispatch:_})=>{try{let O=pa(N);if(!O.length)return!1;let K=N.tr,D=!1;for(let{node:M,pos:B}of O){if(!M||typeof B!="number")continue;let E={...M.attrs||{}};k==null||k===""?delete E[v]:E[v]=k,K=K.setNodeMarkup(B,void 0,E),D=!0}return D?(K=K.setMeta(ue,!0),_(K),!0):!1}catch{return!1}},g=()=>({state:v,dispatch:k})=>{try{let N=pa(v);if(!N.length)return!1;let _=v.schema.nodes?.paragraph||null;if(!_)return!1;let O=v.tr,K=[...N].sort((M,B)=>Number(B.pos)-Number(M.pos)),D=!1;for(let{node:M,pos:B}of K){if(!M||typeof B!="number")continue;let E=B+1,T=B+M.nodeSize-1;if(!(T>=E))continue;let I=_.createAndFill();I&&(O=O.replaceWith(E,T,I),D=!0)}return D?(O=O.setMeta(ue,!0),k(O.scrollIntoView()),!0):!1}catch{return!1}};return{setNodeTextAlign:v=>y("nodeTextAlign",v),setNodeVAlign:v=>y("nodeVerticalAlign",v),setNodeTextColor:v=>y("nodeTextColor",v),setNodeBackground:v=>y("nodeBackground",v),unsetNodeAlignment:()=>({state:v,dispatch:k})=>{try{let N=pa(v);if(!N.length)return!1;let _=v.tr,O=!1;for(let{node:K,pos:D}of N){if(!K||typeof D!="number")continue;let M=K.attrs?.nodeTextAlign||null,B=K.attrs?.nodeVerticalAlign||null;if(!M&&!B)continue;let E={...K.attrs||{}};delete E.nodeTextAlign,delete E.nodeVerticalAlign,_=_.setNodeMarkup(D,void 0,E),O=!0}return O?(_=_.setMeta(ue,!0),k(_),!0):!1}catch{return!1}},clearNodeContents:()=>g()}}}),at=d.create({name:"outlineTablePercentWidths",addProseMirrorPlugins(){return[new w({view(y){let g=null,v=_=>{let O=String(_||"").trim();if(!O)return 0;let K=O.match(/(-?\\d+(?:\\.\\d+)?)px/i);return K&&Number(K[1])||0},k=()=>{g=null;try{let _=y?.dom;if(!_)return;let O=_.querySelectorAll(".tableWrapper > table");for(let K of O){let D=K.querySelector("colgroup");if(!D)continue;let M=Array.from(D.querySelectorAll("col"));if(!M.length||xr)continue;try{K.style.width="100%",K.style.maxWidth="100%",K.style.tableLayout="fixed"}catch{}let B=!1;for(let E of M){let T=E?.dataset?.ttPct||"",I=Number.parseFloat(String(T||""));if(Number.isFinite(I)&&I>0)B=!0,E.style.width=`${I.toFixed(4)}%`,E.style.minWidth="";else{let P=Hd(E.style.width);P!=null&&P>0&&(B=!0,E.dataset.ttPct=P.toFixed(4),E.style.width=`${P.toFixed(4)}%`,E.style.minWidth="")}}if(!B)try{let E=K.querySelector("tbody tr");if(!E)continue;let T=Array.from(E.children||[]).filter(z=>z&&z.nodeType===1);if(T.length<M.length)continue;let I=[];for(let z=0;z<M.length;z+=1){let q=T[z].getBoundingClientRect();I.push(Number.isFinite(q.width)?q.width:0)}let P=I.reduce((z,q)=>z+(Number.isFinite(q)?q:0),0);if(!(P>0))continue;let $=I.map(z=>Hn(z/P*100)),V=$.reduce((z,q)=>z+q,0);Math.abs(V-100)>.01&&($[$.length-1]=Hn($[$.length-1]+(100-V)));for(let z=0;z<M.length;z+=1)$i(M[z],$[z])}catch{}}}catch{}},N=()=>{g==null&&(g=window.requestAnimationFrame(k))};return N(),{update(){N()},destroy(){g!=null&&(window.cancelAnimationFrame(g),g=null)}}}})]}}),ct=d.create({name:"outlineTableSmartMouseSelection",addProseMirrorPlugins(){let y=At?.CellSelection||null;return y?[new w({view(g){let v=N=>{try{for(let _=N.depth;_>=0;_-=1){let O=N.node(_)?.type?.name;if(O==="tableCell"||O==="tableHeader")return N.before(_)}}catch{}return null},k=()=>{try{if(!(Ee?.getState?.(g.state)||null)?.editingSectionId)return;let _=g.state.selection;if(!_||_.empty)return;let O=v(_.$anchor),K=v(_.$head);if(O==null||K==null||O===K)return;let D=typeof y.create=="function"?y.create(g.state.doc,O,K):null;if(!D)return;let M=g.state.tr.setSelection(D);M=M.setMeta(ue,!0),g.dispatch(M)}catch{}};return g.dom.addEventListener("mouseup",k,!0),{destroy(){g.dom.removeEventListener("mouseup",k,!0)}}}})]:[]}}),it=d.create({name:"outlineTableResizeCapture",addProseMirrorPlugins(){return[new w({view(y){let g=k=>{try{if(!k?.target?.closest?.(".column-resize-handle")||!(Ee?.getState?.(y.state)||null)?.editingSectionId)return;xr=!0}catch{}},v=()=>{if(xr){xr=!1;try{let k=y.domAtPos(y.state.selection.from),_=((k?.node&&k.node.nodeType===1?k.node:k?.node?.parentElement)||null)?.closest?.("table")||null;_&&Pi(_)}catch{}}};return y.dom.addEventListener("pointerdown",g,!0),document.addEventListener("pointerup",v,!0),document.addEventListener("pointercancel",v,!0),{destroy(){y.dom.removeEventListener("pointerdown",g,!0),document.removeEventListener("pointerup",v,!0),document.removeEventListener("pointercancel",v,!0)}}}})]}}),te=d.create({name:"outlineTableNodeUi",addProseMirrorPlugins(){let y=this.editor,g=[{label:"Default text",value:null},{label:"Gray text",value:"var(--tt-color-text-gray)"},{label:"Brown text",value:"var(--tt-color-text-brown)"},{label:"Orange text",value:"var(--tt-color-text-orange)"},{label:"Yellow text",value:"var(--tt-color-text-yellow)"},{label:"Green text",value:"var(--tt-color-text-green)"},{label:"Blue text",value:"var(--tt-color-text-blue)"},{label:"Purple text",value:"var(--tt-color-text-purple)"},{label:"Pink text",value:"var(--tt-color-text-pink)"},{label:"Red text",value:"var(--tt-color-text-red)"}],v=[{label:"Default background",value:null},{label:"Gray background",value:"var(--tt-color-highlight-gray)"},{label:"Brown background",value:"var(--tt-color-highlight-brown)"},{label:"Orange background",value:"var(--tt-color-highlight-orange)"},{label:"Yellow background",value:"var(--tt-color-highlight-yellow)"},{label:"Green background",value:"var(--tt-color-highlight-green)"},{label:"Blue background",value:"var(--tt-color-highlight-blue)"},{label:"Purple background",value:"var(--tt-color-highlight-purple)"},{label:"Pink background",value:"var(--tt-color-highlight-pink)"},{label:"Red background",value:"var(--tt-color-highlight-red)"}],k=[{label:"Align left",value:"left"},{label:"Align center",value:"center"},{label:"Align right",value:"right"},{label:"Justify",value:"justify"}],N=[{label:"Align top",value:"top"},{label:"Align middle",value:"middle"},{label:"Align bottom",value:"bottom"}],_=M=>{try{if(!M)return null;let B={left:Number(M.left),top:Number(M.top),right:Number(M.right),bottom:Number(M.bottom),width:Number(M.width),height:Number(M.height)};return!Number.isFinite(B.left)||!Number.isFinite(B.top)?null:B}catch{return null}},O=(M,B,E,T,I=8)=>{try{let P=window.innerWidth||0,$=window.innerHeight||0,V=Math.max(I,Math.min(M,Math.max(I,P-E-I))),z=Math.max(I,Math.min(B,Math.max(I,$-T-I)));return{left:V,top:z}}catch{return{left:M,top:B}}};class K{constructor(){this.panels=[],this.onDocPointerDown=B=>{try{let E=B?.target||null,T=typeof B?.composedPath=="function"?B.composedPath():null,I=Array.isArray(T)&&T.length?T:E?[E]:[];if(!I.length)return;for(let P of I)for(let $ of this.panels)if($&&(P===$||$.contains(P)))return;this.closeAll()}catch{this.closeAll()}},this.onKeyDown=B=>{B?.key==="Escape"&&this.closeAll()}}isOpen(){return this.panels.length>0}closeAll(){try{for(let B of this.panels)B?.remove?.()}catch{}this.panels=[];try{document.removeEventListener("pointerdown",this.onDocPointerDown,!1),window.removeEventListener("keydown",this.onKeyDown,!1)}catch{}}openPanel({anchorRect:B,items:E,level:T=0}){let I=_(B);if(!I)return;for(;this.panels.length>T;){let Z=this.panels.pop();try{Z?.remove?.()}catch{}}let P=document.createElement("div");P.className="tt-table-menu",P.setAttribute("role","menu"),P.setAttribute("data-level",String(T)),P.addEventListener("pointerdown",Z=>{Z.stopPropagation()}),P.addEventListener("mousedown",Z=>{Z.stopPropagation()});for(let Z of E){if(Z.type==="separator"){let xe=document.createElement("div");xe.className="tt-table-menu-sep",P.appendChild(xe);continue}let se=document.createElement("button");if(se.type="button",se.className="tt-table-menu-item",se.textContent=Z.label,se.disabled=!!Z.disabled,Z.swatch){se.classList.add("has-swatch");try{let xe=Z.swatchValue==null?"transparent":String(Z.swatchValue);se.style.setProperty("--tt-swatch",xe)}catch{}}Z.submenu&&se.classList.add("has-submenu"),se.addEventListener("click",xe=>{if(xe.preventDefault(),xe.stopPropagation(),!Z.disabled){if(Z.submenu){let me=se.getBoundingClientRect();this.openPanel({anchorRect:me,items:Z.submenu(),level:T+1});return}try{Z.onClick?.()}finally{this.closeAll()}}}),P.appendChild(se)}document.body.appendChild(P);let $=P.getBoundingClientRect(),V=I.right+8,z=I.top,q=O(V,z,$.width,$.height);P.style.left=`${q.left}px`,P.style.top=`${q.top}px`,this.panels.push(P);try{this.panels.length===1&&(document.addEventListener("pointerdown",this.onDocPointerDown,!1),window.addEventListener("keydown",this.onKeyDown,!1))}catch{}}}class D{constructor(B){this.view=B,this.menu=new K,this.wrapper=null,this.table=null,this.observedTable=null,this.resizeObserver=null,this.layoutRaf=null,this.resizeRaf=null,this.destroyed=!1,this.root=document.createElement("div"),this.root.className="tt-table-ui",this.root.style.display="none",this.cellOutline=document.createElement("div"),this.cellOutline.className="tt-table-active-cell-outline",this.cellOutline.style.display="none",this.root.appendChild(this.cellOutline),this.scheduleLayout=()=>{this.layoutRaf==null&&(this.layoutRaf=window.requestAnimationFrame(()=>{this.layoutRaf=null,!this.destroyed&&this.update(this.view)}))},this.scheduleResizeLoop=()=>{this.resizeRaf==null&&(this.resizeRaf=window.requestAnimationFrame(()=>{this.resizeRaf=null,!this.destroyed&&xr&&this.update(this.view)}))},this.onWrapperScroll=()=>this.scheduleLayout(),this.onWindowResize=()=>this.scheduleLayout();try{window.addEventListener("resize",this.onWindowResize,{passive:!0})}catch{}this.rowHandles=[],this.colHandles=[],this.dragState=null,this.suppressClickUntil=0,this.colDropIndicator=document.createElement("div"),this.colDropIndicator.className="tt-table-drop-indicator tt-table-drop-indicator-col",this.colDropIndicator.style.display="none",this.root.appendChild(this.colDropIndicator),this.rowDropIndicator=document.createElement("div"),this.rowDropIndicator.className="tt-table-drop-indicator tt-table-drop-indicator-row",this.rowDropIndicator.style.display="none",this.root.appendChild(this.rowDropIndicator),this.cellHandle=document.createElement("button"),this.cellHandle.type="button",this.cellHandle.className="tt-table-handle tt-table-cell-handle",this.cellHandle.setAttribute("aria-label","Cell actions"),this.cellHandle.addEventListener("click",E=>{E.preventDefault(),E.stopPropagation();let T=this.cellHandle.getBoundingClientRect();this.openCellMenu(T)}),this.root.appendChild(this.cellHandle)}hideDropIndicators(){try{this.colDropIndicator&&(this.colDropIndicator.style.display="none")}catch{}try{this.rowDropIndicator&&(this.rowDropIndicator.style.display="none")}catch{}}cancelDrag(){let B=this.dragState;if(B){this.dragState=null,this.hideDropIndicators();try{window.removeEventListener("pointermove",B.onMove),window.removeEventListener("pointerup",B.onUp),window.removeEventListener("pointercancel",B.onUp)}catch{}try{document.body.classList.remove("tt-table-dragging")}catch{}}}destroy(){this.destroyed=!0,this.cancelDrag();try{this.cellOutline.style.display="none"}catch{}this.menu.closeAll();try{this.layoutRaf!=null&&window.cancelAnimationFrame(this.layoutRaf)}catch{}this.layoutRaf=null;try{this.resizeRaf!=null&&window.cancelAnimationFrame(this.resizeRaf)}catch{}this.resizeRaf=null;try{window.removeEventListener("resize",this.onWindowResize)}catch{}try{this.wrapper?.removeEventListener?.("scroll",this.onWrapperScroll)}catch{}try{this.resizeObserver?.disconnect?.()}catch{}this.resizeObserver=null,this.observedTable=null;try{this.root.remove()}catch{}this.wrapper=null,this.table=null}ensureAttached(B){if(B&&this.wrapper!==B){try{this.wrapper?.removeEventListener?.("scroll",this.onWrapperScroll)}catch{}try{this.root.remove()}catch{}this.wrapper=B;try{this.wrapper.addEventListener("scroll",this.onWrapperScroll,{passive:!0})}catch{}this.wrapper.appendChild(this.root)}}buildRowHandles(B){for(;this.rowHandles.length>B;){let E=this.rowHandles.pop();try{E?.remove?.()}catch{}}for(;this.rowHandles.length<B;){let E=document.createElement("button");E.type="button",E.className="tt-table-handle tt-table-row-handle",E.setAttribute("aria-label","Row actions"),E.dataset.idx=String(this.rowHandles.length),E.addEventListener("pointerdown",T=>this.onHandlePointerDown(T,E,"row")),E.addEventListener("click",T=>{if(Date.now()<this.suppressClickUntil){T.preventDefault(),T.stopPropagation();return}T.preventDefault(),T.stopPropagation();let I=zt(this.view?.state)?.tablePos,P=E.getBoundingClientRect();y?.chain?.().focus?.().run?.();let $=Number(E.dataset.idx||0);cm(y,$),this.openRowMenu(P,$,I)}),this.rowHandles.push(E),this.root.appendChild(E)}}buildColHandles(B){for(;this.colHandles.length>B;){let E=this.colHandles.pop();try{E?.remove?.()}catch{}}for(;this.colHandles.length<B;){let E=document.createElement("button");E.type="button",E.className="tt-table-handle tt-table-col-handle",E.setAttribute("aria-label","Column actions"),E.dataset.idx=String(this.colHandles.length),E.addEventListener("pointerdown",T=>this.onHandlePointerDown(T,E,"col")),E.addEventListener("click",T=>{if(Date.now()<this.suppressClickUntil){T.preventDefault(),T.stopPropagation();return}T.preventDefault(),T.stopPropagation();let I=zt(this.view?.state)?.tablePos,P=E.getBoundingClientRect();y?.chain?.().focus?.().run?.();let $=Number(E.dataset.idx||0);dm(y,$),this.openColumnMenu(P,$,I)}),this.colHandles.push(E),this.root.appendChild(E)}}onHandlePointerDown(B,E,T){try{if(!B||B.button!==0)return;B.preventDefault(),B.stopPropagation(),y?.chain?.().focus?.().run?.();let I=Number(E?.dataset?.idx||0);try{typeof E.setPointerCapture=="function"&&E.setPointerCapture(B.pointerId)}catch{}let P={kind:T,btn:E,pointerId:B.pointerId,fromIndex:I,startX:B.clientX,startY:B.clientY,moved:!1};this.dragState=P;let $=z=>this.onHandlePointerMove(z),V=z=>this.onHandlePointerUp(z);P.onMove=$,P.onUp=V,window.addEventListener("pointermove",$,{passive:!1}),window.addEventListener("pointerup",V,{passive:!1}),window.addEventListener("pointercancel",V,{passive:!1})}catch{}}onHandlePointerMove(B){let E=this.dragState;if(!E||!B||B.pointerId!==E.pointerId)return;try{B.preventDefault()}catch{}let T=B.clientX-E.startX,I=B.clientY-E.startY;if(!E.moved&&Math.hypot(T,I)>=4){E.moved=!0;try{document.body.classList.add("tt-table-dragging")}catch{}}if(E.moved){let P=this.getDropIndexFromPointer(E.kind,B.clientX,B.clientY);E.dropIndex=P,P==null?this.hideDropIndicators():this.updateDropIndicator(E.kind,P,B.clientX,B.clientY)}}getDropIndexFromPointer(B,E,T){try{let I=this.table;if(!I)return null;let P=Array.from(I.querySelectorAll("tbody tr"));if(!P.length)return null;if(B==="col"){let V=Array.from(P[0].children||[]).filter(q=>q&&q.nodeType===1);if(!V.length)return null;let z=V.map(q=>{let Z=q.getBoundingClientRect();return Z.left+Z.width/2});if(!z.length)return null;if(E<z[0])return 0;for(let q=0;q<z.length-1;q+=1)if(E>=z[q]&&E<z[q+1])return q+1;return z.length-1}let $=P.map(V=>{let z=V.children&&V.children[0];if(!z)return null;let q=z.getBoundingClientRect();return q.top+q.height/2}).filter(V=>typeof V=="number");if(!$.length)return null;if(T<$[0])return 0;for(let V=0;V<$.length-1;V+=1)if(T>=$[V]&&T<$[V+1])return V+1;return $.length-1}catch{return null}}updateDropIndicator(B,E,T,I){try{let P=this.table,$=this.wrapper;if(!P||!$)return;let V=$.getBoundingClientRect(),z=P.getBoundingClientRect(),q=z.top-V.top,Z=z.left-V.left,se=z.width,xe=z.height,me=Array.from(P.querySelectorAll("tbody tr"));if(!me.length)return;if(B==="col"){let Ue=Array.from(me[0].children||[]).filter(Q=>Q&&Q.nodeType===1);if(!Ue.length)return;let nt=Math.max(0,Math.min(Ue.length-1,Number(E))),ut=Ue[nt].getBoundingClientRect(),yt=Ue[Ue.length-1].getBoundingClientRect(),Ht=yt.left+yt.width/2,R=nt===Ue.length-1&&T>Ht?yt.right-V.left:ut.left-V.left;this.colDropIndicator.style.display="",this.rowDropIndicator.style.display="none",this.colDropIndicator.style.left=`${Math.round(R)}px`,this.colDropIndicator.style.top=`${Math.round(q)}px`,this.colDropIndicator.style.height=`${Math.max(0,Math.round(xe))}px`;return}let Ae=Math.max(0,Math.min(me.length-1,Number(E))),Te=me[Ae]?.children?.[0];if(!Te)return;let _e=Te.getBoundingClientRect(),Se=(me[me.length-1]?.children?.[0]||null)?.getBoundingClientRect?.()||null,Fe=Se?Se.top+Se.height/2:null,je=Ae===me.length-1&&Se&&typeof Fe=="number"&&I>Fe?Se.bottom-V.top:_e.top-V.top;this.rowDropIndicator.style.display="",this.colDropIndicator.style.display="none",this.rowDropIndicator.style.left=`${Math.round(Z)}px`,this.rowDropIndicator.style.top=`${Math.round(je)}px`,this.rowDropIndicator.style.width=`${Math.max(0,Math.round(se))}px`}catch{}}onHandlePointerUp(B){let E=this.dragState;if(!E||!B||B.pointerId!==E.pointerId)return;try{B.preventDefault(),B.stopPropagation()}catch{}this.dragState=null;try{window.removeEventListener("pointermove",E.onMove),window.removeEventListener("pointerup",E.onUp),window.removeEventListener("pointercancel",E.onUp)}catch{}try{document.body.classList.remove("tt-table-dragging")}catch{}if(this.hideDropIndicators(),!E.moved)return;this.suppressClickUntil=Date.now()+250;let T=E.dropIndex??this.getDropIndexFromPointer(E.kind,B.clientX,B.clientY);if(T!=null){try{y?.chain?.().focus?.().run?.()}catch{}E.kind==="col"?Ud(y,E.fromIndex,T):qd(y,E.fromIndex,T),this.scheduleLayout()}}isEnabled(){try{return!!(Ee?.getState?.(this.view.state)||null)?.editingSectionId&&!u.isPublicView}catch{return!1}}update(B){if(this.view=B,!xr&&this.resizeRaf!=null){try{window.cancelAnimationFrame(this.resizeRaf)}catch{}this.resizeRaf=null}if(!this.isEnabled()){this.root.style.display="none",this.menu.closeAll();try{this.cellOutline.style.display="none"}catch{}return}let E=zt(B.state),T=am(B),I=T?.closest?.("table")||on(B),P=I?.closest?.(".tableWrapper")||null;if(!E||!I||!P||!T){this.root.style.display="none",this.menu.isOpen()||this.menu.closeAll();try{this.cellOutline.style.display="none"}catch{}return}this.ensureAttached(P),this.table=I;try{typeof ResizeObserver=="function"&&(this.resizeObserver||(this.resizeObserver=new ResizeObserver(()=>this.scheduleLayout())),this.observedTable!==I&&(this.resizeObserver.disconnect(),this.resizeObserver.observe(I),this.observedTable=I))}catch{}this.root.style.display="";let $=Array.from(I.querySelectorAll("tbody tr")),V=Number(E.map?.height||$.length||0),z=Number(E.map?.width||0);this.buildRowHandles(Math.max(0,V)),this.buildColHandles(Math.max(0,z));let q=P.getBoundingClientRect(),Z=I.getBoundingClientRect(),se=Z.top-q.top,xe=Z.left-q.left,me=14,Ae=4,Te=me/2,_e=Math.max(0,Math.min(Math.max(0,V-1),Number(E.rowIndex||0))),Pe=Math.max(0,Math.min(Math.max(0,z-1),Number(E.colIndex||0))),Se=Math.max(Te,se-(me/2+Ae)),Fe=Math.max(Te,xe-(me/2+Ae)),je=T.getBoundingClientRect(),Ue=je.left-q.left+je.width/2,nt=je.top-q.top+je.height/2,ut=je.left-q.left,yt=je.top-q.top,Ht="cell";try{let R=B.state.selection,Q=R?.$anchorCell?.pos,W=R?.$headCell?.pos;if(typeof Q=="number"&&typeof W=="number"&&Q!==W){let J=Q-(E.tablePos+1),re=W-(E.tablePos+1),ae=E.map?.rectBetween?.(J,re)||null;if(ae){let ee=Number(ae.right)-Number(ae.left),fe=Number(ae.bottom)-Number(ae.top);ee===1&&fe>1?Ht="col":fe===1&&ee>1?Ht="row":Ht="range"}else Ht="range"}}catch{Ht="cell"}try{Ht==="cell"?(this.cellOutline.style.display="",this.cellOutline.style.left=`${Math.round(ut)}px`,this.cellOutline.style.top=`${Math.round(yt)}px`,this.cellOutline.style.width=`${Math.max(0,Math.round(je.width))}px`,this.cellOutline.style.height=`${Math.max(0,Math.round(je.height))}px`):this.cellOutline.style.display="none"}catch{try{this.cellOutline.style.display="none"}catch{}}for(let R=0;R<this.colHandles.length;R+=1){let Q=this.colHandles[R];if(Q){if(Q.dataset.idx=String(R),R!==Pe){Q.style.display="none";continue}Q.style.display="",Q.style.width=`${Math.max(18,Math.round(je.width))}px`,Q.style.height=`${me}px`,Q.style.left=`${Math.round(Ue)}px`,Q.style.top=`${Math.round(Se)}px`}}for(let R=0;R<this.rowHandles.length;R+=1){let Q=this.rowHandles[R];if(Q){if(Q.dataset.idx=String(R),R!==_e){Q.style.display="none";continue}Q.style.display="",Q.style.width=`${me}px`,Q.style.height=`${Math.max(18,Math.round(je.height))}px`,Q.style.left=`${Math.round(Fe)}px`,Q.style.top=`${Math.round(nt)}px`}}try{if(Ht!=="cell")this.cellHandle.style.display="none";else{let R=je.right-q.left;this.cellHandle.style.display="",this.cellHandle.style.left=`${Math.round(R)}px`,this.cellHandle.style.top=`${Math.round(nt)}px`}}catch{this.cellHandle.style.display="none"}xr&&this.scheduleResizeLoop()}openCellMenu(B){let E=()=>{try{y?.chain?.().focus?.().run?.()}catch{}},T=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>g.map(I=>({label:I.label,swatch:!0,swatchValue:I.value,onClick:()=>{E(),y.commands.setNodeTextColor(I.value)}}))},{label:"Background color",submenu:()=>v.map(I=>({label:I.label,swatch:!0,swatchValue:I.value,onClick:()=>{E(),y.commands.setNodeBackground(I.value)}}))}]},{label:"Alignment",submenu:()=>[...k.map(I=>({label:I.label,onClick:()=>{E(),y.commands.setNodeTextAlign(I.value)}})),{type:"separator"},...N.map(I=>({label:I.label,onClick:()=>{E(),y.commands.setNodeVAlign(I.value)}}))]},{type:"separator"},{label:"Clear contents",onClick:()=>{E(),y.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:B,items:T,level:0})}openRowMenu(B,E,T){let I=()=>{try{y?.chain?.().focus?.().run?.()}catch{}Number.isFinite(Number(T))&&lm(y,T,E)},P=(q,Z)=>{try{y?.chain?.().focus?.().run?.()}catch{}return y.commands.command(({state:se,dispatch:xe})=>{let me=Number.isFinite(Number(T))?Number(T):zt(se)?.tablePos,Ae=Number.isFinite(Number(E))?Number(E):zt(se)?.rowIndex;return!Number.isFinite(Number(me))||!Number.isFinite(Number(Ae))?!1:fm({pmState:se,dispatch:xe},{tablePos:me,rowIndex:Ae,attr:q,value:Z})})},$=q=>()=>(I(),q?.()),V=q=>{try{return typeof q!="function"?!1:(I(),y.commands.command(({state:Z,dispatch:se})=>q(Z,typeof se=="function"?me=>{try{me=me.setMeta(ue,!0)}catch{}se(me)}:void 0)))}catch{return!1}},z=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>g.map(q=>({label:q.label,swatch:!0,swatchValue:q.value,onClick:()=>P("nodeTextColor",q.value)}))},{label:"Background color",submenu:()=>v.map(q=>({label:q.label,swatch:!0,swatchValue:q.value,onClick:()=>P("nodeBackground",q.value)}))}]},{label:"Alignment",submenu:()=>[...k.map(q=>({label:q.label,onClick:()=>P("nodeTextAlign",q.value)})),{type:"separator"},...N.map(q=>({label:q.label,onClick:()=>P("nodeVerticalAlign",q.value)}))]},{type:"separator"},{label:"Insert row above",onClick:()=>V(At?.addRowBefore)},{label:"Insert row below",onClick:()=>V(At?.addRowAfter)},{label:"Sort ",submenu:()=>[{label:"Sort column A-Z",onClick:$(()=>yd(y,{direction:"asc"}))},{label:"Sort column Z-A",onClick:$(()=>yd(y,{direction:"desc"}))}]},{label:"Header row",onClick:()=>V(At?.toggleHeaderRow)},{label:"Move ",submenu:()=>[{label:"Move row up",onClick:$(()=>hd(y,-1))},{label:"Move row down",onClick:$(()=>hd(y,1))},{label:"Move row left",disabled:!0,onClick:()=>{}},{label:"Move row right",disabled:!0,onClick:()=>{}}]},{label:"Duplicate row",onClick:$(()=>hm(y))},{label:"Delete row",onClick:()=>V(At?.deleteRow)},{type:"separator"},{label:"Clear row contents",onClick:()=>{I(),y.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:B,items:z,level:0})}openColumnMenu(B,E,T){let I=()=>{try{y?.chain?.().focus?.().run?.()}catch{}Number.isFinite(Number(T))&&um(y,T,E)},P=(q,Z)=>{try{y?.chain?.().focus?.().run?.()}catch{}return y.commands.command(({state:se,dispatch:xe})=>{let me=Number.isFinite(Number(T))?Number(T):zt(se)?.tablePos,Ae=Number.isFinite(Number(E))?Number(E):zt(se)?.colIndex;return!Number.isFinite(Number(me))||!Number.isFinite(Number(Ae))?!1:pm({pmState:se,dispatch:xe},{tablePos:me,colIndex:Ae,attr:q,value:Z})})},$=q=>()=>(I(),q?.()),V=q=>{try{return typeof q!="function"?!1:(I(),y.commands.command(({state:Z,dispatch:se})=>q(Z,typeof se=="function"?me=>{try{me=me.setMeta(ue,!0)}catch{}se(me)}:void 0)))}catch{return!1}},z=[{label:"Color",submenu:()=>[{label:"text",submenu:()=>g.map(q=>({label:q.label,swatch:!0,swatchValue:q.value,onClick:()=>P("nodeTextColor",q.value)}))},{label:"Background color",submenu:()=>v.map(q=>({label:q.label,swatch:!0,swatchValue:q.value,onClick:()=>P("nodeBackground",q.value)}))}]},{label:"Alignment",submenu:()=>[...k.map(q=>({label:q.label,onClick:()=>P("nodeTextAlign",q.value)})),{type:"separator"},...N.map(q=>({label:q.label,onClick:()=>P("nodeVerticalAlign",q.value)}))]},{type:"separator"},{label:"Insert column left",onClick:()=>{I();let q=Math.max(0,Number(E||0));V(At?.addColumnBefore)&&window.requestAnimationFrame(()=>{try{Oi(y,{insertIndex:q,newColPct:10})}catch{let se=on(y.view);Pi(se)}})}},{label:"Insert column right",onClick:()=>{I();let q=Math.max(0,Number(E||0)+1);V(At?.addColumnAfter)&&window.requestAnimationFrame(()=>{try{Oi(y,{insertIndex:q,newColPct:10})}catch{let se=on(y.view);Pi(se)}})}},{label:"Sort ",submenu:()=>[{label:"Sort row A-Z",onClick:$(()=>gd(y,{direction:"asc"}))},{label:"Sort row Z-A",onClick:$(()=>gd(y,{direction:"desc"}))}]},{label:"Header column",onClick:()=>V(At?.toggleHeaderColumn)},{label:"Move ",submenu:()=>[{label:"Move column up",disabled:!0,onClick:()=>{}},{label:"Move column down",disabled:!0,onClick:()=>{}},{label:"Move column left",onClick:$(()=>md(y,-1))},{label:"Move column right",onClick:$(()=>md(y,1))}]},{label:"Duplicate column",onClick:$(()=>gm(y))},{label:"Delete column",onClick:()=>{I();let q=on(y.view),Z=to(q),se=Number.isFinite(Number(E))?Number(E):null,xe=Z&&se!=null?Fd(Z,se):null;V(At?.deleteColumn)&&Array.isArray(xe)&&window.requestAnimationFrame(()=>{let Ae=on(y.view);no(Ae,xe)})}},{type:"separator"},{label:"Clear column contents",onClick:()=>{I(),y.commands.clearNodeContents()}}];this.menu.openPanel({anchorRect:B,items:z,level:0})}}return[new w({view(M){let B=new D(M);return B.update(M),{update(E){B.update(E)},destroy(){B.destroy()}}}})]}}),ce=Ar()?performance.now():0;le=new c({element:e,extensions:[Mn,gt,It,Kt,Ln,ye,Ye,ne,ge,Be,Pt,Fn,sn,mn,Nn,An,Ne,X.configure({types:["outlineSection"],attributeName:"id",generateID:()=>Wt()}),b.configure({document:!1,heading:!1,link:!1}),L.configure({openOnClick:!1,protocols:Ai}),ot,wt,he,Je,F.configure({table:{resizable:!0}}),te,ct,it,at,de].filter(Boolean),content:Ve,editorProps:{attributes:{class:"outline-prosemirror"},handleKeyDown(y,g){try{if(Ce?.isOpen?.()&&Ce.isOpen()&&!!Ce.handleKeyDown?.(g))return!0}catch{}try{if((g?.ctrlKey||g?.metaKey)&&!g?.shiftKey&&!g?.altKey&&(String(g?.key||"").toLowerCase()==="v"||String(g?.code||"")==="KeyV")&&!u.isPublicView&&!((Ee?.getState?.(y.state)||null)?.editingSectionId||null)){let P=Sa();if(P&&Array.isArray(P.sections)&&P.sections.length){g.preventDefault(),g.stopPropagation();let $=y.state,z=$.selection?.$from||null,q=z?Ct($.doc,z):null,Z=typeof q=="number"?$.doc.nodeAt(q):null,se=$.doc.content.size;typeof q=="number"&&Z&&(se=q+Z.nodeSize);let xe=new Set;try{$.doc.descendants(Se=>{if(Se?.type?.name!=="outlineSection")return;let Fe=String(Se.attrs?.id||"").trim();Fe&&xe.add(Fe)})}catch{}let me=[];if(P.mode==="copy")for(let Se of P.sections)me.push(Md(Se,()=>Wt()));else for(let Se of P.sections){let Fe=String(Se?.attrs?.id||"").trim();if(Fe&&xe.has(Fe))return Ie("\u041D\u0435\u043B\u044C\u0437\u044F \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C: \u0431\u043B\u043E\u043A \u0441 \u0442\u0430\u043A\u0438\u043C id \u0443\u0436\u0435 \u0435\u0441\u0442\u044C"),!0;me.push(Ea(Se))}let Ae=$.doc.type.schema,Te=[];for(let Se of me)try{let Fe=Ae.nodeFromJSON(Se);Fe?.type?.name==="outlineSection"&&Te.push(Fe)}catch{}if(!Te.length)return Ie("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u0441\u0442\u0430\u0432\u0438\u0442\u044C \u0431\u043B\u043E\u043A\u0438"),!0;let _e=$.tr,Pe=se;for(let Se of Te)_e=_e.insert(Pe,Se),Pe+=Se.nodeSize;return _e=_e.setMeta(ue,!0),y.dispatch(_e.scrollIntoView()),Qt=!0,Xt({delayMs:200}),P.mode==="cut"&&Ni(null),Zr(!1),Ie(`\u0412\u0441\u0442\u0430\u0432\u043B\u0435\u043D\u043E \u0431\u043B\u043E\u043A\u043E\u0432: ${Te.length}`),!0}}}catch{}try{let E=g&&!g.defaultPrevented&&!g.isComposing&&!g.metaKey&&!g.ctrlKey&&!g.altKey,T=E&&String(g?.key||"")==="\\",I=E&&(String(g?.code||"")==="Backslash"||String(g?.code||"")==="IntlBackslash");if(T){g.preventDefault();let{from:P,to:$}=y.state.selection,V=y.state.tr.insertText("\\",P,$).setMeta(ue,!0);return y.dispatch(V),!0}if(I)try{window?.localStorage?.getItem?.("ttree_outline_debug_tag_v1")==="1"&&console.log("[outline][tag-debug] backslash-code",{key:String(g?.key||""),code:String(g?.code||""),shiftKey:!!g?.shiftKey,altKey:!!g?.altKey,ctrlKey:!!g?.ctrlKey,metaKey:!!g?.metaKey})}catch{}}catch{}if(g&&g.__memusSyntheticAltProxy)return!1;let v="ttree_outline_debug_alt_v1",k=()=>{try{return window?.localStorage?.getItem?.(v)==="1"}catch{return!1}},N=E=>{try{return!!E?.getModifierState?.("AltGraph")}catch{return!1}};((E,T)=>{try{if(!k())return;let I=String(E?.key||""),P=String(E?.code||"");if(!I.startsWith("Arrow")&&P!=="Enter"&&P!=="NumpadEnter")return;let $={altKey:!!E?.altKey,ctrlKey:!!E?.ctrlKey,metaKey:!!E?.metaKey,shiftKey:!!E?.shiftKey,altGraph:N(E),repeat:!!E?.repeat,location:E?.location??null},V=[];$.metaKey&&V.push("Meta"),$.ctrlKey&&V.push("Ctrl"),$.altKey&&V.push($.altGraph?"AltGraph":"Alt"),$.shiftKey&&V.push("Shift"),V.push(P||I||"?"),console.log("[outline][alt-debug]",T,{key:I,code:P,name:V.join("-"),...$})}catch{}})(g,"keydown");let O=E=>{try{return!!E?.getModifierState?.("AltGraph")}catch{return!1}},K=E=>{try{return(!!E?.altKey||O(E))&&!E?.metaKey&&(!E?.ctrlKey||O(E))}catch{return!1}},D="ttree_outline_debug_nav_v1",M=()=>{try{return window?.localStorage?.getItem?.(D)==="1"}catch{return!1}},B=(E,T)=>{if(M())try{console.log("[outline][nav-debug]",E,T)}catch{}};try{let T=(Ee?.getState?.(y.state)||null)?.editingSectionId||null;B("keydown",{key:String(g?.key||""),code:String(g?.code||""),altKey:!!g?.altKey,altGraph:!!N(g),ctrlKey:!!g?.ctrlKey,metaKey:!!g?.metaKey,shiftKey:!!g?.shiftKey,repeat:!!g?.repeat,editingSectionId:T?String(T):null,selection:{empty:!!y.state?.selection?.empty,parent:y.state?.selection?.$from?.parent?.type?.name||null,parentOffset:y.state?.selection?.$from?.parentOffset??null,pos:y.state?.selection?.$from?.pos??null}});try{let z=(se,xe,me)=>{try{let Ae=qe?.pmStateMod?.TextSelection;if(!Ae)return!1;let Te=se.doc.nodeAt(me);if(!Te||Te.type?.name!=="outlineSection")return!1;let _e=Te.child(0),Se=me+1+1,Fe=se.tr;return Fe=Fe.setSelection(Ae.near(Fe.doc.resolve(Se),1)),xe(Fe.scrollIntoView()),!0}catch{return!1}},q=String(g?.key||""),Z=!g?.shiftKey&&!g?.metaKey&&!g?.ctrlKey&&!g?.altKey&&!N(g);if(!T&&Z&&(q==="ArrowUp"||q==="ArrowDown")){let se=y.state,xe=Ct(se.doc,se.selection.$from);if(B("nav.check",{key:q,sectionPos:xe}),typeof xe=="number"){let me=(Pe,Se)=>{try{let Fe=Pe.resolve(Math.min(Pe.content.size,Math.max(0,Se+1)));for(let je=Fe.depth;je>0;je-=1){let Ue=Fe.node(je);if(!(Ue?.type?.name!=="outlineSection"||Fe.before(je)===Se)&&Ue.attrs?.collapsed)return!1}return!0}catch{return!0}},_e=q==="ArrowUp"?((Pe,Se)=>{let Fe=null;return Pe.nodesBetween(0,Se,(je,Ue)=>{if(Ue>=Se)return!1;je?.type?.name==="outlineSection"&&me(Pe,Ue)&&(Fe=Ue)}),Fe})(se.doc,xe):((Pe,Se)=>{let Fe=null;return Pe.nodesBetween(Se+1,Pe.content.size,(je,Ue)=>{if(Fe!==null)return!1;Ue<=Se||je?.type?.name==="outlineSection"&&me(Pe,Ue)&&(Fe=Ue)}),Fe})(se.doc,xe);if(B("nav.target",{key:q,sectionPos:xe,target:_e}),typeof _e=="number"){let Pe=z(se,y.dispatch,_e);if(B("nav.apply",{ok:Pe}),Pe)return g.preventDefault(),g.stopPropagation(),!0}}}}catch{}let I=!!N(g)&&!g?.altKey&&!g?.ctrlKey&&!g?.metaKey&&!g?.shiftKey,P=String(g?.key||""),$=String(g?.code||"");if(!T&&I&&(P==="ArrowUp"||P==="ArrowDown"||P==="ArrowLeft"||P==="ArrowRight")){let z=null;try{z=new KeyboardEvent("keydown",{key:P,code:$||P,altKey:!0,ctrlKey:!1,metaKey:!1,shiftKey:!1,bubbles:!0,cancelable:!0});try{Object.defineProperty(z,"__memusSyntheticAltProxy",{value:!0})}catch{}}catch{z=null}if(z||(z={key:P,code:$||P,altKey:!0,ctrlKey:!1,metaKey:!1,shiftKey:!1,bubbles:!0,cancelable:!0,__memusSyntheticAltProxy:!0,preventDefault(){},stopPropagation(){},getModifierState(Z){return!1}}),!!y?.someProp?.("handleKeyDown",Z=>Z(y,z)))return g.preventDefault(),g.stopPropagation(),!0}}catch{}try{if(K(g)){let E=String(g.key||"");if((E==="ArrowUp"||E==="ArrowDown")&&g.repeat){let T=y?.state?.selection?.$from}}}catch{}tt("editorProps.keydown",{key:g?.key||null,repeat:!!g?.repeat,selection:{empty:!!y.state?.selection?.empty,parent:y.state?.selection?.$from?.parent?.type?.name||null,parentOffset:y.state?.selection?.$from?.parentOffset??null,pos:y.state?.selection?.$from?.pos??null}});try{let E=qe?.pmStateMod?.TextSelection;if(E){let I=(Ee?.getState?.(y.state)||null)?.editingSectionId||null,P=(g.key==="Enter"||g.code==="Enter"||g.code==="NumpadEnter")&&(g.ctrlKey||g.metaKey)&&!g.shiftKey&&!g.altKey;if(!u.isPublicView&&!I&&P){let $=y.state.selection,V=$?.$from||null;if(V){let z=Ct(y.state.doc,V),q=typeof z=="number"?y.state.doc.nodeAt(z):null;if(typeof z=="number"&&q?.type?.name==="outlineSection"){let Z=!!($&&$.empty),se=V.parent?.type?.name==="outlineHeading",me=Z&&se&&V.parentOffset===0?z:z+q.nodeSize,Ae=y.state.schema,Te=Wt(),_e=Ae.nodes.outlineSection.create({id:Te,collapsed:!1},[Ae.nodes.outlineHeading.create({},[]),Ae.nodes.outlineBody.create({},[Ae.nodes.paragraph.create({},[])]),Ae.nodes.outlineChildren.create({},[])]),Pe=y.state.tr.insert(me,_e);try{let Fe=Pe.doc.nodeAt(me)?.child?.(0)||_e.child(0),je=me+1+Fe.nodeSize;Pe=Pe.setSelection(E.near(Pe.doc.resolve(je+2),1))}catch{Pe=Pe.setSelection(E.create(Pe.doc,me+2))}Pe=Pe.setMeta(ue,!0),Ee&&(Pe=Pe.setMeta(Ee,{type:"enter",sectionId:Te})),y.dispatch(Pe.scrollIntoView());try{y.focus()}catch{}return g.preventDefault(),g.stopPropagation(),!0}}}}}catch{}try{let E=K(g)&&!g.shiftKey,T=String(g.key||"");if(E&&(T==="ArrowLeft"||T==="ArrowRight"||T==="ArrowUp"||T==="ArrowDown")&&(Ee?.getState?.(y.state)||null)?.editingSectionId&&le){let P=()=>{try{let $=y?.state?.selection?.$from||null;if(!$)return!1;for(let V=$.depth;V>0;V-=1){let z=$.node(V)?.type?.name;if(z==="table"||z==="tableRow"||z==="tableCell"||z==="tableHeader")return!0}return!1}catch{return!1}};if(T==="ArrowLeft"||T==="ArrowRight"){let $=le.chain().focus();$.command(({tr:z})=>(z.setMeta(ue,!0),!0));let V=!1;if(le.isActive("bulletList")||le.isActive("orderedList")?T==="ArrowRight"?V=$.sinkListItem("listItem").run():(V=$.liftListItem("listItem").run(),!V&&le.isActive("bulletList")&&(V=$.toggleBulletList().run()),!V&&le.isActive("orderedList")&&(V=$.toggleOrderedList().run())):T==="ArrowRight"&&(V=$.toggleBulletList().run()),V)return g.preventDefault(),g.stopPropagation(),!0}else if((T==="ArrowUp"||T==="ArrowDown")&&(T==="ArrowUp"?Sd(le,-1)||bd(le,-1):Sd(le,1)||bd(le,1)))return g.preventDefault(),g.stopPropagation(),!0}}catch{}try{if((g.ctrlKey||g.metaKey)&&!g.altKey&&!g.shiftKey&&(g.code==="KeyA"||String(g.key||"").toLowerCase()==="a")){let T=qe?.pmStateMod?.TextSelection;if(!T)return tt("editorProps.modA",{handled:!1,reason:"no-TextSelection"}),!1;let I=y.state,P=I.selection,$=P?.$from||null;if(!$)return tt("editorProps.modA",{handled:!1,reason:"no-$from"}),!1;let V=Ct(I.doc,$);if(typeof V!="number")return tt("editorProps.modA",{handled:!1,reason:"no-sectionPos"}),!1;let z=I.doc.nodeAt(V);if(!z||z.type?.name!=="outlineSection")return tt("editorProps.modA",{handled:!1,reason:"not-outlineSection"}),!1;let q=z.child(0),Z=z.child(1);if(!q||!Z)return tt("editorProps.modA",{handled:!1,reason:"missing-heading/body"}),!1;let se=V+1,xe=se+1,me=se+q.nodeSize-1,Ae=V+1+q.nodeSize,Te=Ae+1,_e=Ae+Z.nodeSize-1,Pe=_e;try{let nt=null;I.doc.nodesBetween(Te,Math.min(I.doc.content.size,_e),(ut,yt)=>{ut?.isTextblock&&(nt=yt+ut.nodeSize-1)}),typeof nt=="number"&&(Pe=nt)}catch{}Pe<Te&&(Pe=me);let Se=xe,Fe=(()=>{try{for(let nt=$.depth;nt>0;nt-=1)if($.node(nt)?.type?.name==="outlineHeading")return!0}catch{}return!1})(),je=!!P&&typeof P.from=="number"&&typeof P.to=="number"&&Math.min(P.from,P.to)===Se&&Math.max(P.from,P.to)===Pe;if(Fe&&je)return tt("editorProps.modA",{handled:!1,reason:"pass-through-doc-select"}),!1;g.preventDefault(),g.stopPropagation();let Ue=T.create(I.doc,Se,Pe);return y.dispatch(I.tr.setSelection(Ue)),tt("editorProps.modA",{handled:!0,blockFrom:Se,blockTo:Pe,isInHeading:Fe,alreadySelectedBlock:je}),!0}}catch{}try{if(!Ee)return!1;let T=(Ee.getState(y.state)||{}).editingSectionId||null;if(!T){let I=(g.ctrlKey||g.metaKey)&&!g.altKey&&!g.shiftKey&&(g.key==="Delete"||g.key==="Del"||g.key==="Backspace"),P=g.key==="Backspace"||g.key==="Delete",$=g.key&&g.key.length===1&&!g.metaKey&&!g.ctrlKey&&!g.altKey,V=!g.metaKey&&!g.ctrlKey&&!g.altKey&&!g.shiftKey&&(g.key===" "||g.key==="Spacebar");if(I){let z=Ct(y.state.doc,y.state.selection.$from),q=!1;try{typeof z=="number"&&(q=Y(y.state,y.dispatch,z))}catch{q=!1}return tt("editorProps.modDelete",{ok:q,sectionPos:z}),g.preventDefault(),g.stopPropagation(),!0}if(V){let z=document.activeElement;if(!(!!(z&&z.closest&&z.closest(".outline-editor"))||!!(g?.target&&g.target.closest&&g.target.closest(".outline-editor"))))return!1;if(g.repeat)return g.preventDefault(),g.stopPropagation(),!0;let Z=g?.target||null,se=String(Z?.tagName||"").toLowerCase();if(se==="button"||se==="input"||se==="textarea"||se==="select"||Z?.closest?.("button, a[href], input, textarea, select")||!!!Z?.closest?.(".outline-prosemirror")&&Z?.closest?.('[contenteditable="true"]'))return!1;let me=Ct(y.state.doc,y.state.selection.$from);if(typeof me!="number")return g.preventDefault(),g.stopPropagation(),!0;let Ae=y.state.doc.nodeAt(me);if(!Ae)return g.preventDefault(),g.stopPropagation(),!0;let Te=!Ae.attrs?.collapsed,_e=y.state.tr.setNodeMarkup(me,void 0,{...Ae.attrs,collapsed:Te});_e=_e.setMeta(ue,!0);try{let Pe=Ae.child(0),Fe=me+1+Pe.nodeSize-1,{TextSelection:je}=qe?.pmStateMod||{};je&&(_e=_e.setSelection(je.near(_e.doc.resolve(Fe),-1)))}catch{}return g.preventDefault(),g.stopPropagation(),y.dispatch(_e.scrollIntoView()),!0}if(P){if(g.key==="Backspace")try{let z=y.state,q=z.selection,Z=q?.$from||null,se=null;try{for(let Ae=Z?.depth||0;Ae>0;Ae-=1)if(Z.node(Ae)?.type?.name==="outlineHeading"){se=Ae;break}}catch{se=null}let xe=se!==null&&Z?Z.start(se):null,me=!!(q&&q.empty)&&!!Z&&se!==null&&typeof xe=="number"&&Z.pos===xe;if(tt("editorProps.backspace.check",{empty:!!q?.empty,headingDepth:se,headingStart:xe,pos:Z?.pos??null,parent:Z?.parent?.type?.name||null,parentOffset:Z?.parentOffset??null,atHeadingStart:me}),me){let Ae=Ct(z.doc,Z),Te=typeof Ae=="number"?z.doc.nodeAt(Ae):null;if(tt("editorProps.backspace.sectionPos",{sectionPos:Ae,hasNode:!!Te}),typeof Ae=="number"&&Te){let _e=String(Te.attrs?.id||""),Pe=null;try{let Fe=z.doc.resolve(Ae),je=Fe.index(),Ue=Fe.parent;if(Ue&&je>0){let nt=Ue.child(je-1),ut=Ae-nt.nodeSize,yt=z.doc.nodeAt(ut);Pe=String(yt?.attrs?.id||"")||null}else for(let nt=Z.depth-1;nt>0;nt-=1){let ut=Z.node(nt);if(ut?.type?.name==="outlineSection"){let yt=String(ut.attrs?.id||"");if(yt&&yt!==_e){Pe=yt;break}}}}catch{Pe=null}tt("editorProps.backspace.mergeCandidate",{sectionPos:Ae,currentSectionId:_e,targetSectionId:Pe});let Se=!1;if(an(Te))Se=Y(z,y.dispatch,Ae);else try{z.doc.resolve(Ae).index()<=0?Se=pe(z,y.dispatch,Ae):Se=ie(z,y.dispatch,Ae)}catch{Se=ie(z,y.dispatch,Ae)}return tt("editorProps.backspace.mergeDone",{ok:Se,targetSectionId:Pe}),Se&&Pe&&Ee&&window.setTimeout(()=>{try{if((Ee.getState(y.state)||{}).editingSectionId)return;let je=mt(y.state.doc,Pe),Ue=typeof je=="number"?y.state.doc.nodeAt(je):null;if(!Ue)return;let nt=y.state.tr;Ue?.attrs?.collapsed&&(nt=nt.setNodeMarkup(je,void 0,{...Ue.attrs,collapsed:!1}),nt=nt.setMeta(ue,!0)),nt=nt.setMeta(Ee,{type:"enter",sectionId:Pe});try{let ut=nt.doc.nodeAt(je);if(ut&&ut.type?.name==="outlineSection"){let yt=ut.child(0),Ht=ut.child(1),Q=je+1+yt.nodeSize+Ht.nodeSize-1;nt=nt.setSelection(f.near(nt.doc.resolve(Q),-1))}}catch{}y.dispatch(nt.scrollIntoView());try{y.focus()}catch{}tt("editorProps.backspace.enterEdit.done",{targetSectionId:Pe})}catch{}},0),g.preventDefault(),g.stopPropagation(),!0}}}catch{}return g.preventDefault(),g.stopPropagation(),!0}if($)return g.preventDefault(),g.stopPropagation(),Qr(),!0}if(u.isPublicView&&!T&&(g.key==="Enter"&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey&&!g.altKey||g.key==="F2"&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey&&!g.altKey))return g.preventDefault(),g.stopPropagation(),!0;if(!T&&(g.key==="Enter"&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey&&!g.altKey||g.key==="F2"&&!g.shiftKey&&!g.ctrlKey&&!g.metaKey&&!g.altKey)){let I=Ct(y.state.doc,y.state.selection.$from);if(typeof I!="number")return!1;let P=y.state.doc.nodeAt(I),$=String(P?.attrs?.id||"");if(!$)return!1;if(g.preventDefault(),g.stopPropagation(),P?.attrs?.collapsed){let V=y.state.tr.setNodeMarkup(I,void 0,{...P.attrs,collapsed:!1});return V.setMeta(ue,!0),y.dispatch(V.scrollIntoView()),!0}return y.dispatch(y.state.tr.setMeta(Ee,{type:"enter",sectionId:$})),!0}if(T&&g.key==="Escape"){g.preventDefault(),g.stopPropagation();let I=T;y.dispatch(y.state.tr.setMeta(Ee,{type:"exit"}));try{let P=le;if(P&&!P.isDestroyed){let $=kr(y.state.doc,I);kd(P,y.state.doc,I),$&&Xt({delayMs:350})}}catch{}return!0}}catch{}return!1},handleDOMEvents:{click(y,g){try{let v=g.target?.closest?.("a[href]");if(!v||!Ee)return!1;let k=String(v.getAttribute("href")||"").trim();if(!k)return!1;if(u.isPublicView){let B=String(v.getAttribute("rel")||"").split(/\s+/).filter(Boolean);if(v.getAttribute("data-unpublished")==="1"||B.includes("unpublished")||k==="#")return alert("\u042D\u0442\u0430 \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0430 \u043F\u043E\u043A\u0430 \u043D\u0435 \u043E\u043F\u0443\u0431\u043B\u0438\u043A\u043E\u0432\u0430\u043D\u0430"),g.preventDefault(),g.stopPropagation(),!0}if(k.startsWith("app:/")||k.startsWith("disk:/")){g.preventDefault(),g.stopPropagation();let M=$n(k);if(M)return window.open(M,"_blank","noopener,noreferrer"),!0}if((Ee.getState(y.state)||{}).editingSectionId||null)return!1;let O=M=>{let B=String(M||"").trim();if(!B||B.startsWith("/")||B.startsWith("#")||/\s/.test(B)||B.includes("://")||/^[a-z][a-z0-9+.-]*:/i.test(B))return!1;let E=B.split(/[/?#]/,1)[0];return!(!E||!E.includes(".")||E.startsWith(".")||E.endsWith(".")||E.includes(".."))},K=M=>{let B=String(M||"").trim();return B&&(B.startsWith("//")?`https:${B}`:O(B)?`https://${B}`:B)};if(g.preventDefault(),g.stopPropagation(),k.startsWith("/"))return u.isPublicView?(window.location.href=k,!0):(bn(k),!0);let D=K(k);return/^https?:\/\//i.test(D)||/^mailto:/i.test(D)||/^tel:/i.test(D),window.open(D,"_blank","noopener,noreferrer"),!0}catch{return!1}},beforeinput(y,g){try{if(!Ee)return!1;let k=(Ee.getState(y.state)||{}).editingSectionId||null;if(k)return!1;let N=String(g?.inputType||"");if(N.startsWith("history"))return!1;if(tt("beforeinput",{inputType:N,key:g?.data??null,editingSectionId:k||null,selection:{empty:!!y.state?.selection?.empty,parent:y.state?.selection?.$from?.parent?.type?.name||null,parentOffset:y.state?.selection?.$from?.parentOffset??null}}),N==="deleteContentBackward"){try{let _=y.state,O=_.selection,K=O?.$from||null,D=null;try{for(let E=K?.depth||0;E>0;E-=1)if(K.node(E)?.type?.name==="outlineHeading"){D=E;break}}catch{D=null}let M=D!==null&&K?K.start(D):null,B=!!(O&&O.empty)&&!!K&&D!==null&&typeof M=="number"&&K.pos===M;if(tt("beforeinput.deleteContentBackward.check",{empty:!!O?.empty,headingDepth:D,headingStart:M,pos:K?.pos??null,parent:K?.parent?.type?.name||null,parentOffset:K?.parentOffset??null,atHeadingStart:B}),B){let E=Ct(_.doc,K),T=typeof E=="number"?_.doc.nodeAt(E):null;if(typeof E=="number"&&T){let I=String(T.attrs?.id||"");tt("beforeinput.deleteContentBackward.candidate",{sectionPos:E,currentSectionId:I});let P=null;try{let V=_.doc.resolve(E),z=V.index(),q=V.parent;if(q&&z>0){let Z=q.child(z-1),se=E-Z.nodeSize,xe=_.doc.nodeAt(se);P=String(xe?.attrs?.id||"")||null}else for(let Z=K.depth-1;Z>0;Z-=1){let se=K.node(Z);if(se?.type?.name==="outlineSection"){let xe=String(se.attrs?.id||"");if(xe&&xe!==I){P=xe;break}}}}catch{P=null}let $=!1;if(an(T))tt("beforeinput.merge",{kind:"deleteEmpty",sectionPos:E}),$=Y(_,y.dispatch,E);else try{_.doc.resolve(E).index()<=0?(tt("beforeinput.merge",{kind:"intoParent",sectionPos:E,targetSectionId:P}),$=pe(_,y.dispatch,E)):(tt("beforeinput.merge",{kind:"intoPrev",sectionPos:E,targetSectionId:P}),$=ie(_,y.dispatch,E))}catch{tt("beforeinput.merge",{kind:"intoPrev.catch",sectionPos:E,targetSectionId:P}),$=ie(_,y.dispatch,E)}return tt("beforeinput.merge.done",{ok:$,targetSectionId:P}),$&&P&&window.setTimeout(()=>{try{if((Ee.getState(y.state)||{}).editingSectionId)return;let z=mt(y.state.doc,P),q=typeof z=="number"?y.state.doc.nodeAt(z):null;if(!q)return;let Z=y.state.tr;q?.attrs?.collapsed&&(Z=Z.setNodeMarkup(z,void 0,{...q.attrs,collapsed:!1}),Z=Z.setMeta(ue,!0)),Z=Z.setMeta(Ee,{type:"enter",sectionId:P});try{let se=y.state.doc.nodeAt(z);if(se&&se.type?.name==="outlineSection"){let xe=se.child(0),me=z+1+xe.nodeSize,Ae=Math.min(Z.doc.content.size,me+2);Z=Z.setSelection(f.create(Z.doc,Ae))}}catch{}y.dispatch(Z.scrollIntoView());try{y.focus()}catch{}tt("beforeinput.enterEdit.done",{targetSectionId:P})}catch{}},0),g.preventDefault(),g.stopPropagation(),!0}}}catch{}return tt("beforeinput.deleteContentBackward.block",{inputType:N}),g.preventDefault(),g.stopPropagation(),!0}return N.startsWith("delete")?(tt("beforeinput.delete.block",{inputType:N}),g.preventDefault(),g.stopPropagation(),!0):(g.preventDefault(),g.stopPropagation(),Qr(),!0)}catch{return!1}},dblclick(y,g){try{if(u.isPublicView||!Ee||(Ee.getState(y.state)||{}).editingSectionId||null)return!1;let N=g?.target&&g.target.closest&&g.target.closest('[data-outline-heading="true"]')||g?.target&&g.target.closest&&g.target.closest(".outline-heading"),_=g?.target&&g.target.closest&&g.target.closest('[data-outline-body="true"]')||g?.target&&g.target.closest&&g.target.closest(".outline-body");if(!N&&!_)return!1;let O={left:g.clientX,top:g.clientY},K=y.posAtCoords(O),D=K&&typeof K.pos=="number"?K.pos:null;if(typeof D!="number")return!1;let M=y.state.doc.resolve(Math.max(0,Math.min(y.state.doc.content.size,D))),B=Ct(y.state.doc,M);if(typeof B!="number")return!1;let E=y.state.doc.nodeAt(B),T=String(E?.attrs?.id||"");if(!T)return!1;window.setTimeout(()=>{try{if((Ee.getState(y.state)||{}).editingSectionId)return;let P=mt(y.state.doc,T),$=typeof P=="number"?y.state.doc.nodeAt(P):null,V=!!$?.attrs?.collapsed,z=y.state.tr;if(V&&typeof P=="number"&&$&&(z=z.setNodeMarkup(P,void 0,{...$.attrs,collapsed:!1}),z=z.setMeta(ue,!0)),V){y.dispatch(z.scrollIntoView());try{y.focus()}catch{}return}z=z.setMeta(Ee,{type:"enter",sectionId:T});try{let{TextSelection:q}=qe?.pmStateMod||{},Z=typeof P=="number"?z.doc.nodeAt(P):null;if(Z&&Z.type?.name==="outlineSection"){let se=Z.child(0),xe=P+1+se.nodeSize,me=Math.min(z.doc.content.size,xe+2);q&&(z=z.setSelection(q.near(z.doc.resolve(me),1)))}}catch{}y.dispatch(z.scrollIntoView());try{y.focus()}catch{}}catch{}},0)}catch{}return!1}}},onCreate:({editor:y})=>{if(Ke&&u.articleId&&u.article&&!u.article.encrypted)try{let g=y.getJSON();u.article.docJson=g,gc(u.articleId,g).catch(()=>{})}catch{}try{Pm(y.state.doc)}catch{}Br.clear();try{eo.clear()}catch{}Qt=!1,Ed=null,pn=null;try{Mi=ud(y.state.doc),Rn=!1;try{En.clear()}catch{En.clear()}Ft&&(clearTimeout(Ft),Ft=null)}catch{}Gn("")},onUpdate:()=>{Qt=!0;try{let y=Ee?.getState?.(le?.state)||null,g=String(y?.editingSectionId||"").trim();if(g){let v=le?.state?.doc||null;v&&kr(v,g)&&Wp(le)}}catch{}try{let y=le?.state?.doc||null;if(y){let g=ud(y);g&&g!==Mi&&(Mi=g,Jp({articleId:Nt||u.articleId,editor:le}))}}catch{}try{wd(le)}catch{}Xt({delayMs:1500})},onSelectionUpdate:({editor:y})=>{let{state:g}=y,{selection:v}=g;if(!v)return;let k=Ct(g.doc,v.$from);if(typeof k!="number")return;let N=g.doc.nodeAt(k),_=String(N?.attrs?.id||"");if(!_)return;try{let D=(Ee?.getState?.(g)||null)?.editingSectionId||null;D&&D!==_&&y.view.dispatch(g.tr.setMeta(Ee,{type:"exit"}))}catch{}if(pn&&pn!==_){let K=kr(g.doc,pn);try{Rt("leave_section",{from:pn,to:_,changed:K})}catch{}try{eo.has(pn)&&kd(y,g.doc,pn)}catch{}K&&Xt({delayMs:350})}let O=pn;pn=_;try{wd(y)}catch{}try{(Ee?.getState?.(g)||null)?.editingSectionId||Tm(y,{lines:5})}catch{}}}),ce&&Xr("new Editor()",{ms:Math.round(performance.now()-ce)});try{(Nt||u.articleId)&&(qp(Nt||u.articleId),navigator.onLine&&Bd(Nt||u.articleId))}catch{}e.focus?.({preventScroll:!0}),Ri=y=>{try{if(!le)return;let g=le.state.tr.setMeta(we,{activeKey:y||null});le.view.dispatch(g)}catch{}};try{Od()}catch{}try{let y=Ar()?performance.now():0;sm(le),y&&Xr("convertMarkdownTablesInOutlineDoc()",{ms:Math.round(performance.now()-y)})}catch{}t&&Xr("mountOutlineEditor() total",{ms:Math.round(performance.now()-t)})})();try{await vo}finally{vo=null}}function Lo(e=""){return String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}async function Om(e={}){if(u.isPublicView||!u.articleId||!u.article||!le)return;let t=Nt||u.articleId;if(!t)return;let n=!!e.silent,r=e&&typeof e.mode=="string"?e.mode:"network",o=Array.from(new Set([...Br||[],pn].filter(Boolean))),i=(s,a)=>{let c=s?String(s):"",l=a?String(a):"";return c?l?c>=l?c:l:c||null:l||null};try{if(n||ji("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u043C outline\u2026"),u.article.encrypted){n||(mr(),Ie("Outline-\u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u0435 docJson \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u043D\u043E \u0434\u043B\u044F \u0437\u0430\u0448\u0438\u0444\u0440\u043E\u0432\u0430\u043D\u043D\u044B\u0445 \u0441\u0442\u0430\u0442\u0435\u0439"));return}let s=le.getJSON(),a=Up(s);if(u.articleId&&t!==u.articleId){await gn(t,a,u.article?.updatedAt||null).catch(()=>{}),n||mr(),Gn("\u041E\u0444\u0444\u043B\u0430\u0439\u043D: \u0447\u0435\u0440\u043D\u043E\u0432\u0438\u043A \u0441\u043E\u0445\u0440\u0430\u043D\u0451\u043D \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E");return}let c=Date.now();await gn(t,a,u.article?.updatedAt||null).catch(()=>{});try{pn&&kr(le.state.doc,pn)}catch{}if(!0){let d=En.size?Array.from(En):[];try{d.length&&(En.clear(),await tn("delete_sections",{articleId:t,payload:{sectionIds:d,clientQueuedAt:c},coalesceKey:`delete:${t}`}))}catch{}n||mr(),u.article&&(u.article.docJson=a),Qt=!1,Ed=new Date,Gn("\u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E");try{Od()}catch{}try{Dm(le,le.state.doc,o)}catch{}return}}catch(s){n?Gn("\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F"):(mr(),Ie(s?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C outline"));try{let a=le.getJSON();a&&typeof a=="object"&&await gn(t,a,u.article?.updatedAt||null).catch(()=>{})}catch{}Xt({delayMs:5e3})}}function Rm(){return pn||null}function Hm(){try{if(!le||le.isDestroyed)return null;let e=le.state,t=Ct(e.doc,e.selection.$from);if(typeof t!="number")return null;let n=e.doc.nodeAt(t);if(!n||n.type?.name!=="outlineSection")return null;let r=String(n.attrs?.id||"").trim();return r?{sectionId:r,collapsed:!!n.attrs?.collapsed}:null}catch{return null}}function $m(e,t){try{let n=String(t||"");if(!e||!n)return null;let r=(i,s,a)=>{if(!i||i.type?.name!=="outlineSection")return null;let c=String(i.attrs?.id||""),l=[...a,s];if(c===n)return l;let d=i.child(0),m=i.child(1),h=i.child(2);if(!h||h.type?.name!=="outlineChildren")return null;let S=s+1+d.nodeSize+m.nodeSize+1;for(let p=0;p<h.childCount;p+=1){let f=h.child(p),w=S;S+=f.nodeSize;let x=r(f,w,l);if(x)return x}return null},o=0;for(let i=0;i<e.childCount;i+=1){let s=e.child(i),a=o;o+=s.nodeSize;let c=r(s,a,[]);if(c)return c}return null}catch{return null}}function Gd(e,t={}){try{if(!le||le.isDestroyed)return!1;let n=String(e||"");if(!n)return!1;let{state:r,view:o}=le,i=qe?.pmStateMod?.TextSelection,s=$m(r.doc,n);if(!Array.isArray(s)||!s.length)return!1;let a=r.tr;for(let c of s){let l=a.doc.nodeAt(c);!l||l.type?.name!=="outlineSection"||l.attrs?.collapsed&&(a=a.setNodeMarkup(c,void 0,{...l.attrs,collapsed:!1}))}a=a.setMeta(ue,!0);try{let c=mt(a.doc,n),l=typeof c=="number"?a.doc.nodeAt(c):null;if(typeof c=="number"&&l?.type?.name==="outlineSection"){let d=l.child(0),m=c+1+d.nodeSize,h=Math.min(a.doc.content.size,m+2);i&&(a=a.setSelection(i.create(a.doc,h)))}}catch{}o.dispatch(a.scrollIntoView());try{let c=typeof CSS<"u"&&CSS.escape?CSS.escape(n):n.replace(/"/g,'\\"');window.requestAnimationFrame(()=>{try{let l=o.dom?.querySelector?.(`[data-outline-section][data-section-id="${c}"]`)||o.dom?.querySelector?.(`[data-section-id="${c}"]`);l&&typeof l.scrollIntoView=="function"&&l.scrollIntoView({block:"center",inline:"nearest"})}catch{}})}catch{}if(t&&t.focus)try{o.focus()}catch{}return!0}catch{return!1}}function Fm(e,t){if(!le)return!1;let n=String(e||"");if(!n)return!1;let r=mt(le.state.doc,n);if(typeof r!="number")return!1;let o=le.state.doc.nodeAt(r);if(!o)return!1;let i=le.state.doc.type.schema,s=Kn(String(t||"")),a=Aa(s.titleHtml||"")||Aa(s.bodyHtml||"").slice(0,80)||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F",c=Po?Po(s.bodyHtml||""):[],l=[];for(let p of c||[])try{l.push(i.nodeFromJSON(p))}catch{}l.length||l.push(i.nodes.paragraph.create({},[]));let d=i.nodes.outlineHeading.create({},a?[i.text(a)]:[]),m=i.nodes.outlineBody.create({},l),h=o.child(2),b=i.nodes.outlineSection.create(o.attrs,[d,m,h]),S=le.state.tr.replaceWith(r,r+o.nodeSize,b);try{let p=qe?.pmStateMod?.TextSelection;p&&(S=S.setSelection(p.create(S.doc,r+2)))}catch{}return le.view.dispatch(S),le.view.focus(),Qt=!0,Xt({delayMs:200}),!0}function zm(e,t){if(!le)return!1;let n=String(e||"");if(!n)return!1;let r=mt(le.state.doc,n);if(typeof r!="number")return!1;let o=le.state.doc.nodeAt(r);if(!o)return!1;let i=t&&typeof t=="object"?t:{},s=le.state.doc.type.schema,a=null,c=null;try{i.heading&&typeof i.heading=="object"&&(a=s.nodeFromJSON(i.heading))}catch{a=null}try{i.body&&typeof i.body=="object"&&(c=s.nodeFromJSON(i.body))}catch{c=null}(!a||a.type?.name!=="outlineHeading")&&(a=s.nodes.outlineHeading.create({},[])),(!c||c.type?.name!=="outlineBody")&&(c=s.nodes.outlineBody.create({},[s.nodes.paragraph.create({},[])])),c.childCount||(c=s.nodes.outlineBody.create({},[s.nodes.paragraph.create({},[])]));let l=o.child(2),d=s.nodes.outlineSection.create(o.attrs,[a,c,l]),m=le.state.tr.replaceWith(r,r+o.nodeSize,d);try{let h=qe?.pmStateMod?.TextSelection;h&&(m=m.setSelection(h.create(m.doc,r+2)))}catch{}return le.view.dispatch(m),le.view.focus(),Qt=!0,Xt({delayMs:200}),!0}function Um(e,t){if(!le)return!1;let n=String(e||"").trim();if(!n||typeof mt(le.state.doc,n)=="number")return!1;let o=t&&typeof t=="object"?t:{},i=le.state.doc.type.schema,s=null,a=null;try{o.heading&&typeof o.heading=="object"&&(s=i.nodeFromJSON(o.heading))}catch{s=null}try{o.body&&typeof o.body=="object"&&(a=i.nodeFromJSON(o.body))}catch{a=null}(!s||s.type?.name!=="outlineHeading")&&(s=i.nodes.outlineHeading.create({},[])),(!a||a.type?.name!=="outlineBody")&&(a=i.nodes.outlineBody.create({},[i.nodes.paragraph.create({},[])])),a.childCount||(a=i.nodes.outlineBody.create({},[i.nodes.paragraph.create({},[])]));let c=i.nodes.outlineChildren.create({},[]),l=i.nodes.outlineSection.create({id:n,collapsed:!1},[s,a,c]),d=le.state.doc.content.size,m=le.state.tr.insert(d,l);try{let h=qe?.pmStateMod?.TextSelection;if(h){let b=Math.min(m.doc.content.size,d+2);m=m.setSelection(h.near(m.doc.resolve(Math.max(0,b)),1))}}catch{}return m=m.setMeta(ue,!0),le.view.dispatch(m.scrollIntoView()),le.view.focus(),Qt=!0,Xt({delayMs:200}),!0}function qm({enterEditMode:e=!0}={}){if(!le)return null;let t=le.state.doc.type.schema,n=le.state.doc.content.size,r=Wt(),o=t.nodes.outlineSection.create({id:r,collapsed:!1},[t.nodes.outlineHeading.create({},[]),t.nodes.outlineBody.create({},[t.nodes.paragraph.create({},[])]),t.nodes.outlineChildren.create({},[])]),i=le.state.tr.insert(n,o);try{let s=qe?.pmStateMod?.TextSelection;if(s){let a=mt(i.doc,r),c=typeof a=="number"?Ui(i.doc,a):null;typeof c=="number"?i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,c+2)),1)):i=i.setSelection(s.create(i.doc,n+2))}}catch{}return i=i.setMeta(ue,!0),e&&Ee&&(i=i.setMeta(Ee,{type:"enter",sectionId:r})),le.view.dispatch(i.scrollIntoView()),le.view.focus(),Qt=!0,Xt({delayMs:200}),r}function Ui(e,t){try{let n=e.nodeAt(t);if(!n||n.type?.name!=="outlineSection")return null;let r=n.child(0);return t+1+r.nodeSize}catch{return null}}function Km(e,{focusBody:t=!0}={}){if(!le||!Ee)return!1;let n=String(e||"").trim();if(!n)return!1;let r=mt(le.state.doc,n);if(typeof r!="number"||le.state.doc.nodeAt(r)?.attrs?.collapsed)return!1;let i=le.state.tr;if(t)try{let s=qe?.pmStateMod?.TextSelection,a=Ui(i.doc,r);s&&typeof a=="number"&&(i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,a+2)),1)))}catch{}return i=i.setMeta(ue,!0),i=i.setMeta(Ee,{type:"enter",sectionId:n}),le.view.dispatch(i.scrollIntoView()),le.view.focus(),!0}function Vm({enterEditMode:e=!0}={}){if(!le)return null;let t=le.state.doc.type.schema,n=0,r=Wt(),o=t.nodes.outlineSection.create({id:r,collapsed:!1},[t.nodes.outlineHeading.create({},[]),t.nodes.outlineBody.create({},[t.nodes.paragraph.create({},[])]),t.nodes.outlineChildren.create({},[])]),i=le.state.tr.insert(n,o);try{let s=qe?.pmStateMod?.TextSelection;if(s){let a=mt(i.doc,r),c=typeof a=="number"?Ui(i.doc,a):null;typeof c=="number"?i=i.setSelection(s.near(i.doc.resolve(Math.min(i.doc.content.size,c+2)),1)):i=i.setSelection(s.create(i.doc,n+2))}}catch{}return i=i.setMeta(ue,!0),e&&Ee&&(i=i.setMeta(Ee,{type:"enter",sectionId:r})),le.view.dispatch(i.scrollIntoView()),le.view.focus(),Qt=!0,Xt({delayMs:200}),r}function jm(e,t,{enterEditMode:n=!1}={}){if(!le)return!1;let r=String(e||"").trim();if(!r||typeof mt(le.state.doc,r)=="number")return!1;let i=le.state.doc.type.schema,s=i.nodes.paragraph,a=i.nodes.hardBreak||i.nodes.hard_break||null,c=String(t||"").replace(/\r\n/g,`
`).trimEnd(),l=()=>{if(!s)return[];if(!c.trim())return[s.create({},[])];let f=c.split(/\n{2,}/),w=[];for(let x of f){let A=String(x||"").split(`
`),C=[];for(let L=0;L<A.length;L+=1){let H=A[L];L>0&&a&&C.push(a.create()),H&&C.push(i.text(H))}w.push(s.create({},C))}return w.length?w:[s.create({},[])]},d=i.nodes.outlineHeading.create({},[]),m=i.nodes.outlineBody.create({},l()),h=i.nodes.outlineChildren.create({},[]),b=i.nodes.outlineSection.create({id:r,collapsed:!1},[d,m,h]),S=0,p=le.state.tr.insert(S,b);try{let f=qe?.pmStateMod?.TextSelection;if(f){let w=mt(p.doc,r),x=typeof w=="number"?Ui(p.doc,w):null;typeof x=="number"?p=p.setSelection(f.near(p.doc.resolve(Math.min(p.doc.content.size,x+2)),1)):p=p.setSelection(f.create(p.doc,S+2))}}catch{}return p=p.setMeta(ue,!0),n&&Ee&&(p=p.setMeta(Ee,{type:"enter",sectionId:r})),le.view.dispatch(p.scrollIntoView()),le.view.focus(),Qt=!0,Xt({delayMs:200}),!0}async function Jm(){if(u.isPublicView||u.isRagView){Ie("Outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440 \u043D\u0435\u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0432 \u044D\u0442\u043E\u043C \u0440\u0435\u0436\u0438\u043C\u0435");return}if(!u.articleId||!u.article){Ie("\u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0441\u0442\u0430\u0442\u044C\u044E");return}if(Nt=u.articleId,!j.outlineEditor||!j.blocksContainer){Ie("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440");return}u.isOutlineEditing=!0,j.articleToolbar&&j.articleToolbar.classList.add("hidden"),j.outlineToolbar&&j.outlineToolbar.classList.remove("hidden"),j.outlineTagsBar&&j.outlineTagsBar.classList.remove("hidden"),j.outlineEditor.classList.remove("hidden"),j.blocksContainer.classList.add("hidden"),Rd({loading:!0});try{dt("outline.open",{articleId:Nt,updatedAt:u.article?.updatedAt||null,docHash:$t(u.article?.docJson||null)})}catch{}try{if(!u.scrollTargetBlockId&&Nt){let e=vm(Nt);e?.sectionId&&(u.currentBlockId=e.sectionId)}}catch{}try{await Yd();try{bm(le)}catch{}try{let t=u.scrollTargetBlockId||null;t&&(Gd(t,{focus:!1}),u.scrollTargetBlockId=null,u.currentBlockId=t)}catch{}try{let t=u.currentBlockId||null;t&&(Im(le,t),km(le,t,{block:"center"}))}catch{}let e=j.outlineEditor.querySelector(".outline-editor__loading");if(e&&e.classList.add("hidden"),Gn("\u0421\u043E\u0445\u0440\u0430\u043D\u044F\u0435\u0442\u0441\u044F \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438"),cd||(cd=!0,window.addEventListener("online",()=>{if(u.isOutlineEditing){try{Bd(Nt||u.articleId)}catch{}Mo({force:!0})}}),window.addEventListener("blur",()=>{u.isOutlineEditing&&Mo({force:!0})}),document.addEventListener("visibilitychange",()=>{u.isOutlineEditing&&document.visibilityState!=="visible"&&Mo({force:!0})})),!Bo){let t=r=>{if(!u.isOutlineEditing)return;let o=r?.dataTransfer;if(!(o&&(o.files&&o.files.length||o.items&&o.items.length)))return;let s=r?.target;j.outlineEditor&&s&&j.outlineEditor.contains(s)||r.preventDefault()},n=r=>{if(!u.isOutlineEditing)return;let o=r?.dataTransfer;if(!(o&&o.files&&o.files.length))return;let s=r?.target;j.outlineEditor&&s&&j.outlineEditor.contains(s)||(r.preventDefault(),r.stopPropagation())};window.addEventListener("dragover",t,{passive:!1}),window.addEventListener("drop",n,{passive:!1}),Bo=()=>{window.removeEventListener("dragover",t),window.removeEventListener("drop",n),Bo=null}}}catch(e){Ie(e?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C outline-\u0440\u0435\u0434\u0430\u043A\u0442\u043E\u0440"),Xd()}}function Xd(){u.isOutlineEditing=!1,Sm(),Ee=null,Nt=null,ur=null,Ri=null,Xn={counts:new Map,labelByKey:new Map,sectionIdsByKey:new Map,sectionPosById:new Map};try{j.outlineTagsBar&&(j.outlineTagsBar.innerHTML="",j.outlineTagsBar.classList.add("hidden"))}catch{}Zr(!1),Bo&&Bo(),j.outlineToolbar&&j.outlineToolbar.classList.add("hidden"),j.articleToolbar&&j.articleToolbar.classList.remove("hidden"),Vn&&(clearTimeout(Vn),Vn=null),Ft&&(clearTimeout(Ft),Ft=null),Ir&&(clearTimeout(Ir),Ir=null),ma=null,Rn=!1,Mi="";try{En.clear()}catch{}vi=!1,Br.clear();try{eo.clear()}catch{}Tr.clear(),pn=null,Qt=!1;try{for(let[,e]of No)try{clearTimeout(e)}catch{}No.clear()}catch{}try{for(let[,e]of vr)try{URL.revokeObjectURL(e)}catch{}vr.clear()}catch{}if(le){try{le.destroy()}catch{}le=null}qe=null,j.outlineEditor&&j.outlineEditor.classList.add("hidden"),j.blocksContainer&&j.blocksContainer.classList.remove("hidden")}async function Wm(e={}){let t=e&&typeof e.mode=="string"?e.mode:"network",n=e&&typeof e.timeoutMs=="number"?Math.max(0,Math.floor(e.timeoutMs)):0;if(!le)return;Vn&&(clearTimeout(Vn),Vn=null);try{let o=Nt||u.articleId;if(o&&!u.article?.encrypted){let i=le.getJSON();if(i&&typeof i=="object")try{await gn(o,i,u.article?.updatedAt||null)}catch{}try{try{let s=Ee?.getState?.(le?.state)||null,a=String(s?.editingSectionId||"").trim();a&&await Ca({articleId:o,doc:le.state.doc,sectionId:a,reason:"pagehide"})}catch{}if(Rn){let s=_o(le.state.doc);s.length&&(tn("structure_snapshot",{articleId:o,payload:{nodes:s},coalesceKey:`structure:${o}`}),Rn=!1)}}catch{}try{if(En.size){let s=Array.from(En);En.clear();let a=Date.now();await tn("delete_sections",{articleId:o,payload:{sectionIds:s,clientQueuedAt:a},coalesceKey:`delete:${o}:${a}`})}}catch{}}}catch{}if(t==="queue")return;let r=Mo({force:!0,silent:!0});if(n>0){await Promise.race([r,new Promise(o=>setTimeout(o,n))]);return}await r}async function Ym({docJson:e}={}){if(j.outlineEditor){if(!e||typeof e!="object"){Ie("\u041F\u0443\u0431\u043B\u0438\u0447\u043D\u0430\u044F \u0441\u0442\u0430\u0442\u044C\u044F: \u043D\u0435\u0442 \u0434\u043E\u043A\u0443\u043C\u0435\u043D\u0442\u0430");return}u.isPublicView=!0,u.isRagView=!1,u.isOutlineEditing=!1,u.articleId=null,u.article={docJson:e,encrypted:!1};try{j.outlineEditor.classList.add("outline-editor")}catch{}j.outlineEditor.classList.remove("hidden"),j.outlineEditor.querySelector("#outlineEditorContent")||Rd({loading:!0});try{await Yd();let t=j.outlineEditor.querySelector(".outline-editor__loading");t&&t.classList.add("hidden"),Gn("\u0422\u043E\u043B\u044C\u043A\u043E \u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440")}catch(t){Ie(t?.message||"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u0443\u044E \u0441\u0442\u0430\u0442\u044C\u044E")}}}var ad,qe,le,vo,Vn,vi,Ir,ma,da,Ed,pn,vr,Tr,Br,eo,Qt,cd,Po,ha,ga,At,xr,ua,Hp,jr,Jr,ki,Ti,Ee,Bo,Nt,ur,Ri,Xn,Yn,fr,$p,Ei,ya,_i,Fp,No,dd,Di,Rn,Mi,Ft,En,fa,ue,fd,Yp,Gp,Xp,Ci,Gm,Xm,tt,ui=Ge(()=>{Bt();In();en();On();tr();ln();fo();yr();Or();Pr();ns();Gl();nr();Xl();Zl();io();ad=!1,qe=null,le=null,vo=null,Vn=null,vi=!1,Ir=null,ma=null,da=0,Ed=null,pn=null,vr=new Map,Tr=new Map,Br=new Set,eo=new Set,Qt=!1,cd=!1,Po=null,ha=null,ga=null,At={TableMap:null,CellSelection:null,moveTableColumn:null,moveTableRow:null,addRowBefore:null,addRowAfter:null,deleteRow:null,addColumnBefore:null,addColumnAfter:null,deleteColumn:null,toggleHeaderRow:null,toggleHeaderColumn:null},xr=!1,ua=new Map,Hp=30*1e3,jr=new Map,Jr=new Map,ki=0,Ti=null,Ee=null,Bo=null,Nt=null,ur=null,Ri=null,Xn={counts:new Map,labelByKey:new Map,sectionIdsByKey:new Map,sectionPosById:new Map},Yn=!1,fr=new Set,$p=650,Ei={articleId:null,sectionId:null,collapsed:null},ya="ttree_outline_section_clipboard_v1",_i="pending-attachment:",Fp=2e3,No=new Map;dd="ttree_outline_section_seq_v1",Di=262144;Rn=!1,Mi="",Ft=null,En=new Set,fa=null;ue="outlineAllowMutation",fd=0,Yp="ttree_outline_debug_md_table";Gp="ttree_profile_v1";Xp="ttree_outline_debug_proofread_v1";Ci=null;Gm="ttree_debug_outline_keys_v1",Xm=()=>{try{return window?.localStorage?.getItem?.(Gm)==="1"}catch{return!1}},tt=(e,t={})=>{Xm()}});(()=>{let e=window.__memusAppModule||"/app.js",t="ttree_boot_session_v1",n="ttree_last_user_v1",r="ttree_last_active_at_v1",o=200,i=900*1e3,s=2500,a="ttree_debug_quick_notes_v1",c="ttree_offline_known_user_keys_v1",l="memus_offline_v1_",d="ttree_offline_recovery_force_index_v1",m="ttree_boot_open_offline_requested_v1",h=!1;try{h=window.sessionStorage?.getItem?.(m)==="1",h&&window.sessionStorage?.removeItem?.(m)}catch{}function b(){try{return window?.localStorage?.getItem?.(a)==="1"}catch{return!1}}function S(...te){try{if(!b())return;console.log("[quick-notes][boot]",...te)}catch{}}function p(...te){try{console.log("[quick-notes][recovery]",...te)}catch{}}function f(...te){try{console.error("[quick-notes][recovery]",...te)}catch{}}function w(){if("serviceWorker"in navigator)try{navigator.serviceWorker.register("/uploads-sw.js",{scope:"/",updateViaCache:"none"}).then(te=>{try{te&&te.waiting&&te.waiting.postMessage({type:"memus:skipWaiting"}),te?.addEventListener?.("updatefound",()=>{try{let ce=te.installing;if(!ce)return;ce.addEventListener("statechange",()=>{if(ce.state==="installed"&&navigator.serviceWorker.controller)try{te.waiting?.postMessage?.({type:"memus:skipWaiting"})}catch{}})}catch{}})}catch{}try{let ce=te?.update?.();ce&&typeof ce.catch=="function"&&ce.catch(()=>{})}catch{}}).catch(()=>{});try{let te=!!navigator.serviceWorker.controller,ce=C(),y=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{if(!y&&(y=!0,!h&&te&&!ce))try{window.location.reload()}catch{}})}catch{}}catch{}}function x(){try{return String(window.location.pathname||"").startsWith("/p/")}catch{return!1}}function A(){try{return!!(typeof navigator<"u"&&navigator&&navigator.onLine===!1)}catch{return!1}}function C(){try{let te=performance.getEntriesByType?.("navigation")||[],ce=te&&te[0];return String(ce?.type||"")==="reload"}catch{return!1}}function L(){try{let te=window.localStorage.getItem(r)||"",ce=Number(te);return Number.isFinite(ce)?ce:0}catch{return 0}}function H(){try{window.localStorage.setItem(r,String(Date.now()))}catch{}}function U(){let te=L();return te?Date.now()-te>i:!0}function F(){try{return window.sessionStorage.getItem(t)?!1:(window.sessionStorage.setItem(t,"1"),!0)}catch{return!0}}function X(){try{let te=window.localStorage.getItem(n);if(!te)return!1;let ce=JSON.parse(te);return!!(ce&&(ce.id||ce.username))}catch{return!1}}function G(){try{if(globalThis.crypto&&typeof globalThis.crypto.randomUUID=="function")return globalThis.crypto.randomUUID()}catch{}return`id-${Date.now()}-${Math.random().toString(16).slice(2)}`}function oe(){return new Date().toISOString()}function we(){try{let te=window.localStorage.getItem(c)||"[]",ce=JSON.parse(te);return Array.isArray(ce)?ce.filter(Boolean).map(String):[]}catch{return[]}}async function Ce(){try{if(!("indexedDB"in window))return[];if(typeof indexedDB.databases=="function"){let y=(await indexedDB.databases()||[]).map(v=>v&&v.name).filter(Boolean).filter(v=>String(v).startsWith(l)).map(v=>String(v).slice(l.length)).filter(Boolean);return Array.from(new Set(y))}}catch{}return Array.from(new Set(we()))}function ne(te,ce){return new Promise((y,g)=>{try{let v=ce?indexedDB.open(te,ce):indexedDB.open(te);ce&&(v.onupgradeneeded=()=>{try{let k=v.result;if(k.objectStoreNames.contains("meta")||k.createObjectStore("meta",{keyPath:"key"}),!k.objectStoreNames.contains("articles")){let N=k.createObjectStore("articles",{keyPath:"id"});N.createIndex("byUpdatedAt","updatedAt",{unique:!1}),N.createIndex("byDeletedAt","deletedAt",{unique:!1})}if(!k.objectStoreNames.contains("outline_sections")){let N=k.createObjectStore("outline_sections",{keyPath:"sectionId"});N.createIndex("byArticleId","articleId",{unique:!1}),N.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!k.objectStoreNames.contains("section_embeddings")){let N=k.createObjectStore("section_embeddings",{keyPath:"sectionId"});N.createIndex("byArticleId","articleId",{unique:!1}),N.createIndex("byUpdatedAt","updatedAt",{unique:!1})}if(!k.objectStoreNames.contains("media_assets")){let N=k.createObjectStore("media_assets",{keyPath:"url"});N.createIndex("byStatus","status",{unique:!1}),N.createIndex("byFetchedAtMs","fetchedAtMs",{unique:!1}),N.createIndex("byStatusFetchedAtMs",["status","fetchedAtMs"],{unique:!1})}if(!k.objectStoreNames.contains("media_refs")){let N=k.createObjectStore("media_refs",{keyPath:"key"});N.createIndex("byArticleId","articleId",{unique:!1}),N.createIndex("byUrl","url",{unique:!1})}if(k.objectStoreNames.contains("outbox"))try{let _=v.transaction.objectStore("outbox");_.indexNames.contains("byTypeCoalesceKey")||_.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}catch{}else{let N=k.createObjectStore("outbox",{keyPath:"id"});N.createIndex("byCreatedAtMs","createdAtMs",{unique:!1}),N.createIndex("byTypeArticleId",["type","articleId"],{unique:!1}),N.createIndex("byTypeCoalesceKey",["type","coalesceKey"],{unique:!1})}if(!k.objectStoreNames.contains("pending_uploads")){let N=k.createObjectStore("pending_uploads",{keyPath:"token"});N.createIndex("byArticleId","articleId",{unique:!1}),N.createIndex("byCreatedAtMs","createdAtMs",{unique:!1})}}catch{}}),v.onsuccess=()=>y(v.result),v.onerror=()=>{let k=v.error||new Error("IndexedDB open failed");f("idb.open.error",{name:te,version:ce||null,message:String(k?.message||k)}),g(k)}}catch(v){f("idb.open.throw",{name:te,version:ce||null,message:String(v?.message||v)}),g(v)}})}function ye(te,ce){return new Promise((y,g)=>{try{let N=te.transaction([ce],"readonly").objectStore(ce).getAll();N.onsuccess=()=>y(Array.isArray(N.result)?N.result:[]),N.onerror=()=>{let _=N.error||new Error("IndexedDB getAll failed");f("idb.getAll.error",{storeName:ce,message:String(_?.message||_)}),g(_)}}catch(v){f("idb.getAll.throw",{storeName:ce,message:String(v?.message||v)}),g(v)}})}function Ye(te,ce){return new Promise((y,g)=>{try{let N=te.transaction([ce],"readonly").objectStore(ce).count();N.onsuccess=()=>y(Number(N.result||0)),N.onerror=()=>{let _=N.error||new Error("IndexedDB count failed");f("idb.count.error",{storeName:ce,message:String(_?.message||_)}),g(_)}}catch(v){f("idb.count.throw",{storeName:ce,message:String(v?.message||v)}),g(v)}})}function wt(te,ce){try{let y=JSON.stringify(ce),g=new Blob([y],{type:"application/json;charset=utf-8"}),v=URL.createObjectURL(g),k=document.createElement("a");return k.href=v,k.download=te,k.rel="noopener",document.body.appendChild(k),k.click(),setTimeout(()=>{try{k.remove(),URL.revokeObjectURL(v)}catch{}},0),!0}catch{return!1}}function Pt(te,ce){try{let y=URL.createObjectURL(ce),g=document.createElement("a");return g.href=y,g.download=te,g.rel="noopener",document.body.appendChild(g),g.click(),setTimeout(()=>{try{g.remove(),URL.revokeObjectURL(y)}catch{}},0),!0}catch{return!1}}async function sn(te,{method:ce="GET",body:y=null,timeoutMs:g=2e4}={}){let v=typeof AbortController<"u"?new AbortController:null,k={method:ce,credentials:"include",headers:{},signal:v?.signal};y!==null&&(k.headers["Content-Type"]="application/json",k.body=JSON.stringify(y));let N=null,_=!1;v&&typeof g=="number"&&g>0&&(N=setTimeout(()=>{try{_=!0;try{v.abort(new Error(`timeout after ${g}ms`))}catch{v.abort()}}catch{}},g));let O;try{O=await fetch(te,k)}finally{N&&clearTimeout(N)}let K=await O.text().catch(()=>""),D=null;try{D=K?JSON.parse(K):null}catch{D=null}if(!O.ok){let M=D&&(D.detail||D.error)||K||`${O.status} ${O.statusText}`,B=new Error(M);throw B.status=O.status,B.payload=D,B}return D}async function mn(te,ce){try{return await sn(te,ce)}catch(y){if(String(y?.name||"")==="AbortError"||String(y?.message||"").toLowerCase().includes("aborted")){let v=typeof ce?.timeoutMs=="number"?ce.timeoutMs:null,k=new Error(v?`timeout after ${v}ms`:"request aborted");throw k.name="TimeoutError",k}throw y}}function An(te){try{return te?JSON.parse(te):null}catch{return null}}function Nn(te){let ce=String(te||"");return!!(!ce||ce==="inbox"||ce.startsWith("inbox-"))}async function $n({userKey:te,onProgress:ce}){let y=String(te||"").trim();if(!y)throw new Error("No userKey");let g=await ne(`${l}${y}`).catch(T=>{throw f("restore.server.idb.open.error",{userKey:y,message:String(T?.message||T)}),T}),v=await ye(g,"articles").catch(T=>{throw f("restore.server.idb.read.error",{userKey:y,message:String(T?.message||T)}),T});try{g.close()}catch{}let k=(Array.isArray(v)?v:[]).filter(T=>T&&!T.deletedAt&&!Nn(T.id)).map(T=>{let I=An(T.articleJsonStr)||{},P=An(T.docJsonStr)||I.docJson||null;return{id:String(T.id),title:(T.title||I.title||"").toString(),parentId:T.parentId??I.parentId??null,position:typeof T.position=="number"?T.position:typeof I.position=="number"?I.position:0,docJson:P&&typeof P=="object"?P:null}}).filter(T=>T.id&&T.docJson),N=k.length,_={n:0},O={n:0},K={n:0},D=(T,I={})=>{try{ce?.({phase:T,total:N,created:_.n,saved:O.n,moved:K.n,...I})}catch{}};D("start");for(let T=0;T<k.length;T+=1){let I=k[T];D("content",{idx:T+1,articleId:I.id,title:I.title});try{p("restore.server.create.start",{idx:T+1,id:I.id}),await mn("/api/articles",{method:"POST",body:{id:I.id,title:I.title||"\u0411\u0435\u0437 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u044F"},timeoutMs:15e3}),_.n+=1,p("restore.server.create.done",{idx:T+1,id:I.id})}catch(P){p("restore.server.create.skip",{idx:T+1,id:I.id,status:P?.status||null,message:String(P?.message||P)})}try{p("restore.server.save.start",{idx:T+1,id:I.id}),await mn(`/api/articles/${encodeURIComponent(I.id)}/doc-json`,{method:"PUT",body:{docJson:I.docJson},timeoutMs:3e4}),O.n+=1,p("restore.server.save.done",{idx:T+1,id:I.id})}catch(P){f("restore.server.save.error",{idx:T+1,id:I.id,status:P?.status||null,message:String(P?.message||P),stack:String(P?.stack||"")})}}let M=new Map;for(let T of k){let I=T.parentId||null;M.has(I)||M.set(I,[]),M.get(I).push(T)}for(let[T,I]of M.entries())I.sort((P,$)=>Number(P.position||0)-Number($.position||0)),M.set(T,I);let B=[null],E=new Set;for(D("structure");B.length;){let T=B.shift(),I=T||"__root__";if(E.has(I))continue;E.add(I);let P=M.get(T||null)||[];for(let $ of P){D("structure",{articleId:$.id,title:$.title});try{await sn(`/api/articles/${encodeURIComponent($.id)}/move-tree`,{method:"POST",body:{parentId:T||null,anchorId:null,placement:"inside"}}),K.n+=1}catch(V){p("restore.server.move.skip",{id:$.id,status:V?.status||null,message:String(V?.message||V)})}M.has($.id)&&B.push($.id)}}return D("done"),{total:N,created:_.n,saved:O.n,moved:K.n}}function Fn(te){let ce=new TextEncoder,y=Object.entries(te?.stores||{}),g={type:"meta",exportedAt:te?.exportedAt||oe(),sourceUserKey:te?.sourceUserKey||null,dbName:te?.dbName||null,format:"ndjson.v1"},v=!1,k=0,N=-1;return new ReadableStream({pull(_){try{if(!v){v=!0,_.enqueue(ce.encode(`${JSON.stringify(g)}
`));return}for(;k<y.length;){let[O,K]=y[k],D=Array.isArray(K)?K:[];if(N===-1){N=0,_.enqueue(ce.encode(`${JSON.stringify({type:"store",store:O,count:D.length})}
`));return}if(N>=D.length){k+=1,N=-1;continue}let M={type:"item",store:O,value:D[N]};N+=1,_.enqueue(ce.encode(`${JSON.stringify(M)}
`));return}_.close()}catch(O){f("ndjson.stream.error",{message:String(O?.message||O),stack:String(O?.stack||"")}),_.error(O)}}})}async function Mn(te,ce){let y=Fn(ce),g=typeof CompressionStream<"u",v=g?y.pipeThrough(new CompressionStream("gzip")):y,k=await new Response(v).blob(),N=g?`${te}.ndjson.gz`:`${te}.ndjson`;if(Pt(N,k))return{ok:!0,method:"download",filename:N};try{let _=URL.createObjectURL(k);try{window.open(_,"_blank","noopener")}catch{window.location.href=_}return{ok:!0,method:"open",filename:N}}catch(_){f("export.open.error",{filename:N,message:String(_?.message||_),stack:String(_?.stack||"")})}return{ok:!1,method:"none",filename:N}}function Ln(){try{let te=window.localStorage.getItem(n)||"",ce=te?JSON.parse(te):null;return ce?.id||ce?.username||""}catch{return""}}async function _t(te){let ce=String(te||"").trim();if(!ce)throw new Error("No userKey");let y=`${l}${ce}`,g=await ne(y,3),v=["articles","outline_sections","media_assets","media_refs","outbox","pending_uploads","section_embeddings","meta"].filter(N=>{try{return g.objectStoreNames.contains(N)}catch{return!1}}),k={exportedAt:oe(),sourceUserKey:ce,dbName:y,stores:{}};for(let N of v)k.stores[N]=await ye(g,N).catch(_=>(f("export.store.read.error",{userKey:ce,store:N,message:String(_?.message||_)}),[]));try{g.close()}catch{}return k}async function Kt(te,ce){let y=String(ce||"").trim();if(!y)throw new Error("No target userKey");if(!te||typeof te!="object"||!te.stores||typeof te.stores!="object")throw new Error("Invalid dump");let g=`${l}${y}`,v=await ne(g,3),k=async(_,O)=>{if(!v.objectStoreNames.contains(_))return 0;let K=Array.isArray(O)?O:[];if(!K.length)return 0;let D=v.transaction([_],"readwrite"),M=D.objectStore(_),B=0;return await new Promise((E,T)=>{D.oncomplete=()=>E(),D.onerror=()=>{let I=D.error||new Error("tx failed");f("import.tx.error",{storeName:_,message:String(I?.message||I)}),T(I)},D.onabort=()=>{let I=D.error||new Error("tx aborted");f("import.tx.abort",{storeName:_,message:String(I?.message||I)}),T(I)};for(let I of K)try{M.put(I),B+=1}catch{}}),B},N=0;N+=await k("articles",te.stores.articles),N+=await k("outline_sections",te.stores.outline_sections),N+=await k("media_assets",te.stores.media_assets),N+=await k("media_refs",te.stores.media_refs),N+=await k("pending_uploads",te.stores.pending_uploads),N+=await k("section_embeddings",te.stores.section_embeddings);try{v.close()}catch{}return N}let It="ttree_pending_quick_notes_v1";function gt(){try{let te=window.localStorage.getItem(It)||"";if(!te)return[];let ce=JSON.parse(te);return Array.isArray(ce)?ce.filter(Boolean):[]}catch{return[]}}function Dt(te){try{window.localStorage.setItem(It,JSON.stringify(Array.isArray(te)?te:[]))}catch{}}function an(te){let ce=String(te||"").trim();if(!ce)return null;let y=G(),g={id:y,sectionId:y,createdAt:oe(),text:ce},v=gt(),k=[g,...v].slice(0,o);return Dt(k),S("saved.pending",{id:g.id,len:k.length}),g}function Y(){if(document.getElementById("quickNoteBootStyles"))return;let te=document.createElement("style");te.id="quickNoteBootStyles",te.textContent=`
      .boot-modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.22);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);z-index:99999;display:flex;align-items:center;justify-content:center;padding:16px}
      .boot-modal{width:min(720px,100%);background:rgba(255,255,255,.92);border:1px solid rgba(203,213,225,.9);border-radius:16px;box-shadow:0 24px 80px rgba(15,23,42,.18);color:#0f172a}
      .boot-modal__hdr{padding:14px 16px;border-bottom:1px solid rgba(203,213,225,.7);display:flex;align-items:center;justify-content:space-between;gap:12px}
      .boot-modal__title{font-size:14px;font-weight:600;letter-spacing:.2px}
      .boot-modal__meta{font-size:12px;color:#64748b}
      .boot-modal__body{padding:12px 16px}
      .boot-note{width:100%;min-height:34vh;max-height:52vh;resize:vertical;background:rgba(255,255,255,.95);color:#0f172a;border:1px solid rgba(203,213,225,.9);border-radius:12px;padding:12px 12px;font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;outline:none}
      .boot-note:focus{border-color:rgba(37,99,235,.65);box-shadow:0 0 0 4px rgba(37,99,235,.14)}
      .boot-modal__ftr{padding:12px 16px;border-top:1px solid rgba(203,213,225,.7);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
      .boot-actions{display:flex;gap:10px;flex-wrap:wrap}
      .boot-btn{appearance:none;border:1px solid rgba(203,213,225,.9);background:rgba(255,255,255,.7);color:#0f172a;border-radius:999px;padding:10px 14px;font:600 13px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;cursor:pointer}
      .boot-btn:hover{background:rgba(241,245,249,.9)}
      .boot-btn--primary{background:#007ACC;border-color:#007ACC;color:#ffffff}
      .boot-btn--primary:hover{background:#0062A3}
      .boot-btn--ghost{background:transparent}
      .boot-hint{font-size:12px;color:#64748b}
      .boot-toast{margin-left:auto;font-size:12px;color:#16a34a}
    `,document.head.appendChild(te)}function ie(te,{timeout:ce=5e3,fallbackDelay:y=1200}={}){try{if(typeof requestIdleCallback=="function"){requestIdleCallback(()=>te(),{timeout:ce});return}}catch{}setTimeout(()=>te(),y)}function pe(){ie(()=>{try{import(e).catch(()=>{})}catch{}})}function he({reason:te=""}={}){Y();let ce=document.createElement("div");ce.className="boot-modal-backdrop";let y=document.createElement("div");y.className="boot-modal";let g=document.createElement("div");g.className="boot-modal__hdr";let v=document.createElement("div"),k=document.createElement("div");k.className="boot-modal__title",k.textContent="\u0411\u044B\u0441\u0442\u0440\u0430\u044F \u0437\u0430\u043C\u0435\u0442\u043A\u0430",v.appendChild(k);let N=document.createElement("button");N.type="button",N.className="boot-btn boot-btn--ghost",N.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",g.appendChild(v),g.appendChild(N);let _=document.createElement("div");_.className="boot-modal__body";let O=document.createElement("textarea");O.className="boot-note",O.placeholder=`\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0443\u2026

Ctrl+Enter \u2014 \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C
Esc \u2014 \u0437\u0430\u043A\u0440\u044B\u0442\u044C`,_.appendChild(O);let K=document.createElement("div");K.className="boot-modal__ftr";let D=document.createElement("div");D.className="boot-hint",D.textContent="\u0417\u0430\u043C\u0435\u0442\u043A\u0438 \u0441\u043E\u0445\u0440\u0430\u043D\u044F\u044E\u0442\u0441\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E \u0438 \u0431\u0443\u0434\u0443\u0442 \u043E\u0442\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u044B \u0432 \u201C\u0411\u044B\u0441\u0442\u0440\u044B\u0435 \u0437\u0430\u043C\u0435\u0442\u043A\u0438\u201D \u043F\u0440\u0438 \u0441\u043B\u0435\u0434\u0443\u044E\u0449\u0435\u043C \u0432\u0445\u043E\u0434\u0435.";let M=document.createElement("div");M.className="boot-actions";let B=document.createElement("button");B.type="button",B.className="boot-btn boot-btn--primary",B.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C";let E=document.createElement("button");E.type="button",E.className="boot-btn",E.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0438 \u0435\u0449\u0451",M.appendChild(B),M.appendChild(E);let T=document.createElement("div");T.className="boot-toast",K.appendChild(D),K.appendChild(M),K.appendChild(T),y.appendChild(g),y.appendChild(_),y.appendChild(K),ce.appendChild(y);let I=()=>{try{ce.remove()}catch{}},P=V=>{let z=an(O.value);if(z){O.value="",T.textContent="\u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E",H();try{window.dispatchEvent(new CustomEvent("memus:queued-inbox-changed",{detail:{note:z}})),S("event.dispatched",{type:"memus:queued-inbox-changed"})}catch{}V||I(),setTimeout(()=>{try{T.textContent=""}catch{}},1200)}};N.addEventListener("click",I),ce.addEventListener("click",V=>{V.target===ce&&I()}),B.addEventListener("click",()=>P(!1)),E.addEventListener("click",()=>P(!0)),O.addEventListener("keydown",V=>{if(V.key==="Escape"){V.preventDefault(),I();return}V.key==="Enter"&&(V.ctrlKey||V.metaKey)&&(V.preventDefault(),P(!0))});let $=async()=>{Y();let V=document.createElement("div");V.className="boot-modal-backdrop";let z=document.createElement("div");z.className="boot-modal";let q=document.createElement("div");q.className="boot-modal__hdr";let Z=document.createElement("div"),se=document.createElement("div");se.className="boot-modal__title",se.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0445 \u0434\u0430\u043D\u043D\u044B\u0445";let xe=document.createElement("div");xe.className="boot-modal__meta",xe.textContent="\u0418\u0449\u0435\u043C \u0441\u0442\u0430\u0440\u044B\u0435 \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0435 \u0431\u0430\u0437\u044B\u2026",Z.appendChild(se),Z.appendChild(xe);let me=document.createElement("button");me.type="button",me.className="boot-btn boot-btn--ghost",me.textContent="\u0417\u0430\u043A\u0440\u044B\u0442\u044C",q.appendChild(Z),q.appendChild(me);let Ae=document.createElement("div");Ae.className="boot-modal__body";let Te=document.createElement("div");Te.style.display="flex",Te.style.flexDirection="column",Te.style.gap="10px",Ae.appendChild(Te);let _e=document.createElement("div");_e.className="boot-modal__ftr";let Pe=document.createElement("div");Pe.className="boot-hint",Pe.textContent="\u0415\u0441\u043B\u0438 \u043F\u043E\u0441\u043B\u0435 \u0432\u0445\u043E\u0434\u0430 \u0432\u0441\u0435 \u0441\u0442\u0430\u0442\u044C\u0438 \u043F\u0440\u043E\u043F\u0430\u043B\u0438, \u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E \u0438\u0437\u043C\u0435\u043D\u0438\u043B\u0441\u044F userKey. \u0417\u0434\u0435\u0441\u044C \u043C\u043E\u0436\u043D\u043E \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441\u0442\u0430\u0440\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 \u0438\u043B\u0438 \u0438\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0438\u0445 \u0432 \u0442\u0435\u043A\u0443\u0449\u0435\u0433\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F.";let Se=document.createElement("div");Se.className="boot-toast",_e.appendChild(Pe),_e.appendChild(Se),z.appendChild(q),z.appendChild(Ae),z.appendChild(_e),V.appendChild(z);let Fe=()=>{try{V.remove()}catch{}};me.addEventListener("click",Fe),V.addEventListener("click",Ue=>{Ue.target===V&&Fe()}),document.body.appendChild(V);let je=(Ue,{articleCount:nt}={})=>{let ut=document.createElement("div");ut.style.border="1px solid rgba(255,255,255,.12)",ut.style.borderRadius="12px",ut.style.padding="12px",ut.style.display="flex",ut.style.flexDirection="column",ut.style.gap="10px";let yt=document.createElement("div");yt.style.display="flex",yt.style.alignItems="baseline",yt.style.justifyContent="space-between",yt.style.gap="12px";let Ht=document.createElement("div");Ht.style.fontWeight="600",Ht.style.fontSize="13px",Ht.textContent=Ue;let R=document.createElement("div");R.dataset.recoveryMeta="1",R.style.fontSize="12px",R.style.color="#9ca3af",R.textContent=typeof nt=="number"?`\u0421\u0442\u0430\u0442\u0435\u0439: ${nt}`:"",yt.appendChild(Ht),yt.appendChild(R);let Q=document.createElement("div");Q.className="boot-actions";let W=document.createElement("button");W.type="button",W.className="boot-btn",W.textContent="\u042D\u043A\u0441\u043F\u043E\u0440\u0442 JSON";let J=document.createElement("button");J.type="button",J.className="boot-btn boot-btn--primary",J.textContent="\u0418\u043C\u043F\u043E\u0440\u0442 \u0432 \u0442\u0435\u043A\u0443\u0449\u0435\u0433\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F";let re=document.createElement("button");return re.type="button",re.className="boot-btn",re.textContent="\u041D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440",Q.appendChild(W),Q.appendChild(J),Q.appendChild(re),ut.appendChild(yt),ut.appendChild(Q),W.addEventListener("click",async()=>{let ae=performance.now();try{Se.textContent="\u042D\u043A\u0441\u043F\u043E\u0440\u0442\u2026",p("export.start",{userKey:Ue});let ee=await _t(Ue),fe=`memus-offline-recovery-${Ue}-${new Date().toISOString().replace(/[:.]/g,"-")}`,be=await Mn(fe,ee);p("export.done",{userKey:Ue,ok:be.ok,method:be.method,filename:be.filename,ms:Math.round(performance.now()-ae)}),Se.textContent=be.ok?be.method==="download"?`\u0421\u043A\u0430\u0447\u0438\u0432\u0430\u043D\u0438\u0435 \u043D\u0430\u0447\u0430\u043B\u043E\u0441\u044C: ${be.filename}`:be.method==="open"?`\u041E\u0442\u043A\u0440\u044B\u043B \u0444\u0430\u0439\u043B \u0432 \u043D\u043E\u0432\u043E\u0439 \u0432\u043A\u043B\u0430\u0434\u043A\u0435: ${be.filename}`:`\u042D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043E: ${be.filename}`:"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C (\u043E\u0433\u0440\u0430\u043D\u0438\u0447\u0435\u043D\u0438\u044F \u0431\u0440\u0430\u0443\u0437\u0435\u0440\u0430)"}catch(ee){f("export.button.error",{userKey:Ue,message:String(ee?.message||ee),stack:String(ee?.stack||"")}),Se.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430 \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0430: ${String(ee&&ee.message?ee.message:ee)}`}finally{setTimeout(()=>{try{Se.textContent=""}catch{}},8e3)}}),J.addEventListener("click",async()=>{let ae=performance.now();try{let ee=Ln();if(!ee){Se.textContent="\u041D\u0435\u0442 \u201C\u0442\u0435\u043A\u0443\u0449\u0435\u0433\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F\u201D \u0432 localStorage. \u0421\u043D\u0430\u0447\u0430\u043B\u0430 \u043E\u0434\u0438\u043D \u0440\u0430\u0437 \u0432\u043E\u0439\u0434\u0438\u0442\u0435.";return}Se.textContent="\u0418\u043C\u043F\u043E\u0440\u0442\u2026",p("import.start",{from:Ue,to:ee});let fe=await _t(Ue),be=await Kt(fe,ee);try{window.localStorage.setItem(d,"1")}catch{}let De=await ne(`${l}${ee}`).catch(()=>null),ke=null,$e=null;if(De){ke=await Ye(De,"articles").catch(()=>null),$e=await Ye(De,"outline_sections").catch(()=>null);try{De.close()}catch{}}p("import.done",{from:Ue,to:ee,imported:be,targetArticles:ke,targetSections:$e,ms:Math.round(performance.now()-ae)});let He=typeof ke=="number"?` (\u0432 \u0431\u0430\u0437\u0435 \u0441\u0442\u0430\u0442\u0435\u0439: ${ke})`:"";Se.textContent=`\u0418\u043C\u043F\u043E\u0440\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u043E \u0437\u0430\u043F\u0438\u0441\u0435\u0439: ${be}${He}`;try{window.dispatchEvent(new CustomEvent("memus:offline-recovery-imported",{detail:{from:Ue,to:ee}}))}catch{}}catch(ee){f("import.button.error",{userKey:Ue,message:String(ee?.message||ee),stack:String(ee?.stack||"")}),Se.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430 \u0438\u043C\u043F\u043E\u0440\u0442\u0430: ${String(ee&&ee.message?ee.message:ee)}`}finally{setTimeout(()=>{try{Se.textContent=""}catch{}},8e3)}}),re.addEventListener("click",async()=>{let ae=performance.now();try{Se.textContent="\u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u043D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u2026",p("restore.server.start",{userKey:Ue});let ee=await $n({userKey:Ue,onProgress:fe=>{let be=fe.phase;be==="content"?Se.textContent=`\u041D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440: ${fe.idx}/${fe.total} \xB7 ${fe.title||fe.articleId}`:be==="structure"?Se.textContent=`\u0421\u0442\u0440\u0443\u043A\u0442\u0443\u0440\u0430\u2026 (${fe.moved}/${fe.total})`:be==="done"&&(Se.textContent=`\u0413\u043E\u0442\u043E\u0432\u043E: \u0441\u0442\u0430\u0442\u0435\u0439=${fe.total}, \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E=${fe.saved}`),p("restore.server.progress",fe)}});p("restore.server.done",{...ee,ms:Math.round(performance.now()-ae)}),Se.textContent=`\u041D\u0430 \u0441\u0435\u0440\u0432\u0435\u0440: \u0441\u0442\u0430\u0442\u0435\u0439=${ee.total}, \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043E=${ee.saved}`}catch(ee){f("restore.server.error",{userKey:Ue,message:String(ee?.message||ee),stack:String(ee?.stack||"")}),Se.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430: ${String(ee?.message||ee)}`}finally{setTimeout(()=>{try{Se.textContent=""}catch{}},12e3)}}),ut};try{let Ue=await Ce();if(!Ue.length){xe.textContent="\u041B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0435 \u0431\u0430\u0437\u044B \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B. \u0415\u0441\u043B\u0438 \u0432\u044B \u0442\u043E\u0447\u043D\u043E \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u043B\u0438\u0441\u044C Memus \u043D\u0430 \u044D\u0442\u043E\u043C \u0443\u0441\u0442\u0440\u043E\u0439\u0441\u0442\u0432\u0435, \u0432\u043E\u0437\u043C\u043E\u0436\u043D\u043E \u0431\u0440\u0430\u0443\u0437\u0435\u0440 \u043D\u0435 \u0434\u0430\u0451\u0442 \u043F\u0435\u0440\u0435\u0447\u0438\u0441\u043B\u044F\u0442\u044C IndexedDB.";return}xe.textContent=`\u041D\u0430\u0439\u0434\u0435\u043D\u043E \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0445 \u0431\u0430\u0437: ${Ue.length}`;for(let nt of Ue){let ut=je(nt);Te.appendChild(ut);let yt=await ne(`${l}${nt}`).catch(()=>null);if(yt){let Ht=await Ye(yt,"articles").catch(()=>null);try{yt.close()}catch{}if(typeof Ht=="number")try{let R=ut.querySelector('[data-recovery-meta="1"]');R&&(R.textContent=`\u0421\u0442\u0430\u0442\u0435\u0439: ${Ht}`)}catch{}}}}catch(Ue){xe.textContent=`\u041E\u0448\u0438\u0431\u043A\u0430: ${String(Ue&&Ue.message?Ue.message:Ue)}`}};document.body.appendChild(ce),setTimeout(()=>O.focus({preventScroll:!0}),0)}function ge(){let te=()=>H();try{window.addEventListener("pointerdown",te,{passive:!0}),window.addEventListener("keydown",te,{passive:!0}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&te()})}catch{}}function Be(){let te=()=>{try{Promise.resolve().then(()=>(ui(),di)).then(ce=>ce.flushOutlineAutosave?.({mode:"queue"})).catch(()=>{})}catch{}try{Promise.resolve().then(()=>(la(),ca)).then(ce=>ce.flushOutboxOnce?.()).catch(()=>{})}catch{}};try{window.addEventListener("pagehide",te),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&te()})}catch{}}let ve=!1,de=te=>{if(!ve){ve=!0;try{document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>he({reason:te}),{once:!0}):he({reason:te})}catch{}}};function Ne({subtitle:te=null,error:ce=null,showRetry:y=!1,showOffline:g=!1}={}){try{let v=document.getElementById("authOverlay");if(!v)return;let k=document.getElementById("authSubtitle"),N=document.getElementById("authError");if(k&&te!=null&&(k.textContent=String(te)),N){let D=ce!=null?String(ce):"";N.textContent=D,N.classList.toggle("hidden",!D)}let _=v.querySelector(".auth-card")||v,O=document.getElementById("bootLoadActions");O||(O=document.createElement("div"),O.id="bootLoadActions",O.style.display="flex",O.style.gap="10px",O.style.flexWrap="wrap",O.style.marginTop="12px",_.appendChild(O)),O.innerHTML="";let K=(D,M)=>{let B=document.createElement("button");return B.type="button",B.className="auth-submit",B.style.padding="10px 14px",B.style.borderRadius="999px",B.style.fontSize="13px",B.textContent=D,B.addEventListener("click",M),B};if(y&&O.appendChild(K("\u041F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C",()=>{try{window.location.reload()}catch{}})),g){let D=()=>{let M=!1;try{M=!!("serviceWorker"in navigator&&navigator.serviceWorker?.controller)}catch{M=!1}if(A()&&!M){Ne({subtitle:"\u041D\u0435\u0442 \u0441\u0435\u0442\u0438",error:`\u041E\u0444\u0444\u043B\u0430\u0439\u043D-\u0440\u0435\u0436\u0438\u043C \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u043F\u043E\u0441\u043B\u0435 \u0442\u043E\u0433\u043E, \u043A\u0430\u043A \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435 \u0445\u043E\u0442\u044F \u0431\u044B \u043E\u0434\u0438\u043D \u0440\u0430\u0437 \u043E\u0442\u043A\u0440\u044B\u043B\u043E\u0441\u044C \u0441 \u0438\u043D\u0442\u0435\u0440\u043D\u0435\u0442\u043E\u043C \u0438 \u0437\u0430\u043A\u0435\u0448\u0438\u0440\u043E\u0432\u0430\u043B\u043E \u0444\u0430\u0439\u043B\u044B.

\u0415\u0441\u043B\u0438 \u0432\u044B \u0442\u043E\u043B\u044C\u043A\u043E \u0447\u0442\u043E \u0443\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u043B\u0438 PWA \u2014 \u043E\u0442\u043A\u0440\u043E\u0439\u0442\u0435 \u0435\u0433\u043E \u043E\u043D\u043B\u0430\u0439\u043D, \u0434\u043E\u0436\u0434\u0438\u0442\u0435\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438, \u0437\u0430\u0442\u0435\u043C \u043C\u043E\u0436\u043D\u043E \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u0431\u0435\u0437 \u0441\u0435\u0442\u0438.`,showRetry:!0,showOffline:!0});return}try{window.sessionStorage?.setItem?.(m,"1")}catch{}try{let E=document.getElementById("authSubtitle");E&&(E.textContent="\u041E\u0442\u043A\u0440\u044B\u0432\u0430\u0435\u043C \u0430\u0432\u0442\u043E\u043D\u043E\u043C\u043D\u044B\u0439 \u0440\u0435\u0436\u0438\u043C\u2026");let T=document.getElementById("authError");T&&(T.textContent="",T.classList.add("hidden"))}catch{}try{if(M){window.location.reload();return}}catch{}try{window.location.reload();return}catch{}try{rt({reason:"offline_button",background:!1})}catch{}};O.appendChild(K("\u041E\u0442\u043A\u0440\u044B\u0442\u044C \u043E\u0444\u0444\u043B\u0430\u0439\u043D-\u0431\u0443\u0444\u0435\u0440",()=>{try{D()}catch{}}))}}catch{}}let Ke=!1,Ve=!1;function rt({reason:te="",background:ce=!1}={}){if(!Ve&&!(Ke&&!ce)){Ke=!0;try{let y=import(e);y&&typeof y.catch=="function"&&y.catch(g=>{Ve=!0;let k="\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435. "+(A()?"\u041F\u043E\u0445\u043E\u0436\u0435, \u0441\u0435\u0439\u0447\u0430\u0441 \u043D\u0435\u0442 \u0441\u0435\u0442\u0438.":"\u041F\u043E\u0445\u043E\u0436\u0435, \u043F\u0440\u043E\u0431\u043B\u0435\u043C\u0430 \u0441 \u0441\u0435\u0442\u044C\u044E/\u0441\u043E\u0435\u0434\u0438\u043D\u0435\u043D\u0438\u0435\u043C.")+" \u041C\u043E\u0436\u043D\u043E \u043F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C \u0432 \u0430\u0432\u0442\u043E\u043D\u043E\u043C\u043D\u043E\u043C \u0440\u0435\u0436\u0438\u043C\u0435 \u0438\u043B\u0438 \u043F\u043E\u043F\u0440\u043E\u0431\u043E\u0432\u0430\u0442\u044C \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443.";if(Ne({subtitle:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",error:k,showRetry:!0,showOffline:!0}),!h)try{ve||de("\u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438")}catch{}S("app.import.failed",{reason:te,message:String(g?.message||g||"")})})}catch(y){Ve=!0,Ne({subtitle:"\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438",error:"\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u043F\u0443\u0441\u0442\u0438\u0442\u044C \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435. \u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0441\u0442\u0440\u0430\u043D\u0438\u0446\u0443.",showRetry:!0,showOffline:!0}),S("app.import.throw",{reason:te,message:String(y?.message||y||"")})}}}if(x()){w(),rt({reason:"public",background:!1});return}w();let Ze=F(),ot=X(),Je=A(),at=C(),ct=U();ge(),Be(),H(),(Je&&!h||at||ct||Ze&&ot)&&de(Je?"\u043D\u0435\u0442 \u0441\u0435\u0442\u0438":at?"\u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430":ct?"\u043F\u0440\u043E\u0441\u0442\u043E\u0439 > 15 \u043C\u0438\u043D":"\u0445\u043E\u043B\u043E\u0434\u043D\u044B\u0439 \u0441\u0442\u0430\u0440\u0442"),window.setTimeout(()=>{try{if(ve||window.__memusAppStarted||h)return;Ne({subtitle:"\u041C\u0435\u0434\u043B\u0435\u043D\u043D\u0430\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430\u2026",error:"\u0415\u0441\u043B\u0438 \u0441\u0435\u0442\u044C \u043D\u0435\u0441\u0442\u0430\u0431\u0438\u043B\u044C\u043D\u0430, \u043C\u043E\u0436\u043D\u043E \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u044C \u043E\u0444\u0444\u043B\u0430\u0439\u043D-\u0431\u0443\u0444\u0435\u0440. \u041F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435 \u043F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442 \u043F\u044B\u0442\u0430\u0442\u044C\u0441\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C\u0441\u044F \u0432 \u0444\u043E\u043D\u0435.",showRetry:!0,showOffline:!0}),de("\u043C\u0435\u0434\u043B\u0435\u043D\u043D\u0430\u044F \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430")}catch{}},s),ve||Je?ie(()=>rt({reason:"idle",background:!0}),{timeout:5e3,fallbackDelay:1200}):rt({reason:"foreground",background:!1})})();
